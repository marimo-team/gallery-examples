{
  "version": "1",
  "metadata": {
    "marimo_version": "0.19.11"
  },
  "cells": [
    {
      "id": "setup",
      "code_hash": "b95360f83d56be16fc8948c7cb000123",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/plain": ""
          }
        }
      ],
      "console": []
    },
    {
      "id": "Hbol",
      "code_hash": "1e4823f4e631fd6a802c39b3ed4e1e12",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/markdown": "<span class=\"markdown prose dark:prose-invert contents\"><span class=\"paragraph\">Try panning and zooming on the scatter plot, then <strong>click and hold</strong> to make a selection with your mouse and get the points back in Python!</span></span>"
          }
        }
      ],
      "console": []
    },
    {
      "id": "MJUe",
      "code_hash": "90306040011bdd5f189fb608cf527f0e",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/html": "<marimo-ui-element object-id='MJUe-0' random-id='83f03525-abbe-b5d6-56ad-6796e6c680f8'><marimo-anywidget data-initial-value='{&quot;model_id&quot;:&quot;80b52a172922434cbf39bfe1cb4d2dc5&quot;}' data-label='null' data-js-url='&quot;data:text/javascript;base64,dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgIGZvciAobGV0IGtleSBvZiBfX2dldE93blByb3BOYW1lcyhmcm9tKSkKICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzsKfTsKdmFyIF9fdG9FU00gPSAobW9kLCBpc05vZGVNb2RlLCB0YXJnZXQpID0+ICh0YXJnZXQgPSBtb2QgIT0gbnVsbCA/IF9fY3JlYXRlKF9fZ2V0UHJvdG9PZihtb2QpKSA6IHt9LCBfX2NvcHlQcm9wcygKICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAvLyBjb21wYXRpYmxlIHRyYW5zZm9ybSAoaS5lLiAiX19lc01vZHVsZSIgaGFzIG5vdCBiZWVuIHNldCksIHRoZW4gc2V0CiAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogIG1vZAopKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWdsL2Rpc3QvcmVnbC5qcwp2YXIgcmVxdWlyZV9yZWdsID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWdsL2Rpc3QvcmVnbC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAoZnVuY3Rpb24oZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICAgIHR5cGVvZiBleHBvcnRzID09PSAib2JqZWN0IiAmJiB0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiA/IG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpIDogdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDogZ2xvYmFsLmNyZWF0ZVJFR0wgPSBmYWN0b3J5KCk7CiAgICB9KShleHBvcnRzLCBmdW5jdGlvbigpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgaXNUeXBlZEFycmF5MiA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICByZXR1cm4geCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgeCBpbnN0YW5jZW9mIFVpbnQxNkFycmF5IHx8IHggaW5zdGFuY2VvZiBVaW50MzJBcnJheSB8fCB4IGluc3RhbmNlb2YgSW50OEFycmF5IHx8IHggaW5zdGFuY2VvZiBJbnQxNkFycmF5IHx8IHggaW5zdGFuY2VvZiBJbnQzMkFycmF5IHx8IHggaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgfHwgeCBpbnN0YW5jZW9mIEZsb2F0NjRBcnJheSB8fCB4IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXk7CiAgICAgIH07CiAgICAgIHZhciBleHRlbmQyID0gZnVuY3Rpb24oYmFzZSwgb3B0cykgewogICAgICAgIHZhciBrZXlzMiA9IE9iamVjdC5rZXlzKG9wdHMpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5czIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGJhc2Vba2V5czJbaV1dID0gb3B0c1trZXlzMltpXV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBiYXNlOwogICAgICB9OwogICAgICB2YXIgZW5kbCA9ICJcbiI7CiAgICAgIGZ1bmN0aW9uIGRlY29kZUI2NChzdHIpIHsKICAgICAgICBpZiAodHlwZW9mIGF0b2IgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICByZXR1cm4gYXRvYihzdHIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gImJhc2U2NDoiICsgc3RyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJhaXNlMihtZXNzYWdlKSB7CiAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCIocmVnbCkgIiArIG1lc3NhZ2UpOwogICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrMihwcmVkLCBtZXNzYWdlKSB7CiAgICAgICAgaWYgKCFwcmVkKSB7CiAgICAgICAgICByYWlzZTIobWVzc2FnZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGVuY29sb24obWVzc2FnZSkgewogICAgICAgIGlmIChtZXNzYWdlKSB7CiAgICAgICAgICByZXR1cm4gIjogIiArIG1lc3NhZ2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja1BhcmFtZXRlcihwYXJhbSwgcG9zc2liaWxpdGllcywgbWVzc2FnZSkgewogICAgICAgIGlmICghKHBhcmFtIGluIHBvc3NpYmlsaXRpZXMpKSB7CiAgICAgICAgICByYWlzZTIoInVua25vd24gcGFyYW1ldGVyICgiICsgcGFyYW0gKyAiKSIgKyBlbmNvbG9uKG1lc3NhZ2UpICsgIi4gcG9zc2libGUgdmFsdWVzOiAiICsgT2JqZWN0LmtleXMocG9zc2liaWxpdGllcykuam9pbigpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tJc1R5cGVkQXJyYXkoZGF0YSwgbWVzc2FnZSkgewogICAgICAgIGlmICghaXNUeXBlZEFycmF5MihkYXRhKSkgewogICAgICAgICAgcmFpc2UyKAogICAgICAgICAgICAiaW52YWxpZCBwYXJhbWV0ZXIgdHlwZSIgKyBlbmNvbG9uKG1lc3NhZ2UpICsgIi4gbXVzdCBiZSBhIHR5cGVkIGFycmF5IgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3RhbmRhcmRUeXBlRWgodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiOwogICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCI7CiAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIjsKICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiI7CiAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIjsKICAgICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja1R5cGVPZih2YWx1ZSwgdHlwZSwgbWVzc2FnZSkgewogICAgICAgIGlmICghc3RhbmRhcmRUeXBlRWgodmFsdWUsIHR5cGUpKSB7CiAgICAgICAgICByYWlzZTIoCiAgICAgICAgICAgICJpbnZhbGlkIHBhcmFtZXRlciB0eXBlIiArIGVuY29sb24obWVzc2FnZSkgKyAiLiBleHBlY3RlZCAiICsgdHlwZSArICIsIGdvdCAiICsgdHlwZW9mIHZhbHVlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja05vbk5lZ2F0aXZlSW50KHZhbHVlLCBtZXNzYWdlKSB7CiAgICAgICAgaWYgKCEodmFsdWUgPj0gMCAmJiAodmFsdWUgfCAwKSA9PT0gdmFsdWUpKSB7CiAgICAgICAgICByYWlzZTIoImludmFsaWQgcGFyYW1ldGVyIHR5cGUsICgiICsgdmFsdWUgKyAiKSIgKyBlbmNvbG9uKG1lc3NhZ2UpICsgIi4gbXVzdCBiZSBhIG5vbm5lZ2F0aXZlIGludGVnZXIiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tPbmVPZjIodmFsdWUsIGxpc3QyLCBtZXNzYWdlKSB7CiAgICAgICAgaWYgKGxpc3QyLmluZGV4T2YodmFsdWUpIDwgMCkgewogICAgICAgICAgcmFpc2UyKCJpbnZhbGlkIHZhbHVlIiArIGVuY29sb24obWVzc2FnZSkgKyAiLiBtdXN0IGJlIG9uZSBvZjogIiArIGxpc3QyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIGNvbnN0cnVjdG9yS2V5cyA9IFsKICAgICAgICAiZ2wiLAogICAgICAgICJjYW52YXMiLAogICAgICAgICJjb250YWluZXIiLAogICAgICAgICJhdHRyaWJ1dGVzIiwKICAgICAgICAicGl4ZWxSYXRpbyIsCiAgICAgICAgImV4dGVuc2lvbnMiLAogICAgICAgICJvcHRpb25hbEV4dGVuc2lvbnMiLAogICAgICAgICJwcm9maWxlIiwKICAgICAgICAib25Eb25lIgogICAgICBdOwogICAgICBmdW5jdGlvbiBjaGVja0NvbnN0cnVjdG9yKG9iaikgewogICAgICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIGlmIChjb25zdHJ1Y3RvcktleXMuaW5kZXhPZihrZXkpIDwgMCkgewogICAgICAgICAgICByYWlzZTIoJ2ludmFsaWQgcmVnbCBjb25zdHJ1Y3RvciBhcmd1bWVudCAiJyArIGtleSArICciLiBtdXN0IGJlIG9uZSBvZiAnICsgY29uc3RydWN0b3JLZXlzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBsZWZ0UGFkKHN0ciwgbikgewogICAgICAgIHN0ciA9IHN0ciArICIiOwogICAgICAgIHdoaWxlIChzdHIubGVuZ3RoIDwgbikgewogICAgICAgICAgc3RyID0gIiAiICsgc3RyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIFNoYWRlckZpbGUoKSB7CiAgICAgICAgdGhpcy5uYW1lID0gInVua25vd24iOwogICAgICAgIHRoaXMubGluZXMgPSBbXTsKICAgICAgICB0aGlzLmluZGV4ID0ge307CiAgICAgICAgdGhpcy5oYXNFcnJvcnMgPSBmYWxzZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBTaGFkZXJMaW5lKG51bWJlcjUsIGxpbmUyKSB7CiAgICAgICAgdGhpcy5udW1iZXIgPSBudW1iZXI1OwogICAgICAgIHRoaXMubGluZSA9IGxpbmUyOwogICAgICAgIHRoaXMuZXJyb3JzID0gW107CiAgICAgIH0KICAgICAgZnVuY3Rpb24gU2hhZGVyRXJyb3IoZmlsZU51bWJlciwgbGluZU51bWJlciwgbWVzc2FnZSkgewogICAgICAgIHRoaXMuZmlsZSA9IGZpbGVOdW1iZXI7CiAgICAgICAgdGhpcy5saW5lID0gbGluZU51bWJlcjsKICAgICAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGd1ZXNzQ29tbWFuZCgpIHsKICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoKTsKICAgICAgICB2YXIgc3RhY2sgPSAoZXJyb3Iuc3RhY2sgfHwgZXJyb3IpLnRvU3RyaW5nKCk7CiAgICAgICAgdmFyIHBhdCA9IC9jb21waWxlUHJvY2VkdXJlLipcblxzKmF0LipcKCguKilcKS8uZXhlYyhzdGFjayk7CiAgICAgICAgaWYgKHBhdCkgewogICAgICAgICAgcmV0dXJuIHBhdFsxXTsKICAgICAgICB9CiAgICAgICAgdmFyIHBhdDIgPSAvY29tcGlsZVByb2NlZHVyZS4qXG5ccyphdFxzKyguKikoXG58JCkvLmV4ZWMoc3RhY2spOwogICAgICAgIGlmIChwYXQyKSB7CiAgICAgICAgICByZXR1cm4gcGF0MlsxXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICJ1bmtub3duIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBndWVzc0NhbGxTaXRlKCkgewogICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigpOwogICAgICAgIHZhciBzdGFjayA9IChlcnJvci5zdGFjayB8fCBlcnJvcikudG9TdHJpbmcoKTsKICAgICAgICB2YXIgcGF0ID0gL2F0IFJFR0xDb21tYW5kLipcblxzK2F0LipcKCguKilcKS8uZXhlYyhzdGFjayk7CiAgICAgICAgaWYgKHBhdCkgewogICAgICAgICAgcmV0dXJuIHBhdFsxXTsKICAgICAgICB9CiAgICAgICAgdmFyIHBhdDIgPSAvYXQgUkVHTENvbW1hbmQuKlxuXHMrYXRccysoLiopXG4vLmV4ZWMoc3RhY2spOwogICAgICAgIGlmIChwYXQyKSB7CiAgICAgICAgICByZXR1cm4gcGF0MlsxXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICJ1bmtub3duIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZVNvdXJjZShzb3VyY2UsIGNvbW1hbmQpIHsKICAgICAgICB2YXIgbGluZXMyID0gc291cmNlLnNwbGl0KCJcbiIpOwogICAgICAgIHZhciBsaW5lTnVtYmVyID0gMTsKICAgICAgICB2YXIgZmlsZU51bWJlciA9IDA7CiAgICAgICAgdmFyIGZpbGVzID0gewogICAgICAgICAgdW5rbm93bjogbmV3IFNoYWRlckZpbGUoKSwKICAgICAgICAgIDA6IG5ldyBTaGFkZXJGaWxlKCkKICAgICAgICB9OwogICAgICAgIGZpbGVzLnVua25vd24ubmFtZSA9IGZpbGVzWzBdLm5hbWUgPSBjb21tYW5kIHx8IGd1ZXNzQ29tbWFuZCgpOwogICAgICAgIGZpbGVzLnVua25vd24ubGluZXMucHVzaChuZXcgU2hhZGVyTGluZSgwLCAiIikpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGluZXMyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgbGluZTIgPSBsaW5lczJbaV07CiAgICAgICAgICB2YXIgcGFydHMgPSAvXlxzKiNccyooXHcrKVxzKyguKylccyokLy5leGVjKGxpbmUyKTsKICAgICAgICAgIGlmIChwYXJ0cykgewogICAgICAgICAgICBzd2l0Y2ggKHBhcnRzWzFdKSB7CiAgICAgICAgICAgICAgY2FzZSAibGluZSI6CiAgICAgICAgICAgICAgICB2YXIgbGluZU51bWJlckluZm8gPSAvKFxkKykoXHMrXGQrKT8vLmV4ZWMocGFydHNbMl0pOwogICAgICAgICAgICAgICAgaWYgKGxpbmVOdW1iZXJJbmZvKSB7CiAgICAgICAgICAgICAgICAgIGxpbmVOdW1iZXIgPSBsaW5lTnVtYmVySW5mb1sxXSB8IDA7CiAgICAgICAgICAgICAgICAgIGlmIChsaW5lTnVtYmVySW5mb1syXSkgewogICAgICAgICAgICAgICAgICAgIGZpbGVOdW1iZXIgPSBsaW5lTnVtYmVySW5mb1syXSB8IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEoZmlsZU51bWJlciBpbiBmaWxlcykpIHsKICAgICAgICAgICAgICAgICAgICAgIGZpbGVzW2ZpbGVOdW1iZXJdID0gbmV3IFNoYWRlckZpbGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgImRlZmluZSI6CiAgICAgICAgICAgICAgICB2YXIgbmFtZUluZm8gPSAvU0hBREVSX05BTUUoX0I2NCk/XHMrKC4qKSQvLmV4ZWMocGFydHNbMl0pOwogICAgICAgICAgICAgICAgaWYgKG5hbWVJbmZvKSB7CiAgICAgICAgICAgICAgICAgIGZpbGVzW2ZpbGVOdW1iZXJdLm5hbWUgPSBuYW1lSW5mb1sxXSA/IGRlY29kZUI2NChuYW1lSW5mb1syXSkgOiBuYW1lSW5mb1syXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmaWxlc1tmaWxlTnVtYmVyXS5saW5lcy5wdXNoKG5ldyBTaGFkZXJMaW5lKGxpbmVOdW1iZXIrKywgbGluZTIpKTsKICAgICAgICB9CiAgICAgICAgT2JqZWN0LmtleXMoZmlsZXMpLmZvckVhY2goZnVuY3Rpb24oZmlsZU51bWJlcjIpIHsKICAgICAgICAgIHZhciBmaWxlID0gZmlsZXNbZmlsZU51bWJlcjJdOwogICAgICAgICAgZmlsZS5saW5lcy5mb3JFYWNoKGZ1bmN0aW9uKGxpbmUzKSB7CiAgICAgICAgICAgIGZpbGUuaW5kZXhbbGluZTMubnVtYmVyXSA9IGxpbmUzOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZpbGVzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRXJyb3JMb2coZXJyTG9nKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIGVyckxvZy5zcGxpdCgiXG4iKS5mb3JFYWNoKGZ1bmN0aW9uKGVyck1zZykgewogICAgICAgICAgaWYgKGVyck1zZy5sZW5ndGggPCA1KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJ0cyA9IC9eRVJST1I6XHMrKFxkKyk6KFxkKyk6XHMqKC4qKSQvLmV4ZWMoZXJyTXNnKTsKICAgICAgICAgIGlmIChwYXJ0cykgewogICAgICAgICAgICByZXN1bHQucHVzaChuZXcgU2hhZGVyRXJyb3IoCiAgICAgICAgICAgICAgcGFydHNbMV0gfCAwLAogICAgICAgICAgICAgIHBhcnRzWzJdIHwgMCwKICAgICAgICAgICAgICBwYXJ0c1szXS50cmltKCkKICAgICAgICAgICAgKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGVyck1zZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ldyBTaGFkZXJFcnJvcigidW5rbm93biIsIDAsIGVyck1zZykpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYW5ub3RhdGVGaWxlcyhmaWxlcywgZXJyb3JzKSB7CiAgICAgICAgZXJyb3JzLmZvckVhY2goZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIHZhciBmaWxlID0gZmlsZXNbZXJyb3IuZmlsZV07CiAgICAgICAgICBpZiAoZmlsZSkgewogICAgICAgICAgICB2YXIgbGluZTIgPSBmaWxlLmluZGV4W2Vycm9yLmxpbmVdOwogICAgICAgICAgICBpZiAobGluZTIpIHsKICAgICAgICAgICAgICBsaW5lMi5lcnJvcnMucHVzaChlcnJvcik7CiAgICAgICAgICAgICAgZmlsZS5oYXNFcnJvcnMgPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZmlsZXMudW5rbm93bi5oYXNFcnJvcnMgPSB0cnVlOwogICAgICAgICAgZmlsZXMudW5rbm93bi5saW5lc1swXS5lcnJvcnMucHVzaChlcnJvcik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tTaGFkZXJFcnJvcihnbCwgc2hhZGVyLCBzb3VyY2UsIHR5cGUsIGNvbW1hbmQpIHsKICAgICAgICBpZiAoIWdsLmdldFNoYWRlclBhcmFtZXRlcihzaGFkZXIsIGdsLkNPTVBJTEVfU1RBVFVTKSkgewogICAgICAgICAgdmFyIGVyckxvZyA9IGdsLmdldFNoYWRlckluZm9Mb2coc2hhZGVyKTsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHR5cGUgPT09IGdsLkZSQUdNRU5UX1NIQURFUiA/ICJmcmFnbWVudCIgOiAidmVydGV4IjsKICAgICAgICAgIGNoZWNrQ29tbWFuZFR5cGUoc291cmNlLCAic3RyaW5nIiwgdHlwZU5hbWUgKyAiIHNoYWRlciBzb3VyY2UgbXVzdCBiZSBhIHN0cmluZyIsIGNvbW1hbmQpOwogICAgICAgICAgdmFyIGZpbGVzID0gcGFyc2VTb3VyY2Uoc291cmNlLCBjb21tYW5kKTsKICAgICAgICAgIHZhciBlcnJvcnMgPSBwYXJzZUVycm9yTG9nKGVyckxvZyk7CiAgICAgICAgICBhbm5vdGF0ZUZpbGVzKGZpbGVzLCBlcnJvcnMpOwogICAgICAgICAgT2JqZWN0LmtleXMoZmlsZXMpLmZvckVhY2goZnVuY3Rpb24oZmlsZU51bWJlcikgewogICAgICAgICAgICB2YXIgZmlsZSA9IGZpbGVzW2ZpbGVOdW1iZXJdOwogICAgICAgICAgICBpZiAoIWZpbGUuaGFzRXJyb3JzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHJpbmdzID0gWyIiXTsKICAgICAgICAgICAgdmFyIHN0eWxlcyA9IFsiIl07CiAgICAgICAgICAgIGZ1bmN0aW9uIHB1c2gyKHN0ciwgc3R5bGUpIHsKICAgICAgICAgICAgICBzdHJpbmdzLnB1c2goc3RyKTsKICAgICAgICAgICAgICBzdHlsZXMucHVzaChzdHlsZSB8fCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaDIoImZpbGUgbnVtYmVyICIgKyBmaWxlTnVtYmVyICsgIjogIiArIGZpbGUubmFtZSArICJcbiIsICJjb2xvcjpyZWQ7dGV4dC1kZWNvcmF0aW9uOnVuZGVybGluZTtmb250LXdlaWdodDpib2xkIik7CiAgICAgICAgICAgIGZpbGUubGluZXMuZm9yRWFjaChmdW5jdGlvbihsaW5lMikgewogICAgICAgICAgICAgIGlmIChsaW5lMi5lcnJvcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcHVzaDIobGVmdFBhZChsaW5lMi5udW1iZXIsIDQpICsgInwgICIsICJiYWNrZ3JvdW5kLWNvbG9yOnllbGxvdzsgZm9udC13ZWlnaHQ6Ym9sZCIpOwogICAgICAgICAgICAgICAgcHVzaDIobGluZTIubGluZSArIGVuZGwsICJjb2xvcjpyZWQ7IGJhY2tncm91bmQtY29sb3I6eWVsbG93OyBmb250LXdlaWdodDpib2xkIik7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgICAgICAgICAgIGxpbmUyLmVycm9ycy5mb3JFYWNoKGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgdmFyIHRva2VuID0gL15ccyonKC4qKSdccyo6XHMqKC4qKSQvLmV4ZWMobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIGlmICh0b2tlbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0b2tlblBhdCA9IHRva2VuWzFdOwogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB0b2tlblsyXTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHRva2VuUGF0KSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhc3NpZ24iOgogICAgICAgICAgICAgICAgICAgICAgICB0b2tlblBhdCA9ICI9IjsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IE1hdGgubWF4KGxpbmUyLmxpbmUuaW5kZXhPZih0b2tlblBhdCwgb2Zmc2V0KSwgMCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBwdXNoMihsZWZ0UGFkKCJ8ICIsIDYpKTsKICAgICAgICAgICAgICAgICAgcHVzaDIobGVmdFBhZCgiXl5eIiwgb2Zmc2V0ICsgMykgKyBlbmRsLCAiZm9udC13ZWlnaHQ6Ym9sZCIpOwogICAgICAgICAgICAgICAgICBwdXNoMihsZWZ0UGFkKCJ8ICIsIDYpKTsKICAgICAgICAgICAgICAgICAgcHVzaDIobWVzc2FnZSArIGVuZGwsICJmb250LXdlaWdodDpib2xkIik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHB1c2gyKGxlZnRQYWQoInwgIiwgNikgKyBlbmRsKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHVzaDIobGVmdFBhZChsaW5lMi5udW1iZXIsIDQpICsgInwgICIpOwogICAgICAgICAgICAgICAgcHVzaDIobGluZTIubGluZSArIGVuZGwsICJjb2xvcjpyZWQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiAhd2luZG93LmNocm9tZSkgewogICAgICAgICAgICAgIHN0eWxlc1swXSA9IHN0cmluZ3Muam9pbigiJWMiKTsKICAgICAgICAgICAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBzdHlsZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN0cmluZ3Muam9pbigiIikpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGNoZWNrMi5yYWlzZSgiRXJyb3IgY29tcGlsaW5nICIgKyB0eXBlTmFtZSArICIgc2hhZGVyLCAiICsgZmlsZXNbMF0ubmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrTGlua0Vycm9yKGdsLCBwcm9ncmFtLCBmcmFnU2hhZGVyLCB2ZXJ0U2hhZGVyLCBjb21tYW5kKSB7CiAgICAgICAgaWYgKCFnbC5nZXRQcm9ncmFtUGFyYW1ldGVyKHByb2dyYW0sIGdsLkxJTktfU1RBVFVTKSkgewogICAgICAgICAgdmFyIGVyckxvZyA9IGdsLmdldFByb2dyYW1JbmZvTG9nKHByb2dyYW0pOwogICAgICAgICAgdmFyIGZyYWdQYXJzZSA9IHBhcnNlU291cmNlKGZyYWdTaGFkZXIsIGNvbW1hbmQpOwogICAgICAgICAgdmFyIHZlcnRQYXJzZSA9IHBhcnNlU291cmNlKHZlcnRTaGFkZXIsIGNvbW1hbmQpOwogICAgICAgICAgdmFyIGhlYWRlciA9ICdFcnJvciBsaW5raW5nIHByb2dyYW0gd2l0aCB2ZXJ0ZXggc2hhZGVyLCAiJyArIHZlcnRQYXJzZVswXS5uYW1lICsgJyIsIGFuZCBmcmFnbWVudCBzaGFkZXIgIicgKyBmcmFnUGFyc2VbMF0ubmFtZSArICciJzsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgICAgICIlYyIgKyBoZWFkZXIgKyBlbmRsICsgIiVjIiArIGVyckxvZywKICAgICAgICAgICAgICAiY29sb3I6cmVkO3RleHQtZGVjb3JhdGlvbjp1bmRlcmxpbmU7Zm9udC13ZWlnaHQ6Ym9sZCIsCiAgICAgICAgICAgICAgImNvbG9yOnJlZCIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGhlYWRlciArIGVuZGwgKyBlcnJMb2cpOwogICAgICAgICAgfQogICAgICAgICAgY2hlY2syLnJhaXNlKGhlYWRlcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNhdmVDb21tYW5kUmVmKG9iamVjdCkgewogICAgICAgIG9iamVjdC5fY29tbWFuZFJlZiA9IGd1ZXNzQ29tbWFuZCgpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNhdmVEcmF3Q29tbWFuZEluZm8ob3B0cywgdW5pZm9ybXMsIGF0dHJpYnV0ZXMsIHN0cmluZ1N0b3JlKSB7CiAgICAgICAgc2F2ZUNvbW1hbmRSZWYob3B0cyk7CiAgICAgICAgZnVuY3Rpb24gaWQoc3RyKSB7CiAgICAgICAgICBpZiAoc3RyKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmdTdG9yZS5pZChzdHIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIG9wdHMuX2ZyYWdJZCA9IGlkKG9wdHMuc3RhdGljLmZyYWcpOwogICAgICAgIG9wdHMuX3ZlcnRJZCA9IGlkKG9wdHMuc3RhdGljLnZlcnQpOwogICAgICAgIGZ1bmN0aW9uIGFkZFByb3BzKGRpY3QsIHNldCkgewogICAgICAgICAgT2JqZWN0LmtleXMoc2V0KS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgICAgICAgICAgZGljdFtzdHJpbmdTdG9yZS5pZCh1KV0gPSB0cnVlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciB1bmlmb3JtU2V0ID0gb3B0cy5fdW5pZm9ybVNldCA9IHt9OwogICAgICAgIGFkZFByb3BzKHVuaWZvcm1TZXQsIHVuaWZvcm1zLnN0YXRpYyk7CiAgICAgICAgYWRkUHJvcHModW5pZm9ybVNldCwgdW5pZm9ybXMuZHluYW1pYyk7CiAgICAgICAgdmFyIGF0dHJpYnV0ZVNldCA9IG9wdHMuX2F0dHJpYnV0ZVNldCA9IHt9OwogICAgICAgIGFkZFByb3BzKGF0dHJpYnV0ZVNldCwgYXR0cmlidXRlcy5zdGF0aWMpOwogICAgICAgIGFkZFByb3BzKGF0dHJpYnV0ZVNldCwgYXR0cmlidXRlcy5keW5hbWljKTsKICAgICAgICBvcHRzLl9oYXNDb3VudCA9ICJjb3VudCIgaW4gb3B0cy5zdGF0aWMgfHwgImNvdW50IiBpbiBvcHRzLmR5bmFtaWMgfHwgImVsZW1lbnRzIiBpbiBvcHRzLnN0YXRpYyB8fCAiZWxlbWVudHMiIGluIG9wdHMuZHluYW1pYzsKICAgICAgfQogICAgICBmdW5jdGlvbiBjb21tYW5kUmFpc2UobWVzc2FnZSwgY29tbWFuZCkgewogICAgICAgIHZhciBjYWxsU2l0ZSA9IGd1ZXNzQ2FsbFNpdGUoKTsKICAgICAgICByYWlzZTIobWVzc2FnZSArICIgaW4gY29tbWFuZCAiICsgKGNvbW1hbmQgfHwgZ3Vlc3NDb21tYW5kKCkpICsgKGNhbGxTaXRlID09PSAidW5rbm93biIgPyAiIiA6ICIgY2FsbGVkIGZyb20gIiArIGNhbGxTaXRlKSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tDb21tYW5kKHByZWQsIG1lc3NhZ2UsIGNvbW1hbmQpIHsKICAgICAgICBpZiAoIXByZWQpIHsKICAgICAgICAgIGNvbW1hbmRSYWlzZShtZXNzYWdlLCBjb21tYW5kIHx8IGd1ZXNzQ29tbWFuZCgpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tQYXJhbWV0ZXJDb21tYW5kKHBhcmFtLCBwb3NzaWJpbGl0aWVzLCBtZXNzYWdlLCBjb21tYW5kKSB7CiAgICAgICAgaWYgKCEocGFyYW0gaW4gcG9zc2liaWxpdGllcykpIHsKICAgICAgICAgIGNvbW1hbmRSYWlzZSgKICAgICAgICAgICAgInVua25vd24gcGFyYW1ldGVyICgiICsgcGFyYW0gKyAiKSIgKyBlbmNvbG9uKG1lc3NhZ2UpICsgIi4gcG9zc2libGUgdmFsdWVzOiAiICsgT2JqZWN0LmtleXMocG9zc2liaWxpdGllcykuam9pbigpLAogICAgICAgICAgICBjb21tYW5kIHx8IGd1ZXNzQ29tbWFuZCgpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0NvbW1hbmRUeXBlKHZhbHVlLCB0eXBlLCBtZXNzYWdlLCBjb21tYW5kKSB7CiAgICAgICAgaWYgKCFzdGFuZGFyZFR5cGVFaCh2YWx1ZSwgdHlwZSkpIHsKICAgICAgICAgIGNvbW1hbmRSYWlzZSgKICAgICAgICAgICAgImludmFsaWQgcGFyYW1ldGVyIHR5cGUiICsgZW5jb2xvbihtZXNzYWdlKSArICIuIGV4cGVjdGVkICIgKyB0eXBlICsgIiwgZ290ICIgKyB0eXBlb2YgdmFsdWUsCiAgICAgICAgICAgIGNvbW1hbmQgfHwgZ3Vlc3NDb21tYW5kKCkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrT3B0aW9uYWwoYmxvY2spIHsKICAgICAgICBibG9jaygpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrRnJhbWVidWZmZXJGb3JtYXQoYXR0YWNobWVudCwgdGV4Rm9ybWF0cywgcmJGb3JtYXRzKSB7CiAgICAgICAgaWYgKGF0dGFjaG1lbnQudGV4dHVyZSkgewogICAgICAgICAgY2hlY2tPbmVPZjIoCiAgICAgICAgICAgIGF0dGFjaG1lbnQudGV4dHVyZS5fdGV4dHVyZS5pbnRlcm5hbGZvcm1hdCwKICAgICAgICAgICAgdGV4Rm9ybWF0cywKICAgICAgICAgICAgInVuc3VwcG9ydGVkIHRleHR1cmUgZm9ybWF0IGZvciBhdHRhY2htZW50IgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tPbmVPZjIoCiAgICAgICAgICAgIGF0dGFjaG1lbnQucmVuZGVyYnVmZmVyLl9yZW5kZXJidWZmZXIuZm9ybWF0LAogICAgICAgICAgICByYkZvcm1hdHMsCiAgICAgICAgICAgICJ1bnN1cHBvcnRlZCByZW5kZXJidWZmZXIgZm9ybWF0IGZvciBhdHRhY2htZW50IgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIEdMX0NMQU1QX1RPX0VER0UgPSAzMzA3MTsKICAgICAgdmFyIEdMX05FQVJFU1QgPSA5NzI4OwogICAgICB2YXIgR0xfTkVBUkVTVF9NSVBNQVBfTkVBUkVTVCA9IDk5ODQ7CiAgICAgIHZhciBHTF9MSU5FQVJfTUlQTUFQX05FQVJFU1QgPSA5OTg1OwogICAgICB2YXIgR0xfTkVBUkVTVF9NSVBNQVBfTElORUFSID0gOTk4NjsKICAgICAgdmFyIEdMX0xJTkVBUl9NSVBNQVBfTElORUFSID0gOTk4NzsKICAgICAgdmFyIEdMX0JZVEUgPSA1MTIwOwogICAgICB2YXIgR0xfVU5TSUdORURfQllURSA9IDUxMjE7CiAgICAgIHZhciBHTF9TSE9SVCA9IDUxMjI7CiAgICAgIHZhciBHTF9VTlNJR05FRF9TSE9SVCA9IDUxMjM7CiAgICAgIHZhciBHTF9JTlQgPSA1MTI0OwogICAgICB2YXIgR0xfVU5TSUdORURfSU5UID0gNTEyNTsKICAgICAgdmFyIEdMX0ZMT0FUID0gNTEyNjsKICAgICAgdmFyIEdMX1VOU0lHTkVEX1NIT1JUXzRfNF80XzQgPSAzMjgxOTsKICAgICAgdmFyIEdMX1VOU0lHTkVEX1NIT1JUXzVfNV81XzEgPSAzMjgyMDsKICAgICAgdmFyIEdMX1VOU0lHTkVEX1NIT1JUXzVfNl81ID0gMzM2MzU7CiAgICAgIHZhciBHTF9VTlNJR05FRF9JTlRfMjRfOF9XRUJHTCA9IDM0MDQyOwogICAgICB2YXIgR0xfSEFMRl9GTE9BVF9PRVMgPSAzNjE5MzsKICAgICAgdmFyIFRZUEVfU0laRSA9IHt9OwogICAgICBUWVBFX1NJWkVbR0xfQllURV0gPSBUWVBFX1NJWkVbR0xfVU5TSUdORURfQllURV0gPSAxOwogICAgICBUWVBFX1NJWkVbR0xfU0hPUlRdID0gVFlQRV9TSVpFW0dMX1VOU0lHTkVEX1NIT1JUXSA9IFRZUEVfU0laRVtHTF9IQUxGX0ZMT0FUX09FU10gPSBUWVBFX1NJWkVbR0xfVU5TSUdORURfU0hPUlRfNV82XzVdID0gVFlQRV9TSVpFW0dMX1VOU0lHTkVEX1NIT1JUXzRfNF80XzRdID0gVFlQRV9TSVpFW0dMX1VOU0lHTkVEX1NIT1JUXzVfNV81XzFdID0gMjsKICAgICAgVFlQRV9TSVpFW0dMX0lOVF0gPSBUWVBFX1NJWkVbR0xfVU5TSUdORURfSU5UXSA9IFRZUEVfU0laRVtHTF9GTE9BVF0gPSBUWVBFX1NJWkVbR0xfVU5TSUdORURfSU5UXzI0XzhfV0VCR0xdID0gNDsKICAgICAgZnVuY3Rpb24gcGl4ZWxTaXplKHR5cGUsIGNoYW5uZWxzKSB7CiAgICAgICAgaWYgKHR5cGUgPT09IEdMX1VOU0lHTkVEX1NIT1JUXzVfNV81XzEgfHwgdHlwZSA9PT0gR0xfVU5TSUdORURfU0hPUlRfNF80XzRfNCB8fCB0eXBlID09PSBHTF9VTlNJR05FRF9TSE9SVF81XzZfNSkgewogICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBHTF9VTlNJR05FRF9JTlRfMjRfOF9XRUJHTCkgewogICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBUWVBFX1NJWkVbdHlwZV0gKiBjaGFubmVsczsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNQb3cyKHYpIHsKICAgICAgICByZXR1cm4gISh2ICYgdiAtIDEpICYmICEhdjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja1RleHR1cmUyRChpbmZvLCBtaXBEYXRhLCBsaW1pdHMpIHsKICAgICAgICB2YXIgaTsKICAgICAgICB2YXIgdyA9IG1pcERhdGEud2lkdGg7CiAgICAgICAgdmFyIGggPSBtaXBEYXRhLmhlaWdodDsKICAgICAgICB2YXIgYyA9IG1pcERhdGEuY2hhbm5lbHM7CiAgICAgICAgY2hlY2syKAogICAgICAgICAgdyA+IDAgJiYgdyA8PSBsaW1pdHMubWF4VGV4dHVyZVNpemUgJiYgaCA+IDAgJiYgaCA8PSBsaW1pdHMubWF4VGV4dHVyZVNpemUsCiAgICAgICAgICAiaW52YWxpZCB0ZXh0dXJlIHNoYXBlIgogICAgICAgICk7CiAgICAgICAgaWYgKGluZm8ud3JhcFMgIT09IEdMX0NMQU1QX1RPX0VER0UgfHwgaW5mby53cmFwVCAhPT0gR0xfQ0xBTVBfVE9fRURHRSkgewogICAgICAgICAgY2hlY2syKAogICAgICAgICAgICBpc1BvdzIodykgJiYgaXNQb3cyKGgpLAogICAgICAgICAgICAiaW5jb21wYXRpYmxlIHdyYXAgbW9kZSBmb3IgdGV4dHVyZSwgYm90aCB3aWR0aCBhbmQgaGVpZ2h0IG11c3QgYmUgcG93ZXIgb2YgMiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChtaXBEYXRhLm1pcG1hc2sgPT09IDEpIHsKICAgICAgICAgIGlmICh3ICE9PSAxICYmIGggIT09IDEpIHsKICAgICAgICAgICAgY2hlY2syKAogICAgICAgICAgICAgIGluZm8ubWluRmlsdGVyICE9PSBHTF9ORUFSRVNUX01JUE1BUF9ORUFSRVNUICYmIGluZm8ubWluRmlsdGVyICE9PSBHTF9ORUFSRVNUX01JUE1BUF9MSU5FQVIgJiYgaW5mby5taW5GaWx0ZXIgIT09IEdMX0xJTkVBUl9NSVBNQVBfTkVBUkVTVCAmJiBpbmZvLm1pbkZpbHRlciAhPT0gR0xfTElORUFSX01JUE1BUF9MSU5FQVIsCiAgICAgICAgICAgICAgIm1pbiBmaWx0ZXIgcmVxdWlyZXMgbWlwbWFwIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVjazIoCiAgICAgICAgICAgIGlzUG93Mih3KSAmJiBpc1BvdzIoaCksCiAgICAgICAgICAgICJ0ZXh0dXJlIG11c3QgYmUgYSBzcXVhcmUgcG93ZXIgb2YgMiB0byBzdXBwb3J0IG1pcG1hcHBpbmciCiAgICAgICAgICApOwogICAgICAgICAgY2hlY2syKAogICAgICAgICAgICBtaXBEYXRhLm1pcG1hc2sgPT09ICh3IDw8IDEpIC0gMSwKICAgICAgICAgICAgIm1pc3Npbmcgb3IgaW5jb21wbGV0ZSBtaXBtYXAgZGF0YSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChtaXBEYXRhLnR5cGUgPT09IEdMX0ZMT0FUKSB7CiAgICAgICAgICBpZiAobGltaXRzLmV4dGVuc2lvbnMuaW5kZXhPZigib2VzX3RleHR1cmVfZmxvYXRfbGluZWFyIikgPCAwKSB7CiAgICAgICAgICAgIGNoZWNrMigKICAgICAgICAgICAgICBpbmZvLm1pbkZpbHRlciA9PT0gR0xfTkVBUkVTVCAmJiBpbmZvLm1hZ0ZpbHRlciA9PT0gR0xfTkVBUkVTVCwKICAgICAgICAgICAgICAiZmlsdGVyIG5vdCBzdXBwb3J0ZWQsIG11c3QgZW5hYmxlIG9lc190ZXh0dXJlX2Zsb2F0X2xpbmVhciIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNoZWNrMigKICAgICAgICAgICAgIWluZm8uZ2VuTWlwbWFwcywKICAgICAgICAgICAgIm1pcG1hcCBnZW5lcmF0aW9uIG5vdCBzdXBwb3J0ZWQgd2l0aCBmbG9hdCB0ZXh0dXJlcyIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHZhciBtaXBpbWFnZXMgPSBtaXBEYXRhLmltYWdlczsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTY7ICsraSkgewogICAgICAgICAgaWYgKG1pcGltYWdlc1tpXSkgewogICAgICAgICAgICB2YXIgbXcgPSB3ID4+IGk7CiAgICAgICAgICAgIHZhciBtaCA9IGggPj4gaTsKICAgICAgICAgICAgY2hlY2syKG1pcERhdGEubWlwbWFzayAmIDEgPDwgaSwgIm1pc3NpbmcgbWlwbWFwIGRhdGEiKTsKICAgICAgICAgICAgdmFyIGltZyA9IG1pcGltYWdlc1tpXTsKICAgICAgICAgICAgY2hlY2syKAogICAgICAgICAgICAgIGltZy53aWR0aCA9PT0gbXcgJiYgaW1nLmhlaWdodCA9PT0gbWgsCiAgICAgICAgICAgICAgImludmFsaWQgc2hhcGUgZm9yIG1pcCBpbWFnZXMiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNoZWNrMigKICAgICAgICAgICAgICBpbWcuZm9ybWF0ID09PSBtaXBEYXRhLmZvcm1hdCAmJiBpbWcuaW50ZXJuYWxmb3JtYXQgPT09IG1pcERhdGEuaW50ZXJuYWxmb3JtYXQgJiYgaW1nLnR5cGUgPT09IG1pcERhdGEudHlwZSwKICAgICAgICAgICAgICAiaW5jb21wYXRpYmxlIHR5cGUgZm9yIG1pcCBpbWFnZSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGltZy5jb21wcmVzc2VkKSB7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW1nLmRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcm93U2l6ZSA9IE1hdGguY2VpbChwaXhlbFNpemUoaW1nLnR5cGUsIGMpICogbXcgLyBpbWcudW5wYWNrQWxpZ25tZW50KSAqIGltZy51bnBhY2tBbGlnbm1lbnQ7CiAgICAgICAgICAgICAgY2hlY2syKAogICAgICAgICAgICAgICAgaW1nLmRhdGEuYnl0ZUxlbmd0aCA9PT0gcm93U2l6ZSAqIG1oLAogICAgICAgICAgICAgICAgImludmFsaWQgZGF0YSBmb3IgaW1hZ2UsIGJ1ZmZlciBzaXplIGlzIGluY29uc2lzdGVudCB3aXRoIGltYWdlIGZvcm1hdCIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGltZy5lbGVtZW50KSB7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW1nLmNvcHkpIHsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICghaW5mby5nZW5NaXBtYXBzKSB7CiAgICAgICAgICAgIGNoZWNrMigobWlwRGF0YS5taXBtYXNrICYgMSA8PCBpKSA9PT0gMCwgImV4dHJhIG1pcG1hcCBkYXRhIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChtaXBEYXRhLmNvbXByZXNzZWQpIHsKICAgICAgICAgIGNoZWNrMigKICAgICAgICAgICAgIWluZm8uZ2VuTWlwbWFwcywKICAgICAgICAgICAgIm1pcG1hcCBnZW5lcmF0aW9uIGZvciBjb21wcmVzc2VkIGltYWdlcyBub3Qgc3VwcG9ydGVkIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tUZXh0dXJlQ3ViZSh0ZXh0dXJlLCBpbmZvLCBmYWNlcywgbGltaXRzKSB7CiAgICAgICAgdmFyIHcgPSB0ZXh0dXJlLndpZHRoOwogICAgICAgIHZhciBoID0gdGV4dHVyZS5oZWlnaHQ7CiAgICAgICAgdmFyIGMgPSB0ZXh0dXJlLmNoYW5uZWxzOwogICAgICAgIGNoZWNrMigKICAgICAgICAgIHcgPiAwICYmIHcgPD0gbGltaXRzLm1heFRleHR1cmVTaXplICYmIGggPiAwICYmIGggPD0gbGltaXRzLm1heFRleHR1cmVTaXplLAogICAgICAgICAgImludmFsaWQgdGV4dHVyZSBzaGFwZSIKICAgICAgICApOwogICAgICAgIGNoZWNrMigKICAgICAgICAgIHcgPT09IGgsCiAgICAgICAgICAiY3ViZSBtYXAgbXVzdCBiZSBzcXVhcmUiCiAgICAgICAgKTsKICAgICAgICBjaGVjazIoCiAgICAgICAgICBpbmZvLndyYXBTID09PSBHTF9DTEFNUF9UT19FREdFICYmIGluZm8ud3JhcFQgPT09IEdMX0NMQU1QX1RPX0VER0UsCiAgICAgICAgICAid3JhcCBtb2RlIG5vdCBzdXBwb3J0ZWQgYnkgY3ViZSBtYXAiCiAgICAgICAgKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZhY2VzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgZmFjZSA9IGZhY2VzW2ldOwogICAgICAgICAgY2hlY2syKAogICAgICAgICAgICBmYWNlLndpZHRoID09PSB3ICYmIGZhY2UuaGVpZ2h0ID09PSBoLAogICAgICAgICAgICAiaW5jb25zaXN0ZW50IGN1YmUgbWFwIGZhY2Ugc2hhcGUiCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGluZm8uZ2VuTWlwbWFwcykgewogICAgICAgICAgICBjaGVjazIoCiAgICAgICAgICAgICAgIWZhY2UuY29tcHJlc3NlZCwKICAgICAgICAgICAgICAiY2FuIG5vdCBnZW5lcmF0ZSBtaXBtYXAgZm9yIGNvbXByZXNzZWQgdGV4dHVyZXMiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNoZWNrMigKICAgICAgICAgICAgICBmYWNlLm1pcG1hc2sgPT09IDEsCiAgICAgICAgICAgICAgImNhbiBub3Qgc3BlY2lmeSBtaXBtYXBzIGFuZCBnZW5lcmF0ZSBtaXBtYXBzIgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtaXBtYXBzID0gZmFjZS5pbWFnZXM7CiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IDE2OyArK2opIHsKICAgICAgICAgICAgdmFyIGltZyA9IG1pcG1hcHNbal07CiAgICAgICAgICAgIGlmIChpbWcpIHsKICAgICAgICAgICAgICB2YXIgbXcgPSB3ID4+IGo7CiAgICAgICAgICAgICAgdmFyIG1oID0gaCA+PiBqOwogICAgICAgICAgICAgIGNoZWNrMihmYWNlLm1pcG1hc2sgJiAxIDw8IGosICJtaXNzaW5nIG1pcG1hcCBkYXRhIik7CiAgICAgICAgICAgICAgY2hlY2syKAogICAgICAgICAgICAgICAgaW1nLndpZHRoID09PSBtdyAmJiBpbWcuaGVpZ2h0ID09PSBtaCwKICAgICAgICAgICAgICAgICJpbnZhbGlkIHNoYXBlIGZvciBtaXAgaW1hZ2VzIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2hlY2syKAogICAgICAgICAgICAgICAgaW1nLmZvcm1hdCA9PT0gdGV4dHVyZS5mb3JtYXQgJiYgaW1nLmludGVybmFsZm9ybWF0ID09PSB0ZXh0dXJlLmludGVybmFsZm9ybWF0ICYmIGltZy50eXBlID09PSB0ZXh0dXJlLnR5cGUsCiAgICAgICAgICAgICAgICAiaW5jb21wYXRpYmxlIHR5cGUgZm9yIG1pcCBpbWFnZSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChpbWcuY29tcHJlc3NlZCkgewogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW1nLmRhdGEpIHsKICAgICAgICAgICAgICAgIGNoZWNrMigKICAgICAgICAgICAgICAgICAgaW1nLmRhdGEuYnl0ZUxlbmd0aCA9PT0gbXcgKiBtaCAqIE1hdGgubWF4KHBpeGVsU2l6ZShpbWcudHlwZSwgYyksIGltZy51bnBhY2tBbGlnbm1lbnQpLAogICAgICAgICAgICAgICAgICAiaW52YWxpZCBkYXRhIGZvciBpbWFnZSwgYnVmZmVyIHNpemUgaXMgaW5jb25zaXN0ZW50IHdpdGggaW1hZ2UgZm9ybWF0IgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGltZy5lbGVtZW50KSB7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbWcuY29weSkgewogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgY2hlY2skMSA9IGV4dGVuZDIoY2hlY2syLCB7CiAgICAgICAgb3B0aW9uYWw6IGNoZWNrT3B0aW9uYWwsCiAgICAgICAgcmFpc2U6IHJhaXNlMiwKICAgICAgICBjb21tYW5kUmFpc2UsCiAgICAgICAgY29tbWFuZDogY2hlY2tDb21tYW5kLAogICAgICAgIHBhcmFtZXRlcjogY2hlY2tQYXJhbWV0ZXIsCiAgICAgICAgY29tbWFuZFBhcmFtZXRlcjogY2hlY2tQYXJhbWV0ZXJDb21tYW5kLAogICAgICAgIGNvbnN0cnVjdG9yOiBjaGVja0NvbnN0cnVjdG9yLAogICAgICAgIHR5cGU6IGNoZWNrVHlwZU9mLAogICAgICAgIGNvbW1hbmRUeXBlOiBjaGVja0NvbW1hbmRUeXBlLAogICAgICAgIGlzVHlwZWRBcnJheTogY2hlY2tJc1R5cGVkQXJyYXksCiAgICAgICAgbm5pOiBjaGVja05vbk5lZ2F0aXZlSW50LAogICAgICAgIG9uZU9mOiBjaGVja09uZU9mMiwKICAgICAgICBzaGFkZXJFcnJvcjogY2hlY2tTaGFkZXJFcnJvciwKICAgICAgICBsaW5rRXJyb3I6IGNoZWNrTGlua0Vycm9yLAogICAgICAgIGNhbGxTaXRlOiBndWVzc0NhbGxTaXRlLAogICAgICAgIHNhdmVDb21tYW5kUmVmLAogICAgICAgIHNhdmVEcmF3SW5mbzogc2F2ZURyYXdDb21tYW5kSW5mbywKICAgICAgICBmcmFtZWJ1ZmZlckZvcm1hdDogY2hlY2tGcmFtZWJ1ZmZlckZvcm1hdCwKICAgICAgICBndWVzc0NvbW1hbmQsCiAgICAgICAgdGV4dHVyZTJEOiBjaGVja1RleHR1cmUyRCwKICAgICAgICB0ZXh0dXJlQ3ViZTogY2hlY2tUZXh0dXJlQ3ViZQogICAgICB9KTsKICAgICAgdmFyIFZBUklBQkxFX0NPVU5URVIgPSAwOwogICAgICB2YXIgRFlOX0ZVTkMgPSAwOwogICAgICB2YXIgRFlOX0NPTlNUQU5UID0gNTsKICAgICAgdmFyIERZTl9BUlJBWSA9IDY7CiAgICAgIGZ1bmN0aW9uIER5bmFtaWNWYXJpYWJsZSh0eXBlLCBkYXRhKSB7CiAgICAgICAgdGhpcy5pZCA9IFZBUklBQkxFX0NPVU5URVIrKzsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZXNjYXBlU3RyKHN0cikgewogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvXFwvZywgIlxcXFwiKS5yZXBsYWNlKC8iL2csICdcXCInKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzcGxpdFBhcnRzKHN0cikgewogICAgICAgIGlmIChzdHIubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfQogICAgICAgIHZhciBmaXJzdENoYXIgPSBzdHIuY2hhckF0KDApOwogICAgICAgIHZhciBsYXN0Q2hhciA9IHN0ci5jaGFyQXQoc3RyLmxlbmd0aCAtIDEpOwogICAgICAgIGlmIChzdHIubGVuZ3RoID4gMSAmJiBmaXJzdENoYXIgPT09IGxhc3RDaGFyICYmIChmaXJzdENoYXIgPT09ICciJyB8fCBmaXJzdENoYXIgPT09ICInIikpIHsKICAgICAgICAgIHJldHVybiBbJyInICsgZXNjYXBlU3RyKHN0ci5zdWJzdHIoMSwgc3RyLmxlbmd0aCAtIDIpKSArICciJ107CiAgICAgICAgfQogICAgICAgIHZhciBwYXJ0cyA9IC9cWyhmYWxzZXx0cnVlfG51bGx8XGQrfCdbXiddKid8IlteIl0qIilcXS8uZXhlYyhzdHIpOwogICAgICAgIGlmIChwYXJ0cykgewogICAgICAgICAgcmV0dXJuIHNwbGl0UGFydHMoc3RyLnN1YnN0cigwLCBwYXJ0cy5pbmRleCkpLmNvbmNhdChzcGxpdFBhcnRzKHBhcnRzWzFdKSkuY29uY2F0KHNwbGl0UGFydHMoc3RyLnN1YnN0cihwYXJ0cy5pbmRleCArIHBhcnRzWzBdLmxlbmd0aCkpKTsKICAgICAgICB9CiAgICAgICAgdmFyIHN1YnBhcnRzID0gc3RyLnNwbGl0KCIuIik7CiAgICAgICAgaWYgKHN1YnBhcnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIFsnIicgKyBlc2NhcGVTdHIoc3RyKSArICciJ107CiAgICAgICAgfQogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN1YnBhcnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KHNwbGl0UGFydHMoc3VicGFydHNbaV0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBmdW5jdGlvbiB0b0FjY2Vzc29yU3RyaW5nKHN0cikgewogICAgICAgIHJldHVybiAiWyIgKyBzcGxpdFBhcnRzKHN0cikuam9pbigiXVsiKSArICJdIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBkZWZpbmVEeW5hbWljKHR5cGUsIGRhdGEpIHsKICAgICAgICByZXR1cm4gbmV3IER5bmFtaWNWYXJpYWJsZSh0eXBlLCB0b0FjY2Vzc29yU3RyaW5nKGRhdGEgKyAiIikpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzRHluYW1pYyh4KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB4ID09PSAiZnVuY3Rpb24iICYmICF4Ll9yZWdsVHlwZSB8fCB4IGluc3RhbmNlb2YgRHluYW1pY1ZhcmlhYmxlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVuYm94KHgsIHBhdGgpIHsKICAgICAgICBpZiAodHlwZW9mIHggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJldHVybiBuZXcgRHluYW1pY1ZhcmlhYmxlKERZTl9GVU5DLCB4KTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB4ID09PSAibnVtYmVyIiB8fCB0eXBlb2YgeCA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICByZXR1cm4gbmV3IER5bmFtaWNWYXJpYWJsZShEWU5fQ09OU1RBTlQsIHgpOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh4KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBEeW5hbWljVmFyaWFibGUoRFlOX0FSUkFZLCB4Lm1hcChmdW5jdGlvbih5LCBpKSB7CiAgICAgICAgICAgIHJldHVybiB1bmJveCh5LCBwYXRoICsgIlsiICsgaSArICJdIik7CiAgICAgICAgICB9KSk7CiAgICAgICAgfSBlbHNlIGlmICh4IGluc3RhbmNlb2YgRHluYW1pY1ZhcmlhYmxlKSB7CiAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9CiAgICAgICAgY2hlY2skMShmYWxzZSwgImludmFsaWQgb3B0aW9uIHR5cGUgaW4gdW5pZm9ybSAiICsgcGF0aCk7CiAgICAgIH0KICAgICAgdmFyIGR5bmFtaWMgPSB7CiAgICAgICAgRHluYW1pY1ZhcmlhYmxlLAogICAgICAgIGRlZmluZTogZGVmaW5lRHluYW1pYywKICAgICAgICBpc0R5bmFtaWMsCiAgICAgICAgdW5ib3gsCiAgICAgICAgYWNjZXNzb3I6IHRvQWNjZXNzb3JTdHJpbmcKICAgICAgfTsKICAgICAgdmFyIHJhZiA9IHsKICAgICAgICBuZXh0OiB0eXBlb2YgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID09PSAiZnVuY3Rpb24iID8gZnVuY3Rpb24oY2IpIHsKICAgICAgICAgIHJldHVybiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2IpOwogICAgICAgIH0gOiBmdW5jdGlvbihjYikgewogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoY2IsIDE2KTsKICAgICAgICB9LAogICAgICAgIGNhbmNlbDogdHlwZW9mIGNhbmNlbEFuaW1hdGlvbkZyYW1lID09PSAiZnVuY3Rpb24iID8gZnVuY3Rpb24ocmFmMikgewogICAgICAgICAgcmV0dXJuIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJhZjIpOwogICAgICAgIH0gOiBjbGVhclRpbWVvdXQKICAgICAgfTsKICAgICAgdmFyIGNsb2NrID0gdHlwZW9mIHBlcmZvcm1hbmNlICE9PSAidW5kZWZpbmVkIiAmJiBwZXJmb3JtYW5jZS5ub3cgPyBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0gOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKy8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogICAgICB9OwogICAgICBmdW5jdGlvbiBjcmVhdGVTdHJpbmdTdG9yZSgpIHsKICAgICAgICB2YXIgc3RyaW5nSWRzID0geyAiIjogMCB9OwogICAgICAgIHZhciBzdHJpbmdWYWx1ZXMgPSBbIiJdOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpZDogZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBzdHJpbmdJZHNbc3RyXTsKICAgICAgICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gc3RyaW5nSWRzW3N0cl0gPSBzdHJpbmdWYWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBzdHJpbmdWYWx1ZXMucHVzaChzdHIpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfSwKICAgICAgICAgIHN0cjogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlc1tpZF07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVDYW52YXMoZWxlbWVudCwgb25Eb25lLCBwaXhlbFJhdGlvKSB7CiAgICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICAgIGV4dGVuZDIoY2FudmFzLnN0eWxlLCB7CiAgICAgICAgICBib3JkZXI6IDAsCiAgICAgICAgICBtYXJnaW46IDAsCiAgICAgICAgICBwYWRkaW5nOiAwLAogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMCwKICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICBoZWlnaHQ6ICIxMDAlIgogICAgICAgIH0pOwogICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoY2FudmFzKTsKICAgICAgICBpZiAoZWxlbWVudCA9PT0gZG9jdW1lbnQuYm9keSkgewogICAgICAgICAgY2FudmFzLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgICAgICAgIGV4dGVuZDIoZWxlbWVudC5zdHlsZSwgewogICAgICAgICAgICBtYXJnaW46IDAsCiAgICAgICAgICAgIHBhZGRpbmc6IDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNpemUyKCkgewogICAgICAgICAgdmFyIHcgPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICAgIHZhciBoID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgICAgICAgaWYgKGVsZW1lbnQgIT09IGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAgICAgdmFyIGJvdW5kcyA9IGNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgdyA9IGJvdW5kcy5yaWdodCAtIGJvdW5kcy5sZWZ0OwogICAgICAgICAgICBoID0gYm91bmRzLmJvdHRvbSAtIGJvdW5kcy50b3A7CiAgICAgICAgICB9CiAgICAgICAgICBjYW52YXMud2lkdGggPSBwaXhlbFJhdGlvICogdzsKICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBwaXhlbFJhdGlvICogaDsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc2l6ZU9ic2VydmVyOwogICAgICAgIGlmIChlbGVtZW50ICE9PSBkb2N1bWVudC5ib2R5ICYmIHR5cGVvZiBSZXNpemVPYnNlcnZlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgcmVzaXplT2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQocmVzaXplMik7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJlc2l6ZU9ic2VydmVyLm9ic2VydmUoZWxlbWVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCByZXNpemUyLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uRGVzdHJveSgpIHsKICAgICAgICAgIGlmIChyZXNpemVPYnNlcnZlcikgewogICAgICAgICAgICByZXNpemVPYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgcmVzaXplMik7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50LnJlbW92ZUNoaWxkKGNhbnZhcyk7CiAgICAgICAgfQogICAgICAgIHJlc2l6ZTIoKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgY2FudmFzLAogICAgICAgICAgb25EZXN0cm95CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVDb250ZXh0KGNhbnZhcywgY29udGV4dEF0dHJpYnV0ZXMpIHsKICAgICAgICBmdW5jdGlvbiBnZXQobmFtZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGNhbnZhcy5nZXRDb250ZXh0KG5hbWUsIGNvbnRleHRBdHRyaWJ1dGVzKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXQoIndlYmdsIikgfHwgZ2V0KCJleHBlcmltZW50YWwtd2ViZ2wiKSB8fCBnZXQoIndlYmdsLWV4cGVyaW1lbnRhbCIpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzSFRNTEVsZW1lbnQob2JqKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmoubm9kZU5hbWUgPT09ICJzdHJpbmciICYmIHR5cGVvZiBvYmouYXBwZW5kQ2hpbGQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG9iai5nZXRCb3VuZGluZ0NsaWVudFJlY3QgPT09ICJmdW5jdGlvbiI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNXZWJHTENvbnRleHQob2JqKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmouZHJhd0FycmF5cyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2Ygb2JqLmRyYXdFbGVtZW50cyA9PT0gImZ1bmN0aW9uIjsKICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZUV4dGVuc2lvbnMoaW5wdXQpIHsKICAgICAgICBpZiAodHlwZW9mIGlucHV0ID09PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIGlucHV0LnNwbGl0KCk7CiAgICAgICAgfQogICAgICAgIGNoZWNrJDEoQXJyYXkuaXNBcnJheShpbnB1dCksICJpbnZhbGlkIGV4dGVuc2lvbiBhcnJheSIpOwogICAgICAgIHJldHVybiBpbnB1dDsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRFbGVtZW50KGRlc2MpIHsKICAgICAgICBpZiAodHlwZW9mIGRlc2MgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBjaGVjayQxKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIsICJub3Qgc3VwcG9ydGVkIG91dHNpZGUgb2YgRE9NIik7CiAgICAgICAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihkZXNjKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc2M7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2VBcmdzKGFyZ3NfKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmdzXyB8fCB7fTsKICAgICAgICB2YXIgZWxlbWVudCwgY29udGFpbmVyLCBjYW52YXMsIGdsOwogICAgICAgIHZhciBjb250ZXh0QXR0cmlidXRlcyA9IHt9OwogICAgICAgIHZhciBleHRlbnNpb25zID0gW107CiAgICAgICAgdmFyIG9wdGlvbmFsRXh0ZW5zaW9ucyA9IFtdOwogICAgICAgIHZhciBwaXhlbFJhdGlvID0gdHlwZW9mIHdpbmRvdyA9PT0gInVuZGVmaW5lZCIgPyAxIDogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICAgICAgdmFyIHByb2ZpbGUgPSBmYWxzZTsKICAgICAgICB2YXIgb25Eb25lID0gZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIGNoZWNrJDEucmFpc2UoZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBvbkRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIGlmICh0eXBlb2YgYXJncyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIsCiAgICAgICAgICAgICJzZWxlY3RvciBxdWVyaWVzIG9ubHkgc3VwcG9ydGVkIGluIERPTSBlbnZpcm9ubWVudHMiCiAgICAgICAgICApOwogICAgICAgICAgZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYXJncyk7CiAgICAgICAgICBjaGVjayQxKGVsZW1lbnQsICJpbnZhbGlkIHF1ZXJ5IHN0cmluZyBmb3IgZWxlbWVudCIpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3MgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICBpZiAoaXNIVE1MRWxlbWVudChhcmdzKSkgewogICAgICAgICAgICBlbGVtZW50ID0gYXJnczsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNXZWJHTENvbnRleHQoYXJncykpIHsKICAgICAgICAgICAgZ2wgPSBhcmdzOwogICAgICAgICAgICBjYW52YXMgPSBnbC5jYW52YXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGVjayQxLmNvbnN0cnVjdG9yKGFyZ3MpOwogICAgICAgICAgICBpZiAoImdsIiBpbiBhcmdzKSB7CiAgICAgICAgICAgICAgZ2wgPSBhcmdzLmdsOwogICAgICAgICAgICB9IGVsc2UgaWYgKCJjYW52YXMiIGluIGFyZ3MpIHsKICAgICAgICAgICAgICBjYW52YXMgPSBnZXRFbGVtZW50KGFyZ3MuY2FudmFzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgiY29udGFpbmVyIiBpbiBhcmdzKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyID0gZ2V0RWxlbWVudChhcmdzLmNvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCJhdHRyaWJ1dGVzIiBpbiBhcmdzKSB7CiAgICAgICAgICAgICAgY29udGV4dEF0dHJpYnV0ZXMgPSBhcmdzLmF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgY2hlY2skMS50eXBlKGNvbnRleHRBdHRyaWJ1dGVzLCAib2JqZWN0IiwgImludmFsaWQgY29udGV4dCBhdHRyaWJ1dGVzIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCJleHRlbnNpb25zIiBpbiBhcmdzKSB7CiAgICAgICAgICAgICAgZXh0ZW5zaW9ucyA9IHBhcnNlRXh0ZW5zaW9ucyhhcmdzLmV4dGVuc2lvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgib3B0aW9uYWxFeHRlbnNpb25zIiBpbiBhcmdzKSB7CiAgICAgICAgICAgICAgb3B0aW9uYWxFeHRlbnNpb25zID0gcGFyc2VFeHRlbnNpb25zKGFyZ3Mub3B0aW9uYWxFeHRlbnNpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIm9uRG9uZSIgaW4gYXJncykgewogICAgICAgICAgICAgIGNoZWNrJDEudHlwZSgKICAgICAgICAgICAgICAgIGFyZ3Mub25Eb25lLAogICAgICAgICAgICAgICAgImZ1bmN0aW9uIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkIG9yIG1pc3Npbmcgb25Eb25lIGNhbGxiYWNrIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb25Eb25lID0gYXJncy5vbkRvbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCJwcm9maWxlIiBpbiBhcmdzKSB7CiAgICAgICAgICAgICAgcHJvZmlsZSA9ICEhYXJncy5wcm9maWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgicGl4ZWxSYXRpbyIgaW4gYXJncykgewogICAgICAgICAgICAgIHBpeGVsUmF0aW8gPSArYXJncy5waXhlbFJhdGlvOwogICAgICAgICAgICAgIGNoZWNrJDEocGl4ZWxSYXRpbyA+IDAsICJpbnZhbGlkIHBpeGVsIHJhdGlvIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2skMS5yYWlzZSgiaW52YWxpZCBhcmd1bWVudHMgdG8gcmVnbCIpOwogICAgICAgIH0KICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgaWYgKGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImNhbnZhcyIpIHsKICAgICAgICAgICAgY2FudmFzID0gZWxlbWVudDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lciA9IGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZ2wpIHsKICAgICAgICAgIGlmICghY2FudmFzKSB7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiwKICAgICAgICAgICAgICAibXVzdCBtYW51YWxseSBzcGVjaWZ5IHdlYmdsIGNvbnRleHQgb3V0c2lkZSBvZiBET00gZW52aXJvbm1lbnRzIgogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gY3JlYXRlQ2FudmFzKGNvbnRhaW5lciB8fCBkb2N1bWVudC5ib2R5LCBvbkRvbmUsIHBpeGVsUmF0aW8pOwogICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbnZhcyA9IHJlc3VsdC5jYW52YXM7CiAgICAgICAgICAgIG9uRGVzdHJveSA9IHJlc3VsdC5vbkRlc3Ryb3k7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGV4dEF0dHJpYnV0ZXMucHJlbXVsdGlwbGllZEFscGhhID09PSB2b2lkIDApIGNvbnRleHRBdHRyaWJ1dGVzLnByZW11bHRpcGxpZWRBbHBoYSA9IHRydWU7CiAgICAgICAgICBnbCA9IGNyZWF0ZUNvbnRleHQoY2FudmFzLCBjb250ZXh0QXR0cmlidXRlcyk7CiAgICAgICAgfQogICAgICAgIGlmICghZ2wpIHsKICAgICAgICAgIG9uRGVzdHJveSgpOwogICAgICAgICAgb25Eb25lKCJ3ZWJnbCBub3Qgc3VwcG9ydGVkLCB0cnkgdXBncmFkaW5nIHlvdXIgYnJvd3NlciBvciBncmFwaGljcyBkcml2ZXJzIGh0dHA6Ly9nZXQud2ViZ2wub3JnIik7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdsLAogICAgICAgICAgY2FudmFzLAogICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgZXh0ZW5zaW9ucywKICAgICAgICAgIG9wdGlvbmFsRXh0ZW5zaW9ucywKICAgICAgICAgIHBpeGVsUmF0aW8sCiAgICAgICAgICBwcm9maWxlLAogICAgICAgICAgb25Eb25lLAogICAgICAgICAgb25EZXN0cm95CiAgICAgICAgfTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVFeHRlbnNpb25DYWNoZShnbCwgY29uZmlnKSB7CiAgICAgICAgdmFyIGV4dGVuc2lvbnMgPSB7fTsKICAgICAgICBmdW5jdGlvbiB0cnlMb2FkRXh0ZW5zaW9uKG5hbWVfKSB7CiAgICAgICAgICBjaGVjayQxLnR5cGUobmFtZV8sICJzdHJpbmciLCAiZXh0ZW5zaW9uIG5hbWUgbXVzdCBiZSBzdHJpbmciKTsKICAgICAgICAgIHZhciBuYW1lMiA9IG5hbWVfLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICB2YXIgZXh0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZXh0ID0gZXh0ZW5zaW9uc1tuYW1lMl0gPSBnbC5nZXRFeHRlbnNpb24obmFtZTIpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICEhZXh0OwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmZpZy5leHRlbnNpb25zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGNvbmZpZy5leHRlbnNpb25zW2ldOwogICAgICAgICAgaWYgKCF0cnlMb2FkRXh0ZW5zaW9uKG5hbWUpKSB7CiAgICAgICAgICAgIGNvbmZpZy5vbkRlc3Ryb3koKTsKICAgICAgICAgICAgY29uZmlnLm9uRG9uZSgnIicgKyBuYW1lICsgJyIgZXh0ZW5zaW9uIGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIGN1cnJlbnQgV2ViR0wgY29udGV4dCwgdHJ5IHVwZ3JhZGluZyB5b3VyIHN5c3RlbSBvciBhIGRpZmZlcmVudCBicm93c2VyJyk7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25maWcub3B0aW9uYWxFeHRlbnNpb25zLmZvckVhY2godHJ5TG9hZEV4dGVuc2lvbik7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGV4dGVuc2lvbnMsCiAgICAgICAgICByZXN0b3JlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgT2JqZWN0LmtleXMoZXh0ZW5zaW9ucykuZm9yRWFjaChmdW5jdGlvbihuYW1lMikgewogICAgICAgICAgICAgIGlmIChleHRlbnNpb25zW25hbWUyXSAmJiAhdHJ5TG9hZEV4dGVuc2lvbihuYW1lMikpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiKHJlZ2wpOiBlcnJvciByZXN0b3JpbmcgZXh0ZW5zaW9uICIgKyBuYW1lMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvb3AobiwgZikgewogICAgICAgIHZhciByZXN1bHQgPSBBcnJheShuKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gZihpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICB2YXIgR0xfQllURSQxID0gNTEyMDsKICAgICAgdmFyIEdMX1VOU0lHTkVEX0JZVEUkMiA9IDUxMjE7CiAgICAgIHZhciBHTF9TSE9SVCQxID0gNTEyMjsKICAgICAgdmFyIEdMX1VOU0lHTkVEX1NIT1JUJDEgPSA1MTIzOwogICAgICB2YXIgR0xfSU5UJDEgPSA1MTI0OwogICAgICB2YXIgR0xfVU5TSUdORURfSU5UJDEgPSA1MTI1OwogICAgICB2YXIgR0xfRkxPQVQkMiA9IDUxMjY7CiAgICAgIGZ1bmN0aW9uIG5leHRQb3cxNih2KSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDE2OyBpIDw9IDEgPDwgMjg7IGkgKj0gMTYpIHsKICAgICAgICAgIGlmICh2IDw9IGkpIHsKICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvZzIodikgewogICAgICAgIHZhciByLCBzaGlmdDsKICAgICAgICByID0gKHYgPiA2NTUzNSkgPDwgNDsKICAgICAgICB2ID4+Pj0gcjsKICAgICAgICBzaGlmdCA9ICh2ID4gMjU1KSA8PCAzOwogICAgICAgIHYgPj4+PSBzaGlmdDsKICAgICAgICByIHw9IHNoaWZ0OwogICAgICAgIHNoaWZ0ID0gKHYgPiAxNSkgPDwgMjsKICAgICAgICB2ID4+Pj0gc2hpZnQ7CiAgICAgICAgciB8PSBzaGlmdDsKICAgICAgICBzaGlmdCA9ICh2ID4gMykgPDwgMTsKICAgICAgICB2ID4+Pj0gc2hpZnQ7CiAgICAgICAgciB8PSBzaGlmdDsKICAgICAgICByZXR1cm4gciB8IHYgPj4gMTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVQb29sKCkgewogICAgICAgIHZhciBidWZmZXJQb29sID0gbG9vcCg4LCBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBhbGxvYyhuKSB7CiAgICAgICAgICB2YXIgc3ogPSBuZXh0UG93MTYobik7CiAgICAgICAgICB2YXIgYmluID0gYnVmZmVyUG9vbFtsb2cyKHN6KSA+PiAyXTsKICAgICAgICAgIGlmIChiaW4ubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXR1cm4gYmluLnBvcCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ldyBBcnJheUJ1ZmZlcihzeik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZyZWUoYnVmMikgewogICAgICAgICAgYnVmZmVyUG9vbFtsb2cyKGJ1ZjIuYnl0ZUxlbmd0aCkgPj4gMl0ucHVzaChidWYyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWxsb2NUeXBlKHR5cGUsIG4pIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgR0xfQllURSQxOgogICAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBJbnQ4QXJyYXkoYWxsb2MobiksIDAsIG4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEdMX1VOU0lHTkVEX0JZVEUkMjoKICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgVWludDhBcnJheShhbGxvYyhuKSwgMCwgbik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgR0xfU0hPUlQkMToKICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgSW50MTZBcnJheShhbGxvYygyICogbiksIDAsIG4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEdMX1VOU0lHTkVEX1NIT1JUJDE6CiAgICAgICAgICAgICAgcmVzdWx0ID0gbmV3IFVpbnQxNkFycmF5KGFsbG9jKDIgKiBuKSwgMCwgbik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgR0xfSU5UJDE6CiAgICAgICAgICAgICAgcmVzdWx0ID0gbmV3IEludDMyQXJyYXkoYWxsb2MoNCAqIG4pLCAwLCBuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBHTF9VTlNJR05FRF9JTlQkMToKICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgVWludDMyQXJyYXkoYWxsb2MoNCAqIG4pLCAwLCBuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBHTF9GTE9BVCQyOgogICAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBGbG9hdDMyQXJyYXkoYWxsb2MoNCAqIG4pLCAwLCBuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoICE9PSBuKSB7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQuc3ViYXJyYXkoMCwgbik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmcmVlVHlwZShhcnJheTIpIHsKICAgICAgICAgIGZyZWUoYXJyYXkyLmJ1ZmZlcik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBhbGxvYywKICAgICAgICAgIGZyZWUsCiAgICAgICAgICBhbGxvY1R5cGUsCiAgICAgICAgICBmcmVlVHlwZQogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIHBvb2wgPSBjcmVhdGVQb29sKCk7CiAgICAgIHBvb2wuemVybyA9IGNyZWF0ZVBvb2woKTsKICAgICAgdmFyIEdMX1NVQlBJWEVMX0JJVFMgPSAzNDA4OwogICAgICB2YXIgR0xfUkVEX0JJVFMgPSAzNDEwOwogICAgICB2YXIgR0xfR1JFRU5fQklUUyA9IDM0MTE7CiAgICAgIHZhciBHTF9CTFVFX0JJVFMgPSAzNDEyOwogICAgICB2YXIgR0xfQUxQSEFfQklUUyA9IDM0MTM7CiAgICAgIHZhciBHTF9ERVBUSF9CSVRTID0gMzQxNDsKICAgICAgdmFyIEdMX1NURU5DSUxfQklUUyA9IDM0MTU7CiAgICAgIHZhciBHTF9BTElBU0VEX1BPSU5UX1NJWkVfUkFOR0UgPSAzMzkwMTsKICAgICAgdmFyIEdMX0FMSUFTRURfTElORV9XSURUSF9SQU5HRSA9IDMzOTAyOwogICAgICB2YXIgR0xfTUFYX1RFWFRVUkVfU0laRSA9IDMzNzk7CiAgICAgIHZhciBHTF9NQVhfVklFV1BPUlRfRElNUyA9IDMzODY7CiAgICAgIHZhciBHTF9NQVhfVkVSVEVYX0FUVFJJQlMgPSAzNDkyMTsKICAgICAgdmFyIEdMX01BWF9WRVJURVhfVU5JRk9STV9WRUNUT1JTID0gMzYzNDc7CiAgICAgIHZhciBHTF9NQVhfVkFSWUlOR19WRUNUT1JTID0gMzYzNDg7CiAgICAgIHZhciBHTF9NQVhfQ09NQklORURfVEVYVFVSRV9JTUFHRV9VTklUUyA9IDM1NjYxOwogICAgICB2YXIgR0xfTUFYX1ZFUlRFWF9URVhUVVJFX0lNQUdFX1VOSVRTID0gMzU2NjA7CiAgICAgIHZhciBHTF9NQVhfVEVYVFVSRV9JTUFHRV9VTklUUyA9IDM0OTMwOwogICAgICB2YXIgR0xfTUFYX0ZSQUdNRU5UX1VOSUZPUk1fVkVDVE9SUyA9IDM2MzQ5OwogICAgICB2YXIgR0xfTUFYX0NVQkVfTUFQX1RFWFRVUkVfU0laRSA9IDM0MDc2OwogICAgICB2YXIgR0xfTUFYX1JFTkRFUkJVRkZFUl9TSVpFID0gMzQwMjQ7CiAgICAgIHZhciBHTF9WRU5ET1IgPSA3OTM2OwogICAgICB2YXIgR0xfUkVOREVSRVIgPSA3OTM3OwogICAgICB2YXIgR0xfVkVSU0lPTiA9IDc5Mzg7CiAgICAgIHZhciBHTF9TSEFESU5HX0xBTkdVQUdFX1ZFUlNJT04gPSAzNTcyNDsKICAgICAgdmFyIEdMX01BWF9URVhUVVJFX01BWF9BTklTT1RST1BZX0VYVCA9IDM0MDQ3OwogICAgICB2YXIgR0xfTUFYX0NPTE9SX0FUVEFDSE1FTlRTX1dFQkdMID0gMzYwNjM7CiAgICAgIHZhciBHTF9NQVhfRFJBV19CVUZGRVJTX1dFQkdMID0gMzQ4NTI7CiAgICAgIHZhciBHTF9URVhUVVJFXzJEID0gMzU1MzsKICAgICAgdmFyIEdMX1RFWFRVUkVfQ1VCRV9NQVAgPSAzNDA2NzsKICAgICAgdmFyIEdMX1RFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCA9IDM0MDY5OwogICAgICB2YXIgR0xfVEVYVFVSRTAgPSAzMzk4NDsKICAgICAgdmFyIEdMX1JHQkEgPSA2NDA4OwogICAgICB2YXIgR0xfRkxPQVQkMSA9IDUxMjY7CiAgICAgIHZhciBHTF9VTlNJR05FRF9CWVRFJDEgPSA1MTIxOwogICAgICB2YXIgR0xfRlJBTUVCVUZGRVIgPSAzNjE2MDsKICAgICAgdmFyIEdMX0ZSQU1FQlVGRkVSX0NPTVBMRVRFID0gMzYwNTM7CiAgICAgIHZhciBHTF9DT0xPUl9BVFRBQ0hNRU5UMCA9IDM2MDY0OwogICAgICB2YXIgR0xfQ09MT1JfQlVGRkVSX0JJVCQxID0gMTYzODQ7CiAgICAgIHZhciB3cmFwTGltaXRzID0gZnVuY3Rpb24oZ2wsIGV4dGVuc2lvbnMpIHsKICAgICAgICB2YXIgbWF4QW5pc290cm9waWMgPSAxOwogICAgICAgIGlmIChleHRlbnNpb25zLmV4dF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYykgewogICAgICAgICAgbWF4QW5pc290cm9waWMgPSBnbC5nZXRQYXJhbWV0ZXIoR0xfTUFYX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUKTsKICAgICAgICB9CiAgICAgICAgdmFyIG1heERyYXdidWZmZXJzID0gMTsKICAgICAgICB2YXIgbWF4Q29sb3JBdHRhY2htZW50cyA9IDE7CiAgICAgICAgaWYgKGV4dGVuc2lvbnMud2ViZ2xfZHJhd19idWZmZXJzKSB7CiAgICAgICAgICBtYXhEcmF3YnVmZmVycyA9IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfRFJBV19CVUZGRVJTX1dFQkdMKTsKICAgICAgICAgIG1heENvbG9yQXR0YWNobWVudHMgPSBnbC5nZXRQYXJhbWV0ZXIoR0xfTUFYX0NPTE9SX0FUVEFDSE1FTlRTX1dFQkdMKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlYWRGbG9hdCA9ICEhZXh0ZW5zaW9ucy5vZXNfdGV4dHVyZV9mbG9hdDsKICAgICAgICBpZiAocmVhZEZsb2F0KSB7CiAgICAgICAgICB2YXIgcmVhZEZsb2F0VGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKEdMX1RFWFRVUkVfMkQsIHJlYWRGbG9hdFRleHR1cmUpOwogICAgICAgICAgZ2wudGV4SW1hZ2UyRChHTF9URVhUVVJFXzJELCAwLCBHTF9SR0JBLCAxLCAxLCAwLCBHTF9SR0JBLCBHTF9GTE9BVCQxLCBudWxsKTsKICAgICAgICAgIHZhciBmYm8gPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwogICAgICAgICAgZ2wuYmluZEZyYW1lYnVmZmVyKEdMX0ZSQU1FQlVGRkVSLCBmYm8pOwogICAgICAgICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoR0xfRlJBTUVCVUZGRVIsIEdMX0NPTE9SX0FUVEFDSE1FTlQwLCBHTF9URVhUVVJFXzJELCByZWFkRmxvYXRUZXh0dXJlLCAwKTsKICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKEdMX1RFWFRVUkVfMkQsIG51bGwpOwogICAgICAgICAgaWYgKGdsLmNoZWNrRnJhbWVidWZmZXJTdGF0dXMoR0xfRlJBTUVCVUZGRVIpICE9PSBHTF9GUkFNRUJVRkZFUl9DT01QTEVURSkgcmVhZEZsb2F0ID0gZmFsc2U7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZ2wudmlld3BvcnQoMCwgMCwgMSwgMSk7CiAgICAgICAgICAgIGdsLmNsZWFyQ29sb3IoMSwgMCwgMCwgMSk7CiAgICAgICAgICAgIGdsLmNsZWFyKEdMX0NPTE9SX0JVRkZFUl9CSVQkMSk7CiAgICAgICAgICAgIHZhciBwaXhlbHMgPSBwb29sLmFsbG9jVHlwZShHTF9GTE9BVCQxLCA0KTsKICAgICAgICAgICAgZ2wucmVhZFBpeGVscygwLCAwLCAxLCAxLCBHTF9SR0JBLCBHTF9GTE9BVCQxLCBwaXhlbHMpOwogICAgICAgICAgICBpZiAoZ2wuZ2V0RXJyb3IoKSkgcmVhZEZsb2F0ID0gZmFsc2U7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIGdsLmRlbGV0ZUZyYW1lYnVmZmVyKGZibyk7CiAgICAgICAgICAgICAgZ2wuZGVsZXRlVGV4dHVyZShyZWFkRmxvYXRUZXh0dXJlKTsKICAgICAgICAgICAgICByZWFkRmxvYXQgPSBwaXhlbHNbMF0gPT09IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcG9vbC5mcmVlVHlwZShwaXhlbHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNJRSA9IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmICgvTVNJRS8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSB8fCAvVHJpZGVudFwvLy50ZXN0KG5hdmlnYXRvci5hcHBWZXJzaW9uKSB8fCAvRWRnZS8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSk7CiAgICAgICAgdmFyIG5wb3RUZXh0dXJlQ3ViZSA9IHRydWU7CiAgICAgICAgaWYgKCFpc0lFKSB7CiAgICAgICAgICB2YXIgY3ViZVRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICAgICAgICB2YXIgZGF0YSA9IHBvb2wuYWxsb2NUeXBlKEdMX1VOU0lHTkVEX0JZVEUkMSwgMzYpOwogICAgICAgICAgZ2wuYWN0aXZlVGV4dHVyZShHTF9URVhUVVJFMCk7CiAgICAgICAgICBnbC5iaW5kVGV4dHVyZShHTF9URVhUVVJFX0NVQkVfTUFQLCBjdWJlVGV4dHVyZSk7CiAgICAgICAgICBnbC50ZXhJbWFnZTJEKEdMX1RFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCwgMCwgR0xfUkdCQSwgMywgMywgMCwgR0xfUkdCQSwgR0xfVU5TSUdORURfQllURSQxLCBkYXRhKTsKICAgICAgICAgIHBvb2wuZnJlZVR5cGUoZGF0YSk7CiAgICAgICAgICBnbC5iaW5kVGV4dHVyZShHTF9URVhUVVJFX0NVQkVfTUFQLCBudWxsKTsKICAgICAgICAgIGdsLmRlbGV0ZVRleHR1cmUoY3ViZVRleHR1cmUpOwogICAgICAgICAgbnBvdFRleHR1cmVDdWJlID0gIWdsLmdldEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAvLyBkcmF3aW5nIGJ1ZmZlciBiaXQgZGVwdGgKICAgICAgICAgIGNvbG9yQml0czogWwogICAgICAgICAgICBnbC5nZXRQYXJhbWV0ZXIoR0xfUkVEX0JJVFMpLAogICAgICAgICAgICBnbC5nZXRQYXJhbWV0ZXIoR0xfR1JFRU5fQklUUyksCiAgICAgICAgICAgIGdsLmdldFBhcmFtZXRlcihHTF9CTFVFX0JJVFMpLAogICAgICAgICAgICBnbC5nZXRQYXJhbWV0ZXIoR0xfQUxQSEFfQklUUykKICAgICAgICAgIF0sCiAgICAgICAgICBkZXB0aEJpdHM6IGdsLmdldFBhcmFtZXRlcihHTF9ERVBUSF9CSVRTKSwKICAgICAgICAgIHN0ZW5jaWxCaXRzOiBnbC5nZXRQYXJhbWV0ZXIoR0xfU1RFTkNJTF9CSVRTKSwKICAgICAgICAgIHN1YnBpeGVsQml0czogZ2wuZ2V0UGFyYW1ldGVyKEdMX1NVQlBJWEVMX0JJVFMpLAogICAgICAgICAgLy8gc3VwcG9ydGVkIGV4dGVuc2lvbnMKICAgICAgICAgIGV4dGVuc2lvbnM6IE9iamVjdC5rZXlzKGV4dGVuc2lvbnMpLmZpbHRlcihmdW5jdGlvbihleHQpIHsKICAgICAgICAgICAgcmV0dXJuICEhZXh0ZW5zaW9uc1tleHRdOwogICAgICAgICAgfSksCiAgICAgICAgICAvLyBtYXggYW5pc28gc2FtcGxlcwogICAgICAgICAgbWF4QW5pc290cm9waWMsCiAgICAgICAgICAvLyBtYXggZHJhdyBidWZmZXJzCiAgICAgICAgICBtYXhEcmF3YnVmZmVycywKICAgICAgICAgIG1heENvbG9yQXR0YWNobWVudHMsCiAgICAgICAgICAvLyBwb2ludCBhbmQgbGluZSBzaXplIHJhbmdlcwogICAgICAgICAgcG9pbnRTaXplRGltczogZ2wuZ2V0UGFyYW1ldGVyKEdMX0FMSUFTRURfUE9JTlRfU0laRV9SQU5HRSksCiAgICAgICAgICBsaW5lV2lkdGhEaW1zOiBnbC5nZXRQYXJhbWV0ZXIoR0xfQUxJQVNFRF9MSU5FX1dJRFRIX1JBTkdFKSwKICAgICAgICAgIG1heFZpZXdwb3J0RGltczogZ2wuZ2V0UGFyYW1ldGVyKEdMX01BWF9WSUVXUE9SVF9ESU1TKSwKICAgICAgICAgIG1heENvbWJpbmVkVGV4dHVyZVVuaXRzOiBnbC5nZXRQYXJhbWV0ZXIoR0xfTUFYX0NPTUJJTkVEX1RFWFRVUkVfSU1BR0VfVU5JVFMpLAogICAgICAgICAgbWF4Q3ViZU1hcFNpemU6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfQ1VCRV9NQVBfVEVYVFVSRV9TSVpFKSwKICAgICAgICAgIG1heFJlbmRlcmJ1ZmZlclNpemU6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfUkVOREVSQlVGRkVSX1NJWkUpLAogICAgICAgICAgbWF4VGV4dHVyZVVuaXRzOiBnbC5nZXRQYXJhbWV0ZXIoR0xfTUFYX1RFWFRVUkVfSU1BR0VfVU5JVFMpLAogICAgICAgICAgbWF4VGV4dHVyZVNpemU6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfVEVYVFVSRV9TSVpFKSwKICAgICAgICAgIG1heEF0dHJpYnV0ZXM6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfVkVSVEVYX0FUVFJJQlMpLAogICAgICAgICAgbWF4VmVydGV4VW5pZm9ybXM6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfVkVSVEVYX1VOSUZPUk1fVkVDVE9SUyksCiAgICAgICAgICBtYXhWZXJ0ZXhUZXh0dXJlVW5pdHM6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFMpLAogICAgICAgICAgbWF4VmFyeWluZ1ZlY3RvcnM6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfVkFSWUlOR19WRUNUT1JTKSwKICAgICAgICAgIG1heEZyYWdtZW50VW5pZm9ybXM6IGdsLmdldFBhcmFtZXRlcihHTF9NQVhfRlJBR01FTlRfVU5JRk9STV9WRUNUT1JTKSwKICAgICAgICAgIC8vIHZlbmRvciBpbmZvCiAgICAgICAgICBnbHNsOiBnbC5nZXRQYXJhbWV0ZXIoR0xfU0hBRElOR19MQU5HVUFHRV9WRVJTSU9OKSwKICAgICAgICAgIHJlbmRlcmVyOiBnbC5nZXRQYXJhbWV0ZXIoR0xfUkVOREVSRVIpLAogICAgICAgICAgdmVuZG9yOiBnbC5nZXRQYXJhbWV0ZXIoR0xfVkVORE9SKSwKICAgICAgICAgIHZlcnNpb246IGdsLmdldFBhcmFtZXRlcihHTF9WRVJTSU9OKSwKICAgICAgICAgIC8vIHF1aXJrcwogICAgICAgICAgcmVhZEZsb2F0LAogICAgICAgICAgbnBvdFRleHR1cmVDdWJlCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gaXNOREFycmF5TGlrZShvYmopIHsKICAgICAgICByZXR1cm4gISFvYmogJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgQXJyYXkuaXNBcnJheShvYmouc2hhcGUpICYmIEFycmF5LmlzQXJyYXkob2JqLnN0cmlkZSkgJiYgdHlwZW9mIG9iai5vZmZzZXQgPT09ICJudW1iZXIiICYmIG9iai5zaGFwZS5sZW5ndGggPT09IG9iai5zdHJpZGUubGVuZ3RoICYmIChBcnJheS5pc0FycmF5KG9iai5kYXRhKSB8fCBpc1R5cGVkQXJyYXkyKG9iai5kYXRhKSk7CiAgICAgIH0KICAgICAgdmFyIHZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIHJldHVybiBvYmpba2V5XTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgdmFyIGZsYXR0ZW5VdGlscyA9IHsKICAgICAgICBzaGFwZTogYXJyYXlTaGFwZSQxLAogICAgICAgIGZsYXR0ZW46IGZsYXR0ZW5BcnJheQogICAgICB9OwogICAgICBmdW5jdGlvbiBmbGF0dGVuMUQoYXJyYXkyLCBueCwgb3V0KSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBueDsgKytpKSB7CiAgICAgICAgICBvdXRbaV0gPSBhcnJheTJbaV07CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsYXR0ZW4yRChhcnJheTIsIG54LCBueSwgb3V0KSB7CiAgICAgICAgdmFyIHB0ciA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBueDsgKytpKSB7CiAgICAgICAgICB2YXIgcm93ID0gYXJyYXkyW2ldOwogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBueTsgKytqKSB7CiAgICAgICAgICAgIG91dFtwdHIrK10gPSByb3dbal07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsYXR0ZW4zRChhcnJheTIsIG54LCBueSwgbnosIG91dCwgcHRyXykgewogICAgICAgIHZhciBwdHIgPSBwdHJfOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbng7ICsraSkgewogICAgICAgICAgdmFyIHJvdyA9IGFycmF5MltpXTsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbnk7ICsraikgewogICAgICAgICAgICB2YXIgY29sID0gcm93W2pdOwogICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IG56OyArK2spIHsKICAgICAgICAgICAgICBvdXRbcHRyKytdID0gY29sW2tdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsYXR0ZW5SZWMoYXJyYXkyLCBzaGFwZSwgbGV2ZWwsIG91dCwgcHRyKSB7CiAgICAgICAgdmFyIHN0cmlkZSA9IDE7CiAgICAgICAgZm9yICh2YXIgaSA9IGxldmVsICsgMTsgaSA8IHNoYXBlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBzdHJpZGUgKj0gc2hhcGVbaV07CiAgICAgICAgfQogICAgICAgIHZhciBuID0gc2hhcGVbbGV2ZWxdOwogICAgICAgIGlmIChzaGFwZS5sZW5ndGggLSBsZXZlbCA9PT0gNCkgewogICAgICAgICAgdmFyIG54ID0gc2hhcGVbbGV2ZWwgKyAxXTsKICAgICAgICAgIHZhciBueSA9IHNoYXBlW2xldmVsICsgMl07CiAgICAgICAgICB2YXIgbnogPSBzaGFwZVtsZXZlbCArIDNdOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgICAgICBmbGF0dGVuM0QoYXJyYXkyW2ldLCBueCwgbnksIG56LCBvdXQsIHB0cik7CiAgICAgICAgICAgIHB0ciArPSBzdHJpZGU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICAgICAgZmxhdHRlblJlYyhhcnJheTJbaV0sIHNoYXBlLCBsZXZlbCArIDEsIG91dCwgcHRyKTsKICAgICAgICAgICAgcHRyICs9IHN0cmlkZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZmxhdHRlbkFycmF5KGFycmF5Miwgc2hhcGUsIHR5cGUsIG91dF8pIHsKICAgICAgICB2YXIgc3ogPSAxOwogICAgICAgIGlmIChzaGFwZS5sZW5ndGgpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hhcGUubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgc3ogKj0gc2hhcGVbaV07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN6ID0gMDsKICAgICAgICB9CiAgICAgICAgdmFyIG91dCA9IG91dF8gfHwgcG9vbC5hbGxvY1R5cGUodHlwZSwgc3opOwogICAgICAgIHN3aXRjaCAoc2hhcGUubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBmbGF0dGVuMUQoYXJyYXkyLCBzaGFwZVswXSwgb3V0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGZsYXR0ZW4yRChhcnJheTIsIHNoYXBlWzBdLCBzaGFwZVsxXSwgb3V0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIGZsYXR0ZW4zRChhcnJheTIsIHNoYXBlWzBdLCBzaGFwZVsxXSwgc2hhcGVbMl0sIG91dCwgMCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgZmxhdHRlblJlYyhhcnJheTIsIHNoYXBlLCAwLCBvdXQsIDApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFycmF5U2hhcGUkMShhcnJheV8pIHsKICAgICAgICB2YXIgc2hhcGUgPSBbXTsKICAgICAgICBmb3IgKHZhciBhcnJheTIgPSBhcnJheV87IGFycmF5Mi5sZW5ndGg7IGFycmF5MiA9IGFycmF5MlswXSkgewogICAgICAgICAgc2hhcGUucHVzaChhcnJheTIubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICB9CiAgICAgIHZhciBhcnJheVR5cGVzID0gewogICAgICAgICJbb2JqZWN0IEludDhBcnJheV0iOiA1MTIwLAogICAgICAgICJbb2JqZWN0IEludDE2QXJyYXldIjogNTEyMiwKICAgICAgICAiW29iamVjdCBJbnQzMkFycmF5XSI6IDUxMjQsCiAgICAgICAgIltvYmplY3QgVWludDhBcnJheV0iOiA1MTIxLAogICAgICAgICJbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSI6IDUxMjEsCiAgICAgICAgIltvYmplY3QgVWludDE2QXJyYXldIjogNTEyMywKICAgICAgICAiW29iamVjdCBVaW50MzJBcnJheV0iOiA1MTI1LAogICAgICAgICJbb2JqZWN0IEZsb2F0MzJBcnJheV0iOiA1MTI2LAogICAgICAgICJbb2JqZWN0IEZsb2F0NjRBcnJheV0iOiA1MTIxLAogICAgICAgICJbb2JqZWN0IEFycmF5QnVmZmVyXSI6IDUxMjEKICAgICAgfTsKICAgICAgdmFyIGludDgyID0gNTEyMDsKICAgICAgdmFyIGludDE2MiA9IDUxMjI7CiAgICAgIHZhciBpbnQzMjIgPSA1MTI0OwogICAgICB2YXIgdWludDgyID0gNTEyMTsKICAgICAgdmFyIHVpbnQxNjIgPSA1MTIzOwogICAgICB2YXIgdWludDMyMiA9IDUxMjU7CiAgICAgIHZhciBmbG9hdDIgPSA1MTI2OwogICAgICB2YXIgZmxvYXQzMjIgPSA1MTI2OwogICAgICB2YXIgZ2xUeXBlcyA9IHsKICAgICAgICBpbnQ4OiBpbnQ4MiwKICAgICAgICBpbnQxNjogaW50MTYyLAogICAgICAgIGludDMyOiBpbnQzMjIsCiAgICAgICAgdWludDg6IHVpbnQ4MiwKICAgICAgICB1aW50MTY6IHVpbnQxNjIsCiAgICAgICAgdWludDMyOiB1aW50MzIyLAogICAgICAgIGZsb2F0OiBmbG9hdDIsCiAgICAgICAgZmxvYXQzMjogZmxvYXQzMjIKICAgICAgfTsKICAgICAgdmFyIGR5bmFtaWMkMSA9IDM1MDQ4OwogICAgICB2YXIgc3RyZWFtID0gMzUwNDA7CiAgICAgIHZhciB1c2FnZVR5cGVzID0gewogICAgICAgIGR5bmFtaWM6IGR5bmFtaWMkMSwKICAgICAgICBzdHJlYW0sCiAgICAgICAgInN0YXRpYyI6IDM1MDQ0CiAgICAgIH07CiAgICAgIHZhciBhcnJheUZsYXR0ZW4gPSBmbGF0dGVuVXRpbHMuZmxhdHRlbjsKICAgICAgdmFyIGFycmF5U2hhcGUgPSBmbGF0dGVuVXRpbHMuc2hhcGU7CiAgICAgIHZhciBHTF9TVEFUSUNfRFJBVyA9IDM1MDQ0OwogICAgICB2YXIgR0xfU1RSRUFNX0RSQVcgPSAzNTA0MDsKICAgICAgdmFyIEdMX1VOU0lHTkVEX0JZVEUkMyA9IDUxMjE7CiAgICAgIHZhciBHTF9GTE9BVCQzID0gNTEyNjsKICAgICAgdmFyIERUWVBFU19TSVpFUyA9IFtdOwogICAgICBEVFlQRVNfU0laRVNbNTEyMF0gPSAxOwogICAgICBEVFlQRVNfU0laRVNbNTEyMl0gPSAyOwogICAgICBEVFlQRVNfU0laRVNbNTEyNF0gPSA0OwogICAgICBEVFlQRVNfU0laRVNbNTEyMV0gPSAxOwogICAgICBEVFlQRVNfU0laRVNbNTEyM10gPSAyOwogICAgICBEVFlQRVNfU0laRVNbNTEyNV0gPSA0OwogICAgICBEVFlQRVNfU0laRVNbNTEyNl0gPSA0OwogICAgICBmdW5jdGlvbiB0eXBlZEFycmF5Q29kZShkYXRhKSB7CiAgICAgICAgcmV0dXJuIGFycmF5VHlwZXNbT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRhdGEpXSB8IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29weUFycmF5MihvdXQsIGlucCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBvdXRbaV0gPSBpbnBbaV07CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHRyYW5zcG9zZShyZXN1bHQsIGRhdGEsIHNoYXBlWCwgc2hhcGVZLCBzdHJpZGVYLCBzdHJpZGVZLCBvZmZzZXQpIHsKICAgICAgICB2YXIgcHRyID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNoYXBlWDsgKytpKSB7CiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNoYXBlWTsgKytqKSB7CiAgICAgICAgICAgIHJlc3VsdFtwdHIrK10gPSBkYXRhW3N0cmlkZVggKiBpICsgc3RyaWRlWSAqIGogKyBvZmZzZXRdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB3cmFwQnVmZmVyU3RhdGUoZ2wsIHN0YXRzMiwgY29uZmlnLCBkZXN0cm95QnVmZmVyKSB7CiAgICAgICAgdmFyIGJ1ZmZlckNvdW50ID0gMDsKICAgICAgICB2YXIgYnVmZmVyU2V0ID0ge307CiAgICAgICAgZnVuY3Rpb24gUkVHTEJ1ZmZlcih0eXBlKSB7CiAgICAgICAgICB0aGlzLmlkID0gYnVmZmVyQ291bnQrKzsKICAgICAgICAgIHRoaXMuYnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgICAgdGhpcy51c2FnZSA9IEdMX1NUQVRJQ19EUkFXOwogICAgICAgICAgdGhpcy5ieXRlTGVuZ3RoID0gMDsKICAgICAgICAgIHRoaXMuZGltZW5zaW9uID0gMTsKICAgICAgICAgIHRoaXMuZHR5cGUgPSBHTF9VTlNJR05FRF9CWVRFJDM7CiAgICAgICAgICB0aGlzLnBlcnNpc3RlbnREYXRhID0gbnVsbDsKICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICB0aGlzLnN0YXRzID0geyBzaXplOiAwIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJFR0xCdWZmZXIucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGdsLmJpbmRCdWZmZXIodGhpcy50eXBlLCB0aGlzLmJ1ZmZlcik7CiAgICAgICAgfTsKICAgICAgICBSRUdMQnVmZmVyLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBkZXN0cm95KHRoaXMpOwogICAgICAgIH07CiAgICAgICAgdmFyIHN0cmVhbVBvb2wgPSBbXTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVTdHJlYW0odHlwZSwgZGF0YSkgewogICAgICAgICAgdmFyIGJ1ZmZlcjIgPSBzdHJlYW1Qb29sLnBvcCgpOwogICAgICAgICAgaWYgKCFidWZmZXIyKSB7CiAgICAgICAgICAgIGJ1ZmZlcjIgPSBuZXcgUkVHTEJ1ZmZlcih0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlcjIuYmluZCgpOwogICAgICAgICAgaW5pdEJ1ZmZlckZyb21EYXRhKGJ1ZmZlcjIsIGRhdGEsIEdMX1NUUkVBTV9EUkFXLCAwLCAxLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gYnVmZmVyMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzdHJveVN0cmVhbShzdHJlYW0kJDEpIHsKICAgICAgICAgIHN0cmVhbVBvb2wucHVzaChzdHJlYW0kJDEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0QnVmZmVyRnJvbVR5cGVkQXJyYXkoYnVmZmVyMiwgZGF0YSwgdXNhZ2UpIHsKICAgICAgICAgIGJ1ZmZlcjIuYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgICAgIGdsLmJ1ZmZlckRhdGEoYnVmZmVyMi50eXBlLCBkYXRhLCB1c2FnZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRCdWZmZXJGcm9tRGF0YShidWZmZXIyLCBkYXRhLCB1c2FnZSwgZHR5cGUsIGRpbWVuc2lvbiwgcGVyc2lzdCkgewogICAgICAgICAgdmFyIHNoYXBlOwogICAgICAgICAgYnVmZmVyMi51c2FnZSA9IHVzYWdlOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgYnVmZmVyMi5kdHlwZSA9IGR0eXBlIHx8IEdMX0ZMT0FUJDM7CiAgICAgICAgICAgIGlmIChkYXRhLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgZmxhdERhdGE7CiAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YVswXSkpIHsKICAgICAgICAgICAgICAgIHNoYXBlID0gYXJyYXlTaGFwZShkYXRhKTsKICAgICAgICAgICAgICAgIHZhciBkaW0gPSAxOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBzaGFwZS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICBkaW0gKj0gc2hhcGVbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBidWZmZXIyLmRpbWVuc2lvbiA9IGRpbTsKICAgICAgICAgICAgICAgIGZsYXREYXRhID0gYXJyYXlGbGF0dGVuKGRhdGEsIHNoYXBlLCBidWZmZXIyLmR0eXBlKTsKICAgICAgICAgICAgICAgIGluaXRCdWZmZXJGcm9tVHlwZWRBcnJheShidWZmZXIyLCBmbGF0RGF0YSwgdXNhZ2UpOwogICAgICAgICAgICAgICAgaWYgKHBlcnNpc3QpIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyMi5wZXJzaXN0ZW50RGF0YSA9IGZsYXREYXRhOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcG9vbC5mcmVlVHlwZShmbGF0RGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YVswXSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGJ1ZmZlcjIuZGltZW5zaW9uID0gZGltZW5zaW9uOwogICAgICAgICAgICAgICAgdmFyIHR5cGVkRGF0YSA9IHBvb2wuYWxsb2NUeXBlKGJ1ZmZlcjIuZHR5cGUsIGRhdGEubGVuZ3RoKTsKICAgICAgICAgICAgICAgIGNvcHlBcnJheTIodHlwZWREYXRhLCBkYXRhKTsKICAgICAgICAgICAgICAgIGluaXRCdWZmZXJGcm9tVHlwZWRBcnJheShidWZmZXIyLCB0eXBlZERhdGEsIHVzYWdlKTsKICAgICAgICAgICAgICAgIGlmIChwZXJzaXN0KSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlcjIucGVyc2lzdGVudERhdGEgPSB0eXBlZERhdGE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwb29sLmZyZWVUeXBlKHR5cGVkRGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1R5cGVkQXJyYXkyKGRhdGFbMF0pKSB7CiAgICAgICAgICAgICAgICBidWZmZXIyLmRpbWVuc2lvbiA9IGRhdGFbMF0ubGVuZ3RoOwogICAgICAgICAgICAgICAgYnVmZmVyMi5kdHlwZSA9IGR0eXBlIHx8IHR5cGVkQXJyYXlDb2RlKGRhdGFbMF0pIHx8IEdMX0ZMT0FUJDM7CiAgICAgICAgICAgICAgICBmbGF0RGF0YSA9IGFycmF5RmxhdHRlbigKICAgICAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICAgICAgW2RhdGEubGVuZ3RoLCBkYXRhWzBdLmxlbmd0aF0sCiAgICAgICAgICAgICAgICAgIGJ1ZmZlcjIuZHR5cGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpbml0QnVmZmVyRnJvbVR5cGVkQXJyYXkoYnVmZmVyMiwgZmxhdERhdGEsIHVzYWdlKTsKICAgICAgICAgICAgICAgIGlmIChwZXJzaXN0KSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlcjIucGVyc2lzdGVudERhdGEgPSBmbGF0RGF0YTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHBvb2wuZnJlZVR5cGUoZmxhdERhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJpbnZhbGlkIGJ1ZmZlciBkYXRhIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVHlwZWRBcnJheTIoZGF0YSkpIHsKICAgICAgICAgICAgYnVmZmVyMi5kdHlwZSA9IGR0eXBlIHx8IHR5cGVkQXJyYXlDb2RlKGRhdGEpOwogICAgICAgICAgICBidWZmZXIyLmRpbWVuc2lvbiA9IGRpbWVuc2lvbjsKICAgICAgICAgICAgaW5pdEJ1ZmZlckZyb21UeXBlZEFycmF5KGJ1ZmZlcjIsIGRhdGEsIHVzYWdlKTsKICAgICAgICAgICAgaWYgKHBlcnNpc3QpIHsKICAgICAgICAgICAgICBidWZmZXIyLnBlcnNpc3RlbnREYXRhID0gbmV3IFVpbnQ4QXJyYXkobmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc05EQXJyYXlMaWtlKGRhdGEpKSB7CiAgICAgICAgICAgIHNoYXBlID0gZGF0YS5zaGFwZTsKICAgICAgICAgICAgdmFyIHN0cmlkZSA9IGRhdGEuc3RyaWRlOwogICAgICAgICAgICB2YXIgb2Zmc2V0ID0gZGF0YS5vZmZzZXQ7CiAgICAgICAgICAgIHZhciBzaGFwZVggPSAwOwogICAgICAgICAgICB2YXIgc2hhcGVZID0gMDsKICAgICAgICAgICAgdmFyIHN0cmlkZVggPSAwOwogICAgICAgICAgICB2YXIgc3RyaWRlWSA9IDA7CiAgICAgICAgICAgIGlmIChzaGFwZS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBzaGFwZVggPSBzaGFwZVswXTsKICAgICAgICAgICAgICBzaGFwZVkgPSAxOwogICAgICAgICAgICAgIHN0cmlkZVggPSBzdHJpZGVbMF07CiAgICAgICAgICAgICAgc3RyaWRlWSA9IDA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hhcGUubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgICAgc2hhcGVYID0gc2hhcGVbMF07CiAgICAgICAgICAgICAgc2hhcGVZID0gc2hhcGVbMV07CiAgICAgICAgICAgICAgc3RyaWRlWCA9IHN0cmlkZVswXTsKICAgICAgICAgICAgICBzdHJpZGVZID0gc3RyaWRlWzFdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoZWNrJDEucmFpc2UoImludmFsaWQgc2hhcGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmZXIyLmR0eXBlID0gZHR5cGUgfHwgdHlwZWRBcnJheUNvZGUoZGF0YS5kYXRhKSB8fCBHTF9GTE9BVCQzOwogICAgICAgICAgICBidWZmZXIyLmRpbWVuc2lvbiA9IHNoYXBlWTsKICAgICAgICAgICAgdmFyIHRyYW5zcG9zZURhdGEyID0gcG9vbC5hbGxvY1R5cGUoYnVmZmVyMi5kdHlwZSwgc2hhcGVYICogc2hhcGVZKTsKICAgICAgICAgICAgdHJhbnNwb3NlKAogICAgICAgICAgICAgIHRyYW5zcG9zZURhdGEyLAogICAgICAgICAgICAgIGRhdGEuZGF0YSwKICAgICAgICAgICAgICBzaGFwZVgsCiAgICAgICAgICAgICAgc2hhcGVZLAogICAgICAgICAgICAgIHN0cmlkZVgsCiAgICAgICAgICAgICAgc3RyaWRlWSwKICAgICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaW5pdEJ1ZmZlckZyb21UeXBlZEFycmF5KGJ1ZmZlcjIsIHRyYW5zcG9zZURhdGEyLCB1c2FnZSk7CiAgICAgICAgICAgIGlmIChwZXJzaXN0KSB7CiAgICAgICAgICAgICAgYnVmZmVyMi5wZXJzaXN0ZW50RGF0YSA9IHRyYW5zcG9zZURhdGEyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvb2wuZnJlZVR5cGUodHJhbnNwb3NlRGF0YTIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgICAgICBidWZmZXIyLmR0eXBlID0gR0xfVU5TSUdORURfQllURSQzOwogICAgICAgICAgICBidWZmZXIyLmRpbWVuc2lvbiA9IGRpbWVuc2lvbjsKICAgICAgICAgICAgaW5pdEJ1ZmZlckZyb21UeXBlZEFycmF5KGJ1ZmZlcjIsIGRhdGEsIHVzYWdlKTsKICAgICAgICAgICAgaWYgKHBlcnNpc3QpIHsKICAgICAgICAgICAgICBidWZmZXIyLnBlcnNpc3RlbnREYXRhID0gbmV3IFVpbnQ4QXJyYXkobmV3IFVpbnQ4QXJyYXkoZGF0YSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJpbnZhbGlkIGJ1ZmZlciBkYXRhIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3koYnVmZmVyMikgewogICAgICAgICAgc3RhdHMyLmJ1ZmZlckNvdW50LS07CiAgICAgICAgICBkZXN0cm95QnVmZmVyKGJ1ZmZlcjIpOwogICAgICAgICAgdmFyIGhhbmRsZSA9IGJ1ZmZlcjIuYnVmZmVyOwogICAgICAgICAgY2hlY2skMShoYW5kbGUsICJidWZmZXIgbXVzdCBub3QgYmUgZGVsZXRlZCBhbHJlYWR5Iik7CiAgICAgICAgICBnbC5kZWxldGVCdWZmZXIoaGFuZGxlKTsKICAgICAgICAgIGJ1ZmZlcjIuYnVmZmVyID0gbnVsbDsKICAgICAgICAgIGRlbGV0ZSBidWZmZXJTZXRbYnVmZmVyMi5pZF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlcihvcHRpb25zLCB0eXBlLCBkZWZlckluaXQsIHBlcnNpc3RlbnQpIHsKICAgICAgICAgIHN0YXRzMi5idWZmZXJDb3VudCsrOwogICAgICAgICAgdmFyIGJ1ZmZlcjIgPSBuZXcgUkVHTEJ1ZmZlcih0eXBlKTsKICAgICAgICAgIGJ1ZmZlclNldFtidWZmZXIyLmlkXSA9IGJ1ZmZlcjI7CiAgICAgICAgICBmdW5jdGlvbiByZWdsQnVmZmVyKG9wdGlvbnMyKSB7CiAgICAgICAgICAgIHZhciB1c2FnZSA9IEdMX1NUQVRJQ19EUkFXOwogICAgICAgICAgICB2YXIgZGF0YSA9IG51bGw7CiAgICAgICAgICAgIHZhciBieXRlTGVuZ3RoID0gMDsKICAgICAgICAgICAgdmFyIGR0eXBlID0gMDsKICAgICAgICAgICAgdmFyIGRpbWVuc2lvbiA9IDE7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9wdGlvbnMyKSB8fCBpc1R5cGVkQXJyYXkyKG9wdGlvbnMyKSB8fCBpc05EQXJyYXlMaWtlKG9wdGlvbnMyKSB8fCBvcHRpb25zMiBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgICAgICAgICAgZGF0YSA9IG9wdGlvbnMyOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zMiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBieXRlTGVuZ3RoID0gb3B0aW9uczIgfCAwOwogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgY2hlY2skMS50eXBlKAogICAgICAgICAgICAgICAgb3B0aW9uczIsCiAgICAgICAgICAgICAgICAib2JqZWN0IiwKICAgICAgICAgICAgICAgICJidWZmZXIgYXJndW1lbnRzIG11c3QgYmUgYW4gb2JqZWN0LCBhIG51bWJlciBvciBhbiBhcnJheSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICgiZGF0YSIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAgIGRhdGEgPT09IG51bGwgfHwgQXJyYXkuaXNBcnJheShkYXRhKSB8fCBpc1R5cGVkQXJyYXkyKGRhdGEpIHx8IGlzTkRBcnJheUxpa2UoZGF0YSksCiAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGRhdGEgZm9yIGJ1ZmZlciIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBkYXRhID0gb3B0aW9uczIuZGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJ1c2FnZSIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKG9wdGlvbnMyLnVzYWdlLCB1c2FnZVR5cGVzLCAiaW52YWxpZCBidWZmZXIgdXNhZ2UiKTsKICAgICAgICAgICAgICAgIHVzYWdlID0gdXNhZ2VUeXBlc1tvcHRpb25zMi51c2FnZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgidHlwZSIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKG9wdGlvbnMyLnR5cGUsIGdsVHlwZXMsICJpbnZhbGlkIGJ1ZmZlciB0eXBlIik7CiAgICAgICAgICAgICAgICBkdHlwZSA9IGdsVHlwZXNbb3B0aW9uczIudHlwZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgiZGltZW5zaW9uIiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgICAgY2hlY2skMS50eXBlKG9wdGlvbnMyLmRpbWVuc2lvbiwgIm51bWJlciIsICJpbnZhbGlkIGRpbWVuc2lvbiIpOwogICAgICAgICAgICAgICAgZGltZW5zaW9uID0gb3B0aW9uczIuZGltZW5zaW9uIHwgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJsZW5ndGgiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICBjaGVjayQxLm5uaShieXRlTGVuZ3RoLCAiYnVmZmVyIGxlbmd0aCBtdXN0IGJlIGEgbm9ubmVnYXRpdmUgaW50ZWdlciIpOwogICAgICAgICAgICAgICAgYnl0ZUxlbmd0aCA9IG9wdGlvbnMyLmxlbmd0aCB8IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJ1ZmZlcjIuYmluZCgpOwogICAgICAgICAgICBpZiAoIWRhdGEpIHsKICAgICAgICAgICAgICBpZiAoYnl0ZUxlbmd0aCkgZ2wuYnVmZmVyRGF0YShidWZmZXIyLnR5cGUsIGJ5dGVMZW5ndGgsIHVzYWdlKTsKICAgICAgICAgICAgICBidWZmZXIyLmR0eXBlID0gZHR5cGUgfHwgR0xfVU5TSUdORURfQllURSQzOwogICAgICAgICAgICAgIGJ1ZmZlcjIudXNhZ2UgPSB1c2FnZTsKICAgICAgICAgICAgICBidWZmZXIyLmRpbWVuc2lvbiA9IGRpbWVuc2lvbjsKICAgICAgICAgICAgICBidWZmZXIyLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluaXRCdWZmZXJGcm9tRGF0YShidWZmZXIyLCBkYXRhLCB1c2FnZSwgZHR5cGUsIGRpbWVuc2lvbiwgcGVyc2lzdGVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICAgICAgYnVmZmVyMi5zdGF0cy5zaXplID0gYnVmZmVyMi5ieXRlTGVuZ3RoICogRFRZUEVTX1NJWkVTW2J1ZmZlcjIuZHR5cGVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZWdsQnVmZmVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2V0U3ViRGF0YShkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICBvZmZzZXQgKyBkYXRhLmJ5dGVMZW5ndGggPD0gYnVmZmVyMi5ieXRlTGVuZ3RoLAogICAgICAgICAgICAgICJpbnZhbGlkIGJ1ZmZlciBzdWJkYXRhIGNhbGwsIGJ1ZmZlciBpcyB0b28gc21hbGwuICBDYW4ndCB3cml0ZSBkYXRhIG9mIHNpemUgIiArIGRhdGEuYnl0ZUxlbmd0aCArICIgc3RhcnRpbmcgZnJvbSBvZmZzZXQgIiArIG9mZnNldCArICIgdG8gYSBidWZmZXIgb2Ygc2l6ZSAiICsgYnVmZmVyMi5ieXRlTGVuZ3RoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGdsLmJ1ZmZlclN1YkRhdGEoYnVmZmVyMi50eXBlLCBvZmZzZXQsIGRhdGEpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3ViZGF0YShkYXRhLCBvZmZzZXRfKSB7CiAgICAgICAgICAgIHZhciBvZmZzZXQgPSAob2Zmc2V0XyB8fCAwKSB8IDA7CiAgICAgICAgICAgIHZhciBzaGFwZTsKICAgICAgICAgICAgYnVmZmVyMi5iaW5kKCk7CiAgICAgICAgICAgIGlmIChpc1R5cGVkQXJyYXkyKGRhdGEpIHx8IGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgICAgICAgIHNldFN1YkRhdGEoZGF0YSwgb2Zmc2V0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhWzBdID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICB2YXIgY29udmVydGVkID0gcG9vbC5hbGxvY1R5cGUoYnVmZmVyMi5kdHlwZSwgZGF0YS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICBjb3B5QXJyYXkyKGNvbnZlcnRlZCwgZGF0YSk7CiAgICAgICAgICAgICAgICAgIHNldFN1YkRhdGEoY29udmVydGVkLCBvZmZzZXQpOwogICAgICAgICAgICAgICAgICBwb29sLmZyZWVUeXBlKGNvbnZlcnRlZCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YVswXSkgfHwgaXNUeXBlZEFycmF5MihkYXRhWzBdKSkgewogICAgICAgICAgICAgICAgICBzaGFwZSA9IGFycmF5U2hhcGUoZGF0YSk7CiAgICAgICAgICAgICAgICAgIHZhciBmbGF0RGF0YSA9IGFycmF5RmxhdHRlbihkYXRhLCBzaGFwZSwgYnVmZmVyMi5kdHlwZSk7CiAgICAgICAgICAgICAgICAgIHNldFN1YkRhdGEoZmxhdERhdGEsIG9mZnNldCk7CiAgICAgICAgICAgICAgICAgIHBvb2wuZnJlZVR5cGUoZmxhdERhdGEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2hlY2skMS5yYWlzZSgiaW52YWxpZCBidWZmZXIgZGF0YSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc05EQXJyYXlMaWtlKGRhdGEpKSB7CiAgICAgICAgICAgICAgc2hhcGUgPSBkYXRhLnNoYXBlOwogICAgICAgICAgICAgIHZhciBzdHJpZGUgPSBkYXRhLnN0cmlkZTsKICAgICAgICAgICAgICB2YXIgc2hhcGVYID0gMDsKICAgICAgICAgICAgICB2YXIgc2hhcGVZID0gMDsKICAgICAgICAgICAgICB2YXIgc3RyaWRlWCA9IDA7CiAgICAgICAgICAgICAgdmFyIHN0cmlkZVkgPSAwOwogICAgICAgICAgICAgIGlmIChzaGFwZS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHNoYXBlWCA9IHNoYXBlWzBdOwogICAgICAgICAgICAgICAgc2hhcGVZID0gMTsKICAgICAgICAgICAgICAgIHN0cmlkZVggPSBzdHJpZGVbMF07CiAgICAgICAgICAgICAgICBzdHJpZGVZID0gMDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNoYXBlLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICAgICAgc2hhcGVYID0gc2hhcGVbMF07CiAgICAgICAgICAgICAgICBzaGFwZVkgPSBzaGFwZVsxXTsKICAgICAgICAgICAgICAgIHN0cmlkZVggPSBzdHJpZGVbMF07CiAgICAgICAgICAgICAgICBzdHJpZGVZID0gc3RyaWRlWzFdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJpbnZhbGlkIHNoYXBlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkdHlwZSA9IEFycmF5LmlzQXJyYXkoZGF0YS5kYXRhKSA/IGJ1ZmZlcjIuZHR5cGUgOiB0eXBlZEFycmF5Q29kZShkYXRhLmRhdGEpOwogICAgICAgICAgICAgIHZhciB0cmFuc3Bvc2VEYXRhMiA9IHBvb2wuYWxsb2NUeXBlKGR0eXBlLCBzaGFwZVggKiBzaGFwZVkpOwogICAgICAgICAgICAgIHRyYW5zcG9zZSgKICAgICAgICAgICAgICAgIHRyYW5zcG9zZURhdGEyLAogICAgICAgICAgICAgICAgZGF0YS5kYXRhLAogICAgICAgICAgICAgICAgc2hhcGVYLAogICAgICAgICAgICAgICAgc2hhcGVZLAogICAgICAgICAgICAgICAgc3RyaWRlWCwKICAgICAgICAgICAgICAgIHN0cmlkZVksCiAgICAgICAgICAgICAgICBkYXRhLm9mZnNldAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2V0U3ViRGF0YSh0cmFuc3Bvc2VEYXRhMiwgb2Zmc2V0KTsKICAgICAgICAgICAgICBwb29sLmZyZWVUeXBlKHRyYW5zcG9zZURhdGEyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJpbnZhbGlkIGRhdGEgZm9yIGJ1ZmZlciBzdWJkYXRhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlZ2xCdWZmZXI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWRlZmVySW5pdCkgewogICAgICAgICAgICByZWdsQnVmZmVyKG9wdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgcmVnbEJ1ZmZlci5fcmVnbFR5cGUgPSAiYnVmZmVyIjsKICAgICAgICAgIHJlZ2xCdWZmZXIuX2J1ZmZlciA9IGJ1ZmZlcjI7CiAgICAgICAgICByZWdsQnVmZmVyLnN1YmRhdGEgPSBzdWJkYXRhOwogICAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICAgIHJlZ2xCdWZmZXIuc3RhdHMgPSBidWZmZXIyLnN0YXRzOwogICAgICAgICAgfQogICAgICAgICAgcmVnbEJ1ZmZlci5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRlc3Ryb3koYnVmZmVyMik7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHJlZ2xCdWZmZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVCdWZmZXJzKCkgewogICAgICAgICAgdmFsdWVzKGJ1ZmZlclNldCkuZm9yRWFjaChmdW5jdGlvbihidWZmZXIyKSB7CiAgICAgICAgICAgIGJ1ZmZlcjIuYnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICAgICAgICAgIGdsLmJpbmRCdWZmZXIoYnVmZmVyMi50eXBlLCBidWZmZXIyLmJ1ZmZlcik7CiAgICAgICAgICAgIGdsLmJ1ZmZlckRhdGEoCiAgICAgICAgICAgICAgYnVmZmVyMi50eXBlLAogICAgICAgICAgICAgIGJ1ZmZlcjIucGVyc2lzdGVudERhdGEgfHwgYnVmZmVyMi5ieXRlTGVuZ3RoLAogICAgICAgICAgICAgIGJ1ZmZlcjIudXNhZ2UKICAgICAgICAgICAgKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoY29uZmlnLnByb2ZpbGUpIHsKICAgICAgICAgIHN0YXRzMi5nZXRUb3RhbEJ1ZmZlclNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHRvdGFsID0gMDsKICAgICAgICAgICAgT2JqZWN0LmtleXMoYnVmZmVyU2V0KS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgIHRvdGFsICs9IGJ1ZmZlclNldFtrZXldLnN0YXRzLnNpemU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdG90YWw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgY3JlYXRlOiBjcmVhdGVCdWZmZXIsCiAgICAgICAgICBjcmVhdGVTdHJlYW0sCiAgICAgICAgICBkZXN0cm95U3RyZWFtLAogICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YWx1ZXMoYnVmZmVyU2V0KS5mb3JFYWNoKGRlc3Ryb3kpOwogICAgICAgICAgICBzdHJlYW1Qb29sLmZvckVhY2goZGVzdHJveSk7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0QnVmZmVyOiBmdW5jdGlvbih3cmFwcGVyKSB7CiAgICAgICAgICAgIGlmICh3cmFwcGVyICYmIHdyYXBwZXIuX2J1ZmZlciBpbnN0YW5jZW9mIFJFR0xCdWZmZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gd3JhcHBlci5fYnVmZmVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfSwKICAgICAgICAgIHJlc3RvcmU6IHJlc3RvcmVCdWZmZXJzLAogICAgICAgICAgX2luaXRCdWZmZXI6IGluaXRCdWZmZXJGcm9tRGF0YQogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIHBvaW50cyA9IDA7CiAgICAgIHZhciBwb2ludCA9IDA7CiAgICAgIHZhciBsaW5lcyA9IDE7CiAgICAgIHZhciBsaW5lID0gMTsKICAgICAgdmFyIHRyaWFuZ2xlcyA9IDQ7CiAgICAgIHZhciB0cmlhbmdsZSA9IDQ7CiAgICAgIHZhciBwcmltVHlwZXMgPSB7CiAgICAgICAgcG9pbnRzLAogICAgICAgIHBvaW50LAogICAgICAgIGxpbmVzLAogICAgICAgIGxpbmUsCiAgICAgICAgdHJpYW5nbGVzLAogICAgICAgIHRyaWFuZ2xlLAogICAgICAgICJsaW5lIGxvb3AiOiAyLAogICAgICAgICJsaW5lIHN0cmlwIjogMywKICAgICAgICAidHJpYW5nbGUgc3RyaXAiOiA1LAogICAgICAgICJ0cmlhbmdsZSBmYW4iOiA2CiAgICAgIH07CiAgICAgIHZhciBHTF9QT0lOVFMgPSAwOwogICAgICB2YXIgR0xfTElORVMgPSAxOwogICAgICB2YXIgR0xfVFJJQU5HTEVTID0gNDsKICAgICAgdmFyIEdMX0JZVEUkMiA9IDUxMjA7CiAgICAgIHZhciBHTF9VTlNJR05FRF9CWVRFJDQgPSA1MTIxOwogICAgICB2YXIgR0xfU0hPUlQkMiA9IDUxMjI7CiAgICAgIHZhciBHTF9VTlNJR05FRF9TSE9SVCQyID0gNTEyMzsKICAgICAgdmFyIEdMX0lOVCQyID0gNTEyNDsKICAgICAgdmFyIEdMX1VOU0lHTkVEX0lOVCQyID0gNTEyNTsKICAgICAgdmFyIEdMX0VMRU1FTlRfQVJSQVlfQlVGRkVSID0gMzQ5NjM7CiAgICAgIHZhciBHTF9TVFJFQU1fRFJBVyQxID0gMzUwNDA7CiAgICAgIHZhciBHTF9TVEFUSUNfRFJBVyQxID0gMzUwNDQ7CiAgICAgIGZ1bmN0aW9uIHdyYXBFbGVtZW50c1N0YXRlKGdsLCBleHRlbnNpb25zLCBidWZmZXJTdGF0ZSwgc3RhdHMyKSB7CiAgICAgICAgdmFyIGVsZW1lbnRTZXQgPSB7fTsKICAgICAgICB2YXIgZWxlbWVudENvdW50ID0gMDsKICAgICAgICB2YXIgZWxlbWVudFR5cGVzID0gewogICAgICAgICAgInVpbnQ4IjogR0xfVU5TSUdORURfQllURSQ0LAogICAgICAgICAgInVpbnQxNiI6IEdMX1VOU0lHTkVEX1NIT1JUJDIKICAgICAgICB9OwogICAgICAgIGlmIChleHRlbnNpb25zLm9lc19lbGVtZW50X2luZGV4X3VpbnQpIHsKICAgICAgICAgIGVsZW1lbnRUeXBlcy51aW50MzIgPSBHTF9VTlNJR05FRF9JTlQkMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUkVHTEVsZW1lbnRCdWZmZXIoYnVmZmVyMikgewogICAgICAgICAgdGhpcy5pZCA9IGVsZW1lbnRDb3VudCsrOwogICAgICAgICAgZWxlbWVudFNldFt0aGlzLmlkXSA9IHRoaXM7CiAgICAgICAgICB0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjI7CiAgICAgICAgICB0aGlzLnByaW1UeXBlID0gR0xfVFJJQU5HTEVTOwogICAgICAgICAgdGhpcy52ZXJ0Q291bnQgPSAwOwogICAgICAgICAgdGhpcy50eXBlID0gMDsKICAgICAgICB9CiAgICAgICAgUkVHTEVsZW1lbnRCdWZmZXIucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuYnVmZmVyLmJpbmQoKTsKICAgICAgICB9OwogICAgICAgIHZhciBidWZmZXJQb29sID0gW107CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudFN0cmVhbShkYXRhKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gYnVmZmVyUG9vbC5wb3AoKTsKICAgICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBSRUdMRWxlbWVudEJ1ZmZlcihidWZmZXJTdGF0ZS5jcmVhdGUoCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBHTF9FTEVNRU5UX0FSUkFZX0JVRkZFUiwKICAgICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICkuX2J1ZmZlcik7CiAgICAgICAgICB9CiAgICAgICAgICBpbml0RWxlbWVudHMocmVzdWx0LCBkYXRhLCBHTF9TVFJFQU1fRFJBVyQxLCAtMSwgLTEsIDAsIDApOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzdHJveUVsZW1lbnRTdHJlYW0oZWxlbWVudHMpIHsKICAgICAgICAgIGJ1ZmZlclBvb2wucHVzaChlbGVtZW50cyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRFbGVtZW50cyhlbGVtZW50cywgZGF0YSwgdXNhZ2UsIHByaW0sIGNvdW50MiwgYnl0ZUxlbmd0aCwgdHlwZSkgewogICAgICAgICAgZWxlbWVudHMuYnVmZmVyLmJpbmQoKTsKICAgICAgICAgIHZhciBkdHlwZTsKICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgIHZhciBwcmVkaWN0ZWRUeXBlID0gdHlwZTsKICAgICAgICAgICAgaWYgKCF0eXBlICYmICghaXNUeXBlZEFycmF5MihkYXRhKSB8fCBpc05EQXJyYXlMaWtlKGRhdGEpICYmICFpc1R5cGVkQXJyYXkyKGRhdGEuZGF0YSkpKSB7CiAgICAgICAgICAgICAgcHJlZGljdGVkVHlwZSA9IGV4dGVuc2lvbnMub2VzX2VsZW1lbnRfaW5kZXhfdWludCA/IEdMX1VOU0lHTkVEX0lOVCQyIDogR0xfVU5TSUdORURfU0hPUlQkMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmZXJTdGF0ZS5faW5pdEJ1ZmZlcigKICAgICAgICAgICAgICBlbGVtZW50cy5idWZmZXIsCiAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICB1c2FnZSwKICAgICAgICAgICAgICBwcmVkaWN0ZWRUeXBlLAogICAgICAgICAgICAgIDMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdsLmJ1ZmZlckRhdGEoR0xfRUxFTUVOVF9BUlJBWV9CVUZGRVIsIGJ5dGVMZW5ndGgsIHVzYWdlKTsKICAgICAgICAgICAgZWxlbWVudHMuYnVmZmVyLmR0eXBlID0gZHR5cGUgfHwgR0xfVU5TSUdORURfQllURSQ0OwogICAgICAgICAgICBlbGVtZW50cy5idWZmZXIudXNhZ2UgPSB1c2FnZTsKICAgICAgICAgICAgZWxlbWVudHMuYnVmZmVyLmRpbWVuc2lvbiA9IDM7CiAgICAgICAgICAgIGVsZW1lbnRzLmJ1ZmZlci5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGR0eXBlID0gdHlwZTsKICAgICAgICAgIGlmICghdHlwZSkgewogICAgICAgICAgICBzd2l0Y2ggKGVsZW1lbnRzLmJ1ZmZlci5kdHlwZSkgewogICAgICAgICAgICAgIGNhc2UgR0xfVU5TSUdORURfQllURSQ0OgogICAgICAgICAgICAgIGNhc2UgR0xfQllURSQyOgogICAgICAgICAgICAgICAgZHR5cGUgPSBHTF9VTlNJR05FRF9CWVRFJDQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEdMX1VOU0lHTkVEX1NIT1JUJDI6CiAgICAgICAgICAgICAgY2FzZSBHTF9TSE9SVCQyOgogICAgICAgICAgICAgICAgZHR5cGUgPSBHTF9VTlNJR05FRF9TSE9SVCQyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBHTF9VTlNJR05FRF9JTlQkMjoKICAgICAgICAgICAgICBjYXNlIEdMX0lOVCQyOgogICAgICAgICAgICAgICAgZHR5cGUgPSBHTF9VTlNJR05FRF9JTlQkMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJ1bnN1cHBvcnRlZCB0eXBlIGZvciBlbGVtZW50IGFycmF5Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudHMuYnVmZmVyLmR0eXBlID0gZHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50cy50eXBlID0gZHR5cGU7CiAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICBkdHlwZSAhPT0gR0xfVU5TSUdORURfSU5UJDIgfHwgISFleHRlbnNpb25zLm9lc19lbGVtZW50X2luZGV4X3VpbnQsCiAgICAgICAgICAgICIzMiBiaXQgZWxlbWVudCBidWZmZXJzIG5vdCBzdXBwb3J0ZWQsIGVuYWJsZSBvZXNfZWxlbWVudF9pbmRleF91aW50IGZpcnN0IgogICAgICAgICAgKTsKICAgICAgICAgIHZhciB2ZXJ0Q291bnQgPSBjb3VudDI7CiAgICAgICAgICBpZiAodmVydENvdW50IDwgMCkgewogICAgICAgICAgICB2ZXJ0Q291bnQgPSBlbGVtZW50cy5idWZmZXIuYnl0ZUxlbmd0aDsKICAgICAgICAgICAgaWYgKGR0eXBlID09PSBHTF9VTlNJR05FRF9TSE9SVCQyKSB7CiAgICAgICAgICAgICAgdmVydENvdW50ID4+PSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKGR0eXBlID09PSBHTF9VTlNJR05FRF9JTlQkMikgewogICAgICAgICAgICAgIHZlcnRDb3VudCA+Pj0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudHMudmVydENvdW50ID0gdmVydENvdW50OwogICAgICAgICAgdmFyIHByaW1UeXBlID0gcHJpbTsKICAgICAgICAgIGlmIChwcmltIDwgMCkgewogICAgICAgICAgICBwcmltVHlwZSA9IEdMX1RSSUFOR0xFUzsKICAgICAgICAgICAgdmFyIGRpbWVuc2lvbiA9IGVsZW1lbnRzLmJ1ZmZlci5kaW1lbnNpb247CiAgICAgICAgICAgIGlmIChkaW1lbnNpb24gPT09IDEpIHByaW1UeXBlID0gR0xfUE9JTlRTOwogICAgICAgICAgICBpZiAoZGltZW5zaW9uID09PSAyKSBwcmltVHlwZSA9IEdMX0xJTkVTOwogICAgICAgICAgICBpZiAoZGltZW5zaW9uID09PSAzKSBwcmltVHlwZSA9IEdMX1RSSUFOR0xFUzsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnRzLnByaW1UeXBlID0gcHJpbVR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lFbGVtZW50cyhlbGVtZW50cykgewogICAgICAgICAgc3RhdHMyLmVsZW1lbnRzQ291bnQtLTsKICAgICAgICAgIGNoZWNrJDEoZWxlbWVudHMuYnVmZmVyICE9PSBudWxsLCAibXVzdCBub3QgZG91YmxlIGRlc3Ryb3kgZWxlbWVudHMiKTsKICAgICAgICAgIGRlbGV0ZSBlbGVtZW50U2V0W2VsZW1lbnRzLmlkXTsKICAgICAgICAgIGVsZW1lbnRzLmJ1ZmZlci5kZXN0cm95KCk7CiAgICAgICAgICBlbGVtZW50cy5idWZmZXIgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50cyhvcHRpb25zLCBwZXJzaXN0ZW50KSB7CiAgICAgICAgICB2YXIgYnVmZmVyMiA9IGJ1ZmZlclN0YXRlLmNyZWF0ZShudWxsLCBHTF9FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdHJ1ZSk7CiAgICAgICAgICB2YXIgZWxlbWVudHMgPSBuZXcgUkVHTEVsZW1lbnRCdWZmZXIoYnVmZmVyMi5fYnVmZmVyKTsKICAgICAgICAgIHN0YXRzMi5lbGVtZW50c0NvdW50Kys7CiAgICAgICAgICBmdW5jdGlvbiByZWdsRWxlbWVudHMob3B0aW9uczIpIHsKICAgICAgICAgICAgaWYgKCFvcHRpb25zMikgewogICAgICAgICAgICAgIGJ1ZmZlcjIoKTsKICAgICAgICAgICAgICBlbGVtZW50cy5wcmltVHlwZSA9IEdMX1RSSUFOR0xFUzsKICAgICAgICAgICAgICBlbGVtZW50cy52ZXJ0Q291bnQgPSAwOwogICAgICAgICAgICAgIGVsZW1lbnRzLnR5cGUgPSBHTF9VTlNJR05FRF9CWVRFJDQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMyID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGJ1ZmZlcjIob3B0aW9uczIpOwogICAgICAgICAgICAgIGVsZW1lbnRzLnByaW1UeXBlID0gR0xfVFJJQU5HTEVTOwogICAgICAgICAgICAgIGVsZW1lbnRzLnZlcnRDb3VudCA9IG9wdGlvbnMyIHwgMDsKICAgICAgICAgICAgICBlbGVtZW50cy50eXBlID0gR0xfVU5TSUdORURfQllURSQ0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgdXNhZ2UgPSBHTF9TVEFUSUNfRFJBVyQxOwogICAgICAgICAgICAgIHZhciBwcmltVHlwZSA9IC0xOwogICAgICAgICAgICAgIHZhciB2ZXJ0Q291bnQgPSAtMTsKICAgICAgICAgICAgICB2YXIgYnl0ZUxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgdmFyIGR0eXBlID0gMDsKICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zMikgfHwgaXNUeXBlZEFycmF5MihvcHRpb25zMikgfHwgaXNOREFycmF5TGlrZShvcHRpb25zMikpIHsKICAgICAgICAgICAgICAgIGRhdGEgPSBvcHRpb25zMjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2hlY2skMS50eXBlKG9wdGlvbnMyLCAib2JqZWN0IiwgImludmFsaWQgYXJndW1lbnRzIGZvciBlbGVtZW50cyIpOwogICAgICAgICAgICAgICAgaWYgKCJkYXRhIiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgICAgICBkYXRhID0gb3B0aW9uczIuZGF0YTsKICAgICAgICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAgICAgICBBcnJheS5pc0FycmF5KGRhdGEpIHx8IGlzVHlwZWRBcnJheTIoZGF0YSkgfHwgaXNOREFycmF5TGlrZShkYXRhKSwKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBkYXRhIGZvciBlbGVtZW50IGJ1ZmZlciIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgidXNhZ2UiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMyLnVzYWdlLAogICAgICAgICAgICAgICAgICAgIHVzYWdlVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgImludmFsaWQgZWxlbWVudCBidWZmZXIgdXNhZ2UiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHVzYWdlID0gdXNhZ2VUeXBlc1tvcHRpb25zMi51c2FnZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoInByaW1pdGl2ZSIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIoCiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczIucHJpbWl0aXZlLAogICAgICAgICAgICAgICAgICAgIHByaW1UeXBlcywKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBlbGVtZW50IGJ1ZmZlciBwcmltaXRpdmUiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHByaW1UeXBlID0gcHJpbVR5cGVzW29wdGlvbnMyLnByaW1pdGl2ZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoImNvdW50IiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICAgIHR5cGVvZiBvcHRpb25zMi5jb3VudCA9PT0gIm51bWJlciIgJiYgb3B0aW9uczIuY291bnQgPj0gMCwKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCB2ZXJ0ZXggY291bnQgZm9yIGVsZW1lbnRzIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB2ZXJ0Q291bnQgPSBvcHRpb25zMi5jb3VudCB8IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoInR5cGUiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMyLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudFR5cGVzLAogICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGJ1ZmZlciB0eXBlIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBkdHlwZSA9IGVsZW1lbnRUeXBlc1tvcHRpb25zMi50eXBlXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgibGVuZ3RoIiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgICAgICBieXRlTGVuZ3RoID0gb3B0aW9uczIubGVuZ3RoIHwgMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGJ5dGVMZW5ndGggPSB2ZXJ0Q291bnQ7CiAgICAgICAgICAgICAgICAgIGlmIChkdHlwZSA9PT0gR0xfVU5TSUdORURfU0hPUlQkMiB8fCBkdHlwZSA9PT0gR0xfU0hPUlQkMikgewogICAgICAgICAgICAgICAgICAgIGJ5dGVMZW5ndGggKj0gMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkdHlwZSA9PT0gR0xfVU5TSUdORURfSU5UJDIgfHwgZHR5cGUgPT09IEdMX0lOVCQyKSB7CiAgICAgICAgICAgICAgICAgICAgYnl0ZUxlbmd0aCAqPSA0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGluaXRFbGVtZW50cygKICAgICAgICAgICAgICAgIGVsZW1lbnRzLAogICAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICAgIHVzYWdlLAogICAgICAgICAgICAgICAgcHJpbVR5cGUsCiAgICAgICAgICAgICAgICB2ZXJ0Q291bnQsCiAgICAgICAgICAgICAgICBieXRlTGVuZ3RoLAogICAgICAgICAgICAgICAgZHR5cGUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZWdsRWxlbWVudHM7CiAgICAgICAgICB9CiAgICAgICAgICByZWdsRWxlbWVudHMob3B0aW9ucyk7CiAgICAgICAgICByZWdsRWxlbWVudHMuX3JlZ2xUeXBlID0gImVsZW1lbnRzIjsKICAgICAgICAgIHJlZ2xFbGVtZW50cy5fZWxlbWVudHMgPSBlbGVtZW50czsKICAgICAgICAgIHJlZ2xFbGVtZW50cy5zdWJkYXRhID0gZnVuY3Rpb24oZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICAgIGJ1ZmZlcjIuc3ViZGF0YShkYXRhLCBvZmZzZXQpOwogICAgICAgICAgICByZXR1cm4gcmVnbEVsZW1lbnRzOwogICAgICAgICAgfTsKICAgICAgICAgIHJlZ2xFbGVtZW50cy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRlc3Ryb3lFbGVtZW50cyhlbGVtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHJlZ2xFbGVtZW50czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZTogY3JlYXRlRWxlbWVudHMsCiAgICAgICAgICBjcmVhdGVTdHJlYW06IGNyZWF0ZUVsZW1lbnRTdHJlYW0sCiAgICAgICAgICBkZXN0cm95U3RyZWFtOiBkZXN0cm95RWxlbWVudFN0cmVhbSwKICAgICAgICAgIGdldEVsZW1lbnRzOiBmdW5jdGlvbihlbGVtZW50cykgewogICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnRzID09PSAiZnVuY3Rpb24iICYmIGVsZW1lbnRzLl9lbGVtZW50cyBpbnN0YW5jZW9mIFJFR0xFbGVtZW50QnVmZmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRzLl9lbGVtZW50czsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0sCiAgICAgICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhbHVlcyhlbGVtZW50U2V0KS5mb3JFYWNoKGRlc3Ryb3lFbGVtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgRkxPQVQgPSBuZXcgRmxvYXQzMkFycmF5KDEpOwogICAgICB2YXIgSU5UID0gbmV3IFVpbnQzMkFycmF5KEZMT0FULmJ1ZmZlcik7CiAgICAgIHZhciBHTF9VTlNJR05FRF9TSE9SVCQ0ID0gNTEyMzsKICAgICAgZnVuY3Rpb24gY29udmVydFRvSGFsZkZsb2F0KGFycmF5MikgewogICAgICAgIHZhciB1c2hvcnRzID0gcG9vbC5hbGxvY1R5cGUoR0xfVU5TSUdORURfU0hPUlQkNCwgYXJyYXkyLmxlbmd0aCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheTIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGlmIChpc05hTihhcnJheTJbaV0pKSB7CiAgICAgICAgICAgIHVzaG9ydHNbaV0gPSA2NTUzNTsKICAgICAgICAgIH0gZWxzZSBpZiAoYXJyYXkyW2ldID09PSBJbmZpbml0eSkgewogICAgICAgICAgICB1c2hvcnRzW2ldID0gMzE3NDQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGFycmF5MltpXSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgICAgIHVzaG9ydHNbaV0gPSA2NDUxMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEZMT0FUWzBdID0gYXJyYXkyW2ldOwogICAgICAgICAgICB2YXIgeCA9IElOVFswXTsKICAgICAgICAgICAgdmFyIHNnbiA9IHggPj4+IDMxIDw8IDE1OwogICAgICAgICAgICB2YXIgZXhwID0gKHggPDwgMSA+Pj4gMjQpIC0gMTI3OwogICAgICAgICAgICB2YXIgZnJhYyA9IHggPj4gMTMgJiAoMSA8PCAxMCkgLSAxOwogICAgICAgICAgICBpZiAoZXhwIDwgLTI0KSB7CiAgICAgICAgICAgICAgdXNob3J0c1tpXSA9IHNnbjsKICAgICAgICAgICAgfSBlbHNlIGlmIChleHAgPCAtMTQpIHsKICAgICAgICAgICAgICB2YXIgcyA9IC0xNCAtIGV4cDsKICAgICAgICAgICAgICB1c2hvcnRzW2ldID0gc2duICsgKGZyYWMgKyAoMSA8PCAxMCkgPj4gcyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwID4gMTUpIHsKICAgICAgICAgICAgICB1c2hvcnRzW2ldID0gc2duICsgMzE3NDQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXNob3J0c1tpXSA9IHNnbiArIChleHAgKyAxNSA8PCAxMCkgKyBmcmFjOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB1c2hvcnRzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlKHMpIHsKICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShzKSB8fCBpc1R5cGVkQXJyYXkyKHMpOwogICAgICB9CiAgICAgIHZhciBpc1BvdzIkMSA9IGZ1bmN0aW9uKHYpIHsKICAgICAgICByZXR1cm4gISh2ICYgdiAtIDEpICYmICEhdjsKICAgICAgfTsKICAgICAgdmFyIEdMX0NPTVBSRVNTRURfVEVYVFVSRV9GT1JNQVRTID0gMzQ0Njc7CiAgICAgIHZhciBHTF9URVhUVVJFXzJEJDEgPSAzNTUzOwogICAgICB2YXIgR0xfVEVYVFVSRV9DVUJFX01BUCQxID0gMzQwNjc7CiAgICAgIHZhciBHTF9URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1gkMSA9IDM0MDY5OwogICAgICB2YXIgR0xfUkdCQSQxID0gNjQwODsKICAgICAgdmFyIEdMX0FMUEhBID0gNjQwNjsKICAgICAgdmFyIEdMX1JHQiA9IDY0MDc7CiAgICAgIHZhciBHTF9MVU1JTkFOQ0UgPSA2NDA5OwogICAgICB2YXIgR0xfTFVNSU5BTkNFX0FMUEhBID0gNjQxMDsKICAgICAgdmFyIEdMX1JHQkE0ID0gMzI4NTQ7CiAgICAgIHZhciBHTF9SR0I1X0ExID0gMzI4NTU7CiAgICAgIHZhciBHTF9SR0I1NjUgPSAzNjE5NDsKICAgICAgdmFyIEdMX1VOU0lHTkVEX1NIT1JUXzRfNF80XzQkMSA9IDMyODE5OwogICAgICB2YXIgR0xfVU5TSUdORURfU0hPUlRfNV81XzVfMSQxID0gMzI4MjA7CiAgICAgIHZhciBHTF9VTlNJR05FRF9TSE9SVF81XzZfNSQxID0gMzM2MzU7CiAgICAgIHZhciBHTF9VTlNJR05FRF9JTlRfMjRfOF9XRUJHTCQxID0gMzQwNDI7CiAgICAgIHZhciBHTF9ERVBUSF9DT01QT05FTlQgPSA2NDAyOwogICAgICB2YXIgR0xfREVQVEhfU1RFTkNJTCA9IDM0MDQxOwogICAgICB2YXIgR0xfU1JHQl9FWFQgPSAzNTkwNDsKICAgICAgdmFyIEdMX1NSR0JfQUxQSEFfRVhUID0gMzU5MDY7CiAgICAgIHZhciBHTF9IQUxGX0ZMT0FUX09FUyQxID0gMzYxOTM7CiAgICAgIHZhciBHTF9DT01QUkVTU0VEX1JHQl9TM1RDX0RYVDFfRVhUID0gMzM3NzY7CiAgICAgIHZhciBHTF9DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQxX0VYVCA9IDMzNzc3OwogICAgICB2YXIgR0xfQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUM19FWFQgPSAzMzc3ODsKICAgICAgdmFyIEdMX0NPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDVfRVhUID0gMzM3Nzk7CiAgICAgIHZhciBHTF9DT01QUkVTU0VEX1JHQl9BVENfV0VCR0wgPSAzNTk4NjsKICAgICAgdmFyIEdMX0NPTVBSRVNTRURfUkdCQV9BVENfRVhQTElDSVRfQUxQSEFfV0VCR0wgPSAzNTk4NzsKICAgICAgdmFyIEdMX0NPTVBSRVNTRURfUkdCQV9BVENfSU5URVJQT0xBVEVEX0FMUEhBX1dFQkdMID0gMzQ3OTg7CiAgICAgIHZhciBHTF9DT01QUkVTU0VEX1JHQl9QVlJUQ180QlBQVjFfSU1HID0gMzU4NDA7CiAgICAgIHZhciBHTF9DT01QUkVTU0VEX1JHQl9QVlJUQ18yQlBQVjFfSU1HID0gMzU4NDE7CiAgICAgIHZhciBHTF9DT01QUkVTU0VEX1JHQkFfUFZSVENfNEJQUFYxX0lNRyA9IDM1ODQyOwogICAgICB2YXIgR0xfQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzJCUFBWMV9JTUcgPSAzNTg0MzsKICAgICAgdmFyIEdMX0NPTVBSRVNTRURfUkdCX0VUQzFfV0VCR0wgPSAzNjE5NjsKICAgICAgdmFyIEdMX1VOU0lHTkVEX0JZVEUkNSA9IDUxMjE7CiAgICAgIHZhciBHTF9VTlNJR05FRF9TSE9SVCQzID0gNTEyMzsKICAgICAgdmFyIEdMX1VOU0lHTkVEX0lOVCQzID0gNTEyNTsKICAgICAgdmFyIEdMX0ZMT0FUJDQgPSA1MTI2OwogICAgICB2YXIgR0xfVEVYVFVSRV9XUkFQX1MgPSAxMDI0MjsKICAgICAgdmFyIEdMX1RFWFRVUkVfV1JBUF9UID0gMTAyNDM7CiAgICAgIHZhciBHTF9SRVBFQVQgPSAxMDQ5NzsKICAgICAgdmFyIEdMX0NMQU1QX1RPX0VER0UkMSA9IDMzMDcxOwogICAgICB2YXIgR0xfTUlSUk9SRURfUkVQRUFUID0gMzM2NDg7CiAgICAgIHZhciBHTF9URVhUVVJFX01BR19GSUxURVIgPSAxMDI0MDsKICAgICAgdmFyIEdMX1RFWFRVUkVfTUlOX0ZJTFRFUiA9IDEwMjQxOwogICAgICB2YXIgR0xfTkVBUkVTVCQxID0gOTcyODsKICAgICAgdmFyIEdMX0xJTkVBUiA9IDk3Mjk7CiAgICAgIHZhciBHTF9ORUFSRVNUX01JUE1BUF9ORUFSRVNUJDEgPSA5OTg0OwogICAgICB2YXIgR0xfTElORUFSX01JUE1BUF9ORUFSRVNUJDEgPSA5OTg1OwogICAgICB2YXIgR0xfTkVBUkVTVF9NSVBNQVBfTElORUFSJDEgPSA5OTg2OwogICAgICB2YXIgR0xfTElORUFSX01JUE1BUF9MSU5FQVIkMSA9IDk5ODc7CiAgICAgIHZhciBHTF9HRU5FUkFURV9NSVBNQVBfSElOVCA9IDMzMTcwOwogICAgICB2YXIgR0xfRE9OVF9DQVJFID0gNDM1MjsKICAgICAgdmFyIEdMX0ZBU1RFU1QgPSA0MzUzOwogICAgICB2YXIgR0xfTklDRVNUID0gNDM1NDsKICAgICAgdmFyIEdMX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUID0gMzQwNDY7CiAgICAgIHZhciBHTF9VTlBBQ0tfQUxJR05NRU5UID0gMzMxNzsKICAgICAgdmFyIEdMX1VOUEFDS19GTElQX1lfV0VCR0wgPSAzNzQ0MDsKICAgICAgdmFyIEdMX1VOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCA9IDM3NDQxOwogICAgICB2YXIgR0xfVU5QQUNLX0NPTE9SU1BBQ0VfQ09OVkVSU0lPTl9XRUJHTCA9IDM3NDQzOwogICAgICB2YXIgR0xfQlJPV1NFUl9ERUZBVUxUX1dFQkdMID0gMzc0NDQ7CiAgICAgIHZhciBHTF9URVhUVVJFMCQxID0gMzM5ODQ7CiAgICAgIHZhciBNSVBNQVBfRklMVEVSUyA9IFsKICAgICAgICBHTF9ORUFSRVNUX01JUE1BUF9ORUFSRVNUJDEsCiAgICAgICAgR0xfTkVBUkVTVF9NSVBNQVBfTElORUFSJDEsCiAgICAgICAgR0xfTElORUFSX01JUE1BUF9ORUFSRVNUJDEsCiAgICAgICAgR0xfTElORUFSX01JUE1BUF9MSU5FQVIkMQogICAgICBdOwogICAgICB2YXIgQ0hBTk5FTFNfRk9STUFUID0gWwogICAgICAgIDAsCiAgICAgICAgR0xfTFVNSU5BTkNFLAogICAgICAgIEdMX0xVTUlOQU5DRV9BTFBIQSwKICAgICAgICBHTF9SR0IsCiAgICAgICAgR0xfUkdCQSQxCiAgICAgIF07CiAgICAgIHZhciBGT1JNQVRfQ0hBTk5FTFMgPSB7fTsKICAgICAgRk9STUFUX0NIQU5ORUxTW0dMX0xVTUlOQU5DRV0gPSBGT1JNQVRfQ0hBTk5FTFNbR0xfQUxQSEFdID0gRk9STUFUX0NIQU5ORUxTW0dMX0RFUFRIX0NPTVBPTkVOVF0gPSAxOwogICAgICBGT1JNQVRfQ0hBTk5FTFNbR0xfREVQVEhfU1RFTkNJTF0gPSBGT1JNQVRfQ0hBTk5FTFNbR0xfTFVNSU5BTkNFX0FMUEhBXSA9IDI7CiAgICAgIEZPUk1BVF9DSEFOTkVMU1tHTF9SR0JdID0gRk9STUFUX0NIQU5ORUxTW0dMX1NSR0JfRVhUXSA9IDM7CiAgICAgIEZPUk1BVF9DSEFOTkVMU1tHTF9SR0JBJDFdID0gRk9STUFUX0NIQU5ORUxTW0dMX1NSR0JfQUxQSEFfRVhUXSA9IDQ7CiAgICAgIGZ1bmN0aW9uIG9iamVjdE5hbWUoc3RyKSB7CiAgICAgICAgcmV0dXJuICJbb2JqZWN0ICIgKyBzdHIgKyAiXSI7CiAgICAgIH0KICAgICAgdmFyIENBTlZBU19DTEFTUyA9IG9iamVjdE5hbWUoIkhUTUxDYW52YXNFbGVtZW50Iik7CiAgICAgIHZhciBPRkZTQ1JFRU5DQU5WQVNfQ0xBU1MgPSBvYmplY3ROYW1lKCJPZmZzY3JlZW5DYW52YXMiKTsKICAgICAgdmFyIENPTlRFWFQyRF9DTEFTUyA9IG9iamVjdE5hbWUoIkNhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCIpOwogICAgICB2YXIgQklUTUFQX0NMQVNTID0gb2JqZWN0TmFtZSgiSW1hZ2VCaXRtYXAiKTsKICAgICAgdmFyIElNQUdFX0NMQVNTID0gb2JqZWN0TmFtZSgiSFRNTEltYWdlRWxlbWVudCIpOwogICAgICB2YXIgVklERU9fQ0xBU1MgPSBvYmplY3ROYW1lKCJIVE1MVmlkZW9FbGVtZW50Iik7CiAgICAgIHZhciBQSVhFTF9DTEFTU0VTID0gT2JqZWN0LmtleXMoYXJyYXlUeXBlcykuY29uY2F0KFsKICAgICAgICBDQU5WQVNfQ0xBU1MsCiAgICAgICAgT0ZGU0NSRUVOQ0FOVkFTX0NMQVNTLAogICAgICAgIENPTlRFWFQyRF9DTEFTUywKICAgICAgICBCSVRNQVBfQ0xBU1MsCiAgICAgICAgSU1BR0VfQ0xBU1MsCiAgICAgICAgVklERU9fQ0xBU1MKICAgICAgXSk7CiAgICAgIHZhciBUWVBFX1NJWkVTID0gW107CiAgICAgIFRZUEVfU0laRVNbR0xfVU5TSUdORURfQllURSQ1XSA9IDE7CiAgICAgIFRZUEVfU0laRVNbR0xfRkxPQVQkNF0gPSA0OwogICAgICBUWVBFX1NJWkVTW0dMX0hBTEZfRkxPQVRfT0VTJDFdID0gMjsKICAgICAgVFlQRV9TSVpFU1tHTF9VTlNJR05FRF9TSE9SVCQzXSA9IDI7CiAgICAgIFRZUEVfU0laRVNbR0xfVU5TSUdORURfSU5UJDNdID0gNDsKICAgICAgdmFyIEZPUk1BVF9TSVpFU19TUEVDSUFMID0gW107CiAgICAgIEZPUk1BVF9TSVpFU19TUEVDSUFMW0dMX1JHQkE0XSA9IDI7CiAgICAgIEZPUk1BVF9TSVpFU19TUEVDSUFMW0dMX1JHQjVfQTFdID0gMjsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfUkdCNTY1XSA9IDI7CiAgICAgIEZPUk1BVF9TSVpFU19TUEVDSUFMW0dMX0RFUFRIX1NURU5DSUxdID0gNDsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfQ09NUFJFU1NFRF9SR0JfUzNUQ19EWFQxX0VYVF0gPSAwLjU7CiAgICAgIEZPUk1BVF9TSVpFU19TUEVDSUFMW0dMX0NPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhUXSA9IDAuNTsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUM19FWFRdID0gMTsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFRdID0gMTsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfQ09NUFJFU1NFRF9SR0JfQVRDX1dFQkdMXSA9IDAuNTsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfQ09NUFJFU1NFRF9SR0JBX0FUQ19FWFBMSUNJVF9BTFBIQV9XRUJHTF0gPSAxOwogICAgICBGT1JNQVRfU0laRVNfU1BFQ0lBTFtHTF9DT01QUkVTU0VEX1JHQkFfQVRDX0lOVEVSUE9MQVRFRF9BTFBIQV9XRUJHTF0gPSAxOwogICAgICBGT1JNQVRfU0laRVNfU1BFQ0lBTFtHTF9DT01QUkVTU0VEX1JHQl9QVlJUQ180QlBQVjFfSU1HXSA9IDAuNTsKICAgICAgRk9STUFUX1NJWkVTX1NQRUNJQUxbR0xfQ09NUFJFU1NFRF9SR0JfUFZSVENfMkJQUFYxX0lNR10gPSAwLjI1OwogICAgICBGT1JNQVRfU0laRVNfU1BFQ0lBTFtHTF9DT01QUkVTU0VEX1JHQkFfUFZSVENfNEJQUFYxX0lNR10gPSAwLjU7CiAgICAgIEZPUk1BVF9TSVpFU19TUEVDSUFMW0dMX0NPTVBSRVNTRURfUkdCQV9QVlJUQ18yQlBQVjFfSU1HXSA9IDAuMjU7CiAgICAgIEZPUk1BVF9TSVpFU19TUEVDSUFMW0dMX0NPTVBSRVNTRURfUkdCX0VUQzFfV0VCR0xdID0gMC41OwogICAgICBmdW5jdGlvbiBpc051bWVyaWNBcnJheShhcnIpIHsKICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShhcnIpICYmIChhcnIubGVuZ3RoID09PSAwIHx8IHR5cGVvZiBhcnJbMF0gPT09ICJudW1iZXIiKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc1JlY3RBcnJheShhcnIpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgd2lkdGggPSBhcnIubGVuZ3RoOwogICAgICAgIGlmICh3aWR0aCA9PT0gMCB8fCAhaXNBcnJheUxpa2UoYXJyWzBdKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjbGFzc1N0cmluZyh4KSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0NhbnZhc0VsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGNsYXNzU3RyaW5nKG9iamVjdCkgPT09IENBTlZBU19DTEFTUzsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc09mZnNjcmVlbkNhbnZhcyhvYmplY3QpIHsKICAgICAgICByZXR1cm4gY2xhc3NTdHJpbmcob2JqZWN0KSA9PT0gT0ZGU0NSRUVOQ0FOVkFTX0NMQVNTOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzQ29udGV4dDJEKG9iamVjdCkgewogICAgICAgIHJldHVybiBjbGFzc1N0cmluZyhvYmplY3QpID09PSBDT05URVhUMkRfQ0xBU1M7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNCaXRtYXAob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGNsYXNzU3RyaW5nKG9iamVjdCkgPT09IEJJVE1BUF9DTEFTUzsKICAgICAgfQogICAgICBmdW5jdGlvbiBpc0ltYWdlRWxlbWVudChvYmplY3QpIHsKICAgICAgICByZXR1cm4gY2xhc3NTdHJpbmcob2JqZWN0KSA9PT0gSU1BR0VfQ0xBU1M7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNWaWRlb0VsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGNsYXNzU3RyaW5nKG9iamVjdCkgPT09IFZJREVPX0NMQVNTOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGlzUGl4ZWxEYXRhKG9iamVjdCkgewogICAgICAgIGlmICghb2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc05hbWUgPSBjbGFzc1N0cmluZyhvYmplY3QpOwogICAgICAgIGlmIChQSVhFTF9DTEFTU0VTLmluZGV4T2YoY2xhc3NOYW1lKSA+PSAwKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzTnVtZXJpY0FycmF5KG9iamVjdCkgfHwgaXNSZWN0QXJyYXkob2JqZWN0KSB8fCBpc05EQXJyYXlMaWtlKG9iamVjdCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHlwZWRBcnJheUNvZGUkMShkYXRhKSB7CiAgICAgICAgcmV0dXJuIGFycmF5VHlwZXNbT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRhdGEpXSB8IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29udmVydERhdGEocmVzdWx0LCBkYXRhKSB7CiAgICAgICAgdmFyIG4gPSBkYXRhLmxlbmd0aDsKICAgICAgICBzd2l0Y2ggKHJlc3VsdC50eXBlKSB7CiAgICAgICAgICBjYXNlIEdMX1VOU0lHTkVEX0JZVEUkNToKICAgICAgICAgIGNhc2UgR0xfVU5TSUdORURfU0hPUlQkMzoKICAgICAgICAgIGNhc2UgR0xfVU5TSUdORURfSU5UJDM6CiAgICAgICAgICBjYXNlIEdMX0ZMT0FUJDQ6CiAgICAgICAgICAgIHZhciBjb252ZXJ0ZWQgPSBwb29sLmFsbG9jVHlwZShyZXN1bHQudHlwZSwgbik7CiAgICAgICAgICAgIGNvbnZlcnRlZC5zZXQoZGF0YSk7CiAgICAgICAgICAgIHJlc3VsdC5kYXRhID0gY29udmVydGVkOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgR0xfSEFMRl9GTE9BVF9PRVMkMToKICAgICAgICAgICAgcmVzdWx0LmRhdGEgPSBjb252ZXJ0VG9IYWxmRmxvYXQoZGF0YSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgY2hlY2skMS5yYWlzZSgidW5zdXBwb3J0ZWQgdGV4dHVyZSB0eXBlLCBtdXN0IHNwZWNpZnkgYSB0eXBlZCBhcnJheSIpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBwcmVDb252ZXJ0KGltYWdlLCBuKSB7CiAgICAgICAgcmV0dXJuIHBvb2wuYWxsb2NUeXBlKAogICAgICAgICAgaW1hZ2UudHlwZSA9PT0gR0xfSEFMRl9GTE9BVF9PRVMkMSA/IEdMX0ZMT0FUJDQgOiBpbWFnZS50eXBlLAogICAgICAgICAgbgogICAgICAgICk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcG9zdENvbnZlcnQoaW1hZ2UsIGRhdGEpIHsKICAgICAgICBpZiAoaW1hZ2UudHlwZSA9PT0gR0xfSEFMRl9GTE9BVF9PRVMkMSkgewogICAgICAgICAgaW1hZ2UuZGF0YSA9IGNvbnZlcnRUb0hhbGZGbG9hdChkYXRhKTsKICAgICAgICAgIHBvb2wuZnJlZVR5cGUoZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGltYWdlLmRhdGEgPSBkYXRhOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB0cmFuc3Bvc2VEYXRhKGltYWdlLCBhcnJheTIsIHN0cmlkZVgsIHN0cmlkZVksIHN0cmlkZUMsIG9mZnNldCkgewogICAgICAgIHZhciB3ID0gaW1hZ2Uud2lkdGg7CiAgICAgICAgdmFyIGggPSBpbWFnZS5oZWlnaHQ7CiAgICAgICAgdmFyIGMgPSBpbWFnZS5jaGFubmVsczsKICAgICAgICB2YXIgbiA9IHcgKiBoICogYzsKICAgICAgICB2YXIgZGF0YSA9IHByZUNvbnZlcnQoaW1hZ2UsIG4pOwogICAgICAgIHZhciBwID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGg7ICsraSkgewogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB3OyArK2opIHsKICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBjOyArK2spIHsKICAgICAgICAgICAgICBkYXRhW3ArK10gPSBhcnJheTJbc3RyaWRlWCAqIGogKyBzdHJpZGVZICogaSArIHN0cmlkZUMgKiBrICsgb2Zmc2V0XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwb3N0Q29udmVydChpbWFnZSwgZGF0YSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0VGV4dHVyZVNpemUoZm9ybWF0MiwgdHlwZSwgd2lkdGgsIGhlaWdodCwgaXNNaXBtYXAsIGlzQ3ViZSkgewogICAgICAgIHZhciBzOwogICAgICAgIGlmICh0eXBlb2YgRk9STUFUX1NJWkVTX1NQRUNJQUxbZm9ybWF0Ml0gIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICBzID0gRk9STUFUX1NJWkVTX1NQRUNJQUxbZm9ybWF0Ml07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHMgPSBGT1JNQVRfQ0hBTk5FTFNbZm9ybWF0Ml0gKiBUWVBFX1NJWkVTW3R5cGVdOwogICAgICAgIH0KICAgICAgICBpZiAoaXNDdWJlKSB7CiAgICAgICAgICBzICo9IDY7CiAgICAgICAgfQogICAgICAgIGlmIChpc01pcG1hcCkgewogICAgICAgICAgdmFyIHRvdGFsID0gMDsKICAgICAgICAgIHZhciB3ID0gd2lkdGg7CiAgICAgICAgICB3aGlsZSAodyA+PSAxKSB7CiAgICAgICAgICAgIHRvdGFsICs9IHMgKiB3ICogdzsKICAgICAgICAgICAgdyAvPSAyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcyAqIHdpZHRoICogaGVpZ2h0OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0dXJlU2V0KGdsLCBleHRlbnNpb25zLCBsaW1pdHMsIHJlZ2xQb2xsLCBjb250ZXh0U3RhdGUsIHN0YXRzMiwgY29uZmlnKSB7CiAgICAgICAgdmFyIG1pcG1hcEhpbnQgPSB7CiAgICAgICAgICAiZG9uJ3QgY2FyZSI6IEdMX0RPTlRfQ0FSRSwKICAgICAgICAgICJkb250IGNhcmUiOiBHTF9ET05UX0NBUkUsCiAgICAgICAgICAibmljZSI6IEdMX05JQ0VTVCwKICAgICAgICAgICJmYXN0IjogR0xfRkFTVEVTVAogICAgICAgIH07CiAgICAgICAgdmFyIHdyYXBNb2RlcyA9IHsKICAgICAgICAgICJyZXBlYXQiOiBHTF9SRVBFQVQsCiAgICAgICAgICAiY2xhbXAiOiBHTF9DTEFNUF9UT19FREdFJDEsCiAgICAgICAgICAibWlycm9yIjogR0xfTUlSUk9SRURfUkVQRUFUCiAgICAgICAgfTsKICAgICAgICB2YXIgbWFnRmlsdGVycyA9IHsKICAgICAgICAgICJuZWFyZXN0IjogR0xfTkVBUkVTVCQxLAogICAgICAgICAgImxpbmVhciI6IEdMX0xJTkVBUgogICAgICAgIH07CiAgICAgICAgdmFyIG1pbkZpbHRlcnMgPSBleHRlbmQyKHsKICAgICAgICAgICJtaXBtYXAiOiBHTF9MSU5FQVJfTUlQTUFQX0xJTkVBUiQxLAogICAgICAgICAgIm5lYXJlc3QgbWlwbWFwIG5lYXJlc3QiOiBHTF9ORUFSRVNUX01JUE1BUF9ORUFSRVNUJDEsCiAgICAgICAgICAibGluZWFyIG1pcG1hcCBuZWFyZXN0IjogR0xfTElORUFSX01JUE1BUF9ORUFSRVNUJDEsCiAgICAgICAgICAibmVhcmVzdCBtaXBtYXAgbGluZWFyIjogR0xfTkVBUkVTVF9NSVBNQVBfTElORUFSJDEsCiAgICAgICAgICAibGluZWFyIG1pcG1hcCBsaW5lYXIiOiBHTF9MSU5FQVJfTUlQTUFQX0xJTkVBUiQxCiAgICAgICAgfSwgbWFnRmlsdGVycyk7CiAgICAgICAgdmFyIGNvbG9yU3BhY2UgPSB7CiAgICAgICAgICAibm9uZSI6IDAsCiAgICAgICAgICAiYnJvd3NlciI6IEdMX0JST1dTRVJfREVGQVVMVF9XRUJHTAogICAgICAgIH07CiAgICAgICAgdmFyIHRleHR1cmVUeXBlcyA9IHsKICAgICAgICAgICJ1aW50OCI6IEdMX1VOU0lHTkVEX0JZVEUkNSwKICAgICAgICAgICJyZ2JhNCI6IEdMX1VOU0lHTkVEX1NIT1JUXzRfNF80XzQkMSwKICAgICAgICAgICJyZ2I1NjUiOiBHTF9VTlNJR05FRF9TSE9SVF81XzZfNSQxLAogICAgICAgICAgInJnYjUgYTEiOiBHTF9VTlNJR05FRF9TSE9SVF81XzVfNV8xJDEKICAgICAgICB9OwogICAgICAgIHZhciB0ZXh0dXJlRm9ybWF0cyA9IHsKICAgICAgICAgICJhbHBoYSI6IEdMX0FMUEhBLAogICAgICAgICAgImx1bWluYW5jZSI6IEdMX0xVTUlOQU5DRSwKICAgICAgICAgICJsdW1pbmFuY2UgYWxwaGEiOiBHTF9MVU1JTkFOQ0VfQUxQSEEsCiAgICAgICAgICAicmdiIjogR0xfUkdCLAogICAgICAgICAgInJnYmEiOiBHTF9SR0JBJDEsCiAgICAgICAgICAicmdiYTQiOiBHTF9SR0JBNCwKICAgICAgICAgICJyZ2I1IGExIjogR0xfUkdCNV9BMSwKICAgICAgICAgICJyZ2I1NjUiOiBHTF9SR0I1NjUKICAgICAgICB9OwogICAgICAgIHZhciBjb21wcmVzc2VkVGV4dHVyZUZvcm1hdHMgPSB7fTsKICAgICAgICBpZiAoZXh0ZW5zaW9ucy5leHRfc3JnYikgewogICAgICAgICAgdGV4dHVyZUZvcm1hdHMuc3JnYiA9IEdMX1NSR0JfRVhUOwogICAgICAgICAgdGV4dHVyZUZvcm1hdHMuc3JnYmEgPSBHTF9TUkdCX0FMUEhBX0VYVDsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dGVuc2lvbnMub2VzX3RleHR1cmVfZmxvYXQpIHsKICAgICAgICAgIHRleHR1cmVUeXBlcy5mbG9hdDMyID0gdGV4dHVyZVR5cGVzLmZsb2F0ID0gR0xfRkxPQVQkNDsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dGVuc2lvbnMub2VzX3RleHR1cmVfaGFsZl9mbG9hdCkgewogICAgICAgICAgdGV4dHVyZVR5cGVzWyJmbG9hdDE2Il0gPSB0ZXh0dXJlVHlwZXNbImhhbGYgZmxvYXQiXSA9IEdMX0hBTEZfRkxPQVRfT0VTJDE7CiAgICAgICAgfQogICAgICAgIGlmIChleHRlbnNpb25zLndlYmdsX2RlcHRoX3RleHR1cmUpIHsKICAgICAgICAgIGV4dGVuZDIodGV4dHVyZUZvcm1hdHMsIHsKICAgICAgICAgICAgImRlcHRoIjogR0xfREVQVEhfQ09NUE9ORU5ULAogICAgICAgICAgICAiZGVwdGggc3RlbmNpbCI6IEdMX0RFUFRIX1NURU5DSUwKICAgICAgICAgIH0pOwogICAgICAgICAgZXh0ZW5kMih0ZXh0dXJlVHlwZXMsIHsKICAgICAgICAgICAgInVpbnQxNiI6IEdMX1VOU0lHTkVEX1NIT1JUJDMsCiAgICAgICAgICAgICJ1aW50MzIiOiBHTF9VTlNJR05FRF9JTlQkMywKICAgICAgICAgICAgImRlcHRoIHN0ZW5jaWwiOiBHTF9VTlNJR05FRF9JTlRfMjRfOF9XRUJHTCQxCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dGVuc2lvbnMud2ViZ2xfY29tcHJlc3NlZF90ZXh0dXJlX3MzdGMpIHsKICAgICAgICAgIGV4dGVuZDIoY29tcHJlc3NlZFRleHR1cmVGb3JtYXRzLCB7CiAgICAgICAgICAgICJyZ2IgczN0YyBkeHQxIjogR0xfQ09NUFJFU1NFRF9SR0JfUzNUQ19EWFQxX0VYVCwKICAgICAgICAgICAgInJnYmEgczN0YyBkeHQxIjogR0xfQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUMV9FWFQsCiAgICAgICAgICAgICJyZ2JhIHMzdGMgZHh0MyI6IEdMX0NPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDNfRVhULAogICAgICAgICAgICAicmdiYSBzM3RjIGR4dDUiOiBHTF9DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQ1X0VYVAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChleHRlbnNpb25zLndlYmdsX2NvbXByZXNzZWRfdGV4dHVyZV9hdGMpIHsKICAgICAgICAgIGV4dGVuZDIoY29tcHJlc3NlZFRleHR1cmVGb3JtYXRzLCB7CiAgICAgICAgICAgICJyZ2IgYXRjIjogR0xfQ09NUFJFU1NFRF9SR0JfQVRDX1dFQkdMLAogICAgICAgICAgICAicmdiYSBhdGMgZXhwbGljaXQgYWxwaGEiOiBHTF9DT01QUkVTU0VEX1JHQkFfQVRDX0VYUExJQ0lUX0FMUEhBX1dFQkdMLAogICAgICAgICAgICAicmdiYSBhdGMgaW50ZXJwb2xhdGVkIGFscGhhIjogR0xfQ09NUFJFU1NFRF9SR0JBX0FUQ19JTlRFUlBPTEFURURfQUxQSEFfV0VCR0wKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoZXh0ZW5zaW9ucy53ZWJnbF9jb21wcmVzc2VkX3RleHR1cmVfcHZydGMpIHsKICAgICAgICAgIGV4dGVuZDIoY29tcHJlc3NlZFRleHR1cmVGb3JtYXRzLCB7CiAgICAgICAgICAgICJyZ2IgcHZydGMgNGJwcHYxIjogR0xfQ09NUFJFU1NFRF9SR0JfUFZSVENfNEJQUFYxX0lNRywKICAgICAgICAgICAgInJnYiBwdnJ0YyAyYnBwdjEiOiBHTF9DT01QUkVTU0VEX1JHQl9QVlJUQ18yQlBQVjFfSU1HLAogICAgICAgICAgICAicmdiYSBwdnJ0YyA0YnBwdjEiOiBHTF9DT01QUkVTU0VEX1JHQkFfUFZSVENfNEJQUFYxX0lNRywKICAgICAgICAgICAgInJnYmEgcHZydGMgMmJwcHYxIjogR0xfQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzJCUFBWMV9JTUcKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoZXh0ZW5zaW9ucy53ZWJnbF9jb21wcmVzc2VkX3RleHR1cmVfZXRjMSkgewogICAgICAgICAgY29tcHJlc3NlZFRleHR1cmVGb3JtYXRzWyJyZ2IgZXRjMSJdID0gR0xfQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTDsKICAgICAgICB9CiAgICAgICAgdmFyIHN1cHBvcnRlZENvbXByZXNzZWRGb3JtYXRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoCiAgICAgICAgICBnbC5nZXRQYXJhbWV0ZXIoR0xfQ09NUFJFU1NFRF9URVhUVVJFX0ZPUk1BVFMpCiAgICAgICAgKTsKICAgICAgICBPYmplY3Qua2V5cyhjb21wcmVzc2VkVGV4dHVyZUZvcm1hdHMpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgdmFyIGZvcm1hdDIgPSBjb21wcmVzc2VkVGV4dHVyZUZvcm1hdHNbbmFtZV07CiAgICAgICAgICBpZiAoc3VwcG9ydGVkQ29tcHJlc3NlZEZvcm1hdHMuaW5kZXhPZihmb3JtYXQyKSA+PSAwKSB7CiAgICAgICAgICAgIHRleHR1cmVGb3JtYXRzW25hbWVdID0gZm9ybWF0MjsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgc3VwcG9ydGVkRm9ybWF0cyA9IE9iamVjdC5rZXlzKHRleHR1cmVGb3JtYXRzKTsKICAgICAgICBsaW1pdHMudGV4dHVyZUZvcm1hdHMgPSBzdXBwb3J0ZWRGb3JtYXRzOwogICAgICAgIHZhciB0ZXh0dXJlRm9ybWF0c0ludmVydCA9IFtdOwogICAgICAgIE9iamVjdC5rZXlzKHRleHR1cmVGb3JtYXRzKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgdmFyIHZhbCA9IHRleHR1cmVGb3JtYXRzW2tleV07CiAgICAgICAgICB0ZXh0dXJlRm9ybWF0c0ludmVydFt2YWxdID0ga2V5OwogICAgICAgIH0pOwogICAgICAgIHZhciB0ZXh0dXJlVHlwZXNJbnZlcnQgPSBbXTsKICAgICAgICBPYmplY3Qua2V5cyh0ZXh0dXJlVHlwZXMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICB2YXIgdmFsID0gdGV4dHVyZVR5cGVzW2tleV07CiAgICAgICAgICB0ZXh0dXJlVHlwZXNJbnZlcnRbdmFsXSA9IGtleTsKICAgICAgICB9KTsKICAgICAgICB2YXIgbWFnRmlsdGVyc0ludmVydCA9IFtdOwogICAgICAgIE9iamVjdC5rZXlzKG1hZ0ZpbHRlcnMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICB2YXIgdmFsID0gbWFnRmlsdGVyc1trZXldOwogICAgICAgICAgbWFnRmlsdGVyc0ludmVydFt2YWxdID0ga2V5OwogICAgICAgIH0pOwogICAgICAgIHZhciBtaW5GaWx0ZXJzSW52ZXJ0ID0gW107CiAgICAgICAgT2JqZWN0LmtleXMobWluRmlsdGVycykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIHZhciB2YWwgPSBtaW5GaWx0ZXJzW2tleV07CiAgICAgICAgICBtaW5GaWx0ZXJzSW52ZXJ0W3ZhbF0gPSBrZXk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHdyYXBNb2Rlc0ludmVydCA9IFtdOwogICAgICAgIE9iamVjdC5rZXlzKHdyYXBNb2RlcykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgIHZhciB2YWwgPSB3cmFwTW9kZXNba2V5XTsKICAgICAgICAgIHdyYXBNb2Rlc0ludmVydFt2YWxdID0ga2V5OwogICAgICAgIH0pOwogICAgICAgIHZhciBjb2xvckZvcm1hdHMgPSBzdXBwb3J0ZWRGb3JtYXRzLnJlZHVjZShmdW5jdGlvbihjb2xvcjIsIGtleSkgewogICAgICAgICAgdmFyIGdsZW51bSA9IHRleHR1cmVGb3JtYXRzW2tleV07CiAgICAgICAgICBpZiAoZ2xlbnVtID09PSBHTF9MVU1JTkFOQ0UgfHwgZ2xlbnVtID09PSBHTF9BTFBIQSB8fCBnbGVudW0gPT09IEdMX0xVTUlOQU5DRSB8fCBnbGVudW0gPT09IEdMX0xVTUlOQU5DRV9BTFBIQSB8fCBnbGVudW0gPT09IEdMX0RFUFRIX0NPTVBPTkVOVCB8fCBnbGVudW0gPT09IEdMX0RFUFRIX1NURU5DSUwgfHwgZXh0ZW5zaW9ucy5leHRfc3JnYiAmJiAoZ2xlbnVtID09PSBHTF9TUkdCX0VYVCB8fCBnbGVudW0gPT09IEdMX1NSR0JfQUxQSEFfRVhUKSkgewogICAgICAgICAgICBjb2xvcjJbZ2xlbnVtXSA9IGdsZW51bTsKICAgICAgICAgIH0gZWxzZSBpZiAoZ2xlbnVtID09PSBHTF9SR0I1X0ExIHx8IGtleS5pbmRleE9mKCJyZ2JhIikgPj0gMCkgewogICAgICAgICAgICBjb2xvcjJbZ2xlbnVtXSA9IEdMX1JHQkEkMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbG9yMltnbGVudW1dID0gR0xfUkdCOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbG9yMjsKICAgICAgICB9LCB7fSk7CiAgICAgICAgZnVuY3Rpb24gVGV4RmxhZ3MoKSB7CiAgICAgICAgICB0aGlzLmludGVybmFsZm9ybWF0ID0gR0xfUkdCQSQxOwogICAgICAgICAgdGhpcy5mb3JtYXQgPSBHTF9SR0JBJDE7CiAgICAgICAgICB0aGlzLnR5cGUgPSBHTF9VTlNJR05FRF9CWVRFJDU7CiAgICAgICAgICB0aGlzLmNvbXByZXNzZWQgPSBmYWxzZTsKICAgICAgICAgIHRoaXMucHJlbXVsdGlwbHlBbHBoYSA9IGZhbHNlOwogICAgICAgICAgdGhpcy5mbGlwWSA9IGZhbHNlOwogICAgICAgICAgdGhpcy51bnBhY2tBbGlnbm1lbnQgPSAxOwogICAgICAgICAgdGhpcy5jb2xvclNwYWNlID0gR0xfQlJPV1NFUl9ERUZBVUxUX1dFQkdMOwogICAgICAgICAgdGhpcy53aWR0aCA9IDA7CiAgICAgICAgICB0aGlzLmhlaWdodCA9IDA7CiAgICAgICAgICB0aGlzLmNoYW5uZWxzID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29weUZsYWdzKHJlc3VsdCwgb3RoZXIpIHsKICAgICAgICAgIHJlc3VsdC5pbnRlcm5hbGZvcm1hdCA9IG90aGVyLmludGVybmFsZm9ybWF0OwogICAgICAgICAgcmVzdWx0LmZvcm1hdCA9IG90aGVyLmZvcm1hdDsKICAgICAgICAgIHJlc3VsdC50eXBlID0gb3RoZXIudHlwZTsKICAgICAgICAgIHJlc3VsdC5jb21wcmVzc2VkID0gb3RoZXIuY29tcHJlc3NlZDsKICAgICAgICAgIHJlc3VsdC5wcmVtdWx0aXBseUFscGhhID0gb3RoZXIucHJlbXVsdGlwbHlBbHBoYTsKICAgICAgICAgIHJlc3VsdC5mbGlwWSA9IG90aGVyLmZsaXBZOwogICAgICAgICAgcmVzdWx0LnVucGFja0FsaWdubWVudCA9IG90aGVyLnVucGFja0FsaWdubWVudDsKICAgICAgICAgIHJlc3VsdC5jb2xvclNwYWNlID0gb3RoZXIuY29sb3JTcGFjZTsKICAgICAgICAgIHJlc3VsdC53aWR0aCA9IG90aGVyLndpZHRoOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IG90aGVyLmhlaWdodDsKICAgICAgICAgIHJlc3VsdC5jaGFubmVscyA9IG90aGVyLmNoYW5uZWxzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZUZsYWdzKGZsYWdzLCBvcHRpb25zKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgIT09ICJvYmplY3QiIHx8ICFvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgicHJlbXVsdGlwbHlBbHBoYSIgaW4gb3B0aW9ucykgewogICAgICAgICAgICBjaGVjayQxLnR5cGUoCiAgICAgICAgICAgICAgb3B0aW9ucy5wcmVtdWx0aXBseUFscGhhLAogICAgICAgICAgICAgICJib29sZWFuIiwKICAgICAgICAgICAgICAiaW52YWxpZCBwcmVtdWx0aXBseUFscGhhIgogICAgICAgICAgICApOwogICAgICAgICAgICBmbGFncy5wcmVtdWx0aXBseUFscGhhID0gb3B0aW9ucy5wcmVtdWx0aXBseUFscGhhOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJmbGlwWSIgaW4gb3B0aW9ucykgewogICAgICAgICAgICBjaGVjayQxLnR5cGUoCiAgICAgICAgICAgICAgb3B0aW9ucy5mbGlwWSwKICAgICAgICAgICAgICAiYm9vbGVhbiIsCiAgICAgICAgICAgICAgImludmFsaWQgdGV4dHVyZSBmbGlwIgogICAgICAgICAgICApOwogICAgICAgICAgICBmbGFncy5mbGlwWSA9IG9wdGlvbnMuZmxpcFk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoImFsaWdubWVudCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICBjaGVjayQxLm9uZU9mKAogICAgICAgICAgICAgIG9wdGlvbnMuYWxpZ25tZW50LAogICAgICAgICAgICAgIFsxLCAyLCA0LCA4XSwKICAgICAgICAgICAgICAiaW52YWxpZCB0ZXh0dXJlIHVucGFjayBhbGlnbm1lbnQiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZsYWdzLnVucGFja0FsaWdubWVudCA9IG9wdGlvbnMuYWxpZ25tZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJjb2xvclNwYWNlIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKAogICAgICAgICAgICAgIG9wdGlvbnMuY29sb3JTcGFjZSwKICAgICAgICAgICAgICBjb2xvclNwYWNlLAogICAgICAgICAgICAgICJpbnZhbGlkIGNvbG9yU3BhY2UiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGZsYWdzLmNvbG9yU3BhY2UgPSBjb2xvclNwYWNlW29wdGlvbnMuY29sb3JTcGFjZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoInR5cGUiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5vZXNfdGV4dHVyZV9mbG9hdCB8fCAhKHR5cGUgPT09ICJmbG9hdCIgfHwgdHlwZSA9PT0gImZsb2F0MzIiKSwKICAgICAgICAgICAgICAieW91IG11c3QgZW5hYmxlIHRoZSBPRVNfdGV4dHVyZV9mbG9hdCBleHRlbnNpb24gaW4gb3JkZXIgdG8gdXNlIGZsb2F0aW5nIHBvaW50IHRleHR1cmVzLiIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICBleHRlbnNpb25zLm9lc190ZXh0dXJlX2hhbGZfZmxvYXQgfHwgISh0eXBlID09PSAiaGFsZiBmbG9hdCIgfHwgdHlwZSA9PT0gImZsb2F0MTYiKSwKICAgICAgICAgICAgICAieW91IG11c3QgZW5hYmxlIHRoZSBPRVNfdGV4dHVyZV9oYWxmX2Zsb2F0IGV4dGVuc2lvbiBpbiBvcmRlciB0byB1c2UgMTYtYml0IGZsb2F0aW5nIHBvaW50IHRleHR1cmVzLiIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICBleHRlbnNpb25zLndlYmdsX2RlcHRoX3RleHR1cmUgfHwgISh0eXBlID09PSAidWludDE2IiB8fCB0eXBlID09PSAidWludDMyIiB8fCB0eXBlID09PSAiZGVwdGggc3RlbmNpbCIpLAogICAgICAgICAgICAgICJ5b3UgbXVzdCBlbmFibGUgdGhlIFdFQkdMX2RlcHRoX3RleHR1cmUgZXh0ZW5zaW9uIGluIG9yZGVyIHRvIHVzZSBkZXB0aC9zdGVuY2lsIHRleHR1cmVzLiIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIoCiAgICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgICB0ZXh0dXJlVHlwZXMsCiAgICAgICAgICAgICAgImludmFsaWQgdGV4dHVyZSB0eXBlIgogICAgICAgICAgICApOwogICAgICAgICAgICBmbGFncy50eXBlID0gdGV4dHVyZVR5cGVzW3R5cGVdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHcgPSBmbGFncy53aWR0aDsKICAgICAgICAgIHZhciBoID0gZmxhZ3MuaGVpZ2h0OwogICAgICAgICAgdmFyIGMgPSBmbGFncy5jaGFubmVsczsKICAgICAgICAgIHZhciBoYXNDaGFubmVscyA9IGZhbHNlOwogICAgICAgICAgaWYgKCJzaGFwZSIgaW4gb3B0aW9ucykgewogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIEFycmF5LmlzQXJyYXkob3B0aW9ucy5zaGFwZSkgJiYgb3B0aW9ucy5zaGFwZS5sZW5ndGggPj0gMiwKICAgICAgICAgICAgICAic2hhcGUgbXVzdCBiZSBhbiBhcnJheSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdyA9IG9wdGlvbnMuc2hhcGVbMF07CiAgICAgICAgICAgIGggPSBvcHRpb25zLnNoYXBlWzFdOwogICAgICAgICAgICBpZiAob3B0aW9ucy5zaGFwZS5sZW5ndGggPT09IDMpIHsKICAgICAgICAgICAgICBjID0gb3B0aW9ucy5zaGFwZVsyXTsKICAgICAgICAgICAgICBjaGVjayQxKGMgPiAwICYmIGMgPD0gNCwgImludmFsaWQgbnVtYmVyIG9mIGNoYW5uZWxzIik7CiAgICAgICAgICAgICAgaGFzQ2hhbm5lbHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoZWNrJDEodyA+PSAwICYmIHcgPD0gbGltaXRzLm1heFRleHR1cmVTaXplLCAiaW52YWxpZCB3aWR0aCIpOwogICAgICAgICAgICBjaGVjayQxKGggPj0gMCAmJiBoIDw9IGxpbWl0cy5tYXhUZXh0dXJlU2l6ZSwgImludmFsaWQgaGVpZ2h0Iik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoInJhZGl1cyIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgIHcgPSBoID0gb3B0aW9ucy5yYWRpdXM7CiAgICAgICAgICAgICAgY2hlY2skMSh3ID49IDAgJiYgdyA8PSBsaW1pdHMubWF4VGV4dHVyZVNpemUsICJpbnZhbGlkIHJhZGl1cyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgid2lkdGgiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICB3ID0gb3B0aW9ucy53aWR0aDsKICAgICAgICAgICAgICBjaGVjayQxKHcgPj0gMCAmJiB3IDw9IGxpbWl0cy5tYXhUZXh0dXJlU2l6ZSwgImludmFsaWQgd2lkdGgiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoImhlaWdodCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgIGggPSBvcHRpb25zLmhlaWdodDsKICAgICAgICAgICAgICBjaGVjayQxKGggPj0gMCAmJiBoIDw9IGxpbWl0cy5tYXhUZXh0dXJlU2l6ZSwgImludmFsaWQgaGVpZ2h0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCJjaGFubmVscyIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgIGMgPSBvcHRpb25zLmNoYW5uZWxzOwogICAgICAgICAgICAgIGNoZWNrJDEoYyA+IDAgJiYgYyA8PSA0LCAiaW52YWxpZCBudW1iZXIgb2YgY2hhbm5lbHMiKTsKICAgICAgICAgICAgICBoYXNDaGFubmVscyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZsYWdzLndpZHRoID0gdyB8IDA7CiAgICAgICAgICBmbGFncy5oZWlnaHQgPSBoIHwgMDsKICAgICAgICAgIGZsYWdzLmNoYW5uZWxzID0gYyB8IDA7CiAgICAgICAgICB2YXIgaGFzRm9ybWF0ID0gZmFsc2U7CiAgICAgICAgICBpZiAoImZvcm1hdCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICB2YXIgZm9ybWF0U3RyID0gb3B0aW9ucy5mb3JtYXQ7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZXh0ZW5zaW9ucy53ZWJnbF9kZXB0aF90ZXh0dXJlIHx8ICEoZm9ybWF0U3RyID09PSAiZGVwdGgiIHx8IGZvcm1hdFN0ciA9PT0gImRlcHRoIHN0ZW5jaWwiKSwKICAgICAgICAgICAgICAieW91IG11c3QgZW5hYmxlIHRoZSBXRUJHTF9kZXB0aF90ZXh0dXJlIGV4dGVuc2lvbiBpbiBvcmRlciB0byB1c2UgZGVwdGgvc3RlbmNpbCB0ZXh0dXJlcy4iCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKAogICAgICAgICAgICAgIGZvcm1hdFN0ciwKICAgICAgICAgICAgICB0ZXh0dXJlRm9ybWF0cywKICAgICAgICAgICAgICAiaW52YWxpZCB0ZXh0dXJlIGZvcm1hdCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGludGVybmFsZm9ybWF0ID0gZmxhZ3MuaW50ZXJuYWxmb3JtYXQgPSB0ZXh0dXJlRm9ybWF0c1tmb3JtYXRTdHJdOwogICAgICAgICAgICBmbGFncy5mb3JtYXQgPSBjb2xvckZvcm1hdHNbaW50ZXJuYWxmb3JtYXRdOwogICAgICAgICAgICBpZiAoZm9ybWF0U3RyIGluIHRleHR1cmVUeXBlcykgewogICAgICAgICAgICAgIGlmICghKCJ0eXBlIiBpbiBvcHRpb25zKSkgewogICAgICAgICAgICAgICAgZmxhZ3MudHlwZSA9IHRleHR1cmVUeXBlc1tmb3JtYXRTdHJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm9ybWF0U3RyIGluIGNvbXByZXNzZWRUZXh0dXJlRm9ybWF0cykgewogICAgICAgICAgICAgIGZsYWdzLmNvbXByZXNzZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhhc0Zvcm1hdCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWhhc0NoYW5uZWxzICYmIGhhc0Zvcm1hdCkgewogICAgICAgICAgICBmbGFncy5jaGFubmVscyA9IEZPUk1BVF9DSEFOTkVMU1tmbGFncy5mb3JtYXRdOwogICAgICAgICAgfSBlbHNlIGlmIChoYXNDaGFubmVscyAmJiAhaGFzRm9ybWF0KSB7CiAgICAgICAgICAgIGlmIChmbGFncy5jaGFubmVscyAhPT0gQ0hBTk5FTFNfRk9STUFUW2ZsYWdzLmZvcm1hdF0pIHsKICAgICAgICAgICAgICBmbGFncy5mb3JtYXQgPSBmbGFncy5pbnRlcm5hbGZvcm1hdCA9IENIQU5ORUxTX0ZPUk1BVFtmbGFncy5jaGFubmVsc107CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaGFzRm9ybWF0ICYmIGhhc0NoYW5uZWxzKSB7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZmxhZ3MuY2hhbm5lbHMgPT09IEZPUk1BVF9DSEFOTkVMU1tmbGFncy5mb3JtYXRdLAogICAgICAgICAgICAgICJudW1iZXIgb2YgY2hhbm5lbHMgaW5jb25zaXN0ZW50IHdpdGggc3BlY2lmaWVkIGZvcm1hdCIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RmxhZ3MoZmxhZ3MpIHsKICAgICAgICAgIGdsLnBpeGVsU3RvcmVpKEdMX1VOUEFDS19GTElQX1lfV0VCR0wsIGZsYWdzLmZsaXBZKTsKICAgICAgICAgIGdsLnBpeGVsU3RvcmVpKEdMX1VOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgZmxhZ3MucHJlbXVsdGlwbHlBbHBoYSk7CiAgICAgICAgICBnbC5waXhlbFN0b3JlaShHTF9VTlBBQ0tfQ09MT1JTUEFDRV9DT05WRVJTSU9OX1dFQkdMLCBmbGFncy5jb2xvclNwYWNlKTsKICAgICAgICAgIGdsLnBpeGVsU3RvcmVpKEdMX1VOUEFDS19BTElHTk1FTlQsIGZsYWdzLnVucGFja0FsaWdubWVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFRleEltYWdlKCkgewogICAgICAgICAgVGV4RmxhZ3MuY2FsbCh0aGlzKTsKICAgICAgICAgIHRoaXMueE9mZnNldCA9IDA7CiAgICAgICAgICB0aGlzLnlPZmZzZXQgPSAwOwogICAgICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgICAgIHRoaXMubmVlZHNGcmVlID0gZmFsc2U7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOwogICAgICAgICAgdGhpcy5uZWVkc0NvcHkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VJbWFnZShpbWFnZSwgb3B0aW9ucykgewogICAgICAgICAgdmFyIGRhdGEgPSBudWxsOwogICAgICAgICAgaWYgKGlzUGl4ZWxEYXRhKG9wdGlvbnMpKSB7CiAgICAgICAgICAgIGRhdGEgPSBvcHRpb25zOwogICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zKSB7CiAgICAgICAgICAgIGNoZWNrJDEudHlwZShvcHRpb25zLCAib2JqZWN0IiwgImludmFsaWQgcGl4ZWwgZGF0YSB0eXBlIik7CiAgICAgICAgICAgIHBhcnNlRmxhZ3MoaW1hZ2UsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoIngiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICBpbWFnZS54T2Zmc2V0ID0gb3B0aW9ucy54IHwgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoInkiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICBpbWFnZS55T2Zmc2V0ID0gb3B0aW9ucy55IHwgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNQaXhlbERhdGEob3B0aW9ucy5kYXRhKSkgewogICAgICAgICAgICAgIGRhdGEgPSBvcHRpb25zLmRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICFpbWFnZS5jb21wcmVzc2VkIHx8IGRhdGEgaW5zdGFuY2VvZiBVaW50OEFycmF5LAogICAgICAgICAgICAiY29tcHJlc3NlZCB0ZXh0dXJlIGRhdGEgbXVzdCBiZSBzdG9yZWQgaW4gYSB1aW50OGFycmF5IgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChvcHRpb25zLmNvcHkpIHsKICAgICAgICAgICAgY2hlY2skMSghZGF0YSwgImNhbiBub3Qgc3BlY2lmeSBjb3B5IGFuZCBkYXRhIGZpZWxkIGZvciB0aGUgc2FtZSB0ZXh0dXJlIik7CiAgICAgICAgICAgIHZhciB2aWV3VyA9IGNvbnRleHRTdGF0ZS52aWV3cG9ydFdpZHRoOwogICAgICAgICAgICB2YXIgdmlld0ggPSBjb250ZXh0U3RhdGUudmlld3BvcnRIZWlnaHQ7CiAgICAgICAgICAgIGltYWdlLndpZHRoID0gaW1hZ2Uud2lkdGggfHwgdmlld1cgLSBpbWFnZS54T2Zmc2V0OwogICAgICAgICAgICBpbWFnZS5oZWlnaHQgPSBpbWFnZS5oZWlnaHQgfHwgdmlld0ggLSBpbWFnZS55T2Zmc2V0OwogICAgICAgICAgICBpbWFnZS5uZWVkc0NvcHkgPSB0cnVlOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIGltYWdlLnhPZmZzZXQgPj0gMCAmJiBpbWFnZS54T2Zmc2V0IDwgdmlld1cgJiYgaW1hZ2UueU9mZnNldCA+PSAwICYmIGltYWdlLnlPZmZzZXQgPCB2aWV3SCAmJiBpbWFnZS53aWR0aCA+IDAgJiYgaW1hZ2Uud2lkdGggPD0gdmlld1cgJiYgaW1hZ2UuaGVpZ2h0ID4gMCAmJiBpbWFnZS5oZWlnaHQgPD0gdmlld0gsCiAgICAgICAgICAgICAgImNvcHkgdGV4dHVyZSByZWFkIG91dCBvZiBib3VuZHMiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFkYXRhKSB7CiAgICAgICAgICAgIGltYWdlLndpZHRoID0gaW1hZ2Uud2lkdGggfHwgMTsKICAgICAgICAgICAgaW1hZ2UuaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0IHx8IDE7CiAgICAgICAgICAgIGltYWdlLmNoYW5uZWxzID0gaW1hZ2UuY2hhbm5lbHMgfHwgNDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUeXBlZEFycmF5MihkYXRhKSkgewogICAgICAgICAgICBpbWFnZS5jaGFubmVscyA9IGltYWdlLmNoYW5uZWxzIHx8IDQ7CiAgICAgICAgICAgIGltYWdlLmRhdGEgPSBkYXRhOwogICAgICAgICAgICBpZiAoISgidHlwZSIgaW4gb3B0aW9ucykgJiYgaW1hZ2UudHlwZSA9PT0gR0xfVU5TSUdORURfQllURSQ1KSB7CiAgICAgICAgICAgICAgaW1hZ2UudHlwZSA9IHR5cGVkQXJyYXlDb2RlJDEoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNOdW1lcmljQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgaW1hZ2UuY2hhbm5lbHMgPSBpbWFnZS5jaGFubmVscyB8fCA0OwogICAgICAgICAgICBjb252ZXJ0RGF0YShpbWFnZSwgZGF0YSk7CiAgICAgICAgICAgIGltYWdlLmFsaWdubWVudCA9IDE7CiAgICAgICAgICAgIGltYWdlLm5lZWRzRnJlZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzTkRBcnJheUxpa2UoZGF0YSkpIHsKICAgICAgICAgICAgdmFyIGFycmF5MiA9IGRhdGEuZGF0YTsKICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGFycmF5MikgJiYgaW1hZ2UudHlwZSA9PT0gR0xfVU5TSUdORURfQllURSQ1KSB7CiAgICAgICAgICAgICAgaW1hZ2UudHlwZSA9IHR5cGVkQXJyYXlDb2RlJDEoYXJyYXkyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2hhcGUgPSBkYXRhLnNoYXBlOwogICAgICAgICAgICB2YXIgc3RyaWRlID0gZGF0YS5zdHJpZGU7CiAgICAgICAgICAgIHZhciBzaGFwZVgsIHNoYXBlWSwgc2hhcGVDLCBzdHJpZGVYLCBzdHJpZGVZLCBzdHJpZGVDOwogICAgICAgICAgICBpZiAoc2hhcGUubGVuZ3RoID09PSAzKSB7CiAgICAgICAgICAgICAgc2hhcGVDID0gc2hhcGVbMl07CiAgICAgICAgICAgICAgc3RyaWRlQyA9IHN0cmlkZVsyXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGVjayQxKHNoYXBlLmxlbmd0aCA9PT0gMiwgImludmFsaWQgbmRhcnJheSBwaXhlbCBkYXRhLCBtdXN0IGJlIDIgb3IgM0QiKTsKICAgICAgICAgICAgICBzaGFwZUMgPSAxOwogICAgICAgICAgICAgIHN0cmlkZUMgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoYXBlWCA9IHNoYXBlWzBdOwogICAgICAgICAgICBzaGFwZVkgPSBzaGFwZVsxXTsKICAgICAgICAgICAgc3RyaWRlWCA9IHN0cmlkZVswXTsKICAgICAgICAgICAgc3RyaWRlWSA9IHN0cmlkZVsxXTsKICAgICAgICAgICAgaW1hZ2UuYWxpZ25tZW50ID0gMTsKICAgICAgICAgICAgaW1hZ2Uud2lkdGggPSBzaGFwZVg7CiAgICAgICAgICAgIGltYWdlLmhlaWdodCA9IHNoYXBlWTsKICAgICAgICAgICAgaW1hZ2UuY2hhbm5lbHMgPSBzaGFwZUM7CiAgICAgICAgICAgIGltYWdlLmZvcm1hdCA9IGltYWdlLmludGVybmFsZm9ybWF0ID0gQ0hBTk5FTFNfRk9STUFUW3NoYXBlQ107CiAgICAgICAgICAgIGltYWdlLm5lZWRzRnJlZSA9IHRydWU7CiAgICAgICAgICAgIHRyYW5zcG9zZURhdGEoaW1hZ2UsIGFycmF5Miwgc3RyaWRlWCwgc3RyaWRlWSwgc3RyaWRlQywgZGF0YS5vZmZzZXQpOwogICAgICAgICAgfSBlbHNlIGlmIChpc0NhbnZhc0VsZW1lbnQoZGF0YSkgfHwgaXNPZmZzY3JlZW5DYW52YXMoZGF0YSkgfHwgaXNDb250ZXh0MkQoZGF0YSkpIHsKICAgICAgICAgICAgaWYgKGlzQ2FudmFzRWxlbWVudChkYXRhKSB8fCBpc09mZnNjcmVlbkNhbnZhcyhkYXRhKSkgewogICAgICAgICAgICAgIGltYWdlLmVsZW1lbnQgPSBkYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGltYWdlLmVsZW1lbnQgPSBkYXRhLmNhbnZhczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbWFnZS53aWR0aCA9IGltYWdlLmVsZW1lbnQud2lkdGg7CiAgICAgICAgICAgIGltYWdlLmhlaWdodCA9IGltYWdlLmVsZW1lbnQuaGVpZ2h0OwogICAgICAgICAgICBpbWFnZS5jaGFubmVscyA9IDQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzQml0bWFwKGRhdGEpKSB7CiAgICAgICAgICAgIGltYWdlLmVsZW1lbnQgPSBkYXRhOwogICAgICAgICAgICBpbWFnZS53aWR0aCA9IGRhdGEud2lkdGg7CiAgICAgICAgICAgIGltYWdlLmhlaWdodCA9IGRhdGEuaGVpZ2h0OwogICAgICAgICAgICBpbWFnZS5jaGFubmVscyA9IDQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzSW1hZ2VFbGVtZW50KGRhdGEpKSB7CiAgICAgICAgICAgIGltYWdlLmVsZW1lbnQgPSBkYXRhOwogICAgICAgICAgICBpbWFnZS53aWR0aCA9IGRhdGEubmF0dXJhbFdpZHRoOwogICAgICAgICAgICBpbWFnZS5oZWlnaHQgPSBkYXRhLm5hdHVyYWxIZWlnaHQ7CiAgICAgICAgICAgIGltYWdlLmNoYW5uZWxzID0gNDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNWaWRlb0VsZW1lbnQoZGF0YSkpIHsKICAgICAgICAgICAgaW1hZ2UuZWxlbWVudCA9IGRhdGE7CiAgICAgICAgICAgIGltYWdlLndpZHRoID0gZGF0YS52aWRlb1dpZHRoOwogICAgICAgICAgICBpbWFnZS5oZWlnaHQgPSBkYXRhLnZpZGVvSGVpZ2h0OwogICAgICAgICAgICBpbWFnZS5jaGFubmVscyA9IDQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzUmVjdEFycmF5KGRhdGEpKSB7CiAgICAgICAgICAgIHZhciB3ID0gaW1hZ2Uud2lkdGggfHwgZGF0YVswXS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBoID0gaW1hZ2UuaGVpZ2h0IHx8IGRhdGEubGVuZ3RoOwogICAgICAgICAgICB2YXIgYyA9IGltYWdlLmNoYW5uZWxzOwogICAgICAgICAgICBpZiAoaXNBcnJheUxpa2UoZGF0YVswXVswXSkpIHsKICAgICAgICAgICAgICBjID0gYyB8fCBkYXRhWzBdWzBdLmxlbmd0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjID0gYyB8fCAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcnJheVNoYXBlMiA9IGZsYXR0ZW5VdGlscy5zaGFwZShkYXRhKTsKICAgICAgICAgICAgdmFyIG4gPSAxOwogICAgICAgICAgICBmb3IgKHZhciBkZCA9IDA7IGRkIDwgYXJyYXlTaGFwZTIubGVuZ3RoOyArK2RkKSB7CiAgICAgICAgICAgICAgbiAqPSBhcnJheVNoYXBlMltkZF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFsbG9jRGF0YSA9IHByZUNvbnZlcnQoaW1hZ2UsIG4pOwogICAgICAgICAgICBmbGF0dGVuVXRpbHMuZmxhdHRlbihkYXRhLCBhcnJheVNoYXBlMiwgIiIsIGFsbG9jRGF0YSk7CiAgICAgICAgICAgIHBvc3RDb252ZXJ0KGltYWdlLCBhbGxvY0RhdGEpOwogICAgICAgICAgICBpbWFnZS5hbGlnbm1lbnQgPSAxOwogICAgICAgICAgICBpbWFnZS53aWR0aCA9IHc7CiAgICAgICAgICAgIGltYWdlLmhlaWdodCA9IGg7CiAgICAgICAgICAgIGltYWdlLmNoYW5uZWxzID0gYzsKICAgICAgICAgICAgaW1hZ2UuZm9ybWF0ID0gaW1hZ2UuaW50ZXJuYWxmb3JtYXQgPSBDSEFOTkVMU19GT1JNQVRbY107CiAgICAgICAgICAgIGltYWdlLm5lZWRzRnJlZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW1hZ2UudHlwZSA9PT0gR0xfRkxPQVQkNCkgewogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIGxpbWl0cy5leHRlbnNpb25zLmluZGV4T2YoIm9lc190ZXh0dXJlX2Zsb2F0IikgPj0gMCwKICAgICAgICAgICAgICAib2VzX3RleHR1cmVfZmxvYXQgZXh0ZW5zaW9uIG5vdCBlbmFibGVkIgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIGlmIChpbWFnZS50eXBlID09PSBHTF9IQUxGX0ZMT0FUX09FUyQxKSB7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgbGltaXRzLmV4dGVuc2lvbnMuaW5kZXhPZigib2VzX3RleHR1cmVfaGFsZl9mbG9hdCIpID49IDAsCiAgICAgICAgICAgICAgIm9lc190ZXh0dXJlX2hhbGZfZmxvYXQgZXh0ZW5zaW9uIG5vdCBlbmFibGVkIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJbWFnZShpbmZvLCB0YXJnZXQsIG1pcGxldmVsKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGluZm8uZWxlbWVudDsKICAgICAgICAgIHZhciBkYXRhID0gaW5mby5kYXRhOwogICAgICAgICAgdmFyIGludGVybmFsZm9ybWF0ID0gaW5mby5pbnRlcm5hbGZvcm1hdDsKICAgICAgICAgIHZhciBmb3JtYXQyID0gaW5mby5mb3JtYXQ7CiAgICAgICAgICB2YXIgdHlwZSA9IGluZm8udHlwZTsKICAgICAgICAgIHZhciB3aWR0aCA9IGluZm8ud2lkdGg7CiAgICAgICAgICB2YXIgaGVpZ2h0ID0gaW5mby5oZWlnaHQ7CiAgICAgICAgICBzZXRGbGFncyhpbmZvKTsKICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgIGdsLnRleEltYWdlMkQodGFyZ2V0LCBtaXBsZXZlbCwgZm9ybWF0MiwgZm9ybWF0MiwgdHlwZSwgZWxlbWVudCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGluZm8uY29tcHJlc3NlZCkgewogICAgICAgICAgICBnbC5jb21wcmVzc2VkVGV4SW1hZ2UyRCh0YXJnZXQsIG1pcGxldmVsLCBpbnRlcm5hbGZvcm1hdCwgd2lkdGgsIGhlaWdodCwgMCwgZGF0YSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGluZm8ubmVlZHNDb3B5KSB7CiAgICAgICAgICAgIHJlZ2xQb2xsKCk7CiAgICAgICAgICAgIGdsLmNvcHlUZXhJbWFnZTJEKAogICAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgICBtaXBsZXZlbCwKICAgICAgICAgICAgICBmb3JtYXQyLAogICAgICAgICAgICAgIGluZm8ueE9mZnNldCwKICAgICAgICAgICAgICBpbmZvLnlPZmZzZXQsCiAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIDAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdsLnRleEltYWdlMkQodGFyZ2V0LCBtaXBsZXZlbCwgZm9ybWF0Miwgd2lkdGgsIGhlaWdodCwgMCwgZm9ybWF0MiwgdHlwZSwgZGF0YSB8fCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U3ViSW1hZ2UoaW5mbywgdGFyZ2V0LCB4LCB5LCBtaXBsZXZlbCkgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSBpbmZvLmVsZW1lbnQ7CiAgICAgICAgICB2YXIgZGF0YSA9IGluZm8uZGF0YTsKICAgICAgICAgIHZhciBpbnRlcm5hbGZvcm1hdCA9IGluZm8uaW50ZXJuYWxmb3JtYXQ7CiAgICAgICAgICB2YXIgZm9ybWF0MiA9IGluZm8uZm9ybWF0OwogICAgICAgICAgdmFyIHR5cGUgPSBpbmZvLnR5cGU7CiAgICAgICAgICB2YXIgd2lkdGggPSBpbmZvLndpZHRoOwogICAgICAgICAgdmFyIGhlaWdodCA9IGluZm8uaGVpZ2h0OwogICAgICAgICAgc2V0RmxhZ3MoaW5mbyk7CiAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICBnbC50ZXhTdWJJbWFnZTJEKAogICAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgICBtaXBsZXZlbCwKICAgICAgICAgICAgICB4LAogICAgICAgICAgICAgIHksCiAgICAgICAgICAgICAgZm9ybWF0MiwKICAgICAgICAgICAgICB0eXBlLAogICAgICAgICAgICAgIGVsZW1lbnQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaW5mby5jb21wcmVzc2VkKSB7CiAgICAgICAgICAgIGdsLmNvbXByZXNzZWRUZXhTdWJJbWFnZTJEKAogICAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgICBtaXBsZXZlbCwKICAgICAgICAgICAgICB4LAogICAgICAgICAgICAgIHksCiAgICAgICAgICAgICAgaW50ZXJuYWxmb3JtYXQsCiAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGRhdGEKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaW5mby5uZWVkc0NvcHkpIHsKICAgICAgICAgICAgcmVnbFBvbGwoKTsKICAgICAgICAgICAgZ2wuY29weVRleFN1YkltYWdlMkQoCiAgICAgICAgICAgICAgdGFyZ2V0LAogICAgICAgICAgICAgIG1pcGxldmVsLAogICAgICAgICAgICAgIHgsCiAgICAgICAgICAgICAgeSwKICAgICAgICAgICAgICBpbmZvLnhPZmZzZXQsCiAgICAgICAgICAgICAgaW5mby55T2Zmc2V0LAogICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgIGhlaWdodAogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2wudGV4U3ViSW1hZ2UyRCgKICAgICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgICAgbWlwbGV2ZWwsCiAgICAgICAgICAgICAgeCwKICAgICAgICAgICAgICB5LAogICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgICBmb3JtYXQyLAogICAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaW1hZ2VQb29sID0gW107CiAgICAgICAgZnVuY3Rpb24gYWxsb2NJbWFnZSgpIHsKICAgICAgICAgIHJldHVybiBpbWFnZVBvb2wucG9wKCkgfHwgbmV3IFRleEltYWdlKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZyZWVJbWFnZShpbWFnZSkgewogICAgICAgICAgaWYgKGltYWdlLm5lZWRzRnJlZSkgewogICAgICAgICAgICBwb29sLmZyZWVUeXBlKGltYWdlLmRhdGEpOwogICAgICAgICAgfQogICAgICAgICAgVGV4SW1hZ2UuY2FsbChpbWFnZSk7CiAgICAgICAgICBpbWFnZVBvb2wucHVzaChpbWFnZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIE1pcE1hcCgpIHsKICAgICAgICAgIFRleEZsYWdzLmNhbGwodGhpcyk7CiAgICAgICAgICB0aGlzLmdlbk1pcG1hcHMgPSBmYWxzZTsKICAgICAgICAgIHRoaXMubWlwbWFwSGludCA9IEdMX0RPTlRfQ0FSRTsKICAgICAgICAgIHRoaXMubWlwbWFzayA9IDA7CiAgICAgICAgICB0aGlzLmltYWdlcyA9IEFycmF5KDE2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VNaXBNYXBGcm9tU2hhcGUobWlwbWFwLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICB2YXIgaW1nID0gbWlwbWFwLmltYWdlc1swXSA9IGFsbG9jSW1hZ2UoKTsKICAgICAgICAgIG1pcG1hcC5taXBtYXNrID0gMTsKICAgICAgICAgIGltZy53aWR0aCA9IG1pcG1hcC53aWR0aCA9IHdpZHRoOwogICAgICAgICAgaW1nLmhlaWdodCA9IG1pcG1hcC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBpbWcuY2hhbm5lbHMgPSBtaXBtYXAuY2hhbm5lbHMgPSA0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZU1pcE1hcEZyb21PYmplY3QobWlwbWFwLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgaW1nRGF0YSA9IG51bGw7CiAgICAgICAgICBpZiAoaXNQaXhlbERhdGEob3B0aW9ucykpIHsKICAgICAgICAgICAgaW1nRGF0YSA9IG1pcG1hcC5pbWFnZXNbMF0gPSBhbGxvY0ltYWdlKCk7CiAgICAgICAgICAgIGNvcHlGbGFncyhpbWdEYXRhLCBtaXBtYXApOwogICAgICAgICAgICBwYXJzZUltYWdlKGltZ0RhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICBtaXBtYXAubWlwbWFzayA9IDE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYXJzZUZsYWdzKG1pcG1hcCwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9wdGlvbnMubWlwbWFwKSkgewogICAgICAgICAgICAgIHZhciBtaXBEYXRhID0gb3B0aW9ucy5taXBtYXA7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtaXBEYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBpbWdEYXRhID0gbWlwbWFwLmltYWdlc1tpXSA9IGFsbG9jSW1hZ2UoKTsKICAgICAgICAgICAgICAgIGNvcHlGbGFncyhpbWdEYXRhLCBtaXBtYXApOwogICAgICAgICAgICAgICAgaW1nRGF0YS53aWR0aCA+Pj0gaTsKICAgICAgICAgICAgICAgIGltZ0RhdGEuaGVpZ2h0ID4+PSBpOwogICAgICAgICAgICAgICAgcGFyc2VJbWFnZShpbWdEYXRhLCBtaXBEYXRhW2ldKTsKICAgICAgICAgICAgICAgIG1pcG1hcC5taXBtYXNrIHw9IDEgPDwgaTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaW1nRGF0YSA9IG1pcG1hcC5pbWFnZXNbMF0gPSBhbGxvY0ltYWdlKCk7CiAgICAgICAgICAgICAgY29weUZsYWdzKGltZ0RhdGEsIG1pcG1hcCk7CiAgICAgICAgICAgICAgcGFyc2VJbWFnZShpbWdEYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICBtaXBtYXAubWlwbWFzayA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvcHlGbGFncyhtaXBtYXAsIG1pcG1hcC5pbWFnZXNbMF0pOwogICAgICAgICAgaWYgKG1pcG1hcC5jb21wcmVzc2VkICYmIChtaXBtYXAuaW50ZXJuYWxmb3JtYXQgPT09IEdMX0NPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQgfHwgbWlwbWFwLmludGVybmFsZm9ybWF0ID09PSBHTF9DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQxX0VYVCB8fCBtaXBtYXAuaW50ZXJuYWxmb3JtYXQgPT09IEdMX0NPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDNfRVhUIHx8IG1pcG1hcC5pbnRlcm5hbGZvcm1hdCA9PT0gR0xfQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQpKSB7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgbWlwbWFwLndpZHRoICUgNCA9PT0gMCAmJiBtaXBtYXAuaGVpZ2h0ICUgNCA9PT0gMCwKICAgICAgICAgICAgICAiZm9yIGNvbXByZXNzZWQgdGV4dHVyZSBmb3JtYXRzLCBtaXBtYXAgbGV2ZWwgMCBtdXN0IGhhdmUgd2lkdGggYW5kIGhlaWdodCB0aGF0IGFyZSBhIG11bHRpcGxlIG9mIDQiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldE1pcE1hcChtaXBtYXAsIHRhcmdldCkgewogICAgICAgICAgdmFyIGltYWdlcyA9IG1pcG1hcC5pbWFnZXM7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoIWltYWdlc1tpXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJbWFnZShpbWFnZXNbaV0sIHRhcmdldCwgaSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBtaXBQb29sID0gW107CiAgICAgICAgZnVuY3Rpb24gYWxsb2NNaXBNYXAoKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gbWlwUG9vbC5wb3AoKSB8fCBuZXcgTWlwTWFwKCk7CiAgICAgICAgICBUZXhGbGFncy5jYWxsKHJlc3VsdCk7CiAgICAgICAgICByZXN1bHQubWlwbWFzayA9IDA7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDE2OyArK2kpIHsKICAgICAgICAgICAgcmVzdWx0LmltYWdlc1tpXSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmcmVlTWlwTWFwKG1pcG1hcCkgewogICAgICAgICAgdmFyIGltYWdlcyA9IG1pcG1hcC5pbWFnZXM7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGltYWdlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoaW1hZ2VzW2ldKSB7CiAgICAgICAgICAgICAgZnJlZUltYWdlKGltYWdlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW1hZ2VzW2ldID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIG1pcFBvb2wucHVzaChtaXBtYXApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBUZXhJbmZvKCkgewogICAgICAgICAgdGhpcy5taW5GaWx0ZXIgPSBHTF9ORUFSRVNUJDE7CiAgICAgICAgICB0aGlzLm1hZ0ZpbHRlciA9IEdMX05FQVJFU1QkMTsKICAgICAgICAgIHRoaXMud3JhcFMgPSBHTF9DTEFNUF9UT19FREdFJDE7CiAgICAgICAgICB0aGlzLndyYXBUID0gR0xfQ0xBTVBfVE9fRURHRSQxOwogICAgICAgICAgdGhpcy5hbmlzb3Ryb3BpYyA9IDE7CiAgICAgICAgICB0aGlzLmdlbk1pcG1hcHMgPSBmYWxzZTsKICAgICAgICAgIHRoaXMubWlwbWFwSGludCA9IEdMX0RPTlRfQ0FSRTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VUZXhJbmZvKGluZm8sIG9wdGlvbnMpIHsKICAgICAgICAgIGlmICgibWluIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBtaW5GaWx0ZXIgPSBvcHRpb25zLm1pbjsKICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIobWluRmlsdGVyLCBtaW5GaWx0ZXJzKTsKICAgICAgICAgICAgaW5mby5taW5GaWx0ZXIgPSBtaW5GaWx0ZXJzW21pbkZpbHRlcl07CiAgICAgICAgICAgIGlmIChNSVBNQVBfRklMVEVSUy5pbmRleE9mKGluZm8ubWluRmlsdGVyKSA+PSAwICYmICEoImZhY2VzIiBpbiBvcHRpb25zKSkgewogICAgICAgICAgICAgIGluZm8uZ2VuTWlwbWFwcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgibWFnIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBtYWdGaWx0ZXIgPSBvcHRpb25zLm1hZzsKICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIobWFnRmlsdGVyLCBtYWdGaWx0ZXJzKTsKICAgICAgICAgICAgaW5mby5tYWdGaWx0ZXIgPSBtYWdGaWx0ZXJzW21hZ0ZpbHRlcl07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd3JhcFMgPSBpbmZvLndyYXBTOwogICAgICAgICAgdmFyIHdyYXBUID0gaW5mby53cmFwVDsKICAgICAgICAgIGlmICgid3JhcCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICB2YXIgd3JhcDIgPSBvcHRpb25zLndyYXA7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd3JhcDIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIod3JhcDIsIHdyYXBNb2Rlcyk7CiAgICAgICAgICAgICAgd3JhcFMgPSB3cmFwVCA9IHdyYXBNb2Rlc1t3cmFwMl07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh3cmFwMikpIHsKICAgICAgICAgICAgICBjaGVjayQxLnBhcmFtZXRlcih3cmFwMlswXSwgd3JhcE1vZGVzKTsKICAgICAgICAgICAgICBjaGVjayQxLnBhcmFtZXRlcih3cmFwMlsxXSwgd3JhcE1vZGVzKTsKICAgICAgICAgICAgICB3cmFwUyA9IHdyYXBNb2Rlc1t3cmFwMlswXV07CiAgICAgICAgICAgICAgd3JhcFQgPSB3cmFwTW9kZXNbd3JhcDJbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIndyYXBTIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgdmFyIG9wdFdyYXBTID0gb3B0aW9ucy53cmFwUzsKICAgICAgICAgICAgICBjaGVjayQxLnBhcmFtZXRlcihvcHRXcmFwUywgd3JhcE1vZGVzKTsKICAgICAgICAgICAgICB3cmFwUyA9IHdyYXBNb2Rlc1tvcHRXcmFwU107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCJ3cmFwVCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgIHZhciBvcHRXcmFwVCA9IG9wdGlvbnMud3JhcFQ7CiAgICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIob3B0V3JhcFQsIHdyYXBNb2Rlcyk7CiAgICAgICAgICAgICAgd3JhcFQgPSB3cmFwTW9kZXNbb3B0V3JhcFRdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpbmZvLndyYXBTID0gd3JhcFM7CiAgICAgICAgICBpbmZvLndyYXBUID0gd3JhcFQ7CiAgICAgICAgICBpZiAoImFuaXNvdHJvcGljIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBhbmlzb3Ryb3BpYyA9IG9wdGlvbnMuYW5pc290cm9waWM7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgdHlwZW9mIGFuaXNvdHJvcGljID09PSAibnVtYmVyIiAmJiBhbmlzb3Ryb3BpYyA+PSAxICYmIGFuaXNvdHJvcGljIDw9IGxpbWl0cy5tYXhBbmlzb3Ryb3BpYywKICAgICAgICAgICAgICAiYW5pc28gc2FtcGxlcyBtdXN0IGJlIGJldHdlZW4gMSBhbmQgIgogICAgICAgICAgICApOwogICAgICAgICAgICBpbmZvLmFuaXNvdHJvcGljID0gb3B0aW9ucy5hbmlzb3Ryb3BpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgibWlwbWFwIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBoYXNNaXBNYXAgPSBmYWxzZTsKICAgICAgICAgICAgc3dpdGNoICh0eXBlb2Ygb3B0aW9ucy5taXBtYXApIHsKICAgICAgICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgICAgICAgICAgY2hlY2skMS5wYXJhbWV0ZXIoCiAgICAgICAgICAgICAgICAgIG9wdGlvbnMubWlwbWFwLAogICAgICAgICAgICAgICAgICBtaXBtYXBIaW50LAogICAgICAgICAgICAgICAgICAiaW52YWxpZCBtaXBtYXAgaGludCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpbmZvLm1pcG1hcEhpbnQgPSBtaXBtYXBIaW50W29wdGlvbnMubWlwbWFwXTsKICAgICAgICAgICAgICAgIGluZm8uZ2VuTWlwbWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgICBoYXNNaXBNYXAgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgICAgICBoYXNNaXBNYXAgPSBpbmZvLmdlbk1pcG1hcHMgPSBvcHRpb25zLm1pcG1hcDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBjaGVjayQxKEFycmF5LmlzQXJyYXkob3B0aW9ucy5taXBtYXApLCAiaW52YWxpZCBtaXBtYXAgdHlwZSIpOwogICAgICAgICAgICAgICAgaW5mby5nZW5NaXBtYXBzID0gZmFsc2U7CiAgICAgICAgICAgICAgICBoYXNNaXBNYXAgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGNoZWNrJDEucmFpc2UoImludmFsaWQgbWlwbWFwIHR5cGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzTWlwTWFwICYmICEoIm1pbiIgaW4gb3B0aW9ucykpIHsKICAgICAgICAgICAgICBpbmZvLm1pbkZpbHRlciA9IEdMX05FQVJFU1RfTUlQTUFQX05FQVJFU1QkMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRUZXhJbmZvKGluZm8sIHRhcmdldCkgewogICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0YXJnZXQsIEdMX1RFWFRVUkVfTUlOX0ZJTFRFUiwgaW5mby5taW5GaWx0ZXIpOwogICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0YXJnZXQsIEdMX1RFWFRVUkVfTUFHX0ZJTFRFUiwgaW5mby5tYWdGaWx0ZXIpOwogICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0YXJnZXQsIEdMX1RFWFRVUkVfV1JBUF9TLCBpbmZvLndyYXBTKTsKICAgICAgICAgIGdsLnRleFBhcmFtZXRlcmkodGFyZ2V0LCBHTF9URVhUVVJFX1dSQVBfVCwgaW5mby53cmFwVCk7CiAgICAgICAgICBpZiAoZXh0ZW5zaW9ucy5leHRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMpIHsKICAgICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaSh0YXJnZXQsIEdMX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhULCBpbmZvLmFuaXNvdHJvcGljKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmZvLmdlbk1pcG1hcHMpIHsKICAgICAgICAgICAgZ2wuaGludChHTF9HRU5FUkFURV9NSVBNQVBfSElOVCwgaW5mby5taXBtYXBIaW50KTsKICAgICAgICAgICAgZ2wuZ2VuZXJhdGVNaXBtYXAodGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHRleHR1cmVDb3VudCA9IDA7CiAgICAgICAgdmFyIHRleHR1cmVTZXQgPSB7fTsKICAgICAgICB2YXIgbnVtVGV4VW5pdHMgPSBsaW1pdHMubWF4VGV4dHVyZVVuaXRzOwogICAgICAgIHZhciB0ZXh0dXJlVW5pdHMgPSBBcnJheShudW1UZXhVbml0cykubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gUkVHTFRleHR1cmUodGFyZ2V0KSB7CiAgICAgICAgICBUZXhGbGFncy5jYWxsKHRoaXMpOwogICAgICAgICAgdGhpcy5taXBtYXNrID0gMDsKICAgICAgICAgIHRoaXMuaW50ZXJuYWxmb3JtYXQgPSBHTF9SR0JBJDE7CiAgICAgICAgICB0aGlzLmlkID0gdGV4dHVyZUNvdW50Kys7CiAgICAgICAgICB0aGlzLnJlZkNvdW50ID0gMTsKICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgdGhpcy50ZXh0dXJlID0gZ2wuY3JlYXRlVGV4dHVyZSgpOwogICAgICAgICAgdGhpcy51bml0ID0gLTE7CiAgICAgICAgICB0aGlzLmJpbmRDb3VudCA9IDA7CiAgICAgICAgICB0aGlzLnRleEluZm8gPSBuZXcgVGV4SW5mbygpOwogICAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7IHNpemU6IDAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVtcEJpbmQodGV4dHVyZSkgewogICAgICAgICAgZ2wuYWN0aXZlVGV4dHVyZShHTF9URVhUVVJFMCQxKTsKICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKHRleHR1cmUudGFyZ2V0LCB0ZXh0dXJlLnRleHR1cmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZW1wUmVzdG9yZSgpIHsKICAgICAgICAgIHZhciBwcmV2ID0gdGV4dHVyZVVuaXRzWzBdOwogICAgICAgICAgaWYgKHByZXYpIHsKICAgICAgICAgICAgZ2wuYmluZFRleHR1cmUocHJldi50YXJnZXQsIHByZXYudGV4dHVyZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnbC5iaW5kVGV4dHVyZShHTF9URVhUVVJFXzJEJDEsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXN0cm95KHRleHR1cmUpIHsKICAgICAgICAgIHZhciBoYW5kbGUgPSB0ZXh0dXJlLnRleHR1cmU7CiAgICAgICAgICBjaGVjayQxKGhhbmRsZSwgIm11c3Qgbm90IGRvdWJsZSBkZXN0cm95IHRleHR1cmUiKTsKICAgICAgICAgIHZhciB1bml0MiA9IHRleHR1cmUudW5pdDsKICAgICAgICAgIHZhciB0YXJnZXQgPSB0ZXh0dXJlLnRhcmdldDsKICAgICAgICAgIGlmICh1bml0MiA+PSAwKSB7CiAgICAgICAgICAgIGdsLmFjdGl2ZVRleHR1cmUoR0xfVEVYVFVSRTAkMSArIHVuaXQyKTsKICAgICAgICAgICAgZ2wuYmluZFRleHR1cmUodGFyZ2V0LCBudWxsKTsKICAgICAgICAgICAgdGV4dHVyZVVuaXRzW3VuaXQyXSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBnbC5kZWxldGVUZXh0dXJlKGhhbmRsZSk7CiAgICAgICAgICB0ZXh0dXJlLnRleHR1cmUgPSBudWxsOwogICAgICAgICAgdGV4dHVyZS5wYXJhbXMgPSBudWxsOwogICAgICAgICAgdGV4dHVyZS5waXhlbHMgPSBudWxsOwogICAgICAgICAgdGV4dHVyZS5yZWZDb3VudCA9IDA7CiAgICAgICAgICBkZWxldGUgdGV4dHVyZVNldFt0ZXh0dXJlLmlkXTsKICAgICAgICAgIHN0YXRzMi50ZXh0dXJlQ291bnQtLTsKICAgICAgICB9CiAgICAgICAgZXh0ZW5kMihSRUdMVGV4dHVyZS5wcm90b3R5cGUsIHsKICAgICAgICAgIGJpbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdGV4dHVyZSA9IHRoaXM7CiAgICAgICAgICAgIHRleHR1cmUuYmluZENvdW50ICs9IDE7CiAgICAgICAgICAgIHZhciB1bml0MiA9IHRleHR1cmUudW5pdDsKICAgICAgICAgICAgaWYgKHVuaXQyIDwgMCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtVGV4VW5pdHM7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIG90aGVyID0gdGV4dHVyZVVuaXRzW2ldOwogICAgICAgICAgICAgICAgaWYgKG90aGVyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChvdGhlci5iaW5kQ291bnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgb3RoZXIudW5pdCA9IC0xOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGV4dHVyZVVuaXRzW2ldID0gdGV4dHVyZTsKICAgICAgICAgICAgICAgIHVuaXQyID0gaTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodW5pdDIgPj0gbnVtVGV4VW5pdHMpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEucmFpc2UoImluc3VmZmljaWVudCBudW1iZXIgb2YgdGV4dHVyZSB1bml0cyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY29uZmlnLnByb2ZpbGUgJiYgc3RhdHMyLm1heFRleHR1cmVVbml0cyA8IHVuaXQyICsgMSkgewogICAgICAgICAgICAgICAgc3RhdHMyLm1heFRleHR1cmVVbml0cyA9IHVuaXQyICsgMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGV4dHVyZS51bml0ID0gdW5pdDI7CiAgICAgICAgICAgICAgZ2wuYWN0aXZlVGV4dHVyZShHTF9URVhUVVJFMCQxICsgdW5pdDIpOwogICAgICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKHRleHR1cmUudGFyZ2V0LCB0ZXh0dXJlLnRleHR1cmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1bml0MjsKICAgICAgICAgIH0sCiAgICAgICAgICB1bmJpbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmJpbmRDb3VudCAtPSAxOwogICAgICAgICAgfSwKICAgICAgICAgIGRlY1JlZjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICgtLXRoaXMucmVmQ291bnQgPD0gMCkgewogICAgICAgICAgICAgIGRlc3Ryb3kodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0dXJlMkQoYSwgYikgewogICAgICAgICAgdmFyIHRleHR1cmUgPSBuZXcgUkVHTFRleHR1cmUoR0xfVEVYVFVSRV8yRCQxKTsKICAgICAgICAgIHRleHR1cmVTZXRbdGV4dHVyZS5pZF0gPSB0ZXh0dXJlOwogICAgICAgICAgc3RhdHMyLnRleHR1cmVDb3VudCsrOwogICAgICAgICAgZnVuY3Rpb24gcmVnbFRleHR1cmUyRChhMiwgYjIpIHsKICAgICAgICAgICAgdmFyIHRleEluZm8gPSB0ZXh0dXJlLnRleEluZm87CiAgICAgICAgICAgIFRleEluZm8uY2FsbCh0ZXhJbmZvKTsKICAgICAgICAgICAgdmFyIG1pcERhdGEgPSBhbGxvY01pcE1hcCgpOwogICAgICAgICAgICBpZiAodHlwZW9mIGEyID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgYjIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21TaGFwZShtaXBEYXRhLCBhMiB8IDAsIGIyIHwgMCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnNlTWlwTWFwRnJvbVNoYXBlKG1pcERhdGEsIGEyIHwgMCwgYTIgfCAwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYTIpIHsKICAgICAgICAgICAgICBjaGVjayQxLnR5cGUoYTIsICJvYmplY3QiLCAiaW52YWxpZCBhcmd1bWVudHMgdG8gcmVnbC50ZXh0dXJlIik7CiAgICAgICAgICAgICAgcGFyc2VUZXhJbmZvKHRleEluZm8sIGEyKTsKICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QobWlwRGF0YSwgYTIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBhcnNlTWlwTWFwRnJvbVNoYXBlKG1pcERhdGEsIDEsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0ZXhJbmZvLmdlbk1pcG1hcHMpIHsKICAgICAgICAgICAgICBtaXBEYXRhLm1pcG1hc2sgPSAobWlwRGF0YS53aWR0aCA8PCAxKSAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGV4dHVyZS5taXBtYXNrID0gbWlwRGF0YS5taXBtYXNrOwogICAgICAgICAgICBjb3B5RmxhZ3ModGV4dHVyZSwgbWlwRGF0YSk7CiAgICAgICAgICAgIGNoZWNrJDEudGV4dHVyZTJEKHRleEluZm8sIG1pcERhdGEsIGxpbWl0cyk7CiAgICAgICAgICAgIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQgPSBtaXBEYXRhLmludGVybmFsZm9ybWF0OwogICAgICAgICAgICByZWdsVGV4dHVyZTJELndpZHRoID0gbWlwRGF0YS53aWR0aDsKICAgICAgICAgICAgcmVnbFRleHR1cmUyRC5oZWlnaHQgPSBtaXBEYXRhLmhlaWdodDsKICAgICAgICAgICAgdGVtcEJpbmQodGV4dHVyZSk7CiAgICAgICAgICAgIHNldE1pcE1hcChtaXBEYXRhLCBHTF9URVhUVVJFXzJEJDEpOwogICAgICAgICAgICBzZXRUZXhJbmZvKHRleEluZm8sIEdMX1RFWFRVUkVfMkQkMSk7CiAgICAgICAgICAgIHRlbXBSZXN0b3JlKCk7CiAgICAgICAgICAgIGZyZWVNaXBNYXAobWlwRGF0YSk7CiAgICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICAgIHRleHR1cmUuc3RhdHMuc2l6ZSA9IGdldFRleHR1cmVTaXplKAogICAgICAgICAgICAgICAgdGV4dHVyZS5pbnRlcm5hbGZvcm1hdCwKICAgICAgICAgICAgICAgIHRleHR1cmUudHlwZSwKICAgICAgICAgICAgICAgIG1pcERhdGEud2lkdGgsCiAgICAgICAgICAgICAgICBtaXBEYXRhLmhlaWdodCwKICAgICAgICAgICAgICAgIHRleEluZm8uZ2VuTWlwbWFwcywKICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWdsVGV4dHVyZTJELmZvcm1hdCA9IHRleHR1cmVGb3JtYXRzSW52ZXJ0W3RleHR1cmUuaW50ZXJuYWxmb3JtYXRdOwogICAgICAgICAgICByZWdsVGV4dHVyZTJELnR5cGUgPSB0ZXh0dXJlVHlwZXNJbnZlcnRbdGV4dHVyZS50eXBlXTsKICAgICAgICAgICAgcmVnbFRleHR1cmUyRC5tYWcgPSBtYWdGaWx0ZXJzSW52ZXJ0W3RleEluZm8ubWFnRmlsdGVyXTsKICAgICAgICAgICAgcmVnbFRleHR1cmUyRC5taW4gPSBtaW5GaWx0ZXJzSW52ZXJ0W3RleEluZm8ubWluRmlsdGVyXTsKICAgICAgICAgICAgcmVnbFRleHR1cmUyRC53cmFwUyA9IHdyYXBNb2Rlc0ludmVydFt0ZXhJbmZvLndyYXBTXTsKICAgICAgICAgICAgcmVnbFRleHR1cmUyRC53cmFwVCA9IHdyYXBNb2Rlc0ludmVydFt0ZXhJbmZvLndyYXBUXTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2xUZXh0dXJlMkQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdWJpbWFnZShpbWFnZSwgeF8sIHlfLCBsZXZlbF8pIHsKICAgICAgICAgICAgY2hlY2skMSghIWltYWdlLCAibXVzdCBzcGVjaWZ5IGltYWdlIGRhdGEiKTsKICAgICAgICAgICAgdmFyIHggPSB4XyB8IDA7CiAgICAgICAgICAgIHZhciB5ID0geV8gfCAwOwogICAgICAgICAgICB2YXIgbGV2ZWwgPSBsZXZlbF8gfCAwOwogICAgICAgICAgICB2YXIgaW1hZ2VEYXRhID0gYWxsb2NJbWFnZSgpOwogICAgICAgICAgICBjb3B5RmxhZ3MoaW1hZ2VEYXRhLCB0ZXh0dXJlKTsKICAgICAgICAgICAgaW1hZ2VEYXRhLndpZHRoID0gMDsKICAgICAgICAgICAgaW1hZ2VEYXRhLmhlaWdodCA9IDA7CiAgICAgICAgICAgIHBhcnNlSW1hZ2UoaW1hZ2VEYXRhLCBpbWFnZSk7CiAgICAgICAgICAgIGltYWdlRGF0YS53aWR0aCA9IGltYWdlRGF0YS53aWR0aCB8fCAodGV4dHVyZS53aWR0aCA+PiBsZXZlbCkgLSB4OwogICAgICAgICAgICBpbWFnZURhdGEuaGVpZ2h0ID0gaW1hZ2VEYXRhLmhlaWdodCB8fCAodGV4dHVyZS5oZWlnaHQgPj4gbGV2ZWwpIC0geTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB0ZXh0dXJlLnR5cGUgPT09IGltYWdlRGF0YS50eXBlICYmIHRleHR1cmUuZm9ybWF0ID09PSBpbWFnZURhdGEuZm9ybWF0ICYmIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQgPT09IGltYWdlRGF0YS5pbnRlcm5hbGZvcm1hdCwKICAgICAgICAgICAgICAiaW5jb21wYXRpYmxlIGZvcm1hdCBmb3IgdGV4dHVyZS5zdWJpbWFnZSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB4ID49IDAgJiYgeSA+PSAwICYmIHggKyBpbWFnZURhdGEud2lkdGggPD0gdGV4dHVyZS53aWR0aCAmJiB5ICsgaW1hZ2VEYXRhLmhlaWdodCA8PSB0ZXh0dXJlLmhlaWdodCwKICAgICAgICAgICAgICAidGV4dHVyZS5zdWJpbWFnZSB3cml0ZSBvdXQgb2YgYm91bmRzIgogICAgICAgICAgICApOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIHRleHR1cmUubWlwbWFzayAmIDEgPDwgbGV2ZWwsCiAgICAgICAgICAgICAgIm1pc3NpbmcgbWlwbWFwIGRhdGEiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgaW1hZ2VEYXRhLmRhdGEgfHwgaW1hZ2VEYXRhLmVsZW1lbnQgfHwgaW1hZ2VEYXRhLm5lZWRzQ29weSwKICAgICAgICAgICAgICAibWlzc2luZyBpbWFnZSBkYXRhIgogICAgICAgICAgICApOwogICAgICAgICAgICB0ZW1wQmluZCh0ZXh0dXJlKTsKICAgICAgICAgICAgc2V0U3ViSW1hZ2UoaW1hZ2VEYXRhLCBHTF9URVhUVVJFXzJEJDEsIHgsIHksIGxldmVsKTsKICAgICAgICAgICAgdGVtcFJlc3RvcmUoKTsKICAgICAgICAgICAgZnJlZUltYWdlKGltYWdlRGF0YSk7CiAgICAgICAgICAgIHJldHVybiByZWdsVGV4dHVyZTJEOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVzaXplMih3XywgaF8pIHsKICAgICAgICAgICAgdmFyIHcgPSB3XyB8IDA7CiAgICAgICAgICAgIHZhciBoID0gaF8gfCAwIHx8IHc7CiAgICAgICAgICAgIGlmICh3ID09PSB0ZXh0dXJlLndpZHRoICYmIGggPT09IHRleHR1cmUuaGVpZ2h0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlZ2xUZXh0dXJlMkQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnbFRleHR1cmUyRC53aWR0aCA9IHRleHR1cmUud2lkdGggPSB3OwogICAgICAgICAgICByZWdsVGV4dHVyZTJELmhlaWdodCA9IHRleHR1cmUuaGVpZ2h0ID0gaDsKICAgICAgICAgICAgdGVtcEJpbmQodGV4dHVyZSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyB0ZXh0dXJlLm1pcG1hc2sgPj4gaTsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIF93ID0gdyA+PiBpOwogICAgICAgICAgICAgIHZhciBfaCA9IGggPj4gaTsKICAgICAgICAgICAgICBpZiAoIV93IHx8ICFfaCkgYnJlYWs7CiAgICAgICAgICAgICAgZ2wudGV4SW1hZ2UyRCgKICAgICAgICAgICAgICAgIEdMX1RFWFRVUkVfMkQkMSwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICB0ZXh0dXJlLmZvcm1hdCwKICAgICAgICAgICAgICAgIF93LAogICAgICAgICAgICAgICAgX2gsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgdGV4dHVyZS5mb3JtYXQsCiAgICAgICAgICAgICAgICB0ZXh0dXJlLnR5cGUsCiAgICAgICAgICAgICAgICBudWxsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZW1wUmVzdG9yZSgpOwogICAgICAgICAgICBpZiAoY29uZmlnLnByb2ZpbGUpIHsKICAgICAgICAgICAgICB0ZXh0dXJlLnN0YXRzLnNpemUgPSBnZXRUZXh0dXJlU2l6ZSgKICAgICAgICAgICAgICAgIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQsCiAgICAgICAgICAgICAgICB0ZXh0dXJlLnR5cGUsCiAgICAgICAgICAgICAgICB3LAogICAgICAgICAgICAgICAgaCwKICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZWdsVGV4dHVyZTJEOwogICAgICAgICAgfQogICAgICAgICAgcmVnbFRleHR1cmUyRChhLCBiKTsKICAgICAgICAgIHJlZ2xUZXh0dXJlMkQuc3ViaW1hZ2UgPSBzdWJpbWFnZTsKICAgICAgICAgIHJlZ2xUZXh0dXJlMkQucmVzaXplID0gcmVzaXplMjsKICAgICAgICAgIHJlZ2xUZXh0dXJlMkQuX3JlZ2xUeXBlID0gInRleHR1cmUyZCI7CiAgICAgICAgICByZWdsVGV4dHVyZTJELl90ZXh0dXJlID0gdGV4dHVyZTsKICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICByZWdsVGV4dHVyZTJELnN0YXRzID0gdGV4dHVyZS5zdGF0czsKICAgICAgICAgIH0KICAgICAgICAgIHJlZ2xUZXh0dXJlMkQuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0ZXh0dXJlLmRlY1JlZigpOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiByZWdsVGV4dHVyZTJEOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0dXJlQ3ViZShhMCwgYTEsIGEyLCBhMywgYTQsIGE1KSB7CiAgICAgICAgICB2YXIgdGV4dHVyZSA9IG5ldyBSRUdMVGV4dHVyZShHTF9URVhUVVJFX0NVQkVfTUFQJDEpOwogICAgICAgICAgdGV4dHVyZVNldFt0ZXh0dXJlLmlkXSA9IHRleHR1cmU7CiAgICAgICAgICBzdGF0czIuY3ViZUNvdW50Kys7CiAgICAgICAgICB2YXIgZmFjZXMgPSBuZXcgQXJyYXkoNik7CiAgICAgICAgICBmdW5jdGlvbiByZWdsVGV4dHVyZUN1YmUoYTAyLCBhMTIsIGEyMiwgYTMyLCBhNDIsIGE1MikgewogICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgdmFyIHRleEluZm8gPSB0ZXh0dXJlLnRleEluZm87CiAgICAgICAgICAgIFRleEluZm8uY2FsbCh0ZXhJbmZvKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDY7ICsraSkgewogICAgICAgICAgICAgIGZhY2VzW2ldID0gYWxsb2NNaXBNYXAoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGEwMiA9PT0gIm51bWJlciIgfHwgIWEwMikgewogICAgICAgICAgICAgIHZhciBzID0gYTAyIHwgMCB8fCAxOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCA2OyArK2kpIHsKICAgICAgICAgICAgICAgIHBhcnNlTWlwTWFwRnJvbVNoYXBlKGZhY2VzW2ldLCBzLCBzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGEwMiA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBpZiAoYTEyKSB7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QoZmFjZXNbMF0sIGEwMik7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QoZmFjZXNbMV0sIGExMik7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QoZmFjZXNbMl0sIGEyMik7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QoZmFjZXNbM10sIGEzMik7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QoZmFjZXNbNF0sIGE0Mik7CiAgICAgICAgICAgICAgICBwYXJzZU1pcE1hcEZyb21PYmplY3QoZmFjZXNbNV0sIGE1Mik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnNlVGV4SW5mbyh0ZXhJbmZvLCBhMDIpOwogICAgICAgICAgICAgICAgcGFyc2VGbGFncyh0ZXh0dXJlLCBhMDIpOwogICAgICAgICAgICAgICAgaWYgKCJmYWNlcyIgaW4gYTAyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmYWNlSW5wdXQgPSBhMDIuZmFjZXM7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAgICAgQXJyYXkuaXNBcnJheShmYWNlSW5wdXQpICYmIGZhY2VJbnB1dC5sZW5ndGggPT09IDYsCiAgICAgICAgICAgICAgICAgICAgImN1YmUgZmFjZXMgbXVzdCBiZSBhIGxlbmd0aCA2IGFycmF5IgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNjsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBmYWNlSW5wdXRbaV0gPT09ICJvYmplY3QiICYmICEhZmFjZUlucHV0W2ldLAogICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgaW5wdXQgZm9yIGN1YmUgbWFwIGZhY2UiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBjb3B5RmxhZ3MoZmFjZXNbaV0sIHRleHR1cmUpOwogICAgICAgICAgICAgICAgICAgIHBhcnNlTWlwTWFwRnJvbU9iamVjdChmYWNlc1tpXSwgZmFjZUlucHV0W2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDY7ICsraSkgewogICAgICAgICAgICAgICAgICAgIHBhcnNlTWlwTWFwRnJvbU9iamVjdChmYWNlc1tpXSwgYTAyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJpbnZhbGlkIGFyZ3VtZW50cyB0byBjdWJlIG1hcCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvcHlGbGFncyh0ZXh0dXJlLCBmYWNlc1swXSk7CiAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFsaW1pdHMubnBvdFRleHR1cmVDdWJlKSB7CiAgICAgICAgICAgICAgICBjaGVjayQxKGlzUG93MiQxKHRleHR1cmUud2lkdGgpICYmIGlzUG93MiQxKHRleHR1cmUuaGVpZ2h0KSwgInlvdXIgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IG5vbiBwb3dlciBvciB0d28gdGV4dHVyZSBkaW1lbnNpb25zIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHRleEluZm8uZ2VuTWlwbWFwcykgewogICAgICAgICAgICAgIHRleHR1cmUubWlwbWFzayA9IChmYWNlc1swXS53aWR0aCA8PCAxKSAtIDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGV4dHVyZS5taXBtYXNrID0gZmFjZXNbMF0ubWlwbWFzazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGVjayQxLnRleHR1cmVDdWJlKHRleHR1cmUsIHRleEluZm8sIGZhY2VzLCBsaW1pdHMpOwogICAgICAgICAgICB0ZXh0dXJlLmludGVybmFsZm9ybWF0ID0gZmFjZXNbMF0uaW50ZXJuYWxmb3JtYXQ7CiAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS53aWR0aCA9IGZhY2VzWzBdLndpZHRoOwogICAgICAgICAgICByZWdsVGV4dHVyZUN1YmUuaGVpZ2h0ID0gZmFjZXNbMF0uaGVpZ2h0OwogICAgICAgICAgICB0ZW1wQmluZCh0ZXh0dXJlKTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDY7ICsraSkgewogICAgICAgICAgICAgIHNldE1pcE1hcChmYWNlc1tpXSwgR0xfVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YJDEgKyBpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUZXhJbmZvKHRleEluZm8sIEdMX1RFWFRVUkVfQ1VCRV9NQVAkMSk7CiAgICAgICAgICAgIHRlbXBSZXN0b3JlKCk7CiAgICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICAgIHRleHR1cmUuc3RhdHMuc2l6ZSA9IGdldFRleHR1cmVTaXplKAogICAgICAgICAgICAgICAgdGV4dHVyZS5pbnRlcm5hbGZvcm1hdCwKICAgICAgICAgICAgICAgIHRleHR1cmUudHlwZSwKICAgICAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS53aWR0aCwKICAgICAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS5oZWlnaHQsCiAgICAgICAgICAgICAgICB0ZXhJbmZvLmdlbk1pcG1hcHMsCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWdsVGV4dHVyZUN1YmUuZm9ybWF0ID0gdGV4dHVyZUZvcm1hdHNJbnZlcnRbdGV4dHVyZS5pbnRlcm5hbGZvcm1hdF07CiAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS50eXBlID0gdGV4dHVyZVR5cGVzSW52ZXJ0W3RleHR1cmUudHlwZV07CiAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS5tYWcgPSBtYWdGaWx0ZXJzSW52ZXJ0W3RleEluZm8ubWFnRmlsdGVyXTsKICAgICAgICAgICAgcmVnbFRleHR1cmVDdWJlLm1pbiA9IG1pbkZpbHRlcnNJbnZlcnRbdGV4SW5mby5taW5GaWx0ZXJdOwogICAgICAgICAgICByZWdsVGV4dHVyZUN1YmUud3JhcFMgPSB3cmFwTW9kZXNJbnZlcnRbdGV4SW5mby53cmFwU107CiAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS53cmFwVCA9IHdyYXBNb2Rlc0ludmVydFt0ZXhJbmZvLndyYXBUXTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDY7ICsraSkgewogICAgICAgICAgICAgIGZyZWVNaXBNYXAoZmFjZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZWdsVGV4dHVyZUN1YmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzdWJpbWFnZShmYWNlLCBpbWFnZSwgeF8sIHlfLCBsZXZlbF8pIHsKICAgICAgICAgICAgY2hlY2skMSghIWltYWdlLCAibXVzdCBzcGVjaWZ5IGltYWdlIGRhdGEiKTsKICAgICAgICAgICAgY2hlY2skMSh0eXBlb2YgZmFjZSA9PT0gIm51bWJlciIgJiYgZmFjZSA9PT0gKGZhY2UgfCAwKSAmJiBmYWNlID49IDAgJiYgZmFjZSA8IDYsICJpbnZhbGlkIGZhY2UiKTsKICAgICAgICAgICAgdmFyIHggPSB4XyB8IDA7CiAgICAgICAgICAgIHZhciB5ID0geV8gfCAwOwogICAgICAgICAgICB2YXIgbGV2ZWwgPSBsZXZlbF8gfCAwOwogICAgICAgICAgICB2YXIgaW1hZ2VEYXRhID0gYWxsb2NJbWFnZSgpOwogICAgICAgICAgICBjb3B5RmxhZ3MoaW1hZ2VEYXRhLCB0ZXh0dXJlKTsKICAgICAgICAgICAgaW1hZ2VEYXRhLndpZHRoID0gMDsKICAgICAgICAgICAgaW1hZ2VEYXRhLmhlaWdodCA9IDA7CiAgICAgICAgICAgIHBhcnNlSW1hZ2UoaW1hZ2VEYXRhLCBpbWFnZSk7CiAgICAgICAgICAgIGltYWdlRGF0YS53aWR0aCA9IGltYWdlRGF0YS53aWR0aCB8fCAodGV4dHVyZS53aWR0aCA+PiBsZXZlbCkgLSB4OwogICAgICAgICAgICBpbWFnZURhdGEuaGVpZ2h0ID0gaW1hZ2VEYXRhLmhlaWdodCB8fCAodGV4dHVyZS5oZWlnaHQgPj4gbGV2ZWwpIC0geTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB0ZXh0dXJlLnR5cGUgPT09IGltYWdlRGF0YS50eXBlICYmIHRleHR1cmUuZm9ybWF0ID09PSBpbWFnZURhdGEuZm9ybWF0ICYmIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQgPT09IGltYWdlRGF0YS5pbnRlcm5hbGZvcm1hdCwKICAgICAgICAgICAgICAiaW5jb21wYXRpYmxlIGZvcm1hdCBmb3IgdGV4dHVyZS5zdWJpbWFnZSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB4ID49IDAgJiYgeSA+PSAwICYmIHggKyBpbWFnZURhdGEud2lkdGggPD0gdGV4dHVyZS53aWR0aCAmJiB5ICsgaW1hZ2VEYXRhLmhlaWdodCA8PSB0ZXh0dXJlLmhlaWdodCwKICAgICAgICAgICAgICAidGV4dHVyZS5zdWJpbWFnZSB3cml0ZSBvdXQgb2YgYm91bmRzIgogICAgICAgICAgICApOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIHRleHR1cmUubWlwbWFzayAmIDEgPDwgbGV2ZWwsCiAgICAgICAgICAgICAgIm1pc3NpbmcgbWlwbWFwIGRhdGEiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgaW1hZ2VEYXRhLmRhdGEgfHwgaW1hZ2VEYXRhLmVsZW1lbnQgfHwgaW1hZ2VEYXRhLm5lZWRzQ29weSwKICAgICAgICAgICAgICAibWlzc2luZyBpbWFnZSBkYXRhIgogICAgICAgICAgICApOwogICAgICAgICAgICB0ZW1wQmluZCh0ZXh0dXJlKTsKICAgICAgICAgICAgc2V0U3ViSW1hZ2UoaW1hZ2VEYXRhLCBHTF9URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1gkMSArIGZhY2UsIHgsIHksIGxldmVsKTsKICAgICAgICAgICAgdGVtcFJlc3RvcmUoKTsKICAgICAgICAgICAgZnJlZUltYWdlKGltYWdlRGF0YSk7CiAgICAgICAgICAgIHJldHVybiByZWdsVGV4dHVyZUN1YmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNpemUyKHJhZGl1c18pIHsKICAgICAgICAgICAgdmFyIHJhZGl1cyA9IHJhZGl1c18gfCAwOwogICAgICAgICAgICBpZiAocmFkaXVzID09PSB0ZXh0dXJlLndpZHRoKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS53aWR0aCA9IHRleHR1cmUud2lkdGggPSByYWRpdXM7CiAgICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS5oZWlnaHQgPSB0ZXh0dXJlLmhlaWdodCA9IHJhZGl1czsKICAgICAgICAgICAgdGVtcEJpbmQodGV4dHVyZSk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgNjsgKytpKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IHRleHR1cmUubWlwbWFzayA+PiBqOyArK2opIHsKICAgICAgICAgICAgICAgIGdsLnRleEltYWdlMkQoCiAgICAgICAgICAgICAgICAgIEdMX1RFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCQxICsgaSwKICAgICAgICAgICAgICAgICAgaiwKICAgICAgICAgICAgICAgICAgdGV4dHVyZS5mb3JtYXQsCiAgICAgICAgICAgICAgICAgIHJhZGl1cyA+PiBqLAogICAgICAgICAgICAgICAgICByYWRpdXMgPj4gaiwKICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgdGV4dHVyZS5mb3JtYXQsCiAgICAgICAgICAgICAgICAgIHRleHR1cmUudHlwZSwKICAgICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGVtcFJlc3RvcmUoKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICAgICAgdGV4dHVyZS5zdGF0cy5zaXplID0gZ2V0VGV4dHVyZVNpemUoCiAgICAgICAgICAgICAgICB0ZXh0dXJlLmludGVybmFsZm9ybWF0LAogICAgICAgICAgICAgICAgdGV4dHVyZS50eXBlLAogICAgICAgICAgICAgICAgcmVnbFRleHR1cmVDdWJlLndpZHRoLAogICAgICAgICAgICAgICAgcmVnbFRleHR1cmVDdWJlLmhlaWdodCwKICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlZ2xUZXh0dXJlQ3ViZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZShhMCwgYTEsIGEyLCBhMywgYTQsIGE1KTsKICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS5zdWJpbWFnZSA9IHN1YmltYWdlOwogICAgICAgICAgcmVnbFRleHR1cmVDdWJlLnJlc2l6ZSA9IHJlc2l6ZTI7CiAgICAgICAgICByZWdsVGV4dHVyZUN1YmUuX3JlZ2xUeXBlID0gInRleHR1cmVDdWJlIjsKICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS5fdGV4dHVyZSA9IHRleHR1cmU7CiAgICAgICAgICBpZiAoY29uZmlnLnByb2ZpbGUpIHsKICAgICAgICAgICAgcmVnbFRleHR1cmVDdWJlLnN0YXRzID0gdGV4dHVyZS5zdGF0czsKICAgICAgICAgIH0KICAgICAgICAgIHJlZ2xUZXh0dXJlQ3ViZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRleHR1cmUuZGVjUmVmKCk7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHJlZ2xUZXh0dXJlQ3ViZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzdHJveVRleHR1cmVzKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1UZXhVbml0czsgKytpKSB7CiAgICAgICAgICAgIGdsLmFjdGl2ZVRleHR1cmUoR0xfVEVYVFVSRTAkMSArIGkpOwogICAgICAgICAgICBnbC5iaW5kVGV4dHVyZShHTF9URVhUVVJFXzJEJDEsIG51bGwpOwogICAgICAgICAgICB0ZXh0dXJlVW5pdHNbaV0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFsdWVzKHRleHR1cmVTZXQpLmZvckVhY2goZGVzdHJveSk7CiAgICAgICAgICBzdGF0czIuY3ViZUNvdW50ID0gMDsKICAgICAgICAgIHN0YXRzMi50ZXh0dXJlQ291bnQgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoY29uZmlnLnByb2ZpbGUpIHsKICAgICAgICAgIHN0YXRzMi5nZXRUb3RhbFRleHR1cmVTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0b3RhbCA9IDA7CiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRleHR1cmVTZXQpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgdG90YWwgKz0gdGV4dHVyZVNldFtrZXldLnN0YXRzLnNpemU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdG90YWw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlVGV4dHVyZXMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bVRleFVuaXRzOyArK2kpIHsKICAgICAgICAgICAgdmFyIHRleCA9IHRleHR1cmVVbml0c1tpXTsKICAgICAgICAgICAgaWYgKHRleCkgewogICAgICAgICAgICAgIHRleC5iaW5kQ291bnQgPSAwOwogICAgICAgICAgICAgIHRleC51bml0ID0gLTE7CiAgICAgICAgICAgICAgdGV4dHVyZVVuaXRzW2ldID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFsdWVzKHRleHR1cmVTZXQpLmZvckVhY2goZnVuY3Rpb24odGV4dHVyZSkgewogICAgICAgICAgICB0ZXh0dXJlLnRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICAgICAgICAgIGdsLmJpbmRUZXh0dXJlKHRleHR1cmUudGFyZ2V0LCB0ZXh0dXJlLnRleHR1cmUpOwogICAgICAgICAgICBmb3IgKHZhciBpMiA9IDA7IGkyIDwgMzI7ICsraTIpIHsKICAgICAgICAgICAgICBpZiAoKHRleHR1cmUubWlwbWFzayAmIDEgPDwgaTIpID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRleHR1cmUudGFyZ2V0ID09PSBHTF9URVhUVVJFXzJEJDEpIHsKICAgICAgICAgICAgICAgIGdsLnRleEltYWdlMkQoCiAgICAgICAgICAgICAgICAgIEdMX1RFWFRVUkVfMkQkMSwKICAgICAgICAgICAgICAgICAgaTIsCiAgICAgICAgICAgICAgICAgIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQsCiAgICAgICAgICAgICAgICAgIHRleHR1cmUud2lkdGggPj4gaTIsCiAgICAgICAgICAgICAgICAgIHRleHR1cmUuaGVpZ2h0ID4+IGkyLAogICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICB0ZXh0dXJlLmludGVybmFsZm9ybWF0LAogICAgICAgICAgICAgICAgICB0ZXh0dXJlLnR5cGUsCiAgICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgNjsgKytqKSB7CiAgICAgICAgICAgICAgICAgIGdsLnRleEltYWdlMkQoCiAgICAgICAgICAgICAgICAgICAgR0xfVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YJDEgKyBqLAogICAgICAgICAgICAgICAgICAgIGkyLAogICAgICAgICAgICAgICAgICAgIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQsCiAgICAgICAgICAgICAgICAgICAgdGV4dHVyZS53aWR0aCA+PiBpMiwKICAgICAgICAgICAgICAgICAgICB0ZXh0dXJlLmhlaWdodCA+PiBpMiwKICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgIHRleHR1cmUuaW50ZXJuYWxmb3JtYXQsCiAgICAgICAgICAgICAgICAgICAgdGV4dHVyZS50eXBlLAogICAgICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0VGV4SW5mbyh0ZXh0dXJlLnRleEluZm8sIHRleHR1cmUudGFyZ2V0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWZyZXNoVGV4dHVyZXMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bVRleFVuaXRzOyArK2kpIHsKICAgICAgICAgICAgdmFyIHRleCA9IHRleHR1cmVVbml0c1tpXTsKICAgICAgICAgICAgaWYgKHRleCkgewogICAgICAgICAgICAgIHRleC5iaW5kQ291bnQgPSAwOwogICAgICAgICAgICAgIHRleC51bml0ID0gLTE7CiAgICAgICAgICAgICAgdGV4dHVyZVVuaXRzW2ldID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBnbC5hY3RpdmVUZXh0dXJlKEdMX1RFWFRVUkUwJDEgKyBpKTsKICAgICAgICAgICAgZ2wuYmluZFRleHR1cmUoR0xfVEVYVFVSRV8yRCQxLCBudWxsKTsKICAgICAgICAgICAgZ2wuYmluZFRleHR1cmUoR0xfVEVYVFVSRV9DVUJFX01BUCQxLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZTJEOiBjcmVhdGVUZXh0dXJlMkQsCiAgICAgICAgICBjcmVhdGVDdWJlOiBjcmVhdGVUZXh0dXJlQ3ViZSwKICAgICAgICAgIGNsZWFyOiBkZXN0cm95VGV4dHVyZXMsCiAgICAgICAgICBnZXRUZXh0dXJlOiBmdW5jdGlvbih3cmFwcGVyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfSwKICAgICAgICAgIHJlc3RvcmU6IHJlc3RvcmVUZXh0dXJlcywKICAgICAgICAgIHJlZnJlc2g6IHJlZnJlc2hUZXh0dXJlcwogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIEdMX1JFTkRFUkJVRkZFUiA9IDM2MTYxOwogICAgICB2YXIgR0xfUkdCQTQkMSA9IDMyODU0OwogICAgICB2YXIgR0xfUkdCNV9BMSQxID0gMzI4NTU7CiAgICAgIHZhciBHTF9SR0I1NjUkMSA9IDM2MTk0OwogICAgICB2YXIgR0xfREVQVEhfQ09NUE9ORU5UMTYgPSAzMzE4OTsKICAgICAgdmFyIEdMX1NURU5DSUxfSU5ERVg4ID0gMzYxNjg7CiAgICAgIHZhciBHTF9ERVBUSF9TVEVOQ0lMJDEgPSAzNDA0MTsKICAgICAgdmFyIEdMX1NSR0I4X0FMUEhBOF9FWFQgPSAzNTkwNzsKICAgICAgdmFyIEdMX1JHQkEzMkZfRVhUID0gMzQ4MzY7CiAgICAgIHZhciBHTF9SR0JBMTZGX0VYVCA9IDM0ODQyOwogICAgICB2YXIgR0xfUkdCMTZGX0VYVCA9IDM0ODQzOwogICAgICB2YXIgRk9STUFUX1NJWkVTID0gW107CiAgICAgIEZPUk1BVF9TSVpFU1tHTF9SR0JBNCQxXSA9IDI7CiAgICAgIEZPUk1BVF9TSVpFU1tHTF9SR0I1X0ExJDFdID0gMjsKICAgICAgRk9STUFUX1NJWkVTW0dMX1JHQjU2NSQxXSA9IDI7CiAgICAgIEZPUk1BVF9TSVpFU1tHTF9ERVBUSF9DT01QT05FTlQxNl0gPSAyOwogICAgICBGT1JNQVRfU0laRVNbR0xfU1RFTkNJTF9JTkRFWDhdID0gMTsKICAgICAgRk9STUFUX1NJWkVTW0dMX0RFUFRIX1NURU5DSUwkMV0gPSA0OwogICAgICBGT1JNQVRfU0laRVNbR0xfU1JHQjhfQUxQSEE4X0VYVF0gPSA0OwogICAgICBGT1JNQVRfU0laRVNbR0xfUkdCQTMyRl9FWFRdID0gMTY7CiAgICAgIEZPUk1BVF9TSVpFU1tHTF9SR0JBMTZGX0VYVF0gPSA4OwogICAgICBGT1JNQVRfU0laRVNbR0xfUkdCMTZGX0VYVF0gPSA2OwogICAgICBmdW5jdGlvbiBnZXRSZW5kZXJidWZmZXJTaXplKGZvcm1hdDIsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICByZXR1cm4gRk9STUFUX1NJWkVTW2Zvcm1hdDJdICogd2lkdGggKiBoZWlnaHQ7CiAgICAgIH0KICAgICAgdmFyIHdyYXBSZW5kZXJidWZmZXJzID0gZnVuY3Rpb24oZ2wsIGV4dGVuc2lvbnMsIGxpbWl0cywgc3RhdHMyLCBjb25maWcpIHsKICAgICAgICB2YXIgZm9ybWF0VHlwZXMgPSB7CiAgICAgICAgICAicmdiYTQiOiBHTF9SR0JBNCQxLAogICAgICAgICAgInJnYjU2NSI6IEdMX1JHQjU2NSQxLAogICAgICAgICAgInJnYjUgYTEiOiBHTF9SR0I1X0ExJDEsCiAgICAgICAgICAiZGVwdGgiOiBHTF9ERVBUSF9DT01QT05FTlQxNiwKICAgICAgICAgICJzdGVuY2lsIjogR0xfU1RFTkNJTF9JTkRFWDgsCiAgICAgICAgICAiZGVwdGggc3RlbmNpbCI6IEdMX0RFUFRIX1NURU5DSUwkMQogICAgICAgIH07CiAgICAgICAgaWYgKGV4dGVuc2lvbnMuZXh0X3NyZ2IpIHsKICAgICAgICAgIGZvcm1hdFR5cGVzWyJzcmdiYSJdID0gR0xfU1JHQjhfQUxQSEE4X0VYVDsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dGVuc2lvbnMuZXh0X2NvbG9yX2J1ZmZlcl9oYWxmX2Zsb2F0KSB7CiAgICAgICAgICBmb3JtYXRUeXBlc1sicmdiYTE2ZiJdID0gR0xfUkdCQTE2Rl9FWFQ7CiAgICAgICAgICBmb3JtYXRUeXBlc1sicmdiMTZmIl0gPSBHTF9SR0IxNkZfRVhUOwogICAgICAgIH0KICAgICAgICBpZiAoZXh0ZW5zaW9ucy53ZWJnbF9jb2xvcl9idWZmZXJfZmxvYXQpIHsKICAgICAgICAgIGZvcm1hdFR5cGVzWyJyZ2JhMzJmIl0gPSBHTF9SR0JBMzJGX0VYVDsKICAgICAgICB9CiAgICAgICAgdmFyIGZvcm1hdFR5cGVzSW52ZXJ0ID0gW107CiAgICAgICAgT2JqZWN0LmtleXMoZm9ybWF0VHlwZXMpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICB2YXIgdmFsID0gZm9ybWF0VHlwZXNba2V5XTsKICAgICAgICAgIGZvcm1hdFR5cGVzSW52ZXJ0W3ZhbF0gPSBrZXk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIHJlbmRlcmJ1ZmZlckNvdW50ID0gMDsKICAgICAgICB2YXIgcmVuZGVyYnVmZmVyU2V0ID0ge307CiAgICAgICAgZnVuY3Rpb24gUkVHTFJlbmRlcmJ1ZmZlcihyZW5kZXJidWZmZXIpIHsKICAgICAgICAgIHRoaXMuaWQgPSByZW5kZXJidWZmZXJDb3VudCsrOwogICAgICAgICAgdGhpcy5yZWZDb3VudCA9IDE7CiAgICAgICAgICB0aGlzLnJlbmRlcmJ1ZmZlciA9IHJlbmRlcmJ1ZmZlcjsKICAgICAgICAgIHRoaXMuZm9ybWF0ID0gR0xfUkdCQTQkMTsKICAgICAgICAgIHRoaXMud2lkdGggPSAwOwogICAgICAgICAgdGhpcy5oZWlnaHQgPSAwOwogICAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHMgPSB7IHNpemU6IDAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgUkVHTFJlbmRlcmJ1ZmZlci5wcm90b3R5cGUuZGVjUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoLS10aGlzLnJlZkNvdW50IDw9IDApIHsKICAgICAgICAgICAgZGVzdHJveSh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3kocmIpIHsKICAgICAgICAgIHZhciBoYW5kbGUgPSByYi5yZW5kZXJidWZmZXI7CiAgICAgICAgICBjaGVjayQxKGhhbmRsZSwgIm11c3Qgbm90IGRvdWJsZSBkZXN0cm95IHJlbmRlcmJ1ZmZlciIpOwogICAgICAgICAgZ2wuYmluZFJlbmRlcmJ1ZmZlcihHTF9SRU5ERVJCVUZGRVIsIG51bGwpOwogICAgICAgICAgZ2wuZGVsZXRlUmVuZGVyYnVmZmVyKGhhbmRsZSk7CiAgICAgICAgICByYi5yZW5kZXJidWZmZXIgPSBudWxsOwogICAgICAgICAgcmIucmVmQ291bnQgPSAwOwogICAgICAgICAgZGVsZXRlIHJlbmRlcmJ1ZmZlclNldFtyYi5pZF07CiAgICAgICAgICBzdGF0czIucmVuZGVyYnVmZmVyQ291bnQtLTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVuZGVyYnVmZmVyKGEsIGIpIHsKICAgICAgICAgIHZhciByZW5kZXJidWZmZXIgPSBuZXcgUkVHTFJlbmRlcmJ1ZmZlcihnbC5jcmVhdGVSZW5kZXJidWZmZXIoKSk7CiAgICAgICAgICByZW5kZXJidWZmZXJTZXRbcmVuZGVyYnVmZmVyLmlkXSA9IHJlbmRlcmJ1ZmZlcjsKICAgICAgICAgIHN0YXRzMi5yZW5kZXJidWZmZXJDb3VudCsrOwogICAgICAgICAgZnVuY3Rpb24gcmVnbFJlbmRlcmJ1ZmZlcihhMiwgYjIpIHsKICAgICAgICAgICAgdmFyIHcgPSAwOwogICAgICAgICAgICB2YXIgaCA9IDA7CiAgICAgICAgICAgIHZhciBmb3JtYXQyID0gR0xfUkdCQTQkMTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhMiA9PT0gIm9iamVjdCIgJiYgYTIpIHsKICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IGEyOwogICAgICAgICAgICAgIGlmICgic2hhcGUiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhciBzaGFwZSA9IG9wdGlvbnMuc2hhcGU7CiAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICBBcnJheS5pc0FycmF5KHNoYXBlKSAmJiBzaGFwZS5sZW5ndGggPj0gMiwKICAgICAgICAgICAgICAgICAgImludmFsaWQgcmVuZGVyYnVmZmVyIHNoYXBlIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHcgPSBzaGFwZVswXSB8IDA7CiAgICAgICAgICAgICAgICBoID0gc2hhcGVbMV0gfCAwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoInJhZGl1cyIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgICAgICB3ID0gaCA9IG9wdGlvbnMucmFkaXVzIHwgMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgid2lkdGgiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgdyA9IG9wdGlvbnMud2lkdGggfCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCJoZWlnaHQiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgaCA9IG9wdGlvbnMuaGVpZ2h0IHwgMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJmb3JtYXQiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKAogICAgICAgICAgICAgICAgICBvcHRpb25zLmZvcm1hdCwKICAgICAgICAgICAgICAgICAgZm9ybWF0VHlwZXMsCiAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHJlbmRlcmJ1ZmZlciBmb3JtYXQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgZm9ybWF0MiA9IGZvcm1hdFR5cGVzW29wdGlvbnMuZm9ybWF0XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGEyID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHcgPSBhMiB8IDA7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBiMiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGggPSBiMiB8IDA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGggPSB3OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghYTIpIHsKICAgICAgICAgICAgICB3ID0gaCA9IDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hlY2skMS5yYWlzZSgiaW52YWxpZCBhcmd1bWVudHMgdG8gcmVuZGVyYnVmZmVyIGNvbnN0cnVjdG9yIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB3ID4gMCAmJiBoID4gMCAmJiB3IDw9IGxpbWl0cy5tYXhSZW5kZXJidWZmZXJTaXplICYmIGggPD0gbGltaXRzLm1heFJlbmRlcmJ1ZmZlclNpemUsCiAgICAgICAgICAgICAgImludmFsaWQgcmVuZGVyYnVmZmVyIHNpemUiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICh3ID09PSByZW5kZXJidWZmZXIud2lkdGggJiYgaCA9PT0gcmVuZGVyYnVmZmVyLmhlaWdodCAmJiBmb3JtYXQyID09PSByZW5kZXJidWZmZXIuZm9ybWF0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlZ2xSZW5kZXJidWZmZXIud2lkdGggPSByZW5kZXJidWZmZXIud2lkdGggPSB3OwogICAgICAgICAgICByZWdsUmVuZGVyYnVmZmVyLmhlaWdodCA9IHJlbmRlcmJ1ZmZlci5oZWlnaHQgPSBoOwogICAgICAgICAgICByZW5kZXJidWZmZXIuZm9ybWF0ID0gZm9ybWF0MjsKICAgICAgICAgICAgZ2wuYmluZFJlbmRlcmJ1ZmZlcihHTF9SRU5ERVJCVUZGRVIsIHJlbmRlcmJ1ZmZlci5yZW5kZXJidWZmZXIpOwogICAgICAgICAgICBnbC5yZW5kZXJidWZmZXJTdG9yYWdlKEdMX1JFTkRFUkJVRkZFUiwgZm9ybWF0MiwgdywgaCk7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZ2wuZ2V0RXJyb3IoKSA9PT0gMCwKICAgICAgICAgICAgICAiaW52YWxpZCByZW5kZXIgYnVmZmVyIGZvcm1hdCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICAgICAgcmVuZGVyYnVmZmVyLnN0YXRzLnNpemUgPSBnZXRSZW5kZXJidWZmZXJTaXplKHJlbmRlcmJ1ZmZlci5mb3JtYXQsIHJlbmRlcmJ1ZmZlci53aWR0aCwgcmVuZGVyYnVmZmVyLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVnbFJlbmRlcmJ1ZmZlci5mb3JtYXQgPSBmb3JtYXRUeXBlc0ludmVydFtyZW5kZXJidWZmZXIuZm9ybWF0XTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2xSZW5kZXJidWZmZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNpemUyKHdfLCBoXykgewogICAgICAgICAgICB2YXIgdyA9IHdfIHwgMDsKICAgICAgICAgICAgdmFyIGggPSBoXyB8IDAgfHwgdzsKICAgICAgICAgICAgaWYgKHcgPT09IHJlbmRlcmJ1ZmZlci53aWR0aCAmJiBoID09PSByZW5kZXJidWZmZXIuaGVpZ2h0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlZ2xSZW5kZXJidWZmZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB3ID4gMCAmJiBoID4gMCAmJiB3IDw9IGxpbWl0cy5tYXhSZW5kZXJidWZmZXJTaXplICYmIGggPD0gbGltaXRzLm1heFJlbmRlcmJ1ZmZlclNpemUsCiAgICAgICAgICAgICAgImludmFsaWQgcmVuZGVyYnVmZmVyIHNpemUiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJlZ2xSZW5kZXJidWZmZXIud2lkdGggPSByZW5kZXJidWZmZXIud2lkdGggPSB3OwogICAgICAgICAgICByZWdsUmVuZGVyYnVmZmVyLmhlaWdodCA9IHJlbmRlcmJ1ZmZlci5oZWlnaHQgPSBoOwogICAgICAgICAgICBnbC5iaW5kUmVuZGVyYnVmZmVyKEdMX1JFTkRFUkJVRkZFUiwgcmVuZGVyYnVmZmVyLnJlbmRlcmJ1ZmZlcik7CiAgICAgICAgICAgIGdsLnJlbmRlcmJ1ZmZlclN0b3JhZ2UoR0xfUkVOREVSQlVGRkVSLCByZW5kZXJidWZmZXIuZm9ybWF0LCB3LCBoKTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICBnbC5nZXRFcnJvcigpID09PSAwLAogICAgICAgICAgICAgICJpbnZhbGlkIHJlbmRlciBidWZmZXIgZm9ybWF0IgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoY29uZmlnLnByb2ZpbGUpIHsKICAgICAgICAgICAgICByZW5kZXJidWZmZXIuc3RhdHMuc2l6ZSA9IGdldFJlbmRlcmJ1ZmZlclNpemUoCiAgICAgICAgICAgICAgICByZW5kZXJidWZmZXIuZm9ybWF0LAogICAgICAgICAgICAgICAgcmVuZGVyYnVmZmVyLndpZHRoLAogICAgICAgICAgICAgICAgcmVuZGVyYnVmZmVyLmhlaWdodAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlZ2xSZW5kZXJidWZmZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZWdsUmVuZGVyYnVmZmVyKGEsIGIpOwogICAgICAgICAgcmVnbFJlbmRlcmJ1ZmZlci5yZXNpemUgPSByZXNpemUyOwogICAgICAgICAgcmVnbFJlbmRlcmJ1ZmZlci5fcmVnbFR5cGUgPSAicmVuZGVyYnVmZmVyIjsKICAgICAgICAgIHJlZ2xSZW5kZXJidWZmZXIuX3JlbmRlcmJ1ZmZlciA9IHJlbmRlcmJ1ZmZlcjsKICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICByZWdsUmVuZGVyYnVmZmVyLnN0YXRzID0gcmVuZGVyYnVmZmVyLnN0YXRzOwogICAgICAgICAgfQogICAgICAgICAgcmVnbFJlbmRlcmJ1ZmZlci5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJlbmRlcmJ1ZmZlci5kZWNSZWYoKTsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gcmVnbFJlbmRlcmJ1ZmZlcjsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICBzdGF0czIuZ2V0VG90YWxSZW5kZXJidWZmZXJTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB0b3RhbCA9IDA7CiAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlbmRlcmJ1ZmZlclNldCkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICB0b3RhbCArPSByZW5kZXJidWZmZXJTZXRba2V5XS5zdGF0cy5zaXplOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVJlbmRlcmJ1ZmZlcnMoKSB7CiAgICAgICAgICB2YWx1ZXMocmVuZGVyYnVmZmVyU2V0KS5mb3JFYWNoKGZ1bmN0aW9uKHJiKSB7CiAgICAgICAgICAgIHJiLnJlbmRlcmJ1ZmZlciA9IGdsLmNyZWF0ZVJlbmRlcmJ1ZmZlcigpOwogICAgICAgICAgICBnbC5iaW5kUmVuZGVyYnVmZmVyKEdMX1JFTkRFUkJVRkZFUiwgcmIucmVuZGVyYnVmZmVyKTsKICAgICAgICAgICAgZ2wucmVuZGVyYnVmZmVyU3RvcmFnZShHTF9SRU5ERVJCVUZGRVIsIHJiLmZvcm1hdCwgcmIud2lkdGgsIHJiLmhlaWdodCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGdsLmJpbmRSZW5kZXJidWZmZXIoR0xfUkVOREVSQlVGRkVSLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZTogY3JlYXRlUmVuZGVyYnVmZmVyLAogICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YWx1ZXMocmVuZGVyYnVmZmVyU2V0KS5mb3JFYWNoKGRlc3Ryb3kpOwogICAgICAgICAgfSwKICAgICAgICAgIHJlc3RvcmU6IHJlc3RvcmVSZW5kZXJidWZmZXJzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgdmFyIEdMX0ZSQU1FQlVGRkVSJDEgPSAzNjE2MDsKICAgICAgdmFyIEdMX1JFTkRFUkJVRkZFUiQxID0gMzYxNjE7CiAgICAgIHZhciBHTF9URVhUVVJFXzJEJDIgPSAzNTUzOwogICAgICB2YXIgR0xfVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YJDIgPSAzNDA2OTsKICAgICAgdmFyIEdMX0NPTE9SX0FUVEFDSE1FTlQwJDEgPSAzNjA2NDsKICAgICAgdmFyIEdMX0RFUFRIX0FUVEFDSE1FTlQgPSAzNjA5NjsKICAgICAgdmFyIEdMX1NURU5DSUxfQVRUQUNITUVOVCA9IDM2MTI4OwogICAgICB2YXIgR0xfREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5UID0gMzMzMDY7CiAgICAgIHZhciBHTF9GUkFNRUJVRkZFUl9DT01QTEVURSQxID0gMzYwNTM7CiAgICAgIHZhciBHTF9GUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlQgPSAzNjA1NDsKICAgICAgdmFyIEdMX0ZSQU1FQlVGRkVSX0lOQ09NUExFVEVfTUlTU0lOR19BVFRBQ0hNRU5UID0gMzYwNTU7CiAgICAgIHZhciBHTF9GUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0RJTUVOU0lPTlMgPSAzNjA1NzsKICAgICAgdmFyIEdMX0ZSQU1FQlVGRkVSX1VOU1VQUE9SVEVEID0gMzYwNjE7CiAgICAgIHZhciBHTF9IQUxGX0ZMT0FUX09FUyQyID0gMzYxOTM7CiAgICAgIHZhciBHTF9VTlNJR05FRF9CWVRFJDYgPSA1MTIxOwogICAgICB2YXIgR0xfRkxPQVQkNSA9IDUxMjY7CiAgICAgIHZhciBHTF9SR0IkMSA9IDY0MDc7CiAgICAgIHZhciBHTF9SR0JBJDIgPSA2NDA4OwogICAgICB2YXIgR0xfREVQVEhfQ09NUE9ORU5UJDEgPSA2NDAyOwogICAgICB2YXIgY29sb3JUZXh0dXJlRm9ybWF0RW51bXMgPSBbCiAgICAgICAgR0xfUkdCJDEsCiAgICAgICAgR0xfUkdCQSQyCiAgICAgIF07CiAgICAgIHZhciB0ZXh0dXJlRm9ybWF0Q2hhbm5lbHMgPSBbXTsKICAgICAgdGV4dHVyZUZvcm1hdENoYW5uZWxzW0dMX1JHQkEkMl0gPSA0OwogICAgICB0ZXh0dXJlRm9ybWF0Q2hhbm5lbHNbR0xfUkdCJDFdID0gMzsKICAgICAgdmFyIHRleHR1cmVUeXBlU2l6ZXMgPSBbXTsKICAgICAgdGV4dHVyZVR5cGVTaXplc1tHTF9VTlNJR05FRF9CWVRFJDZdID0gMTsKICAgICAgdGV4dHVyZVR5cGVTaXplc1tHTF9GTE9BVCQ1XSA9IDQ7CiAgICAgIHRleHR1cmVUeXBlU2l6ZXNbR0xfSEFMRl9GTE9BVF9PRVMkMl0gPSAyOwogICAgICB2YXIgR0xfUkdCQTQkMiA9IDMyODU0OwogICAgICB2YXIgR0xfUkdCNV9BMSQyID0gMzI4NTU7CiAgICAgIHZhciBHTF9SR0I1NjUkMiA9IDM2MTk0OwogICAgICB2YXIgR0xfREVQVEhfQ09NUE9ORU5UMTYkMSA9IDMzMTg5OwogICAgICB2YXIgR0xfU1RFTkNJTF9JTkRFWDgkMSA9IDM2MTY4OwogICAgICB2YXIgR0xfREVQVEhfU1RFTkNJTCQyID0gMzQwNDE7CiAgICAgIHZhciBHTF9TUkdCOF9BTFBIQThfRVhUJDEgPSAzNTkwNzsKICAgICAgdmFyIEdMX1JHQkEzMkZfRVhUJDEgPSAzNDgzNjsKICAgICAgdmFyIEdMX1JHQkExNkZfRVhUJDEgPSAzNDg0MjsKICAgICAgdmFyIEdMX1JHQjE2Rl9FWFQkMSA9IDM0ODQzOwogICAgICB2YXIgY29sb3JSZW5kZXJidWZmZXJGb3JtYXRFbnVtcyA9IFsKICAgICAgICBHTF9SR0JBNCQyLAogICAgICAgIEdMX1JHQjVfQTEkMiwKICAgICAgICBHTF9SR0I1NjUkMiwKICAgICAgICBHTF9TUkdCOF9BTFBIQThfRVhUJDEsCiAgICAgICAgR0xfUkdCQTE2Rl9FWFQkMSwKICAgICAgICBHTF9SR0IxNkZfRVhUJDEsCiAgICAgICAgR0xfUkdCQTMyRl9FWFQkMQogICAgICBdOwogICAgICB2YXIgc3RhdHVzQ29kZSA9IHt9OwogICAgICBzdGF0dXNDb2RlW0dMX0ZSQU1FQlVGRkVSX0NPTVBMRVRFJDFdID0gImNvbXBsZXRlIjsKICAgICAgc3RhdHVzQ29kZVtHTF9GUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlRdID0gImluY29tcGxldGUgYXR0YWNobWVudCI7CiAgICAgIHN0YXR1c0NvZGVbR0xfRlJBTUVCVUZGRVJfSU5DT01QTEVURV9ESU1FTlNJT05TXSA9ICJpbmNvbXBsZXRlIGRpbWVuc2lvbnMiOwogICAgICBzdGF0dXNDb2RlW0dMX0ZSQU1FQlVGRkVSX0lOQ09NUExFVEVfTUlTU0lOR19BVFRBQ0hNRU5UXSA9ICJpbmNvbXBsZXRlLCBtaXNzaW5nIGF0dGFjaG1lbnQiOwogICAgICBzdGF0dXNDb2RlW0dMX0ZSQU1FQlVGRkVSX1VOU1VQUE9SVEVEXSA9ICJ1bnN1cHBvcnRlZCI7CiAgICAgIGZ1bmN0aW9uIHdyYXBGQk9TdGF0ZShnbCwgZXh0ZW5zaW9ucywgbGltaXRzLCB0ZXh0dXJlU3RhdGUsIHJlbmRlcmJ1ZmZlclN0YXRlLCBzdGF0czIpIHsKICAgICAgICB2YXIgZnJhbWVidWZmZXJTdGF0ZSA9IHsKICAgICAgICAgIGN1cjogbnVsbCwKICAgICAgICAgIG5leHQ6IG51bGwsCiAgICAgICAgICBkaXJ0eTogZmFsc2UsCiAgICAgICAgICBzZXRGQk86IG51bGwKICAgICAgICB9OwogICAgICAgIHZhciBjb2xvclRleHR1cmVGb3JtYXRzID0gWyJyZ2JhIl07CiAgICAgICAgdmFyIGNvbG9yUmVuZGVyYnVmZmVyRm9ybWF0cyA9IFsicmdiYTQiLCAicmdiNTY1IiwgInJnYjUgYTEiXTsKICAgICAgICBpZiAoZXh0ZW5zaW9ucy5leHRfc3JnYikgewogICAgICAgICAgY29sb3JSZW5kZXJidWZmZXJGb3JtYXRzLnB1c2goInNyZ2JhIik7CiAgICAgICAgfQogICAgICAgIGlmIChleHRlbnNpb25zLmV4dF9jb2xvcl9idWZmZXJfaGFsZl9mbG9hdCkgewogICAgICAgICAgY29sb3JSZW5kZXJidWZmZXJGb3JtYXRzLnB1c2goInJnYmExNmYiLCAicmdiMTZmIik7CiAgICAgICAgfQogICAgICAgIGlmIChleHRlbnNpb25zLndlYmdsX2NvbG9yX2J1ZmZlcl9mbG9hdCkgewogICAgICAgICAgY29sb3JSZW5kZXJidWZmZXJGb3JtYXRzLnB1c2goInJnYmEzMmYiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbG9yVHlwZXMgPSBbInVpbnQ4Il07CiAgICAgICAgaWYgKGV4dGVuc2lvbnMub2VzX3RleHR1cmVfaGFsZl9mbG9hdCkgewogICAgICAgICAgY29sb3JUeXBlcy5wdXNoKCJoYWxmIGZsb2F0IiwgImZsb2F0MTYiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGV4dGVuc2lvbnMub2VzX3RleHR1cmVfZmxvYXQpIHsKICAgICAgICAgIGNvbG9yVHlwZXMucHVzaCgiZmxvYXQiLCAiZmxvYXQzMiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGcmFtZWJ1ZmZlckF0dGFjaG1lbnQodGFyZ2V0LCB0ZXh0dXJlLCByZW5kZXJidWZmZXIpIHsKICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKICAgICAgICAgIHRoaXMucmVuZGVyYnVmZmVyID0gcmVuZGVyYnVmZmVyOwogICAgICAgICAgdmFyIHcgPSAwOwogICAgICAgICAgdmFyIGggPSAwOwogICAgICAgICAgaWYgKHRleHR1cmUpIHsKICAgICAgICAgICAgdyA9IHRleHR1cmUud2lkdGg7CiAgICAgICAgICAgIGggPSB0ZXh0dXJlLmhlaWdodDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVuZGVyYnVmZmVyKSB7CiAgICAgICAgICAgIHcgPSByZW5kZXJidWZmZXIud2lkdGg7CiAgICAgICAgICAgIGggPSByZW5kZXJidWZmZXIuaGVpZ2h0OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy53aWR0aCA9IHc7CiAgICAgICAgICB0aGlzLmhlaWdodCA9IGg7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlY1JlZihhdHRhY2htZW50KSB7CiAgICAgICAgICBpZiAoYXR0YWNobWVudCkgewogICAgICAgICAgICBpZiAoYXR0YWNobWVudC50ZXh0dXJlKSB7CiAgICAgICAgICAgICAgYXR0YWNobWVudC50ZXh0dXJlLl90ZXh0dXJlLmRlY1JlZigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRhY2htZW50LnJlbmRlcmJ1ZmZlcikgewogICAgICAgICAgICAgIGF0dGFjaG1lbnQucmVuZGVyYnVmZmVyLl9yZW5kZXJidWZmZXIuZGVjUmVmKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jUmVmQW5kQ2hlY2tTaGFwZShhdHRhY2htZW50LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICBpZiAoIWF0dGFjaG1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGF0dGFjaG1lbnQudGV4dHVyZSkgewogICAgICAgICAgICB2YXIgdGV4dHVyZSA9IGF0dGFjaG1lbnQudGV4dHVyZS5fdGV4dHVyZTsKICAgICAgICAgICAgdmFyIHR3ID0gTWF0aC5tYXgoMSwgdGV4dHVyZS53aWR0aCk7CiAgICAgICAgICAgIHZhciB0aCA9IE1hdGgubWF4KDEsIHRleHR1cmUuaGVpZ2h0KTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB0dyA9PT0gd2lkdGggJiYgdGggPT09IGhlaWdodCwKICAgICAgICAgICAgICAiaW5jb25zaXN0ZW50IHdpZHRoL2hlaWdodCBmb3Igc3VwcGxpZWQgdGV4dHVyZSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGV4dHVyZS5yZWZDb3VudCArPSAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlbmRlcmJ1ZmZlciA9IGF0dGFjaG1lbnQucmVuZGVyYnVmZmVyLl9yZW5kZXJidWZmZXI7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgcmVuZGVyYnVmZmVyLndpZHRoID09PSB3aWR0aCAmJiByZW5kZXJidWZmZXIuaGVpZ2h0ID09PSBoZWlnaHQsCiAgICAgICAgICAgICAgImluY29uc2lzdGVudCB3aWR0aC9oZWlnaHQgZm9yIHJlbmRlcmJ1ZmZlciIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmVuZGVyYnVmZmVyLnJlZkNvdW50ICs9IDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaChsb2NhdGlvbiwgYXR0YWNobWVudCkgewogICAgICAgICAgaWYgKGF0dGFjaG1lbnQpIHsKICAgICAgICAgICAgaWYgKGF0dGFjaG1lbnQudGV4dHVyZSkgewogICAgICAgICAgICAgIGdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKAogICAgICAgICAgICAgICAgR0xfRlJBTUVCVUZGRVIkMSwKICAgICAgICAgICAgICAgIGxvY2F0aW9uLAogICAgICAgICAgICAgICAgYXR0YWNobWVudC50YXJnZXQsCiAgICAgICAgICAgICAgICBhdHRhY2htZW50LnRleHR1cmUuX3RleHR1cmUudGV4dHVyZSwKICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdsLmZyYW1lYnVmZmVyUmVuZGVyYnVmZmVyKAogICAgICAgICAgICAgICAgR0xfRlJBTUVCVUZGRVIkMSwKICAgICAgICAgICAgICAgIGxvY2F0aW9uLAogICAgICAgICAgICAgICAgR0xfUkVOREVSQlVGRkVSJDEsCiAgICAgICAgICAgICAgICBhdHRhY2htZW50LnJlbmRlcmJ1ZmZlci5fcmVuZGVyYnVmZmVyLnJlbmRlcmJ1ZmZlcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VBdHRhY2htZW50KGF0dGFjaG1lbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBHTF9URVhUVVJFXzJEJDI7CiAgICAgICAgICB2YXIgdGV4dHVyZSA9IG51bGw7CiAgICAgICAgICB2YXIgcmVuZGVyYnVmZmVyID0gbnVsbDsKICAgICAgICAgIHZhciBkYXRhID0gYXR0YWNobWVudDsKICAgICAgICAgIGlmICh0eXBlb2YgYXR0YWNobWVudCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgZGF0YSA9IGF0dGFjaG1lbnQuZGF0YTsKICAgICAgICAgICAgaWYgKCJ0YXJnZXQiIGluIGF0dGFjaG1lbnQpIHsKICAgICAgICAgICAgICB0YXJnZXQgPSBhdHRhY2htZW50LnRhcmdldCB8IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNoZWNrJDEudHlwZShkYXRhLCAiZnVuY3Rpb24iLCAiaW52YWxpZCBhdHRhY2htZW50IGRhdGEiKTsKICAgICAgICAgIHZhciB0eXBlID0gZGF0YS5fcmVnbFR5cGU7CiAgICAgICAgICBpZiAodHlwZSA9PT0gInRleHR1cmUyZCIpIHsKICAgICAgICAgICAgdGV4dHVyZSA9IGRhdGE7CiAgICAgICAgICAgIGNoZWNrJDEodGFyZ2V0ID09PSBHTF9URVhUVVJFXzJEJDIpOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAidGV4dHVyZUN1YmUiKSB7CiAgICAgICAgICAgIHRleHR1cmUgPSBkYXRhOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIHRhcmdldCA+PSBHTF9URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1gkMiAmJiB0YXJnZXQgPCBHTF9URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1gkMiArIDYsCiAgICAgICAgICAgICAgImludmFsaWQgY3ViZSBtYXAgdGFyZ2V0IgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAicmVuZGVyYnVmZmVyIikgewogICAgICAgICAgICByZW5kZXJidWZmZXIgPSBkYXRhOwogICAgICAgICAgICB0YXJnZXQgPSBHTF9SRU5ERVJCVUZGRVIkMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoZWNrJDEucmFpc2UoImludmFsaWQgcmVnbCBvYmplY3QgZm9yIGF0dGFjaG1lbnQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgRnJhbWVidWZmZXJBdHRhY2htZW50KHRhcmdldCwgdGV4dHVyZSwgcmVuZGVyYnVmZmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWxsb2NBdHRhY2htZW50KHdpZHRoLCBoZWlnaHQsIGlzVGV4dHVyZSwgZm9ybWF0MiwgdHlwZSkgewogICAgICAgICAgaWYgKGlzVGV4dHVyZSkgewogICAgICAgICAgICB2YXIgdGV4dHVyZSA9IHRleHR1cmVTdGF0ZS5jcmVhdGUyRCh7CiAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGZvcm1hdDogZm9ybWF0MiwKICAgICAgICAgICAgICB0eXBlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0ZXh0dXJlLl90ZXh0dXJlLnJlZkNvdW50ID0gMDsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGcmFtZWJ1ZmZlckF0dGFjaG1lbnQoR0xfVEVYVFVSRV8yRCQyLCB0ZXh0dXJlLCBudWxsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByYiA9IHJlbmRlcmJ1ZmZlclN0YXRlLmNyZWF0ZSh7CiAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGZvcm1hdDogZm9ybWF0MgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmIuX3JlbmRlcmJ1ZmZlci5yZWZDb3VudCA9IDA7CiAgICAgICAgICAgIHJldHVybiBuZXcgRnJhbWVidWZmZXJBdHRhY2htZW50KEdMX1JFTkRFUkJVRkZFUiQxLCBudWxsLCByYik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud3JhcEF0dGFjaG1lbnQoYXR0YWNobWVudCkgewogICAgICAgICAgcmV0dXJuIGF0dGFjaG1lbnQgJiYgKGF0dGFjaG1lbnQudGV4dHVyZSB8fCBhdHRhY2htZW50LnJlbmRlcmJ1ZmZlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2l6ZUF0dGFjaG1lbnQoYXR0YWNobWVudCwgdywgaCkgewogICAgICAgICAgaWYgKGF0dGFjaG1lbnQpIHsKICAgICAgICAgICAgaWYgKGF0dGFjaG1lbnQudGV4dHVyZSkgewogICAgICAgICAgICAgIGF0dGFjaG1lbnQudGV4dHVyZS5yZXNpemUodywgaCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0YWNobWVudC5yZW5kZXJidWZmZXIpIHsKICAgICAgICAgICAgICBhdHRhY2htZW50LnJlbmRlcmJ1ZmZlci5yZXNpemUodywgaCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXR0YWNobWVudC53aWR0aCA9IHc7CiAgICAgICAgICAgIGF0dGFjaG1lbnQuaGVpZ2h0ID0gaDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZyYW1lYnVmZmVyQ291bnQgPSAwOwogICAgICAgIHZhciBmcmFtZWJ1ZmZlclNldCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIFJFR0xGcmFtZWJ1ZmZlcigpIHsKICAgICAgICAgIHRoaXMuaWQgPSBmcmFtZWJ1ZmZlckNvdW50Kys7CiAgICAgICAgICBmcmFtZWJ1ZmZlclNldFt0aGlzLmlkXSA9IHRoaXM7CiAgICAgICAgICB0aGlzLmZyYW1lYnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKICAgICAgICAgIHRoaXMud2lkdGggPSAwOwogICAgICAgICAgdGhpcy5oZWlnaHQgPSAwOwogICAgICAgICAgdGhpcy5jb2xvckF0dGFjaG1lbnRzID0gW107CiAgICAgICAgICB0aGlzLmRlcHRoQXR0YWNobWVudCA9IG51bGw7CiAgICAgICAgICB0aGlzLnN0ZW5jaWxBdHRhY2htZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVwdGhTdGVuY2lsQXR0YWNobWVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlY0ZCT1JlZnMoZnJhbWVidWZmZXIpIHsKICAgICAgICAgIGZyYW1lYnVmZmVyLmNvbG9yQXR0YWNobWVudHMuZm9yRWFjaChkZWNSZWYpOwogICAgICAgICAgZGVjUmVmKGZyYW1lYnVmZmVyLmRlcHRoQXR0YWNobWVudCk7CiAgICAgICAgICBkZWNSZWYoZnJhbWVidWZmZXIuc3RlbmNpbEF0dGFjaG1lbnQpOwogICAgICAgICAgZGVjUmVmKGZyYW1lYnVmZmVyLmRlcHRoU3RlbmNpbEF0dGFjaG1lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXN0cm95KGZyYW1lYnVmZmVyKSB7CiAgICAgICAgICB2YXIgaGFuZGxlID0gZnJhbWVidWZmZXIuZnJhbWVidWZmZXI7CiAgICAgICAgICBjaGVjayQxKGhhbmRsZSwgIm11c3Qgbm90IGRvdWJsZSBkZXN0cm95IGZyYW1lYnVmZmVyIik7CiAgICAgICAgICBnbC5kZWxldGVGcmFtZWJ1ZmZlcihoYW5kbGUpOwogICAgICAgICAgZnJhbWVidWZmZXIuZnJhbWVidWZmZXIgPSBudWxsOwogICAgICAgICAgc3RhdHMyLmZyYW1lYnVmZmVyQ291bnQtLTsKICAgICAgICAgIGRlbGV0ZSBmcmFtZWJ1ZmZlclNldFtmcmFtZWJ1ZmZlci5pZF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYW1lYnVmZmVyKGZyYW1lYnVmZmVyKSB7CiAgICAgICAgICB2YXIgaTsKICAgICAgICAgIGdsLmJpbmRGcmFtZWJ1ZmZlcihHTF9GUkFNRUJVRkZFUiQxLCBmcmFtZWJ1ZmZlci5mcmFtZWJ1ZmZlcik7CiAgICAgICAgICB2YXIgY29sb3JBdHRhY2htZW50cyA9IGZyYW1lYnVmZmVyLmNvbG9yQXR0YWNobWVudHM7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29sb3JBdHRhY2htZW50cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBhdHRhY2goR0xfQ09MT1JfQVRUQUNITUVOVDAkMSArIGksIGNvbG9yQXR0YWNobWVudHNbaV0pOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gY29sb3JBdHRhY2htZW50cy5sZW5ndGg7IGkgPCBsaW1pdHMubWF4Q29sb3JBdHRhY2htZW50czsgKytpKSB7CiAgICAgICAgICAgIGdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKAogICAgICAgICAgICAgIEdMX0ZSQU1FQlVGRkVSJDEsCiAgICAgICAgICAgICAgR0xfQ09MT1JfQVRUQUNITUVOVDAkMSArIGksCiAgICAgICAgICAgICAgR0xfVEVYVFVSRV8yRCQyLAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgMAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoCiAgICAgICAgICAgIEdMX0ZSQU1FQlVGRkVSJDEsCiAgICAgICAgICAgIEdMX0RFUFRIX1NURU5DSUxfQVRUQUNITUVOVCwKICAgICAgICAgICAgR0xfVEVYVFVSRV8yRCQyLAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAwCiAgICAgICAgICApOwogICAgICAgICAgZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoCiAgICAgICAgICAgIEdMX0ZSQU1FQlVGRkVSJDEsCiAgICAgICAgICAgIEdMX0RFUFRIX0FUVEFDSE1FTlQsCiAgICAgICAgICAgIEdMX1RFWFRVUkVfMkQkMiwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgMAogICAgICAgICAgKTsKICAgICAgICAgIGdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKAogICAgICAgICAgICBHTF9GUkFNRUJVRkZFUiQxLAogICAgICAgICAgICBHTF9TVEVOQ0lMX0FUVEFDSE1FTlQsCiAgICAgICAgICAgIEdMX1RFWFRVUkVfMkQkMiwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgMAogICAgICAgICAgKTsKICAgICAgICAgIGF0dGFjaChHTF9ERVBUSF9BVFRBQ0hNRU5ULCBmcmFtZWJ1ZmZlci5kZXB0aEF0dGFjaG1lbnQpOwogICAgICAgICAgYXR0YWNoKEdMX1NURU5DSUxfQVRUQUNITUVOVCwgZnJhbWVidWZmZXIuc3RlbmNpbEF0dGFjaG1lbnQpOwogICAgICAgICAgYXR0YWNoKEdMX0RFUFRIX1NURU5DSUxfQVRUQUNITUVOVCwgZnJhbWVidWZmZXIuZGVwdGhTdGVuY2lsQXR0YWNobWVudCk7CiAgICAgICAgICB2YXIgc3RhdHVzID0gZ2wuY2hlY2tGcmFtZWJ1ZmZlclN0YXR1cyhHTF9GUkFNRUJVRkZFUiQxKTsKICAgICAgICAgIGlmICghZ2wuaXNDb250ZXh0TG9zdCgpICYmIHN0YXR1cyAhPT0gR0xfRlJBTUVCVUZGRVJfQ09NUExFVEUkMSkgewogICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJmcmFtZWJ1ZmZlciBjb25maWd1cmF0aW9uIG5vdCBzdXBwb3J0ZWQsIHN0YXR1cyA9ICIgKyBzdGF0dXNDb2RlW3N0YXR1c10pOwogICAgICAgICAgfQogICAgICAgICAgZ2wuYmluZEZyYW1lYnVmZmVyKEdMX0ZSQU1FQlVGRkVSJDEsIGZyYW1lYnVmZmVyU3RhdGUubmV4dCA/IGZyYW1lYnVmZmVyU3RhdGUubmV4dC5mcmFtZWJ1ZmZlciA6IG51bGwpOwogICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5jdXIgPSBmcmFtZWJ1ZmZlclN0YXRlLm5leHQ7CiAgICAgICAgICBnbC5nZXRFcnJvcigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGQk8oYTAsIGExKSB7CiAgICAgICAgICB2YXIgZnJhbWVidWZmZXIgPSBuZXcgUkVHTEZyYW1lYnVmZmVyKCk7CiAgICAgICAgICBzdGF0czIuZnJhbWVidWZmZXJDb3VudCsrOwogICAgICAgICAgZnVuY3Rpb24gcmVnbEZyYW1lYnVmZmVyKGEsIGIpIHsKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5uZXh0ICE9PSBmcmFtZWJ1ZmZlciwKICAgICAgICAgICAgICAiY2FuIG5vdCB1cGRhdGUgZnJhbWVidWZmZXIgd2hpY2ggaXMgY3VycmVudGx5IGluIHVzZSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIHdpZHRoID0gMDsKICAgICAgICAgICAgdmFyIGhlaWdodCA9IDA7CiAgICAgICAgICAgIHZhciBuZWVkc0RlcHRoID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG5lZWRzU3RlbmNpbCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb2xvckJ1ZmZlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBjb2xvclRleHR1cmUgPSB0cnVlOwogICAgICAgICAgICB2YXIgY29sb3JGb3JtYXQgPSAicmdiYSI7CiAgICAgICAgICAgIHZhciBjb2xvclR5cGUgPSAidWludDgiOwogICAgICAgICAgICB2YXIgY29sb3JDb3VudCA9IDE7CiAgICAgICAgICAgIHZhciBkZXB0aEJ1ZmZlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBzdGVuY2lsQnVmZmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIGRlcHRoU3RlbmNpbEJ1ZmZlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBkZXB0aFN0ZW5jaWxUZXh0dXJlID0gZmFsc2U7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB3aWR0aCA9IGEgfCAwOwogICAgICAgICAgICAgIGhlaWdodCA9IGIgfCAwIHx8IHdpZHRoOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFhKSB7CiAgICAgICAgICAgICAgd2lkdGggPSBoZWlnaHQgPSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoZWNrJDEudHlwZShhLCAib2JqZWN0IiwgImludmFsaWQgYXJndW1lbnRzIGZvciBmcmFtZWJ1ZmZlciIpOwogICAgICAgICAgICAgIHZhciBvcHRpb25zID0gYTsKICAgICAgICAgICAgICBpZiAoInNoYXBlIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgc2hhcGUgPSBvcHRpb25zLnNoYXBlOwogICAgICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAgICAgQXJyYXkuaXNBcnJheShzaGFwZSkgJiYgc2hhcGUubGVuZ3RoID49IDIsCiAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHNoYXBlIGZvciBmcmFtZWJ1ZmZlciIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHNoYXBlWzBdOwogICAgICAgICAgICAgICAgaGVpZ2h0ID0gc2hhcGVbMV07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgicmFkaXVzIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIHdpZHRoID0gaGVpZ2h0ID0gb3B0aW9ucy5yYWRpdXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIndpZHRoIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgiaGVpZ2h0IiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGhlaWdodCA9IG9wdGlvbnMuaGVpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoImNvbG9yIiBpbiBvcHRpb25zIHx8ICJjb2xvcnMiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyID0gb3B0aW9ucy5jb2xvciB8fCBvcHRpb25zLmNvbG9yczsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbG9yQnVmZmVyKSkgewogICAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyLmxlbmd0aCA9PT0gMSB8fCBleHRlbnNpb25zLndlYmdsX2RyYXdfYnVmZmVycywKICAgICAgICAgICAgICAgICAgICAibXVsdGlwbGUgcmVuZGVyIHRhcmdldHMgbm90IHN1cHBvcnRlZCIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFjb2xvckJ1ZmZlcikgewogICAgICAgICAgICAgICAgaWYgKCJjb2xvckNvdW50IiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGNvbG9yQ291bnQgPSBvcHRpb25zLmNvbG9yQ291bnQgfCAwOwogICAgICAgICAgICAgICAgICBjaGVjayQxKGNvbG9yQ291bnQgPiAwLCAiaW52YWxpZCBjb2xvciBidWZmZXIgY291bnQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgiY29sb3JUZXh0dXJlIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGNvbG9yVGV4dHVyZSA9ICEhb3B0aW9ucy5jb2xvclRleHR1cmU7CiAgICAgICAgICAgICAgICAgIGNvbG9yRm9ybWF0ID0gInJnYmE0IjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgiY29sb3JUeXBlIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGNvbG9yVHlwZSA9IG9wdGlvbnMuY29sb3JUeXBlOwogICAgICAgICAgICAgICAgICBpZiAoIWNvbG9yVGV4dHVyZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb2xvclR5cGUgPT09ICJoYWxmIGZsb2F0IiB8fCBjb2xvclR5cGUgPT09ICJmbG9hdDE2IikgewogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5leHRfY29sb3JfYnVmZmVyX2hhbGZfZmxvYXQsCiAgICAgICAgICAgICAgICAgICAgICAgICJ5b3UgbXVzdCBlbmFibGUgRVhUX2NvbG9yX2J1ZmZlcl9oYWxmX2Zsb2F0IHRvIHVzZSAxNi1iaXQgcmVuZGVyIGJ1ZmZlcnMiCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgY29sb3JGb3JtYXQgPSAicmdiYTE2ZiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2xvclR5cGUgPT09ICJmbG9hdCIgfHwgY29sb3JUeXBlID09PSAiZmxvYXQzMiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbnMud2ViZ2xfY29sb3JfYnVmZmVyX2Zsb2F0LAogICAgICAgICAgICAgICAgICAgICAgICAieW91IG11c3QgZW5hYmxlIFdFQkdMX2NvbG9yX2J1ZmZlcl9mbG9hdCBpbiBvcmRlciB0byB1c2UgMzItYml0IGZsb2F0aW5nIHBvaW50IHJlbmRlcmJ1ZmZlcnMiCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgY29sb3JGb3JtYXQgPSAicmdiYTMyZiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAgICAgICBleHRlbnNpb25zLm9lc190ZXh0dXJlX2Zsb2F0IHx8ICEoY29sb3JUeXBlID09PSAiZmxvYXQiIHx8IGNvbG9yVHlwZSA9PT0gImZsb2F0MzIiKSwKICAgICAgICAgICAgICAgICAgICAgICJ5b3UgbXVzdCBlbmFibGUgT0VTX3RleHR1cmVfZmxvYXQgaW4gb3JkZXIgdG8gdXNlIGZsb2F0aW5nIHBvaW50IGZyYW1lYnVmZmVyIG9iamVjdHMiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5vZXNfdGV4dHVyZV9oYWxmX2Zsb2F0IHx8ICEoY29sb3JUeXBlID09PSAiaGFsZiBmbG9hdCIgfHwgY29sb3JUeXBlID09PSAiZmxvYXQxNiIpLAogICAgICAgICAgICAgICAgICAgICAgInlvdSBtdXN0IGVuYWJsZSBPRVNfdGV4dHVyZV9oYWxmX2Zsb2F0IGluIG9yZGVyIHRvIHVzZSAxNi1iaXQgZmxvYXRpbmcgcG9pbnQgZnJhbWVidWZmZXIgb2JqZWN0cyIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEub25lT2YoY29sb3JUeXBlLCBjb2xvclR5cGVzLCAiaW52YWxpZCBjb2xvciB0eXBlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoImNvbG9yRm9ybWF0IiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIGNvbG9yRm9ybWF0ID0gb3B0aW9ucy5jb2xvckZvcm1hdDsKICAgICAgICAgICAgICAgICAgaWYgKGNvbG9yVGV4dHVyZUZvcm1hdHMuaW5kZXhPZihjb2xvckZvcm1hdCkgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbG9yVGV4dHVyZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sb3JSZW5kZXJidWZmZXJGb3JtYXRzLmluZGV4T2YoY29sb3JGb3JtYXQpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb2xvclRleHR1cmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbG9yVGV4dHVyZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9uZU9mKAogICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY29sb3JGb3JtYXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JUZXh0dXJlRm9ybWF0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBjb2xvciBmb3JtYXQgZm9yIHRleHR1cmUiCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9uZU9mKAogICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY29sb3JGb3JtYXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JSZW5kZXJidWZmZXJGb3JtYXRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGNvbG9yIGZvcm1hdCBmb3IgcmVuZGVyYnVmZmVyIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgiZGVwdGhUZXh0dXJlIiBpbiBvcHRpb25zIHx8ICJkZXB0aFN0ZW5jaWxUZXh0dXJlIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBkZXB0aFN0ZW5jaWxUZXh0dXJlID0gISEob3B0aW9ucy5kZXB0aFRleHR1cmUgfHwgb3B0aW9ucy5kZXB0aFN0ZW5jaWxUZXh0dXJlKTsKICAgICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAgICFkZXB0aFN0ZW5jaWxUZXh0dXJlIHx8IGV4dGVuc2lvbnMud2ViZ2xfZGVwdGhfdGV4dHVyZSwKICAgICAgICAgICAgICAgICAgIndlYmdsX2RlcHRoX3RleHR1cmUgZXh0ZW5zaW9uIG5vdCBzdXBwb3J0ZWQiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoImRlcHRoIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZGVwdGggPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgICBuZWVkc0RlcHRoID0gb3B0aW9ucy5kZXB0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoQnVmZmVyID0gb3B0aW9ucy5kZXB0aDsKICAgICAgICAgICAgICAgICAgbmVlZHNTdGVuY2lsID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgic3RlbmNpbCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLnN0ZW5jaWwgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgICBuZWVkc1N0ZW5jaWwgPSBvcHRpb25zLnN0ZW5jaWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdGVuY2lsQnVmZmVyID0gb3B0aW9ucy5zdGVuY2lsOwogICAgICAgICAgICAgICAgICBuZWVkc0RlcHRoID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgiZGVwdGhTdGVuY2lsIiBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZGVwdGhTdGVuY2lsID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNEZXB0aCA9IG5lZWRzU3RlbmNpbCA9IG9wdGlvbnMuZGVwdGhTdGVuY2lsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGVwdGhTdGVuY2lsQnVmZmVyID0gb3B0aW9ucy5kZXB0aFN0ZW5jaWw7CiAgICAgICAgICAgICAgICAgIG5lZWRzRGVwdGggPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgbmVlZHNTdGVuY2lsID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb2xvckF0dGFjaG1lbnRzID0gbnVsbDsKICAgICAgICAgICAgdmFyIGRlcHRoQXR0YWNobWVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzdGVuY2lsQXR0YWNobWVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBkZXB0aFN0ZW5jaWxBdHRhY2htZW50ID0gbnVsbDsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29sb3JCdWZmZXIpKSB7CiAgICAgICAgICAgICAgY29sb3JBdHRhY2htZW50cyA9IGNvbG9yQnVmZmVyLm1hcChwYXJzZUF0dGFjaG1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbG9yQnVmZmVyKSB7CiAgICAgICAgICAgICAgY29sb3JBdHRhY2htZW50cyA9IFtwYXJzZUF0dGFjaG1lbnQoY29sb3JCdWZmZXIpXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb2xvckF0dGFjaG1lbnRzID0gbmV3IEFycmF5KGNvbG9yQ291bnQpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2xvckNvdW50OyArK2kpIHsKICAgICAgICAgICAgICAgIGNvbG9yQXR0YWNobWVudHNbaV0gPSBhbGxvY0F0dGFjaG1lbnQoCiAgICAgICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICAgIGNvbG9yVGV4dHVyZSwKICAgICAgICAgICAgICAgICAgY29sb3JGb3JtYXQsCiAgICAgICAgICAgICAgICAgIGNvbG9yVHlwZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICBleHRlbnNpb25zLndlYmdsX2RyYXdfYnVmZmVycyB8fCBjb2xvckF0dGFjaG1lbnRzLmxlbmd0aCA8PSAxLAogICAgICAgICAgICAgICJ5b3UgbXVzdCBlbmFibGUgdGhlIFdFQkdMX2RyYXdfYnVmZmVycyBleHRlbnNpb24gaW4gb3JkZXIgdG8gdXNlIG11bHRpcGxlIGNvbG9yIGJ1ZmZlcnMuIgogICAgICAgICAgICApOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIGNvbG9yQXR0YWNobWVudHMubGVuZ3RoIDw9IGxpbWl0cy5tYXhDb2xvckF0dGFjaG1lbnRzLAogICAgICAgICAgICAgICJ0b28gbWFueSBjb2xvciBhdHRhY2htZW50cywgbm90IHN1cHBvcnRlZCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgd2lkdGggPSB3aWR0aCB8fCBjb2xvckF0dGFjaG1lbnRzWzBdLndpZHRoOwogICAgICAgICAgICBoZWlnaHQgPSBoZWlnaHQgfHwgY29sb3JBdHRhY2htZW50c1swXS5oZWlnaHQ7CiAgICAgICAgICAgIGlmIChkZXB0aEJ1ZmZlcikgewogICAgICAgICAgICAgIGRlcHRoQXR0YWNobWVudCA9IHBhcnNlQXR0YWNobWVudChkZXB0aEJ1ZmZlcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmVlZHNEZXB0aCAmJiAhbmVlZHNTdGVuY2lsKSB7CiAgICAgICAgICAgICAgZGVwdGhBdHRhY2htZW50ID0gYWxsb2NBdHRhY2htZW50KAogICAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBkZXB0aFN0ZW5jaWxUZXh0dXJlLAogICAgICAgICAgICAgICAgImRlcHRoIiwKICAgICAgICAgICAgICAgICJ1aW50MzIiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RlbmNpbEJ1ZmZlcikgewogICAgICAgICAgICAgIHN0ZW5jaWxBdHRhY2htZW50ID0gcGFyc2VBdHRhY2htZW50KHN0ZW5jaWxCdWZmZXIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5lZWRzU3RlbmNpbCAmJiAhbmVlZHNEZXB0aCkgewogICAgICAgICAgICAgIHN0ZW5jaWxBdHRhY2htZW50ID0gYWxsb2NBdHRhY2htZW50KAogICAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICJzdGVuY2lsIiwKICAgICAgICAgICAgICAgICJ1aW50OCIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZXB0aFN0ZW5jaWxCdWZmZXIpIHsKICAgICAgICAgICAgICBkZXB0aFN0ZW5jaWxBdHRhY2htZW50ID0gcGFyc2VBdHRhY2htZW50KGRlcHRoU3RlbmNpbEJ1ZmZlcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRlcHRoQnVmZmVyICYmICFzdGVuY2lsQnVmZmVyICYmIG5lZWRzU3RlbmNpbCAmJiBuZWVkc0RlcHRoKSB7CiAgICAgICAgICAgICAgZGVwdGhTdGVuY2lsQXR0YWNobWVudCA9IGFsbG9jQXR0YWNobWVudCgKICAgICAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgICAgZGVwdGhTdGVuY2lsVGV4dHVyZSwKICAgICAgICAgICAgICAgICJkZXB0aCBzdGVuY2lsIiwKICAgICAgICAgICAgICAgICJkZXB0aCBzdGVuY2lsIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAhIWRlcHRoQnVmZmVyICsgISFzdGVuY2lsQnVmZmVyICsgISFkZXB0aFN0ZW5jaWxCdWZmZXIgPD0gMSwKICAgICAgICAgICAgICAiaW52YWxpZCBmcmFtZWJ1ZmZlciBjb25maWd1cmF0aW9uLCBjYW4gc3BlY2lmeSBleGFjdGx5IG9uZSBkZXB0aC9zdGVuY2lsIGF0dGFjaG1lbnQiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHZhciBjb21tb25Db2xvckF0dGFjaG1lbnRTaXplID0gbnVsbDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbG9yQXR0YWNobWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBpbmNSZWZBbmRDaGVja1NoYXBlKGNvbG9yQXR0YWNobWVudHNbaV0sIHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAhY29sb3JBdHRhY2htZW50c1tpXSB8fCBjb2xvckF0dGFjaG1lbnRzW2ldLnRleHR1cmUgJiYgY29sb3JUZXh0dXJlRm9ybWF0RW51bXMuaW5kZXhPZihjb2xvckF0dGFjaG1lbnRzW2ldLnRleHR1cmUuX3RleHR1cmUuZm9ybWF0KSA+PSAwIHx8IGNvbG9yQXR0YWNobWVudHNbaV0ucmVuZGVyYnVmZmVyICYmIGNvbG9yUmVuZGVyYnVmZmVyRm9ybWF0RW51bXMuaW5kZXhPZihjb2xvckF0dGFjaG1lbnRzW2ldLnJlbmRlcmJ1ZmZlci5fcmVuZGVyYnVmZmVyLmZvcm1hdCkgPj0gMCwKICAgICAgICAgICAgICAgICJmcmFtZWJ1ZmZlciBjb2xvciBhdHRhY2htZW50ICIgKyBpICsgIiBpcyBpbnZhbGlkIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGNvbG9yQXR0YWNobWVudHNbaV0gJiYgY29sb3JBdHRhY2htZW50c1tpXS50ZXh0dXJlKSB7CiAgICAgICAgICAgICAgICB2YXIgY29sb3JBdHRhY2htZW50U2l6ZSA9IHRleHR1cmVGb3JtYXRDaGFubmVsc1tjb2xvckF0dGFjaG1lbnRzW2ldLnRleHR1cmUuX3RleHR1cmUuZm9ybWF0XSAqIHRleHR1cmVUeXBlU2l6ZXNbY29sb3JBdHRhY2htZW50c1tpXS50ZXh0dXJlLl90ZXh0dXJlLnR5cGVdOwogICAgICAgICAgICAgICAgaWYgKGNvbW1vbkNvbG9yQXR0YWNobWVudFNpemUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29tbW9uQ29sb3JBdHRhY2htZW50U2l6ZSA9IGNvbG9yQXR0YWNobWVudFNpemU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICAgIGNvbW1vbkNvbG9yQXR0YWNobWVudFNpemUgPT09IGNvbG9yQXR0YWNobWVudFNpemUsCiAgICAgICAgICAgICAgICAgICAgImFsbCBjb2xvciBhdHRhY2htZW50cyBtdWNoIGhhdmUgdGhlIHNhbWUgbnVtYmVyIG9mIGJpdHMgcGVyIHBpeGVsLiIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5jUmVmQW5kQ2hlY2tTaGFwZShkZXB0aEF0dGFjaG1lbnQsIHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICFkZXB0aEF0dGFjaG1lbnQgfHwgZGVwdGhBdHRhY2htZW50LnRleHR1cmUgJiYgZGVwdGhBdHRhY2htZW50LnRleHR1cmUuX3RleHR1cmUuZm9ybWF0ID09PSBHTF9ERVBUSF9DT01QT05FTlQkMSB8fCBkZXB0aEF0dGFjaG1lbnQucmVuZGVyYnVmZmVyICYmIGRlcHRoQXR0YWNobWVudC5yZW5kZXJidWZmZXIuX3JlbmRlcmJ1ZmZlci5mb3JtYXQgPT09IEdMX0RFUFRIX0NPTVBPTkVOVDE2JDEsCiAgICAgICAgICAgICAgImludmFsaWQgZGVwdGggYXR0YWNobWVudCBmb3IgZnJhbWVidWZmZXIgb2JqZWN0IgogICAgICAgICAgICApOwogICAgICAgICAgICBpbmNSZWZBbmRDaGVja1NoYXBlKHN0ZW5jaWxBdHRhY2htZW50LCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAhc3RlbmNpbEF0dGFjaG1lbnQgfHwgc3RlbmNpbEF0dGFjaG1lbnQucmVuZGVyYnVmZmVyICYmIHN0ZW5jaWxBdHRhY2htZW50LnJlbmRlcmJ1ZmZlci5fcmVuZGVyYnVmZmVyLmZvcm1hdCA9PT0gR0xfU1RFTkNJTF9JTkRFWDgkMSwKICAgICAgICAgICAgICAiaW52YWxpZCBzdGVuY2lsIGF0dGFjaG1lbnQgZm9yIGZyYW1lYnVmZmVyIG9iamVjdCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaW5jUmVmQW5kQ2hlY2tTaGFwZShkZXB0aFN0ZW5jaWxBdHRhY2htZW50LCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAhZGVwdGhTdGVuY2lsQXR0YWNobWVudCB8fCBkZXB0aFN0ZW5jaWxBdHRhY2htZW50LnRleHR1cmUgJiYgZGVwdGhTdGVuY2lsQXR0YWNobWVudC50ZXh0dXJlLl90ZXh0dXJlLmZvcm1hdCA9PT0gR0xfREVQVEhfU1RFTkNJTCQyIHx8IGRlcHRoU3RlbmNpbEF0dGFjaG1lbnQucmVuZGVyYnVmZmVyICYmIGRlcHRoU3RlbmNpbEF0dGFjaG1lbnQucmVuZGVyYnVmZmVyLl9yZW5kZXJidWZmZXIuZm9ybWF0ID09PSBHTF9ERVBUSF9TVEVOQ0lMJDIsCiAgICAgICAgICAgICAgImludmFsaWQgZGVwdGgtc3RlbmNpbCBhdHRhY2htZW50IGZvciBmcmFtZWJ1ZmZlciBvYmplY3QiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGRlY0ZCT1JlZnMoZnJhbWVidWZmZXIpOwogICAgICAgICAgICBmcmFtZWJ1ZmZlci53aWR0aCA9IHdpZHRoOwogICAgICAgICAgICBmcmFtZWJ1ZmZlci5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICAgIGZyYW1lYnVmZmVyLmNvbG9yQXR0YWNobWVudHMgPSBjb2xvckF0dGFjaG1lbnRzOwogICAgICAgICAgICBmcmFtZWJ1ZmZlci5kZXB0aEF0dGFjaG1lbnQgPSBkZXB0aEF0dGFjaG1lbnQ7CiAgICAgICAgICAgIGZyYW1lYnVmZmVyLnN0ZW5jaWxBdHRhY2htZW50ID0gc3RlbmNpbEF0dGFjaG1lbnQ7CiAgICAgICAgICAgIGZyYW1lYnVmZmVyLmRlcHRoU3RlbmNpbEF0dGFjaG1lbnQgPSBkZXB0aFN0ZW5jaWxBdHRhY2htZW50OwogICAgICAgICAgICByZWdsRnJhbWVidWZmZXIuY29sb3IgPSBjb2xvckF0dGFjaG1lbnRzLm1hcCh1bndyYXBBdHRhY2htZW50KTsKICAgICAgICAgICAgcmVnbEZyYW1lYnVmZmVyLmRlcHRoID0gdW53cmFwQXR0YWNobWVudChkZXB0aEF0dGFjaG1lbnQpOwogICAgICAgICAgICByZWdsRnJhbWVidWZmZXIuc3RlbmNpbCA9IHVud3JhcEF0dGFjaG1lbnQoc3RlbmNpbEF0dGFjaG1lbnQpOwogICAgICAgICAgICByZWdsRnJhbWVidWZmZXIuZGVwdGhTdGVuY2lsID0gdW53cmFwQXR0YWNobWVudChkZXB0aFN0ZW5jaWxBdHRhY2htZW50KTsKICAgICAgICAgICAgcmVnbEZyYW1lYnVmZmVyLndpZHRoID0gZnJhbWVidWZmZXIud2lkdGg7CiAgICAgICAgICAgIHJlZ2xGcmFtZWJ1ZmZlci5oZWlnaHQgPSBmcmFtZWJ1ZmZlci5oZWlnaHQ7CiAgICAgICAgICAgIHVwZGF0ZUZyYW1lYnVmZmVyKGZyYW1lYnVmZmVyKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2xGcmFtZWJ1ZmZlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlc2l6ZTIod18sIGhfKSB7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5uZXh0ICE9PSBmcmFtZWJ1ZmZlciwKICAgICAgICAgICAgICAiY2FuIG5vdCByZXNpemUgYSBmcmFtZWJ1ZmZlciB3aGljaCBpcyBjdXJyZW50bHkgaW4gdXNlIgogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgdyA9IE1hdGgubWF4KHdfIHwgMCwgMSk7CiAgICAgICAgICAgIHZhciBoID0gTWF0aC5tYXgoaF8gfCAwIHx8IHcsIDEpOwogICAgICAgICAgICBpZiAodyA9PT0gZnJhbWVidWZmZXIud2lkdGggJiYgaCA9PT0gZnJhbWVidWZmZXIuaGVpZ2h0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlZ2xGcmFtZWJ1ZmZlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29sb3JBdHRhY2htZW50cyA9IGZyYW1lYnVmZmVyLmNvbG9yQXR0YWNobWVudHM7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29sb3JBdHRhY2htZW50cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHJlc2l6ZUF0dGFjaG1lbnQoY29sb3JBdHRhY2htZW50c1tpXSwgdywgaCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzaXplQXR0YWNobWVudChmcmFtZWJ1ZmZlci5kZXB0aEF0dGFjaG1lbnQsIHcsIGgpOwogICAgICAgICAgICByZXNpemVBdHRhY2htZW50KGZyYW1lYnVmZmVyLnN0ZW5jaWxBdHRhY2htZW50LCB3LCBoKTsKICAgICAgICAgICAgcmVzaXplQXR0YWNobWVudChmcmFtZWJ1ZmZlci5kZXB0aFN0ZW5jaWxBdHRhY2htZW50LCB3LCBoKTsKICAgICAgICAgICAgZnJhbWVidWZmZXIud2lkdGggPSByZWdsRnJhbWVidWZmZXIud2lkdGggPSB3OwogICAgICAgICAgICBmcmFtZWJ1ZmZlci5oZWlnaHQgPSByZWdsRnJhbWVidWZmZXIuaGVpZ2h0ID0gaDsKICAgICAgICAgICAgdXBkYXRlRnJhbWVidWZmZXIoZnJhbWVidWZmZXIpOwogICAgICAgICAgICByZXR1cm4gcmVnbEZyYW1lYnVmZmVyOwogICAgICAgICAgfQogICAgICAgICAgcmVnbEZyYW1lYnVmZmVyKGEwLCBhMSk7CiAgICAgICAgICByZXR1cm4gZXh0ZW5kMihyZWdsRnJhbWVidWZmZXIsIHsKICAgICAgICAgICAgcmVzaXplOiByZXNpemUyLAogICAgICAgICAgICBfcmVnbFR5cGU6ICJmcmFtZWJ1ZmZlciIsCiAgICAgICAgICAgIF9mcmFtZWJ1ZmZlcjogZnJhbWVidWZmZXIsCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRlc3Ryb3koZnJhbWVidWZmZXIpOwogICAgICAgICAgICAgIGRlY0ZCT1JlZnMoZnJhbWVidWZmZXIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2U6IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5zZXRGQk8oewogICAgICAgICAgICAgICAgZnJhbWVidWZmZXI6IHJlZ2xGcmFtZWJ1ZmZlcgogICAgICAgICAgICAgIH0sIGJsb2NrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUN1YmVGQk8ob3B0aW9ucykgewogICAgICAgICAgdmFyIGZhY2VzID0gQXJyYXkoNik7CiAgICAgICAgICBmdW5jdGlvbiByZWdsRnJhbWVidWZmZXJDdWJlKGEpIHsKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZmFjZXMuaW5kZXhPZihmcmFtZWJ1ZmZlclN0YXRlLm5leHQpIDwgMCwKICAgICAgICAgICAgICAiY2FuIG5vdCB1cGRhdGUgZnJhbWVidWZmZXIgd2hpY2ggaXMgY3VycmVudGx5IGluIHVzZSIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHsKICAgICAgICAgICAgICBjb2xvcjogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgcmFkaXVzID0gMDsKICAgICAgICAgICAgdmFyIGNvbG9yQnVmZmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIGNvbG9yRm9ybWF0ID0gInJnYmEiOwogICAgICAgICAgICB2YXIgY29sb3JUeXBlID0gInVpbnQ4IjsKICAgICAgICAgICAgdmFyIGNvbG9yQ291bnQgPSAxOwogICAgICAgICAgICBpZiAodHlwZW9mIGEgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgcmFkaXVzID0gYSB8IDA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWEpIHsKICAgICAgICAgICAgICByYWRpdXMgPSAxOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNoZWNrJDEudHlwZShhLCAib2JqZWN0IiwgImludmFsaWQgYXJndW1lbnRzIGZvciBmcmFtZWJ1ZmZlciIpOwogICAgICAgICAgICAgIHZhciBvcHRpb25zMiA9IGE7CiAgICAgICAgICAgICAgaWYgKCJzaGFwZSIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgIHZhciBzaGFwZSA9IG9wdGlvbnMyLnNoYXBlOwogICAgICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAgICAgQXJyYXkuaXNBcnJheShzaGFwZSkgJiYgc2hhcGUubGVuZ3RoID49IDIsCiAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHNoYXBlIGZvciBmcmFtZWJ1ZmZlciIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICBzaGFwZVswXSA9PT0gc2hhcGVbMV0sCiAgICAgICAgICAgICAgICAgICJjdWJlIGZyYW1lYnVmZmVyIG11c3QgYmUgc3F1YXJlIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHJhZGl1cyA9IHNoYXBlWzBdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoInJhZGl1cyIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgICAgcmFkaXVzID0gb3B0aW9uczIucmFkaXVzIHwgMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgid2lkdGgiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICAgIHJhZGl1cyA9IG9wdGlvbnMyLndpZHRoIHwgMDsKICAgICAgICAgICAgICAgICAgaWYgKCJoZWlnaHQiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMShvcHRpb25zMi5oZWlnaHQgPT09IHJhZGl1cywgIm11c3QgYmUgc3F1YXJlIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoImhlaWdodCIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgICAgcmFkaXVzID0gb3B0aW9uczIuaGVpZ2h0IHwgMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJjb2xvciIgaW4gb3B0aW9uczIgfHwgImNvbG9ycyIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgIGNvbG9yQnVmZmVyID0gb3B0aW9uczIuY29sb3IgfHwgb3B0aW9uczIuY29sb3JzOwogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29sb3JCdWZmZXIpKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICAgICAgY29sb3JCdWZmZXIubGVuZ3RoID09PSAxIHx8IGV4dGVuc2lvbnMud2ViZ2xfZHJhd19idWZmZXJzLAogICAgICAgICAgICAgICAgICAgICJtdWx0aXBsZSByZW5kZXIgdGFyZ2V0cyBub3Qgc3VwcG9ydGVkIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWNvbG9yQnVmZmVyKSB7CiAgICAgICAgICAgICAgICBpZiAoImNvbG9yQ291bnQiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICAgIGNvbG9yQ291bnQgPSBvcHRpb25zMi5jb2xvckNvdW50IHwgMDsKICAgICAgICAgICAgICAgICAgY2hlY2skMShjb2xvckNvdW50ID4gMCwgImludmFsaWQgY29sb3IgYnVmZmVyIGNvdW50Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoImNvbG9yVHlwZSIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgICAgY2hlY2skMS5vbmVPZigKICAgICAgICAgICAgICAgICAgICBvcHRpb25zMi5jb2xvclR5cGUsCiAgICAgICAgICAgICAgICAgICAgY29sb3JUeXBlcywKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBjb2xvciB0eXBlIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBjb2xvclR5cGUgPSBvcHRpb25zMi5jb2xvclR5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoImNvbG9yRm9ybWF0IiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgICAgICBjb2xvckZvcm1hdCA9IG9wdGlvbnMyLmNvbG9yRm9ybWF0OwogICAgICAgICAgICAgICAgICBjaGVjayQxLm9uZU9mKAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMyLmNvbG9yRm9ybWF0LAogICAgICAgICAgICAgICAgICAgIGNvbG9yVGV4dHVyZUZvcm1hdHMsCiAgICAgICAgICAgICAgICAgICAgImludmFsaWQgY29sb3IgZm9ybWF0IGZvciB0ZXh0dXJlIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoImRlcHRoIiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgICAgcGFyYW1zLmRlcHRoID0gb3B0aW9uczIuZGVwdGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgic3RlbmNpbCIgaW4gb3B0aW9uczIpIHsKICAgICAgICAgICAgICAgIHBhcmFtcy5zdGVuY2lsID0gb3B0aW9uczIuc3RlbmNpbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJkZXB0aFN0ZW5jaWwiIGluIG9wdGlvbnMyKSB7CiAgICAgICAgICAgICAgICBwYXJhbXMuZGVwdGhTdGVuY2lsID0gb3B0aW9uczIuZGVwdGhTdGVuY2lsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29sb3JDdWJlczsKICAgICAgICAgICAgaWYgKGNvbG9yQnVmZmVyKSB7CiAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29sb3JCdWZmZXIpKSB7CiAgICAgICAgICAgICAgICBjb2xvckN1YmVzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29sb3JCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgY29sb3JDdWJlc1tpXSA9IGNvbG9yQnVmZmVyW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb2xvckN1YmVzID0gW2NvbG9yQnVmZmVyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29sb3JDdWJlcyA9IEFycmF5KGNvbG9yQ291bnQpOwogICAgICAgICAgICAgIHZhciBjdWJlTWFwUGFyYW1zID0gewogICAgICAgICAgICAgICAgcmFkaXVzLAogICAgICAgICAgICAgICAgZm9ybWF0OiBjb2xvckZvcm1hdCwKICAgICAgICAgICAgICAgIHR5cGU6IGNvbG9yVHlwZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbG9yQ291bnQ7ICsraSkgewogICAgICAgICAgICAgICAgY29sb3JDdWJlc1tpXSA9IHRleHR1cmVTdGF0ZS5jcmVhdGVDdWJlKGN1YmVNYXBQYXJhbXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMuY29sb3IgPSBBcnJheShjb2xvckN1YmVzLmxlbmd0aCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2xvckN1YmVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIGN1YmUgPSBjb2xvckN1YmVzW2ldOwogICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICB0eXBlb2YgY3ViZSA9PT0gImZ1bmN0aW9uIiAmJiBjdWJlLl9yZWdsVHlwZSA9PT0gInRleHR1cmVDdWJlIiwKICAgICAgICAgICAgICAgICJpbnZhbGlkIGN1YmUgbWFwIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmFkaXVzID0gcmFkaXVzIHx8IGN1YmUud2lkdGg7CiAgICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICAgIGN1YmUud2lkdGggPT09IHJhZGl1cyAmJiBjdWJlLmhlaWdodCA9PT0gcmFkaXVzLAogICAgICAgICAgICAgICAgImludmFsaWQgY3ViZSBtYXAgc2hhcGUiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBwYXJhbXMuY29sb3JbaV0gPSB7CiAgICAgICAgICAgICAgICB0YXJnZXQ6IEdMX1RFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCQyLAogICAgICAgICAgICAgICAgZGF0YTogY29sb3JDdWJlc1tpXQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDY7ICsraSkgewogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY29sb3JDdWJlcy5sZW5ndGg7ICsraikgewogICAgICAgICAgICAgICAgcGFyYW1zLmNvbG9yW2pdLnRhcmdldCA9IEdMX1RFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCQyICsgaTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICBwYXJhbXMuZGVwdGggPSBmYWNlc1swXS5kZXB0aDsKICAgICAgICAgICAgICAgIHBhcmFtcy5zdGVuY2lsID0gZmFjZXNbMF0uc3RlbmNpbDsKICAgICAgICAgICAgICAgIHBhcmFtcy5kZXB0aFN0ZW5jaWwgPSBmYWNlc1swXS5kZXB0aFN0ZW5jaWw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmYWNlc1tpXSkgewogICAgICAgICAgICAgICAgZmFjZXNbaV0ocGFyYW1zKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZmFjZXNbaV0gPSBjcmVhdGVGQk8ocGFyYW1zKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV4dGVuZDIocmVnbEZyYW1lYnVmZmVyQ3ViZSwgewogICAgICAgICAgICAgIHdpZHRoOiByYWRpdXMsCiAgICAgICAgICAgICAgaGVpZ2h0OiByYWRpdXMsCiAgICAgICAgICAgICAgY29sb3I6IGNvbG9yQ3ViZXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXNpemUyKHJhZGl1c18pIHsKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIHZhciByYWRpdXMgPSByYWRpdXNfIHwgMDsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICByYWRpdXMgPiAwICYmIHJhZGl1cyA8PSBsaW1pdHMubWF4Q3ViZU1hcFNpemUsCiAgICAgICAgICAgICAgImludmFsaWQgcmFkaXVzIGZvciBjdWJlIGZibyIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKHJhZGl1cyA9PT0gcmVnbEZyYW1lYnVmZmVyQ3ViZS53aWR0aCkgewogICAgICAgICAgICAgIHJldHVybiByZWdsRnJhbWVidWZmZXJDdWJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb2xvcnMgPSByZWdsRnJhbWVidWZmZXJDdWJlLmNvbG9yOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29sb3JzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgY29sb3JzW2ldLnJlc2l6ZShyYWRpdXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCA2OyArK2kpIHsKICAgICAgICAgICAgICBmYWNlc1tpXS5yZXNpemUocmFkaXVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWdsRnJhbWVidWZmZXJDdWJlLndpZHRoID0gcmVnbEZyYW1lYnVmZmVyQ3ViZS5oZWlnaHQgPSByYWRpdXM7CiAgICAgICAgICAgIHJldHVybiByZWdsRnJhbWVidWZmZXJDdWJlOwogICAgICAgICAgfQogICAgICAgICAgcmVnbEZyYW1lYnVmZmVyQ3ViZShvcHRpb25zKTsKICAgICAgICAgIHJldHVybiBleHRlbmQyKHJlZ2xGcmFtZWJ1ZmZlckN1YmUsIHsKICAgICAgICAgICAgZmFjZXMsCiAgICAgICAgICAgIHJlc2l6ZTogcmVzaXplMiwKICAgICAgICAgICAgX3JlZ2xUeXBlOiAiZnJhbWVidWZmZXJDdWJlIiwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZmFjZXMuZm9yRWFjaChmdW5jdGlvbihmKSB7CiAgICAgICAgICAgICAgICBmLmRlc3Ryb3koKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVGcmFtZWJ1ZmZlcnMoKSB7CiAgICAgICAgICBmcmFtZWJ1ZmZlclN0YXRlLmN1ciA9IG51bGw7CiAgICAgICAgICBmcmFtZWJ1ZmZlclN0YXRlLm5leHQgPSBudWxsOwogICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5kaXJ0eSA9IHRydWU7CiAgICAgICAgICB2YWx1ZXMoZnJhbWVidWZmZXJTZXQpLmZvckVhY2goZnVuY3Rpb24oZmIpIHsKICAgICAgICAgICAgZmIuZnJhbWVidWZmZXIgPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwogICAgICAgICAgICB1cGRhdGVGcmFtZWJ1ZmZlcihmYik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4dGVuZDIoZnJhbWVidWZmZXJTdGF0ZSwgewogICAgICAgICAgZ2V0RnJhbWVidWZmZXI6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdCA9PT0gImZ1bmN0aW9uIiAmJiBvYmplY3QuX3JlZ2xUeXBlID09PSAiZnJhbWVidWZmZXIiKSB7CiAgICAgICAgICAgICAgdmFyIGZibyA9IG9iamVjdC5fZnJhbWVidWZmZXI7CiAgICAgICAgICAgICAgaWYgKGZibyBpbnN0YW5jZW9mIFJFR0xGcmFtZWJ1ZmZlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZibzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9LAogICAgICAgICAgY3JlYXRlOiBjcmVhdGVGQk8sCiAgICAgICAgICBjcmVhdGVDdWJlOiBjcmVhdGVDdWJlRkJPLAogICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YWx1ZXMoZnJhbWVidWZmZXJTZXQpLmZvckVhY2goZGVzdHJveSk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVzdG9yZTogcmVzdG9yZUZyYW1lYnVmZmVycwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciBHTF9GTE9BVCQ2ID0gNTEyNjsKICAgICAgdmFyIEdMX0FSUkFZX0JVRkZFUiQxID0gMzQ5NjI7CiAgICAgIHZhciBHTF9FTEVNRU5UX0FSUkFZX0JVRkZFUiQxID0gMzQ5NjM7CiAgICAgIHZhciBWQU9fT1BUSU9OUyA9IFsKICAgICAgICAiYXR0cmlidXRlcyIsCiAgICAgICAgImVsZW1lbnRzIiwKICAgICAgICAib2Zmc2V0IiwKICAgICAgICAiY291bnQiLAogICAgICAgICJwcmltaXRpdmUiLAogICAgICAgICJpbnN0YW5jZXMiCiAgICAgIF07CiAgICAgIGZ1bmN0aW9uIEF0dHJpYnV0ZVJlY29yZCgpIHsKICAgICAgICB0aGlzLnN0YXRlID0gMDsKICAgICAgICB0aGlzLnggPSAwOwogICAgICAgIHRoaXMueSA9IDA7CiAgICAgICAgdGhpcy56ID0gMDsKICAgICAgICB0aGlzLncgPSAwOwogICAgICAgIHRoaXMuYnVmZmVyID0gbnVsbDsKICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgIHRoaXMubm9ybWFsaXplZCA9IGZhbHNlOwogICAgICAgIHRoaXMudHlwZSA9IEdMX0ZMT0FUJDY7CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHRoaXMuc3RyaWRlID0gMDsKICAgICAgICB0aGlzLmRpdmlzb3IgPSAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHdyYXBBdHRyaWJ1dGVTdGF0ZShnbCwgZXh0ZW5zaW9ucywgbGltaXRzLCBzdGF0czIsIGJ1ZmZlclN0YXRlLCBlbGVtZW50U3RhdGUsIGRyYXdTdGF0ZSkgewogICAgICAgIHZhciBOVU1fQVRUUklCVVRFUyA9IGxpbWl0cy5tYXhBdHRyaWJ1dGVzOwogICAgICAgIHZhciBhdHRyaWJ1dGVCaW5kaW5ncyA9IG5ldyBBcnJheShOVU1fQVRUUklCVVRFUyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBOVU1fQVRUUklCVVRFUzsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVCaW5kaW5nc1tpXSA9IG5ldyBBdHRyaWJ1dGVSZWNvcmQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHZhb0NvdW50ID0gMDsKICAgICAgICB2YXIgdmFvU2V0ID0ge307CiAgICAgICAgdmFyIHN0YXRlID0gewogICAgICAgICAgUmVjb3JkOiBBdHRyaWJ1dGVSZWNvcmQsCiAgICAgICAgICBzY29wZToge30sCiAgICAgICAgICBzdGF0ZTogYXR0cmlidXRlQmluZGluZ3MsCiAgICAgICAgICBjdXJyZW50VkFPOiBudWxsLAogICAgICAgICAgdGFyZ2V0VkFPOiBudWxsLAogICAgICAgICAgcmVzdG9yZTogZXh0VkFPKCkgPyByZXN0b3JlVkFPIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9LAogICAgICAgICAgY3JlYXRlVkFPLAogICAgICAgICAgZ2V0VkFPLAogICAgICAgICAgZGVzdHJveUJ1ZmZlciwKICAgICAgICAgIHNldFZBTzogZXh0VkFPKCkgPyBzZXRWQU9FWFQgOiBzZXRWQU9FbXVsYXRlZCwKICAgICAgICAgIGNsZWFyOiBleHRWQU8oKSA/IGRlc3Ryb3lWQU9FWFQgOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lCdWZmZXIoYnVmZmVyMikgewogICAgICAgICAgZm9yICh2YXIgaTIgPSAwOyBpMiA8IGF0dHJpYnV0ZUJpbmRpbmdzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICB2YXIgcmVjb3JkID0gYXR0cmlidXRlQmluZGluZ3NbaTJdOwogICAgICAgICAgICBpZiAocmVjb3JkLmJ1ZmZlciA9PT0gYnVmZmVyMikgewogICAgICAgICAgICAgIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShpMik7CiAgICAgICAgICAgICAgcmVjb3JkLmJ1ZmZlciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0VkFPKCkgewogICAgICAgICAgcmV0dXJuIGV4dGVuc2lvbnMub2VzX3ZlcnRleF9hcnJheV9vYmplY3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dEluc3RhbmNlZCgpIHsKICAgICAgICAgIHJldHVybiBleHRlbnNpb25zLmFuZ2xlX2luc3RhbmNlZF9hcnJheXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZBTyh2YW8pIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFvID09PSAiZnVuY3Rpb24iICYmIHZhby5fdmFvKSB7CiAgICAgICAgICAgIHJldHVybiB2YW8uX3ZhbzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRWQU9FWFQodmFvKSB7CiAgICAgICAgICBpZiAodmFvID09PSBzdGF0ZS5jdXJyZW50VkFPKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleHQgPSBleHRWQU8oKTsKICAgICAgICAgIGlmICh2YW8pIHsKICAgICAgICAgICAgZXh0LmJpbmRWZXJ0ZXhBcnJheU9FUyh2YW8udmFvKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4dC5iaW5kVmVydGV4QXJyYXlPRVMobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS5jdXJyZW50VkFPID0gdmFvOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRWQU9FbXVsYXRlZCh2YW8pIHsKICAgICAgICAgIGlmICh2YW8gPT09IHN0YXRlLmN1cnJlbnRWQU8pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbykgewogICAgICAgICAgICB2YW8uYmluZEF0dHJzKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZXh0aSA9IGV4dEluc3RhbmNlZCgpOwogICAgICAgICAgICBmb3IgKHZhciBpMiA9IDA7IGkyIDwgYXR0cmlidXRlQmluZGluZ3MubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBhdHRyaWJ1dGVCaW5kaW5nc1tpMl07CiAgICAgICAgICAgICAgaWYgKGJpbmRpbmcuYnVmZmVyKSB7CiAgICAgICAgICAgICAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShpMik7CiAgICAgICAgICAgICAgICBiaW5kaW5nLmJ1ZmZlci5iaW5kKCk7CiAgICAgICAgICAgICAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKGkyLCBiaW5kaW5nLnNpemUsIGJpbmRpbmcudHlwZSwgYmluZGluZy5ub3JtYWxpemVkLCBiaW5kaW5nLnN0cmlkZSwgYmluZGluZy5vZmZmc2V0KTsKICAgICAgICAgICAgICAgIGlmIChleHRpICYmIGJpbmRpbmcuZGl2aXNvcikgewogICAgICAgICAgICAgICAgICBleHRpLnZlcnRleEF0dHJpYkRpdmlzb3JBTkdMRShpMiwgYmluZGluZy5kaXZpc29yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KGkyKTsKICAgICAgICAgICAgICAgIGdsLnZlcnRleEF0dHJpYjRmKGkyLCBiaW5kaW5nLngsIGJpbmRpbmcueSwgYmluZGluZy56LCBiaW5kaW5nLncpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZHJhd1N0YXRlLmVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgZ2wuYmluZEJ1ZmZlcihHTF9FTEVNRU5UX0FSUkFZX0JVRkZFUiQxLCBkcmF3U3RhdGUuZWxlbWVudHMuYnVmZmVyLmJ1ZmZlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2wuYmluZEJ1ZmZlcihHTF9FTEVNRU5UX0FSUkFZX0JVRkZFUiQxLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3RhdGUuY3VycmVudFZBTyA9IHZhbzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzdHJveVZBT0VYVCgpIHsKICAgICAgICAgIHZhbHVlcyh2YW9TZXQpLmZvckVhY2goZnVuY3Rpb24odmFvKSB7CiAgICAgICAgICAgIHZhby5kZXN0cm95KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUkVHTFZBTygpIHsKICAgICAgICAgIHRoaXMuaWQgPSArK3Zhb0NvdW50OwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gW107CiAgICAgICAgICB0aGlzLmVsZW1lbnRzID0gbnVsbDsKICAgICAgICAgIHRoaXMub3duc0VsZW1lbnRzID0gZmFsc2U7CiAgICAgICAgICB0aGlzLmNvdW50ID0gMDsKICAgICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgICAgIHRoaXMuaW5zdGFuY2VzID0gLTE7CiAgICAgICAgICB0aGlzLnByaW1pdGl2ZSA9IDQ7CiAgICAgICAgICB2YXIgZXh0ZW5zaW9uID0gZXh0VkFPKCk7CiAgICAgICAgICBpZiAoZXh0ZW5zaW9uKSB7CiAgICAgICAgICAgIHRoaXMudmFvID0gZXh0ZW5zaW9uLmNyZWF0ZVZlcnRleEFycmF5T0VTKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YW9TZXRbdGhpcy5pZF0gPSB0aGlzOwogICAgICAgICAgdGhpcy5idWZmZXJzID0gW107CiAgICAgICAgfQogICAgICAgIFJFR0xWQU8ucHJvdG90eXBlLmJpbmRBdHRycyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGV4dGkgPSBleHRJbnN0YW5jZWQoKTsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICAgICAgZm9yICh2YXIgaTIgPSAwOyBpMiA8IGF0dHJpYnV0ZXMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIHZhciBhdHRyID0gYXR0cmlidXRlc1tpMl07CiAgICAgICAgICAgIGlmIChhdHRyLmJ1ZmZlcikgewogICAgICAgICAgICAgIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KGkyKTsKICAgICAgICAgICAgICBnbC5iaW5kQnVmZmVyKEdMX0FSUkFZX0JVRkZFUiQxLCBhdHRyLmJ1ZmZlci5idWZmZXIpOwogICAgICAgICAgICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoaTIsIGF0dHIuc2l6ZSwgYXR0ci50eXBlLCBhdHRyLm5vcm1hbGl6ZWQsIGF0dHIuc3RyaWRlLCBhdHRyLm9mZnNldCk7CiAgICAgICAgICAgICAgaWYgKGV4dGkgJiYgYXR0ci5kaXZpc29yKSB7CiAgICAgICAgICAgICAgICBleHRpLnZlcnRleEF0dHJpYkRpdmlzb3JBTkdMRShpMiwgYXR0ci5kaXZpc29yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KGkyKTsKICAgICAgICAgICAgICBnbC52ZXJ0ZXhBdHRyaWI0ZihpMiwgYXR0ci54LCBhdHRyLnksIGF0dHIueiwgYXR0ci53KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaiA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBqIDwgTlVNX0FUVFJJQlVURVM7ICsraikgewogICAgICAgICAgICBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoaik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudHMgPSBlbGVtZW50U3RhdGUuZ2V0RWxlbWVudHModGhpcy5lbGVtZW50cyk7CiAgICAgICAgICBpZiAoZWxlbWVudHMpIHsKICAgICAgICAgICAgZ2wuYmluZEJ1ZmZlcihHTF9FTEVNRU5UX0FSUkFZX0JVRkZFUiQxLCBlbGVtZW50cy5idWZmZXIuYnVmZmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdsLmJpbmRCdWZmZXIoR0xfRUxFTUVOVF9BUlJBWV9CVUZGRVIkMSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBSRUdMVkFPLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZXh0ID0gZXh0VkFPKCk7CiAgICAgICAgICBpZiAoZXh0KSB7CiAgICAgICAgICAgIGV4dC5iaW5kVmVydGV4QXJyYXlPRVModGhpcy52YW8pOwogICAgICAgICAgICB0aGlzLmJpbmRBdHRycygpOwogICAgICAgICAgICBzdGF0ZS5jdXJyZW50VkFPID0gbnVsbDsKICAgICAgICAgICAgZXh0LmJpbmRWZXJ0ZXhBcnJheU9FUyhudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFJFR0xWQU8ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLnZhbykgewogICAgICAgICAgICB2YXIgZXh0ZW5zaW9uID0gZXh0VkFPKCk7CiAgICAgICAgICAgIGlmICh0aGlzID09PSBzdGF0ZS5jdXJyZW50VkFPKSB7CiAgICAgICAgICAgICAgc3RhdGUuY3VycmVudFZBTyA9IG51bGw7CiAgICAgICAgICAgICAgZXh0ZW5zaW9uLmJpbmRWZXJ0ZXhBcnJheU9FUyhudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleHRlbnNpb24uZGVsZXRlVmVydGV4QXJyYXlPRVModGhpcy52YW8pOwogICAgICAgICAgICB0aGlzLnZhbyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5vd25zRWxlbWVudHMpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cy5kZXN0cm95KCk7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMgPSBudWxsOwogICAgICAgICAgICB0aGlzLm93bnNFbGVtZW50cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhb1NldFt0aGlzLmlkXSkgewogICAgICAgICAgICBkZWxldGUgdmFvU2V0W3RoaXMuaWRdOwogICAgICAgICAgICBzdGF0czIudmFvQ291bnQgLT0gMTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVWQU8oKSB7CiAgICAgICAgICB2YXIgZXh0ID0gZXh0VkFPKCk7CiAgICAgICAgICBpZiAoZXh0KSB7CiAgICAgICAgICAgIHZhbHVlcyh2YW9TZXQpLmZvckVhY2goZnVuY3Rpb24odmFvKSB7CiAgICAgICAgICAgICAgdmFvLnJlZnJlc2goKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVZBTyhfYXR0cikgewogICAgICAgICAgdmFyIHZhbyA9IG5ldyBSRUdMVkFPKCk7CiAgICAgICAgICBzdGF0czIudmFvQ291bnQgKz0gMTsKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZBTyhvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVzOwogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zKSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSBvcHRpb25zOwogICAgICAgICAgICAgIGlmICh2YW8uZWxlbWVudHMgJiYgdmFvLm93bnNFbGVtZW50cykgewogICAgICAgICAgICAgICAgdmFvLmVsZW1lbnRzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFvLmVsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgICB2YW8ub3duc0VsZW1lbnRzID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFvLm9mZnNldCA9IDA7CiAgICAgICAgICAgICAgdmFvLmNvdW50ID0gMDsKICAgICAgICAgICAgICB2YW8uaW5zdGFuY2VzID0gLTE7CiAgICAgICAgICAgICAgdmFvLnByaW1pdGl2ZSA9IDQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hlY2skMSh0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIsICJpbnZhbGlkIGFyZ3VtZW50cyBmb3IgY3JlYXRlIHZhbyIpOwogICAgICAgICAgICAgIGNoZWNrJDEoImF0dHJpYnV0ZXMiIGluIG9wdGlvbnMsICJtdXN0IHNwZWNpZnkgYXR0cmlidXRlcyBmb3IgdmFvIik7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZWxlbWVudHMpIHsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IG9wdGlvbnMuZWxlbWVudHM7CiAgICAgICAgICAgICAgICBpZiAodmFvLm93bnNFbGVtZW50cykgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVsZW1lbnRzID09PSAiZnVuY3Rpb24iICYmIGVsZW1lbnRzLl9yZWdsVHlwZSA9PT0gImVsZW1lbnRzIikgewogICAgICAgICAgICAgICAgICAgIHZhby5lbGVtZW50cy5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgdmFvLm93bnNFbGVtZW50cyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhby5lbGVtZW50cyhlbGVtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgdmFvLm93bnNFbGVtZW50cyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnRTdGF0ZS5nZXRFbGVtZW50cyhvcHRpb25zLmVsZW1lbnRzKSkgewogICAgICAgICAgICAgICAgICB2YW8uZWxlbWVudHMgPSBvcHRpb25zLmVsZW1lbnRzOwogICAgICAgICAgICAgICAgICB2YW8ub3duc0VsZW1lbnRzID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YW8uZWxlbWVudHMgPSBlbGVtZW50U3RhdGUuY3JlYXRlKG9wdGlvbnMuZWxlbWVudHMpOwogICAgICAgICAgICAgICAgICB2YW8ub3duc0VsZW1lbnRzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFvLmVsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhby5vd25zRWxlbWVudHMgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0cmlidXRlcyA9IG9wdGlvbnMuYXR0cmlidXRlczsKICAgICAgICAgICAgICB2YW8ub2Zmc2V0ID0gMDsKICAgICAgICAgICAgICB2YW8uY291bnQgPSAtMTsKICAgICAgICAgICAgICB2YW8uaW5zdGFuY2VzID0gLTE7CiAgICAgICAgICAgICAgdmFvLnByaW1pdGl2ZSA9IDQ7CiAgICAgICAgICAgICAgaWYgKHZhby5lbGVtZW50cykgewogICAgICAgICAgICAgICAgdmFvLmNvdW50ID0gdmFvLmVsZW1lbnRzLl9lbGVtZW50cy52ZXJ0Q291bnQ7CiAgICAgICAgICAgICAgICB2YW8ucHJpbWl0aXZlID0gdmFvLmVsZW1lbnRzLl9lbGVtZW50cy5wcmltVHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJvZmZzZXQiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhby5vZmZzZXQgPSBvcHRpb25zLm9mZnNldCB8IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgiY291bnQiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhby5jb3VudCA9IG9wdGlvbnMuY291bnQgfCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoImluc3RhbmNlcyIgaW4gb3B0aW9ucykgewogICAgICAgICAgICAgICAgdmFvLmluc3RhbmNlcyA9IG9wdGlvbnMuaW5zdGFuY2VzIHwgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCJwcmltaXRpdmUiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEob3B0aW9ucy5wcmltaXRpdmUgaW4gcHJpbVR5cGVzLCAiYmFkIHByaW1pdGl2ZSB0eXBlOiAiICsgb3B0aW9ucy5wcmltaXRpdmUpOwogICAgICAgICAgICAgICAgdmFvLnByaW1pdGl2ZSA9IHByaW1UeXBlc1tvcHRpb25zLnByaW1pdGl2ZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoKCkgPT4gewogICAgICAgICAgICAgICAgdmFyIGtleXMyID0gT2JqZWN0LmtleXMob3B0aW9ucyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpMyA9IDA7IGkzIDwga2V5czIubGVuZ3RoOyArK2kzKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEoVkFPX09QVElPTlMuaW5kZXhPZihrZXlzMltpM10pID49IDAsICdpbnZhbGlkIG9wdGlvbiBmb3IgdmFvOiAiJyArIGtleXMyW2kzXSArICciIHZhbGlkIG9wdGlvbnMgYXJlICcgKyBWQU9fT1BUSU9OUyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2hlY2skMShBcnJheS5pc0FycmF5KGF0dHJpYnV0ZXMpLCAiYXR0cmlidXRlcyBtdXN0IGJlIGFuIGFycmF5Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hlY2skMShhdHRyaWJ1dGVzLmxlbmd0aCA8IE5VTV9BVFRSSUJVVEVTLCAidG9vIG1hbnkgYXR0cmlidXRlcyIpOwogICAgICAgICAgICBjaGVjayQxKGF0dHJpYnV0ZXMubGVuZ3RoID4gMCwgIm11c3Qgc3BlY2lmeSBhdCBsZWFzdCBvbmUgYXR0cmlidXRlIik7CiAgICAgICAgICAgIHZhciBidWZVcGRhdGVkID0ge307CiAgICAgICAgICAgIHZhciBuYXR0cmlidXRlcyA9IHZhby5hdHRyaWJ1dGVzOwogICAgICAgICAgICBuYXR0cmlidXRlcy5sZW5ndGggPSBhdHRyaWJ1dGVzLmxlbmd0aDsKICAgICAgICAgICAgZm9yICh2YXIgaTIgPSAwOyBpMiA8IGF0dHJpYnV0ZXMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgICAgdmFyIHNwZWMgPSBhdHRyaWJ1dGVzW2kyXTsKICAgICAgICAgICAgICB2YXIgcmVjID0gbmF0dHJpYnV0ZXNbaTJdID0gbmV3IEF0dHJpYnV0ZVJlY29yZCgpOwogICAgICAgICAgICAgIHZhciBkYXRhID0gc3BlYy5kYXRhIHx8IHNwZWM7CiAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkgfHwgaXNUeXBlZEFycmF5MihkYXRhKSB8fCBpc05EQXJyYXlMaWtlKGRhdGEpKSB7CiAgICAgICAgICAgICAgICB2YXIgYnVmMjsKICAgICAgICAgICAgICAgIGlmICh2YW8uYnVmZmVyc1tpMl0pIHsKICAgICAgICAgICAgICAgICAgYnVmMiA9IHZhby5idWZmZXJzW2kyXTsKICAgICAgICAgICAgICAgICAgaWYgKGlzVHlwZWRBcnJheTIoZGF0YSkgJiYgYnVmMi5fYnVmZmVyLmJ5dGVMZW5ndGggPj0gZGF0YS5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgYnVmMi5zdWJkYXRhKGRhdGEpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJ1ZjIuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgIHZhby5idWZmZXJzW2kyXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdmFvLmJ1ZmZlcnNbaTJdKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZjIgPSB2YW8uYnVmZmVyc1tpMl0gPSBidWZmZXJTdGF0ZS5jcmVhdGUoc3BlYywgR0xfQVJSQVlfQlVGRkVSJDEsIGZhbHNlLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlYy5idWZmZXIgPSBidWZmZXJTdGF0ZS5nZXRCdWZmZXIoYnVmMik7CiAgICAgICAgICAgICAgICByZWMuc2l6ZSA9IHJlYy5idWZmZXIuZGltZW5zaW9uIHwgMDsKICAgICAgICAgICAgICAgIHJlYy5ub3JtYWxpemVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZWMudHlwZSA9IHJlYy5idWZmZXIuZHR5cGU7CiAgICAgICAgICAgICAgICByZWMub2Zmc2V0ID0gMDsKICAgICAgICAgICAgICAgIHJlYy5zdHJpZGUgPSAwOwogICAgICAgICAgICAgICAgcmVjLmRpdmlzb3IgPSAwOwogICAgICAgICAgICAgICAgcmVjLnN0YXRlID0gMTsKICAgICAgICAgICAgICAgIGJ1ZlVwZGF0ZWRbaTJdID0gMTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJ1ZmZlclN0YXRlLmdldEJ1ZmZlcihzcGVjKSkgewogICAgICAgICAgICAgICAgcmVjLmJ1ZmZlciA9IGJ1ZmZlclN0YXRlLmdldEJ1ZmZlcihzcGVjKTsKICAgICAgICAgICAgICAgIHJlYy5zaXplID0gcmVjLmJ1ZmZlci5kaW1lbnNpb24gfCAwOwogICAgICAgICAgICAgICAgcmVjLm5vcm1hbGl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJlYy50eXBlID0gcmVjLmJ1ZmZlci5kdHlwZTsKICAgICAgICAgICAgICAgIHJlYy5vZmZzZXQgPSAwOwogICAgICAgICAgICAgICAgcmVjLnN0cmlkZSA9IDA7CiAgICAgICAgICAgICAgICByZWMuZGl2aXNvciA9IDA7CiAgICAgICAgICAgICAgICByZWMuc3RhdGUgPSAxOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYnVmZmVyU3RhdGUuZ2V0QnVmZmVyKHNwZWMuYnVmZmVyKSkgewogICAgICAgICAgICAgICAgcmVjLmJ1ZmZlciA9IGJ1ZmZlclN0YXRlLmdldEJ1ZmZlcihzcGVjLmJ1ZmZlcik7CiAgICAgICAgICAgICAgICByZWMuc2l6ZSA9ICgrc3BlYy5zaXplIHx8IHJlYy5idWZmZXIuZGltZW5zaW9uKSB8IDA7CiAgICAgICAgICAgICAgICByZWMubm9ybWFsaXplZCA9ICEhc3BlYy5ub3JtYWxpemVkIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKCJ0eXBlIiBpbiBzcGVjKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEucGFyYW1ldGVyKHNwZWMudHlwZSwgZ2xUeXBlcywgImludmFsaWQgYnVmZmVyIHR5cGUiKTsKICAgICAgICAgICAgICAgICAgcmVjLnR5cGUgPSBnbFR5cGVzW3NwZWMudHlwZV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWMudHlwZSA9IHJlYy5idWZmZXIuZHR5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZWMub2Zmc2V0ID0gKHNwZWMub2Zmc2V0IHx8IDApIHwgMDsKICAgICAgICAgICAgICAgIHJlYy5zdHJpZGUgPSAoc3BlYy5zdHJpZGUgfHwgMCkgfCAwOwogICAgICAgICAgICAgICAgcmVjLmRpdmlzb3IgPSAoc3BlYy5kaXZpc29yIHx8IDApIHwgMDsKICAgICAgICAgICAgICAgIHJlYy5zdGF0ZSA9IDE7CiAgICAgICAgICAgICAgICBjaGVjayQxKHJlYy5zaXplID49IDEgJiYgcmVjLnNpemUgPD0gNCwgInNpemUgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDQiKTsKICAgICAgICAgICAgICAgIGNoZWNrJDEocmVjLm9mZnNldCA+PSAwLCAiaW52YWxpZCBvZmZzZXQiKTsKICAgICAgICAgICAgICAgIGNoZWNrJDEocmVjLnN0cmlkZSA+PSAwICYmIHJlYy5zdHJpZGUgPD0gMjU1LCAic3RyaWRlIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAyNTUiKTsKICAgICAgICAgICAgICAgIGNoZWNrJDEocmVjLmRpdmlzb3IgPj0gMCwgImRpdmlzb3IgbXVzdCBiZSBwb3NpdGl2ZSIpOwogICAgICAgICAgICAgICAgY2hlY2skMSghcmVjLmRpdmlzb3IgfHwgISFleHRlbnNpb25zLmFuZ2xlX2luc3RhbmNlZF9hcnJheXMsICJBTkdMRV9pbnN0YW5jZWRfYXJyYXlzIG11c3QgYmUgZW5hYmxlZCB0byB1c2UgZGl2aXNvciIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIngiIGluIHNwZWMpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEoaTIgPiAwLCAiZmlyc3QgYXR0cmlidXRlIG11c3Qgbm90IGJlIGEgY29uc3RhbnQiKTsKICAgICAgICAgICAgICAgIHJlYy54ID0gK3NwZWMueCB8fCAwOwogICAgICAgICAgICAgICAgcmVjLnkgPSArc3BlYy55IHx8IDA7CiAgICAgICAgICAgICAgICByZWMueiA9ICtzcGVjLnogfHwgMDsKICAgICAgICAgICAgICAgIHJlYy53ID0gK3NwZWMudyB8fCAwOwogICAgICAgICAgICAgICAgcmVjLnN0YXRlID0gMjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2hlY2skMShmYWxzZSwgImludmFsaWQgYXR0cmlidXRlIHNwZWMgZm9yIGxvY2F0aW9uICIgKyBpMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFvLmJ1ZmZlcnMubGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICBpZiAoIWJ1ZlVwZGF0ZWRbal0gJiYgdmFvLmJ1ZmZlcnNbal0pIHsKICAgICAgICAgICAgICAgIHZhby5idWZmZXJzW2pdLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIHZhby5idWZmZXJzW2pdID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFvLnJlZnJlc2goKTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVZBTzsKICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZVZBTy5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFvLmJ1ZmZlcnMubGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICBpZiAodmFvLmJ1ZmZlcnNbal0pIHsKICAgICAgICAgICAgICAgIHZhby5idWZmZXJzW2pdLmRlc3Ryb3koKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFvLmJ1ZmZlcnMubGVuZ3RoID0gMDsKICAgICAgICAgICAgaWYgKHZhby5vd25zRWxlbWVudHMpIHsKICAgICAgICAgICAgICB2YW8uZWxlbWVudHMuZGVzdHJveSgpOwogICAgICAgICAgICAgIHZhby5lbGVtZW50cyA9IG51bGw7CiAgICAgICAgICAgICAgdmFvLm93bnNFbGVtZW50cyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhby5kZXN0cm95KCk7CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlVkFPLl92YW8gPSB2YW87CiAgICAgICAgICB1cGRhdGVWQU8uX3JlZ2xUeXBlID0gInZhbyI7CiAgICAgICAgICByZXR1cm4gdXBkYXRlVkFPKF9hdHRyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0YXRlOwogICAgICB9CiAgICAgIHZhciBHTF9GUkFHTUVOVF9TSEFERVIgPSAzNTYzMjsKICAgICAgdmFyIEdMX1ZFUlRFWF9TSEFERVIgPSAzNTYzMzsKICAgICAgdmFyIEdMX0FDVElWRV9VTklGT1JNUyA9IDM1NzE4OwogICAgICB2YXIgR0xfQUNUSVZFX0FUVFJJQlVURVMgPSAzNTcyMTsKICAgICAgZnVuY3Rpb24gd3JhcFNoYWRlclN0YXRlKGdsLCBzdHJpbmdTdG9yZSwgc3RhdHMyLCBjb25maWcpIHsKICAgICAgICB2YXIgZnJhZ1NoYWRlcnMgPSB7fTsKICAgICAgICB2YXIgdmVydFNoYWRlcnMgPSB7fTsKICAgICAgICBmdW5jdGlvbiBBY3RpdmVJbmZvKG5hbWUsIGlkLCBsb2NhdGlvbiwgaW5mbykgewogICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgIHRoaXMuaWQgPSBpZDsKICAgICAgICAgIHRoaXMubG9jYXRpb24gPSBsb2NhdGlvbjsKICAgICAgICAgIHRoaXMuaW5mbyA9IGluZm87CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEFjdGl2ZUluZm8obGlzdDIsIGluZm8pIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdDIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKGxpc3QyW2ldLmlkID09PSBpbmZvLmlkKSB7CiAgICAgICAgICAgICAgbGlzdDJbaV0ubG9jYXRpb24gPSBpbmZvLmxvY2F0aW9uOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbGlzdDIucHVzaChpbmZvKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2hhZGVyKHR5cGUsIGlkLCBjb21tYW5kKSB7CiAgICAgICAgICB2YXIgY2FjaGUgPSB0eXBlID09PSBHTF9GUkFHTUVOVF9TSEFERVIgPyBmcmFnU2hhZGVycyA6IHZlcnRTaGFkZXJzOwogICAgICAgICAgdmFyIHNoYWRlciA9IGNhY2hlW2lkXTsKICAgICAgICAgIGlmICghc2hhZGVyKSB7CiAgICAgICAgICAgIHZhciBzb3VyY2UgPSBzdHJpbmdTdG9yZS5zdHIoaWQpOwogICAgICAgICAgICBzaGFkZXIgPSBnbC5jcmVhdGVTaGFkZXIodHlwZSk7CiAgICAgICAgICAgIGdsLnNoYWRlclNvdXJjZShzaGFkZXIsIHNvdXJjZSk7CiAgICAgICAgICAgIGdsLmNvbXBpbGVTaGFkZXIoc2hhZGVyKTsKICAgICAgICAgICAgY2hlY2skMS5zaGFkZXJFcnJvcihnbCwgc2hhZGVyLCBzb3VyY2UsIHR5cGUsIGNvbW1hbmQpOwogICAgICAgICAgICBjYWNoZVtpZF0gPSBzaGFkZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2hhZGVyOwogICAgICAgIH0KICAgICAgICB2YXIgcHJvZ3JhbUNhY2hlID0ge307CiAgICAgICAgdmFyIHByb2dyYW1MaXN0ID0gW107CiAgICAgICAgdmFyIFBST0dSQU1fQ09VTlRFUiA9IDA7CiAgICAgICAgZnVuY3Rpb24gUkVHTFByb2dyYW0oZnJhZ0lkLCB2ZXJ0SWQpIHsKICAgICAgICAgIHRoaXMuaWQgPSBQUk9HUkFNX0NPVU5URVIrKzsKICAgICAgICAgIHRoaXMuZnJhZ0lkID0gZnJhZ0lkOwogICAgICAgICAgdGhpcy52ZXJ0SWQgPSB2ZXJ0SWQ7CiAgICAgICAgICB0aGlzLnByb2dyYW0gPSBudWxsOwogICAgICAgICAgdGhpcy51bmlmb3JtcyA9IFtdOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gW107CiAgICAgICAgICB0aGlzLnJlZkNvdW50ID0gMTsKICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICB0aGlzLnN0YXRzID0gewogICAgICAgICAgICAgIHVuaWZvcm1zQ291bnQ6IDAsCiAgICAgICAgICAgICAgYXR0cmlidXRlc0NvdW50OiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpbmtQcm9ncmFtKGRlc2MsIGNvbW1hbmQsIGF0dHJpYnV0ZUxvY2F0aW9ucykgewogICAgICAgICAgdmFyIGksIGluZm87CiAgICAgICAgICB2YXIgZnJhZ1NoYWRlciA9IGdldFNoYWRlcihHTF9GUkFHTUVOVF9TSEFERVIsIGRlc2MuZnJhZ0lkKTsKICAgICAgICAgIHZhciB2ZXJ0U2hhZGVyID0gZ2V0U2hhZGVyKEdMX1ZFUlRFWF9TSEFERVIsIGRlc2MudmVydElkKTsKICAgICAgICAgIHZhciBwcm9ncmFtID0gZGVzYy5wcm9ncmFtID0gZ2wuY3JlYXRlUHJvZ3JhbSgpOwogICAgICAgICAgZ2wuYXR0YWNoU2hhZGVyKHByb2dyYW0sIGZyYWdTaGFkZXIpOwogICAgICAgICAgZ2wuYXR0YWNoU2hhZGVyKHByb2dyYW0sIHZlcnRTaGFkZXIpOwogICAgICAgICAgaWYgKGF0dHJpYnV0ZUxvY2F0aW9ucykgewogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXR0cmlidXRlTG9jYXRpb25zLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBhdHRyaWJ1dGVMb2NhdGlvbnNbaV07CiAgICAgICAgICAgICAgZ2wuYmluZEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sIGJpbmRpbmdbMF0sIGJpbmRpbmdbMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBnbC5saW5rUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgICAgIGNoZWNrJDEubGlua0Vycm9yKAogICAgICAgICAgICBnbCwKICAgICAgICAgICAgcHJvZ3JhbSwKICAgICAgICAgICAgc3RyaW5nU3RvcmUuc3RyKGRlc2MuZnJhZ0lkKSwKICAgICAgICAgICAgc3RyaW5nU3RvcmUuc3RyKGRlc2MudmVydElkKSwKICAgICAgICAgICAgY29tbWFuZAogICAgICAgICAgKTsKICAgICAgICAgIHZhciBudW1Vbmlmb3JtcyA9IGdsLmdldFByb2dyYW1QYXJhbWV0ZXIocHJvZ3JhbSwgR0xfQUNUSVZFX1VOSUZPUk1TKTsKICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICBkZXNjLnN0YXRzLnVuaWZvcm1zQ291bnQgPSBudW1Vbmlmb3JtczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1bmlmb3JtcyA9IGRlc2MudW5pZm9ybXM7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVW5pZm9ybXM7ICsraSkgewogICAgICAgICAgICBpbmZvID0gZ2wuZ2V0QWN0aXZlVW5pZm9ybShwcm9ncmFtLCBpKTsKICAgICAgICAgICAgaWYgKGluZm8pIHsKICAgICAgICAgICAgICBpZiAoaW5mby5zaXplID4gMSkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBpbmZvLnNpemU7ICsraikgewogICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGluZm8ubmFtZS5yZXBsYWNlKCJbMF0iLCAiWyIgKyBqICsgIl0iKTsKICAgICAgICAgICAgICAgICAgaW5zZXJ0QWN0aXZlSW5mbyh1bmlmb3JtcywgbmV3IEFjdGl2ZUluZm8oCiAgICAgICAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAgICAgICBzdHJpbmdTdG9yZS5pZChuYW1lKSwKICAgICAgICAgICAgICAgICAgICBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgbmFtZSksCiAgICAgICAgICAgICAgICAgICAgaW5mbwogICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5zZXJ0QWN0aXZlSW5mbyh1bmlmb3JtcywgbmV3IEFjdGl2ZUluZm8oCiAgICAgICAgICAgICAgICAgIGluZm8ubmFtZSwKICAgICAgICAgICAgICAgICAgc3RyaW5nU3RvcmUuaWQoaW5mby5uYW1lKSwKICAgICAgICAgICAgICAgICAgZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sIGluZm8ubmFtZSksCiAgICAgICAgICAgICAgICAgIGluZm8KICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG51bUF0dHJpYnV0ZXMgPSBnbC5nZXRQcm9ncmFtUGFyYW1ldGVyKHByb2dyYW0sIEdMX0FDVElWRV9BVFRSSUJVVEVTKTsKICAgICAgICAgIGlmIChjb25maWcucHJvZmlsZSkgewogICAgICAgICAgICBkZXNjLnN0YXRzLmF0dHJpYnV0ZXNDb3VudCA9IG51bUF0dHJpYnV0ZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGRlc2MuYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1BdHRyaWJ1dGVzOyArK2kpIHsKICAgICAgICAgICAgaW5mbyA9IGdsLmdldEFjdGl2ZUF0dHJpYihwcm9ncmFtLCBpKTsKICAgICAgICAgICAgaWYgKGluZm8pIHsKICAgICAgICAgICAgICBpbnNlcnRBY3RpdmVJbmZvKGF0dHJpYnV0ZXMsIG5ldyBBY3RpdmVJbmZvKAogICAgICAgICAgICAgICAgaW5mby5uYW1lLAogICAgICAgICAgICAgICAgc3RyaW5nU3RvcmUuaWQoaW5mby5uYW1lKSwKICAgICAgICAgICAgICAgIGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sIGluZm8ubmFtZSksCiAgICAgICAgICAgICAgICBpbmZvCiAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGNvbmZpZy5wcm9maWxlKSB7CiAgICAgICAgICBzdGF0czIuZ2V0TWF4VW5pZm9ybXNDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbSA9IDA7CiAgICAgICAgICAgIHByb2dyYW1MaXN0LmZvckVhY2goZnVuY3Rpb24oZGVzYykgewogICAgICAgICAgICAgIGlmIChkZXNjLnN0YXRzLnVuaWZvcm1zQ291bnQgPiBtKSB7CiAgICAgICAgICAgICAgICBtID0gZGVzYy5zdGF0cy51bmlmb3Jtc0NvdW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBtOwogICAgICAgICAgfTsKICAgICAgICAgIHN0YXRzMi5nZXRNYXhBdHRyaWJ1dGVzQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIG0gPSAwOwogICAgICAgICAgICBwcm9ncmFtTGlzdC5mb3JFYWNoKGZ1bmN0aW9uKGRlc2MpIHsKICAgICAgICAgICAgICBpZiAoZGVzYy5zdGF0cy5hdHRyaWJ1dGVzQ291bnQgPiBtKSB7CiAgICAgICAgICAgICAgICBtID0gZGVzYy5zdGF0cy5hdHRyaWJ1dGVzQ291bnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU2hhZGVycygpIHsKICAgICAgICAgIGZyYWdTaGFkZXJzID0ge307CiAgICAgICAgICB2ZXJ0U2hhZGVycyA9IHt9OwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9ncmFtTGlzdC5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBsaW5rUHJvZ3JhbShwcm9ncmFtTGlzdFtpXSwgbnVsbCwgcHJvZ3JhbUxpc3RbaV0uYXR0cmlidXRlcy5tYXAoZnVuY3Rpb24oaW5mbykgewogICAgICAgICAgICAgIHJldHVybiBbaW5mby5sb2NhdGlvbiwgaW5mby5uYW1lXTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZGVsZXRlU2hhZGVyID0gZ2wuZGVsZXRlU2hhZGVyLmJpbmQoZ2wpOwogICAgICAgICAgICB2YWx1ZXMoZnJhZ1NoYWRlcnMpLmZvckVhY2goZGVsZXRlU2hhZGVyKTsKICAgICAgICAgICAgZnJhZ1NoYWRlcnMgPSB7fTsKICAgICAgICAgICAgdmFsdWVzKHZlcnRTaGFkZXJzKS5mb3JFYWNoKGRlbGV0ZVNoYWRlcik7CiAgICAgICAgICAgIHZlcnRTaGFkZXJzID0ge307CiAgICAgICAgICAgIHByb2dyYW1MaXN0LmZvckVhY2goZnVuY3Rpb24oZGVzYykgewogICAgICAgICAgICAgIGdsLmRlbGV0ZVByb2dyYW0oZGVzYy5wcm9ncmFtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHByb2dyYW1MaXN0Lmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHByb2dyYW1DYWNoZSA9IHt9OwogICAgICAgICAgICBzdGF0czIuc2hhZGVyQ291bnQgPSAwOwogICAgICAgICAgfSwKICAgICAgICAgIHByb2dyYW06IGZ1bmN0aW9uKHZlcnRJZCwgZnJhZ0lkLCBjb21tYW5kLCBhdHRyaWJMb2NhdGlvbnMpIHsKICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKHZlcnRJZCA+PSAwLCAibWlzc2luZyB2ZXJ0ZXggc2hhZGVyIiwgY29tbWFuZCk7CiAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZChmcmFnSWQgPj0gMCwgIm1pc3NpbmcgZnJhZ21lbnQgc2hhZGVyIiwgY29tbWFuZCk7CiAgICAgICAgICAgIHZhciBjYWNoZSA9IHByb2dyYW1DYWNoZVtmcmFnSWRdOwogICAgICAgICAgICBpZiAoIWNhY2hlKSB7CiAgICAgICAgICAgICAgY2FjaGUgPSBwcm9ncmFtQ2FjaGVbZnJhZ0lkXSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2UHJvZ3JhbSA9IGNhY2hlW3ZlcnRJZF07CiAgICAgICAgICAgIGlmIChwcmV2UHJvZ3JhbSkgewogICAgICAgICAgICAgIHByZXZQcm9ncmFtLnJlZkNvdW50Kys7CiAgICAgICAgICAgICAgaWYgKCFhdHRyaWJMb2NhdGlvbnMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2UHJvZ3JhbTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb2dyYW0gPSBuZXcgUkVHTFByb2dyYW0oZnJhZ0lkLCB2ZXJ0SWQpOwogICAgICAgICAgICBzdGF0czIuc2hhZGVyQ291bnQrKzsKICAgICAgICAgICAgbGlua1Byb2dyYW0ocHJvZ3JhbSwgY29tbWFuZCwgYXR0cmliTG9jYXRpb25zKTsKICAgICAgICAgICAgaWYgKCFwcmV2UHJvZ3JhbSkgewogICAgICAgICAgICAgIGNhY2hlW3ZlcnRJZF0gPSBwcm9ncmFtOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2dyYW1MaXN0LnB1c2gocHJvZ3JhbSk7CiAgICAgICAgICAgIHJldHVybiBleHRlbmQyKHByb2dyYW0sIHsKICAgICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHByb2dyYW0ucmVmQ291bnQtLTsKICAgICAgICAgICAgICAgIGlmIChwcm9ncmFtLnJlZkNvdW50IDw9IDApIHsKICAgICAgICAgICAgICAgICAgZ2wuZGVsZXRlUHJvZ3JhbShwcm9ncmFtLnByb2dyYW0pOwogICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gcHJvZ3JhbUxpc3QuaW5kZXhPZihwcm9ncmFtKTsKICAgICAgICAgICAgICAgICAgcHJvZ3JhbUxpc3Quc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgICAgICAgIHN0YXRzMi5zaGFkZXJDb3VudC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNhY2hlW3Byb2dyYW0udmVydElkXS5yZWZDb3VudCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgIGdsLmRlbGV0ZVNoYWRlcih2ZXJ0U2hhZGVyc1twcm9ncmFtLnZlcnRJZF0pOwogICAgICAgICAgICAgICAgICBkZWxldGUgdmVydFNoYWRlcnNbcHJvZ3JhbS52ZXJ0SWRdOwogICAgICAgICAgICAgICAgICBkZWxldGUgcHJvZ3JhbUNhY2hlW3Byb2dyYW0uZnJhZ0lkXVtwcm9ncmFtLnZlcnRJZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIU9iamVjdC5rZXlzKHByb2dyYW1DYWNoZVtwcm9ncmFtLmZyYWdJZF0pLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBnbC5kZWxldGVTaGFkZXIoZnJhZ1NoYWRlcnNbcHJvZ3JhbS5mcmFnSWRdKTsKICAgICAgICAgICAgICAgICAgZGVsZXRlIGZyYWdTaGFkZXJzW3Byb2dyYW0uZnJhZ0lkXTsKICAgICAgICAgICAgICAgICAgZGVsZXRlIHByb2dyYW1DYWNoZVtwcm9ncmFtLmZyYWdJZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICByZXN0b3JlOiByZXN0b3JlU2hhZGVycywKICAgICAgICAgIHNoYWRlcjogZ2V0U2hhZGVyLAogICAgICAgICAgZnJhZzogLTEsCiAgICAgICAgICB2ZXJ0OiAtMQogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIEdMX1JHQkEkMyA9IDY0MDg7CiAgICAgIHZhciBHTF9VTlNJR05FRF9CWVRFJDcgPSA1MTIxOwogICAgICB2YXIgR0xfUEFDS19BTElHTk1FTlQgPSAzMzMzOwogICAgICB2YXIgR0xfRkxPQVQkNyA9IDUxMjY7CiAgICAgIGZ1bmN0aW9uIHdyYXBSZWFkUGl4ZWxzKGdsLCBmcmFtZWJ1ZmZlclN0YXRlLCByZWdsUG9sbCwgY29udGV4dCwgZ2xBdHRyaWJ1dGVzLCBleHRlbnNpb25zLCBsaW1pdHMpIHsKICAgICAgICBmdW5jdGlvbiByZWFkUGl4ZWxzSW1wbChpbnB1dCkgewogICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICBpZiAoZnJhbWVidWZmZXJTdGF0ZS5uZXh0ID09PSBudWxsKSB7CiAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgZ2xBdHRyaWJ1dGVzLnByZXNlcnZlRHJhd2luZ0J1ZmZlciwKICAgICAgICAgICAgICAneW91IG11c3QgY3JlYXRlIGEgd2ViZ2wgY29udGV4dCB3aXRoICJwcmVzZXJ2ZURyYXdpbmdCdWZmZXIiOnRydWUgaW4gb3JkZXIgdG8gcmVhZCBwaXhlbHMgZnJvbSB0aGUgZHJhd2luZyBidWZmZXInCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHR5cGUgPSBHTF9VTlNJR05FRF9CWVRFJDc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIGZyYW1lYnVmZmVyU3RhdGUubmV4dC5jb2xvckF0dGFjaG1lbnRzWzBdLnRleHR1cmUgIT09IG51bGwsCiAgICAgICAgICAgICAgIllvdSBjYW5ub3QgcmVhZCBmcm9tIGEgcmVuZGVyYnVmZmVyIgogICAgICAgICAgICApOwogICAgICAgICAgICB0eXBlID0gZnJhbWVidWZmZXJTdGF0ZS5uZXh0LmNvbG9yQXR0YWNobWVudHNbMF0udGV4dHVyZS5fdGV4dHVyZS50eXBlOwogICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChleHRlbnNpb25zLm9lc190ZXh0dXJlX2Zsb2F0KSB7CiAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICB0eXBlID09PSBHTF9VTlNJR05FRF9CWVRFJDcgfHwgdHlwZSA9PT0gR0xfRkxPQVQkNywKICAgICAgICAgICAgICAgICAgIlJlYWRpbmcgZnJvbSBhIGZyYW1lYnVmZmVyIGlzIG9ubHkgYWxsb3dlZCBmb3IgdGhlIHR5cGVzICd1aW50OCcgYW5kICdmbG9hdCciCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IEdMX0ZMT0FUJDcpIHsKICAgICAgICAgICAgICAgICAgY2hlY2skMShsaW1pdHMucmVhZEZsb2F0LCAiUmVhZGluZyAnZmxvYXQnIHZhbHVlcyBpcyBub3QgcGVybWl0dGVkIGluIHlvdXIgYnJvd3Nlci4gRm9yIGEgZmFsbGJhY2ssIHBsZWFzZSBzZWU6IGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL2dsc2wtcmVhZC1mbG9hdCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgICB0eXBlID09PSBHTF9VTlNJR05FRF9CWVRFJDcsCiAgICAgICAgICAgICAgICAgICJSZWFkaW5nIGZyb20gYSBmcmFtZWJ1ZmZlciBpcyBvbmx5IGFsbG93ZWQgZm9yIHRoZSB0eXBlICd1aW50OCciCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgeCA9IDA7CiAgICAgICAgICB2YXIgeSA9IDA7CiAgICAgICAgICB2YXIgd2lkdGggPSBjb250ZXh0LmZyYW1lYnVmZmVyV2lkdGg7CiAgICAgICAgICB2YXIgaGVpZ2h0ID0gY29udGV4dC5mcmFtZWJ1ZmZlckhlaWdodDsKICAgICAgICAgIHZhciBkYXRhID0gbnVsbDsKICAgICAgICAgIGlmIChpc1R5cGVkQXJyYXkyKGlucHV0KSkgewogICAgICAgICAgICBkYXRhID0gaW5wdXQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0KSB7CiAgICAgICAgICAgIGNoZWNrJDEudHlwZShpbnB1dCwgIm9iamVjdCIsICJpbnZhbGlkIGFyZ3VtZW50cyB0byByZWdsLnJlYWQoKSIpOwogICAgICAgICAgICB4ID0gaW5wdXQueCB8IDA7CiAgICAgICAgICAgIHkgPSBpbnB1dC55IHwgMDsKICAgICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgICB4ID49IDAgJiYgeCA8IGNvbnRleHQuZnJhbWVidWZmZXJXaWR0aCwKICAgICAgICAgICAgICAiaW52YWxpZCB4IG9mZnNldCBmb3IgcmVnbC5yZWFkIgogICAgICAgICAgICApOwogICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgIHkgPj0gMCAmJiB5IDwgY29udGV4dC5mcmFtZWJ1ZmZlckhlaWdodCwKICAgICAgICAgICAgICAiaW52YWxpZCB5IG9mZnNldCBmb3IgcmVnbC5yZWFkIgogICAgICAgICAgICApOwogICAgICAgICAgICB3aWR0aCA9IChpbnB1dC53aWR0aCB8fCBjb250ZXh0LmZyYW1lYnVmZmVyV2lkdGggLSB4KSB8IDA7CiAgICAgICAgICAgIGhlaWdodCA9IChpbnB1dC5oZWlnaHQgfHwgY29udGV4dC5mcmFtZWJ1ZmZlckhlaWdodCAtIHkpIHwgMDsKICAgICAgICAgICAgZGF0YSA9IGlucHV0LmRhdGEgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBHTF9VTlNJR05FRF9CWVRFJDcpIHsKICAgICAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICAgICAgZGF0YSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXksCiAgICAgICAgICAgICAgICAiYnVmZmVyIG11c3QgYmUgJ1VpbnQ4QXJyYXknIHdoZW4gcmVhZGluZyBmcm9tIGEgZnJhbWVidWZmZXIgb2YgdHlwZSAndWludDgnIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gR0xfRkxPQVQkNykgewogICAgICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgICAgICBkYXRhIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5LAogICAgICAgICAgICAgICAgImJ1ZmZlciBtdXN0IGJlICdGbG9hdDMyQXJyYXknIHdoZW4gcmVhZGluZyBmcm9tIGEgZnJhbWVidWZmZXIgb2YgdHlwZSAnZmxvYXQnIgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNoZWNrJDEoCiAgICAgICAgICAgIHdpZHRoID4gMCAmJiB3aWR0aCArIHggPD0gY29udGV4dC5mcmFtZWJ1ZmZlcldpZHRoLAogICAgICAgICAgICAiaW52YWxpZCB3aWR0aCBmb3IgcmVhZCBwaXhlbHMiCiAgICAgICAgICApOwogICAgICAgICAgY2hlY2skMSgKICAgICAgICAgICAgaGVpZ2h0ID4gMCAmJiBoZWlnaHQgKyB5IDw9IGNvbnRleHQuZnJhbWVidWZmZXJIZWlnaHQsCiAgICAgICAgICAgICJpbnZhbGlkIGhlaWdodCBmb3IgcmVhZCBwaXhlbHMiCiAgICAgICAgICApOwogICAgICAgICAgcmVnbFBvbGwoKTsKICAgICAgICAgIHZhciBzaXplID0gd2lkdGggKiBoZWlnaHQgKiA0OwogICAgICAgICAgaWYgKCFkYXRhKSB7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBHTF9VTlNJR05FRF9CWVRFJDcpIHsKICAgICAgICAgICAgICBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gR0xfRkxPQVQkNykgewogICAgICAgICAgICAgIGRhdGEgPSBkYXRhIHx8IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNoZWNrJDEuaXNUeXBlZEFycmF5KGRhdGEsICJkYXRhIGJ1ZmZlciBmb3IgcmVnbC5yZWFkKCkgbXVzdCBiZSBhIHR5cGVkYXJyYXkiKTsKICAgICAgICAgIGNoZWNrJDEoZGF0YS5ieXRlTGVuZ3RoID49IHNpemUsICJkYXRhIGJ1ZmZlciBmb3IgcmVnbC5yZWFkKCkgdG9vIHNtYWxsIik7CiAgICAgICAgICBnbC5waXhlbFN0b3JlaShHTF9QQUNLX0FMSUdOTUVOVCwgNCk7CiAgICAgICAgICBnbC5yZWFkUGl4ZWxzKAogICAgICAgICAgICB4LAogICAgICAgICAgICB5LAogICAgICAgICAgICB3aWR0aCwKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICBHTF9SR0JBJDMsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGRhdGEKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhZFBpeGVsc0ZCTyhvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5zZXRGQk8oewogICAgICAgICAgICBmcmFtZWJ1ZmZlcjogb3B0aW9ucy5mcmFtZWJ1ZmZlcgogICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHJlYWRQaXhlbHNJbXBsKG9wdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkUGl4ZWxzKG9wdGlvbnMpIHsKICAgICAgICAgIGlmICghb3B0aW9ucyB8fCAhKCJmcmFtZWJ1ZmZlciIgaW4gb3B0aW9ucykpIHsKICAgICAgICAgICAgcmV0dXJuIHJlYWRQaXhlbHNJbXBsKG9wdGlvbnMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHJlYWRQaXhlbHNGQk8ob3B0aW9ucyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZWFkUGl4ZWxzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNsaWNlKHgpIHsKICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoeCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gam9pbih4KSB7CiAgICAgICAgcmV0dXJuIHNsaWNlKHgpLmpvaW4oIiIpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVudmlyb25tZW50KCkgewogICAgICAgIHZhciB2YXJDb3VudGVyID0gMDsKICAgICAgICB2YXIgbGlua2VkTmFtZXMgPSBbXTsKICAgICAgICB2YXIgbGlua2VkVmFsdWVzID0gW107CiAgICAgICAgZnVuY3Rpb24gbGluayh2YWx1ZSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5rZWRWYWx1ZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKGxpbmtlZFZhbHVlc1tpXSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gbGlua2VkTmFtZXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gImciICsgdmFyQ291bnRlcisrOwogICAgICAgICAgbGlua2VkTmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgIGxpbmtlZFZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBibG9jaygpIHsKICAgICAgICAgIHZhciBjb2RlID0gW107CiAgICAgICAgICBmdW5jdGlvbiBwdXNoMigpIHsKICAgICAgICAgICAgY29kZS5wdXNoLmFwcGx5KGNvZGUsIHNsaWNlKGFyZ3VtZW50cykpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhcnMgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIGRlZigpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSAidiIgKyB2YXJDb3VudGVyKys7CiAgICAgICAgICAgIHZhcnMucHVzaChuYW1lKTsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgY29kZS5wdXNoKG5hbWUsICI9Iik7CiAgICAgICAgICAgICAgY29kZS5wdXNoLmFwcGx5KGNvZGUsIHNsaWNlKGFyZ3VtZW50cykpOwogICAgICAgICAgICAgIGNvZGUucHVzaCgiOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4dGVuZDIocHVzaDIsIHsKICAgICAgICAgICAgZGVmLAogICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGpvaW4oWwogICAgICAgICAgICAgICAgdmFycy5sZW5ndGggPiAwID8gInZhciAiICsgdmFycy5qb2luKCIsIikgKyAiOyIgOiAiIiwKICAgICAgICAgICAgICAgIGpvaW4oY29kZSkKICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjb3BlKCkgewogICAgICAgICAgdmFyIGVudHJ5ID0gYmxvY2soKTsKICAgICAgICAgIHZhciBleGl0ID0gYmxvY2soKTsKICAgICAgICAgIHZhciBlbnRyeVRvU3RyaW5nID0gZW50cnkudG9TdHJpbmc7CiAgICAgICAgICB2YXIgZXhpdFRvU3RyaW5nID0gZXhpdC50b1N0cmluZzsKICAgICAgICAgIGZ1bmN0aW9uIHNhdmUob2JqZWN0LCBwcm9wKSB7CiAgICAgICAgICAgIGV4aXQob2JqZWN0LCBwcm9wLCAiPSIsIGVudHJ5LmRlZihvYmplY3QsIHByb3ApLCAiOyIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4dGVuZDIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVudHJ5LmFwcGx5KGVudHJ5LCBzbGljZShhcmd1bWVudHMpKTsKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgZGVmOiBlbnRyeS5kZWYsCiAgICAgICAgICAgIGVudHJ5LAogICAgICAgICAgICBleGl0LAogICAgICAgICAgICBzYXZlLAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG9iamVjdCwgcHJvcCwgdmFsdWUpIHsKICAgICAgICAgICAgICBzYXZlKG9iamVjdCwgcHJvcCk7CiAgICAgICAgICAgICAgZW50cnkob2JqZWN0LCBwcm9wLCAiPSIsIHZhbHVlLCAiOyIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5VG9TdHJpbmcoKSArIGV4aXRUb1N0cmluZygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29uZGl0aW9uYWwoKSB7CiAgICAgICAgICB2YXIgcHJlZCA9IGpvaW4oYXJndW1lbnRzKTsKICAgICAgICAgIHZhciB0aGVuQmxvY2sgPSBzY29wZSgpOwogICAgICAgICAgdmFyIGVsc2VCbG9jayA9IHNjb3BlKCk7CiAgICAgICAgICB2YXIgdGhlblRvU3RyaW5nID0gdGhlbkJsb2NrLnRvU3RyaW5nOwogICAgICAgICAgdmFyIGVsc2VUb1N0cmluZyA9IGVsc2VCbG9jay50b1N0cmluZzsKICAgICAgICAgIHJldHVybiBleHRlbmQyKHRoZW5CbG9jaywgewogICAgICAgICAgICB0aGVuOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aGVuQmxvY2suYXBwbHkodGhlbkJsb2NrLCBzbGljZShhcmd1bWVudHMpKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWxzZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZWxzZUJsb2NrLmFwcGx5KGVsc2VCbG9jaywgc2xpY2UoYXJndW1lbnRzKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgZWxzZUNsYXVzZSA9IGVsc2VUb1N0cmluZygpOwogICAgICAgICAgICAgIGlmIChlbHNlQ2xhdXNlKSB7CiAgICAgICAgICAgICAgICBlbHNlQ2xhdXNlID0gImVsc2V7IiArIGVsc2VDbGF1c2UgKyAifSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBqb2luKFsKICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgcHJlZCwKICAgICAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgICAgICB0aGVuVG9TdHJpbmcoKSwKICAgICAgICAgICAgICAgICJ9IiwKICAgICAgICAgICAgICAgIGVsc2VDbGF1c2UKICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciBnbG9iYWxCbG9jayA9IGJsb2NrKCk7CiAgICAgICAgdmFyIHByb2NlZHVyZXMgPSB7fTsKICAgICAgICBmdW5jdGlvbiBwcm9jKG5hbWUsIGNvdW50MikgewogICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIGFyZygpIHsKICAgICAgICAgICAgdmFyIG5hbWUyID0gImEiICsgYXJncy5sZW5ndGg7CiAgICAgICAgICAgIGFyZ3MucHVzaChuYW1lMik7CiAgICAgICAgICAgIHJldHVybiBuYW1lMjsKICAgICAgICAgIH0KICAgICAgICAgIGNvdW50MiA9IGNvdW50MiB8fCAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDI7ICsraSkgewogICAgICAgICAgICBhcmcoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBib2R5ID0gc2NvcGUoKTsKICAgICAgICAgIHZhciBib2R5VG9TdHJpbmcgPSBib2R5LnRvU3RyaW5nOwogICAgICAgICAgdmFyIHJlc3VsdCA9IHByb2NlZHVyZXNbbmFtZV0gPSBleHRlbmQyKGJvZHksIHsKICAgICAgICAgICAgYXJnLAogICAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGpvaW4oWwogICAgICAgICAgICAgICAgImZ1bmN0aW9uKCIsCiAgICAgICAgICAgICAgICBhcmdzLmpvaW4oKSwKICAgICAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgICAgICBib2R5VG9TdHJpbmcoKSwKICAgICAgICAgICAgICAgICJ9IgogICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBpbGUoKSB7CiAgICAgICAgICB2YXIgY29kZSA9IFsKICAgICAgICAgICAgJyJ1c2Ugc3RyaWN0IjsnLAogICAgICAgICAgICBnbG9iYWxCbG9jaywKICAgICAgICAgICAgInJldHVybiB7IgogICAgICAgICAgXTsKICAgICAgICAgIE9iamVjdC5rZXlzKHByb2NlZHVyZXMpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBjb2RlLnB1c2goJyInLCBuYW1lLCAnIjonLCBwcm9jZWR1cmVzW25hbWVdLnRvU3RyaW5nKCksICIsIik7CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvZGUucHVzaCgifSIpOwogICAgICAgICAgdmFyIHNyYyA9IGpvaW4oY29kZSkucmVwbGFjZSgvOy9nLCAiO1xuIikucmVwbGFjZSgvfS9nLCAifVxuIikucmVwbGFjZSgvey9nLCAie1xuIik7CiAgICAgICAgICB2YXIgcHJvYzIgPSBGdW5jdGlvbi5hcHBseShudWxsLCBsaW5rZWROYW1lcy5jb25jYXQoc3JjKSk7CiAgICAgICAgICByZXR1cm4gcHJvYzIuYXBwbHkobnVsbCwgbGlua2VkVmFsdWVzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGdsb2JhbDogZ2xvYmFsQmxvY2ssCiAgICAgICAgICBsaW5rLAogICAgICAgICAgYmxvY2ssCiAgICAgICAgICBwcm9jLAogICAgICAgICAgc2NvcGUsCiAgICAgICAgICBjb25kOiBjb25kaXRpb25hbCwKICAgICAgICAgIGNvbXBpbGUKICAgICAgICB9OwogICAgICB9CiAgICAgIHZhciBDVVRFX0NPTVBPTkVOVFMgPSAieHl6dyIuc3BsaXQoIiIpOwogICAgICB2YXIgR0xfVU5TSUdORURfQllURSQ4ID0gNTEyMTsKICAgICAgdmFyIEFUVFJJQl9TVEFURV9QT0lOVEVSID0gMTsKICAgICAgdmFyIEFUVFJJQl9TVEFURV9DT05TVEFOVCA9IDI7CiAgICAgIHZhciBEWU5fRlVOQyQxID0gMDsKICAgICAgdmFyIERZTl9QUk9QJDEgPSAxOwogICAgICB2YXIgRFlOX0NPTlRFWFQkMSA9IDI7CiAgICAgIHZhciBEWU5fU1RBVEUkMSA9IDM7CiAgICAgIHZhciBEWU5fVEhVTksgPSA0OwogICAgICB2YXIgRFlOX0NPTlNUQU5UJDEgPSA1OwogICAgICB2YXIgRFlOX0FSUkFZJDEgPSA2OwogICAgICB2YXIgU19ESVRIRVIgPSAiZGl0aGVyIjsKICAgICAgdmFyIFNfQkxFTkRfRU5BQkxFID0gImJsZW5kLmVuYWJsZSI7CiAgICAgIHZhciBTX0JMRU5EX0NPTE9SID0gImJsZW5kLmNvbG9yIjsKICAgICAgdmFyIFNfQkxFTkRfRVFVQVRJT04gPSAiYmxlbmQuZXF1YXRpb24iOwogICAgICB2YXIgU19CTEVORF9GVU5DID0gImJsZW5kLmZ1bmMiOwogICAgICB2YXIgU19ERVBUSF9FTkFCTEUgPSAiZGVwdGguZW5hYmxlIjsKICAgICAgdmFyIFNfREVQVEhfRlVOQyA9ICJkZXB0aC5mdW5jIjsKICAgICAgdmFyIFNfREVQVEhfUkFOR0UgPSAiZGVwdGgucmFuZ2UiOwogICAgICB2YXIgU19ERVBUSF9NQVNLID0gImRlcHRoLm1hc2siOwogICAgICB2YXIgU19DT0xPUl9NQVNLID0gImNvbG9yTWFzayI7CiAgICAgIHZhciBTX0NVTExfRU5BQkxFID0gImN1bGwuZW5hYmxlIjsKICAgICAgdmFyIFNfQ1VMTF9GQUNFID0gImN1bGwuZmFjZSI7CiAgICAgIHZhciBTX0ZST05UX0ZBQ0UgPSAiZnJvbnRGYWNlIjsKICAgICAgdmFyIFNfTElORV9XSURUSCA9ICJsaW5lV2lkdGgiOwogICAgICB2YXIgU19QT0xZR09OX09GRlNFVF9FTkFCTEUgPSAicG9seWdvbk9mZnNldC5lbmFibGUiOwogICAgICB2YXIgU19QT0xZR09OX09GRlNFVF9PRkZTRVQgPSAicG9seWdvbk9mZnNldC5vZmZzZXQiOwogICAgICB2YXIgU19TQU1QTEVfQUxQSEEgPSAic2FtcGxlLmFscGhhIjsKICAgICAgdmFyIFNfU0FNUExFX0VOQUJMRSA9ICJzYW1wbGUuZW5hYmxlIjsKICAgICAgdmFyIFNfU0FNUExFX0NPVkVSQUdFID0gInNhbXBsZS5jb3ZlcmFnZSI7CiAgICAgIHZhciBTX1NURU5DSUxfRU5BQkxFID0gInN0ZW5jaWwuZW5hYmxlIjsKICAgICAgdmFyIFNfU1RFTkNJTF9NQVNLID0gInN0ZW5jaWwubWFzayI7CiAgICAgIHZhciBTX1NURU5DSUxfRlVOQyA9ICJzdGVuY2lsLmZ1bmMiOwogICAgICB2YXIgU19TVEVOQ0lMX09QRlJPTlQgPSAic3RlbmNpbC5vcEZyb250IjsKICAgICAgdmFyIFNfU1RFTkNJTF9PUEJBQ0sgPSAic3RlbmNpbC5vcEJhY2siOwogICAgICB2YXIgU19TQ0lTU09SX0VOQUJMRSA9ICJzY2lzc29yLmVuYWJsZSI7CiAgICAgIHZhciBTX1NDSVNTT1JfQk9YID0gInNjaXNzb3IuYm94IjsKICAgICAgdmFyIFNfVklFV1BPUlQgPSAidmlld3BvcnQiOwogICAgICB2YXIgU19QUk9GSUxFID0gInByb2ZpbGUiOwogICAgICB2YXIgU19GUkFNRUJVRkZFUiA9ICJmcmFtZWJ1ZmZlciI7CiAgICAgIHZhciBTX1ZFUlQgPSAidmVydCI7CiAgICAgIHZhciBTX0ZSQUcgPSAiZnJhZyI7CiAgICAgIHZhciBTX0VMRU1FTlRTID0gImVsZW1lbnRzIjsKICAgICAgdmFyIFNfUFJJTUlUSVZFID0gInByaW1pdGl2ZSI7CiAgICAgIHZhciBTX0NPVU5UID0gImNvdW50IjsKICAgICAgdmFyIFNfT0ZGU0VUID0gIm9mZnNldCI7CiAgICAgIHZhciBTX0lOU1RBTkNFUyA9ICJpbnN0YW5jZXMiOwogICAgICB2YXIgU19WQU8gPSAidmFvIjsKICAgICAgdmFyIFNVRkZJWF9XSURUSCA9ICJXaWR0aCI7CiAgICAgIHZhciBTVUZGSVhfSEVJR0hUID0gIkhlaWdodCI7CiAgICAgIHZhciBTX0ZSQU1FQlVGRkVSX1dJRFRIID0gU19GUkFNRUJVRkZFUiArIFNVRkZJWF9XSURUSDsKICAgICAgdmFyIFNfRlJBTUVCVUZGRVJfSEVJR0hUID0gU19GUkFNRUJVRkZFUiArIFNVRkZJWF9IRUlHSFQ7CiAgICAgIHZhciBTX1ZJRVdQT1JUX1dJRFRIID0gU19WSUVXUE9SVCArIFNVRkZJWF9XSURUSDsKICAgICAgdmFyIFNfVklFV1BPUlRfSEVJR0hUID0gU19WSUVXUE9SVCArIFNVRkZJWF9IRUlHSFQ7CiAgICAgIHZhciBTX0RSQVdJTkdCVUZGRVIgPSAiZHJhd2luZ0J1ZmZlciI7CiAgICAgIHZhciBTX0RSQVdJTkdCVUZGRVJfV0lEVEggPSBTX0RSQVdJTkdCVUZGRVIgKyBTVUZGSVhfV0lEVEg7CiAgICAgIHZhciBTX0RSQVdJTkdCVUZGRVJfSEVJR0hUID0gU19EUkFXSU5HQlVGRkVSICsgU1VGRklYX0hFSUdIVDsKICAgICAgdmFyIE5FU1RFRF9PUFRJT05TID0gWwogICAgICAgIFNfQkxFTkRfRlVOQywKICAgICAgICBTX0JMRU5EX0VRVUFUSU9OLAogICAgICAgIFNfU1RFTkNJTF9GVU5DLAogICAgICAgIFNfU1RFTkNJTF9PUEZST05ULAogICAgICAgIFNfU1RFTkNJTF9PUEJBQ0ssCiAgICAgICAgU19TQU1QTEVfQ09WRVJBR0UsCiAgICAgICAgU19WSUVXUE9SVCwKICAgICAgICBTX1NDSVNTT1JfQk9YLAogICAgICAgIFNfUE9MWUdPTl9PRkZTRVRfT0ZGU0VUCiAgICAgIF07CiAgICAgIHZhciBHTF9BUlJBWV9CVUZGRVIkMiA9IDM0OTYyOwogICAgICB2YXIgR0xfRUxFTUVOVF9BUlJBWV9CVUZGRVIkMiA9IDM0OTYzOwogICAgICB2YXIgR0xfRlJBR01FTlRfU0hBREVSJDEgPSAzNTYzMjsKICAgICAgdmFyIEdMX1ZFUlRFWF9TSEFERVIkMSA9IDM1NjMzOwogICAgICB2YXIgR0xfVEVYVFVSRV8yRCQzID0gMzU1MzsKICAgICAgdmFyIEdMX1RFWFRVUkVfQ1VCRV9NQVAkMiA9IDM0MDY3OwogICAgICB2YXIgR0xfQ1VMTF9GQUNFID0gMjg4NDsKICAgICAgdmFyIEdMX0JMRU5EID0gMzA0MjsKICAgICAgdmFyIEdMX0RJVEhFUiA9IDMwMjQ7CiAgICAgIHZhciBHTF9TVEVOQ0lMX1RFU1QgPSAyOTYwOwogICAgICB2YXIgR0xfREVQVEhfVEVTVCA9IDI5Mjk7CiAgICAgIHZhciBHTF9TQ0lTU09SX1RFU1QgPSAzMDg5OwogICAgICB2YXIgR0xfUE9MWUdPTl9PRkZTRVRfRklMTCA9IDMyODIzOwogICAgICB2YXIgR0xfU0FNUExFX0FMUEhBX1RPX0NPVkVSQUdFID0gMzI5MjY7CiAgICAgIHZhciBHTF9TQU1QTEVfQ09WRVJBR0UgPSAzMjkyODsKICAgICAgdmFyIEdMX0ZMT0FUJDggPSA1MTI2OwogICAgICB2YXIgR0xfRkxPQVRfVkVDMiA9IDM1NjY0OwogICAgICB2YXIgR0xfRkxPQVRfVkVDMyA9IDM1NjY1OwogICAgICB2YXIgR0xfRkxPQVRfVkVDNCA9IDM1NjY2OwogICAgICB2YXIgR0xfSU5UJDMgPSA1MTI0OwogICAgICB2YXIgR0xfSU5UX1ZFQzIgPSAzNTY2NzsKICAgICAgdmFyIEdMX0lOVF9WRUMzID0gMzU2Njg7CiAgICAgIHZhciBHTF9JTlRfVkVDNCA9IDM1NjY5OwogICAgICB2YXIgR0xfQk9PTCA9IDM1NjcwOwogICAgICB2YXIgR0xfQk9PTF9WRUMyID0gMzU2NzE7CiAgICAgIHZhciBHTF9CT09MX1ZFQzMgPSAzNTY3MjsKICAgICAgdmFyIEdMX0JPT0xfVkVDNCA9IDM1NjczOwogICAgICB2YXIgR0xfRkxPQVRfTUFUMiA9IDM1Njc0OwogICAgICB2YXIgR0xfRkxPQVRfTUFUMyA9IDM1Njc1OwogICAgICB2YXIgR0xfRkxPQVRfTUFUNCA9IDM1Njc2OwogICAgICB2YXIgR0xfU0FNUExFUl8yRCA9IDM1Njc4OwogICAgICB2YXIgR0xfU0FNUExFUl9DVUJFID0gMzU2ODA7CiAgICAgIHZhciBHTF9UUklBTkdMRVMkMSA9IDQ7CiAgICAgIHZhciBHTF9GUk9OVCA9IDEwMjg7CiAgICAgIHZhciBHTF9CQUNLID0gMTAyOTsKICAgICAgdmFyIEdMX0NXID0gMjMwNDsKICAgICAgdmFyIEdMX0NDVyA9IDIzMDU7CiAgICAgIHZhciBHTF9NSU5fRVhUID0gMzI3NzU7CiAgICAgIHZhciBHTF9NQVhfRVhUID0gMzI3NzY7CiAgICAgIHZhciBHTF9BTFdBWVMgPSA1MTk7CiAgICAgIHZhciBHTF9LRUVQID0gNzY4MDsKICAgICAgdmFyIEdMX1pFUk8gPSAwOwogICAgICB2YXIgR0xfT05FID0gMTsKICAgICAgdmFyIEdMX0ZVTkNfQUREID0gMzI3NzQ7CiAgICAgIHZhciBHTF9MRVNTID0gNTEzOwogICAgICB2YXIgR0xfRlJBTUVCVUZGRVIkMiA9IDM2MTYwOwogICAgICB2YXIgR0xfQ09MT1JfQVRUQUNITUVOVDAkMiA9IDM2MDY0OwogICAgICB2YXIgYmxlbmRGdW5jcyA9IHsKICAgICAgICAiMCI6IDAsCiAgICAgICAgIjEiOiAxLAogICAgICAgICJ6ZXJvIjogMCwKICAgICAgICAib25lIjogMSwKICAgICAgICAic3JjIGNvbG9yIjogNzY4LAogICAgICAgICJvbmUgbWludXMgc3JjIGNvbG9yIjogNzY5LAogICAgICAgICJzcmMgYWxwaGEiOiA3NzAsCiAgICAgICAgIm9uZSBtaW51cyBzcmMgYWxwaGEiOiA3NzEsCiAgICAgICAgImRzdCBjb2xvciI6IDc3NCwKICAgICAgICAib25lIG1pbnVzIGRzdCBjb2xvciI6IDc3NSwKICAgICAgICAiZHN0IGFscGhhIjogNzcyLAogICAgICAgICJvbmUgbWludXMgZHN0IGFscGhhIjogNzczLAogICAgICAgICJjb25zdGFudCBjb2xvciI6IDMyNzY5LAogICAgICAgICJvbmUgbWludXMgY29uc3RhbnQgY29sb3IiOiAzMjc3MCwKICAgICAgICAiY29uc3RhbnQgYWxwaGEiOiAzMjc3MSwKICAgICAgICAib25lIG1pbnVzIGNvbnN0YW50IGFscGhhIjogMzI3NzIsCiAgICAgICAgInNyYyBhbHBoYSBzYXR1cmF0ZSI6IDc3NgogICAgICB9OwogICAgICB2YXIgaW52YWxpZEJsZW5kQ29tYmluYXRpb25zID0gWwogICAgICAgICJjb25zdGFudCBjb2xvciwgY29uc3RhbnQgYWxwaGEiLAogICAgICAgICJvbmUgbWludXMgY29uc3RhbnQgY29sb3IsIGNvbnN0YW50IGFscGhhIiwKICAgICAgICAiY29uc3RhbnQgY29sb3IsIG9uZSBtaW51cyBjb25zdGFudCBhbHBoYSIsCiAgICAgICAgIm9uZSBtaW51cyBjb25zdGFudCBjb2xvciwgb25lIG1pbnVzIGNvbnN0YW50IGFscGhhIiwKICAgICAgICAiY29uc3RhbnQgYWxwaGEsIGNvbnN0YW50IGNvbG9yIiwKICAgICAgICAiY29uc3RhbnQgYWxwaGEsIG9uZSBtaW51cyBjb25zdGFudCBjb2xvciIsCiAgICAgICAgIm9uZSBtaW51cyBjb25zdGFudCBhbHBoYSwgY29uc3RhbnQgY29sb3IiLAogICAgICAgICJvbmUgbWludXMgY29uc3RhbnQgYWxwaGEsIG9uZSBtaW51cyBjb25zdGFudCBjb2xvciIKICAgICAgXTsKICAgICAgdmFyIGNvbXBhcmVGdW5jcyA9IHsKICAgICAgICAibmV2ZXIiOiA1MTIsCiAgICAgICAgImxlc3MiOiA1MTMsCiAgICAgICAgIjwiOiA1MTMsCiAgICAgICAgImVxdWFsIjogNTE0LAogICAgICAgICI9IjogNTE0LAogICAgICAgICI9PSI6IDUxNCwKICAgICAgICAiPT09IjogNTE0LAogICAgICAgICJsZXF1YWwiOiA1MTUsCiAgICAgICAgIjw9IjogNTE1LAogICAgICAgICJncmVhdGVyIjogNTE2LAogICAgICAgICI+IjogNTE2LAogICAgICAgICJub3RlcXVhbCI6IDUxNywKICAgICAgICAiIT0iOiA1MTcsCiAgICAgICAgIiE9PSI6IDUxNywKICAgICAgICAiZ2VxdWFsIjogNTE4LAogICAgICAgICI+PSI6IDUxOCwKICAgICAgICAiYWx3YXlzIjogNTE5CiAgICAgIH07CiAgICAgIHZhciBzdGVuY2lsT3BzID0gewogICAgICAgICIwIjogMCwKICAgICAgICAiemVybyI6IDAsCiAgICAgICAgImtlZXAiOiA3NjgwLAogICAgICAgICJyZXBsYWNlIjogNzY4MSwKICAgICAgICAiaW5jcmVtZW50IjogNzY4MiwKICAgICAgICAiZGVjcmVtZW50IjogNzY4MywKICAgICAgICAiaW5jcmVtZW50IHdyYXAiOiAzNDA1NSwKICAgICAgICAiZGVjcmVtZW50IHdyYXAiOiAzNDA1NiwKICAgICAgICAiaW52ZXJ0IjogNTM4NgogICAgICB9OwogICAgICB2YXIgc2hhZGVyVHlwZSA9IHsKICAgICAgICAiZnJhZyI6IEdMX0ZSQUdNRU5UX1NIQURFUiQxLAogICAgICAgICJ2ZXJ0IjogR0xfVkVSVEVYX1NIQURFUiQxCiAgICAgIH07CiAgICAgIHZhciBvcmllbnRhdGlvblR5cGUgPSB7CiAgICAgICAgImN3IjogR0xfQ1csCiAgICAgICAgImNjdyI6IEdMX0NDVwogICAgICB9OwogICAgICBmdW5jdGlvbiBpc0J1ZmZlckFyZ3MoeCkgewogICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHgpIHx8IGlzVHlwZWRBcnJheTIoeCkgfHwgaXNOREFycmF5TGlrZSh4KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzb3J0U3RhdGUoc3RhdGUpIHsKICAgICAgICByZXR1cm4gc3RhdGUuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICBpZiAoYSA9PT0gU19WSUVXUE9SVCkgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9IGVsc2UgaWYgKGIgPT09IFNfVklFV1BPUlQpIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYSA8IGIgPyAtMSA6IDE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gRGVjbGFyYXRpb24odGhpc0RlcCwgY29udGV4dERlcCwgcHJvcERlcCwgYXBwZW5kKSB7CiAgICAgICAgdGhpcy50aGlzRGVwID0gdGhpc0RlcDsKICAgICAgICB0aGlzLmNvbnRleHREZXAgPSBjb250ZXh0RGVwOwogICAgICAgIHRoaXMucHJvcERlcCA9IHByb3BEZXA7CiAgICAgICAgdGhpcy5hcHBlbmQgPSBhcHBlbmQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNTdGF0aWMoZGVjbCkgewogICAgICAgIHJldHVybiBkZWNsICYmICEoZGVjbC50aGlzRGVwIHx8IGRlY2wuY29udGV4dERlcCB8fCBkZWNsLnByb3BEZXApOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN0YXRpY0RlY2woYXBwZW5kKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEZWNsYXJhdGlvbihmYWxzZSwgZmFsc2UsIGZhbHNlLCBhcHBlbmQpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNyZWF0ZUR5bmFtaWNEZWNsKGR5biwgYXBwZW5kKSB7CiAgICAgICAgdmFyIHR5cGUgPSBkeW4udHlwZTsKICAgICAgICBpZiAodHlwZSA9PT0gRFlOX0ZVTkMkMSkgewogICAgICAgICAgdmFyIG51bUFyZ3MgPSBkeW4uZGF0YS5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gbmV3IERlY2xhcmF0aW9uKAogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICBudW1BcmdzID49IDEsCiAgICAgICAgICAgIG51bUFyZ3MgPj0gMiwKICAgICAgICAgICAgYXBwZW5kCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gRFlOX1RIVU5LKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IGR5bi5kYXRhOwogICAgICAgICAgcmV0dXJuIG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgZGF0YS50aGlzRGVwLAogICAgICAgICAgICBkYXRhLmNvbnRleHREZXAsCiAgICAgICAgICAgIGRhdGEucHJvcERlcCwKICAgICAgICAgICAgYXBwZW5kCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gRFlOX0NPTlNUQU5UJDEpIHsKICAgICAgICAgIHJldHVybiBuZXcgRGVjbGFyYXRpb24oCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIGFwcGVuZAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IERZTl9BUlJBWSQxKSB7CiAgICAgICAgICB2YXIgdGhpc0RlcCA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbnRleHREZXAgPSBmYWxzZTsKICAgICAgICAgIHZhciBwcm9wRGVwID0gZmFsc2U7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGR5bi5kYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIHZhciBzdWJEeW4gPSBkeW4uZGF0YVtpXTsKICAgICAgICAgICAgaWYgKHN1YkR5bi50eXBlID09PSBEWU5fUFJPUCQxKSB7CiAgICAgICAgICAgICAgcHJvcERlcCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3ViRHluLnR5cGUgPT09IERZTl9DT05URVhUJDEpIHsKICAgICAgICAgICAgICBjb250ZXh0RGVwID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdWJEeW4udHlwZSA9PT0gRFlOX1NUQVRFJDEpIHsKICAgICAgICAgICAgICB0aGlzRGVwID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdWJEeW4udHlwZSA9PT0gRFlOX0ZVTkMkMSkgewogICAgICAgICAgICAgIHRoaXNEZXAgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBzdWJBcmdzID0gc3ViRHluLmRhdGE7CiAgICAgICAgICAgICAgaWYgKHN1YkFyZ3MgPj0gMSkgewogICAgICAgICAgICAgICAgY29udGV4dERlcCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzdWJBcmdzID49IDIpIHsKICAgICAgICAgICAgICAgIHByb3BEZXAgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdWJEeW4udHlwZSA9PT0gRFlOX1RIVU5LKSB7CiAgICAgICAgICAgICAgdGhpc0RlcCA9IHRoaXNEZXAgfHwgc3ViRHluLmRhdGEudGhpc0RlcDsKICAgICAgICAgICAgICBjb250ZXh0RGVwID0gY29udGV4dERlcCB8fCBzdWJEeW4uZGF0YS5jb250ZXh0RGVwOwogICAgICAgICAgICAgIHByb3BEZXAgPSBwcm9wRGVwIHx8IHN1YkR5bi5kYXRhLnByb3BEZXA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgRGVjbGFyYXRpb24oCiAgICAgICAgICAgIHRoaXNEZXAsCiAgICAgICAgICAgIGNvbnRleHREZXAsCiAgICAgICAgICAgIHByb3BEZXAsCiAgICAgICAgICAgIGFwcGVuZAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgdHlwZSA9PT0gRFlOX1NUQVRFJDEsCiAgICAgICAgICAgIHR5cGUgPT09IERZTl9DT05URVhUJDEsCiAgICAgICAgICAgIHR5cGUgPT09IERZTl9QUk9QJDEsCiAgICAgICAgICAgIGFwcGVuZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIFNDT1BFX0RFQ0wgPSBuZXcgRGVjbGFyYXRpb24oZmFsc2UsIGZhbHNlLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgIH0pOwogICAgICBmdW5jdGlvbiByZWdsQ29yZShnbCwgc3RyaW5nU3RvcmUsIGV4dGVuc2lvbnMsIGxpbWl0cywgYnVmZmVyU3RhdGUsIGVsZW1lbnRTdGF0ZSwgdGV4dHVyZVN0YXRlLCBmcmFtZWJ1ZmZlclN0YXRlLCB1bmlmb3JtU3RhdGUsIGF0dHJpYnV0ZVN0YXRlLCBzaGFkZXJTdGF0ZSwgZHJhd1N0YXRlLCBjb250ZXh0U3RhdGUsIHRpbWVyLCBjb25maWcpIHsKICAgICAgICB2YXIgQXR0cmlidXRlUmVjb3JkMiA9IGF0dHJpYnV0ZVN0YXRlLlJlY29yZDsKICAgICAgICB2YXIgYmxlbmRFcXVhdGlvbnMgPSB7CiAgICAgICAgICAiYWRkIjogMzI3NzQsCiAgICAgICAgICAic3VidHJhY3QiOiAzMjc3OCwKICAgICAgICAgICJyZXZlcnNlIHN1YnRyYWN0IjogMzI3NzkKICAgICAgICB9OwogICAgICAgIGlmIChleHRlbnNpb25zLmV4dF9ibGVuZF9taW5tYXgpIHsKICAgICAgICAgIGJsZW5kRXF1YXRpb25zLm1pbiA9IEdMX01JTl9FWFQ7CiAgICAgICAgICBibGVuZEVxdWF0aW9ucy5tYXggPSBHTF9NQVhfRVhUOwogICAgICAgIH0KICAgICAgICB2YXIgZXh0SW5zdGFuY2luZyA9IGV4dGVuc2lvbnMuYW5nbGVfaW5zdGFuY2VkX2FycmF5czsKICAgICAgICB2YXIgZXh0RHJhd0J1ZmZlcnMgPSBleHRlbnNpb25zLndlYmdsX2RyYXdfYnVmZmVyczsKICAgICAgICB2YXIgZXh0VmVydGV4QXJyYXlzID0gZXh0ZW5zaW9ucy5vZXNfdmVydGV4X2FycmF5X29iamVjdDsKICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gewogICAgICAgICAgZGlydHk6IHRydWUsCiAgICAgICAgICBwcm9maWxlOiBjb25maWcucHJvZmlsZQogICAgICAgIH07CiAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHt9OwogICAgICAgIHZhciBHTF9TVEFURV9OQU1FUyA9IFtdOwogICAgICAgIHZhciBHTF9GTEFHUyA9IHt9OwogICAgICAgIHZhciBHTF9WQVJJQUJMRVMgPSB7fTsKICAgICAgICBmdW5jdGlvbiBwcm9wTmFtZShuYW1lKSB7CiAgICAgICAgICByZXR1cm4gbmFtZS5yZXBsYWNlKCIuIiwgIl8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhdGVGbGFnKHNuYW1lLCBjYXAsIGluaXQpIHsKICAgICAgICAgIHZhciBuYW1lID0gcHJvcE5hbWUoc25hbWUpOwogICAgICAgICAgR0xfU1RBVEVfTkFNRVMucHVzaChzbmFtZSk7CiAgICAgICAgICBuZXh0U3RhdGVbbmFtZV0gPSBjdXJyZW50U3RhdGVbbmFtZV0gPSAhIWluaXQ7CiAgICAgICAgICBHTF9GTEFHU1tuYW1lXSA9IGNhcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhdGVWYXJpYWJsZShzbmFtZSwgZnVuYywgaW5pdCkgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wTmFtZShzbmFtZSk7CiAgICAgICAgICBHTF9TVEFURV9OQU1FUy5wdXNoKHNuYW1lKTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGluaXQpKSB7CiAgICAgICAgICAgIGN1cnJlbnRTdGF0ZVtuYW1lXSA9IGluaXQuc2xpY2UoKTsKICAgICAgICAgICAgbmV4dFN0YXRlW25hbWVdID0gaW5pdC5zbGljZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFN0YXRlW25hbWVdID0gbmV4dFN0YXRlW25hbWVdID0gaW5pdDsKICAgICAgICAgIH0KICAgICAgICAgIEdMX1ZBUklBQkxFU1tuYW1lXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICAgIHN0YXRlRmxhZyhTX0RJVEhFUiwgR0xfRElUSEVSKTsKICAgICAgICBzdGF0ZUZsYWcoU19CTEVORF9FTkFCTEUsIEdMX0JMRU5EKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKFNfQkxFTkRfQ09MT1IsICJibGVuZENvbG9yIiwgWzAsIDAsIDAsIDBdKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKAogICAgICAgICAgU19CTEVORF9FUVVBVElPTiwKICAgICAgICAgICJibGVuZEVxdWF0aW9uU2VwYXJhdGUiLAogICAgICAgICAgW0dMX0ZVTkNfQURELCBHTF9GVU5DX0FERF0KICAgICAgICApOwogICAgICAgIHN0YXRlVmFyaWFibGUoCiAgICAgICAgICBTX0JMRU5EX0ZVTkMsCiAgICAgICAgICAiYmxlbmRGdW5jU2VwYXJhdGUiLAogICAgICAgICAgW0dMX09ORSwgR0xfWkVSTywgR0xfT05FLCBHTF9aRVJPXQogICAgICAgICk7CiAgICAgICAgc3RhdGVGbGFnKFNfREVQVEhfRU5BQkxFLCBHTF9ERVBUSF9URVNULCB0cnVlKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKFNfREVQVEhfRlVOQywgImRlcHRoRnVuYyIsIEdMX0xFU1MpOwogICAgICAgIHN0YXRlVmFyaWFibGUoU19ERVBUSF9SQU5HRSwgImRlcHRoUmFuZ2UiLCBbMCwgMV0pOwogICAgICAgIHN0YXRlVmFyaWFibGUoU19ERVBUSF9NQVNLLCAiZGVwdGhNYXNrIiwgdHJ1ZSk7CiAgICAgICAgc3RhdGVWYXJpYWJsZShTX0NPTE9SX01BU0ssIFNfQ09MT1JfTUFTSywgW3RydWUsIHRydWUsIHRydWUsIHRydWVdKTsKICAgICAgICBzdGF0ZUZsYWcoU19DVUxMX0VOQUJMRSwgR0xfQ1VMTF9GQUNFKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKFNfQ1VMTF9GQUNFLCAiY3VsbEZhY2UiLCBHTF9CQUNLKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKFNfRlJPTlRfRkFDRSwgU19GUk9OVF9GQUNFLCBHTF9DQ1cpOwogICAgICAgIHN0YXRlVmFyaWFibGUoU19MSU5FX1dJRFRILCBTX0xJTkVfV0lEVEgsIDEpOwogICAgICAgIHN0YXRlRmxhZyhTX1BPTFlHT05fT0ZGU0VUX0VOQUJMRSwgR0xfUE9MWUdPTl9PRkZTRVRfRklMTCk7CiAgICAgICAgc3RhdGVWYXJpYWJsZShTX1BPTFlHT05fT0ZGU0VUX09GRlNFVCwgInBvbHlnb25PZmZzZXQiLCBbMCwgMF0pOwogICAgICAgIHN0YXRlRmxhZyhTX1NBTVBMRV9BTFBIQSwgR0xfU0FNUExFX0FMUEhBX1RPX0NPVkVSQUdFKTsKICAgICAgICBzdGF0ZUZsYWcoU19TQU1QTEVfRU5BQkxFLCBHTF9TQU1QTEVfQ09WRVJBR0UpOwogICAgICAgIHN0YXRlVmFyaWFibGUoU19TQU1QTEVfQ09WRVJBR0UsICJzYW1wbGVDb3ZlcmFnZSIsIFsxLCBmYWxzZV0pOwogICAgICAgIHN0YXRlRmxhZyhTX1NURU5DSUxfRU5BQkxFLCBHTF9TVEVOQ0lMX1RFU1QpOwogICAgICAgIHN0YXRlVmFyaWFibGUoU19TVEVOQ0lMX01BU0ssICJzdGVuY2lsTWFzayIsIC0xKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKFNfU1RFTkNJTF9GVU5DLCAic3RlbmNpbEZ1bmMiLCBbR0xfQUxXQVlTLCAwLCAtMV0pOwogICAgICAgIHN0YXRlVmFyaWFibGUoCiAgICAgICAgICBTX1NURU5DSUxfT1BGUk9OVCwKICAgICAgICAgICJzdGVuY2lsT3BTZXBhcmF0ZSIsCiAgICAgICAgICBbR0xfRlJPTlQsIEdMX0tFRVAsIEdMX0tFRVAsIEdMX0tFRVBdCiAgICAgICAgKTsKICAgICAgICBzdGF0ZVZhcmlhYmxlKAogICAgICAgICAgU19TVEVOQ0lMX09QQkFDSywKICAgICAgICAgICJzdGVuY2lsT3BTZXBhcmF0ZSIsCiAgICAgICAgICBbR0xfQkFDSywgR0xfS0VFUCwgR0xfS0VFUCwgR0xfS0VFUF0KICAgICAgICApOwogICAgICAgIHN0YXRlRmxhZyhTX1NDSVNTT1JfRU5BQkxFLCBHTF9TQ0lTU09SX1RFU1QpOwogICAgICAgIHN0YXRlVmFyaWFibGUoCiAgICAgICAgICBTX1NDSVNTT1JfQk9YLAogICAgICAgICAgInNjaXNzb3IiLAogICAgICAgICAgWzAsIDAsIGdsLmRyYXdpbmdCdWZmZXJXaWR0aCwgZ2wuZHJhd2luZ0J1ZmZlckhlaWdodF0KICAgICAgICApOwogICAgICAgIHN0YXRlVmFyaWFibGUoCiAgICAgICAgICBTX1ZJRVdQT1JULAogICAgICAgICAgU19WSUVXUE9SVCwKICAgICAgICAgIFswLCAwLCBnbC5kcmF3aW5nQnVmZmVyV2lkdGgsIGdsLmRyYXdpbmdCdWZmZXJIZWlnaHRdCiAgICAgICAgKTsKICAgICAgICB2YXIgc2hhcmVkU3RhdGUgPSB7CiAgICAgICAgICBnbCwKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHRTdGF0ZSwKICAgICAgICAgIHN0cmluZ3M6IHN0cmluZ1N0b3JlLAogICAgICAgICAgbmV4dDogbmV4dFN0YXRlLAogICAgICAgICAgY3VycmVudDogY3VycmVudFN0YXRlLAogICAgICAgICAgZHJhdzogZHJhd1N0YXRlLAogICAgICAgICAgZWxlbWVudHM6IGVsZW1lbnRTdGF0ZSwKICAgICAgICAgIGJ1ZmZlcjogYnVmZmVyU3RhdGUsCiAgICAgICAgICBzaGFkZXI6IHNoYWRlclN0YXRlLAogICAgICAgICAgYXR0cmlidXRlczogYXR0cmlidXRlU3RhdGUuc3RhdGUsCiAgICAgICAgICB2YW86IGF0dHJpYnV0ZVN0YXRlLAogICAgICAgICAgdW5pZm9ybXM6IHVuaWZvcm1TdGF0ZSwKICAgICAgICAgIGZyYW1lYnVmZmVyOiBmcmFtZWJ1ZmZlclN0YXRlLAogICAgICAgICAgZXh0ZW5zaW9ucywKICAgICAgICAgIHRpbWVyLAogICAgICAgICAgaXNCdWZmZXJBcmdzCiAgICAgICAgfTsKICAgICAgICB2YXIgc2hhcmVkQ29uc3RhbnRzID0gewogICAgICAgICAgcHJpbVR5cGVzLAogICAgICAgICAgY29tcGFyZUZ1bmNzLAogICAgICAgICAgYmxlbmRGdW5jcywKICAgICAgICAgIGJsZW5kRXF1YXRpb25zLAogICAgICAgICAgc3RlbmNpbE9wcywKICAgICAgICAgIGdsVHlwZXMsCiAgICAgICAgICBvcmllbnRhdGlvblR5cGUKICAgICAgICB9OwogICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICBzaGFyZWRTdGF0ZS5pc0FycmF5TGlrZSA9IGlzQXJyYXlMaWtlOwogICAgICAgIH0pOwogICAgICAgIGlmIChleHREcmF3QnVmZmVycykgewogICAgICAgICAgc2hhcmVkQ29uc3RhbnRzLmJhY2tCdWZmZXIgPSBbR0xfQkFDS107CiAgICAgICAgICBzaGFyZWRDb25zdGFudHMuZHJhd0J1ZmZlciA9IGxvb3AobGltaXRzLm1heERyYXdidWZmZXJzLCBmdW5jdGlvbihpKSB7CiAgICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFswXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbG9vcChpLCBmdW5jdGlvbihqKSB7CiAgICAgICAgICAgICAgcmV0dXJuIEdMX0NPTE9SX0FUVEFDSE1FTlQwJDIgKyBqOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZHJhd0NhbGxDb3VudGVyID0gMDsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSRUdMRW52aXJvbm1lbnQoKSB7CiAgICAgICAgICB2YXIgZW52ID0gY3JlYXRlRW52aXJvbm1lbnQoKTsKICAgICAgICAgIHZhciBsaW5rID0gZW52Lmxpbms7CiAgICAgICAgICB2YXIgZ2xvYmFsID0gZW52Lmdsb2JhbDsKICAgICAgICAgIGVudi5pZCA9IGRyYXdDYWxsQ291bnRlcisrOwogICAgICAgICAgZW52LmJhdGNoSWQgPSAiMCI7CiAgICAgICAgICB2YXIgU0hBUkVEID0gbGluayhzaGFyZWRTdGF0ZSk7CiAgICAgICAgICB2YXIgc2hhcmVkID0gZW52LnNoYXJlZCA9IHsKICAgICAgICAgICAgcHJvcHM6ICJhMCIKICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3Qua2V5cyhzaGFyZWRTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgIHNoYXJlZFtwcm9wXSA9IGdsb2JhbC5kZWYoU0hBUkVELCAiLiIsIHByb3ApOwogICAgICAgICAgfSk7CiAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBlbnYuQ0hFQ0sgPSBsaW5rKGNoZWNrJDEpOwogICAgICAgICAgICBlbnYuY29tbWFuZFN0ciA9IGNoZWNrJDEuZ3Vlc3NDb21tYW5kKCk7CiAgICAgICAgICAgIGVudi5jb21tYW5kID0gbGluayhlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgIGVudi5hc3NlcnQgPSBmdW5jdGlvbihibG9jaywgcHJlZCwgbWVzc2FnZSkgewogICAgICAgICAgICAgIGJsb2NrKAogICAgICAgICAgICAgICAgImlmKCEoIiwKICAgICAgICAgICAgICAgIHByZWQsCiAgICAgICAgICAgICAgICAiKSkiLAogICAgICAgICAgICAgICAgdGhpcy5DSEVDSywKICAgICAgICAgICAgICAgICIuY29tbWFuZFJhaXNlKCIsCiAgICAgICAgICAgICAgICBsaW5rKG1lc3NhZ2UpLAogICAgICAgICAgICAgICAgIiwiLAogICAgICAgICAgICAgICAgdGhpcy5jb21tYW5kLAogICAgICAgICAgICAgICAgIik7IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHNoYXJlZENvbnN0YW50cy5pbnZhbGlkQmxlbmRDb21iaW5hdGlvbnMgPSBpbnZhbGlkQmxlbmRDb21iaW5hdGlvbnM7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBuZXh0VmFycyA9IGVudi5uZXh0ID0ge307CiAgICAgICAgICB2YXIgY3VycmVudFZhcnMgPSBlbnYuY3VycmVudCA9IHt9OwogICAgICAgICAgT2JqZWN0LmtleXMoR0xfVkFSSUFCTEVTKS5mb3JFYWNoKGZ1bmN0aW9uKHZhcmlhYmxlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGN1cnJlbnRTdGF0ZVt2YXJpYWJsZV0pKSB7CiAgICAgICAgICAgICAgbmV4dFZhcnNbdmFyaWFibGVdID0gZ2xvYmFsLmRlZihzaGFyZWQubmV4dCwgIi4iLCB2YXJpYWJsZSk7CiAgICAgICAgICAgICAgY3VycmVudFZhcnNbdmFyaWFibGVdID0gZ2xvYmFsLmRlZihzaGFyZWQuY3VycmVudCwgIi4iLCB2YXJpYWJsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIGNvbnN0YW50czIgPSBlbnYuY29uc3RhbnRzID0ge307CiAgICAgICAgICBPYmplY3Qua2V5cyhzaGFyZWRDb25zdGFudHMpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBjb25zdGFudHMyW25hbWVdID0gZ2xvYmFsLmRlZihKU09OLnN0cmluZ2lmeShzaGFyZWRDb25zdGFudHNbbmFtZV0pKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZW52Lmludm9rZSA9IGZ1bmN0aW9uKGJsb2NrLCB4KSB7CiAgICAgICAgICAgIHN3aXRjaCAoeC50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSBEWU5fRlVOQyQxOgogICAgICAgICAgICAgICAgdmFyIGFyZ0xpc3QgPSBbCiAgICAgICAgICAgICAgICAgICJ0aGlzIiwKICAgICAgICAgICAgICAgICAgc2hhcmVkLmNvbnRleHQsCiAgICAgICAgICAgICAgICAgIHNoYXJlZC5wcm9wcywKICAgICAgICAgICAgICAgICAgZW52LmJhdGNoSWQKICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICByZXR1cm4gYmxvY2suZGVmKAogICAgICAgICAgICAgICAgICBsaW5rKHguZGF0YSksCiAgICAgICAgICAgICAgICAgICIuY2FsbCgiLAogICAgICAgICAgICAgICAgICBhcmdMaXN0LnNsaWNlKDAsIE1hdGgubWF4KHguZGF0YS5sZW5ndGggKyAxLCA0KSksCiAgICAgICAgICAgICAgICAgICIpIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjYXNlIERZTl9QUk9QJDE6CiAgICAgICAgICAgICAgICByZXR1cm4gYmxvY2suZGVmKHNoYXJlZC5wcm9wcywgeC5kYXRhKTsKICAgICAgICAgICAgICBjYXNlIERZTl9DT05URVhUJDE6CiAgICAgICAgICAgICAgICByZXR1cm4gYmxvY2suZGVmKHNoYXJlZC5jb250ZXh0LCB4LmRhdGEpOwogICAgICAgICAgICAgIGNhc2UgRFlOX1NUQVRFJDE6CiAgICAgICAgICAgICAgICByZXR1cm4gYmxvY2suZGVmKCJ0aGlzIiwgeC5kYXRhKTsKICAgICAgICAgICAgICBjYXNlIERZTl9USFVOSzoKICAgICAgICAgICAgICAgIHguZGF0YS5hcHBlbmQoZW52LCBibG9jayk7CiAgICAgICAgICAgICAgICByZXR1cm4geC5kYXRhLnJlZjsKICAgICAgICAgICAgICBjYXNlIERZTl9DT05TVEFOVCQxOgogICAgICAgICAgICAgICAgcmV0dXJuIHguZGF0YS50b1N0cmluZygpOwogICAgICAgICAgICAgIGNhc2UgRFlOX0FSUkFZJDE6CiAgICAgICAgICAgICAgICByZXR1cm4geC5kYXRhLm1hcChmdW5jdGlvbih5KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBlbnYuaW52b2tlKGJsb2NrLCB5KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgZW52LmF0dHJpYkNhY2hlID0ge307CiAgICAgICAgICB2YXIgc2NvcGVBdHRyaWJzID0ge307CiAgICAgICAgICBlbnYuc2NvcGVBdHRyaWIgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciBpZCA9IHN0cmluZ1N0b3JlLmlkKG5hbWUpOwogICAgICAgICAgICBpZiAoaWQgaW4gc2NvcGVBdHRyaWJzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlQXR0cmlic1tpZF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBhdHRyaWJ1dGVTdGF0ZS5zY29wZVtpZF07CiAgICAgICAgICAgIGlmICghYmluZGluZykgewogICAgICAgICAgICAgIGJpbmRpbmcgPSBhdHRyaWJ1dGVTdGF0ZS5zY29wZVtpZF0gPSBuZXcgQXR0cmlidXRlUmVjb3JkMigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBzY29wZUF0dHJpYnNbaWRdID0gbGluayhiaW5kaW5nKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gZW52OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZVByb2ZpbGUob3B0aW9ucykgewogICAgICAgICAgdmFyIHN0YXRpY09wdGlvbnMgPSBvcHRpb25zLnN0YXRpYzsKICAgICAgICAgIHZhciBkeW5hbWljT3B0aW9ucyA9IG9wdGlvbnMuZHluYW1pYzsKICAgICAgICAgIHZhciBwcm9maWxlRW5hYmxlOwogICAgICAgICAgaWYgKFNfUFJPRklMRSBpbiBzdGF0aWNPcHRpb25zKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9ICEhc3RhdGljT3B0aW9uc1tTX1BST0ZJTEVdOwogICAgICAgICAgICBwcm9maWxlRW5hYmxlID0gY3JlYXRlU3RhdGljRGVjbChmdW5jdGlvbihlbnYsIHNjb3BlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcHJvZmlsZUVuYWJsZS5lbmFibGUgPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoU19QUk9GSUxFIGluIGR5bmFtaWNPcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBkeW4gPSBkeW5hbWljT3B0aW9uc1tTX1BST0ZJTEVdOwogICAgICAgICAgICBwcm9maWxlRW5hYmxlID0gY3JlYXRlRHluYW1pY0RlY2woZHluLCBmdW5jdGlvbihlbnYsIHNjb3BlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVudi5pbnZva2Uoc2NvcGUsIGR5bik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHByb2ZpbGVFbmFibGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBhcnNlRnJhbWVidWZmZXIob3B0aW9ucywgZW52KSB7CiAgICAgICAgICB2YXIgc3RhdGljT3B0aW9ucyA9IG9wdGlvbnMuc3RhdGljOwogICAgICAgICAgdmFyIGR5bmFtaWNPcHRpb25zID0gb3B0aW9ucy5keW5hbWljOwogICAgICAgICAgaWYgKFNfRlJBTUVCVUZGRVIgaW4gc3RhdGljT3B0aW9ucykgewogICAgICAgICAgICB2YXIgZnJhbWVidWZmZXIgPSBzdGF0aWNPcHRpb25zW1NfRlJBTUVCVUZGRVJdOwogICAgICAgICAgICBpZiAoZnJhbWVidWZmZXIpIHsKICAgICAgICAgICAgICBmcmFtZWJ1ZmZlciA9IGZyYW1lYnVmZmVyU3RhdGUuZ2V0RnJhbWVidWZmZXIoZnJhbWVidWZmZXIpOwogICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZChmcmFtZWJ1ZmZlciwgImludmFsaWQgZnJhbWVidWZmZXIgb2JqZWN0Iik7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52MiwgYmxvY2spIHsKICAgICAgICAgICAgICAgIHZhciBGUkFNRUJVRkZFUiA9IGVudjIubGluayhmcmFtZWJ1ZmZlcik7CiAgICAgICAgICAgICAgICB2YXIgc2hhcmVkID0gZW52Mi5zaGFyZWQ7CiAgICAgICAgICAgICAgICBibG9jay5zZXQoCiAgICAgICAgICAgICAgICAgIHNoYXJlZC5mcmFtZWJ1ZmZlciwKICAgICAgICAgICAgICAgICAgIi5uZXh0IiwKICAgICAgICAgICAgICAgICAgRlJBTUVCVUZGRVIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB2YXIgQ09OVEVYVCA9IHNoYXJlZC5jb250ZXh0OwogICAgICAgICAgICAgICAgYmxvY2suc2V0KAogICAgICAgICAgICAgICAgICBDT05URVhULAogICAgICAgICAgICAgICAgICAiLiIgKyBTX0ZSQU1FQlVGRkVSX1dJRFRILAogICAgICAgICAgICAgICAgICBGUkFNRUJVRkZFUiArICIud2lkdGgiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYmxvY2suc2V0KAogICAgICAgICAgICAgICAgICBDT05URVhULAogICAgICAgICAgICAgICAgICAiLiIgKyBTX0ZSQU1FQlVGRkVSX0hFSUdIVCwKICAgICAgICAgICAgICAgICAgRlJBTUVCVUZGRVIgKyAiLmhlaWdodCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gRlJBTUVCVUZGRVI7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciBzaGFyZWQgPSBlbnYyLnNoYXJlZDsKICAgICAgICAgICAgICAgIHNjb3BlLnNldCgKICAgICAgICAgICAgICAgICAgc2hhcmVkLmZyYW1lYnVmZmVyLAogICAgICAgICAgICAgICAgICAiLm5leHQiLAogICAgICAgICAgICAgICAgICAibnVsbCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB2YXIgQ09OVEVYVCA9IHNoYXJlZC5jb250ZXh0OwogICAgICAgICAgICAgICAgc2NvcGUuc2V0KAogICAgICAgICAgICAgICAgICBDT05URVhULAogICAgICAgICAgICAgICAgICAiLiIgKyBTX0ZSQU1FQlVGRkVSX1dJRFRILAogICAgICAgICAgICAgICAgICBDT05URVhUICsgIi4iICsgU19EUkFXSU5HQlVGRkVSX1dJRFRICiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2NvcGUuc2V0KAogICAgICAgICAgICAgICAgICBDT05URVhULAogICAgICAgICAgICAgICAgICAiLiIgKyBTX0ZSQU1FQlVGRkVSX0hFSUdIVCwKICAgICAgICAgICAgICAgICAgQ09OVEVYVCArICIuIiArIFNfRFJBV0lOR0JVRkZFUl9IRUlHSFQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gIm51bGwiOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKFNfRlJBTUVCVUZGRVIgaW4gZHluYW1pY09wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGR5biA9IGR5bmFtaWNPcHRpb25zW1NfRlJBTUVCVUZGRVJdOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlRHluYW1pY0RlY2woZHluLCBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgIHZhciBGUkFNRUJVRkZFUl9GVU5DID0gZW52Mi5pbnZva2Uoc2NvcGUsIGR5bik7CiAgICAgICAgICAgICAgdmFyIHNoYXJlZCA9IGVudjIuc2hhcmVkOwogICAgICAgICAgICAgIHZhciBGUkFNRUJVRkZFUl9TVEFURSA9IHNoYXJlZC5mcmFtZWJ1ZmZlcjsKICAgICAgICAgICAgICB2YXIgRlJBTUVCVUZGRVIgPSBzY29wZS5kZWYoCiAgICAgICAgICAgICAgICBGUkFNRUJVRkZFUl9TVEFURSwKICAgICAgICAgICAgICAgICIuZ2V0RnJhbWVidWZmZXIoIiwKICAgICAgICAgICAgICAgIEZSQU1FQlVGRkVSX0ZVTkMsCiAgICAgICAgICAgICAgICAiKSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICIhIiArIEZSQU1FQlVGRkVSX0ZVTkMgKyAifHwiICsgRlJBTUVCVUZGRVIsCiAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGZyYW1lYnVmZmVyIG9iamVjdCIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgc2NvcGUuc2V0KAogICAgICAgICAgICAgICAgRlJBTUVCVUZGRVJfU1RBVEUsCiAgICAgICAgICAgICAgICAiLm5leHQiLAogICAgICAgICAgICAgICAgRlJBTUVCVUZGRVIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHZhciBDT05URVhUID0gc2hhcmVkLmNvbnRleHQ7CiAgICAgICAgICAgICAgc2NvcGUuc2V0KAogICAgICAgICAgICAgICAgQ09OVEVYVCwKICAgICAgICAgICAgICAgICIuIiArIFNfRlJBTUVCVUZGRVJfV0lEVEgsCiAgICAgICAgICAgICAgICBGUkFNRUJVRkZFUiArICI/IiArIEZSQU1FQlVGRkVSICsgIi53aWR0aDoiICsgQ09OVEVYVCArICIuIiArIFNfRFJBV0lOR0JVRkZFUl9XSURUSAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NvcGUuc2V0KAogICAgICAgICAgICAgICAgQ09OVEVYVCwKICAgICAgICAgICAgICAgICIuIiArIFNfRlJBTUVCVUZGRVJfSEVJR0hULAogICAgICAgICAgICAgICAgRlJBTUVCVUZGRVIgKyAiPyIgKyBGUkFNRUJVRkZFUiArICIuaGVpZ2h0OiIgKyBDT05URVhUICsgIi4iICsgU19EUkFXSU5HQlVGRkVSX0hFSUdIVAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuIEZSQU1FQlVGRkVSOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZVZpZXdwb3J0U2Npc3NvcihvcHRpb25zLCBmcmFtZWJ1ZmZlciwgZW52KSB7CiAgICAgICAgICB2YXIgc3RhdGljT3B0aW9ucyA9IG9wdGlvbnMuc3RhdGljOwogICAgICAgICAgdmFyIGR5bmFtaWNPcHRpb25zID0gb3B0aW9ucy5keW5hbWljOwogICAgICAgICAgZnVuY3Rpb24gcGFyc2VCb3gocGFyYW0pIHsKICAgICAgICAgICAgaWYgKHBhcmFtIGluIHN0YXRpY09wdGlvbnMpIHsKICAgICAgICAgICAgICB2YXIgYm94ID0gc3RhdGljT3B0aW9uc1twYXJhbV07CiAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kVHlwZShib3gsICJvYmplY3QiLCAiaW52YWxpZCAiICsgcGFyYW0sIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICB2YXIgaXNTdGF0aWMyID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgeCA9IGJveC54IHwgMDsKICAgICAgICAgICAgICB2YXIgeSA9IGJveC55IHwgMDsKICAgICAgICAgICAgICB2YXIgdywgaDsKICAgICAgICAgICAgICBpZiAoIndpZHRoIiBpbiBib3gpIHsKICAgICAgICAgICAgICAgIHcgPSBib3gud2lkdGggfCAwOwogICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKHcgPj0gMCwgImludmFsaWQgIiArIHBhcmFtLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzU3RhdGljMiA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoImhlaWdodCIgaW4gYm94KSB7CiAgICAgICAgICAgICAgICBoID0gYm94LmhlaWdodCB8IDA7CiAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoaCA+PSAwLCAiaW52YWxpZCAiICsgcGFyYW0sIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNTdGF0aWMyID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBuZXcgRGVjbGFyYXRpb24oCiAgICAgICAgICAgICAgICAhaXNTdGF0aWMyICYmIGZyYW1lYnVmZmVyICYmIGZyYW1lYnVmZmVyLnRoaXNEZXAsCiAgICAgICAgICAgICAgICAhaXNTdGF0aWMyICYmIGZyYW1lYnVmZmVyICYmIGZyYW1lYnVmZmVyLmNvbnRleHREZXAsCiAgICAgICAgICAgICAgICAhaXNTdGF0aWMyICYmIGZyYW1lYnVmZmVyICYmIGZyYW1lYnVmZmVyLnByb3BEZXAsCiAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgICB2YXIgQ09OVEVYVCA9IGVudjIuc2hhcmVkLmNvbnRleHQ7CiAgICAgICAgICAgICAgICAgIHZhciBCT1hfVyA9IHc7CiAgICAgICAgICAgICAgICAgIGlmICghKCJ3aWR0aCIgaW4gYm94KSkgewogICAgICAgICAgICAgICAgICAgIEJPWF9XID0gc2NvcGUuZGVmKENPTlRFWFQsICIuIiwgU19GUkFNRUJVRkZFUl9XSURUSCwgIi0iLCB4KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgQk9YX0ggPSBoOwogICAgICAgICAgICAgICAgICBpZiAoISgiaGVpZ2h0IiBpbiBib3gpKSB7CiAgICAgICAgICAgICAgICAgICAgQk9YX0ggPSBzY29wZS5kZWYoQ09OVEVYVCwgIi4iLCBTX0ZSQU1FQlVGRkVSX0hFSUdIVCwgIi0iLCB5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gW3gsIHksIEJPWF9XLCBCT1hfSF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJhbSBpbiBkeW5hbWljT3B0aW9ucykgewogICAgICAgICAgICAgIHZhciBkeW5Cb3ggPSBkeW5hbWljT3B0aW9uc1twYXJhbV07CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNyZWF0ZUR5bmFtaWNEZWNsKGR5bkJveCwgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciBCT1ggPSBlbnYyLmludm9rZShzY29wZSwgZHluQm94KTsKICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgIHNjb3BlLAogICAgICAgICAgICAgICAgICAgIEJPWCArICImJnR5cGVvZiAiICsgQk9YICsgJz09PSJvYmplY3QiJywKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCAiICsgcGFyYW0KICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIENPTlRFWFQgPSBlbnYyLnNoYXJlZC5jb250ZXh0OwogICAgICAgICAgICAgICAgdmFyIEJPWF9YID0gc2NvcGUuZGVmKEJPWCwgIi54fDAiKTsKICAgICAgICAgICAgICAgIHZhciBCT1hfWSA9IHNjb3BlLmRlZihCT1gsICIueXwwIik7CiAgICAgICAgICAgICAgICB2YXIgQk9YX1cgPSBzY29wZS5kZWYoCiAgICAgICAgICAgICAgICAgICcid2lkdGgiIGluICcsCiAgICAgICAgICAgICAgICAgIEJPWCwKICAgICAgICAgICAgICAgICAgIj8iLAogICAgICAgICAgICAgICAgICBCT1gsCiAgICAgICAgICAgICAgICAgICIud2lkdGh8MDoiLAogICAgICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgICAgIENPTlRFWFQsCiAgICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgICAgU19GUkFNRUJVRkZFUl9XSURUSCwKICAgICAgICAgICAgICAgICAgIi0iLAogICAgICAgICAgICAgICAgICBCT1hfWCwKICAgICAgICAgICAgICAgICAgIikiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgdmFyIEJPWF9IID0gc2NvcGUuZGVmKAogICAgICAgICAgICAgICAgICAnImhlaWdodCIgaW4gJywKICAgICAgICAgICAgICAgICAgQk9YLAogICAgICAgICAgICAgICAgICAiPyIsCiAgICAgICAgICAgICAgICAgIEJPWCwKICAgICAgICAgICAgICAgICAgIi5oZWlnaHR8MDoiLAogICAgICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgICAgIENPTlRFWFQsCiAgICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgICAgU19GUkFNRUJVRkZFUl9IRUlHSFQsCiAgICAgICAgICAgICAgICAgICItIiwKICAgICAgICAgICAgICAgICAgQk9YX1ksCiAgICAgICAgICAgICAgICAgICIpIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgIHNjb3BlLAogICAgICAgICAgICAgICAgICAgIEJPWF9XICsgIj49MCYmIiArIEJPWF9IICsgIj49MCIsCiAgICAgICAgICAgICAgICAgICAgImludmFsaWQgIiArIHBhcmFtCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBbQk9YX1gsIEJPWF9ZLCBCT1hfVywgQk9YX0hdOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChmcmFtZWJ1ZmZlcikgewogICAgICAgICAgICAgICAgcmVzdWx0LnRoaXNEZXAgPSByZXN1bHQudGhpc0RlcCB8fCBmcmFtZWJ1ZmZlci50aGlzRGVwOwogICAgICAgICAgICAgICAgcmVzdWx0LmNvbnRleHREZXAgPSByZXN1bHQuY29udGV4dERlcCB8fCBmcmFtZWJ1ZmZlci5jb250ZXh0RGVwOwogICAgICAgICAgICAgICAgcmVzdWx0LnByb3BEZXAgPSByZXN1bHQucHJvcERlcCB8fCBmcmFtZWJ1ZmZlci5wcm9wRGVwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9IGVsc2UgaWYgKGZyYW1lYnVmZmVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgICAgIGZyYW1lYnVmZmVyLnRoaXNEZXAsCiAgICAgICAgICAgICAgICBmcmFtZWJ1ZmZlci5jb250ZXh0RGVwLAogICAgICAgICAgICAgICAgZnJhbWVidWZmZXIucHJvcERlcCwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBDT05URVhUID0gZW52Mi5zaGFyZWQuY29udGV4dDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuZGVmKENPTlRFWFQsICIuIiwgU19GUkFNRUJVRkZFUl9XSURUSCksCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuZGVmKENPTlRFWFQsICIuIiwgU19GUkFNRUJVRkZFUl9IRUlHSFQpCiAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHZpZXdwb3J0ID0gcGFyc2VCb3goU19WSUVXUE9SVCk7CiAgICAgICAgICBpZiAodmlld3BvcnQpIHsKICAgICAgICAgICAgdmFyIHByZXZWaWV3cG9ydCA9IHZpZXdwb3J0OwogICAgICAgICAgICB2aWV3cG9ydCA9IG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgICB2aWV3cG9ydC50aGlzRGVwLAogICAgICAgICAgICAgIHZpZXdwb3J0LmNvbnRleHREZXAsCiAgICAgICAgICAgICAgdmlld3BvcnQucHJvcERlcCwKICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgdmFyIFZJRVdQT1JUID0gcHJldlZpZXdwb3J0LmFwcGVuZChlbnYyLCBzY29wZSk7CiAgICAgICAgICAgICAgICB2YXIgQ09OVEVYVCA9IGVudjIuc2hhcmVkLmNvbnRleHQ7CiAgICAgICAgICAgICAgICBzY29wZS5zZXQoCiAgICAgICAgICAgICAgICAgIENPTlRFWFQsCiAgICAgICAgICAgICAgICAgICIuIiArIFNfVklFV1BPUlRfV0lEVEgsCiAgICAgICAgICAgICAgICAgIFZJRVdQT1JUWzJdCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2NvcGUuc2V0KAogICAgICAgICAgICAgICAgICBDT05URVhULAogICAgICAgICAgICAgICAgICAiLiIgKyBTX1ZJRVdQT1JUX0hFSUdIVCwKICAgICAgICAgICAgICAgICAgVklFV1BPUlRbM10KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICByZXR1cm4gVklFV1BPUlQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmlld3BvcnQsCiAgICAgICAgICAgIHNjaXNzb3JfYm94OiBwYXJzZUJveChTX1NDSVNTT1JfQk9YKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VBdHRyaWJMb2NhdGlvbnMob3B0aW9ucywgYXR0cmlidXRlcykgewogICAgICAgICAgdmFyIHN0YXRpY09wdGlvbnMgPSBvcHRpb25zLnN0YXRpYzsKICAgICAgICAgIHZhciBzdGF0aWNQcm9ncmFtID0gdHlwZW9mIHN0YXRpY09wdGlvbnNbU19GUkFHXSA9PT0gInN0cmluZyIgJiYgdHlwZW9mIHN0YXRpY09wdGlvbnNbU19WRVJUXSA9PT0gInN0cmluZyI7CiAgICAgICAgICBpZiAoc3RhdGljUHJvZ3JhbSkgewogICAgICAgICAgICBpZiAoT2JqZWN0LmtleXMoYXR0cmlidXRlcy5keW5hbWljKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YXRpY0F0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzLnN0YXRpYzsKICAgICAgICAgICAgdmFyIHNBdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoc3RhdGljQXR0cmlidXRlcyk7CiAgICAgICAgICAgIGlmIChzQXR0cmlidXRlcy5sZW5ndGggPiAwICYmIHR5cGVvZiBzdGF0aWNBdHRyaWJ1dGVzW3NBdHRyaWJ1dGVzWzBdXSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgYmluZGluZ3MgPSBbXTsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNBdHRyaWJ1dGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBjaGVjayQxKHR5cGVvZiBzdGF0aWNBdHRyaWJ1dGVzW3NBdHRyaWJ1dGVzW2ldXSA9PT0gIm51bWJlciIsICJtdXN0IHNwZWNpZnkgYWxsIHZlcnRleCBhdHRyaWJ1dGUgbG9jYXRpb25zIHdoZW4gdXNpbmcgdmFvcyIpOwogICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChbc3RhdGljQXR0cmlidXRlc1tzQXR0cmlidXRlc1tpXV0gfCAwLCBzQXR0cmlidXRlc1tpXV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZVByb2dyYW0ob3B0aW9ucywgZW52LCBhdHRyaWJMb2NhdGlvbnMpIHsKICAgICAgICAgIHZhciBzdGF0aWNPcHRpb25zID0gb3B0aW9ucy5zdGF0aWM7CiAgICAgICAgICB2YXIgZHluYW1pY09wdGlvbnMgPSBvcHRpb25zLmR5bmFtaWM7CiAgICAgICAgICBmdW5jdGlvbiBwYXJzZVNoYWRlcihuYW1lKSB7CiAgICAgICAgICAgIGlmIChuYW1lIGluIHN0YXRpY09wdGlvbnMpIHsKICAgICAgICAgICAgICB2YXIgaWQgPSBzdHJpbmdTdG9yZS5pZChzdGF0aWNPcHRpb25zW25hbWVdKTsKICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2hhZGVyU3RhdGUuc2hhZGVyKHNoYWRlclR5cGVbbmFtZV0sIGlkLCBjaGVjayQxLmd1ZXNzQ29tbWFuZCgpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gY3JlYXRlU3RhdGljRGVjbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXN1bHQuaWQgPSBpZDsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgaW4gZHluYW1pY09wdGlvbnMpIHsKICAgICAgICAgICAgICB2YXIgZHluID0gZHluYW1pY09wdGlvbnNbbmFtZV07CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUR5bmFtaWNEZWNsKGR5biwgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciBzdHIgPSBlbnYyLmludm9rZShzY29wZSwgZHluKTsKICAgICAgICAgICAgICAgIHZhciBpZDIgPSBzY29wZS5kZWYoZW52Mi5zaGFyZWQuc3RyaW5ncywgIi5pZCgiLCBzdHIsICIpIik7CiAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBzY29wZSgKICAgICAgICAgICAgICAgICAgICBlbnYyLnNoYXJlZC5zaGFkZXIsCiAgICAgICAgICAgICAgICAgICAgIi5zaGFkZXIoIiwKICAgICAgICAgICAgICAgICAgICBzaGFkZXJUeXBlW25hbWVdLAogICAgICAgICAgICAgICAgICAgICIsIiwKICAgICAgICAgICAgICAgICAgICBpZDIsCiAgICAgICAgICAgICAgICAgICAgIiwiLAogICAgICAgICAgICAgICAgICAgIGVudjIuY29tbWFuZCwKICAgICAgICAgICAgICAgICAgICAiKTsiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBpZDI7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnJhZyA9IHBhcnNlU2hhZGVyKFNfRlJBRyk7CiAgICAgICAgICB2YXIgdmVydCA9IHBhcnNlU2hhZGVyKFNfVkVSVCk7CiAgICAgICAgICB2YXIgcHJvZ3JhbSA9IG51bGw7CiAgICAgICAgICB2YXIgcHJvZ1ZhcjsKICAgICAgICAgIGlmIChpc1N0YXRpYyhmcmFnKSAmJiBpc1N0YXRpYyh2ZXJ0KSkgewogICAgICAgICAgICBwcm9ncmFtID0gc2hhZGVyU3RhdGUucHJvZ3JhbSh2ZXJ0LmlkLCBmcmFnLmlkLCBudWxsLCBhdHRyaWJMb2NhdGlvbnMpOwogICAgICAgICAgICBwcm9nVmFyID0gY3JlYXRlU3RhdGljRGVjbChmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgIHJldHVybiBlbnYyLmxpbmsocHJvZ3JhbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvZ1ZhciA9IG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgICBmcmFnICYmIGZyYWcudGhpc0RlcCB8fCB2ZXJ0ICYmIHZlcnQudGhpc0RlcCwKICAgICAgICAgICAgICBmcmFnICYmIGZyYWcuY29udGV4dERlcCB8fCB2ZXJ0ICYmIHZlcnQuY29udGV4dERlcCwKICAgICAgICAgICAgICBmcmFnICYmIGZyYWcucHJvcERlcCB8fCB2ZXJ0ICYmIHZlcnQucHJvcERlcCwKICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgdmFyIFNIQURFUl9TVEFURSA9IGVudjIuc2hhcmVkLnNoYWRlcjsKICAgICAgICAgICAgICAgIHZhciBmcmFnSWQ7CiAgICAgICAgICAgICAgICBpZiAoZnJhZykgewogICAgICAgICAgICAgICAgICBmcmFnSWQgPSBmcmFnLmFwcGVuZChlbnYyLCBzY29wZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBmcmFnSWQgPSBzY29wZS5kZWYoU0hBREVSX1NUQVRFLCAiLiIsIFNfRlJBRyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdmVydElkOwogICAgICAgICAgICAgICAgaWYgKHZlcnQpIHsKICAgICAgICAgICAgICAgICAgdmVydElkID0gdmVydC5hcHBlbmQoZW52Miwgc2NvcGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmVydElkID0gc2NvcGUuZGVmKFNIQURFUl9TVEFURSwgIi4iLCBTX1ZFUlQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByb2dEZWYgPSBTSEFERVJfU1RBVEUgKyAiLnByb2dyYW0oIiArIHZlcnRJZCArICIsIiArIGZyYWdJZDsKICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHByb2dEZWYgKz0gIiwiICsgZW52Mi5jb21tYW5kOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKHByb2dEZWYgKyAiKSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGZyYWcsCiAgICAgICAgICAgIHZlcnQsCiAgICAgICAgICAgIHByb2dWYXIsCiAgICAgICAgICAgIHByb2dyYW0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBhcnNlRHJhdyhvcHRpb25zLCBlbnYpIHsKICAgICAgICAgIHZhciBzdGF0aWNPcHRpb25zID0gb3B0aW9ucy5zdGF0aWM7CiAgICAgICAgICB2YXIgZHluYW1pY09wdGlvbnMgPSBvcHRpb25zLmR5bmFtaWM7CiAgICAgICAgICB2YXIgc3RhdGljRHJhdyA9IHt9OwogICAgICAgICAgdmFyIHZhb0FjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gcGFyc2VWQU8oKSB7CiAgICAgICAgICAgIGlmIChTX1ZBTyBpbiBzdGF0aWNPcHRpb25zKSB7CiAgICAgICAgICAgICAgdmFyIHZhbzIgPSBzdGF0aWNPcHRpb25zW1NfVkFPXTsKICAgICAgICAgICAgICBpZiAodmFvMiAhPT0gbnVsbCAmJiBhdHRyaWJ1dGVTdGF0ZS5nZXRWQU8odmFvMikgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhbzIgPSBhdHRyaWJ1dGVTdGF0ZS5jcmVhdGVWQU8odmFvMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhb0FjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgc3RhdGljRHJhdy52YW8gPSB2YW8yOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVTdGF0aWNEZWNsKGZ1bmN0aW9uKGVudjIpIHsKICAgICAgICAgICAgICAgIHZhciB2YW9SZWYgPSBhdHRyaWJ1dGVTdGF0ZS5nZXRWQU8odmFvMik7CiAgICAgICAgICAgICAgICBpZiAodmFvUmVmKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBlbnYyLmxpbmsodmFvUmVmKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoU19WQU8gaW4gZHluYW1pY09wdGlvbnMpIHsKICAgICAgICAgICAgICB2YW9BY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBkeW4gPSBkeW5hbWljT3B0aW9uc1tTX1ZBT107CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUR5bmFtaWNEZWNsKGR5biwgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciB2YW9SZWYgPSBlbnYyLmludm9rZShzY29wZSwgZHluKTsKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS5kZWYoZW52Mi5zaGFyZWQudmFvICsgIi5nZXRWQU8oIiArIHZhb1JlZiArICIpIik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFvID0gcGFyc2VWQU8oKTsKICAgICAgICAgIHZhciBlbGVtZW50c0FjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgZnVuY3Rpb24gcGFyc2VFbGVtZW50cygpIHsKICAgICAgICAgICAgaWYgKFNfRUxFTUVOVFMgaW4gc3RhdGljT3B0aW9ucykgewogICAgICAgICAgICAgIHZhciBlbGVtZW50czIgPSBzdGF0aWNPcHRpb25zW1NfRUxFTUVOVFNdOwogICAgICAgICAgICAgIHN0YXRpY0RyYXcuZWxlbWVudHMgPSBlbGVtZW50czI7CiAgICAgICAgICAgICAgaWYgKGlzQnVmZmVyQXJncyhlbGVtZW50czIpKSB7CiAgICAgICAgICAgICAgICB2YXIgZSA9IHN0YXRpY0RyYXcuZWxlbWVudHMgPSBlbGVtZW50U3RhdGUuY3JlYXRlKGVsZW1lbnRzMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBlbGVtZW50czIgPSBlbGVtZW50U3RhdGUuZ2V0RWxlbWVudHMoZSk7CiAgICAgICAgICAgICAgICBlbGVtZW50c0FjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50czIpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnRzMiA9IGVsZW1lbnRTdGF0ZS5nZXRFbGVtZW50cyhlbGVtZW50czIpOwogICAgICAgICAgICAgICAgZWxlbWVudHNBY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKGVsZW1lbnRzMiwgImludmFsaWQgZWxlbWVudHMiLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjcmVhdGVTdGF0aWNEZWNsKGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudHMyKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQyID0gZW52Mi5saW5rKGVsZW1lbnRzMik7CiAgICAgICAgICAgICAgICAgIGVudjIuRUxFTUVOVFMgPSByZXN1bHQyOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVudjIuRUxFTUVOVFMgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVzdWx0LnZhbHVlID0gZWxlbWVudHMyOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoU19FTEVNRU5UUyBpbiBkeW5hbWljT3B0aW9ucykgewogICAgICAgICAgICAgIGVsZW1lbnRzQWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgZHluID0gZHluYW1pY09wdGlvbnNbU19FTEVNRU5UU107CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUR5bmFtaWNEZWNsKGR5biwgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciBzaGFyZWQgPSBlbnYyLnNoYXJlZDsKICAgICAgICAgICAgICAgIHZhciBJU19CVUZGRVJfQVJHUyA9IHNoYXJlZC5pc0J1ZmZlckFyZ3M7CiAgICAgICAgICAgICAgICB2YXIgRUxFTUVOVF9TVEFURSA9IHNoYXJlZC5lbGVtZW50czsKICAgICAgICAgICAgICAgIHZhciBlbGVtZW50RGVmbiA9IGVudjIuaW52b2tlKHNjb3BlLCBkeW4pOwogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRzMyA9IHNjb3BlLmRlZigibnVsbCIpOwogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRTdHJlYW0gPSBzY29wZS5kZWYoSVNfQlVGRkVSX0FSR1MsICIoIiwgZWxlbWVudERlZm4sICIpIik7CiAgICAgICAgICAgICAgICB2YXIgaWZ0ZSA9IGVudjIuY29uZChlbGVtZW50U3RyZWFtKS50aGVuKGVsZW1lbnRzMywgIj0iLCBFTEVNRU5UX1NUQVRFLCAiLmNyZWF0ZVN0cmVhbSgiLCBlbGVtZW50RGVmbiwgIik7IikuZWxzZShlbGVtZW50czMsICI9IiwgRUxFTUVOVF9TVEFURSwgIi5nZXRFbGVtZW50cygiLCBlbGVtZW50RGVmbiwgIik7Iik7CiAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICBpZnRlLmVsc2UsCiAgICAgICAgICAgICAgICAgICAgIiEiICsgZWxlbWVudERlZm4gKyAifHwiICsgZWxlbWVudHMzLAogICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGVsZW1lbnRzIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBzY29wZS5lbnRyeShpZnRlKTsKICAgICAgICAgICAgICAgIHNjb3BlLmV4aXQoCiAgICAgICAgICAgICAgICAgIGVudjIuY29uZChlbGVtZW50U3RyZWFtKS50aGVuKEVMRU1FTlRfU1RBVEUsICIuZGVzdHJveVN0cmVhbSgiLCBlbGVtZW50czMsICIpOyIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgZW52Mi5FTEVNRU5UUyA9IGVsZW1lbnRzMzsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50czM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFvQWN0aXZlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgICAgIHZhby50aGlzRGVwLAogICAgICAgICAgICAgICAgdmFvLmNvbnRleHREZXAsCiAgICAgICAgICAgICAgICB2YW8ucHJvcERlcCwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS5kZWYoZW52Mi5zaGFyZWQudmFvICsgIi5jdXJyZW50VkFPPyIgKyBlbnYyLnNoYXJlZC5lbGVtZW50cyArICIuZ2V0RWxlbWVudHMoIiArIGVudjIuc2hhcmVkLnZhbyArICIuY3VycmVudFZBTy5lbGVtZW50cyk6bnVsbCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudHMgPSBwYXJzZUVsZW1lbnRzKCk7CiAgICAgICAgICBmdW5jdGlvbiBwYXJzZVByaW1pdGl2ZSgpIHsKICAgICAgICAgICAgaWYgKFNfUFJJTUlUSVZFIGluIHN0YXRpY09wdGlvbnMpIHsKICAgICAgICAgICAgICB2YXIgcHJpbWl0aXZlMiA9IHN0YXRpY09wdGlvbnNbU19QUklNSVRJVkVdOwogICAgICAgICAgICAgIHN0YXRpY0RyYXcucHJpbWl0aXZlID0gcHJpbWl0aXZlMjsKICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIocHJpbWl0aXZlMiwgcHJpbVR5cGVzLCAiaW52YWxpZCBwcmltaXR2ZSIsIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlU3RhdGljRGVjbChmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByaW1UeXBlc1twcmltaXRpdmUyXTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChTX1BSSU1JVElWRSBpbiBkeW5hbWljT3B0aW9ucykgewogICAgICAgICAgICAgIHZhciBkeW5QcmltaXRpdmUgPSBkeW5hbWljT3B0aW9uc1tTX1BSSU1JVElWRV07CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUR5bmFtaWNEZWNsKGR5blByaW1pdGl2ZSwgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciBQUklNX1RZUEVTID0gZW52Mi5jb25zdGFudHMucHJpbVR5cGVzOwogICAgICAgICAgICAgICAgdmFyIHByaW0gPSBlbnYyLmludm9rZShzY29wZSwgZHluUHJpbWl0aXZlKTsKICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgIHNjb3BlLAogICAgICAgICAgICAgICAgICAgIHByaW0gKyAiIGluICIgKyBQUklNX1RZUEVTLAogICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHByaW1pdGl2ZSwgbXVzdCBiZSBvbmUgb2YgIiArIE9iamVjdC5rZXlzKHByaW1UeXBlcykKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmRlZihQUklNX1RZUEVTLCAiWyIsIHByaW0sICJdIik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudHNBY3RpdmUpIHsKICAgICAgICAgICAgICBpZiAoaXNTdGF0aWMoZWxlbWVudHMpKSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudHMudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKGVudjIuRUxFTUVOVFMsICIucHJpbVR5cGUiKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlU3RhdGljRGVjbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gR0xfVFJJQU5HTEVTJDE7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERlY2xhcmF0aW9uKAogICAgICAgICAgICAgICAgICBlbGVtZW50cy50aGlzRGVwLAogICAgICAgICAgICAgICAgICBlbGVtZW50cy5jb250ZXh0RGVwLAogICAgICAgICAgICAgICAgICBlbGVtZW50cy5wcm9wRGVwLAogICAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50czIgPSBlbnYyLkVMRU1FTlRTOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS5kZWYoZWxlbWVudHMyLCAiPyIsIGVsZW1lbnRzMiwgIi5wcmltVHlwZToiLCBHTF9UUklBTkdMRVMkMSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHZhb0FjdGl2ZSkgewogICAgICAgICAgICAgIHJldHVybiBuZXcgRGVjbGFyYXRpb24oCiAgICAgICAgICAgICAgICB2YW8udGhpc0RlcCwKICAgICAgICAgICAgICAgIHZhby5jb250ZXh0RGVwLAogICAgICAgICAgICAgICAgdmFvLnByb3BEZXAsCiAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKGVudjIuc2hhcmVkLnZhbyArICIuY3VycmVudFZBTz8iICsgZW52Mi5zaGFyZWQudmFvICsgIi5jdXJyZW50VkFPLnByaW1pdGl2ZToiICsgR0xfVFJJQU5HTEVTJDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwYXJzZVBhcmFtKHBhcmFtLCBpc09mZnNldCkgewogICAgICAgICAgICBpZiAocGFyYW0gaW4gc3RhdGljT3B0aW9ucykgewogICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHN0YXRpY09wdGlvbnNbcGFyYW1dIHwgMDsKICAgICAgICAgICAgICBpZiAoaXNPZmZzZXQpIHsKICAgICAgICAgICAgICAgIHN0YXRpY0RyYXcub2Zmc2V0ID0gdmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXRpY0RyYXcuaW5zdGFuY2VzID0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCghaXNPZmZzZXQgfHwgdmFsdWUgPj0gMCwgImludmFsaWQgIiArIHBhcmFtLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIGlmIChpc09mZnNldCkgewogICAgICAgICAgICAgICAgICBlbnYyLk9GRlNFVCA9IHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKHBhcmFtIGluIGR5bmFtaWNPcHRpb25zKSB7CiAgICAgICAgICAgICAgdmFyIGR5blZhbHVlID0gZHluYW1pY09wdGlvbnNbcGFyYW1dOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVEeW5hbWljRGVjbChkeW5WYWx1ZSwgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBlbnYyLmludm9rZShzY29wZSwgZHluVmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGlzT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIGVudjIuT0ZGU0VUID0gcmVzdWx0OwogICAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgKyAiPj0wIiwKICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkICIgKyBwYXJhbQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc09mZnNldCkgewogICAgICAgICAgICAgIGlmIChlbGVtZW50c0FjdGl2ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgZW52Mi5PRkZTRVQgPSAwOwogICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFvQWN0aXZlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERlY2xhcmF0aW9uKAogICAgICAgICAgICAgICAgICB2YW8udGhpc0RlcCwKICAgICAgICAgICAgICAgICAgdmFvLmNvbnRleHREZXAsCiAgICAgICAgICAgICAgICAgIHZhby5wcm9wRGVwLAogICAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS5kZWYoZW52Mi5zaGFyZWQudmFvICsgIi5jdXJyZW50VkFPPyIgKyBlbnYyLnNoYXJlZC52YW8gKyAiLmN1cnJlbnRWQU8ub2Zmc2V0OjAiKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFvQWN0aXZlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgICAgIHZhby50aGlzRGVwLAogICAgICAgICAgICAgICAgdmFvLmNvbnRleHREZXAsCiAgICAgICAgICAgICAgICB2YW8ucHJvcERlcCwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS5kZWYoZW52Mi5zaGFyZWQudmFvICsgIi5jdXJyZW50VkFPPyIgKyBlbnYyLnNoYXJlZC52YW8gKyAiLmN1cnJlbnRWQU8uaW5zdGFuY2VzOi0xIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBPRkZTRVQgPSBwYXJzZVBhcmFtKFNfT0ZGU0VULCB0cnVlKTsKICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlVmVydENvdW50KCkgewogICAgICAgICAgICBpZiAoU19DT1VOVCBpbiBzdGF0aWNPcHRpb25zKSB7CiAgICAgICAgICAgICAgdmFyIGNvdW50MyA9IHN0YXRpY09wdGlvbnNbU19DT1VOVF0gfCAwOwogICAgICAgICAgICAgIHN0YXRpY0RyYXcuY291bnQgPSBjb3VudDM7CiAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgdHlwZW9mIGNvdW50MyA9PT0gIm51bWJlciIgJiYgY291bnQzID49IDAsCiAgICAgICAgICAgICAgICAiaW52YWxpZCB2ZXJ0ZXggY291bnQiLAogICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVTdGF0aWNEZWNsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvdW50MzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChTX0NPVU5UIGluIGR5bmFtaWNPcHRpb25zKSB7CiAgICAgICAgICAgICAgdmFyIGR5bkNvdW50ID0gZHluYW1pY09wdGlvbnNbU19DT1VOVF07CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUR5bmFtaWNEZWNsKGR5bkNvdW50LCBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdDIgPSBlbnYyLmludm9rZShzY29wZSwgZHluQ291bnQpOwogICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgInR5cGVvZiAiICsgcmVzdWx0MiArICc9PT0ibnVtYmVyIiYmJyArIHJlc3VsdDIgKyAiPj0wJiYiICsgcmVzdWx0MiArICI9PT0oIiArIHJlc3VsdDIgKyAifDApIiwKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCB2ZXJ0ZXggY291bnQiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnRzQWN0aXZlKSB7CiAgICAgICAgICAgICAgaWYgKGlzU3RhdGljKGVsZW1lbnRzKSkgewogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChPRkZTRVQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERlY2xhcmF0aW9uKAogICAgICAgICAgICAgICAgICAgICAgT0ZGU0VULnRoaXNEZXAsCiAgICAgICAgICAgICAgICAgICAgICBPRkZTRVQuY29udGV4dERlcCwKICAgICAgICAgICAgICAgICAgICAgIE9GRlNFVC5wcm9wRGVwLAogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdDIgPSBzY29wZS5kZWYoCiAgICAgICAgICAgICAgICAgICAgICAgICAgZW52Mi5FTEVNRU5UUywKICAgICAgICAgICAgICAgICAgICAgICAgICAiLnZlcnRDb3VudC0iLAogICAgICAgICAgICAgICAgICAgICAgICAgIGVudjIuT0ZGU0VUCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDIgKyAiPj0wIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHZlcnRleCBvZmZzZXQvZWxlbWVudCBidWZmZXIgdG9vIHNtYWxsIgogICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0MjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVTdGF0aWNEZWNsKGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKGVudjIuRUxFTUVOVFMsICIudmVydENvdW50Iik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjcmVhdGVTdGF0aWNEZWNsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lk1JU1NJTkcgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHZhcmlhYmxlID0gbmV3IERlY2xhcmF0aW9uKAogICAgICAgICAgICAgICAgICBlbGVtZW50cy50aGlzRGVwIHx8IE9GRlNFVC50aGlzRGVwLAogICAgICAgICAgICAgICAgICBlbGVtZW50cy5jb250ZXh0RGVwIHx8IE9GRlNFVC5jb250ZXh0RGVwLAogICAgICAgICAgICAgICAgICBlbGVtZW50cy5wcm9wRGVwIHx8IE9GRlNFVC5wcm9wRGVwLAogICAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50czIgPSBlbnYyLkVMRU1FTlRTOwogICAgICAgICAgICAgICAgICAgIGlmIChlbnYyLk9GRlNFVCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmRlZigKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudHMyLAogICAgICAgICAgICAgICAgICAgICAgICAiPyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRzMiwKICAgICAgICAgICAgICAgICAgICAgICAgIi52ZXJ0Q291bnQtIiwKICAgICAgICAgICAgICAgICAgICAgICAgZW52Mi5PRkZTRVQsCiAgICAgICAgICAgICAgICAgICAgICAgICI6LTEiCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKGVsZW1lbnRzMiwgIj8iLCBlbGVtZW50czIsICIudmVydENvdW50Oi0xIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB2YXJpYWJsZS5EWU5BTUlDID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHZhcmlhYmxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh2YW9BY3RpdmUpIHsKICAgICAgICAgICAgICB2YXIgY291bnRWYXJpYWJsZSA9IG5ldyBEZWNsYXJhdGlvbigKICAgICAgICAgICAgICAgIHZhby50aGlzRGVwLAogICAgICAgICAgICAgICAgdmFvLmNvbnRleHREZXAsCiAgICAgICAgICAgICAgICB2YW8ucHJvcERlcCwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS5kZWYoZW52Mi5zaGFyZWQudmFvLCAiLmN1cnJlbnRWQU8/IiwgZW52Mi5zaGFyZWQudmFvLCAiLmN1cnJlbnRWQU8uY291bnQ6LTEiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiBjb3VudFZhcmlhYmxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByaW1pdGl2ZSA9IHBhcnNlUHJpbWl0aXZlKCk7CiAgICAgICAgICB2YXIgY291bnQyID0gcGFyc2VWZXJ0Q291bnQoKTsKICAgICAgICAgIHZhciBpbnN0YW5jZXMgPSBwYXJzZVBhcmFtKFNfSU5TVEFOQ0VTLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBlbGVtZW50cywKICAgICAgICAgICAgcHJpbWl0aXZlLAogICAgICAgICAgICBjb3VudDogY291bnQyLAogICAgICAgICAgICBpbnN0YW5jZXMsCiAgICAgICAgICAgIG9mZnNldDogT0ZGU0VULAogICAgICAgICAgICB2YW8sCiAgICAgICAgICAgIHZhb0FjdGl2ZSwKICAgICAgICAgICAgZWxlbWVudHNBY3RpdmUsCiAgICAgICAgICAgIC8vIHN0YXRpYyBkcmF3IHByb3BzCiAgICAgICAgICAgIHN0YXRpYzogc3RhdGljRHJhdwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGFyc2VHTFN0YXRlKG9wdGlvbnMsIGVudikgewogICAgICAgICAgdmFyIHN0YXRpY09wdGlvbnMgPSBvcHRpb25zLnN0YXRpYzsKICAgICAgICAgIHZhciBkeW5hbWljT3B0aW9ucyA9IG9wdGlvbnMuZHluYW1pYzsKICAgICAgICAgIHZhciBTVEFURSA9IHt9OwogICAgICAgICAgR0xfU1RBVEVfTkFNRVMuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgIHZhciBwYXJhbSA9IHByb3BOYW1lKHByb3ApOwogICAgICAgICAgICBmdW5jdGlvbiBwYXJzZVBhcmFtKHBhcnNlU3RhdGljLCBwYXJzZUR5bmFtaWMpIHsKICAgICAgICAgICAgICBpZiAocHJvcCBpbiBzdGF0aWNPcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZVN0YXRpYyhzdGF0aWNPcHRpb25zW3Byb3BdKTsKICAgICAgICAgICAgICAgIFNUQVRFW3BhcmFtXSA9IGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcCBpbiBkeW5hbWljT3B0aW9ucykgewogICAgICAgICAgICAgICAgdmFyIGR5biA9IGR5bmFtaWNPcHRpb25zW3Byb3BdOwogICAgICAgICAgICAgICAgU1RBVEVbcGFyYW1dID0gY3JlYXRlRHluYW1pY0RlY2woZHluLCBmdW5jdGlvbihlbnYyLCBzY29wZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VEeW5hbWljKGVudjIsIHNjb3BlLCBlbnYyLmludm9rZShzY29wZSwgZHluKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoIChwcm9wKSB7CiAgICAgICAgICAgICAgY2FzZSBTX0NVTExfRU5BQkxFOgogICAgICAgICAgICAgIGNhc2UgU19CTEVORF9FTkFCTEU6CiAgICAgICAgICAgICAgY2FzZSBTX0RJVEhFUjoKICAgICAgICAgICAgICBjYXNlIFNfU1RFTkNJTF9FTkFCTEU6CiAgICAgICAgICAgICAgY2FzZSBTX0RFUFRIX0VOQUJMRToKICAgICAgICAgICAgICBjYXNlIFNfU0NJU1NPUl9FTkFCTEU6CiAgICAgICAgICAgICAgY2FzZSBTX1BPTFlHT05fT0ZGU0VUX0VOQUJMRToKICAgICAgICAgICAgICBjYXNlIFNfU0FNUExFX0FMUEhBOgogICAgICAgICAgICAgIGNhc2UgU19TQU1QTEVfRU5BQkxFOgogICAgICAgICAgICAgIGNhc2UgU19ERVBUSF9NQVNLOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kVHlwZSh2YWx1ZSwgImJvb2xlYW4iLCBwcm9wLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZW9mICIgKyB2YWx1ZSArICc9PT0iYm9vbGVhbiInLAogICAgICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBmbGFnICIgKyBwcm9wLAogICAgICAgICAgICAgICAgICAgICAgICBlbnYyLmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNhc2UgU19ERVBUSF9GVU5DOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kUGFyYW1ldGVyKHZhbHVlLCBjb21wYXJlRnVuY3MsICJpbnZhbGlkICIgKyBwcm9wLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmVGdW5jc1t2YWx1ZV07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBDT01QQVJFX0ZVTkNTID0gZW52Mi5jb25zdGFudHMuY29tcGFyZUZ1bmNzOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICsgIiBpbiAiICsgQ09NUEFSRV9GVU5DUywKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgIiArIHByb3AgKyAiLCBtdXN0IGJlIG9uZSBvZiAiICsgT2JqZWN0LmtleXMoY29tcGFyZUZ1bmNzKQogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKENPTVBBUkVfRlVOQ1MsICJbIiwgdmFsdWUsICJdIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2FzZSBTX0RFUFRIX1JBTkdFOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgdmFsdWVbMF0gPT09ICJudW1iZXIiICYmIHR5cGVvZiB2YWx1ZVsxXSA9PT0gIm51bWJlciIgJiYgdmFsdWVbMF0gPD0gdmFsdWVbMV0sCiAgICAgICAgICAgICAgICAgICAgICAiZGVwdGggcmFuZ2UgaXMgMmQgYXJyYXkiLAogICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZW52Miwgc2NvcGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgZW52Mi5zaGFyZWQuaXNBcnJheUxpa2UgKyAiKCIgKyB2YWx1ZSArICIpJiYiICsgdmFsdWUgKyAiLmxlbmd0aD09PTImJnR5cGVvZiAiICsgdmFsdWUgKyAnWzBdPT09Im51bWJlciImJnR5cGVvZiAnICsgdmFsdWUgKyAnWzFdPT09Im51bWJlciImJicgKyB2YWx1ZSArICJbMF08PSIgKyB2YWx1ZSArICJbMV0iLAogICAgICAgICAgICAgICAgICAgICAgICAiZGVwdGggcmFuZ2UgbXVzdCBiZSBhIDJkIGFycmF5IgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgWl9ORUFSID0gc2NvcGUuZGVmKCIrIiwgdmFsdWUsICJbMF0iKTsKICAgICAgICAgICAgICAgICAgICB2YXIgWl9GQVIgPSBzY29wZS5kZWYoIisiLCB2YWx1ZSwgIlsxXSIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBbWl9ORUFSLCBaX0ZBUl07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2FzZSBTX0JMRU5EX0ZVTkM6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VQYXJhbSgKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRUeXBlKHZhbHVlLCAib2JqZWN0IiwgImJsZW5kLmZ1bmMiLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY1JHQiA9ICJzcmNSR0IiIGluIHZhbHVlID8gdmFsdWUuc3JjUkdCIDogdmFsdWUuc3JjOwogICAgICAgICAgICAgICAgICAgIHZhciBzcmNBbHBoYSA9ICJzcmNBbHBoYSIgaW4gdmFsdWUgPyB2YWx1ZS5zcmNBbHBoYSA6IHZhbHVlLnNyYzsKICAgICAgICAgICAgICAgICAgICB2YXIgZHN0UkdCID0gImRzdFJHQiIgaW4gdmFsdWUgPyB2YWx1ZS5kc3RSR0IgOiB2YWx1ZS5kc3Q7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRzdEFscGhhID0gImRzdEFscGhhIiBpbiB2YWx1ZSA/IHZhbHVlLmRzdEFscGhhIDogdmFsdWUuZHN0OwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFBhcmFtZXRlcihzcmNSR0IsIGJsZW5kRnVuY3MsIHBhcmFtICsgIi5zcmNSR0IiLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kUGFyYW1ldGVyKHNyY0FscGhhLCBibGVuZEZ1bmNzLCBwYXJhbSArICIuc3JjQWxwaGEiLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kUGFyYW1ldGVyKGRzdFJHQiwgYmxlbmRGdW5jcywgcGFyYW0gKyAiLmRzdFJHQiIsIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIoZHN0QWxwaGEsIGJsZW5kRnVuY3MsIHBhcmFtICsgIi5kc3RBbHBoYSIsIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQmxlbmRDb21iaW5hdGlvbnMuaW5kZXhPZihzcmNSR0IgKyAiLCAiICsgZHN0UkdCKSA9PT0gLTEsCiAgICAgICAgICAgICAgICAgICAgICAidW5hbGxvd2VkIGJsZW5kaW5nIGNvbWJpbmF0aW9uIChzcmNSR0IsIGRzdFJHQikgPSAoIiArIHNyY1JHQiArICIsICIgKyBkc3RSR0IgKyAiKSIsCiAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgIGJsZW5kRnVuY3Nbc3JjUkdCXSwKICAgICAgICAgICAgICAgICAgICAgIGJsZW5kRnVuY3NbZHN0UkdCXSwKICAgICAgICAgICAgICAgICAgICAgIGJsZW5kRnVuY3Nbc3JjQWxwaGFdLAogICAgICAgICAgICAgICAgICAgICAgYmxlbmRGdW5jc1tkc3RBbHBoYV0KICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgQkxFTkRfRlVOQ1MgPSBlbnYyLmNvbnN0YW50cy5ibGVuZEZ1bmNzOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICsgIiYmdHlwZW9mICIgKyB2YWx1ZSArICc9PT0ib2JqZWN0IicsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGJsZW5kIGZ1bmMsIG11c3QgYmUgYW4gb2JqZWN0IgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiByZWFkKHByZWZpeCwgc3VmZml4KSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZnVuYyA9IHNjb3BlLmRlZigKICAgICAgICAgICAgICAgICAgICAgICAgJyInLAogICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1ZmZpeCwKICAgICAgICAgICAgICAgICAgICAgICAgJyIgaW4gJywKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICI/IiwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4LAogICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXgsCiAgICAgICAgICAgICAgICAgICAgICAgICI6IiwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4CiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyArICIgaW4gIiArIEJMRU5EX0ZVTkNTLAogICAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkICIgKyBwcm9wICsgIi4iICsgcHJlZml4ICsgc3VmZml4ICsgIiwgbXVzdCBiZSBvbmUgb2YgIiArIE9iamVjdC5rZXlzKGJsZW5kRnVuY3MpCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgc3JjUkdCID0gcmVhZCgic3JjIiwgIlJHQiIpOwogICAgICAgICAgICAgICAgICAgIHZhciBkc3RSR0IgPSByZWFkKCJkc3QiLCAiUkdCIik7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBJTlZBTElEX0JMRU5EX0NPTUJJTkFUSU9OUyA9IGVudjIuY29uc3RhbnRzLmludmFsaWRCbGVuZENvbWJpbmF0aW9uczsKICAgICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgSU5WQUxJRF9CTEVORF9DT01CSU5BVElPTlMgKyAiLmluZGV4T2YoIiArIHNyY1JHQiArICcrIiwgIisnICsgZHN0UkdCICsgIikgPT09IC0xICIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bmFsbG93ZWQgYmxlbmRpbmcgY29tYmluYXRpb24gZm9yIChzcmNSR0IsIGRzdFJHQikiCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHZhciBTUkNfUkdCID0gc2NvcGUuZGVmKEJMRU5EX0ZVTkNTLCAiWyIsIHNyY1JHQiwgIl0iKTsKICAgICAgICAgICAgICAgICAgICB2YXIgU1JDX0FMUEhBID0gc2NvcGUuZGVmKEJMRU5EX0ZVTkNTLCAiWyIsIHJlYWQoInNyYyIsICJBbHBoYSIpLCAiXSIpOwogICAgICAgICAgICAgICAgICAgIHZhciBEU1RfUkdCID0gc2NvcGUuZGVmKEJMRU5EX0ZVTkNTLCAiWyIsIGRzdFJHQiwgIl0iKTsKICAgICAgICAgICAgICAgICAgICB2YXIgRFNUX0FMUEhBID0gc2NvcGUuZGVmKEJMRU5EX0ZVTkNTLCAiWyIsIHJlYWQoImRzdCIsICJBbHBoYSIpLCAiXSIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBbU1JDX1JHQiwgRFNUX1JHQiwgU1JDX0FMUEhBLCBEU1RfQUxQSEFdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNhc2UgU19CTEVORF9FUVVBVElPTjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIodmFsdWUsIGJsZW5kRXF1YXRpb25zLCAiaW52YWxpZCAiICsgcHJvcCwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgICAgYmxlbmRFcXVhdGlvbnNbdmFsdWVdLAogICAgICAgICAgICAgICAgICAgICAgICBibGVuZEVxdWF0aW9uc1t2YWx1ZV0KICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIoCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnJnYiwKICAgICAgICAgICAgICAgICAgICAgICAgYmxlbmRFcXVhdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgKyAiLnJnYiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kUGFyYW1ldGVyKAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5hbHBoYSwKICAgICAgICAgICAgICAgICAgICAgICAgYmxlbmRFcXVhdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgKyAiLmFscGhhIiwKICAgICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgICBibGVuZEVxdWF0aW9uc1t2YWx1ZS5yZ2JdLAogICAgICAgICAgICAgICAgICAgICAgICBibGVuZEVxdWF0aW9uc1t2YWx1ZS5hbHBoYV0KICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFJhaXNlKCJpbnZhbGlkIGJsZW5kLmVxdWF0aW9uIiwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZW52Miwgc2NvcGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIEJMRU5EX0VRVUFUSU9OUyA9IGVudjIuY29uc3RhbnRzLmJsZW5kRXF1YXRpb25zOwogICAgICAgICAgICAgICAgICAgIHZhciBSR0IgPSBzY29wZS5kZWYoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgQUxQSEEgPSBzY29wZS5kZWYoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgaWZ0ZSA9IGVudjIuY29uZCgidHlwZW9mICIsIHZhbHVlLCAnPT09InN0cmluZyInKTsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wKGJsb2NrLCBuYW1lLCB2YWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2ssCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUyICsgIiBpbiAiICsgQkxFTkRfRVFVQVRJT05TLAogICAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkICIgKyBuYW1lICsgIiwgbXVzdCBiZSBvbmUgb2YgIiArIE9iamVjdC5rZXlzKGJsZW5kRXF1YXRpb25zKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wKGlmdGUudGhlbiwgcHJvcCwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgIGlmdGUuZWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgKyAiJiZ0eXBlb2YgIiArIHZhbHVlICsgJz09PSJvYmplY3QiJywKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgIiArIHByb3AKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3AoaWZ0ZS5lbHNlLCBwcm9wICsgIi5yZ2IiLCB2YWx1ZSArICIucmdiIik7CiAgICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3AoaWZ0ZS5lbHNlLCBwcm9wICsgIi5hbHBoYSIsIHZhbHVlICsgIi5hbHBoYSIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmdGUudGhlbigKICAgICAgICAgICAgICAgICAgICAgIFJHQiwKICAgICAgICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgICAgICAgIEFMUEhBLAogICAgICAgICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgICAgICAgQkxFTkRfRVFVQVRJT05TLAogICAgICAgICAgICAgICAgICAgICAgIlsiLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAiXTsiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBpZnRlLmVsc2UoCiAgICAgICAgICAgICAgICAgICAgICBSR0IsCiAgICAgICAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICAgICAgICBCTEVORF9FUVVBVElPTlMsCiAgICAgICAgICAgICAgICAgICAgICAiWyIsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICIucmdiXTsiLAogICAgICAgICAgICAgICAgICAgICAgQUxQSEEsCiAgICAgICAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICAgICAgICBCTEVORF9FUVVBVElPTlMsCiAgICAgICAgICAgICAgICAgICAgICAiWyIsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICIuYWxwaGFdOyIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHNjb3BlKGlmdGUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBbUkdCLCBBTFBIQV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2FzZSBTX0JMRU5EX0NPTE9SOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gNCwKICAgICAgICAgICAgICAgICAgICAgICJibGVuZC5jb2xvciBtdXN0IGJlIGEgNGQgYXJyYXkiLAogICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb29wKDQsIGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiArdmFsdWVbaV07CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudjIuc2hhcmVkLmlzQXJyYXlMaWtlICsgIigiICsgdmFsdWUgKyAiKSYmIiArIHZhbHVlICsgIi5sZW5ndGg9PT00IiwKICAgICAgICAgICAgICAgICAgICAgICAgImJsZW5kLmNvbG9yIG11c3QgYmUgYSA0ZCBhcnJheSIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvb3AoNCwgZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmRlZigiKyIsIHZhbHVlLCAiWyIsIGksICJdIik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2FzZSBTX1NURU5DSUxfTUFTSzoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFR5cGUodmFsdWUsICJudW1iZXIiLCBwYXJhbSwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSB8IDA7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlb2YgIiArIHZhbHVlICsgJz09PSJudW1iZXIiJywKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgc3RlbmNpbC5tYXNrIgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKHZhbHVlLCAifDAiKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjYXNlIFNfU1RFTkNJTF9GVU5DOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kVHlwZSh2YWx1ZSwgIm9iamVjdCIsIHBhcmFtLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNtcCA9IHZhbHVlLmNtcCB8fCAia2VlcCI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9IHZhbHVlLnJlZiB8fCAwOwogICAgICAgICAgICAgICAgICAgIHZhciBtYXNrID0gIm1hc2siIGluIHZhbHVlID8gdmFsdWUubWFzayA6IC0xOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFBhcmFtZXRlcihjbXAsIGNvbXBhcmVGdW5jcywgcHJvcCArICIuY21wIiwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFR5cGUocmVmLCAibnVtYmVyIiwgcHJvcCArICIucmVmIiwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFR5cGUobWFzaywgIm51bWJlciIsIHByb3AgKyAiLm1hc2siLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcmVGdW5jc1tjbXBdLAogICAgICAgICAgICAgICAgICAgICAgcmVmLAogICAgICAgICAgICAgICAgICAgICAgbWFzawogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBDT01QQVJFX0ZVTkNTID0gZW52Mi5jb25zdGFudHMuY29tcGFyZUZ1bmNzOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBhc3NlcnQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5qb2luLmNhbGwoYXJndW1lbnRzLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgc3RlbmNpbC5mdW5jIgogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KHZhbHVlICsgIiYmdHlwZW9mICIsIHZhbHVlLCAnPT09Im9iamVjdCInKTsKICAgICAgICAgICAgICAgICAgICAgIGFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgJyEoImNtcCIgaW4gJywKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICIpfHwoIiwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICIuY21wIGluICIsCiAgICAgICAgICAgICAgICAgICAgICAgIENPTVBBUkVfRlVOQ1MsCiAgICAgICAgICAgICAgICAgICAgICAgICIpIgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgY21wID0gc2NvcGUuZGVmKAogICAgICAgICAgICAgICAgICAgICAgJyJjbXAiIGluICcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICI/IiwKICAgICAgICAgICAgICAgICAgICAgIENPTVBBUkVfRlVOQ1MsCiAgICAgICAgICAgICAgICAgICAgICAiWyIsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICIuY21wXSIsCiAgICAgICAgICAgICAgICAgICAgICAiOiIsCiAgICAgICAgICAgICAgICAgICAgICBHTF9LRUVQCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gc2NvcGUuZGVmKHZhbHVlLCAiLnJlZnwwIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hc2sgPSBzY29wZS5kZWYoCiAgICAgICAgICAgICAgICAgICAgICAnIm1hc2siIGluICcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICI/IiwKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgIi5tYXNrfDA6LTEiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2NtcCwgcmVmLCBtYXNrXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjYXNlIFNfU1RFTkNJTF9PUEZST05UOgogICAgICAgICAgICAgIGNhc2UgU19TVEVOQ0lMX09QQkFDSzoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFR5cGUodmFsdWUsICJvYmplY3QiLCBwYXJhbSwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIHZhciBmYWlsID0gdmFsdWUuZmFpbCB8fCAia2VlcCI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHpmYWlsID0gdmFsdWUuemZhaWwgfHwgImtlZXAiOwogICAgICAgICAgICAgICAgICAgIHZhciB6cGFzcyA9IHZhbHVlLnpwYXNzIHx8ICJrZWVwIjsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIoZmFpbCwgc3RlbmNpbE9wcywgcHJvcCArICIuZmFpbCIsIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIoemZhaWwsIHN0ZW5jaWxPcHMsIHByb3AgKyAiLnpmYWlsIiwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFBhcmFtZXRlcih6cGFzcywgc3RlbmNpbE9wcywgcHJvcCArICIuenBhc3MiLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICAgIHByb3AgPT09IFNfU1RFTkNJTF9PUEJBQ0sgPyBHTF9CQUNLIDogR0xfRlJPTlQsCiAgICAgICAgICAgICAgICAgICAgICBzdGVuY2lsT3BzW2ZhaWxdLAogICAgICAgICAgICAgICAgICAgICAgc3RlbmNpbE9wc1t6ZmFpbF0sCiAgICAgICAgICAgICAgICAgICAgICBzdGVuY2lsT3BzW3pwYXNzXQogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBTVEVOQ0lMX09QUyA9IGVudjIuY29uc3RhbnRzLnN0ZW5jaWxPcHM7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgKyAiJiZ0eXBlb2YgIiArIHZhbHVlICsgJz09PSJvYmplY3QiJywKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgIiArIHByb3AKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAnISgiJyArIG5hbWUgKyAnIiBpbiAnICsgdmFsdWUgKyAiKXx8KCIgKyB2YWx1ZSArICIuIiArIG5hbWUgKyAiIGluICIgKyBTVEVOQ0lMX09QUyArICIpIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCAiICsgcHJvcCArICIuIiArIG5hbWUgKyAiLCBtdXN0IGJlIG9uZSBvZiAiICsgT2JqZWN0LmtleXMoc3RlbmNpbE9wcykKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmRlZigKICAgICAgICAgICAgICAgICAgICAgICAgJyInLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAnIiBpbiAnLAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgIj8iLAogICAgICAgICAgICAgICAgICAgICAgICBTVEVOQ0lMX09QUywKICAgICAgICAgICAgICAgICAgICAgICAgIlsiLAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgIi4iLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAiXToiLAogICAgICAgICAgICAgICAgICAgICAgICBHTF9LRUVQCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgcHJvcCA9PT0gU19TVEVOQ0lMX09QQkFDSyA/IEdMX0JBQ0sgOiBHTF9GUk9OVCwKICAgICAgICAgICAgICAgICAgICAgIHJlYWQoImZhaWwiKSwKICAgICAgICAgICAgICAgICAgICAgIHJlYWQoInpmYWlsIiksCiAgICAgICAgICAgICAgICAgICAgICByZWFkKCJ6cGFzcyIpCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjYXNlIFNfUE9MWUdPTl9PRkZTRVRfT0ZGU0VUOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kVHlwZSh2YWx1ZSwgIm9iamVjdCIsIHBhcmFtLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZhY3RvciA9IHZhbHVlLmZhY3RvciB8IDA7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVuaXRzID0gdmFsdWUudW5pdHMgfCAwOwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFR5cGUoZmFjdG9yLCAibnVtYmVyIiwgcGFyYW0gKyAiLmZhY3RvciIsIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRUeXBlKHVuaXRzLCAibnVtYmVyIiwgcGFyYW0gKyAiLnVuaXRzIiwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBbZmFjdG9yLCB1bml0c107CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICsgIiYmdHlwZW9mICIgKyB2YWx1ZSArICc9PT0ib2JqZWN0IicsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkICIgKyBwcm9wCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHZhciBGQUNUT1IgPSBzY29wZS5kZWYodmFsdWUsICIuZmFjdG9yfDAiKTsKICAgICAgICAgICAgICAgICAgICB2YXIgVU5JVFMgPSBzY29wZS5kZWYodmFsdWUsICIudW5pdHN8MCIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBbRkFDVE9SLCBVTklUU107CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2FzZSBTX0NVTExfRkFDRToKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmYWNlID0gMDsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICJmcm9udCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGZhY2UgPSBHTF9GUk9OVDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAiYmFjayIpIHsKICAgICAgICAgICAgICAgICAgICAgIGZhY2UgPSBHTF9CQUNLOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoISFmYWNlLCBwYXJhbSwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWNlOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBmdW5jdGlvbihlbnYyLCBzY29wZSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgZW52Mi5hc3NlcnQoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLAogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSArICc9PT0iZnJvbnQifHwnICsgdmFsdWUgKyAnPT09ImJhY2siJywKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgY3VsbC5mYWNlIgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKHZhbHVlLCAnPT09ImZyb250Ij8nLCBHTF9GUk9OVCwgIjoiLCBHTF9CQUNLKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjYXNlIFNfTElORV9XSURUSDoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgPj0gbGltaXRzLmxpbmVXaWR0aERpbXNbMF0gJiYgdmFsdWUgPD0gbGltaXRzLmxpbmVXaWR0aERpbXNbMV0sCiAgICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBsaW5lIHdpZHRoLCBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyIGJldHdlZW4gIiArIGxpbWl0cy5saW5lV2lkdGhEaW1zWzBdICsgIiBhbmQgIiArIGxpbWl0cy5saW5lV2lkdGhEaW1zWzFdLAogICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZW52Miwgc2NvcGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGVvZiAiICsgdmFsdWUgKyAnPT09Im51bWJlciImJicgKyB2YWx1ZSArICI+PSIgKyBsaW1pdHMubGluZVdpZHRoRGltc1swXSArICImJiIgKyB2YWx1ZSArICI8PSIgKyBsaW1pdHMubGluZVdpZHRoRGltc1sxXSwKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgbGluZSB3aWR0aCIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNhc2UgU19GUk9OVF9GQUNFOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlUGFyYW0oCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kUGFyYW1ldGVyKHZhbHVlLCBvcmllbnRhdGlvblR5cGUsIHBhcmFtLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9yaWVudGF0aW9uVHlwZVt2YWx1ZV07CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlICsgJz09PSJjdyJ8fCcgKyB2YWx1ZSArICc9PT0iY2N3IicsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIGZyb250RmFjZSwgbXVzdCBiZSBvbmUgb2YgY3csY2N3IgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGVmKHZhbHVlICsgJz09PSJjdyI/JyArIEdMX0NXICsgIjoiICsgR0xfQ0NXKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjYXNlIFNfQ09MT1JfTUFTSzoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXlMaWtlKHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDQsCiAgICAgICAgICAgICAgICAgICAgICAiY29sb3IubWFzayBtdXN0IGJlIGxlbmd0aCA0IGFycmF5IiwKICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhIXY7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVudjIsIHNjb3BlLCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbnYyLmFzc2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudjIuc2hhcmVkLmlzQXJyYXlMaWtlICsgIigiICsgdmFsdWUgKyAiKSYmIiArIHZhbHVlICsgIi5sZW5ndGg9PT00IiwKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgY29sb3IubWFzayIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvb3AoNCwgZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIhISIgKyB2YWx1ZSArICJbIiArIGkgKyAiXSI7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY2FzZSBTX1NBTVBMRV9DT1ZFUkFHRToKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVBhcmFtKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlLCBwYXJhbSwgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICAgICAgICAgIHZhciBzYW1wbGVWYWx1ZSA9ICJ2YWx1ZSIgaW4gdmFsdWUgPyB2YWx1ZS52YWx1ZSA6IDE7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNhbXBsZUludmVydCA9ICEhdmFsdWUuaW52ZXJ0OwogICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBzYW1wbGVWYWx1ZSA9PT0gIm51bWJlciIgJiYgc2FtcGxlVmFsdWUgPj0gMCAmJiBzYW1wbGVWYWx1ZSA8PSAxLAogICAgICAgICAgICAgICAgICAgICAgInNhbXBsZS5jb3ZlcmFnZS52YWx1ZSBtdXN0IGJlIGEgbnVtYmVyIGJldHdlZW4gMCBhbmQgMSIsCiAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtzYW1wbGVWYWx1ZSwgc2FtcGxlSW52ZXJ0XTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZW52Miwgc2NvcGUsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgKyAiJiZ0eXBlb2YgIiArIHZhbHVlICsgJz09PSJvYmplY3QiJywKICAgICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgc2FtcGxlLmNvdmVyYWdlIgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2YXIgVkFMVUUgPSBzY29wZS5kZWYoCiAgICAgICAgICAgICAgICAgICAgICAnInZhbHVlIiBpbiAnLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAiPysiLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAiLnZhbHVlOjEiCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB2YXIgSU5WRVJUID0gc2NvcGUuZGVmKCIhISIsIHZhbHVlLCAiLmludmVydCIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBbVkFMVUUsIElOVkVSVF07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIFNUQVRFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZVVuaWZvcm1zKHVuaWZvcm1zLCBlbnYpIHsKICAgICAgICAgIHZhciBzdGF0aWNVbmlmb3JtcyA9IHVuaWZvcm1zLnN0YXRpYzsKICAgICAgICAgIHZhciBkeW5hbWljVW5pZm9ybXMgPSB1bmlmb3Jtcy5keW5hbWljOwogICAgICAgICAgdmFyIFVOSUZPUk1TID0ge307CiAgICAgICAgICBPYmplY3Qua2V5cyhzdGF0aWNVbmlmb3JtcykuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHN0YXRpY1VuaWZvcm1zW25hbWVdOwogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgIHJlc3VsdCA9IGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJlZ2xUeXBlID0gdmFsdWUuX3JlZ2xUeXBlOwogICAgICAgICAgICAgIGlmIChyZWdsVHlwZSA9PT0gInRleHR1cmUyZCIgfHwgcmVnbFR5cGUgPT09ICJ0ZXh0dXJlQ3ViZSIpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZW52Mi5saW5rKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVnbFR5cGUgPT09ICJmcmFtZWJ1ZmZlciIgfHwgcmVnbFR5cGUgPT09ICJmcmFtZWJ1ZmZlckN1YmUiKSB7CiAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgIHZhbHVlLmNvbG9yLmxlbmd0aCA+IDAsCiAgICAgICAgICAgICAgICAgICdtaXNzaW5nIGNvbG9yIGF0dGFjaG1lbnQgZm9yIGZyYW1lYnVmZmVyIHNlbnQgdG8gdW5pZm9ybSAiJyArIG5hbWUgKyAnIicsCiAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gY3JlYXRlU3RhdGljRGVjbChmdW5jdGlvbihlbnYyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBlbnYyLmxpbmsodmFsdWUuY29sb3JbMF0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZFJhaXNlKCdpbnZhbGlkIGRhdGEgZm9yIHVuaWZvcm0gIicgKyBuYW1lICsgJyInLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKHZhbHVlKSkgewogICAgICAgICAgICAgIHJlc3VsdCA9IGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52MikgewogICAgICAgICAgICAgICAgdmFyIElURU0gPSBlbnYyLmdsb2JhbC5kZWYoCiAgICAgICAgICAgICAgICAgICJbIiwKICAgICAgICAgICAgICAgICAgbG9vcCh2YWx1ZS5sZW5ndGgsIGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgdmFsdWVbaV0gPT09ICJudW1iZXIiIHx8IHR5cGVvZiB2YWx1ZVtpXSA9PT0gImJvb2xlYW4iLAogICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgdW5pZm9ybSAiICsgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGVudjIuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlW2ldOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgIl0iCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcmV0dXJuIElURU07CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kUmFpc2UoJ2ludmFsaWQgb3IgbWlzc2luZyBkYXRhIGZvciB1bmlmb3JtICInICsgbmFtZSArICciJywgZW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBVTklGT1JNU1tuYW1lXSA9IHJlc3VsdDsKICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmtleXMoZHluYW1pY1VuaWZvcm1zKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICB2YXIgZHluID0gZHluYW1pY1VuaWZvcm1zW2tleV07CiAgICAgICAgICAgIFVOSUZPUk1TW2tleV0gPSBjcmVhdGVEeW5hbWljRGVjbChkeW4sIGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVudjIuaW52b2tlKHNjb3BlLCBkeW4pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIFVOSUZPUk1TOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZUF0dHJpYnV0ZXMoYXR0cmlidXRlcywgZW52KSB7CiAgICAgICAgICB2YXIgc3RhdGljQXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMuc3RhdGljOwogICAgICAgICAgdmFyIGR5bmFtaWNBdHRyaWJ1dGVzID0gYXR0cmlidXRlcy5keW5hbWljOwogICAgICAgICAgdmFyIGF0dHJpYnV0ZURlZnMgPSB7fTsKICAgICAgICAgIE9iamVjdC5rZXlzKHN0YXRpY0F0dHJpYnV0ZXMpLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHN0YXRpY0F0dHJpYnV0ZXNbYXR0cmlidXRlXTsKICAgICAgICAgICAgdmFyIGlkID0gc3RyaW5nU3RvcmUuaWQoYXR0cmlidXRlKTsKICAgICAgICAgICAgdmFyIHJlY29yZCA9IG5ldyBBdHRyaWJ1dGVSZWNvcmQyKCk7CiAgICAgICAgICAgIGlmIChpc0J1ZmZlckFyZ3ModmFsdWUpKSB7CiAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gQVRUUklCX1NUQVRFX1BPSU5URVI7CiAgICAgICAgICAgICAgcmVjb3JkLmJ1ZmZlciA9IGJ1ZmZlclN0YXRlLmdldEJ1ZmZlcigKICAgICAgICAgICAgICAgIGJ1ZmZlclN0YXRlLmNyZWF0ZSh2YWx1ZSwgR0xfQVJSQVlfQlVGRkVSJDIsIGZhbHNlLCB0cnVlKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmVjb3JkLnR5cGUgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBidWZmZXIyID0gYnVmZmVyU3RhdGUuZ2V0QnVmZmVyKHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoYnVmZmVyMikgewogICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gQVRUUklCX1NUQVRFX1BPSU5URVI7CiAgICAgICAgICAgICAgICByZWNvcmQuYnVmZmVyID0gYnVmZmVyMjsKICAgICAgICAgICAgICAgIHJlY29yZC50eXBlID0gMDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlLAogICAgICAgICAgICAgICAgICAiaW52YWxpZCBkYXRhIGZvciBhdHRyaWJ1dGUgIiArIGF0dHJpYnV0ZSwKICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAoImNvbnN0YW50IiBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY29uc3RhbnQgPSB2YWx1ZS5jb25zdGFudDsKICAgICAgICAgICAgICAgICAgcmVjb3JkLmJ1ZmZlciA9ICJudWxsIjsKICAgICAgICAgICAgICAgICAgcmVjb3JkLnN0YXRlID0gQVRUUklCX1NUQVRFX0NPTlNUQU5UOwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnN0YW50ID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC54ID0gY29uc3RhbnQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UoY29uc3RhbnQpICYmIGNvbnN0YW50Lmxlbmd0aCA+IDAgJiYgY29uc3RhbnQubGVuZ3RoIDw9IDQsCiAgICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBjb25zdGFudCBmb3IgYXR0cmlidXRlICIgKyBhdHRyaWJ1dGUsCiAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgQ1VURV9DT01QT05FTlRTLmZvckVhY2goZnVuY3Rpb24oYywgaSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPCBjb25zdGFudC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkW2NdID0gY29uc3RhbnRbaV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0J1ZmZlckFyZ3ModmFsdWUuYnVmZmVyKSkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlcjIgPSBidWZmZXJTdGF0ZS5nZXRCdWZmZXIoCiAgICAgICAgICAgICAgICAgICAgICBidWZmZXJTdGF0ZS5jcmVhdGUodmFsdWUuYnVmZmVyLCBHTF9BUlJBWV9CVUZGRVIkMiwgZmFsc2UsIHRydWUpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBidWZmZXIyID0gYnVmZmVyU3RhdGUuZ2V0QnVmZmVyKHZhbHVlLmJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKCEhYnVmZmVyMiwgJ21pc3NpbmcgYnVmZmVyIGZvciBhdHRyaWJ1dGUgIicgKyBhdHRyaWJ1dGUgKyAnIicsIGVudi5jb21tYW5kU3RyKTsKICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldCA9IHZhbHVlLm9mZnNldCB8IDA7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPj0gMCwKICAgICAgICAgICAgICAgICAgICAnaW52YWxpZCBvZmZzZXQgZm9yIGF0dHJpYnV0ZSAiJyArIGF0dHJpYnV0ZSArICciJywKICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB2YXIgc3RyaWRlID0gdmFsdWUuc3RyaWRlIHwgMDsKICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgIHN0cmlkZSA+PSAwICYmIHN0cmlkZSA8IDI1NiwKICAgICAgICAgICAgICAgICAgICAnaW52YWxpZCBzdHJpZGUgZm9yIGF0dHJpYnV0ZSAiJyArIGF0dHJpYnV0ZSArICciLCBtdXN0IGJlIGludGVnZXIgYmV0d2VlZW4gWzAsIDI1NV0nLAogICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHZhciBzaXplID0gdmFsdWUuc2l6ZSB8IDA7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAhKCJzaXplIiBpbiB2YWx1ZSkgfHwgc2l6ZSA+IDAgJiYgc2l6ZSA8PSA0LAogICAgICAgICAgICAgICAgICAgICdpbnZhbGlkIHNpemUgZm9yIGF0dHJpYnV0ZSAiJyArIGF0dHJpYnV0ZSArICciLCBtdXN0IGJlIDEsMiwzLDQnLAogICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHZhciBub3JtYWxpemVkID0gISF2YWx1ZS5ub3JtYWxpemVkOwogICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IDA7CiAgICAgICAgICAgICAgICAgIGlmICgidHlwZSIgaW4gdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRQYXJhbWV0ZXIoCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS50eXBlLAogICAgICAgICAgICAgICAgICAgICAgZ2xUeXBlcywKICAgICAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHR5cGUgZm9yIGF0dHJpYnV0ZSAiICsgYXR0cmlidXRlLAogICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIHR5cGUgPSBnbFR5cGVzW3ZhbHVlLnR5cGVdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBkaXZpc29yID0gdmFsdWUuZGl2aXNvciB8IDA7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCJkaXZpc29yIiBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgICBkaXZpc29yID09PSAwIHx8IGV4dEluc3RhbmNpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICdjYW5ub3Qgc3BlY2lmeSBkaXZpc29yIGZvciBhdHRyaWJ1dGUgIicgKyBhdHRyaWJ1dGUgKyAnIiwgaW5zdGFuY2luZyBub3Qgc3VwcG9ydGVkJywKICAgICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIGRpdmlzb3IgPj0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2ludmFsaWQgZGl2aXNvciBmb3IgYXR0cmlidXRlICInICsgYXR0cmlidXRlICsgJyInLAogICAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbW1hbmQgPSBlbnYuY29tbWFuZFN0cjsKICAgICAgICAgICAgICAgICAgICB2YXIgVkFMSURfS0VZUyA9IFsKICAgICAgICAgICAgICAgICAgICAgICJidWZmZXIiLAogICAgICAgICAgICAgICAgICAgICAgIm9mZnNldCIsCiAgICAgICAgICAgICAgICAgICAgICAiZGl2aXNvciIsCiAgICAgICAgICAgICAgICAgICAgICAibm9ybWFsaXplZCIsCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAic2l6ZSIsCiAgICAgICAgICAgICAgICAgICAgICAic3RyaWRlIgogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmtleXModmFsdWUpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgICBWQUxJRF9LRVlTLmluZGV4T2YocHJvcCkgPj0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3Vua25vd24gcGFyYW1ldGVyICInICsgcHJvcCArICciIGZvciBhdHRyaWJ1dGUgcG9pbnRlciAiJyArIGF0dHJpYnV0ZSArICciICh2YWxpZCBwYXJhbWV0ZXJzIGFyZSAnICsgVkFMSURfS0VZUyArICIpIiwKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZAogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHJlY29yZC5idWZmZXIgPSBidWZmZXIyOwogICAgICAgICAgICAgICAgICByZWNvcmQuc3RhdGUgPSBBVFRSSUJfU1RBVEVfUE9JTlRFUjsKICAgICAgICAgICAgICAgICAgcmVjb3JkLnNpemUgPSBzaXplOwogICAgICAgICAgICAgICAgICByZWNvcmQubm9ybWFsaXplZCA9IG5vcm1hbGl6ZWQ7CiAgICAgICAgICAgICAgICAgIHJlY29yZC50eXBlID0gdHlwZSB8fCBidWZmZXIyLmR0eXBlOwogICAgICAgICAgICAgICAgICByZWNvcmQub2Zmc2V0ID0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICByZWNvcmQuc3RyaWRlID0gc3RyaWRlOwogICAgICAgICAgICAgICAgICByZWNvcmQuZGl2aXNvciA9IGRpdmlzb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGF0dHJpYnV0ZURlZnNbYXR0cmlidXRlXSA9IGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52Miwgc2NvcGUpIHsKICAgICAgICAgICAgICB2YXIgY2FjaGUgPSBlbnYyLmF0dHJpYkNhY2hlOwogICAgICAgICAgICAgIGlmIChpZCBpbiBjYWNoZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlW2lkXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICAgICAgICAgIGlzU3RyZWFtOiBmYWxzZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmtleXMocmVjb3JkKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgcmVzdWx0W2tleV0gPSByZWNvcmRba2V5XTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAocmVjb3JkLmJ1ZmZlcikgewogICAgICAgICAgICAgICAgcmVzdWx0LmJ1ZmZlciA9IGVudjIubGluayhyZWNvcmQuYnVmZmVyKTsKICAgICAgICAgICAgICAgIHJlc3VsdC50eXBlID0gcmVzdWx0LnR5cGUgfHwgcmVzdWx0LmJ1ZmZlciArICIuZHR5cGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYWNoZVtpZF0gPSByZXN1bHQ7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5rZXlzKGR5bmFtaWNBdHRyaWJ1dGVzKS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZSkgewogICAgICAgICAgICB2YXIgZHluID0gZHluYW1pY0F0dHJpYnV0ZXNbYXR0cmlidXRlXTsKICAgICAgICAgICAgZnVuY3Rpb24gYXBwZW5kQXR0cmlidXRlQ29kZShlbnYyLCBibG9jaykgewogICAgICAgICAgICAgIHZhciBWQUxVRSA9IGVudjIuaW52b2tlKGJsb2NrLCBkeW4pOwogICAgICAgICAgICAgIHZhciBzaGFyZWQgPSBlbnYyLnNoYXJlZDsKICAgICAgICAgICAgICB2YXIgY29uc3RhbnRzMiA9IGVudjIuY29uc3RhbnRzOwogICAgICAgICAgICAgIHZhciBJU19CVUZGRVJfQVJHUyA9IHNoYXJlZC5pc0J1ZmZlckFyZ3M7CiAgICAgICAgICAgICAgdmFyIEJVRkZFUl9TVEFURSA9IHNoYXJlZC5idWZmZXI7CiAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGVudjIuYXNzZXJ0KAogICAgICAgICAgICAgICAgICBibG9jaywKICAgICAgICAgICAgICAgICAgVkFMVUUgKyAiJiYodHlwZW9mICIgKyBWQUxVRSArICc9PT0ib2JqZWN0Inx8dHlwZW9mICcgKyBWQUxVRSArICc9PT0iZnVuY3Rpb24iKSYmKCcgKyBJU19CVUZGRVJfQVJHUyArICIoIiArIFZBTFVFICsgIil8fCIgKyBCVUZGRVJfU1RBVEUgKyAiLmdldEJ1ZmZlcigiICsgVkFMVUUgKyAiKXx8IiArIEJVRkZFUl9TVEFURSArICIuZ2V0QnVmZmVyKCIgKyBWQUxVRSArICIuYnVmZmVyKXx8IiArIElTX0JVRkZFUl9BUkdTICsgIigiICsgVkFMVUUgKyAnLmJ1ZmZlcil8fCgiY29uc3RhbnQiIGluICcgKyBWQUxVRSArICImJih0eXBlb2YgIiArIFZBTFVFICsgJy5jb25zdGFudD09PSJudW1iZXIifHwnICsgc2hhcmVkLmlzQXJyYXlMaWtlICsgIigiICsgVkFMVUUgKyAiLmNvbnN0YW50KSkpKSIsCiAgICAgICAgICAgICAgICAgICdpbnZhbGlkIGR5bmFtaWMgYXR0cmlidXRlICInICsgYXR0cmlidXRlICsgJyInCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICAgICAgICBpc1N0cmVhbTogYmxvY2suZGVmKGZhbHNlKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRSZWNvcmQgPSBuZXcgQXR0cmlidXRlUmVjb3JkMigpOwogICAgICAgICAgICAgIGRlZmF1bHRSZWNvcmQuc3RhdGUgPSBBVFRSSUJfU1RBVEVfUE9JTlRFUjsKICAgICAgICAgICAgICBPYmplY3Qua2V5cyhkZWZhdWx0UmVjb3JkKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgcmVzdWx0W2tleV0gPSBibG9jay5kZWYoIiIgKyBkZWZhdWx0UmVjb3JkW2tleV0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBCVUZGRVIgPSByZXN1bHQuYnVmZmVyOwogICAgICAgICAgICAgIHZhciBUWVBFID0gcmVzdWx0LnR5cGU7CiAgICAgICAgICAgICAgYmxvY2soCiAgICAgICAgICAgICAgICAiaWYoIiwKICAgICAgICAgICAgICAgIElTX0JVRkZFUl9BUkdTLAogICAgICAgICAgICAgICAgIigiLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiKSl7IiwKICAgICAgICAgICAgICAgIHJlc3VsdC5pc1N0cmVhbSwKICAgICAgICAgICAgICAgICI9dHJ1ZTsiLAogICAgICAgICAgICAgICAgQlVGRkVSLAogICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgQlVGRkVSX1NUQVRFLAogICAgICAgICAgICAgICAgIi5jcmVhdGVTdHJlYW0oIiwKICAgICAgICAgICAgICAgIEdMX0FSUkFZX0JVRkZFUiQyLAogICAgICAgICAgICAgICAgIiwiLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgVFlQRSwKICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgIEJVRkZFUiwKICAgICAgICAgICAgICAgICIuZHR5cGU7IiwKICAgICAgICAgICAgICAgICJ9ZWxzZXsiLAogICAgICAgICAgICAgICAgQlVGRkVSLAogICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgQlVGRkVSX1NUQVRFLAogICAgICAgICAgICAgICAgIi5nZXRCdWZmZXIoIiwKICAgICAgICAgICAgICAgIFZBTFVFLAogICAgICAgICAgICAgICAgIik7IiwKICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgQlVGRkVSLAogICAgICAgICAgICAgICAgIil7IiwKICAgICAgICAgICAgICAgIFRZUEUsCiAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICBCVUZGRVIsCiAgICAgICAgICAgICAgICAiLmR0eXBlOyIsCiAgICAgICAgICAgICAgICAnfWVsc2UgaWYoImNvbnN0YW50IiBpbiAnLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiKXsiLAogICAgICAgICAgICAgICAgcmVzdWx0LnN0YXRlLAogICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgQVRUUklCX1NUQVRFX0NPTlNUQU5ULAogICAgICAgICAgICAgICAgIjsiLAogICAgICAgICAgICAgICAgImlmKHR5cGVvZiAiICsgVkFMVUUgKyAnLmNvbnN0YW50ID09PSAibnVtYmVyIil7JywKICAgICAgICAgICAgICAgIHJlc3VsdFtDVVRFX0NPTVBPTkVOVFNbMF1dLAogICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiLmNvbnN0YW50OyIsCiAgICAgICAgICAgICAgICBDVVRFX0NPTVBPTkVOVFMuc2xpY2UoMSkubWFwKGZ1bmN0aW9uKG4pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdFtuXTsKICAgICAgICAgICAgICAgIH0pLmpvaW4oIj0iKSwKICAgICAgICAgICAgICAgICI9MDsiLAogICAgICAgICAgICAgICAgIn1lbHNleyIsCiAgICAgICAgICAgICAgICBDVVRFX0NPTVBPTkVOVFMubWFwKGZ1bmN0aW9uKG5hbWUsIGkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdFtuYW1lXSArICI9IiArIFZBTFVFICsgIi5jb25zdGFudC5sZW5ndGg+IiArIGkgKyAiPyIgKyBWQUxVRSArICIuY29uc3RhbnRbIiArIGkgKyAiXTowOyI7CiAgICAgICAgICAgICAgICB9KS5qb2luKCIiKSwKICAgICAgICAgICAgICAgICJ9fWVsc2V7IiwKICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgSVNfQlVGRkVSX0FSR1MsCiAgICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgICBWQUxVRSwKICAgICAgICAgICAgICAgICIuYnVmZmVyKSl7IiwKICAgICAgICAgICAgICAgIEJVRkZFUiwKICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgIEJVRkZFUl9TVEFURSwKICAgICAgICAgICAgICAgICIuY3JlYXRlU3RyZWFtKCIsCiAgICAgICAgICAgICAgICBHTF9BUlJBWV9CVUZGRVIkMiwKICAgICAgICAgICAgICAgICIsIiwKICAgICAgICAgICAgICAgIFZBTFVFLAogICAgICAgICAgICAgICAgIi5idWZmZXIpOyIsCiAgICAgICAgICAgICAgICAifWVsc2V7IiwKICAgICAgICAgICAgICAgIEJVRkZFUiwKICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgIEJVRkZFUl9TVEFURSwKICAgICAgICAgICAgICAgICIuZ2V0QnVmZmVyKCIsCiAgICAgICAgICAgICAgICBWQUxVRSwKICAgICAgICAgICAgICAgICIuYnVmZmVyKTsiLAogICAgICAgICAgICAgICAgIn0iLAogICAgICAgICAgICAgICAgVFlQRSwKICAgICAgICAgICAgICAgICc9InR5cGUiIGluICcsCiAgICAgICAgICAgICAgICBWQUxVRSwKICAgICAgICAgICAgICAgICI/IiwKICAgICAgICAgICAgICAgIGNvbnN0YW50czIuZ2xUeXBlcywKICAgICAgICAgICAgICAgICJbIiwKICAgICAgICAgICAgICAgIFZBTFVFLAogICAgICAgICAgICAgICAgIi50eXBlXToiLAogICAgICAgICAgICAgICAgQlVGRkVSLAogICAgICAgICAgICAgICAgIi5kdHlwZTsiLAogICAgICAgICAgICAgICAgcmVzdWx0Lm5vcm1hbGl6ZWQsCiAgICAgICAgICAgICAgICAiPSEhIiwKICAgICAgICAgICAgICAgIFZBTFVFLAogICAgICAgICAgICAgICAgIi5ub3JtYWxpemVkOyIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGZ1bmN0aW9uIGVtaXRSZWFkUmVjb3JkKG5hbWUpIHsKICAgICAgICAgICAgICAgIGJsb2NrKHJlc3VsdFtuYW1lXSwgIj0iLCBWQUxVRSwgIi4iLCBuYW1lLCAifDA7Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVtaXRSZWFkUmVjb3JkKCJzaXplIik7CiAgICAgICAgICAgICAgZW1pdFJlYWRSZWNvcmQoIm9mZnNldCIpOwogICAgICAgICAgICAgIGVtaXRSZWFkUmVjb3JkKCJzdHJpZGUiKTsKICAgICAgICAgICAgICBlbWl0UmVhZFJlY29yZCgiZGl2aXNvciIpOwogICAgICAgICAgICAgIGJsb2NrKCJ9fSIpOwogICAgICAgICAgICAgIGJsb2NrLmV4aXQoCiAgICAgICAgICAgICAgICAiaWYoIiwKICAgICAgICAgICAgICAgIHJlc3VsdC5pc1N0cmVhbSwKICAgICAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgICAgICBCVUZGRVJfU1RBVEUsCiAgICAgICAgICAgICAgICAiLmRlc3Ryb3lTdHJlYW0oIiwKICAgICAgICAgICAgICAgIEJVRkZFUiwKICAgICAgICAgICAgICAgICIpOyIsCiAgICAgICAgICAgICAgICAifSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXR0cmlidXRlRGVmc1thdHRyaWJ1dGVdID0gY3JlYXRlRHluYW1pY0RlY2woZHluLCBhcHBlbmRBdHRyaWJ1dGVDb2RlKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURlZnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBhcnNlQ29udGV4dChjb250ZXh0KSB7CiAgICAgICAgICB2YXIgc3RhdGljQ29udGV4dCA9IGNvbnRleHQuc3RhdGljOwogICAgICAgICAgdmFyIGR5bmFtaWNDb250ZXh0ID0gY29udGV4dC5keW5hbWljOwogICAgICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICAgICAgT2JqZWN0LmtleXMoc3RhdGljQ29udGV4dCkuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHN0YXRpY0NvbnRleHRbbmFtZV07CiAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGNyZWF0ZVN0YXRpY0RlY2woZnVuY3Rpb24oZW52LCBzY29wZSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGVudi5saW5rKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3Qua2V5cyhkeW5hbWljQ29udGV4dCkuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHZhciBkeW4gPSBkeW5hbWljQ29udGV4dFtuYW1lXTsKICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gY3JlYXRlRHluYW1pY0RlY2woZHluLCBmdW5jdGlvbihlbnYsIHNjb3BlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVudi5pbnZva2Uoc2NvcGUsIGR5bik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZUFyZ3VtZW50cyhvcHRpb25zLCBhdHRyaWJ1dGVzLCB1bmlmb3JtcywgY29udGV4dCwgZW52KSB7CiAgICAgICAgICB2YXIgc3RhdGljT3B0aW9ucyA9IG9wdGlvbnMuc3RhdGljOwogICAgICAgICAgdmFyIGR5bmFtaWNPcHRpb25zID0gb3B0aW9ucy5keW5hbWljOwogICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIEtFWV9OQU1FUyA9IFsKICAgICAgICAgICAgICBTX0ZSQU1FQlVGRkVSLAogICAgICAgICAgICAgIFNfVkVSVCwKICAgICAgICAgICAgICBTX0ZSQUcsCiAgICAgICAgICAgICAgU19FTEVNRU5UUywKICAgICAgICAgICAgICBTX1BSSU1JVElWRSwKICAgICAgICAgICAgICBTX09GRlNFVCwKICAgICAgICAgICAgICBTX0NPVU5ULAogICAgICAgICAgICAgIFNfSU5TVEFOQ0VTLAogICAgICAgICAgICAgIFNfUFJPRklMRSwKICAgICAgICAgICAgICBTX1ZBTwogICAgICAgICAgICBdLmNvbmNhdChHTF9TVEFURV9OQU1FUyk7CiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5cyhkaWN0KSB7CiAgICAgICAgICAgICAgT2JqZWN0LmtleXMoZGljdCkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgS0VZX05BTUVTLmluZGV4T2Yoa2V5KSA+PSAwLAogICAgICAgICAgICAgICAgICAndW5rbm93biBwYXJhbWV0ZXIgIicgKyBrZXkgKyAnIicsCiAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoZWNrS2V5cyhzdGF0aWNPcHRpb25zKTsKICAgICAgICAgICAgY2hlY2tLZXlzKGR5bmFtaWNPcHRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIGF0dHJpYkxvY2F0aW9ucyA9IHBhcnNlQXR0cmliTG9jYXRpb25zKG9wdGlvbnMsIGF0dHJpYnV0ZXMpOwogICAgICAgICAgdmFyIGZyYW1lYnVmZmVyID0gcGFyc2VGcmFtZWJ1ZmZlcihvcHRpb25zLCBlbnYpOwogICAgICAgICAgdmFyIHZpZXdwb3J0QW5kU2Npc3NvciA9IHBhcnNlVmlld3BvcnRTY2lzc29yKG9wdGlvbnMsIGZyYW1lYnVmZmVyLCBlbnYpOwogICAgICAgICAgdmFyIGRyYXcgPSBwYXJzZURyYXcob3B0aW9ucywgZW52KTsKICAgICAgICAgIHZhciBzdGF0ZSA9IHBhcnNlR0xTdGF0ZShvcHRpb25zLCBlbnYpOwogICAgICAgICAgdmFyIHNoYWRlciA9IHBhcnNlUHJvZ3JhbShvcHRpb25zLCBlbnYsIGF0dHJpYkxvY2F0aW9ucyk7CiAgICAgICAgICBmdW5jdGlvbiBjb3B5Qm94KG5hbWUpIHsKICAgICAgICAgICAgdmFyIGRlZm4gPSB2aWV3cG9ydEFuZFNjaXNzb3JbbmFtZV07CiAgICAgICAgICAgIGlmIChkZWZuKSB7CiAgICAgICAgICAgICAgc3RhdGVbbmFtZV0gPSBkZWZuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb3B5Qm94KFNfVklFV1BPUlQpOwogICAgICAgICAgY29weUJveChwcm9wTmFtZShTX1NDSVNTT1JfQk9YKSk7CiAgICAgICAgICB2YXIgZGlydHkgPSBPYmplY3Qua2V5cyhzdGF0ZSkubGVuZ3RoID4gMDsKICAgICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICAgIGZyYW1lYnVmZmVyLAogICAgICAgICAgICBkcmF3LAogICAgICAgICAgICBzaGFkZXIsCiAgICAgICAgICAgIHN0YXRlLAogICAgICAgICAgICBkaXJ0eSwKICAgICAgICAgICAgc2NvcGVWQU86IG51bGwsCiAgICAgICAgICAgIGRyYXdWQU86IG51bGwsCiAgICAgICAgICAgIHVzZVZBTzogZmFsc2UsCiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHt9CiAgICAgICAgICB9OwogICAgICAgICAgcmVzdWx0LnByb2ZpbGUgPSBwYXJzZVByb2ZpbGUob3B0aW9ucywgZW52KTsKICAgICAgICAgIHJlc3VsdC51bmlmb3JtcyA9IHBhcnNlVW5pZm9ybXModW5pZm9ybXMsIGVudik7CiAgICAgICAgICByZXN1bHQuZHJhd1ZBTyA9IHJlc3VsdC5zY29wZVZBTyA9IGRyYXcudmFvOwogICAgICAgICAgaWYgKCFyZXN1bHQuZHJhd1ZBTyAmJiBzaGFkZXIucHJvZ3JhbSAmJiAhYXR0cmliTG9jYXRpb25zICYmIGV4dGVuc2lvbnMuYW5nbGVfaW5zdGFuY2VkX2FycmF5cyAmJiBkcmF3LnN0YXRpYy5lbGVtZW50cykgewogICAgICAgICAgICB2YXIgdXNlVkFPID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHN0YXRpY0JpbmRpbmdzID0gc2hhZGVyLnByb2dyYW0uYXR0cmlidXRlcy5tYXAoZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYXR0cmlidXRlcy5zdGF0aWNbYXR0cl07CiAgICAgICAgICAgICAgdXNlVkFPID0gdXNlVkFPICYmICEhYmluZGluZzsKICAgICAgICAgICAgICByZXR1cm4gYmluZGluZzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmICh1c2VWQU8gJiYgc3RhdGljQmluZGluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciB2YW8gPSBhdHRyaWJ1dGVTdGF0ZS5nZXRWQU8oYXR0cmlidXRlU3RhdGUuY3JlYXRlVkFPKHsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHN0YXRpY0JpbmRpbmdzLAogICAgICAgICAgICAgICAgZWxlbWVudHM6IGRyYXcuc3RhdGljLmVsZW1lbnRzCiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgIHJlc3VsdC5kcmF3VkFPID0gbmV3IERlY2xhcmF0aW9uKG51bGwsIG51bGwsIG51bGwsIGZ1bmN0aW9uKGVudjIsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZW52Mi5saW5rKHZhbyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVzdWx0LnVzZVZBTyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChhdHRyaWJMb2NhdGlvbnMpIHsKICAgICAgICAgICAgcmVzdWx0LnVzZVZBTyA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQuYXR0cmlidXRlcyA9IHBhcnNlQXR0cmlidXRlcyhhdHRyaWJ1dGVzLCBlbnYpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LmNvbnRleHQgPSBwYXJzZUNvbnRleHQoY29udGV4dCwgZW52KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtaXRDb250ZXh0KGVudiwgc2NvcGUsIGNvbnRleHQpIHsKICAgICAgICAgIHZhciBzaGFyZWQgPSBlbnYuc2hhcmVkOwogICAgICAgICAgdmFyIENPTlRFWFQgPSBzaGFyZWQuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0RW50ZXIgPSBlbnYuc2NvcGUoKTsKICAgICAgICAgIE9iamVjdC5rZXlzKGNvbnRleHQpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBzY29wZS5zYXZlKENPTlRFWFQsICIuIiArIG5hbWUpOwogICAgICAgICAgICB2YXIgZGVmbiA9IGNvbnRleHRbbmFtZV07CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGRlZm4uYXBwZW5kKGVudiwgc2NvcGUpOwogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBjb250ZXh0RW50ZXIoQ09OVEVYVCwgIi4iLCBuYW1lLCAiPVsiLCB2YWx1ZS5qb2luKCksICJdOyIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnRleHRFbnRlcihDT05URVhULCAiLiIsIG5hbWUsICI9IiwgdmFsdWUsICI7Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2NvcGUoY29udGV4dEVudGVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1pdFBvbGxGcmFtZWJ1ZmZlcihlbnYsIHNjb3BlLCBmcmFtZWJ1ZmZlciwgc2tpcENoZWNrKSB7CiAgICAgICAgICB2YXIgc2hhcmVkID0gZW52LnNoYXJlZDsKICAgICAgICAgIHZhciBHTCA9IHNoYXJlZC5nbDsKICAgICAgICAgIHZhciBGUkFNRUJVRkZFUl9TVEFURSA9IHNoYXJlZC5mcmFtZWJ1ZmZlcjsKICAgICAgICAgIHZhciBFWFRfRFJBV19CVUZGRVJTOwogICAgICAgICAgaWYgKGV4dERyYXdCdWZmZXJzKSB7CiAgICAgICAgICAgIEVYVF9EUkFXX0JVRkZFUlMgPSBzY29wZS5kZWYoc2hhcmVkLmV4dGVuc2lvbnMsICIud2ViZ2xfZHJhd19idWZmZXJzIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29uc3RhbnRzMiA9IGVudi5jb25zdGFudHM7CiAgICAgICAgICB2YXIgRFJBV19CVUZGRVJTID0gY29uc3RhbnRzMi5kcmF3QnVmZmVyOwogICAgICAgICAgdmFyIEJBQ0tfQlVGRkVSID0gY29uc3RhbnRzMi5iYWNrQnVmZmVyOwogICAgICAgICAgdmFyIE5FWFQ7CiAgICAgICAgICBpZiAoZnJhbWVidWZmZXIpIHsKICAgICAgICAgICAgTkVYVCA9IGZyYW1lYnVmZmVyLmFwcGVuZChlbnYsIHNjb3BlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE5FWFQgPSBzY29wZS5kZWYoRlJBTUVCVUZGRVJfU1RBVEUsICIubmV4dCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFza2lwQ2hlY2spIHsKICAgICAgICAgICAgc2NvcGUoImlmKCIsIE5FWFQsICIhPT0iLCBGUkFNRUJVRkZFUl9TVEFURSwgIi5jdXIpeyIpOwogICAgICAgICAgfQogICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICBORVhULAogICAgICAgICAgICAiKXsiLAogICAgICAgICAgICBHTCwKICAgICAgICAgICAgIi5iaW5kRnJhbWVidWZmZXIoIiwKICAgICAgICAgICAgR0xfRlJBTUVCVUZGRVIkMiwKICAgICAgICAgICAgIiwiLAogICAgICAgICAgICBORVhULAogICAgICAgICAgICAiLmZyYW1lYnVmZmVyKTsiCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGV4dERyYXdCdWZmZXJzKSB7CiAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgIEVYVF9EUkFXX0JVRkZFUlMsCiAgICAgICAgICAgICAgIi5kcmF3QnVmZmVyc1dFQkdMKCIsCiAgICAgICAgICAgICAgRFJBV19CVUZGRVJTLAogICAgICAgICAgICAgICJbIiwKICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICIuY29sb3JBdHRhY2htZW50cy5sZW5ndGhdKTsiCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBzY29wZSgKICAgICAgICAgICAgIn1lbHNleyIsCiAgICAgICAgICAgIEdMLAogICAgICAgICAgICAiLmJpbmRGcmFtZWJ1ZmZlcigiLAogICAgICAgICAgICBHTF9GUkFNRUJVRkZFUiQyLAogICAgICAgICAgICAiLG51bGwpOyIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZXh0RHJhd0J1ZmZlcnMpIHsKICAgICAgICAgICAgc2NvcGUoRVhUX0RSQVdfQlVGRkVSUywgIi5kcmF3QnVmZmVyc1dFQkdMKCIsIEJBQ0tfQlVGRkVSLCAiKTsiKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAifSIsCiAgICAgICAgICAgIEZSQU1FQlVGRkVSX1NUQVRFLAogICAgICAgICAgICAiLmN1cj0iLAogICAgICAgICAgICBORVhULAogICAgICAgICAgICAiOyIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoIXNraXBDaGVjaykgewogICAgICAgICAgICBzY29wZSgifSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbWl0UG9sbFN0YXRlKGVudiwgc2NvcGUsIGFyZ3MpIHsKICAgICAgICAgIHZhciBzaGFyZWQgPSBlbnYuc2hhcmVkOwogICAgICAgICAgdmFyIEdMID0gc2hhcmVkLmdsOwogICAgICAgICAgdmFyIENVUlJFTlRfVkFSUyA9IGVudi5jdXJyZW50OwogICAgICAgICAgdmFyIE5FWFRfVkFSUyA9IGVudi5uZXh0OwogICAgICAgICAgdmFyIENVUlJFTlRfU1RBVEUgPSBzaGFyZWQuY3VycmVudDsKICAgICAgICAgIHZhciBORVhUX1NUQVRFID0gc2hhcmVkLm5leHQ7CiAgICAgICAgICB2YXIgYmxvY2sgPSBlbnYuY29uZChDVVJSRU5UX1NUQVRFLCAiLmRpcnR5Iik7CiAgICAgICAgICBHTF9TVEFURV9OQU1FUy5mb3JFYWNoKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgdmFyIHBhcmFtID0gcHJvcE5hbWUocHJvcCk7CiAgICAgICAgICAgIGlmIChwYXJhbSBpbiBhcmdzLnN0YXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBORVhULCBDVVJSRU5UOwogICAgICAgICAgICBpZiAocGFyYW0gaW4gTkVYVF9WQVJTKSB7CiAgICAgICAgICAgICAgTkVYVCA9IE5FWFRfVkFSU1twYXJhbV07CiAgICAgICAgICAgICAgQ1VSUkVOVCA9IENVUlJFTlRfVkFSU1twYXJhbV07CiAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbG9vcChjdXJyZW50U3RhdGVbcGFyYW1dLmxlbmd0aCwgZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGJsb2NrLmRlZihORVhULCAiWyIsIGksICJdIik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYmxvY2soZW52LmNvbmQocGFydHMubWFwKGZ1bmN0aW9uKHAsIGkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwICsgIiE9PSIgKyBDVVJSRU5UICsgIlsiICsgaSArICJdIjsKICAgICAgICAgICAgICB9KS5qb2luKCJ8fCIpKS50aGVuKAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLiIsCiAgICAgICAgICAgICAgICBHTF9WQVJJQUJMRVNbcGFyYW1dLAogICAgICAgICAgICAgICAgIigiLAogICAgICAgICAgICAgICAgcGFydHMsCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgcGFydHMubWFwKGZ1bmN0aW9uKHAsIGkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIENVUlJFTlQgKyAiWyIgKyBpICsgIl09IiArIHA7CiAgICAgICAgICAgICAgICB9KS5qb2luKCI7IiksCiAgICAgICAgICAgICAgICAiOyIKICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBORVhUID0gYmxvY2suZGVmKE5FWFRfU1RBVEUsICIuIiwgcGFyYW0pOwogICAgICAgICAgICAgIHZhciBpZnRlID0gZW52LmNvbmQoTkVYVCwgIiE9PSIsIENVUlJFTlRfU1RBVEUsICIuIiwgcGFyYW0pOwogICAgICAgICAgICAgIGJsb2NrKGlmdGUpOwogICAgICAgICAgICAgIGlmIChwYXJhbSBpbiBHTF9GTEFHUykgewogICAgICAgICAgICAgICAgaWZ0ZSgKICAgICAgICAgICAgICAgICAgZW52LmNvbmQoTkVYVCkudGhlbihHTCwgIi5lbmFibGUoIiwgR0xfRkxBR1NbcGFyYW1dLCAiKTsiKS5lbHNlKEdMLCAiLmRpc2FibGUoIiwgR0xfRkxBR1NbcGFyYW1dLCAiKTsiKSwKICAgICAgICAgICAgICAgICAgQ1VSUkVOVF9TVEFURSwKICAgICAgICAgICAgICAgICAgIi4iLAogICAgICAgICAgICAgICAgICBwYXJhbSwKICAgICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICAgICAiOyIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmdGUoCiAgICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgICAiLiIsCiAgICAgICAgICAgICAgICAgIEdMX1ZBUklBQkxFU1twYXJhbV0sCiAgICAgICAgICAgICAgICAgICIoIiwKICAgICAgICAgICAgICAgICAgTkVYVCwKICAgICAgICAgICAgICAgICAgIik7IiwKICAgICAgICAgICAgICAgICAgQ1VSUkVOVF9TVEFURSwKICAgICAgICAgICAgICAgICAgIi4iLAogICAgICAgICAgICAgICAgICBwYXJhbSwKICAgICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICAgICAiOyIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhhcmdzLnN0YXRlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgYmxvY2soQ1VSUkVOVF9TVEFURSwgIi5kaXJ0eT1mYWxzZTsiKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjb3BlKGJsb2NrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1pdFNldE9wdGlvbnMoZW52LCBzY29wZSwgb3B0aW9ucywgZmlsdGVyMikgewogICAgICAgICAgdmFyIHNoYXJlZCA9IGVudi5zaGFyZWQ7CiAgICAgICAgICB2YXIgQ1VSUkVOVF9WQVJTID0gZW52LmN1cnJlbnQ7CiAgICAgICAgICB2YXIgQ1VSUkVOVF9TVEFURSA9IHNoYXJlZC5jdXJyZW50OwogICAgICAgICAgdmFyIEdMID0gc2hhcmVkLmdsOwogICAgICAgICAgc29ydFN0YXRlKE9iamVjdC5rZXlzKG9wdGlvbnMpKS5mb3JFYWNoKGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgICAgIHZhciBkZWZuID0gb3B0aW9uc1twYXJhbV07CiAgICAgICAgICAgIGlmIChmaWx0ZXIyICYmICFmaWx0ZXIyKGRlZm4pKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YXJpYWJsZSA9IGRlZm4uYXBwZW5kKGVudiwgc2NvcGUpOwogICAgICAgICAgICBpZiAoR0xfRkxBR1NbcGFyYW1dKSB7CiAgICAgICAgICAgICAgdmFyIGZsYWcgPSBHTF9GTEFHU1twYXJhbV07CiAgICAgICAgICAgICAgaWYgKGlzU3RhdGljKGRlZm4pKSB7CiAgICAgICAgICAgICAgICBpZiAodmFyaWFibGUpIHsKICAgICAgICAgICAgICAgICAgc2NvcGUoR0wsICIuZW5hYmxlKCIsIGZsYWcsICIpOyIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc2NvcGUoR0wsICIuZGlzYWJsZSgiLCBmbGFnLCAiKTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2NvcGUoZW52LmNvbmQodmFyaWFibGUpLnRoZW4oR0wsICIuZW5hYmxlKCIsIGZsYWcsICIpOyIpLmVsc2UoR0wsICIuZGlzYWJsZSgiLCBmbGFnLCAiKTsiKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjb3BlKENVUlJFTlRfU1RBVEUsICIuIiwgcGFyYW0sICI9IiwgdmFyaWFibGUsICI7Iik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2UodmFyaWFibGUpKSB7CiAgICAgICAgICAgICAgdmFyIENVUlJFTlQgPSBDVVJSRU5UX1ZBUlNbcGFyYW1dOwogICAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLiIsCiAgICAgICAgICAgICAgICBHTF9WQVJJQUJMRVNbcGFyYW1dLAogICAgICAgICAgICAgICAgIigiLAogICAgICAgICAgICAgICAgdmFyaWFibGUsCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgdmFyaWFibGUubWFwKGZ1bmN0aW9uKHYsIGkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIENVUlJFTlQgKyAiWyIgKyBpICsgIl09IiArIHY7CiAgICAgICAgICAgICAgICB9KS5qb2luKCI7IiksCiAgICAgICAgICAgICAgICAiOyIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLiIsCiAgICAgICAgICAgICAgICBHTF9WQVJJQUJMRVNbcGFyYW1dLAogICAgICAgICAgICAgICAgIigiLAogICAgICAgICAgICAgICAgdmFyaWFibGUsCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgQ1VSUkVOVF9TVEFURSwKICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgIHBhcmFtLAogICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgdmFyaWFibGUsCiAgICAgICAgICAgICAgICAiOyIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0RXh0ZW5zaW9ucyhlbnYsIHNjb3BlKSB7CiAgICAgICAgICBpZiAoZXh0SW5zdGFuY2luZykgewogICAgICAgICAgICBlbnYuaW5zdGFuY2luZyA9IHNjb3BlLmRlZigKICAgICAgICAgICAgICBlbnYuc2hhcmVkLmV4dGVuc2lvbnMsCiAgICAgICAgICAgICAgIi5hbmdsZV9pbnN0YW5jZWRfYXJyYXlzIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbWl0UHJvZmlsZShlbnYsIHNjb3BlLCBhcmdzLCB1c2VTY29wZSwgaW5jcmVtZW50Q291bnRlcikgewogICAgICAgICAgdmFyIHNoYXJlZCA9IGVudi5zaGFyZWQ7CiAgICAgICAgICB2YXIgU1RBVFMgPSBlbnYuc3RhdHM7CiAgICAgICAgICB2YXIgQ1VSUkVOVF9TVEFURSA9IHNoYXJlZC5jdXJyZW50OwogICAgICAgICAgdmFyIFRJTUVSID0gc2hhcmVkLnRpbWVyOwogICAgICAgICAgdmFyIHByb2ZpbGVBcmcgPSBhcmdzLnByb2ZpbGU7CiAgICAgICAgICBmdW5jdGlvbiBwZXJmQ291bnRlcigpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZXJmb3JtYW5jZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRhdGUubm93KCkiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiAicGVyZm9ybWFuY2Uubm93KCkiOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgQ1BVX1NUQVJULCBRVUVSWV9DT1VOVEVSOwogICAgICAgICAgZnVuY3Rpb24gZW1pdFByb2ZpbGVTdGFydChibG9jaykgewogICAgICAgICAgICBDUFVfU1RBUlQgPSBzY29wZS5kZWYoKTsKICAgICAgICAgICAgYmxvY2soQ1BVX1NUQVJULCAiPSIsIHBlcmZDb3VudGVyKCksICI7Iik7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5jcmVtZW50Q291bnRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBibG9jayhTVEFUUywgIi5jb3VudCs9IiwgaW5jcmVtZW50Q291bnRlciwgIjsiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBibG9jayhTVEFUUywgIi5jb3VudCsrOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aW1lcikgewogICAgICAgICAgICAgIGlmICh1c2VTY29wZSkgewogICAgICAgICAgICAgICAgUVVFUllfQ09VTlRFUiA9IHNjb3BlLmRlZigpOwogICAgICAgICAgICAgICAgYmxvY2soUVVFUllfQ09VTlRFUiwgIj0iLCBUSU1FUiwgIi5nZXROdW1QZW5kaW5nUXVlcmllcygpOyIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBibG9jayhUSU1FUiwgIi5iZWdpblF1ZXJ5KCIsIFNUQVRTLCAiKTsiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtaXRQcm9maWxlRW5kKGJsb2NrKSB7CiAgICAgICAgICAgIGJsb2NrKFNUQVRTLCAiLmNwdVRpbWUrPSIsIHBlcmZDb3VudGVyKCksICItIiwgQ1BVX1NUQVJULCAiOyIpOwogICAgICAgICAgICBpZiAodGltZXIpIHsKICAgICAgICAgICAgICBpZiAodXNlU2NvcGUpIHsKICAgICAgICAgICAgICAgIGJsb2NrKAogICAgICAgICAgICAgICAgICBUSU1FUiwKICAgICAgICAgICAgICAgICAgIi5wdXNoU2NvcGVTdGF0cygiLAogICAgICAgICAgICAgICAgICBRVUVSWV9DT1VOVEVSLAogICAgICAgICAgICAgICAgICAiLCIsCiAgICAgICAgICAgICAgICAgIFRJTUVSLAogICAgICAgICAgICAgICAgICAiLmdldE51bVBlbmRpbmdRdWVyaWVzKCksIiwKICAgICAgICAgICAgICAgICAgU1RBVFMsCiAgICAgICAgICAgICAgICAgICIpOyIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJsb2NrKFRJTUVSLCAiLmVuZFF1ZXJ5KCk7Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBzY29wZVByb2ZpbGUodmFsdWUpIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBzY29wZS5kZWYoQ1VSUkVOVF9TVEFURSwgIi5wcm9maWxlIik7CiAgICAgICAgICAgIHNjb3BlKENVUlJFTlRfU1RBVEUsICIucHJvZmlsZT0iLCB2YWx1ZSwgIjsiKTsKICAgICAgICAgICAgc2NvcGUuZXhpdChDVVJSRU5UX1NUQVRFLCAiLnByb2ZpbGU9IiwgcHJldiwgIjsiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBVU0VfUFJPRklMRTsKICAgICAgICAgIGlmIChwcm9maWxlQXJnKSB7CiAgICAgICAgICAgIGlmIChpc1N0YXRpYyhwcm9maWxlQXJnKSkgewogICAgICAgICAgICAgIGlmIChwcm9maWxlQXJnLmVuYWJsZSkgewogICAgICAgICAgICAgICAgZW1pdFByb2ZpbGVTdGFydChzY29wZSk7CiAgICAgICAgICAgICAgICBlbWl0UHJvZmlsZUVuZChzY29wZS5leGl0KTsKICAgICAgICAgICAgICAgIHNjb3BlUHJvZmlsZSgidHJ1ZSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY29wZVByb2ZpbGUoImZhbHNlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBVU0VfUFJPRklMRSA9IHByb2ZpbGVBcmcuYXBwZW5kKGVudiwgc2NvcGUpOwogICAgICAgICAgICBzY29wZVByb2ZpbGUoVVNFX1BST0ZJTEUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgVVNFX1BST0ZJTEUgPSBzY29wZS5kZWYoQ1VSUkVOVF9TVEFURSwgIi5wcm9maWxlIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnQgPSBlbnYuYmxvY2soKTsKICAgICAgICAgIGVtaXRQcm9maWxlU3RhcnQoc3RhcnQpOwogICAgICAgICAgc2NvcGUoImlmKCIsIFVTRV9QUk9GSUxFLCAiKXsiLCBzdGFydCwgIn0iKTsKICAgICAgICAgIHZhciBlbmQgPSBlbnYuYmxvY2soKTsKICAgICAgICAgIGVtaXRQcm9maWxlRW5kKGVuZCk7CiAgICAgICAgICBzY29wZS5leGl0KCJpZigiLCBVU0VfUFJPRklMRSwgIil7IiwgZW5kLCAifSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbWl0QXR0cmlidXRlcyhlbnYsIHNjb3BlLCBhcmdzLCBhdHRyaWJ1dGVzLCBmaWx0ZXIyKSB7CiAgICAgICAgICB2YXIgc2hhcmVkID0gZW52LnNoYXJlZDsKICAgICAgICAgIGZ1bmN0aW9uIHR5cGVMZW5ndGgoeCkgewogICAgICAgICAgICBzd2l0Y2ggKHgpIHsKICAgICAgICAgICAgICBjYXNlIEdMX0ZMT0FUX1ZFQzI6CiAgICAgICAgICAgICAgY2FzZSBHTF9JTlRfVkVDMjoKICAgICAgICAgICAgICBjYXNlIEdMX0JPT0xfVkVDMjoKICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfVkVDMzoKICAgICAgICAgICAgICBjYXNlIEdMX0lOVF9WRUMzOgogICAgICAgICAgICAgIGNhc2UgR0xfQk9PTF9WRUMzOgogICAgICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9WRUM0OgogICAgICAgICAgICAgIGNhc2UgR0xfSU5UX1ZFQzQ6CiAgICAgICAgICAgICAgY2FzZSBHTF9CT09MX1ZFQzQ6CiAgICAgICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtaXRCaW5kQXR0cmlidXRlKEFUVFJJQlVURSwgc2l6ZSwgcmVjb3JkKSB7CiAgICAgICAgICAgIHZhciBHTCA9IHNoYXJlZC5nbDsKICAgICAgICAgICAgdmFyIExPQ0FUSU9OID0gc2NvcGUuZGVmKEFUVFJJQlVURSwgIi5sb2NhdGlvbiIpOwogICAgICAgICAgICB2YXIgQklORElORyA9IHNjb3BlLmRlZihzaGFyZWQuYXR0cmlidXRlcywgIlsiLCBMT0NBVElPTiwgIl0iKTsKICAgICAgICAgICAgdmFyIFNUQVRFID0gcmVjb3JkLnN0YXRlOwogICAgICAgICAgICB2YXIgQlVGRkVSID0gcmVjb3JkLmJ1ZmZlcjsKICAgICAgICAgICAgdmFyIENPTlNUX0NPTVBPTkVOVFMgPSBbCiAgICAgICAgICAgICAgcmVjb3JkLngsCiAgICAgICAgICAgICAgcmVjb3JkLnksCiAgICAgICAgICAgICAgcmVjb3JkLnosCiAgICAgICAgICAgICAgcmVjb3JkLncKICAgICAgICAgICAgXTsKICAgICAgICAgICAgdmFyIENPTU1PTl9LRVlTID0gWwogICAgICAgICAgICAgICJidWZmZXIiLAogICAgICAgICAgICAgICJub3JtYWxpemVkIiwKICAgICAgICAgICAgICAib2Zmc2V0IiwKICAgICAgICAgICAgICAic3RyaWRlIgogICAgICAgICAgICBdOwogICAgICAgICAgICBmdW5jdGlvbiBlbWl0QnVmZmVyKCkgewogICAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgICAgImlmKCEiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIuYnVmZmVyKXsiLAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KCIsCiAgICAgICAgICAgICAgICBMT0NBVElPTiwKICAgICAgICAgICAgICAgICIpO30iCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB2YXIgVFlQRSA9IHJlY29yZC50eXBlOwogICAgICAgICAgICAgIHZhciBTSVpFOwogICAgICAgICAgICAgIGlmICghcmVjb3JkLnNpemUpIHsKICAgICAgICAgICAgICAgIFNJWkUgPSBzaXplOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTSVpFID0gc2NvcGUuZGVmKHJlY29yZC5zaXplLCAifHwiLCBzaXplKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgICAgICAiaWYoIiwKICAgICAgICAgICAgICAgIEJJTkRJTkcsCiAgICAgICAgICAgICAgICAiLnR5cGUhPT0iLAogICAgICAgICAgICAgICAgVFlQRSwKICAgICAgICAgICAgICAgICJ8fCIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi5zaXplIT09IiwKICAgICAgICAgICAgICAgIFNJWkUsCiAgICAgICAgICAgICAgICAifHwiLAogICAgICAgICAgICAgICAgQ09NTU9OX0tFWVMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gQklORElORyArICIuIiArIGtleSArICIhPT0iICsgcmVjb3JkW2tleV07CiAgICAgICAgICAgICAgICB9KS5qb2luKCJ8fCIpLAogICAgICAgICAgICAgICAgIil7IiwKICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgIi5iaW5kQnVmZmVyKCIsCiAgICAgICAgICAgICAgICBHTF9BUlJBWV9CVUZGRVIkMiwKICAgICAgICAgICAgICAgICIsIiwKICAgICAgICAgICAgICAgIEJVRkZFUiwKICAgICAgICAgICAgICAgICIuYnVmZmVyKTsiLAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLnZlcnRleEF0dHJpYlBvaW50ZXIoIiwKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgTE9DQVRJT04sCiAgICAgICAgICAgICAgICAgIFNJWkUsCiAgICAgICAgICAgICAgICAgIFRZUEUsCiAgICAgICAgICAgICAgICAgIHJlY29yZC5ub3JtYWxpemVkLAogICAgICAgICAgICAgICAgICByZWNvcmQuc3RyaWRlLAogICAgICAgICAgICAgICAgICByZWNvcmQub2Zmc2V0CiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgIik7IiwKICAgICAgICAgICAgICAgIEJJTkRJTkcsCiAgICAgICAgICAgICAgICAiLnR5cGU9IiwKICAgICAgICAgICAgICAgIFRZUEUsCiAgICAgICAgICAgICAgICAiOyIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi5zaXplPSIsCiAgICAgICAgICAgICAgICBTSVpFLAogICAgICAgICAgICAgICAgIjsiLAogICAgICAgICAgICAgICAgQ09NTU9OX0tFWVMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gQklORElORyArICIuIiArIGtleSArICI9IiArIHJlY29yZFtrZXldICsgIjsiOwogICAgICAgICAgICAgICAgfSkuam9pbigiIiksCiAgICAgICAgICAgICAgICAifSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChleHRJbnN0YW5jaW5nKSB7CiAgICAgICAgICAgICAgICB2YXIgRElWSVNPUiA9IHJlY29yZC5kaXZpc29yOwogICAgICAgICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgICAiLmRpdmlzb3IhPT0iLAogICAgICAgICAgICAgICAgICBESVZJU09SLAogICAgICAgICAgICAgICAgICAiKXsiLAogICAgICAgICAgICAgICAgICBlbnYuaW5zdGFuY2luZywKICAgICAgICAgICAgICAgICAgIi52ZXJ0ZXhBdHRyaWJEaXZpc29yQU5HTEUoIiwKICAgICAgICAgICAgICAgICAgW0xPQ0FUSU9OLCBESVZJU09SXSwKICAgICAgICAgICAgICAgICAgIik7IiwKICAgICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICAgIi5kaXZpc29yPSIsCiAgICAgICAgICAgICAgICAgIERJVklTT1IsCiAgICAgICAgICAgICAgICAgICI7fSIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGVtaXRDb25zdGFudCgpIHsKICAgICAgICAgICAgICBzY29wZSgKICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIuYnVmZmVyKXsiLAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheSgiLAogICAgICAgICAgICAgICAgTE9DQVRJT04sCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIuYnVmZmVyPW51bGw7IiwKICAgICAgICAgICAgICAgICJ9aWYoIiwKICAgICAgICAgICAgICAgIENVVEVfQ09NUE9ORU5UUy5tYXAoZnVuY3Rpb24oYywgaSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gQklORElORyArICIuIiArIGMgKyAiIT09IiArIENPTlNUX0NPTVBPTkVOVFNbaV07CiAgICAgICAgICAgICAgICB9KS5qb2luKCJ8fCIpLAogICAgICAgICAgICAgICAgIil7IiwKICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgIi52ZXJ0ZXhBdHRyaWI0ZigiLAogICAgICAgICAgICAgICAgTE9DQVRJT04sCiAgICAgICAgICAgICAgICAiLCIsCiAgICAgICAgICAgICAgICBDT05TVF9DT01QT05FTlRTLAogICAgICAgICAgICAgICAgIik7IiwKICAgICAgICAgICAgICAgIENVVEVfQ09NUE9ORU5UUy5tYXAoZnVuY3Rpb24oYywgaSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gQklORElORyArICIuIiArIGMgKyAiPSIgKyBDT05TVF9DT01QT05FTlRTW2ldICsgIjsiOwogICAgICAgICAgICAgICAgfSkuam9pbigiIiksCiAgICAgICAgICAgICAgICAifSIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChTVEFURSA9PT0gQVRUUklCX1NUQVRFX1BPSU5URVIpIHsKICAgICAgICAgICAgICBlbWl0QnVmZmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoU1RBVEUgPT09IEFUVFJJQl9TVEFURV9DT05TVEFOVCkgewogICAgICAgICAgICAgIGVtaXRDb25zdGFudCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjb3BlKCJpZigiLCBTVEFURSwgIj09PSIsIEFUVFJJQl9TVEFURV9QT0lOVEVSLCAiKXsiKTsKICAgICAgICAgICAgICBlbWl0QnVmZmVyKCk7CiAgICAgICAgICAgICAgc2NvcGUoIn1lbHNleyIpOwogICAgICAgICAgICAgIGVtaXRDb25zdGFudCgpOwogICAgICAgICAgICAgIHNjb3BlKCJ9Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGF0dHJpYnV0ZXMuZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGUpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGUubmFtZTsKICAgICAgICAgICAgdmFyIGFyZyA9IGFyZ3MuYXR0cmlidXRlc1tuYW1lXTsKICAgICAgICAgICAgdmFyIHJlY29yZDsKICAgICAgICAgICAgaWYgKGFyZykgewogICAgICAgICAgICAgIGlmICghZmlsdGVyMihhcmcpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY29yZCA9IGFyZy5hcHBlbmQoZW52LCBzY29wZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFmaWx0ZXIyKFNDT1BFX0RFQ0wpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzY29wZUF0dHJpYiA9IGVudi5zY29wZUF0dHJpYihuYW1lKTsKICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZW52LmFzc2VydCgKICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgIHNjb3BlQXR0cmliICsgIi5zdGF0ZSIsCiAgICAgICAgICAgICAgICAgICJtaXNzaW5nIGF0dHJpYnV0ZSAiICsgbmFtZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZWNvcmQgPSB7fTsKICAgICAgICAgICAgICBPYmplY3Qua2V5cyhuZXcgQXR0cmlidXRlUmVjb3JkMigpKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgcmVjb3JkW2tleV0gPSBzY29wZS5kZWYoc2NvcGVBdHRyaWIsICIuIiwga2V5KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbWl0QmluZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICBlbnYubGluayhhdHRyaWJ1dGUpLAogICAgICAgICAgICAgIHR5cGVMZW5ndGgoYXR0cmlidXRlLmluZm8udHlwZSksCiAgICAgICAgICAgICAgcmVjb3JkCiAgICAgICAgICAgICk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1pdFVuaWZvcm1zKGVudiwgc2NvcGUsIGFyZ3MsIHVuaWZvcm1zLCBmaWx0ZXIyLCBpc0JhdGNoSW5uZXJMb29wKSB7CiAgICAgICAgICB2YXIgc2hhcmVkID0gZW52LnNoYXJlZDsKICAgICAgICAgIHZhciBHTCA9IHNoYXJlZC5nbDsKICAgICAgICAgIHZhciBpbmZpeDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdW5pZm9ybXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIHVuaWZvcm0gPSB1bmlmb3Jtc1tpXTsKICAgICAgICAgICAgdmFyIG5hbWUgPSB1bmlmb3JtLm5hbWU7CiAgICAgICAgICAgIHZhciB0eXBlID0gdW5pZm9ybS5pbmZvLnR5cGU7CiAgICAgICAgICAgIHZhciBhcmcgPSBhcmdzLnVuaWZvcm1zW25hbWVdOwogICAgICAgICAgICB2YXIgVU5JRk9STSA9IGVudi5saW5rKHVuaWZvcm0pOwogICAgICAgICAgICB2YXIgTE9DQVRJT04gPSBVTklGT1JNICsgIi5sb2NhdGlvbiI7CiAgICAgICAgICAgIHZhciBWQUxVRTsKICAgICAgICAgICAgaWYgKGFyZykgewogICAgICAgICAgICAgIGlmICghZmlsdGVyMihhcmcpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzU3RhdGljKGFyZykpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFyZy52YWx1ZTsKICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9PSAidW5kZWZpbmVkIiwKICAgICAgICAgICAgICAgICAgJ21pc3NpbmcgdW5pZm9ybSAiJyArIG5hbWUgKyAnIicsCiAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IEdMX1NBTVBMRVJfMkQgfHwgdHlwZSA9PT0gR0xfU0FNUExFUl9DVUJFKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgJiYgKHR5cGUgPT09IEdMX1NBTVBMRVJfMkQgJiYgKHZhbHVlLl9yZWdsVHlwZSA9PT0gInRleHR1cmUyZCIgfHwgdmFsdWUuX3JlZ2xUeXBlID09PSAiZnJhbWVidWZmZXIiKSB8fCB0eXBlID09PSBHTF9TQU1QTEVSX0NVQkUgJiYgKHZhbHVlLl9yZWdsVHlwZSA9PT0gInRleHR1cmVDdWJlIiB8fCB2YWx1ZS5fcmVnbFR5cGUgPT09ICJmcmFtZWJ1ZmZlckN1YmUiKSksCiAgICAgICAgICAgICAgICAgICAgImludmFsaWQgdGV4dHVyZSBmb3IgdW5pZm9ybSAiICsgbmFtZSwKICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB2YXIgVEVYX1ZBTFVFID0gZW52LmxpbmsodmFsdWUuX3RleHR1cmUgfHwgdmFsdWUuY29sb3JbMF0uX3RleHR1cmUpOwogICAgICAgICAgICAgICAgICBzY29wZShHTCwgIi51bmlmb3JtMWkoIiwgTE9DQVRJT04sICIsIiwgVEVYX1ZBTFVFICsgIi5iaW5kKCkpOyIpOwogICAgICAgICAgICAgICAgICBzY29wZS5leGl0KFRFWF9WQUxVRSwgIi51bmJpbmQoKTsiKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gR0xfRkxPQVRfTUFUMiB8fCB0eXBlID09PSBHTF9GTE9BVF9NQVQzIHx8IHR5cGUgPT09IEdMX0ZMT0FUX01BVDQpIHsKICAgICAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5TGlrZSh2YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCBtYXRyaXggZm9yIHVuaWZvcm0gIiArIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgdHlwZSA9PT0gR0xfRkxPQVRfTUFUMiAmJiB2YWx1ZS5sZW5ndGggPT09IDQgfHwgdHlwZSA9PT0gR0xfRkxPQVRfTUFUMyAmJiB2YWx1ZS5sZW5ndGggPT09IDkgfHwgdHlwZSA9PT0gR0xfRkxPQVRfTUFUNCAmJiB2YWx1ZS5sZW5ndGggPT09IDE2LAogICAgICAgICAgICAgICAgICAgICAgImludmFsaWQgbGVuZ3RoIGZvciBtYXRyaXggdW5pZm9ybSAiICsgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHZhciBNQVRfVkFMVUUgPSBlbnYuZ2xvYmFsLmRlZigibmV3IEZsb2F0MzJBcnJheShbIiArIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHZhbHVlKSArICJdKSIpOwogICAgICAgICAgICAgICAgICB2YXIgZGltID0gMjsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IEdMX0ZMT0FUX01BVDMpIHsKICAgICAgICAgICAgICAgICAgICBkaW0gPSAzOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IEdMX0ZMT0FUX01BVDQpIHsKICAgICAgICAgICAgICAgICAgICBkaW0gPSA0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgICAgICIudW5pZm9ybU1hdHJpeCIsCiAgICAgICAgICAgICAgICAgICAgZGltLAogICAgICAgICAgICAgICAgICAgICJmdigiLAogICAgICAgICAgICAgICAgICAgIExPQ0FUSU9OLAogICAgICAgICAgICAgICAgICAgICIsZmFsc2UsIiwKICAgICAgICAgICAgICAgICAgICBNQVRfVkFMVUUsCiAgICAgICAgICAgICAgICAgICAgIik7IgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVCQ4OgogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kVHlwZSh2YWx1ZSwgIm51bWJlciIsICJ1bmlmb3JtICIgKyBuYW1lLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgICBpbmZpeCA9ICIxZiI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIEdMX0ZMT0FUX1ZFQzI6CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXlMaWtlKHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlmb3JtICIgKyBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIGluZml4ID0gIjJmIjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfVkVDMzoKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMywKICAgICAgICAgICAgICAgICAgICAgICAgInVuaWZvcm0gIiArIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgaW5maXggPSAiM2YiOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9WRUM0OgogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5TGlrZSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSA0LAogICAgICAgICAgICAgICAgICAgICAgICAidW5pZm9ybSAiICsgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICBpbmZpeCA9ICI0ZiI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIEdMX0JPT0w6CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmRUeXBlKHZhbHVlLCAiYm9vbGVhbiIsICJ1bmlmb3JtICIgKyBuYW1lLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgICBpbmZpeCA9ICIxaSI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIEdMX0lOVCQzOgogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kVHlwZSh2YWx1ZSwgIm51bWJlciIsICJ1bmlmb3JtICIgKyBuYW1lLCBlbnYuY29tbWFuZFN0cik7CiAgICAgICAgICAgICAgICAgICAgICBpbmZpeCA9ICIxaSI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIEdMX0JPT0xfVkVDMjoKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMiwKICAgICAgICAgICAgICAgICAgICAgICAgInVuaWZvcm0gIiArIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgaW5maXggPSAiMmkiOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBHTF9JTlRfVkVDMjoKICAgICAgICAgICAgICAgICAgICAgIGNoZWNrJDEuY29tbWFuZCgKICAgICAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMiwKICAgICAgICAgICAgICAgICAgICAgICAgInVuaWZvcm0gIiArIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgaW5maXggPSAiMmkiOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBHTF9CT09MX1ZFQzM6CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXlMaWtlKHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlmb3JtICIgKyBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIGluZml4ID0gIjNpIjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgR0xfSU5UX1ZFQzM6CiAgICAgICAgICAgICAgICAgICAgICBjaGVjayQxLmNvbW1hbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIGlzQXJyYXlMaWtlKHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT09IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlmb3JtICIgKyBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgIGluZml4ID0gIjNpIjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgR0xfQk9PTF9WRUM0OgogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5TGlrZSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSA0LAogICAgICAgICAgICAgICAgICAgICAgICAidW5pZm9ybSAiICsgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICBpbmZpeCA9ICI0aSI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIEdMX0lOVF9WRUM0OgogICAgICAgICAgICAgICAgICAgICAgY2hlY2skMS5jb21tYW5kKAogICAgICAgICAgICAgICAgICAgICAgICBpc0FycmF5TGlrZSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSA0LAogICAgICAgICAgICAgICAgICAgICAgICAidW5pZm9ybSAiICsgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgZW52LmNvbW1hbmRTdHIKICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICBpbmZpeCA9ICI0aSI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzY29wZSgKICAgICAgICAgICAgICAgICAgICBHTCwKICAgICAgICAgICAgICAgICAgICAiLnVuaWZvcm0iLAogICAgICAgICAgICAgICAgICAgIGluZml4LAogICAgICAgICAgICAgICAgICAgICIoIiwKICAgICAgICAgICAgICAgICAgICBMT0NBVElPTiwKICAgICAgICAgICAgICAgICAgICAiLCIsCiAgICAgICAgICAgICAgICAgICAgaXNBcnJheUxpa2UodmFsdWUpID8gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodmFsdWUpIDogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgIik7IgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFZBTFVFID0gYXJnLmFwcGVuZChlbnYsIHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFmaWx0ZXIyKFNDT1BFX0RFQ0wpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgVkFMVUUgPSBzY29wZS5kZWYoc2hhcmVkLnVuaWZvcm1zLCAiWyIsIHN0cmluZ1N0b3JlLmlkKG5hbWUpLCAiXSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlID09PSBHTF9TQU1QTEVSXzJEKSB7CiAgICAgICAgICAgICAgY2hlY2skMSghQXJyYXkuaXNBcnJheShWQUxVRSksICJtdXN0IHNwZWNpZnkgYSBzY2FsYXIgcHJvcCBmb3IgdGV4dHVyZXMiKTsKICAgICAgICAgICAgICBzY29wZSgKICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiJiYiLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAnLl9yZWdsVHlwZT09PSJmcmFtZWJ1ZmZlciIpeycsCiAgICAgICAgICAgICAgICBWQUxVRSwKICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgIFZBTFVFLAogICAgICAgICAgICAgICAgIi5jb2xvclswXTsiLAogICAgICAgICAgICAgICAgIn0iCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBHTF9TQU1QTEVSX0NVQkUpIHsKICAgICAgICAgICAgICBjaGVjayQxKCFBcnJheS5pc0FycmF5KFZBTFVFKSwgIm11c3Qgc3BlY2lmeSBhIHNjYWxhciBwcm9wIGZvciBjdWJlIG1hcHMiKTsKICAgICAgICAgICAgICBzY29wZSgKICAgICAgICAgICAgICAgICJpZigiLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiJiYiLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAnLl9yZWdsVHlwZT09PSJmcmFtZWJ1ZmZlckN1YmUiKXsnLAogICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICBWQUxVRSwKICAgICAgICAgICAgICAgICIuY29sb3JbMF07IiwKICAgICAgICAgICAgICAgICJ9IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBmdW5jdGlvbiBlbWl0Q2hlY2socHJlZCwgbWVzc2FnZSkgewogICAgICAgICAgICAgICAgZW52LmFzc2VydCgKICAgICAgICAgICAgICAgICAgc2NvcGUsCiAgICAgICAgICAgICAgICAgIHByZWQsCiAgICAgICAgICAgICAgICAgICdiYWQgZGF0YSBvciBtaXNzaW5nIGZvciB1bmlmb3JtICInICsgbmFtZSArICciLiAgJyArIG1lc3NhZ2UKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrVHlwZSh0eXBlMikgewogICAgICAgICAgICAgICAgY2hlY2skMSghQXJyYXkuaXNBcnJheShWQUxVRSksICJtdXN0IG5vdCBzcGVjaWZ5IGFuIGFycmF5IHR5cGUgZm9yIHVuaWZvcm0iKTsKICAgICAgICAgICAgICAgIGVtaXRDaGVjaygKICAgICAgICAgICAgICAgICAgInR5cGVvZiAiICsgVkFMVUUgKyAnPT09IicgKyB0eXBlMiArICciJywKICAgICAgICAgICAgICAgICAgImludmFsaWQgdHlwZSwgZXhwZWN0ZWQgIiArIHR5cGUyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmdW5jdGlvbiBjaGVja1ZlY3RvcihuLCB0eXBlMikgewogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoVkFMVUUpKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrJDEoVkFMVUUubGVuZ3RoID09PSBuLCAibXVzdCBoYXZlIGxlbmd0aCAiICsgbik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBlbWl0Q2hlY2soCiAgICAgICAgICAgICAgICAgICAgc2hhcmVkLmlzQXJyYXlMaWtlICsgIigiICsgVkFMVUUgKyAiKSYmIiArIFZBTFVFICsgIi5sZW5ndGg9PT0iICsgbiwKICAgICAgICAgICAgICAgICAgICAiaW52YWxpZCB2ZWN0b3IsIHNob3VsZCBoYXZlIGxlbmd0aCAiICsgbiwKICAgICAgICAgICAgICAgICAgICBlbnYuY29tbWFuZFN0cgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmdW5jdGlvbiBjaGVja1RleHR1cmUodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICBjaGVjayQxKCFBcnJheS5pc0FycmF5KFZBTFVFKSwgIm11c3Qgbm90IHNwZWNpZnkgYSB2YWx1ZSB0eXBlIik7CiAgICAgICAgICAgICAgICBlbWl0Q2hlY2soCiAgICAgICAgICAgICAgICAgICJ0eXBlb2YgIiArIFZBTFVFICsgJz09PSJmdW5jdGlvbiImJicgKyBWQUxVRSArICcuX3JlZ2xUeXBlPT09InRleHR1cmUnICsgKHRhcmdldCA9PT0gR0xfVEVYVFVSRV8yRCQzID8gIjJkIiA6ICJDdWJlIikgKyAnIicsCiAgICAgICAgICAgICAgICAgICJpbnZhbGlkIHRleHR1cmUgdHlwZSIsCiAgICAgICAgICAgICAgICAgIGVudi5jb21tYW5kU3RyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgR0xfSU5UJDM6CiAgICAgICAgICAgICAgICAgIGNoZWNrVHlwZSgibnVtYmVyIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9JTlRfVkVDMjoKICAgICAgICAgICAgICAgICAgY2hlY2tWZWN0b3IoMiwgIm51bWJlciIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgR0xfSU5UX1ZFQzM6CiAgICAgICAgICAgICAgICAgIGNoZWNrVmVjdG9yKDMsICJudW1iZXIiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIEdMX0lOVF9WRUM0OgogICAgICAgICAgICAgICAgICBjaGVja1ZlY3Rvcig0LCAibnVtYmVyIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVCQ4OgogICAgICAgICAgICAgICAgICBjaGVja1R5cGUoIm51bWJlciIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfVkVDMjoKICAgICAgICAgICAgICAgICAgY2hlY2tWZWN0b3IoMiwgIm51bWJlciIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfVkVDMzoKICAgICAgICAgICAgICAgICAgY2hlY2tWZWN0b3IoMywgIm51bWJlciIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfVkVDNDoKICAgICAgICAgICAgICAgICAgY2hlY2tWZWN0b3IoNCwgIm51bWJlciIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgR0xfQk9PTDoKICAgICAgICAgICAgICAgICAgY2hlY2tUeXBlKCJib29sZWFuIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9CT09MX1ZFQzI6CiAgICAgICAgICAgICAgICAgIGNoZWNrVmVjdG9yKDIsICJib29sZWFuIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9CT09MX1ZFQzM6CiAgICAgICAgICAgICAgICAgIGNoZWNrVmVjdG9yKDMsICJib29sZWFuIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9CT09MX1ZFQzQ6CiAgICAgICAgICAgICAgICAgIGNoZWNrVmVjdG9yKDQsICJib29sZWFuIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9NQVQyOgogICAgICAgICAgICAgICAgICBjaGVja1ZlY3Rvcig0LCAibnVtYmVyIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9NQVQzOgogICAgICAgICAgICAgICAgICBjaGVja1ZlY3Rvcig5LCAibnVtYmVyIik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9NQVQ0OgogICAgICAgICAgICAgICAgICBjaGVja1ZlY3RvcigxNiwgIm51bWJlciIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgR0xfU0FNUExFUl8yRDoKICAgICAgICAgICAgICAgICAgY2hlY2tUZXh0dXJlKEdMX1RFWFRVUkVfMkQkMyk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBHTF9TQU1QTEVSX0NVQkU6CiAgICAgICAgICAgICAgICAgIGNoZWNrVGV4dHVyZShHTF9URVhUVVJFX0NVQkVfTUFQJDIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgdW5yb2xsID0gMTsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSBHTF9TQU1QTEVSXzJEOgogICAgICAgICAgICAgIGNhc2UgR0xfU0FNUExFUl9DVUJFOgogICAgICAgICAgICAgICAgdmFyIFRFWCA9IHNjb3BlLmRlZihWQUxVRSwgIi5fdGV4dHVyZSIpOwogICAgICAgICAgICAgICAgc2NvcGUoR0wsICIudW5pZm9ybTFpKCIsIExPQ0FUSU9OLCAiLCIsIFRFWCwgIi5iaW5kKCkpOyIpOwogICAgICAgICAgICAgICAgc2NvcGUuZXhpdChURVgsICIudW5iaW5kKCk7Iik7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICBjYXNlIEdMX0lOVCQzOgogICAgICAgICAgICAgIGNhc2UgR0xfQk9PTDoKICAgICAgICAgICAgICAgIGluZml4ID0gIjFpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgR0xfSU5UX1ZFQzI6CiAgICAgICAgICAgICAgY2FzZSBHTF9CT09MX1ZFQzI6CiAgICAgICAgICAgICAgICBpbmZpeCA9ICIyaSI7CiAgICAgICAgICAgICAgICB1bnJvbGwgPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBHTF9JTlRfVkVDMzoKICAgICAgICAgICAgICBjYXNlIEdMX0JPT0xfVkVDMzoKICAgICAgICAgICAgICAgIGluZml4ID0gIjNpIjsKICAgICAgICAgICAgICAgIHVucm9sbCA9IDM7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEdMX0lOVF9WRUM0OgogICAgICAgICAgICAgIGNhc2UgR0xfQk9PTF9WRUM0OgogICAgICAgICAgICAgICAgaW5maXggPSAiNGkiOwogICAgICAgICAgICAgICAgdW5yb2xsID0gNDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVQkODoKICAgICAgICAgICAgICAgIGluZml4ID0gIjFmIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfVkVDMjoKICAgICAgICAgICAgICAgIGluZml4ID0gIjJmIjsKICAgICAgICAgICAgICAgIHVucm9sbCA9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEdMX0ZMT0FUX1ZFQzM6CiAgICAgICAgICAgICAgICBpbmZpeCA9ICIzZiI7CiAgICAgICAgICAgICAgICB1bnJvbGwgPSAzOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9WRUM0OgogICAgICAgICAgICAgICAgaW5maXggPSAiNGYiOwogICAgICAgICAgICAgICAgdW5yb2xsID0gNDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgR0xfRkxPQVRfTUFUMjoKICAgICAgICAgICAgICAgIGluZml4ID0gIk1hdHJpeDJmdiI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEdMX0ZMT0FUX01BVDM6CiAgICAgICAgICAgICAgICBpbmZpeCA9ICJNYXRyaXgzZnYiOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBHTF9GTE9BVF9NQVQ0OgogICAgICAgICAgICAgICAgaW5maXggPSAiTWF0cml4NGZ2IjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmZpeC5jaGFyQXQoMCkgPT09ICJNIikgewogICAgICAgICAgICAgIHNjb3BlKEdMLCAiLnVuaWZvcm0iLCBpbmZpeCwgIigiLCBMT0NBVElPTiwgIiwiKTsKICAgICAgICAgICAgICB2YXIgbWF0U2l6ZSA9IE1hdGgucG93KHR5cGUgLSBHTF9GTE9BVF9NQVQyICsgMiwgMik7CiAgICAgICAgICAgICAgdmFyIFNUT1JBR0UgPSBlbnYuZ2xvYmFsLmRlZigibmV3IEZsb2F0MzJBcnJheSgiLCBtYXRTaXplLCAiKSIpOwogICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KFZBTFVFKSkgewogICAgICAgICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgICAgICAgICJmYWxzZSwoIiwKICAgICAgICAgICAgICAgICAgbG9vcChtYXRTaXplLCBmdW5jdGlvbihpMikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBTVE9SQUdFICsgIlsiICsgaTIgKyAiXT0iICsgVkFMVUVbaTJdOwogICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgIiwiLAogICAgICAgICAgICAgICAgICBTVE9SQUdFLAogICAgICAgICAgICAgICAgICAiKSIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgICAgICAiZmFsc2UsKEFycmF5LmlzQXJyYXkoIiwKICAgICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAgICIpfHwiLAogICAgICAgICAgICAgICAgICBWQUxVRSwKICAgICAgICAgICAgICAgICAgIiBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSk/IiwKICAgICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAgICI6KCIsCiAgICAgICAgICAgICAgICAgIGxvb3AobWF0U2l6ZSwgZnVuY3Rpb24oaTIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gU1RPUkFHRSArICJbIiArIGkyICsgIl09IiArIFZBTFVFICsgIlsiICsgaTIgKyAiXSI7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAiLCIsCiAgICAgICAgICAgICAgICAgIFNUT1JBR0UsCiAgICAgICAgICAgICAgICAgICIpIgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NvcGUoIik7Iik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodW5yb2xsID4gMSkgewogICAgICAgICAgICAgIHZhciBwcmV2ID0gW107CiAgICAgICAgICAgICAgdmFyIGN1ciA9IFtdOwogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdW5yb2xsOyArK2opIHsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KFZBTFVFKSkgewogICAgICAgICAgICAgICAgICBjdXIucHVzaChWQUxVRVtqXSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXIucHVzaChzY29wZS5kZWYoVkFMVUUgKyAiWyIgKyBqICsgIl0iKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNCYXRjaElubmVyTG9vcCkgewogICAgICAgICAgICAgICAgICBwcmV2LnB1c2goc2NvcGUuZGVmKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNCYXRjaElubmVyTG9vcCkgewogICAgICAgICAgICAgICAgc2NvcGUoImlmKCEiLCBlbnYuYmF0Y2hJZCwgInx8IiwgcHJldi5tYXAoZnVuY3Rpb24ocCwgaTIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHAgKyAiIT09IiArIGN1cltpMl07CiAgICAgICAgICAgICAgICB9KS5qb2luKCJ8fCIpLCAiKXsiLCBwcmV2Lm1hcChmdW5jdGlvbihwLCBpMikgewogICAgICAgICAgICAgICAgICByZXR1cm4gcCArICI9IiArIGN1cltpMl0gKyAiOyI7CiAgICAgICAgICAgICAgICB9KS5qb2luKCIiKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjb3BlKEdMLCAiLnVuaWZvcm0iLCBpbmZpeCwgIigiLCBMT0NBVElPTiwgIiwiLCBjdXIuam9pbigiLCIpLCAiKTsiKTsKICAgICAgICAgICAgICBpZiAoaXNCYXRjaElubmVyTG9vcCkgewogICAgICAgICAgICAgICAgc2NvcGUoIn0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2hlY2skMSghQXJyYXkuaXNBcnJheShWQUxVRSksICJ1bmlmb3JtIHZhbHVlIG11c3Qgbm90IGJlIGFuIGFycmF5Iik7CiAgICAgICAgICAgICAgaWYgKGlzQmF0Y2hJbm5lckxvb3ApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2UyA9IHNjb3BlLmRlZigpOwogICAgICAgICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgICAgICAgICJpZighIiwKICAgICAgICAgICAgICAgICAgZW52LmJhdGNoSWQsCiAgICAgICAgICAgICAgICAgICJ8fCIsCiAgICAgICAgICAgICAgICAgIHByZXZTLAogICAgICAgICAgICAgICAgICAiIT09IiwKICAgICAgICAgICAgICAgICAgVkFMVUUsCiAgICAgICAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgICAgICAgIHByZXZTLAogICAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICAgIFZBTFVFLAogICAgICAgICAgICAgICAgICAiOyIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjb3BlKEdMLCAiLnVuaWZvcm0iLCBpbmZpeCwgIigiLCBMT0NBVElPTiwgIiwiLCBWQUxVRSwgIik7Iik7CiAgICAgICAgICAgICAgaWYgKGlzQmF0Y2hJbm5lckxvb3ApIHsKICAgICAgICAgICAgICAgIHNjb3BlKCJ9Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtaXREcmF3KGVudiwgb3V0ZXIsIGlubmVyLCBhcmdzKSB7CiAgICAgICAgICB2YXIgc2hhcmVkID0gZW52LnNoYXJlZDsKICAgICAgICAgIHZhciBHTCA9IHNoYXJlZC5nbDsKICAgICAgICAgIHZhciBEUkFXX1NUQVRFID0gc2hhcmVkLmRyYXc7CiAgICAgICAgICB2YXIgZHJhd09wdGlvbnMgPSBhcmdzLmRyYXc7CiAgICAgICAgICBmdW5jdGlvbiBlbWl0RWxlbWVudHMoKSB7CiAgICAgICAgICAgIHZhciBkZWZuID0gZHJhd09wdGlvbnMuZWxlbWVudHM7CiAgICAgICAgICAgIHZhciBFTEVNRU5UUzI7CiAgICAgICAgICAgIHZhciBzY29wZSA9IG91dGVyOwogICAgICAgICAgICBpZiAoZGVmbikgewogICAgICAgICAgICAgIGlmIChkZWZuLmNvbnRleHREZXAgJiYgYXJncy5jb250ZXh0RHluYW1pYyB8fCBkZWZuLnByb3BEZXApIHsKICAgICAgICAgICAgICAgIHNjb3BlID0gaW5uZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIEVMRU1FTlRTMiA9IGRlZm4uYXBwZW5kKGVudiwgc2NvcGUpOwogICAgICAgICAgICAgIGlmIChkcmF3T3B0aW9ucy5lbGVtZW50c0FjdGl2ZSkgewogICAgICAgICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgICAgICAgICJpZigiICsgRUxFTUVOVFMyICsgIikiICsgR0wgKyAiLmJpbmRCdWZmZXIoIiArIEdMX0VMRU1FTlRfQVJSQVlfQlVGRkVSJDIgKyAiLCIgKyBFTEVNRU5UUzIgKyAiLmJ1ZmZlci5idWZmZXIpOyIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIEVMRU1FTlRTMiA9IHNjb3BlLmRlZigpOwogICAgICAgICAgICAgIHNjb3BlKAogICAgICAgICAgICAgICAgRUxFTUVOVFMyLAogICAgICAgICAgICAgICAgIj0iLAogICAgICAgICAgICAgICAgRFJBV19TVEFURSwKICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgIFNfRUxFTUVOVFMsCiAgICAgICAgICAgICAgICAiOyIsCiAgICAgICAgICAgICAgICAiaWYoIiwKICAgICAgICAgICAgICAgIEVMRU1FTlRTMiwKICAgICAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgICAgICBHTCwKICAgICAgICAgICAgICAgICIuYmluZEJ1ZmZlcigiLAogICAgICAgICAgICAgICAgR0xfRUxFTUVOVF9BUlJBWV9CVUZGRVIkMiwKICAgICAgICAgICAgICAgICIsIiwKICAgICAgICAgICAgICAgIEVMRU1FTlRTMiwKICAgICAgICAgICAgICAgICIuYnVmZmVyLmJ1ZmZlcik7fSIsCiAgICAgICAgICAgICAgICAiZWxzZSBpZigiLAogICAgICAgICAgICAgICAgc2hhcmVkLnZhbywKICAgICAgICAgICAgICAgICIuY3VycmVudFZBTyl7IiwKICAgICAgICAgICAgICAgIEVMRU1FTlRTMiwKICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgIGVudi5zaGFyZWQuZWxlbWVudHMgKyAiLmdldEVsZW1lbnRzKCIgKyBzaGFyZWQudmFvLAogICAgICAgICAgICAgICAgIi5jdXJyZW50VkFPLmVsZW1lbnRzKTsiLAogICAgICAgICAgICAgICAgIWV4dFZlcnRleEFycmF5cyA/ICJpZigiICsgRUxFTUVOVFMyICsgIikiICsgR0wgKyAiLmJpbmRCdWZmZXIoIiArIEdMX0VMRU1FTlRfQVJSQVlfQlVGRkVSJDIgKyAiLCIgKyBFTEVNRU5UUzIgKyAiLmJ1ZmZlci5idWZmZXIpOyIgOiAiIiwKICAgICAgICAgICAgICAgICJ9IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEVMRU1FTlRTMjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVtaXRDb3VudCgpIHsKICAgICAgICAgICAgdmFyIGRlZm4gPSBkcmF3T3B0aW9ucy5jb3VudDsKICAgICAgICAgICAgdmFyIENPVU5UMjsKICAgICAgICAgICAgdmFyIHNjb3BlID0gb3V0ZXI7CiAgICAgICAgICAgIGlmIChkZWZuKSB7CiAgICAgICAgICAgICAgaWYgKGRlZm4uY29udGV4dERlcCAmJiBhcmdzLmNvbnRleHREeW5hbWljIHx8IGRlZm4ucHJvcERlcCkgewogICAgICAgICAgICAgICAgc2NvcGUgPSBpbm5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgQ09VTlQyID0gZGVmbi5hcHBlbmQoZW52LCBzY29wZSk7CiAgICAgICAgICAgICAgY2hlY2skMS5vcHRpb25hbChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChkZWZuLk1JU1NJTkcpIHsKICAgICAgICAgICAgICAgICAgZW52LmFzc2VydChvdXRlciwgImZhbHNlIiwgIm1pc3NpbmcgdmVydGV4IGNvdW50Iik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGVmbi5EWU5BTUlDKSB7CiAgICAgICAgICAgICAgICAgIGVudi5hc3NlcnQoc2NvcGUsIENPVU5UMiArICI+PTAiLCAibWlzc2luZyB2ZXJ0ZXggY291bnQiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBDT1VOVDIgPSBzY29wZS5kZWYoRFJBV19TVEFURSwgIi4iLCBTX0NPVU5UKTsKICAgICAgICAgICAgICBjaGVjayQxLm9wdGlvbmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZW52LmFzc2VydChzY29wZSwgQ09VTlQyICsgIj49MCIsICJtaXNzaW5nIHZlcnRleCBjb3VudCIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBDT1VOVDI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgRUxFTUVOVFMgPSBlbWl0RWxlbWVudHMoKTsKICAgICAgICAgIGZ1bmN0aW9uIGVtaXRWYWx1ZShuYW1lKSB7CiAgICAgICAgICAgIHZhciBkZWZuID0gZHJhd09wdGlvbnNbbmFtZV07CiAgICAgICAgICAgIGlmIChkZWZuKSB7CiAgICAgICAgICAgICAgaWYgKGRlZm4uY29udGV4dERlcCAmJiBhcmdzLmNvbnRleHREeW5hbWljIHx8IGRlZm4ucHJvcERlcCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlZm4uYXBwZW5kKGVudiwgaW5uZXIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVmbi5hcHBlbmQoZW52LCBvdXRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBvdXRlci5kZWYoRFJBV19TVEFURSwgIi4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIFBSSU1JVElWRSA9IGVtaXRWYWx1ZShTX1BSSU1JVElWRSk7CiAgICAgICAgICB2YXIgT0ZGU0VUID0gZW1pdFZhbHVlKFNfT0ZGU0VUKTsKICAgICAgICAgIHZhciBDT1VOVCA9IGVtaXRDb3VudCgpOwogICAgICAgICAgaWYgKHR5cGVvZiBDT1VOVCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgaWYgKENPVU5UID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbm5lcigiaWYoIiwgQ09VTlQsICIpeyIpOwogICAgICAgICAgICBpbm5lci5leGl0KCJ9Iik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgSU5TVEFOQ0VTLCBFWFRfSU5TVEFOQ0lORzsKICAgICAgICAgIGlmIChleHRJbnN0YW5jaW5nKSB7CiAgICAgICAgICAgIElOU1RBTkNFUyA9IGVtaXRWYWx1ZShTX0lOU1RBTkNFUyk7CiAgICAgICAgICAgIEVYVF9JTlNUQU5DSU5HID0gZW52Lmluc3RhbmNpbmc7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgRUxFTUVOVF9UWVBFID0gRUxFTUVOVFMgKyAiLnR5cGUiOwogICAgICAgICAgdmFyIGVsZW1lbnRzU3RhdGljID0gZHJhd09wdGlvbnMuZWxlbWVudHMgJiYgaXNTdGF0aWMoZHJhd09wdGlvbnMuZWxlbWVudHMpICYmICFkcmF3T3B0aW9ucy52YW9BY3RpdmU7CiAgICAgICAgICBmdW5jdGlvbiBlbWl0SW5zdGFuY2luZygpIHsKICAgICAgICAgICAgZnVuY3Rpb24gZHJhd0VsZW1lbnRzKCkgewogICAgICAgICAgICAgIGlubmVyKEVYVF9JTlNUQU5DSU5HLCAiLmRyYXdFbGVtZW50c0luc3RhbmNlZEFOR0xFKCIsIFsKICAgICAgICAgICAgICAgIFBSSU1JVElWRSwKICAgICAgICAgICAgICAgIENPVU5ULAogICAgICAgICAgICAgICAgRUxFTUVOVF9UWVBFLAogICAgICAgICAgICAgICAgT0ZGU0VUICsgIjw8KCgiICsgRUxFTUVOVF9UWVBFICsgIi0iICsgR0xfVU5TSUdORURfQllURSQ4ICsgIik+PjEpIiwKICAgICAgICAgICAgICAgIElOU1RBTkNFUwogICAgICAgICAgICAgIF0sICIpOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRyYXdBcnJheXMoKSB7CiAgICAgICAgICAgICAgaW5uZXIoCiAgICAgICAgICAgICAgICBFWFRfSU5TVEFOQ0lORywKICAgICAgICAgICAgICAgICIuZHJhd0FycmF5c0luc3RhbmNlZEFOR0xFKCIsCiAgICAgICAgICAgICAgICBbUFJJTUlUSVZFLCBPRkZTRVQsIENPVU5ULCBJTlNUQU5DRVNdLAogICAgICAgICAgICAgICAgIik7IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEVMRU1FTlRTICYmIEVMRU1FTlRTICE9PSAibnVsbCIpIHsKICAgICAgICAgICAgICBpZiAoIWVsZW1lbnRzU3RhdGljKSB7CiAgICAgICAgICAgICAgICBpbm5lcigiaWYoIiwgRUxFTUVOVFMsICIpeyIpOwogICAgICAgICAgICAgICAgZHJhd0VsZW1lbnRzKCk7CiAgICAgICAgICAgICAgICBpbm5lcigifWVsc2V7Iik7CiAgICAgICAgICAgICAgICBkcmF3QXJyYXlzKCk7CiAgICAgICAgICAgICAgICBpbm5lcigifSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkcmF3RWxlbWVudHMoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZHJhd0FycmF5cygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbWl0UmVndWxhcigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gZHJhd0VsZW1lbnRzKCkgewogICAgICAgICAgICAgIGlubmVyKEdMICsgIi5kcmF3RWxlbWVudHMoIiArIFsKICAgICAgICAgICAgICAgIFBSSU1JVElWRSwKICAgICAgICAgICAgICAgIENPVU5ULAogICAgICAgICAgICAgICAgRUxFTUVOVF9UWVBFLAogICAgICAgICAgICAgICAgT0ZGU0VUICsgIjw8KCgiICsgRUxFTUVOVF9UWVBFICsgIi0iICsgR0xfVU5TSUdORURfQllURSQ4ICsgIik+PjEpIgogICAgICAgICAgICAgIF0gKyAiKTsiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBkcmF3QXJyYXlzKCkgewogICAgICAgICAgICAgIGlubmVyKEdMICsgIi5kcmF3QXJyYXlzKCIgKyBbUFJJTUlUSVZFLCBPRkZTRVQsIENPVU5UXSArICIpOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChFTEVNRU5UUyAmJiBFTEVNRU5UUyAhPT0gIm51bGwiKSB7CiAgICAgICAgICAgICAgaWYgKCFlbGVtZW50c1N0YXRpYykgewogICAgICAgICAgICAgICAgaW5uZXIoImlmKCIsIEVMRU1FTlRTLCAiKXsiKTsKICAgICAgICAgICAgICAgIGRyYXdFbGVtZW50cygpOwogICAgICAgICAgICAgICAgaW5uZXIoIn1lbHNleyIpOwogICAgICAgICAgICAgICAgZHJhd0FycmF5cygpOwogICAgICAgICAgICAgICAgaW5uZXIoIn0iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZHJhd0VsZW1lbnRzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRyYXdBcnJheXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4dEluc3RhbmNpbmcgJiYgKHR5cGVvZiBJTlNUQU5DRVMgIT09ICJudW1iZXIiIHx8IElOU1RBTkNFUyA+PSAwKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIElOU1RBTkNFUyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBpbm5lcigiaWYoIiwgSU5TVEFOQ0VTLCAiPjApeyIpOwogICAgICAgICAgICAgIGVtaXRJbnN0YW5jaW5nKCk7CiAgICAgICAgICAgICAgaW5uZXIoIn1lbHNlIGlmKCIsIElOU1RBTkNFUywgIjwwKXsiKTsKICAgICAgICAgICAgICBlbWl0UmVndWxhcigpOwogICAgICAgICAgICAgIGlubmVyKCJ9Iik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZW1pdEluc3RhbmNpbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZW1pdFJlZ3VsYXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQm9keShlbWl0Qm9keSwgcGFyZW50RW52LCBhcmdzLCBwcm9ncmFtLCBjb3VudDIpIHsKICAgICAgICAgIHZhciBlbnYgPSBjcmVhdGVSRUdMRW52aXJvbm1lbnQoKTsKICAgICAgICAgIHZhciBzY29wZSA9IGVudi5wcm9jKCJib2R5IiwgY291bnQyKTsKICAgICAgICAgIGNoZWNrJDEub3B0aW9uYWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVudi5jb21tYW5kU3RyID0gcGFyZW50RW52LmNvbW1hbmRTdHI7CiAgICAgICAgICAgIGVudi5jb21tYW5kID0gZW52LmxpbmsocGFyZW50RW52LmNvbW1hbmRTdHIpOwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoZXh0SW5zdGFuY2luZykgewogICAgICAgICAgICBlbnYuaW5zdGFuY2luZyA9IHNjb3BlLmRlZigKICAgICAgICAgICAgICBlbnYuc2hhcmVkLmV4dGVuc2lvbnMsCiAgICAgICAgICAgICAgIi5hbmdsZV9pbnN0YW5jZWRfYXJyYXlzIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgZW1pdEJvZHkoZW52LCBzY29wZSwgYXJncywgcHJvZ3JhbSk7CiAgICAgICAgICByZXR1cm4gZW52LmNvbXBpbGUoKS5ib2R5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbWl0RHJhd0JvZHkoZW52LCBkcmF3LCBhcmdzLCBwcm9ncmFtKSB7CiAgICAgICAgICBpbmplY3RFeHRlbnNpb25zKGVudiwgZHJhdyk7CiAgICAgICAgICBpZiAoYXJncy51c2VWQU8pIHsKICAgICAgICAgICAgaWYgKGFyZ3MuZHJhd1ZBTykgewogICAgICAgICAgICAgIGRyYXcoZW52LnNoYXJlZC52YW8sICIuc2V0VkFPKCIsIGFyZ3MuZHJhd1ZBTy5hcHBlbmQoZW52LCBkcmF3KSwgIik7Iik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZHJhdyhlbnYuc2hhcmVkLnZhbywgIi5zZXRWQU8oIiwgZW52LnNoYXJlZC52YW8sICIudGFyZ2V0VkFPKTsiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZHJhdyhlbnYuc2hhcmVkLnZhbywgIi5zZXRWQU8obnVsbCk7Iik7CiAgICAgICAgICAgIGVtaXRBdHRyaWJ1dGVzKGVudiwgZHJhdywgYXJncywgcHJvZ3JhbS5hdHRyaWJ1dGVzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbWl0VW5pZm9ybXMoZW52LCBkcmF3LCBhcmdzLCBwcm9ncmFtLnVuaWZvcm1zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICBlbWl0RHJhdyhlbnYsIGRyYXcsIGRyYXcsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbWl0RHJhd1Byb2MoZW52LCBhcmdzKSB7CiAgICAgICAgICB2YXIgZHJhdyA9IGVudi5wcm9jKCJkcmF3IiwgMSk7CiAgICAgICAgICBpbmplY3RFeHRlbnNpb25zKGVudiwgZHJhdyk7CiAgICAgICAgICBlbWl0Q29udGV4dChlbnYsIGRyYXcsIGFyZ3MuY29udGV4dCk7CiAgICAgICAgICBlbWl0UG9sbEZyYW1lYnVmZmVyKGVudiwgZHJhdywgYXJncy5mcmFtZWJ1ZmZlcik7CiAgICAgICAgICBlbWl0UG9sbFN0YXRlKGVudiwgZHJhdywgYXJncyk7CiAgICAgICAgICBlbWl0U2V0T3B0aW9ucyhlbnYsIGRyYXcsIGFyZ3Muc3RhdGUpOwogICAgICAgICAgZW1pdFByb2ZpbGUoZW52LCBkcmF3LCBhcmdzLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICB2YXIgcHJvZ3JhbSA9IGFyZ3Muc2hhZGVyLnByb2dWYXIuYXBwZW5kKGVudiwgZHJhdyk7CiAgICAgICAgICBkcmF3KGVudi5zaGFyZWQuZ2wsICIudXNlUHJvZ3JhbSgiLCBwcm9ncmFtLCAiLnByb2dyYW0pOyIpOwogICAgICAgICAgaWYgKGFyZ3Muc2hhZGVyLnByb2dyYW0pIHsKICAgICAgICAgICAgZW1pdERyYXdCb2R5KGVudiwgZHJhdywgYXJncywgYXJncy5zaGFkZXIucHJvZ3JhbSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkcmF3KGVudi5zaGFyZWQudmFvLCAiLnNldFZBTyhudWxsKTsiKTsKICAgICAgICAgICAgdmFyIGRyYXdDYWNoZSA9IGVudi5nbG9iYWwuZGVmKCJ7fSIpOwogICAgICAgICAgICB2YXIgUFJPR19JRCA9IGRyYXcuZGVmKHByb2dyYW0sICIuaWQiKTsKICAgICAgICAgICAgdmFyIENBQ0hFRF9QUk9DID0gZHJhdy5kZWYoZHJhd0NhY2hlLCAiWyIsIFBST0dfSUQsICJdIik7CiAgICAgICAgICAgIGRyYXcoCiAgICAgICAgICAgICAgZW52LmNvbmQoQ0FDSEVEX1BST0MpLnRoZW4oQ0FDSEVEX1BST0MsICIuY2FsbCh0aGlzLGEwKTsiKS5lbHNlKAogICAgICAgICAgICAgICAgQ0FDSEVEX1BST0MsCiAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICBkcmF3Q2FjaGUsCiAgICAgICAgICAgICAgICAiWyIsCiAgICAgICAgICAgICAgICBQUk9HX0lELAogICAgICAgICAgICAgICAgIl09IiwKICAgICAgICAgICAgICAgIGVudi5saW5rKGZ1bmN0aW9uKHByb2dyYW0yKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVCb2R5KGVtaXREcmF3Qm9keSwgZW52LCBhcmdzLCBwcm9ncmFtMiwgMSk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICIoIiwKICAgICAgICAgICAgICAgIHByb2dyYW0sCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgQ0FDSEVEX1BST0MsCiAgICAgICAgICAgICAgICAiLmNhbGwodGhpcyxhMCk7IgogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhhcmdzLnN0YXRlKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGRyYXcoZW52LnNoYXJlZC5jdXJyZW50LCAiLmRpcnR5PXRydWU7Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZW52LnNoYXJlZC52YW8pIHsKICAgICAgICAgICAgZHJhdyhlbnYuc2hhcmVkLnZhbywgIi5zZXRWQU8obnVsbCk7Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtaXRCYXRjaER5bmFtaWNTaGFkZXJCb2R5KGVudiwgc2NvcGUsIGFyZ3MsIHByb2dyYW0pIHsKICAgICAgICAgIGVudi5iYXRjaElkID0gImExIjsKICAgICAgICAgIGluamVjdEV4dGVuc2lvbnMoZW52LCBzY29wZSk7CiAgICAgICAgICBmdW5jdGlvbiBhbGwoKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZW1pdEF0dHJpYnV0ZXMoZW52LCBzY29wZSwgYXJncywgcHJvZ3JhbS5hdHRyaWJ1dGVzLCBhbGwpOwogICAgICAgICAgZW1pdFVuaWZvcm1zKGVudiwgc2NvcGUsIGFyZ3MsIHByb2dyYW0udW5pZm9ybXMsIGFsbCwgZmFsc2UpOwogICAgICAgICAgZW1pdERyYXcoZW52LCBzY29wZSwgc2NvcGUsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbWl0QmF0Y2hCb2R5KGVudiwgc2NvcGUsIGFyZ3MsIHByb2dyYW0pIHsKICAgICAgICAgIGluamVjdEV4dGVuc2lvbnMoZW52LCBzY29wZSk7CiAgICAgICAgICB2YXIgY29udGV4dER5bmFtaWMgPSBhcmdzLmNvbnRleHREZXA7CiAgICAgICAgICB2YXIgQkFUQ0hfSUQgPSBzY29wZS5kZWYoKTsKICAgICAgICAgIHZhciBQUk9QX0xJU1QgPSAiYTAiOwogICAgICAgICAgdmFyIE5VTV9QUk9QUyA9ICJhMSI7CiAgICAgICAgICB2YXIgUFJPUFMgPSBzY29wZS5kZWYoKTsKICAgICAgICAgIGVudi5zaGFyZWQucHJvcHMgPSBQUk9QUzsKICAgICAgICAgIGVudi5iYXRjaElkID0gQkFUQ0hfSUQ7CiAgICAgICAgICB2YXIgb3V0ZXIgPSBlbnYuc2NvcGUoKTsKICAgICAgICAgIHZhciBpbm5lciA9IGVudi5zY29wZSgpOwogICAgICAgICAgc2NvcGUoCiAgICAgICAgICAgIG91dGVyLmVudHJ5LAogICAgICAgICAgICAiZm9yKCIsCiAgICAgICAgICAgIEJBVENIX0lELAogICAgICAgICAgICAiPTA7IiwKICAgICAgICAgICAgQkFUQ0hfSUQsCiAgICAgICAgICAgICI8IiwKICAgICAgICAgICAgTlVNX1BST1BTLAogICAgICAgICAgICAiOysrIiwKICAgICAgICAgICAgQkFUQ0hfSUQsCiAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgIFBST1BTLAogICAgICAgICAgICAiPSIsCiAgICAgICAgICAgIFBST1BfTElTVCwKICAgICAgICAgICAgIlsiLAogICAgICAgICAgICBCQVRDSF9JRCwKICAgICAgICAgICAgIl07IiwKICAgICAgICAgICAgaW5uZXIsCiAgICAgICAgICAgICJ9IiwKICAgICAgICAgICAgb3V0ZXIuZXhpdAogICAgICAgICAgKTsKICAgICAgICAgIGZ1bmN0aW9uIGlzSW5uZXJEZWZuKGRlZm4pIHsKICAgICAgICAgICAgcmV0dXJuIGRlZm4uY29udGV4dERlcCAmJiBjb250ZXh0RHluYW1pYyB8fCBkZWZuLnByb3BEZXA7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc091dGVyRGVmbihkZWZuKSB7CiAgICAgICAgICAgIHJldHVybiAhaXNJbm5lckRlZm4oZGVmbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYXJncy5uZWVkc0NvbnRleHQpIHsKICAgICAgICAgICAgZW1pdENvbnRleHQoZW52LCBpbm5lciwgYXJncy5jb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhcmdzLm5lZWRzRnJhbWVidWZmZXIpIHsKICAgICAgICAgICAgZW1pdFBvbGxGcmFtZWJ1ZmZlcihlbnYsIGlubmVyLCBhcmdzLmZyYW1lYnVmZmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIGVtaXRTZXRPcHRpb25zKGVudiwgaW5uZXIsIGFyZ3Muc3RhdGUsIGlzSW5uZXJEZWZuKTsKICAgICAgICAgIGlmIChhcmdzLnByb2ZpbGUgJiYgaXNJbm5lckRlZm4oYXJncy5wcm9maWxlKSkgewogICAgICAgICAgICBlbWl0UHJvZmlsZShlbnYsIGlubmVyLCBhcmdzLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgICAgdmFyIHByb2dDYWNoZSA9IGVudi5nbG9iYWwuZGVmKCJ7fSIpOwogICAgICAgICAgICB2YXIgUFJPR1JBTSA9IGFyZ3Muc2hhZGVyLnByb2dWYXIuYXBwZW5kKGVudiwgaW5uZXIpOwogICAgICAgICAgICB2YXIgUFJPR19JRCA9IGlubmVyLmRlZihQUk9HUkFNLCAiLmlkIik7CiAgICAgICAgICAgIHZhciBDQUNIRURfUFJPQyA9IGlubmVyLmRlZihwcm9nQ2FjaGUsICJbIiwgUFJPR19JRCwgIl0iKTsKICAgICAgICAgICAgaW5uZXIoCiAgICAgICAgICAgICAgZW52LnNoYXJlZC5nbCwKICAgICAgICAgICAgICAiLnVzZVByb2dyYW0oIiwKICAgICAgICAgICAgICBQUk9HUkFNLAogICAgICAgICAgICAgICIucHJvZ3JhbSk7IiwKICAgICAgICAgICAgICAiaWYoISIsCiAgICAgICAgICAgICAgQ0FDSEVEX1BST0MsCiAgICAgICAgICAgICAgIil7IiwKICAgICAgICAgICAgICBDQUNIRURfUFJPQywKICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgcHJvZ0NhY2hlLAogICAgICAgICAgICAgICJbIiwKICAgICAgICAgICAgICBQUk9HX0lELAogICAgICAgICAgICAgICJdPSIsCiAgICAgICAgICAgICAgZW52LmxpbmsoZnVuY3Rpb24ocHJvZ3JhbTIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVCb2R5KAogICAgICAgICAgICAgICAgICBlbWl0QmF0Y2hEeW5hbWljU2hhZGVyQm9keSwKICAgICAgICAgICAgICAgICAgZW52LAogICAgICAgICAgICAgICAgICBhcmdzLAogICAgICAgICAgICAgICAgICBwcm9ncmFtMiwKICAgICAgICAgICAgICAgICAgMgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgUFJPR1JBTSwKICAgICAgICAgICAgICAiKTt9IiwKICAgICAgICAgICAgICBDQUNIRURfUFJPQywKICAgICAgICAgICAgICAiLmNhbGwodGhpcyxhMFsiLAogICAgICAgICAgICAgIEJBVENIX0lELAogICAgICAgICAgICAgICJdLCIsCiAgICAgICAgICAgICAgQkFUQ0hfSUQsCiAgICAgICAgICAgICAgIik7IgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGFyZ3MudXNlVkFPKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3MuZHJhd1ZBTykgewogICAgICAgICAgICAgICAgaWYgKGlzSW5uZXJEZWZuKGFyZ3MuZHJhd1ZBTykpIHsKICAgICAgICAgICAgICAgICAgaW5uZXIoZW52LnNoYXJlZC52YW8sICIuc2V0VkFPKCIsIGFyZ3MuZHJhd1ZBTy5hcHBlbmQoZW52LCBpbm5lciksICIpOyIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgb3V0ZXIoZW52LnNoYXJlZC52YW8sICIuc2V0VkFPKCIsIGFyZ3MuZHJhd1ZBTy5hcHBlbmQoZW52LCBvdXRlciksICIpOyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvdXRlcihlbnYuc2hhcmVkLnZhbywgIi5zZXRWQU8oIiwgZW52LnNoYXJlZC52YW8sICIudGFyZ2V0VkFPKTsiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb3V0ZXIoZW52LnNoYXJlZC52YW8sICIuc2V0VkFPKG51bGwpOyIpOwogICAgICAgICAgICAgIGVtaXRBdHRyaWJ1dGVzKGVudiwgb3V0ZXIsIGFyZ3MsIHByb2dyYW0uYXR0cmlidXRlcywgaXNPdXRlckRlZm4pOwogICAgICAgICAgICAgIGVtaXRBdHRyaWJ1dGVzKGVudiwgaW5uZXIsIGFyZ3MsIHByb2dyYW0uYXR0cmlidXRlcywgaXNJbm5lckRlZm4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVtaXRVbmlmb3JtcyhlbnYsIG91dGVyLCBhcmdzLCBwcm9ncmFtLnVuaWZvcm1zLCBpc091dGVyRGVmbiwgZmFsc2UpOwogICAgICAgICAgICBlbWl0VW5pZm9ybXMoZW52LCBpbm5lciwgYXJncywgcHJvZ3JhbS51bmlmb3JtcywgaXNJbm5lckRlZm4sIHRydWUpOwogICAgICAgICAgICBlbWl0RHJhdyhlbnYsIG91dGVyLCBpbm5lciwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtaXRCYXRjaFByb2MoZW52LCBhcmdzKSB7CiAgICAgICAgICB2YXIgYmF0Y2ggPSBlbnYucHJvYygiYmF0Y2giLCAyKTsKICAgICAgICAgIGVudi5iYXRjaElkID0gIjAiOwogICAgICAgICAgaW5qZWN0RXh0ZW5zaW9ucyhlbnYsIGJhdGNoKTsKICAgICAgICAgIHZhciBjb250ZXh0RHluYW1pYyA9IGZhbHNlOwogICAgICAgICAgdmFyIG5lZWRzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICBPYmplY3Qua2V5cyhhcmdzLmNvbnRleHQpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBjb250ZXh0RHluYW1pYyA9IGNvbnRleHREeW5hbWljIHx8IGFyZ3MuY29udGV4dFtuYW1lXS5wcm9wRGVwOwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoIWNvbnRleHREeW5hbWljKSB7CiAgICAgICAgICAgIGVtaXRDb250ZXh0KGVudiwgYmF0Y2gsIGFyZ3MuY29udGV4dCk7CiAgICAgICAgICAgIG5lZWRzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyYW1lYnVmZmVyID0gYXJncy5mcmFtZWJ1ZmZlcjsKICAgICAgICAgIHZhciBuZWVkc0ZyYW1lYnVmZmVyID0gZmFsc2U7CiAgICAgICAgICBpZiAoZnJhbWVidWZmZXIpIHsKICAgICAgICAgICAgaWYgKGZyYW1lYnVmZmVyLnByb3BEZXApIHsKICAgICAgICAgICAgICBjb250ZXh0RHluYW1pYyA9IG5lZWRzRnJhbWVidWZmZXIgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZyYW1lYnVmZmVyLmNvbnRleHREZXAgJiYgY29udGV4dER5bmFtaWMpIHsKICAgICAgICAgICAgICBuZWVkc0ZyYW1lYnVmZmVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW5lZWRzRnJhbWVidWZmZXIpIHsKICAgICAgICAgICAgICBlbWl0UG9sbEZyYW1lYnVmZmVyKGVudiwgYmF0Y2gsIGZyYW1lYnVmZmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZW1pdFBvbGxGcmFtZWJ1ZmZlcihlbnYsIGJhdGNoLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhcmdzLnN0YXRlLnZpZXdwb3J0ICYmIGFyZ3Muc3RhdGUudmlld3BvcnQucHJvcERlcCkgewogICAgICAgICAgICBjb250ZXh0RHluYW1pYyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpc0lubmVyRGVmbihkZWZuKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZuLmNvbnRleHREZXAgJiYgY29udGV4dER5bmFtaWMgfHwgZGVmbi5wcm9wRGVwOwogICAgICAgICAgfQogICAgICAgICAgZW1pdFBvbGxTdGF0ZShlbnYsIGJhdGNoLCBhcmdzKTsKICAgICAgICAgIGVtaXRTZXRPcHRpb25zKGVudiwgYmF0Y2gsIGFyZ3Muc3RhdGUsIGZ1bmN0aW9uKGRlZm4pIHsKICAgICAgICAgICAgcmV0dXJuICFpc0lubmVyRGVmbihkZWZuKTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKCFhcmdzLnByb2ZpbGUgfHwgIWlzSW5uZXJEZWZuKGFyZ3MucHJvZmlsZSkpIHsKICAgICAgICAgICAgZW1pdFByb2ZpbGUoZW52LCBiYXRjaCwgYXJncywgZmFsc2UsICJhMSIpOwogICAgICAgICAgfQogICAgICAgICAgYXJncy5jb250ZXh0RGVwID0gY29udGV4dER5bmFtaWM7CiAgICAgICAgICBhcmdzLm5lZWRzQ29udGV4dCA9IG5lZWRzQ29udGV4dDsKICAgICAgICAgIGFyZ3MubmVlZHNGcmFtZWJ1ZmZlciA9IG5lZWRzRnJhbWVidWZmZXI7CiAgICAgICAgICB2YXIgcHJvZ0RlZm4gPSBhcmdzLnNoYWRlci5wcm9nVmFyOwogICAgICAgICAgaWYgKHByb2dEZWZuLmNvbnRleHREZXAgJiYgY29udGV4dER5bmFtaWMgfHwgcHJvZ0RlZm4ucHJvcERlcCkgewogICAgICAgICAgICBlbWl0QmF0Y2hCb2R5KAogICAgICAgICAgICAgIGVudiwKICAgICAgICAgICAgICBiYXRjaCwKICAgICAgICAgICAgICBhcmdzLAogICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBQUk9HUkFNID0gcHJvZ0RlZm4uYXBwZW5kKGVudiwgYmF0Y2gpOwogICAgICAgICAgICBiYXRjaChlbnYuc2hhcmVkLmdsLCAiLnVzZVByb2dyYW0oIiwgUFJPR1JBTSwgIi5wcm9ncmFtKTsiKTsKICAgICAgICAgICAgaWYgKGFyZ3Muc2hhZGVyLnByb2dyYW0pIHsKICAgICAgICAgICAgICBlbWl0QmF0Y2hCb2R5KAogICAgICAgICAgICAgICAgZW52LAogICAgICAgICAgICAgICAgYmF0Y2gsCiAgICAgICAgICAgICAgICBhcmdzLAogICAgICAgICAgICAgICAgYXJncy5zaGFkZXIucHJvZ3JhbQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYmF0Y2goZW52LnNoYXJlZC52YW8sICIuc2V0VkFPKG51bGwpOyIpOwogICAgICAgICAgICAgIHZhciBiYXRjaENhY2hlID0gZW52Lmdsb2JhbC5kZWYoInt9Iik7CiAgICAgICAgICAgICAgdmFyIFBST0dfSUQgPSBiYXRjaC5kZWYoUFJPR1JBTSwgIi5pZCIpOwogICAgICAgICAgICAgIHZhciBDQUNIRURfUFJPQyA9IGJhdGNoLmRlZihiYXRjaENhY2hlLCAiWyIsIFBST0dfSUQsICJdIik7CiAgICAgICAgICAgICAgYmF0Y2goCiAgICAgICAgICAgICAgICBlbnYuY29uZChDQUNIRURfUFJPQykudGhlbihDQUNIRURfUFJPQywgIi5jYWxsKHRoaXMsYTAsYTEpOyIpLmVsc2UoCiAgICAgICAgICAgICAgICAgIENBQ0hFRF9QUk9DLAogICAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICAgIGJhdGNoQ2FjaGUsCiAgICAgICAgICAgICAgICAgICJbIiwKICAgICAgICAgICAgICAgICAgUFJPR19JRCwKICAgICAgICAgICAgICAgICAgIl09IiwKICAgICAgICAgICAgICAgICAgZW52LmxpbmsoZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVCb2R5KGVtaXRCYXRjaEJvZHksIGVudiwgYXJncywgcHJvZ3JhbSwgMik7CiAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAiKCIsCiAgICAgICAgICAgICAgICAgIFBST0dSQU0sCiAgICAgICAgICAgICAgICAgICIpOyIsCiAgICAgICAgICAgICAgICAgIENBQ0hFRF9QUk9DLAogICAgICAgICAgICAgICAgICAiLmNhbGwodGhpcyxhMCxhMSk7IgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhhcmdzLnN0YXRlKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGJhdGNoKGVudi5zaGFyZWQuY3VycmVudCwgIi5kaXJ0eT10cnVlOyIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGVudi5zaGFyZWQudmFvKSB7CiAgICAgICAgICAgIGJhdGNoKGVudi5zaGFyZWQudmFvLCAiLnNldFZBTyhudWxsKTsiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1pdFNjb3BlUHJvYyhlbnYsIGFyZ3MpIHsKICAgICAgICAgIHZhciBzY29wZSA9IGVudi5wcm9jKCJzY29wZSIsIDMpOwogICAgICAgICAgZW52LmJhdGNoSWQgPSAiYTIiOwogICAgICAgICAgdmFyIHNoYXJlZCA9IGVudi5zaGFyZWQ7CiAgICAgICAgICB2YXIgQ1VSUkVOVF9TVEFURSA9IHNoYXJlZC5jdXJyZW50OwogICAgICAgICAgZW1pdENvbnRleHQoZW52LCBzY29wZSwgYXJncy5jb250ZXh0KTsKICAgICAgICAgIGlmIChhcmdzLmZyYW1lYnVmZmVyKSB7CiAgICAgICAgICAgIGFyZ3MuZnJhbWVidWZmZXIuYXBwZW5kKGVudiwgc2NvcGUpOwogICAgICAgICAgfQogICAgICAgICAgc29ydFN0YXRlKE9iamVjdC5rZXlzKGFyZ3Muc3RhdGUpKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgdmFyIGRlZm4gPSBhcmdzLnN0YXRlW25hbWVdOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWZuLmFwcGVuZChlbnYsIHNjb3BlKTsKICAgICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKHZhbHVlKSkgewogICAgICAgICAgICAgIHZhbHVlLmZvckVhY2goZnVuY3Rpb24odiwgaSkgewogICAgICAgICAgICAgICAgc2NvcGUuc2V0KGVudi5uZXh0W25hbWVdLCAiWyIgKyBpICsgIl0iLCB2KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY29wZS5zZXQoc2hhcmVkLm5leHQsICIuIiArIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBlbWl0UHJvZmlsZShlbnYsIHNjb3BlLCBhcmdzLCB0cnVlLCB0cnVlKTsKICAgICAgICAgIFtTX0VMRU1FTlRTLCBTX09GRlNFVCwgU19DT1VOVCwgU19JTlNUQU5DRVMsIFNfUFJJTUlUSVZFXS5mb3JFYWNoKAogICAgICAgICAgICBmdW5jdGlvbihvcHQpIHsKICAgICAgICAgICAgICB2YXIgdmFyaWFibGUgPSBhcmdzLmRyYXdbb3B0XTsKICAgICAgICAgICAgICBpZiAoIXZhcmlhYmxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjb3BlLnNldChzaGFyZWQuZHJhdywgIi4iICsgb3B0LCAiIiArIHZhcmlhYmxlLmFwcGVuZChlbnYsIHNjb3BlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICk7CiAgICAgICAgICBPYmplY3Qua2V5cyhhcmdzLnVuaWZvcm1zKS5mb3JFYWNoKGZ1bmN0aW9uKG9wdCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBhcmdzLnVuaWZvcm1zW29wdF0uYXBwZW5kKGVudiwgc2NvcGUpOwogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9ICJbIiArIHZhbHVlLmpvaW4oKSArICJdIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzY29wZS5zZXQoCiAgICAgICAgICAgICAgc2hhcmVkLnVuaWZvcm1zLAogICAgICAgICAgICAgICJbIiArIHN0cmluZ1N0b3JlLmlkKG9wdCkgKyAiXSIsCiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgKTsKICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmtleXMoYXJncy5hdHRyaWJ1dGVzKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgdmFyIHJlY29yZCA9IGFyZ3MuYXR0cmlidXRlc1tuYW1lXS5hcHBlbmQoZW52LCBzY29wZSk7CiAgICAgICAgICAgIHZhciBzY29wZUF0dHJpYiA9IGVudi5zY29wZUF0dHJpYihuYW1lKTsKICAgICAgICAgICAgT2JqZWN0LmtleXMobmV3IEF0dHJpYnV0ZVJlY29yZDIoKSkuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgc2NvcGUuc2V0KHNjb3BlQXR0cmliLCAiLiIgKyBwcm9wLCByZWNvcmRbcHJvcF0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGFyZ3Muc2NvcGVWQU8pIHsKICAgICAgICAgICAgc2NvcGUuc2V0KHNoYXJlZC52YW8sICIudGFyZ2V0VkFPIiwgYXJncy5zY29wZVZBTy5hcHBlbmQoZW52LCBzY29wZSkpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2F2ZVNoYWRlcihuYW1lKSB7CiAgICAgICAgICAgIHZhciBzaGFkZXIgPSBhcmdzLnNoYWRlcltuYW1lXTsKICAgICAgICAgICAgaWYgKHNoYWRlcikgewogICAgICAgICAgICAgIHNjb3BlLnNldChzaGFyZWQuc2hhZGVyLCAiLiIgKyBuYW1lLCBzaGFkZXIuYXBwZW5kKGVudiwgc2NvcGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc2F2ZVNoYWRlcihTX1ZFUlQpOwogICAgICAgICAgc2F2ZVNoYWRlcihTX0ZSQUcpOwogICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGFyZ3Muc3RhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgc2NvcGUoQ1VSUkVOVF9TVEFURSwgIi5kaXJ0eT10cnVlOyIpOwogICAgICAgICAgICBzY29wZS5leGl0KENVUlJFTlRfU1RBVEUsICIuZGlydHk9dHJ1ZTsiKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjb3BlKCJhMSgiLCBlbnYuc2hhcmVkLmNvbnRleHQsICIsYTAsIiwgZW52LmJhdGNoSWQsICIpOyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0R5bmFtaWNPYmplY3Qob2JqZWN0KSB7CiAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdCAhPT0gIm9iamVjdCIgfHwgaXNBcnJheUxpa2Uob2JqZWN0KSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBPYmplY3Qua2V5cyhvYmplY3QpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBpZiAoZHluYW1pYy5pc0R5bmFtaWMob2JqZWN0W3Byb3BzW2ldXSkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzcGxhdE9iamVjdChlbnYsIG9wdGlvbnMsIG5hbWUpIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBvcHRpb25zLnN0YXRpY1tuYW1lXTsKICAgICAgICAgIGlmICghb2JqZWN0IHx8ICFpc0R5bmFtaWNPYmplY3Qob2JqZWN0KSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2xvYmFscyA9IGVudi5nbG9iYWw7CiAgICAgICAgICB2YXIga2V5czIgPSBPYmplY3Qua2V5cyhvYmplY3QpOwogICAgICAgICAgdmFyIHRoaXNEZXAgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb250ZXh0RGVwID0gZmFsc2U7CiAgICAgICAgICB2YXIgcHJvcERlcCA9IGZhbHNlOwogICAgICAgICAgdmFyIG9iamVjdFJlZiA9IGVudi5nbG9iYWwuZGVmKCJ7fSIpOwogICAgICAgICAga2V5czIuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CiAgICAgICAgICAgIGlmIChkeW5hbWljLmlzRHluYW1pYyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG9iamVjdFtrZXldID0gZHluYW1pYy51bmJveCh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkZXBzID0gY3JlYXRlRHluYW1pY0RlY2wodmFsdWUsIG51bGwpOwogICAgICAgICAgICAgIHRoaXNEZXAgPSB0aGlzRGVwIHx8IGRlcHMudGhpc0RlcDsKICAgICAgICAgICAgICBwcm9wRGVwID0gcHJvcERlcCB8fCBkZXBzLnByb3BEZXA7CiAgICAgICAgICAgICAgY29udGV4dERlcCA9IGNvbnRleHREZXAgfHwgZGVwcy5jb250ZXh0RGVwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdsb2JhbHMob2JqZWN0UmVmLCAiLiIsIGtleSwgIj0iKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgICAgZ2xvYmFscyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgICAgZ2xvYmFscygnIicsIHZhbHVlLCAnIicpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGdsb2JhbHMoIlsiLCB2YWx1ZS5qb2luKCksICJdIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBnbG9iYWxzKGVudi5saW5rKHZhbHVlKSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnbG9iYWxzKCI7Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgZnVuY3Rpb24gYXBwZW5kQmxvY2soZW52MiwgYmxvY2spIHsKICAgICAgICAgICAga2V5czIuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKICAgICAgICAgICAgICBpZiAoIWR5bmFtaWMuaXNEeW5hbWljKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVmID0gZW52Mi5pbnZva2UoYmxvY2ssIHZhbHVlKTsKICAgICAgICAgICAgICBibG9jayhvYmplY3RSZWYsICIuIiwga2V5LCAiPSIsIHJlZiwgIjsiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBvcHRpb25zLmR5bmFtaWNbbmFtZV0gPSBuZXcgZHluYW1pYy5EeW5hbWljVmFyaWFibGUoRFlOX1RIVU5LLCB7CiAgICAgICAgICAgIHRoaXNEZXAsCiAgICAgICAgICAgIGNvbnRleHREZXAsCiAgICAgICAgICAgIHByb3BEZXAsCiAgICAgICAgICAgIHJlZjogb2JqZWN0UmVmLAogICAgICAgICAgICBhcHBlbmQ6IGFwcGVuZEJsb2NrCiAgICAgICAgICB9KTsKICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnN0YXRpY1tuYW1lXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGlsZUNvbW1hbmQob3B0aW9ucywgYXR0cmlidXRlcywgdW5pZm9ybXMsIGNvbnRleHQsIHN0YXRzMikgewogICAgICAgICAgdmFyIGVudiA9IGNyZWF0ZVJFR0xFbnZpcm9ubWVudCgpOwogICAgICAgICAgZW52LnN0YXRzID0gZW52Lmxpbmsoc3RhdHMyKTsKICAgICAgICAgIE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMuc3RhdGljKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICBzcGxhdE9iamVjdChlbnYsIGF0dHJpYnV0ZXMsIGtleSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIE5FU1RFRF9PUFRJT05TLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBzcGxhdE9iamVjdChlbnYsIG9wdGlvbnMsIG5hbWUpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgYXJncyA9IHBhcnNlQXJndW1lbnRzKG9wdGlvbnMsIGF0dHJpYnV0ZXMsIHVuaWZvcm1zLCBjb250ZXh0LCBlbnYpOwogICAgICAgICAgZW1pdERyYXdQcm9jKGVudiwgYXJncyk7CiAgICAgICAgICBlbWl0U2NvcGVQcm9jKGVudiwgYXJncyk7CiAgICAgICAgICBlbWl0QmF0Y2hQcm9jKGVudiwgYXJncyk7CiAgICAgICAgICByZXR1cm4gZXh0ZW5kMihlbnYuY29tcGlsZSgpLCB7CiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGFyZ3Muc2hhZGVyLnByb2dyYW0uZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG5leHQ6IG5leHRTdGF0ZSwKICAgICAgICAgIGN1cnJlbnQ6IGN1cnJlbnRTdGF0ZSwKICAgICAgICAgIHByb2NzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGVudiA9IGNyZWF0ZVJFR0xFbnZpcm9ubWVudCgpOwogICAgICAgICAgICB2YXIgcG9sbCA9IGVudi5wcm9jKCJwb2xsIik7CiAgICAgICAgICAgIHZhciByZWZyZXNoID0gZW52LnByb2MoInJlZnJlc2giKTsKICAgICAgICAgICAgdmFyIGNvbW1vbiA9IGVudi5ibG9jaygpOwogICAgICAgICAgICBwb2xsKGNvbW1vbik7CiAgICAgICAgICAgIHJlZnJlc2goY29tbW9uKTsKICAgICAgICAgICAgdmFyIHNoYXJlZCA9IGVudi5zaGFyZWQ7CiAgICAgICAgICAgIHZhciBHTCA9IHNoYXJlZC5nbDsKICAgICAgICAgICAgdmFyIE5FWFRfU1RBVEUgPSBzaGFyZWQubmV4dDsKICAgICAgICAgICAgdmFyIENVUlJFTlRfU1RBVEUgPSBzaGFyZWQuY3VycmVudDsKICAgICAgICAgICAgY29tbW9uKENVUlJFTlRfU1RBVEUsICIuZGlydHk9ZmFsc2U7Iik7CiAgICAgICAgICAgIGVtaXRQb2xsRnJhbWVidWZmZXIoZW52LCBwb2xsKTsKICAgICAgICAgICAgZW1pdFBvbGxGcmFtZWJ1ZmZlcihlbnYsIHJlZnJlc2gsIG51bGwsIHRydWUpOwogICAgICAgICAgICB2YXIgSU5TVEFOQ0lORzsKICAgICAgICAgICAgaWYgKGV4dEluc3RhbmNpbmcpIHsKICAgICAgICAgICAgICBJTlNUQU5DSU5HID0gZW52LmxpbmsoZXh0SW5zdGFuY2luZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4dGVuc2lvbnMub2VzX3ZlcnRleF9hcnJheV9vYmplY3QpIHsKICAgICAgICAgICAgICByZWZyZXNoKGVudi5saW5rKGV4dGVuc2lvbnMub2VzX3ZlcnRleF9hcnJheV9vYmplY3QpLCAiLmJpbmRWZXJ0ZXhBcnJheU9FUyhudWxsKTsiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpbWl0cy5tYXhBdHRyaWJ1dGVzOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgQklORElORyA9IHJlZnJlc2guZGVmKHNoYXJlZC5hdHRyaWJ1dGVzLCAiWyIsIGksICJdIik7CiAgICAgICAgICAgICAgdmFyIGlmdGUgPSBlbnYuY29uZChCSU5ESU5HLCAiLmJ1ZmZlciIpOwogICAgICAgICAgICAgIGlmdGUudGhlbigKICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgIi5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheSgiLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgICIpOyIsCiAgICAgICAgICAgICAgICBHTCwKICAgICAgICAgICAgICAgICIuYmluZEJ1ZmZlcigiLAogICAgICAgICAgICAgICAgR0xfQVJSQVlfQlVGRkVSJDIsCiAgICAgICAgICAgICAgICAiLCIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi5idWZmZXIuYnVmZmVyKTsiLAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLnZlcnRleEF0dHJpYlBvaW50ZXIoIiwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICAiLCIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi5zaXplLCIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi50eXBlLCIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi5ub3JtYWxpemVkLCIsCiAgICAgICAgICAgICAgICBCSU5ESU5HLAogICAgICAgICAgICAgICAgIi5zdHJpZGUsIiwKICAgICAgICAgICAgICAgIEJJTkRJTkcsCiAgICAgICAgICAgICAgICAiLm9mZnNldCk7IgogICAgICAgICAgICAgICkuZWxzZSgKICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgIi5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoIiwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgR0wsCiAgICAgICAgICAgICAgICAiLnZlcnRleEF0dHJpYjRmKCIsCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgIiwiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIueCwiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIueSwiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIueiwiLAogICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICIudyk7IiwKICAgICAgICAgICAgICAgIEJJTkRJTkcsCiAgICAgICAgICAgICAgICAiLmJ1ZmZlcj1udWxsOyIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJlZnJlc2goaWZ0ZSk7CiAgICAgICAgICAgICAgaWYgKGV4dEluc3RhbmNpbmcpIHsKICAgICAgICAgICAgICAgIHJlZnJlc2goCiAgICAgICAgICAgICAgICAgIElOU1RBTkNJTkcsCiAgICAgICAgICAgICAgICAgICIudmVydGV4QXR0cmliRGl2aXNvckFOR0xFKCIsCiAgICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICAgICIsIiwKICAgICAgICAgICAgICAgICAgQklORElORywKICAgICAgICAgICAgICAgICAgIi5kaXZpc29yKTsiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZWZyZXNoKAogICAgICAgICAgICAgIGVudi5zaGFyZWQudmFvLAogICAgICAgICAgICAgICIuY3VycmVudFZBTz1udWxsOyIsCiAgICAgICAgICAgICAgZW52LnNoYXJlZC52YW8sCiAgICAgICAgICAgICAgIi5zZXRWQU8oIiwKICAgICAgICAgICAgICBlbnYuc2hhcmVkLnZhbywKICAgICAgICAgICAgICAiLnRhcmdldFZBTyk7IgogICAgICAgICAgICApOwogICAgICAgICAgICBPYmplY3Qua2V5cyhHTF9GTEFHUykuZm9yRWFjaChmdW5jdGlvbihmbGFnKSB7CiAgICAgICAgICAgICAgdmFyIGNhcCA9IEdMX0ZMQUdTW2ZsYWddOwogICAgICAgICAgICAgIHZhciBORVhUID0gY29tbW9uLmRlZihORVhUX1NUQVRFLCAiLiIsIGZsYWcpOwogICAgICAgICAgICAgIHZhciBibG9jayA9IGVudi5ibG9jaygpOwogICAgICAgICAgICAgIGJsb2NrKAogICAgICAgICAgICAgICAgImlmKCIsCiAgICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICAgIil7IiwKICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgIi5lbmFibGUoIiwKICAgICAgICAgICAgICAgIGNhcCwKICAgICAgICAgICAgICAgICIpfWVsc2V7IiwKICAgICAgICAgICAgICAgIEdMLAogICAgICAgICAgICAgICAgIi5kaXNhYmxlKCIsCiAgICAgICAgICAgICAgICBjYXAsCiAgICAgICAgICAgICAgICAiKX0iLAogICAgICAgICAgICAgICAgQ1VSUkVOVF9TVEFURSwKICAgICAgICAgICAgICAgICIuIiwKICAgICAgICAgICAgICAgIGZsYWcsCiAgICAgICAgICAgICAgICAiPSIsCiAgICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICAgIjsiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZWZyZXNoKGJsb2NrKTsKICAgICAgICAgICAgICBwb2xsKAogICAgICAgICAgICAgICAgImlmKCIsCiAgICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICAgIiE9PSIsCiAgICAgICAgICAgICAgICBDVVJSRU5UX1NUQVRFLAogICAgICAgICAgICAgICAgIi4iLAogICAgICAgICAgICAgICAgZmxhZywKICAgICAgICAgICAgICAgICIpeyIsCiAgICAgICAgICAgICAgICBibG9jaywKICAgICAgICAgICAgICAgICJ9IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3Qua2V5cyhHTF9WQVJJQUJMRVMpLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgIHZhciBmdW5jID0gR0xfVkFSSUFCTEVTW25hbWVdOwogICAgICAgICAgICAgIHZhciBpbml0ID0gY3VycmVudFN0YXRlW25hbWVdOwogICAgICAgICAgICAgIHZhciBORVhULCBDVVJSRU5UOwogICAgICAgICAgICAgIHZhciBibG9jayA9IGVudi5ibG9jaygpOwogICAgICAgICAgICAgIGJsb2NrKEdMLCAiLiIsIGZ1bmMsICIoIik7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKGluaXQpKSB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGluaXQubGVuZ3RoOwogICAgICAgICAgICAgICAgTkVYVCA9IGVudi5nbG9iYWwuZGVmKE5FWFRfU1RBVEUsICIuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICBDVVJSRU5UID0gZW52Lmdsb2JhbC5kZWYoQ1VSUkVOVF9TVEFURSwgIi4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIGJsb2NrKAogICAgICAgICAgICAgICAgICBsb29wKG4sIGZ1bmN0aW9uKGkyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5FWFQgKyAiWyIgKyBpMiArICJdIjsKICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICIpOyIsCiAgICAgICAgICAgICAgICAgIGxvb3AobiwgZnVuY3Rpb24oaTIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQ1VSUkVOVCArICJbIiArIGkyICsgIl09IiArIE5FWFQgKyAiWyIgKyBpMiArICJdOyI7CiAgICAgICAgICAgICAgICAgIH0pLmpvaW4oIiIpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcG9sbCgKICAgICAgICAgICAgICAgICAgImlmKCIsCiAgICAgICAgICAgICAgICAgIGxvb3AobiwgZnVuY3Rpb24oaTIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTkVYVCArICJbIiArIGkyICsgIl0hPT0iICsgQ1VSUkVOVCArICJbIiArIGkyICsgIl0iOwogICAgICAgICAgICAgICAgICB9KS5qb2luKCJ8fCIpLAogICAgICAgICAgICAgICAgICAiKXsiLAogICAgICAgICAgICAgICAgICBibG9jaywKICAgICAgICAgICAgICAgICAgIn0iCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBORVhUID0gY29tbW9uLmRlZihORVhUX1NUQVRFLCAiLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgQ1VSUkVOVCA9IGNvbW1vbi5kZWYoQ1VSUkVOVF9TVEFURSwgIi4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIGJsb2NrKAogICAgICAgICAgICAgICAgICBORVhULAogICAgICAgICAgICAgICAgICAiKTsiLAogICAgICAgICAgICAgICAgICBDVVJSRU5UX1NUQVRFLAogICAgICAgICAgICAgICAgICAiLiIsCiAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICI9IiwKICAgICAgICAgICAgICAgICAgTkVYVCwKICAgICAgICAgICAgICAgICAgIjsiCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcG9sbCgKICAgICAgICAgICAgICAgICAgImlmKCIsCiAgICAgICAgICAgICAgICAgIE5FWFQsCiAgICAgICAgICAgICAgICAgICIhPT0iLAogICAgICAgICAgICAgICAgICBDVVJSRU5ULAogICAgICAgICAgICAgICAgICAiKXsiLAogICAgICAgICAgICAgICAgICBibG9jaywKICAgICAgICAgICAgICAgICAgIn0iCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWZyZXNoKGJsb2NrKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBlbnYuY29tcGlsZSgpOwogICAgICAgICAgfSgpLAogICAgICAgICAgY29tcGlsZTogY29tcGlsZUNvbW1hbmQKICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN0YXRzKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB2YW9Db3VudDogMCwKICAgICAgICAgIGJ1ZmZlckNvdW50OiAwLAogICAgICAgICAgZWxlbWVudHNDb3VudDogMCwKICAgICAgICAgIGZyYW1lYnVmZmVyQ291bnQ6IDAsCiAgICAgICAgICBzaGFkZXJDb3VudDogMCwKICAgICAgICAgIHRleHR1cmVDb3VudDogMCwKICAgICAgICAgIGN1YmVDb3VudDogMCwKICAgICAgICAgIHJlbmRlcmJ1ZmZlckNvdW50OiAwLAogICAgICAgICAgbWF4VGV4dHVyZVVuaXRzOiAwCiAgICAgICAgfTsKICAgICAgfQogICAgICB2YXIgR0xfUVVFUllfUkVTVUxUX0VYVCA9IDM0OTE4OwogICAgICB2YXIgR0xfUVVFUllfUkVTVUxUX0FWQUlMQUJMRV9FWFQgPSAzNDkxOTsKICAgICAgdmFyIEdMX1RJTUVfRUxBUFNFRF9FWFQgPSAzNTAwNzsKICAgICAgdmFyIGNyZWF0ZVRpbWVyID0gZnVuY3Rpb24oZ2wsIGV4dGVuc2lvbnMpIHsKICAgICAgICBpZiAoIWV4dGVuc2lvbnMuZXh0X2Rpc2pvaW50X3RpbWVyX3F1ZXJ5KSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHF1ZXJ5UG9vbCA9IFtdOwogICAgICAgIGZ1bmN0aW9uIGFsbG9jUXVlcnkoKSB7CiAgICAgICAgICByZXR1cm4gcXVlcnlQb29sLnBvcCgpIHx8IGV4dGVuc2lvbnMuZXh0X2Rpc2pvaW50X3RpbWVyX3F1ZXJ5LmNyZWF0ZVF1ZXJ5RVhUKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZyZWVRdWVyeShxdWVyeSkgewogICAgICAgICAgcXVlcnlQb29sLnB1c2gocXVlcnkpOwogICAgICAgIH0KICAgICAgICB2YXIgcGVuZGluZ1F1ZXJpZXMgPSBbXTsKICAgICAgICBmdW5jdGlvbiBiZWdpblF1ZXJ5KHN0YXRzMikgewogICAgICAgICAgdmFyIHF1ZXJ5ID0gYWxsb2NRdWVyeSgpOwogICAgICAgICAgZXh0ZW5zaW9ucy5leHRfZGlzam9pbnRfdGltZXJfcXVlcnkuYmVnaW5RdWVyeUVYVChHTF9USU1FX0VMQVBTRURfRVhULCBxdWVyeSk7CiAgICAgICAgICBwZW5kaW5nUXVlcmllcy5wdXNoKHF1ZXJ5KTsKICAgICAgICAgIHB1c2hTY29wZVN0YXRzKHBlbmRpbmdRdWVyaWVzLmxlbmd0aCAtIDEsIHBlbmRpbmdRdWVyaWVzLmxlbmd0aCwgc3RhdHMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5kUXVlcnkoKSB7CiAgICAgICAgICBleHRlbnNpb25zLmV4dF9kaXNqb2ludF90aW1lcl9xdWVyeS5lbmRRdWVyeUVYVChHTF9USU1FX0VMQVBTRURfRVhUKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gUGVuZGluZ1N0YXRzKCkgewogICAgICAgICAgdGhpcy5zdGFydFF1ZXJ5SW5kZXggPSAtMTsKICAgICAgICAgIHRoaXMuZW5kUXVlcnlJbmRleCA9IC0xOwogICAgICAgICAgdGhpcy5zdW0gPSAwOwogICAgICAgICAgdGhpcy5zdGF0cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBwZW5kaW5nU3RhdHNQb29sID0gW107CiAgICAgICAgZnVuY3Rpb24gYWxsb2NQZW5kaW5nU3RhdHMoKSB7CiAgICAgICAgICByZXR1cm4gcGVuZGluZ1N0YXRzUG9vbC5wb3AoKSB8fCBuZXcgUGVuZGluZ1N0YXRzKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZyZWVQZW5kaW5nU3RhdHMocGVuZGluZ1N0YXRzMikgewogICAgICAgICAgcGVuZGluZ1N0YXRzUG9vbC5wdXNoKHBlbmRpbmdTdGF0czIpOwogICAgICAgIH0KICAgICAgICB2YXIgcGVuZGluZ1N0YXRzID0gW107CiAgICAgICAgZnVuY3Rpb24gcHVzaFNjb3BlU3RhdHMoc3RhcnQsIGVuZCwgc3RhdHMyKSB7CiAgICAgICAgICB2YXIgcHMgPSBhbGxvY1BlbmRpbmdTdGF0cygpOwogICAgICAgICAgcHMuc3RhcnRRdWVyeUluZGV4ID0gc3RhcnQ7CiAgICAgICAgICBwcy5lbmRRdWVyeUluZGV4ID0gZW5kOwogICAgICAgICAgcHMuc3VtID0gMDsKICAgICAgICAgIHBzLnN0YXRzID0gc3RhdHMyOwogICAgICAgICAgcGVuZGluZ1N0YXRzLnB1c2gocHMpOwogICAgICAgIH0KICAgICAgICB2YXIgdGltZVN1bSA9IFtdOwogICAgICAgIHZhciBxdWVyeVB0ciA9IFtdOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAgICAgICAgIHZhciBwdHIsIGk7CiAgICAgICAgICB2YXIgbiA9IHBlbmRpbmdRdWVyaWVzLmxlbmd0aDsKICAgICAgICAgIGlmIChuID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXJ5UHRyLmxlbmd0aCA9IE1hdGgubWF4KHF1ZXJ5UHRyLmxlbmd0aCwgbiArIDEpOwogICAgICAgICAgdGltZVN1bS5sZW5ndGggPSBNYXRoLm1heCh0aW1lU3VtLmxlbmd0aCwgbiArIDEpOwogICAgICAgICAgdGltZVN1bVswXSA9IDA7CiAgICAgICAgICBxdWVyeVB0clswXSA9IDA7CiAgICAgICAgICB2YXIgcXVlcnlUaW1lID0gMDsKICAgICAgICAgIHB0ciA9IDA7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGVuZGluZ1F1ZXJpZXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gcGVuZGluZ1F1ZXJpZXNbaV07CiAgICAgICAgICAgIGlmIChleHRlbnNpb25zLmV4dF9kaXNqb2ludF90aW1lcl9xdWVyeS5nZXRRdWVyeU9iamVjdEVYVChxdWVyeSwgR0xfUVVFUllfUkVTVUxUX0FWQUlMQUJMRV9FWFQpKSB7CiAgICAgICAgICAgICAgcXVlcnlUaW1lICs9IGV4dGVuc2lvbnMuZXh0X2Rpc2pvaW50X3RpbWVyX3F1ZXJ5LmdldFF1ZXJ5T2JqZWN0RVhUKHF1ZXJ5LCBHTF9RVUVSWV9SRVNVTFRfRVhUKTsKICAgICAgICAgICAgICBmcmVlUXVlcnkocXVlcnkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBlbmRpbmdRdWVyaWVzW3B0cisrXSA9IHF1ZXJ5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRpbWVTdW1baSArIDFdID0gcXVlcnlUaW1lOwogICAgICAgICAgICBxdWVyeVB0cltpICsgMV0gPSBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBwZW5kaW5nUXVlcmllcy5sZW5ndGggPSBwdHI7CiAgICAgICAgICBwdHIgPSAwOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBlbmRpbmdTdGF0cy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICB2YXIgc3RhdHMyID0gcGVuZGluZ1N0YXRzW2ldOwogICAgICAgICAgICB2YXIgc3RhcnQgPSBzdGF0czIuc3RhcnRRdWVyeUluZGV4OwogICAgICAgICAgICB2YXIgZW5kID0gc3RhdHMyLmVuZFF1ZXJ5SW5kZXg7CiAgICAgICAgICAgIHN0YXRzMi5zdW0gKz0gdGltZVN1bVtlbmRdIC0gdGltZVN1bVtzdGFydF07CiAgICAgICAgICAgIHZhciBzdGFydFB0ciA9IHF1ZXJ5UHRyW3N0YXJ0XTsKICAgICAgICAgICAgdmFyIGVuZFB0ciA9IHF1ZXJ5UHRyW2VuZF07CiAgICAgICAgICAgIGlmIChlbmRQdHIgPT09IHN0YXJ0UHRyKSB7CiAgICAgICAgICAgICAgc3RhdHMyLnN0YXRzLmdwdVRpbWUgKz0gc3RhdHMyLnN1bSAvIDFlNjsKICAgICAgICAgICAgICBmcmVlUGVuZGluZ1N0YXRzKHN0YXRzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RhdHMyLnN0YXJ0UXVlcnlJbmRleCA9IHN0YXJ0UHRyOwogICAgICAgICAgICAgIHN0YXRzMi5lbmRRdWVyeUluZGV4ID0gZW5kUHRyOwogICAgICAgICAgICAgIHBlbmRpbmdTdGF0c1twdHIrK10gPSBzdGF0czI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBlbmRpbmdTdGF0cy5sZW5ndGggPSBwdHI7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBiZWdpblF1ZXJ5LAogICAgICAgICAgZW5kUXVlcnksCiAgICAgICAgICBwdXNoU2NvcGVTdGF0cywKICAgICAgICAgIHVwZGF0ZSwKICAgICAgICAgIGdldE51bVBlbmRpbmdRdWVyaWVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBlbmRpbmdRdWVyaWVzLmxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHF1ZXJ5UG9vbC5wdXNoLmFwcGx5KHF1ZXJ5UG9vbCwgcGVuZGluZ1F1ZXJpZXMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5UG9vbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4dGVuc2lvbnMuZXh0X2Rpc2pvaW50X3RpbWVyX3F1ZXJ5LmRlbGV0ZVF1ZXJ5RVhUKHF1ZXJ5UG9vbFtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGVuZGluZ1F1ZXJpZXMubGVuZ3RoID0gMDsKICAgICAgICAgICAgcXVlcnlQb29sLmxlbmd0aCA9IDA7CiAgICAgICAgICB9LAogICAgICAgICAgcmVzdG9yZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdRdWVyaWVzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHF1ZXJ5UG9vbC5sZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH07CiAgICAgIHZhciBHTF9DT0xPUl9CVUZGRVJfQklUID0gMTYzODQ7CiAgICAgIHZhciBHTF9ERVBUSF9CVUZGRVJfQklUID0gMjU2OwogICAgICB2YXIgR0xfU1RFTkNJTF9CVUZGRVJfQklUID0gMTAyNDsKICAgICAgdmFyIEdMX0FSUkFZX0JVRkZFUiA9IDM0OTYyOwogICAgICB2YXIgQ09OVEVYVF9MT1NUX0VWRU5UID0gIndlYmdsY29udGV4dGxvc3QiOwogICAgICB2YXIgQ09OVEVYVF9SRVNUT1JFRF9FVkVOVCA9ICJ3ZWJnbGNvbnRleHRyZXN0b3JlZCI7CiAgICAgIHZhciBEWU5fUFJPUCA9IDE7CiAgICAgIHZhciBEWU5fQ09OVEVYVCA9IDI7CiAgICAgIHZhciBEWU5fU1RBVEUgPSAzOwogICAgICBmdW5jdGlvbiBmaW5kMihoYXlzdGFjaywgbmVlZGxlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXlzdGFjay5sZW5ndGg7ICsraSkgewogICAgICAgICAgaWYgKGhheXN0YWNrW2ldID09PSBuZWVkbGUpIHsKICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgICBmdW5jdGlvbiB3cmFwUkVHTChhcmdzKSB7CiAgICAgICAgdmFyIGNvbmZpZyA9IHBhcnNlQXJncyhhcmdzKTsKICAgICAgICBpZiAoIWNvbmZpZykgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBnbCA9IGNvbmZpZy5nbDsKICAgICAgICB2YXIgZ2xBdHRyaWJ1dGVzID0gZ2wuZ2V0Q29udGV4dEF0dHJpYnV0ZXMoKTsKICAgICAgICB2YXIgY29udGV4dExvc3QgPSBnbC5pc0NvbnRleHRMb3N0KCk7CiAgICAgICAgdmFyIGV4dGVuc2lvblN0YXRlID0gY3JlYXRlRXh0ZW5zaW9uQ2FjaGUoZ2wsIGNvbmZpZyk7CiAgICAgICAgaWYgKCFleHRlbnNpb25TdGF0ZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBzdHJpbmdTdG9yZSA9IGNyZWF0ZVN0cmluZ1N0b3JlKCk7CiAgICAgICAgdmFyIHN0YXRzJCQxID0gc3RhdHMoKTsKICAgICAgICB2YXIgZXh0ZW5zaW9ucyA9IGV4dGVuc2lvblN0YXRlLmV4dGVuc2lvbnM7CiAgICAgICAgdmFyIHRpbWVyID0gY3JlYXRlVGltZXIoZ2wsIGV4dGVuc2lvbnMpOwogICAgICAgIHZhciBTVEFSVF9USU1FID0gY2xvY2soKTsKICAgICAgICB2YXIgV0lEVEggPSBnbC5kcmF3aW5nQnVmZmVyV2lkdGg7CiAgICAgICAgdmFyIEhFSUdIVCA9IGdsLmRyYXdpbmdCdWZmZXJIZWlnaHQ7CiAgICAgICAgdmFyIGNvbnRleHRTdGF0ZSA9IHsKICAgICAgICAgIHRpY2s6IDAsCiAgICAgICAgICB0aW1lOiAwLAogICAgICAgICAgdmlld3BvcnRXaWR0aDogV0lEVEgsCiAgICAgICAgICB2aWV3cG9ydEhlaWdodDogSEVJR0hULAogICAgICAgICAgZnJhbWVidWZmZXJXaWR0aDogV0lEVEgsCiAgICAgICAgICBmcmFtZWJ1ZmZlckhlaWdodDogSEVJR0hULAogICAgICAgICAgZHJhd2luZ0J1ZmZlcldpZHRoOiBXSURUSCwKICAgICAgICAgIGRyYXdpbmdCdWZmZXJIZWlnaHQ6IEhFSUdIVCwKICAgICAgICAgIHBpeGVsUmF0aW86IGNvbmZpZy5waXhlbFJhdGlvCiAgICAgICAgfTsKICAgICAgICB2YXIgdW5pZm9ybVN0YXRlID0ge307CiAgICAgICAgdmFyIGRyYXdTdGF0ZSA9IHsKICAgICAgICAgIGVsZW1lbnRzOiBudWxsLAogICAgICAgICAgcHJpbWl0aXZlOiA0LAogICAgICAgICAgLy8gR0xfVFJJQU5HTEVTCiAgICAgICAgICBjb3VudDogLTEsCiAgICAgICAgICBvZmZzZXQ6IDAsCiAgICAgICAgICBpbnN0YW5jZXM6IC0xCiAgICAgICAgfTsKICAgICAgICB2YXIgbGltaXRzID0gd3JhcExpbWl0cyhnbCwgZXh0ZW5zaW9ucyk7CiAgICAgICAgdmFyIGJ1ZmZlclN0YXRlID0gd3JhcEJ1ZmZlclN0YXRlKAogICAgICAgICAgZ2wsCiAgICAgICAgICBzdGF0cyQkMSwKICAgICAgICAgIGNvbmZpZywKICAgICAgICAgIGRlc3Ryb3lCdWZmZXIKICAgICAgICApOwogICAgICAgIHZhciBlbGVtZW50U3RhdGUgPSB3cmFwRWxlbWVudHNTdGF0ZShnbCwgZXh0ZW5zaW9ucywgYnVmZmVyU3RhdGUsIHN0YXRzJCQxKTsKICAgICAgICB2YXIgYXR0cmlidXRlU3RhdGUgPSB3cmFwQXR0cmlidXRlU3RhdGUoCiAgICAgICAgICBnbCwKICAgICAgICAgIGV4dGVuc2lvbnMsCiAgICAgICAgICBsaW1pdHMsCiAgICAgICAgICBzdGF0cyQkMSwKICAgICAgICAgIGJ1ZmZlclN0YXRlLAogICAgICAgICAgZWxlbWVudFN0YXRlLAogICAgICAgICAgZHJhd1N0YXRlCiAgICAgICAgKTsKICAgICAgICBmdW5jdGlvbiBkZXN0cm95QnVmZmVyKGJ1ZmZlcjIpIHsKICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGVTdGF0ZS5kZXN0cm95QnVmZmVyKGJ1ZmZlcjIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hhZGVyU3RhdGUgPSB3cmFwU2hhZGVyU3RhdGUoZ2wsIHN0cmluZ1N0b3JlLCBzdGF0cyQkMSwgY29uZmlnKTsKICAgICAgICB2YXIgdGV4dHVyZVN0YXRlID0gY3JlYXRlVGV4dHVyZVNldCgKICAgICAgICAgIGdsLAogICAgICAgICAgZXh0ZW5zaW9ucywKICAgICAgICAgIGxpbWl0cywKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjb3JlLnByb2NzLnBvbGwoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjb250ZXh0U3RhdGUsCiAgICAgICAgICBzdGF0cyQkMSwKICAgICAgICAgIGNvbmZpZwogICAgICAgICk7CiAgICAgICAgdmFyIHJlbmRlcmJ1ZmZlclN0YXRlID0gd3JhcFJlbmRlcmJ1ZmZlcnMoZ2wsIGV4dGVuc2lvbnMsIGxpbWl0cywgc3RhdHMkJDEsIGNvbmZpZyk7CiAgICAgICAgdmFyIGZyYW1lYnVmZmVyU3RhdGUgPSB3cmFwRkJPU3RhdGUoCiAgICAgICAgICBnbCwKICAgICAgICAgIGV4dGVuc2lvbnMsCiAgICAgICAgICBsaW1pdHMsCiAgICAgICAgICB0ZXh0dXJlU3RhdGUsCiAgICAgICAgICByZW5kZXJidWZmZXJTdGF0ZSwKICAgICAgICAgIHN0YXRzJCQxCiAgICAgICAgKTsKICAgICAgICB2YXIgY29yZSA9IHJlZ2xDb3JlKAogICAgICAgICAgZ2wsCiAgICAgICAgICBzdHJpbmdTdG9yZSwKICAgICAgICAgIGV4dGVuc2lvbnMsCiAgICAgICAgICBsaW1pdHMsCiAgICAgICAgICBidWZmZXJTdGF0ZSwKICAgICAgICAgIGVsZW1lbnRTdGF0ZSwKICAgICAgICAgIHRleHR1cmVTdGF0ZSwKICAgICAgICAgIGZyYW1lYnVmZmVyU3RhdGUsCiAgICAgICAgICB1bmlmb3JtU3RhdGUsCiAgICAgICAgICBhdHRyaWJ1dGVTdGF0ZSwKICAgICAgICAgIHNoYWRlclN0YXRlLAogICAgICAgICAgZHJhd1N0YXRlLAogICAgICAgICAgY29udGV4dFN0YXRlLAogICAgICAgICAgdGltZXIsCiAgICAgICAgICBjb25maWcKICAgICAgICApOwogICAgICAgIHZhciByZWFkUGl4ZWxzID0gd3JhcFJlYWRQaXhlbHMoCiAgICAgICAgICBnbCwKICAgICAgICAgIGZyYW1lYnVmZmVyU3RhdGUsCiAgICAgICAgICBjb3JlLnByb2NzLnBvbGwsCiAgICAgICAgICBjb250ZXh0U3RhdGUsCiAgICAgICAgICBnbEF0dHJpYnV0ZXMsCiAgICAgICAgICBleHRlbnNpb25zLAogICAgICAgICAgbGltaXRzCiAgICAgICAgKTsKICAgICAgICB2YXIgbmV4dFN0YXRlID0gY29yZS5uZXh0OwogICAgICAgIHZhciBjYW52YXMgPSBnbC5jYW52YXM7CiAgICAgICAgdmFyIHJhZkNhbGxiYWNrcyA9IFtdOwogICAgICAgIHZhciBsb3NzQ2FsbGJhY2tzID0gW107CiAgICAgICAgdmFyIHJlc3RvcmVDYWxsYmFja3MgPSBbXTsKICAgICAgICB2YXIgZGVzdHJveUNhbGxiYWNrcyA9IFtjb25maWcub25EZXN0cm95XTsKICAgICAgICB2YXIgYWN0aXZlUkFGID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVSQUYoKSB7CiAgICAgICAgICBpZiAocmFmQ2FsbGJhY2tzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBpZiAodGltZXIpIHsKICAgICAgICAgICAgICB0aW1lci51cGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RpdmVSQUYgPSBudWxsOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBhY3RpdmVSQUYgPSByYWYubmV4dChoYW5kbGVSQUYpOwogICAgICAgICAgcG9sbCgpOwogICAgICAgICAgZm9yICh2YXIgaSA9IHJhZkNhbGxiYWNrcy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICB2YXIgY2IgPSByYWZDYWxsYmFja3NbaV07CiAgICAgICAgICAgIGlmIChjYikgewogICAgICAgICAgICAgIGNiKGNvbnRleHRTdGF0ZSwgbnVsbCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGdsLmZsdXNoKCk7CiAgICAgICAgICBpZiAodGltZXIpIHsKICAgICAgICAgICAgdGltZXIudXBkYXRlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UkFGKCkgewogICAgICAgICAgaWYgKCFhY3RpdmVSQUYgJiYgcmFmQ2FsbGJhY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYWN0aXZlUkFGID0gcmFmLm5leHQoaGFuZGxlUkFGKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFJBRigpIHsKICAgICAgICAgIGlmIChhY3RpdmVSQUYpIHsKICAgICAgICAgICAgcmFmLmNhbmNlbChoYW5kbGVSQUYpOwogICAgICAgICAgICBhY3RpdmVSQUYgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVDb250ZXh0TG9zcyhldmVudCkgewogICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGNvbnRleHRMb3N0ID0gdHJ1ZTsKICAgICAgICAgIHN0b3BSQUYoKTsKICAgICAgICAgIGxvc3NDYWxsYmFja3MuZm9yRWFjaChmdW5jdGlvbihjYikgewogICAgICAgICAgICBjYigpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbnRleHRSZXN0b3JlZChldmVudCkgewogICAgICAgICAgZ2wuZ2V0RXJyb3IoKTsKICAgICAgICAgIGNvbnRleHRMb3N0ID0gZmFsc2U7CiAgICAgICAgICBleHRlbnNpb25TdGF0ZS5yZXN0b3JlKCk7CiAgICAgICAgICBzaGFkZXJTdGF0ZS5yZXN0b3JlKCk7CiAgICAgICAgICBidWZmZXJTdGF0ZS5yZXN0b3JlKCk7CiAgICAgICAgICB0ZXh0dXJlU3RhdGUucmVzdG9yZSgpOwogICAgICAgICAgcmVuZGVyYnVmZmVyU3RhdGUucmVzdG9yZSgpOwogICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5yZXN0b3JlKCk7CiAgICAgICAgICBhdHRyaWJ1dGVTdGF0ZS5yZXN0b3JlKCk7CiAgICAgICAgICBpZiAodGltZXIpIHsKICAgICAgICAgICAgdGltZXIucmVzdG9yZSgpOwogICAgICAgICAgfQogICAgICAgICAgY29yZS5wcm9jcy5yZWZyZXNoKCk7CiAgICAgICAgICBzdGFydFJBRigpOwogICAgICAgICAgcmVzdG9yZUNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICAgIGNiKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGNhbnZhcykgewogICAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoQ09OVEVYVF9MT1NUX0VWRU5ULCBoYW5kbGVDb250ZXh0TG9zcywgZmFsc2UpOwogICAgICAgICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoQ09OVEVYVF9SRVNUT1JFRF9FVkVOVCwgaGFuZGxlQ29udGV4dFJlc3RvcmVkLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICByYWZDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICAgIHN0b3BSQUYoKTsKICAgICAgICAgIGlmIChjYW52YXMpIHsKICAgICAgICAgICAgY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoQ09OVEVYVF9MT1NUX0VWRU5ULCBoYW5kbGVDb250ZXh0TG9zcyk7CiAgICAgICAgICAgIGNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKENPTlRFWFRfUkVTVE9SRURfRVZFTlQsIGhhbmRsZUNvbnRleHRSZXN0b3JlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBzaGFkZXJTdGF0ZS5jbGVhcigpOwogICAgICAgICAgZnJhbWVidWZmZXJTdGF0ZS5jbGVhcigpOwogICAgICAgICAgcmVuZGVyYnVmZmVyU3RhdGUuY2xlYXIoKTsKICAgICAgICAgIGF0dHJpYnV0ZVN0YXRlLmNsZWFyKCk7CiAgICAgICAgICB0ZXh0dXJlU3RhdGUuY2xlYXIoKTsKICAgICAgICAgIGVsZW1lbnRTdGF0ZS5jbGVhcigpOwogICAgICAgICAgYnVmZmVyU3RhdGUuY2xlYXIoKTsKICAgICAgICAgIGlmICh0aW1lcikgewogICAgICAgICAgICB0aW1lci5jbGVhcigpOwogICAgICAgICAgfQogICAgICAgICAgZGVzdHJveUNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICAgIGNiKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGlsZVByb2NlZHVyZShvcHRpb25zKSB7CiAgICAgICAgICBjaGVjayQxKCEhb3B0aW9ucywgImludmFsaWQgYXJncyB0byByZWdsKHsuLi59KSIpOwogICAgICAgICAgY2hlY2skMS50eXBlKG9wdGlvbnMsICJvYmplY3QiLCAiaW52YWxpZCBhcmdzIHRvIHJlZ2woey4uLn0pIik7CiAgICAgICAgICBmdW5jdGlvbiBmbGF0dGVuTmVzdGVkT3B0aW9ucyhvcHRpb25zMikgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZXh0ZW5kMih7fSwgb3B0aW9uczIpOwogICAgICAgICAgICBkZWxldGUgcmVzdWx0LnVuaWZvcm1zOwogICAgICAgICAgICBkZWxldGUgcmVzdWx0LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGRlbGV0ZSByZXN1bHQuY29udGV4dDsKICAgICAgICAgICAgZGVsZXRlIHJlc3VsdC52YW87CiAgICAgICAgICAgIGlmICgic3RlbmNpbCIgaW4gcmVzdWx0ICYmIHJlc3VsdC5zdGVuY2lsLm9wKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnN0ZW5jaWwub3BCYWNrID0gcmVzdWx0LnN0ZW5jaWwub3BGcm9udCA9IHJlc3VsdC5zdGVuY2lsLm9wOwogICAgICAgICAgICAgIGRlbGV0ZSByZXN1bHQuc3RlbmNpbC5vcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBtZXJnZShuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKG5hbWUgaW4gcmVzdWx0KSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSByZXN1bHRbbmFtZV07CiAgICAgICAgICAgICAgICBkZWxldGUgcmVzdWx0W25hbWVdOwogICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoY2hpbGQpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgICAgICByZXN1bHRbbmFtZSArICIuIiArIHByb3BdID0gY2hpbGRbcHJvcF07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWVyZ2UoImJsZW5kIik7CiAgICAgICAgICAgIG1lcmdlKCJkZXB0aCIpOwogICAgICAgICAgICBtZXJnZSgiY3VsbCIpOwogICAgICAgICAgICBtZXJnZSgic3RlbmNpbCIpOwogICAgICAgICAgICBtZXJnZSgicG9seWdvbk9mZnNldCIpOwogICAgICAgICAgICBtZXJnZSgic2Npc3NvciIpOwogICAgICAgICAgICBtZXJnZSgic2FtcGxlIik7CiAgICAgICAgICAgIGlmICgidmFvIiBpbiBvcHRpb25zMikgewogICAgICAgICAgICAgIHJlc3VsdC52YW8gPSBvcHRpb25zMi52YW87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNlcGFyYXRlRHluYW1pYyhvYmplY3QsIHVzZUFycmF5cykgewogICAgICAgICAgICB2YXIgc3RhdGljSXRlbXMgPSB7fTsKICAgICAgICAgICAgdmFyIGR5bmFtaWNJdGVtcyA9IHt9OwogICAgICAgICAgICBPYmplY3Qua2V5cyhvYmplY3QpLmZvckVhY2goZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgICAgdmFyIHZhbHVlID0gb2JqZWN0W29wdGlvbl07CiAgICAgICAgICAgICAgaWYgKGR5bmFtaWMuaXNEeW5hbWljKHZhbHVlKSkgewogICAgICAgICAgICAgICAgZHluYW1pY0l0ZW1zW29wdGlvbl0gPSBkeW5hbWljLnVuYm94KHZhbHVlLCBvcHRpb24pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlQXJyYXlzICYmIEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljLmlzRHluYW1pYyh2YWx1ZVtpXSkpIHsKICAgICAgICAgICAgICAgICAgICBkeW5hbWljSXRlbXNbb3B0aW9uXSA9IGR5bmFtaWMudW5ib3godmFsdWUsIG9wdGlvbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXRpY0l0ZW1zW29wdGlvbl0gPSB2YWx1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgZHluYW1pYzogZHluYW1pY0l0ZW1zLAogICAgICAgICAgICAgIHN0YXRpYzogc3RhdGljSXRlbXMKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250ZXh0ID0gc2VwYXJhdGVEeW5hbWljKG9wdGlvbnMuY29udGV4dCB8fCB7fSwgdHJ1ZSk7CiAgICAgICAgICB2YXIgdW5pZm9ybXMgPSBzZXBhcmF0ZUR5bmFtaWMob3B0aW9ucy51bmlmb3JtcyB8fCB7fSwgdHJ1ZSk7CiAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IHNlcGFyYXRlRHluYW1pYyhvcHRpb25zLmF0dHJpYnV0ZXMgfHwge30sIGZhbHNlKTsKICAgICAgICAgIHZhciBvcHRzID0gc2VwYXJhdGVEeW5hbWljKGZsYXR0ZW5OZXN0ZWRPcHRpb25zKG9wdGlvbnMpLCBmYWxzZSk7CiAgICAgICAgICB2YXIgc3RhdHMkJDEyID0gewogICAgICAgICAgICBncHVUaW1lOiAwLAogICAgICAgICAgICBjcHVUaW1lOiAwLAogICAgICAgICAgICBjb3VudDogMAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21waWxlZCA9IGNvcmUuY29tcGlsZShvcHRzLCBhdHRyaWJ1dGVzLCB1bmlmb3JtcywgY29udGV4dCwgc3RhdHMkJDEyKTsKICAgICAgICAgIHZhciBkcmF3ID0gY29tcGlsZWQuZHJhdzsKICAgICAgICAgIHZhciBiYXRjaCA9IGNvbXBpbGVkLmJhdGNoOwogICAgICAgICAgdmFyIHNjb3BlID0gY29tcGlsZWQuc2NvcGU7CiAgICAgICAgICB2YXIgRU1QVFlfQVJSQVkgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIHJlc2VydmUoY291bnQyKSB7CiAgICAgICAgICAgIHdoaWxlIChFTVBUWV9BUlJBWS5sZW5ndGggPCBjb3VudDIpIHsKICAgICAgICAgICAgICBFTVBUWV9BUlJBWS5wdXNoKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBFTVBUWV9BUlJBWTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJFR0xDb21tYW5kKGFyZ3MyLCBib2R5KSB7CiAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICBpZiAoY29udGV4dExvc3QpIHsKICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJjb250ZXh0IGxvc3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3MyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmNhbGwodGhpcywgbnVsbCwgYXJnczIsIDApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBib2R5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzMiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcmdzMjsgKytpKSB7CiAgICAgICAgICAgICAgICAgIHNjb3BlLmNhbGwodGhpcywgbnVsbCwgYm9keSwgaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGFyZ3MyKSkgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3MyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgIHNjb3BlLmNhbGwodGhpcywgYXJnczJbaV0sIGJvZHksIGkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuY2FsbCh0aGlzLCBhcmdzMiwgYm9keSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzMiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoYXJnczIgPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmF0Y2guY2FsbCh0aGlzLCByZXNlcnZlKGFyZ3MyIHwgMCksIGFyZ3MyIHwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoYXJnczIpKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3MyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGJhdGNoLmNhbGwodGhpcywgYXJnczIsIGFyZ3MyLmxlbmd0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBkcmF3LmNhbGwodGhpcywgYXJnczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXh0ZW5kMihSRUdMQ29tbWFuZCwgewogICAgICAgICAgICBzdGF0czogc3RhdHMkJDEyLAogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjb21waWxlZC5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgc2V0RkJPID0gZnJhbWVidWZmZXJTdGF0ZS5zZXRGQk8gPSBjb21waWxlUHJvY2VkdXJlKHsKICAgICAgICAgIGZyYW1lYnVmZmVyOiBkeW5hbWljLmRlZmluZS5jYWxsKG51bGwsIERZTl9QUk9QLCAiZnJhbWVidWZmZXIiKQogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGNsZWFySW1wbChfLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgY2xlYXJGbGFncyA9IDA7CiAgICAgICAgICBjb3JlLnByb2NzLnBvbGwoKTsKICAgICAgICAgIHZhciBjID0gb3B0aW9ucy5jb2xvcjsKICAgICAgICAgIGlmIChjKSB7CiAgICAgICAgICAgIGdsLmNsZWFyQ29sb3IoK2NbMF0gfHwgMCwgK2NbMV0gfHwgMCwgK2NbMl0gfHwgMCwgK2NbM10gfHwgMCk7CiAgICAgICAgICAgIGNsZWFyRmxhZ3MgfD0gR0xfQ09MT1JfQlVGRkVSX0JJVDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgiZGVwdGgiIGluIG9wdGlvbnMpIHsKICAgICAgICAgICAgZ2wuY2xlYXJEZXB0aCgrb3B0aW9ucy5kZXB0aCk7CiAgICAgICAgICAgIGNsZWFyRmxhZ3MgfD0gR0xfREVQVEhfQlVGRkVSX0JJVDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgic3RlbmNpbCIgaW4gb3B0aW9ucykgewogICAgICAgICAgICBnbC5jbGVhclN0ZW5jaWwob3B0aW9ucy5zdGVuY2lsIHwgMCk7CiAgICAgICAgICAgIGNsZWFyRmxhZ3MgfD0gR0xfU1RFTkNJTF9CVUZGRVJfQklUOwogICAgICAgICAgfQogICAgICAgICAgY2hlY2skMSghIWNsZWFyRmxhZ3MsICJjYWxsZWQgcmVnbC5jbGVhciB3aXRoIG5vIGJ1ZmZlciBzcGVjaWZpZWQiKTsKICAgICAgICAgIGdsLmNsZWFyKGNsZWFyRmxhZ3MpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhcihvcHRpb25zKSB7CiAgICAgICAgICBjaGVjayQxKAogICAgICAgICAgICB0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucywKICAgICAgICAgICAgInJlZ2wuY2xlYXIoKSB0YWtlcyBhbiBvYmplY3QgYXMgaW5wdXQiCiAgICAgICAgICApOwogICAgICAgICAgaWYgKCJmcmFtZWJ1ZmZlciIgaW4gb3B0aW9ucykgewogICAgICAgICAgICBpZiAob3B0aW9ucy5mcmFtZWJ1ZmZlciAmJiBvcHRpb25zLmZyYW1lYnVmZmVyX3JlZ2xUeXBlID09PSAiZnJhbWVidWZmZXJDdWJlIikgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgNjsgKytpKSB7CiAgICAgICAgICAgICAgICBzZXRGQk8oZXh0ZW5kMih7CiAgICAgICAgICAgICAgICAgIGZyYW1lYnVmZmVyOiBvcHRpb25zLmZyYW1lYnVmZmVyLmZhY2VzW2ldCiAgICAgICAgICAgICAgICB9LCBvcHRpb25zKSwgY2xlYXJJbXBsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0RkJPKG9wdGlvbnMsIGNsZWFySW1wbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNsZWFySW1wbChudWxsLCBvcHRpb25zKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnJhbWUoY2IpIHsKICAgICAgICAgIGNoZWNrJDEudHlwZShjYiwgImZ1bmN0aW9uIiwgInJlZ2wuZnJhbWUoKSBjYWxsYmFjayBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICAgIHJhZkNhbGxiYWNrcy5wdXNoKGNiKTsKICAgICAgICAgIGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICAgICAgdmFyIGkgPSBmaW5kMihyYWZDYWxsYmFja3MsIGNiKTsKICAgICAgICAgICAgY2hlY2skMShpID49IDAsICJjYW5ub3QgY2FuY2VsIGEgZnJhbWUgdHdpY2UiKTsKICAgICAgICAgICAgZnVuY3Rpb24gcGVuZGluZ0NhbmNlbCgpIHsKICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kMihyYWZDYWxsYmFja3MsIHBlbmRpbmdDYW5jZWwpOwogICAgICAgICAgICAgIHJhZkNhbGxiYWNrc1tpbmRleF0gPSByYWZDYWxsYmFja3NbcmFmQ2FsbGJhY2tzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgIHJhZkNhbGxiYWNrcy5sZW5ndGggLT0gMTsKICAgICAgICAgICAgICBpZiAocmFmQ2FsbGJhY2tzLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgICAgICAgICBzdG9wUkFGKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJhZkNhbGxiYWNrc1tpXSA9IHBlbmRpbmdDYW5jZWw7CiAgICAgICAgICB9CiAgICAgICAgICBzdGFydFJBRigpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY2FuY2VsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb2xsVmlld3BvcnQoKSB7CiAgICAgICAgICB2YXIgdmlld3BvcnQgPSBuZXh0U3RhdGUudmlld3BvcnQ7CiAgICAgICAgICB2YXIgc2Npc3NvckJveCA9IG5leHRTdGF0ZS5zY2lzc29yX2JveDsKICAgICAgICAgIHZpZXdwb3J0WzBdID0gdmlld3BvcnRbMV0gPSBzY2lzc29yQm94WzBdID0gc2Npc3NvckJveFsxXSA9IDA7CiAgICAgICAgICBjb250ZXh0U3RhdGUudmlld3BvcnRXaWR0aCA9IGNvbnRleHRTdGF0ZS5mcmFtZWJ1ZmZlcldpZHRoID0gY29udGV4dFN0YXRlLmRyYXdpbmdCdWZmZXJXaWR0aCA9IHZpZXdwb3J0WzJdID0gc2Npc3NvckJveFsyXSA9IGdsLmRyYXdpbmdCdWZmZXJXaWR0aDsKICAgICAgICAgIGNvbnRleHRTdGF0ZS52aWV3cG9ydEhlaWdodCA9IGNvbnRleHRTdGF0ZS5mcmFtZWJ1ZmZlckhlaWdodCA9IGNvbnRleHRTdGF0ZS5kcmF3aW5nQnVmZmVySGVpZ2h0ID0gdmlld3BvcnRbM10gPSBzY2lzc29yQm94WzNdID0gZ2wuZHJhd2luZ0J1ZmZlckhlaWdodDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgICAgIGNvbnRleHRTdGF0ZS50aWNrICs9IDE7CiAgICAgICAgICBjb250ZXh0U3RhdGUudGltZSA9IG5vdygpOwogICAgICAgICAgcG9sbFZpZXdwb3J0KCk7CiAgICAgICAgICBjb3JlLnByb2NzLnBvbGwoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVmcmVzaCgpIHsKICAgICAgICAgIHRleHR1cmVTdGF0ZS5yZWZyZXNoKCk7CiAgICAgICAgICBwb2xsVmlld3BvcnQoKTsKICAgICAgICAgIGNvcmUucHJvY3MucmVmcmVzaCgpOwogICAgICAgICAgaWYgKHRpbWVyKSB7CiAgICAgICAgICAgIHRpbWVyLnVwZGF0ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub3coKSB7CiAgICAgICAgICByZXR1cm4gKGNsb2NrKCkgLSBTVEFSVF9USU1FKSAvIDFlMzsKICAgICAgICB9CiAgICAgICAgcmVmcmVzaCgpOwogICAgICAgIGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50LCBjYWxsYmFjaykgewogICAgICAgICAgY2hlY2skMS50eXBlKGNhbGxiYWNrLCAiZnVuY3Rpb24iLCAibGlzdGVuZXIgY2FsbGJhY2sgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgICB2YXIgY2FsbGJhY2tzOwogICAgICAgICAgc3dpdGNoIChldmVudCkgewogICAgICAgICAgICBjYXNlICJmcmFtZSI6CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lKGNhbGxiYWNrKTsKICAgICAgICAgICAgY2FzZSAibG9zdCI6CiAgICAgICAgICAgICAgY2FsbGJhY2tzID0gbG9zc0NhbGxiYWNrczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAicmVzdG9yZSI6CiAgICAgICAgICAgICAgY2FsbGJhY2tzID0gcmVzdG9yZUNhbGxiYWNrczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGVzdHJveSI6CiAgICAgICAgICAgICAgY2FsbGJhY2tzID0gZGVzdHJveUNhbGxiYWNrczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBjaGVjayQxLnJhaXNlKCJpbnZhbGlkIGV2ZW50LCBtdXN0IGJlIG9uZSBvZiBmcmFtZSxsb3N0LHJlc3RvcmUsZGVzdHJveSIpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY2FuY2VsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tpXSA9PT0gY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2ldID0gY2FsbGJhY2tzW2NhbGxiYWNrcy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLnBvcCgpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgcmVnbCA9IGV4dGVuZDIoY29tcGlsZVByb2NlZHVyZSwgewogICAgICAgICAgLy8gQ2xlYXIgY3VycmVudCBGQk8KICAgICAgICAgIGNsZWFyLAogICAgICAgICAgLy8gU2hvcnQgY3V0cyBmb3IgZHluYW1pYyB2YXJpYWJsZXMKICAgICAgICAgIHByb3A6IGR5bmFtaWMuZGVmaW5lLmJpbmQobnVsbCwgRFlOX1BST1ApLAogICAgICAgICAgY29udGV4dDogZHluYW1pYy5kZWZpbmUuYmluZChudWxsLCBEWU5fQ09OVEVYVCksCiAgICAgICAgICB0aGlzOiBkeW5hbWljLmRlZmluZS5iaW5kKG51bGwsIERZTl9TVEFURSksCiAgICAgICAgICAvLyBleGVjdXRlcyBhbiBlbXB0eSBkcmF3IGNvbW1hbmQKICAgICAgICAgIGRyYXc6IGNvbXBpbGVQcm9jZWR1cmUoe30pLAogICAgICAgICAgLy8gUmVzb3VyY2VzCiAgICAgICAgICBidWZmZXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIGJ1ZmZlclN0YXRlLmNyZWF0ZShvcHRpb25zLCBHTF9BUlJBWV9CVUZGRVIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICB9LAogICAgICAgICAgZWxlbWVudHM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRTdGF0ZS5jcmVhdGUob3B0aW9ucywgZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIHRleHR1cmU6IHRleHR1cmVTdGF0ZS5jcmVhdGUyRCwKICAgICAgICAgIGN1YmU6IHRleHR1cmVTdGF0ZS5jcmVhdGVDdWJlLAogICAgICAgICAgcmVuZGVyYnVmZmVyOiByZW5kZXJidWZmZXJTdGF0ZS5jcmVhdGUsCiAgICAgICAgICBmcmFtZWJ1ZmZlcjogZnJhbWVidWZmZXJTdGF0ZS5jcmVhdGUsCiAgICAgICAgICBmcmFtZWJ1ZmZlckN1YmU6IGZyYW1lYnVmZmVyU3RhdGUuY3JlYXRlQ3ViZSwKICAgICAgICAgIHZhbzogYXR0cmlidXRlU3RhdGUuY3JlYXRlVkFPLAogICAgICAgICAgLy8gRXhwb3NlIGNvbnRleHQgYXR0cmlidXRlcwogICAgICAgICAgYXR0cmlidXRlczogZ2xBdHRyaWJ1dGVzLAogICAgICAgICAgLy8gRnJhbWUgcmVuZGVyaW5nCiAgICAgICAgICBmcmFtZSwKICAgICAgICAgIG9uOiBhZGRMaXN0ZW5lciwKICAgICAgICAgIC8vIFN5c3RlbSBsaW1pdHMKICAgICAgICAgIGxpbWl0cywKICAgICAgICAgIGhhc0V4dGVuc2lvbjogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICByZXR1cm4gbGltaXRzLmV4dGVuc2lvbnMuaW5kZXhPZihuYW1lLnRvTG93ZXJDYXNlKCkpID49IDA7CiAgICAgICAgICB9LAogICAgICAgICAgLy8gUmVhZCBwaXhlbHMKICAgICAgICAgIHJlYWQ6IHJlYWRQaXhlbHMsCiAgICAgICAgICAvLyBEZXN0cm95IHJlZ2wgYW5kIGFsbCBhc3NvY2lhdGVkIHJlc291cmNlcwogICAgICAgICAgZGVzdHJveSwKICAgICAgICAgIC8vIERpcmVjdCBHTCBzdGF0ZSBtYW5pcHVsYXRpb24KICAgICAgICAgIF9nbDogZ2wsCiAgICAgICAgICBfcmVmcmVzaDogcmVmcmVzaCwKICAgICAgICAgIHBvbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIGlmICh0aW1lcikgewogICAgICAgICAgICAgIHRpbWVyLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgLy8gQ3VycmVudCB0aW1lCiAgICAgICAgICBub3csCiAgICAgICAgICAvLyByZWdsIFN0YXRpc3RpY3MgSW5mb3JtYXRpb24KICAgICAgICAgIHN0YXRzOiBzdGF0cyQkMQogICAgICAgIH0pOwogICAgICAgIGNvbmZpZy5vbkRvbmUobnVsbCwgcmVnbCk7CiAgICAgICAgcmV0dXJuIHJlZ2w7CiAgICAgIH0KICAgICAgcmV0dXJuIHdyYXBSRUdMOwogICAgfSk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9AZmxla3NjaGFzL3V0aWxzL2Rpc3QvdXRpbHMuZXNtLmpzCnZhciBtYXggPSAodikgPT4gdi5yZWR1Y2UoKF9tYXgsIGEpID0+IGEgPiBfbWF4ID8gYSA6IF9tYXgsIC1JbmZpbml0eSk7CnZhciBtaW4gPSAodikgPT4gdi5yZWR1Y2UoKF9taW4sIGEpID0+IGEgPCBfbWluID8gYSA6IF9taW4sIEluZmluaXR5KTsKdmFyIGdldEQzRm9ybWF0U3BlY2lmaWVyID0gKGRvbWFpbikgPT4gewogIGNvbnN0IGV4dGVudCA9IGRvbWFpblsxXSAtIGRvbWFpblswXTsKICBpZiAoZXh0ZW50IDw9IDApIHJldHVybiAiLC4zfnIiOwogIGNvbnN0IGxvZzIgPSBNYXRoLmxvZzEwKGV4dGVudCk7CiAgY29uc3Qgc2lnbjIgPSBNYXRoLnNpZ24obG9nMik7CiAgY29uc3QgbnVtRGlnaXRzID0gTWF0aC5yb3VuZChNYXRoLmFicyhsb2cyKSArIE51bWJlci5pc0ludGVnZXIobG9nMikpOwogIGlmIChOdW1iZXIuaXNOYU4obnVtRGlnaXRzKSkgcmV0dXJuICIsLjN+ciI7CiAgaWYgKHNpZ24yIDw9IDApIHJldHVybiBgLiR7TWF0aC5tYXgoMywgbnVtRGlnaXRzICsgMSl9fmZgOwogIGNvbnN0IGxvZ01heCA9IE1hdGgubG9nMTAoTWF0aC5tYXgoZXh0ZW50LCBNYXRoLmFicyhkb21haW5bMV0pKSk7CiAgY29uc3QgbnVtRGlnaXRzTWF4ID0gTWF0aC5yb3VuZChNYXRoLmFicyhsb2dNYXgpICsgTnVtYmVyLmlzSW50ZWdlcihsb2dNYXgpKTsKICBpZiAobnVtRGlnaXRzTWF4ID4gNCkgcmV0dXJuICIuM35zIjsKICBpZiAoTnVtYmVyLmlzTmFOKG51bURpZ2l0c01heCkpIHJldHVybiAiLC4zfnIiOwogIHJldHVybiBgLC4ke01hdGgubWF4KDMsIE1hdGgubWF4KG51bURpZ2l0cywgbnVtRGlnaXRzTWF4KSl9fnJgOwp9Owp2YXIgZGVib3VuY2UgPSAoZm4sIHdhaXQpID0+IHsKICBsZXQgdGltZW91dDsKICBjb25zdCBkZWJvdW5jZWQgPSAoLi4uYXJncykgPT4gewogICAgY29uc3QgbGF0ZXIgPSAoKSA9PiB7CiAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICBmbiguLi5hcmdzKTsKICAgIH07CiAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgfTsKICBkZWJvdW5jZWQuY2FuY2VsID0gKCkgPT4gewogICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogIH07CiAgZGVib3VuY2VkLm5vdyA9ICguLi5hcmdzKSA9PiBmbiguLi5hcmdzKTsKICByZXR1cm4gZGVib3VuY2VkOwp9Owp2YXIgbmV4dEFuaW1hdGlvbkZyYW1lID0gKG4gPSAxKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogIGxldCBpID0gMDsKICBjb25zdCByYWYgPSAoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgaSsrOwogICAgaWYgKGkgPCBuKSByYWYoKTsKICAgIGVsc2UgcmVzb2x2ZSgpOwogIH0pOwogIHJhZigpOwp9KTsKdmFyIHRocm90dGxlQW5kRGVib3VuY2UgPSAoZm4sIHRocm90dGxlVGltZSwgZGVib3VuY2VUaW1lID0gbnVsbCkgPT4gewogIGxldCB0aW1lb3V0OwogIGxldCBibG9ja2VkQ2FsbHMgPSAwOwogIGRlYm91bmNlVGltZSA9IGRlYm91bmNlVGltZSA9PT0gbnVsbCA/IHRocm90dGxlVGltZSA6IGRlYm91bmNlVGltZTsKICBjb25zdCBkZWJvdW5jZWQgPSAoLi4uYXJncykgPT4gewogICAgY29uc3QgbGF0ZXIgPSAoKSA9PiB7CiAgICAgIGlmIChibG9ja2VkQ2FsbHMgPiAwKSB7CiAgICAgICAgZm4oLi4uYXJncyk7CiAgICAgICAgYmxvY2tlZENhbGxzID0gMDsKICAgICAgfQogICAgfTsKICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCBkZWJvdW5jZVRpbWUpOwogIH07CiAgbGV0IGlzV2FpdGluZyA9IGZhbHNlOwogIGNvbnN0IHRocm90dGxlZEFuZERlYm91bmNlZCA9ICguLi5hcmdzKSA9PiB7CiAgICBpZiAoIWlzV2FpdGluZykgewogICAgICBmbiguLi5hcmdzKTsKICAgICAgZGVib3VuY2VkKC4uLmFyZ3MpOwogICAgICBpc1dhaXRpbmcgPSB0cnVlOwogICAgICBibG9ja2VkQ2FsbHMgPSAwOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBpc1dhaXRpbmcgPSBmYWxzZTsKICAgICAgfSwgdGhyb3R0bGVUaW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGJsb2NrZWRDYWxscysrOwogICAgICBkZWJvdW5jZWQoLi4uYXJncyk7CiAgICB9CiAgfTsKICB0aHJvdHRsZWRBbmREZWJvdW5jZWQucmVzZXQgPSAoKSA9PiB7CiAgICBpc1dhaXRpbmcgPSBmYWxzZTsKICB9OwogIHRocm90dGxlZEFuZERlYm91bmNlZC5jYW5jZWwgPSAoKSA9PiB7CiAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgfTsKICB0aHJvdHRsZWRBbmREZWJvdW5jZWQubm93ID0gKC4uLmFyZ3MpID0+IGZuKC4uLmFyZ3MpOwogIHJldHVybiB0aHJvdHRsZWRBbmREZWJvdW5jZWQ7Cn07CgovLyBub2RlX21vZHVsZXMvcHViLXN1Yi1lcy9kaXN0L2luZGV4LmpzCnZhciBicm9hZGNhc3RDaGFubmVsID0gbmV3IHdpbmRvdy5Ccm9hZGNhc3RDaGFubmVsKCJwdWItc3ViLWVzIik7CnZhciBpc1N0cmluZyA9IChrZXkpID0+IHR5cGVvZiBrZXkgPT09ICJzdHJpbmciOwp2YXIgZ2V0RXZlbnROYW1lID0gKGV2ZW50TmFtZSwgY2FzZUluc2Vuc2l0aXZlKSA9PiB7CiAgaWYgKGlzU3RyaW5nKGV2ZW50TmFtZSkgJiYgY2FzZUluc2Vuc2l0aXZlKSB7CiAgICByZXR1cm4gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgfQogIHJldHVybiBldmVudE5hbWU7Cn07CnZhciBjcmVhdGVTdWJzY3JpYmUgPSAoc3RhY2ssIG9wdGlvbnMpID0+IChldmVudCwgaGFuZGxlciwgdGltZXMgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpID0+IHsKICBjb25zdCBlID0gZ2V0RXZlbnROYW1lKGV2ZW50LCBvcHRpb25zPy5jYXNlSW5zZW5zaXRpdmUpOwogIGNvbnN0IGxpc3RlbmVycyA9IHN0YWNrW2VdIHx8IFtdOwogIGxpc3RlbmVycy5wdXNoKHsKICAgIGhhbmRsZXIsCiAgICB0aW1lczogK3RpbWVzIHx8IE51bWJlci5QT1NJVElWRV9JTkZJTklUWQogIH0pOwogIHN0YWNrW2VdID0gbGlzdGVuZXJzOwogIHJldHVybiB7IGV2ZW50OiBlLCBoYW5kbGVyIH07Cn07CnZhciBpc1N1YnNjcmlwdGlvbiA9IChldmVudCkgPT4gdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IjsKZnVuY3Rpb24gY3JlYXRlVW5zdWJzY3JpYmUoc3RhY2ssIG9wdGlvbnMpIHsKICBmdW5jdGlvbiB1bnN1YnNjcmliZShldmVudE9yU3Vic2NyaXB0aW9uLCBoYW5kbGVyT3JVbmRlZmluZWQpIHsKICAgIGxldCBldmVudDsKICAgIGxldCBoYW5kbGVyOwogICAgaWYgKGlzU3Vic2NyaXB0aW9uKGV2ZW50T3JTdWJzY3JpcHRpb24pKSB7CiAgICAgIGhhbmRsZXIgPSBldmVudE9yU3Vic2NyaXB0aW9uLmhhbmRsZXI7CiAgICAgIGV2ZW50ID0gZXZlbnRPclN1YnNjcmlwdGlvbi5ldmVudDsKICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50ID0gZXZlbnRPclN1YnNjcmlwdGlvbjsKICAgICAgaGFuZGxlciA9IGhhbmRsZXJPclVuZGVmaW5lZDsKICAgIH0KICAgIGNvbnN0IGUgPSBnZXRFdmVudE5hbWUoZXZlbnQsIG9wdGlvbnM/LmNhc2VJbnNlbnNpdGl2ZSk7CiAgICBjb25zdCBsaXN0ZW5lcnMgPSBzdGFja1tlXTsKICAgIGlmICghbGlzdGVuZXJzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGlkeCA9IGxpc3RlbmVycy5maW5kSW5kZXgoKGxpc3RlbmVyKSA9PiBsaXN0ZW5lci5oYW5kbGVyID09PSBoYW5kbGVyKTsKICAgIGlmIChpZHggPT09IC0xIHx8IGlkeCA+PSBsaXN0ZW5lcnMubGVuZ3RoKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxpc3RlbmVycy5zcGxpY2UoaWR4LCAxKTsKICB9CiAgcmV0dXJuIHVuc3Vic2NyaWJlOwp9CnZhciBoYXNMaXN0ZW5lcnMgPSAobGlzdGVuZXJzKSA9PiB7CiAgcmV0dXJuIEJvb2xlYW4obGlzdGVuZXJzKTsKfTsKdmFyIGNyZWF0ZVB1Ymxpc2ggPSAoc3RhY2ssIG9wdGlvbnMpID0+IHsKICBjb25zdCB1bnN1YnNjcmliZSA9IGNyZWF0ZVVuc3Vic2NyaWJlKHN0YWNrKTsKICByZXR1cm4gKC4uLmFyZ3MpID0+IHsKICAgIGNvbnN0IFtldmVudCwgbmV3cywgY2FsbE9wdGlvbnNdID0gYXJnczsKICAgIGNvbnN0IGV2ZW50TmFtZSA9IGdldEV2ZW50TmFtZShldmVudCwgb3B0aW9ucz8uY2FzZUluc2Vuc2l0aXZlKTsKICAgIGNvbnN0IGxpc3RlbmVyc09yVW5kZWZpbmVkID0gc3RhY2tbZXZlbnROYW1lXTsKICAgIGlmICghaGFzTGlzdGVuZXJzKGxpc3RlbmVyc09yVW5kZWZpbmVkKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBsaXN0ZW5lcnMgPSBbLi4ubGlzdGVuZXJzT3JVbmRlZmluZWRdOwogICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiBsaXN0ZW5lcnMpIHsKICAgICAgaWYgKC0tbGlzdGVuZXIudGltZXMgPCAxKSB7CiAgICAgICAgdW5zdWJzY3JpYmUoZXZlbnROYW1lLCBsaXN0ZW5lci5oYW5kbGVyKTsKICAgICAgfQogICAgfQogICAgY29uc3QgaXNBc3luYyA9IGNhbGxPcHRpb25zPy5hc3luYyAhPT0gdm9pZCAwID8gY2FsbE9wdGlvbnMuYXN5bmMgOiBvcHRpb25zPy5hc3luYzsKICAgIGNvbnN0IGluZm9ybSA9ICgpID0+IHsKICAgICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiBsaXN0ZW5lcnMpIHsKICAgICAgICBsaXN0ZW5lci5oYW5kbGVyKG5ld3MpOwogICAgICB9CiAgICB9OwogICAgaWYgKGlzQXN5bmMpIHsKICAgICAgc2V0VGltZW91dChpbmZvcm0sIDApOwogICAgfSBlbHNlIHsKICAgICAgaW5mb3JtKCk7CiAgICB9CiAgICBpZiAob3B0aW9ucz8uaXNHbG9iYWwgJiYgIWNhbGxPcHRpb25zPy5pc05vR2xvYmFsQnJvYWRjYXN0KSB7CiAgICAgIHRyeSB7CiAgICAgICAgYnJvYWRjYXN0Q2hhbm5lbC5wb3N0TWVzc2FnZSh7IGV2ZW50OiBldmVudE5hbWUsIG5ld3MgfSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3IubmFtZSA9PT0gIkRhdGFDbG9uZUVycm9yIikgewogICAgICAgICAgY29uc29sZS53YXJuKGBDb3VsZCBub3QgYnJvYWRjYXN0ICcke2V2ZW50TmFtZS50b1N0cmluZygpfScgZ2xvYmFsbHkuIFBheWxvYWQgaXMgbm90IGNsb25hYmxlLmApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Owp9OwpmdW5jdGlvbiBrZXlzKG9iaikgewogIHJldHVybiBPYmplY3Qua2V5cyhvYmopOwp9CnZhciBjcmVhdGVDbGVhciA9IChzdGFjaykgPT4gKCkgPT4gewogIGZvciAoY29uc3QgZXZlbnQgb2Yga2V5cyhzdGFjaykpIHsKICAgIGRlbGV0ZSBzdGFja1tldmVudF07CiAgfQp9Owp2YXIgY3JlYXRlU3RhY2sgPSAoKSA9PiAoe30pOwp2YXIgY3JlYXRlUHViU3ViID0gKG9wdGlvbnMpID0+IHsKICBjb25zdCBhc3luYyA9IEJvb2xlYW4ob3B0aW9ucz8uYXN5bmMpOwogIGNvbnN0IGNhc2VJbnNlbnNpdGl2ZSA9IEJvb2xlYW4ob3B0aW9ucz8uY2FzZUluc2Vuc2l0aXZlKTsKICBjb25zdCBzdGFjayA9IG9wdGlvbnM/LnN0YWNrIHx8IGNyZWF0ZVN0YWNrKCk7CiAgcmV0dXJuIHsKICAgIHB1Ymxpc2g6IGNyZWF0ZVB1Ymxpc2goc3RhY2ssIHsgYXN5bmMsIGNhc2VJbnNlbnNpdGl2ZSB9KSwKICAgIHN1YnNjcmliZTogY3JlYXRlU3Vic2NyaWJlKHN0YWNrLCB7IGNhc2VJbnNlbnNpdGl2ZSB9KSwKICAgIHVuc3Vic2NyaWJlOiBjcmVhdGVVbnN1YnNjcmliZShzdGFjaywgeyBjYXNlSW5zZW5zaXRpdmUgfSksCiAgICBjbGVhcjogY3JlYXRlQ2xlYXIoc3RhY2spLAogICAgc3RhY2sKICB9Owp9Owp2YXIgZ2xvYmFsUHViU3ViU3RhY2sgPSBjcmVhdGVTdGFjaygpOwp2YXIgZ2xvYmFsUHViU3ViID0gewogIHB1Ymxpc2g6IGNyZWF0ZVB1Ymxpc2goZ2xvYmFsUHViU3ViU3RhY2ssIHsgaXNHbG9iYWw6IHRydWUgfSksCiAgc3Vic2NyaWJlOiBjcmVhdGVTdWJzY3JpYmUoZ2xvYmFsUHViU3ViU3RhY2spLAogIHVuc3Vic2NyaWJlOiBjcmVhdGVVbnN1YnNjcmliZShnbG9iYWxQdWJTdWJTdGFjayksCiAgY2xlYXI6IGNyZWF0ZUNsZWFyKGdsb2JhbFB1YlN1YlN0YWNrKSwKICBzdGFjazogZ2xvYmFsUHViU3ViU3RhY2sKfTsKYnJvYWRjYXN0Q2hhbm5lbC5vbm1lc3NhZ2UgPSAoeyBkYXRhOiB7IGV2ZW50LCBuZXdzIH0gfSkgPT4gZ2xvYmFsUHViU3ViLnB1Ymxpc2goZXZlbnQsIG5ld3MsIHsgaXNOb0dsb2JhbEJyb2FkY2FzdDogdHJ1ZSB9KTsKdmFyIGRpc3RfZGVmYXVsdCA9IGNyZWF0ZVB1YlN1YjsKCi8vIG5vZGVfbW9kdWxlcy9yZWdsLXNjYXR0ZXJwbG90L2Rpc3QvcmVnbC1zY2F0dGVycGxvdC5lc20uanMKdmFyIGltcG9ydF9yZWdsID0gX190b0VTTShyZXF1aXJlX3JlZ2woKSwgMSk7CnZhciBjdWJpY0luID0gKHQpID0+IHQgKiB0ICogdDsKdmFyIGN1YmljSW5PdXQgPSAodCkgPT4gdCA8IDAuNSA/IDQgKiB0ICogdCAqIHQgOiAodCAtIDEpICogKDIgKiB0IC0gMikgKiAoMiAqIHQgLSAyKSArIDE7CnZhciBjdWJpY091dCA9ICh0KSA9PiAtLXQgKiB0ICogdCArIDE7CnZhciBsaW5lYXIgPSAodCkgPT4gdDsKdmFyIHF1YWRJbiA9ICh0KSA9PiB0ICogdDsKdmFyIHF1YWRJbk91dCA9ICh0KSA9PiB0IDwgMC41ID8gMiAqIHQgKiB0IDogLTEgKyAoNCAtIDIgKiB0KSAqIHQ7CnZhciBxdWFkT3V0ID0gKHQpID0+IHQgKiAoMiAtIHQpOwp2YXIgaWRlbnRpdHkgPSAoeCkgPT4geDsKdmFyIGhhc1NhbWVFbGVtZW50cyA9IChhLCBiKSA9PiB7CiAgaWYgKGEgPT09IGIpIHJldHVybiB0cnVlOwogIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBmYWxzZTsKICBjb25zdCBhU2V0ID0gbmV3IFNldChhKTsKICBjb25zdCBiU2V0ID0gbmV3IFNldChiKTsKICBpZiAoYVNldC5zaXplICE9PSBiU2V0LnNpemUpIHJldHVybiBmYWxzZTsKICByZXR1cm4gYi5ldmVyeSgoZWxlbWVudCkgPT4gYVNldC5oYXMoZWxlbWVudCkpOwp9Owp2YXIgbDJOb3JtID0gKHYpID0+IE1hdGguc3FydCh2LnJlZHVjZSgoc3VtLCB4KSA9PiBzdW0gKyB4ICoqIDIsIDApKTsKdmFyIG1heCQxID0gKHYpID0+IHYucmVkdWNlKChfbWF4LCBhKSA9PiBhID4gX21heCA/IGEgOiBfbWF4LCAtSW5maW5pdHkpOwp2YXIgcmFuZ2VNYXAgPSAobGVuZ3RoLCBtYXBGbiA9ICh4KSA9PiB4KSA9PiB7CiAgY29uc3Qgb3V0ID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgb3V0LnB1c2gobWFwRm4oaSwgbGVuZ3RoKSk7CiAgfQogIHJldHVybiBvdXQ7Cn07CnZhciB1bmlvbkludGVnZXJzID0gKHYsIHcpID0+IHsKICBjb25zdCBhID0gW107CiAgdi5mb3JFYWNoKCh4KSA9PiB7CiAgICBhW3hdID0gdHJ1ZTsKICB9KTsKICB3LmZvckVhY2goKHgpID0+IHsKICAgIGFbeF0gPSB0cnVlOwogIH0pOwogIHJldHVybiBhLnJlZHVjZSgodW5pb24yLCB2YWx1ZSwgaSkgPT4gewogICAgaWYgKHZhbHVlKSB1bmlvbjIucHVzaChpKTsKICAgIHJldHVybiB1bmlvbjI7CiAgfSwgW10pOwp9Owp2YXIgYXNzaWduID0gKHRhcmdldCwgLi4uc291cmNlcykgPT4gewogIHNvdXJjZXMuZm9yRWFjaCgoc291cmNlKSA9PiB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE9iamVjdC5rZXlzKHNvdXJjZSkucmVkdWNlKChkZXNjcmlwdG9yczIsIGtleSkgPT4gewogICAgICBkZXNjcmlwdG9yczJba2V5XSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBrZXkpOwogICAgICByZXR1cm4gZGVzY3JpcHRvcnMyOwogICAgfSwge30pOwogICAgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhzb3VyY2UpLmZvckVhY2goKHN5bWJvbCkgPT4gewogICAgICBjb25zdCBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UsIHN5bWJvbCk7CiAgICAgIGlmIChkZXNjcmlwdG9yLmVudW1lcmFibGUpIHsKICAgICAgICBkZXNjcmlwdG9yc1tzeW1ib2xdID0gZGVzY3JpcHRvcjsKICAgICAgfQogICAgfSk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIGRlc2NyaXB0b3JzKTsKICB9KTsKICByZXR1cm4gdGFyZ2V0Owp9Owp2YXIgcGlwZSA9ICguLi5mbnMpID0+ICgKICAvKioKICAgKiBAcGFyYW0geyp9IHggLSBTb21lIHZhbHVlCiAgICogQHJldHVybiB7Kn0gT3V0cHV0IG9mIHRoZSBjb21wb3NlZCBmdW5jdGlvbgogICAqLwogICh4KSA9PiBmbnMucmVkdWNlKCh5LCBmKSA9PiBmKHkpLCB4KQopOwp2YXIgd2l0aENvbnN0cnVjdG9yID0gKGNvbnN0cnVjdG9yKSA9PiAoc2VsZjIpID0+IGFzc2lnbigKICB7CiAgICBfX3Byb3RvX186IHsKICAgICAgY29uc3RydWN0b3IKICAgIH0KICB9LAogIHNlbGYyCik7CnZhciB3aXRoU3RhdGljUHJvcGVydHkgPSAobmFtZSwgdmFsdWUpID0+IChzZWxmMikgPT4gYXNzaWduKHNlbGYyLCB7CiAgZ2V0IFtuYW1lXSgpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9Cn0pOwp2YXIgbDJQb2ludERpc3QgPSAoZnJvbVgsIGZyb21ZLCB0b1gsIHRvWSkgPT4gTWF0aC5zcXJ0KChmcm9tWCAtIHRvWCkgKiogMiArIChmcm9tWSAtIHRvWSkgKiogMik7CnZhciBjcmVhdGVXb3JrZXIkMSA9IChmbikgPT4gbmV3IFdvcmtlcigKICB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTCgKICAgIG5ldyBCbG9iKFtgKCR7Zm4udG9TdHJpbmcoKX0pKClgXSwgeyB0eXBlOiAidGV4dC9qYXZhc2NyaXB0IiB9KQogICkKKTsKdmFyIG5leHRBbmltYXRpb25GcmFtZTIgPSAobiA9IDEpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgbGV0IGkgPSAwOwogIGNvbnN0IHJhZiA9ICgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICBpKys7CiAgICBpZiAoaSA8IG4pIHJhZigpOwogICAgZWxzZSByZXNvbHZlKCk7CiAgfSk7CiAgcmFmKCk7Cn0pOwp2YXIgdGhyb3R0bGVBbmREZWJvdW5jZTIgPSAoZm4sIHRocm90dGxlVGltZSwgZGVib3VuY2VUaW1lID0gbnVsbCkgPT4gewogIGxldCB0aW1lb3V0OwogIGxldCBibG9ja2VkQ2FsbHMgPSAwOwogIGRlYm91bmNlVGltZSA9IGRlYm91bmNlVGltZSA9PT0gbnVsbCA/IHRocm90dGxlVGltZSA6IGRlYm91bmNlVGltZTsKICBjb25zdCBkZWJvdW5jZWQgPSAoLi4uYXJncykgPT4gewogICAgY29uc3QgbGF0ZXIgPSAoKSA9PiB7CiAgICAgIGlmIChibG9ja2VkQ2FsbHMgPiAwKSB7CiAgICAgICAgZm4oLi4uYXJncyk7CiAgICAgICAgYmxvY2tlZENhbGxzID0gMDsKICAgICAgfQogICAgfTsKICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCBkZWJvdW5jZVRpbWUpOwogIH07CiAgbGV0IGlzV2FpdGluZyA9IGZhbHNlOwogIGNvbnN0IHRocm90dGxlZEFuZERlYm91bmNlZCA9ICguLi5hcmdzKSA9PiB7CiAgICBpZiAoIWlzV2FpdGluZykgewogICAgICBmbiguLi5hcmdzKTsKICAgICAgZGVib3VuY2VkKC4uLmFyZ3MpOwogICAgICBpc1dhaXRpbmcgPSB0cnVlOwogICAgICBibG9ja2VkQ2FsbHMgPSAwOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBpc1dhaXRpbmcgPSBmYWxzZTsKICAgICAgfSwgdGhyb3R0bGVUaW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGJsb2NrZWRDYWxscysrOwogICAgICBkZWJvdW5jZWQoLi4uYXJncyk7CiAgICB9CiAgfTsKICB0aHJvdHRsZWRBbmREZWJvdW5jZWQucmVzZXQgPSAoKSA9PiB7CiAgICBpc1dhaXRpbmcgPSBmYWxzZTsKICB9OwogIHRocm90dGxlZEFuZERlYm91bmNlZC5jYW5jZWwgPSAoKSA9PiB7CiAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgfTsKICB0aHJvdHRsZWRBbmREZWJvdW5jZWQubm93ID0gKC4uLmFyZ3MpID0+IGZuKC4uLmFyZ3MpOwogIHJldHVybiB0aHJvdHRsZWRBbmREZWJvdW5jZWQ7Cn07CnZhciBFUFNJTE9OID0gMWUtNjsKdmFyIEFSUkFZX1RZUEUgPSB0eXBlb2YgRmxvYXQzMkFycmF5ICE9PSAidW5kZWZpbmVkIiA/IEZsb2F0MzJBcnJheSA6IEFycmF5OwppZiAoIU1hdGguaHlwb3QpIE1hdGguaHlwb3QgPSBmdW5jdGlvbigpIHsKICB2YXIgeSA9IDAsIGkgPSBhcmd1bWVudHMubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIHkgKz0gYXJndW1lbnRzW2ldICogYXJndW1lbnRzW2ldOwogIH0KICByZXR1cm4gTWF0aC5zcXJ0KHkpOwp9OwpmdW5jdGlvbiBjcmVhdGUkMigpIHsKICB2YXIgb3V0ID0gbmV3IEFSUkFZX1RZUEUoMTYpOwogIGlmIChBUlJBWV9UWVBFICE9IEZsb2F0MzJBcnJheSkgewogICAgb3V0WzFdID0gMDsKICAgIG91dFsyXSA9IDA7CiAgICBvdXRbM10gPSAwOwogICAgb3V0WzRdID0gMDsKICAgIG91dFs2XSA9IDA7CiAgICBvdXRbN10gPSAwOwogICAgb3V0WzhdID0gMDsKICAgIG91dFs5XSA9IDA7CiAgICBvdXRbMTFdID0gMDsKICAgIG91dFsxMl0gPSAwOwogICAgb3V0WzEzXSA9IDA7CiAgICBvdXRbMTRdID0gMDsKICB9CiAgb3V0WzBdID0gMTsKICBvdXRbNV0gPSAxOwogIG91dFsxMF0gPSAxOwogIG91dFsxNV0gPSAxOwogIHJldHVybiBvdXQ7Cn0KZnVuY3Rpb24gY2xvbmUoYSkgewogIHZhciBvdXQgPSBuZXcgQVJSQVlfVFlQRSgxNik7CiAgb3V0WzBdID0gYVswXTsKICBvdXRbMV0gPSBhWzFdOwogIG91dFsyXSA9IGFbMl07CiAgb3V0WzNdID0gYVszXTsKICBvdXRbNF0gPSBhWzRdOwogIG91dFs1XSA9IGFbNV07CiAgb3V0WzZdID0gYVs2XTsKICBvdXRbN10gPSBhWzddOwogIG91dFs4XSA9IGFbOF07CiAgb3V0WzldID0gYVs5XTsKICBvdXRbMTBdID0gYVsxMF07CiAgb3V0WzExXSA9IGFbMTFdOwogIG91dFsxMl0gPSBhWzEyXTsKICBvdXRbMTNdID0gYVsxM107CiAgb3V0WzE0XSA9IGFbMTRdOwogIG91dFsxNV0gPSBhWzE1XTsKICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIGludmVydChvdXQsIGEpIHsKICB2YXIgYTAwID0gYVswXSwgYTAxID0gYVsxXSwgYTAyID0gYVsyXSwgYTAzID0gYVszXTsKICB2YXIgYTEwID0gYVs0XSwgYTExID0gYVs1XSwgYTEyID0gYVs2XSwgYTEzID0gYVs3XTsKICB2YXIgYTIwID0gYVs4XSwgYTIxID0gYVs5XSwgYTIyID0gYVsxMF0sIGEyMyA9IGFbMTFdOwogIHZhciBhMzAgPSBhWzEyXSwgYTMxID0gYVsxM10sIGEzMiA9IGFbMTRdLCBhMzMgPSBhWzE1XTsKICB2YXIgYjAwID0gYTAwICogYTExIC0gYTAxICogYTEwOwogIHZhciBiMDEgPSBhMDAgKiBhMTIgLSBhMDIgKiBhMTA7CiAgdmFyIGIwMiA9IGEwMCAqIGExMyAtIGEwMyAqIGExMDsKICB2YXIgYjAzID0gYTAxICogYTEyIC0gYTAyICogYTExOwogIHZhciBiMDQgPSBhMDEgKiBhMTMgLSBhMDMgKiBhMTE7CiAgdmFyIGIwNSA9IGEwMiAqIGExMyAtIGEwMyAqIGExMjsKICB2YXIgYjA2ID0gYTIwICogYTMxIC0gYTIxICogYTMwOwogIHZhciBiMDcgPSBhMjAgKiBhMzIgLSBhMjIgKiBhMzA7CiAgdmFyIGIwOCA9IGEyMCAqIGEzMyAtIGEyMyAqIGEzMDsKICB2YXIgYjA5ID0gYTIxICogYTMyIC0gYTIyICogYTMxOwogIHZhciBiMTAgPSBhMjEgKiBhMzMgLSBhMjMgKiBhMzE7CiAgdmFyIGIxMSA9IGEyMiAqIGEzMyAtIGEyMyAqIGEzMjsKICB2YXIgZGV0ID0gYjAwICogYjExIC0gYjAxICogYjEwICsgYjAyICogYjA5ICsgYjAzICogYjA4IC0gYjA0ICogYjA3ICsgYjA1ICogYjA2OwogIGlmICghZGV0KSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZGV0ID0gMSAvIGRldDsKICBvdXRbMF0gPSAoYTExICogYjExIC0gYTEyICogYjEwICsgYTEzICogYjA5KSAqIGRldDsKICBvdXRbMV0gPSAoYTAyICogYjEwIC0gYTAxICogYjExIC0gYTAzICogYjA5KSAqIGRldDsKICBvdXRbMl0gPSAoYTMxICogYjA1IC0gYTMyICogYjA0ICsgYTMzICogYjAzKSAqIGRldDsKICBvdXRbM10gPSAoYTIyICogYjA0IC0gYTIxICogYjA1IC0gYTIzICogYjAzKSAqIGRldDsKICBvdXRbNF0gPSAoYTEyICogYjA4IC0gYTEwICogYjExIC0gYTEzICogYjA3KSAqIGRldDsKICBvdXRbNV0gPSAoYTAwICogYjExIC0gYTAyICogYjA4ICsgYTAzICogYjA3KSAqIGRldDsKICBvdXRbNl0gPSAoYTMyICogYjAyIC0gYTMwICogYjA1IC0gYTMzICogYjAxKSAqIGRldDsKICBvdXRbN10gPSAoYTIwICogYjA1IC0gYTIyICogYjAyICsgYTIzICogYjAxKSAqIGRldDsKICBvdXRbOF0gPSAoYTEwICogYjEwIC0gYTExICogYjA4ICsgYTEzICogYjA2KSAqIGRldDsKICBvdXRbOV0gPSAoYTAxICogYjA4IC0gYTAwICogYjEwIC0gYTAzICogYjA2KSAqIGRldDsKICBvdXRbMTBdID0gKGEzMCAqIGIwNCAtIGEzMSAqIGIwMiArIGEzMyAqIGIwMCkgKiBkZXQ7CiAgb3V0WzExXSA9IChhMjEgKiBiMDIgLSBhMjAgKiBiMDQgLSBhMjMgKiBiMDApICogZGV0OwogIG91dFsxMl0gPSAoYTExICogYjA3IC0gYTEwICogYjA5IC0gYTEyICogYjA2KSAqIGRldDsKICBvdXRbMTNdID0gKGEwMCAqIGIwOSAtIGEwMSAqIGIwNyArIGEwMiAqIGIwNikgKiBkZXQ7CiAgb3V0WzE0XSA9IChhMzEgKiBiMDEgLSBhMzAgKiBiMDMgLSBhMzIgKiBiMDApICogZGV0OwogIG91dFsxNV0gPSAoYTIwICogYjAzIC0gYTIxICogYjAxICsgYTIyICogYjAwKSAqIGRldDsKICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIG11bHRpcGx5KG91dCwgYSwgYikgewogIHZhciBhMDAgPSBhWzBdLCBhMDEgPSBhWzFdLCBhMDIgPSBhWzJdLCBhMDMgPSBhWzNdOwogIHZhciBhMTAgPSBhWzRdLCBhMTEgPSBhWzVdLCBhMTIgPSBhWzZdLCBhMTMgPSBhWzddOwogIHZhciBhMjAgPSBhWzhdLCBhMjEgPSBhWzldLCBhMjIgPSBhWzEwXSwgYTIzID0gYVsxMV07CiAgdmFyIGEzMCA9IGFbMTJdLCBhMzEgPSBhWzEzXSwgYTMyID0gYVsxNF0sIGEzMyA9IGFbMTVdOwogIHZhciBiMCA9IGJbMF0sIGIxID0gYlsxXSwgYjIgPSBiWzJdLCBiMyA9IGJbM107CiAgb3V0WzBdID0gYjAgKiBhMDAgKyBiMSAqIGExMCArIGIyICogYTIwICsgYjMgKiBhMzA7CiAgb3V0WzFdID0gYjAgKiBhMDEgKyBiMSAqIGExMSArIGIyICogYTIxICsgYjMgKiBhMzE7CiAgb3V0WzJdID0gYjAgKiBhMDIgKyBiMSAqIGExMiArIGIyICogYTIyICsgYjMgKiBhMzI7CiAgb3V0WzNdID0gYjAgKiBhMDMgKyBiMSAqIGExMyArIGIyICogYTIzICsgYjMgKiBhMzM7CiAgYjAgPSBiWzRdOwogIGIxID0gYls1XTsKICBiMiA9IGJbNl07CiAgYjMgPSBiWzddOwogIG91dFs0XSA9IGIwICogYTAwICsgYjEgKiBhMTAgKyBiMiAqIGEyMCArIGIzICogYTMwOwogIG91dFs1XSA9IGIwICogYTAxICsgYjEgKiBhMTEgKyBiMiAqIGEyMSArIGIzICogYTMxOwogIG91dFs2XSA9IGIwICogYTAyICsgYjEgKiBhMTIgKyBiMiAqIGEyMiArIGIzICogYTMyOwogIG91dFs3XSA9IGIwICogYTAzICsgYjEgKiBhMTMgKyBiMiAqIGEyMyArIGIzICogYTMzOwogIGIwID0gYls4XTsKICBiMSA9IGJbOV07CiAgYjIgPSBiWzEwXTsKICBiMyA9IGJbMTFdOwogIG91dFs4XSA9IGIwICogYTAwICsgYjEgKiBhMTAgKyBiMiAqIGEyMCArIGIzICogYTMwOwogIG91dFs5XSA9IGIwICogYTAxICsgYjEgKiBhMTEgKyBiMiAqIGEyMSArIGIzICogYTMxOwogIG91dFsxMF0gPSBiMCAqIGEwMiArIGIxICogYTEyICsgYjIgKiBhMjIgKyBiMyAqIGEzMjsKICBvdXRbMTFdID0gYjAgKiBhMDMgKyBiMSAqIGExMyArIGIyICogYTIzICsgYjMgKiBhMzM7CiAgYjAgPSBiWzEyXTsKICBiMSA9IGJbMTNdOwogIGIyID0gYlsxNF07CiAgYjMgPSBiWzE1XTsKICBvdXRbMTJdID0gYjAgKiBhMDAgKyBiMSAqIGExMCArIGIyICogYTIwICsgYjMgKiBhMzA7CiAgb3V0WzEzXSA9IGIwICogYTAxICsgYjEgKiBhMTEgKyBiMiAqIGEyMSArIGIzICogYTMxOwogIG91dFsxNF0gPSBiMCAqIGEwMiArIGIxICogYTEyICsgYjIgKiBhMjIgKyBiMyAqIGEzMjsKICBvdXRbMTVdID0gYjAgKiBhMDMgKyBiMSAqIGExMyArIGIyICogYTIzICsgYjMgKiBhMzM7CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBmcm9tVHJhbnNsYXRpb24ob3V0LCB2KSB7CiAgb3V0WzBdID0gMTsKICBvdXRbMV0gPSAwOwogIG91dFsyXSA9IDA7CiAgb3V0WzNdID0gMDsKICBvdXRbNF0gPSAwOwogIG91dFs1XSA9IDE7CiAgb3V0WzZdID0gMDsKICBvdXRbN10gPSAwOwogIG91dFs4XSA9IDA7CiAgb3V0WzldID0gMDsKICBvdXRbMTBdID0gMTsKICBvdXRbMTFdID0gMDsKICBvdXRbMTJdID0gdlswXTsKICBvdXRbMTNdID0gdlsxXTsKICBvdXRbMTRdID0gdlsyXTsKICBvdXRbMTVdID0gMTsKICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIGZyb21TY2FsaW5nKG91dCwgdikgewogIG91dFswXSA9IHZbMF07CiAgb3V0WzFdID0gMDsKICBvdXRbMl0gPSAwOwogIG91dFszXSA9IDA7CiAgb3V0WzRdID0gMDsKICBvdXRbNV0gPSB2WzFdOwogIG91dFs2XSA9IDA7CiAgb3V0WzddID0gMDsKICBvdXRbOF0gPSAwOwogIG91dFs5XSA9IDA7CiAgb3V0WzEwXSA9IHZbMl07CiAgb3V0WzExXSA9IDA7CiAgb3V0WzEyXSA9IDA7CiAgb3V0WzEzXSA9IDA7CiAgb3V0WzE0XSA9IDA7CiAgb3V0WzE1XSA9IDE7CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBmcm9tUm90YXRpb24ob3V0LCByYWQsIGF4aXMyKSB7CiAgdmFyIHggPSBheGlzMlswXSwgeSA9IGF4aXMyWzFdLCB6ID0gYXhpczJbMl07CiAgdmFyIGxlbiA9IE1hdGguaHlwb3QoeCwgeSwgeik7CiAgdmFyIHMsIGMsIHQ7CiAgaWYgKGxlbiA8IEVQU0lMT04pIHsKICAgIHJldHVybiBudWxsOwogIH0KICBsZW4gPSAxIC8gbGVuOwogIHggKj0gbGVuOwogIHkgKj0gbGVuOwogIHogKj0gbGVuOwogIHMgPSBNYXRoLnNpbihyYWQpOwogIGMgPSBNYXRoLmNvcyhyYWQpOwogIHQgPSAxIC0gYzsKICBvdXRbMF0gPSB4ICogeCAqIHQgKyBjOwogIG91dFsxXSA9IHkgKiB4ICogdCArIHogKiBzOwogIG91dFsyXSA9IHogKiB4ICogdCAtIHkgKiBzOwogIG91dFszXSA9IDA7CiAgb3V0WzRdID0geCAqIHkgKiB0IC0geiAqIHM7CiAgb3V0WzVdID0geSAqIHkgKiB0ICsgYzsKICBvdXRbNl0gPSB6ICogeSAqIHQgKyB4ICogczsKICBvdXRbN10gPSAwOwogIG91dFs4XSA9IHggKiB6ICogdCArIHkgKiBzOwogIG91dFs5XSA9IHkgKiB6ICogdCAtIHggKiBzOwogIG91dFsxMF0gPSB6ICogeiAqIHQgKyBjOwogIG91dFsxMV0gPSAwOwogIG91dFsxMl0gPSAwOwogIG91dFsxM10gPSAwOwogIG91dFsxNF0gPSAwOwogIG91dFsxNV0gPSAxOwogIHJldHVybiBvdXQ7Cn0KZnVuY3Rpb24gZ2V0VHJhbnNsYXRpb24ob3V0LCBtYXQpIHsKICBvdXRbMF0gPSBtYXRbMTJdOwogIG91dFsxXSA9IG1hdFsxM107CiAgb3V0WzJdID0gbWF0WzE0XTsKICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIGdldFNjYWxpbmcob3V0LCBtYXQpIHsKICB2YXIgbTExID0gbWF0WzBdOwogIHZhciBtMTIgPSBtYXRbMV07CiAgdmFyIG0xMyA9IG1hdFsyXTsKICB2YXIgbTIxID0gbWF0WzRdOwogIHZhciBtMjIgPSBtYXRbNV07CiAgdmFyIG0yMyA9IG1hdFs2XTsKICB2YXIgbTMxID0gbWF0WzhdOwogIHZhciBtMzIgPSBtYXRbOV07CiAgdmFyIG0zMyA9IG1hdFsxMF07CiAgb3V0WzBdID0gTWF0aC5oeXBvdChtMTEsIG0xMiwgbTEzKTsKICBvdXRbMV0gPSBNYXRoLmh5cG90KG0yMSwgbTIyLCBtMjMpOwogIG91dFsyXSA9IE1hdGguaHlwb3QobTMxLCBtMzIsIG0zMyk7CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBjcmVhdGUkMSgpIHsKICB2YXIgb3V0ID0gbmV3IEFSUkFZX1RZUEUoNCk7CiAgaWYgKEFSUkFZX1RZUEUgIT0gRmxvYXQzMkFycmF5KSB7CiAgICBvdXRbMF0gPSAwOwogICAgb3V0WzFdID0gMDsKICAgIG91dFsyXSA9IDA7CiAgICBvdXRbM10gPSAwOwogIH0KICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybU1hdDQob3V0LCBhLCBtKSB7CiAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl0sIHcgPSBhWzNdOwogIG91dFswXSA9IG1bMF0gKiB4ICsgbVs0XSAqIHkgKyBtWzhdICogeiArIG1bMTJdICogdzsKICBvdXRbMV0gPSBtWzFdICogeCArIG1bNV0gKiB5ICsgbVs5XSAqIHogKyBtWzEzXSAqIHc7CiAgb3V0WzJdID0gbVsyXSAqIHggKyBtWzZdICogeSArIG1bMTBdICogeiArIG1bMTRdICogdzsKICBvdXRbM10gPSBtWzNdICogeCArIG1bN10gKiB5ICsgbVsxMV0gKiB6ICsgbVsxNV0gKiB3OwogIHJldHVybiBvdXQ7Cn0KKGZ1bmN0aW9uKCkgewogIHZhciB2ZWMgPSBjcmVhdGUkMSgpOwogIHJldHVybiBmdW5jdGlvbihhLCBzdHJpZGUsIG9mZnNldCwgY291bnQyLCBmbiwgYXJnKSB7CiAgICB2YXIgaSwgbDsKICAgIGlmICghc3RyaWRlKSB7CiAgICAgIHN0cmlkZSA9IDQ7CiAgICB9CiAgICBpZiAoIW9mZnNldCkgewogICAgICBvZmZzZXQgPSAwOwogICAgfQogICAgaWYgKGNvdW50MikgewogICAgICBsID0gTWF0aC5taW4oY291bnQyICogc3RyaWRlICsgb2Zmc2V0LCBhLmxlbmd0aCk7CiAgICB9IGVsc2UgewogICAgICBsID0gYS5sZW5ndGg7CiAgICB9CiAgICBmb3IgKGkgPSBvZmZzZXQ7IGkgPCBsOyBpICs9IHN0cmlkZSkgewogICAgICB2ZWNbMF0gPSBhW2ldOwogICAgICB2ZWNbMV0gPSBhW2kgKyAxXTsKICAgICAgdmVjWzJdID0gYVtpICsgMl07CiAgICAgIHZlY1szXSA9IGFbaSArIDNdOwogICAgICBmbih2ZWMsIHZlYywgYXJnKTsKICAgICAgYVtpXSA9IHZlY1swXTsKICAgICAgYVtpICsgMV0gPSB2ZWNbMV07CiAgICAgIGFbaSArIDJdID0gdmVjWzJdOwogICAgICBhW2kgKyAzXSA9IHZlY1szXTsKICAgIH0KICAgIHJldHVybiBhOwogIH07Cn0pKCk7CmZ1bmN0aW9uIGNyZWF0ZSgpIHsKICB2YXIgb3V0ID0gbmV3IEFSUkFZX1RZUEUoMik7CiAgaWYgKEFSUkFZX1RZUEUgIT0gRmxvYXQzMkFycmF5KSB7CiAgICBvdXRbMF0gPSAwOwogICAgb3V0WzFdID0gMDsKICB9CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBhbmdsZShhLCBiKSB7CiAgdmFyIHgxID0gYVswXSwgeTEgPSBhWzFdLCB4MiA9IGJbMF0sIHkyID0gYlsxXSwgbWFnID0gTWF0aC5zcXJ0KHgxICogeDEgKyB5MSAqIHkxKSAqIE1hdGguc3FydCh4MiAqIHgyICsgeTIgKiB5MiksIGNvc2luZSA9IG1hZyAmJiAoeDEgKiB4MiArIHkxICogeTIpIC8gbWFnOwogIHJldHVybiBNYXRoLmFjb3MoTWF0aC5taW4oTWF0aC5tYXgoY29zaW5lLCAtMSksIDEpKTsKfQooZnVuY3Rpb24oKSB7CiAgdmFyIHZlYyA9IGNyZWF0ZSgpOwogIHJldHVybiBmdW5jdGlvbihhLCBzdHJpZGUsIG9mZnNldCwgY291bnQyLCBmbiwgYXJnKSB7CiAgICB2YXIgaSwgbDsKICAgIGlmICghc3RyaWRlKSB7CiAgICAgIHN0cmlkZSA9IDI7CiAgICB9CiAgICBpZiAoIW9mZnNldCkgewogICAgICBvZmZzZXQgPSAwOwogICAgfQogICAgaWYgKGNvdW50MikgewogICAgICBsID0gTWF0aC5taW4oY291bnQyICogc3RyaWRlICsgb2Zmc2V0LCBhLmxlbmd0aCk7CiAgICB9IGVsc2UgewogICAgICBsID0gYS5sZW5ndGg7CiAgICB9CiAgICBmb3IgKGkgPSBvZmZzZXQ7IGkgPCBsOyBpICs9IHN0cmlkZSkgewogICAgICB2ZWNbMF0gPSBhW2ldOwogICAgICB2ZWNbMV0gPSBhW2kgKyAxXTsKICAgICAgZm4odmVjLCB2ZWMsIGFyZyk7CiAgICAgIGFbaV0gPSB2ZWNbMF07CiAgICAgIGFbaSArIDFdID0gdmVjWzFdOwogICAgfQogICAgcmV0dXJuIGE7CiAgfTsKfSkoKTsKdmFyIGNyZWF0ZUNhbWVyYSA9IChpbml0VGFyZ2V0ID0gWzAsIDBdLCBpbml0RGlzdGFuY2UgPSAxLCBpbml0Um90YXRpb24gPSAwLCBpbml0Vmlld0NlbnRlciA9IFswLCAwXSwgaW5pdFNjYWxlQm91bmRzID0gWwogIFswLCBJbmZpbml0eV0sCiAgWzAsIEluZmluaXR5XQpdLCBpbml0VHJhbnNsYXRpb25Cb3VuZHMgPSBbCiAgWy1JbmZpbml0eSwgSW5maW5pdHldLAogIFstSW5maW5pdHksIEluZmluaXR5XQpdKSA9PiB7CiAgY29uc3Qgc2NyYXRjaDAgPSBuZXcgRmxvYXQzMkFycmF5KDE2KTsKICBjb25zdCBzY3JhdGNoMSA9IG5ldyBGbG9hdDMyQXJyYXkoMTYpOwogIGNvbnN0IHNjcmF0Y2gyID0gbmV3IEZsb2F0MzJBcnJheSgxNik7CiAgbGV0IHZpZXcgPSBjcmVhdGUkMigpOwogIGxldCB2aWV3Q2VudGVyID0gWy4uLmluaXRWaWV3Q2VudGVyLnNsaWNlKDAsIDIpLCAwLCAxXTsKICBjb25zdCBzY2FsZVhCb3VuZHMgPSBBcnJheS5pc0FycmF5KGluaXRTY2FsZUJvdW5kc1swXSkgPyBbLi4uaW5pdFNjYWxlQm91bmRzWzBdXSA6IFsuLi5pbml0U2NhbGVCb3VuZHNdOwogIGNvbnN0IHNjYWxlWUJvdW5kcyA9IEFycmF5LmlzQXJyYXkoaW5pdFNjYWxlQm91bmRzWzBdKSA/IFsuLi5pbml0U2NhbGVCb3VuZHNbMV1dIDogWy4uLmluaXRTY2FsZUJvdW5kc107CiAgY29uc3QgdHJhbnNsYXRpb25YQm91bmRzID0gQXJyYXkuaXNBcnJheShpbml0VHJhbnNsYXRpb25Cb3VuZHNbMF0pID8gWy4uLmluaXRUcmFuc2xhdGlvbkJvdW5kc1swXV0gOiBbLi4uaW5pdFRyYW5zbGF0aW9uQm91bmRzXTsKICBjb25zdCB0cmFuc2xhdGlvbllCb3VuZHMgPSBBcnJheS5pc0FycmF5KGluaXRUcmFuc2xhdGlvbkJvdW5kc1swXSkgPyBbLi4uaW5pdFRyYW5zbGF0aW9uQm91bmRzWzFdXSA6IFsuLi5pbml0VHJhbnNsYXRpb25Cb3VuZHNdOwogIGNvbnN0IGdldFNjYWxpbmckMSA9ICgpID0+IGdldFNjYWxpbmcoc2NyYXRjaDAsIHZpZXcpLnNsaWNlKDAsIDIpOwogIGNvbnN0IGdldE1pblNjYWxpbmcgPSAoKSA9PiB7CiAgICBjb25zdCBzY2FsaW5nID0gZ2V0U2NhbGluZyQxKCk7CiAgICByZXR1cm4gTWF0aC5taW4oc2NhbGluZ1swXSwgc2NhbGluZ1sxXSk7CiAgfTsKICBjb25zdCBnZXRNYXhTY2FsaW5nID0gKCkgPT4gewogICAgY29uc3Qgc2NhbGluZyA9IGdldFNjYWxpbmckMSgpOwogICAgcmV0dXJuIE1hdGgubWF4KHNjYWxpbmdbMF0sIHNjYWxpbmdbMV0pOwogIH07CiAgY29uc3QgZ2V0Um90YXRpb24gPSAoKSA9PiBNYXRoLmFjb3Modmlld1swXSAvIGdldE1heFNjYWxpbmcoKSk7CiAgY29uc3QgZ2V0U2NhbGVCb3VuZHMgPSAoKSA9PiBbWy4uLnNjYWxlWEJvdW5kc10sIFsuLi5zY2FsZVlCb3VuZHNdXTsKICBjb25zdCBnZXRUcmFuc2xhdGlvbkJvdW5kcyA9ICgpID0+IFsKICAgIFsuLi50cmFuc2xhdGlvblhCb3VuZHNdLAogICAgWy4uLnRyYW5zbGF0aW9uWUJvdW5kc10KICBdOwogIGNvbnN0IGdldERpc3RhbmNlID0gKCkgPT4gewogICAgY29uc3Qgc2NhbGluZyA9IGdldFNjYWxpbmckMSgpOwogICAgcmV0dXJuIFsxIC8gc2NhbGluZ1swXSwgMSAvIHNjYWxpbmdbMV1dOwogIH07CiAgY29uc3QgZ2V0TWluRGlzdGFuY2UgPSAoKSA9PiAxIC8gZ2V0TWluU2NhbGluZygpOwogIGNvbnN0IGdldE1heERpc3RhbmNlID0gKCkgPT4gMSAvIGdldE1heFNjYWxpbmcoKTsKICBjb25zdCBnZXRUcmFuc2xhdGlvbiQxID0gKCkgPT4gZ2V0VHJhbnNsYXRpb24oc2NyYXRjaDAsIHZpZXcpLnNsaWNlKDAsIDIpOwogIGNvbnN0IGdldFRhcmdldCA9ICgpID0+IHRyYW5zZm9ybU1hdDQoc2NyYXRjaDAsIHZpZXdDZW50ZXIsIGludmVydChzY3JhdGNoMiwgdmlldykpLnNsaWNlKDAsIDIpOwogIGNvbnN0IGdldFZpZXcgPSAoKSA9PiB2aWV3OwogIGNvbnN0IGdldFZpZXdDZW50ZXIgPSAoKSA9PiB2aWV3Q2VudGVyLnNsaWNlKDAsIDIpOwogIGNvbnN0IGxvb2tBdCA9IChbeCA9IDAsIHkgPSAwXSA9IFtdLCBuZXdEaXN0YW5jZSA9IDEsIG5ld1JvdGF0aW9uID0gMCkgPT4gewogICAgdmlldyA9IGNyZWF0ZSQyKCk7CiAgICB0cmFuc2xhdGUoWy14LCAteV0pOwogICAgcm90YXRlKG5ld1JvdGF0aW9uKTsKICAgIHNjYWxlKDEgLyBuZXdEaXN0YW5jZSk7CiAgfTsKICBjb25zdCB0cmFuc2xhdGUgPSAoW3ggPSAwLCB5ID0gMF0gPSBbXSkgPT4gewogICAgc2NyYXRjaDBbMF0gPSB4OwogICAgc2NyYXRjaDBbMV0gPSB5OwogICAgc2NyYXRjaDBbMl0gPSAwOwogICAgY29uc3QgdCA9IGZyb21UcmFuc2xhdGlvbihzY3JhdGNoMSwgc2NyYXRjaDApOwogICAgbXVsdGlwbHkodmlldywgdCwgdmlldyk7CiAgfTsKICBjb25zdCBzY2FsZSA9IChkLCBtb3VzZVBvcykgPT4gewogICAgY29uc3QgaXNBcnJheTIgPSBBcnJheS5pc0FycmF5KGQpOwogICAgbGV0IGR4ID0gaXNBcnJheTIgPyBkWzBdIDogZDsKICAgIGxldCBkeSA9IGlzQXJyYXkyID8gZFsxXSA6IGQ7CiAgICBpZiAoZHggPD0gMCB8fCBkeSA8PSAwIHx8IGR4ID09PSAxICYmIGR5ID09PSAxKSByZXR1cm47CiAgICBjb25zdCBzY2FsaW5nID0gZ2V0U2NhbGluZyQxKCk7CiAgICBjb25zdCBuZXdYU2NhbGUgPSBzY2FsaW5nWzBdICogZHg7CiAgICBjb25zdCBuZXdZU2NhbGUgPSBzY2FsaW5nWzFdICogZHk7CiAgICBkeCA9IE1hdGgubWF4KHNjYWxlWEJvdW5kc1swXSwgTWF0aC5taW4obmV3WFNjYWxlLCBzY2FsZVhCb3VuZHNbMV0pKSAvIHNjYWxpbmdbMF07CiAgICBkeSA9IE1hdGgubWF4KHNjYWxlWUJvdW5kc1swXSwgTWF0aC5taW4obmV3WVNjYWxlLCBzY2FsZVlCb3VuZHNbMV0pKSAvIHNjYWxpbmdbMV07CiAgICBpZiAoZHggPT09IDEgJiYgZHkgPT09IDEpIHJldHVybjsKICAgIHNjcmF0Y2gwWzBdID0gZHg7CiAgICBzY3JhdGNoMFsxXSA9IGR5OwogICAgc2NyYXRjaDBbMl0gPSAxOwogICAgY29uc3QgcyA9IGZyb21TY2FsaW5nKHNjcmF0Y2gxLCBzY3JhdGNoMCk7CiAgICBjb25zdCBzY2FsZUNlbnRlciA9IG1vdXNlUG9zID8gWy4uLm1vdXNlUG9zLCAwXSA6IHZpZXdDZW50ZXI7CiAgICBjb25zdCBhID0gZnJvbVRyYW5zbGF0aW9uKHNjcmF0Y2gwLCBzY2FsZUNlbnRlcik7CiAgICBtdWx0aXBseSgKICAgICAgdmlldywKICAgICAgYSwKICAgICAgbXVsdGlwbHkoCiAgICAgICAgdmlldywKICAgICAgICBzLAogICAgICAgIG11bHRpcGx5KHZpZXcsIGludmVydChzY3JhdGNoMiwgYSksIHZpZXcpCiAgICAgICkKICAgICk7CiAgfTsKICBjb25zdCByb3RhdGUgPSAocmFkKSA9PiB7CiAgICBjb25zdCByID0gY3JlYXRlJDIoKTsKICAgIGZyb21Sb3RhdGlvbihyLCByYWQsIFswLCAwLCAxXSk7CiAgICBtdWx0aXBseSh2aWV3LCByLCB2aWV3KTsKICB9OwogIGNvbnN0IHNldFNjYWxlQm91bmRzID0gKG5ld0JvdW5kcykgPT4gewogICAgY29uc3QgaXNBcnJheTIgPSBBcnJheS5pc0FycmF5KG5ld0JvdW5kc1swXSk7CiAgICBzY2FsZVhCb3VuZHNbMF0gPSBpc0FycmF5MiA/IG5ld0JvdW5kc1swXVswXSA6IG5ld0JvdW5kc1swXTsKICAgIHNjYWxlWEJvdW5kc1sxXSA9IGlzQXJyYXkyID8gbmV3Qm91bmRzWzBdWzFdIDogbmV3Qm91bmRzWzFdOwogICAgc2NhbGVZQm91bmRzWzBdID0gaXNBcnJheTIgPyBuZXdCb3VuZHNbMV1bMF0gOiBuZXdCb3VuZHNbMF07CiAgICBzY2FsZVlCb3VuZHNbMV0gPSBpc0FycmF5MiA/IG5ld0JvdW5kc1sxXVsxXSA6IG5ld0JvdW5kc1sxXTsKICB9OwogIGNvbnN0IHNldFRyYW5zbGF0aW9uQm91bmRzID0gKG5ld0JvdW5kcykgPT4gewogICAgY29uc3QgaXNBcnJheTIgPSBBcnJheS5pc0FycmF5KG5ld0JvdW5kc1swXSk7CiAgICB0cmFuc2xhdGlvblhCb3VuZHNbMF0gPSBpc0FycmF5MiA/IG5ld0JvdW5kc1swXVswXSA6IG5ld0JvdW5kc1swXTsKICAgIHRyYW5zbGF0aW9uWEJvdW5kc1sxXSA9IGlzQXJyYXkyID8gbmV3Qm91bmRzWzBdWzFdIDogbmV3Qm91bmRzWzFdOwogICAgdHJhbnNsYXRpb25ZQm91bmRzWzBdID0gaXNBcnJheTIgPyBuZXdCb3VuZHNbMV1bMF0gOiBuZXdCb3VuZHNbMF07CiAgICB0cmFuc2xhdGlvbllCb3VuZHNbMV0gPSBpc0FycmF5MiA/IG5ld0JvdW5kc1sxXVsxXSA6IG5ld0JvdW5kc1sxXTsKICB9OwogIGNvbnN0IHNldFZpZXcgPSAobmV3VmlldykgPT4gewogICAgaWYgKCFuZXdWaWV3IHx8IG5ld1ZpZXcubGVuZ3RoIDwgMTYpIHJldHVybjsKICAgIHZpZXcgPSBuZXdWaWV3OwogIH07CiAgY29uc3Qgc2V0Vmlld0NlbnRlciA9IChuZXdWaWV3Q2VudGVyKSA9PiB7CiAgICB2aWV3Q2VudGVyID0gWy4uLm5ld1ZpZXdDZW50ZXIuc2xpY2UoMCwgMiksIDAsIDFdOwogIH07CiAgY29uc3QgcmVzZXQgPSAoKSA9PiB7CiAgICBsb29rQXQoaW5pdFRhcmdldCwgaW5pdERpc3RhbmNlLCBpbml0Um90YXRpb24pOwogIH07CiAgbG9va0F0KGluaXRUYXJnZXQsIGluaXREaXN0YW5jZSwgaW5pdFJvdGF0aW9uKTsKICByZXR1cm4gewogICAgZ2V0IHRyYW5zbGF0aW9uKCkgewogICAgICByZXR1cm4gZ2V0VHJhbnNsYXRpb24kMSgpOwogICAgfSwKICAgIGdldCB0YXJnZXQoKSB7CiAgICAgIHJldHVybiBnZXRUYXJnZXQoKTsKICAgIH0sCiAgICBnZXQgc2NhbGluZygpIHsKICAgICAgcmV0dXJuIGdldFNjYWxpbmckMSgpOwogICAgfSwKICAgIGdldCBtaW5TY2FsaW5nKCkgewogICAgICByZXR1cm4gZ2V0TWluU2NhbGluZygpOwogICAgfSwKICAgIGdldCBtYXhTY2FsaW5nKCkgewogICAgICByZXR1cm4gZ2V0TWF4U2NhbGluZygpOwogICAgfSwKICAgIGdldCBzY2FsZUJvdW5kcygpIHsKICAgICAgcmV0dXJuIGdldFNjYWxlQm91bmRzKCk7CiAgICB9LAogICAgZ2V0IHRyYW5zbGF0aW9uQm91bmRzKCkgewogICAgICByZXR1cm4gZ2V0VHJhbnNsYXRpb25Cb3VuZHMoKTsKICAgIH0sCiAgICBnZXQgZGlzdGFuY2UoKSB7CiAgICAgIHJldHVybiBnZXREaXN0YW5jZSgpOwogICAgfSwKICAgIGdldCBtaW5EaXN0YW5jZSgpIHsKICAgICAgcmV0dXJuIGdldE1pbkRpc3RhbmNlKCk7CiAgICB9LAogICAgZ2V0IG1heERpc3RhbmNlKCkgewogICAgICByZXR1cm4gZ2V0TWF4RGlzdGFuY2UoKTsKICAgIH0sCiAgICBnZXQgcm90YXRpb24oKSB7CiAgICAgIHJldHVybiBnZXRSb3RhdGlvbigpOwogICAgfSwKICAgIGdldCB2aWV3KCkgewogICAgICByZXR1cm4gZ2V0VmlldygpOwogICAgfSwKICAgIGdldCB2aWV3Q2VudGVyKCkgewogICAgICByZXR1cm4gZ2V0Vmlld0NlbnRlcigpOwogICAgfSwKICAgIGxvb2tBdCwKICAgIHRyYW5zbGF0ZSwKICAgIHBhbjogdHJhbnNsYXRlLAogICAgcm90YXRlLAogICAgc2NhbGUsCiAgICB6b29tOiBzY2FsZSwKICAgIHJlc2V0LAogICAgc2V0OiAoLi4uYXJncykgPT4gewogICAgICBjb25zb2xlLndhcm4oImBzZXQoKWAgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSBgc2V0VmlldygpYCBpbnN0ZWFkLiIpOwogICAgICByZXR1cm4gc2V0VmlldyguLi5hcmdzKTsKICAgIH0sCiAgICBzZXRTY2FsZUJvdW5kcywKICAgIHNldFRyYW5zbGF0aW9uQm91bmRzLAogICAgc2V0VmlldywKICAgIHNldFZpZXdDZW50ZXIKICB9Owp9Owp2YXIgTU9VU0VfRE9XTl9NT1ZFX0FDVElPTlMgPSBbInBhbiIsICJyb3RhdGUiXTsKdmFyIEtFWV9NQVAgPSB7CiAgYWx0OiAiYWx0S2V5IiwKICBjbWQ6ICJtZXRhS2V5IiwKICBjdHJsOiAiY3RybEtleSIsCiAgbWV0YTogIm1ldGFLZXkiLAogIHNoaWZ0OiAic2hpZnRLZXkiCn07CnZhciBkb20yZENhbWVyYSA9IChlbGVtZW50LCB7CiAgZGlzdGFuY2UgPSAxLAogIHRhcmdldCA9IFswLCAwXSwKICByb3RhdGlvbiA9IDAsCiAgaXNOZGMgPSB0cnVlLAogIGlzRml4ZWQgPSBmYWxzZSwKICBpc1BhbiA9IHRydWUsCiAgaXNQYW5JbnZlcnRlZCA9IFtmYWxzZSwgdHJ1ZV0sCiAgcGFuU3BlZWQgPSAxLAogIGlzUm90YXRlID0gdHJ1ZSwKICByb3RhdGVTcGVlZCA9IDEsCiAgZGVmYXVsdE1vdXNlRG93bk1vdmVBY3Rpb24gPSAicGFuIiwKICBtb3VzZURvd25Nb3ZlTW9kS2V5ID0gImFsdCIsCiAgaXNab29tID0gdHJ1ZSwKICB6b29tU3BlZWQgPSAxLAogIHZpZXdDZW50ZXIsCiAgc2NhbGVCb3VuZHMsCiAgdHJhbnNsYXRpb25Cb3VuZHMsCiAgb25LZXlEb3duID0gKCkgPT4gewogIH0sCiAgb25LZXlVcCA9ICgpID0+IHsKICB9LAogIG9uTW91c2VEb3duID0gKCkgPT4gewogIH0sCiAgb25Nb3VzZVVwID0gKCkgPT4gewogIH0sCiAgb25Nb3VzZU1vdmUgPSAoKSA9PiB7CiAgfSwKICBvbldoZWVsID0gKCkgPT4gewogIH0KfSA9IHt9KSA9PiB7CiAgbGV0IGNhbWVyYSA9IGNyZWF0ZUNhbWVyYSgKICAgIHRhcmdldCwKICAgIGRpc3RhbmNlLAogICAgcm90YXRpb24sCiAgICB2aWV3Q2VudGVyLAogICAgc2NhbGVCb3VuZHMsCiAgICB0cmFuc2xhdGlvbkJvdW5kcwogICk7CiAgbGV0IG1vdXNlWCA9IDA7CiAgbGV0IG1vdXNlWSA9IDA7CiAgbGV0IG1vdXNlUmVsWCA9IDA7CiAgbGV0IG1vdXNlUmVsWSA9IDA7CiAgbGV0IHByZXZNb3VzZVggPSAwOwogIGxldCBwcmV2TW91c2VZID0gMDsKICBsZXQgaXNMZWZ0TW91c2VQcmVzc2VkID0gZmFsc2U7CiAgbGV0IHNjcm9sbERpc3QgPSAwOwogIGxldCB3aWR0aCA9IDE7CiAgbGV0IGhlaWdodCA9IDE7CiAgbGV0IGFzcGVjdFJhdGlvID0gMTsKICBsZXQgaXNJbnRlcmFjdGl2ZWx5Q2hhbmdlZCA9IGZhbHNlOwogIGxldCBpc1Byb2dyYW1tYXRpY2FsbHlDaGFuZ2VkID0gZmFsc2U7CiAgbGV0IGlzTW91c2VEb3duTW92ZU1vZEFjdGl2ZSA9IGZhbHNlOwogIGxldCBwYW5Pbk1vdXNlRG93bk1vdmUgPSBkZWZhdWx0TW91c2VEb3duTW92ZUFjdGlvbiA9PT0gInBhbiI7CiAgbGV0IGlzUGFuWCA9IGlzUGFuOwogIGxldCBpc1BhblkgPSBpc1BhbjsKICBsZXQgaXNQYW5YSW52ZXJ0ZWQgPSBpc1BhbkludmVydGVkOwogIGxldCBpc1BhbllJbnZlcnRlZCA9IGlzUGFuSW52ZXJ0ZWQ7CiAgbGV0IGlzWm9vbVggPSBpc1pvb207CiAgbGV0IGlzWm9vbVkgPSBpc1pvb207CiAgY29uc3Qgc3ByZWFkWFlTZXR0aW5ncyA9ICgpID0+IHsKICAgIGlzUGFuWCA9IEFycmF5LmlzQXJyYXkoaXNQYW4pID8gQm9vbGVhbihpc1BhblswXSkgOiBpc1BhbjsKICAgIGlzUGFuWSA9IEFycmF5LmlzQXJyYXkoaXNQYW4pID8gQm9vbGVhbihpc1BhblsxXSkgOiBpc1BhbjsKICAgIGlzUGFuWEludmVydGVkID0gQXJyYXkuaXNBcnJheShpc1BhbkludmVydGVkKSA/IEJvb2xlYW4oaXNQYW5JbnZlcnRlZFswXSkgOiBpc1BhbkludmVydGVkOwogICAgaXNQYW5ZSW52ZXJ0ZWQgPSBBcnJheS5pc0FycmF5KGlzUGFuSW52ZXJ0ZWQpID8gQm9vbGVhbihpc1BhbkludmVydGVkWzFdKSA6IGlzUGFuSW52ZXJ0ZWQ7CiAgICBpc1pvb21YID0gQXJyYXkuaXNBcnJheShpc1pvb20pID8gQm9vbGVhbihpc1pvb21bMF0pIDogaXNab29tOwogICAgaXNab29tWSA9IEFycmF5LmlzQXJyYXkoaXNab29tKSA/IEJvb2xlYW4oaXNab29tWzFdKSA6IGlzWm9vbTsKICB9OwogIHNwcmVhZFhZU2V0dGluZ3MoKTsKICBjb25zdCB0cmFuc2Zvcm1QYW5YID0gaXNOZGMgPyAoZFgpID0+IGRYIC8gd2lkdGggKiAyICogYXNwZWN0UmF0aW8gOiAoZFgpID0+IGRYOwogIGNvbnN0IHRyYW5zZm9ybVBhblkgPSBpc05kYyA/IChkWSkgPT4gZFkgLyBoZWlnaHQgKiAyIDogKGRZKSA9PiAtZFk7CiAgY29uc3QgdHJhbnNmb3JtU2NhbGVYID0gaXNOZGMgPyAoeCkgPT4gKC0xICsgeCAvIHdpZHRoICogMikgKiBhc3BlY3RSYXRpbyA6ICh4KSA9PiB4OwogIGNvbnN0IHRyYW5zZm9ybVNjYWxlWSA9IGlzTmRjID8gKHkpID0+IDEgLSB5IC8gaGVpZ2h0ICogMiA6ICh5KSA9PiB5OwogIGNvbnN0IHRpY2sgPSAoKSA9PiB7CiAgICBpZiAoaXNGaXhlZCkgewogICAgICBjb25zdCBpc0NoYW5nZWQyID0gaXNQcm9ncmFtbWF0aWNhbGx5Q2hhbmdlZDsKICAgICAgaXNQcm9ncmFtbWF0aWNhbGx5Q2hhbmdlZCA9IGZhbHNlOwogICAgICByZXR1cm4gaXNDaGFuZ2VkMjsKICAgIH0KICAgIGlzSW50ZXJhY3RpdmVseUNoYW5nZWQgPSBmYWxzZTsKICAgIGNvbnN0IGN1cnJlbnRNb3VzZVggPSBtb3VzZVg7CiAgICBjb25zdCBjdXJyZW50TW91c2VZID0gbW91c2VZOwogICAgaWYgKChpc1BhblggfHwgaXNQYW5ZKSAmJiBpc0xlZnRNb3VzZVByZXNzZWQgJiYgKHBhbk9uTW91c2VEb3duTW92ZSAmJiAhaXNNb3VzZURvd25Nb3ZlTW9kQWN0aXZlIHx8ICFwYW5Pbk1vdXNlRG93bk1vdmUgJiYgaXNNb3VzZURvd25Nb3ZlTW9kQWN0aXZlKSkgewogICAgICBjb25zdCBkWCA9IGlzUGFuWEludmVydGVkID8gcHJldk1vdXNlWCAtIGN1cnJlbnRNb3VzZVggOiBjdXJyZW50TW91c2VYIC0gcHJldk1vdXNlWDsKICAgICAgY29uc3QgdHJhbnNmb3JtZWRQYW5YID0gaXNQYW5YID8gdHJhbnNmb3JtUGFuWChwYW5TcGVlZCAqIGRYKSA6IDA7CiAgICAgIGNvbnN0IGRZID0gaXNQYW5ZSW52ZXJ0ZWQgPyBwcmV2TW91c2VZIC0gY3VycmVudE1vdXNlWSA6IGN1cnJlbnRNb3VzZVkgLSBwcmV2TW91c2VZOwogICAgICBjb25zdCB0cmFuc2Zvcm1lZFBhblkgPSBpc1BhblkgPyB0cmFuc2Zvcm1QYW5ZKHBhblNwZWVkICogZFkpIDogMDsKICAgICAgaWYgKHRyYW5zZm9ybWVkUGFuWCAhPT0gMCB8fCB0cmFuc2Zvcm1lZFBhblkgIT09IDApIHsKICAgICAgICBjYW1lcmEucGFuKFt0cmFuc2Zvcm1lZFBhblgsIHRyYW5zZm9ybWVkUGFuWV0pOwogICAgICAgIGlzSW50ZXJhY3RpdmVseUNoYW5nZWQgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBpZiAoKGlzWm9vbVggfHwgaXNab29tWSkgJiYgc2Nyb2xsRGlzdCkgewogICAgICBjb25zdCBkWiA9IHpvb21TcGVlZCAqIE1hdGguZXhwKHNjcm9sbERpc3QgLyBoZWlnaHQpOwogICAgICBjb25zdCB0cmFuc2Zvcm1lZFggPSB0cmFuc2Zvcm1TY2FsZVgobW91c2VSZWxYKTsKICAgICAgY29uc3QgdHJhbnNmb3JtZWRZID0gdHJhbnNmb3JtU2NhbGVZKG1vdXNlUmVsWSk7CiAgICAgIGNhbWVyYS5zY2FsZSgKICAgICAgICBbaXNab29tWCA/IDEgLyBkWiA6IDEsIGlzWm9vbVkgPyAxIC8gZFogOiAxXSwKICAgICAgICBbdHJhbnNmb3JtZWRYLCB0cmFuc2Zvcm1lZFldCiAgICAgICk7CiAgICAgIGlzSW50ZXJhY3RpdmVseUNoYW5nZWQgPSB0cnVlOwogICAgfQogICAgaWYgKGlzUm90YXRlICYmIGlzTGVmdE1vdXNlUHJlc3NlZCAmJiAocGFuT25Nb3VzZURvd25Nb3ZlICYmIGlzTW91c2VEb3duTW92ZU1vZEFjdGl2ZSB8fCAhcGFuT25Nb3VzZURvd25Nb3ZlICYmICFpc01vdXNlRG93bk1vdmVNb2RBY3RpdmUpICYmIE1hdGguYWJzKHByZXZNb3VzZVggLSBjdXJyZW50TW91c2VYKSArIE1hdGguYWJzKHByZXZNb3VzZVkgLSBjdXJyZW50TW91c2VZKSA+IDApIHsKICAgICAgY29uc3Qgd2ggPSB3aWR0aCAvIDI7CiAgICAgIGNvbnN0IGhoID0gaGVpZ2h0IC8gMjsKICAgICAgY29uc3QgeDEgPSBwcmV2TW91c2VYIC0gd2g7CiAgICAgIGNvbnN0IHkxID0gaGggLSBwcmV2TW91c2VZOwogICAgICBjb25zdCB4MiA9IGN1cnJlbnRNb3VzZVggLSB3aDsKICAgICAgY29uc3QgeTIgPSBoaCAtIGN1cnJlbnRNb3VzZVk7CiAgICAgIGNvbnN0IHJhZGlhbnMgPSBhbmdsZShbeDEsIHkxXSwgW3gyLCB5Ml0pOwogICAgICBjb25zdCBjcm9zcyA9IHgxICogeTIgLSB4MiAqIHkxOwogICAgICBjYW1lcmEucm90YXRlKHJvdGF0ZVNwZWVkICogcmFkaWFucyAqIE1hdGguc2lnbihjcm9zcykpOwogICAgICBpc0ludGVyYWN0aXZlbHlDaGFuZ2VkID0gdHJ1ZTsKICAgIH0KICAgIHNjcm9sbERpc3QgPSAwOwogICAgcHJldk1vdXNlWCA9IGN1cnJlbnRNb3VzZVg7CiAgICBwcmV2TW91c2VZID0gY3VycmVudE1vdXNlWTsKICAgIGNvbnN0IGlzQ2hhbmdlZCA9IGlzSW50ZXJhY3RpdmVseUNoYW5nZWQgfHwgaXNQcm9ncmFtbWF0aWNhbGx5Q2hhbmdlZDsKICAgIGlzUHJvZ3JhbW1hdGljYWxseUNoYW5nZWQgPSBmYWxzZTsKICAgIHJldHVybiBpc0NoYW5nZWQ7CiAgfTsKICBjb25zdCBjb25maWcgPSAoewogICAgZGVmYXVsdE1vdXNlRG93bk1vdmVBY3Rpb246IG5ld0RlZmF1bHRNb3VzZURvd25Nb3ZlQWN0aW9uID0gbnVsbCwKICAgIGlzRml4ZWQ6IG5ld0lzRml4ZWQgPSBudWxsLAogICAgaXNQYW46IG5ld0lzUGFuID0gbnVsbCwKICAgIGlzUGFuSW52ZXJ0ZWQ6IG5ld0lzUGFuSW52ZXJ0ZWQgPSBudWxsLAogICAgaXNSb3RhdGU6IG5ld0lzUm90YXRlID0gbnVsbCwKICAgIGlzWm9vbTogbmV3SXNab29tID0gbnVsbCwKICAgIHBhblNwZWVkOiBuZXdQYW5TcGVlZCA9IG51bGwsCiAgICByb3RhdGVTcGVlZDogbmV3Um90YXRlU3BlZWQgPSBudWxsLAogICAgem9vbVNwZWVkOiBuZXdab29tU3BlZWQgPSBudWxsLAogICAgbW91c2VEb3duTW92ZU1vZEtleTogbmV3TW91c2VEb3duTW92ZU1vZEtleSA9IG51bGwKICB9ID0ge30pID0+IHsKICAgIGRlZmF1bHRNb3VzZURvd25Nb3ZlQWN0aW9uID0gbmV3RGVmYXVsdE1vdXNlRG93bk1vdmVBY3Rpb24gIT09IG51bGwgJiYgTU9VU0VfRE9XTl9NT1ZFX0FDVElPTlMuaW5jbHVkZXMobmV3RGVmYXVsdE1vdXNlRG93bk1vdmVBY3Rpb24pID8gbmV3RGVmYXVsdE1vdXNlRG93bk1vdmVBY3Rpb24gOiBkZWZhdWx0TW91c2VEb3duTW92ZUFjdGlvbjsKICAgIHBhbk9uTW91c2VEb3duTW92ZSA9IGRlZmF1bHRNb3VzZURvd25Nb3ZlQWN0aW9uID09PSAicGFuIjsKICAgIGlzRml4ZWQgPSBuZXdJc0ZpeGVkICE9PSBudWxsID8gbmV3SXNGaXhlZCA6IGlzRml4ZWQ7CiAgICBpc1BhbiA9IG5ld0lzUGFuICE9PSBudWxsID8gbmV3SXNQYW4gOiBpc1BhbjsKICAgIGlzUGFuSW52ZXJ0ZWQgPSBuZXdJc1BhbkludmVydGVkICE9PSBudWxsID8gbmV3SXNQYW5JbnZlcnRlZCA6IGlzUGFuSW52ZXJ0ZWQ7CiAgICBpc1JvdGF0ZSA9IG5ld0lzUm90YXRlICE9PSBudWxsID8gbmV3SXNSb3RhdGUgOiBpc1JvdGF0ZTsKICAgIGlzWm9vbSA9IG5ld0lzWm9vbSAhPT0gbnVsbCA/IG5ld0lzWm9vbSA6IGlzWm9vbTsKICAgIHBhblNwZWVkID0gK25ld1BhblNwZWVkID4gMCA/IG5ld1BhblNwZWVkIDogcGFuU3BlZWQ7CiAgICByb3RhdGVTcGVlZCA9ICtuZXdSb3RhdGVTcGVlZCA+IDAgPyBuZXdSb3RhdGVTcGVlZCA6IHJvdGF0ZVNwZWVkOwogICAgem9vbVNwZWVkID0gK25ld1pvb21TcGVlZCA+IDAgPyBuZXdab29tU3BlZWQgOiB6b29tU3BlZWQ7CiAgICBzcHJlYWRYWVNldHRpbmdzKCk7CiAgICBtb3VzZURvd25Nb3ZlTW9kS2V5ID0gbmV3TW91c2VEb3duTW92ZU1vZEtleSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyhLRVlfTUFQKS5pbmNsdWRlcyhuZXdNb3VzZURvd25Nb3ZlTW9kS2V5KSA/IG5ld01vdXNlRG93bk1vdmVNb2RLZXkgOiBtb3VzZURvd25Nb3ZlTW9kS2V5OwogIH07CiAgY29uc3QgcmVmcmVzaCA9ICgpID0+IHsKICAgIGNvbnN0IGJCb3ggPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgd2lkdGggPSBiQm94LndpZHRoOwogICAgaGVpZ2h0ID0gYkJveC5oZWlnaHQ7CiAgICBhc3BlY3RSYXRpbyA9IHdpZHRoIC8gaGVpZ2h0OwogIH07CiAgY29uc3Qga2V5VXBIYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBpc01vdXNlRG93bk1vdmVNb2RBY3RpdmUgPSBmYWxzZTsKICAgIG9uS2V5VXAoZXZlbnQpOwogIH07CiAgY29uc3Qga2V5RG93bkhhbmRsZXIgPSAoZXZlbnQpID0+IHsKICAgIGlzTW91c2VEb3duTW92ZU1vZEFjdGl2ZSA9IGV2ZW50W0tFWV9NQVBbbW91c2VEb3duTW92ZU1vZEtleV1dOwogICAgb25LZXlEb3duKGV2ZW50KTsKICB9OwogIGNvbnN0IG1vdXNlVXBIYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBpc0xlZnRNb3VzZVByZXNzZWQgPSBmYWxzZTsKICAgIG9uTW91c2VVcChldmVudCk7CiAgfTsKICBjb25zdCBtb3VzZURvd25IYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBpc0xlZnRNb3VzZVByZXNzZWQgPSBldmVudC5idXR0b25zID09PSAxOwogICAgb25Nb3VzZURvd24oZXZlbnQpOwogIH07CiAgY29uc3Qgb2Zmc2V0WFN1cHBvcnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudCIpLm9mZnNldFggIT09IHZvaWQgMDsKICBjb25zdCB1cGRhdGVNb3VzZVJlbFhZID0gb2Zmc2V0WFN1cHBvcnQgPyAoZXZlbnQpID0+IHsKICAgIG1vdXNlUmVsWCA9IGV2ZW50Lm9mZnNldFg7CiAgICBtb3VzZVJlbFkgPSBldmVudC5vZmZzZXRZOwogIH0gOiAoZXZlbnQpID0+IHsKICAgIGNvbnN0IGJCb3ggPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgbW91c2VSZWxYID0gZXZlbnQuY2xpZW50WCAtIGJCb3gubGVmdDsKICAgIG1vdXNlUmVsWSA9IGV2ZW50LmNsaWVudFkgLSBiQm94LnRvcDsKICB9OwogIGNvbnN0IHVwZGF0ZU1vdXNlWFkgPSAoZXZlbnQpID0+IHsKICAgIG1vdXNlWCA9IGV2ZW50LmNsaWVudFg7CiAgICBtb3VzZVkgPSBldmVudC5jbGllbnRZOwogIH07CiAgY29uc3QgbW91c2VNb3ZlSGFuZGxlciA9IChldmVudCkgPT4gewogICAgdXBkYXRlTW91c2VYWShldmVudCk7CiAgICBvbk1vdXNlTW92ZShldmVudCk7CiAgfTsKICBjb25zdCB3aGVlbEhhbmRsZXIgPSAoZXZlbnQpID0+IHsKICAgIGlmICgoaXNab29tWCB8fCBpc1pvb21ZKSAmJiAhaXNGaXhlZCkgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB1cGRhdGVNb3VzZVhZKGV2ZW50KTsKICAgICAgdXBkYXRlTW91c2VSZWxYWShldmVudCk7CiAgICAgIGNvbnN0IHNjYWxlID0gZXZlbnQuZGVsdGFNb2RlID09PSAxID8gMTIgOiAxOwogICAgICBzY3JvbGxEaXN0ICs9IHNjYWxlICogKGV2ZW50LmRlbHRhWSB8fCBldmVudC5kZWx0YVggfHwgMCk7CiAgICB9CiAgICBvbldoZWVsKGV2ZW50KTsKICB9OwogIGNvbnN0IGRpc3Bvc2UgPSAoKSA9PiB7CiAgICBjYW1lcmEgPSB2b2lkIDA7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIGtleURvd25IYW5kbGVyKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXl1cCIsIGtleVVwSGFuZGxlcik7CiAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIG1vdXNlRG93bkhhbmRsZXIpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBtb3VzZVVwSGFuZGxlcik7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgbW91c2VNb3ZlSGFuZGxlcik7CiAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIndoZWVsIiwgd2hlZWxIYW5kbGVyKTsKICB9OwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwga2V5RG93bkhhbmRsZXIsIHsgcGFzc2l2ZTogdHJ1ZSB9KTsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigia2V5dXAiLCBrZXlVcEhhbmRsZXIsIHsgcGFzc2l2ZTogdHJ1ZSB9KTsKICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIG1vdXNlRG93bkhhbmRsZXIsIHsgcGFzc2l2ZTogdHJ1ZSB9KTsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIG1vdXNlVXBIYW5kbGVyLCB7IHBhc3NpdmU6IHRydWUgfSk7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIG1vdXNlTW92ZUhhbmRsZXIsIHsgcGFzc2l2ZTogdHJ1ZSB9KTsKICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoIndoZWVsIiwgd2hlZWxIYW5kbGVyLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogIGNhbWVyYS5jb25maWcgPSBjb25maWc7CiAgY2FtZXJhLmRpc3Bvc2UgPSBkaXNwb3NlOwogIGNhbWVyYS5yZWZyZXNoID0gcmVmcmVzaDsKICBjYW1lcmEudGljayA9IHRpY2s7CiAgY29uc3Qgd2l0aFByb2dyYW1tYXRpY0NoYW5nZSA9IChmbikgPT4gZnVuY3Rpb24oKSB7CiAgICBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgaXNQcm9ncmFtbWF0aWNhbGx5Q2hhbmdlZCA9IHRydWU7CiAgfTsKICBjYW1lcmEubG9va0F0ID0gd2l0aFByb2dyYW1tYXRpY0NoYW5nZShjYW1lcmEubG9va0F0KTsKICBjYW1lcmEudHJhbnNsYXRlID0gd2l0aFByb2dyYW1tYXRpY0NoYW5nZShjYW1lcmEudHJhbnNsYXRlKTsKICBjYW1lcmEucGFuID0gd2l0aFByb2dyYW1tYXRpY0NoYW5nZShjYW1lcmEucGFuKTsKICBjYW1lcmEucm90YXRlID0gd2l0aFByb2dyYW1tYXRpY0NoYW5nZShjYW1lcmEucm90YXRlKTsKICBjYW1lcmEuc2NhbGUgPSB3aXRoUHJvZ3JhbW1hdGljQ2hhbmdlKGNhbWVyYS5zY2FsZSk7CiAgY2FtZXJhLnpvb20gPSB3aXRoUHJvZ3JhbW1hdGljQ2hhbmdlKGNhbWVyYS56b29tKTsKICBjYW1lcmEucmVzZXQgPSB3aXRoUHJvZ3JhbW1hdGljQ2hhbmdlKGNhbWVyYS5yZXNldCk7CiAgY2FtZXJhLnNldCA9IHdpdGhQcm9ncmFtbWF0aWNDaGFuZ2UoY2FtZXJhLnNldCk7CiAgY2FtZXJhLnNldFNjYWxlQm91bmRzID0gd2l0aFByb2dyYW1tYXRpY0NoYW5nZShjYW1lcmEuc2V0U2NhbGVCb3VuZHMpOwogIGNhbWVyYS5zZXRUcmFuc2xhdGlvbkJvdW5kcyA9IHdpdGhQcm9ncmFtbWF0aWNDaGFuZ2UoCiAgICBjYW1lcmEuc2V0VHJhbnNsYXRpb25Cb3VuZHMKICApOwogIGNhbWVyYS5zZXRWaWV3ID0gd2l0aFByb2dyYW1tYXRpY0NoYW5nZShjYW1lcmEuc2V0Vmlldyk7CiAgY2FtZXJhLnNldFZpZXdDZW50ZXIgPSB3aXRoUHJvZ3JhbW1hdGljQ2hhbmdlKGNhbWVyYS5zZXRWaWV3Q2VudGVyKTsKICByZWZyZXNoKCk7CiAgcmV0dXJuIGNhbWVyYTsKfTsKZnVuY3Rpb24gZWFyY3V0KGRhdGEsIGhvbGVJbmRpY2VzLCBkaW0gPSAyKSB7CiAgY29uc3Qgb3V0ZXJMZW4gPSBkYXRhLmxlbmd0aDsKICBsZXQgb3V0ZXJOb2RlID0gbGlua2VkTGlzdChkYXRhLCAwLCBvdXRlckxlbiwgZGltLCB0cnVlKTsKICBjb25zdCB0cmlhbmdsZXMgPSBbXTsKICBpZiAoIW91dGVyTm9kZSB8fCBvdXRlck5vZGUubmV4dCA9PT0gb3V0ZXJOb2RlLnByZXYpIHJldHVybiB0cmlhbmdsZXM7CiAgbGV0IG1pblgsIG1pblksIGludlNpemU7CiAgaWYgKGRhdGEubGVuZ3RoID4gODAgKiBkaW0pIHsKICAgIG1pblggPSBJbmZpbml0eTsKICAgIG1pblkgPSBJbmZpbml0eTsKICAgIGxldCBtYXhYID0gLUluZmluaXR5OwogICAgbGV0IG1heFkgPSAtSW5maW5pdHk7CiAgICBmb3IgKGxldCBpID0gZGltOyBpIDwgb3V0ZXJMZW47IGkgKz0gZGltKSB7CiAgICAgIGNvbnN0IHggPSBkYXRhW2ldOwogICAgICBjb25zdCB5ID0gZGF0YVtpICsgMV07CiAgICAgIGlmICh4IDwgbWluWCkgbWluWCA9IHg7CiAgICAgIGlmICh5IDwgbWluWSkgbWluWSA9IHk7CiAgICAgIGlmICh4ID4gbWF4WCkgbWF4WCA9IHg7CiAgICAgIGlmICh5ID4gbWF4WSkgbWF4WSA9IHk7CiAgICB9CiAgICBpbnZTaXplID0gTWF0aC5tYXgobWF4WCAtIG1pblgsIG1heFkgLSBtaW5ZKTsKICAgIGludlNpemUgPSBpbnZTaXplICE9PSAwID8gMzI3NjcgLyBpbnZTaXplIDogMDsKICB9CiAgZWFyY3V0TGlua2VkKG91dGVyTm9kZSwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDApOwogIHJldHVybiB0cmlhbmdsZXM7Cn0KZnVuY3Rpb24gbGlua2VkTGlzdChkYXRhLCBzdGFydCwgZW5kLCBkaW0sIGNsb2Nrd2lzZSkgewogIGxldCBsYXN0OwogIGlmIChjbG9ja3dpc2UgPT09IHNpZ25lZEFyZWEoZGF0YSwgc3RhcnQsIGVuZCwgZGltKSA+IDApIHsKICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSBkaW0pIGxhc3QgPSBpbnNlcnROb2RlKGkgLyBkaW0gfCAwLCBkYXRhW2ldLCBkYXRhW2kgKyAxXSwgbGFzdCk7CiAgfSBlbHNlIHsKICAgIGZvciAobGV0IGkgPSBlbmQgLSBkaW07IGkgPj0gc3RhcnQ7IGkgLT0gZGltKSBsYXN0ID0gaW5zZXJ0Tm9kZShpIC8gZGltIHwgMCwgZGF0YVtpXSwgZGF0YVtpICsgMV0sIGxhc3QpOwogIH0KICBpZiAobGFzdCAmJiBlcXVhbHMobGFzdCwgbGFzdC5uZXh0KSkgewogICAgcmVtb3ZlTm9kZShsYXN0KTsKICAgIGxhc3QgPSBsYXN0Lm5leHQ7CiAgfQogIHJldHVybiBsYXN0Owp9CmZ1bmN0aW9uIGZpbHRlclBvaW50cyhzdGFydCwgZW5kKSB7CiAgaWYgKCFzdGFydCkgcmV0dXJuIHN0YXJ0OwogIGlmICghZW5kKSBlbmQgPSBzdGFydDsKICBsZXQgcCA9IHN0YXJ0LCBhZ2FpbjsKICBkbyB7CiAgICBhZ2FpbiA9IGZhbHNlOwogICAgaWYgKCFwLnN0ZWluZXIgJiYgKGVxdWFscyhwLCBwLm5leHQpIHx8IGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID09PSAwKSkgewogICAgICByZW1vdmVOb2RlKHApOwogICAgICBwID0gZW5kID0gcC5wcmV2OwogICAgICBpZiAocCA9PT0gcC5uZXh0KSBicmVhazsKICAgICAgYWdhaW4gPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcCA9IHAubmV4dDsKICAgIH0KICB9IHdoaWxlIChhZ2FpbiB8fCBwICE9PSBlbmQpOwogIHJldHVybiBlbmQ7Cn0KZnVuY3Rpb24gZWFyY3V0TGlua2VkKGVhciwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIHBhc3MpIHsKICBpZiAoIWVhcikgcmV0dXJuOwogIGlmICghcGFzcyAmJiBpbnZTaXplKSBpbmRleEN1cnZlKGVhciwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgbGV0IHN0b3AgPSBlYXI7CiAgd2hpbGUgKGVhci5wcmV2ICE9PSBlYXIubmV4dCkgewogICAgY29uc3QgcHJldiA9IGVhci5wcmV2OwogICAgY29uc3QgbmV4dCA9IGVhci5uZXh0OwogICAgaWYgKGludlNpemUgPyBpc0Vhckhhc2hlZChlYXIsIG1pblgsIG1pblksIGludlNpemUpIDogaXNFYXIoZWFyKSkgewogICAgICB0cmlhbmdsZXMucHVzaChwcmV2LmksIGVhci5pLCBuZXh0LmkpOwogICAgICByZW1vdmVOb2RlKGVhcik7CiAgICAgIGVhciA9IG5leHQubmV4dDsKICAgICAgc3RvcCA9IG5leHQubmV4dDsKICAgICAgY29udGludWU7CiAgICB9CiAgICBlYXIgPSBuZXh0OwogICAgaWYgKGVhciA9PT0gc3RvcCkgewogICAgICBpZiAoIXBhc3MpIHsKICAgICAgICBlYXJjdXRMaW5rZWQoZmlsdGVyUG9pbnRzKGVhciksIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAxKTsKICAgICAgfSBlbHNlIGlmIChwYXNzID09PSAxKSB7CiAgICAgICAgZWFyID0gY3VyZUxvY2FsSW50ZXJzZWN0aW9ucyhmaWx0ZXJQb2ludHMoZWFyKSwgdHJpYW5nbGVzKTsKICAgICAgICBlYXJjdXRMaW5rZWQoZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMik7CiAgICAgIH0gZWxzZSBpZiAocGFzcyA9PT0gMikgewogICAgICAgIHNwbGl0RWFyY3V0KGVhciwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUpOwogICAgICB9CiAgICAgIGJyZWFrOwogICAgfQogIH0KfQpmdW5jdGlvbiBpc0VhcihlYXIpIHsKICBjb25zdCBhID0gZWFyLnByZXYsIGIgPSBlYXIsIGMgPSBlYXIubmV4dDsKICBpZiAoYXJlYShhLCBiLCBjKSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgYXggPSBhLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhLnksIGJ5ID0gYi55LCBjeSA9IGMueTsKICBjb25zdCB4MCA9IE1hdGgubWluKGF4LCBieCwgY3gpLCB5MCA9IE1hdGgubWluKGF5LCBieSwgY3kpLCB4MSA9IE1hdGgubWF4KGF4LCBieCwgY3gpLCB5MSA9IE1hdGgubWF4KGF5LCBieSwgY3kpOwogIGxldCBwID0gYy5uZXh0OwogIHdoaWxlIChwICE9PSBhKSB7CiAgICBpZiAocC54ID49IHgwICYmIHAueCA8PSB4MSAmJiBwLnkgPj0geTAgJiYgcC55IDw9IHkxICYmIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICBwID0gcC5uZXh0OwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBpc0Vhckhhc2hlZChlYXIsIG1pblgsIG1pblksIGludlNpemUpIHsKICBjb25zdCBhID0gZWFyLnByZXYsIGIgPSBlYXIsIGMgPSBlYXIubmV4dDsKICBpZiAoYXJlYShhLCBiLCBjKSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgYXggPSBhLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhLnksIGJ5ID0gYi55LCBjeSA9IGMueTsKICBjb25zdCB4MCA9IE1hdGgubWluKGF4LCBieCwgY3gpLCB5MCA9IE1hdGgubWluKGF5LCBieSwgY3kpLCB4MSA9IE1hdGgubWF4KGF4LCBieCwgY3gpLCB5MSA9IE1hdGgubWF4KGF5LCBieSwgY3kpOwogIGNvbnN0IG1pblogPSB6T3JkZXIoeDAsIHkwLCBtaW5YLCBtaW5ZLCBpbnZTaXplKSwgbWF4WiA9IHpPcmRlcih4MSwgeTEsIG1pblgsIG1pblksIGludlNpemUpOwogIGxldCBwID0gZWFyLnByZXZaLCBuID0gZWFyLm5leHRaOwogIHdoaWxlIChwICYmIHAueiA+PSBtaW5aICYmIG4gJiYgbi56IDw9IG1heFopIHsKICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcCAhPT0gYSAmJiBwICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICBwID0gcC5wcmV2WjsKICAgIGlmIChuLnggPj0geDAgJiYgbi54IDw9IHgxICYmIG4ueSA+PSB5MCAmJiBuLnkgPD0geTEgJiYgbiAhPT0gYSAmJiBuICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIG4ueCwgbi55KSAmJiBhcmVhKG4ucHJldiwgbiwgbi5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICBuID0gbi5uZXh0WjsKICB9CiAgd2hpbGUgKHAgJiYgcC56ID49IG1pblopIHsKICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcCAhPT0gYSAmJiBwICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICBwID0gcC5wcmV2WjsKICB9CiAgd2hpbGUgKG4gJiYgbi56IDw9IG1heFopIHsKICAgIGlmIChuLnggPj0geDAgJiYgbi54IDw9IHgxICYmIG4ueSA+PSB5MCAmJiBuLnkgPD0geTEgJiYgbiAhPT0gYSAmJiBuICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIG4ueCwgbi55KSAmJiBhcmVhKG4ucHJldiwgbiwgbi5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICBuID0gbi5uZXh0WjsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY3VyZUxvY2FsSW50ZXJzZWN0aW9ucyhzdGFydCwgdHJpYW5nbGVzKSB7CiAgbGV0IHAgPSBzdGFydDsKICBkbyB7CiAgICBjb25zdCBhID0gcC5wcmV2LCBiID0gcC5uZXh0Lm5leHQ7CiAgICBpZiAoIWVxdWFscyhhLCBiKSAmJiBpbnRlcnNlY3RzKGEsIHAsIHAubmV4dCwgYikgJiYgbG9jYWxseUluc2lkZShhLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEpKSB7CiAgICAgIHRyaWFuZ2xlcy5wdXNoKGEuaSwgcC5pLCBiLmkpOwogICAgICByZW1vdmVOb2RlKHApOwogICAgICByZW1vdmVOb2RlKHAubmV4dCk7CiAgICAgIHAgPSBzdGFydCA9IGI7CiAgICB9CiAgICBwID0gcC5uZXh0OwogIH0gd2hpbGUgKHAgIT09IHN0YXJ0KTsKICByZXR1cm4gZmlsdGVyUG9pbnRzKHApOwp9CmZ1bmN0aW9uIHNwbGl0RWFyY3V0KHN0YXJ0LCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSkgewogIGxldCBhID0gc3RhcnQ7CiAgZG8gewogICAgbGV0IGIgPSBhLm5leHQubmV4dDsKICAgIHdoaWxlIChiICE9PSBhLnByZXYpIHsKICAgICAgaWYgKGEuaSAhPT0gYi5pICYmIGlzVmFsaWREaWFnb25hbChhLCBiKSkgewogICAgICAgIGxldCBjID0gc3BsaXRQb2x5Z29uKGEsIGIpOwogICAgICAgIGEgPSBmaWx0ZXJQb2ludHMoYSwgYS5uZXh0KTsKICAgICAgICBjID0gZmlsdGVyUG9pbnRzKGMsIGMubmV4dCk7CiAgICAgICAgZWFyY3V0TGlua2VkKGEsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAwKTsKICAgICAgICBlYXJjdXRMaW5rZWQoYywgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBiID0gYi5uZXh0OwogICAgfQogICAgYSA9IGEubmV4dDsKICB9IHdoaWxlIChhICE9PSBzdGFydCk7Cn0KZnVuY3Rpb24gaW5kZXhDdXJ2ZShzdGFydCwgbWluWCwgbWluWSwgaW52U2l6ZSkgewogIGxldCBwID0gc3RhcnQ7CiAgZG8gewogICAgaWYgKHAueiA9PT0gMCkgcC56ID0gek9yZGVyKHAueCwgcC55LCBtaW5YLCBtaW5ZLCBpbnZTaXplKTsKICAgIHAucHJldlogPSBwLnByZXY7CiAgICBwLm5leHRaID0gcC5uZXh0OwogICAgcCA9IHAubmV4dDsKICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgcC5wcmV2Wi5uZXh0WiA9IG51bGw7CiAgcC5wcmV2WiA9IG51bGw7CiAgc29ydExpbmtlZChwKTsKfQpmdW5jdGlvbiBzb3J0TGlua2VkKGxpc3QyKSB7CiAgbGV0IG51bU1lcmdlczsKICBsZXQgaW5TaXplID0gMTsKICBkbyB7CiAgICBsZXQgcCA9IGxpc3QyOwogICAgbGV0IGU7CiAgICBsaXN0MiA9IG51bGw7CiAgICBsZXQgdGFpbCA9IG51bGw7CiAgICBudW1NZXJnZXMgPSAwOwogICAgd2hpbGUgKHApIHsKICAgICAgbnVtTWVyZ2VzKys7CiAgICAgIGxldCBxID0gcDsKICAgICAgbGV0IHBTaXplID0gMDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpblNpemU7IGkrKykgewogICAgICAgIHBTaXplKys7CiAgICAgICAgcSA9IHEubmV4dFo7CiAgICAgICAgaWYgKCFxKSBicmVhazsKICAgICAgfQogICAgICBsZXQgcVNpemUgPSBpblNpemU7CiAgICAgIHdoaWxlIChwU2l6ZSA+IDAgfHwgcVNpemUgPiAwICYmIHEpIHsKICAgICAgICBpZiAocFNpemUgIT09IDAgJiYgKHFTaXplID09PSAwIHx8ICFxIHx8IHAueiA8PSBxLnopKSB7CiAgICAgICAgICBlID0gcDsKICAgICAgICAgIHAgPSBwLm5leHRaOwogICAgICAgICAgcFNpemUtLTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZSA9IHE7CiAgICAgICAgICBxID0gcS5uZXh0WjsKICAgICAgICAgIHFTaXplLS07CiAgICAgICAgfQogICAgICAgIGlmICh0YWlsKSB0YWlsLm5leHRaID0gZTsKICAgICAgICBlbHNlIGxpc3QyID0gZTsKICAgICAgICBlLnByZXZaID0gdGFpbDsKICAgICAgICB0YWlsID0gZTsKICAgICAgfQogICAgICBwID0gcTsKICAgIH0KICAgIHRhaWwubmV4dFogPSBudWxsOwogICAgaW5TaXplICo9IDI7CiAgfSB3aGlsZSAobnVtTWVyZ2VzID4gMSk7CiAgcmV0dXJuIGxpc3QyOwp9CmZ1bmN0aW9uIHpPcmRlcih4LCB5LCBtaW5YLCBtaW5ZLCBpbnZTaXplKSB7CiAgeCA9ICh4IC0gbWluWCkgKiBpbnZTaXplIHwgMDsKICB5ID0gKHkgLSBtaW5ZKSAqIGludlNpemUgfCAwOwogIHggPSAoeCB8IHggPDwgOCkgJiAxNjcxMTkzNTsKICB4ID0gKHggfCB4IDw8IDQpICYgMjUyNjQ1MTM1OwogIHggPSAoeCB8IHggPDwgMikgJiA4NTg5OTM0NTk7CiAgeCA9ICh4IHwgeCA8PCAxKSAmIDE0MzE2NTU3NjU7CiAgeSA9ICh5IHwgeSA8PCA4KSAmIDE2NzExOTM1OwogIHkgPSAoeSB8IHkgPDwgNCkgJiAyNTI2NDUxMzU7CiAgeSA9ICh5IHwgeSA8PCAyKSAmIDg1ODk5MzQ1OTsKICB5ID0gKHkgfCB5IDw8IDEpICYgMTQzMTY1NTc2NTsKICByZXR1cm4geCB8IHkgPDwgMTsKfQpmdW5jdGlvbiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcHgsIHB5KSB7CiAgcmV0dXJuIChjeCAtIHB4KSAqIChheSAtIHB5KSA+PSAoYXggLSBweCkgKiAoY3kgLSBweSkgJiYgKGF4IC0gcHgpICogKGJ5IC0gcHkpID49IChieCAtIHB4KSAqIChheSAtIHB5KSAmJiAoYnggLSBweCkgKiAoY3kgLSBweSkgPj0gKGN4IC0gcHgpICogKGJ5IC0gcHkpOwp9CmZ1bmN0aW9uIHBvaW50SW5UcmlhbmdsZUV4Y2VwdEZpcnN0KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHB4LCBweSkgewogIHJldHVybiAhKGF4ID09PSBweCAmJiBheSA9PT0gcHkpICYmIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBweCwgcHkpOwp9CmZ1bmN0aW9uIGlzVmFsaWREaWFnb25hbChhLCBiKSB7CiAgcmV0dXJuIGEubmV4dC5pICE9PSBiLmkgJiYgYS5wcmV2LmkgIT09IGIuaSAmJiAhaW50ZXJzZWN0c1BvbHlnb24oYSwgYikgJiYgLy8gZG9uZXMndCBpbnRlcnNlY3Qgb3RoZXIgZWRnZXMKICAobG9jYWxseUluc2lkZShhLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEpICYmIG1pZGRsZUluc2lkZShhLCBiKSAmJiAvLyBsb2NhbGx5IHZpc2libGUKICAoYXJlYShhLnByZXYsIGEsIGIucHJldikgfHwgYXJlYShhLCBiLnByZXYsIGIpKSB8fCAvLyBkb2VzIG5vdCBjcmVhdGUgb3Bwb3NpdGUtZmFjaW5nIHNlY3RvcnMKICBlcXVhbHMoYSwgYikgJiYgYXJlYShhLnByZXYsIGEsIGEubmV4dCkgPiAwICYmIGFyZWEoYi5wcmV2LCBiLCBiLm5leHQpID4gMCk7Cn0KZnVuY3Rpb24gYXJlYShwLCBxLCByKSB7CiAgcmV0dXJuIChxLnkgLSBwLnkpICogKHIueCAtIHEueCkgLSAocS54IC0gcC54KSAqIChyLnkgLSBxLnkpOwp9CmZ1bmN0aW9uIGVxdWFscyhwMSwgcDIpIHsKICByZXR1cm4gcDEueCA9PT0gcDIueCAmJiBwMS55ID09PSBwMi55Owp9CmZ1bmN0aW9uIGludGVyc2VjdHMocDEsIHExLCBwMiwgcTIpIHsKICBjb25zdCBvMSA9IHNpZ24oYXJlYShwMSwgcTEsIHAyKSk7CiAgY29uc3QgbzIgPSBzaWduKGFyZWEocDEsIHExLCBxMikpOwogIGNvbnN0IG8zID0gc2lnbihhcmVhKHAyLCBxMiwgcDEpKTsKICBjb25zdCBvNCA9IHNpZ24oYXJlYShwMiwgcTIsIHExKSk7CiAgaWYgKG8xICE9PSBvMiAmJiBvMyAhPT0gbzQpIHJldHVybiB0cnVlOwogIGlmIChvMSA9PT0gMCAmJiBvblNlZ21lbnQocDEsIHAyLCBxMSkpIHJldHVybiB0cnVlOwogIGlmIChvMiA9PT0gMCAmJiBvblNlZ21lbnQocDEsIHEyLCBxMSkpIHJldHVybiB0cnVlOwogIGlmIChvMyA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHAxLCBxMikpIHJldHVybiB0cnVlOwogIGlmIChvNCA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHExLCBxMikpIHJldHVybiB0cnVlOwogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBvblNlZ21lbnQocCwgcSwgcikgewogIHJldHVybiBxLnggPD0gTWF0aC5tYXgocC54LCByLngpICYmIHEueCA+PSBNYXRoLm1pbihwLngsIHIueCkgJiYgcS55IDw9IE1hdGgubWF4KHAueSwgci55KSAmJiBxLnkgPj0gTWF0aC5taW4ocC55LCByLnkpOwp9CmZ1bmN0aW9uIHNpZ24obnVtKSB7CiAgcmV0dXJuIG51bSA+IDAgPyAxIDogbnVtIDwgMCA/IC0xIDogMDsKfQpmdW5jdGlvbiBpbnRlcnNlY3RzUG9seWdvbihhLCBiKSB7CiAgbGV0IHAgPSBhOwogIGRvIHsKICAgIGlmIChwLmkgIT09IGEuaSAmJiBwLm5leHQuaSAhPT0gYS5pICYmIHAuaSAhPT0gYi5pICYmIHAubmV4dC5pICE9PSBiLmkgJiYgaW50ZXJzZWN0cyhwLCBwLm5leHQsIGEsIGIpKSByZXR1cm4gdHJ1ZTsKICAgIHAgPSBwLm5leHQ7CiAgfSB3aGlsZSAocCAhPT0gYSk7CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGxvY2FsbHlJbnNpZGUoYSwgYikgewogIHJldHVybiBhcmVhKGEucHJldiwgYSwgYS5uZXh0KSA8IDAgPyBhcmVhKGEsIGIsIGEubmV4dCkgPj0gMCAmJiBhcmVhKGEsIGEucHJldiwgYikgPj0gMCA6IGFyZWEoYSwgYiwgYS5wcmV2KSA8IDAgfHwgYXJlYShhLCBhLm5leHQsIGIpIDwgMDsKfQpmdW5jdGlvbiBtaWRkbGVJbnNpZGUoYSwgYikgewogIGxldCBwID0gYTsKICBsZXQgaW5zaWRlID0gZmFsc2U7CiAgY29uc3QgcHggPSAoYS54ICsgYi54KSAvIDI7CiAgY29uc3QgcHkgPSAoYS55ICsgYi55KSAvIDI7CiAgZG8gewogICAgaWYgKHAueSA+IHB5ICE9PSBwLm5leHQueSA+IHB5ICYmIHAubmV4dC55ICE9PSBwLnkgJiYgcHggPCAocC5uZXh0LnggLSBwLngpICogKHB5IC0gcC55KSAvIChwLm5leHQueSAtIHAueSkgKyBwLngpCiAgICAgIGluc2lkZSA9ICFpbnNpZGU7CiAgICBwID0gcC5uZXh0OwogIH0gd2hpbGUgKHAgIT09IGEpOwogIHJldHVybiBpbnNpZGU7Cn0KZnVuY3Rpb24gc3BsaXRQb2x5Z29uKGEsIGIpIHsKICBjb25zdCBhMiA9IGNyZWF0ZU5vZGUoYS5pLCBhLngsIGEueSksIGIyID0gY3JlYXRlTm9kZShiLmksIGIueCwgYi55KSwgYW4gPSBhLm5leHQsIGJwID0gYi5wcmV2OwogIGEubmV4dCA9IGI7CiAgYi5wcmV2ID0gYTsKICBhMi5uZXh0ID0gYW47CiAgYW4ucHJldiA9IGEyOwogIGIyLm5leHQgPSBhMjsKICBhMi5wcmV2ID0gYjI7CiAgYnAubmV4dCA9IGIyOwogIGIyLnByZXYgPSBicDsKICByZXR1cm4gYjI7Cn0KZnVuY3Rpb24gaW5zZXJ0Tm9kZShpLCB4LCB5LCBsYXN0KSB7CiAgY29uc3QgcCA9IGNyZWF0ZU5vZGUoaSwgeCwgeSk7CiAgaWYgKCFsYXN0KSB7CiAgICBwLnByZXYgPSBwOwogICAgcC5uZXh0ID0gcDsKICB9IGVsc2UgewogICAgcC5uZXh0ID0gbGFzdC5uZXh0OwogICAgcC5wcmV2ID0gbGFzdDsKICAgIGxhc3QubmV4dC5wcmV2ID0gcDsKICAgIGxhc3QubmV4dCA9IHA7CiAgfQogIHJldHVybiBwOwp9CmZ1bmN0aW9uIHJlbW92ZU5vZGUocCkgewogIHAubmV4dC5wcmV2ID0gcC5wcmV2OwogIHAucHJldi5uZXh0ID0gcC5uZXh0OwogIGlmIChwLnByZXZaKSBwLnByZXZaLm5leHRaID0gcC5uZXh0WjsKICBpZiAocC5uZXh0WikgcC5uZXh0Wi5wcmV2WiA9IHAucHJldlo7Cn0KZnVuY3Rpb24gY3JlYXRlTm9kZShpLCB4LCB5KSB7CiAgcmV0dXJuIHsKICAgIGksCiAgICAvLyB2ZXJ0ZXggaW5kZXggaW4gY29vcmRpbmF0ZXMgYXJyYXkKICAgIHgsCiAgICB5LAogICAgLy8gdmVydGV4IGNvb3JkaW5hdGVzCiAgICBwcmV2OiBudWxsLAogICAgLy8gcHJldmlvdXMgYW5kIG5leHQgdmVydGV4IG5vZGVzIGluIGEgcG9seWdvbiByaW5nCiAgICBuZXh0OiBudWxsLAogICAgejogMCwKICAgIC8vIHotb3JkZXIgY3VydmUgdmFsdWUKICAgIHByZXZaOiBudWxsLAogICAgLy8gcHJldmlvdXMgYW5kIG5leHQgbm9kZXMgaW4gei1vcmRlcgogICAgbmV4dFo6IG51bGwsCiAgICBzdGVpbmVyOiBmYWxzZQogICAgLy8gaW5kaWNhdGVzIHdoZXRoZXIgdGhpcyBpcyBhIHN0ZWluZXIgcG9pbnQKICB9Owp9CmZ1bmN0aW9uIHNpZ25lZEFyZWEoZGF0YSwgc3RhcnQsIGVuZCwgZGltKSB7CiAgbGV0IHN1bSA9IDA7CiAgZm9yIChsZXQgaSA9IHN0YXJ0LCBqID0gZW5kIC0gZGltOyBpIDwgZW5kOyBpICs9IGRpbSkgewogICAgc3VtICs9IChkYXRhW2pdIC0gZGF0YVtpXSkgKiAoZGF0YVtpICsgMV0gKyBkYXRhW2ogKyAxXSk7CiAgICBqID0gaTsKICB9CiAgcmV0dXJuIHN1bTsKfQp2YXIgRlJBR01FTlRfU0hBREVSJDMgPSBgCnByZWNpc2lvbiBtZWRpdW1wIGZsb2F0Owp2YXJ5aW5nIHZlYzQgY29sb3I7CnZvaWQgbWFpbigpIHsKICBnbF9GcmFnQ29sb3IgPSBjb2xvcjsKfWA7CnZhciBWRVJURVhfU0hBREVSJDEgPSBgCnVuaWZvcm0gbWF0NCBwcm9qZWN0aW9uVmlld01vZGVsOwp1bmlmb3JtIGZsb2F0IGFzcGVjdFJhdGlvOwoKdW5pZm9ybSBzYW1wbGVyMkQgY29sb3JUZXg7CnVuaWZvcm0gZmxvYXQgY29sb3JUZXhSZXM7CnVuaWZvcm0gZmxvYXQgY29sb3JUZXhFcHM7CnVuaWZvcm0gZmxvYXQgd2lkdGg7CnVuaWZvcm0gZmxvYXQgdXNlT3BhY2l0eTsKdW5pZm9ybSBmbG9hdCB1c2VDb2xvck9wYWNpdHk7CnVuaWZvcm0gaW50IG1pdGVyOwoKYXR0cmlidXRlIHZlYzMgcHJldlBvc2l0aW9uOwphdHRyaWJ1dGUgdmVjMyBjdXJyUG9zaXRpb247CmF0dHJpYnV0ZSB2ZWMzIG5leHRQb3NpdGlvbjsKYXR0cmlidXRlIGZsb2F0IG9wYWNpdHk7CmF0dHJpYnV0ZSBmbG9hdCBvZmZzZXRTY2FsZTsKYXR0cmlidXRlIGZsb2F0IGNvbG9ySW5kZXg7Cgp2YXJ5aW5nIHZlYzQgY29sb3I7Cgp2b2lkIG1haW4oKSB7CiAgdmVjMiBhc3BlY3RWZWMgPSB2ZWMyKGFzcGVjdFJhdGlvLCAxLjApOwogIHZlYzQgcHJldlByb2plY3RlZCA9IHByb2plY3Rpb25WaWV3TW9kZWwgKiB2ZWM0KHByZXZQb3NpdGlvbiwgMS4wKTsKICB2ZWM0IGN1cnJQcm9qZWN0ZWQgPSBwcm9qZWN0aW9uVmlld01vZGVsICogdmVjNChjdXJyUG9zaXRpb24sIDEuMCk7CiAgdmVjNCBuZXh0UHJvamVjdGVkID0gcHJvamVjdGlvblZpZXdNb2RlbCAqIHZlYzQobmV4dFBvc2l0aW9uLCAxLjApOwoKICAvLyBnZXQgMkQgc2NyZWVuIHNwYWNlIHdpdGggVyBkaXZpZGUgYW5kIGFzcGVjdCBjb3JyZWN0aW9uCiAgdmVjMiBwcmV2U2NyZWVuID0gcHJldlByb2plY3RlZC54eSAvIHByZXZQcm9qZWN0ZWQudyAqIGFzcGVjdFZlYzsKICB2ZWMyIGN1cnJTY3JlZW4gPSBjdXJyUHJvamVjdGVkLnh5IC8gY3VyclByb2plY3RlZC53ICogYXNwZWN0VmVjOwogIHZlYzIgbmV4dFNjcmVlbiA9IG5leHRQcm9qZWN0ZWQueHkgLyBuZXh0UHJvamVjdGVkLncgKiBhc3BlY3RWZWM7CgogIGZsb2F0IGxlbiA9IHdpZHRoOwoKICAvLyBzdGFydGluZyBwb2ludCB1c2VzIChuZXh0IC0gY3VycmVudCkKICB2ZWMyIGRpciA9IHZlYzIoMC4wKTsKICBpZiAoY3VyclNjcmVlbiA9PSBwcmV2U2NyZWVuKSB7CiAgICBkaXIgPSBub3JtYWxpemUobmV4dFNjcmVlbiAtIGN1cnJTY3JlZW4pOwogIH0KICAvLyBlbmRpbmcgcG9pbnQgdXNlcyAoY3VycmVudCAtIHByZXZpb3VzKQogIGVsc2UgaWYgKGN1cnJTY3JlZW4gPT0gbmV4dFNjcmVlbikgewogICAgZGlyID0gbm9ybWFsaXplKGN1cnJTY3JlZW4gLSBwcmV2U2NyZWVuKTsKICB9CiAgLy8gc29tZXdoZXJlIGluIG1pZGRsZSwgbmVlZHMgYSBqb2luCiAgZWxzZSB7CiAgICAvLyBnZXQgZGlyZWN0aW9ucyBmcm9tIChDIC0gQikgYW5kIChCIC0gQSkKICAgIHZlYzIgZGlyQSA9IG5vcm1hbGl6ZSgoY3VyclNjcmVlbiAtIHByZXZTY3JlZW4pKTsKICAgIGlmIChtaXRlciA9PSAxKSB7CiAgICAgIHZlYzIgZGlyQiA9IG5vcm1hbGl6ZSgobmV4dFNjcmVlbiAtIGN1cnJTY3JlZW4pKTsKICAgICAgLy8gbm93IGNvbXB1dGUgdGhlIG1pdGVyIGpvaW4gbm9ybWFsIGFuZCBsZW5ndGgKICAgICAgdmVjMiB0YW5nZW50ID0gbm9ybWFsaXplKGRpckEgKyBkaXJCKTsKICAgICAgdmVjMiBwZXJwID0gdmVjMigtZGlyQS55LCBkaXJBLngpOwogICAgICB2ZWMyIG1pdGVyID0gdmVjMigtdGFuZ2VudC55LCB0YW5nZW50LngpOwogICAgICBsZW4gPSB3aWR0aCAvIGRvdChtaXRlciwgcGVycCk7CiAgICAgIGRpciA9IHRhbmdlbnQ7CiAgICB9IGVsc2UgewogICAgICBkaXIgPSBkaXJBOwogICAgfQogIH0KCiAgdmVjMiBub3JtYWwgPSB2ZWMyKC1kaXIueSwgZGlyLngpICogbGVuOwogIG5vcm1hbC54IC89IGFzcGVjdFJhdGlvOwogIHZlYzQgb2Zmc2V0ID0gdmVjNChub3JtYWwgKiBvZmZzZXRTY2FsZSwgMC4wLCAwLjApOwogIGdsX1Bvc2l0aW9uID0gY3VyclByb2plY3RlZCArIG9mZnNldDsKCiAgLy8gR2V0IGNvbG9yIGZyb20gdGV4dHVyZQogIGZsb2F0IGNvbG9yUm93SW5kZXggPSBmbG9vcigoY29sb3JJbmRleCArIGNvbG9yVGV4RXBzKSAvIGNvbG9yVGV4UmVzKTsKICB2ZWMyIGNvbG9yVGV4SW5kZXggPSB2ZWMyKAogICAgKGNvbG9ySW5kZXggLyBjb2xvclRleFJlcykgLSBjb2xvclJvd0luZGV4ICsgY29sb3JUZXhFcHMsCiAgICBjb2xvclJvd0luZGV4IC8gY29sb3JUZXhSZXMgKyBjb2xvclRleEVwcwogICk7CgogIGNvbG9yID0gdGV4dHVyZTJEKGNvbG9yVGV4LCBjb2xvclRleEluZGV4KTsKICBjb2xvci5hID0gdXNlQ29sb3JPcGFjaXR5ICogY29sb3IuYSArIHVzZU9wYWNpdHkgKiBvcGFjaXR5Owp9YDsKdmFyIEkgPSBuZXcgRmxvYXQzMkFycmF5KFsxLCAwLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAwLCAxXSk7CnZhciBGTE9BVF9CWVRFUyQxID0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwp2YXIgaXNQb3NpdGl2ZU51bWJlciQxID0gKG4pID0+IHsKICByZXR1cm4gbiAhPT0gdm9pZCAwICYmIE51bWJlci5pc0Zpbml0ZShuKTsKfTsKdmFyIGlzTmVzdGVkQXJyYXkgPSAoYXJyKSA9PiB7CiAgcmV0dXJuIGFyci5sZW5ndGggPiAwICYmIEFycmF5LmlzQXJyYXkoYXJyWzBdKTsKfTsKdmFyIHsgcHVzaCwgc3BsaWNlIH0gPSBBcnJheS5wcm90b3R5cGU7CnZhciBjcmVhdGVNZXNoID0gKG51bVBvaW50c1BlckxpbmUsIGJ1ZmZlcjIgPSBbXSkgPT4gewogIGxldCBudW1QcmV2UG9pbnRzID0gMDsKICBmb3IgKGNvbnN0IG51bVBvaW50cyBvZiBudW1Qb2ludHNQZXJMaW5lKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVBvaW50cyAtIDE7IGkrKykgewogICAgICBjb25zdCBhID0gbnVtUHJldlBvaW50cyArIGkgKiAyOwogICAgICBjb25zdCBiID0gYSArIDE7CiAgICAgIGNvbnN0IGMgPSBhICsgMjsKICAgICAgY29uc3QgZCA9IGEgKyAzOwogICAgICBidWZmZXIyLnB1c2goYSwgYiwgYywgYywgYiwgZCk7CiAgICB9CiAgICBudW1QcmV2UG9pbnRzICs9IChudW1Qb2ludHMgKyAyKSAqIDI7CiAgfQogIHJldHVybiBidWZmZXIyOwp9OwpmdW5jdGlvbiBidWZmZXJEdXBsaWNhdGUoYnVmZmVyMiwgc3RyaWRlID0gMSwgZHVwU2NhbGUgPSAxKSB7CiAgY29uc3Qgb3V0ID0gW107CiAgY29uc3QgY29tcG9uZW50ID0gbmV3IEFycmF5KHN0cmlkZSAqIDIpOwogIGZvciAobGV0IGkgPSAwLCBpbCA9IGJ1ZmZlcjIubGVuZ3RoIC8gc3RyaWRlOyBpIDwgaWw7IGkrKykgewogICAgY29uc3QgaW5kZXggPSBpICogc3RyaWRlOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBzdHJpZGU7IGorKykgewogICAgICBjb25zdCB2YWx1ZSA9IGJ1ZmZlcjJbaW5kZXggKyBqXTsKICAgICAgY29tcG9uZW50W2pdID0gdmFsdWU7CiAgICAgIGNvbXBvbmVudFtqICsgc3RyaWRlXSA9IHZhbHVlICogZHVwU2NhbGU7CiAgICB9CiAgICBwdXNoLmFwcGx5KG91dCwgY29tcG9uZW50KTsKICB9CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiBidWZmZXJDb3B5RWxlbWVudChidWZmZXIyLCBzb3VyY2VFbGVtZW50SW5kZXgsIHRhcmdldEluZGV4LCBzdHJpZGUpIHsKICBjb25zdCBjb21wb25lbnQgPSBuZXcgQXJyYXkoc3RyaWRlKTsKICBjb25zdCBhaSA9IHNvdXJjZUVsZW1lbnRJbmRleCAqIHN0cmlkZTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHN0cmlkZTsgaSsrKSB7CiAgICBjb21wb25lbnRbaV0gPSBidWZmZXIyW2FpICsgaV07CiAgfQogIHNwbGljZS5jYWxsKGJ1ZmZlcjIsIHRhcmdldEluZGV4ICogc3RyaWRlLCAwLCAuLi5jb21wb25lbnQpOwogIHJldHVybiBidWZmZXIyOwp9CmZ1bmN0aW9uIGJ1ZmZlckluY3JlYXNlU3RyaWRlKGJ1ZmZlcjIsIHN0cmlkZSwgbmV3U3RyaWRlLCB1bmRlZlZhbHVlID0gMCkgewogIGNvbnN0IG91dCA9IFtdOwogIGNvbnN0IGNvbXBvbmVudCA9IG5ldyBBcnJheShuZXdTdHJpZGUpLmZpbGwodW5kZWZWYWx1ZSk7CiAgZm9yIChsZXQgaSA9IDAsIGlsID0gYnVmZmVyMi5sZW5ndGggLyBzdHJpZGU7IGkgPCBpbDsgaSsrKSB7CiAgICBjb25zdCBpbmRleCA9IGkgKiBzdHJpZGU7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHN0cmlkZTsgaisrKSB7CiAgICAgIGNvbXBvbmVudFtqXSA9IGJ1ZmZlcjJbaW5kZXggKyBqXTsKICAgIH0KICAgIHB1c2guYXBwbHkob3V0LCBjb21wb25lbnQpOwogIH0KICByZXR1cm4gb3V0Owp9CnZhciBjcmVhdGVMaW5lID0gKHJlZ2wsIHsgcHJvamVjdGlvbiA9IEksIG1vZGVsID0gSSwgdmlldyA9IEksIHBvaW50cyA9IFtdLCBjb2xvckluZGljZXMgPSBbXSwgY29sb3I6IGNvbG9yMiA9IFswLjgsIDAuNSwgMCwgMV0sIG9wYWNpdHkgPSBudWxsLCBvcGFjaXRpZXMgPSBbXSwgd2lkdGggPSAxLCB3aWR0aHMgPSBbXSwgbWl0ZXIgPSB0cnVlLCBpczJkID0gZmFsc2UsIHpQb3MyZCA9IDAgfSA9IHt9KSA9PiB7CiAgaWYgKCFyZWdsKSB7CiAgICBjb25zb2xlLmVycm9yKCJSZWdsIGluc3RhbmNlIGlzIHVuZGVmaW5lZC4iKTsKICAgIHJldHVybjsKICB9CiAgY29uc3QgcHZtID0gbmV3IEZsb2F0MzJBcnJheSgxNik7CiAgbGV0IG51bUxpbmVzOwogIGxldCBudW1Qb2ludHM7CiAgbGV0IG51bVBvaW50c1BlckxpbmU7CiAgbGV0IHBvaW50c1BhZGRlZDsKICBsZXQgcG9pbnRzRHVwOwogIGxldCBjb2xvckluZGljZXNEdXA7CiAgbGV0IG9wYWNpdGllc0R1cDsKICBsZXQgd2lkdGhzRHVwOwogIGxldCBpbmRpY2VzOwogIGxldCBwb2ludEJ1ZmZlcjsKICBsZXQgb3BhY2l0eUJ1ZmZlcjsKICBsZXQgd2lkdGhCdWZmZXI7CiAgbGV0IGNvbG9yVGV4OwogIGxldCBjb2xvclRleFJlczsKICBsZXQgY29sb3JJbmRleEJ1ZmZlcjsKICBsZXQgYXR0cmlidXRlczsKICBsZXQgZWxlbWVudHM7CiAgbGV0IGRyYXdMaW5lOwogIGxldCBkaW0gPSBpczJkID8gMiA6IDM7CiAgY29uc3QgdXNlT3BhY2l0eSA9ICgpID0+ICsob3BhY2l0aWVzLmxlbmd0aCA9PT0gbnVtUG9pbnRzIHx8IG9wYWNpdHkgIT09IG51bGwpOwogIGNvbnN0IGluaXQgPSAoKSA9PiB7CiAgICBwb2ludEJ1ZmZlciA9IHJlZ2wuYnVmZmVyKCk7CiAgICBvcGFjaXR5QnVmZmVyID0gcmVnbC5idWZmZXIoKTsKICAgIHdpZHRoQnVmZmVyID0gcmVnbC5idWZmZXIoKTsKICAgIGNvbG9ySW5kZXhCdWZmZXIgPSByZWdsLmJ1ZmZlcigpOwogICAgYXR0cmlidXRlcyA9IHsKICAgICAgcHJldlBvc2l0aW9uOiB7CiAgICAgICAgLy8gVHlwaW5nIGlzc3VlIGluIFJlZ2wKICAgICAgICBidWZmZXI6ICgpID0+IHBvaW50QnVmZmVyLAogICAgICAgIG9mZnNldDogMCwKICAgICAgICBzdHJpZGU6IEZMT0FUX0JZVEVTJDEgKiAzCiAgICAgIH0sCiAgICAgIGN1cnJQb3NpdGlvbjogewogICAgICAgIC8vIFR5cGluZyBpc3N1ZSBpbiBSZWdsCiAgICAgICAgYnVmZmVyOiAoKSA9PiBwb2ludEJ1ZmZlciwKICAgICAgICAvLyBub3RlIHRoYXQgZWFjaCBwb2ludCBpcyBkdXBsaWNhdGVkLCBoZW5jZSB3ZSBuZWVkIHRvIHNraXAgb3ZlciB0aGUgZmlyc3QgdHdvCiAgICAgICAgb2Zmc2V0OiBGTE9BVF9CWVRFUyQxICogMyAqIDIsCiAgICAgICAgc3RyaWRlOiBGTE9BVF9CWVRFUyQxICogMwogICAgICB9LAogICAgICBuZXh0UG9zaXRpb246IHsKICAgICAgICAvLyBUeXBpbmcgaXNzdWUgaW4gUmVnbAogICAgICAgIGJ1ZmZlcjogKCkgPT4gcG9pbnRCdWZmZXIsCiAgICAgICAgLy8gbm90ZSB0aGF0IGVhY2ggcG9pbnQgaXMgZHVwbGljYXRlZCwgaGVuY2Ugd2UgbmVlZCB0byBza2lwIG92ZXIgdGhlIGZpcnN0IGZvdXIKICAgICAgICBvZmZzZXQ6IEZMT0FUX0JZVEVTJDEgKiAzICogNCwKICAgICAgICBzdHJpZGU6IEZMT0FUX0JZVEVTJDEgKiAzCiAgICAgIH0sCiAgICAgIG9wYWNpdHk6IHsKICAgICAgICAvLyBUeXBpbmcgaXNzdWUgaW4gUmVnbAogICAgICAgIGJ1ZmZlcjogKCkgPT4gb3BhY2l0eUJ1ZmZlciwKICAgICAgICAvLyBub3RlIHRoYXQgZWFjaCBwb2ludCBpcyBkdXBsaWNhdGVkLCBoZW5jZSB3ZSBuZWVkIHRvIHNraXAgb3ZlciB0aGUgZmlyc3QgdHdvCiAgICAgICAgb2Zmc2V0OiBGTE9BVF9CWVRFUyQxICogMiwKICAgICAgICBzdHJpZGU6IEZMT0FUX0JZVEVTJDEKICAgICAgfSwKICAgICAgb2Zmc2V0U2NhbGU6IHsKICAgICAgICAvLyBUeXBpbmcgaXNzdWUgaW4gUmVnbAogICAgICAgIGJ1ZmZlcjogKCkgPT4gd2lkdGhCdWZmZXIsCiAgICAgICAgLy8gbm90ZSB0aGF0IGVhY2ggcG9pbnQgaXMgZHVwbGljYXRlZCwgaGVuY2Ugd2UgbmVlZCB0byBza2lwIG92ZXIgdGhlIGZpcnN0IHR3bwogICAgICAgIG9mZnNldDogRkxPQVRfQllURVMkMSAqIDIsCiAgICAgICAgc3RyaWRlOiBGTE9BVF9CWVRFUyQxCiAgICAgIH0sCiAgICAgIGNvbG9ySW5kZXg6IHsKICAgICAgICAvLyBUeXBpbmcgaXNzdWUgaW4gUmVnbAogICAgICAgIGJ1ZmZlcjogKCkgPT4gY29sb3JJbmRleEJ1ZmZlciwKICAgICAgICAvLyBub3RlIHRoYXQgZWFjaCBwb2ludCBpcyBkdXBsaWNhdGVkLCBoZW5jZSB3ZSBuZWVkIHRvIHNraXAgb3ZlciB0aGUgZmlyc3QgdHdvCiAgICAgICAgb2Zmc2V0OiBGTE9BVF9CWVRFUyQxICogMiwKICAgICAgICBzdHJpZGU6IEZMT0FUX0JZVEVTJDEKICAgICAgfQogICAgfTsKICAgIGVsZW1lbnRzID0gcmVnbC5lbGVtZW50cygpOwogICAgZHJhd0xpbmUgPSByZWdsKHsKICAgICAgYXR0cmlidXRlcywKICAgICAgZGVwdGg6IHsgZW5hYmxlOiAhaXMyZCB9LAogICAgICBibGVuZDogewogICAgICAgIGVuYWJsZTogdHJ1ZSwKICAgICAgICBmdW5jOiB7CiAgICAgICAgICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBwcmVkZWZpbmVkIHByb3BlcnR5CiAgICAgICAgICBzcmNSR0I6ICJzcmMgYWxwaGEiLAogICAgICAgICAgc3JjQWxwaGE6ICJvbmUiLAogICAgICAgICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogcHJlZGVmaW5lZCBwcm9wZXJ0eQogICAgICAgICAgZHN0UkdCOiAib25lIG1pbnVzIHNyYyBhbHBoYSIsCiAgICAgICAgICBkc3RBbHBoYTogIm9uZSBtaW51cyBzcmMgYWxwaGEiCiAgICAgICAgfQogICAgICB9LAogICAgICB1bmlmb3JtczogewogICAgICAgIHByb2plY3Rpb25WaWV3TW9kZWw6IChjb250ZXh0LCBwcm9wcykgPT4gewogICAgICAgICAgY29uc3QgcHJvamVjdGlvbjIgPSBjb250ZXh0LnByb2plY3Rpb24gfHwgcHJvcHMucHJvamVjdGlvbjsKICAgICAgICAgIGNvbnN0IG1vZGVsMiA9IGNvbnRleHQubW9kZWwgfHwgcHJvcHMubW9kZWw7CiAgICAgICAgICBjb25zdCB2aWV3MiA9IGNvbnRleHQudmlldyB8fCBwcm9wcy52aWV3OwogICAgICAgICAgcmV0dXJuIG11bHRpcGx5KHB2bSwgcHJvamVjdGlvbjIsIG11bHRpcGx5KHB2bSwgdmlldzIsIG1vZGVsMikpOwogICAgICAgIH0sCiAgICAgICAgYXNwZWN0UmF0aW86ICh7IHZpZXdwb3J0V2lkdGgsIHZpZXdwb3J0SGVpZ2h0IH0pID0+IHZpZXdwb3J0V2lkdGggLyB2aWV3cG9ydEhlaWdodCwKICAgICAgICBjb2xvclRleDogKCkgPT4gY29sb3JUZXgsCiAgICAgICAgY29sb3JUZXhSZXM6ICgpID0+IGNvbG9yVGV4UmVzLAogICAgICAgIGNvbG9yVGV4RXBzOiAoKSA9PiAwLjUgLyBjb2xvclRleFJlcywKICAgICAgICBwaXhlbFJhdGlvOiAoeyBwaXhlbFJhdGlvIH0pID0+IHBpeGVsUmF0aW8sCiAgICAgICAgd2lkdGg6ICh7IHBpeGVsUmF0aW8sIHZpZXdwb3J0SGVpZ2h0IH0pID0+IHdpZHRoIC8gdmlld3BvcnRIZWlnaHQgKiBwaXhlbFJhdGlvLAogICAgICAgIHVzZU9wYWNpdHksCiAgICAgICAgdXNlQ29sb3JPcGFjaXR5OiAoKSA9PiBOdW1iZXIoIXVzZU9wYWNpdHkoKSksCiAgICAgICAgbWl0ZXI6IE51bWJlcihCb29sZWFuKG1pdGVyKSkKICAgICAgfSwKICAgICAgZWxlbWVudHM6ICgpID0+IGVsZW1lbnRzLAogICAgICB2ZXJ0OiBWRVJURVhfU0hBREVSJDEsCiAgICAgIGZyYWc6IEZSQUdNRU5UX1NIQURFUiQzCiAgICB9KTsKICB9OwogIGNvbnN0IHByZXBhcmUgPSAoKSA9PiB7CiAgICBpZiAobnVtTGluZXMgPT09IDEgJiYgcG9pbnRzLmxlbmd0aCAlIGRpbSA+IDApIHsKICAgICAgY29uc29sZS53YXJuKGBUaGUgbGVuZ3RoIG9mIHBvaW50cyAoJHtudW1Qb2ludHN9KSBkb2VzIG5vdCBtYXRjaCB0aGUgZGltZW5zaW9ucyAoJHtkaW19KS4gSW5jb21wbGV0ZSBwb2ludHMgYXJlIGlnbm9yZWQuYCk7CiAgICB9CiAgICBwb2ludHNQYWRkZWQgPSBwb2ludHMuZmxhdCgpLnNsaWNlKDAsIG51bVBvaW50cyAqIGRpbSk7CiAgICBpZiAoaXMyZCkgewogICAgICBwb2ludHNQYWRkZWQgPSBidWZmZXJJbmNyZWFzZVN0cmlkZShwb2ludHNQYWRkZWQsIDIsIDMsIHpQb3MyZCk7CiAgICB9CiAgICBpZiAoY29sb3JJbmRpY2VzLmxlbmd0aCAhPT0gbnVtUG9pbnRzKSB7CiAgICAgIGNvbG9ySW5kaWNlcyA9IG5ldyBBcnJheShudW1Qb2ludHMpLmZpbGwoMCk7CiAgICB9CiAgICBpZiAod2lkdGhzLmxlbmd0aCAhPT0gbnVtUG9pbnRzKSB7CiAgICAgIHdpZHRocyA9IG5ldyBBcnJheShudW1Qb2ludHMpLmZpbGwoMSk7CiAgICB9CiAgICBjb25zdCBmaW5hbENvbG9ySW5kaWNlcyA9IGNvbG9ySW5kaWNlcy5zbGljZSgpOwogICAgY29uc3QgZmluYWxPcGFjaXRpZXMgPSBvcGFjaXRpZXMubGVuZ3RoID09PSBudW1Qb2ludHMgPyBvcGFjaXRpZXMuc2xpY2UoKSA6IG5ldyBBcnJheShudW1Qb2ludHMpLmZpbGwob3BhY2l0eSA9PT0gbnVsbCA/IDEgOiBvcGFjaXR5KTsKICAgIGNvbnN0IGZpbmFsV2lkdGhzID0gd2lkdGhzLnNsaWNlKCk7CiAgICBsZXQgayA9IDA7CiAgICBmb3IgKGNvbnN0IG4gb2YgbnVtUG9pbnRzUGVyTGluZSkgewogICAgICBjb25zdCBsYXN0UG9pbnRJZHggPSBrICsgbiAtIDE7CiAgICAgIGJ1ZmZlckNvcHlFbGVtZW50KHBvaW50c1BhZGRlZCwgbGFzdFBvaW50SWR4LCBsYXN0UG9pbnRJZHgsIDMpOwogICAgICBidWZmZXJDb3B5RWxlbWVudChwb2ludHNQYWRkZWQsIGssIGssIDMpOwogICAgICBidWZmZXJDb3B5RWxlbWVudChmaW5hbENvbG9ySW5kaWNlcywgbGFzdFBvaW50SWR4LCBsYXN0UG9pbnRJZHgsIDEpOwogICAgICBidWZmZXJDb3B5RWxlbWVudChmaW5hbENvbG9ySW5kaWNlcywgaywgaywgMSk7CiAgICAgIGJ1ZmZlckNvcHlFbGVtZW50KGZpbmFsT3BhY2l0aWVzLCBsYXN0UG9pbnRJZHgsIGxhc3RQb2ludElkeCwgMSk7CiAgICAgIGJ1ZmZlckNvcHlFbGVtZW50KGZpbmFsT3BhY2l0aWVzLCBrLCBrLCAxKTsKICAgICAgYnVmZmVyQ29weUVsZW1lbnQoZmluYWxXaWR0aHMsIGxhc3RQb2ludElkeCwgbGFzdFBvaW50SWR4LCAxKTsKICAgICAgYnVmZmVyQ29weUVsZW1lbnQoZmluYWxXaWR0aHMsIGssIGssIDEpOwogICAgICBrICs9IG4gKyAyOwogICAgfQogICAgcG9pbnRzRHVwID0gbmV3IEZsb2F0MzJBcnJheShidWZmZXJEdXBsaWNhdGUocG9pbnRzUGFkZGVkLCAzKSk7CiAgICBjb2xvckluZGljZXNEdXAgPSBidWZmZXJEdXBsaWNhdGUoZmluYWxDb2xvckluZGljZXMpOwogICAgb3BhY2l0aWVzRHVwID0gYnVmZmVyRHVwbGljYXRlKGZpbmFsT3BhY2l0aWVzKTsKICAgIHdpZHRoc0R1cCA9IGJ1ZmZlckR1cGxpY2F0ZShmaW5hbFdpZHRocywgMSwgLTEpOwogICAgaW5kaWNlcyA9IGNyZWF0ZU1lc2gobnVtUG9pbnRzUGVyTGluZSk7CiAgICBwb2ludEJ1ZmZlcih7CiAgICAgIHVzYWdlOiAiZHluYW1pYyIsCiAgICAgIHR5cGU6ICJmbG9hdCIsCiAgICAgIGxlbmd0aDogcG9pbnRzRHVwLmxlbmd0aCAqIEZMT0FUX0JZVEVTJDEsCiAgICAgIGRhdGE6IHBvaW50c0R1cAogICAgfSk7CiAgICBvcGFjaXR5QnVmZmVyKHsKICAgICAgdXNhZ2U6ICJkeW5hbWljIiwKICAgICAgdHlwZTogImZsb2F0IiwKICAgICAgbGVuZ3RoOiBvcGFjaXRpZXNEdXAubGVuZ3RoICogRkxPQVRfQllURVMkMSwKICAgICAgZGF0YTogb3BhY2l0aWVzRHVwCiAgICB9KTsKICAgIHdpZHRoQnVmZmVyKHsKICAgICAgdXNhZ2U6ICJkeW5hbWljIiwKICAgICAgdHlwZTogImZsb2F0IiwKICAgICAgbGVuZ3RoOiB3aWR0aHNEdXAubGVuZ3RoICogRkxPQVRfQllURVMkMSwKICAgICAgZGF0YTogd2lkdGhzRHVwCiAgICB9KTsKICAgIGNvbG9ySW5kZXhCdWZmZXIoewogICAgICB1c2FnZTogImR5bmFtaWMiLAogICAgICB0eXBlOiAiZmxvYXQiLAogICAgICBsZW5ndGg6IGNvbG9ySW5kaWNlc0R1cC5sZW5ndGggKiBGTE9BVF9CWVRFUyQxLAogICAgICBkYXRhOiBjb2xvckluZGljZXNEdXAKICAgIH0pOwogICAgZWxlbWVudHMoewogICAgICBwcmltaXRpdmU6ICJ0cmlhbmdsZXMiLAogICAgICB1c2FnZTogImR5bmFtaWMiLAogICAgICB0eXBlOiBpbmRpY2VzLmxlbmd0aCA+IDIgKiogMTYgPyAidWludDMyIiA6ICJ1aW50MTYiLAogICAgICBkYXRhOiBpbmRpY2VzCiAgICB9KTsKICB9OwogIGNvbnN0IGNsZWFyID0gKCkgPT4gewogICAgZGVzdHJveSgpOwogICAgaW5pdCgpOwogIH07CiAgY29uc3QgZGVzdHJveSA9ICgpID0+IHsKICAgIHBvaW50cyA9IFtdOwogICAgcG9pbnRzUGFkZGVkID0gW107CiAgICBwb2ludHNEdXAgPSBuZXcgRmxvYXQzMkFycmF5KCk7CiAgICB3aWR0aHNEdXAgPSBbXTsKICAgIGluZGljZXMgPSBbXTsKICAgIHBvaW50QnVmZmVyLmRlc3Ryb3koKTsKICAgIHdpZHRoQnVmZmVyLmRlc3Ryb3koKTsKICAgIGVsZW1lbnRzLmRlc3Ryb3koKTsKICB9OwogIGNvbnN0IGRyYXcgPSAoeyBwcm9qZWN0aW9uOiBuZXdQcm9qZWN0aW9uLCBtb2RlbDogbmV3TW9kZWwsIHZpZXc6IG5ld1ZpZXcgfSA9IHt9KSA9PiB7CiAgICBpZiAobmV3UHJvamVjdGlvbikgewogICAgICBwcm9qZWN0aW9uID0gbmV3UHJvamVjdGlvbjsKICAgIH0KICAgIGlmIChuZXdNb2RlbCkgewogICAgICBtb2RlbCA9IG5ld01vZGVsOwogICAgfQogICAgaWYgKG5ld1ZpZXcpIHsKICAgICAgdmlldyA9IG5ld1ZpZXc7CiAgICB9CiAgICBpZiAocG9pbnRzICYmIHBvaW50cy5sZW5ndGggPiAxKSB7CiAgICAgIGRyYXdMaW5lKHsgcHJvamVjdGlvbiwgbW9kZWwsIHZpZXcgfSk7CiAgICB9CiAgfTsKICBjb25zdCBnZXRQZXJQb2ludFByb3BlcnR5ID0gKHByb3BlcnR5LCBuZXdWYWx1ZXMpID0+IHsKICAgIGNvbnN0IGZsYXRWYWx1ZXMgPSBuZXdWYWx1ZXMuZmxhdCgyKTsKICAgIGlmIChmbGF0VmFsdWVzLmxlbmd0aCA9PT0gbnVtUG9pbnRzKSB7CiAgICAgIHJldHVybiBmbGF0VmFsdWVzOwogICAgfQogICAgaWYgKGZsYXRWYWx1ZXMubGVuZ3RoID09PSBudW1MaW5lcykgewogICAgICByZXR1cm4gbnVtUG9pbnRzUGVyTGluZS5mbGF0TWFwKChuLCBpKSA9PiBBcnJheShuKS5maWxsKGZsYXRWYWx1ZXNbaV0pKTsKICAgIH0KICAgIHJldHVybiBwcm9wZXJ0eTsKICB9OwogIGNvbnN0IGdldFBvaW50cyA9ICgpID0+IHBvaW50czsKICBjb25zdCBzZXRQb2ludHMgPSAobmV3UG9pbnRzID0gW10sIHsgY29sb3JJbmRpY2VzOiBuZXdDb2xvckluZGljZXMgPSBjb2xvckluZGljZXMsIG9wYWNpdGllczogbmV3T3BhY2l0aWVzID0gb3BhY2l0aWVzLCB3aWR0aHM6IG5ld1dpZHRocyA9IHdpZHRocywgaXMyZDogbmV3SXMyZCA9IGlzMmQgfSA9IHt9KSA9PiB7CiAgICBwb2ludHMgPSBuZXdQb2ludHM7CiAgICBpczJkID0gbmV3SXMyZDsKICAgIGRpbSA9IGlzMmQgPyAyIDogMzsKICAgIG51bUxpbmVzID0gaXNOZXN0ZWRBcnJheShwb2ludHMpID8gcG9pbnRzLmxlbmd0aCA6IDE7CiAgICBudW1Qb2ludHNQZXJMaW5lID0gaXNOZXN0ZWRBcnJheShwb2ludHMpID8gcG9pbnRzLm1hcCgocHRzKSA9PiBNYXRoLmZsb29yKHB0cy5sZW5ndGggLyBkaW0pKSA6IFtNYXRoLmZsb29yKHBvaW50cy5sZW5ndGggLyBkaW0pXTsKICAgIG51bVBvaW50cyA9IG51bVBvaW50c1BlckxpbmUucmVkdWNlKChuLCBuUHRzKSA9PiBuICsgblB0cywgMCk7CiAgICBjb2xvckluZGljZXMgPSBnZXRQZXJQb2ludFByb3BlcnR5KGNvbG9ySW5kaWNlcywgbmV3Q29sb3JJbmRpY2VzKTsKICAgIG9wYWNpdGllcyA9IGdldFBlclBvaW50UHJvcGVydHkob3BhY2l0aWVzLCBuZXdPcGFjaXRpZXMpOwogICAgd2lkdGhzID0gZ2V0UGVyUG9pbnRQcm9wZXJ0eSh3aWR0aHMsIG5ld1dpZHRocyk7CiAgICBpZiAocG9pbnRzICYmIG51bVBvaW50cyA+IDEpIHsKICAgICAgcHJlcGFyZSgpOwogICAgfSBlbHNlIHsKICAgICAgY2xlYXIoKTsKICAgIH0KICB9OwogIGNvbnN0IGNyZWF0ZUNvbG9yVGV4dHVyZSA9ICgpID0+IHsKICAgIGNvbnN0IGNvbG9ycyA9IGlzTmVzdGVkQXJyYXkoY29sb3IyKSA/IGNvbG9yMiA6IFtjb2xvcjJdOwogICAgY29sb3JUZXhSZXMgPSBNYXRoLm1heCgyLCBNYXRoLmNlaWwoTWF0aC5zcXJ0KGNvbG9ycy5sZW5ndGgpKSk7CiAgICBjb25zdCByZ2JhMiA9IG5ldyBVaW50OEFycmF5KGNvbG9yVGV4UmVzICoqIDIgKiA0KTsKICAgIGNvbG9ycy5mb3JFYWNoKChjb2xvcjMsIGkpID0+IHsKICAgICAgcmdiYTJbaSAqIDRdID0gTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCBNYXRoLnJvdW5kKGNvbG9yM1swXSAqIDI1NSkpKTsKICAgICAgcmdiYTJbaSAqIDQgKyAxXSA9IE1hdGgubWluKDI1NSwgTWF0aC5tYXgoMCwgTWF0aC5yb3VuZChjb2xvcjNbMV0gKiAyNTUpKSk7CiAgICAgIHJnYmEyW2kgKiA0ICsgMl0gPSBNYXRoLm1pbigyNTUsIE1hdGgubWF4KDAsIE1hdGgucm91bmQoY29sb3IzWzJdICogMjU1KSkpOwogICAgICByZ2JhMltpICogNCArIDNdID0gTnVtYmVyLmlzTmFOKCtjb2xvcjNbM10pID8gMjU1IDogTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCBNYXRoLnJvdW5kKGNvbG9yM1szXSAqIDI1NSkpKTsKICAgIH0pOwogICAgY29sb3JUZXggPSByZWdsLnRleHR1cmUoewogICAgICBkYXRhOiByZ2JhMiwKICAgICAgc2hhcGU6IFtjb2xvclRleFJlcywgY29sb3JUZXhSZXMsIDRdCiAgICB9KTsKICB9OwogIGNvbnN0IHNldENvbG9yID0gKG5ld0NvbG9yLCBuZXdPcGFjaXR5ID0gb3BhY2l0eSkgPT4gewogICAgY29sb3IyID0gbmV3Q29sb3I7CiAgICBvcGFjaXR5ID0gbmV3T3BhY2l0eTsKICAgIGlmIChjb2xvclRleCkgewogICAgICBjb2xvclRleC5kZXN0cm95KCk7CiAgICB9CiAgICBjcmVhdGVDb2xvclRleHR1cmUoKTsKICB9OwogIGNvbnN0IGdldFN0eWxlID0gKCkgPT4gKHsgY29sb3I6IGNvbG9yMiwgbWl0ZXIsIHdpZHRoIH0pOwogIGNvbnN0IHNldFN0eWxlID0gKHsgY29sb3I6IG5ld0NvbG9yLCBvcGFjaXR5OiBuZXdPcGFjaXR5LCBtaXRlcjogbmV3TWl0ZXIsIHdpZHRoOiBuZXdXaWR0aCB9ID0ge30pID0+IHsKICAgIGlmIChuZXdDb2xvcikgewogICAgICBzZXRDb2xvcihuZXdDb2xvciwgbmV3T3BhY2l0eSB8fCBvcGFjaXR5KTsKICAgIH0KICAgIGlmIChuZXdNaXRlcikgewogICAgICBtaXRlciA9IEJvb2xlYW4obmV3TWl0ZXIpOwogICAgfQogICAgaWYgKGlzUG9zaXRpdmVOdW1iZXIkMShuZXdXaWR0aCkpIHsKICAgICAgd2lkdGggPSBuZXdXaWR0aDsKICAgIH0KICB9OwogIGNvbnN0IGdldEJ1ZmZlciA9ICgpID0+ICh7CiAgICBwb2ludHM6IHBvaW50QnVmZmVyLAogICAgd2lkdGhzOiB3aWR0aEJ1ZmZlciwKICAgIG9wYWNpdGllczogb3BhY2l0eUJ1ZmZlciwKICAgIGNvbG9ySW5kaWNlczogY29sb3JJbmRleEJ1ZmZlcgogIH0pOwogIGNvbnN0IGdldERhdGEgPSAoKSA9PiAoewogICAgcG9pbnRzOiBwb2ludHNEdXAsCiAgICB3aWR0aHM6IHdpZHRoc0R1cCwKICAgIG9wYWNpdGllczogb3BhY2l0aWVzRHVwLAogICAgY29sb3JJbmRpY2VzOiBjb2xvckluZGljZXNEdXAKICB9KTsKICBpbml0KCk7CiAgY3JlYXRlQ29sb3JUZXh0dXJlKCk7CiAgaWYgKHBvaW50cyAmJiBwb2ludHMubGVuZ3RoID4gMSkgewogICAgc2V0UG9pbnRzKHBvaW50cyk7CiAgfQogIHJldHVybiB7CiAgICBjbGVhciwKICAgIGRlc3Ryb3ksCiAgICBkcmF3LAogICAgZ2V0UG9pbnRzLAogICAgc2V0UG9pbnRzLAogICAgZ2V0RGF0YSwKICAgIGdldEJ1ZmZlciwKICAgIGdldFN0eWxlLAogICAgc2V0U3R5bGUKICB9Owp9Owp2YXIgY3JlYXRlS0RCdXNoQ2xhc3MgPSAoKSA9PiB7CiAgY29uc3QgQVJSQVlfVFlQRVMgPSBbCiAgICBJbnQ4QXJyYXksCiAgICBVaW50OEFycmF5LAogICAgVWludDhDbGFtcGVkQXJyYXksCiAgICBJbnQxNkFycmF5LAogICAgVWludDE2QXJyYXksCiAgICBJbnQzMkFycmF5LAogICAgVWludDMyQXJyYXksCiAgICBGbG9hdDMyQXJyYXksCiAgICBGbG9hdDY0QXJyYXkKICBdOwogIGNvbnN0IFZFUlNJT04gPSAxOwogIGNvbnN0IEhFQURFUl9TSVpFID0gODsKICBjbGFzcyBLREJ1c2gyIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBpbmRleCBmcm9tIHJhdyBgQXJyYXlCdWZmZXJgIGRhdGEuCiAgICAgKiBAcGFyYW0ge0FycmF5QnVmZmVyfSBkYXRhCiAgICAgKi8KICAgIHN0YXRpYyBmcm9tKGRhdGEpIHsKICAgICAgaWYgKCEoZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRGF0YSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIEFycmF5QnVmZmVyLiIpOwogICAgICB9CiAgICAgIGNvbnN0IFttYWdpYywgdmVyc2lvbkFuZFR5cGVdID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSwgMCwgMik7CiAgICAgIGlmIChtYWdpYyAhPT0gMjE5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEYXRhIGRvZXMgbm90IGFwcGVhciB0byBiZSBpbiBhIEtEQnVzaCBmb3JtYXQuIik7CiAgICAgIH0KICAgICAgY29uc3QgdmVyc2lvbjMgPSB2ZXJzaW9uQW5kVHlwZSA+PiA0OwogICAgICBpZiAodmVyc2lvbjMgIT09IFZFUlNJT04pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEdvdCB2JHt2ZXJzaW9uM30gZGF0YSB3aGVuIGV4cGVjdGVkIHYke1ZFUlNJT059LmApOwogICAgICB9CiAgICAgIGNvbnN0IEFycmF5VHlwZSA9IEFSUkFZX1RZUEVTW3ZlcnNpb25BbmRUeXBlICYgMTVdOwogICAgICBpZiAoIUFycmF5VHlwZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIGFycmF5IHR5cGUuIik7CiAgICAgIH0KICAgICAgY29uc3QgW25vZGVTaXplXSA9IG5ldyBVaW50MTZBcnJheShkYXRhLCAyLCAxKTsKICAgICAgY29uc3QgW251bUl0ZW1zXSA9IG5ldyBVaW50MzJBcnJheShkYXRhLCA0LCAxKTsKICAgICAgcmV0dXJuIG5ldyBLREJ1c2gyKG51bUl0ZW1zLCBub2RlU2l6ZSwgQXJyYXlUeXBlLCBkYXRhKTsKICAgIH0KICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBpbmRleCB0aGF0IHdpbGwgaG9sZCBhIGdpdmVuIG51bWJlciBvZiBpdGVtcy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBudW1JdGVtcwogICAgICogQHBhcmFtIHtudW1iZXJ9IFtub2RlU2l6ZT02NF0gU2l6ZSBvZiB0aGUgS0QtdHJlZSBub2RlICg2NCBieSBkZWZhdWx0KS4KICAgICAqIEBwYXJhbSB7VHlwZWRBcnJheUNvbnN0cnVjdG9yfSBbQXJyYXlUeXBlPUZsb2F0NjRBcnJheV0gVGhlIGFycmF5IHR5cGUgdXNlZCBmb3IgY29vcmRpbmF0ZXMgc3RvcmFnZSAoYEZsb2F0NjRBcnJheWAgYnkgZGVmYXVsdCkuCiAgICAgKiBAcGFyYW0ge0FycmF5QnVmZmVyfSBbZGF0YV0gKEZvciBpbnRlcm5hbCB1c2Ugb25seSkKICAgICAqLwogICAgY29uc3RydWN0b3IobnVtSXRlbXMsIG5vZGVTaXplID0gNjQsIEFycmF5VHlwZSA9IEZsb2F0NjRBcnJheSwgZGF0YSkgewogICAgICBpZiAoaXNOYU4obnVtSXRlbXMpIHx8IG51bUl0ZW1zIDwgMCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgbnVtSXRlbXMgdmFsdWU6ICR7bnVtSXRlbXN9LmApOwogICAgICB0aGlzLm51bUl0ZW1zID0gK251bUl0ZW1zOwogICAgICB0aGlzLm5vZGVTaXplID0gTWF0aC5taW4oTWF0aC5tYXgoK25vZGVTaXplLCAyKSwgNjU1MzUpOwogICAgICB0aGlzLkFycmF5VHlwZSA9IEFycmF5VHlwZTsKICAgICAgdGhpcy5JbmRleEFycmF5VHlwZSA9IG51bUl0ZW1zIDwgNjU1MzYgPyBVaW50MTZBcnJheSA6IFVpbnQzMkFycmF5OwogICAgICBjb25zdCBhcnJheVR5cGVJbmRleCA9IEFSUkFZX1RZUEVTLmluZGV4T2YodGhpcy5BcnJheVR5cGUpOwogICAgICBjb25zdCBjb29yZHNCeXRlU2l6ZSA9IG51bUl0ZW1zICogMiAqIHRoaXMuQXJyYXlUeXBlLkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBjb25zdCBpZHNCeXRlU2l6ZSA9IG51bUl0ZW1zICogdGhpcy5JbmRleEFycmF5VHlwZS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgY29uc3QgcGFkQ29vcmRzID0gKDggLSBpZHNCeXRlU2l6ZSAlIDgpICUgODsKICAgICAgaWYgKGFycmF5VHlwZUluZGV4IDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlZCBhcnJheSBjbGFzczogJHtBcnJheVR5cGV9LmApOwogICAgICB9CiAgICAgIGlmIChkYXRhICYmIGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgICAgdGhpcy5pZHMgPSBuZXcgdGhpcy5JbmRleEFycmF5VHlwZSh0aGlzLmRhdGEsIEhFQURFUl9TSVpFLCBudW1JdGVtcyk7CiAgICAgICAgdGhpcy5jb29yZHMgPSBuZXcgdGhpcy5BcnJheVR5cGUoCiAgICAgICAgICB0aGlzLmRhdGEsCiAgICAgICAgICBIRUFERVJfU0laRSArIGlkc0J5dGVTaXplICsgcGFkQ29vcmRzLAogICAgICAgICAgbnVtSXRlbXMgKiAyCiAgICAgICAgKTsKICAgICAgICB0aGlzLl9wb3MgPSBudW1JdGVtcyAqIDI7CiAgICAgICAgdGhpcy5fZmluaXNoZWQgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZGF0YSA9IG5ldyBBcnJheUJ1ZmZlcigKICAgICAgICAgIEhFQURFUl9TSVpFICsgY29vcmRzQnl0ZVNpemUgKyBpZHNCeXRlU2l6ZSArIHBhZENvb3JkcwogICAgICAgICk7CiAgICAgICAgdGhpcy5pZHMgPSBuZXcgdGhpcy5JbmRleEFycmF5VHlwZSh0aGlzLmRhdGEsIEhFQURFUl9TSVpFLCBudW1JdGVtcyk7CiAgICAgICAgdGhpcy5jb29yZHMgPSBuZXcgdGhpcy5BcnJheVR5cGUoCiAgICAgICAgICB0aGlzLmRhdGEsCiAgICAgICAgICBIRUFERVJfU0laRSArIGlkc0J5dGVTaXplICsgcGFkQ29vcmRzLAogICAgICAgICAgbnVtSXRlbXMgKiAyCiAgICAgICAgKTsKICAgICAgICB0aGlzLl9wb3MgPSAwOwogICAgICAgIHRoaXMuX2ZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgbmV3IFVpbnQ4QXJyYXkodGhpcy5kYXRhLCAwLCAyKS5zZXQoWwogICAgICAgICAgMjE5LAogICAgICAgICAgKFZFUlNJT04gPDwgNCkgKyBhcnJheVR5cGVJbmRleAogICAgICAgIF0pOwogICAgICAgIG5ldyBVaW50MTZBcnJheSh0aGlzLmRhdGEsIDIsIDEpWzBdID0gbm9kZVNpemU7CiAgICAgICAgbmV3IFVpbnQzMkFycmF5KHRoaXMuZGF0YSwgNCwgMSlbMF0gPSBudW1JdGVtczsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSBwb2ludCB0byB0aGUgaW5kZXguCiAgICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgICogQHBhcmFtIHtudW1iZXJ9IHkKICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IEFuIGluY3JlbWVudGFsIGluZGV4IGFzc29jaWF0ZWQgd2l0aCB0aGUgYWRkZWQgaXRlbSAoc3RhcnRpbmcgZnJvbSBgMGApLgogICAgICovCiAgICBhZGQoeCwgeSkgewogICAgICBjb25zdCBpbmRleCA9IHRoaXMuX3BvcyA+PiAxOwogICAgICB0aGlzLmlkc1tpbmRleF0gPSBpbmRleDsKICAgICAgdGhpcy5jb29yZHNbdGhpcy5fcG9zKytdID0geDsKICAgICAgdGhpcy5jb29yZHNbdGhpcy5fcG9zKytdID0geTsKICAgICAgcmV0dXJuIGluZGV4OwogICAgfQogICAgLyoqCiAgICAgKiBQZXJmb3JtIGluZGV4aW5nIG9mIHRoZSBhZGRlZCBwb2ludHMuCiAgICAgKi8KICAgIGZpbmlzaCgpIHsKICAgICAgY29uc3QgbnVtQWRkZWQgPSB0aGlzLl9wb3MgPj4gMTsKICAgICAgaWYgKG51bUFkZGVkICE9PSB0aGlzLm51bUl0ZW1zKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgYEFkZGVkICR7bnVtQWRkZWR9IGl0ZW1zIHdoZW4gZXhwZWN0ZWQgJHt0aGlzLm51bUl0ZW1zfS5gCiAgICAgICAgKTsKICAgICAgfQogICAgICBzb3J0KHRoaXMuaWRzLCB0aGlzLmNvb3JkcywgdGhpcy5ub2RlU2l6ZSwgMCwgdGhpcy5udW1JdGVtcyAtIDEsIDApOwogICAgICB0aGlzLl9maW5pc2hlZCA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBTZWFyY2ggdGhlIGluZGV4IGZvciBpdGVtcyB3aXRoaW4gYSBnaXZlbiBib3VuZGluZyBib3guCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWluWAogICAgICogQHBhcmFtIHtudW1iZXJ9IG1pblkKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhYCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4WQogICAgICogQHJldHVybnMge251bWJlcltdfSBBbiBhcnJheSBvZiBpbmRpY2VzIGNvcnJlcG9uZGluZyB0byB0aGUgZm91bmQgaXRlbXMuCiAgICAgKi8KICAgIHJhbmdlKG1pblgsIG1pblksIG1heFgsIG1heFkpIHsKICAgICAgaWYgKCF0aGlzLl9maW5pc2hlZCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRhdGEgbm90IHlldCBpbmRleGVkIC0gY2FsbCBpbmRleC5maW5pc2goKS4iKTsKICAgICAgY29uc3QgeyBpZHMsIGNvb3Jkcywgbm9kZVNpemUgfSA9IHRoaXM7CiAgICAgIGNvbnN0IHN0YWNrID0gWzAsIGlkcy5sZW5ndGggLSAxLCAwXTsKICAgICAgY29uc3QgcmVzdWx0ID0gW107CiAgICAgIHdoaWxlIChzdGFjay5sZW5ndGgpIHsKICAgICAgICBjb25zdCBheGlzMiA9IHN0YWNrLnBvcCgpIHx8IDA7CiAgICAgICAgY29uc3QgcmlnaHQyID0gc3RhY2sucG9wKCkgfHwgMDsKICAgICAgICBjb25zdCBsZWZ0MiA9IHN0YWNrLnBvcCgpIHx8IDA7CiAgICAgICAgaWYgKHJpZ2h0MiAtIGxlZnQyIDw9IG5vZGVTaXplKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gbGVmdDI7IGkgPD0gcmlnaHQyOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgeDIgPSBjb29yZHNbMiAqIGldOwogICAgICAgICAgICBjb25zdCB5MiA9IGNvb3Jkc1syICogaSArIDFdOwogICAgICAgICAgICBpZiAoeDIgPj0gbWluWCAmJiB4MiA8PSBtYXhYICYmIHkyID49IG1pblkgJiYgeTIgPD0gbWF4WSkKICAgICAgICAgICAgICByZXN1bHQucHVzaChpZHNbaV0pOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG0gPSBsZWZ0MiArIHJpZ2h0MiA+PiAxOwogICAgICAgIGNvbnN0IHggPSBjb29yZHNbMiAqIG1dOwogICAgICAgIGNvbnN0IHkgPSBjb29yZHNbMiAqIG0gKyAxXTsKICAgICAgICBpZiAoeCA+PSBtaW5YICYmIHggPD0gbWF4WCAmJiB5ID49IG1pblkgJiYgeSA8PSBtYXhZKQogICAgICAgICAgcmVzdWx0LnB1c2goaWRzW21dKTsKICAgICAgICBpZiAoYXhpczIgPT09IDAgPyBtaW5YIDw9IHggOiBtaW5ZIDw9IHkpIHsKICAgICAgICAgIHN0YWNrLnB1c2gobGVmdDIpOwogICAgICAgICAgc3RhY2sucHVzaChtIC0gMSk7CiAgICAgICAgICBzdGFjay5wdXNoKDEgLSBheGlzMik7CiAgICAgICAgfQogICAgICAgIGlmIChheGlzMiA9PT0gMCA/IG1heFggPj0geCA6IG1heFkgPj0geSkgewogICAgICAgICAgc3RhY2sucHVzaChtICsgMSk7CiAgICAgICAgICBzdGFjay5wdXNoKHJpZ2h0Mik7CiAgICAgICAgICBzdGFjay5wdXNoKDEgLSBheGlzMik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIFNlYXJjaCB0aGUgaW5kZXggZm9yIGl0ZW1zIHdpdGhpbiBhIGdpdmVuIHJhZGl1cy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBxeAogICAgICogQHBhcmFtIHtudW1iZXJ9IHF5CiAgICAgKiBAcGFyYW0ge251bWJlcn0gciBRdWVyeSByYWRpdXMuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IEFuIGFycmF5IG9mIGluZGljZXMgY29ycmVwb25kaW5nIHRvIHRoZSBmb3VuZCBpdGVtcy4KICAgICAqLwogICAgd2l0aGluKHF4LCBxeSwgcikgewogICAgICBpZiAoIXRoaXMuX2ZpbmlzaGVkKQogICAgICAgIHRocm93IG5ldyBFcnJvcigiRGF0YSBub3QgeWV0IGluZGV4ZWQgLSBjYWxsIGluZGV4LmZpbmlzaCgpLiIpOwogICAgICBjb25zdCB7IGlkcywgY29vcmRzLCBub2RlU2l6ZSB9ID0gdGhpczsKICAgICAgY29uc3Qgc3RhY2sgPSBbMCwgaWRzLmxlbmd0aCAtIDEsIDBdOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgcjIgPSByICogcjsKICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGF4aXMyID0gc3RhY2sucG9wKCkgfHwgMDsKICAgICAgICBjb25zdCByaWdodDIgPSBzdGFjay5wb3AoKSB8fCAwOwogICAgICAgIGNvbnN0IGxlZnQyID0gc3RhY2sucG9wKCkgfHwgMDsKICAgICAgICBpZiAocmlnaHQyIC0gbGVmdDIgPD0gbm9kZVNpemUpIHsKICAgICAgICAgIGZvciAobGV0IGkgPSBsZWZ0MjsgaSA8PSByaWdodDI7IGkrKykgewogICAgICAgICAgICBpZiAoc3FEaXN0KGNvb3Jkc1syICogaV0sIGNvb3Jkc1syICogaSArIDFdLCBxeCwgcXkpIDw9IHIyKQogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGlkc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbSA9IGxlZnQyICsgcmlnaHQyID4+IDE7CiAgICAgICAgY29uc3QgeCA9IGNvb3Jkc1syICogbV07CiAgICAgICAgY29uc3QgeSA9IGNvb3Jkc1syICogbSArIDFdOwogICAgICAgIGlmIChzcURpc3QoeCwgeSwgcXgsIHF5KSA8PSByMikgcmVzdWx0LnB1c2goaWRzW21dKTsKICAgICAgICBpZiAoYXhpczIgPT09IDAgPyBxeCAtIHIgPD0geCA6IHF5IC0gciA8PSB5KSB7CiAgICAgICAgICBzdGFjay5wdXNoKGxlZnQyKTsKICAgICAgICAgIHN0YWNrLnB1c2gobSAtIDEpOwogICAgICAgICAgc3RhY2sucHVzaCgxIC0gYXhpczIpOwogICAgICAgIH0KICAgICAgICBpZiAoYXhpczIgPT09IDAgPyBxeCArIHIgPj0geCA6IHF5ICsgciA+PSB5KSB7CiAgICAgICAgICBzdGFjay5wdXNoKG0gKyAxKTsKICAgICAgICAgIHN0YWNrLnB1c2gocmlnaHQyKTsKICAgICAgICAgIHN0YWNrLnB1c2goMSAtIGF4aXMyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9CiAgZnVuY3Rpb24gc29ydChpZHMsIGNvb3Jkcywgbm9kZVNpemUsIGxlZnQyLCByaWdodDIsIGF4aXMyKSB7CiAgICBpZiAocmlnaHQyIC0gbGVmdDIgPD0gbm9kZVNpemUpIHJldHVybjsKICAgIGNvbnN0IG0gPSBsZWZ0MiArIHJpZ2h0MiA+PiAxOwogICAgc2VsZWN0KGlkcywgY29vcmRzLCBtLCBsZWZ0MiwgcmlnaHQyLCBheGlzMik7CiAgICBzb3J0KGlkcywgY29vcmRzLCBub2RlU2l6ZSwgbGVmdDIsIG0gLSAxLCAxIC0gYXhpczIpOwogICAgc29ydChpZHMsIGNvb3Jkcywgbm9kZVNpemUsIG0gKyAxLCByaWdodDIsIDEgLSBheGlzMik7CiAgfQogIGZ1bmN0aW9uIHNlbGVjdChpZHMsIGNvb3JkcywgaywgbGVmdDIsIHJpZ2h0MiwgYXhpczIpIHsKICAgIHdoaWxlIChyaWdodDIgPiBsZWZ0MikgewogICAgICBpZiAocmlnaHQyIC0gbGVmdDIgPiA2MDApIHsKICAgICAgICBjb25zdCBuID0gcmlnaHQyIC0gbGVmdDIgKyAxOwogICAgICAgIGNvbnN0IG0gPSBrIC0gbGVmdDIgKyAxOwogICAgICAgIGNvbnN0IHogPSBNYXRoLmxvZyhuKTsKICAgICAgICBjb25zdCBzID0gMC41ICogTWF0aC5leHAoMiAqIHogLyAzKTsKICAgICAgICBjb25zdCBzZCA9IDAuNSAqIE1hdGguc3FydCh6ICogcyAqIChuIC0gcykgLyBuKSAqIChtIC0gbiAvIDIgPCAwID8gLTEgOiAxKTsKICAgICAgICBjb25zdCBuZXdMZWZ0ID0gTWF0aC5tYXgobGVmdDIsIE1hdGguZmxvb3IoayAtIG0gKiBzIC8gbiArIHNkKSk7CiAgICAgICAgY29uc3QgbmV3UmlnaHQgPSBNYXRoLm1pbigKICAgICAgICAgIHJpZ2h0MiwKICAgICAgICAgIE1hdGguZmxvb3IoayArIChuIC0gbSkgKiBzIC8gbiArIHNkKQogICAgICAgICk7CiAgICAgICAgc2VsZWN0KGlkcywgY29vcmRzLCBrLCBuZXdMZWZ0LCBuZXdSaWdodCwgYXhpczIpOwogICAgICB9CiAgICAgIGNvbnN0IHQgPSBjb29yZHNbMiAqIGsgKyBheGlzMl07CiAgICAgIGxldCBpID0gbGVmdDI7CiAgICAgIGxldCBqID0gcmlnaHQyOwogICAgICBzd2FwSXRlbShpZHMsIGNvb3JkcywgbGVmdDIsIGspOwogICAgICBpZiAoY29vcmRzWzIgKiByaWdodDIgKyBheGlzMl0gPiB0KSBzd2FwSXRlbShpZHMsIGNvb3JkcywgbGVmdDIsIHJpZ2h0Mik7CiAgICAgIHdoaWxlIChpIDwgaikgewogICAgICAgIHN3YXBJdGVtKGlkcywgY29vcmRzLCBpLCBqKTsKICAgICAgICBpKys7CiAgICAgICAgai0tOwogICAgICAgIHdoaWxlIChjb29yZHNbMiAqIGkgKyBheGlzMl0gPCB0KSBpKys7CiAgICAgICAgd2hpbGUgKGNvb3Jkc1syICogaiArIGF4aXMyXSA+IHQpIGotLTsKICAgICAgfQogICAgICBpZiAoY29vcmRzWzIgKiBsZWZ0MiArIGF4aXMyXSA9PT0gdCkgc3dhcEl0ZW0oaWRzLCBjb29yZHMsIGxlZnQyLCBqKTsKICAgICAgZWxzZSB7CiAgICAgICAgaisrOwogICAgICAgIHN3YXBJdGVtKGlkcywgY29vcmRzLCBqLCByaWdodDIpOwogICAgICB9CiAgICAgIGlmIChqIDw9IGspIGxlZnQyID0gaiArIDE7CiAgICAgIGlmIChrIDw9IGopIHJpZ2h0MiA9IGogLSAxOwogICAgfQogIH0KICBmdW5jdGlvbiBzd2FwSXRlbShpZHMsIGNvb3JkcywgaSwgaikgewogICAgc3dhcChpZHMsIGksIGopOwogICAgc3dhcChjb29yZHMsIDIgKiBpLCAyICogaik7CiAgICBzd2FwKGNvb3JkcywgMiAqIGkgKyAxLCAyICogaiArIDEpOwogIH0KICBmdW5jdGlvbiBzd2FwKGFyciwgaSwgaikgewogICAgY29uc3QgdG1wID0gYXJyW2ldOwogICAgYXJyW2ldID0gYXJyW2pdOwogICAgYXJyW2pdID0gdG1wOwogIH0KICBmdW5jdGlvbiBzcURpc3QoYXgsIGF5LCBieCwgYnkpIHsKICAgIGNvbnN0IGR4ID0gYXggLSBieDsKICAgIGNvbnN0IGR5ID0gYXkgLSBieTsKICAgIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeTsKICB9CiAgcmV0dXJuIEtEQnVzaDI7Cn07CnZhciB3b3JrZXJGbiA9ICgpID0+IHsKICBhZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKGV2ZW50KSA9PiB7CiAgICBjb25zdCBwb2ludHMgPSBldmVudC5kYXRhLnBvaW50czsKICAgIGlmIChwb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHNlbGYucG9zdE1lc3NhZ2UoeyBlcnJvcjogbmV3IEVycm9yKCJJbnZhbGlkIHBvaW50IGRhdGEiKSB9KTsKICAgIH0KICAgIGNvbnN0IGluZGV4ID0gbmV3IEtEQnVzaChwb2ludHMubGVuZ3RoLCBldmVudC5kYXRhLm5vZGVTaXplKTsKICAgIGZvciAoY29uc3QgW3gsIHldIG9mIHBvaW50cykgewogICAgICBpbmRleC5hZGQoeCwgeSk7CiAgICB9CiAgICBpbmRleC5maW5pc2goKTsKICAgIHBvc3RNZXNzYWdlKGluZGV4LmRhdGEsIFtpbmRleC5kYXRhXSk7CiAgfSk7Cn07CnZhciBLREJ1c2gkMSA9IGNyZWF0ZUtEQnVzaENsYXNzKCk7CnZhciBXT1JLRVJfVEhSRVNIT0xEID0gMWU2Owp2YXIgY3JlYXRlV29ya2VyID0gKGZuKSA9PiB7CiAgY29uc3Qga2RidXNoU3RyID0gY3JlYXRlS0RCdXNoQ2xhc3MudG9TdHJpbmcoKTsKICBjb25zdCBmblN0ciA9IGZuLnRvU3RyaW5nKCk7CiAgY29uc3Qgd29ya2VyU3RyID0gKAogICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlVGVtcGxhdGU6IFByZWZlciBvbmUgYXNzaWdubWVudCBwZXIgbGluZQogICAgYGNvbnN0IGNyZWF0ZUtEQnVzaENsYXNzID0gJHtrZGJ1c2hTdHJ9O0tEQnVzaCA9IGNyZWF0ZUtEQnVzaENsYXNzKCk7Y29uc3QgY3JlYXRlV29ya2VyID0gJHtmblN0cn07Y3JlYXRlV29ya2VyKCk7YAogICk7CiAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt3b3JrZXJTdHJdLCB7IHR5cGU6ICJ0ZXh0L2phdmFzY3JpcHQiIH0pOwogIGNvbnN0IHdvcmtlclVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgY29uc3Qgd29ya2VyMyA9IG5ldyBXb3JrZXIod29ya2VyVXJsLCB7IG5hbWU6ICJLREJ1c2giIH0pOwogIFVSTC5yZXZva2VPYmplY3RVUkwod29ya2VyVXJsKTsKICByZXR1cm4gd29ya2VyMzsKfTsKdmFyIGNyZWF0ZUtkYnVzaCA9IChwb2ludHNPckluZGV4LCBvcHRpb25zID0geyBub2RlU2l6ZTogMTYsIHVzZVdvcmtlcjogdm9pZCAwIH0pID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICBpZiAocG9pbnRzT3JJbmRleCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICByZXNvbHZlKEtEQnVzaCQxLmZyb20ocG9pbnRzT3JJbmRleCkpOwogIH0gZWxzZSBpZiAoKHBvaW50c09ySW5kZXgubGVuZ3RoIDwgV09SS0VSX1RIUkVTSE9MRCB8fCBvcHRpb25zLnVzZVdvcmtlciA9PT0gZmFsc2UpICYmIG9wdGlvbnMudXNlV29ya2VyICE9PSB0cnVlKSB7CiAgICBjb25zdCBpbmRleCA9IG5ldyBLREJ1c2gkMShwb2ludHNPckluZGV4Lmxlbmd0aCwgb3B0aW9ucy5ub2RlU2l6ZSk7CiAgICBmb3IgKGNvbnN0IHBvaW50T3JJbmRleCBvZiBwb2ludHNPckluZGV4KSB7CiAgICAgIGluZGV4LmFkZChwb2ludE9ySW5kZXhbMF0sIHBvaW50T3JJbmRleFsxXSk7CiAgICB9CiAgICBpbmRleC5maW5pc2goKTsKICAgIHJlc29sdmUoaW5kZXgpOwogIH0gZWxzZSB7CiAgICBjb25zdCB3b3JrZXIzID0gY3JlYXRlV29ya2VyKHdvcmtlckZuKTsKICAgIHdvcmtlcjMub25tZXNzYWdlID0gKGUpID0+IHsKICAgICAgaWYgKGUuZGF0YS5lcnJvcikgewogICAgICAgIHJlamVjdChlLmRhdGEuZXJyb3IpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc29sdmUoS0RCdXNoJDEuZnJvbShlLmRhdGEpKTsKICAgICAgfQogICAgICB3b3JrZXIzLnRlcm1pbmF0ZSgpOwogICAgfTsKICAgIHdvcmtlcjMucG9zdE1lc3NhZ2UoeyBwb2ludHM6IHBvaW50c09ySW5kZXgsIG5vZGVTaXplOiBvcHRpb25zLm5vZGVTaXplIH0pOwogIH0KfSk7CnZhciBERUZBVUxUX0xBU1NPX1NUQVJUX0lOSVRJQVRPUl9TSE9XID0gdHJ1ZTsKdmFyIERFRkFVTFRfTEFTU09fTUlOX0RFTEFZJDEgPSA4Owp2YXIgREVGQVVMVF9MQVNTT19NSU5fRElTVCQxID0gMjsKdmFyIERFRkFVTFRfTEFTU09fVFlQRSQxID0gImZyZWVmb3JtIjsKdmFyIERFRkFVTFRfQlJVU0hfU0laRSA9IDI0Owp2YXIgTEFTU09fU0hPV19TVEFSVF9JTklUSUFUT1JfVElNRSA9IDI1MDA7CnZhciBMQVNTT19ISURFX1NUQVJUX0lOSVRJQVRPUl9USU1FID0gMjUwOwp2YXIgQVVUTyA9ICJhdXRvIjsKdmFyIENPTE9SX05PUk1BTF9JRFggPSAwOwp2YXIgQ09MT1JfQUNUSVZFX0lEWCA9IDE7CnZhciBDT0xPUl9IT1ZFUl9JRFggPSAyOwp2YXIgQ09MT1JfQkdfSURYID0gMzsKdmFyIENPTE9SX05VTV9TVEFURVMgPSA0Owp2YXIgRkxPQVRfQllURVMgPSBGbG9hdDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CnZhciBHTF9FWFRFTlNJT05TID0gWwogICJPRVNfdGV4dHVyZV9mbG9hdCIsCiAgIk9FU19lbGVtZW50X2luZGV4X3VpbnQiLAogICJXRUJHTF9jb2xvcl9idWZmZXJfZmxvYXQiLAogICJFWFRfZmxvYXRfYmxlbmQiCl07CnZhciBDTEVBUl9PUFRJT05TID0gewogIGNvbG9yOiBbMCwgMCwgMCwgMF0sCiAgLy8gVHJhbnNwYXJlbnQgYmFja2dyb3VuZCBjb2xvcgogIGRlcHRoOiAxCn07CnZhciBNT1VTRV9NT0RFX1BBTlpPT00gPSAicGFuWm9vbSI7CnZhciBNT1VTRV9NT0RFX0xBU1NPID0gImxhc3NvIjsKdmFyIE1PVVNFX01PREVfUk9UQVRFID0gInJvdGF0ZSI7CnZhciBNT1VTRV9NT0RFUyA9IFsKICBNT1VTRV9NT0RFX1BBTlpPT00sCiAgTU9VU0VfTU9ERV9MQVNTTywKICBNT1VTRV9NT0RFX1JPVEFURQpdOwp2YXIgREVGQVVMVF9NT1VTRV9NT0RFID0gTU9VU0VfTU9ERV9QQU5aT09NOwp2YXIgRUFTSU5HX0ZOUyA9IHsKICBjdWJpY0luLAogIGN1YmljSW5PdXQsCiAgY3ViaWNPdXQsCiAgbGluZWFyLAogIHF1YWRJbiwKICBxdWFkSW5PdXQsCiAgcXVhZE91dAp9Owp2YXIgREVGQVVMVF9FQVNJTkcgPSBjdWJpY0luT3V0Owp2YXIgQ09OVElOVU9VUyA9ICJjb250aW51b3VzIjsKdmFyIENBVEVHT1JJQ0FMID0gImNhdGVnb3JpY2FsIjsKdmFyIFZBTFVFX1pXX0RBVEFfVFlQRVMgPSBbQ09OVElOVU9VUywgQ0FURUdPUklDQUxdOwp2YXIgTEFTU09fQ0xFQVJfT05fREVTRUxFQ1QgPSAiZGVzZWxlY3QiOwp2YXIgTEFTU09fQ0xFQVJfT05fRU5EID0gImxhc3NvRW5kIjsKdmFyIExBU1NPX0NMRUFSX0VWRU5UUyA9IFtMQVNTT19DTEVBUl9PTl9ERVNFTEVDVCwgTEFTU09fQ0xFQVJfT05fRU5EXTsKdmFyIExBU1NPX0JSVVNIX01JTl9NSU5fRElTVCA9IDM7CnZhciBERUZBVUxUX0xBU1NPX0NPTE9SID0gWzAsIDAuNjY2NjY2NjY3LCAxLCAxXTsKdmFyIERFRkFVTFRfTEFTU09fTElORV9XSURUSCA9IDI7CnZhciBERUZBVUxUX0xBU1NPX0lOSVRJQVRPUiA9IGZhbHNlOwp2YXIgREVGQVVMVF9MQVNTT19NSU5fREVMQVkgPSAxMDsKdmFyIERFRkFVTFRfTEFTU09fTUlOX0RJU1QgPSAzOwp2YXIgREVGQVVMVF9MQVNTT19DTEVBUl9FVkVOVCA9IExBU1NPX0NMRUFSX09OX0VORDsKdmFyIERFRkFVTFRfTEFTU09fT05fTE9OR19QUkVTUyA9IGZhbHNlOwp2YXIgREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX1RJTUUgPSA3NTA7CnZhciBERUZBVUxUX0xBU1NPX0xPTkdfUFJFU1NfQUZURVJfRUZGRUNUX1RJTUUgPSA1MDA7CnZhciBERUZBVUxUX0xBU1NPX0xPTkdfUFJFU1NfRUZGRUNUX0RFTEFZID0gMTAwOwp2YXIgREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX1JFVkVSVF9FRkZFQ1RfVElNRSA9IDI1MDsKdmFyIERFRkFVTFRfTEFTU09fQlJVU0hfU0laRSA9IDI0Owp2YXIgS0VZX0FDVElPTl9MQVNTTyA9ICJsYXNzbyI7CnZhciBLRVlfQUNUSU9OX1JPVEFURSA9ICJyb3RhdGUiOwp2YXIgS0VZX0FDVElPTl9NRVJHRSA9ICJtZXJnZSI7CnZhciBLRVlfQUNUSU9OX1JFTU9WRSA9ICJyZW1vdmUiOwp2YXIgS0VZX0FDVElPTlMgPSBbCiAgS0VZX0FDVElPTl9MQVNTTywKICBLRVlfQUNUSU9OX1JPVEFURSwKICBLRVlfQUNUSU9OX01FUkdFLAogIEtFWV9BQ1RJT05fUkVNT1ZFCl07CnZhciBLRVlfQUxUID0gImFsdCI7CnZhciBLRVlfQ01EID0gImNtZCI7CnZhciBLRVlfQ1RSTCA9ICJjdHJsIjsKdmFyIEtFWV9NRVRBID0gIm1ldGEiOwp2YXIgS0VZX1NISUZUID0gInNoaWZ0IjsKdmFyIEtFWVMgPSBbS0VZX0FMVCwgS0VZX0NNRCwgS0VZX0NUUkwsIEtFWV9NRVRBLCBLRVlfU0hJRlRdOwp2YXIgREVGQVVMVF9BQ1RJT05fS0VZX01BUCA9IHsKICBbS0VZX0FDVElPTl9SRU1PVkVdOiBLRVlfQUxULAogIFtLRVlfQUNUSU9OX1JPVEFURV06IEtFWV9BTFQsCiAgW0tFWV9BQ1RJT05fTEFTU09dOiBLRVlfU0hJRlQsCiAgW0tFWV9BQ1RJT05fTUVSR0VdOiBLRVlfQ01ECn07CnZhciBERUZBVUxUX0RBVEFfQVNQRUNUX1JBVElPID0gMTsKdmFyIERFRkFVTFRfV0lEVEggPSBBVVRPOwp2YXIgREVGQVVMVF9IRUlHSFQgPSBBVVRPOwp2YXIgREVGQVVMVF9HQU1NQSA9IDE7CnZhciBNSU5fUE9JTlRfU0laRSA9IDE7CnZhciBERUZBVUxUX1BPSU5UX1NDQUxFX01PREUgPSAiYXNpbmgiOwp2YXIgREVGQVVMVF9QT0lOVF9TSVpFID0gNjsKdmFyIERFRkFVTFRfUE9JTlRfU0laRV9TRUxFQ1RFRCA9IDI7CnZhciBERUZBVUxUX1BPSU5UX09VVExJTkVfV0lEVEggPSAyOwp2YXIgREVGQVVMVF9TSVpFX0JZID0gbnVsbDsKdmFyIERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9TSVpFID0gMjsKdmFyIERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9TSVpFX0FDVElWRSA9IDI7CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fU0laRV9CWSA9IG51bGw7CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fT1BBQ0lUWSA9IG51bGw7CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fT1BBQ0lUWV9CWSA9IG51bGw7CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fT1BBQ0lUWV9BQ1RJVkUgPSAwLjY2Owp2YXIgREVGQVVMVF9PUEFDSVRZID0gMTsKdmFyIERFRkFVTFRfT1BBQ0lUWV9CWSA9IG51bGw7CnZhciBERUZBVUxUX09QQUNJVFlfQllfREVOU0lUWV9GSUxMID0gMC4xNTsKdmFyIERFRkFVTFRfT1BBQ0lUWV9CWV9ERU5TSVRZX0RFQk9VTkNFX1RJTUUgPSAyNTsKdmFyIERFRkFVTFRfT1BBQ0lUWV9JTkFDVElWRV9NQVggPSAxOwp2YXIgREVGQVVMVF9PUEFDSVRZX0lOQUNUSVZFX1NDQUxFID0gMTsKdmFyIERFRkFVTFRfQ09MT1JfQlkgPSBudWxsOwp2YXIgREVGQVVMVF9DT0xPUl9OT1JNQUwgPSBbMC42NiwgMC42NiwgMC42NiwgREVGQVVMVF9PUEFDSVRZXTsKdmFyIERFRkFVTFRfQ09MT1JfQUNUSVZFID0gWzAsIDAuNTUsIDEsIDFdOwp2YXIgREVGQVVMVF9DT0xPUl9IT1ZFUiA9IFsxLCAxLCAxLCAxXTsKdmFyIERFRkFVTFRfQ09MT1JfQkcgPSBbMCwgMCwgMCwgMV07CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fQ09MT1JfQlkgPSBudWxsOwp2YXIgREVGQVVMVF9QT0lOVF9DT05ORUNUSU9OX0NPTE9SX05PUk1BTCA9IFswLjY2LCAwLjY2LCAwLjY2LCAwLjJdOwp2YXIgREVGQVVMVF9QT0lOVF9DT05ORUNUSU9OX0NPTE9SX0FDVElWRSA9IFswLCAwLjU1LCAxLCAxXTsKdmFyIERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9DT0xPUl9IT1ZFUiA9IFsxLCAxLCAxLCAxXTsKdmFyIERFRkFVTFRfQU5OT1RBVElPTl9MSU5FX0NPTE9SID0gWzEsIDEsIDEsIDAuNV07CnZhciBERUZBVUxUX0FOTk9UQVRJT05fTElORV9XSURUSCA9IDE7CnZhciBERUZBVUxUX0FOTk9UQVRJT05fSFZMSU5FX0xJTUlUID0gMWUzOwp2YXIgREVGQVVMVF9UQVJHRVQgPSBbMCwgMF07CnZhciBERUZBVUxUX0RJU1RBTkNFID0gMTsKdmFyIERFRkFVTFRfUk9UQVRJT04gPSAwOwp2YXIgREVGQVVMVF9WSUVXID0gbmV3IEZsb2F0MzJBcnJheShbCiAgMSwKICAwLAogIDAsCiAgMCwKICAwLAogIDEsCiAgMCwKICAwLAogIDAsCiAgMCwKICAxLAogIDAsCiAgMCwKICAwLAogIDAsCiAgMQpdKTsKdmFyIElNQUdFX0xPQURfRVJST1IgPSAiSU1BR0VfTE9BRF9FUlJPUiI7CnZhciBERUZBVUxUX0JBQ0tHUk9VTkRfSU1BR0UgPSBudWxsOwp2YXIgREVGQVVMVF9TSE9XX1JFVElDTEUgPSBmYWxzZTsKdmFyIERFRkFVTFRfUkVUSUNMRV9DT0xPUiA9IFsxLCAxLCAxLCAwLjVdOwp2YXIgREVGQVVMVF9ERVNFTEVDVF9PTl9EQkxfQ0xJQ0sgPSB0cnVlOwp2YXIgREVGQVVMVF9ERVNFTEVDVF9PTl9FU0NBUEUgPSB0cnVlOwp2YXIgREVGQVVMVF9TSE9XX1BPSU5UX0NPTk5FQ1RJT05TID0gZmFsc2U7CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fTUFYX0lOVF9QT0lOVFNfUEVSX1NFR01FTlQgPSAxMDA7CnZhciBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fSU5UX1BPSU5UU19UT0xFUkFOQ0UgPSAxIC8gNTAwOwp2YXIgREVGQVVMVF9QT0lOVF9TSVpFX01PVVNFX0RFVEVDVElPTiA9ICJhdXRvIjsKdmFyIERFRkFVTFRfUEVSRk9STUFOQ0VfTU9ERSA9IGZhbHNlOwp2YXIgU0lOR0xFX0NMSUNLX0RFTEFZID0gMjAwOwp2YXIgTE9OR19DTElDS19USU1FID0gNTAwOwp2YXIgWl9OQU1FUyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsieiIsICJ2YWx1ZVoiLCAidmFsdWVBIiwgInZhbHVlMSIsICJjYXRlZ29yeSJdKTsKdmFyIFdfTkFNRVMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbInciLCAidmFsdWVXIiwgInZhbHVlQiIsICJ2YWx1ZTIiLCAidmFsdWUiXSk7CnZhciBERUZBVUxUX0lNQUdFX0xPQURfVElNRU9VVCA9IDE1ZTM7CnZhciBERUZBVUxUX1NQQVRJQUxfSU5ERVhfVVNFX1dPUktFUiA9IHZvaWQgMDsKdmFyIERFRkFVTFRfQ0FNRVJBX0lTX0ZJWEVEID0gZmFsc2U7CnZhciBERUZBVUxUX0FOVElfQUxJQVNJTkcgPSAwLjU7CnZhciBERUZBVUxUX1BJWEVMX0FMSUdORUQgPSBmYWxzZTsKdmFyIERFRkFVTFRfTEFTU09fVFlQRSA9ICJsYXNzbyI7CnZhciBTS0lQX0RFUFJFQ0FUSU9OX1ZBTFVFX1RSQU5TTEFUSU9OID0gU3ltYm9sKAogICJTS0lQX0RFUFJFQ0FUSU9OX1ZBTFVFX1RSQU5TTEFUSU9OIgopOwp2YXIgRVJST1JfUE9JTlRTX05PVF9EUkFXTiA9ICJQb2ludHMgaGF2ZSBub3QgYmVlbiBkcmF3biI7CnZhciBFUlJPUl9JTlNUQU5DRV9JU19ERVNUUk9ZRUQgPSAiVGhlIGluc3RhbmNlIHdhcyBhbHJlYWR5IGRlc3Ryb3llZCI7CnZhciBFUlJPUl9JU19EUkFXSU5HID0gIklnbm9yaW5nIGRyYXcgY2FsbCBhcyB0aGUgcHJldmlvdXMgZHJhdyBjYWxsIGhhcyBub3QgeWV0IGZpbmlzaGVkLiBUbyBhdm9pZCB0aGlzIHdhcm5pbmcgYGF3YWl0YCB0aGUgZHJhdyBjYWxsLiI7CnZhciBnZXRJblRpbWUgPSAocCwgdGltZTMsIGV4dHJhVGltZSkgPT4gKDEgLSBwKSAqIHRpbWUzICsgZXh0cmFUaW1lOwp2YXIgZ2V0TWFpbkluQW5pbWF0aW9uID0gKHQsIGQpID0+IGAke3R9bXMgZWFzZS1vdXQgbWFpbkluICR7ZH1tcyAxIG5vcm1hbCBmb3J3YXJkc2A7CnZhciBnZXRFZmZlY3RJbkFuaW1hdGlvbiA9ICh0LCBkKSA9PiBgJHt0fW1zIGVhc2Utb3V0IGVmZmVjdEluICR7ZH1tcyAxIG5vcm1hbCBmb3J3YXJkc2A7CnZhciBnZXRDaXJjbGVMZWZ0SW5BbmltYXRpb24gPSAodCwgZCkgPT4gYCR7dH1tcyBsaW5lYXIgbGVmdFNwaW5JbiAke2R9bXMgMSBub3JtYWwgZm9yd2FyZHNgOwp2YXIgZ2V0Q2lyY2xlUmlnaHRJbkFuaW1hdGlvbiA9ICh0LCBkKSA9PiBgJHt0fW1zIGxpbmVhciByaWdodFNwaW5JbiAke2R9bXMgMSBub3JtYWwgZm9yd2FyZHNgOwp2YXIgZ2V0Q2lyY2xlSW5BbmltYXRpb24gPSAodCwgZCkgPT4gYCR7dH1tcyBsaW5lYXIgY2lyY2xlSW4gJHtkfW1zIDEgbm9ybWFsIGZvcndhcmRzYDsKdmFyIGdldE1haW5JbiA9IChtYWluRWZmZWN0UGVyY2VudCwgY3VycmVudENvbG9yLCB0YXJnZXRDb2xvcikgPT4gYAogIEBrZXlmcmFtZXMgbWFpbkluIHsKICAgIDAlIHsKICAgICAgY29sb3I6ICR7Y3VycmVudENvbG9yfTsKICAgICAgb3BhY2l0eTogMDsKICAgIH0KICAgIDAlLCAke21haW5FZmZlY3RQZXJjZW50fSUgewogICAgICBjb2xvcjogJHtjdXJyZW50Q29sb3J9OwogICAgICBvcGFjaXR5OiAxOwogICAgfQogICAgMTAwJSB7CiAgICAgIGNvbG9yOiAke3RhcmdldENvbG9yfTsKICAgICAgb3BhY2l0eTogMC44OwogICAgfQogIH0KYDsKdmFyIGdldEVmZmVjdEluID0gKG1haW5FZmZlY3RQZXJjZW50LCBhZnRlckVmZmVjdFBlcmNlbnQsIG9wYWNpdHksIHNjYWxlKSA9PiBgCiAgQGtleWZyYW1lcyBlZmZlY3RJbiB7CiAgICAwJSwgJHttYWluRWZmZWN0UGVyY2VudH0lIHsKICAgICAgb3BhY2l0eTogJHtvcGFjaXR5fTsKICAgICAgdHJhbnNmb3JtOiBzY2FsZSgke3NjYWxlfSk7CiAgICB9CiAgICAke2FmdGVyRWZmZWN0UGVyY2VudH0lIHsKICAgICAgb3BhY2l0eTogMC42NjsKICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOwogICAgfQogICAgOTklIHsKICAgICAgb3BhY2l0eTogMDsKICAgICAgdHJhbnNmb3JtOiBzY2FsZSgyKTsKICAgIH0KICAgIDEwMCUgewogICAgICBvcGFjaXR5OiAwOwogICAgICB0cmFuc2Zvcm06IHNjYWxlKDApOwogICAgfQogIH0KYDsKdmFyIGdldENpcmNsZUluID0gKGhhbGZNYWluRWZmZWN0UGVyY2VudCwgY2xpcFBhdGgsIG9wYWNpdHkpID0+IGAKICBAa2V5ZnJhbWVzIGNpcmNsZUluIHsKICAgIDAlIHsKICAgICAgY2xpcC1wYXRoOiAke2NsaXBQYXRofTsKICAgICAgb3BhY2l0eTogJHtvcGFjaXR5fTsKICAgIH0KICAgICR7aGFsZk1haW5FZmZlY3RQZXJjZW50fSUgewogICAgICBjbGlwLXBhdGg6ICR7Y2xpcFBhdGh9OwogICAgICBvcGFjaXR5OiAxOwogICAgfQogICAgJHtoYWxmTWFpbkVmZmVjdFBlcmNlbnQgKyAwLjAxfSUsIDEwMCUgewogICAgICBjbGlwLXBhdGg6IGluc2V0KDApOwogICAgICBvcGFjaXR5OiAxOwogICAgfQogIH0KYDsKdmFyIGdldENpcmNsZUxlZnRJbiA9IChtYWluRWZmZWN0UGVyY2VudCwgYW5nbGUyKSA9PiBgCiAgQGtleWZyYW1lcyBsZWZ0U3BpbkluIHsKICAgIDAlIHsKICAgICAgdHJhbnNmb3JtOiByb3RhdGUoJHthbmdsZTJ9ZGVnKTsKICAgIH0KICAgICR7bWFpbkVmZmVjdFBlcmNlbnR9JSwgMTAwJSB7CiAgICAgIHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7CiAgICB9CiAgfQpgOwp2YXIgZ2V0Q2lyY2xlUmlnaHRJbiA9IChoYWxmTWFpbkVmZmVjdFBlcmNlbnQsIGFuZ2xlMikgPT4gYAogIEBrZXlmcmFtZXMgcmlnaHRTcGluSW4gewogICAgMCUgewogICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgke2FuZ2xlMn1kZWcpOwogICAgfQogICAgJHtoYWxmTWFpbkVmZmVjdFBlcmNlbnR9JSwgMTAwJSB7CiAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE4MGRlZyk7CiAgICB9CiAgfQpgOwp2YXIgY3JlYXRlTG9uZ1ByZXNzSW5BbmltYXRpb25zID0gKHsKICB0aW1lOiB0aW1lMyA9IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19USU1FLAogIGV4dHJhVGltZSA9IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19BRlRFUl9FRkZFQ1RfVElNRSwKICBkZWxheSA9IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19FRkZFQ1RfREVMQVksCiAgY3VycmVudENvbG9yLAogIHRhcmdldENvbG9yLAogIGVmZmVjdE9wYWNpdHksCiAgZWZmZWN0U2NhbGUsCiAgY2lyY2xlTGVmdFJvdGF0aW9uLAogIGNpcmNsZVJpZ2h0Um90YXRpb24sCiAgY2lyY2xlQ2xpcFBhdGgsCiAgY2lyY2xlT3BhY2l0eQp9KSA9PiB7CiAgY29uc3QgcCA9IGNpcmNsZUxlZnRSb3RhdGlvbiAvIDM2MDsKICBjb25zdCBhY3R1YWxUaW1lID0gZ2V0SW5UaW1lKHAsIHRpbWUzLCBleHRyYVRpbWUpOwogIGNvbnN0IGxvbmdQcmVzc1BlcmNlbnQgPSBNYXRoLnJvdW5kKCgxIC0gcCkgKiB0aW1lMyAvIGFjdHVhbFRpbWUgKiAxMDApOwogIGNvbnN0IGhhbGZMb25nUHJlc3NQZXJjZW50ID0gTWF0aC5yb3VuZChsb25nUHJlc3NQZXJjZW50IC8gMik7CiAgY29uc3QgYWZ0ZXJFZmZlY3RQZXJjZW50ID0gbG9uZ1ByZXNzUGVyY2VudCArICgxMDAgLSBsb25nUHJlc3NQZXJjZW50KSAvIDQ7CiAgcmV0dXJuIHsKICAgIHJ1bGVzOiB7CiAgICAgIG1haW46IGdldE1haW5Jbihsb25nUHJlc3NQZXJjZW50LCBjdXJyZW50Q29sb3IsIHRhcmdldENvbG9yKSwKICAgICAgZWZmZWN0OiBnZXRFZmZlY3RJbigKICAgICAgICBsb25nUHJlc3NQZXJjZW50LAogICAgICAgIGFmdGVyRWZmZWN0UGVyY2VudCwKICAgICAgICBlZmZlY3RPcGFjaXR5LAogICAgICAgIGVmZmVjdFNjYWxlCiAgICAgICksCiAgICAgIGNpcmNsZVJpZ2h0OiBnZXRDaXJjbGVSaWdodEluKGhhbGZMb25nUHJlc3NQZXJjZW50LCBjaXJjbGVSaWdodFJvdGF0aW9uKSwKICAgICAgY2lyY2xlTGVmdDogZ2V0Q2lyY2xlTGVmdEluKGxvbmdQcmVzc1BlcmNlbnQsIGNpcmNsZUxlZnRSb3RhdGlvbiksCiAgICAgIGNpcmNsZTogZ2V0Q2lyY2xlSW4oaGFsZkxvbmdQcmVzc1BlcmNlbnQsIGNpcmNsZUNsaXBQYXRoLCBjaXJjbGVPcGFjaXR5KQogICAgfSwKICAgIG5hbWVzOiB7CiAgICAgIG1haW46IGdldE1haW5JbkFuaW1hdGlvbihhY3R1YWxUaW1lLCBkZWxheSksCiAgICAgIGVmZmVjdDogZ2V0RWZmZWN0SW5BbmltYXRpb24oYWN0dWFsVGltZSwgZGVsYXkpLAogICAgICBjaXJjbGVMZWZ0OiBnZXRDaXJjbGVMZWZ0SW5BbmltYXRpb24oYWN0dWFsVGltZSwgZGVsYXkpLAogICAgICBjaXJjbGVSaWdodDogZ2V0Q2lyY2xlUmlnaHRJbkFuaW1hdGlvbihhY3R1YWxUaW1lLCBkZWxheSksCiAgICAgIGNpcmNsZTogZ2V0Q2lyY2xlSW5BbmltYXRpb24oYWN0dWFsVGltZSwgZGVsYXkpCiAgICB9CiAgfTsKfTsKdmFyIGdldE1haW5PdXRBbmltYXRpb24gPSAodCkgPT4gYCR7dH1tcyBsaW5lYXIgbWFpbk91dCAwcyAxIG5vcm1hbCBmb3J3YXJkc2A7CnZhciBnZXRFZmZlY3RPdXRBbmltYXRpb24gPSAodCkgPT4gYCR7dH1tcyBsaW5lYXIgZWZmZWN0T3V0IDBzIDEgbm9ybWFsIGZvcndhcmRzYDsKdmFyIGdldENpcmNsZUxlZnRPdXRBbmltYXRpb24gPSAodCkgPT4gYCR7dH1tcyBsaW5lYXIgbGVmdFNwaW5PdXQgMHMgMSBub3JtYWwgZm9yd2FyZHNgOwp2YXIgZ2V0Q2lyY2xlUmlnaHRPdXRBbmltYXRpb24gPSAodCkgPT4gYCR7dH1tcyBsaW5lYXIgcmlnaHRTcGluT3V0IDBzIDEgbm9ybWFsIGZvcndhcmRzYDsKdmFyIGdldENpcmNsZU91dEFuaW1hdGlvbiA9ICh0KSA9PiBgJHt0fW1zIGxpbmVhciBjaXJjbGVPdXQgMHMgMSBub3JtYWwgZm9yd2FyZHNgOwp2YXIgZ2V0TWFpbk91dCA9IChjdXJyZW50Q29sb3IsIHRhcmdldENvbG9yKSA9PiBgCiAgQGtleWZyYW1lcyBtYWluT3V0IHsKICAgIDAlIHsKICAgICAgY29sb3I6ICR7Y3VycmVudENvbG9yfTsKICAgIH0KICAgIDEwMCUgewogICAgICBjb2xvcjogJHt0YXJnZXRDb2xvcn07CiAgICB9CiAgfQpgOwp2YXIgZ2V0RWZmZWN0T3V0ID0gKG9wYWNpdHksIHNjYWxlKSA9PiBgCiAgQGtleWZyYW1lcyBlZmZlY3RPdXQgewogICAgMCUgewogICAgICBvcGFjaXR5OiAke29wYWNpdHl9OwogICAgICB0cmFuc2Zvcm06IHNjYWxlKCR7c2NhbGV9KTsKICAgIH0KICAgIDk5JSB7CiAgICAgIG9wYWNpdHk6IDA7CiAgICAgIHRyYW5zZm9ybTogc2NhbGUoJHtzY2FsZSArIDAuNX0pOwogICAgfQogICAgMTAwJSB7CiAgICAgIG9wYWNpdHk6IDA7CiAgICAgIHRyYW5zZm9ybTogc2NhbGUoMCk7CiAgICB9CiAgfQpgOwp2YXIgZ2V0Q2lyY2xlUmlnaHRPdXQgPSAoaGFsZkVmZmVjdFBlcmNlbnQsIGFuZ2xlMikgPT4gYAogIEBrZXlmcmFtZXMgcmlnaHRTcGluT3V0IHsKICAgIDAlLCAke2hhbGZFZmZlY3RQZXJjZW50fSUgewogICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgke2FuZ2xlMn1kZWcpOwogICAgfQogICAgMTAwJSB7CiAgICAgIHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOwogICAgfQpgOwp2YXIgZ2V0Q2lyY2xlTGVmdE91dCA9IChhbmdsZTIpID0+IGAKICBAa2V5ZnJhbWVzIGxlZnRTcGluT3V0IHsKICAgIDAlIHsKICAgICAgdHJhbnNmb3JtOiByb3RhdGUoJHthbmdsZTJ9ZGVnKTsKICAgIH0KICAgIDEwMCUgewogICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICB9CmA7CnZhciBnZXRDaXJjbGVPdXQgPSAoaGFsZkVmZmVjdFBlcmNlbnQsIGNsaXBQYXRoLCBvcGFjaXR5KSA9PiBgCiAgQGtleWZyYW1lcyBjaXJjbGVPdXQgewogICAgMCUsICR7aGFsZkVmZmVjdFBlcmNlbnR9JSB7CiAgICAgIGNsaXAtcGF0aDogJHtjbGlwUGF0aH07CiAgICAgIG9wYWNpdHk6ICR7b3BhY2l0eX07CiAgICB9CiAgICAke2hhbGZFZmZlY3RQZXJjZW50ICsgMC4wMX0lIHsKICAgICAgY2xpcC1wYXRoOiBpbnNldCgwIDAgMCA1MCUpOwogICAgICBvcGFjaXR5OiAke29wYWNpdHl9OwogICAgfQogICAgMTAwJSB7CiAgICAgIGNsaXAtcGF0aDogaW5zZXQoMCAwIDAgNTAlKTsKICAgICAgb3BhY2l0eTogMDsKICAgIH0KICB9CmA7CnZhciBjcmVhdGVMb25nUHJlc3NPdXRBbmltYXRpb25zID0gKHsKICB0aW1lOiB0aW1lMyA9IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19SRVZFUlRfRUZGRUNUX1RJTUUsCiAgY3VycmVudENvbG9yLAogIHRhcmdldENvbG9yLAogIGVmZmVjdE9wYWNpdHksCiAgZWZmZWN0U2NhbGUsCiAgY2lyY2xlTGVmdFJvdGF0aW9uLAogIGNpcmNsZVJpZ2h0Um90YXRpb24sCiAgY2lyY2xlQ2xpcFBhdGgsCiAgY2lyY2xlT3BhY2l0eQp9KSA9PiB7CiAgY29uc3QgcCA9IGNpcmNsZUxlZnRSb3RhdGlvbiAvIDM2MDsKICBjb25zdCBhY3R1YWxUaW1lID0gcCAqIHRpbWUzOwogIGNvbnN0IHJvdGF0ZWRQZXJjZW50ID0gTWF0aC5taW4oMTAwLCBwICogMTAwKTsKICBjb25zdCBoYWxmUGVyY2VudCA9IHJvdGF0ZWRQZXJjZW50ID4gNTAgPyBNYXRoLnJvdW5kKCgxIC0gNTAgLyByb3RhdGVkUGVyY2VudCkgKiAxMDApIDogMDsKICByZXR1cm4gewogICAgcnVsZXM6IHsKICAgICAgbWFpbjogZ2V0TWFpbk91dChjdXJyZW50Q29sb3IsIHRhcmdldENvbG9yKSwKICAgICAgZWZmZWN0OiBnZXRFZmZlY3RPdXQoZWZmZWN0T3BhY2l0eSwgZWZmZWN0U2NhbGUpLAogICAgICBjaXJjbGVSaWdodDogZ2V0Q2lyY2xlUmlnaHRPdXQoaGFsZlBlcmNlbnQsIGNpcmNsZVJpZ2h0Um90YXRpb24pLAogICAgICBjaXJjbGVMZWZ0OiBnZXRDaXJjbGVMZWZ0T3V0KGNpcmNsZUxlZnRSb3RhdGlvbiksCiAgICAgIGNpcmNsZTogZ2V0Q2lyY2xlT3V0KGhhbGZQZXJjZW50LCBjaXJjbGVDbGlwUGF0aCwgY2lyY2xlT3BhY2l0eSkKICAgIH0sCiAgICBuYW1lczogewogICAgICBtYWluOiBnZXRNYWluT3V0QW5pbWF0aW9uKGFjdHVhbFRpbWUpLAogICAgICBlZmZlY3Q6IGdldEVmZmVjdE91dEFuaW1hdGlvbihhY3R1YWxUaW1lKSwKICAgICAgY2lyY2xlUmlnaHQ6IGdldENpcmNsZUxlZnRPdXRBbmltYXRpb24oYWN0dWFsVGltZSksCiAgICAgIGNpcmNsZUxlZnQ6IGdldENpcmNsZVJpZ2h0T3V0QW5pbWF0aW9uKGFjdHVhbFRpbWUpLAogICAgICBjaXJjbGU6IGdldENpcmNsZU91dEFuaW1hdGlvbihhY3R1YWxUaW1lKQogICAgfQogIH07Cn07CnZhciBjcmVhdGVMb25nUHJlc3NFbGVtZW50cyA9ICgpID0+IHsKICBjb25zdCBsb25nUHJlc3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBjb25zdCBsb25nUHJlc3NJZCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyLCA1KSArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyLCA1KTsKICBsb25nUHJlc3MuaWQgPSBgbGFzc28tbG9uZy1wcmVzcy0ke2xvbmdQcmVzc0lkfWA7CiAgbG9uZ1ByZXNzLnN0eWxlLnBvc2l0aW9uID0gImZpeGVkIjsKICBsb25nUHJlc3Muc3R5bGUud2lkdGggPSAiMS4yNXJlbSI7CiAgbG9uZ1ByZXNzLnN0eWxlLmhlaWdodCA9ICIxLjI1cmVtIjsKICBsb25nUHJlc3Muc3R5bGUucG9pbnRlckV2ZW50cyA9ICJub25lIjsKICBsb25nUHJlc3Muc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZSgtNTAlLC01MCUpIjsKICBjb25zdCBsb25nUHJlc3NDaXJjbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBsb25nUHJlc3NDaXJjbGUuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogIGxvbmdQcmVzc0NpcmNsZS5zdHlsZS50b3AgPSAwOwogIGxvbmdQcmVzc0NpcmNsZS5zdHlsZS5sZWZ0ID0gMDsKICBsb25nUHJlc3NDaXJjbGUuc3R5bGUud2lkdGggPSAiMS4yNXJlbSI7CiAgbG9uZ1ByZXNzQ2lyY2xlLnN0eWxlLmhlaWdodCA9ICIxLjI1cmVtIjsKICBsb25nUHJlc3NDaXJjbGUuc3R5bGUuY2xpcFBhdGggPSAiaW5zZXQoMHB4IDBweCAwcHggNTAlKSI7CiAgbG9uZ1ByZXNzQ2lyY2xlLnN0eWxlLm9wYWNpdHkgPSAwOwogIGxvbmdQcmVzcy5hcHBlbmRDaGlsZChsb25nUHJlc3NDaXJjbGUpOwogIGNvbnN0IGxvbmdQcmVzc0NpcmNsZUxlZnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBsb25nUHJlc3NDaXJjbGVMZWZ0LnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICBsb25nUHJlc3NDaXJjbGVMZWZ0LnN0eWxlLnRvcCA9IDA7CiAgbG9uZ1ByZXNzQ2lyY2xlTGVmdC5zdHlsZS5sZWZ0ID0gMDsKICBsb25nUHJlc3NDaXJjbGVMZWZ0LnN0eWxlLndpZHRoID0gIjAuOHJlbSI7CiAgbG9uZ1ByZXNzQ2lyY2xlTGVmdC5zdHlsZS5oZWlnaHQgPSAiMC44cmVtIjsKICBsb25nUHJlc3NDaXJjbGVMZWZ0LnN0eWxlLmJvcmRlciA9ICIwLjJyZW0gc29saWQgY3VycmVudGNvbG9yIjsKICBsb25nUHJlc3NDaXJjbGVMZWZ0LnN0eWxlLmJvcmRlclJhZGl1cyA9ICIwLjhyZW0iOwogIGxvbmdQcmVzc0NpcmNsZUxlZnQuc3R5bGUuY2xpcFBhdGggPSAiaW5zZXQoMHB4IDUwJSAwcHggMHB4KSI7CiAgbG9uZ1ByZXNzQ2lyY2xlTGVmdC5zdHlsZS50cmFuc2Zvcm0gPSAicm90YXRlKDBkZWcpIjsKICBsb25nUHJlc3NDaXJjbGUuYXBwZW5kQ2hpbGQobG9uZ1ByZXNzQ2lyY2xlTGVmdCk7CiAgY29uc3QgbG9uZ1ByZXNzQ2lyY2xlUmlnaHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgbG9uZ1ByZXNzQ2lyY2xlUmlnaHQuc3R5bGUudG9wID0gMDsKICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5sZWZ0ID0gMDsKICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS53aWR0aCA9ICIwLjhyZW0iOwogIGxvbmdQcmVzc0NpcmNsZVJpZ2h0LnN0eWxlLmhlaWdodCA9ICIwLjhyZW0iOwogIGxvbmdQcmVzc0NpcmNsZVJpZ2h0LnN0eWxlLmJvcmRlciA9ICIwLjJyZW0gc29saWQgY3VycmVudGNvbG9yIjsKICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMC44cmVtIjsKICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5jbGlwUGF0aCA9ICJpbnNldCgwcHggNTAlIDBweCAwcHgpIjsKICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS50cmFuc2Zvcm0gPSAicm90YXRlKDBkZWcpIjsKICBsb25nUHJlc3NDaXJjbGUuYXBwZW5kQ2hpbGQobG9uZ1ByZXNzQ2lyY2xlUmlnaHQpOwogIGNvbnN0IGxvbmdQcmVzc0VmZmVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGxvbmdQcmVzc0VmZmVjdC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLnRvcCA9IDA7CiAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLmxlZnQgPSAwOwogIGxvbmdQcmVzc0VmZmVjdC5zdHlsZS53aWR0aCA9ICIxLjI1cmVtIjsKICBsb25nUHJlc3NFZmZlY3Quc3R5bGUuaGVpZ2h0ID0gIjEuMjVyZW0iOwogIGxvbmdQcmVzc0VmZmVjdC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMS4yNXJlbSI7CiAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLmJhY2tncm91bmQgPSAiY3VycmVudGNvbG9yIjsKICBsb25nUHJlc3NFZmZlY3Quc3R5bGUudHJhbnNmb3JtID0gInNjYWxlKDApIjsKICBsb25nUHJlc3NFZmZlY3Quc3R5bGUub3BhY2l0eSA9IDA7CiAgbG9uZ1ByZXNzLmFwcGVuZENoaWxkKGxvbmdQcmVzc0VmZmVjdCk7CiAgcmV0dXJuIHsKICAgIGxvbmdQcmVzcywKICAgIGxvbmdQcmVzc0NpcmNsZSwKICAgIGxvbmdQcmVzc0NpcmNsZUxlZnQsCiAgICBsb25nUHJlc3NDaXJjbGVSaWdodCwKICAgIGxvbmdQcmVzc0VmZmVjdAogIH07Cn07CnZhciBleHBvbmVudGlhbE1vdmluZ0F2ZXJhZ2UgPSAodmFsdWVzLCBoYWxmTGlmZSwgd2luZG93U2l6ZSkgPT4gewogIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDEpIHsKICAgIHJldHVybiB2YWx1ZXNbMF07CiAgfQogIGNvbnN0IGRlY2F5QmFzZSA9IDIgKiogKC0xIC8gaGFsZkxpZmUpOwogIGNvbnN0IHN0YXJ0SWR4ID0gTWF0aC5tYXgoMCwgdmFsdWVzLmxlbmd0aCAtIHdpbmRvd1NpemUpOwogIGNvbnN0IHJlbGV2YW50VmFsdWVzID0gdmFsdWVzLnNsaWNlKHN0YXJ0SWR4KTsKICBsZXQgd2VpZ2h0ZWRTdW1YID0gMDsKICBsZXQgd2VpZ2h0ZWRTdW1ZID0gMDsKICBsZXQgd2VpZ2h0U3VtID0gMDsKICBmb3IgKGxldCBpID0gcmVsZXZhbnRWYWx1ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIGNvbnN0IHN0ZXBzID0gcmVsZXZhbnRWYWx1ZXMubGVuZ3RoIC0gMSAtIGk7CiAgICBjb25zdCB3ZWlnaHQgPSBkZWNheUJhc2UgKiogc3RlcHM7CiAgICB3ZWlnaHRlZFN1bVggKz0gcmVsZXZhbnRWYWx1ZXNbaV1bMF0gKiB3ZWlnaHQ7CiAgICB3ZWlnaHRlZFN1bVkgKz0gcmVsZXZhbnRWYWx1ZXNbaV1bMV0gKiB3ZWlnaHQ7CiAgICB3ZWlnaHRTdW0gKz0gd2VpZ2h0OwogIH0KICByZXR1cm4gW3dlaWdodGVkU3VtWCAvIHdlaWdodFN1bSwgd2VpZ2h0ZWRTdW1ZIC8gd2VpZ2h0U3VtXTsKfTsKdmFyIGlmTm90TnVsbCA9ICh2LCBhbHRlcm5hdGl2ZSA9IG51bGwpID0+IHYgPT09IG51bGwgPyBhbHRlcm5hdGl2ZSA6IHY7CnZhciBjYWNoZWRMYXNzb1N0eWxlc2hlZXRzOwp2YXIgZ2V0TGFzc29TdHlsZXNoZWV0cyA9ICgpID0+IHsKICBpZiAoIWNhY2hlZExhc3NvU3R5bGVzaGVldHMpIHsKICAgIGNvbnN0IGxhc3NvU3R5bGVFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIik7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGxhc3NvU3R5bGVFbCk7CiAgICBjYWNoZWRMYXNzb1N0eWxlc2hlZXRzID0gbGFzc29TdHlsZUVsLnNoZWV0OwogIH0KICByZXR1cm4gY2FjaGVkTGFzc29TdHlsZXNoZWV0czsKfTsKdmFyIGFkZFJ1bGUgPSAocnVsZSkgPT4gewogIGNvbnN0IGxhc3NvU3R5bGVzaGVldHMgPSBnZXRMYXNzb1N0eWxlc2hlZXRzKCk7CiAgY29uc3QgY3VycmVudE51bVJ1bGVzID0gbGFzc29TdHlsZXNoZWV0cy5ydWxlcy5sZW5ndGg7CiAgbGFzc29TdHlsZXNoZWV0cy5pbnNlcnRSdWxlKHJ1bGUsIGN1cnJlbnROdW1SdWxlcyk7CiAgcmV0dXJuIGN1cnJlbnROdW1SdWxlczsKfTsKdmFyIHJlbW92ZVJ1bGUgPSAoaW5kZXgpID0+IHsKICBnZXRMYXNzb1N0eWxlc2hlZXRzKCkuZGVsZXRlUnVsZShpbmRleCk7Cn07CnZhciBpbkFuaW1hdGlvbiA9IGAke0xBU1NPX1NIT1dfU1RBUlRfSU5JVElBVE9SX1RJTUV9bXMgZWFzZSBzY2FsZUluRmFkZU91dCAwcyAxIG5vcm1hbCBiYWNrd2FyZHNgOwp2YXIgY3JlYXRlSW5BbmltYXRpb25SdWxlID0gKG9wYWNpdHksIHNjYWxlLCByb3RhdGUpID0+IGAKQGtleWZyYW1lcyBzY2FsZUluRmFkZU91dCB7CiAgMCUgewogICAgb3BhY2l0eTogJHtvcGFjaXR5fTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsLTUwJSkgc2NhbGUoJHtzY2FsZX0pIHJvdGF0ZSgke3JvdGF0ZX1kZWcpOwogIH0KICAxMCUgewogICAgb3BhY2l0eTogMTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsLTUwJSkgc2NhbGUoMSkgcm90YXRlKCR7cm90YXRlICsgMjB9ZGVnKTsKICB9CiAgMTAwJSB7CiAgICBvcGFjaXR5OiAwOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgwLjkpIHJvdGF0ZSgke3JvdGF0ZSArIDYwfWRlZyk7CiAgfQp9CmA7CnZhciBpbkFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CnZhciBvdXRBbmltYXRpb24gPSBgJHtMQVNTT19ISURFX1NUQVJUX0lOSVRJQVRPUl9USU1FfW1zIGVhc2UgZmFkZVNjYWxlT3V0IDBzIDEgbm9ybWFsIGJhY2t3YXJkc2A7CnZhciBjcmVhdGVPdXRBbmltYXRpb25SdWxlID0gKG9wYWNpdHksIHNjYWxlLCByb3RhdGUpID0+IGAKQGtleWZyYW1lcyBmYWRlU2NhbGVPdXQgewogIDAlIHsKICAgIG9wYWNpdHk6ICR7b3BhY2l0eX07CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLC01MCUpIHNjYWxlKCR7c2NhbGV9KSByb3RhdGUoJHtyb3RhdGV9ZGVnKTsKICB9CiAgMTAwJSB7CiAgICBvcGFjaXR5OiAwOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgwKSByb3RhdGUoJHtyb3RhdGV9ZGVnKTsKICB9Cn0KYDsKdmFyIG91dEFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CnZhciBjcmVhdGVMYXNzbyA9IChlbGVtZW50LCB7CiAgb25EcmF3OiBpbml0aWFsT25EcmF3ID0gaWRlbnRpdHksCiAgb25TdGFydDogaW5pdGlhbE9uU3RhcnQgPSBpZGVudGl0eSwKICBvbkVuZDogaW5pdGlhbE9uRW5kID0gaWRlbnRpdHksCiAgZW5hYmxlSW5pdGlhdG9yOiBpbml0aWFsZW5hYmxlSW5pdGlhdG9yID0gREVGQVVMVF9MQVNTT19TVEFSVF9JTklUSUFUT1JfU0hPVywKICBpbml0aWF0b3JQYXJlbnRFbGVtZW50OiBpbml0aWFsSW5pdGlhdG9yUGFyZW50RWxlbWVudCA9IGRvY3VtZW50LmJvZHksCiAgbG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudDogaW5pdGlhbExvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQgPSBkb2N1bWVudC5ib2R5LAogIG1pbkRlbGF5OiBpbml0aWFsTWluRGVsYXkgPSBERUZBVUxUX0xBU1NPX01JTl9ERUxBWSQxLAogIG1pbkRpc3Q6IGluaXRpYWxNaW5EaXN0ID0gREVGQVVMVF9MQVNTT19NSU5fRElTVCQxLAogIHBvaW50Tm9ybTogaW5pdGlhbFBvaW50Tm9ybSA9IGlkZW50aXR5LAogIHR5cGU6IGluaXRpYWxUeXBlID0gREVGQVVMVF9MQVNTT19UWVBFJDEsCiAgYnJ1c2hTaXplOiBpbml0aWFsQnJ1c2hTaXplID0gREVGQVVMVF9CUlVTSF9TSVpFCn0gPSB7fSkgPT4gewogIGxldCBlbmFibGVJbml0aWF0b3IgPSBpbml0aWFsZW5hYmxlSW5pdGlhdG9yOwogIGxldCBpbml0aWF0b3JQYXJlbnRFbGVtZW50ID0gaW5pdGlhbEluaXRpYXRvclBhcmVudEVsZW1lbnQ7CiAgbGV0IGxvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQgPSBpbml0aWFsTG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudDsKICBsZXQgb25EcmF3ID0gaW5pdGlhbE9uRHJhdzsKICBsZXQgb25TdGFydCA9IGluaXRpYWxPblN0YXJ0OwogIGxldCBvbkVuZCA9IGluaXRpYWxPbkVuZDsKICBsZXQgbWluRGVsYXkgPSBpbml0aWFsTWluRGVsYXk7CiAgbGV0IG1pbkRpc3QgPSBpbml0aWFsTWluRGlzdDsKICBsZXQgcG9pbnROb3JtID0gaW5pdGlhbFBvaW50Tm9ybTsKICBsZXQgdHlwZSA9IGluaXRpYWxUeXBlOwogIGxldCBicnVzaFNpemUgPSBpbml0aWFsQnJ1c2hTaXplOwogIGNvbnN0IGluaXRpYXRvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGNvbnN0IGluaXRpYXRvcklkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDUpICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDUpOwogIGluaXRpYXRvci5pZCA9IGBsYXNzby1pbml0aWF0b3ItJHtpbml0aWF0b3JJZH1gOwogIGluaXRpYXRvci5zdHlsZS5wb3NpdGlvbiA9ICJmaXhlZCI7CiAgaW5pdGlhdG9yLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgaW5pdGlhdG9yLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gImNlbnRlciI7CiAgaW5pdGlhdG9yLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICBpbml0aWF0b3Iuc3R5bGUuekluZGV4ID0gOTk7CiAgaW5pdGlhdG9yLnN0eWxlLndpZHRoID0gIjRyZW0iOwogIGluaXRpYXRvci5zdHlsZS5oZWlnaHQgPSAiNHJlbSI7CiAgaW5pdGlhdG9yLnN0eWxlLmJvcmRlclJhZGl1cyA9ICI0cmVtIjsKICBpbml0aWF0b3Iuc3R5bGUub3BhY2l0eSA9IDAuNTsKICBpbml0aWF0b3Iuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZSgtNTAlLC01MCUpIHNjYWxlKDApIHJvdGF0ZSgwZGVnKSI7CiAgY29uc3QgewogICAgbG9uZ1ByZXNzLAogICAgbG9uZ1ByZXNzQ2lyY2xlLAogICAgbG9uZ1ByZXNzQ2lyY2xlTGVmdCwKICAgIGxvbmdQcmVzc0NpcmNsZVJpZ2h0LAogICAgbG9uZ1ByZXNzRWZmZWN0CiAgfSA9IGNyZWF0ZUxvbmdQcmVzc0VsZW1lbnRzKCk7CiAgbGV0IGlzTW91c2VEb3duID0gZmFsc2U7CiAgbGV0IGlzTGFzc28gPSBmYWxzZTsKICBsZXQgbGFzc29Qb3MgPSBbXTsKICBsZXQgbGFzc29Qb3NGbGF0ID0gW107CiAgbGV0IGxhc3NvQnJ1c2hDZW50ZXJQb3MgPSBbXTsKICBsZXQgbGFzc29CcnVzaE5vcm1hbHMgPSBbXTsKICBsZXQgcHJldk1vdXNlUG9zOwogIGxldCBsb25nUHJlc3NJc1N0YXJ0aW5nID0gZmFsc2U7CiAgbGV0IGxvbmdQcmVzc01haW5JbkFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CiAgbGV0IGxvbmdQcmVzc0VmZmVjdEluQW5pbWF0aW9uUnVsZUluZGV4ID0gbnVsbDsKICBsZXQgbG9uZ1ByZXNzQ2lyY2xlTGVmdEluQW5pbWF0aW9uUnVsZUluZGV4ID0gbnVsbDsKICBsZXQgbG9uZ1ByZXNzQ2lyY2xlUmlnaHRJbkFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CiAgbGV0IGxvbmdQcmVzc0NpcmNsZUluQW5pbWF0aW9uUnVsZUluZGV4ID0gbnVsbDsKICBsZXQgbG9uZ1ByZXNzTWFpbk91dEFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CiAgbGV0IGxvbmdQcmVzc0VmZmVjdE91dEFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CiAgbGV0IGxvbmdQcmVzc0NpcmNsZUxlZnRPdXRBbmltYXRpb25SdWxlSW5kZXggPSBudWxsOwogIGxldCBsb25nUHJlc3NDaXJjbGVSaWdodE91dEFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CiAgbGV0IGxvbmdQcmVzc0NpcmNsZU91dEFuaW1hdGlvblJ1bGVJbmRleCA9IG51bGw7CiAgY29uc3QgbW91c2VVcEhhbmRsZXIgPSAoKSA9PiB7CiAgICBpc01vdXNlRG93biA9IGZhbHNlOwogIH07CiAgY29uc3QgZ2V0TW91c2VQb3NpdGlvbiA9IChldmVudCkgPT4gewogICAgY29uc3QgeyBsZWZ0OiBsZWZ0MiwgdG9wOiB0b3AyIH0gPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgcmV0dXJuIFtldmVudC5jbGllbnRYIC0gbGVmdDIsIGV2ZW50LmNsaWVudFkgLSB0b3AyXTsKICB9OwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgbW91c2VVcEhhbmRsZXIpOwogIGNvbnN0IHJlc2V0SW5pdGlhdG9yU3R5bGUgPSAoKSA9PiB7CiAgICBpbml0aWF0b3Iuc3R5bGUub3BhY2l0eSA9IDAuNTsKICAgIGluaXRpYXRvci5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlKC01MCUsLTUwJSkgc2NhbGUoMCkgcm90YXRlKDBkZWcpIjsKICB9OwogIGNvbnN0IGdldEN1cnJlbnRUcmFuc2Zvcm1TdHlsZSA9IChub2RlLCBoYXNSb3RhdGVkKSA9PiB7CiAgICBjb25zdCBjb21wdXRlZFN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZShub2RlKTsKICAgIGNvbnN0IG9wYWNpdHkgPSArY29tcHV0ZWRTdHlsZS5vcGFjaXR5OwogICAgY29uc3QgbSA9IGNvbXB1dGVkU3R5bGUudHJhbnNmb3JtLm1hdGNoKC8oWzAtOS4tXSspKy9nKTsKICAgIGNvbnN0IGEgPSArbVswXTsKICAgIGNvbnN0IGIgPSArbVsxXTsKICAgIGNvbnN0IHNjYWxlID0gTWF0aC5zcXJ0KGEgKiBhICsgYiAqIGIpOwogICAgbGV0IHJvdGF0ZSA9IE1hdGguYXRhbjIoYiwgYSkgKiAoMTgwIC8gTWF0aC5QSSk7CiAgICByb3RhdGUgPSBoYXNSb3RhdGVkICYmIHJvdGF0ZSA8PSAwID8gMzYwICsgcm90YXRlIDogcm90YXRlOwogICAgcmV0dXJuIHsgb3BhY2l0eSwgc2NhbGUsIHJvdGF0ZSB9OwogIH07CiAgY29uc3Qgc2hvd0luaXRpYXRvciA9IChldmVudCkgPT4gewogICAgaWYgKCFlbmFibGVJbml0aWF0b3IgfHwgaXNNb3VzZURvd24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgeCA9IGV2ZW50LmNsaWVudFg7CiAgICBjb25zdCB5ID0gZXZlbnQuY2xpZW50WTsKICAgIGluaXRpYXRvci5zdHlsZS50b3AgPSBgJHt5fXB4YDsKICAgIGluaXRpYXRvci5zdHlsZS5sZWZ0ID0gYCR7eH1weGA7CiAgICBjb25zdCBzdHlsZSA9IGdldEN1cnJlbnRUcmFuc2Zvcm1TdHlsZShpbml0aWF0b3IpOwogICAgY29uc3Qgb3BhY2l0eSA9IHN0eWxlLm9wYWNpdHk7CiAgICBjb25zdCBzY2FsZSA9IHN0eWxlLnNjYWxlOwogICAgY29uc3Qgcm90YXRlID0gc3R5bGUucm90YXRlOwogICAgaW5pdGlhdG9yLnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5OwogICAgaW5pdGlhdG9yLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoLTUwJSwtNTAlKSBzY2FsZSgke3NjYWxlfSkgcm90YXRlKCR7cm90YXRlfWRlZylgOwogICAgaW5pdGlhdG9yLnN0eWxlLmFuaW1hdGlvbiA9ICJub25lIjsKICAgIG5leHRBbmltYXRpb25GcmFtZTIoKS50aGVuKCgpID0+IHsKICAgICAgaWYgKGluQW5pbWF0aW9uUnVsZUluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgcmVtb3ZlUnVsZShpbkFuaW1hdGlvblJ1bGVJbmRleCk7CiAgICAgIH0KICAgICAgaW5BbmltYXRpb25SdWxlSW5kZXggPSBhZGRSdWxlKAogICAgICAgIGNyZWF0ZUluQW5pbWF0aW9uUnVsZShvcGFjaXR5LCBzY2FsZSwgcm90YXRlKQogICAgICApOwogICAgICBpbml0aWF0b3Iuc3R5bGUuYW5pbWF0aW9uID0gaW5BbmltYXRpb247CiAgICAgIG5leHRBbmltYXRpb25GcmFtZTIoKS50aGVuKCgpID0+IHsKICAgICAgICByZXNldEluaXRpYXRvclN0eWxlKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKICBjb25zdCBoaWRlSW5pdGlhdG9yID0gKCkgPT4gewogICAgY29uc3QgeyBvcGFjaXR5LCBzY2FsZSwgcm90YXRlIH0gPSBnZXRDdXJyZW50VHJhbnNmb3JtU3R5bGUoaW5pdGlhdG9yKTsKICAgIGluaXRpYXRvci5zdHlsZS5vcGFjaXR5ID0gb3BhY2l0eTsKICAgIGluaXRpYXRvci5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKC01MCUsLTUwJSkgc2NhbGUoJHtzY2FsZX0pIHJvdGF0ZSgke3JvdGF0ZX1kZWcpYDsKICAgIGluaXRpYXRvci5zdHlsZS5hbmltYXRpb24gPSAibm9uZSI7CiAgICBuZXh0QW5pbWF0aW9uRnJhbWUyKDIpLnRoZW4oKCkgPT4gewogICAgICBpZiAob3V0QW5pbWF0aW9uUnVsZUluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgcmVtb3ZlUnVsZShvdXRBbmltYXRpb25SdWxlSW5kZXgpOwogICAgICB9CiAgICAgIG91dEFuaW1hdGlvblJ1bGVJbmRleCA9IGFkZFJ1bGUoCiAgICAgICAgY3JlYXRlT3V0QW5pbWF0aW9uUnVsZShvcGFjaXR5LCBzY2FsZSwgcm90YXRlKQogICAgICApOwogICAgICBpbml0aWF0b3Iuc3R5bGUuYW5pbWF0aW9uID0gb3V0QW5pbWF0aW9uOwogICAgICBuZXh0QW5pbWF0aW9uRnJhbWUyKCkudGhlbigoKSA9PiB7CiAgICAgICAgcmVzZXRJbml0aWF0b3JTdHlsZSgpOwogICAgICB9KTsKICAgIH0pOwogIH07CiAgY29uc3Qgc2hvd0xvbmdQcmVzc0luZGljYXRvciA9ICh4LCB5LCB7CiAgICB0aW1lOiB0aW1lMyA9IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19USU1FLAogICAgZXh0cmFUaW1lID0gREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX0FGVEVSX0VGRkVDVF9USU1FLAogICAgZGVsYXkgPSBERUZBVUxUX0xBU1NPX0xPTkdfUFJFU1NfRUZGRUNUX0RFTEFZCiAgfSA9IHsKICAgIHRpbWU6IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19USU1FLAogICAgZXh0cmFUaW1lOiBERUZBVUxUX0xBU1NPX0xPTkdfUFJFU1NfQUZURVJfRUZGRUNUX1RJTUUsCiAgICBkZWxheTogREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX0VGRkVDVF9ERUxBWQogIH0pID0+IHsKICAgIGxvbmdQcmVzc0lzU3RhcnRpbmcgPSB0cnVlOwogICAgY29uc3QgbWFpblN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZShsb25nUHJlc3MpOwogICAgbG9uZ1ByZXNzLnN0eWxlLmNvbG9yID0gbWFpblN0eWxlLmNvbG9yOwogICAgbG9uZ1ByZXNzLnN0eWxlLnRvcCA9IGAke3l9cHhgOwogICAgbG9uZ1ByZXNzLnN0eWxlLmxlZnQgPSBgJHt4fXB4YDsKICAgIGxvbmdQcmVzcy5zdHlsZS5hbmltYXRpb24gPSAibm9uZSI7CiAgICBjb25zdCBjaXJjbGVTdHlsZSA9IGdldENvbXB1dGVkU3R5bGUobG9uZ1ByZXNzQ2lyY2xlKTsKICAgIGxvbmdQcmVzc0NpcmNsZS5zdHlsZS5jbGlwUGF0aCA9IGNpcmNsZVN0eWxlLmNsaXBQYXRoOwogICAgbG9uZ1ByZXNzQ2lyY2xlLnN0eWxlLm9wYWNpdHkgPSBjaXJjbGVTdHlsZS5vcGFjaXR5OwogICAgbG9uZ1ByZXNzQ2lyY2xlLnN0eWxlLmFuaW1hdGlvbiA9ICJub25lIjsKICAgIGNvbnN0IGVmZmVjdFN0eWxlID0gZ2V0Q3VycmVudFRyYW5zZm9ybVN0eWxlKGxvbmdQcmVzc0VmZmVjdCk7CiAgICBsb25nUHJlc3NFZmZlY3Quc3R5bGUub3BhY2l0eSA9IGVmZmVjdFN0eWxlLm9wYWNpdHk7CiAgICBsb25nUHJlc3NFZmZlY3Quc3R5bGUudHJhbnNmb3JtID0gYHNjYWxlKCR7ZWZmZWN0U3R5bGUuc2NhbGV9KWA7CiAgICBsb25nUHJlc3NFZmZlY3Quc3R5bGUuYW5pbWF0aW9uID0gIm5vbmUiOwogICAgY29uc3QgY2lyY2xlTGVmdFN0eWxlID0gZ2V0Q3VycmVudFRyYW5zZm9ybVN0eWxlKGxvbmdQcmVzc0NpcmNsZUxlZnQpOwogICAgbG9uZ1ByZXNzQ2lyY2xlTGVmdC5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlKCR7Y2lyY2xlTGVmdFN0eWxlLnJvdGF0ZX1kZWcpYDsKICAgIGxvbmdQcmVzc0NpcmNsZUxlZnQuc3R5bGUuYW5pbWF0aW9uID0gIm5vbmUiOwogICAgY29uc3QgY2lyY2xlUmlnaHRTdHlsZSA9IGdldEN1cnJlbnRUcmFuc2Zvcm1TdHlsZShsb25nUHJlc3NDaXJjbGVSaWdodCk7CiAgICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlKCR7Y2lyY2xlUmlnaHRTdHlsZS5yb3RhdGV9ZGVnKWA7CiAgICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5hbmltYXRpb24gPSAibm9uZSI7CiAgICBuZXh0QW5pbWF0aW9uRnJhbWUyKCkudGhlbigoKSA9PiB7CiAgICAgIGlmICghbG9uZ1ByZXNzSXNTdGFydGluZykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobG9uZ1ByZXNzQ2lyY2xlSW5BbmltYXRpb25SdWxlSW5kZXggIT09IG51bGwpIHsKICAgICAgICByZW1vdmVSdWxlKGxvbmdQcmVzc0NpcmNsZUluQW5pbWF0aW9uUnVsZUluZGV4KTsKICAgICAgfQogICAgICBpZiAobG9uZ1ByZXNzQ2lyY2xlUmlnaHRJbkFuaW1hdGlvblJ1bGVJbmRleCAhPT0gbnVsbCkgewogICAgICAgIHJlbW92ZVJ1bGUobG9uZ1ByZXNzQ2lyY2xlUmlnaHRJbkFuaW1hdGlvblJ1bGVJbmRleCk7CiAgICAgIH0KICAgICAgaWYgKGxvbmdQcmVzc0NpcmNsZUxlZnRJbkFuaW1hdGlvblJ1bGVJbmRleCAhPT0gbnVsbCkgewogICAgICAgIHJlbW92ZVJ1bGUobG9uZ1ByZXNzQ2lyY2xlTGVmdEluQW5pbWF0aW9uUnVsZUluZGV4KTsKICAgICAgfQogICAgICBpZiAobG9uZ1ByZXNzRWZmZWN0SW5BbmltYXRpb25SdWxlSW5kZXggIT09IG51bGwpIHsKICAgICAgICByZW1vdmVSdWxlKGxvbmdQcmVzc0VmZmVjdEluQW5pbWF0aW9uUnVsZUluZGV4KTsKICAgICAgfQogICAgICBpZiAobG9uZ1ByZXNzTWFpbkluQW5pbWF0aW9uUnVsZUluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgcmVtb3ZlUnVsZShsb25nUHJlc3NNYWluSW5BbmltYXRpb25SdWxlSW5kZXgpOwogICAgICB9CiAgICAgIGNvbnN0IHsgcnVsZXMsIG5hbWVzIH0gPSBjcmVhdGVMb25nUHJlc3NJbkFuaW1hdGlvbnMoewogICAgICAgIHRpbWU6IHRpbWUzLAogICAgICAgIGV4dHJhVGltZSwKICAgICAgICBkZWxheSwKICAgICAgICBjdXJyZW50Q29sb3I6IG1haW5TdHlsZS5jb2xvciB8fCAiY3VycmVudGNvbG9yIiwKICAgICAgICB0YXJnZXRDb2xvcjogbG9uZ1ByZXNzLmRhdGFzZXQuYWN0aXZlQ29sb3IsCiAgICAgICAgZWZmZWN0T3BhY2l0eTogZWZmZWN0U3R5bGUub3BhY2l0eSB8fCAwLAogICAgICAgIGVmZmVjdFNjYWxlOiBlZmZlY3RTdHlsZS5zY2FsZSB8fCAwLAogICAgICAgIGNpcmNsZUxlZnRSb3RhdGlvbjogY2lyY2xlTGVmdFN0eWxlLnJvdGF0ZSB8fCAwLAogICAgICAgIGNpcmNsZVJpZ2h0Um90YXRpb246IGNpcmNsZVJpZ2h0U3R5bGUucm90YXRlIHx8IDAsCiAgICAgICAgY2lyY2xlQ2xpcFBhdGg6IGNpcmNsZVN0eWxlLmNsaXBQYXRoIHx8ICJpbnNldCgwIDAgMCA1MCUpIiwKICAgICAgICBjaXJjbGVPcGFjaXR5OiBjaXJjbGVTdHlsZS5vcGFjaXR5IHx8IDAKICAgICAgfSk7CiAgICAgIGxvbmdQcmVzc01haW5JbkFuaW1hdGlvblJ1bGVJbmRleCA9IGFkZFJ1bGUocnVsZXMubWFpbik7CiAgICAgIGxvbmdQcmVzc0VmZmVjdEluQW5pbWF0aW9uUnVsZUluZGV4ID0gYWRkUnVsZShydWxlcy5lZmZlY3QpOwogICAgICBsb25nUHJlc3NDaXJjbGVMZWZ0SW5BbmltYXRpb25SdWxlSW5kZXggPSBhZGRSdWxlKHJ1bGVzLmNpcmNsZUxlZnQpOwogICAgICBsb25nUHJlc3NDaXJjbGVSaWdodEluQW5pbWF0aW9uUnVsZUluZGV4ID0gYWRkUnVsZShydWxlcy5jaXJjbGVSaWdodCk7CiAgICAgIGxvbmdQcmVzc0NpcmNsZUluQW5pbWF0aW9uUnVsZUluZGV4ID0gYWRkUnVsZShydWxlcy5jaXJjbGUpOwogICAgICBsb25nUHJlc3Muc3R5bGUuYW5pbWF0aW9uID0gbmFtZXMubWFpbjsKICAgICAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLmFuaW1hdGlvbiA9IG5hbWVzLmVmZmVjdDsKICAgICAgbG9uZ1ByZXNzQ2lyY2xlTGVmdC5zdHlsZS5hbmltYXRpb24gPSBuYW1lcy5jaXJjbGVMZWZ0OwogICAgICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5hbmltYXRpb24gPSBuYW1lcy5jaXJjbGVSaWdodDsKICAgICAgbG9uZ1ByZXNzQ2lyY2xlLnN0eWxlLmFuaW1hdGlvbiA9IG5hbWVzLmNpcmNsZTsKICAgIH0pOwogIH07CiAgY29uc3QgaGlkZUxvbmdQcmVzc0luZGljYXRvciA9ICh7IHRpbWU6IHRpbWUzID0gREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX1JFVkVSVF9FRkZFQ1RfVElNRSB9ID0gewogICAgdGltZTogREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX1JFVkVSVF9FRkZFQ1RfVElNRQogIH0pID0+IHsKICAgIGlmICghbG9uZ1ByZXNzSXNTdGFydGluZykgewogICAgICByZXR1cm47CiAgICB9CiAgICBsb25nUHJlc3NJc1N0YXJ0aW5nID0gZmFsc2U7CiAgICBjb25zdCBtYWluU3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlKGxvbmdQcmVzcyk7CiAgICBsb25nUHJlc3Muc3R5bGUuY29sb3IgPSBtYWluU3R5bGUuY29sb3I7CiAgICBsb25nUHJlc3Muc3R5bGUuYW5pbWF0aW9uID0gIm5vbmUiOwogICAgY29uc3QgY2lyY2xlU3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlKGxvbmdQcmVzc0NpcmNsZSk7CiAgICBsb25nUHJlc3NDaXJjbGUuc3R5bGUuY2xpcFBhdGggPSBjaXJjbGVTdHlsZS5jbGlwUGF0aDsKICAgIGxvbmdQcmVzc0NpcmNsZS5zdHlsZS5vcGFjaXR5ID0gY2lyY2xlU3R5bGUub3BhY2l0eTsKICAgIGxvbmdQcmVzc0NpcmNsZS5zdHlsZS5hbmltYXRpb24gPSAibm9uZSI7CiAgICBjb25zdCBlZmZlY3RTdHlsZSA9IGdldEN1cnJlbnRUcmFuc2Zvcm1TdHlsZShsb25nUHJlc3NFZmZlY3QpOwogICAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLm9wYWNpdHkgPSBlZmZlY3RTdHlsZS5vcGFjaXR5OwogICAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLnRyYW5zZm9ybSA9IGBzY2FsZSgke2VmZmVjdFN0eWxlLnNjYWxlfSlgOwogICAgbG9uZ1ByZXNzRWZmZWN0LnN0eWxlLmFuaW1hdGlvbiA9ICJub25lIjsKICAgIGNvbnN0IGlzQW5pbWF0ZWRNb3JlVGhhbjUwUGVyY2VudCA9IGNpcmNsZVN0eWxlLmNsaXBQYXRoLnNsaWNlKC0yLCAtMSkgPT09ICJ4IjsKICAgIGNvbnN0IGNpcmNsZUxlZnRTdHlsZSA9IGdldEN1cnJlbnRUcmFuc2Zvcm1TdHlsZSgKICAgICAgbG9uZ1ByZXNzQ2lyY2xlTGVmdCwKICAgICAgaXNBbmltYXRlZE1vcmVUaGFuNTBQZXJjZW50CiAgICApOwogICAgbG9uZ1ByZXNzQ2lyY2xlTGVmdC5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlKCR7Y2lyY2xlTGVmdFN0eWxlLnJvdGF0ZX1kZWcpYDsKICAgIGxvbmdQcmVzc0NpcmNsZUxlZnQuc3R5bGUuYW5pbWF0aW9uID0gIm5vbmUiOwogICAgY29uc3QgY2lyY2xlUmlnaHRTdHlsZSA9IGdldEN1cnJlbnRUcmFuc2Zvcm1TdHlsZShsb25nUHJlc3NDaXJjbGVSaWdodCk7CiAgICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlKCR7Y2lyY2xlUmlnaHRTdHlsZS5yb3RhdGV9ZGVnKWA7CiAgICBsb25nUHJlc3NDaXJjbGVSaWdodC5zdHlsZS5hbmltYXRpb24gPSAibm9uZSI7CiAgICBuZXh0QW5pbWF0aW9uRnJhbWUyKCkudGhlbigoKSA9PiB7CiAgICAgIGlmIChsb25nUHJlc3NDaXJjbGVPdXRBbmltYXRpb25SdWxlSW5kZXggIT09IG51bGwpIHsKICAgICAgICByZW1vdmVSdWxlKGxvbmdQcmVzc0NpcmNsZU91dEFuaW1hdGlvblJ1bGVJbmRleCk7CiAgICAgIH0KICAgICAgaWYgKGxvbmdQcmVzc0NpcmNsZVJpZ2h0T3V0QW5pbWF0aW9uUnVsZUluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgcmVtb3ZlUnVsZShsb25nUHJlc3NDaXJjbGVSaWdodE91dEFuaW1hdGlvblJ1bGVJbmRleCk7CiAgICAgIH0KICAgICAgaWYgKGxvbmdQcmVzc0NpcmNsZUxlZnRPdXRBbmltYXRpb25SdWxlSW5kZXggIT09IG51bGwpIHsKICAgICAgICByZW1vdmVSdWxlKGxvbmdQcmVzc0NpcmNsZUxlZnRPdXRBbmltYXRpb25SdWxlSW5kZXgpOwogICAgICB9CiAgICAgIGlmIChsb25nUHJlc3NFZmZlY3RPdXRBbmltYXRpb25SdWxlSW5kZXggIT09IG51bGwpIHsKICAgICAgICByZW1vdmVSdWxlKGxvbmdQcmVzc0VmZmVjdE91dEFuaW1hdGlvblJ1bGVJbmRleCk7CiAgICAgIH0KICAgICAgaWYgKGxvbmdQcmVzc01haW5PdXRBbmltYXRpb25SdWxlSW5kZXggIT09IG51bGwpIHsKICAgICAgICByZW1vdmVSdWxlKGxvbmdQcmVzc01haW5PdXRBbmltYXRpb25SdWxlSW5kZXgpOwogICAgICB9CiAgICAgIGNvbnN0IHsgcnVsZXMsIG5hbWVzIH0gPSBjcmVhdGVMb25nUHJlc3NPdXRBbmltYXRpb25zKHsKICAgICAgICB0aW1lOiB0aW1lMywKICAgICAgICBjdXJyZW50Q29sb3I6IG1haW5TdHlsZS5jb2xvciB8fCAiY3VycmVudGNvbG9yIiwKICAgICAgICB0YXJnZXRDb2xvcjogbG9uZ1ByZXNzLmRhdGFzZXQuY29sb3IsCiAgICAgICAgZWZmZWN0T3BhY2l0eTogZWZmZWN0U3R5bGUub3BhY2l0eSB8fCAwLAogICAgICAgIGVmZmVjdFNjYWxlOiBlZmZlY3RTdHlsZS5zY2FsZSB8fCAwLAogICAgICAgIGNpcmNsZUxlZnRSb3RhdGlvbjogY2lyY2xlTGVmdFN0eWxlLnJvdGF0ZSB8fCAwLAogICAgICAgIGNpcmNsZVJpZ2h0Um90YXRpb246IGNpcmNsZVJpZ2h0U3R5bGUucm90YXRlIHx8IDAsCiAgICAgICAgY2lyY2xlQ2xpcFBhdGg6IGNpcmNsZVN0eWxlLmNsaXBQYXRoIHx8ICJpbnNldCgwcHgpIiwKICAgICAgICBjaXJjbGVPcGFjaXR5OiBjaXJjbGVTdHlsZS5vcGFjaXR5IHx8IDEKICAgICAgfSk7CiAgICAgIGxvbmdQcmVzc01haW5PdXRBbmltYXRpb25SdWxlSW5kZXggPSBhZGRSdWxlKHJ1bGVzLm1haW4pOwogICAgICBsb25nUHJlc3NFZmZlY3RPdXRBbmltYXRpb25SdWxlSW5kZXggPSBhZGRSdWxlKHJ1bGVzLmVmZmVjdCk7CiAgICAgIGxvbmdQcmVzc0NpcmNsZUxlZnRPdXRBbmltYXRpb25SdWxlSW5kZXggPSBhZGRSdWxlKHJ1bGVzLmNpcmNsZUxlZnQpOwogICAgICBsb25nUHJlc3NDaXJjbGVSaWdodE91dEFuaW1hdGlvblJ1bGVJbmRleCA9IGFkZFJ1bGUocnVsZXMuY2lyY2xlUmlnaHQpOwogICAgICBsb25nUHJlc3NDaXJjbGVPdXRBbmltYXRpb25SdWxlSW5kZXggPSBhZGRSdWxlKHJ1bGVzLmNpcmNsZSk7CiAgICAgIGxvbmdQcmVzcy5zdHlsZS5hbmltYXRpb24gPSBuYW1lcy5tYWluOwogICAgICBsb25nUHJlc3NFZmZlY3Quc3R5bGUuYW5pbWF0aW9uID0gbmFtZXMuZWZmZWN0OwogICAgICBsb25nUHJlc3NDaXJjbGVMZWZ0LnN0eWxlLmFuaW1hdGlvbiA9IG5hbWVzLmNpcmNsZUxlZnQ7CiAgICAgIGxvbmdQcmVzc0NpcmNsZVJpZ2h0LnN0eWxlLmFuaW1hdGlvbiA9IG5hbWVzLmNpcmNsZVJpZ2h0OwogICAgICBsb25nUHJlc3NDaXJjbGUuc3R5bGUuYW5pbWF0aW9uID0gbmFtZXMuY2lyY2xlOwogICAgfSk7CiAgfTsKICBjb25zdCBkcmF3ID0gKCkgPT4gewogICAgb25EcmF3KGxhc3NvUG9zLCBsYXNzb1Bvc0ZsYXQpOwogIH07CiAgY29uc3QgZXh0ZW5kRnJlZWZvcm0gPSAocG9pbnQpID0+IHsKICAgIGxhc3NvUG9zLnB1c2gocG9pbnQpOwogICAgbGFzc29Qb3NGbGF0LnB1c2gocG9pbnRbMF0sIHBvaW50WzFdKTsKICB9OwogIGNvbnN0IGV4dGVuZFJlY3RhbmdsZSA9IChwb2ludCkgPT4gewogICAgY29uc3QgW3gsIHldID0gcG9pbnQ7CiAgICBjb25zdCBbc3RhcnRYLCBzdGFydFldID0gbGFzc29Qb3NbMF07CiAgICBsYXNzb1Bvc1sxXSA9IFt4LCBzdGFydFldOwogICAgbGFzc29Qb3NbMl0gPSBbeCwgeV07CiAgICBsYXNzb1Bvc1szXSA9IFtzdGFydFgsIHldOwogICAgbGFzc29Qb3NbNF0gPSBbc3RhcnRYLCBzdGFydFldOwogICAgbGFzc29Qb3NGbGF0WzJdID0geDsKICAgIGxhc3NvUG9zRmxhdFszXSA9IHN0YXJ0WTsKICAgIGxhc3NvUG9zRmxhdFs0XSA9IHg7CiAgICBsYXNzb1Bvc0ZsYXRbNV0gPSB5OwogICAgbGFzc29Qb3NGbGF0WzZdID0gc3RhcnRYOwogICAgbGFzc29Qb3NGbGF0WzddID0geTsKICAgIGxhc3NvUG9zRmxhdFs4XSA9IHN0YXJ0WDsKICAgIGxhc3NvUG9zRmxhdFs5XSA9IHN0YXJ0WTsKICB9OwogIGNvbnN0IHN0YXJ0QnJ1c2ggPSAocG9pbnQpID0+IHsKICAgIGxhc3NvQnJ1c2hDZW50ZXJQb3MucHVzaChwb2ludCk7CiAgfTsKICBjb25zdCBnZXROb3JtYWxpemVkQnJ1c2hTaXplID0gKCkgPT4gTWF0aC5hYnMocG9pbnROb3JtKFswLCAwXSlbMF0gLSBwb2ludE5vcm0oW2JydXNoU2l6ZSAvIDIsIDBdKVswXSk7CiAgY29uc3QgZ2V0QnJ1c2hOb3JtYWwgPSAocG9pbnQxLCBwb2ludDIsIHcpID0+IHsKICAgIGNvbnN0IFt4MSwgeTFdID0gcG9pbnQxOwogICAgY29uc3QgW3gyLCB5Ml0gPSBwb2ludDI7CiAgICBjb25zdCBkeCA9IHgxIC0geDI7CiAgICBjb25zdCBkeSA9IHkxIC0geTI7CiAgICBjb25zdCBkbiA9IGwyTm9ybShbZHgsIGR5XSk7CiAgICByZXR1cm4gWytkeSAvIGRuICogdywgLWR4IC8gZG4gKiB3XTsKICB9OwogIGNvbnN0IGV4dGVuZEJydXNoID0gKHBvaW50KSA9PiB7CiAgICBjb25zdCBwcmV2UG9pbnQgPSBsYXNzb0JydXNoQ2VudGVyUG9zLmF0KC0xKTsKICAgIGNvbnN0IHdpZHRoID0gZ2V0Tm9ybWFsaXplZEJydXNoU2l6ZSgpOwogICAgbGV0IFtueCwgbnldID0gZ2V0QnJ1c2hOb3JtYWwocG9pbnQsIHByZXZQb2ludCwgd2lkdGgpOwogICAgY29uc3QgTiA9IGxhc3NvQnJ1c2hDZW50ZXJQb3MubGVuZ3RoOwogICAgaWYgKE4gPT09IDEpIHsKICAgICAgY29uc3QgcGwyID0gW3ByZXZQb2ludFswXSArIG54LCBwcmV2UG9pbnRbMV0gKyBueV07CiAgICAgIGNvbnN0IHByMiA9IFtwcmV2UG9pbnRbMF0gLSBueCwgcHJldlBvaW50WzFdIC0gbnldOwogICAgICBsYXNzb1Bvcy5wdXNoKHBsMiwgcHIyKTsKICAgICAgbGFzc29Qb3NGbGF0LnB1c2gocGwyWzBdLCBwbDJbMV0sIHByMlswXSwgcHIyWzFdKTsKICAgICAgbGFzc29CcnVzaE5vcm1hbHMucHVzaChbbngsIG55XSk7CiAgICB9IGVsc2UgewogICAgICBbbngsIG55XSA9IGdldEJydXNoTm9ybWFsKHBvaW50LCBwcmV2UG9pbnQsIHdpZHRoKTsKICAgICAgY29uc3QgbmV4dFJhd0JydXNoTm9ybWFscyA9IFsuLi5sYXNzb0JydXNoTm9ybWFscywgW254LCBueV1dOwogICAgICBbbngsIG55XSA9IGV4cG9uZW50aWFsTW92aW5nQXZlcmFnZShuZXh0UmF3QnJ1c2hOb3JtYWxzLCAxLCAxMCk7CiAgICAgIGNvbnN0IFtwbngsIHBueV0gPSBsYXNzb0JydXNoTm9ybWFscy5hdCgtMSk7CiAgICAgIGNvbnN0IHBueDIgPSAobnggKyBwbngpIC8gMjsKICAgICAgY29uc3QgcG55MiA9IChueSArIHBueSkgLyAyOwogICAgICBjb25zdCBwbDIgPSBbcHJldlBvaW50WzBdICsgcG54MiwgcHJldlBvaW50WzFdICsgcG55Ml07CiAgICAgIGNvbnN0IHByMiA9IFtwcmV2UG9pbnRbMF0gLSBwbngyLCBwcmV2UG9pbnRbMV0gLSBwbnkyXTsKICAgICAgbGFzc29Qb3Muc3BsaWNlKE4gLSAxLCAyLCBwbDIsIHByMik7CiAgICAgIGxhc3NvUG9zRmxhdC5zcGxpY2UoMiAqIChOIC0gMSksIDQsIHBsMlswXSwgcGwyWzFdLCBwcjJbMF0sIHByMlsxXSk7CiAgICAgIGxhc3NvQnJ1c2hOb3JtYWxzLnNwbGljZShOLCAxLCBbcG54MiwgcG55Ml0pOwogICAgfQogICAgY29uc3QgcGwgPSBbcG9pbnRbMF0gKyBueCwgcG9pbnRbMV0gKyBueV07CiAgICBjb25zdCBwciA9IFtwb2ludFswXSAtIG54LCBwb2ludFsxXSAtIG55XTsKICAgIGxhc3NvUG9zLnNwbGljZShOLCAwLCBwbCwgcHIpOwogICAgbGFzc29Qb3NGbGF0LnNwbGljZSgyICogTiwgMCwgcGxbMF0sIHBsWzFdLCBwclswXSwgcHJbMV0pOwogICAgbGFzc29CcnVzaENlbnRlclBvcy5wdXNoKHBvaW50KTsKICAgIGxhc3NvQnJ1c2hOb3JtYWxzLnB1c2goW254LCBueV0pOwogIH07CiAgbGV0IGV4dGVuZExhc3NvID0gZXh0ZW5kRnJlZWZvcm07CiAgbGV0IHN0YXJ0TGFzc28gPSBleHRlbmRGcmVlZm9ybTsKICBjb25zdCBleHRlbmQyID0gKGN1cnJNb3VzZVBvcykgPT4gewogICAgaWYgKHByZXZNb3VzZVBvcykgewogICAgICBjb25zdCBkID0gbDJQb2ludERpc3QoCiAgICAgICAgY3Vyck1vdXNlUG9zWzBdLAogICAgICAgIGN1cnJNb3VzZVBvc1sxXSwKICAgICAgICBwcmV2TW91c2VQb3NbMF0sCiAgICAgICAgcHJldk1vdXNlUG9zWzFdCiAgICAgICk7CiAgICAgIGlmIChkID4gbWluRGlzdCkgewogICAgICAgIHByZXZNb3VzZVBvcyA9IGN1cnJNb3VzZVBvczsKICAgICAgICBleHRlbmRMYXNzbyhwb2ludE5vcm0oY3Vyck1vdXNlUG9zKSk7CiAgICAgICAgaWYgKGxhc3NvUG9zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIGRyYXcoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmICghaXNMYXNzbykgewogICAgICAgIGlzTGFzc28gPSB0cnVlOwogICAgICAgIG9uU3RhcnQoKTsKICAgICAgfQogICAgICBwcmV2TW91c2VQb3MgPSBjdXJyTW91c2VQb3M7CiAgICAgIGNvbnN0IHBvaW50ID0gcG9pbnROb3JtKGN1cnJNb3VzZVBvcyk7CiAgICAgIHN0YXJ0TGFzc28ocG9pbnQpOwogICAgfQogIH07CiAgY29uc3QgZXh0ZW5kRGIgPSB0aHJvdHRsZUFuZERlYm91bmNlMihleHRlbmQyLCBtaW5EZWxheSwgbWluRGVsYXkpOwogIGNvbnN0IGV4dGVuZFB1YmxpYyA9IChldmVudCwgZGVib3VuY2VkKSA9PiB7CiAgICBjb25zdCBtb3VzZVBvc2l0aW9uID0gZ2V0TW91c2VQb3NpdGlvbihldmVudCk7CiAgICBpZiAoZGVib3VuY2VkKSB7CiAgICAgIHJldHVybiBleHRlbmREYihtb3VzZVBvc2l0aW9uKTsKICAgIH0KICAgIHJldHVybiBleHRlbmQyKG1vdXNlUG9zaXRpb24pOwogIH07CiAgY29uc3QgY2xlYXIgPSAoKSA9PiB7CiAgICBsYXNzb1BvcyA9IFtdOwogICAgbGFzc29Qb3NGbGF0ID0gW107CiAgICBsYXNzb0JydXNoQ2VudGVyUG9zID0gW107CiAgICBsYXNzb0JydXNoTm9ybWFscyA9IFtdOwogICAgcHJldk1vdXNlUG9zID0gdm9pZCAwOwogICAgZHJhdygpOwogIH07CiAgY29uc3QgaW5pdGlhdG9yQ2xpY2tIYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBzaG93SW5pdGlhdG9yKGV2ZW50KTsKICB9OwogIGNvbnN0IGluaXRpYXRvck1vdXNlRG93bkhhbmRsZXIgPSAoKSA9PiB7CiAgICBpc01vdXNlRG93biA9IHRydWU7CiAgICBpc0xhc3NvID0gdHJ1ZTsKICAgIGNsZWFyKCk7CiAgICBvblN0YXJ0KCk7CiAgfTsKICBjb25zdCBpbml0aWF0b3JNb3VzZUxlYXZlSGFuZGxlciA9ICgpID0+IHsKICAgIGhpZGVJbml0aWF0b3IoKTsKICB9OwogIGNvbnN0IGVuZCA9ICh7IG1lcmdlID0gZmFsc2UsIHJlbW92ZTogcmVtb3ZlMiA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgaXNMYXNzbyA9IGZhbHNlOwogICAgY29uc3QgY3Vyckxhc3NvUG9zID0gWy4uLmxhc3NvUG9zXTsKICAgIGNvbnN0IGN1cnJMYXNzb1Bvc0ZsYXQgPSBbLi4ubGFzc29Qb3NGbGF0XTsKICAgIGV4dGVuZERiLmNhbmNlbCgpOwogICAgY2xlYXIoKTsKICAgIGlmIChjdXJyTGFzc29Qb3MubGVuZ3RoID4gMCkgewogICAgICBvbkVuZChjdXJyTGFzc29Qb3MsIGN1cnJMYXNzb1Bvc0ZsYXQsIHsgbWVyZ2UsIHJlbW92ZTogcmVtb3ZlMiB9KTsKICAgIH0KICAgIHJldHVybiBjdXJyTGFzc29Qb3M7CiAgfTsKICBjb25zdCBzZXRFeHRlbmRMYXNzbyA9IChuZXdUeXBlKSA9PiB7CiAgICBzd2l0Y2ggKG5ld1R5cGUpIHsKICAgICAgY2FzZSAicmVjdGFuZ2xlIjogewogICAgICAgIHR5cGUgPSBuZXdUeXBlOwogICAgICAgIGV4dGVuZExhc3NvID0gZXh0ZW5kUmVjdGFuZ2xlOwogICAgICAgIHN0YXJ0TGFzc28gPSBleHRlbmRGcmVlZm9ybTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlICJicnVzaCI6IHsKICAgICAgICB0eXBlID0gbmV3VHlwZTsKICAgICAgICBleHRlbmRMYXNzbyA9IGV4dGVuZEJydXNoOwogICAgICAgIHN0YXJ0TGFzc28gPSBzdGFydEJydXNoOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICB0eXBlID0gImZyZWVmb3JtIjsKICAgICAgICBleHRlbmRMYXNzbyA9IGV4dGVuZEZyZWVmb3JtOwogICAgICAgIHN0YXJ0TGFzc28gPSBleHRlbmRGcmVlZm9ybTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH07CiAgY29uc3QgZ2V0ID0gKHByb3BlcnR5KSA9PiB7CiAgICBpZiAocHJvcGVydHkgPT09ICJvbkRyYXciKSB7CiAgICAgIHJldHVybiBvbkRyYXc7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJvblN0YXJ0IikgewogICAgICByZXR1cm4gb25TdGFydDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gIm9uRW5kIikgewogICAgICByZXR1cm4gb25FbmQ7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJlbmFibGVJbml0aWF0b3IiKSB7CiAgICAgIHJldHVybiBlbmFibGVJbml0aWF0b3I7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJtaW5EZWxheSIpIHsKICAgICAgcmV0dXJuIG1pbkRlbGF5OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAibWluRGlzdCIpIHsKICAgICAgcmV0dXJuIG1pbkRpc3Q7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludE5vcm0iKSB7CiAgICAgIHJldHVybiBwb2ludE5vcm07CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJ0eXBlIikgewogICAgICByZXR1cm4gdHlwZTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImJydXNoU2l6ZSIpIHsKICAgICAgcmV0dXJuIGJydXNoU2l6ZTsKICAgIH0KICB9OwogIGNvbnN0IHNldCA9ICh7CiAgICBvbkRyYXc6IG5ld09uRHJhdyA9IG51bGwsCiAgICBvblN0YXJ0OiBuZXdPblN0YXJ0ID0gbnVsbCwKICAgIG9uRW5kOiBuZXdPbkVuZCA9IG51bGwsCiAgICBlbmFibGVJbml0aWF0b3I6IG5ld0VuYWJsZUluaXRpYXRvciA9IG51bGwsCiAgICBpbml0aWF0b3JQYXJlbnRFbGVtZW50OiBuZXdJbml0aWF0b3JQYXJlbnRFbGVtZW50ID0gbnVsbCwKICAgIGxvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQ6IG5ld0xvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQgPSBudWxsLAogICAgbWluRGVsYXk6IG5ld01pbkRlbGF5ID0gbnVsbCwKICAgIG1pbkRpc3Q6IG5ld01pbkRpc3QgPSBudWxsLAogICAgcG9pbnROb3JtOiBuZXdQb2ludE5vcm0gPSBudWxsLAogICAgdHlwZTogbmV3VHlwZSA9IG51bGwsCiAgICBicnVzaFNpemU6IG5ld0JydXNoU2l6ZSA9IG51bGwKICB9ID0ge30pID0+IHsKICAgIG9uRHJhdyA9IGlmTm90TnVsbChuZXdPbkRyYXcsIG9uRHJhdyk7CiAgICBvblN0YXJ0ID0gaWZOb3ROdWxsKG5ld09uU3RhcnQsIG9uU3RhcnQpOwogICAgb25FbmQgPSBpZk5vdE51bGwobmV3T25FbmQsIG9uRW5kKTsKICAgIGVuYWJsZUluaXRpYXRvciA9IGlmTm90TnVsbChuZXdFbmFibGVJbml0aWF0b3IsIGVuYWJsZUluaXRpYXRvcik7CiAgICBtaW5EZWxheSA9IGlmTm90TnVsbChuZXdNaW5EZWxheSwgbWluRGVsYXkpOwogICAgbWluRGlzdCA9IGlmTm90TnVsbChuZXdNaW5EaXN0LCBtaW5EaXN0KTsKICAgIHBvaW50Tm9ybSA9IGlmTm90TnVsbChuZXdQb2ludE5vcm0sIHBvaW50Tm9ybSk7CiAgICBicnVzaFNpemUgPSBpZk5vdE51bGwobmV3QnJ1c2hTaXplLCBicnVzaFNpemUpOwogICAgaWYgKG5ld0luaXRpYXRvclBhcmVudEVsZW1lbnQgIT09IG51bGwgJiYgbmV3SW5pdGlhdG9yUGFyZW50RWxlbWVudCAhPT0gaW5pdGlhdG9yUGFyZW50RWxlbWVudCkgewogICAgICBpbml0aWF0b3JQYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGluaXRpYXRvcik7CiAgICAgIG5ld0luaXRpYXRvclBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoaW5pdGlhdG9yKTsKICAgICAgaW5pdGlhdG9yUGFyZW50RWxlbWVudCA9IG5ld0luaXRpYXRvclBhcmVudEVsZW1lbnQ7CiAgICB9CiAgICBpZiAobmV3TG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudCAhPT0gbnVsbCAmJiBuZXdMb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50ICE9PSBsb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50KSB7CiAgICAgIGxvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQobG9uZ1ByZXNzKTsKICAgICAgbmV3TG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChsb25nUHJlc3MpOwogICAgICBsb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50ID0gbmV3TG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudDsKICAgIH0KICAgIGlmIChlbmFibGVJbml0aWF0b3IpIHsKICAgICAgaW5pdGlhdG9yLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgaW5pdGlhdG9yQ2xpY2tIYW5kbGVyKTsKICAgICAgaW5pdGlhdG9yLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIGluaXRpYXRvck1vdXNlRG93bkhhbmRsZXIpOwogICAgICBpbml0aWF0b3IuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VsZWF2ZSIsIGluaXRpYXRvck1vdXNlTGVhdmVIYW5kbGVyKTsKICAgIH0gZWxzZSB7CiAgICAgIGluaXRpYXRvci5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBpbml0aWF0b3JNb3VzZURvd25IYW5kbGVyKTsKICAgICAgaW5pdGlhdG9yLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlbGVhdmUiLCBpbml0aWF0b3JNb3VzZUxlYXZlSGFuZGxlcik7CiAgICB9CiAgICBpZiAobmV3VHlwZSAhPT0gbnVsbCkgewogICAgICBzZXRFeHRlbmRMYXNzbyhuZXdUeXBlKTsKICAgIH0KICB9OwogIGNvbnN0IGRlc3Ryb3kgPSAoKSA9PiB7CiAgICBpbml0aWF0b3JQYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGluaXRpYXRvcik7CiAgICBsb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGxvbmdQcmVzcyk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIG1vdXNlVXBIYW5kbGVyKTsKICAgIGluaXRpYXRvci5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIGluaXRpYXRvckNsaWNrSGFuZGxlcik7CiAgICBpbml0aWF0b3IucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgaW5pdGlhdG9yTW91c2VEb3duSGFuZGxlcik7CiAgICBpbml0aWF0b3IucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2VsZWF2ZSIsIGluaXRpYXRvck1vdXNlTGVhdmVIYW5kbGVyKTsKICB9OwogIGNvbnN0IHdpdGhQdWJsaWNNZXRob2RzID0gKCkgPT4gKHNlbGYyKSA9PiBhc3NpZ24oc2VsZjIsIHsKICAgIGNsZWFyLAogICAgZGVzdHJveSwKICAgIGVuZCwKICAgIGV4dGVuZDogZXh0ZW5kUHVibGljLAogICAgZ2V0LAogICAgc2V0LAogICAgc2hvd0luaXRpYXRvciwKICAgIGhpZGVJbml0aWF0b3IsCiAgICBzaG93TG9uZ1ByZXNzSW5kaWNhdG9yLAogICAgaGlkZUxvbmdQcmVzc0luZGljYXRvcgogIH0pOwogIGluaXRpYXRvclBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoaW5pdGlhdG9yKTsKICBsb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKGxvbmdQcmVzcyk7CiAgc2V0KHsKICAgIG9uRHJhdywKICAgIG9uU3RhcnQsCiAgICBvbkVuZCwKICAgIGVuYWJsZUluaXRpYXRvciwKICAgIGluaXRpYXRvclBhcmVudEVsZW1lbnQsCiAgICB0eXBlLAogICAgYnJ1c2hTaXplCiAgfSk7CiAgcmV0dXJuIHBpcGUoCiAgICB3aXRoU3RhdGljUHJvcGVydHkoImluaXRpYXRvciIsIGluaXRpYXRvciksCiAgICB3aXRoU3RhdGljUHJvcGVydHkoImxvbmdQcmVzc0luZGljYXRvciIsIGxvbmdQcmVzcyksCiAgICB3aXRoUHVibGljTWV0aG9kcygpLAogICAgd2l0aENvbnN0cnVjdG9yKGNyZWF0ZUxhc3NvKQogICkoe30pOwp9Owp2YXIgY2hlY2tSZWdsRXh0ZW5zaW9ucyA9IChyZWdsLCBzaWxlbnQpID0+IHsKICBpZiAoIXJlZ2wpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIEdMX0VYVEVOU0lPTlMucmVkdWNlKChldmVyeSwgZXh0ZW5zaW9uKSA9PiB7CiAgICBpZiAoIXJlZ2wuaGFzRXh0ZW5zaW9uKGV4dGVuc2lvbikpIHsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgICBgV2ViR0w6ICR7ZXh0ZW5zaW9ufSBleHRlbnNpb24gbm90IHN1cHBvcnRlZC4gU2NhdHRlcnBsb3QgbWlnaHQgbm90IHJlbmRlciBwcm9wZXJseWAKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiBldmVyeTsKICB9LCB0cnVlKTsKfTsKdmFyIGNyZWF0ZVJlZ2wgPSAoY2FudmFzKSA9PiB7CiAgY29uc3QgZ2wgPSBjYW52YXMuZ2V0Q29udGV4dCgid2ViZ2wiLCB7CiAgICBhbnRpYWxpYXM6IHRydWUsCiAgICBwcmVzZXJ2ZURyYXdpbmdCdWZmZXI6IHRydWUKICB9KTsKICBjb25zdCBleHRlbnNpb25zID0gW107CiAgZm9yIChjb25zdCBleHRlbnNpb24gb2YgR0xfRVhURU5TSU9OUykgewogICAgaWYgKGdsLmdldEV4dGVuc2lvbihleHRlbnNpb24pKSB7CiAgICAgIGV4dGVuc2lvbnMucHVzaChleHRlbnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgY29uc29sZS53YXJuKAogICAgICAgIGBXZWJHTDogJHtleHRlbnNpb259IGV4dGVuc2lvbiBub3Qgc3VwcG9ydGVkLiBTY2F0dGVycGxvdCBtaWdodCBub3QgcmVuZGVyIHByb3Blcmx5YAogICAgICApOwogICAgfQogIH0KICByZXR1cm4gKDAsIGltcG9ydF9yZWdsLmRlZmF1bHQpKHsgZ2wsIGV4dGVuc2lvbnMgfSk7Cn07CnZhciBkaXN0ID0gKHgxLCB5MSwgeDIsIHkyKSA9PiBNYXRoLnNxcnQoKHgxIC0geDIpICoqIDIgKyAoeTEgLSB5MikgKiogMik7CnZhciBnZXRCQm94ID0gKHBvc2l0aW9uczJkKSA9PiB7CiAgbGV0IHhNaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgbGV0IHhNYXggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgbGV0IHlNaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgbGV0IHlNYXggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMyZC5sZW5ndGg7IGkgKz0gMikgewogICAgeE1pbiA9IHBvc2l0aW9uczJkW2ldIDwgeE1pbiA/IHBvc2l0aW9uczJkW2ldIDogeE1pbjsKICAgIHhNYXggPSBwb3NpdGlvbnMyZFtpXSA+IHhNYXggPyBwb3NpdGlvbnMyZFtpXSA6IHhNYXg7CiAgICB5TWluID0gcG9zaXRpb25zMmRbaSArIDFdIDwgeU1pbiA/IHBvc2l0aW9uczJkW2kgKyAxXSA6IHlNaW47CiAgICB5TWF4ID0gcG9zaXRpb25zMmRbaSArIDFdID4geU1heCA/IHBvc2l0aW9uczJkW2kgKyAxXSA6IHlNYXg7CiAgfQogIHJldHVybiBbeE1pbiwgeU1pbiwgeE1heCwgeU1heF07Cn07CnZhciBpc1ZhbGlkQkJveCA9IChbeE1pbiwgeU1pbiwgeE1heCwgeU1heF0pID0+IE51bWJlci5pc0Zpbml0ZSh4TWluKSAmJiBOdW1iZXIuaXNGaW5pdGUoeU1pbikgJiYgTnVtYmVyLmlzRmluaXRlKHhNYXgpICYmIE51bWJlci5pc0Zpbml0ZSh5TWF4KSAmJiB4TWF4IC0geE1pbiA+IDAgJiYgeU1heCAtIHlNaW4gPiAwOwp2YXIgUkVHRVhfSEVYX1RPX1JHQiA9IC9eIz8oW2EtZlxkXSkoW2EtZlxkXSkoW2EtZlxkXSkkL2k7CnZhciBoZXhUb1JnYiA9IChoZXgyLCBpc05vcm1hbGl6ZSA9IGZhbHNlKSA9PiBoZXgyLnJlcGxhY2UoUkVHRVhfSEVYX1RPX1JHQiwgKF9tLCByLCBnLCBiKSA9PiBgIyR7cn0ke3J9JHtnfSR7Z30ke2J9JHtifWApLnN1YnN0cmluZygxKS5tYXRjaCgvLnsyfS9nKS5tYXAoKHgpID0+IE51bWJlci5wYXJzZUludCh4LCAxNikgLyAyNTUgKiogaXNOb3JtYWxpemUpOwp2YXIgaXNDb25kaXRpb25hbEFycmF5ID0gKGEsIGNvbmRpdGlvbiwgeyBtaW5MZW5ndGggPSAwIH0gPSB7fSkgPT4gQXJyYXkuaXNBcnJheShhKSAmJiBhLmxlbmd0aCA+PSBtaW5MZW5ndGggJiYgYS5ldmVyeShjb25kaXRpb24pOwp2YXIgaXNQb3NpdGl2ZU51bWJlciA9ICh4KSA9PiAhTnVtYmVyLmlzTmFOKCt4KSAmJiAreCA+PSAwOwp2YXIgaXNTdHJpY3RseVBvc2l0aXZlTnVtYmVyID0gKHgpID0+ICFOdW1iZXIuaXNOYU4oK3gpICYmICt4ID4gMDsKdmFyIGxpbWl0ID0gKGNob2ljZXMsIGRlZmF1bHRDaG9pY2UpID0+IChjaG9pY2UpID0+IGNob2ljZXMuaW5kZXhPZihjaG9pY2UpID49IDAgPyBjaG9pY2UgOiBkZWZhdWx0Q2hvaWNlOwp2YXIgbG9hZEltYWdlID0gKHNyYywgaXNDcm9zc09yaWdpbiA9IGZhbHNlLCB0aW1lb3V0ID0gREVGQVVMVF9JTUFHRV9MT0FEX1RJTUVPVVQpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICBjb25zdCBpbWFnZSA9IG5ldyBJbWFnZSgpOwogIGlmIChpc0Nyb3NzT3JpZ2luKSB7CiAgICBpbWFnZS5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogIH0KICBpbWFnZS5zcmMgPSBzcmM7CiAgaW1hZ2Uub25sb2FkID0gKCkgPT4gewogICAgcmVzb2x2ZShpbWFnZSk7CiAgfTsKICBjb25zdCByZWplY3RQcm9taXNlID0gKCkgPT4gewogICAgcmVqZWN0KG5ldyBFcnJvcihJTUFHRV9MT0FEX0VSUk9SKSk7CiAgfTsKICBpbWFnZS5vbmVycm9yID0gcmVqZWN0UHJvbWlzZTsKICBzZXRUaW1lb3V0KHJlamVjdFByb21pc2UsIHRpbWVvdXQpOwp9KTsKdmFyIGNyZWF0ZVRleHR1cmVGcm9tVXJsID0gKHJlZ2wsIHVybCwgdGltZW91dCA9IERFRkFVTFRfSU1BR0VfTE9BRF9USU1FT1VUKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgbG9hZEltYWdlKAogICAgdXJsLAogICAgdXJsLmluZGV4T2Yod2luZG93LmxvY2F0aW9uLm9yaWdpbikgIT09IDAgJiYgdXJsLmluZGV4T2YoImJhc2U2NCIpID09PSAtMSwKICAgIHRpbWVvdXQKICApLnRoZW4oKGltYWdlKSA9PiB7CiAgICByZXNvbHZlKHJlZ2wudGV4dHVyZShpbWFnZSkpOwogIH0pLmNhdGNoKChlcnJvcikgPT4gewogICAgcmVqZWN0KGVycm9yKTsKICB9KTsKfSk7CnZhciBoZXhUb1JnYmEgPSAoaGV4MiwgaXNOb3JtYWxpemUgPSBmYWxzZSkgPT4gWwogIC4uLmhleFRvUmdiKGhleDIsIGlzTm9ybWFsaXplKSwKICAyNTUgKiogIWlzTm9ybWFsaXplCl07CnZhciBSRUdFWF9JU19IRVggPSAvKF4jWzAtOUEtRl17Nn0kKXwoXiNbMC05QS1GXXszfSQpL2k7CnZhciBpc0hleCA9IChoZXgyKSA9PiBSRUdFWF9JU19IRVgudGVzdChoZXgyKTsKdmFyIGlzTm9ybUZsb2F0ID0gKHgpID0+IHggPj0gMCAmJiB4IDw9IDE7CnZhciBpc05vcm1GbG9hdEFycmF5ID0gKGEpID0+IEFycmF5LmlzQXJyYXkoYSkgJiYgYS5ldmVyeShpc05vcm1GbG9hdCk7CmZ1bmN0aW9uIGNyb3NzUHJvZHVjdCh4MSwgeTEsIHgyLCB5MiwgcHgsIHB5KSB7CiAgcmV0dXJuICh4MiAtIHgxKSAqIChweSAtIHkxKSAtIChweCAtIHgxKSAqICh5MiAtIHkxKTsKfQp2YXIgaXNQb2ludEluUG9seWdvbiA9IChwb2x5Z29uLCBbcHgsIHB5XSA9IFtdKSA9PiB7CiAgbGV0IHdpbmRpbmcgPSAwOwogIGZvciAobGV0IGkgPSAwLCBqID0gcG9seWdvbi5sZW5ndGggLSAyOyBpIDwgcG9seWdvbi5sZW5ndGg7IGkgKz0gMikgewogICAgY29uc3QgeDEgPSBwb2x5Z29uW2ldOwogICAgY29uc3QgeTEgPSBwb2x5Z29uW2kgKyAxXTsKICAgIGNvbnN0IHgyID0gcG9seWdvbltqXTsKICAgIGNvbnN0IHkyID0gcG9seWdvbltqICsgMV07CiAgICBpZiAoeTEgPD0gcHkpIHsKICAgICAgaWYgKHkyID4gcHkpIHsKICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IGNyb3NzUHJvZHVjdCh4MSwgeTEsIHgyLCB5MiwgcHgsIHB5KTsKICAgICAgICBpZiAob3JpZW50YXRpb24gPiAwKSB7CiAgICAgICAgICB3aW5kaW5nKys7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKHkyIDw9IHB5KSB7CiAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gY3Jvc3NQcm9kdWN0KHgxLCB5MSwgeDIsIHkyLCBweCwgcHkpOwogICAgICBpZiAob3JpZW50YXRpb24gPCAwKSB7CiAgICAgICAgd2luZGluZy0tOwogICAgICB9CiAgICB9CiAgICBqID0gaTsKICB9CiAgcmV0dXJuIHdpbmRpbmcgIT09IDA7Cn07CnZhciBpc1N0cmluZzIgPSAocykgPT4gdHlwZW9mIHMgPT09ICJzdHJpbmciIHx8IHMgaW5zdGFuY2VvZiBTdHJpbmc7CnZhciBpc1VpbnQ4ID0gKHgpID0+IE51bWJlci5pc0ludGVnZXIoeCkgJiYgeCA+PSAwICYmIHggPD0gMjU1Owp2YXIgaXNVaW50OEFycmF5ID0gKGEpID0+IEFycmF5LmlzQXJyYXkoYSkgJiYgYS5ldmVyeShpc1VpbnQ4KTsKdmFyIGlzUmdiID0gKHJnYjIpID0+IHJnYjIubGVuZ3RoID09PSAzICYmIChpc05vcm1GbG9hdEFycmF5KHJnYjIpIHx8IGlzVWludDhBcnJheShyZ2IyKSk7CnZhciBpc1JnYmEgPSAocmdiYTIpID0+IHJnYmEyLmxlbmd0aCA9PT0gNCAmJiAoaXNOb3JtRmxvYXRBcnJheShyZ2JhMikgfHwgaXNVaW50OEFycmF5KHJnYmEyKSk7CnZhciBpc011bHRpcGxlQ29sb3JzID0gKGNvbG9yMikgPT4gQXJyYXkuaXNBcnJheShjb2xvcjIpICYmIGNvbG9yMi5sZW5ndGggPiAwICYmIChBcnJheS5pc0FycmF5KGNvbG9yMlswXSkgfHwgaXNTdHJpbmcyKGNvbG9yMlswXSkpOwp2YXIgaXNTYW1lUmdiYXMgPSAoYSwgYikgPT4gewogIGlmICghKEFycmF5LmlzQXJyYXkoYSkgJiYgQXJyYXkuaXNBcnJheShiKSkgfHwgYS5sZW5ndGggIT09IGIubGVuZ3RoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChhLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmICghKEFycmF5LmlzQXJyYXkoYVswXSkgJiYgQXJyYXkuaXNBcnJheShiWzBdKSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIGEuZXZlcnkoKFtyMSwgZzEsIGIxLCBhMV0sIGkpID0+IHsKICAgIGNvbnN0IFtyMiwgZzIsIGIyLCBhMl0gPSBiW2ldOwogICAgcmV0dXJuIHIxID09PSByMiAmJiBnMSA9PT0gZzIgJiYgYjEgPT09IGIyICYmIGExID09PSBhMjsKICB9KTsKfTsKdmFyIG1heDIgPSAoYSwgYikgPT4gYSA+IGIgPyBhIDogYjsKdmFyIG1pbjIgPSAoYSwgYikgPT4gYSA8IGIgPyBhIDogYjsKdmFyIHRvUmdiYSA9IChjb2xvcjIsIHNob3VsZE5vcm1hbGl6ZSkgPT4gewogIGlmIChpc1JnYmEoY29sb3IyKSkgewogICAgY29uc3QgaXNOb3JtYWxpemVkID0gaXNOb3JtRmxvYXRBcnJheShjb2xvcjIpOwogICAgaWYgKHNob3VsZE5vcm1hbGl6ZSAmJiBpc05vcm1hbGl6ZWQgfHwgIShzaG91bGROb3JtYWxpemUgfHwgaXNOb3JtYWxpemVkKSkgewogICAgICByZXR1cm4gY29sb3IyOwogICAgfQogICAgaWYgKHNob3VsZE5vcm1hbGl6ZSAmJiAhaXNOb3JtYWxpemVkKSB7CiAgICAgIHJldHVybiBjb2xvcjIubWFwKCh4KSA9PiB4IC8gMjU1KTsKICAgIH0KICAgIHJldHVybiBjb2xvcjIubWFwKCh4KSA9PiB4ICogMjU1KTsKICB9CiAgaWYgKGlzUmdiKGNvbG9yMikpIHsKICAgIGNvbnN0IGJhc2UgPSAyNTUgKiogIXNob3VsZE5vcm1hbGl6ZTsKICAgIGNvbnN0IGlzTm9ybWFsaXplZCA9IGlzTm9ybUZsb2F0QXJyYXkoY29sb3IyKTsKICAgIGlmIChzaG91bGROb3JtYWxpemUgJiYgaXNOb3JtYWxpemVkIHx8ICEoc2hvdWxkTm9ybWFsaXplIHx8IGlzTm9ybWFsaXplZCkpIHsKICAgICAgcmV0dXJuIFsuLi5jb2xvcjIsIGJhc2VdOwogICAgfQogICAgaWYgKHNob3VsZE5vcm1hbGl6ZSAmJiAhaXNOb3JtYWxpemVkKSB7CiAgICAgIHJldHVybiBbLi4uY29sb3IyLm1hcCgoeCkgPT4geCAvIDI1NSksIGJhc2VdOwogICAgfQogICAgcmV0dXJuIFsuLi5jb2xvcjIubWFwKCh4KSA9PiB4ICogMjU1KSwgYmFzZV07CiAgfQogIGlmIChpc0hleChjb2xvcjIpKSB7CiAgICByZXR1cm4gaGV4VG9SZ2JhKGNvbG9yMiwgc2hvdWxkTm9ybWFsaXplKTsKICB9CiAgY29uc29sZS53YXJuKAogICAgIk9ubHkgSEVYLCBSR0IsIGFuZCBSR0JBIGFyZSBoYW5kbGVkIGJ5IHRoaXMgZnVuY3Rpb24uIFJldHVybmluZyB3aGl0ZSBpbnN0ZWFkLiIKICApOwogIHJldHVybiBzaG91bGROb3JtYWxpemUgPyBbMSwgMSwgMSwgMV0gOiBbMjU1LCAyNTUsIDI1NSwgMjU1XTsKfTsKdmFyIGZsaXBPYmogPSAob2JqKSA9PiBPYmplY3QuZW50cmllcyhvYmopLnJlZHVjZSgob3V0LCBba2V5LCB2YWx1ZV0pID0+IHsKICBpZiAob3V0W3ZhbHVlXSkgewogICAgb3V0W3ZhbHVlXSA9IFsuLi5vdXRbdmFsdWVdLCBrZXldOwogIH0gZWxzZSB7CiAgICBvdXRbdmFsdWVdID0ga2V5OwogIH0KICByZXR1cm4gb3V0Owp9LCB7fSk7CnZhciByZ2JCcmlnaHRuZXNzID0gKHJnYjIpID0+IDAuMjEgKiByZ2IyWzBdICsgMC43MiAqIHJnYjJbMV0gKyAwLjA3ICogcmdiMlsyXTsKdmFyIGNsaXAgPSAodmFsdWUsIG1pblZhbHVlLCBtYXhWYWx1ZSkgPT4gTWF0aC5taW4obWF4VmFsdWUsIE1hdGgubWF4KG1pblZhbHVlLCB2YWx1ZSkpOwp2YXIgdG9BcnJheU9yaWVudGVkUG9pbnRzID0gKHBvaW50cykgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogIGlmICghcG9pbnRzIHx8IEFycmF5LmlzQXJyYXkocG9pbnRzKSkgewogICAgcmVzb2x2ZShwb2ludHMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBsZW5ndGggPSBBcnJheS5pc0FycmF5KHBvaW50cy54KSB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcocG9pbnRzLngpID8gcG9pbnRzLngubGVuZ3RoIDogMDsKICAgIGNvbnN0IGdldFggPSAoQXJyYXkuaXNBcnJheShwb2ludHMueCkgfHwgQXJyYXlCdWZmZXIuaXNWaWV3KHBvaW50cy54KSkgJiYgKChpKSA9PiBwb2ludHMueFtpXSk7CiAgICBjb25zdCBnZXRZID0gKEFycmF5LmlzQXJyYXkocG9pbnRzLnkpIHx8IEFycmF5QnVmZmVyLmlzVmlldyhwb2ludHMueSkpICYmICgoaSkgPT4gcG9pbnRzLnlbaV0pOwogICAgY29uc3QgZ2V0TCA9IChBcnJheS5pc0FycmF5KHBvaW50cy5saW5lKSB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcocG9pbnRzLmxpbmUpKSAmJiAoKGkpID0+IHBvaW50cy5saW5lW2ldKTsKICAgIGNvbnN0IGdldExPID0gKEFycmF5LmlzQXJyYXkocG9pbnRzLmxpbmVPcmRlcikgfHwgQXJyYXlCdWZmZXIuaXNWaWV3KHBvaW50cy5saW5lT3JkZXIpKSAmJiAoKGkpID0+IHBvaW50cy5saW5lT3JkZXJbaV0pOwogICAgY29uc3QgY29tcG9uZW50cyA9IE9iamVjdC5rZXlzKHBvaW50cyk7CiAgICBjb25zdCBnZXRaID0gKCgpID0+IHsKICAgICAgY29uc3QgeiA9IGNvbXBvbmVudHMuZmluZCgoYykgPT4gWl9OQU1FUy5oYXMoYykpOwogICAgICByZXR1cm4geiAmJiAoQXJyYXkuaXNBcnJheShwb2ludHNbel0pIHx8IEFycmF5QnVmZmVyLmlzVmlldyhwb2ludHNbel0pKSAmJiAoKGkpID0+IHBvaW50c1t6XVtpXSk7CiAgICB9KSgpOwogICAgY29uc3QgZ2V0VyA9ICgoKSA9PiB7CiAgICAgIGNvbnN0IHcgPSBjb21wb25lbnRzLmZpbmQoKGMpID0+IFdfTkFNRVMuaGFzKGMpKTsKICAgICAgcmV0dXJuIHcgJiYgKEFycmF5LmlzQXJyYXkocG9pbnRzW3ddKSB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcocG9pbnRzW3ddKSkgJiYgKChpKSA9PiBwb2ludHNbd11baV0pOwogICAgfSkoKTsKICAgIGlmIChnZXRYICYmIGdldFkgJiYgZ2V0WiAmJiBnZXRXICYmIGdldEwgJiYgZ2V0TE8pIHsKICAgICAgcmVzb2x2ZSgKICAgICAgICBwb2ludHMueC5tYXAoKHgsIGkpID0+IFsKICAgICAgICAgIHgsCiAgICAgICAgICBnZXRZKGkpLAogICAgICAgICAgZ2V0WihpKSwKICAgICAgICAgIGdldFcoaSksCiAgICAgICAgICBnZXRMKGkpLAogICAgICAgICAgZ2V0TE8oaSkKICAgICAgICBdKQogICAgICApOwogICAgfSBlbHNlIGlmIChnZXRYICYmIGdldFkgJiYgZ2V0WiAmJiBnZXRXICYmIGdldEwpIHsKICAgICAgcmVzb2x2ZSgKICAgICAgICBBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIChfLCBpKSA9PiBbCiAgICAgICAgICBnZXRYKGkpLAogICAgICAgICAgZ2V0WShpKSwKICAgICAgICAgIGdldFooaSksCiAgICAgICAgICBnZXRXKGkpLAogICAgICAgICAgZ2V0TChpKQogICAgICAgIF0pCiAgICAgICk7CiAgICB9IGVsc2UgaWYgKGdldFggJiYgZ2V0WSAmJiBnZXRaICYmIGdldFcpIHsKICAgICAgcmVzb2x2ZSgKICAgICAgICBBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIChfLCBpKSA9PiBbCiAgICAgICAgICBnZXRYKGkpLAogICAgICAgICAgZ2V0WShpKSwKICAgICAgICAgIGdldFooaSksCiAgICAgICAgICBnZXRXKGkpCiAgICAgICAgXSkKICAgICAgKTsKICAgIH0gZWxzZSBpZiAoZ2V0WCAmJiBnZXRZICYmIGdldFopIHsKICAgICAgcmVzb2x2ZShBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIChfLCBpKSA9PiBbZ2V0WChpKSwgZ2V0WShpKSwgZ2V0WihpKV0pKTsKICAgIH0gZWxzZSBpZiAoZ2V0WCAmJiBnZXRZKSB7CiAgICAgIHJlc29sdmUoQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAoXywgaSkgPT4gW2dldFgoaSksIGdldFkoaSldKSk7CiAgICB9IGVsc2UgewogICAgICByZWplY3QobmV3IEVycm9yKCJZb3UgbmVlZCB0byBzcGVjaWZ5IGF0IGxlYXN0IHggYW5kIHkiKSk7CiAgICB9CiAgfQp9KTsKdmFyIGlzSG9yaXpvbnRhbExpbmUgPSAoYW5ub3RhdGlvbikgPT4gTnVtYmVyLmlzRmluaXRlKGFubm90YXRpb24ueSkgJiYgISgieCIgaW4gYW5ub3RhdGlvbik7CnZhciBpc1ZlcnRpY2FsTGluZSA9IChhbm5vdGF0aW9uKSA9PiBOdW1iZXIuaXNGaW5pdGUoYW5ub3RhdGlvbi54KSAmJiAhKCJ5IiBpbiBhbm5vdGF0aW9uKTsKdmFyIGlzRG9tUmVjdCA9IChhbm5vdGF0aW9uKSA9PiBOdW1iZXIuaXNGaW5pdGUoYW5ub3RhdGlvbi54KSAmJiBOdW1iZXIuaXNGaW5pdGUoYW5ub3RhdGlvbi55KSAmJiBOdW1iZXIuaXNGaW5pdGUoYW5ub3RhdGlvbi53aWR0aCkgJiYgTnVtYmVyLmlzRmluaXRlKGFubm90YXRpb24uaGVpZ2h0KTsKdmFyIGlzUmVjdCA9IChhbm5vdGF0aW9uKSA9PiBOdW1iZXIuaXNGaW5pdGUoYW5ub3RhdGlvbi54MSkgJiYgTnVtYmVyLmlzRmluaXRlKGFubm90YXRpb24ueTEpICYmIE51bWJlci5pc0Zpbml0ZShhbm5vdGF0aW9uLngyKSAmJiBOdW1iZXIuaXNGaW5pdGUoYW5ub3RhdGlvbi54Mik7CnZhciBpc1BvbHlnb24gPSAoYW5ub3RhdGlvbikgPT4gInZlcnRpY2VzIiBpbiBhbm5vdGF0aW9uICYmIGFubm90YXRpb24udmVydGljZXMubGVuZ3RoID4gMTsKdmFyIGluc2VydGlvblNvcnQgPSAoYXJyYXkyKSA9PiB7CiAgY29uc3QgZW5kID0gYXJyYXkyLmxlbmd0aDsKICBmb3IgKGxldCBpID0gMTsgaSA8IGVuZDsgaSsrKSB7CiAgICBjb25zdCBjdXJyZW50ID0gYXJyYXkyW2ldOwogICAgbGV0IGogPSBpIC0gMTsKICAgIHdoaWxlIChqID4gLTEgJiYgY3VycmVudCA8IGFycmF5MltqXSkgewogICAgICBhcnJheTJbaiArIDFdID0gYXJyYXkyW2pdOwogICAgICBqLS07CiAgICB9CiAgICBhcnJheTJbaiArIDFdID0gY3VycmVudDsKICB9CiAgcmV0dXJuIGFycmF5MjsKfTsKdmFyIGNyZWF0ZVJlbmRlcmVyID0gKG9wdGlvbnMgPSB7fSkgPT4gewogIGxldCB7CiAgICByZWdsLAogICAgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksCiAgICBnYW1tYTogZ2FtbWEyID0gREVGQVVMVF9HQU1NQQogIH0gPSBvcHRpb25zOwogIGxldCBpc0Rlc3Ryb3llZCA9IGZhbHNlOwogIGlmICghcmVnbCkgewogICAgcmVnbCA9IGNyZWF0ZVJlZ2woY2FudmFzKTsKICB9CiAgY29uc3QgaXNTdXBwb3J0aW5nQWxsR2xFeHRlbnNpb25zID0gY2hlY2tSZWdsRXh0ZW5zaW9ucyhyZWdsKTsKICBjb25zdCBmYm9SZXMgPSBbY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0XTsKICBjb25zdCBmYm8gPSByZWdsLmZyYW1lYnVmZmVyKHsKICAgIHdpZHRoOiBmYm9SZXNbMF0sCiAgICBoZWlnaHQ6IGZib1Jlc1sxXSwKICAgIGNvbG9yRm9ybWF0OiAicmdiYSIsCiAgICBjb2xvclR5cGU6ICJmbG9hdCIKICB9KTsKICBjb25zdCByZW5kZXJUb0NhbnZhcyA9IHJlZ2woewogICAgdmVydDogYAogICAgICBwcmVjaXNpb24gaGlnaHAgZmxvYXQ7CiAgICAgIGF0dHJpYnV0ZSB2ZWMyIHh5OwogICAgICB2b2lkIG1haW4gKCkgewogICAgICAgIGdsX1Bvc2l0aW9uID0gdmVjNCh4eSwgMCwgMSk7CiAgICAgIH1gLAogICAgZnJhZzogYAogICAgICBwcmVjaXNpb24gaGlnaHAgZmxvYXQ7CiAgICAgIHVuaWZvcm0gdmVjMiBzcmNSZXM7CiAgICAgIHVuaWZvcm0gc2FtcGxlcjJEIHNyYzsKICAgICAgdW5pZm9ybSBmbG9hdCBnYW1tYTsKCiAgICAgIHZlYzMgYXBwcm94TGluZWFyVG9TUkdCICh2ZWMzIHJnYiwgZmxvYXQgZ2FtbWEpIHsKICAgICAgICByZXR1cm4gcG93KGNsYW1wKHJnYiwgdmVjMygwKSwgdmVjMygxKSksIHZlYzMoMS4wIC8gZ2FtbWEpKTsKICAgICAgfQoKICAgICAgdm9pZCBtYWluICgpIHsKICAgICAgICB2ZWM0IGNvbG9yID0gdGV4dHVyZTJEKHNyYywgZ2xfRnJhZ0Nvb3JkLnh5IC8gc3JjUmVzKTsKICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGFwcHJveExpbmVhclRvU1JHQihjb2xvci5yZ2IsIGdhbW1hKSwgY29sb3IuYSk7CiAgICAgIH1gLAogICAgYXR0cmlidXRlczogewogICAgICB4eTogWy00LCAtNCwgNCwgLTQsIDAsIDRdCiAgICB9LAogICAgdW5pZm9ybXM6IHsKICAgICAgc3JjOiAoKSA9PiBmYm8sCiAgICAgIHNyY1JlczogKCkgPT4gZmJvUmVzLAogICAgICBnYW1tYTogKCkgPT4gZ2FtbWEyCiAgICB9LAogICAgY291bnQ6IDMsCiAgICBkZXB0aDogeyBlbmFibGU6IGZhbHNlIH0sCiAgICBibGVuZDogewogICAgICBlbmFibGU6IHRydWUsCiAgICAgIGZ1bmM6IHsKICAgICAgICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBSZWdsIGludGVybmFsCiAgICAgICAgc3JjUkdCOiAib25lIiwKICAgICAgICBzcmNBbHBoYTogIm9uZSIsCiAgICAgICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogUmVnbCBpbnRlcm5hbAogICAgICAgIGRzdFJHQjogIm9uZSBtaW51cyBzcmMgYWxwaGEiLAogICAgICAgIGRzdEFscGhhOiAib25lIG1pbnVzIHNyYyBhbHBoYSIKICAgICAgfQogICAgfQogIH0pOwogIGNvbnN0IGNvcHlUbyA9ICh0YXJnZXRDYW52YXMpID0+IHsKICAgIGNvbnN0IGN0eCA9IHRhcmdldENhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgY3R4LmNsZWFyUmVjdCgwLCAwLCB0YXJnZXRDYW52YXMud2lkdGgsIHRhcmdldENhbnZhcy5oZWlnaHQpOwogICAgY3R4LmRyYXdJbWFnZSgKICAgICAgY2FudmFzLAogICAgICAoY2FudmFzLndpZHRoIC0gdGFyZ2V0Q2FudmFzLndpZHRoKSAvIDIsCiAgICAgIChjYW52YXMuaGVpZ2h0IC0gdGFyZ2V0Q2FudmFzLmhlaWdodCkgLyAyLAogICAgICB0YXJnZXRDYW52YXMud2lkdGgsCiAgICAgIHRhcmdldENhbnZhcy5oZWlnaHQsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIHRhcmdldENhbnZhcy53aWR0aCwKICAgICAgdGFyZ2V0Q2FudmFzLmhlaWdodAogICAgKTsKICB9OwogIGNvbnN0IHJlbmRlcjIgPSAoZHJhdywgdGFyZ2V0Q2FudmFzKSA9PiB7CiAgICByZWdsLmNsZWFyKENMRUFSX09QVElPTlMpOwogICAgZmJvLnVzZSgoKSA9PiB7CiAgICAgIHJlZ2wuY2xlYXIoQ0xFQVJfT1BUSU9OUyk7CiAgICAgIGRyYXcoKTsKICAgIH0pOwogICAgcmVuZGVyVG9DYW52YXMoKTsKICAgIGNvcHlUbyh0YXJnZXRDYW52YXMpOwogIH07CiAgY29uc3QgcmVmcmVzaCA9ICgpID0+IHsKICAgIHJlZ2wucG9sbCgpOwogIH07CiAgY29uc3QgZHJhd0ZucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgY29uc3Qgb25GcmFtZSA9IChkcmF3KSA9PiB7CiAgICBkcmF3Rm5zLmFkZChkcmF3KTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRyYXdGbnMuZGVsZXRlKGRyYXcpOwogICAgfTsKICB9OwogIGNvbnN0IGZyYW1lID0gcmVnbC5mcmFtZSgoKSA9PiB7CiAgICBjb25zdCBpdGVyYXRvciA9IGRyYXdGbnMudmFsdWVzKCk7CiAgICBsZXQgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwogICAgd2hpbGUgKCFyZXN1bHQuZG9uZSkgewogICAgICByZXN1bHQudmFsdWUoKTsKICAgICAgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwogICAgfQogIH0pOwogIGNvbnN0IHJlc2l6ZTIgPSAoY3VzdG9tV2lkdGgsIGN1c3RvbUhlaWdodCkgPT4gewogICAgY29uc3Qgd2lkdGggPSBjdXN0b21XaWR0aCA9PT0gdm9pZCAwID8gTWF0aC5taW4od2luZG93LmlubmVyV2lkdGgsIHdpbmRvdy5zY3JlZW4uYXZhaWxXaWR0aCkgOiBjdXN0b21XaWR0aDsKICAgIGNvbnN0IGhlaWdodCA9IGN1c3RvbUhlaWdodCA9PT0gdm9pZCAwID8gTWF0aC5taW4od2luZG93LmlubmVySGVpZ2h0LCB3aW5kb3cuc2NyZWVuLmF2YWlsSGVpZ2h0KSA6IGN1c3RvbUhlaWdodDsKICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0ICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBmYm9SZXNbMF0gPSBjYW52YXMud2lkdGg7CiAgICBmYm9SZXNbMV0gPSBjYW52YXMuaGVpZ2h0OwogICAgZmJvLnJlc2l6ZSguLi5mYm9SZXMpOwogIH07CiAgY29uc3QgcmVzaXplSGFuZGxlciA9ICgpID0+IHsKICAgIHJlc2l6ZTIoKTsKICB9OwogIGlmICghb3B0aW9ucy5jYW52YXMpIHsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCByZXNpemVIYW5kbGVyKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJvcmllbnRhdGlvbmNoYW5nZSIsIHJlc2l6ZUhhbmRsZXIpOwogICAgcmVzaXplMigpOwogIH0KICBjb25zdCBkZXN0cm95ID0gKCkgPT4gewogICAgaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHJlc2l6ZUhhbmRsZXIpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm9yaWVudGF0aW9uY2hhbmdlIiwgcmVzaXplSGFuZGxlcik7CiAgICBmcmFtZS5jYW5jZWwoKTsKICAgIGNhbnZhcyA9IHZvaWQgMDsKICAgIHJlZ2wuZGVzdHJveSgpOwogICAgcmVnbCA9IHZvaWQgMDsKICB9OwogIHJldHVybiB7CiAgICAvKioKICAgICAqIEdldCB0aGUgYXNzb2NpYXRlZCBjYW52YXMgZWxlbWVudAogICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFRoZSBhc3NvY2lhdGVkIGNhbnZhcyBlbGVtZW50CiAgICAgKi8KICAgIGdldCBjYW52YXMoKSB7CiAgICAgIHJldHVybiBjYW52YXM7CiAgICB9LAogICAgLyoqCiAgICAgKiBHZXQgdGhlIGFzc29jaWF0ZWQgUmVnbCBpbnN0YW5jZQogICAgICogQHJldHVybiB7aW1wb3J0KCdyZWdsJykuUmVnbH0gVGhlIGFzc29jaWF0ZWQgUmVnbCBpbnN0YW5jZQogICAgICovCiAgICBnZXQgcmVnbCgpIHsKICAgICAgcmV0dXJuIHJlZ2w7CiAgICB9LAogICAgLyoqCiAgICAgKiBHZXQgdGhlIGdhbW1hIHZhbHVlCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBnYW1tYSB2YWx1ZQogICAgICovCiAgICBnZXQgZ2FtbWEoKSB7CiAgICAgIHJldHVybiBnYW1tYTI7CiAgICB9LAogICAgLyoqCiAgICAgKiBTZXQgZ2FtbWEgdG8gYSBuZXcgdmFsdWUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBuZXdHYW1tYSAtIFRoZSBuZXcgZ2FtbWEgdmFsdWUKICAgICAqLwogICAgc2V0IGdhbW1hKG5ld0dhbW1hKSB7CiAgICAgIGdhbW1hMiA9ICtuZXdHYW1tYTsKICAgIH0sCiAgICAvKioKICAgICAqIEdldCB3aGV0aGVyIHRoZSBicm93c2VyIHN1cHBvcnRzIGFsbCBuZWNlc3NhcnkgV2ViR0wgZmVhdHVyZXMKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IElmIGB0cnVlYCB0aGUgYnJvd3NlciBzdXBwb3J0cyBhbGwgbmVjZXNzYXJ5IFdlYkdMIGZlYXR1cmVzCiAgICAgKi8KICAgIGdldCBpc1N1cHBvcnRlZCgpIHsKICAgICAgcmV0dXJuIGlzU3VwcG9ydGluZ0FsbEdsRXh0ZW5zaW9uczsKICAgIH0sCiAgICAvKioKICAgICAqIEdldCB3aGV0aGVyIHRoZSByZW5kZXJlciAoYW5kIGl0cyBSZWdsIGluc3RhbmNlKSBpcyBkZXN0cm95ZWQKICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IElmIGB0cnVlYCB0aGUgcmVuZGVyZXIgaXMgZGVzdHJveWVkCiAgICAgKi8KICAgIGdldCBpc0Rlc3Ryb3llZCgpIHsKICAgICAgcmV0dXJuIGlzRGVzdHJveWVkOwogICAgfSwKICAgIHJlbmRlcjogcmVuZGVyMiwKICAgIHJlc2l6ZTogcmVzaXplMiwKICAgIG9uRnJhbWUsCiAgICByZWZyZXNoLAogICAgZGVzdHJveQogIH07Cn07CnZhciBGUkFHTUVOVF9TSEFERVIkMiA9IGAKcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7Cgp1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlOwoKdmFyeWluZyB2ZWMyIHV2OwoKdm9pZCBtYWluICgpIHsKICBnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodGV4dHVyZSwgdXYpOwp9CmA7CnZhciBWRVJURVhfU0hBREVSID0gYApwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsKCnVuaWZvcm0gbWF0NCBtb2RlbFZpZXdQcm9qZWN0aW9uOwoKYXR0cmlidXRlIHZlYzIgcG9zaXRpb247Cgp2YXJ5aW5nIHZlYzIgdXY7Cgp2b2lkIG1haW4gKCkgewogIHV2ID0gcG9zaXRpb247CiAgZ2xfUG9zaXRpb24gPSBtb2RlbFZpZXdQcm9qZWN0aW9uICogdmVjNCgtMS4wICsgMi4wICogdXYueCwgMS4wIC0gMi4wICogdXYueSwgMCwgMSk7Cn0KYDsKdmFyIEZSQUdNRU5UX1NIQURFUiQxID0gYHByZWNpc2lvbiBoaWdocCBmbG9hdDsKCnZhcnlpbmcgdmVjNCBjb2xvcjsKCnZvaWQgbWFpbigpIHsKICBnbF9GcmFnQ29sb3IgPSBjb2xvcjsKfQpgOwp2YXIgU0hBREVSJDEgPSBgcHJlY2lzaW9uIGhpZ2hwIGZsb2F0OwoKdW5pZm9ybSBzYW1wbGVyMkQgc3RhcnRTdGF0ZVRleDsKdW5pZm9ybSBzYW1wbGVyMkQgZW5kU3RhdGVUZXg7CnVuaWZvcm0gZmxvYXQgdDsKCnZhcnlpbmcgdmVjMiBwYXJ0aWNsZVRleHR1cmVJbmRleDsKCnZvaWQgbWFpbigpIHsKICAvLyBJbnRlcnBvbGF0ZSB4LCB5LCBhbmQgdmFsdWUKICB2ZWMzIHN0YXJ0ID0gdGV4dHVyZTJEKHN0YXJ0U3RhdGVUZXgsIHBhcnRpY2xlVGV4dHVyZUluZGV4KS54eXc7CiAgdmVjMyBlbmQgPSB0ZXh0dXJlMkQoZW5kU3RhdGVUZXgsIHBhcnRpY2xlVGV4dHVyZUluZGV4KS54eXc7CiAgdmVjMyBjdXJyID0gc3RhcnQgKiAoMS4wIC0gdCkgKyBlbmQgKiB0OwoKICAvLyBUaGUgY2F0ZWdvcnkgY2Fubm90IGJlIGludGVycG9sYXRlZAogIGZsb2F0IGVuZENhdGVnb3J5ID0gdGV4dHVyZTJEKGVuZFN0YXRlVGV4LCBwYXJ0aWNsZVRleHR1cmVJbmRleCkuejsKCiAgZ2xfRnJhZ0NvbG9yID0gdmVjNChjdXJyLnh5LCBlbmRDYXRlZ29yeSwgY3Vyci56KTsKfWA7CnZhciBTSEFERVIgPSBgcHJlY2lzaW9uIGhpZ2hwIGZsb2F0OwoKYXR0cmlidXRlIHZlYzIgcG9zaXRpb247CnZhcnlpbmcgdmVjMiBwYXJ0aWNsZVRleHR1cmVJbmRleDsKCnZvaWQgbWFpbigpIHsKICAvLyBtYXAgbm9ybWFsaXplZCBkZXZpY2UgY29vcmRzIHRvIHRleHR1cmUgY29vcmRzCiAgcGFydGljbGVUZXh0dXJlSW5kZXggPSAwLjUgKiAoMS4wICsgcG9zaXRpb24pOwoKICBnbF9Qb3NpdGlvbiA9IHZlYzQocG9zaXRpb24sIDAsIDEpOwp9YDsKdmFyIEZSQUdNRU5UX1NIQURFUiA9IGAKcHJlY2lzaW9uIGhpZ2hwIGZsb2F0OwoKdW5pZm9ybSBmbG9hdCBhbnRpQWxpYXNpbmc7Cgp2YXJ5aW5nIHZlYzQgY29sb3I7CnZhcnlpbmcgZmxvYXQgZmluYWxQb2ludFNpemU7CgpmbG9hdCBsaW5lYXJzdGVwKGZsb2F0IGVkZ2UwLCBmbG9hdCBlZGdlMSwgZmxvYXQgeCkgewogIHJldHVybiBjbGFtcCgoeCAtIGVkZ2UwKSAvIChlZGdlMSAtIGVkZ2UwKSwgMC4wLCAxLjApOwp9Cgp2b2lkIG1haW4oKSB7CiAgdmVjMiBjID0gZ2xfUG9pbnRDb29yZCAqIDIuMCAtIDEuMDsKICBmbG9hdCBzZGYgPSBsZW5ndGgoYykgKiBmaW5hbFBvaW50U2l6ZTsKICBmbG9hdCBhbHBoYSA9IGxpbmVhcnN0ZXAoZmluYWxQb2ludFNpemUgKyBhbnRpQWxpYXNpbmcsIGZpbmFsUG9pbnRTaXplIC0gYW50aUFsaWFzaW5nLCBzZGYpOwoKICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbG9yLnJnYiwgYWxwaGEgKiBjb2xvci5hKTsKfQpgOwp2YXIgY3JlYXRlVmVydGV4U2hhZGVyID0gKGdsb2JhbFN0YXRlKSA9PiBgCnByZWNpc2lvbiBoaWdocCBmbG9hdDsKCnVuaWZvcm0gc2FtcGxlcjJEIGNvbG9yVGV4Owp1bmlmb3JtIGZsb2F0IGNvbG9yVGV4UmVzOwp1bmlmb3JtIGZsb2F0IGNvbG9yVGV4RXBzOwp1bmlmb3JtIHNhbXBsZXIyRCBzdGF0ZVRleDsKdW5pZm9ybSBmbG9hdCBzdGF0ZVRleFJlczsKdW5pZm9ybSBmbG9hdCBzdGF0ZVRleEVwczsKdW5pZm9ybSBmbG9hdCBkZXZpY2VQaXhlbFJhdGlvOwp1bmlmb3JtIHNhbXBsZXIyRCBlbmNvZGluZ1RleDsKdW5pZm9ybSBmbG9hdCBlbmNvZGluZ1RleFJlczsKdW5pZm9ybSBmbG9hdCBlbmNvZGluZ1RleEVwczsKdW5pZm9ybSBmbG9hdCBwb2ludFNpemVFeHRyYTsKdW5pZm9ybSBmbG9hdCBwb2ludE9wYWNpdHlNYXg7CnVuaWZvcm0gZmxvYXQgcG9pbnRPcGFjaXR5U2NhbGU7CnVuaWZvcm0gZmxvYXQgbnVtUG9pbnRzOwp1bmlmb3JtIGZsb2F0IGdsb2JhbFN0YXRlOwp1bmlmb3JtIGZsb2F0IGlzQ29sb3JlZEJ5WjsKdW5pZm9ybSBmbG9hdCBpc0NvbG9yZWRCeVc7CnVuaWZvcm0gZmxvYXQgaXNPcGFjaXR5QnlaOwp1bmlmb3JtIGZsb2F0IGlzT3BhY2l0eUJ5VzsKdW5pZm9ybSBmbG9hdCBpc09wYWNpdHlCeURlbnNpdHk7CnVuaWZvcm0gZmxvYXQgaXNTaXplZEJ5WjsKdW5pZm9ybSBmbG9hdCBpc1NpemVkQnlXOwp1bmlmb3JtIGZsb2F0IGlzUGl4ZWxBbGlnbmVkOwp1bmlmb3JtIGZsb2F0IGNvbG9yTXVsdGlwbGljYXRvcjsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5TXVsdGlwbGljYXRvcjsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5RGVuc2l0eTsKdW5pZm9ybSBmbG9hdCBzaXplTXVsdGlwbGljYXRvcjsKdW5pZm9ybSBmbG9hdCBudW1Db2xvclN0YXRlczsKdW5pZm9ybSBmbG9hdCBwb2ludFNjYWxlOwp1bmlmb3JtIGZsb2F0IGRyYXdpbmdCdWZmZXJXaWR0aDsKdW5pZm9ybSBmbG9hdCBkcmF3aW5nQnVmZmVySGVpZ2h0Owp1bmlmb3JtIG1hdDQgbW9kZWxWaWV3UHJvamVjdGlvbjsKCmF0dHJpYnV0ZSB2ZWMyIHN0YXRlSW5kZXg7Cgp2YXJ5aW5nIHZlYzQgY29sb3I7CnZhcnlpbmcgZmxvYXQgZmluYWxQb2ludFNpemU7Cgp2b2lkIG1haW4oKSB7CiAgdmVjNCBzdGF0ZSA9IHRleHR1cmUyRChzdGF0ZVRleCwgc3RhdGVJbmRleCk7CgogIGlmIChpc1BpeGVsQWxpZ25lZCA8IDAuNSkgewogICAgZ2xfUG9zaXRpb24gPSBtb2RlbFZpZXdQcm9qZWN0aW9uICogdmVjNChzdGF0ZS54LCBzdGF0ZS55LCAwLjAsIDEuMCk7CiAgfSBlbHNlIHsKICAgIHZlYzQgY2xpcFNwYWNlUG9zaXRpb24gPSBtb2RlbFZpZXdQcm9qZWN0aW9uICogdmVjNChzdGF0ZS54LCBzdGF0ZS55LCAwLjAsIDEuMCk7CiAgICB2ZWMyIG5kY1Bvc2l0aW9uID0gY2xpcFNwYWNlUG9zaXRpb24ueHkgLyBjbGlwU3BhY2VQb3NpdGlvbi53OwogICAgdmVjMiBwaXhlbFBvcyA9IDAuNSAqIChuZGNQb3NpdGlvbiArIDEuMCkgKiB2ZWMyKGRyYXdpbmdCdWZmZXJXaWR0aCwgZHJhd2luZ0J1ZmZlckhlaWdodCk7CiAgICBwaXhlbFBvcyA9IGZsb29yKHBpeGVsUG9zICsgMC41KTsgLy8gU25hcCB0byBuZWFyZXN0IHBpeGVsCiAgICB2ZWMyIHNuYXBwZWRQb3NpdGlvbiA9IChwaXhlbFBvcyAvIHZlYzIoZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0KSkgKiAyLjAgLSAxLjA7CiAgICBnbF9Qb3NpdGlvbiA9IHZlYzQoc25hcHBlZFBvc2l0aW9uLCAwLjAsIDEuMCk7CiAgfQoKCiAgLy8gRGV0ZXJtaW5lIGNvbG9yIGluZGV4CiAgZmxvYXQgY29sb3JJbmRleFogPSAgaXNDb2xvcmVkQnlaICogZmxvb3Ioc3RhdGUueiAqIGNvbG9yTXVsdGlwbGljYXRvcik7CiAgZmxvYXQgY29sb3JJbmRleFcgPSAgaXNDb2xvcmVkQnlXICogZmxvb3Ioc3RhdGUudyAqIGNvbG9yTXVsdGlwbGljYXRvcik7CgogIC8vIE11bHRpcGx5IGJ5IHRoZSBudW1iZXIgb2YgY29sb3Igc3RhdGVzIHBlciBjb2xvcgogIC8vIEkuZS4sIG5vcm1hbCwgYWN0aXZlLCBob3ZlciwgYmFja2dyb3VuZCwgZXRjLgogIGZsb2F0IGNvbG9ySW5kZXggPSAoY29sb3JJbmRleFogKyBjb2xvckluZGV4VykgKiBudW1Db2xvclN0YXRlczsKCiAgLy8gSGFsZiBhICJwaXhlbCIgb3IgInRleGVsIiBpbiB0ZXh0dXJlIGNvb3JkaW5hdGVzCiAgZmxvYXQgY29sb3JMaW5lYXJJbmRleCA9IGNvbG9ySW5kZXggKyBnbG9iYWxTdGF0ZTsKCiAgLy8gTmVlZCB0byBhZGQgY0VwcyBoZXJlIHRvIGF2b2lkIGZsb2F0aW5nIHBvaW50IGlzc3VlIHRoYXQgY2FuIGxlYWQgdG8KICAvLyBkcmFtYXRpYyBjaGFuZ2VzIGluIHdoaWNoIGNvbG9yIGlzIGxvYWRlZCBhcyBmbG9vcigzLzIuOTk5OSkgPSAxIGJ1dAogIC8vIGZsb29yKDMvMy4wMDAxKSA9IDAhCiAgZmxvYXQgY29sb3JSb3dJbmRleCA9IGZsb29yKChjb2xvckxpbmVhckluZGV4ICsgY29sb3JUZXhFcHMpIC8gY29sb3JUZXhSZXMpOwoKICB2ZWMyIGNvbG9yVGV4SW5kZXggPSB2ZWMyKAogICAgKGNvbG9yTGluZWFySW5kZXggLyBjb2xvclRleFJlcykgLSBjb2xvclJvd0luZGV4ICsgY29sb3JUZXhFcHMsCiAgICBjb2xvclJvd0luZGV4IC8gY29sb3JUZXhSZXMgKyBjb2xvclRleEVwcwogICk7CgogIGNvbG9yID0gdGV4dHVyZTJEKGNvbG9yVGV4LCBjb2xvclRleEluZGV4KTsKCiAgLy8gUmV0cmlldmUgcG9pbnQgc2l6ZQogIGZsb2F0IHBvaW50U2l6ZUluZGV4WiA9IGlzU2l6ZWRCeVogKiBmbG9vcihzdGF0ZS56ICogc2l6ZU11bHRpcGxpY2F0b3IpOwogIGZsb2F0IHBvaW50U2l6ZUluZGV4VyA9IGlzU2l6ZWRCeVcgKiBmbG9vcihzdGF0ZS53ICogc2l6ZU11bHRpcGxpY2F0b3IpOwogIGZsb2F0IHBvaW50U2l6ZUluZGV4ID0gcG9pbnRTaXplSW5kZXhaICsgcG9pbnRTaXplSW5kZXhXOwoKICBmbG9hdCBwb2ludFNpemVSb3dJbmRleCA9IGZsb29yKChwb2ludFNpemVJbmRleCArIGVuY29kaW5nVGV4RXBzKSAvIGVuY29kaW5nVGV4UmVzKTsKICB2ZWMyIHBvaW50U2l6ZVRleEluZGV4ID0gdmVjMigKICAgIChwb2ludFNpemVJbmRleCAvIGVuY29kaW5nVGV4UmVzKSAtIHBvaW50U2l6ZVJvd0luZGV4ICsgZW5jb2RpbmdUZXhFcHMsCiAgICBwb2ludFNpemVSb3dJbmRleCAvIGVuY29kaW5nVGV4UmVzICsgZW5jb2RpbmdUZXhFcHMKICApOwogIGZsb2F0IHBvaW50U2l6ZSA9IHRleHR1cmUyRChlbmNvZGluZ1RleCwgcG9pbnRTaXplVGV4SW5kZXgpLng7CgogIC8vIFJldHJpZXZlIG9wYWNpdHkKICAkeygoKSA9PiB7CiAgaWYgKGdsb2JhbFN0YXRlID09PSAzKSByZXR1cm4gIiI7CiAgcmV0dXJuIGAKICAgICAgICBpZiAoaXNPcGFjaXR5QnlEZW5zaXR5IDwgMC41KSB7CiAgICAgICAgICBmbG9hdCBvcGFjaXR5SW5kZXhaID0gaXNPcGFjaXR5QnlaICogZmxvb3Ioc3RhdGUueiAqIG9wYWNpdHlNdWx0aXBsaWNhdG9yKTsKICAgICAgICAgIGZsb2F0IG9wYWNpdHlJbmRleFcgPSBpc09wYWNpdHlCeVcgKiBmbG9vcihzdGF0ZS53ICogb3BhY2l0eU11bHRpcGxpY2F0b3IpOwogICAgICAgICAgZmxvYXQgb3BhY2l0eUluZGV4ID0gb3BhY2l0eUluZGV4WiArIG9wYWNpdHlJbmRleFc7CgogICAgICAgICAgZmxvYXQgb3BhY2l0eVJvd0luZGV4ID0gZmxvb3IoKG9wYWNpdHlJbmRleCArIGVuY29kaW5nVGV4RXBzKSAvIGVuY29kaW5nVGV4UmVzKTsKICAgICAgICAgIHZlYzIgb3BhY2l0eVRleEluZGV4ID0gdmVjMigKICAgICAgICAgICAgKG9wYWNpdHlJbmRleCAvIGVuY29kaW5nVGV4UmVzKSAtIG9wYWNpdHlSb3dJbmRleCArIGVuY29kaW5nVGV4RXBzLAogICAgICAgICAgICBvcGFjaXR5Um93SW5kZXggLyBlbmNvZGluZ1RleFJlcyArIGVuY29kaW5nVGV4RXBzCiAgICAgICAgICApOwogICAgICAgICAgY29sb3IuYSA9IHRleHR1cmUyRChlbmNvZGluZ1RleCwgb3BhY2l0eVRleEluZGV4KVskezEgKyBnbG9iYWxTdGF0ZX1dOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb2xvci5hID0gbWluKDEuMCwgb3BhY2l0eURlbnNpdHkgKyBnbG9iYWxTdGF0ZSk7CiAgICAgICAgfQogICAgICBgOwp9KSgpfQoKICBjb2xvci5hID0gbWluKHBvaW50T3BhY2l0eU1heCwgY29sb3IuYSkgKiBwb2ludE9wYWNpdHlTY2FsZTsKICBmaW5hbFBvaW50U2l6ZSA9IChwb2ludFNpemUgKiBwb2ludFNjYWxlKSArIHBvaW50U2l6ZUV4dHJhOwogIGdsX1BvaW50U2l6ZSA9IGZpbmFsUG9pbnRTaXplOwp9CmA7CnZhciB3b3JrZXIgPSBmdW5jdGlvbiB3b3JrZXIyKCkgewogIGNvbnN0IGNhdG11bGxSb20gPSAodCwgcDAsIHAxLCBwMiwgcDMpID0+IHsKICAgIGNvbnN0IHYwID0gKHAyIC0gcDApICogMC41OwogICAgY29uc3QgdjEgPSAocDMgLSBwMSkgKiAwLjU7CiAgICByZXR1cm4gKDIgKiBwMSAtIDIgKiBwMiArIHYwICsgdjEpICogdCAqIHQgKiB0ICsgKC0zICogcDEgKyAzICogcDIgLSAyICogdjAgLSB2MSkgKiB0ICogdCArIHYwICogdCArIHAxOwogIH07CiAgY29uc3QgaW50ZXJwb2xhdGVQb2ludCA9ICh0LCBwb2ludHMsIG1heFBvaW50SWR4KSA9PiB7CiAgICBjb25zdCBwID0gbWF4UG9pbnRJZHggKiB0OwogICAgY29uc3QgaW50UG9pbnQgPSBNYXRoLmZsb29yKHApOwogICAgY29uc3Qgd2VpZ2h0ID0gcCAtIGludFBvaW50OwogICAgY29uc3QgcDAgPSBwb2ludHNbTWF0aC5tYXgoMCwgaW50UG9pbnQgLSAxKV07CiAgICBjb25zdCBwMSA9IHBvaW50c1tpbnRQb2ludF07CiAgICBjb25zdCBwMiA9IHBvaW50c1tNYXRoLm1pbihtYXhQb2ludElkeCwgaW50UG9pbnQgKyAxKV07CiAgICBjb25zdCBwMyA9IHBvaW50c1tNYXRoLm1pbihtYXhQb2ludElkeCwgaW50UG9pbnQgKyAyKV07CiAgICByZXR1cm4gWwogICAgICBjYXRtdWxsUm9tKHdlaWdodCwgcDBbMF0sIHAxWzBdLCBwMlswXSwgcDNbMF0pLAogICAgICBjYXRtdWxsUm9tKHdlaWdodCwgcDBbMV0sIHAxWzFdLCBwMlsxXSwgcDNbMV0pCiAgICBdOwogIH07CiAgY29uc3Qgc3FEaXN0ID0gKHgxLCB5MSwgeDIsIHkyKSA9PiAoeDEgLSB4MikgKiogMiArICh5MSAtIHkyKSAqKiAyOwogIGNvbnN0IHNxU2VnRGlzdCA9IChwLCBwMSwgcDIpID0+IHsKICAgIGxldCB4ID0gcDFbMF07CiAgICBsZXQgeSA9IHAxWzFdOwogICAgbGV0IGR4ID0gcDJbMF0gLSB4OwogICAgbGV0IGR5ID0gcDJbMV0gLSB5OwogICAgaWYgKGR4ICE9PSAwIHx8IGR5ICE9PSAwKSB7CiAgICAgIGNvbnN0IHQgPSAoKHBbMF0gLSB4KSAqIGR4ICsgKHBbMV0gLSB5KSAqIGR5KSAvIChkeCAqIGR4ICsgZHkgKiBkeSk7CiAgICAgIGlmICh0ID4gMSkgewogICAgICAgIHggPSBwMlswXTsKICAgICAgICB5ID0gcDJbMV07CiAgICAgIH0gZWxzZSBpZiAodCA+IDApIHsKICAgICAgICB4ICs9IGR4ICogdDsKICAgICAgICB5ICs9IGR5ICogdDsKICAgICAgfQogICAgfQogICAgZHggPSBwWzBdIC0geDsKICAgIGR5ID0gcFsxXSAtIHk7CiAgICByZXR1cm4gZHggKiBkeCArIGR5ICogZHk7CiAgfTsKICBjb25zdCBzaW1wbGlmeURQU3RlcCA9IChwb2ludHMsIGZpcnN0LCBsYXN0LCB0b2xlcmFuY2UsIHNpbXBsaWZpZWQpID0+IHsKICAgIGxldCBtYXhEaXN0ID0gdG9sZXJhbmNlOwogICAgbGV0IGluZGV4OwogICAgZm9yIChsZXQgaSA9IGZpcnN0ICsgMTsgaSA8IGxhc3Q7IGkrKykgewogICAgICBjb25zdCBkaXN0MiA9IHNxU2VnRGlzdChwb2ludHNbaV0sIHBvaW50c1tmaXJzdF0sIHBvaW50c1tsYXN0XSk7CiAgICAgIGlmIChkaXN0MiA+IG1heERpc3QpIHsKICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgbWF4RGlzdCA9IGRpc3QyOwogICAgICB9CiAgICB9CiAgICBpZiAobWF4RGlzdCA+IHRvbGVyYW5jZSkgewogICAgICBpZiAoaW5kZXggLSBmaXJzdCA+IDEpIHsKICAgICAgICBzaW1wbGlmeURQU3RlcChwb2ludHMsIGZpcnN0LCBpbmRleCwgdG9sZXJhbmNlLCBzaW1wbGlmaWVkKTsKICAgICAgfQogICAgICBzaW1wbGlmaWVkLnB1c2gocG9pbnRzW2luZGV4XSk7CiAgICAgIGlmIChsYXN0IC0gaW5kZXggPiAxKSB7CiAgICAgICAgc2ltcGxpZnlEUFN0ZXAocG9pbnRzLCBpbmRleCwgbGFzdCwgdG9sZXJhbmNlLCBzaW1wbGlmaWVkKTsKICAgICAgfQogICAgfQogIH07CiAgY29uc3Qgc2ltcGxpZnlEb3VnbGFzUGV1Y2tlciA9IChwb2ludHMsIHRvbGVyYW5jZSkgPT4gewogICAgY29uc3QgbGFzdCA9IHBvaW50cy5sZW5ndGggLSAxOwogICAgY29uc3Qgc2ltcGxpZmllZCA9IFtwb2ludHNbMF1dOwogICAgc2ltcGxpZnlEUFN0ZXAocG9pbnRzLCAwLCBsYXN0LCB0b2xlcmFuY2UsIHNpbXBsaWZpZWQpOwogICAgc2ltcGxpZmllZC5wdXNoKHBvaW50c1tsYXN0XSk7CiAgICByZXR1cm4gc2ltcGxpZmllZDsKICB9OwogIGNvbnN0IGludGVycG9sYXRlUG9pbnRzID0gKHBvaW50cywgeyBtYXhJbnRQb2ludHNQZXJTZWdtZW50ID0gMTAwLCB0b2xlcmFuY2UgPSAyZS0zIH0gPSB7fSkgPT4gewogICAgY29uc3QgbnVtUG9pbnRzID0gcG9pbnRzLmxlbmd0aDsKICAgIGNvbnN0IG1heFBvaW50SWR4ID0gbnVtUG9pbnRzIC0gMTsKICAgIGNvbnN0IG1heE91dFBvaW50cyA9IG1heFBvaW50SWR4ICogbWF4SW50UG9pbnRzUGVyU2VnbWVudCArIDE7CiAgICBjb25zdCBzcVRvbGVyYW5jZSA9IHRvbGVyYW5jZSAqKiAyOwogICAgbGV0IG91dFBvaW50cyA9IFtdOwogICAgbGV0IHByZXZQb2ludDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtUG9pbnRzIC0gMTsgaSsrKSB7CiAgICAgIGxldCBzZWdtZW50UG9pbnRzID0gW3BvaW50c1tpXS5zbGljZSgwLCAyKV07CiAgICAgIHByZXZQb2ludCA9IHBvaW50c1tpXTsKICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBtYXhJbnRQb2ludHNQZXJTZWdtZW50OyBqKyspIHsKICAgICAgICBjb25zdCB0ID0gKGkgKiBtYXhJbnRQb2ludHNQZXJTZWdtZW50ICsgaikgLyBtYXhPdXRQb2ludHM7CiAgICAgICAgY29uc3QgaW50UG9pbnQgPSBpbnRlcnBvbGF0ZVBvaW50KHQsIHBvaW50cywgbWF4UG9pbnRJZHgpOwogICAgICAgIGlmIChzcURpc3QocHJldlBvaW50WzBdLCBwcmV2UG9pbnRbMV0sIGludFBvaW50WzBdLCBpbnRQb2ludFsxXSkgPiBzcVRvbGVyYW5jZSkgewogICAgICAgICAgc2VnbWVudFBvaW50cy5wdXNoKGludFBvaW50KTsKICAgICAgICAgIHByZXZQb2ludCA9IGludFBvaW50OwogICAgICAgIH0KICAgICAgfQogICAgICBzZWdtZW50UG9pbnRzLnB1c2gocG9pbnRzW2kgKyAxXSk7CiAgICAgIHNlZ21lbnRQb2ludHMgPSBzaW1wbGlmeURvdWdsYXNQZXVja2VyKHNlZ21lbnRQb2ludHMsIHNxVG9sZXJhbmNlKTsKICAgICAgb3V0UG9pbnRzID0gb3V0UG9pbnRzLmNvbmNhdCgKICAgICAgICBzZWdtZW50UG9pbnRzLnNsaWNlKDAsIHNlZ21lbnRQb2ludHMubGVuZ3RoIC0gMSkKICAgICAgKTsKICAgIH0KICAgIG91dFBvaW50cy5wdXNoKHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0uc2xpY2UoMCwgMikpOwogICAgcmV0dXJuIG91dFBvaW50cy5mbGF0KCk7CiAgfTsKICBjb25zdCBncm91cFBvaW50cyA9IChwb2ludHMpID0+IHsKICAgIGNvbnN0IGdyb3VwZWRQb2ludHMgPSB7fTsKICAgIGNvbnN0IGlzT3JkZXJlZCA9ICFOdW1iZXIuaXNOYU4oK3BvaW50c1swXVs1XSk7CiAgICBwb2ludHMuZm9yRWFjaCgocG9pbnQpID0+IHsKICAgICAgY29uc3Qgc2VnSWQgPSBwb2ludFs0XTsKICAgICAgaWYgKCFncm91cGVkUG9pbnRzW3NlZ0lkXSkgewogICAgICAgIGdyb3VwZWRQb2ludHNbc2VnSWRdID0gW107CiAgICAgIH0KICAgICAgaWYgKGlzT3JkZXJlZCkgewogICAgICAgIGdyb3VwZWRQb2ludHNbc2VnSWRdW3BvaW50WzVdXSA9IHBvaW50OwogICAgICB9IGVsc2UgewogICAgICAgIGdyb3VwZWRQb2ludHNbc2VnSWRdLnB1c2gocG9pbnQpOwogICAgICB9CiAgICB9KTsKICAgIE9iamVjdC5lbnRyaWVzKGdyb3VwZWRQb2ludHMpLmZvckVhY2goKGlkUG9pbnRzKSA9PiB7CiAgICAgIGdyb3VwZWRQb2ludHNbaWRQb2ludHNbMF1dID0gaWRQb2ludHNbMV0uZmlsdGVyKCh2KSA9PiB2KTsKICAgICAgZ3JvdXBlZFBvaW50c1tpZFBvaW50c1swXV0ucmVmZXJlbmNlID0gaWRQb2ludHNbMV1bMF07CiAgICB9KTsKICAgIHJldHVybiBncm91cGVkUG9pbnRzOwogIH07CiAgc2VsZi5vbm1lc3NhZ2UgPSBmdW5jdGlvbiBvbm1lc3NhZ2UoZXZlbnQpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGV2ZW50LmRhdGEucG9pbnRzID8gK2V2ZW50LmRhdGEucG9pbnRzLmxlbmd0aCA6IDA7CiAgICBpZiAoIW51bVBvaW50cykgewogICAgICBzZWxmLnBvc3RNZXNzYWdlKHsgZXJyb3I6IG5ldyBFcnJvcigiTm8gcG9pbnRzIHByb3ZpZGVkIikgfSk7CiAgICB9CiAgICBldmVudC5kYXRhLnBvaW50czsKICAgIGNvbnN0IGdyb3VwZWRQb2ludHMgPSBncm91cFBvaW50cyhldmVudC5kYXRhLnBvaW50cyk7CiAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgcG9pbnRzOiBPYmplY3QuZW50cmllcyhncm91cGVkUG9pbnRzKS5yZWR1Y2UoCiAgICAgICAgKGN1cnZlUG9pbnRzLCBpZEFuZFBvaW50cykgPT4gewogICAgICAgICAgY3VydmVQb2ludHNbaWRBbmRQb2ludHNbMF1dID0gaW50ZXJwb2xhdGVQb2ludHMoCiAgICAgICAgICAgIGlkQW5kUG9pbnRzWzFdLAogICAgICAgICAgICBldmVudC5kYXRhLm9wdGlvbnMKICAgICAgICAgICk7CiAgICAgICAgICBjdXJ2ZVBvaW50c1tpZEFuZFBvaW50c1swXV0ucmVmZXJlbmNlID0gaWRBbmRQb2ludHNbMV0ucmVmZXJlbmNlOwogICAgICAgICAgcmV0dXJuIGN1cnZlUG9pbnRzOwogICAgICAgIH0sCiAgICAgICAge30KICAgICAgKQogICAgfSk7CiAgfTsKfTsKdmFyIGNyZWF0ZVNwbGluZUN1cnZlID0gKHBvaW50cywgb3B0aW9ucyA9IHsgdG9sZXJhbmNlOiAyZS0zLCBtYXhJbnRQb2ludHNQZXJTZWdtZW50OiAxMDAgfSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogIGNvbnN0IHdvcmtlciQxID0gY3JlYXRlV29ya2VyJDEod29ya2VyKTsKICB3b3JrZXIkMS5vbm1lc3NhZ2UgPSAoZSkgPT4gewogICAgaWYgKGUuZGF0YS5lcnJvcikgewogICAgICByZWplY3QoZS5kYXRhLmVycm9yKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc29sdmUoZS5kYXRhLnBvaW50cyk7CiAgICB9CiAgICB3b3JrZXIkMS50ZXJtaW5hdGUoKTsKICB9OwogIHdvcmtlciQxLnBvc3RNZXNzYWdlKHsgcG9pbnRzLCBvcHRpb25zIH0pOwp9KTsKdmFyIHZlcnNpb24gPSAiMS4xNC4xIjsKdmFyIGRlcHJlY2F0aW9ucyA9IHsKICBzaG93UmVjdGljbGU6IHsKICAgIHJlcGxhY2VtZW50OiAic2hvd1JldGljbGUiLAogICAgcmVtb3ZhbFZlcnNpb246ICIyIiwKICAgIHRyYW5zbGF0aW9uOiBpZGVudGl0eQogIH0sCiAgcmVjdGljbGVDb2xvcjogewogICAgcmVwbGFjZW1lbnQ6ICJyZXRpY2xlQ29sb3IiLAogICAgcmVtb3ZhbFZlcnNpb246ICIyIiwKICAgIHRyYW5zbGF0aW9uOiBpZGVudGl0eQogIH0sCiAga2V5TWFwOiB7CiAgICByZXBsYWNlbWVudDogImFjdGlvbktleU1hcCIsCiAgICByZW1vdmFsVmVyc2lvbjogIjIiLAogICAgdHJhbnNsYXRpb246IGZsaXBPYmoKICB9Cn07CnZhciBjaGVja0RlcHJlY2F0aW9ucyA9IChwcm9wZXJ0aWVzMikgPT4gewogIGNvbnN0IGRlcHJlY2F0ZWRQcm9wcyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMyKS5maWx0ZXIoCiAgICAocHJvcCkgPT4gZGVwcmVjYXRpb25zW3Byb3BdCiAgKTsKICBmb3IgKGNvbnN0IHByb3Agb2YgZGVwcmVjYXRlZFByb3BzKSB7CiAgICBjb25zdCB7IHJlcGxhY2VtZW50LCByZW1vdmFsVmVyc2lvbiwgdHJhbnNsYXRpb24gfSA9IGRlcHJlY2F0aW9uc1twcm9wXTsKICAgIGNvbnNvbGUud2FybigKICAgICAgYHJlZ2wtc2NhdHRlcnBsb3Q6IHRoZSAiJHtwcm9wfSIgcHJvcGVydHkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHYke3JlbW92YWxWZXJzaW9ufS4gUGxlYXNlIHVzZSAiJHtyZXBsYWNlbWVudH0iIGluc3RlYWQuYAogICAgKTsKICAgIHByb3BlcnRpZXMyW2RlcHJlY2F0aW9uc1twcm9wXS5yZXBsYWNlbWVudF0gPSBwcm9wZXJ0aWVzMltwcm9wXSAhPT0gU0tJUF9ERVBSRUNBVElPTl9WQUxVRV9UUkFOU0xBVElPTiA/IHRyYW5zbGF0aW9uKHByb3BlcnRpZXMyW3Byb3BdKSA6IHByb3BlcnRpZXMyW3Byb3BdOwogICAgZGVsZXRlIHByb3BlcnRpZXMyW3Byb3BdOwogIH0KICByZXR1cm4gcHJvcGVydGllczI7Cn07CnZhciBnZXRFbmNvZGluZ1R5cGUgPSAodHlwZSwgZGVmYXVsdFZhbHVlLCB7IGFsbG93U2VnbWVudCA9IGZhbHNlLCBhbGxvd0RlbnNpdHkgPSBmYWxzZSwgYWxsb3dJbmhlcml0ID0gZmFsc2UgfSA9IHt9KSA9PiB7CiAgaWYgKFpfTkFNRVMuaGFzKHR5cGUpKSB7CiAgICByZXR1cm4gInZhbHVlWiI7CiAgfQogIGlmIChXX05BTUVTLmhhcyh0eXBlKSkgewogICAgcmV0dXJuICJ2YWx1ZVciOwogIH0KICBpZiAodHlwZSA9PT0gInNlZ21lbnQiKSB7CiAgICByZXR1cm4gYWxsb3dTZWdtZW50ID8gInNlZ21lbnQiIDogZGVmYXVsdFZhbHVlOwogIH0KICBpZiAodHlwZSA9PT0gImRlbnNpdHkiKSB7CiAgICByZXR1cm4gYWxsb3dEZW5zaXR5ID8gImRlbnNpdHkiIDogZGVmYXVsdFZhbHVlOwogIH0KICBpZiAodHlwZSA9PT0gImluaGVyaXQiKSB7CiAgICByZXR1cm4gYWxsb3dJbmhlcml0ID8gImluaGVyaXQiIDogZGVmYXVsdFZhbHVlOwogIH0KICByZXR1cm4gZGVmYXVsdFZhbHVlOwp9Owp2YXIgZ2V0RW5jb2RpbmdJZHggPSAodHlwZSkgPT4gewogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSAidmFsdWVaIjoKICAgICAgcmV0dXJuIDI7CiAgICBjYXNlICJ2YWx1ZVciOgogICAgICByZXR1cm4gMzsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBudWxsOwogIH0KfTsKdmFyIGNyZWF0ZVNjYXR0ZXJwbG90ID0gKGluaXRpYWxQcm9wZXJ0aWVzID0ge30pID0+IHsKICBjb25zdCBwdWJTdWIgPSBkaXN0X2RlZmF1bHQoewogICAgYXN5bmM6ICFpbml0aWFsUHJvcGVydGllcy5zeW5jRXZlbnRzLAogICAgY2FzZUluc2Vuc2l0aXZlOiB0cnVlCiAgfSk7CiAgY29uc3Qgc2NyYXRjaCA9IG5ldyBGbG9hdDMyQXJyYXkoMTYpOwogIGNvbnN0IHB2bSA9IG5ldyBGbG9hdDMyQXJyYXkoMTYpOwogIGNvbnN0IG1vdXNlUG9zaXRpb24gPSBbMCwgMF07CiAgY2hlY2tEZXByZWNhdGlvbnMoaW5pdGlhbFByb3BlcnRpZXMpOwogIGxldCB7CiAgICByZW5kZXJlciwKICAgIGFudGlBbGlhc2luZyA9IERFRkFVTFRfQU5USV9BTElBU0lORywKICAgIHBpeGVsQWxpZ25lZCA9IERFRkFVTFRfUElYRUxfQUxJR05FRCwKICAgIGJhY2tncm91bmRDb2xvciA9IERFRkFVTFRfQ09MT1JfQkcsCiAgICBiYWNrZ3JvdW5kSW1hZ2UgPSBERUZBVUxUX0JBQ0tHUk9VTkRfSU1BR0UsCiAgICBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICAgIGNvbG9yQnkgPSBERUZBVUxUX0NPTE9SX0JZLAogICAgZGVzZWxlY3RPbkRibENsaWNrID0gREVGQVVMVF9ERVNFTEVDVF9PTl9EQkxfQ0xJQ0ssCiAgICBkZXNlbGVjdE9uRXNjYXBlID0gREVGQVVMVF9ERVNFTEVDVF9PTl9FU0NBUEUsCiAgICBsYXNzb0NvbG9yID0gREVGQVVMVF9MQVNTT19DT0xPUiwKICAgIGxhc3NvTGluZVdpZHRoID0gREVGQVVMVF9MQVNTT19MSU5FX1dJRFRILAogICAgbGFzc29NaW5EZWxheSA9IERFRkFVTFRfTEFTU09fTUlOX0RFTEFZLAogICAgbGFzc29NaW5EaXN0ID0gREVGQVVMVF9MQVNTT19NSU5fRElTVCwKICAgIGxhc3NvQ2xlYXJFdmVudCA9IERFRkFVTFRfTEFTU09fQ0xFQVJfRVZFTlQsCiAgICBsYXNzb0luaXRpYXRvciA9IERFRkFVTFRfTEFTU09fSU5JVElBVE9SLAogICAgbGFzc29Jbml0aWF0b3JQYXJlbnRFbGVtZW50ID0gZG9jdW1lbnQuYm9keSwKICAgIGxhc3NvTG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudCA9IGRvY3VtZW50LmJvZHksCiAgICBsYXNzb09uTG9uZ1ByZXNzID0gREVGQVVMVF9MQVNTT19PTl9MT05HX1BSRVNTLAogICAgbGFzc29Mb25nUHJlc3NUaW1lID0gREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX1RJTUUsCiAgICBsYXNzb0xvbmdQcmVzc0FmdGVyRWZmZWN0VGltZSA9IERFRkFVTFRfTEFTU09fTE9OR19QUkVTU19BRlRFUl9FRkZFQ1RfVElNRSwKICAgIGxhc3NvTG9uZ1ByZXNzRWZmZWN0RGVsYXkgPSBERUZBVUxUX0xBU1NPX0xPTkdfUFJFU1NfRUZGRUNUX0RFTEFZLAogICAgbGFzc29Mb25nUHJlc3NSZXZlcnRFZmZlY3RUaW1lID0gREVGQVVMVF9MQVNTT19MT05HX1BSRVNTX1JFVkVSVF9FRkZFQ1RfVElNRSwKICAgIGxhc3NvVHlwZSA9IERFRkFVTFRfTEFTU09fVFlQRSwKICAgIGxhc3NvQnJ1c2hTaXplID0gREVGQVVMVF9MQVNTT19CUlVTSF9TSVpFLAogICAgYWN0aW9uS2V5TWFwID0gREVGQVVMVF9BQ1RJT05fS0VZX01BUCwKICAgIG1vdXNlTW9kZSA9IERFRkFVTFRfTU9VU0VfTU9ERSwKICAgIHNob3dSZXRpY2xlID0gREVGQVVMVF9TSE9XX1JFVElDTEUsCiAgICByZXRpY2xlQ29sb3IgPSBERUZBVUxUX1JFVElDTEVfQ09MT1IsCiAgICBwb2ludENvbG9yID0gREVGQVVMVF9DT0xPUl9OT1JNQUwsCiAgICBwb2ludENvbG9yQWN0aXZlID0gREVGQVVMVF9DT0xPUl9BQ1RJVkUsCiAgICBwb2ludENvbG9ySG92ZXIgPSBERUZBVUxUX0NPTE9SX0hPVkVSLAogICAgc2hvd1BvaW50Q29ubmVjdGlvbnMgPSBERUZBVUxUX1NIT1dfUE9JTlRfQ09OTkVDVElPTlMsCiAgICBwb2ludENvbm5lY3Rpb25Db2xvciA9IERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9DT0xPUl9OT1JNQUwsCiAgICBwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZSA9IERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9DT0xPUl9BQ1RJVkUsCiAgICBwb2ludENvbm5lY3Rpb25Db2xvckhvdmVyID0gREVGQVVMVF9QT0lOVF9DT05ORUNUSU9OX0NPTE9SX0hPVkVSLAogICAgcG9pbnRDb25uZWN0aW9uQ29sb3JCeSA9IERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9DT0xPUl9CWSwKICAgIHBvaW50Q29ubmVjdGlvbk9wYWNpdHkgPSBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fT1BBQ0lUWSwKICAgIHBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeSA9IERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9PUEFDSVRZX0JZLAogICAgcG9pbnRDb25uZWN0aW9uT3BhY2l0eUFjdGl2ZSA9IERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9PUEFDSVRZX0FDVElWRSwKICAgIHBvaW50Q29ubmVjdGlvblNpemUgPSBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fU0laRSwKICAgIHBvaW50Q29ubmVjdGlvblNpemVBY3RpdmUgPSBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fU0laRV9BQ1RJVkUsCiAgICBwb2ludENvbm5lY3Rpb25TaXplQnkgPSBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fU0laRV9CWSwKICAgIHBvaW50Q29ubmVjdGlvbk1heEludFBvaW50c1BlclNlZ21lbnQgPSBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fTUFYX0lOVF9QT0lOVFNfUEVSX1NFR01FTlQsCiAgICBwb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UgPSBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fSU5UX1BPSU5UU19UT0xFUkFOQ0UsCiAgICBwb2ludFNpemUgPSBERUZBVUxUX1BPSU5UX1NJWkUsCiAgICBwb2ludFNpemVTZWxlY3RlZCA9IERFRkFVTFRfUE9JTlRfU0laRV9TRUxFQ1RFRCwKICAgIHBvaW50U2l6ZU1vdXNlRGV0ZWN0aW9uID0gREVGQVVMVF9QT0lOVF9TSVpFX01PVVNFX0RFVEVDVElPTiwKICAgIHBvaW50T3V0bGluZVdpZHRoID0gREVGQVVMVF9QT0lOVF9PVVRMSU5FX1dJRFRILAogICAgb3BhY2l0eSA9IEFVVE8sCiAgICBvcGFjaXR5QnkgPSBERUZBVUxUX09QQUNJVFlfQlksCiAgICBvcGFjaXR5QnlEZW5zaXR5RmlsbCA9IERFRkFVTFRfT1BBQ0lUWV9CWV9ERU5TSVRZX0ZJTEwsCiAgICBvcGFjaXR5SW5hY3RpdmVNYXggPSBERUZBVUxUX09QQUNJVFlfSU5BQ1RJVkVfTUFYLAogICAgb3BhY2l0eUluYWN0aXZlU2NhbGUgPSBERUZBVUxUX09QQUNJVFlfSU5BQ1RJVkVfU0NBTEUsCiAgICBzaXplQnkgPSBERUZBVUxUX1NJWkVfQlksCiAgICBwb2ludFNjYWxlTW9kZSA9IERFRkFVTFRfUE9JTlRfU0NBTEVfTU9ERSwKICAgIGhlaWdodCA9IERFRkFVTFRfSEVJR0hULAogICAgd2lkdGggPSBERUZBVUxUX1dJRFRILAogICAgYW5ub3RhdGlvbkxpbmVDb2xvciA9IERFRkFVTFRfQU5OT1RBVElPTl9MSU5FX0NPTE9SLAogICAgYW5ub3RhdGlvbkxpbmVXaWR0aCA9IERFRkFVTFRfQU5OT1RBVElPTl9MSU5FX1dJRFRILAogICAgYW5ub3RhdGlvbkhWTGluZUxpbWl0ID0gREVGQVVMVF9BTk5PVEFUSU9OX0hWTElORV9MSU1JVCwKICAgIGNhbWVyYUlzRml4ZWQgPSBERUZBVUxUX0NBTUVSQV9JU19GSVhFRAogIH0gPSBpbml0aWFsUHJvcGVydGllczsKICBsZXQgY3VycmVudFdpZHRoID0gd2lkdGggPT09IEFVVE8gPyAxIDogd2lkdGg7CiAgbGV0IGN1cnJlbnRIZWlnaHQgPSBoZWlnaHQgPT09IEFVVE8gPyAxIDogaGVpZ2h0OwogIGNvbnN0IHsKICAgIHBlcmZvcm1hbmNlTW9kZSA9IERFRkFVTFRfUEVSRk9STUFOQ0VfTU9ERSwKICAgIG9wYWNpdHlCeURlbnNpdHlEZWJvdW5jZVRpbWUgPSBERUZBVUxUX09QQUNJVFlfQllfREVOU0lUWV9ERUJPVU5DRV9USU1FLAogICAgc3BhdGlhbEluZGV4VXNlV29ya2VyID0gREVGQVVMVF9TUEFUSUFMX0lOREVYX1VTRV9XT1JLRVIKICB9ID0gaW5pdGlhbFByb3BlcnRpZXM7CiAgY29uc3QgcmVuZGVyUG9pbnRzQXNTcXVhcmVzID0gQm9vbGVhbigKICAgIGluaXRpYWxQcm9wZXJ0aWVzLnJlbmRlclBvaW50c0FzU3F1YXJlcyB8fCBwZXJmb3JtYW5jZU1vZGUKICApOwogIGNvbnN0IGRpc2FibGVBbHBoYUJsZW5kaW5nID0gQm9vbGVhbigKICAgIGluaXRpYWxQcm9wZXJ0aWVzLmRpc2FibGVBbHBoYUJsZW5kaW5nIHx8IHBlcmZvcm1hbmNlTW9kZQogICk7CiAgbW91c2VNb2RlID0gbGltaXQoTU9VU0VfTU9ERVMsIE1PVVNFX01PREVfUEFOWk9PTSkobW91c2VNb2RlKTsKICBpZiAoIXJlbmRlcmVyKSB7CiAgICByZW5kZXJlciA9IGNyZWF0ZVJlbmRlcmVyKHsKICAgICAgcmVnbDogaW5pdGlhbFByb3BlcnRpZXMucmVnbCwKICAgICAgZ2FtbWE6IGluaXRpYWxQcm9wZXJ0aWVzLmdhbW1hCiAgICB9KTsKICB9CiAgYmFja2dyb3VuZENvbG9yID0gdG9SZ2JhKGJhY2tncm91bmRDb2xvciwgdHJ1ZSk7CiAgbGFzc29Db2xvciA9IHRvUmdiYShsYXNzb0NvbG9yLCB0cnVlKTsKICByZXRpY2xlQ29sb3IgPSB0b1JnYmEocmV0aWNsZUNvbG9yLCB0cnVlKTsKICBsZXQgaXNEcmF3aW5nID0gZmFsc2U7CiAgbGV0IGlzRGVzdHJveWVkID0gZmFsc2U7CiAgbGV0IGJhY2tncm91bmRDb2xvckJyaWdodG5lc3MgPSByZ2JCcmlnaHRuZXNzKGJhY2tncm91bmRDb2xvcik7CiAgbGV0IGNhbWVyYTsKICBsZXQgbGFzc287CiAgbGV0IGFubm90YXRpb25zOwogIGxldCBtb3VzZURvd24gPSBmYWxzZTsKICBsZXQgbW91c2VEb3duVGltZSA9IG51bGw7CiAgbGV0IG1vdXNlRG93blBvc2l0aW9uID0gWzAsIDBdOwogIGxldCBtb3VzZURvd25UaW1lb3V0ID0gLTE7CiAgbGV0IHNlbGVjdGVkUG9pbnRzID0gW107CiAgY29uc3Qgc2VsZWN0ZWRQb2ludHNTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogIGNvbnN0IHNlbGVjdGVkUG9pbnRzQ29ubmVjdGlvblNldCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgbGV0IGlzUG9pbnRzRmlsdGVyZWQgPSBmYWxzZTsKICBjb25zdCBmaWx0ZXJlZFBvaW50c1NldCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgbGV0IHBvaW50cyA9IFtdOwogIGxldCBudW1Qb2ludHMgPSAwOwogIGxldCBudW1Qb2ludHNJblZpZXcgPSAwOwogIGxldCBsYXNzb0FjdGl2ZSA9IGZhbHNlOwogIGxldCBsYXNzb1BvaW50c0N1cnIgPSBbXTsKICBsZXQgc3BhdGlhbEluZGV4OwogIGxldCB2aWV3QXNwZWN0UmF0aW87CiAgbGV0IGRhdGFBc3BlY3RSYXRpbyA9IGluaXRpYWxQcm9wZXJ0aWVzLmFzcGVjdFJhdGlvIHx8IERFRkFVTFRfREFUQV9BU1BFQ1RfUkFUSU87CiAgbGV0IHByb2plY3Rpb25Mb2NhbDsKICBsZXQgcHJvamVjdGlvbjsKICBsZXQgbW9kZWw7CiAgbGV0IHBvaW50Q29ubmVjdGlvbnM7CiAgbGV0IHBvaW50Q29ubmVjdGlvbk1hcDsKICBsZXQgY29tcHV0aW5nUG9pbnRDb25uZWN0aW9uQ3VydmVzOwogIGxldCByZXRpY2xlSExpbmU7CiAgbGV0IHJldGljbGVWTGluZTsKICBsZXQgY29tcHV0ZWRQb2ludFNpemVNb3VzZURldGVjdGlvbjsKICBsZXQgbGFzc29Jbml0aWF0b3JUaW1lb3V0OwogIGxldCB0b3BSaWdodE5kYzsKICBsZXQgYm90dG9tTGVmdE5kYzsKICBsZXQgcHJldmVudEV2ZW50VmlldyA9IGZhbHNlOwogIGxldCBkcmF3ID0gdHJ1ZTsKICBsZXQgZHJhd1JldGljbGVPbmNlID0gZmFsc2U7CiAgbGV0IGNhbnZhc09ic2VydmVyOwogIHBvaW50Q29sb3IgPSBpc011bHRpcGxlQ29sb3JzKHBvaW50Q29sb3IpID8gWy4uLnBvaW50Q29sb3JdIDogW3BvaW50Q29sb3JdOwogIHBvaW50Q29sb3JBY3RpdmUgPSBpc011bHRpcGxlQ29sb3JzKHBvaW50Q29sb3JBY3RpdmUpID8gWy4uLnBvaW50Q29sb3JBY3RpdmVdIDogW3BvaW50Q29sb3JBY3RpdmVdOwogIHBvaW50Q29sb3JIb3ZlciA9IGlzTXVsdGlwbGVDb2xvcnMocG9pbnRDb2xvckhvdmVyKSA/IFsuLi5wb2ludENvbG9ySG92ZXJdIDogW3BvaW50Q29sb3JIb3Zlcl07CiAgcG9pbnRDb2xvciA9IHBvaW50Q29sb3IubWFwKChjb2xvcjIpID0+IHRvUmdiYShjb2xvcjIsIHRydWUpKTsKICBwb2ludENvbG9yQWN0aXZlID0gcG9pbnRDb2xvckFjdGl2ZS5tYXAoKGNvbG9yMikgPT4gdG9SZ2JhKGNvbG9yMiwgdHJ1ZSkpOwogIHBvaW50Q29sb3JIb3ZlciA9IHBvaW50Q29sb3JIb3Zlci5tYXAoKGNvbG9yMikgPT4gdG9SZ2JhKGNvbG9yMiwgdHJ1ZSkpOwogIG9wYWNpdHkgPSAhQXJyYXkuaXNBcnJheShvcGFjaXR5KSAmJiBOdW1iZXIuaXNOYU4oK29wYWNpdHkpID8gcG9pbnRDb2xvclswXVszXSA6IG9wYWNpdHk7CiAgb3BhY2l0eSA9IGlzQ29uZGl0aW9uYWxBcnJheShvcGFjaXR5LCBpc1Bvc2l0aXZlTnVtYmVyLCB7CiAgICBtaW5MZW5ndGg6IDEKICB9KSA/IFsuLi5vcGFjaXR5XSA6IFtvcGFjaXR5XTsKICBwb2ludFNpemUgPSBpc0NvbmRpdGlvbmFsQXJyYXkocG9pbnRTaXplLCBpc1Bvc2l0aXZlTnVtYmVyLCB7CiAgICBtaW5MZW5ndGg6IDEKICB9KSA/IFsuLi5wb2ludFNpemVdIDogW3BvaW50U2l6ZV07CiAgbGV0IG1pblBvaW50U2NhbGUgPSBNSU5fUE9JTlRfU0laRSAvIHBvaW50U2l6ZVswXTsKICBpZiAocG9pbnRDb25uZWN0aW9uQ29sb3IgPT09ICJpbmhlcml0IikgewogICAgcG9pbnRDb25uZWN0aW9uQ29sb3IgPSBbLi4ucG9pbnRDb2xvcl07CiAgfSBlbHNlIHsKICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yID0gaXNNdWx0aXBsZUNvbG9ycyhwb2ludENvbm5lY3Rpb25Db2xvcikgPyBbLi4ucG9pbnRDb25uZWN0aW9uQ29sb3JdIDogW3BvaW50Q29ubmVjdGlvbkNvbG9yXTsKICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yID0gcG9pbnRDb25uZWN0aW9uQ29sb3IubWFwKAogICAgICAoY29sb3IyKSA9PiB0b1JnYmEoY29sb3IyLCB0cnVlKQogICAgKTsKICB9CiAgaWYgKHBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlID09PSAiaW5oZXJpdCIpIHsKICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlID0gWy4uLnBvaW50Q29sb3JBY3RpdmVdOwogIH0gZWxzZSB7CiAgICBwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZSA9IGlzTXVsdGlwbGVDb2xvcnMocG9pbnRDb25uZWN0aW9uQ29sb3JBY3RpdmUpID8gWy4uLnBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlXSA6IFtwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZV07CiAgICBwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZSA9IHBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlLm1hcCgKICAgICAgKGNvbG9yMikgPT4gdG9SZ2JhKGNvbG9yMiwgdHJ1ZSkKICAgICk7CiAgfQogIGlmIChwb2ludENvbm5lY3Rpb25Db2xvckhvdmVyID09PSAiaW5oZXJpdCIpIHsKICAgIHBvaW50Q29ubmVjdGlvbkNvbG9ySG92ZXIgPSBbLi4ucG9pbnRDb2xvckhvdmVyXTsKICB9IGVsc2UgewogICAgcG9pbnRDb25uZWN0aW9uQ29sb3JIb3ZlciA9IGlzTXVsdGlwbGVDb2xvcnMocG9pbnRDb25uZWN0aW9uQ29sb3JIb3ZlcikgPyBbLi4ucG9pbnRDb25uZWN0aW9uQ29sb3JIb3Zlcl0gOiBbcG9pbnRDb25uZWN0aW9uQ29sb3JIb3Zlcl07CiAgICBwb2ludENvbm5lY3Rpb25Db2xvckhvdmVyID0gcG9pbnRDb25uZWN0aW9uQ29sb3JIb3Zlci5tYXAoCiAgICAgIChjb2xvcjIpID0+IHRvUmdiYShjb2xvcjIsIHRydWUpCiAgICApOwogIH0KICBpZiAocG9pbnRDb25uZWN0aW9uT3BhY2l0eSA9PT0gImluaGVyaXQiKSB7CiAgICBwb2ludENvbm5lY3Rpb25PcGFjaXR5ID0gWy4uLm9wYWNpdHldOwogIH0gZWxzZSB7CiAgICBwb2ludENvbm5lY3Rpb25PcGFjaXR5ID0gaXNDb25kaXRpb25hbEFycmF5KAogICAgICBwb2ludENvbm5lY3Rpb25PcGFjaXR5LAogICAgICBpc1Bvc2l0aXZlTnVtYmVyLAogICAgICB7CiAgICAgICAgbWluTGVuZ3RoOiAxCiAgICAgIH0KICAgICkgPyBbLi4ucG9pbnRDb25uZWN0aW9uT3BhY2l0eV0gOiBbcG9pbnRDb25uZWN0aW9uT3BhY2l0eV07CiAgfQogIGlmIChwb2ludENvbm5lY3Rpb25TaXplID09PSAiaW5oZXJpdCIpIHsKICAgIHBvaW50Q29ubmVjdGlvblNpemUgPSBbLi4ucG9pbnRTaXplXTsKICB9IGVsc2UgewogICAgcG9pbnRDb25uZWN0aW9uU2l6ZSA9IGlzQ29uZGl0aW9uYWxBcnJheSgKICAgICAgcG9pbnRDb25uZWN0aW9uU2l6ZSwKICAgICAgaXNQb3NpdGl2ZU51bWJlciwKICAgICAgewogICAgICAgIG1pbkxlbmd0aDogMQogICAgICB9CiAgICApID8gWy4uLnBvaW50Q29ubmVjdGlvblNpemVdIDogW3BvaW50Q29ubmVjdGlvblNpemVdOwogIH0KICBjb2xvckJ5ID0gZ2V0RW5jb2RpbmdUeXBlKGNvbG9yQnksIERFRkFVTFRfQ09MT1JfQlkpOwogIG9wYWNpdHlCeSA9IGdldEVuY29kaW5nVHlwZShvcGFjaXR5QnksIERFRkFVTFRfT1BBQ0lUWV9CWSwgewogICAgYWxsb3dEZW5zaXR5OiB0cnVlCiAgfSk7CiAgc2l6ZUJ5ID0gZ2V0RW5jb2RpbmdUeXBlKHNpemVCeSwgREVGQVVMVF9TSVpFX0JZKTsKICBwb2ludENvbm5lY3Rpb25Db2xvckJ5ID0gZ2V0RW5jb2RpbmdUeXBlKAogICAgcG9pbnRDb25uZWN0aW9uQ29sb3JCeSwKICAgIERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9DT0xPUl9CWSwKICAgIHsgYWxsb3dTZWdtZW50OiB0cnVlLCBhbGxvd0luaGVyaXQ6IHRydWUgfQogICk7CiAgcG9pbnRDb25uZWN0aW9uT3BhY2l0eUJ5ID0gZ2V0RW5jb2RpbmdUeXBlKAogICAgcG9pbnRDb25uZWN0aW9uT3BhY2l0eUJ5LAogICAgREVGQVVMVF9QT0lOVF9DT05ORUNUSU9OX09QQUNJVFlfQlksCiAgICB7IGFsbG93U2VnbWVudDogdHJ1ZSB9CiAgKTsKICBwb2ludENvbm5lY3Rpb25TaXplQnkgPSBnZXRFbmNvZGluZ1R5cGUoCiAgICBwb2ludENvbm5lY3Rpb25TaXplQnksCiAgICBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fU0laRV9CWSwKICAgIHsgYWxsb3dTZWdtZW50OiB0cnVlIH0KICApOwogIGxldCBzdGF0ZVRleDsKICBsZXQgcHJldlN0YXRlVGV4OwogIGxldCB0bXBTdGF0ZVRleDsKICBsZXQgdG1wU3RhdGVCdWZmZXI7CiAgbGV0IHN0YXRlVGV4UmVzID0gMDsKICBsZXQgc3RhdGVUZXhFcHMgPSAwOwogIGxldCBub3JtYWxQb2ludHNJbmRleEJ1ZmZlcjsKICBsZXQgc2VsZWN0ZWRQb2ludHNJbmRleEJ1ZmZlcjsKICBsZXQgaG92ZXJlZFBvaW50SW5kZXhCdWZmZXI7CiAgbGV0IGNhbWVyYVpvb21UYXJnZXRTdGFydDsKICBsZXQgY2FtZXJhWm9vbVRhcmdldEVuZDsKICBsZXQgY2FtZXJhWm9vbURpc3RhbmNlU3RhcnQ7CiAgbGV0IGNhbWVyYVpvb21EaXN0YW5jZUVuZDsKICBsZXQgaXNUcmFuc2l0aW9uaW5nID0gZmFsc2U7CiAgbGV0IHRyYW5zaXRpb25TdGFydFRpbWUgPSBudWxsOwogIGxldCB0cmFuc2l0aW9uRHVyYXRpb247CiAgbGV0IHRyYW5zaXRpb25FYXNpbmc7CiAgbGV0IHByZVRyYW5zaXRpb25TaG93UmV0aWNsZSA9IHNob3dSZXRpY2xlOwogIGxldCBjb2xvclRleDsKICBsZXQgY29sb3JUZXhSZXMgPSAwOwogIGxldCBlbmNvZGluZ1RleDsKICBsZXQgZW5jb2RpbmdUZXhSZXMgPSAwOwogIGxldCBpc1ZpZXdDaGFuZ2VkID0gZmFsc2U7CiAgbGV0IGlzUG9pbnRzRHJhd24gPSBmYWxzZTsKICBsZXQgaXNBbm5vdGF0aW9uc0RyYXduID0gZmFsc2U7CiAgbGV0IGlzTW91c2VPdmVyQ2FudmFzQ2hlY2tlZCA9IGZhbHNlOwogIGxldCB2YWx1ZVpEYXRhVHlwZSA9IENBVEVHT1JJQ0FMOwogIGxldCB2YWx1ZVdEYXRhVHlwZSA9IENBVEVHT1JJQ0FMOwogIGxldCBob3ZlcmVkUG9pbnQ7CiAgbGV0IGlzTW91c2VJbkNhbnZhcyA9IGZhbHNlOwogIGxldCB4U2NhbGUgPSBpbml0aWFsUHJvcGVydGllcy54U2NhbGUgfHwgbnVsbDsKICBsZXQgeVNjYWxlID0gaW5pdGlhbFByb3BlcnRpZXMueVNjYWxlIHx8IG51bGw7CiAgbGV0IHhEb21haW5TdGFydCA9IDA7CiAgbGV0IHhEb21haW5TaXplID0gMDsKICBsZXQgeURvbWFpblN0YXJ0ID0gMDsKICBsZXQgeURvbWFpblNpemUgPSAwOwogIGlmICh4U2NhbGUpIHsKICAgIHhEb21haW5TdGFydCA9IHhTY2FsZS5kb21haW4oKVswXTsKICAgIHhEb21haW5TaXplID0geFNjYWxlLmRvbWFpbigpWzFdIC0geFNjYWxlLmRvbWFpbigpWzBdOwogICAgeFNjYWxlLnJhbmdlKFswLCBjdXJyZW50V2lkdGhdKTsKICB9CiAgaWYgKHlTY2FsZSkgewogICAgeURvbWFpblN0YXJ0ID0geVNjYWxlLmRvbWFpbigpWzBdOwogICAgeURvbWFpblNpemUgPSB5U2NhbGUuZG9tYWluKClbMV0gLSB5U2NhbGUuZG9tYWluKClbMF07CiAgICB5U2NhbGUucmFuZ2UoW2N1cnJlbnRIZWlnaHQsIDBdKTsKICB9CiAgY29uc3QgZ2V0TmRjWCA9ICh4KSA9PiAtMSArIHggLyBjdXJyZW50V2lkdGggKiAyOwogIGNvbnN0IGdldE5kY1kgPSAoeSkgPT4gMSArIHkgLyBjdXJyZW50SGVpZ2h0ICogLTI7CiAgY29uc3QgZ2V0TW91c2VHbFBvcyA9ICgpID0+IFsKICAgIGdldE5kY1gobW91c2VQb3NpdGlvblswXSksCiAgICBnZXROZGNZKG1vdXNlUG9zaXRpb25bMV0pCiAgXTsKICBjb25zdCBnZXRTY2F0dGVyR2xQb3MgPSAoeEdsLCB5R2wpID0+IHsKICAgIGNvbnN0IHYgPSBbeEdsLCB5R2wsIDEsIDFdOwogICAgY29uc3QgbXZwID0gaW52ZXJ0KAogICAgICBzY3JhdGNoLAogICAgICBtdWx0aXBseSgKICAgICAgICBzY3JhdGNoLAogICAgICAgIHByb2plY3Rpb25Mb2NhbCwKICAgICAgICBtdWx0aXBseShzY3JhdGNoLCBjYW1lcmEudmlldywgbW9kZWwpCiAgICAgICkKICAgICk7CiAgICB0cmFuc2Zvcm1NYXQ0KHYsIHYsIG12cCk7CiAgICByZXR1cm4gdi5zbGljZSgwLCAyKTsKICB9OwogIGNvbnN0IGdldFBvaW50U2l6ZU5kYyA9IChwb2ludFNpemVJbmNyZWFzZSA9IDApID0+IHsKICAgIGNvbnN0IHBvaW50U2NhbGUgPSBnZXRQb2ludFNjYWxlKCk7CiAgICBjb25zdCBoZWlnaHROZGMgPSB0b3BSaWdodE5kY1sxXSAtIGJvdHRvbUxlZnROZGNbMV07CiAgICBjb25zdCBweE5kYyA9IGhlaWdodE5kYyAvIGNhbnZhcy5oZWlnaHQ7CiAgICByZXR1cm4gKGNvbXB1dGVkUG9pbnRTaXplTW91c2VEZXRlY3Rpb24gKiBwb2ludFNjYWxlICsgcG9pbnRTaXplSW5jcmVhc2UpICogcHhOZGM7CiAgfTsKICBjb25zdCBnZXRQb2ludHMgPSAoKSA9PiB7CiAgICBpZiAoaXNQb2ludHNGaWx0ZXJlZCkgewogICAgICByZXR1cm4gcG9pbnRzLmZpbHRlcigoXywgaSkgPT4gZmlsdGVyZWRQb2ludHNTZXQuaGFzKGkpKTsKICAgIH0KICAgIHJldHVybiBwb2ludHM7CiAgfTsKICBjb25zdCBnZXRQb2ludHNJbkJCb3ggPSAoeDAsIHkwLCB4MSwgeTEpID0+IHsKICAgIGNvbnN0IHBvaW50c0luQkJveCA9IHNwYXRpYWxJbmRleC5yYW5nZSh4MCwgeTAsIHgxLCB5MSk7CiAgICBpZiAoaXNQb2ludHNGaWx0ZXJlZCkgewogICAgICByZXR1cm4gcG9pbnRzSW5CQm94LmZpbHRlcigoaSkgPT4gZmlsdGVyZWRQb2ludHNTZXQuaGFzKGkpKTsKICAgIH0KICAgIHJldHVybiBwb2ludHNJbkJCb3g7CiAgfTsKICBjb25zdCByYXljYXN0ID0gKCkgPT4gewogICAgY29uc3QgW3hHbCwgeUdsXSA9IGdldE1vdXNlR2xQb3MoKTsKICAgIGNvbnN0IFt4TmRjLCB5TmRjXSA9IGdldFNjYXR0ZXJHbFBvcyh4R2wsIHlHbCk7CiAgICBjb25zdCBwb2ludFNpemVOZGMgPSBnZXRQb2ludFNpemVOZGMoNCk7CiAgICBjb25zdCBwb2ludHNJbkJCb3ggPSBnZXRQb2ludHNJbkJCb3goCiAgICAgIHhOZGMgLSBwb2ludFNpemVOZGMsCiAgICAgIHlOZGMgLSBwb2ludFNpemVOZGMsCiAgICAgIHhOZGMgKyBwb2ludFNpemVOZGMsCiAgICAgIHlOZGMgKyBwb2ludFNpemVOZGMKICAgICk7CiAgICBsZXQgbWluRGlzdCA9IHBvaW50U2l6ZU5kYzsKICAgIGxldCBjbG9zdGVzdFBvaW50SWR4ID0gLTE7CiAgICBmb3IgKGNvbnN0IHBvaW50SWR4IG9mIHBvaW50c0luQkJveCkgewogICAgICBjb25zdCBbcHRYLCBwdFldID0gcG9pbnRzW3BvaW50SWR4XTsKICAgICAgY29uc3QgZCA9IGRpc3QocHRYLCBwdFksIHhOZGMsIHlOZGMpOwogICAgICBpZiAoZCA8IG1pbkRpc3QpIHsKICAgICAgICBtaW5EaXN0ID0gZDsKICAgICAgICBjbG9zdGVzdFBvaW50SWR4ID0gcG9pbnRJZHg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjbG9zdGVzdFBvaW50SWR4OwogIH07CiAgY29uc3QgbGFzc29FeHRlbmQgPSAobGFzc29Qb2ludHMsIGxhc3NvUG9pbnRzRmxhdCkgPT4gewogICAgbGFzc29Qb2ludHNDdXJyID0gbGFzc29Qb2ludHM7CiAgICBsYXNzby5zZXRQb2ludHMobGFzc29Qb2ludHNGbGF0KTsKICAgIHB1YlN1Yi5wdWJsaXNoKCJsYXNzb0V4dGVuZCIsIHsgY29vcmRpbmF0ZXM6IGxhc3NvUG9pbnRzIH0pOwogIH07CiAgY29uc3QgZmluZFBvaW50c0luTGFzc28gPSAobGFzc29Qb2x5Z29uKSA9PiB7CiAgICBjb25zdCBiQm94ID0gZ2V0QkJveChsYXNzb1BvbHlnb24pOwogICAgaWYgKCFpc1ZhbGlkQkJveChiQm94KSkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICBjb25zdCBwb2ludHNJbkJCb3ggPSBnZXRQb2ludHNJbkJCb3goLi4uYkJveCk7CiAgICBjb25zdCBwb2ludHNJblBvbHlnb24gPSBbXTsKICAgIGZvciAoY29uc3QgcG9pbnRJZHggb2YgcG9pbnRzSW5CQm94KSB7CiAgICAgIGlmIChpc1BvaW50SW5Qb2x5Z29uKGxhc3NvUG9seWdvbiwgcG9pbnRzW3BvaW50SWR4XSkpIHsKICAgICAgICBwb2ludHNJblBvbHlnb24ucHVzaChwb2ludElkeCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwb2ludHNJblBvbHlnb247CiAgfTsKICBjb25zdCBsYXNzb0NsZWFyID0gKCkgPT4gewogICAgbGFzc29Qb2ludHNDdXJyID0gW107CiAgICBpZiAobGFzc28pIHsKICAgICAgbGFzc28uY2xlYXIoKTsKICAgIH0KICB9OwogIGNvbnN0IGhhc1BvaW50Q29ubmVjdGlvbnMgPSAocG9pbnQpID0+IHBvaW50ICYmIHBvaW50Lmxlbmd0aCA+IDQ7CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JTdGF0ZSA9IChwb2ludElkeHMsIHN0YXRlSW5kZXgpID0+IHsKICAgIGlmIChjb21wdXRpbmdQb2ludENvbm5lY3Rpb25DdXJ2ZXMgfHwgIXNob3dQb2ludENvbm5lY3Rpb25zIHx8ICFoYXNQb2ludENvbm5lY3Rpb25zKHBvaW50c1twb2ludElkeHNbMF1dKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpc05vcm1hbCA9IHN0YXRlSW5kZXggPT09IDA7CiAgICBjb25zdCBsaW5lSWRDYWNoZXIgPSBzdGF0ZUluZGV4ID09PSAxID8gKGxpbmVJZCkgPT4gc2VsZWN0ZWRQb2ludHNDb25uZWN0aW9uU2V0LmFkZChsaW5lSWQpIDogaWRlbnRpdHk7CiAgICBjb25zdCBsaW5lSWRzID0gT2JqZWN0LmtleXMoCiAgICAgIHBvaW50SWR4cy5yZWR1Y2UoKGlkcywgcG9pbnRJZHgpID0+IHsKICAgICAgICBjb25zdCBwb2ludCA9IHBvaW50c1twb2ludElkeF07CiAgICAgICAgY29uc3QgaXNTdHJ1Y3QgPSBBcnJheS5pc0FycmF5KHBvaW50WzRdKTsKICAgICAgICBjb25zdCBsaW5lSWQgPSBpc1N0cnVjdCA/IHBvaW50WzRdWzBdIDogcG9pbnRbNF07CiAgICAgICAgaWRzW2xpbmVJZF0gPSB0cnVlOwogICAgICAgIHJldHVybiBpZHM7CiAgICAgIH0sIHt9KQogICAgKTsKICAgIGNvbnN0IGJ1ZmZlcjIgPSBwb2ludENvbm5lY3Rpb25zLmdldERhdGEoKS5vcGFjaXRpZXM7CiAgICBjb25zdCB1bnNlbGVjdGVkTGluZUlkcyA9IGxpbmVJZHMuZmlsdGVyKAogICAgICAobGluZUlkKSA9PiAhc2VsZWN0ZWRQb2ludHNDb25uZWN0aW9uU2V0LmhhcygrbGluZUlkKQogICAgKTsKICAgIGZvciAoY29uc3QgbGluZUlkIG9mIHVuc2VsZWN0ZWRMaW5lSWRzKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gcG9pbnRDb25uZWN0aW9uTWFwW2xpbmVJZF1bMF07CiAgICAgIGNvbnN0IG51bVBvaW50UGVyTGluZSA9IHBvaW50Q29ubmVjdGlvbk1hcFtsaW5lSWRdWzJdOwogICAgICBjb25zdCBwb2ludE9mZnNldCA9IHBvaW50Q29ubmVjdGlvbk1hcFtsaW5lSWRdWzNdOwogICAgICBjb25zdCBidWZmZXJTdGFydCA9IGluZGV4ICogNCArIHBvaW50T2Zmc2V0ICogMjsKICAgICAgY29uc3QgYnVmZmVyRW5kID0gYnVmZmVyU3RhcnQgKyBudW1Qb2ludFBlckxpbmUgKiAyICsgNDsKICAgICAgaWYgKGJ1ZmZlcjIuX19vcmlnaW5hbF9fID09PSB2b2lkIDApIHsKICAgICAgICBidWZmZXIyLl9fb3JpZ2luYWxfXyA9IGJ1ZmZlcjIuc2xpY2UoKTsKICAgICAgfQogICAgICBmb3IgKGxldCBpID0gYnVmZmVyU3RhcnQ7IGkgPCBidWZmZXJFbmQ7IGkrKykgewogICAgICAgIGJ1ZmZlcjJbaV0gPSBpc05vcm1hbCA/IGJ1ZmZlcjIuX19vcmlnaW5hbF9fW2ldIDogcG9pbnRDb25uZWN0aW9uT3BhY2l0eUFjdGl2ZTsKICAgICAgfQogICAgICBsaW5lSWRDYWNoZXIobGluZUlkKTsKICAgIH0KICAgIHBvaW50Q29ubmVjdGlvbnMuZ2V0QnVmZmVyKCkub3BhY2l0aWVzLnN1YmRhdGEoYnVmZmVyMiwgMCk7CiAgfTsKICBjb25zdCBpbmRleFRvU3RhdGVUZXhDb29yZCA9IChpbmRleCkgPT4gWwogICAgaW5kZXggJSBzdGF0ZVRleFJlcyAvIHN0YXRlVGV4UmVzICsgc3RhdGVUZXhFcHMsCiAgICBNYXRoLmZsb29yKGluZGV4IC8gc3RhdGVUZXhSZXMpIC8gc3RhdGVUZXhSZXMgKyBzdGF0ZVRleEVwcwogIF07CiAgY29uc3QgaXNQb2ludHNGaWx0ZXJlZE91dCA9IChwb2ludElkeCkgPT4gaXNQb2ludHNGaWx0ZXJlZCAmJiAhZmlsdGVyZWRQb2ludHNTZXQuaGFzKHBvaW50SWR4KTsKICBjb25zdCBkZXNlbGVjdCA9ICh7IHByZXZlbnRFdmVudCA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgaWYgKGxhc3NvQ2xlYXJFdmVudCA9PT0gTEFTU09fQ0xFQVJfT05fREVTRUxFQ1QpIHsKICAgICAgbGFzc29DbGVhcigpOwogICAgfQogICAgaWYgKHNlbGVjdGVkUG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgaWYgKCFwcmV2ZW50RXZlbnQpIHsKICAgICAgICBwdWJTdWIucHVibGlzaCgiZGVzZWxlY3QiKTsKICAgICAgfQogICAgICBzZWxlY3RlZFBvaW50c0Nvbm5lY3Rpb25TZXQuY2xlYXIoKTsKICAgICAgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JTdGF0ZShzZWxlY3RlZFBvaW50cywgMCk7CiAgICAgIHNlbGVjdGVkUG9pbnRzID0gW107CiAgICAgIHNlbGVjdGVkUG9pbnRzU2V0LmNsZWFyKCk7CiAgICAgIGRyYXcgPSB0cnVlOwogICAgfQogIH07CiAgY29uc3Qgc2VsZWN0ID0gKHBvaW50SWR4cywgeyBtZXJnZSA9IGZhbHNlLCByZW1vdmU6IHJlbW92ZTIgPSBmYWxzZSwgcHJldmVudEV2ZW50ID0gZmFsc2UgfSA9IHt9KSA9PiB7CiAgICBjb25zdCBuZXdTZWxlY3RlZFBvaW50cyA9IEFycmF5LmlzQXJyYXkocG9pbnRJZHhzKSA/IHBvaW50SWR4cyA6IFtwb2ludElkeHNdOwogICAgY29uc3QgY3VyclNlbGVjdGVkUG9pbnRzID0gWy4uLnNlbGVjdGVkUG9pbnRzXTsKICAgIGlmIChtZXJnZSkgewogICAgICBzZWxlY3RlZFBvaW50cyA9IHVuaW9uSW50ZWdlcnMoc2VsZWN0ZWRQb2ludHMsIG5ld1NlbGVjdGVkUG9pbnRzKTsKICAgICAgaWYgKGN1cnJTZWxlY3RlZFBvaW50cy5sZW5ndGggPT09IHNlbGVjdGVkUG9pbnRzLmxlbmd0aCkgewogICAgICAgIGRyYXcgPSB0cnVlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIGlmIChyZW1vdmUyKSB7CiAgICAgIGNvbnN0IG5ld1NlbGVjdGVkUG9pbnRzU2V0ID0gbmV3IFNldChuZXdTZWxlY3RlZFBvaW50cyk7CiAgICAgIHNlbGVjdGVkUG9pbnRzID0gc2VsZWN0ZWRQb2ludHMuZmlsdGVyKAogICAgICAgIChwb2ludCkgPT4gIW5ld1NlbGVjdGVkUG9pbnRzU2V0Lmhhcyhwb2ludCkKICAgICAgKTsKICAgICAgaWYgKGN1cnJTZWxlY3RlZFBvaW50cy5sZW5ndGggPT09IHNlbGVjdGVkUG9pbnRzLmxlbmd0aCkgewogICAgICAgIGRyYXcgPSB0cnVlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHNlbGVjdGVkUG9pbnRzPy5sZW5ndGggPiAwKSB7CiAgICAgICAgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JTdGF0ZShzZWxlY3RlZFBvaW50cywgMCk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJTZWxlY3RlZFBvaW50cy5sZW5ndGggPiAwICYmIG5ld1NlbGVjdGVkUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGRlc2VsZWN0KHsgcHJldmVudEV2ZW50IH0pOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzZWxlY3RlZFBvaW50cyA9IG5ld1NlbGVjdGVkUG9pbnRzOwogICAgfQogICAgaWYgKGhhc1NhbWVFbGVtZW50cyhjdXJyU2VsZWN0ZWRQb2ludHMsIHNlbGVjdGVkUG9pbnRzKSkgewogICAgICBkcmF3ID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc2VsZWN0ZWRQb2ludHNCdWZmZXIgPSBbXTsKICAgIHNlbGVjdGVkUG9pbnRzU2V0LmNsZWFyKCk7CiAgICBzZWxlY3RlZFBvaW50c0Nvbm5lY3Rpb25TZXQuY2xlYXIoKTsKICAgIGZvciAobGV0IGkgPSBzZWxlY3RlZFBvaW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwb2ludElkeCA9IHNlbGVjdGVkUG9pbnRzW2ldOwogICAgICBpZiAocG9pbnRJZHggPCAwIHx8IHBvaW50SWR4ID49IG51bVBvaW50cyB8fCBpc1BvaW50c0ZpbHRlcmVkT3V0KHBvaW50SWR4KSkgewogICAgICAgIHNlbGVjdGVkUG9pbnRzLnNwbGljZShpLCAxKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBzZWxlY3RlZFBvaW50c1NldC5hZGQocG9pbnRJZHgpOwogICAgICBzZWxlY3RlZFBvaW50c0J1ZmZlci5wdXNoLmFwcGx5KAogICAgICAgIHNlbGVjdGVkUG9pbnRzQnVmZmVyLAogICAgICAgIGluZGV4VG9TdGF0ZVRleENvb3JkKHBvaW50SWR4KQogICAgICApOwogICAgfQogICAgc2VsZWN0ZWRQb2ludHNJbmRleEJ1ZmZlcih7CiAgICAgIHVzYWdlOiAiZHluYW1pYyIsCiAgICAgIHR5cGU6ICJmbG9hdCIsCiAgICAgIGRhdGE6IHNlbGVjdGVkUG9pbnRzQnVmZmVyCiAgICB9KTsKICAgIHNldFBvaW50Q29ubmVjdGlvbkNvbG9yU3RhdGUoc2VsZWN0ZWRQb2ludHMsIDEpOwogICAgaWYgKCFwcmV2ZW50RXZlbnQpIHsKICAgICAgcHViU3ViLnB1Ymxpc2goInNlbGVjdCIsIHsgcG9pbnRzOiBzZWxlY3RlZFBvaW50cyB9KTsKICAgIH0KICAgIGRyYXcgPSB0cnVlOwogIH07CiAgY29uc3QgaG92ZXIgPSAocG9pbnQsIHsgc2hvd1JldGljbGVPbmNlID0gZmFsc2UsIHByZXZlbnRFdmVudCA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgbGV0IG5lZWRzUmVkcmF3ID0gZmFsc2U7CiAgICBjb25zdCBpc0ZpbHRlcmVkT3V0ID0gaXNQb2ludHNGaWx0ZXJlZCAmJiAhZmlsdGVyZWRQb2ludHNTZXQuaGFzKHBvaW50KTsKICAgIGlmICghaXNGaWx0ZXJlZE91dCAmJiBwb2ludCA+PSAwICYmIHBvaW50IDwgbnVtUG9pbnRzKSB7CiAgICAgIG5lZWRzUmVkcmF3ID0gdHJ1ZTsKICAgICAgY29uc3Qgb2xkSG92ZXJlZFBvaW50ID0gaG92ZXJlZFBvaW50OwogICAgICBjb25zdCBuZXdIb3ZlcmVkUG9pbnQgPSBwb2ludCAhPT0gaG92ZXJlZFBvaW50OwogICAgICBpZiAoK29sZEhvdmVyZWRQb2ludCA+PSAwICYmIG5ld0hvdmVyZWRQb2ludCAmJiAhc2VsZWN0ZWRQb2ludHNTZXQuaGFzKG9sZEhvdmVyZWRQb2ludCkpIHsKICAgICAgICBzZXRQb2ludENvbm5lY3Rpb25Db2xvclN0YXRlKFtvbGRIb3ZlcmVkUG9pbnRdLCAwKTsKICAgICAgfQogICAgICBob3ZlcmVkUG9pbnQgPSBwb2ludDsKICAgICAgaG92ZXJlZFBvaW50SW5kZXhCdWZmZXIuc3ViZGF0YShpbmRleFRvU3RhdGVUZXhDb29yZChwb2ludCkpOwogICAgICBpZiAoIXNlbGVjdGVkUG9pbnRzU2V0Lmhhcyhwb2ludCkpIHsKICAgICAgICBzZXRQb2ludENvbm5lY3Rpb25Db2xvclN0YXRlKFtwb2ludF0sIDIpOwogICAgICB9CiAgICAgIGlmIChuZXdIb3ZlcmVkUG9pbnQgJiYgIXByZXZlbnRFdmVudCkgewogICAgICAgIHB1YlN1Yi5wdWJsaXNoKCJwb2ludG92ZXIiLCBob3ZlcmVkUG9pbnQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBuZWVkc1JlZHJhdyA9ICtob3ZlcmVkUG9pbnQgPj0gMDsKICAgICAgaWYgKG5lZWRzUmVkcmF3KSB7CiAgICAgICAgaWYgKCFzZWxlY3RlZFBvaW50c1NldC5oYXMoaG92ZXJlZFBvaW50KSkgewogICAgICAgICAgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JTdGF0ZShbaG92ZXJlZFBvaW50XSwgMCk7CiAgICAgICAgfQogICAgICAgIGlmICghcHJldmVudEV2ZW50KSB7CiAgICAgICAgICBwdWJTdWIucHVibGlzaCgicG9pbnRvdXQiLCBob3ZlcmVkUG9pbnQpOwogICAgICAgIH0KICAgICAgfQogICAgICBob3ZlcmVkUG9pbnQgPSB2b2lkIDA7CiAgICB9CiAgICBpZiAobmVlZHNSZWRyYXcpIHsKICAgICAgZHJhdyA9IHRydWU7CiAgICAgIGRyYXdSZXRpY2xlT25jZSA9IHNob3dSZXRpY2xlT25jZTsKICAgIH0KICB9OwogIGNvbnN0IGdldFJlbGF0aXZlTW91c2VQb3NpdGlvbiA9IChldmVudCkgPT4gewogICAgY29uc3QgcmVjdCA9IGNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIG1vdXNlUG9zaXRpb25bMF0gPSBldmVudC5jbGllbnRYIC0gcmVjdC5sZWZ0OwogICAgbW91c2VQb3NpdGlvblsxXSA9IGV2ZW50LmNsaWVudFkgLSByZWN0LnRvcDsKICAgIHJldHVybiBbLi4ubW91c2VQb3NpdGlvbl07CiAgfTsKICBjb25zdCBsYXNzb1N0YXJ0ID0gKCkgPT4gewogICAgY2FtZXJhLmNvbmZpZyh7IGlzRml4ZWQ6IHRydWUgfSk7CiAgICBtb3VzZURvd24gPSB0cnVlOwogICAgbGFzc29BY3RpdmUgPSB0cnVlOwogICAgbGFzc29DbGVhcigpOwogICAgaWYgKG1vdXNlRG93blRpbWVvdXQgPj0gMCkgewogICAgICBjbGVhclRpbWVvdXQobW91c2VEb3duVGltZW91dCk7CiAgICAgIG1vdXNlRG93blRpbWVvdXQgPSAtMTsKICAgIH0KICAgIHB1YlN1Yi5wdWJsaXNoKCJsYXNzb1N0YXJ0Iik7CiAgfTsKICBjb25zdCBsYXNzb0VuZCA9IChsYXNzb1BvaW50cywgbGFzc29Qb2ludHNGbGF0LCB7IG1lcmdlID0gZmFsc2UsIHJlbW92ZTogcmVtb3ZlMiA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgY2FtZXJhLmNvbmZpZyh7IGlzRml4ZWQ6IGNhbWVyYUlzRml4ZWQgfSk7CiAgICBsYXNzb1BvaW50c0N1cnIgPSBbLi4ubGFzc29Qb2ludHNdOwogICAgY29uc3QgcG9pbnRzSW5MYXNzbyA9IGZpbmRQb2ludHNJbkxhc3NvKGxhc3NvUG9pbnRzRmxhdCk7CiAgICBzZWxlY3QocG9pbnRzSW5MYXNzbywgeyBtZXJnZSwgcmVtb3ZlOiByZW1vdmUyIH0pOwogICAgcHViU3ViLnB1Ymxpc2goImxhc3NvRW5kIiwgewogICAgICBjb29yZGluYXRlczogbGFzc29Qb2ludHNDdXJyCiAgICB9KTsKICAgIGlmIChsYXNzb0NsZWFyRXZlbnQgPT09IExBU1NPX0NMRUFSX09OX0VORCkgewogICAgICBsYXNzb0NsZWFyKCk7CiAgICB9CiAgfTsKICBjb25zdCBsYXNzb01hbmFnZXIgPSBjcmVhdGVMYXNzbyhjYW52YXMsIHsKICAgIG9uU3RhcnQ6IGxhc3NvU3RhcnQsCiAgICBvbkRyYXc6IGxhc3NvRXh0ZW5kLAogICAgb25FbmQ6IGxhc3NvRW5kLAogICAgZW5hYmxlSW5pdGlhdG9yOiBsYXNzb0luaXRpYXRvciwKICAgIGluaXRpYXRvclBhcmVudEVsZW1lbnQ6IGxhc3NvSW5pdGlhdG9yUGFyZW50RWxlbWVudCwKICAgIGxvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQ6IGxhc3NvTG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudCwKICAgIHBvaW50Tm9ybTogKFt4LCB5XSkgPT4gZ2V0U2NhdHRlckdsUG9zKGdldE5kY1goeCksIGdldE5kY1koeSkpLAogICAgbWluRGVsYXk6IGxhc3NvTWluRGVsYXksCiAgICBtaW5EaXN0OiBsYXNzb1R5cGUgPT09ICJicnVzaCIgPyBNYXRoLm1heChMQVNTT19CUlVTSF9NSU5fTUlOX0RJU1QsIGxhc3NvTWluRGlzdCkgOiBsYXNzb01pbkRpc3QsCiAgICB0eXBlOiBsYXNzb1R5cGUKICB9KTsKICBjb25zdCBjaGVja0xhc3NvTW9kZSA9ICgpID0+IG1vdXNlTW9kZSA9PT0gTU9VU0VfTU9ERV9MQVNTTzsKICBjb25zdCBjaGVja01vZEtleSA9IChldmVudCwgYWN0aW9uKSA9PiB7CiAgICBzd2l0Y2ggKGFjdGlvbktleU1hcFthY3Rpb25dKSB7CiAgICAgIGNhc2UgS0VZX0FMVDoKICAgICAgICByZXR1cm4gZXZlbnQuYWx0S2V5OwogICAgICBjYXNlIEtFWV9DTUQ6CiAgICAgICAgcmV0dXJuIGV2ZW50Lm1ldGFLZXk7CiAgICAgIGNhc2UgS0VZX0NUUkw6CiAgICAgICAgcmV0dXJuIGV2ZW50LmN0cmxLZXk7CiAgICAgIGNhc2UgS0VZX01FVEE6CiAgICAgICAgcmV0dXJuIGV2ZW50Lm1ldGFLZXk7CiAgICAgIGNhc2UgS0VZX1NISUZUOgogICAgICAgIHJldHVybiBldmVudC5zaGlmdEtleTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKICBjb25zdCBjaGVja0lmTW91c2VJc092ZXJDYW52YXMgPSAoZXZlbnQpID0+IGRvY3VtZW50LmVsZW1lbnRzRnJvbVBvaW50KGV2ZW50LmNsaWVudFgsIGV2ZW50LmNsaWVudFkpLnNvbWUoKGVsZW1lbnQpID0+IGVsZW1lbnQgPT09IGNhbnZhcyk7CiAgY29uc3QgbW91c2VEb3duSGFuZGxlciA9IChldmVudCkgPT4gewogICAgaWYgKCFpc1BvaW50c0RyYXduIHx8IGV2ZW50LmJ1dHRvbnMgIT09IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbW91c2VEb3duID0gdHJ1ZTsKICAgIG1vdXNlRG93blRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgIG1vdXNlRG93blBvc2l0aW9uID0gZ2V0UmVsYXRpdmVNb3VzZVBvc2l0aW9uKGV2ZW50KTsKICAgIGxhc3NvQWN0aXZlID0gY2hlY2tMYXNzb01vZGUoKSB8fCBjaGVja01vZEtleShldmVudCwgS0VZX0FDVElPTl9MQVNTTyk7CiAgICBpZiAoIWxhc3NvQWN0aXZlICYmIGxhc3NvT25Mb25nUHJlc3MpIHsKICAgICAgbGFzc29NYW5hZ2VyLnNob3dMb25nUHJlc3NJbmRpY2F0b3IoZXZlbnQuY2xpZW50WCwgZXZlbnQuY2xpZW50WSwgewogICAgICAgIHRpbWU6IGxhc3NvTG9uZ1ByZXNzVGltZSwKICAgICAgICBleHRyYVRpbWU6IGxhc3NvTG9uZ1ByZXNzQWZ0ZXJFZmZlY3RUaW1lLAogICAgICAgIGRlbGF5OiBsYXNzb0xvbmdQcmVzc0VmZmVjdERlbGF5CiAgICAgIH0pOwogICAgICBtb3VzZURvd25UaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgbW91c2VEb3duVGltZW91dCA9IC0xOwogICAgICAgIGxhc3NvQWN0aXZlID0gdHJ1ZTsKICAgICAgfSwgbGFzc29Mb25nUHJlc3NUaW1lKTsKICAgIH0KICB9OwogIGNvbnN0IG1vdXNlVXBIYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBpZiAoIWlzUG9pbnRzRHJhd24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbW91c2VEb3duID0gZmFsc2U7CiAgICBpZiAobW91c2VEb3duVGltZW91dCA+PSAwKSB7CiAgICAgIGNsZWFyVGltZW91dChtb3VzZURvd25UaW1lb3V0KTsKICAgICAgbW91c2VEb3duVGltZW91dCA9IC0xOwogICAgfQogICAgaWYgKGxhc3NvQWN0aXZlKSB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGxhc3NvQWN0aXZlID0gZmFsc2U7CiAgICAgIGxhc3NvTWFuYWdlci5lbmQoewogICAgICAgIG1lcmdlOiBjaGVja01vZEtleShldmVudCwgS0VZX0FDVElPTl9NRVJHRSksCiAgICAgICAgcmVtb3ZlOiBjaGVja01vZEtleShldmVudCwgS0VZX0FDVElPTl9SRU1PVkUpCiAgICAgIH0pOwogICAgfQogICAgaWYgKGxhc3NvT25Mb25nUHJlc3MpIHsKICAgICAgbGFzc29NYW5hZ2VyLmhpZGVMb25nUHJlc3NJbmRpY2F0b3IoewogICAgICAgIHRpbWU6IGxhc3NvTG9uZ1ByZXNzUmV2ZXJ0RWZmZWN0VGltZQogICAgICB9KTsKICAgIH0KICB9OwogIGNvbnN0IG1vdXNlQ2xpY2tIYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBpZiAoIWlzUG9pbnRzRHJhd24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IGN1cnJlbnRNb3VzZVBvc2l0aW9uID0gZ2V0UmVsYXRpdmVNb3VzZVBvc2l0aW9uKGV2ZW50KTsKICAgIGlmIChkaXN0KC4uLmN1cnJlbnRNb3VzZVBvc2l0aW9uLCAuLi5tb3VzZURvd25Qb3NpdGlvbikgPj0gbGFzc29NaW5EaXN0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGNsaWNrVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gbW91c2VEb3duVGltZTsKICAgIGlmICghbGFzc29Jbml0aWF0b3IgfHwgY2xpY2tUaW1lIDwgTE9OR19DTElDS19USU1FKSB7CiAgICAgIGNvbnN0IGNsb3N0ZXN0UG9pbnQgPSByYXljYXN0KCk7CiAgICAgIGlmIChjbG9zdGVzdFBvaW50ID49IDApIHsKICAgICAgICBpZiAoc2VsZWN0ZWRQb2ludHMubGVuZ3RoID4gMCAmJiBsYXNzb0NsZWFyRXZlbnQgPT09IExBU1NPX0NMRUFSX09OX0RFU0VMRUNUKSB7CiAgICAgICAgICBsYXNzb0NsZWFyKCk7CiAgICAgICAgfQogICAgICAgIHNlbGVjdChbY2xvc3Rlc3RQb2ludF0sIHsKICAgICAgICAgIG1lcmdlOiBjaGVja01vZEtleShldmVudCwgS0VZX0FDVElPTl9NRVJHRSksCiAgICAgICAgICByZW1vdmU6IGNoZWNrTW9kS2V5KGV2ZW50LCBLRVlfQUNUSU9OX1JFTU9WRSkKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICghbGFzc29Jbml0aWF0b3JUaW1lb3V0KSB7CiAgICAgICAgbGFzc29Jbml0aWF0b3JUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBsYXNzb0luaXRpYXRvclRpbWVvdXQgPSBudWxsOwogICAgICAgICAgbGFzc29NYW5hZ2VyLnNob3dJbml0aWF0b3IoZXZlbnQpOwogICAgICAgIH0sIFNJTkdMRV9DTElDS19ERUxBWSk7CiAgICAgIH0KICAgIH0KICB9OwogIGNvbnN0IG1vdXNlRGJsQ2xpY2tIYW5kbGVyID0gKGV2ZW50KSA9PiB7CiAgICBsYXNzb01hbmFnZXIuaGlkZUluaXRpYXRvcigpOwogICAgaWYgKGxhc3NvSW5pdGlhdG9yVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQobGFzc29Jbml0aWF0b3JUaW1lb3V0KTsKICAgICAgbGFzc29Jbml0aWF0b3JUaW1lb3V0ID0gbnVsbDsKICAgIH0KICAgIGlmIChkZXNlbGVjdE9uRGJsQ2xpY2spIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgZGVzZWxlY3QoKTsKICAgIH0KICB9OwogIGNvbnN0IG1vdXNlTW92ZUhhbmRsZXIgPSAoZXZlbnQpID0+IHsKICAgIGlmICghaXNNb3VzZU92ZXJDYW52YXNDaGVja2VkKSB7CiAgICAgIGlzTW91c2VJbkNhbnZhcyA9IGNoZWNrSWZNb3VzZUlzT3ZlckNhbnZhcyhldmVudCk7CiAgICAgIGlzTW91c2VPdmVyQ2FudmFzQ2hlY2tlZCA9IHRydWU7CiAgICB9CiAgICBpZiAoIShpc1BvaW50c0RyYXduICYmIChpc01vdXNlSW5DYW52YXMgfHwgbW91c2VEb3duKSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY3VycmVudE1vdXNlUG9zaXRpb24gPSBnZXRSZWxhdGl2ZU1vdXNlUG9zaXRpb24oZXZlbnQpOwogICAgY29uc3QgbW91c2VNb3ZlRGlzdCA9IGRpc3QoLi4uY3VycmVudE1vdXNlUG9zaXRpb24sIC4uLm1vdXNlRG93blBvc2l0aW9uKTsKICAgIGNvbnN0IG1vdXNlTW92ZWRNaW4gPSBtb3VzZU1vdmVEaXN0ID49IGxhc3NvTWluRGlzdDsKICAgIGlmIChpc01vdXNlSW5DYW52YXMgJiYgIWxhc3NvQWN0aXZlKSB7CiAgICAgIGhvdmVyKHJheWNhc3QoKSk7CiAgICB9CiAgICBpZiAobGFzc29BY3RpdmUpIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgbGFzc29NYW5hZ2VyLmV4dGVuZChldmVudCwgdHJ1ZSk7CiAgICB9IGVsc2UgaWYgKG1vdXNlRG93biAmJiBsYXNzb09uTG9uZ1ByZXNzICYmIG1vdXNlTW92ZWRNaW4pIHsKICAgICAgbGFzc29NYW5hZ2VyLmhpZGVMb25nUHJlc3NJbmRpY2F0b3IoewogICAgICAgIHRpbWU6IGxhc3NvTG9uZ1ByZXNzUmV2ZXJ0RWZmZWN0VGltZQogICAgICB9KTsKICAgIH0KICAgIGlmIChtb3VzZURvd25UaW1lb3V0ID49IDAgJiYgbW91c2VNb3ZlZE1pbikgewogICAgICBjbGVhclRpbWVvdXQobW91c2VEb3duVGltZW91dCk7CiAgICAgIG1vdXNlRG93blRpbWVvdXQgPSAtMTsKICAgIH0KICAgIGlmIChtb3VzZURvd24pIHsKICAgICAgZHJhdyA9IHRydWU7CiAgICB9CiAgfTsKICBjb25zdCBibHVySGFuZGxlciA9ICgpID0+IHsKICAgIGhvdmVyZWRQb2ludCA9IHZvaWQgMDsKICAgIGlzTW91c2VJbkNhbnZhcyA9IGZhbHNlOwogICAgaXNNb3VzZU92ZXJDYW52YXNDaGVja2VkID0gZmFsc2U7CiAgICBpZiAoIWlzUG9pbnRzRHJhd24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCtob3ZlcmVkUG9pbnQgPj0gMCAmJiAhc2VsZWN0ZWRQb2ludHNTZXQuaGFzKGhvdmVyZWRQb2ludCkpIHsKICAgICAgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JTdGF0ZShbaG92ZXJlZFBvaW50XSwgMCk7CiAgICB9CiAgICBtb3VzZVVwSGFuZGxlcigpOwogICAgZHJhdyA9IHRydWU7CiAgfTsKICBjb25zdCBjcmVhdGVFbmNvZGluZ1RleHR1cmUgPSAoKSA9PiB7CiAgICBjb25zdCBtYXhFbmNvZGluZyA9IE1hdGgubWF4KHBvaW50U2l6ZS5sZW5ndGgsIG9wYWNpdHkubGVuZ3RoKTsKICAgIGVuY29kaW5nVGV4UmVzID0gTWF0aC5tYXgoMiwgTWF0aC5jZWlsKE1hdGguc3FydChtYXhFbmNvZGluZykpKTsKICAgIGNvbnN0IHJnYmEyID0gbmV3IEZsb2F0MzJBcnJheShlbmNvZGluZ1RleFJlcyAqKiAyICogNCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1heEVuY29kaW5nOyBpKyspIHsKICAgICAgcmdiYTJbaSAqIDRdID0gcG9pbnRTaXplW2ldIHx8IDA7CiAgICAgIHJnYmEyW2kgKiA0ICsgMV0gPSBNYXRoLm1pbigxLCBvcGFjaXR5W2ldIHx8IDApOwogICAgICBjb25zdCBhY3RpdmVPcGFjaXR5ID0gTnVtYmVyKAogICAgICAgIChwb2ludENvbG9yQWN0aXZlW2ldIHx8IHBvaW50Q29sb3JBY3RpdmVbMF0pWzNdCiAgICAgICk7CiAgICAgIHJnYmEyW2kgKiA0ICsgMl0gPSBNYXRoLm1pbigKICAgICAgICAxLAogICAgICAgIE51bWJlci5pc05hTihhY3RpdmVPcGFjaXR5KSA/IDEgOiBhY3RpdmVPcGFjaXR5CiAgICAgICk7CiAgICAgIGNvbnN0IGhvdmVyT3BhY2l0eSA9IE51bWJlcigKICAgICAgICAocG9pbnRDb2xvckhvdmVyW2ldIHx8IHBvaW50Q29sb3JIb3ZlclswXSlbM10KICAgICAgKTsKICAgICAgcmdiYTJbaSAqIDQgKyAzXSA9IE1hdGgubWluKAogICAgICAgIDEsCiAgICAgICAgTnVtYmVyLmlzTmFOKGhvdmVyT3BhY2l0eSkgPyAxIDogaG92ZXJPcGFjaXR5CiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gcmVuZGVyZXIucmVnbC50ZXh0dXJlKHsKICAgICAgZGF0YTogcmdiYTIsCiAgICAgIHNoYXBlOiBbZW5jb2RpbmdUZXhSZXMsIGVuY29kaW5nVGV4UmVzLCA0XSwKICAgICAgdHlwZTogImZsb2F0IgogICAgfSk7CiAgfTsKICBjb25zdCBnZXRDb2xvcnMgPSAoYmFzZUNvbG9yID0gcG9pbnRDb2xvciwgYWN0aXZlQ29sb3IgPSBwb2ludENvbG9yQWN0aXZlLCBob3ZlckNvbG9yID0gcG9pbnRDb2xvckhvdmVyKSA9PiB7CiAgICBjb25zdCBuID0gYmFzZUNvbG9yLmxlbmd0aDsKICAgIGNvbnN0IG4yID0gYWN0aXZlQ29sb3IubGVuZ3RoOwogICAgY29uc3QgbjMgPSBob3ZlckNvbG9yLmxlbmd0aDsKICAgIGNvbnN0IGNvbG9ycyA9IFtdOwogICAgaWYgKG4gPT09IG4yICYmIG4yID09PSBuMykgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICAgIGNvbG9ycy5wdXNoKAogICAgICAgICAgYmFzZUNvbG9yW2ldLAogICAgICAgICAgYWN0aXZlQ29sb3JbaV0sCiAgICAgICAgICBob3ZlckNvbG9yW2ldLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yCiAgICAgICAgKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICBjb25zdCByZ2JhT3BhcXVlID0gWwogICAgICAgICAgYmFzZUNvbG9yW2ldWzBdLAogICAgICAgICAgYmFzZUNvbG9yW2ldWzFdLAogICAgICAgICAgYmFzZUNvbG9yW2ldWzJdLAogICAgICAgICAgMQogICAgICAgIF07CiAgICAgICAgY29uc3QgY29sb3JBY3RpdmUgPSBjb2xvckJ5ID09PSBERUZBVUxUX0NPTE9SX0JZID8gYWN0aXZlQ29sb3JbMF0gOiByZ2JhT3BhcXVlOwogICAgICAgIGNvbnN0IGNvbG9ySG92ZXIgPSBjb2xvckJ5ID09PSBERUZBVUxUX0NPTE9SX0JZID8gaG92ZXJDb2xvclswXSA6IHJnYmFPcGFxdWU7CiAgICAgICAgY29sb3JzLnB1c2goYmFzZUNvbG9yW2ldLCBjb2xvckFjdGl2ZSwgY29sb3JIb3ZlciwgYmFja2dyb3VuZENvbG9yKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvbG9yczsKICB9OwogIGNvbnN0IGNyZWF0ZUNvbG9yVGV4dHVyZSA9ICgpID0+IHsKICAgIGNvbnN0IGNvbG9ycyA9IGdldENvbG9ycygpOwogICAgY29uc3QgbnVtQ29sb3JzID0gY29sb3JzLmxlbmd0aDsKICAgIGNvbG9yVGV4UmVzID0gTWF0aC5tYXgoMiwgTWF0aC5jZWlsKE1hdGguc3FydChudW1Db2xvcnMpKSk7CiAgICBjb25zdCByZ2JhMiA9IG5ldyBGbG9hdDMyQXJyYXkoY29sb3JUZXhSZXMgKiogMiAqIDQpOwogICAgY29sb3JzLmZvckVhY2goKGNvbG9yMiwgaSkgPT4gewogICAgICByZ2JhMltpICogNF0gPSBjb2xvcjJbMF07CiAgICAgIHJnYmEyW2kgKiA0ICsgMV0gPSBjb2xvcjJbMV07CiAgICAgIHJnYmEyW2kgKiA0ICsgMl0gPSBjb2xvcjJbMl07CiAgICAgIHJnYmEyW2kgKiA0ICsgM10gPSBjb2xvcjJbM107CiAgICB9KTsKICAgIHJldHVybiByZW5kZXJlci5yZWdsLnRleHR1cmUoewogICAgICBkYXRhOiByZ2JhMiwKICAgICAgc2hhcGU6IFtjb2xvclRleFJlcywgY29sb3JUZXhSZXMsIDRdLAogICAgICB0eXBlOiAiZmxvYXQiCiAgICB9KTsKICB9OwogIGNvbnN0IHVwZGF0ZVByb2plY3Rpb25NYXRyaXggPSAod2lkdGhSYXRpbywgaGVpZ2h0UmF0aW8pID0+IHsKICAgIHByb2plY3Rpb25bMF0gPSB3aWR0aFJhdGlvIC8gdmlld0FzcGVjdFJhdGlvOwogICAgcHJvamVjdGlvbls1XSA9IGhlaWdodFJhdGlvOwogIH07CiAgY29uc3QgdXBkYXRlVmlld0FzcGVjdFJhdGlvID0gKCkgPT4gewogICAgdmlld0FzcGVjdFJhdGlvID0gY3VycmVudFdpZHRoIC8gY3VycmVudEhlaWdodDsKICAgIHByb2plY3Rpb25Mb2NhbCA9IGZyb21TY2FsaW5nKFtdLCBbMSAvIHZpZXdBc3BlY3RSYXRpbywgMSwgMV0pOwogICAgcHJvamVjdGlvbiA9IGZyb21TY2FsaW5nKFtdLCBbMSAvIHZpZXdBc3BlY3RSYXRpbywgMSwgMV0pOwogICAgbW9kZWwgPSBmcm9tU2NhbGluZyhbXSwgW2RhdGFBc3BlY3RSYXRpbywgMSwgMV0pOwogIH07CiAgY29uc3Qgc2V0RGF0YUFzcGVjdFJhdGlvID0gKG5ld0RhdGFBc3BlY3RSYXRpbykgPT4gewogICAgaWYgKCtuZXdEYXRhQXNwZWN0UmF0aW8gPD0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBkYXRhQXNwZWN0UmF0aW8gPSBuZXdEYXRhQXNwZWN0UmF0aW87CiAgfTsKICBjb25zdCBzZXRDb2xvcnMgPSAoZ2V0dGVyLCBzZXR0ZXIpID0+IChuZXdDb2xvcnMpID0+IHsKICAgIGlmICghbmV3Q29sb3JzIHx8IG5ld0NvbG9ycy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY29sb3JzID0gZ2V0dGVyKCk7CiAgICBjb25zdCBwcmV2Q29sb3JzID0gWy4uLmNvbG9yc107CiAgICBsZXQgdG1wQ29sb3JzID0gaXNNdWx0aXBsZUNvbG9ycyhuZXdDb2xvcnMpID8gbmV3Q29sb3JzIDogW25ld0NvbG9yc107CiAgICB0bXBDb2xvcnMgPSB0bXBDb2xvcnMubWFwKChjb2xvcjIpID0+IHRvUmdiYShjb2xvcjIsIHRydWUpKTsKICAgIGlmIChpc1NhbWVSZ2JhcyhwcmV2Q29sb3JzLCB0bXBDb2xvcnMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChjb2xvclRleCkgewogICAgICBjb2xvclRleC5kZXN0cm95KCk7CiAgICB9CiAgICB0cnkgewogICAgICBzZXR0ZXIodG1wQ29sb3JzKTsKICAgICAgY29sb3JUZXggPSBjcmVhdGVDb2xvclRleHR1cmUoKTsKICAgIH0gY2F0Y2ggKF9lcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJJbnZhbGlkIGNvbG9ycy4gU3dpdGNoaW5nIGJhY2sgdG8gZGVmYXVsdCBjb2xvcnMuIik7CiAgICAgIHNldHRlcihwcmV2Q29sb3JzKTsKICAgICAgY29sb3JUZXggPSBjcmVhdGVDb2xvclRleHR1cmUoKTsKICAgIH0KICB9OwogIGNvbnN0IHNldFBvaW50Q29sb3IgPSBzZXRDb2xvcnMoCiAgICAoKSA9PiBwb2ludENvbG9yLAogICAgKGNvbG9ycykgPT4gewogICAgICBwb2ludENvbG9yID0gY29sb3JzOwogICAgfQogICk7CiAgY29uc3Qgc2V0UG9pbnRDb2xvckFjdGl2ZSA9IHNldENvbG9ycygKICAgICgpID0+IHBvaW50Q29sb3JBY3RpdmUsCiAgICAoY29sb3JzKSA9PiB7CiAgICAgIHBvaW50Q29sb3JBY3RpdmUgPSBjb2xvcnM7CiAgICB9CiAgKTsKICBjb25zdCBzZXRQb2ludENvbG9ySG92ZXIgPSBzZXRDb2xvcnMoCiAgICAoKSA9PiBwb2ludENvbG9ySG92ZXIsCiAgICAoY29sb3JzKSA9PiB7CiAgICAgIHBvaW50Q29sb3JIb3ZlciA9IGNvbG9yczsKICAgIH0KICApOwogIGNvbnN0IGNvbXB1dGVEb21haW5WaWV3ID0gKCkgPT4gewogICAgY29uc3QgeHlTdGFydFB0ID0gZ2V0U2NhdHRlckdsUG9zKC0xLCAtMSk7CiAgICBjb25zdCB4eUVuZFB0ID0gZ2V0U2NhdHRlckdsUG9zKDEsIDEpOwogICAgY29uc3QgeFN0YXJ0ID0gKHh5U3RhcnRQdFswXSArIDEpIC8gMjsKICAgIGNvbnN0IHhFbmQgPSAoeHlFbmRQdFswXSArIDEpIC8gMjsKICAgIGNvbnN0IHlTdGFydCA9ICh4eVN0YXJ0UHRbMV0gKyAxKSAvIDI7CiAgICBjb25zdCB5RW5kID0gKHh5RW5kUHRbMV0gKyAxKSAvIDI7CiAgICBjb25zdCB4RG9tYWluVmlldyA9IFsKICAgICAgeERvbWFpblN0YXJ0ICsgeFN0YXJ0ICogeERvbWFpblNpemUsCiAgICAgIHhEb21haW5TdGFydCArIHhFbmQgKiB4RG9tYWluU2l6ZQogICAgXTsKICAgIGNvbnN0IHlEb21haW5WaWV3ID0gWwogICAgICB5RG9tYWluU3RhcnQgKyB5U3RhcnQgKiB5RG9tYWluU2l6ZSwKICAgICAgeURvbWFpblN0YXJ0ICsgeUVuZCAqIHlEb21haW5TaXplCiAgICBdOwogICAgcmV0dXJuIFt4RG9tYWluVmlldywgeURvbWFpblZpZXddOwogIH07CiAgY29uc3QgdXBkYXRlU2NhbGVzID0gKCkgPT4gewogICAgaWYgKCEoeFNjYWxlIHx8IHlTY2FsZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgW3hEb21haW5WaWV3LCB5RG9tYWluVmlld10gPSBjb21wdXRlRG9tYWluVmlldygpOwogICAgaWYgKHhTY2FsZSkgewogICAgICB4U2NhbGUuZG9tYWluKHhEb21haW5WaWV3KTsKICAgIH0KICAgIGlmICh5U2NhbGUpIHsKICAgICAgeVNjYWxlLmRvbWFpbih5RG9tYWluVmlldyk7CiAgICB9CiAgfTsKICBjb25zdCBzZXRDdXJyZW50SGVpZ2h0ID0gKG5ld0N1cnJlbnRIZWlnaHQsIHNraXBTY2FsZVVwZGF0ZXMpID0+IHsKICAgIGN1cnJlbnRIZWlnaHQgPSBNYXRoLm1heCgxLCBuZXdDdXJyZW50SGVpZ2h0KTsKICAgIGNhbnZhcy5oZWlnaHQgPSBNYXRoLmZsb29yKGN1cnJlbnRIZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7CiAgICBpZiAoeVNjYWxlKSB7CiAgICAgIHlTY2FsZS5yYW5nZShbY3VycmVudEhlaWdodCwgMF0pOwogICAgICBpZiAoIXNraXBTY2FsZVVwZGF0ZXMpIHsKICAgICAgICB1cGRhdGVTY2FsZXMoKTsKICAgICAgfQogICAgfQogIH07CiAgY29uc3Qgc2V0SGVpZ2h0ID0gKG5ld0hlaWdodCkgPT4gewogICAgaWYgKG5ld0hlaWdodCA9PT0gQVVUTykgewogICAgICBoZWlnaHQgPSBuZXdIZWlnaHQ7CiAgICAgIGNhbnZhcy5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICAgIGlmIChjYW52YXMpIHsKICAgICAgICAgIHNldEN1cnJlbnRIZWlnaHQoY2FudmFzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCErbmV3SGVpZ2h0IHx8ICtuZXdIZWlnaHQgPD0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBoZWlnaHQgPSArbmV3SGVpZ2h0OwogICAgc2V0Q3VycmVudEhlaWdodChoZWlnaHQpOwogICAgY2FudmFzLnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7CiAgfTsKICBjb25zdCBjb21wdXRlUG9pbnRTaXplTW91c2VEZXRlY3Rpb24gPSAoKSA9PiB7CiAgICBjb21wdXRlZFBvaW50U2l6ZU1vdXNlRGV0ZWN0aW9uID0gcG9pbnRTaXplTW91c2VEZXRlY3Rpb247CiAgICBpZiAocG9pbnRTaXplTW91c2VEZXRlY3Rpb24gPT09IEFVVE8pIHsKICAgICAgY29tcHV0ZWRQb2ludFNpemVNb3VzZURldGVjdGlvbiA9IEFycmF5LmlzQXJyYXkocG9pbnRTaXplKSA/IG1heCQxKHBvaW50U2l6ZSkgOiBwb2ludFNpemU7CiAgICB9CiAgfTsKICBjb25zdCBzZXRQb2ludFNpemUgPSAobmV3UG9pbnRTaXplKSA9PiB7CiAgICBjb25zdCBvbGRQb2ludFNpemUgPSBBcnJheS5pc0FycmF5KHBvaW50U2l6ZSkgPyBbLi4ucG9pbnRTaXplXSA6IHBvaW50U2l6ZTsKICAgIGlmIChpc0NvbmRpdGlvbmFsQXJyYXkobmV3UG9pbnRTaXplLCBpc1Bvc2l0aXZlTnVtYmVyLCB7IG1pbkxlbmd0aDogMSB9KSkgewogICAgICBwb2ludFNpemUgPSBbLi4ubmV3UG9pbnRTaXplXTsKICAgIH0gZWxzZSBpZiAoaXNTdHJpY3RseVBvc2l0aXZlTnVtYmVyKCtuZXdQb2ludFNpemUpKSB7CiAgICAgIHBvaW50U2l6ZSA9IFsrbmV3UG9pbnRTaXplXTsKICAgIH0KICAgIGlmIChvbGRQb2ludFNpemUgPT09IHBvaW50U2l6ZSB8fCBoYXNTYW1lRWxlbWVudHMob2xkUG9pbnRTaXplLCBwb2ludFNpemUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChlbmNvZGluZ1RleCkgewogICAgICBlbmNvZGluZ1RleC5kZXN0cm95KCk7CiAgICB9CiAgICBtaW5Qb2ludFNjYWxlID0gTUlOX1BPSU5UX1NJWkUgLyBwb2ludFNpemVbMF07CiAgICBlbmNvZGluZ1RleCA9IGNyZWF0ZUVuY29kaW5nVGV4dHVyZSgpOwogICAgY29tcHV0ZVBvaW50U2l6ZU1vdXNlRGV0ZWN0aW9uKCk7CiAgfTsKICBjb25zdCBzZXRQb2ludFNpemVTZWxlY3RlZCA9IChuZXdQb2ludFNpemVTZWxlY3RlZCkgPT4gewogICAgaWYgKCErbmV3UG9pbnRTaXplU2VsZWN0ZWQgfHwgK25ld1BvaW50U2l6ZVNlbGVjdGVkIDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBwb2ludFNpemVTZWxlY3RlZCA9ICtuZXdQb2ludFNpemVTZWxlY3RlZDsKICB9OwogIGNvbnN0IHNldFBvaW50T3V0bGluZVdpZHRoID0gKG5ld1BvaW50T3V0bGluZVdpZHRoKSA9PiB7CiAgICBpZiAoIStuZXdQb2ludE91dGxpbmVXaWR0aCB8fCArbmV3UG9pbnRPdXRsaW5lV2lkdGggPCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHBvaW50T3V0bGluZVdpZHRoID0gK25ld1BvaW50T3V0bGluZVdpZHRoOwogIH07CiAgY29uc3Qgc2V0Q3VycmVudFdpZHRoID0gKG5ld0N1cnJlbnRXaWR0aCwgc2tpcFNjYWxlVXBkYXRlcykgPT4gewogICAgY3VycmVudFdpZHRoID0gTWF0aC5tYXgoMSwgbmV3Q3VycmVudFdpZHRoKTsKICAgIGNhbnZhcy53aWR0aCA9IE1hdGguZmxvb3IoY3VycmVudFdpZHRoICogd2luZG93LmRldmljZVBpeGVsUmF0aW8pOwogICAgaWYgKHhTY2FsZSkgewogICAgICB4U2NhbGUucmFuZ2UoWzAsIGN1cnJlbnRXaWR0aF0pOwogICAgICBpZiAoIXNraXBTY2FsZVVwZGF0ZXMpIHsKICAgICAgICB1cGRhdGVTY2FsZXMoKTsKICAgICAgfQogICAgfQogIH07CiAgY29uc3Qgc2V0V2lkdGggPSAobmV3V2lkdGgpID0+IHsKICAgIGlmIChuZXdXaWR0aCA9PT0gQVVUTykgewogICAgICB3aWR0aCA9IG5ld1dpZHRoOwogICAgICBjYW52YXMuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICAgIGlmIChjYW52YXMpIHsKICAgICAgICAgIHNldEN1cnJlbnRXaWR0aChjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghK25ld1dpZHRoIHx8ICtuZXdXaWR0aCA8PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHdpZHRoID0gK25ld1dpZHRoOwogICAgc2V0Q3VycmVudFdpZHRoKHdpZHRoKTsKICAgIGNhbnZhcy5zdHlsZS53aWR0aCA9IGAke2N1cnJlbnRXaWR0aH1weGA7CiAgfTsKICBjb25zdCBzZXRPcGFjaXR5ID0gKG5ld09wYWNpdHkpID0+IHsKICAgIGNvbnN0IG9sZE9wYWNpdHkgPSBBcnJheS5pc0FycmF5KG9wYWNpdHkpID8gWy4uLm9wYWNpdHldIDogb3BhY2l0eTsKICAgIGlmIChpc0NvbmRpdGlvbmFsQXJyYXkobmV3T3BhY2l0eSwgaXNQb3NpdGl2ZU51bWJlciwgeyBtaW5MZW5ndGg6IDEgfSkpIHsKICAgICAgb3BhY2l0eSA9IFsuLi5uZXdPcGFjaXR5XTsKICAgIH0gZWxzZSBpZiAoaXNTdHJpY3RseVBvc2l0aXZlTnVtYmVyKCtuZXdPcGFjaXR5KSkgewogICAgICBvcGFjaXR5ID0gWytuZXdPcGFjaXR5XTsKICAgIH0KICAgIGlmIChvbGRPcGFjaXR5ID09PSBvcGFjaXR5IHx8IGhhc1NhbWVFbGVtZW50cyhvbGRPcGFjaXR5LCBvcGFjaXR5KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZW5jb2RpbmdUZXgpIHsKICAgICAgZW5jb2RpbmdUZXguZGVzdHJveSgpOwogICAgfQogICAgZW5jb2RpbmdUZXggPSBjcmVhdGVFbmNvZGluZ1RleHR1cmUoKTsKICB9OwogIGNvbnN0IGdldEVuY29kaW5nRGF0YVR5cGUgPSAodHlwZSkgPT4gewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgInZhbHVlWiI6CiAgICAgICAgcmV0dXJuIHZhbHVlWkRhdGFUeXBlOwogICAgICBjYXNlICJ2YWx1ZVciOgogICAgICAgIHJldHVybiB2YWx1ZVdEYXRhVHlwZTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwogIGNvbnN0IGdldEVuY29kaW5nVmFsdWVUb0lkeCA9ICh0eXBlLCByYW5nZVZhbHVlcykgPT4gewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgQ09OVElOVU9VUzoKICAgICAgICByZXR1cm4gKHZhbHVlKSA9PiBNYXRoLnJvdW5kKHZhbHVlICogKHJhbmdlVmFsdWVzLmxlbmd0aCAtIDEpKTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gaWRlbnRpdHk7CiAgICB9CiAgfTsKICBjb25zdCBzZXRDb2xvckJ5ID0gKHR5cGUpID0+IHsKICAgIGNvbG9yQnkgPSBnZXRFbmNvZGluZ1R5cGUodHlwZSwgREVGQVVMVF9DT0xPUl9CWSk7CiAgfTsKICBjb25zdCBzZXRPcGFjaXR5QnkgPSAodHlwZSkgPT4gewogICAgb3BhY2l0eUJ5ID0gZ2V0RW5jb2RpbmdUeXBlKHR5cGUsIERFRkFVTFRfT1BBQ0lUWV9CWSwgewogICAgICBhbGxvd0RlbnNpdHk6IHRydWUKICAgIH0pOwogIH07CiAgY29uc3Qgc2V0U2l6ZUJ5ID0gKHR5cGUpID0+IHsKICAgIHNpemVCeSA9IGdldEVuY29kaW5nVHlwZSh0eXBlLCBERUZBVUxUX1NJWkVfQlkpOwogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JCeSA9ICh0eXBlKSA9PiB7CiAgICBwb2ludENvbm5lY3Rpb25Db2xvckJ5ID0gZ2V0RW5jb2RpbmdUeXBlKAogICAgICB0eXBlLAogICAgICBERUZBVUxUX1BPSU5UX0NPTk5FQ1RJT05fQ09MT1JfQlksCiAgICAgIHsgYWxsb3dTZWdtZW50OiB0cnVlLCBhbGxvd0luaGVyaXQ6IHRydWUgfQogICAgKTsKICB9OwogIGNvbnN0IHNldFBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeSA9ICh0eXBlKSA9PiB7CiAgICBwb2ludENvbm5lY3Rpb25PcGFjaXR5QnkgPSBnZXRFbmNvZGluZ1R5cGUoCiAgICAgIHR5cGUsCiAgICAgIERFRkFVTFRfUE9JTlRfQ09OTkVDVElPTl9PUEFDSVRZX0JZLAogICAgICB7IGFsbG93U2VnbWVudDogdHJ1ZSB9CiAgICApOwogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uU2l6ZUJ5ID0gKHR5cGUpID0+IHsKICAgIHBvaW50Q29ubmVjdGlvblNpemVCeSA9IGdldEVuY29kaW5nVHlwZSgKICAgICAgdHlwZSwKICAgICAgREVGQVVMVF9QT0lOVF9DT05ORUNUSU9OX1NJWkVfQlksCiAgICAgIHsgYWxsb3dTZWdtZW50OiB0cnVlIH0KICAgICk7CiAgfTsKICBjb25zdCBnZXRBbnRpQWxpYXNpbmcgPSAoKSA9PiBhbnRpQWxpYXNpbmc7CiAgY29uc3QgZ2V0UmVzb2x1dGlvbiA9ICgpID0+IFtjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHRdOwogIGNvbnN0IGdldEJhY2tncm91bmRJbWFnZSA9ICgpID0+IGJhY2tncm91bmRJbWFnZTsKICBjb25zdCBnZXRDb2xvclRleCA9ICgpID0+IGNvbG9yVGV4OwogIGNvbnN0IGdldENvbG9yVGV4UmVzID0gKCkgPT4gY29sb3JUZXhSZXM7CiAgY29uc3QgZ2V0Q29sb3JUZXhFcHMgPSAoKSA9PiAwLjUgLyBjb2xvclRleFJlczsKICBjb25zdCBnZXREZXZpY2VQaXhlbFJhdGlvID0gKCkgPT4gd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgY29uc3QgZ2V0Tm9ybWFsUG9pbnRzSW5kZXhCdWZmZXIgPSAoKSA9PiBub3JtYWxQb2ludHNJbmRleEJ1ZmZlcjsKICBjb25zdCBnZXRTZWxlY3RlZFBvaW50c0luZGV4QnVmZmVyID0gKCkgPT4gc2VsZWN0ZWRQb2ludHNJbmRleEJ1ZmZlcjsKICBjb25zdCBnZXRFbmNvZGluZ1RleCA9ICgpID0+IGVuY29kaW5nVGV4OwogIGNvbnN0IGdldEVuY29kaW5nVGV4UmVzID0gKCkgPT4gZW5jb2RpbmdUZXhSZXM7CiAgY29uc3QgZ2V0RW5jb2RpbmdUZXhFcHMgPSAoKSA9PiAwLjUgLyBlbmNvZGluZ1RleFJlczsKICBjb25zdCBnZXROb3JtYWxQb2ludFNpemVFeHRyYSA9ICgpID0+IDA7CiAgY29uc3QgZ2V0U3RhdGVUZXggPSAoKSA9PiB0bXBTdGF0ZVRleCB8fCBzdGF0ZVRleDsKICBjb25zdCBnZXRTdGF0ZVRleFJlcyA9ICgpID0+IHN0YXRlVGV4UmVzOwogIGNvbnN0IGdldFN0YXRlVGV4RXBzID0gKCkgPT4gMC41IC8gc3RhdGVUZXhSZXM7CiAgY29uc3QgZ2V0UHJvamVjdGlvbiA9ICgpID0+IHByb2plY3Rpb247CiAgY29uc3QgZ2V0VmlldyA9ICgpID0+IGNhbWVyYS52aWV3OwogIGNvbnN0IGdldE1vZGVsID0gKCkgPT4gbW9kZWw7CiAgY29uc3QgZ2V0TW9kZWxWaWV3UHJvamVjdGlvbiA9ICgpID0+IG11bHRpcGx5KHB2bSwgcHJvamVjdGlvbiwgbXVsdGlwbHkocHZtLCBjYW1lcmEudmlldywgbW9kZWwpKTsKICBjb25zdCBnZXRDb25zdGFudFBvaW50U2NhbGUgPSAoKSA9PiB7CiAgICByZXR1cm4gd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgfTsKICBjb25zdCBnZXRMaW5lYXJQb2ludFNjYWxlID0gKCkgPT4gewogICAgcmV0dXJuIG1heDIobWluUG9pbnRTY2FsZSwgY2FtZXJhLnNjYWxpbmdbMF0pICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgfTsKICBjb25zdCBnZXRBc2luaFBvaW50U2NhbGUgPSAoKSA9PiB7CiAgICBpZiAoY2FtZXJhLnNjYWxpbmdbMF0gPiAxKSB7CiAgICAgIHJldHVybiBNYXRoLmFzaW5oKG1heDIoMSwgY2FtZXJhLnNjYWxpbmdbMF0pKSAvIE1hdGguYXNpbmgoMSkgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbzsKICAgIH0KICAgIHJldHVybiBtYXgyKG1pblBvaW50U2NhbGUsIGNhbWVyYS5zY2FsaW5nWzBdKSAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogIH07CiAgbGV0IGdldFBvaW50U2NhbGUgPSBnZXRBc2luaFBvaW50U2NhbGU7CiAgaWYgKHBvaW50U2NhbGVNb2RlID09PSAibGluZWFyIikgewogICAgZ2V0UG9pbnRTY2FsZSA9IGdldExpbmVhclBvaW50U2NhbGU7CiAgfSBlbHNlIGlmIChwb2ludFNjYWxlTW9kZSA9PT0gImNvbnN0YW50IikgewogICAgZ2V0UG9pbnRTY2FsZSA9IGdldENvbnN0YW50UG9pbnRTY2FsZTsKICB9CiAgY29uc3QgZ2V0Tm9ybWFsTnVtUG9pbnRzID0gKCkgPT4gaXNQb2ludHNGaWx0ZXJlZCA/IGZpbHRlcmVkUG9pbnRzU2V0LnNpemUgOiBudW1Qb2ludHM7CiAgY29uc3QgZ2V0U2VsZWN0ZWROdW1Qb2ludHMgPSAoKSA9PiBzZWxlY3RlZFBvaW50cy5sZW5ndGg7CiAgY29uc3QgZ2V0UG9pbnRPcGFjaXR5TWF4QmFzZSA9ICgpID0+IGdldFNlbGVjdGVkTnVtUG9pbnRzKCkgPiAwID8gb3BhY2l0eUluYWN0aXZlTWF4IDogMTsKICBjb25zdCBnZXRQb2ludE9wYWNpdHlTY2FsZUJhc2UgPSAoKSA9PiBnZXRTZWxlY3RlZE51bVBvaW50cygpID4gMCA/IG9wYWNpdHlJbmFjdGl2ZVNjYWxlIDogMTsKICBjb25zdCBnZXRJc0NvbG9yZWRCeVogPSAoKSA9PiArKGNvbG9yQnkgPT09ICJ2YWx1ZVoiKTsKICBjb25zdCBnZXRJc0NvbG9yZWRCeVcgPSAoKSA9PiArKGNvbG9yQnkgPT09ICJ2YWx1ZVciKTsKICBjb25zdCBnZXRJc09wYWNpdHlCeVogPSAoKSA9PiArKG9wYWNpdHlCeSA9PT0gInZhbHVlWiIpOwogIGNvbnN0IGdldElzT3BhY2l0eUJ5VyA9ICgpID0+ICsob3BhY2l0eUJ5ID09PSAidmFsdWVXIik7CiAgY29uc3QgZ2V0SXNPcGFjaXR5QnlEZW5zaXR5ID0gKCkgPT4gKyhvcGFjaXR5QnkgPT09ICJkZW5zaXR5Iik7CiAgY29uc3QgZ2V0SXNTaXplZEJ5WiA9ICgpID0+ICsoc2l6ZUJ5ID09PSAidmFsdWVaIik7CiAgY29uc3QgZ2V0SXNTaXplZEJ5VyA9ICgpID0+ICsoc2l6ZUJ5ID09PSAidmFsdWVXIik7CiAgY29uc3QgZ2V0SXNQaXhlbEFsaWduZWQgPSAoKSA9PiArcGl4ZWxBbGlnbmVkOwogIGNvbnN0IGdldENvbG9yTXVsdGlwbGljYXRvciA9ICgpID0+IHsKICAgIGlmIChjb2xvckJ5ID09PSAidmFsdWVaIikgewogICAgICByZXR1cm4gdmFsdWVaRGF0YVR5cGUgPT09IENPTlRJTlVPVVMgPyBwb2ludENvbG9yLmxlbmd0aCAtIDEgOiAxOwogICAgfQogICAgcmV0dXJuIHZhbHVlV0RhdGFUeXBlID09PSBDT05USU5VT1VTID8gcG9pbnRDb2xvci5sZW5ndGggLSAxIDogMTsKICB9OwogIGNvbnN0IGdldE9wYWNpdHlNdWx0aXBsaWNhdG9yID0gKCkgPT4gewogICAgaWYgKG9wYWNpdHlCeSA9PT0gInZhbHVlWiIpIHsKICAgICAgcmV0dXJuIHZhbHVlWkRhdGFUeXBlID09PSBDT05USU5VT1VTID8gb3BhY2l0eS5sZW5ndGggLSAxIDogMTsKICAgIH0KICAgIHJldHVybiB2YWx1ZVdEYXRhVHlwZSA9PT0gQ09OVElOVU9VUyA/IG9wYWNpdHkubGVuZ3RoIC0gMSA6IDE7CiAgfTsKICBjb25zdCBnZXRTaXplTXVsdGlwbGljYXRvciA9ICgpID0+IHsKICAgIGlmIChzaXplQnkgPT09ICJ2YWx1ZVoiKSB7CiAgICAgIHJldHVybiB2YWx1ZVpEYXRhVHlwZSA9PT0gQ09OVElOVU9VUyA/IHBvaW50U2l6ZS5sZW5ndGggLSAxIDogMTsKICAgIH0KICAgIHJldHVybiB2YWx1ZVdEYXRhVHlwZSA9PT0gQ09OVElOVU9VUyA/IHBvaW50U2l6ZS5sZW5ndGggLSAxIDogMTsKICB9OwogIGNvbnN0IGdldE9wYWNpdHlEZW5zaXR5ID0gKGNvbnRleHQpID0+IHsKICAgIGlmIChvcGFjaXR5QnkgIT09ICJkZW5zaXR5IikgewogICAgICByZXR1cm4gMTsKICAgIH0KICAgIGNvbnN0IHBvaW50U2NhbGUgPSBnZXRQb2ludFNjYWxlKCk7CiAgICBjb25zdCBwID0gcG9pbnRTaXplWzBdICogcG9pbnRTY2FsZTsKICAgIGNvbnN0IHMgPSAyIC8gKDIgLyBjYW1lcmEudmlld1swXSkgKiAoMiAvICgyIC8gY2FtZXJhLnZpZXdbNV0pKTsKICAgIGNvbnN0IEggPSBjb250ZXh0LnZpZXdwb3J0SGVpZ2h0OwogICAgY29uc3QgVyA9IGNvbnRleHQudmlld3BvcnRXaWR0aDsKICAgIGxldCBhbHBoYSA9IG9wYWNpdHlCeURlbnNpdHlGaWxsICogVyAqIEggLyAobnVtUG9pbnRzSW5WaWV3ICogcCAqIHApICogbWluMigxLCBzKTsKICAgIGFscGhhICo9IHJlbmRlclBvaW50c0FzU3F1YXJlcyA/IDEgOiAxIC8gKDAuMjUgKiBNYXRoLlBJKTsKICAgIGNvbnN0IGNsYW1wZWRQb2ludERldmljZVNpemUgPSBtYXgyKE1JTl9QT0lOVF9TSVpFLCBwKSArIDAuNTsKICAgIGFscGhhICo9IChwIC8gY2xhbXBlZFBvaW50RGV2aWNlU2l6ZSkgKiogMjsKICAgIHJldHVybiBtaW4yKDEsIG1heDIoMCwgYWxwaGEpKTsKICB9OwogIGNvbnN0IHVwZGF0ZVBvaW50cyA9IHJlbmRlcmVyLnJlZ2woewogICAgZnJhbWVidWZmZXI6ICgpID0+IHRtcFN0YXRlQnVmZmVyLAogICAgdmVydDogU0hBREVSLAogICAgZnJhZzogU0hBREVSJDEsCiAgICBhdHRyaWJ1dGVzOiB7CiAgICAgIHBvc2l0aW9uOiBbLTQsIDAsIDQsIDQsIDQsIC00XQogICAgfSwKICAgIHVuaWZvcm1zOiB7CiAgICAgIHN0YXJ0U3RhdGVUZXg6ICgpID0+IHByZXZTdGF0ZVRleCwKICAgICAgZW5kU3RhdGVUZXg6ICgpID0+IHN0YXRlVGV4LAogICAgICB0OiAoX2N0eCwgcHJvcHMpID0+IHByb3BzLnQKICAgIH0sCiAgICBjb3VudDogMwogIH0pOwogIGNvbnN0IGRyYXdQb2ludHMgPSAoZ2V0UG9pbnRTaXplRXh0cmEsIGdldE51bVBvaW50cywgZ2V0U3RhdGVJbmRleEJ1ZmZlciwgZ2xvYmFsU3RhdGUgPSBDT0xPUl9OT1JNQUxfSURYLCBnZXRQb2ludE9wYWNpdHlNYXggPSBnZXRQb2ludE9wYWNpdHlNYXhCYXNlLCBnZXRQb2ludE9wYWNpdHlTY2FsZSA9IGdldFBvaW50T3BhY2l0eVNjYWxlQmFzZSkgPT4gcmVuZGVyZXIucmVnbCh7CiAgICBmcmFnOiByZW5kZXJQb2ludHNBc1NxdWFyZXMgPyBGUkFHTUVOVF9TSEFERVIkMSA6IEZSQUdNRU5UX1NIQURFUiwKICAgIHZlcnQ6IGNyZWF0ZVZlcnRleFNoYWRlcihnbG9iYWxTdGF0ZSksCiAgICBibGVuZDogewogICAgICBlbmFibGU6ICFkaXNhYmxlQWxwaGFCbGVuZGluZywKICAgICAgZnVuYzogewogICAgICAgIC8vIGJpb21lLWlnbm9yZSBsaW50L3N0eWxlL3VzZU5hbWluZ0NvbnZlbnRpb246IFJlZ2wgc3BlY2lmaWMKICAgICAgICBzcmNSR0I6ICJzcmMgYWxwaGEiLAogICAgICAgIHNyY0FscGhhOiAib25lIiwKICAgICAgICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBSZWdsIHNwZWNpZmljCiAgICAgICAgZHN0UkdCOiAib25lIG1pbnVzIHNyYyBhbHBoYSIsCiAgICAgICAgZHN0QWxwaGE6ICJvbmUgbWludXMgc3JjIGFscGhhIgogICAgICB9CiAgICB9LAogICAgZGVwdGg6IHsgZW5hYmxlOiBmYWxzZSB9LAogICAgYXR0cmlidXRlczogewogICAgICBzdGF0ZUluZGV4OiB7CiAgICAgICAgYnVmZmVyOiBnZXRTdGF0ZUluZGV4QnVmZmVyLAogICAgICAgIHNpemU6IDIKICAgICAgfQogICAgfSwKICAgIHVuaWZvcm1zOiB7CiAgICAgIGFudGlBbGlhc2luZzogZ2V0QW50aUFsaWFzaW5nLAogICAgICByZXNvbHV0aW9uOiBnZXRSZXNvbHV0aW9uLAogICAgICBtb2RlbFZpZXdQcm9qZWN0aW9uOiBnZXRNb2RlbFZpZXdQcm9qZWN0aW9uLAogICAgICBkZXZpY2VQaXhlbFJhdGlvOiBnZXREZXZpY2VQaXhlbFJhdGlvLAogICAgICBwb2ludFNjYWxlOiAoKSA9PiBnZXRQb2ludFNjYWxlKCksCiAgICAgIGVuY29kaW5nVGV4OiBnZXRFbmNvZGluZ1RleCwKICAgICAgZW5jb2RpbmdUZXhSZXM6IGdldEVuY29kaW5nVGV4UmVzLAogICAgICBlbmNvZGluZ1RleEVwczogZ2V0RW5jb2RpbmdUZXhFcHMsCiAgICAgIHBvaW50T3BhY2l0eU1heDogZ2V0UG9pbnRPcGFjaXR5TWF4LAogICAgICBwb2ludE9wYWNpdHlTY2FsZTogZ2V0UG9pbnRPcGFjaXR5U2NhbGUsCiAgICAgIHBvaW50U2l6ZUV4dHJhOiBnZXRQb2ludFNpemVFeHRyYSwKICAgICAgZ2xvYmFsU3RhdGUsCiAgICAgIGNvbG9yVGV4OiBnZXRDb2xvclRleCwKICAgICAgY29sb3JUZXhSZXM6IGdldENvbG9yVGV4UmVzLAogICAgICBjb2xvclRleEVwczogZ2V0Q29sb3JUZXhFcHMsCiAgICAgIHN0YXRlVGV4OiBnZXRTdGF0ZVRleCwKICAgICAgc3RhdGVUZXhSZXM6IGdldFN0YXRlVGV4UmVzLAogICAgICBzdGF0ZVRleEVwczogZ2V0U3RhdGVUZXhFcHMsCiAgICAgIGlzQ29sb3JlZEJ5WjogZ2V0SXNDb2xvcmVkQnlaLAogICAgICBpc0NvbG9yZWRCeVc6IGdldElzQ29sb3JlZEJ5VywKICAgICAgaXNPcGFjaXR5QnlaOiBnZXRJc09wYWNpdHlCeVosCiAgICAgIGlzT3BhY2l0eUJ5VzogZ2V0SXNPcGFjaXR5QnlXLAogICAgICBpc09wYWNpdHlCeURlbnNpdHk6IGdldElzT3BhY2l0eUJ5RGVuc2l0eSwKICAgICAgaXNTaXplZEJ5WjogZ2V0SXNTaXplZEJ5WiwKICAgICAgaXNTaXplZEJ5VzogZ2V0SXNTaXplZEJ5VywKICAgICAgaXNQaXhlbEFsaWduZWQ6IGdldElzUGl4ZWxBbGlnbmVkLAogICAgICBjb2xvck11bHRpcGxpY2F0b3I6IGdldENvbG9yTXVsdGlwbGljYXRvciwKICAgICAgb3BhY2l0eU11bHRpcGxpY2F0b3I6IGdldE9wYWNpdHlNdWx0aXBsaWNhdG9yLAogICAgICBvcGFjaXR5RGVuc2l0eTogZ2V0T3BhY2l0eURlbnNpdHksCiAgICAgIHNpemVNdWx0aXBsaWNhdG9yOiBnZXRTaXplTXVsdGlwbGljYXRvciwKICAgICAgbnVtQ29sb3JTdGF0ZXM6IENPTE9SX05VTV9TVEFURVMsCiAgICAgIGRyYXdpbmdCdWZmZXJXaWR0aDogKGNvbnRleHQpID0+IGNvbnRleHQuZHJhd2luZ0J1ZmZlcldpZHRoLAogICAgICBkcmF3aW5nQnVmZmVySGVpZ2h0OiAoY29udGV4dCkgPT4gY29udGV4dC5kcmF3aW5nQnVmZmVySGVpZ2h0CiAgICB9LAogICAgY291bnQ6IGdldE51bVBvaW50cywKICAgIHByaW1pdGl2ZTogInBvaW50cyIKICB9KTsKICBjb25zdCBkcmF3UG9pbnRCb2RpZXMgPSBkcmF3UG9pbnRzKAogICAgZ2V0Tm9ybWFsUG9pbnRTaXplRXh0cmEsCiAgICBnZXROb3JtYWxOdW1Qb2ludHMsCiAgICBnZXROb3JtYWxQb2ludHNJbmRleEJ1ZmZlcgogICk7CiAgY29uc3QgZHJhd0hvdmVyZWRQb2ludCA9IGRyYXdQb2ludHMoCiAgICBnZXROb3JtYWxQb2ludFNpemVFeHRyYSwKICAgICgpID0+IDEsCiAgICAoKSA9PiBob3ZlcmVkUG9pbnRJbmRleEJ1ZmZlciwKICAgIENPTE9SX0hPVkVSX0lEWCwKICAgICgpID0+IDEsCiAgICAoKSA9PiAxCiAgKTsKICBjb25zdCBkcmF3U2VsZWN0ZWRQb2ludE91dGxpbmVzID0gZHJhd1BvaW50cygKICAgICgpID0+IChwb2ludFNpemVTZWxlY3RlZCArIHBvaW50T3V0bGluZVdpZHRoICogMikgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbywKICAgIGdldFNlbGVjdGVkTnVtUG9pbnRzLAogICAgZ2V0U2VsZWN0ZWRQb2ludHNJbmRleEJ1ZmZlciwKICAgIENPTE9SX0FDVElWRV9JRFgsCiAgICAoKSA9PiAxLAogICAgKCkgPT4gMQogICk7CiAgY29uc3QgZHJhd1NlbGVjdGVkUG9pbnRJbm5lckJvcmRlciA9IGRyYXdQb2ludHMoCiAgICAoKSA9PiAocG9pbnRTaXplU2VsZWN0ZWQgKyBwb2ludE91dGxpbmVXaWR0aCkgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbywKICAgIGdldFNlbGVjdGVkTnVtUG9pbnRzLAogICAgZ2V0U2VsZWN0ZWRQb2ludHNJbmRleEJ1ZmZlciwKICAgIENPTE9SX0JHX0lEWCwKICAgICgpID0+IDEsCiAgICAoKSA9PiAxCiAgKTsKICBjb25zdCBkcmF3U2VsZWN0ZWRQb2ludEJvZGllcyA9IGRyYXdQb2ludHMoCiAgICAoKSA9PiBwb2ludFNpemVTZWxlY3RlZCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvLAogICAgZ2V0U2VsZWN0ZWROdW1Qb2ludHMsCiAgICBnZXRTZWxlY3RlZFBvaW50c0luZGV4QnVmZmVyLAogICAgQ09MT1JfQUNUSVZFX0lEWCwKICAgICgpID0+IDEsCiAgICAoKSA9PiAxCiAgKTsKICBjb25zdCBkcmF3U2VsZWN0ZWRQb2ludHMgPSAoKSA9PiB7CiAgICBkcmF3U2VsZWN0ZWRQb2ludE91dGxpbmVzKCk7CiAgICBkcmF3U2VsZWN0ZWRQb2ludElubmVyQm9yZGVyKCk7CiAgICBkcmF3U2VsZWN0ZWRQb2ludEJvZGllcygpOwogIH07CiAgY29uc3QgZHJhd0JhY2tncm91bmRJbWFnZSA9IHJlbmRlcmVyLnJlZ2woewogICAgZnJhZzogRlJBR01FTlRfU0hBREVSJDIsCiAgICB2ZXJ0OiBWRVJURVhfU0hBREVSLAogICAgYXR0cmlidXRlczogewogICAgICBwb3NpdGlvbjogWzAsIDEsIDAsIDAsIDEsIDAsIDAsIDEsIDEsIDEsIDEsIDBdCiAgICB9LAogICAgdW5pZm9ybXM6IHsKICAgICAgbW9kZWxWaWV3UHJvamVjdGlvbjogZ2V0TW9kZWxWaWV3UHJvamVjdGlvbiwKICAgICAgdGV4dHVyZTogZ2V0QmFja2dyb3VuZEltYWdlCiAgICB9LAogICAgY291bnQ6IDYKICB9KTsKICBjb25zdCBkcmF3TGFzc29Qb2x5Z29uID0gcmVuZGVyZXIucmVnbCh7CiAgICB2ZXJ0OiBgCiAgICAgIHByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OwogICAgICB1bmlmb3JtIG1hdDQgbW9kZWxWaWV3UHJvamVjdGlvbjsKICAgICAgYXR0cmlidXRlIHZlYzIgcG9zaXRpb247CiAgICAgIHZvaWQgbWFpbiAoKSB7CiAgICAgICAgZ2xfUG9zaXRpb24gPSBtb2RlbFZpZXdQcm9qZWN0aW9uICogdmVjNChwb3NpdGlvbiwgMCwgMSk7CiAgICAgIH1gLAogICAgZnJhZzogYAogICAgICBwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsKICAgICAgdW5pZm9ybSB2ZWM0IGNvbG9yOwogICAgICB2b2lkIG1haW4gKCkgewogICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoY29sb3IucmdiLCAwLjIpOwogICAgICB9YCwKICAgIGRlcHRoOiB7IGVuYWJsZTogZmFsc2UgfSwKICAgIGJsZW5kOiB7CiAgICAgIGVuYWJsZTogdHJ1ZSwKICAgICAgZnVuYzogewogICAgICAgIC8vIGJpb21lLWlnbm9yZSBsaW50L3N0eWxlL3VzZU5hbWluZ0NvbnZlbnRpb246IFJlZ2wgc3BlY2lmaWMKICAgICAgICBzcmNSR0I6ICJzcmMgYWxwaGEiLAogICAgICAgIHNyY0FscGhhOiAib25lIiwKICAgICAgICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBSZWdsIHNwZWNpZmljCiAgICAgICAgZHN0UkdCOiAib25lIG1pbnVzIHNyYyBhbHBoYSIsCiAgICAgICAgZHN0QWxwaGE6ICJvbmUgbWludXMgc3JjIGFscGhhIgogICAgICB9CiAgICB9LAogICAgYXR0cmlidXRlczogewogICAgICBwb3NpdGlvbjogKCkgPT4gbGFzc29Qb2ludHNDdXJyCiAgICB9LAogICAgdW5pZm9ybXM6IHsKICAgICAgbW9kZWxWaWV3UHJvamVjdGlvbjogZ2V0TW9kZWxWaWV3UHJvamVjdGlvbiwKICAgICAgY29sb3I6ICgpID0+IGxhc3NvQ29sb3IKICAgIH0sCiAgICBlbGVtZW50czogKCkgPT4gZWFyY3V0KGxhc3NvLmdldFBvaW50cygpKQogIH0pOwogIGNvbnN0IGRyYXdSZXRpY2xlID0gKCkgPT4gewogICAgaWYgKCEoaG92ZXJlZFBvaW50ID49IDApKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IFt4LCB5XSA9IHBvaW50c1tob3ZlcmVkUG9pbnRdLnNsaWNlKDAsIDIpOwogICAgY29uc3QgdiA9IFt4LCB5LCAwLCAxXTsKICAgIG11bHRpcGx5KAogICAgICBzY3JhdGNoLAogICAgICBwcm9qZWN0aW9uLAogICAgICBtdWx0aXBseShzY3JhdGNoLCBjYW1lcmEudmlldywgbW9kZWwpCiAgICApOwogICAgdHJhbnNmb3JtTWF0NCh2LCB2LCBzY3JhdGNoKTsKICAgIHJldGljbGVITGluZS5zZXRQb2ludHMoWy0xLCB2WzFdLCAxLCB2WzFdXSk7CiAgICByZXRpY2xlVkxpbmUuc2V0UG9pbnRzKFt2WzBdLCAxLCB2WzBdLCAtMV0pOwogICAgcmV0aWNsZUhMaW5lLmRyYXcoKTsKICAgIHJldGljbGVWTGluZS5kcmF3KCk7CiAgICBkcmF3UG9pbnRzKAogICAgICAoKSA9PiAocG9pbnRTaXplU2VsZWN0ZWQgKyBwb2ludE91dGxpbmVXaWR0aCAqIDIpICogd2luZG93LmRldmljZVBpeGVsUmF0aW8sCiAgICAgICgpID0+IDEsCiAgICAgIGhvdmVyZWRQb2ludEluZGV4QnVmZmVyLAogICAgICBDT0xPUl9BQ1RJVkVfSURYCiAgICApKCk7CiAgICBkcmF3UG9pbnRzKAogICAgICAoKSA9PiAocG9pbnRTaXplU2VsZWN0ZWQgKyBwb2ludE91dGxpbmVXaWR0aCkgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbywKICAgICAgKCkgPT4gMSwKICAgICAgaG92ZXJlZFBvaW50SW5kZXhCdWZmZXIsCiAgICAgIENPTE9SX0JHX0lEWAogICAgKSgpOwogIH07CiAgY29uc3QgY3JlYXRlUG9pbnRJbmRleCA9IChudW1OZXdQb2ludHMpID0+IHsKICAgIGNvbnN0IGluZGV4ID0gbmV3IEZsb2F0MzJBcnJheShudW1OZXdQb2ludHMgKiAyKTsKICAgIGxldCBqID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtTmV3UG9pbnRzOyArK2kpIHsKICAgICAgY29uc3QgdGV4Q29vcmQgPSBpbmRleFRvU3RhdGVUZXhDb29yZChpKTsKICAgICAgaW5kZXhbal0gPSB0ZXhDb29yZFswXTsKICAgICAgaW5kZXhbaiArIDFdID0gdGV4Q29vcmRbMV07CiAgICAgIGogKz0gMjsKICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9OwogIGNvbnN0IGNyZWF0ZVN0YXRlVGV4dHVyZSA9IChuZXdQb2ludHMsIGRhdGFUeXBlcyA9IHt9KSA9PiB7CiAgICBjb25zdCBudW1OZXdQb2ludHMgPSBuZXdQb2ludHMubGVuZ3RoOwogICAgc3RhdGVUZXhSZXMgPSBNYXRoLm1heCgyLCBNYXRoLmNlaWwoTWF0aC5zcXJ0KG51bU5ld1BvaW50cykpKTsKICAgIHN0YXRlVGV4RXBzID0gMC41IC8gc3RhdGVUZXhSZXM7CiAgICBjb25zdCBkYXRhID0gbmV3IEZsb2F0MzJBcnJheShzdGF0ZVRleFJlcyAqKiAyICogNCk7CiAgICBsZXQgeklzSW50cyA9IHRydWU7CiAgICBsZXQgd0lzSW50cyA9IHRydWU7CiAgICBsZXQgayA9IDA7CiAgICBsZXQgeiA9IDA7CiAgICBsZXQgdyA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bU5ld1BvaW50czsgKytpKSB7CiAgICAgIGsgPSBpICogNDsKICAgICAgZGF0YVtrXSA9IG5ld1BvaW50c1tpXVswXTsKICAgICAgZGF0YVtrICsgMV0gPSBuZXdQb2ludHNbaV1bMV07CiAgICAgIHogPSBuZXdQb2ludHNbaV1bMl0gfHwgMDsKICAgICAgdyA9IG5ld1BvaW50c1tpXVszXSB8fCAwOwogICAgICBkYXRhW2sgKyAyXSA9IHo7CiAgICAgIGRhdGFbayArIDNdID0gdzsKICAgICAgeklzSW50cyAmJj0gTnVtYmVyLmlzSW50ZWdlcih6KTsKICAgICAgd0lzSW50cyAmJj0gTnVtYmVyLmlzSW50ZWdlcih3KTsKICAgIH0KICAgIGlmIChkYXRhVHlwZXMueiAmJiBWQUxVRV9aV19EQVRBX1RZUEVTLmluY2x1ZGVzKGRhdGFUeXBlcy56KSkgewogICAgICB2YWx1ZVpEYXRhVHlwZSA9IGRhdGFUeXBlcy56OwogICAgfSBlbHNlIHsKICAgICAgdmFsdWVaRGF0YVR5cGUgPSB6SXNJbnRzID8gQ0FURUdPUklDQUwgOiBDT05USU5VT1VTOwogICAgfQogICAgaWYgKGRhdGFUeXBlcy53ICYmIFZBTFVFX1pXX0RBVEFfVFlQRVMuaW5jbHVkZXMoZGF0YVR5cGVzLncpKSB7CiAgICAgIHZhbHVlV0RhdGFUeXBlID0gZGF0YVR5cGVzLnc7CiAgICB9IGVsc2UgewogICAgICB2YWx1ZVdEYXRhVHlwZSA9IHdJc0ludHMgPyBDQVRFR09SSUNBTCA6IENPTlRJTlVPVVM7CiAgICB9CiAgICByZXR1cm4gcmVuZGVyZXIucmVnbC50ZXh0dXJlKHsKICAgICAgZGF0YSwKICAgICAgc2hhcGU6IFtzdGF0ZVRleFJlcywgc3RhdGVUZXhSZXMsIDRdLAogICAgICB0eXBlOiAiZmxvYXQiCiAgICB9KTsKICB9OwogIGNvbnN0IGNhY2hlUG9pbnRzID0gKG5ld1BvaW50cywgZGF0YVR5cGVzID0ge30pID0+IHsKICAgIGlmICghc3RhdGVUZXgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKGlzVHJhbnNpdGlvbmluZykgewogICAgICBjb25zdCB0bXAgPSBwcmV2U3RhdGVUZXg7CiAgICAgIHByZXZTdGF0ZVRleCA9IHRtcFN0YXRlVGV4OwogICAgICB0bXAuZGVzdHJveSgpOwogICAgfSBlbHNlIHsKICAgICAgcHJldlN0YXRlVGV4ID0gc3RhdGVUZXg7CiAgICB9CiAgICB0bXBTdGF0ZVRleCA9IGNyZWF0ZVN0YXRlVGV4dHVyZShuZXdQb2ludHMsIGRhdGFUeXBlcyk7CiAgICB0bXBTdGF0ZUJ1ZmZlciA9IHJlbmRlcmVyLnJlZ2wuZnJhbWVidWZmZXIoewogICAgICBjb2xvcjogdG1wU3RhdGVUZXgsCiAgICAgIGRlcHRoOiBmYWxzZSwKICAgICAgc3RlbmNpbDogZmFsc2UKICAgIH0pOwogICAgc3RhdGVUZXggPSB2b2lkIDA7CiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIGNvbnN0IGhhc0NhY2hlZFBvaW50cyA9ICgpID0+IEJvb2xlYW4ocHJldlN0YXRlVGV4ICYmIHRtcFN0YXRlVGV4KTsKICBjb25zdCBjbGVhckNhY2hlZFBvaW50cyA9ICgpID0+IHsKICAgIGlmIChwcmV2U3RhdGVUZXgpIHsKICAgICAgcHJldlN0YXRlVGV4LmRlc3Ryb3koKTsKICAgICAgcHJldlN0YXRlVGV4ID0gdm9pZCAwOwogICAgfQogICAgaWYgKHRtcFN0YXRlVGV4KSB7CiAgICAgIHRtcFN0YXRlVGV4LmRlc3Ryb3koKTsKICAgICAgdG1wU3RhdGVUZXggPSB2b2lkIDA7CiAgICB9CiAgfTsKICBjb25zdCBzZXRQb2ludHMgPSAobmV3UG9pbnRzLCBvcHRpb25zID0ge30pID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICBpc1BvaW50c0RyYXduID0gZmFsc2U7CiAgICBjb25zdCBwcmV2ZW50RmlsdGVyUmVzZXQgPSBvcHRpb25zPy5wcmV2ZW50RmlsdGVyUmVzZXQgJiYgbmV3UG9pbnRzLmxlbmd0aCA9PT0gbnVtUG9pbnRzOwogICAgbnVtUG9pbnRzID0gbmV3UG9pbnRzLmxlbmd0aDsKICAgIG51bVBvaW50c0luVmlldyA9IG51bVBvaW50czsKICAgIGlmIChzdGF0ZVRleCkgewogICAgICBzdGF0ZVRleC5kZXN0cm95KCk7CiAgICB9CiAgICBzdGF0ZVRleCA9IGNyZWF0ZVN0YXRlVGV4dHVyZShuZXdQb2ludHMsIHsKICAgICAgejogb3B0aW9ucy56RGF0YVR5cGUsCiAgICAgIHc6IG9wdGlvbnMud0RhdGFUeXBlCiAgICB9KTsKICAgIGlmICghcHJldmVudEZpbHRlclJlc2V0KSB7CiAgICAgIG5vcm1hbFBvaW50c0luZGV4QnVmZmVyKHsKICAgICAgICB1c2FnZTogInN0YXRpYyIsCiAgICAgICAgdHlwZTogImZsb2F0IiwKICAgICAgICBkYXRhOiBjcmVhdGVQb2ludEluZGV4KG51bVBvaW50cykKICAgICAgfSk7CiAgICB9CiAgICBjcmVhdGVLZGJ1c2gob3B0aW9ucy5zcGF0aWFsSW5kZXggfHwgbmV3UG9pbnRzLCB7CiAgICAgIHVzZVdvcmtlcjogc3BhdGlhbEluZGV4VXNlV29ya2VyCiAgICB9KS50aGVuKChuZXdTZWFyY2hJbmRleCkgPT4gewogICAgICBzcGF0aWFsSW5kZXggPSBuZXdTZWFyY2hJbmRleDsKICAgICAgcG9pbnRzID0gbmV3UG9pbnRzOwogICAgICBpc1BvaW50c0RyYXduID0gdHJ1ZTsKICAgIH0pLnRoZW4ocmVzb2x2ZSk7CiAgfSk7CiAgY29uc3QgY2FjaGVDYW1lcmEgPSAobmV3VGFyZ2V0LCBuZXdEaXN0YW5jZSkgPT4gewogICAgY2FtZXJhWm9vbVRhcmdldFN0YXJ0ID0gY2FtZXJhLnRhcmdldDsKICAgIGNhbWVyYVpvb21UYXJnZXRFbmQgPSBuZXdUYXJnZXQ7CiAgICBjYW1lcmFab29tRGlzdGFuY2VTdGFydCA9IGNhbWVyYS5kaXN0YW5jZVswXTsKICAgIGNhbWVyYVpvb21EaXN0YW5jZUVuZCA9IG5ld0Rpc3RhbmNlOwogIH07CiAgY29uc3QgaGFzQ2FjaGVkQ2FtZXJhID0gKCkgPT4gQm9vbGVhbigKICAgIGNhbWVyYVpvb21UYXJnZXRTdGFydCAhPT0gdm9pZCAwICYmIGNhbWVyYVpvb21UYXJnZXRFbmQgIT09IHZvaWQgMCAmJiBjYW1lcmFab29tRGlzdGFuY2VTdGFydCAhPT0gdm9pZCAwICYmIGNhbWVyYVpvb21EaXN0YW5jZUVuZCAhPT0gdm9pZCAwCiAgKTsKICBjb25zdCBjbGVhckNhY2hlZENhbWVyYSA9ICgpID0+IHsKICAgIGNhbWVyYVpvb21UYXJnZXRTdGFydCA9IHZvaWQgMDsKICAgIGNhbWVyYVpvb21UYXJnZXRFbmQgPSB2b2lkIDA7CiAgICBjYW1lcmFab29tRGlzdGFuY2VTdGFydCA9IHZvaWQgMDsKICAgIGNhbWVyYVpvb21EaXN0YW5jZUVuZCA9IHZvaWQgMDsKICB9OwogIGNvbnN0IGdldFBvaW50Q29ubmVjdGlvbkNvbG9ySW5kaWNlcyA9IChjdXJ2ZVBvaW50cykgPT4gewogICAgY29uc3QgY29sb3JFbmNvZGluZyA9IHBvaW50Q29ubmVjdGlvbkNvbG9yQnkgPT09ICJpbmhlcml0IiA/IGNvbG9yQnkgOiBwb2ludENvbm5lY3Rpb25Db2xvckJ5OwogICAgaWYgKGNvbG9yRW5jb2RpbmcgPT09ICJzZWdtZW50IikgewogICAgICBjb25zdCBtYXhDb2xvcklkeCA9IHBvaW50Q29ubmVjdGlvbkNvbG9yLmxlbmd0aCAtIDE7CiAgICAgIGlmIChtYXhDb2xvcklkeCA8IDEpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgcmV0dXJuIGN1cnZlUG9pbnRzLnJlZHVjZSgoY29sb3JJbmRpY2VzLCBjdXJ2ZSwgaW5kZXgpID0+IHsKICAgICAgICBsZXQgdG90YWxMZW5ndGggPSAwOwogICAgICAgIGNvbnN0IHNlZ0xlbmd0aHMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMjsgaSA8IGN1cnZlLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBzZWdMZW5ndGggPSBNYXRoLnNxcnQoCiAgICAgICAgICAgIChjdXJ2ZVtpIC0gMl0gLSBjdXJ2ZVtpXSkgKiogMiArIChjdXJ2ZVtpIC0gMV0gLSBjdXJ2ZVtpICsgMV0pICoqIDIKICAgICAgICAgICk7CiAgICAgICAgICBzZWdMZW5ndGhzLnB1c2goc2VnTGVuZ3RoKTsKICAgICAgICAgIHRvdGFsTGVuZ3RoICs9IHNlZ0xlbmd0aDsKICAgICAgICB9CiAgICAgICAgY29sb3JJbmRpY2VzW2luZGV4XSA9IFswXTsKICAgICAgICBsZXQgY3VtTGVuZ3RoID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cnZlLmxlbmd0aCAvIDIgLSAxOyBpKyspIHsKICAgICAgICAgIGN1bUxlbmd0aCArPSBzZWdMZW5ndGhzW2ldOwogICAgICAgICAgY29sb3JJbmRpY2VzW2luZGV4XS5wdXNoKAogICAgICAgICAgICBNYXRoLmZsb29yKGN1bUxlbmd0aCAvIHRvdGFsTGVuZ3RoICogbWF4Q29sb3JJZHgpICogNAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbG9ySW5kaWNlczsKICAgICAgfSwgW10pOwogICAgfQogICAgaWYgKGNvbG9yRW5jb2RpbmcpIHsKICAgICAgY29uc3QgZW5jb2RpbmdJZHggPSBnZXRFbmNvZGluZ0lkeChjb2xvckVuY29kaW5nKTsKICAgICAgY29uc3QgZW5jb2RpbmdWYWx1ZVRvSWR4ID0gZ2V0RW5jb2RpbmdWYWx1ZVRvSWR4KAogICAgICAgIGdldEVuY29kaW5nRGF0YVR5cGUoY29sb3JFbmNvZGluZyksCiAgICAgICAgcG9pbnRDb25uZWN0aW9uQ29sb3JCeSA9PT0gImluaGVyaXQiID8gcG9pbnRDb2xvciA6IHBvaW50Q29ubmVjdGlvbkNvbG9yCiAgICAgICk7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25NYXAucmVkdWNlKAogICAgICAgIChjb2xvckluZGljZXMsIFtpbmRleCwgcmVmZXJlbmNlUG9pbnRdKSA9PiB7CiAgICAgICAgICBjb2xvckluZGljZXNbaW5kZXhdID0gZW5jb2RpbmdWYWx1ZVRvSWR4KHJlZmVyZW5jZVBvaW50W2VuY29kaW5nSWR4XSkgKiA0OwogICAgICAgICAgcmV0dXJuIGNvbG9ySW5kaWNlczsKICAgICAgICB9LAogICAgICAgIFtdCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gbmV3IEFycmF5KHBvaW50Q29ubmVjdGlvbk1hcC5sZW5ndGgpLmZpbGwoMCk7CiAgfTsKICBjb25zdCBnZXRQb2ludENvbm5lY3Rpb25PcGFjaXRpZXMgPSAoKSA9PiB7CiAgICBjb25zdCBvcGFjaXR5RW5jb2RpbmcgPSBwb2ludENvbm5lY3Rpb25PcGFjaXR5QnkgPT09ICJpbmhlcml0IiA/IG9wYWNpdHlCeSA6IHBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeTsKICAgIGlmIChvcGFjaXR5RW5jb2RpbmcgPT09ICJzZWdtZW50IikgewogICAgICBjb25zdCBtYXhPcGFjaXR5SWR4ID0gcG9pbnRDb25uZWN0aW9uT3BhY2l0eS5sZW5ndGggLSAxOwogICAgICBpZiAobWF4T3BhY2l0eUlkeCA8IDEpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgcmV0dXJuIHBvaW50Q29ubmVjdGlvbk1hcC5yZWR1Y2UoCiAgICAgICAgKG9wYWNpdGllcywgW2luZGV4LCBfcmVmZXJlbmNlUG9pbnQsIGxlbmd0aF0pID0+IHsKICAgICAgICAgIG9wYWNpdGllc1tpbmRleF0gPSByYW5nZU1hcCgKICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAoaSkgPT4gcG9pbnRDb25uZWN0aW9uT3BhY2l0eVtNYXRoLmZsb29yKGkgLyAobGVuZ3RoIC0gMSkgKiBtYXhPcGFjaXR5SWR4KV0KICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gb3BhY2l0aWVzOwogICAgICAgIH0sCiAgICAgICAgW10KICAgICAgKTsKICAgIH0KICAgIGlmIChvcGFjaXR5RW5jb2RpbmcpIHsKICAgICAgY29uc3QgZW5jb2RpbmdJZHggPSBnZXRFbmNvZGluZ0lkeChvcGFjaXR5RW5jb2RpbmcpOwogICAgICBjb25zdCBlbmNvZGluZ1JhbmdlTWFwID0gcG9pbnRDb25uZWN0aW9uT3BhY2l0eUJ5ID09PSAiaW5oZXJpdCIgPyBvcGFjaXR5IDogcG9pbnRDb25uZWN0aW9uT3BhY2l0eTsKICAgICAgY29uc3QgZW5jb2RpbmdWYWx1ZVRvSWR4ID0gZ2V0RW5jb2RpbmdWYWx1ZVRvSWR4KAogICAgICAgIGdldEVuY29kaW5nRGF0YVR5cGUob3BhY2l0eUVuY29kaW5nKSwKICAgICAgICBlbmNvZGluZ1JhbmdlTWFwCiAgICAgICk7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25NYXAucmVkdWNlKChvcGFjaXRpZXMsIFtpbmRleCwgcmVmZXJlbmNlUG9pbnRdKSA9PiB7CiAgICAgICAgb3BhY2l0aWVzW2luZGV4XSA9IGVuY29kaW5nUmFuZ2VNYXBbZW5jb2RpbmdWYWx1ZVRvSWR4KHJlZmVyZW5jZVBvaW50W2VuY29kaW5nSWR4XSldOwogICAgICAgIHJldHVybiBvcGFjaXRpZXM7CiAgICAgIH0sIFtdKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfTsKICBjb25zdCBnZXRQb2ludENvbm5lY3Rpb25XaWR0aHMgPSAoKSA9PiB7CiAgICBjb25zdCBzaXplRW5jb2RpbmcgPSBwb2ludENvbm5lY3Rpb25TaXplQnkgPT09ICJpbmhlcml0IiA/IHNpemVCeSA6IHBvaW50Q29ubmVjdGlvblNpemVCeTsKICAgIGlmIChzaXplRW5jb2RpbmcgPT09ICJzZWdtZW50IikgewogICAgICBjb25zdCBtYXhTaXplSWR4ID0gcG9pbnRDb25uZWN0aW9uU2l6ZS5sZW5ndGggLSAxOwogICAgICBpZiAobWF4U2l6ZUlkeCA8IDEpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgcmV0dXJuIHBvaW50Q29ubmVjdGlvbk1hcC5yZWR1Y2UoCiAgICAgICAgKHdpZHRocywgW2luZGV4LCBfcmVmZXJlbmNlUG9pbnQsIGxlbmd0aF0pID0+IHsKICAgICAgICAgIHdpZHRoc1tpbmRleF0gPSByYW5nZU1hcCgKICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAoaSkgPT4gcG9pbnRDb25uZWN0aW9uU2l6ZVtNYXRoLmZsb29yKGkgLyAobGVuZ3RoIC0gMSkgKiBtYXhTaXplSWR4KV0KICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gd2lkdGhzOwogICAgICAgIH0sCiAgICAgICAgW10KICAgICAgKTsKICAgIH0KICAgIGlmIChzaXplRW5jb2RpbmcpIHsKICAgICAgY29uc3QgZW5jb2RpbmdJZHggPSBnZXRFbmNvZGluZ0lkeChzaXplRW5jb2RpbmcpOwogICAgICBjb25zdCBlbmNvZGluZ1JhbmdlTWFwID0gcG9pbnRDb25uZWN0aW9uU2l6ZUJ5ID09PSAiaW5oZXJpdCIgPyBwb2ludFNpemUgOiBwb2ludENvbm5lY3Rpb25TaXplOwogICAgICBjb25zdCBlbmNvZGluZ1ZhbHVlVG9JZHggPSBnZXRFbmNvZGluZ1ZhbHVlVG9JZHgoCiAgICAgICAgZ2V0RW5jb2RpbmdEYXRhVHlwZShzaXplRW5jb2RpbmcpLAogICAgICAgIGVuY29kaW5nUmFuZ2VNYXAKICAgICAgKTsKICAgICAgcmV0dXJuIHBvaW50Q29ubmVjdGlvbk1hcC5yZWR1Y2UoKHdpZHRocywgW2luZGV4LCByZWZlcmVuY2VQb2ludF0pID0+IHsKICAgICAgICB3aWR0aHNbaW5kZXhdID0gZW5jb2RpbmdSYW5nZU1hcFtlbmNvZGluZ1ZhbHVlVG9JZHgocmVmZXJlbmNlUG9pbnRbZW5jb2RpbmdJZHhdKV07CiAgICAgICAgcmV0dXJuIHdpZHRoczsKICAgICAgfSwgW10pOwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9OwogIGNvbnN0IHNldFBvaW50Q29ubmVjdGlvbk1hcCA9IChjdXJ2ZVBvaW50cykgPT4gewogICAgcG9pbnRDb25uZWN0aW9uTWFwID0gW107CiAgICBsZXQgY3VtTGluZVBvaW50cyA9IDA7CiAgICBPYmplY3Qua2V5cyhjdXJ2ZVBvaW50cykuZm9yRWFjaCgoaWQsIGluZGV4KSA9PiB7CiAgICAgIHBvaW50Q29ubmVjdGlvbk1hcFtpZF0gPSBbCiAgICAgICAgaW5kZXgsCiAgICAgICAgY3VydmVQb2ludHNbaWRdLnJlZmVyZW5jZSwKICAgICAgICBjdXJ2ZVBvaW50c1tpZF0ubGVuZ3RoIC8gMiwKICAgICAgICAvLyBVc2VkIGZvciBvZmZzZXR0aW5nIGluIHRoZSBidWZmZXIgbWFuaXB1bGF0aW9ucyBvbgogICAgICAgIC8vIGhvdmVyaW5nIGFuZCBzZWxlY3RpbmcKICAgICAgICBjdW1MaW5lUG9pbnRzCiAgICAgIF07CiAgICAgIGN1bUxpbmVQb2ludHMgKz0gY3VydmVQb2ludHNbaWRdLmxlbmd0aCAvIDI7CiAgICB9KTsKICB9OwogIGNvbnN0IHNldFBvaW50Q29ubmVjdGlvbnMgPSAobmV3UG9pbnRzKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgcG9pbnRDb25uZWN0aW9ucy5zZXRQb2ludHMoW10pOwogICAgaWYgKG5ld1BvaW50cz8ubGVuZ3RoID4gMCkgewogICAgICBjb21wdXRpbmdQb2ludENvbm5lY3Rpb25DdXJ2ZXMgPSB0cnVlOwogICAgICBjcmVhdGVTcGxpbmVDdXJ2ZShuZXdQb2ludHMsIHsKICAgICAgICBtYXhJbnRQb2ludHNQZXJTZWdtZW50OiBwb2ludENvbm5lY3Rpb25NYXhJbnRQb2ludHNQZXJTZWdtZW50LAogICAgICAgIHRvbGVyYW5jZTogcG9pbnRDb25uZWN0aW9uVG9sZXJhbmNlCiAgICAgIH0pLnRoZW4oKGN1cnZlUG9pbnRzKSA9PiB7CiAgICAgICAgc2V0UG9pbnRDb25uZWN0aW9uTWFwKGN1cnZlUG9pbnRzKTsKICAgICAgICBjb25zdCBjdXJ2ZVBvaW50VmFsdWVzID0gT2JqZWN0LnZhbHVlcyhjdXJ2ZVBvaW50cyk7CiAgICAgICAgcG9pbnRDb25uZWN0aW9ucy5zZXRQb2ludHMoCiAgICAgICAgICBjdXJ2ZVBvaW50VmFsdWVzLmxlbmd0aCA9PT0gMSA/IGN1cnZlUG9pbnRWYWx1ZXNbMF0gOiBjdXJ2ZVBvaW50VmFsdWVzLAogICAgICAgICAgewogICAgICAgICAgICBjb2xvckluZGljZXM6IGdldFBvaW50Q29ubmVjdGlvbkNvbG9ySW5kaWNlcyhjdXJ2ZVBvaW50VmFsdWVzKSwKICAgICAgICAgICAgb3BhY2l0aWVzOiBnZXRQb2ludENvbm5lY3Rpb25PcGFjaXRpZXMoKSwKICAgICAgICAgICAgd2lkdGhzOiBnZXRQb2ludENvbm5lY3Rpb25XaWR0aHMoKQogICAgICAgICAgfQogICAgICAgICk7CiAgICAgICAgY29tcHV0aW5nUG9pbnRDb25uZWN0aW9uQ3VydmVzID0gZmFsc2U7CiAgICAgICAgcmVzb2x2ZSgpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc29sdmUoKTsKICAgIH0KICB9KTsKICBjb25zdCB1bmZpbHRlciA9ICh7IHByZXZlbnRFdmVudCA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgaXNQb2ludHNGaWx0ZXJlZCA9IGZhbHNlOwogICAgZmlsdGVyZWRQb2ludHNTZXQuY2xlYXIoKTsKICAgIG5vcm1hbFBvaW50c0luZGV4QnVmZmVyLnN1YmRhdGEoY3JlYXRlUG9pbnRJbmRleChudW1Qb2ludHMpKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBjb25zdCBmaW5pc2ggPSAoKSA9PiB7CiAgICAgICAgcHViU3ViLnN1YnNjcmliZSgKICAgICAgICAgICJkcmF3IiwKICAgICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCFwcmV2ZW50RXZlbnQpIHsKICAgICAgICAgICAgICBwdWJTdWIucHVibGlzaCgidW5maWx0ZXIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICB9LAogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgZHJhdyA9IHRydWU7CiAgICAgIH07CiAgICAgIGlmIChzaG93UG9pbnRDb25uZWN0aW9ucyB8fCBoYXNQb2ludENvbm5lY3Rpb25zKHBvaW50c1swXSkpIHsKICAgICAgICBzZXRQb2ludENvbm5lY3Rpb25zKGdldFBvaW50cygpKS50aGVuKCgpID0+IHsKICAgICAgICAgIGlmICghcHJldmVudEV2ZW50KSB7CiAgICAgICAgICAgIHB1YlN1Yi5wdWJsaXNoKCJwb2ludENvbm5lY3Rpb25zRHJhdyIpOwogICAgICAgICAgfQogICAgICAgICAgZmluaXNoKCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmluaXNoKCk7CiAgICAgIH0KICAgIH0pOwogIH07CiAgY29uc3QgZmlsdGVyMiA9IChwb2ludElkeHMsIHsgcHJldmVudEV2ZW50ID0gZmFsc2UgfSA9IHt9KSA9PiB7CiAgICBpc1BvaW50c0ZpbHRlcmVkID0gdHJ1ZTsKICAgIGZpbHRlcmVkUG9pbnRzU2V0LmNsZWFyKCk7CiAgICBjb25zdCBwb2ludElkeHNBcnJheSA9IEFycmF5LmlzQXJyYXkocG9pbnRJZHhzKSA/IHBvaW50SWR4cyA6IFtwb2ludElkeHNdOwogICAgY29uc3QgZmlsdGVyZWRQb2ludHMgPSBbXTsKICAgIGNvbnN0IGZpbHRlcmVkUG9pbnRzQnVmZmVyID0gW107CiAgICBjb25zdCBmaWx0ZXJlZFNlbGVjdGVkUG9pbnRzID0gW107CiAgICBmb3IgKGNvbnN0IHBvaW50SWR4IG9mIHBvaW50SWR4c0FycmF5KSB7CiAgICAgIGlmICghTnVtYmVyLmlzRmluaXRlKHBvaW50SWR4KSB8fCBwb2ludElkeCA8IDAgfHwgcG9pbnRJZHggPj0gbnVtUG9pbnRzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgZmlsdGVyZWRQb2ludHMucHVzaChwb2ludElkeCk7CiAgICAgIGZpbHRlcmVkUG9pbnRzU2V0LmFkZChwb2ludElkeCk7CiAgICAgIGlmIChzZWxlY3RlZFBvaW50c1NldC5oYXMocG9pbnRJZHgpKSB7CiAgICAgICAgZmlsdGVyZWRTZWxlY3RlZFBvaW50cy5wdXNoKHBvaW50SWR4KTsKICAgICAgfQogICAgfQogICAgY29uc3Qgc29ydGVkRmlsdGVyZWRQb2ludHMgPSBpbnNlcnRpb25Tb3J0KFsuLi5maWx0ZXJlZFBvaW50c10pOwogICAgZm9yIChjb25zdCBwb2ludElkeCBvZiBzb3J0ZWRGaWx0ZXJlZFBvaW50cykgewogICAgICBmaWx0ZXJlZFBvaW50c0J1ZmZlci5wdXNoLmFwcGx5KAogICAgICAgIGZpbHRlcmVkUG9pbnRzQnVmZmVyLAogICAgICAgIGluZGV4VG9TdGF0ZVRleENvb3JkKHBvaW50SWR4KQogICAgICApOwogICAgfQogICAgbm9ybWFsUG9pbnRzSW5kZXhCdWZmZXIuc3ViZGF0YShmaWx0ZXJlZFBvaW50c0J1ZmZlcik7CiAgICBzZWxlY3QoZmlsdGVyZWRTZWxlY3RlZFBvaW50cywgeyBwcmV2ZW50RXZlbnQgfSk7CiAgICBpZiAoIWZpbHRlcmVkUG9pbnRzU2V0Lmhhcyhob3ZlcmVkUG9pbnQpKSB7CiAgICAgIGhvdmVyKC0xLCB7IHByZXZlbnRFdmVudCB9KTsKICAgIH0KICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBjb25zdCBmaW5pc2ggPSAoKSA9PiB7CiAgICAgICAgcHViU3ViLnN1YnNjcmliZSgKICAgICAgICAgICJkcmF3IiwKICAgICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCFwcmV2ZW50RXZlbnQpIHsKICAgICAgICAgICAgICBwdWJTdWIucHVibGlzaCgiZmlsdGVyIiwgeyBwb2ludHM6IGZpbHRlcmVkUG9pbnRzIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgIH0sCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICBkcmF3ID0gdHJ1ZTsKICAgICAgfTsKICAgICAgaWYgKHNob3dQb2ludENvbm5lY3Rpb25zIHx8IGhhc1BvaW50Q29ubmVjdGlvbnMocG9pbnRzWzBdKSkgewogICAgICAgIHNldFBvaW50Q29ubmVjdGlvbnMoZ2V0UG9pbnRzKCkpLnRoZW4oKCkgPT4gewogICAgICAgICAgaWYgKCFwcmV2ZW50RXZlbnQpIHsKICAgICAgICAgICAgcHViU3ViLnB1Ymxpc2goInBvaW50Q29ubmVjdGlvbnNEcmF3Iik7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxlY3QoZmlsdGVyZWRTZWxlY3RlZFBvaW50cywgeyBwcmV2ZW50RXZlbnQgfSk7CiAgICAgICAgICBmaW5pc2goKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2goKTsKICAgICAgfQogICAgfSk7CiAgfTsKICBjb25zdCBnZXRQb2ludHNJblZpZXcgPSAoKSA9PiBnZXRQb2ludHNJbkJCb3goCiAgICBib3R0b21MZWZ0TmRjWzBdLAogICAgYm90dG9tTGVmdE5kY1sxXSwKICAgIHRvcFJpZ2h0TmRjWzBdLAogICAgdG9wUmlnaHROZGNbMV0KICApOwogIGNvbnN0IGdldE51bVBvaW50c0luVmlldyA9ICgpID0+IHsKICAgIG51bVBvaW50c0luVmlldyA9IGdldFBvaW50c0luVmlldygpLmxlbmd0aDsKICB9OwogIGNvbnN0IGdldE51bVBvaW50c0luVmlld0RiID0gdGhyb3R0bGVBbmREZWJvdW5jZTIoCiAgICBnZXROdW1Qb2ludHNJblZpZXcsCiAgICBvcGFjaXR5QnlEZW5zaXR5RGVib3VuY2VUaW1lCiAgKTsKICBjb25zdCB0d2VlbkNhbWVyYSA9ICh0KSA9PiB7CiAgICBjb25zdCBbeFN0YXJ0LCB5U3RhcnRdID0gY2FtZXJhWm9vbVRhcmdldFN0YXJ0OwogICAgY29uc3QgW3hFbmQsIHlFbmRdID0gY2FtZXJhWm9vbVRhcmdldEVuZDsKICAgIGNvbnN0IHRpID0gMSAtIHQ7CiAgICBjb25zdCB0YXJnZXRYID0geFN0YXJ0ICogdGkgKyB4RW5kICogdDsKICAgIGNvbnN0IHRhcmdldFkgPSB5U3RhcnQgKiB0aSArIHlFbmQgKiB0OwogICAgY29uc3QgZGlzdGFuY2UgPSBjYW1lcmFab29tRGlzdGFuY2VTdGFydCAqIHRpICsgY2FtZXJhWm9vbURpc3RhbmNlRW5kICogdDsKICAgIGNhbWVyYS5sb29rQXQoW3RhcmdldFgsIHRhcmdldFldLCBkaXN0YW5jZSk7CiAgfTsKICBjb25zdCBpc1RyYW5zaXRpb25pbmdQb2ludHMgPSAoKSA9PiBoYXNDYWNoZWRQb2ludHMoKTsKICBjb25zdCBpc1RyYW5zaXRpb25pbmdDYW1lcmEgPSAoKSA9PiBoYXNDYWNoZWRDYW1lcmEoKTsKICBjb25zdCB0d2VlbiA9IChkdXJhdGlvbjIsIGVhc2luZykgPT4gewogICAgaWYgKCF0cmFuc2l0aW9uU3RhcnRUaW1lKSB7CiAgICAgIHRyYW5zaXRpb25TdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgIH0KICAgIGNvbnN0IGR0ID0gcGVyZm9ybWFuY2Uubm93KCkgLSB0cmFuc2l0aW9uU3RhcnRUaW1lOwogICAgY29uc3QgdCA9IGNsaXAoZWFzaW5nKGR0IC8gZHVyYXRpb24yKSwgMCwgMSk7CiAgICBpZiAoaXNUcmFuc2l0aW9uaW5nUG9pbnRzKCkpIHsKICAgICAgdXBkYXRlUG9pbnRzKHsgdCB9KTsKICAgIH0KICAgIGlmIChpc1RyYW5zaXRpb25pbmdDYW1lcmEoKSkgewogICAgICB0d2VlbkNhbWVyYSh0KTsKICAgIH0KICAgIHJldHVybiBkdCA8IGR1cmF0aW9uMjsKICB9OwogIGNvbnN0IGVuZFRyYW5zaXRpb24gPSAoKSA9PiB7CiAgICBpc1RyYW5zaXRpb25pbmcgPSBmYWxzZTsKICAgIHRyYW5zaXRpb25TdGFydFRpbWUgPSBudWxsOwogICAgdHJhbnNpdGlvbkR1cmF0aW9uID0gdm9pZCAwOwogICAgdHJhbnNpdGlvbkVhc2luZyA9IHZvaWQgMDsKICAgIHNob3dSZXRpY2xlID0gcHJlVHJhbnNpdGlvblNob3dSZXRpY2xlOwogICAgY2xlYXJDYWNoZWRQb2ludHMoKTsKICAgIGNsZWFyQ2FjaGVkQ2FtZXJhKCk7CiAgICBwdWJTdWIucHVibGlzaCgidHJhbnNpdGlvbkVuZCIpOwogIH07CiAgY29uc3Qgc3RhcnRUcmFuc2l0aW9uID0gKHsgZHVyYXRpb246IGR1cmF0aW9uMiA9IDUwMCwgZWFzaW5nID0gREVGQVVMVF9FQVNJTkcgfSkgPT4gewogICAgaWYgKGlzVHJhbnNpdGlvbmluZykgewogICAgICBwdWJTdWIucHVibGlzaCgidHJhbnNpdGlvbkVuZCIpOwogICAgfQogICAgaXNUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKICAgIHRyYW5zaXRpb25TdGFydFRpbWUgPSBudWxsOwogICAgdHJhbnNpdGlvbkR1cmF0aW9uID0gZHVyYXRpb24yOwogICAgdHJhbnNpdGlvbkVhc2luZyA9IGlzU3RyaW5nMihlYXNpbmcpID8gRUFTSU5HX0ZOU1tlYXNpbmddIHx8IERFRkFVTFRfRUFTSU5HIDogZWFzaW5nOwogICAgcHJlVHJhbnNpdGlvblNob3dSZXRpY2xlID0gc2hvd1JldGljbGU7CiAgICBzaG93UmV0aWNsZSA9IGZhbHNlOwogICAgcHViU3ViLnB1Ymxpc2goInRyYW5zaXRpb25TdGFydCIpOwogIH07CiAgY29uc3QgcHVibGljRHJhdyA9IChuZXdQb2ludHMsIG9wdGlvbnMgPSB7fSkgPT4gewogICAgaWYgKGlzRGVzdHJveWVkKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoRVJST1JfSU5TVEFOQ0VfSVNfREVTVFJPWUVEKSk7CiAgICB9CiAgICBpZiAoaXNEcmF3aW5nKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoRVJST1JfSVNfRFJBV0lORykpOwogICAgfQogICAgaXNEcmF3aW5nID0gdHJ1ZTsKICAgIHJldHVybiB0b0FycmF5T3JpZW50ZWRQb2ludHMobmV3UG9pbnRzKS50aGVuKAogICAgICAobmV3UG9pbnRzQXJyYXkpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgaWYgKGlzRGVzdHJveWVkKSB7CiAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGxldCBwb2ludHNDYWNoZWQgPSBmYWxzZTsKICAgICAgICBpZiAoIW9wdGlvbnMucHJldmVudEZpbHRlclJlc2V0IHx8IG5ld1BvaW50c0FycmF5Py5sZW5ndGggIT09IG51bVBvaW50cykgewogICAgICAgICAgaXNQb2ludHNGaWx0ZXJlZCA9IGZhbHNlOwogICAgICAgICAgZmlsdGVyZWRQb2ludHNTZXQuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZHJhd1BvaW50Q29ubmVjdGlvbnMgPSBuZXdQb2ludHNBcnJheSAmJiBoYXNQb2ludENvbm5lY3Rpb25zKG5ld1BvaW50c0FycmF5WzBdKSAmJiAoc2hvd1BvaW50Q29ubmVjdGlvbnMgfHwgb3B0aW9ucy5zaG93UG9pbnRDb25uZWN0aW9uc09uY2UpOwogICAgICAgIGNvbnN0IHsgekRhdGFUeXBlLCB3RGF0YVR5cGUgfSA9IG9wdGlvbnM7CiAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmVEcmF3KSA9PiB7CiAgICAgICAgICBpZiAobmV3UG9pbnRzQXJyYXkpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbikgewogICAgICAgICAgICAgIGlmIChuZXdQb2ludHNBcnJheS5sZW5ndGggPT09IG51bVBvaW50cykgewogICAgICAgICAgICAgICAgcG9pbnRzQ2FjaGVkID0gY2FjaGVQb2ludHMobmV3UG9pbnRzQXJyYXksIHsKICAgICAgICAgICAgICAgICAgejogekRhdGFUeXBlLAogICAgICAgICAgICAgICAgICB3OiB3RGF0YVR5cGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgICAgICAgICAgICJDYW5ub3QgdHJhbnNpdGlvbiEgVGhlIG51bWJlciBvZiBwb2ludHMgYmV0d2VlbiB0aGUgcHJldmlvdXMgYW5kIGN1cnJlbnQgZHJhdyBjYWxsIG11c3QgYmUgaWRlbnRpY2FsLiIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFBvaW50cyhuZXdQb2ludHNBcnJheSwgewogICAgICAgICAgICAgIHpEYXRhVHlwZSwKICAgICAgICAgICAgICB3RGF0YVR5cGUsCiAgICAgICAgICAgICAgcHJldmVudEZpbHRlclJlc2V0OiBvcHRpb25zLnByZXZlbnRGaWx0ZXJSZXNldCwKICAgICAgICAgICAgICBzcGF0aWFsSW5kZXg6IG9wdGlvbnMuc3BhdGlhbEluZGV4CiAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgIGlmIChvcHRpb25zLmhvdmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGhvdmVyKG9wdGlvbnMuaG92ZXIsIHsgcHJldmVudEV2ZW50OiB0cnVlIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zZWxlY3QgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc2VsZWN0KG9wdGlvbnMuc2VsZWN0LCB7IHByZXZlbnRFdmVudDogdHJ1ZSB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZmlsdGVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGZpbHRlcjIob3B0aW9ucy5maWx0ZXIsIHsgcHJldmVudEV2ZW50OiB0cnVlIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZHJhd1BvaW50Q29ubmVjdGlvbnMpIHsKICAgICAgICAgICAgICAgIHNldFBvaW50Q29ubmVjdGlvbnMobmV3UG9pbnRzQXJyYXkpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICBwdWJTdWIucHVibGlzaCgicG9pbnRDb25uZWN0aW9uc0RyYXciKTsKICAgICAgICAgICAgICAgICAgZHJhdyA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGRyYXdSZXRpY2xlT25jZSA9IG9wdGlvbnMuc2hvd1JldGljbGVPbmNlOwogICAgICAgICAgICAgICAgfSkudGhlbigoKSA9PiByZXNvbHZlKCkpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXNvbHZlRHJhdygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlRHJhdygpOwogICAgICAgICAgfQogICAgICAgIH0pLnRoZW4oKCkgPT4gewogICAgICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbiAmJiBwb2ludHNDYWNoZWQpIHsKICAgICAgICAgICAgaWYgKGRyYXdQb2ludENvbm5lY3Rpb25zKSB7CiAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoWwogICAgICAgICAgICAgICAgbmV3IFByb21pc2UoKHJlc29sdmVUcmFuc2l0aW9uKSA9PiB7CiAgICAgICAgICAgICAgICAgIHB1YlN1Yi5zdWJzY3JpYmUoCiAgICAgICAgICAgICAgICAgICAgInRyYW5zaXRpb25FbmQiLAogICAgICAgICAgICAgICAgICAgICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgIGRyYXcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZHJhd1JldGljbGVPbmNlID0gb3B0aW9ucy5zaG93UmV0aWNsZU9uY2U7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlVHJhbnNpdGlvbigpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgMQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZURyYXcpID0+IHsKICAgICAgICAgICAgICAgICAgcHViU3ViLnN1YnNjcmliZSgicG9pbnRDb25uZWN0aW9uc0RyYXciLCByZXNvbHZlRHJhdywgMSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIF0pLnRoZW4oKCkgPT4gcmVzb2x2ZSgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwdWJTdWIuc3Vic2NyaWJlKAogICAgICAgICAgICAgICAgInRyYW5zaXRpb25FbmQiLAogICAgICAgICAgICAgICAgKCkgPT4gewogICAgICAgICAgICAgICAgICBkcmF3ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZHJhd1JldGljbGVPbmNlID0gb3B0aW9ucy5zaG93UmV0aWNsZU9uY2U7CiAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdGFydFRyYW5zaXRpb24oewogICAgICAgICAgICAgIGR1cmF0aW9uOiBvcHRpb25zLnRyYW5zaXRpb25EdXJhdGlvbiwKICAgICAgICAgICAgICBlYXNpbmc6IG9wdGlvbnMudHJhbnNpdGlvbkVhc2luZwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChkcmF3UG9pbnRDb25uZWN0aW9ucykgewogICAgICAgICAgICAgIFByb21pc2UuYWxsKFsKICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlRHJhdykgPT4gewogICAgICAgICAgICAgICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgcmVzb2x2ZURyYXcsIDEpOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZURyYXcpID0+IHsKICAgICAgICAgICAgICAgICAgcHViU3ViLnN1YnNjcmliZSgicG9pbnRDb25uZWN0aW9uc0RyYXciLCByZXNvbHZlRHJhdywgMSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIF0pLnRoZW4oKCkgPT4gcmVzb2x2ZSgpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgKCkgPT4gcmVzb2x2ZSgpLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkcmF3ID0gdHJ1ZTsKICAgICAgICAgICAgZHJhd1JldGljbGVPbmNlID0gb3B0aW9ucy5zaG93UmV0aWNsZU9uY2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pLmZpbmFsbHkoKCkgPT4gewogICAgICAgIGlzRHJhd2luZyA9IGZhbHNlOwogICAgICB9KQogICAgKTsKICB9OwogIGNvbnN0IGRyYXdBbm5vdGF0aW9ucyA9IChuZXdBbm5vdGF0aW9ucykgPT4gewogICAgaWYgKGlzRGVzdHJveWVkKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRVJST1JfSU5TVEFOQ0VfSVNfREVTVFJPWUVEKCkpOwogICAgfQogICAgaXNBbm5vdGF0aW9uc0RyYXduID0gZmFsc2U7CiAgICBpZiAobmV3QW5ub3RhdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIGFubm90YXRpb25zLmNsZWFyKCk7CiAgICAgICAgcHViU3ViLnN1YnNjcmliZSgiZHJhdyIsIHJlc29sdmUsIDEpOwogICAgICAgIGlzQW5ub3RhdGlvbnNEcmF3biA9IHRydWU7CiAgICAgICAgZHJhdyA9IHRydWU7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIGNvbnN0IG5ld1BvaW50cyA9IFtdOwogICAgICBjb25zdCBuZXdDb2xvcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBjb25zdCBuZXdDb2xvckluZGljZXMgPSBbXTsKICAgICAgY29uc3QgbmV3V2lkdGhzID0gW107CiAgICAgIGxldCBtYXhOZXdDb2xvcklkeCA9IC0xOwogICAgICBjb25zdCBhZGRDb2xvckFuZFdpZHRoID0gKGFubm90YXRpb24pID0+IHsKICAgICAgICBuZXdXaWR0aHMucHVzaChhbm5vdGF0aW9uLmxpbmVXaWR0aCB8fCBhbm5vdGF0aW9uTGluZVdpZHRoKTsKICAgICAgICBjb25zdCBjb2xvcjIgPSB0b1JnYmEoYW5ub3RhdGlvbi5saW5lQ29sb3IgfHwgYW5ub3RhdGlvbkxpbmVDb2xvciwgdHJ1ZSk7CiAgICAgICAgY29uc3QgY29sb3JJZCA9IGBbJHtjb2xvcjIuam9pbigiLCIpfV1gOwogICAgICAgIGlmIChuZXdDb2xvcnMuaGFzKGNvbG9ySWQpKSB7CiAgICAgICAgICBjb25zdCB7IGlkeCB9ID0gbmV3Q29sb3JzLmdldChjb2xvcklkKTsKICAgICAgICAgIG5ld0NvbG9ySW5kaWNlcy5wdXNoKGlkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGlkeCA9ICsrbWF4TmV3Q29sb3JJZHg7CiAgICAgICAgICBuZXdDb2xvcnMuc2V0KGNvbG9ySWQsIHsgaWR4LCBjb2xvcjogY29sb3IyIH0pOwogICAgICAgICAgbmV3Q29sb3JJbmRpY2VzLnB1c2goaWR4KTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGZvciAoY29uc3QgYW5ub3RhdGlvbiBvZiBuZXdBbm5vdGF0aW9ucykgewogICAgICAgIGlmIChpc0hvcml6b250YWxMaW5lKGFubm90YXRpb24pKSB7CiAgICAgICAgICBuZXdQb2ludHMucHVzaChbCiAgICAgICAgICAgIGFubm90YXRpb24ueDEgPz8gLWFubm90YXRpb25IVkxpbmVMaW1pdCwKICAgICAgICAgICAgYW5ub3RhdGlvbi55LAogICAgICAgICAgICBhbm5vdGF0aW9uLngyID8/IGFubm90YXRpb25IVkxpbmVMaW1pdCwKICAgICAgICAgICAgYW5ub3RhdGlvbi55CiAgICAgICAgICBdKTsKICAgICAgICAgIGFkZENvbG9yQW5kV2lkdGgoYW5ub3RhdGlvbik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzVmVydGljYWxMaW5lKGFubm90YXRpb24pKSB7CiAgICAgICAgICBuZXdQb2ludHMucHVzaChbCiAgICAgICAgICAgIGFubm90YXRpb24ueCwKICAgICAgICAgICAgYW5ub3RhdGlvbi55MSA/PyAtYW5ub3RhdGlvbkhWTGluZUxpbWl0LAogICAgICAgICAgICBhbm5vdGF0aW9uLngsCiAgICAgICAgICAgIGFubm90YXRpb24ueTIgPz8gYW5ub3RhdGlvbkhWTGluZUxpbWl0CiAgICAgICAgICBdKTsKICAgICAgICAgIGFkZENvbG9yQW5kV2lkdGgoYW5ub3RhdGlvbik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUmVjdChhbm5vdGF0aW9uKSkgewogICAgICAgICAgbmV3UG9pbnRzLnB1c2goWwogICAgICAgICAgICBhbm5vdGF0aW9uLngxLAogICAgICAgICAgICBhbm5vdGF0aW9uLnkxLAogICAgICAgICAgICBhbm5vdGF0aW9uLngyLAogICAgICAgICAgICBhbm5vdGF0aW9uLnkxLAogICAgICAgICAgICBhbm5vdGF0aW9uLngyLAogICAgICAgICAgICBhbm5vdGF0aW9uLnkyLAogICAgICAgICAgICBhbm5vdGF0aW9uLngxLAogICAgICAgICAgICBhbm5vdGF0aW9uLnkyLAogICAgICAgICAgICBhbm5vdGF0aW9uLngxLAogICAgICAgICAgICBhbm5vdGF0aW9uLnkxCiAgICAgICAgICBdKTsKICAgICAgICAgIGFkZENvbG9yQW5kV2lkdGgoYW5ub3RhdGlvbik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzRG9tUmVjdChhbm5vdGF0aW9uKSkgewogICAgICAgICAgbmV3UG9pbnRzLnB1c2goWwogICAgICAgICAgICBhbm5vdGF0aW9uLngsCiAgICAgICAgICAgIGFubm90YXRpb24ueSwKICAgICAgICAgICAgYW5ub3RhdGlvbi54ICsgYW5ub3RhdGlvbi53aWR0aCwKICAgICAgICAgICAgYW5ub3RhdGlvbi55LAogICAgICAgICAgICBhbm5vdGF0aW9uLnggKyBhbm5vdGF0aW9uLndpZHRoLAogICAgICAgICAgICBhbm5vdGF0aW9uLnkgKyBhbm5vdGF0aW9uLmhlaWdodCwKICAgICAgICAgICAgYW5ub3RhdGlvbi54LAogICAgICAgICAgICBhbm5vdGF0aW9uLnkgKyBhbm5vdGF0aW9uLmhlaWdodCwKICAgICAgICAgICAgYW5ub3RhdGlvbi54LAogICAgICAgICAgICBhbm5vdGF0aW9uLnkKICAgICAgICAgIF0pOwogICAgICAgICAgYWRkQ29sb3JBbmRXaWR0aChhbm5vdGF0aW9uKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQb2x5Z29uKGFubm90YXRpb24pKSB7CiAgICAgICAgICBuZXdQb2ludHMucHVzaChhbm5vdGF0aW9uLnZlcnRpY2VzLmZsYXRNYXAoaWRlbnRpdHkpKTsKICAgICAgICAgIGFkZENvbG9yQW5kV2lkdGgoYW5ub3RhdGlvbik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFubm90YXRpb25zLnNldFN0eWxlKHsKICAgICAgICBjb2xvcjogQXJyYXkuZnJvbShuZXdDb2xvcnMudmFsdWVzKCkpLnNvcnQoKGEsIGIpID0+IGEuaWR4ID4gYi5pZHggPyAxIDogLTEpLm1hcCgoeyBjb2xvcjogY29sb3IyIH0pID0+IGNvbG9yMikKICAgICAgfSk7CiAgICAgIGFubm90YXRpb25zLnNldFBvaW50cygKICAgICAgICBuZXdQb2ludHMubGVuZ3RoID09PSAxID8gbmV3UG9pbnRzLmZsYXQoKSA6IG5ld1BvaW50cywKICAgICAgICB7CiAgICAgICAgICBjb2xvckluZGljZXM6IG5ld0NvbG9ySW5kaWNlcywKICAgICAgICAgIHdpZHRoczogbmV3V2lkdGhzCiAgICAgICAgfQogICAgICApOwogICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgcmVzb2x2ZSwgMSk7CiAgICAgIGlzQW5ub3RhdGlvbnNEcmF3biA9IHRydWU7CiAgICAgIGRyYXcgPSB0cnVlOwogICAgfSk7CiAgfTsKICBjb25zdCB3aXRoRHJhdyA9IChmKSA9PiAoLi4uYXJncykgPT4gewogICAgY29uc3Qgb3V0ID0gZiguLi5hcmdzKTsKICAgIGRyYXcgPSB0cnVlOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIHB1YlN1Yi5zdWJzY3JpYmUoImRyYXciLCAoKSA9PiByZXNvbHZlKG91dCksIDEpOwogICAgfSk7CiAgfTsKICBjb25zdCBnZXRCQm94T2ZQb2ludHMgPSAocG9pbnRJZHhzKSA9PiB7CiAgICBsZXQgeE1pbiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGxldCB4TWF4ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IHlNaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgeU1heCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGZvciAoY29uc3QgcG9pbnRJZHggb2YgcG9pbnRJZHhzKSB7CiAgICAgIGNvbnN0IFt4LCB5XSA9IHBvaW50c1twb2ludElkeF07CiAgICAgIHhNaW4gPSBNYXRoLm1pbih4TWluLCB4KTsKICAgICAgeE1heCA9IE1hdGgubWF4KHhNYXgsIHgpOwogICAgICB5TWluID0gTWF0aC5taW4oeU1pbiwgeSk7CiAgICAgIHlNYXggPSBNYXRoLm1heCh5TWF4LCB5KTsKICAgIH0KICAgIHJldHVybiB7IHg6IHhNaW4sIHk6IHlNaW4sIHdpZHRoOiB4TWF4IC0geE1pbiwgaGVpZ2h0OiB5TWF4IC0geU1pbiB9OwogIH07CiAgY29uc3Qgem9vbVRvQXJlYSA9IChyZWN0LCBvcHRpb25zID0ge30pID0+IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICBjb25zdCB0YXJnZXQgPSB0cmFuc2Zvcm1NYXQ0KAogICAgICBbXSwKICAgICAgW3JlY3QueCArIHJlY3Qud2lkdGggLyAyLCByZWN0LnkgKyByZWN0LmhlaWdodCAvIDIsIDAsIDBdLAogICAgICBtb2RlbAogICAgKS5zbGljZSgwLCAyKTsKICAgIGNvbnN0IHZGT1YgPSAyICogTWF0aC5hdGFuKDEpOwogICAgY29uc3QgYXNwZWN0UmF0aW8gPSB2aWV3QXNwZWN0UmF0aW8gLyBkYXRhQXNwZWN0UmF0aW87CiAgICBjb25zdCBkaXN0YW5jZSA9IHJlY3QuaGVpZ2h0ICogYXNwZWN0UmF0aW8gPj0gcmVjdC53aWR0aCA/ICgKICAgICAgLy8gRGlzdGFuY2UgaXMgYmFzZWQgb24gdGhlIGhlaWdodCBvZiB0aGUgYm91bmRpbmcgYm94CiAgICAgIHJlY3QuaGVpZ2h0IC8gMiAvIE1hdGgudGFuKHZGT1YgLyAyKQogICAgKSA6ICgKICAgICAgLy8gRGlzdGFuY2UgaXMgYmFzZWQgb24gdGhlIHdpZHRoIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAgcmVjdC53aWR0aCAvIDIgLyBNYXRoLnRhbih2Rk9WIC8gMikgLyBhc3BlY3RSYXRpbwogICAgKTsKICAgIGlmIChvcHRpb25zLnRyYW5zaXRpb24pIHsKICAgICAgY2FtZXJhLmNvbmZpZyh7IGlzRml4ZWQ6IHRydWUgfSk7CiAgICAgIGNhY2hlQ2FtZXJhKHRhcmdldCwgZGlzdGFuY2UpOwogICAgICBwdWJTdWIuc3Vic2NyaWJlKAogICAgICAgICJ0cmFuc2l0aW9uRW5kIiwKICAgICAgICAoKSA9PiB7CiAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICBjYW1lcmEuY29uZmlnKHsgaXNGaXhlZDogY2FtZXJhSXNGaXhlZCB9KTsKICAgICAgICB9LAogICAgICAgIDEKICAgICAgKTsKICAgICAgc3RhcnRUcmFuc2l0aW9uKHsKICAgICAgICBkdXJhdGlvbjogb3B0aW9ucy50cmFuc2l0aW9uRHVyYXRpb24sCiAgICAgICAgZWFzaW5nOiBvcHRpb25zLnRyYW5zaXRpb25FYXNpbmcKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjYW1lcmEubG9va0F0KHRhcmdldCwgZGlzdGFuY2UpOwogICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgcmVzb2x2ZSwgMSk7CiAgICAgIGRyYXcgPSB0cnVlOwogICAgfQogIH0pOwogIGNvbnN0IHpvb21Ub1BvaW50cyA9IChwb2ludElkeHMsIG9wdGlvbnMgPSB7fSkgPT4gewogICAgaWYgKCFpc1BvaW50c0RyYXduKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoRVJST1JfUE9JTlRTX05PVF9EUkFXTikpOwogICAgfQogICAgY29uc3QgcmVjdCA9IGdldEJCb3hPZlBvaW50cyhwb2ludElkeHMpOwogICAgY29uc3QgY1ggPSByZWN0LnggKyByZWN0LndpZHRoIC8gMjsKICAgIGNvbnN0IGNZID0gcmVjdC55ICsgcmVjdC5oZWlnaHQgLyAyOwogICAgY29uc3QgcG9pbnRTaXplTmRjID0gZ2V0UG9pbnRTaXplTmRjKCk7CiAgICBjb25zdCBzY2FsZSA9IDEgKyAob3B0aW9ucy5wYWRkaW5nIHx8IDApOwogICAgY29uc3QgdyA9IE1hdGgubWF4KHJlY3Qud2lkdGgsIHBvaW50U2l6ZU5kYykgKiBzY2FsZTsKICAgIGNvbnN0IGggPSBNYXRoLm1heChyZWN0LmhlaWdodCwgcG9pbnRTaXplTmRjKSAqIHNjYWxlOwogICAgY29uc3QgeCA9IGNYIC0gdyAvIDI7CiAgICBjb25zdCB5ID0gY1kgLSBoIC8gMjsKICAgIHJldHVybiB6b29tVG9BcmVhKHsgeCwgeSwgd2lkdGg6IHcsIGhlaWdodDogaCB9LCBvcHRpb25zKTsKICB9OwogIGNvbnN0IHpvb21Ub0xvY2F0aW9uID0gKHRhcmdldCwgZGlzdGFuY2UsIG9wdGlvbnMgPSB7fSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgIGlmIChvcHRpb25zLnRyYW5zaXRpb24pIHsKICAgICAgY2FtZXJhLmNvbmZpZyh7IGlzRml4ZWQ6IHRydWUgfSk7CiAgICAgIGNhY2hlQ2FtZXJhKHRhcmdldCwgZGlzdGFuY2UpOwogICAgICBwdWJTdWIuc3Vic2NyaWJlKAogICAgICAgICJ0cmFuc2l0aW9uRW5kIiwKICAgICAgICAoKSA9PiB7CiAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICBjYW1lcmEuY29uZmlnKHsgaXNGaXhlZDogY2FtZXJhSXNGaXhlZCB9KTsKICAgICAgICB9LAogICAgICAgIDEKICAgICAgKTsKICAgICAgc3RhcnRUcmFuc2l0aW9uKHsKICAgICAgICBkdXJhdGlvbjogb3B0aW9ucy50cmFuc2l0aW9uRHVyYXRpb24sCiAgICAgICAgZWFzaW5nOiBvcHRpb25zLnRyYW5zaXRpb25FYXNpbmcKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjYW1lcmEubG9va0F0KHRhcmdldCwgZGlzdGFuY2UpOwogICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgcmVzb2x2ZSwgMSk7CiAgICAgIGRyYXcgPSB0cnVlOwogICAgfQogIH0pOwogIGNvbnN0IHpvb21Ub09yaWdpbiA9IChvcHRpb25zID0ge30pID0+IHpvb21Ub0xvY2F0aW9uKFswLCAwXSwgMSwgb3B0aW9ucyk7CiAgY29uc3QgZ2V0U2NyZWVuUG9zaXRpb24gPSAocG9pbnRJZHgpID0+IHsKICAgIGlmICghaXNQb2ludHNEcmF3bikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoRVJST1JfUE9JTlRTX05PVF9EUkFXTik7CiAgICB9CiAgICBjb25zdCBwb2ludCA9IHBvaW50c1twb2ludElkeF07CiAgICBpZiAoIXBvaW50KSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBjb25zdCB2ID0gW3BvaW50WzBdLCBwb2ludFsxXSwgMCwgMV07CiAgICBtdWx0aXBseSgKICAgICAgc2NyYXRjaCwKICAgICAgcHJvamVjdGlvbkxvY2FsLAogICAgICBtdWx0aXBseShzY3JhdGNoLCBjYW1lcmEudmlldywgbW9kZWwpCiAgICApOwogICAgdHJhbnNmb3JtTWF0NCh2LCB2LCBzY3JhdGNoKTsKICAgIGNvbnN0IHggPSBjdXJyZW50V2lkdGggKiAodlswXSArIDEpIC8gMjsKICAgIGNvbnN0IHkgPSBjdXJyZW50SGVpZ2h0ICogKDAuNSAtIHZbMV0gLyAyKTsKICAgIHJldHVybiBbeCwgeV07CiAgfTsKICBjb25zdCB1cGRhdGVQb2ludENvbm5lY3Rpb25TdHlsZSA9ICgpID0+IHsKICAgIHBvaW50Q29ubmVjdGlvbnMuc2V0U3R5bGUoewogICAgICBjb2xvcjogZ2V0Q29sb3JzKAogICAgICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yLAogICAgICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlLAogICAgICAgIHBvaW50Q29ubmVjdGlvbkNvbG9ySG92ZXIKICAgICAgKSwKICAgICAgb3BhY2l0eTogcG9pbnRDb25uZWN0aW9uT3BhY2l0eSA9PT0gbnVsbCA/IG51bGwgOiBwb2ludENvbm5lY3Rpb25PcGFjaXR5WzBdLAogICAgICB3aWR0aDogcG9pbnRDb25uZWN0aW9uU2l6ZVswXQogICAgfSk7CiAgfTsKICBjb25zdCB1cGRhdGVMYXNzb0luaXRpYXRvclN0eWxlID0gKCkgPT4gewogICAgY29uc3QgdiA9IE1hdGgucm91bmQoYmFja2dyb3VuZENvbG9yQnJpZ2h0bmVzcykgPiAwLjUgPyAwIDogMjU1OwogICAgbGFzc29NYW5hZ2VyLmluaXRpYXRvci5zdHlsZS5ib3JkZXIgPSBgMXB4IGRhc2hlZCByZ2JhKCR7dn0sICR7dn0sICR7dn0sIDAuMzMpYDsKICAgIGxhc3NvTWFuYWdlci5pbml0aWF0b3Iuc3R5bGUuYmFja2dyb3VuZCA9IGByZ2JhKCR7dn0sICR7dn0sICR7dn0sIDAuMSlgOwogIH07CiAgY29uc3QgdXBkYXRlTGFzc29Mb25nUHJlc3NJbmRpY2F0b3JTdHlsZSA9ICgpID0+IHsKICAgIGNvbnN0IHYgPSBNYXRoLnJvdW5kKGJhY2tncm91bmRDb2xvckJyaWdodG5lc3MpID4gMC41ID8gMCA6IDI1NTsKICAgIGxhc3NvTWFuYWdlci5sb25nUHJlc3NJbmRpY2F0b3Iuc3R5bGUuY29sb3IgPSBgcmdiKCR7dn0sICR7dn0sICR7dn0pYDsKICAgIGxhc3NvTWFuYWdlci5sb25nUHJlc3NJbmRpY2F0b3IuZGF0YXNldC5jb2xvciA9IGByZ2IoJHt2fSwgJHt2fSwgJHt2fSlgOwogICAgY29uc3QgcmdiMiA9IGxhc3NvQ29sb3IubWFwKChjKSA9PiBNYXRoLnJvdW5kKGMgKiAyNTUpKTsKICAgIGxhc3NvTWFuYWdlci5sb25nUHJlc3NJbmRpY2F0b3IuZGF0YXNldC5hY3RpdmVDb2xvciA9IGByZ2IoJHtyZ2IyWzBdfSwgJHtyZ2IyWzFdfSwgJHtyZ2IyWzJdfSlgOwogIH07CiAgY29uc3Qgc2V0QmFja2dyb3VuZENvbG9yID0gKG5ld0JhY2tncm91bmRDb2xvcikgPT4gewogICAgaWYgKCFuZXdCYWNrZ3JvdW5kQ29sb3IpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgYmFja2dyb3VuZENvbG9yID0gdG9SZ2JhKG5ld0JhY2tncm91bmRDb2xvciwgdHJ1ZSk7CiAgICBiYWNrZ3JvdW5kQ29sb3JCcmlnaHRuZXNzID0gcmdiQnJpZ2h0bmVzcyhiYWNrZ3JvdW5kQ29sb3IpOwogICAgdXBkYXRlTGFzc29Jbml0aWF0b3JTdHlsZSgpOwogICAgdXBkYXRlTGFzc29Mb25nUHJlc3NJbmRpY2F0b3JTdHlsZSgpOwogIH07CiAgY29uc3Qgc2V0QmFja2dyb3VuZEltYWdlID0gKG5ld0JhY2tncm91bmRJbWFnZSkgPT4gewogICAgaWYgKCFuZXdCYWNrZ3JvdW5kSW1hZ2UpIHsKICAgICAgYmFja2dyb3VuZEltYWdlID0gbnVsbDsKICAgIH0gZWxzZSBpZiAoaXNTdHJpbmcyKG5ld0JhY2tncm91bmRJbWFnZSkpIHsKICAgICAgY3JlYXRlVGV4dHVyZUZyb21VcmwocmVuZGVyZXIucmVnbCwgbmV3QmFja2dyb3VuZEltYWdlKS50aGVuKCh0ZXh0dXJlKSA9PiB7CiAgICAgICAgYmFja2dyb3VuZEltYWdlID0gdGV4dHVyZTsKICAgICAgICBkcmF3ID0gdHJ1ZTsKICAgICAgICBwdWJTdWIucHVibGlzaCgiYmFja2dyb3VuZEltYWdlUmVhZHkiKTsKICAgICAgfSkuY2F0Y2goKCkgPT4gewogICAgICAgIGNvbnNvbGUuZXJyb3IoYENvdW50IG5vdCBjcmVhdGUgdGV4dHVyZSBmcm9tICR7bmV3QmFja2dyb3VuZEltYWdlfWApOwogICAgICAgIGJhY2tncm91bmRJbWFnZSA9IG51bGw7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChuZXdCYWNrZ3JvdW5kSW1hZ2UuX3JlZ2xUeXBlID09PSAidGV4dHVyZTJkIikgewogICAgICBiYWNrZ3JvdW5kSW1hZ2UgPSBuZXdCYWNrZ3JvdW5kSW1hZ2U7CiAgICB9IGVsc2UgewogICAgICBiYWNrZ3JvdW5kSW1hZ2UgPSBudWxsOwogICAgfQogIH07CiAgY29uc3Qgc2V0Q2FtZXJhRGlzdGFuY2UgPSAoZGlzdGFuY2UpID0+IHsKICAgIGlmIChkaXN0YW5jZSA+IDApIHsKICAgICAgY2FtZXJhLmxvb2tBdChjYW1lcmEudGFyZ2V0LCBkaXN0YW5jZSwgY2FtZXJhLnJvdGF0aW9uKTsKICAgIH0KICB9OwogIGNvbnN0IHNldENhbWVyYVJvdGF0aW9uID0gKHJvdGF0aW9uKSA9PiB7CiAgICBpZiAocm90YXRpb24gIT09IG51bGwpIHsKICAgICAgY2FtZXJhLmxvb2tBdChjYW1lcmEudGFyZ2V0LCBjYW1lcmEuZGlzdGFuY2VbMF0sIHJvdGF0aW9uKTsKICAgIH0KICB9OwogIGNvbnN0IHNldENhbWVyYVRhcmdldCA9ICh0YXJnZXQpID0+IHsKICAgIGlmICh0YXJnZXQpIHsKICAgICAgY2FtZXJhLmxvb2tBdCh0YXJnZXQsIGNhbWVyYS5kaXN0YW5jZVswXSwgY2FtZXJhLnJvdGF0aW9uKTsKICAgIH0KICB9OwogIGNvbnN0IHNldENhbWVyYVZpZXcgPSAodmlldzIpID0+IHsKICAgIGlmICh2aWV3MikgewogICAgICBjYW1lcmEuc2V0Vmlldyh2aWV3Mik7CiAgICB9CiAgfTsKICBjb25zdCBzZXRDYW1lcmFJc0ZpeGVkID0gKGlzRml4ZWQpID0+IHsKICAgIGNhbWVyYUlzRml4ZWQgPSBCb29sZWFuKGlzRml4ZWQpOwogICAgY2FtZXJhLmNvbmZpZyh7IGlzRml4ZWQ6IGNhbWVyYUlzRml4ZWQgfSk7CiAgfTsKICBjb25zdCBzZXRMYXNzb0NvbG9yID0gKG5ld0xhc3NvQ29sb3IpID0+IHsKICAgIGlmICghbmV3TGFzc29Db2xvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBsYXNzb0NvbG9yID0gdG9SZ2JhKG5ld0xhc3NvQ29sb3IsIHRydWUpOwogICAgbGFzc28uc2V0U3R5bGUoeyBjb2xvcjogbGFzc29Db2xvciB9KTsKICAgIGNvbnN0IHJnYjIgPSBsYXNzb0NvbG9yLm1hcCgoYykgPT4gTWF0aC5yb3VuZChjICogMjU1KSk7CiAgICBsYXNzb01hbmFnZXIubG9uZ1ByZXNzSW5kaWNhdG9yLmRhdGFzZXQuYWN0aXZlQ29sb3IgPSBgcmdiKCR7cmdiMlswXX0sICR7cmdiMlsxXX0sICR7cmdiMlsyXX0pYDsKICB9OwogIGNvbnN0IHNldExhc3NvTGluZVdpZHRoID0gKG5ld0xhc3NvTGluZVdpZHRoKSA9PiB7CiAgICBpZiAoTnVtYmVyLmlzTmFOKCtuZXdMYXNzb0xpbmVXaWR0aCkgfHwgK25ld0xhc3NvTGluZVdpZHRoIDwgMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsYXNzb0xpbmVXaWR0aCA9ICtuZXdMYXNzb0xpbmVXaWR0aDsKICAgIGxhc3NvLnNldFN0eWxlKHsgd2lkdGg6IGxhc3NvTGluZVdpZHRoIH0pOwogIH07CiAgY29uc3Qgc2V0TGFzc29NaW5EZWxheSA9IChuZXdMYXNzb01pbkRlbGF5KSA9PiB7CiAgICBpZiAoIStuZXdMYXNzb01pbkRlbGF5KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxhc3NvTWluRGVsYXkgPSArbmV3TGFzc29NaW5EZWxheTsKICAgIGxhc3NvTWFuYWdlci5zZXQoewogICAgICBtaW5EZWxheTogbGFzc29NaW5EZWxheQogICAgfSk7CiAgfTsKICBjb25zdCBzZXRMYXNzb01pbkRpc3QgPSAobmV3TGFzc29NaW5EaXN0KSA9PiB7CiAgICBpZiAoIStuZXdMYXNzb01pbkRpc3QpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGFzc29NaW5EaXN0ID0gK25ld0xhc3NvTWluRGlzdDsKICAgIGxhc3NvTWFuYWdlci5zZXQoewogICAgICBtaW5EaXN0OiBsYXNzb01pbkRpc3QKICAgIH0pOwogIH07CiAgY29uc3Qgc2V0TGFzc29DbGVhckV2ZW50ID0gKG5ld0xhc3NvQ2xlYXJFdmVudCkgPT4gewogICAgbGFzc29DbGVhckV2ZW50ID0gbGltaXQoCiAgICAgIExBU1NPX0NMRUFSX0VWRU5UUywKICAgICAgbGFzc29DbGVhckV2ZW50CiAgICApKG5ld0xhc3NvQ2xlYXJFdmVudCk7CiAgfTsKICBjb25zdCBzZXRMYXNzb0luaXRpYXRvciA9IChuZXdMYXNzb0luaXRpYXRvcikgPT4gewogICAgbGFzc29Jbml0aWF0b3IgPSBCb29sZWFuKG5ld0xhc3NvSW5pdGlhdG9yKTsKICAgIGxhc3NvTWFuYWdlci5zZXQoewogICAgICBlbmFibGVJbml0aWF0b3I6IGxhc3NvSW5pdGlhdG9yCiAgICB9KTsKICB9OwogIGNvbnN0IHNldExhc3NvSW5pdGlhdG9yUGFyZW50RWxlbWVudCA9IChuZXdMYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQpID0+IHsKICAgIGxhc3NvSW5pdGlhdG9yUGFyZW50RWxlbWVudCA9IG5ld0xhc3NvSW5pdGlhdG9yUGFyZW50RWxlbWVudDsKICAgIGxhc3NvTWFuYWdlci5zZXQoewogICAgICBpbml0aWF0b3JQYXJlbnRFbGVtZW50OiBsYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQKICAgIH0pOwogIH07CiAgY29uc3Qgc2V0TGFzc29Mb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50ID0gKG5ld1BhcmVudEVsZW1lbnQpID0+IHsKICAgIGxhc3NvTG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudCA9IG5ld1BhcmVudEVsZW1lbnQ7CiAgICBsYXNzb01hbmFnZXIuc2V0KHsKICAgICAgbG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudDogbGFzc29Mb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50CiAgICB9KTsKICB9OwogIGNvbnN0IHNldExhc3NvT25Mb25nUHJlc3MgPSAobmV3TGFzc29PbkxvbmdQcmVzcykgPT4gewogICAgbGFzc29PbkxvbmdQcmVzcyA9IEJvb2xlYW4obmV3TGFzc29PbkxvbmdQcmVzcyk7CiAgfTsKICBjb25zdCBzZXRMYXNzb0xvbmdQcmVzc1RpbWUgPSAobmV3TGFzc29PbkxvbmdQcmVzc1RpbWUpID0+IHsKICAgIGxhc3NvTG9uZ1ByZXNzVGltZSA9IE51bWJlcihuZXdMYXNzb09uTG9uZ1ByZXNzVGltZSk7CiAgfTsKICBjb25zdCBzZXRMYXNzb0xvbmdQcmVzc0FmdGVyRWZmZWN0VGltZSA9IChuZXdUaW1lKSA9PiB7CiAgICBsYXNzb0xvbmdQcmVzc0FmdGVyRWZmZWN0VGltZSA9IE51bWJlcihuZXdUaW1lKTsKICB9OwogIGNvbnN0IHNldExhc3NvTG9uZ1ByZXNzRWZmZWN0RGVsYXkgPSAobmV3RGVsYXkpID0+IHsKICAgIGxhc3NvTG9uZ1ByZXNzRWZmZWN0RGVsYXkgPSBOdW1iZXIobmV3RGVsYXkpOwogIH07CiAgY29uc3Qgc2V0TGFzc29Mb25nUHJlc3NSZXZlcnRFZmZlY3RUaW1lID0gKG5ld1RpbWUpID0+IHsKICAgIGxhc3NvTG9uZ1ByZXNzUmV2ZXJ0RWZmZWN0VGltZSA9IE51bWJlcihuZXdUaW1lKTsKICB9OwogIGNvbnN0IHNldExhc3NvVHlwZSA9IChuZXdUeXBlKSA9PiB7CiAgICBpZiAobmV3VHlwZSA9PT0gImJydXNoIikgewogICAgICBsYXNzb01hbmFnZXIuc2V0KHsKICAgICAgICB0eXBlOiBuZXdUeXBlLAogICAgICAgIG1pbkRpc3Q6IE1hdGgubWF4KExBU1NPX0JSVVNIX01JTl9NSU5fRElTVCwgbGFzc29NaW5EaXN0KQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGxhc3NvTWFuYWdlci5zZXQoewogICAgICAgIHR5cGU6IG5ld1R5cGUsCiAgICAgICAgbWluRGlzdDogbGFzc29NaW5EaXN0CiAgICAgIH0pOwogICAgfQogICAgbGFzc29UeXBlID0gbGFzc29NYW5hZ2VyLmdldCgidHlwZSIpOwogIH07CiAgY29uc3Qgc2V0TGFzc29CcnVzaFNpemUgPSAobmV3QnJ1c2hTaXplKSA9PiB7CiAgICBsYXNzb0JydXNoU2l6ZSA9IE51bWJlcihuZXdCcnVzaFNpemUpIHx8IGxhc3NvQnJ1c2hTaXplOwogICAgbGFzc29NYW5hZ2VyLnNldCh7IGJydXNoU2l6ZTogbGFzc29CcnVzaFNpemUgfSk7CiAgfTsKICBjb25zdCB1cGRhdGVBY3Rpb25LZXlNYXBDaGFuZ2UgPSAoKSA9PiB7CiAgICBpZiAoYWN0aW9uS2V5TWFwW0tFWV9BQ1RJT05fUk9UQVRFXSkgewogICAgICBjYW1lcmEuY29uZmlnKHsKICAgICAgICBpc1JvdGF0ZTogdHJ1ZSwKICAgICAgICBtb3VzZURvd25Nb3ZlTW9kS2V5OiBhY3Rpb25LZXlNYXBbS0VZX0FDVElPTl9ST1RBVEVdCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY2FtZXJhLmNvbmZpZyh7CiAgICAgICAgaXNSb3RhdGU6IGZhbHNlCiAgICAgIH0pOwogICAgfQogIH07CiAgY29uc3Qgc2V0QWN0aW9uS2V5TWFwID0gKG5ld0FjdGlvbktleU1hcCkgPT4gewogICAgYWN0aW9uS2V5TWFwID0gT2JqZWN0LmVudHJpZXMobmV3QWN0aW9uS2V5TWFwKS5yZWR1Y2UoCiAgICAgIChtYXAzLCBbYWN0aW9uLCBrZXldKSA9PiB7CiAgICAgICAgaWYgKEtFWVMuaW5jbHVkZXMoa2V5KSAmJiBLRVlfQUNUSU9OUy5pbmNsdWRlcyhhY3Rpb24pKSB7CiAgICAgICAgICBtYXAzW2FjdGlvbl0gPSBrZXk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXAzOwogICAgICB9LAogICAgICB7fQogICAgKTsKICAgIHVwZGF0ZUFjdGlvbktleU1hcENoYW5nZSgpOwogIH07CiAgY29uc3Qgc2V0TW91c2VNb2RlID0gKG5ld01vdXNlTW9kZSkgPT4gewogICAgbW91c2VNb2RlID0gbGltaXQoTU9VU0VfTU9ERVMsIE1PVVNFX01PREVfUEFOWk9PTSkobmV3TW91c2VNb2RlKTsKICAgIGNhbWVyYS5jb25maWcoewogICAgICBkZWZhdWx0TW91c2VEb3duTW92ZUFjdGlvbjogbW91c2VNb2RlID09PSBNT1VTRV9NT0RFX1JPVEFURSA/ICJyb3RhdGUiIDogInBhbiIKICAgIH0pOwogIH07CiAgY29uc3Qgc2V0U2hvd1JldGljbGUgPSAobmV3U2hvd1JldGljbGUpID0+IHsKICAgIGlmIChuZXdTaG93UmV0aWNsZSA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzaG93UmV0aWNsZSA9IG5ld1Nob3dSZXRpY2xlOwogIH07CiAgY29uc3Qgc2V0UmV0aWNsZUNvbG9yID0gKG5ld1JldGljbGVDb2xvcikgPT4gewogICAgaWYgKCFuZXdSZXRpY2xlQ29sb3IpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0aWNsZUNvbG9yID0gdG9SZ2JhKG5ld1JldGljbGVDb2xvciwgdHJ1ZSk7CiAgICByZXRpY2xlSExpbmUuc2V0U3R5bGUoeyBjb2xvcjogcmV0aWNsZUNvbG9yIH0pOwogICAgcmV0aWNsZVZMaW5lLnNldFN0eWxlKHsgY29sb3I6IHJldGljbGVDb2xvciB9KTsKICB9OwogIGNvbnN0IHNldFhTY2FsZSA9IChuZXdYU2NhbGUpID0+IHsKICAgIGlmICghbmV3WFNjYWxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHhTY2FsZSA9IG5ld1hTY2FsZTsKICAgIHhEb21haW5TdGFydCA9IG5ld1hTY2FsZS5kb21haW4oKVswXTsKICAgIHhEb21haW5TaXplID0gbmV3WFNjYWxlID8gbmV3WFNjYWxlLmRvbWFpbigpWzFdIC0gbmV3WFNjYWxlLmRvbWFpbigpWzBdIDogMDsKICAgIHhTY2FsZS5yYW5nZShbMCwgY3VycmVudFdpZHRoXSk7CiAgICB1cGRhdGVTY2FsZXMoKTsKICB9OwogIGNvbnN0IHNldFlTY2FsZSA9IChuZXdZU2NhbGUpID0+IHsKICAgIGlmICghbmV3WVNjYWxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHlTY2FsZSA9IG5ld1lTY2FsZTsKICAgIHlEb21haW5TdGFydCA9IHlTY2FsZS5kb21haW4oKVswXTsKICAgIHlEb21haW5TaXplID0geVNjYWxlID8geVNjYWxlLmRvbWFpbigpWzFdIC0geVNjYWxlLmRvbWFpbigpWzBdIDogMDsKICAgIHlTY2FsZS5yYW5nZShbY3VycmVudEhlaWdodCwgMF0pOwogICAgdXBkYXRlU2NhbGVzKCk7CiAgfTsKICBjb25zdCBzZXREZXNlbGVjdE9uRGJsQ2xpY2sgPSAobmV3RGVzZWxlY3RPbkRibENsaWNrKSA9PiB7CiAgICBkZXNlbGVjdE9uRGJsQ2xpY2sgPSAhIW5ld0Rlc2VsZWN0T25EYmxDbGljazsKICB9OwogIGNvbnN0IHNldERlc2VsZWN0T25Fc2NhcGUgPSAobmV3RGVzZWxlY3RPbkVzY2FwZSkgPT4gewogICAgZGVzZWxlY3RPbkVzY2FwZSA9ICEhbmV3RGVzZWxlY3RPbkVzY2FwZTsKICB9OwogIGNvbnN0IHNldFNob3dQb2ludENvbm5lY3Rpb25zID0gKG5ld1Nob3dQb2ludENvbm5lY3Rpb25zKSA9PiB7CiAgICBzaG93UG9pbnRDb25uZWN0aW9ucyA9ICEhbmV3U2hvd1BvaW50Q29ubmVjdGlvbnM7CiAgICBpZiAoc2hvd1BvaW50Q29ubmVjdGlvbnMpIHsKICAgICAgaWYgKGlzUG9pbnRzRHJhd24gJiYgaGFzUG9pbnRDb25uZWN0aW9ucyhwb2ludHNbMF0pKSB7CiAgICAgICAgc2V0UG9pbnRDb25uZWN0aW9ucyhnZXRQb2ludHMoKSkudGhlbigoKSA9PiB7CiAgICAgICAgICBwdWJTdWIucHVibGlzaCgicG9pbnRDb25uZWN0aW9uc0RyYXciKTsKICAgICAgICAgIGRyYXcgPSB0cnVlOwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25zKCk7CiAgICB9CiAgfTsKICBjb25zdCBzZXRQb2ludENvbm5lY3Rpb25Db2xvcnMgPSAoc2V0dGVyLCBnZXRJbmhlcml0YW5jZSkgPT4gKG5ld0NvbG9ycykgPT4gewogICAgaWYgKG5ld0NvbG9ycyA9PT0gImluaGVyaXQiKSB7CiAgICAgIHNldHRlcihbLi4uZ2V0SW5oZXJpdGFuY2UoKV0pOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgdG1wQ29sb3JzID0gaXNNdWx0aXBsZUNvbG9ycyhuZXdDb2xvcnMpID8gbmV3Q29sb3JzIDogW25ld0NvbG9yc107CiAgICAgIHNldHRlcih0bXBDb2xvcnMubWFwKChjb2xvcjIpID0+IHRvUmdiYShjb2xvcjIsIHRydWUpKSk7CiAgICB9CiAgICB1cGRhdGVQb2ludENvbm5lY3Rpb25TdHlsZSgpOwogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3IgPSBzZXRQb2ludENvbm5lY3Rpb25Db2xvcnMoCiAgICAobmV3Q29sb3JzKSA9PiB7CiAgICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yID0gbmV3Q29sb3JzOwogICAgfSwKICAgICgpID0+IHBvaW50Q29sb3IKICApOwogIGNvbnN0IHNldFBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlID0gc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JzKAogICAgKG5ld0NvbG9ycykgPT4gewogICAgICBwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZSA9IG5ld0NvbG9yczsKICAgIH0sCiAgICAoKSA9PiBwb2ludENvbG9yQWN0aXZlCiAgKTsKICBjb25zdCBzZXRQb2ludENvbm5lY3Rpb25Db2xvckhvdmVyID0gc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JzKAogICAgKG5ld0NvbG9ycykgPT4gewogICAgICBwb2ludENvbm5lY3Rpb25Db2xvckhvdmVyID0gbmV3Q29sb3JzOwogICAgfSwKICAgICgpID0+IHBvaW50Q29sb3JIb3ZlcgogICk7CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uT3BhY2l0eSA9IChuZXdPcGFjaXR5KSA9PiB7CiAgICBpZiAoaXNDb25kaXRpb25hbEFycmF5KG5ld09wYWNpdHksIGlzUG9zaXRpdmVOdW1iZXIsIHsgbWluTGVuZ3RoOiAxIH0pKSB7CiAgICAgIHBvaW50Q29ubmVjdGlvbk9wYWNpdHkgPSBbLi4ubmV3T3BhY2l0eV07CiAgICB9CiAgICBpZiAoaXNTdHJpY3RseVBvc2l0aXZlTnVtYmVyKCtuZXdPcGFjaXR5KSkgewogICAgICBwb2ludENvbm5lY3Rpb25PcGFjaXR5ID0gWytuZXdPcGFjaXR5XTsKICAgIH0KICAgIHBvaW50Q29ubmVjdGlvbkNvbG9yID0gcG9pbnRDb25uZWN0aW9uQ29sb3IubWFwKChjb2xvcjIpID0+IHsKICAgICAgY29sb3IyWzNdID0gTnVtYmVyLmlzTmFOKCtwb2ludENvbm5lY3Rpb25PcGFjaXR5WzBdKSA/IGNvbG9yMlszXSA6ICtwb2ludENvbm5lY3Rpb25PcGFjaXR5WzBdOwogICAgICByZXR1cm4gY29sb3IyOwogICAgfSk7CiAgICB1cGRhdGVQb2ludENvbm5lY3Rpb25TdHlsZSgpOwogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uT3BhY2l0eUFjdGl2ZSA9IChuZXdPcGFjaXR5KSA9PiB7CiAgICBpZiAoIU51bWJlci5pc05hTigrbmV3T3BhY2l0eSkgJiYgK25ld09wYWNpdHkpIHsKICAgICAgcG9pbnRDb25uZWN0aW9uT3BhY2l0eUFjdGl2ZSA9ICtuZXdPcGFjaXR5OwogICAgfQogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uU2l6ZSA9IChuZXdQb2ludENvbm5lY3Rpb25TaXplKSA9PiB7CiAgICBpZiAoaXNDb25kaXRpb25hbEFycmF5KG5ld1BvaW50Q29ubmVjdGlvblNpemUsIGlzUG9zaXRpdmVOdW1iZXIsIHsKICAgICAgbWluTGVuZ3RoOiAxCiAgICB9KSkgewogICAgICBwb2ludENvbm5lY3Rpb25TaXplID0gWy4uLm5ld1BvaW50Q29ubmVjdGlvblNpemVdOwogICAgfQogICAgaWYgKGlzU3RyaWN0bHlQb3NpdGl2ZU51bWJlcigrbmV3UG9pbnRDb25uZWN0aW9uU2l6ZSkpIHsKICAgICAgcG9pbnRDb25uZWN0aW9uU2l6ZSA9IFsrbmV3UG9pbnRDb25uZWN0aW9uU2l6ZV07CiAgICB9CiAgICB1cGRhdGVQb2ludENvbm5lY3Rpb25TdHlsZSgpOwogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uU2l6ZUFjdGl2ZSA9IChuZXdQb2ludENvbm5lY3Rpb25TaXplQWN0aXZlKSA9PiB7CiAgICBpZiAoIU51bWJlci5pc05hTigrbmV3UG9pbnRDb25uZWN0aW9uU2l6ZUFjdGl2ZSkgJiYgK25ld1BvaW50Q29ubmVjdGlvblNpemVBY3RpdmUpIHsKICAgICAgcG9pbnRDb25uZWN0aW9uU2l6ZUFjdGl2ZSA9IE1hdGgubWF4KDAsIG5ld1BvaW50Q29ubmVjdGlvblNpemVBY3RpdmUpOwogICAgfQogIH07CiAgY29uc3Qgc2V0UG9pbnRDb25uZWN0aW9uTWF4SW50UG9pbnRzUGVyU2VnbWVudCA9IChuZXdQb2ludENvbm5lY3Rpb25NYXhJbnRQb2ludHNQZXJTZWdtZW50KSA9PiB7CiAgICBwb2ludENvbm5lY3Rpb25NYXhJbnRQb2ludHNQZXJTZWdtZW50ID0gTWF0aC5tYXgoCiAgICAgIDAsCiAgICAgIG5ld1BvaW50Q29ubmVjdGlvbk1heEludFBvaW50c1BlclNlZ21lbnQKICAgICk7CiAgfTsKICBjb25zdCBzZXRQb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UgPSAobmV3UG9pbnRDb25uZWN0aW9uVG9sZXJhbmNlKSA9PiB7CiAgICBwb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UgPSBNYXRoLm1heCgwLCBuZXdQb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UpOwogIH07CiAgY29uc3Qgc2V0UG9pbnRTaXplTW91c2VEZXRlY3Rpb24gPSAobmV3UG9pbnRTaXplTW91c2VEZXRlY3Rpb24pID0+IHsKICAgIHBvaW50U2l6ZU1vdXNlRGV0ZWN0aW9uID0gbmV3UG9pbnRTaXplTW91c2VEZXRlY3Rpb247CiAgICBjb21wdXRlUG9pbnRTaXplTW91c2VEZXRlY3Rpb24oKTsKICB9OwogIGNvbnN0IHNldFBvaW50U2NhbGVNb2RlID0gKG5ld1BvaW50U2NhbGVNb2RlKSA9PiB7CiAgICBzd2l0Y2ggKG5ld1BvaW50U2NhbGVNb2RlKSB7CiAgICAgIGNhc2UgImxpbmVhciI6IHsKICAgICAgICBwb2ludFNjYWxlTW9kZSA9IG5ld1BvaW50U2NhbGVNb2RlOwogICAgICAgIGdldFBvaW50U2NhbGUgPSBnZXRMaW5lYXJQb2ludFNjYWxlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgImNvbnN0YW50IjogewogICAgICAgIHBvaW50U2NhbGVNb2RlID0gbmV3UG9pbnRTY2FsZU1vZGU7CiAgICAgICAgZ2V0UG9pbnRTY2FsZSA9IGdldENvbnN0YW50UG9pbnRTY2FsZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBkZWZhdWx0OiB7CiAgICAgICAgcG9pbnRTY2FsZU1vZGUgPSAiYXNpbmgiOwogICAgICAgIGdldFBvaW50U2NhbGUgPSBnZXRBc2luaFBvaW50U2NhbGU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9OwogIGNvbnN0IHNldE9wYWNpdHlCeURlbnNpdHlGaWxsID0gKG5ld09wYWNpdHlCeURlbnNpdHlGaWxsKSA9PiB7CiAgICBvcGFjaXR5QnlEZW5zaXR5RmlsbCA9ICtuZXdPcGFjaXR5QnlEZW5zaXR5RmlsbDsKICB9OwogIGNvbnN0IHNldE9wYWNpdHlJbmFjdGl2ZU1heCA9IChuZXdPcGFjaXR5SW5hY3RpdmVNYXgpID0+IHsKICAgIG9wYWNpdHlJbmFjdGl2ZU1heCA9ICtuZXdPcGFjaXR5SW5hY3RpdmVNYXg7CiAgfTsKICBjb25zdCBzZXRPcGFjaXR5SW5hY3RpdmVTY2FsZSA9IChuZXdPcGFjaXR5SW5hY3RpdmVTY2FsZSkgPT4gewogICAgb3BhY2l0eUluYWN0aXZlU2NhbGUgPSArbmV3T3BhY2l0eUluYWN0aXZlU2NhbGU7CiAgfTsKICBjb25zdCBzZXRBbm5vdGF0aW9uTGluZUNvbG9yID0gKG5ld0Fubm90YXRpb25MaW5lQ29sb3IpID0+IHsKICAgIGFubm90YXRpb25MaW5lQ29sb3IgPSB0b1JnYmEobmV3QW5ub3RhdGlvbkxpbmVDb2xvcik7CiAgfTsKICBjb25zdCBzZXRBbm5vdGF0aW9uTGluZVdpZHRoID0gKG5ld0Fubm90YXRpb25MaW5lV2lkdGgpID0+IHsKICAgIGFubm90YXRpb25MaW5lV2lkdGggPSArbmV3QW5ub3RhdGlvbkxpbmVXaWR0aDsKICB9OwogIGNvbnN0IHNldEFubm90YXRpb25IVkxpbmVMaW1pdCA9IChuZXdBbm5vdGF0aW9uSFZMaW5lTGltaXQpID0+IHsKICAgIGFubm90YXRpb25IVkxpbmVMaW1pdCA9ICtuZXdBbm5vdGF0aW9uSFZMaW5lTGltaXQ7CiAgfTsKICBjb25zdCBzZXRHYW1tYSA9IChuZXdHYW1tYSkgPT4gewogICAgcmVuZGVyZXIuZ2FtbWEgPSBuZXdHYW1tYTsKICB9OwogIGNvbnN0IHNldEFudGlBbGlhc2luZyA9IChuZXdBbnRpQWxpYXNpbmcpID0+IHsKICAgIGFudGlBbGlhc2luZyA9IE51bWJlcihuZXdBbnRpQWxpYXNpbmcpIHx8IDAuNTsKICB9OwogIGNvbnN0IHNldFBpeGVsQWxpZ25lZCA9IChuZXdQaXhlbEFsaWduZWQpID0+IHsKICAgIHBpeGVsQWxpZ25lZCA9IEJvb2xlYW4obmV3UGl4ZWxBbGlnbmVkKTsKICB9OwogIGNvbnN0IGdldCA9IChwcm9wKSA9PiB7CiAgICBjb25zdCBbcHJvcGVydHldID0gT2JqZWN0LmtleXMoCiAgICAgIGNoZWNrRGVwcmVjYXRpb25zKHsKICAgICAgICBbcHJvcF06IFNLSVBfREVQUkVDQVRJT05fVkFMVUVfVFJBTlNMQVRJT04KICAgICAgfSkKICAgICk7CiAgICBpZiAocHJvcGVydHkgPT09ICJhc3BlY3RSYXRpbyIpIHsKICAgICAgcmV0dXJuIGRhdGFBc3BlY3RSYXRpbzsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImJhY2tncm91bmQiKSB7CiAgICAgIHJldHVybiBiYWNrZ3JvdW5kQ29sb3I7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJiYWNrZ3JvdW5kQ29sb3IiKSB7CiAgICAgIHJldHVybiBiYWNrZ3JvdW5kQ29sb3I7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJiYWNrZ3JvdW5kSW1hZ2UiKSB7CiAgICAgIHJldHVybiBiYWNrZ3JvdW5kSW1hZ2U7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJjYW1lcmEiKSB7CiAgICAgIHJldHVybiBjYW1lcmE7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJjYW1lcmFUYXJnZXQiKSB7CiAgICAgIHJldHVybiBjYW1lcmEudGFyZ2V0OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiY2FtZXJhRGlzdGFuY2UiKSB7CiAgICAgIHJldHVybiBjYW1lcmEuZGlzdGFuY2VbMF07CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJjYW1lcmFSb3RhdGlvbiIpIHsKICAgICAgcmV0dXJuIGNhbWVyYS5yb3RhdGlvbjsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImNhbWVyYVZpZXciKSB7CiAgICAgIHJldHVybiBjYW1lcmEudmlldzsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImNhbWVyYUlzRml4ZWQiKSB7CiAgICAgIHJldHVybiBjYW1lcmFJc0ZpeGVkOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiY2FudmFzIikgewogICAgICByZXR1cm4gY2FudmFzOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiY29sb3JCeSIpIHsKICAgICAgcmV0dXJuIGNvbG9yQnk7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJzaXplQnkiKSB7CiAgICAgIHJldHVybiBzaXplQnk7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJkZXNlbGVjdE9uRGJsQ2xpY2siKSB7CiAgICAgIHJldHVybiBkZXNlbGVjdE9uRGJsQ2xpY2s7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJkZXNlbGVjdE9uRXNjYXBlIikgewogICAgICByZXR1cm4gZGVzZWxlY3RPbkVzY2FwZTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImhlaWdodCIpIHsKICAgICAgcmV0dXJuIGhlaWdodDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImxhc3NvQ29sb3IiKSB7CiAgICAgIHJldHVybiBsYXNzb0NvbG9yOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAibGFzc29MaW5lV2lkdGgiKSB7CiAgICAgIHJldHVybiBsYXNzb0xpbmVXaWR0aDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImxhc3NvTWluRGVsYXkiKSB7CiAgICAgIHJldHVybiBsYXNzb01pbkRlbGF5OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAibGFzc29NaW5EaXN0IikgewogICAgICByZXR1cm4gbGFzc29NaW5EaXN0OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAibGFzc29DbGVhckV2ZW50IikgewogICAgICByZXR1cm4gbGFzc29DbGVhckV2ZW50OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAibGFzc29Jbml0aWF0b3IiKSB7CiAgICAgIHJldHVybiBsYXNzb0luaXRpYXRvcjsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImxhc3NvSW5pdGlhdG9yRWxlbWVudCIpIHsKICAgICAgcmV0dXJuIGxhc3NvTWFuYWdlci5pbml0aWF0b3I7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJsYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQiKSB7CiAgICAgIHJldHVybiBsYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQ7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJsYXNzb0xvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQiKSB7CiAgICAgIHJldHVybiBsYXNzb0xvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQ7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJsYXNzb09uTG9uZ1ByZXNzIikgewogICAgICByZXR1cm4gbGFzc29PbkxvbmdQcmVzczsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImxhc3NvVHlwZSIpIHsKICAgICAgcmV0dXJuIGxhc3NvVHlwZTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImxhc3NvQnJ1c2hTaXplIikgewogICAgICByZXR1cm4gbGFzc29CcnVzaFNpemU7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJtb3VzZU1vZGUiKSB7CiAgICAgIHJldHVybiBtb3VzZU1vZGU7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJvcGFjaXR5IikgewogICAgICByZXR1cm4gb3BhY2l0eS5sZW5ndGggPT09IDEgPyBvcGFjaXR5WzBdIDogb3BhY2l0eTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gIm9wYWNpdHlCeSIpIHsKICAgICAgcmV0dXJuIG9wYWNpdHlCeTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gIm9wYWNpdHlCeURlbnNpdHlGaWxsIikgewogICAgICByZXR1cm4gb3BhY2l0eUJ5RGVuc2l0eUZpbGw7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJvcGFjaXR5QnlEZW5zaXR5RGVib3VuY2VUaW1lIikgewogICAgICByZXR1cm4gb3BhY2l0eUJ5RGVuc2l0eURlYm91bmNlVGltZTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gIm9wYWNpdHlJbmFjdGl2ZU1heCIpIHsKICAgICAgcmV0dXJuIG9wYWNpdHlJbmFjdGl2ZU1heDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gIm9wYWNpdHlJbmFjdGl2ZVNjYWxlIikgewogICAgICByZXR1cm4gb3BhY2l0eUluYWN0aXZlU2NhbGU7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludHMiKSB7CiAgICAgIHJldHVybiBwb2ludHM7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJob3ZlcmVkUG9pbnQiKSB7CiAgICAgIHJldHVybiBob3ZlcmVkUG9pbnQ7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJzZWxlY3RlZFBvaW50cyIpIHsKICAgICAgcmV0dXJuIFsuLi5zZWxlY3RlZFBvaW50c107CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJmaWx0ZXJlZFBvaW50cyIpIHsKICAgICAgcmV0dXJuIGlzUG9pbnRzRmlsdGVyZWQgPyBBcnJheS5mcm9tKGZpbHRlcmVkUG9pbnRzU2V0KSA6IEFycmF5LmZyb20oeyBsZW5ndGg6IHBvaW50cy5sZW5ndGggfSwgKF8sIGkpID0+IGkpOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRzSW5WaWV3IikgewogICAgICByZXR1cm4gZ2V0UG9pbnRzSW5WaWV3KCk7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludENvbG9yIikgewogICAgICByZXR1cm4gcG9pbnRDb2xvci5sZW5ndGggPT09IDEgPyBwb2ludENvbG9yWzBdIDogcG9pbnRDb2xvcjsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gInBvaW50Q29sb3JBY3RpdmUiKSB7CiAgICAgIHJldHVybiBwb2ludENvbG9yQWN0aXZlLmxlbmd0aCA9PT0gMSA/IHBvaW50Q29sb3JBY3RpdmVbMF0gOiBwb2ludENvbG9yQWN0aXZlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb2xvckhvdmVyIikgewogICAgICByZXR1cm4gcG9pbnRDb2xvckhvdmVyLmxlbmd0aCA9PT0gMSA/IHBvaW50Q29sb3JIb3ZlclswXSA6IHBvaW50Q29sb3JIb3ZlcjsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gInBvaW50T3V0bGluZVdpZHRoIikgewogICAgICByZXR1cm4gcG9pbnRPdXRsaW5lV2lkdGg7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludFNpemUiKSB7CiAgICAgIHJldHVybiBwb2ludFNpemUubGVuZ3RoID09PSAxID8gcG9pbnRTaXplWzBdIDogcG9pbnRTaXplOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRTaXplU2VsZWN0ZWQiKSB7CiAgICAgIHJldHVybiBwb2ludFNpemVTZWxlY3RlZDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gInBvaW50U2l6ZU1vdXNlRGV0ZWN0aW9uIikgewogICAgICByZXR1cm4gcG9pbnRTaXplTW91c2VEZXRlY3Rpb247CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJzaG93UG9pbnRDb25uZWN0aW9ucyIpIHsKICAgICAgcmV0dXJuIHNob3dQb2ludENvbm5lY3Rpb25zOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uQ29sb3IiKSB7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25Db2xvci5sZW5ndGggPT09IDEgPyBwb2ludENvbm5lY3Rpb25Db2xvclswXSA6IHBvaW50Q29ubmVjdGlvbkNvbG9yOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uQ29sb3JBY3RpdmUiKSB7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZS5sZW5ndGggPT09IDEgPyBwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZVswXSA6IHBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uQ29sb3JIb3ZlciIpIHsKICAgICAgcmV0dXJuIHBvaW50Q29ubmVjdGlvbkNvbG9ySG92ZXIubGVuZ3RoID09PSAxID8gcG9pbnRDb25uZWN0aW9uQ29sb3JIb3ZlclswXSA6IHBvaW50Q29ubmVjdGlvbkNvbG9ySG92ZXI7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludENvbm5lY3Rpb25Db2xvckJ5IikgewogICAgICByZXR1cm4gcG9pbnRDb25uZWN0aW9uQ29sb3JCeTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gInBvaW50Q29ubmVjdGlvbk9wYWNpdHkiKSB7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25PcGFjaXR5Lmxlbmd0aCA9PT0gMSA/IHBvaW50Q29ubmVjdGlvbk9wYWNpdHlbMF0gOiBwb2ludENvbm5lY3Rpb25PcGFjaXR5OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uT3BhY2l0eUJ5IikgewogICAgICByZXR1cm4gcG9pbnRDb25uZWN0aW9uT3BhY2l0eUJ5OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uT3BhY2l0eUFjdGl2ZSIpIHsKICAgICAgcmV0dXJuIHBvaW50Q29ubmVjdGlvbk9wYWNpdHlBY3RpdmU7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludENvbm5lY3Rpb25TaXplIikgewogICAgICByZXR1cm4gcG9pbnRDb25uZWN0aW9uU2l6ZS5sZW5ndGggPT09IDEgPyBwb2ludENvbm5lY3Rpb25TaXplWzBdIDogcG9pbnRDb25uZWN0aW9uU2l6ZTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gInBvaW50Q29ubmVjdGlvblNpemVBY3RpdmUiKSB7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25TaXplQWN0aXZlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uU2l6ZUJ5IikgewogICAgICByZXR1cm4gcG9pbnRDb25uZWN0aW9uU2l6ZUJ5OwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicG9pbnRDb25uZWN0aW9uTWF4SW50UG9pbnRzUGVyU2VnbWVudCIpIHsKICAgICAgcmV0dXJuIHBvaW50Q29ubmVjdGlvbk1heEludFBvaW50c1BlclNlZ21lbnQ7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UiKSB7CiAgICAgIHJldHVybiBwb2ludENvbm5lY3Rpb25Ub2xlcmFuY2U7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJwb2ludFNjYWxlTW9kZSIpIHsKICAgICAgcmV0dXJuIHBvaW50U2NhbGVNb2RlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicmV0aWNsZUNvbG9yIikgewogICAgICByZXR1cm4gcmV0aWNsZUNvbG9yOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicmVnbCIpIHsKICAgICAgcmV0dXJuIHJlbmRlcmVyLnJlZ2w7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJzaG93UmV0aWNsZSIpIHsKICAgICAgcmV0dXJuIHNob3dSZXRpY2xlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAidmVyc2lvbiIpIHsKICAgICAgcmV0dXJuIHZlcnNpb247CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJ3aWR0aCIpIHsKICAgICAgcmV0dXJuIHdpZHRoOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAieFNjYWxlIikgewogICAgICByZXR1cm4geFNjYWxlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAieVNjYWxlIikgewogICAgICByZXR1cm4geVNjYWxlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicGVyZm9ybWFuY2VNb2RlIikgewogICAgICByZXR1cm4gcGVyZm9ybWFuY2VNb2RlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAicmVuZGVyUG9pbnRzQXNTcXVhcmVzIikgewogICAgICByZXR1cm4gcmVuZGVyUG9pbnRzQXNTcXVhcmVzOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiZGlzYWJsZUFscGhhQmxlbmRpbmciKSB7CiAgICAgIHJldHVybiBkaXNhYmxlQWxwaGFCbGVuZGluZzsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImdhbW1hIikgewogICAgICByZXR1cm4gcmVuZGVyZXIuZ2FtbWE7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJyZW5kZXJlciIpIHsKICAgICAgcmV0dXJuIHJlbmRlcmVyOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiaXNEZXN0cm95ZWQiKSB7CiAgICAgIHJldHVybiBpc0Rlc3Ryb3llZDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImlzRHJhd2luZyIpIHsKICAgICAgcmV0dXJuIGlzRHJhd2luZzsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImlzUG9pbnRzRHJhd24iKSB7CiAgICAgIHJldHVybiBpc1BvaW50c0RyYXduOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiaXNQb2ludHNGaWx0ZXJlZCIpIHsKICAgICAgcmV0dXJuIGlzUG9pbnRzRmlsdGVyZWQ7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJpc0Fubm90YXRpb25zRHJhd24iKSB7CiAgICAgIHJldHVybiBpc0Fubm90YXRpb25zRHJhd247CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJ6RGF0YVR5cGUiKSB7CiAgICAgIHJldHVybiB2YWx1ZVpEYXRhVHlwZTsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gIndEYXRhVHlwZSIpIHsKICAgICAgcmV0dXJuIHZhbHVlV0RhdGFUeXBlOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAic3BhdGlhbEluZGV4IikgewogICAgICByZXR1cm4gc3BhdGlhbEluZGV4Py5kYXRhOwogICAgfQogICAgaWYgKHByb3BlcnR5ID09PSAiYW5ub3RhdGlvbkxpbmVDb2xvciIpIHsKICAgICAgcmV0dXJuIGFubm90YXRpb25MaW5lQ29sb3I7CiAgICB9CiAgICBpZiAocHJvcGVydHkgPT09ICJhbm5vdGF0aW9uTGluZVdpZHRoIikgewogICAgICByZXR1cm4gYW5ub3RhdGlvbkxpbmVXaWR0aDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImFubm90YXRpb25IVkxpbmVMaW1pdCIpIHsKICAgICAgcmV0dXJuIGFubm90YXRpb25IVkxpbmVMaW1pdDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImFudGlBbGlhc2luZyIpIHsKICAgICAgcmV0dXJuIGFudGlBbGlhc2luZzsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gInBpeGVsQWxpZ25lZCIpIHsKICAgICAgcmV0dXJuIHBpeGVsQWxpZ25lZDsKICAgIH0KICAgIGlmIChwcm9wZXJ0eSA9PT0gImFjdGlvbktleU1hcCIpIHsKICAgICAgcmV0dXJuIHsgLi4uYWN0aW9uS2V5TWFwIH07CiAgICB9CiAgICByZXR1cm4gdm9pZCAwOwogIH07CiAgY29uc3Qgc2V0ID0gKHByb3BlcnRpZXMyID0ge30pID0+IHsKICAgIGlmIChpc0Rlc3Ryb3llZCkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKEVSUk9SX0lOU1RBTkNFX0lTX0RFU1RST1lFRCkpOwogICAgfQogICAgY2hlY2tEZXByZWNhdGlvbnMocHJvcGVydGllczIpOwogICAgaWYgKHByb3BlcnRpZXMyLmJhY2tncm91bmRDb2xvciAhPT0gdm9pZCAwIHx8IHByb3BlcnRpZXMyLmJhY2tncm91bmQgIT09IHZvaWQgMCkgewogICAgICBzZXRCYWNrZ3JvdW5kQ29sb3IocHJvcGVydGllczIuYmFja2dyb3VuZENvbG9yIHx8IHByb3BlcnRpZXMyLmJhY2tncm91bmQpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmJhY2tncm91bmRJbWFnZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldEJhY2tncm91bmRJbWFnZShwcm9wZXJ0aWVzMi5iYWNrZ3JvdW5kSW1hZ2UpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmNhbWVyYVRhcmdldCAhPT0gdm9pZCAwKSB7CiAgICAgIHNldENhbWVyYVRhcmdldChwcm9wZXJ0aWVzMi5jYW1lcmFUYXJnZXQpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmNhbWVyYURpc3RhbmNlICE9PSB2b2lkIDApIHsKICAgICAgc2V0Q2FtZXJhRGlzdGFuY2UocHJvcGVydGllczIuY2FtZXJhRGlzdGFuY2UpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmNhbWVyYVJvdGF0aW9uICE9PSB2b2lkIDApIHsKICAgICAgc2V0Q2FtZXJhUm90YXRpb24ocHJvcGVydGllczIuY2FtZXJhUm90YXRpb24pOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmNhbWVyYVZpZXcgIT09IHZvaWQgMCkgewogICAgICBzZXRDYW1lcmFWaWV3KHByb3BlcnRpZXMyLmNhbWVyYVZpZXcpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmNhbWVyYUlzRml4ZWQgIT09IHZvaWQgMCkgewogICAgICBzZXRDYW1lcmFJc0ZpeGVkKHByb3BlcnRpZXMyLmNhbWVyYUlzRml4ZWQpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmNvbG9yQnkgIT09IHZvaWQgMCkgewogICAgICBzZXRDb2xvckJ5KHByb3BlcnRpZXMyLmNvbG9yQnkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29sb3IgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbG9yKHByb3BlcnRpZXMyLnBvaW50Q29sb3IpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29sb3JBY3RpdmUgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbG9yQWN0aXZlKHByb3BlcnRpZXMyLnBvaW50Q29sb3JBY3RpdmUpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29sb3JIb3ZlciAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFBvaW50Q29sb3JIb3Zlcihwcm9wZXJ0aWVzMi5wb2ludENvbG9ySG92ZXIpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50U2l6ZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFBvaW50U2l6ZShwcm9wZXJ0aWVzMi5wb2ludFNpemUpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50U2l6ZVNlbGVjdGVkICE9PSB2b2lkIDApIHsKICAgICAgc2V0UG9pbnRTaXplU2VsZWN0ZWQocHJvcGVydGllczIucG9pbnRTaXplU2VsZWN0ZWQpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50U2l6ZU1vdXNlRGV0ZWN0aW9uICE9PSB2b2lkIDApIHsKICAgICAgc2V0UG9pbnRTaXplTW91c2VEZXRlY3Rpb24ocHJvcGVydGllczIucG9pbnRTaXplTW91c2VEZXRlY3Rpb24pOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnNpemVCeSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFNpemVCeShwcm9wZXJ0aWVzMi5zaXplQnkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLm9wYWNpdHkgIT09IHZvaWQgMCkgewogICAgICBzZXRPcGFjaXR5KHByb3BlcnRpZXMyLm9wYWNpdHkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnNob3dQb2ludENvbm5lY3Rpb25zICE9PSB2b2lkIDApIHsKICAgICAgc2V0U2hvd1BvaW50Q29ubmVjdGlvbnMocHJvcGVydGllczIuc2hvd1BvaW50Q29ubmVjdGlvbnMpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbkNvbG9yICE9PSB2b2lkIDApIHsKICAgICAgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3IocHJvcGVydGllczIucG9pbnRDb25uZWN0aW9uQ29sb3IpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlICE9PSB2b2lkIDApIHsKICAgICAgc2V0UG9pbnRDb25uZWN0aW9uQ29sb3JBY3RpdmUocHJvcGVydGllczIucG9pbnRDb25uZWN0aW9uQ29sb3JBY3RpdmUpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbkNvbG9ySG92ZXIgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25Db2xvckhvdmVyKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbkNvbG9ySG92ZXIpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbkNvbG9yQnkgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25Db2xvckJ5KHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbkNvbG9yQnkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeShwcm9wZXJ0aWVzMi5wb2ludENvbm5lY3Rpb25PcGFjaXR5QnkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk9wYWNpdHkgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25PcGFjaXR5KHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk9wYWNpdHkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk9wYWNpdHlBY3RpdmUgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25PcGFjaXR5QWN0aXZlKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk9wYWNpdHlBY3RpdmUpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvblNpemUgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25TaXplKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvblNpemUpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvblNpemVBY3RpdmUgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25TaXplQWN0aXZlKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvblNpemVBY3RpdmUpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvblNpemVCeSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFBvaW50Q29ubmVjdGlvblNpemVCeShwcm9wZXJ0aWVzMi5wb2ludENvbm5lY3Rpb25TaXplQnkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk1heEludFBvaW50c1BlclNlZ21lbnQgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25NYXhJbnRQb2ludHNQZXJTZWdtZW50KAogICAgICAgIHByb3BlcnRpZXMyLnBvaW50Q29ubmVjdGlvbk1heEludFBvaW50c1BlclNlZ21lbnQKICAgICAgKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5wb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UgIT09IHZvaWQgMCkgewogICAgICBzZXRQb2ludENvbm5lY3Rpb25Ub2xlcmFuY2UocHJvcGVydGllczIucG9pbnRDb25uZWN0aW9uVG9sZXJhbmNlKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5wb2ludFNjYWxlTW9kZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFBvaW50U2NhbGVNb2RlKHByb3BlcnRpZXMyLnBvaW50U2NhbGVNb2RlKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5vcGFjaXR5QnkgIT09IHZvaWQgMCkgewogICAgICBzZXRPcGFjaXR5QnkocHJvcGVydGllczIub3BhY2l0eUJ5KTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0NvbG9yICE9PSB2b2lkIDApIHsKICAgICAgc2V0TGFzc29Db2xvcihwcm9wZXJ0aWVzMi5sYXNzb0NvbG9yKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0xpbmVXaWR0aCAhPT0gdm9pZCAwKSB7CiAgICAgIHNldExhc3NvTGluZVdpZHRoKHByb3BlcnRpZXMyLmxhc3NvTGluZVdpZHRoKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb01pbkRlbGF5ICE9PSB2b2lkIDApIHsKICAgICAgc2V0TGFzc29NaW5EZWxheShwcm9wZXJ0aWVzMi5sYXNzb01pbkRlbGF5KTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb01pbkRpc3QgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb01pbkRpc3QocHJvcGVydGllczIubGFzc29NaW5EaXN0KTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0NsZWFyRXZlbnQgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb0NsZWFyRXZlbnQocHJvcGVydGllczIubGFzc29DbGVhckV2ZW50KTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0luaXRpYXRvciAhPT0gdm9pZCAwKSB7CiAgICAgIHNldExhc3NvSW5pdGlhdG9yKHByb3BlcnRpZXMyLmxhc3NvSW5pdGlhdG9yKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQocHJvcGVydGllczIubGFzc29Jbml0aWF0b3JQYXJlbnRFbGVtZW50KTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0xvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb0xvbmdQcmVzc0luZGljYXRvclBhcmVudEVsZW1lbnQoCiAgICAgICAgcHJvcGVydGllczIubGFzc29Mb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50CiAgICAgICk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIubGFzc29PbkxvbmdQcmVzcyAhPT0gdm9pZCAwKSB7CiAgICAgIHNldExhc3NvT25Mb25nUHJlc3MocHJvcGVydGllczIubGFzc29PbkxvbmdQcmVzcyk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIubGFzc29Mb25nUHJlc3NUaW1lICE9PSB2b2lkIDApIHsKICAgICAgc2V0TGFzc29Mb25nUHJlc3NUaW1lKHByb3BlcnRpZXMyLmxhc3NvTG9uZ1ByZXNzVGltZSk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIubGFzc29Mb25nUHJlc3NBZnRlckVmZmVjdFRpbWUgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb0xvbmdQcmVzc0FmdGVyRWZmZWN0VGltZSgKICAgICAgICBwcm9wZXJ0aWVzMi5sYXNzb0xvbmdQcmVzc0FmdGVyRWZmZWN0VGltZQogICAgICApOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmxhc3NvTG9uZ1ByZXNzRWZmZWN0RGVsYXkgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb0xvbmdQcmVzc0VmZmVjdERlbGF5KHByb3BlcnRpZXMyLmxhc3NvTG9uZ1ByZXNzRWZmZWN0RGVsYXkpOwogICAgfQogICAgaWYgKHByb3BlcnRpZXMyLmxhc3NvTG9uZ1ByZXNzUmV2ZXJ0RWZmZWN0VGltZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldExhc3NvTG9uZ1ByZXNzUmV2ZXJ0RWZmZWN0VGltZSgKICAgICAgICBwcm9wZXJ0aWVzMi5sYXNzb0xvbmdQcmVzc1JldmVydEVmZmVjdFRpbWUKICAgICAgKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb1R5cGUgIT09IHZvaWQgMCkgewogICAgICBzZXRMYXNzb1R5cGUocHJvcGVydGllczIubGFzc29UeXBlKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5sYXNzb0JydXNoU2l6ZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldExhc3NvQnJ1c2hTaXplKHByb3BlcnRpZXMyLmxhc3NvQnJ1c2hTaXplKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5hY3Rpb25LZXlNYXAgIT09IHZvaWQgMCkgewogICAgICBzZXRBY3Rpb25LZXlNYXAocHJvcGVydGllczIuYWN0aW9uS2V5TWFwKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5tb3VzZU1vZGUgIT09IHZvaWQgMCkgewogICAgICBzZXRNb3VzZU1vZGUocHJvcGVydGllczIubW91c2VNb2RlKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5zaG93UmV0aWNsZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFNob3dSZXRpY2xlKHByb3BlcnRpZXMyLnNob3dSZXRpY2xlKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5yZXRpY2xlQ29sb3IgIT09IHZvaWQgMCkgewogICAgICBzZXRSZXRpY2xlQ29sb3IocHJvcGVydGllczIucmV0aWNsZUNvbG9yKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5wb2ludE91dGxpbmVXaWR0aCAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFBvaW50T3V0bGluZVdpZHRoKHByb3BlcnRpZXMyLnBvaW50T3V0bGluZVdpZHRoKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5oZWlnaHQgIT09IHZvaWQgMCkgewogICAgICBzZXRIZWlnaHQocHJvcGVydGllczIuaGVpZ2h0KTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi53aWR0aCAhPT0gdm9pZCAwKSB7CiAgICAgIHNldFdpZHRoKHByb3BlcnRpZXMyLndpZHRoKTsKICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzMi5hc3BlY3RSYXRpbyAhPT0gdm9pZCAwKSB7CiAgICAgIHNldERhdGFBc3BlY3RSYXRpbyhwcm9wZXJ0aWVzMi5hc3BlY3RSYXRpbyk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIueFNjYWxlICE9PSB2b2lkIDApIHsKICAgICAgc2V0WFNjYWxlKHByb3BlcnRpZXMyLnhTY2FsZSk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIueVNjYWxlICE9PSB2b2lkIDApIHsKICAgICAgc2V0WVNjYWxlKHByb3BlcnRpZXMyLnlTY2FsZSk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuZGVzZWxlY3RPbkRibENsaWNrICE9PSB2b2lkIDApIHsKICAgICAgc2V0RGVzZWxlY3RPbkRibENsaWNrKHByb3BlcnRpZXMyLmRlc2VsZWN0T25EYmxDbGljayk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuZGVzZWxlY3RPbkVzY2FwZSAhPT0gdm9pZCAwKSB7CiAgICAgIHNldERlc2VsZWN0T25Fc2NhcGUocHJvcGVydGllczIuZGVzZWxlY3RPbkVzY2FwZSk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIub3BhY2l0eUJ5RGVuc2l0eUZpbGwgIT09IHZvaWQgMCkgewogICAgICBzZXRPcGFjaXR5QnlEZW5zaXR5RmlsbChwcm9wZXJ0aWVzMi5vcGFjaXR5QnlEZW5zaXR5RmlsbCk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIub3BhY2l0eUluYWN0aXZlTWF4ICE9PSB2b2lkIDApIHsKICAgICAgc2V0T3BhY2l0eUluYWN0aXZlTWF4KHByb3BlcnRpZXMyLm9wYWNpdHlJbmFjdGl2ZU1heCk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIub3BhY2l0eUluYWN0aXZlU2NhbGUgIT09IHZvaWQgMCkgewogICAgICBzZXRPcGFjaXR5SW5hY3RpdmVTY2FsZShwcm9wZXJ0aWVzMi5vcGFjaXR5SW5hY3RpdmVTY2FsZSk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuZ2FtbWEgIT09IHZvaWQgMCkgewogICAgICBzZXRHYW1tYShwcm9wZXJ0aWVzMi5nYW1tYSk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuYW5ub3RhdGlvbkxpbmVDb2xvciAhPT0gdm9pZCAwKSB7CiAgICAgIHNldEFubm90YXRpb25MaW5lQ29sb3IocHJvcGVydGllczIuYW5ub3RhdGlvbkxpbmVDb2xvcik7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuYW5ub3RhdGlvbkxpbmVXaWR0aCAhPT0gdm9pZCAwKSB7CiAgICAgIHNldEFubm90YXRpb25MaW5lV2lkdGgocHJvcGVydGllczIuYW5ub3RhdGlvbkxpbmVXaWR0aCk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuYW5ub3RhdGlvbkhWTGluZUxpbWl0ICE9PSB2b2lkIDApIHsKICAgICAgc2V0QW5ub3RhdGlvbkhWTGluZUxpbWl0KHByb3BlcnRpZXMyLmFubm90YXRpb25IVkxpbmVMaW1pdCk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIuYW50aUFsaWFzaW5nICE9PSB2b2lkIDApIHsKICAgICAgc2V0QW50aUFsaWFzaW5nKHByb3BlcnRpZXMyLmFudGlBbGlhc2luZyk7CiAgICB9CiAgICBpZiAocHJvcGVydGllczIucGl4ZWxBbGlnbmVkICE9PSB2b2lkIDApIHsKICAgICAgc2V0UGl4ZWxBbGlnbmVkKHByb3BlcnRpZXMyLnBpeGVsQWxpZ25lZCk7CiAgICB9CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgICAgaWYgKGlzRGVzdHJveWVkIHx8ICFjYW52YXMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdXBkYXRlVmlld0FzcGVjdFJhdGlvKCk7CiAgICAgICAgY2FtZXJhLnJlZnJlc2goKTsKICAgICAgICByZW5kZXJlci5yZWZyZXNoKCk7CiAgICAgICAgcmVkcmF3KCk7CiAgICAgICAgcmVzb2x2ZSgpOwogICAgICB9KTsKICAgIH0pOwogIH07CiAgY29uc3QgdmlldyA9IChjYW1lcmFWaWV3LCB7IHByZXZlbnRFdmVudCA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgc2V0Q2FtZXJhVmlldyhjYW1lcmFWaWV3KTsKICAgIGRyYXcgPSB0cnVlOwogICAgcHJldmVudEV2ZW50VmlldyA9IHByZXZlbnRFdmVudDsKICB9OwogIGNvbnN0IGluaXRDYW1lcmEgPSAoKSA9PiB7CiAgICBpZiAoIWNhbWVyYSkgewogICAgICBjYW1lcmEgPSBkb20yZENhbWVyYShjYW52YXMsIHsKICAgICAgICBpc0ZpeGVkOiBjYW1lcmFJc0ZpeGVkLAogICAgICAgIGlzUGFuSW52ZXJ0ZWQ6IFtmYWxzZSwgdHJ1ZV0sCiAgICAgICAgZGVmYXVsdE1vdXNlRG93bk1vdmVBY3Rpb246IG1vdXNlTW9kZSA9PT0gTU9VU0VfTU9ERV9ST1RBVEUgPyAicm90YXRlIiA6ICJwYW4iCiAgICAgIH0pOwogICAgfQogICAgaWYgKGluaXRpYWxQcm9wZXJ0aWVzLmNhbWVyYVZpZXcpIHsKICAgICAgY2FtZXJhLnNldFZpZXcoY2xvbmUoaW5pdGlhbFByb3BlcnRpZXMuY2FtZXJhVmlldykpOwogICAgfSBlbHNlIGlmIChpbml0aWFsUHJvcGVydGllcy5jYW1lcmFUYXJnZXQgfHwgaW5pdGlhbFByb3BlcnRpZXMuY2FtZXJhRGlzdGFuY2UgfHwgaW5pdGlhbFByb3BlcnRpZXMuY2FtZXJhUm90YXRpb24pIHsKICAgICAgY2FtZXJhLmxvb2tBdCgKICAgICAgICBbLi4uaW5pdGlhbFByb3BlcnRpZXMuY2FtZXJhVGFyZ2V0IHx8IERFRkFVTFRfVEFSR0VUXSwKICAgICAgICBpbml0aWFsUHJvcGVydGllcy5jYW1lcmFEaXN0YW5jZSB8fCBERUZBVUxUX0RJU1RBTkNFLAogICAgICAgIGluaXRpYWxQcm9wZXJ0aWVzLmNhbWVyYVJvdGF0aW9uIHx8IERFRkFVTFRfUk9UQVRJT04KICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGNhbWVyYS5zZXRWaWV3KGNsb25lKERFRkFVTFRfVklFVykpOwogICAgfQogICAgdG9wUmlnaHROZGMgPSBnZXRTY2F0dGVyR2xQb3MoMSwgMSk7CiAgICBib3R0b21MZWZ0TmRjID0gZ2V0U2NhdHRlckdsUG9zKC0xLCAtMSk7CiAgfTsKICBjb25zdCByZXNldCA9ICh7IHByZXZlbnRFdmVudCA9IGZhbHNlIH0gPSB7fSkgPT4gewogICAgaW5pdENhbWVyYSgpOwogICAgdXBkYXRlU2NhbGVzKCk7CiAgICBpZiAocHJldmVudEV2ZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHB1YlN1Yi5wdWJsaXNoKCJ2aWV3IiwgewogICAgICB2aWV3OiBjYW1lcmEudmlldywKICAgICAgY2FtZXJhLAogICAgICB4U2NhbGUsCiAgICAgIHlTY2FsZQogICAgfSk7CiAgfTsKICBjb25zdCBrZXlVcEhhbmRsZXIgPSAoeyBrZXkgfSkgPT4gewogICAgc3dpdGNoIChrZXkpIHsKICAgICAgY2FzZSAiRXNjYXBlIjogewogICAgICAgIGlmIChkZXNlbGVjdE9uRXNjYXBlKSB7CiAgICAgICAgICBkZXNlbGVjdCgpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH07CiAgY29uc3QgbW91c2VFbnRlckNhbnZhc0hhbmRsZXIgPSAoKSA9PiB7CiAgICBpc01vdXNlSW5DYW52YXMgPSB0cnVlOwogICAgaXNNb3VzZU92ZXJDYW52YXNDaGVja2VkID0gdHJ1ZTsKICB9OwogIGNvbnN0IG1vdXNlTGVhdmVDYW52YXNIYW5kbGVyID0gKCkgPT4gewogICAgaG92ZXIoKTsKICAgIGlzTW91c2VJbkNhbnZhcyA9IGZhbHNlOwogICAgaXNNb3VzZU92ZXJDYW52YXNDaGVja2VkID0gdHJ1ZTsKICAgIGRyYXcgPSB0cnVlOwogIH07CiAgY29uc3Qgd2hlZWxIYW5kbGVyID0gKCkgPT4gewogICAgZHJhdyA9IHRydWU7CiAgfTsKICBjb25zdCBjbGVhclBvaW50cyA9ICgpID0+IHsKICAgIHNldFBvaW50cyhbXSk7CiAgICBwb2ludENvbm5lY3Rpb25zLmNsZWFyKCk7CiAgfTsKICBjb25zdCBjbGVhclBvaW50Q29ubmVjdGlvbnMgPSAoKSA9PiB7CiAgICBwb2ludENvbm5lY3Rpb25zLmNsZWFyKCk7CiAgfTsKICBjb25zdCBjbGVhckFubm90YXRpb25zID0gKCkgPT4gewogICAgZHJhd0Fubm90YXRpb25zKFtdKTsKICB9OwogIGNvbnN0IGNsZWFyID0gKCkgPT4gewogICAgY2xlYXJQb2ludHMoKTsKICAgIGNsZWFyQW5ub3RhdGlvbnMoKTsKICB9OwogIGNvbnN0IHJlc2l6ZUhhbmRsZXIgPSAoKSA9PiB7CiAgICBjb25zdCBhdXRvV2lkdGggPSB3aWR0aCA9PT0gQVVUTzsKICAgIGNvbnN0IGF1dG9IZWlnaHQgPSBoZWlnaHQgPT09IEFVVE87CiAgICBpZiAoYXV0b1dpZHRoIHx8IGF1dG9IZWlnaHQpIHsKICAgICAgY29uc3QgeyB3aWR0aDogbmV3V2lkdGgsIGhlaWdodDogbmV3SGVpZ2h0IH0gPSBjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGlmIChhdXRvV2lkdGgpIHsKICAgICAgICBzZXRDdXJyZW50V2lkdGgobmV3V2lkdGgsIHRydWUpOwogICAgICB9CiAgICAgIGlmIChhdXRvSGVpZ2h0KSB7CiAgICAgICAgc2V0Q3VycmVudEhlaWdodChuZXdIZWlnaHQsIHRydWUpOwogICAgICB9CiAgICAgIHVwZGF0ZVZpZXdBc3BlY3RSYXRpbygpOwogICAgICB1cGRhdGVTY2FsZXMoKTsKICAgICAgZHJhdyA9IHRydWU7CiAgICB9CiAgICBjYW1lcmEucmVmcmVzaCgpOwogIH07CiAgY29uc3QgZXhwb3J0Rm5BZHZhbmNlZCA9IGFzeW5jIChvcHRpb25zKSA9PiB7CiAgICBjYW52YXMuc3R5bGUudXNlclNlbGVjdCA9ICJub25lIjsKICAgIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgY29uc3QgY3VyclBvaW50U2l6ZSA9IHBvaW50U2l6ZTsKICAgIGNvbnN0IGN1cnJXaWR0aCA9IHdpZHRoOwogICAgY29uc3QgY3VyckhlaWdodCA9IGhlaWdodDsKICAgIGNvbnN0IGN1cnJSZW5kZXJlcldpZHRoID0gcmVuZGVyZXIuY2FudmFzLndpZHRoIC8gZHByOwogICAgY29uc3QgY3VyclJlbmRlcmVySGVpZ2h0ID0gcmVuZGVyZXIuY2FudmFzLmhlaWdodCAvIGRwcjsKICAgIGNvbnN0IGN1cnJQaXhlbEFsaWduZWQgPSBwaXhlbEFsaWduZWQ7CiAgICBjb25zdCBjdXJyQW50aUFsaWFzaW5nID0gYW50aUFsaWFzaW5nOwogICAgY29uc3Qgc2NhbGUgPSBvcHRpb25zPy5zY2FsZSB8fCAxOwogICAgY29uc3QgbmV3UG9pbnRTaXplID0gQXJyYXkuaXNBcnJheShwb2ludFNpemUpID8gcG9pbnRTaXplLm1hcCgocykgPT4gcyAqIHNjYWxlKSA6IHBvaW50U2l6ZSAqIHNjYWxlOwogICAgY29uc3QgbmV3V2lkdGggPSBjdXJyZW50V2lkdGggKiBzY2FsZTsKICAgIGNvbnN0IG5ld0hlaWdodCA9IGN1cnJlbnRIZWlnaHQgKiBzY2FsZTsKICAgIHNldFBvaW50U2l6ZShuZXdQb2ludFNpemUpOwogICAgc2V0V2lkdGgobmV3V2lkdGgpOwogICAgc2V0SGVpZ2h0KG5ld0hlaWdodCk7CiAgICBzZXRQaXhlbEFsaWduZWQob3B0aW9ucz8ucGl4ZWxBbGlnbmVkIHx8IHBpeGVsQWxpZ25lZCk7CiAgICBzZXRBbnRpQWxpYXNpbmcob3B0aW9ucz8uYW50aUFsaWFzaW5nIHx8IGFudGlBbGlhc2luZyk7CiAgICByZW5kZXJlci5yZXNpemUod2lkdGgsIGhlaWdodCk7CiAgICByZW5kZXJlci5yZWZyZXNoKCk7CiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgcmVzb2x2ZSwgMSk7CiAgICAgIHJlZHJhdygpOwogICAgfSk7CiAgICBjb25zdCBpbWFnZURhdGEgPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKS5nZXRJbWFnZURhdGEoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgIHJlbmRlcmVyLnJlc2l6ZShjdXJyUmVuZGVyZXJXaWR0aCwgY3VyclJlbmRlcmVySGVpZ2h0KTsKICAgIHJlbmRlcmVyLnJlZnJlc2goKTsKICAgIHNldFBvaW50U2l6ZShjdXJyUG9pbnRTaXplKTsKICAgIHNldFdpZHRoKGN1cnJXaWR0aCk7CiAgICBzZXRIZWlnaHQoY3VyckhlaWdodCk7CiAgICBzZXRQaXhlbEFsaWduZWQoY3VyclBpeGVsQWxpZ25lZCk7CiAgICBzZXRBbnRpQWxpYXNpbmcoY3VyckFudGlBbGlhc2luZyk7CiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBwdWJTdWIuc3Vic2NyaWJlKCJkcmF3IiwgcmVzb2x2ZSwgMSk7CiAgICAgIHJlZHJhdygpOwogICAgfSk7CiAgICBjYW52YXMuc3R5bGUudXNlclNlbGVjdCA9IG51bGw7CiAgICByZXR1cm4gaW1hZ2VEYXRhOwogIH07CiAgY29uc3QgZXhwb3J0Rm4gPSAob3B0aW9ucykgPT4gewogICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gY2FudmFzLmdldENvbnRleHQoIjJkIikuZ2V0SW1hZ2VEYXRhKDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICB9CiAgICByZXR1cm4gZXhwb3J0Rm5BZHZhbmNlZChvcHRpb25zKTsKICB9OwogIGNvbnN0IGluaXQgPSAoKSA9PiB7CiAgICB1cGRhdGVWaWV3QXNwZWN0UmF0aW8oKTsKICAgIGluaXRDYW1lcmEoKTsKICAgIHVwZGF0ZVNjYWxlcygpOwogICAgbGFzc28gPSBjcmVhdGVMaW5lKHJlbmRlcmVyLnJlZ2wsIHsKICAgICAgY29sb3I6IGxhc3NvQ29sb3IsCiAgICAgIHdpZHRoOiBsYXNzb0xpbmVXaWR0aCwKICAgICAgaXMyZDogdHJ1ZQogICAgfSk7CiAgICBwb2ludENvbm5lY3Rpb25zID0gY3JlYXRlTGluZShyZW5kZXJlci5yZWdsLCB7CiAgICAgIGNvbG9yOiBnZXRDb2xvcnMoCiAgICAgICAgcG9pbnRDb25uZWN0aW9uQ29sb3IsCiAgICAgICAgcG9pbnRDb25uZWN0aW9uQ29sb3JBY3RpdmUsCiAgICAgICAgcG9pbnRDb25uZWN0aW9uQ29sb3JIb3ZlcgogICAgICApLAogICAgICBvcGFjaXR5OiBwb2ludENvbm5lY3Rpb25PcGFjaXR5ID09PSBudWxsID8gbnVsbCA6IHBvaW50Q29ubmVjdGlvbk9wYWNpdHlbMF0sCiAgICAgIHdpZHRoOiBwb2ludENvbm5lY3Rpb25TaXplWzBdLAogICAgICBpczJkOiB0cnVlCiAgICB9KTsKICAgIHJldGljbGVITGluZSA9IGNyZWF0ZUxpbmUocmVuZGVyZXIucmVnbCwgewogICAgICBjb2xvcjogcmV0aWNsZUNvbG9yLAogICAgICB3aWR0aDogMSwKICAgICAgaXMyZDogdHJ1ZQogICAgfSk7CiAgICByZXRpY2xlVkxpbmUgPSBjcmVhdGVMaW5lKHJlbmRlcmVyLnJlZ2wsIHsKICAgICAgY29sb3I6IHJldGljbGVDb2xvciwKICAgICAgd2lkdGg6IDEsCiAgICAgIGlzMmQ6IHRydWUKICAgIH0pOwogICAgYW5ub3RhdGlvbnMgPSBjcmVhdGVMaW5lKHJlbmRlcmVyLnJlZ2wsIHsKICAgICAgY29sb3I6IGFubm90YXRpb25MaW5lQ29sb3IsCiAgICAgIHdpZHRoOiBhbm5vdGF0aW9uTGluZVdpZHRoLAogICAgICBpczJkOiB0cnVlCiAgICB9KTsKICAgIGNvbXB1dGVQb2ludFNpemVNb3VzZURldGVjdGlvbigpOwogICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoIndoZWVsIiwgd2hlZWxIYW5kbGVyKTsKICAgIG5vcm1hbFBvaW50c0luZGV4QnVmZmVyID0gcmVuZGVyZXIucmVnbC5idWZmZXIoKTsKICAgIHNlbGVjdGVkUG9pbnRzSW5kZXhCdWZmZXIgPSByZW5kZXJlci5yZWdsLmJ1ZmZlcigpOwogICAgaG92ZXJlZFBvaW50SW5kZXhCdWZmZXIgPSByZW5kZXJlci5yZWdsLmJ1ZmZlcih7CiAgICAgIHVzYWdlOiAiZHluYW1pYyIsCiAgICAgIHR5cGU6ICJmbG9hdCIsCiAgICAgIGxlbmd0aDogRkxPQVRfQllURVMgKiAyCiAgICAgIC8vIFRoaXMgYnVmZmVyIGlzIGZpeGVkIHRvIGV4YWN0bHkgMSBwb2ludCBjb25zaXN0aW5nIG9mIDIgY29vcmRpbmF0ZXMKICAgIH0pOwogICAgY29sb3JUZXggPSBjcmVhdGVDb2xvclRleHR1cmUoKTsKICAgIGVuY29kaW5nVGV4ID0gY3JlYXRlRW5jb2RpbmdUZXh0dXJlKCk7CiAgICBjb25zdCB3aGVuU2V0ID0gc2V0KHsKICAgICAgYmFja2dyb3VuZEltYWdlLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0LAogICAgICBhY3Rpb25LZXlNYXAKICAgIH0pOwogICAgdXBkYXRlTGFzc29Jbml0aWF0b3JTdHlsZSgpOwogICAgdXBkYXRlTGFzc29Mb25nUHJlc3NJbmRpY2F0b3JTdHlsZSgpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImtleXVwIiwga2V5VXBIYW5kbGVyLCBmYWxzZSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIGJsdXJIYW5kbGVyLCBmYWxzZSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIG1vdXNlVXBIYW5kbGVyLCBmYWxzZSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgbW91c2VNb3ZlSGFuZGxlciwgZmFsc2UpOwogICAgY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIG1vdXNlRG93bkhhbmRsZXIsIGZhbHNlKTsKICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWVudGVyIiwgbW91c2VFbnRlckNhbnZhc0hhbmRsZXIsIGZhbHNlKTsKICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWxlYXZlIiwgbW91c2VMZWF2ZUNhbnZhc0hhbmRsZXIsIGZhbHNlKTsKICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIG1vdXNlQ2xpY2tIYW5kbGVyLCBmYWxzZSk7CiAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcigiZGJsY2xpY2siLCBtb3VzZURibENsaWNrSGFuZGxlciwgZmFsc2UpOwogICAgaWYgKCJSZXNpemVPYnNlcnZlciIgaW4gd2luZG93KSB7CiAgICAgIGNhbnZhc09ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKHJlc2l6ZUhhbmRsZXIpOwogICAgICBjYW52YXNPYnNlcnZlci5vYnNlcnZlKGNhbnZhcyk7CiAgICB9IGVsc2UgewogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgcmVzaXplSGFuZGxlcik7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJvcmllbnRhdGlvbmNoYW5nZSIsIHJlc2l6ZUhhbmRsZXIpOwogICAgfQogICAgd2hlblNldC50aGVuKCgpID0+IHsKICAgICAgcHViU3ViLnB1Ymxpc2goImluaXQiKTsKICAgIH0pOwogIH07CiAgY29uc3QgY2FuY2VsRnJhbWVMaXN0ZW5lciA9IHJlbmRlcmVyLm9uRnJhbWUoKCkgPT4gewogICAgaXNWaWV3Q2hhbmdlZCA9IGNhbWVyYS50aWNrKCk7CiAgICBpZiAoISgoaXNQb2ludHNEcmF3biB8fCBpc0Fubm90YXRpb25zRHJhd24pICYmIChkcmF3IHx8IGlzVHJhbnNpdGlvbmluZykpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc1RyYW5zaXRpb25pbmcgJiYgIXR3ZWVuKHRyYW5zaXRpb25EdXJhdGlvbiwgdHJhbnNpdGlvbkVhc2luZykpIHsKICAgICAgZW5kVHJhbnNpdGlvbigpOwogICAgfQogICAgaWYgKGlzVmlld0NoYW5nZWQpIHsKICAgICAgdG9wUmlnaHROZGMgPSBnZXRTY2F0dGVyR2xQb3MoMSwgMSk7CiAgICAgIGJvdHRvbUxlZnROZGMgPSBnZXRTY2F0dGVyR2xQb3MoLTEsIC0xKTsKICAgICAgaWYgKG9wYWNpdHlCeSA9PT0gImRlbnNpdHkiKSB7CiAgICAgICAgZ2V0TnVtUG9pbnRzSW5WaWV3RGIoKTsKICAgICAgfQogICAgfQogICAgcmVuZGVyZXIucmVuZGVyKCgpID0+IHsKICAgICAgY29uc3Qgd2lkdGhSYXRpbyA9IGNhbnZhcy53aWR0aCAvIHJlbmRlcmVyLmNhbnZhcy53aWR0aDsKICAgICAgY29uc3QgaGVpZ2h0UmF0aW8gPSBjYW52YXMuaGVpZ2h0IC8gcmVuZGVyZXIuY2FudmFzLmhlaWdodDsKICAgICAgdXBkYXRlUHJvamVjdGlvbk1hdHJpeCh3aWR0aFJhdGlvLCBoZWlnaHRSYXRpbyk7CiAgICAgIGlmIChiYWNrZ3JvdW5kSW1hZ2U/Ll9yZWdsVHlwZSkgewogICAgICAgIGRyYXdCYWNrZ3JvdW5kSW1hZ2UoKTsKICAgICAgfQogICAgICBpZiAobGFzc29Qb2ludHNDdXJyLmxlbmd0aCA+IDIpIHsKICAgICAgICBkcmF3TGFzc29Qb2x5Z29uKCk7CiAgICAgIH0KICAgICAgaWYgKCFpc1RyYW5zaXRpb25pbmcpIHsKICAgICAgICBwb2ludENvbm5lY3Rpb25zLmRyYXcoewogICAgICAgICAgcHJvamVjdGlvbjogZ2V0UHJvamVjdGlvbigpLAogICAgICAgICAgbW9kZWw6IGdldE1vZGVsKCksCiAgICAgICAgICB2aWV3OiBnZXRWaWV3KCkKICAgICAgICB9KTsKICAgICAgfQogICAgICBjb25zdCBudW1Qb2ludHMyID0gZ2V0Tm9ybWFsTnVtUG9pbnRzKCk7CiAgICAgIGlmIChpc1BvaW50c0RyYXduICYmIG51bVBvaW50czIgPiAwKSB7CiAgICAgICAgZHJhd1BvaW50Qm9kaWVzKCk7CiAgICAgIH0KICAgICAgaWYgKCFtb3VzZURvd24gJiYgKHNob3dSZXRpY2xlIHx8IGRyYXdSZXRpY2xlT25jZSkpIHsKICAgICAgICBkcmF3UmV0aWNsZSgpOwogICAgICB9CiAgICAgIGlmIChob3ZlcmVkUG9pbnQgPj0gMCkgewogICAgICAgIGRyYXdIb3ZlcmVkUG9pbnQoKTsKICAgICAgfQogICAgICBpZiAoc2VsZWN0ZWRQb2ludHMubGVuZ3RoID4gMCkgewogICAgICAgIGRyYXdTZWxlY3RlZFBvaW50cygpOwogICAgICB9CiAgICAgIGFubm90YXRpb25zLmRyYXcoewogICAgICAgIHByb2plY3Rpb246IGdldFByb2plY3Rpb24oKSwKICAgICAgICBtb2RlbDogZ2V0TW9kZWwoKSwKICAgICAgICB2aWV3OiBnZXRWaWV3KCkKICAgICAgfSk7CiAgICAgIGxhc3NvLmRyYXcoewogICAgICAgIHByb2plY3Rpb246IGdldFByb2plY3Rpb24oKSwKICAgICAgICBtb2RlbDogZ2V0TW9kZWwoKSwKICAgICAgICB2aWV3OiBnZXRWaWV3KCkKICAgICAgfSk7CiAgICB9LCBjYW52YXMpOwogICAgY29uc3QgcmVuZGVyVmlldyA9IHsKICAgICAgdmlldzogY2FtZXJhLnZpZXcsCiAgICAgIGlzVmlld0NoYW5nZWQsCiAgICAgIGNhbWVyYSwKICAgICAgeFNjYWxlLAogICAgICB5U2NhbGUKICAgIH07CiAgICBpZiAoaXNWaWV3Q2hhbmdlZCkgewogICAgICB1cGRhdGVTY2FsZXMoKTsKICAgICAgaWYgKHByZXZlbnRFdmVudFZpZXcpIHsKICAgICAgICBwcmV2ZW50RXZlbnRWaWV3ID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHViU3ViLnB1Ymxpc2goInZpZXciLCByZW5kZXJWaWV3KTsKICAgICAgfQogICAgfQogICAgZHJhdyA9IGZhbHNlOwogICAgZHJhd1JldGljbGVPbmNlID0gZmFsc2U7CiAgICBwdWJTdWIucHVibGlzaCgiZHJhd2luZyIsIHJlbmRlclZpZXcsIHsgYXN5bmM6IGZhbHNlIH0pOwogICAgcHViU3ViLnB1Ymxpc2goImRyYXciLCByZW5kZXJWaWV3KTsKICB9KTsKICBjb25zdCByZWRyYXcgPSAoKSA9PiB7CiAgICBkcmF3ID0gdHJ1ZTsKICB9OwogIGNvbnN0IGRlc3Ryb3kgPSAoKSA9PiB7CiAgICBpc1BvaW50c0RyYXduID0gZmFsc2U7CiAgICBpc0Fubm90YXRpb25zRHJhd24gPSBmYWxzZTsKICAgIGlzRGVzdHJveWVkID0gdHJ1ZTsKICAgIGNhbmNlbEZyYW1lTGlzdGVuZXIoKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXl1cCIsIGtleVVwSGFuZGxlciwgZmFsc2UpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImJsdXIiLCBibHVySGFuZGxlciwgZmFsc2UpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBtb3VzZVVwSGFuZGxlciwgZmFsc2UpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIG1vdXNlTW92ZUhhbmRsZXIsIGZhbHNlKTsKICAgIGNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBtb3VzZURvd25IYW5kbGVyLCBmYWxzZSk7CiAgICBjYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2VlbnRlciIsIG1vdXNlRW50ZXJDYW52YXNIYW5kbGVyLCBmYWxzZSk7CiAgICBjYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2VsZWF2ZSIsIG1vdXNlTGVhdmVDYW52YXNIYW5kbGVyLCBmYWxzZSk7CiAgICBjYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBtb3VzZUNsaWNrSGFuZGxlciwgZmFsc2UpOwogICAgY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoImRibGNsaWNrIiwgbW91c2VEYmxDbGlja0hhbmRsZXIsIGZhbHNlKTsKICAgIGNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCJ3aGVlbCIsIHdoZWVsSGFuZGxlciwgZmFsc2UpOwogICAgaWYgKGNhbnZhc09ic2VydmVyKSB7CiAgICAgIGNhbnZhc09ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgIH0gZWxzZSB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCByZXNpemVIYW5kbGVyKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm9yaWVudGF0aW9uY2hhbmdlIiwgcmVzaXplSGFuZGxlcik7CiAgICB9CiAgICBjYW52YXMgPSB2b2lkIDA7CiAgICBjYW1lcmEuZGlzcG9zZSgpOwogICAgY2FtZXJhID0gdm9pZCAwOwogICAgbGFzc28uZGVzdHJveSgpOwogICAgbGFzc29NYW5hZ2VyLmRlc3Ryb3koKTsKICAgIHBvaW50Q29ubmVjdGlvbnMuZGVzdHJveSgpOwogICAgcmV0aWNsZUhMaW5lLmRlc3Ryb3koKTsKICAgIHJldGljbGVWTGluZS5kZXN0cm95KCk7CiAgICBpZiAoY29sb3JUZXgpIHsKICAgICAgY29sb3JUZXguZGVzdHJveSgpOwogICAgfQogICAgaWYgKGVuY29kaW5nVGV4KSB7CiAgICAgIGVuY29kaW5nVGV4LmRlc3Ryb3koKTsKICAgIH0KICAgIGlmICghKGluaXRpYWxQcm9wZXJ0aWVzLnJlbmRlcmVyIHx8IHJlbmRlcmVyLmlzRGVzdHJveWVkKSkgewogICAgICByZW5kZXJlci5kZXN0cm95KCk7CiAgICB9CiAgICBwdWJTdWIucHVibGlzaCgiZGVzdHJveSIpOwogICAgcHViU3ViLmNsZWFyKCk7CiAgfTsKICBpbml0KCk7CiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogR2V0IHdoZXRoZXIgdGhlIGJyb3dzZXIgc3VwcG9ydHMgYWxsIG5lY2Vzc2FyeSBXZWJHTCBmZWF0dXJlcwogICAgICogQHJldHVybiB7Ym9vbGVhbn0gSWYgYHRydWVgIHRoZSBicm93c2VyIHN1cHBvcnRzIGFsbCBuZWNlc3NhcnkgV2ViR0wgZmVhdHVyZXMKICAgICAqLwogICAgZ2V0IGlzU3VwcG9ydGVkKCkgewogICAgICByZXR1cm4gcmVuZGVyZXIuaXNTdXBwb3J0ZWQ7CiAgICB9LAogICAgY2xlYXI6IHdpdGhEcmF3KGNsZWFyKSwKICAgIGNsZWFyUG9pbnRzOiB3aXRoRHJhdyhjbGVhclBvaW50cyksCiAgICBjbGVhclBvaW50Q29ubmVjdGlvbnM6IHdpdGhEcmF3KGNsZWFyUG9pbnRDb25uZWN0aW9ucyksCiAgICBjbGVhckFubm90YXRpb25zOiB3aXRoRHJhdyhjbGVhckFubm90YXRpb25zKSwKICAgIGNyZWF0ZVRleHR1cmVGcm9tVXJsOiAodXJsLCB0aW1lb3V0ID0gREVGQVVMVF9JTUFHRV9MT0FEX1RJTUVPVVQpID0+IGNyZWF0ZVRleHR1cmVGcm9tVXJsKHJlbmRlcmVyLnJlZ2wsIHVybCwgdGltZW91dCksCiAgICBkZXNlbGVjdCwKICAgIGRlc3Ryb3ksCiAgICBkcmF3OiBwdWJsaWNEcmF3LAogICAgZHJhd0Fubm90YXRpb25zLAogICAgZmlsdGVyOiBmaWx0ZXIyLAogICAgZ2V0LAogICAgZ2V0U2NyZWVuUG9zaXRpb24sCiAgICBob3ZlciwKICAgIHJlZHJhdywKICAgIHJlZnJlc2g6IHJlbmRlcmVyLnJlZnJlc2gsCiAgICByZXNldDogd2l0aERyYXcocmVzZXQpLAogICAgc2VsZWN0LAogICAgc2V0LAogICAgZXhwb3J0OiBleHBvcnRGbiwKICAgIHN1YnNjcmliZTogcHViU3ViLnN1YnNjcmliZSwKICAgIHVuZmlsdGVyLAogICAgdW5zdWJzY3JpYmU6IHB1YlN1Yi51bnN1YnNjcmliZSwKICAgIHZpZXcsCiAgICB6b29tVG9Mb2NhdGlvbiwKICAgIHpvb21Ub0FyZWEsCiAgICB6b29tVG9Qb2ludHMsCiAgICB6b29tVG9PcmlnaW4KICB9Owp9OwoKLy8gbm9kZV9tb2R1bGVzL2QzLWF4aXMvc3JjL2lkZW50aXR5LmpzCmZ1bmN0aW9uIGlkZW50aXR5X2RlZmF1bHQoeCkgewogIHJldHVybiB4Owp9CgovLyBub2RlX21vZHVsZXMvZDMtYXhpcy9zcmMvYXhpcy5qcwp2YXIgdG9wID0gMTsKdmFyIHJpZ2h0ID0gMjsKdmFyIGJvdHRvbSA9IDM7CnZhciBsZWZ0ID0gNDsKdmFyIGVwc2lsb24gPSAxZS02OwpmdW5jdGlvbiB0cmFuc2xhdGVYKHgpIHsKICByZXR1cm4gInRyYW5zbGF0ZSgiICsgeCArICIsMCkiOwp9CmZ1bmN0aW9uIHRyYW5zbGF0ZVkoeSkgewogIHJldHVybiAidHJhbnNsYXRlKDAsIiArIHkgKyAiKSI7Cn0KZnVuY3Rpb24gbnVtYmVyKHNjYWxlKSB7CiAgcmV0dXJuIChkKSA9PiArc2NhbGUoZCk7Cn0KZnVuY3Rpb24gY2VudGVyKHNjYWxlLCBvZmZzZXQpIHsKICBvZmZzZXQgPSBNYXRoLm1heCgwLCBzY2FsZS5iYW5kd2lkdGgoKSAtIG9mZnNldCAqIDIpIC8gMjsKICBpZiAoc2NhbGUucm91bmQoKSkgb2Zmc2V0ID0gTWF0aC5yb3VuZChvZmZzZXQpOwogIHJldHVybiAoZCkgPT4gK3NjYWxlKGQpICsgb2Zmc2V0Owp9CmZ1bmN0aW9uIGVudGVyaW5nKCkgewogIHJldHVybiAhdGhpcy5fX2F4aXM7Cn0KZnVuY3Rpb24gYXhpcyhvcmllbnQsIHNjYWxlKSB7CiAgdmFyIHRpY2tBcmd1bWVudHMgPSBbXSwgdGlja1ZhbHVlcyA9IG51bGwsIHRpY2tGb3JtYXQyID0gbnVsbCwgdGlja1NpemVJbm5lciA9IDYsIHRpY2tTaXplT3V0ZXIgPSA2LCB0aWNrUGFkZGluZyA9IDMsIG9mZnNldCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvID4gMSA/IDAgOiAwLjUsIGsgPSBvcmllbnQgPT09IHRvcCB8fCBvcmllbnQgPT09IGxlZnQgPyAtMSA6IDEsIHggPSBvcmllbnQgPT09IGxlZnQgfHwgb3JpZW50ID09PSByaWdodCA/ICJ4IiA6ICJ5IiwgdHJhbnNmb3JtID0gb3JpZW50ID09PSB0b3AgfHwgb3JpZW50ID09PSBib3R0b20gPyB0cmFuc2xhdGVYIDogdHJhbnNsYXRlWTsKICBmdW5jdGlvbiBheGlzMihjb250ZXh0KSB7CiAgICB2YXIgdmFsdWVzID0gdGlja1ZhbHVlcyA9PSBudWxsID8gc2NhbGUudGlja3MgPyBzY2FsZS50aWNrcy5hcHBseShzY2FsZSwgdGlja0FyZ3VtZW50cykgOiBzY2FsZS5kb21haW4oKSA6IHRpY2tWYWx1ZXMsIGZvcm1hdDIgPSB0aWNrRm9ybWF0MiA9PSBudWxsID8gc2NhbGUudGlja0Zvcm1hdCA/IHNjYWxlLnRpY2tGb3JtYXQuYXBwbHkoc2NhbGUsIHRpY2tBcmd1bWVudHMpIDogaWRlbnRpdHlfZGVmYXVsdCA6IHRpY2tGb3JtYXQyLCBzcGFjaW5nID0gTWF0aC5tYXgodGlja1NpemVJbm5lciwgMCkgKyB0aWNrUGFkZGluZywgcmFuZ2UgPSBzY2FsZS5yYW5nZSgpLCByYW5nZTAgPSArcmFuZ2VbMF0gKyBvZmZzZXQsIHJhbmdlMSA9ICtyYW5nZVtyYW5nZS5sZW5ndGggLSAxXSArIG9mZnNldCwgcG9zaXRpb24gPSAoc2NhbGUuYmFuZHdpZHRoID8gY2VudGVyIDogbnVtYmVyKShzY2FsZS5jb3B5KCksIG9mZnNldCksIHNlbGVjdGlvbjIgPSBjb250ZXh0LnNlbGVjdGlvbiA/IGNvbnRleHQuc2VsZWN0aW9uKCkgOiBjb250ZXh0LCBwYXRoID0gc2VsZWN0aW9uMi5zZWxlY3RBbGwoIi5kb21haW4iKS5kYXRhKFtudWxsXSksIHRpY2sgPSBzZWxlY3Rpb24yLnNlbGVjdEFsbCgiLnRpY2siKS5kYXRhKHZhbHVlcywgc2NhbGUpLm9yZGVyKCksIHRpY2tFeGl0ID0gdGljay5leGl0KCksIHRpY2tFbnRlciA9IHRpY2suZW50ZXIoKS5hcHBlbmQoImciKS5hdHRyKCJjbGFzcyIsICJ0aWNrIiksIGxpbmUgPSB0aWNrLnNlbGVjdCgibGluZSIpLCB0ZXh0ID0gdGljay5zZWxlY3QoInRleHQiKTsKICAgIHBhdGggPSBwYXRoLm1lcmdlKHBhdGguZW50ZXIoKS5pbnNlcnQoInBhdGgiLCAiLnRpY2siKS5hdHRyKCJjbGFzcyIsICJkb21haW4iKS5hdHRyKCJzdHJva2UiLCAiY3VycmVudENvbG9yIikpOwogICAgdGljayA9IHRpY2subWVyZ2UodGlja0VudGVyKTsKICAgIGxpbmUgPSBsaW5lLm1lcmdlKHRpY2tFbnRlci5hcHBlbmQoImxpbmUiKS5hdHRyKCJzdHJva2UiLCAiY3VycmVudENvbG9yIikuYXR0cih4ICsgIjIiLCBrICogdGlja1NpemVJbm5lcikpOwogICAgdGV4dCA9IHRleHQubWVyZ2UodGlja0VudGVyLmFwcGVuZCgidGV4dCIpLmF0dHIoImZpbGwiLCAiY3VycmVudENvbG9yIikuYXR0cih4LCBrICogc3BhY2luZykuYXR0cigiZHkiLCBvcmllbnQgPT09IHRvcCA/ICIwZW0iIDogb3JpZW50ID09PSBib3R0b20gPyAiMC43MWVtIiA6ICIwLjMyZW0iKSk7CiAgICBpZiAoY29udGV4dCAhPT0gc2VsZWN0aW9uMikgewogICAgICBwYXRoID0gcGF0aC50cmFuc2l0aW9uKGNvbnRleHQpOwogICAgICB0aWNrID0gdGljay50cmFuc2l0aW9uKGNvbnRleHQpOwogICAgICBsaW5lID0gbGluZS50cmFuc2l0aW9uKGNvbnRleHQpOwogICAgICB0ZXh0ID0gdGV4dC50cmFuc2l0aW9uKGNvbnRleHQpOwogICAgICB0aWNrRXhpdCA9IHRpY2tFeGl0LnRyYW5zaXRpb24oY29udGV4dCkuYXR0cigib3BhY2l0eSIsIGVwc2lsb24pLmF0dHIoInRyYW5zZm9ybSIsIGZ1bmN0aW9uKGQpIHsKICAgICAgICByZXR1cm4gaXNGaW5pdGUoZCA9IHBvc2l0aW9uKGQpKSA/IHRyYW5zZm9ybShkICsgb2Zmc2V0KSA6IHRoaXMuZ2V0QXR0cmlidXRlKCJ0cmFuc2Zvcm0iKTsKICAgICAgfSk7CiAgICAgIHRpY2tFbnRlci5hdHRyKCJvcGFjaXR5IiwgZXBzaWxvbikuYXR0cigidHJhbnNmb3JtIiwgZnVuY3Rpb24oZCkgewogICAgICAgIHZhciBwID0gdGhpcy5wYXJlbnROb2RlLl9fYXhpczsKICAgICAgICByZXR1cm4gdHJhbnNmb3JtKChwICYmIGlzRmluaXRlKHAgPSBwKGQpKSA/IHAgOiBwb3NpdGlvbihkKSkgKyBvZmZzZXQpOwogICAgICB9KTsKICAgIH0KICAgIHRpY2tFeGl0LnJlbW92ZSgpOwogICAgcGF0aC5hdHRyKCJkIiwgb3JpZW50ID09PSBsZWZ0IHx8IG9yaWVudCA9PT0gcmlnaHQgPyB0aWNrU2l6ZU91dGVyID8gIk0iICsgayAqIHRpY2tTaXplT3V0ZXIgKyAiLCIgKyByYW5nZTAgKyAiSCIgKyBvZmZzZXQgKyAiViIgKyByYW5nZTEgKyAiSCIgKyBrICogdGlja1NpemVPdXRlciA6ICJNIiArIG9mZnNldCArICIsIiArIHJhbmdlMCArICJWIiArIHJhbmdlMSA6IHRpY2tTaXplT3V0ZXIgPyAiTSIgKyByYW5nZTAgKyAiLCIgKyBrICogdGlja1NpemVPdXRlciArICJWIiArIG9mZnNldCArICJIIiArIHJhbmdlMSArICJWIiArIGsgKiB0aWNrU2l6ZU91dGVyIDogIk0iICsgcmFuZ2UwICsgIiwiICsgb2Zmc2V0ICsgIkgiICsgcmFuZ2UxKTsKICAgIHRpY2suYXR0cigib3BhY2l0eSIsIDEpLmF0dHIoInRyYW5zZm9ybSIsIGZ1bmN0aW9uKGQpIHsKICAgICAgcmV0dXJuIHRyYW5zZm9ybShwb3NpdGlvbihkKSArIG9mZnNldCk7CiAgICB9KTsKICAgIGxpbmUuYXR0cih4ICsgIjIiLCBrICogdGlja1NpemVJbm5lcik7CiAgICB0ZXh0LmF0dHIoeCwgayAqIHNwYWNpbmcpLnRleHQoZm9ybWF0Mik7CiAgICBzZWxlY3Rpb24yLmZpbHRlcihlbnRlcmluZykuYXR0cigiZmlsbCIsICJub25lIikuYXR0cigiZm9udC1zaXplIiwgMTApLmF0dHIoImZvbnQtZmFtaWx5IiwgInNhbnMtc2VyaWYiKS5hdHRyKCJ0ZXh0LWFuY2hvciIsIG9yaWVudCA9PT0gcmlnaHQgPyAic3RhcnQiIDogb3JpZW50ID09PSBsZWZ0ID8gImVuZCIgOiAibWlkZGxlIik7CiAgICBzZWxlY3Rpb24yLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX19heGlzID0gcG9zaXRpb247CiAgICB9KTsKICB9CiAgYXhpczIuc2NhbGUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzY2FsZSA9IF8sIGF4aXMyKSA6IHNjYWxlOwogIH07CiAgYXhpczIudGlja3MgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aWNrQXJndW1lbnRzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpLCBheGlzMjsKICB9OwogIGF4aXMyLnRpY2tBcmd1bWVudHMgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh0aWNrQXJndW1lbnRzID0gXyA9PSBudWxsID8gW10gOiBBcnJheS5mcm9tKF8pLCBheGlzMikgOiB0aWNrQXJndW1lbnRzLnNsaWNlKCk7CiAgfTsKICBheGlzMi50aWNrVmFsdWVzID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodGlja1ZhbHVlcyA9IF8gPT0gbnVsbCA/IG51bGwgOiBBcnJheS5mcm9tKF8pLCBheGlzMikgOiB0aWNrVmFsdWVzICYmIHRpY2tWYWx1ZXMuc2xpY2UoKTsKICB9OwogIGF4aXMyLnRpY2tGb3JtYXQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh0aWNrRm9ybWF0MiA9IF8sIGF4aXMyKSA6IHRpY2tGb3JtYXQyOwogIH07CiAgYXhpczIudGlja1NpemUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh0aWNrU2l6ZUlubmVyID0gdGlja1NpemVPdXRlciA9ICtfLCBheGlzMikgOiB0aWNrU2l6ZUlubmVyOwogIH07CiAgYXhpczIudGlja1NpemVJbm5lciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHRpY2tTaXplSW5uZXIgPSArXywgYXhpczIpIDogdGlja1NpemVJbm5lcjsKICB9OwogIGF4aXMyLnRpY2tTaXplT3V0ZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh0aWNrU2l6ZU91dGVyID0gK18sIGF4aXMyKSA6IHRpY2tTaXplT3V0ZXI7CiAgfTsKICBheGlzMi50aWNrUGFkZGluZyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHRpY2tQYWRkaW5nID0gK18sIGF4aXMyKSA6IHRpY2tQYWRkaW5nOwogIH07CiAgYXhpczIub2Zmc2V0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob2Zmc2V0ID0gK18sIGF4aXMyKSA6IG9mZnNldDsKICB9OwogIHJldHVybiBheGlzMjsKfQpmdW5jdGlvbiBheGlzUmlnaHQoc2NhbGUpIHsKICByZXR1cm4gYXhpcyhyaWdodCwgc2NhbGUpOwp9CmZ1bmN0aW9uIGF4aXNCb3R0b20oc2NhbGUpIHsKICByZXR1cm4gYXhpcyhib3R0b20sIHNjYWxlKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0RGVjaW1hbC5qcwpmdW5jdGlvbiBmb3JtYXREZWNpbWFsX2RlZmF1bHQoeCkgewogIHJldHVybiBNYXRoLmFicyh4ID0gTWF0aC5yb3VuZCh4KSkgPj0gMWUyMSA/IHgudG9Mb2NhbGVTdHJpbmcoImVuIikucmVwbGFjZSgvLC9nLCAiIikgOiB4LnRvU3RyaW5nKDEwKTsKfQpmdW5jdGlvbiBmb3JtYXREZWNpbWFsUGFydHMoeCwgcCkgewogIGlmICgoaSA9ICh4ID0gcCA/IHgudG9FeHBvbmVudGlhbChwIC0gMSkgOiB4LnRvRXhwb25lbnRpYWwoKSkuaW5kZXhPZigiZSIpKSA8IDApIHJldHVybiBudWxsOwogIHZhciBpLCBjb2VmZmljaWVudCA9IHguc2xpY2UoMCwgaSk7CiAgcmV0dXJuIFsKICAgIGNvZWZmaWNpZW50Lmxlbmd0aCA+IDEgPyBjb2VmZmljaWVudFswXSArIGNvZWZmaWNpZW50LnNsaWNlKDIpIDogY29lZmZpY2llbnQsCiAgICAreC5zbGljZShpICsgMSkKICBdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9leHBvbmVudC5qcwpmdW5jdGlvbiBleHBvbmVudF9kZWZhdWx0KHgpIHsKICByZXR1cm4geCA9IGZvcm1hdERlY2ltYWxQYXJ0cyhNYXRoLmFicyh4KSksIHggPyB4WzFdIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRHcm91cC5qcwpmdW5jdGlvbiBmb3JtYXRHcm91cF9kZWZhdWx0KGdyb3VwaW5nLCB0aG91c2FuZHMpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIHdpZHRoKSB7CiAgICB2YXIgaSA9IHZhbHVlLmxlbmd0aCwgdCA9IFtdLCBqID0gMCwgZyA9IGdyb3VwaW5nWzBdLCBsZW5ndGggPSAwOwogICAgd2hpbGUgKGkgPiAwICYmIGcgPiAwKSB7CiAgICAgIGlmIChsZW5ndGggKyBnICsgMSA+IHdpZHRoKSBnID0gTWF0aC5tYXgoMSwgd2lkdGggLSBsZW5ndGgpOwogICAgICB0LnB1c2godmFsdWUuc3Vic3RyaW5nKGkgLT0gZywgaSArIGcpKTsKICAgICAgaWYgKChsZW5ndGggKz0gZyArIDEpID4gd2lkdGgpIGJyZWFrOwogICAgICBnID0gZ3JvdXBpbmdbaiA9IChqICsgMSkgJSBncm91cGluZy5sZW5ndGhdOwogICAgfQogICAgcmV0dXJuIHQucmV2ZXJzZSgpLmpvaW4odGhvdXNhbmRzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXROdW1lcmFscy5qcwpmdW5jdGlvbiBmb3JtYXROdW1lcmFsc19kZWZhdWx0KG51bWVyYWxzKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvWzAtOV0vZywgZnVuY3Rpb24oaSkgewogICAgICByZXR1cm4gbnVtZXJhbHNbK2ldOwogICAgfSk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0U3BlY2lmaWVyLmpzCnZhciByZSA9IC9eKD86KC4pPyhbPD49Xl0pKT8oWytcLSggXSk/KFskI10pPygwKT8oXGQrKT8oLCk/KFwuXGQrKT8ofik/KFthLXolXSk/JC9pOwpmdW5jdGlvbiBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgaWYgKCEobWF0Y2ggPSByZS5leGVjKHNwZWNpZmllcikpKSB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgZm9ybWF0OiAiICsgc3BlY2lmaWVyKTsKICB2YXIgbWF0Y2g7CiAgcmV0dXJuIG5ldyBGb3JtYXRTcGVjaWZpZXIoewogICAgZmlsbDogbWF0Y2hbMV0sCiAgICBhbGlnbjogbWF0Y2hbMl0sCiAgICBzaWduOiBtYXRjaFszXSwKICAgIHN5bWJvbDogbWF0Y2hbNF0sCiAgICB6ZXJvOiBtYXRjaFs1XSwKICAgIHdpZHRoOiBtYXRjaFs2XSwKICAgIGNvbW1hOiBtYXRjaFs3XSwKICAgIHByZWNpc2lvbjogbWF0Y2hbOF0gJiYgbWF0Y2hbOF0uc2xpY2UoMSksCiAgICB0cmltOiBtYXRjaFs5XSwKICAgIHR5cGU6IG1hdGNoWzEwXQogIH0pOwp9CmZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUgPSBGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlOwpmdW5jdGlvbiBGb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgdGhpcy5maWxsID0gc3BlY2lmaWVyLmZpbGwgPT09IHZvaWQgMCA/ICIgIiA6IHNwZWNpZmllci5maWxsICsgIiI7CiAgdGhpcy5hbGlnbiA9IHNwZWNpZmllci5hbGlnbiA9PT0gdm9pZCAwID8gIj4iIDogc3BlY2lmaWVyLmFsaWduICsgIiI7CiAgdGhpcy5zaWduID0gc3BlY2lmaWVyLnNpZ24gPT09IHZvaWQgMCA/ICItIiA6IHNwZWNpZmllci5zaWduICsgIiI7CiAgdGhpcy5zeW1ib2wgPSBzcGVjaWZpZXIuc3ltYm9sID09PSB2b2lkIDAgPyAiIiA6IHNwZWNpZmllci5zeW1ib2wgKyAiIjsKICB0aGlzLnplcm8gPSAhIXNwZWNpZmllci56ZXJvOwogIHRoaXMud2lkdGggPSBzcGVjaWZpZXIud2lkdGggPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIud2lkdGg7CiAgdGhpcy5jb21tYSA9ICEhc3BlY2lmaWVyLmNvbW1hOwogIHRoaXMucHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogK3NwZWNpZmllci5wcmVjaXNpb247CiAgdGhpcy50cmltID0gISFzcGVjaWZpZXIudHJpbTsKICB0aGlzLnR5cGUgPSBzcGVjaWZpZXIudHlwZSA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIudHlwZSArICIiOwp9CkZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5maWxsICsgdGhpcy5hbGlnbiArIHRoaXMuc2lnbiArIHRoaXMuc3ltYm9sICsgKHRoaXMuemVybyA/ICIwIiA6ICIiKSArICh0aGlzLndpZHRoID09PSB2b2lkIDAgPyAiIiA6IE1hdGgubWF4KDEsIHRoaXMud2lkdGggfCAwKSkgKyAodGhpcy5jb21tYSA/ICIsIiA6ICIiKSArICh0aGlzLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gIiIgOiAiLiIgKyBNYXRoLm1heCgwLCB0aGlzLnByZWNpc2lvbiB8IDApKSArICh0aGlzLnRyaW0gPyAifiIgOiAiIikgKyB0aGlzLnR5cGU7Cn07CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRUcmltLmpzCmZ1bmN0aW9uIGZvcm1hdFRyaW1fZGVmYXVsdChzKSB7CiAgb3V0OiBmb3IgKHZhciBuID0gcy5sZW5ndGgsIGkgPSAxLCBpMCA9IC0xLCBpMTsgaSA8IG47ICsraSkgewogICAgc3dpdGNoIChzW2ldKSB7CiAgICAgIGNhc2UgIi4iOgogICAgICAgIGkwID0gaTEgPSBpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICIwIjoKICAgICAgICBpZiAoaTAgPT09IDApIGkwID0gaTsKICAgICAgICBpMSA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKCErc1tpXSkgYnJlYWsgb3V0OwogICAgICAgIGlmIChpMCA+IDApIGkwID0gMDsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGkwID4gMCA/IHMuc2xpY2UoMCwgaTApICsgcy5zbGljZShpMSArIDEpIDogczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0UHJlZml4QXV0by5qcwp2YXIgcHJlZml4RXhwb25lbnQ7CmZ1bmN0aW9uIGZvcm1hdFByZWZpeEF1dG9fZGVmYXVsdCh4LCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeCwgcCk7CiAgaWYgKCFkKSByZXR1cm4geCArICIiOwogIHZhciBjb2VmZmljaWVudCA9IGRbMF0sIGV4cG9uZW50ID0gZFsxXSwgaSA9IGV4cG9uZW50IC0gKHByZWZpeEV4cG9uZW50ID0gTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnQgLyAzKSkpICogMykgKyAxLCBuID0gY29lZmZpY2llbnQubGVuZ3RoOwogIHJldHVybiBpID09PSBuID8gY29lZmZpY2llbnQgOiBpID4gbiA/IGNvZWZmaWNpZW50ICsgbmV3IEFycmF5KGkgLSBuICsgMSkuam9pbigiMCIpIDogaSA+IDAgPyBjb2VmZmljaWVudC5zbGljZSgwLCBpKSArICIuIiArIGNvZWZmaWNpZW50LnNsaWNlKGkpIDogIjAuIiArIG5ldyBBcnJheSgxIC0gaSkuam9pbigiMCIpICsgZm9ybWF0RGVjaW1hbFBhcnRzKHgsIE1hdGgubWF4KDAsIHAgKyBpIC0gMSkpWzBdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRSb3VuZGVkLmpzCmZ1bmN0aW9uIGZvcm1hdFJvdW5kZWRfZGVmYXVsdCh4LCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeCwgcCk7CiAgaWYgKCFkKSByZXR1cm4geCArICIiOwogIHZhciBjb2VmZmljaWVudCA9IGRbMF0sIGV4cG9uZW50ID0gZFsxXTsKICByZXR1cm4gZXhwb25lbnQgPCAwID8gIjAuIiArIG5ldyBBcnJheSgtZXhwb25lbnQpLmpvaW4oIjAiKSArIGNvZWZmaWNpZW50IDogY29lZmZpY2llbnQubGVuZ3RoID4gZXhwb25lbnQgKyAxID8gY29lZmZpY2llbnQuc2xpY2UoMCwgZXhwb25lbnQgKyAxKSArICIuIiArIGNvZWZmaWNpZW50LnNsaWNlKGV4cG9uZW50ICsgMSkgOiBjb2VmZmljaWVudCArIG5ldyBBcnJheShleHBvbmVudCAtIGNvZWZmaWNpZW50Lmxlbmd0aCArIDIpLmpvaW4oIjAiKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHlwZXMuanMKdmFyIGZvcm1hdFR5cGVzX2RlZmF1bHQgPSB7CiAgIiUiOiAoeCwgcCkgPT4gKHggKiAxMDApLnRvRml4ZWQocCksCiAgImIiOiAoeCkgPT4gTWF0aC5yb3VuZCh4KS50b1N0cmluZygyKSwKICAiYyI6ICh4KSA9PiB4ICsgIiIsCiAgImQiOiBmb3JtYXREZWNpbWFsX2RlZmF1bHQsCiAgImUiOiAoeCwgcCkgPT4geC50b0V4cG9uZW50aWFsKHApLAogICJmIjogKHgsIHApID0+IHgudG9GaXhlZChwKSwKICAiZyI6ICh4LCBwKSA9PiB4LnRvUHJlY2lzaW9uKHApLAogICJvIjogKHgpID0+IE1hdGgucm91bmQoeCkudG9TdHJpbmcoOCksCiAgInAiOiAoeCwgcCkgPT4gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHggKiAxMDAsIHApLAogICJyIjogZm9ybWF0Um91bmRlZF9kZWZhdWx0LAogICJzIjogZm9ybWF0UHJlZml4QXV0b19kZWZhdWx0LAogICJYIjogKHgpID0+IE1hdGgucm91bmQoeCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCksCiAgIngiOiAoeCkgPT4gTWF0aC5yb3VuZCh4KS50b1N0cmluZygxNikKfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2lkZW50aXR5LmpzCmZ1bmN0aW9uIGlkZW50aXR5X2RlZmF1bHQyKHgpIHsKICByZXR1cm4geDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvbG9jYWxlLmpzCnZhciBtYXAgPSBBcnJheS5wcm90b3R5cGUubWFwOwp2YXIgcHJlZml4ZXMgPSBbInkiLCAieiIsICJhIiwgImYiLCAicCIsICJuIiwgIlx4QjUiLCAibSIsICIiLCAiayIsICJNIiwgIkciLCAiVCIsICJQIiwgIkUiLCAiWiIsICJZIl07CmZ1bmN0aW9uIGxvY2FsZV9kZWZhdWx0KGxvY2FsZTMpIHsKICB2YXIgZ3JvdXAgPSBsb2NhbGUzLmdyb3VwaW5nID09PSB2b2lkIDAgfHwgbG9jYWxlMy50aG91c2FuZHMgPT09IHZvaWQgMCA/IGlkZW50aXR5X2RlZmF1bHQyIDogZm9ybWF0R3JvdXBfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLmdyb3VwaW5nLCBOdW1iZXIpLCBsb2NhbGUzLnRob3VzYW5kcyArICIiKSwgY3VycmVuY3lQcmVmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMF0gKyAiIiwgY3VycmVuY3lTdWZmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMV0gKyAiIiwgZGVjaW1hbDIgPSBsb2NhbGUzLmRlY2ltYWwgPT09IHZvaWQgMCA/ICIuIiA6IGxvY2FsZTMuZGVjaW1hbCArICIiLCBudW1lcmFscyA9IGxvY2FsZTMubnVtZXJhbHMgPT09IHZvaWQgMCA/IGlkZW50aXR5X2RlZmF1bHQyIDogZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLm51bWVyYWxzLCBTdHJpbmcpKSwgcGVyY2VudCA9IGxvY2FsZTMucGVyY2VudCA9PT0gdm9pZCAwID8gIiUiIDogbG9jYWxlMy5wZXJjZW50ICsgIiIsIG1pbnVzID0gbG9jYWxlMy5taW51cyA9PT0gdm9pZCAwID8gIlx1MjIxMiIgOiBsb2NhbGUzLm1pbnVzICsgIiIsIG5hbiA9IGxvY2FsZTMubmFuID09PSB2b2lkIDAgPyAiTmFOIiA6IGxvY2FsZTMubmFuICsgIiI7CiAgZnVuY3Rpb24gbmV3Rm9ybWF0KHNwZWNpZmllcikgewogICAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcik7CiAgICB2YXIgZmlsbCA9IHNwZWNpZmllci5maWxsLCBhbGlnbjIgPSBzcGVjaWZpZXIuYWxpZ24sIHNpZ24yID0gc3BlY2lmaWVyLnNpZ24sIHN5bWJvbCA9IHNwZWNpZmllci5zeW1ib2wsIHplcm8zID0gc3BlY2lmaWVyLnplcm8sIHdpZHRoID0gc3BlY2lmaWVyLndpZHRoLCBjb21tYSA9IHNwZWNpZmllci5jb21tYSwgcHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiwgdHJpbSA9IHNwZWNpZmllci50cmltLCB0eXBlID0gc3BlY2lmaWVyLnR5cGU7CiAgICBpZiAodHlwZSA9PT0gIm4iKSBjb21tYSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBlbHNlIGlmICghZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSkgcHJlY2lzaW9uID09PSB2b2lkIDAgJiYgKHByZWNpc2lvbiA9IDEyKSwgdHJpbSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBpZiAoemVybzMgfHwgZmlsbCA9PT0gIjAiICYmIGFsaWduMiA9PT0gIj0iKSB6ZXJvMyA9IHRydWUsIGZpbGwgPSAiMCIsIGFsaWduMiA9ICI9IjsKICAgIHZhciBwcmVmaXggPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5UHJlZml4IDogc3ltYm9sID09PSAiIyIgJiYgL1tib3hYXS8udGVzdCh0eXBlKSA/ICIwIiArIHR5cGUudG9Mb3dlckNhc2UoKSA6ICIiLCBzdWZmaXggPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5U3VmZml4IDogL1slcF0vLnRlc3QodHlwZSkgPyBwZXJjZW50IDogIiI7CiAgICB2YXIgZm9ybWF0VHlwZSA9IGZvcm1hdFR5cGVzX2RlZmF1bHRbdHlwZV0sIG1heWJlU3VmZml4ID0gL1tkZWZncHJzJV0vLnRlc3QodHlwZSk7CiAgICBwcmVjaXNpb24gPSBwcmVjaXNpb24gPT09IHZvaWQgMCA/IDYgOiAvW2dwcnNdLy50ZXN0KHR5cGUpID8gTWF0aC5tYXgoMSwgTWF0aC5taW4oMjEsIHByZWNpc2lvbikpIDogTWF0aC5tYXgoMCwgTWF0aC5taW4oMjAsIHByZWNpc2lvbikpOwogICAgZnVuY3Rpb24gZm9ybWF0Mih2YWx1ZSkgewogICAgICB2YXIgdmFsdWVQcmVmaXggPSBwcmVmaXgsIHZhbHVlU3VmZml4ID0gc3VmZml4LCBpLCBuLCBjOwogICAgICBpZiAodHlwZSA9PT0gImMiKSB7CiAgICAgICAgdmFsdWVTdWZmaXggPSBmb3JtYXRUeXBlKHZhbHVlKSArIHZhbHVlU3VmZml4OwogICAgICAgIHZhbHVlID0gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSArdmFsdWU7CiAgICAgICAgdmFyIHZhbHVlTmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgMSAvIHZhbHVlIDwgMDsKICAgICAgICB2YWx1ZSA9IGlzTmFOKHZhbHVlKSA/IG5hbiA6IGZvcm1hdFR5cGUoTWF0aC5hYnModmFsdWUpLCBwcmVjaXNpb24pOwogICAgICAgIGlmICh0cmltKSB2YWx1ZSA9IGZvcm1hdFRyaW1fZGVmYXVsdCh2YWx1ZSk7CiAgICAgICAgaWYgKHZhbHVlTmVnYXRpdmUgJiYgK3ZhbHVlID09PSAwICYmIHNpZ24yICE9PSAiKyIpIHZhbHVlTmVnYXRpdmUgPSBmYWxzZTsKICAgICAgICB2YWx1ZVByZWZpeCA9ICh2YWx1ZU5lZ2F0aXZlID8gc2lnbjIgPT09ICIoIiA/IHNpZ24yIDogbWludXMgOiBzaWduMiA9PT0gIi0iIHx8IHNpZ24yID09PSAiKCIgPyAiIiA6IHNpZ24yKSArIHZhbHVlUHJlZml4OwogICAgICAgIHZhbHVlU3VmZml4ID0gKHR5cGUgPT09ICJzIiA/IHByZWZpeGVzWzggKyBwcmVmaXhFeHBvbmVudCAvIDNdIDogIiIpICsgdmFsdWVTdWZmaXggKyAodmFsdWVOZWdhdGl2ZSAmJiBzaWduMiA9PT0gIigiID8gIikiIDogIiIpOwogICAgICAgIGlmIChtYXliZVN1ZmZpeCkgewogICAgICAgICAgaSA9IC0xLCBuID0gdmFsdWUubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICAgICAgaWYgKGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpLCA0OCA+IGMgfHwgYyA+IDU3KSB7CiAgICAgICAgICAgICAgdmFsdWVTdWZmaXggPSAoYyA9PT0gNDYgPyBkZWNpbWFsMiArIHZhbHVlLnNsaWNlKGkgKyAxKSA6IHZhbHVlLnNsaWNlKGkpKSArIHZhbHVlU3VmZml4OwogICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbW1hICYmICF6ZXJvMykgdmFsdWUgPSBncm91cCh2YWx1ZSwgSW5maW5pdHkpOwogICAgICB2YXIgbGVuZ3RoID0gdmFsdWVQcmVmaXgubGVuZ3RoICsgdmFsdWUubGVuZ3RoICsgdmFsdWVTdWZmaXgubGVuZ3RoLCBwYWRkaW5nID0gbGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkod2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpIDogIiI7CiAgICAgIGlmIChjb21tYSAmJiB6ZXJvMykgdmFsdWUgPSBncm91cChwYWRkaW5nICsgdmFsdWUsIHBhZGRpbmcubGVuZ3RoID8gd2lkdGggLSB2YWx1ZVN1ZmZpeC5sZW5ndGggOiBJbmZpbml0eSksIHBhZGRpbmcgPSAiIjsKICAgICAgc3dpdGNoIChhbGlnbjIpIHsKICAgICAgICBjYXNlICI8IjoKICAgICAgICAgIHZhbHVlID0gdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4ICsgcGFkZGluZzsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIj0iOgogICAgICAgICAgdmFsdWUgPSB2YWx1ZVByZWZpeCArIHBhZGRpbmcgKyB2YWx1ZSArIHZhbHVlU3VmZml4OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiXiI6CiAgICAgICAgICB2YWx1ZSA9IHBhZGRpbmcuc2xpY2UoMCwgbGVuZ3RoID0gcGFkZGluZy5sZW5ndGggPj4gMSkgKyB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXggKyBwYWRkaW5nLnNsaWNlKGxlbmd0aCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdmFsdWUgPSBwYWRkaW5nICsgdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4OwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bWVyYWxzKHZhbHVlKTsKICAgIH0KICAgIGZvcm1hdDIudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHNwZWNpZmllciArICIiOwogICAgfTsKICAgIHJldHVybiBmb3JtYXQyOwogIH0KICBmdW5jdGlvbiBmb3JtYXRQcmVmaXgyKHNwZWNpZmllciwgdmFsdWUpIHsKICAgIHZhciBmID0gbmV3Rm9ybWF0KChzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSwgc3BlY2lmaWVyLnR5cGUgPSAiZiIsIHNwZWNpZmllcikpLCBlID0gTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnRfZGVmYXVsdCh2YWx1ZSkgLyAzKSkpICogMywgayA9IE1hdGgucG93KDEwLCAtZSksIHByZWZpeCA9IHByZWZpeGVzWzggKyBlIC8gM107CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUyKSB7CiAgICAgIHJldHVybiBmKGsgKiB2YWx1ZTIpICsgcHJlZml4OwogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIGZvcm1hdDogbmV3Rm9ybWF0LAogICAgZm9ybWF0UHJlZml4OiBmb3JtYXRQcmVmaXgyCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZGVmYXVsdExvY2FsZS5qcwp2YXIgbG9jYWxlOwp2YXIgZm9ybWF0Owp2YXIgZm9ybWF0UHJlZml4OwpkZWZhdWx0TG9jYWxlKHsKICB0aG91c2FuZHM6ICIsIiwKICBncm91cGluZzogWzNdLAogIGN1cnJlbmN5OiBbIiQiLCAiIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUoZGVmaW5pdGlvbikgewogIGxvY2FsZSA9IGxvY2FsZV9kZWZhdWx0KGRlZmluaXRpb24pOwogIGZvcm1hdCA9IGxvY2FsZS5mb3JtYXQ7CiAgZm9ybWF0UHJlZml4ID0gbG9jYWxlLmZvcm1hdFByZWZpeDsKICByZXR1cm4gbG9jYWxlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25GaXhlZC5qcwpmdW5jdGlvbiBwcmVjaXNpb25GaXhlZF9kZWZhdWx0KHN0ZXApIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgLWV4cG9uZW50X2RlZmF1bHQoTWF0aC5hYnMoc3RlcCkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvcHJlY2lzaW9uUHJlZml4LmpzCmZ1bmN0aW9uIHByZWNpc2lvblByZWZpeF9kZWZhdWx0KHN0ZXAsIHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50X2RlZmF1bHQodmFsdWUpIC8gMykpKSAqIDMgLSBleHBvbmVudF9kZWZhdWx0KE1hdGguYWJzKHN0ZXApKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblJvdW5kLmpzCmZ1bmN0aW9uIHByZWNpc2lvblJvdW5kX2RlZmF1bHQoc3RlcCwgbWF4MykgewogIHN0ZXAgPSBNYXRoLmFicyhzdGVwKSwgbWF4MyA9IE1hdGguYWJzKG1heDMpIC0gc3RlcDsKICByZXR1cm4gTWF0aC5tYXgoMCwgZXhwb25lbnRfZGVmYXVsdChtYXgzKSAtIGV4cG9uZW50X2RlZmF1bHQoc3RlcCkpICsgMTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9hc2NlbmRpbmcuanMKZnVuY3Rpb24gYXNjZW5kaW5nKGEsIGIpIHsKICByZXR1cm4gYSA9PSBudWxsIHx8IGIgPT0gbnVsbCA/IE5hTiA6IGEgPCBiID8gLTEgOiBhID4gYiA/IDEgOiBhID49IGIgPyAwIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2Rlc2NlbmRpbmcuanMKZnVuY3Rpb24gZGVzY2VuZGluZyhhLCBiKSB7CiAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBiIDwgYSA/IC0xIDogYiA+IGEgPyAxIDogYiA+PSBhID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3Rvci5qcwpmdW5jdGlvbiBiaXNlY3RvcihmKSB7CiAgbGV0IGNvbXBhcmUxLCBjb21wYXJlMiwgZGVsdGE7CiAgaWYgKGYubGVuZ3RoICE9PSAyKSB7CiAgICBjb21wYXJlMSA9IGFzY2VuZGluZzsKICAgIGNvbXBhcmUyID0gKGQsIHgpID0+IGFzY2VuZGluZyhmKGQpLCB4KTsKICAgIGRlbHRhID0gKGQsIHgpID0+IGYoZCkgLSB4OwogIH0gZWxzZSB7CiAgICBjb21wYXJlMSA9IGYgPT09IGFzY2VuZGluZyB8fCBmID09PSBkZXNjZW5kaW5nID8gZiA6IHplcm87CiAgICBjb21wYXJlMiA9IGY7CiAgICBkZWx0YSA9IGY7CiAgfQogIGZ1bmN0aW9uIGxlZnQyKGEsIHgsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgaWYgKGxvIDwgaGkpIHsKICAgICAgaWYgKGNvbXBhcmUxKHgsIHgpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgpIDwgMCkgbG8gPSBtaWQgKyAxOwogICAgICAgIGVsc2UgaGkgPSBtaWQ7CiAgICAgIH0gd2hpbGUgKGxvIDwgaGkpOwogICAgfQogICAgcmV0dXJuIGxvOwogIH0KICBmdW5jdGlvbiByaWdodDIoYSwgeCwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICBpZiAobG8gPCBoaSkgewogICAgICBpZiAoY29tcGFyZTEoeCwgeCkgIT09IDApIHJldHVybiBoaTsKICAgICAgZG8gewogICAgICAgIGNvbnN0IG1pZCA9IGxvICsgaGkgPj4+IDE7CiAgICAgICAgaWYgKGNvbXBhcmUyKGFbbWlkXSwgeCkgPD0gMCkgbG8gPSBtaWQgKyAxOwogICAgICAgIGVsc2UgaGkgPSBtaWQ7CiAgICAgIH0gd2hpbGUgKGxvIDwgaGkpOwogICAgfQogICAgcmV0dXJuIGxvOwogIH0KICBmdW5jdGlvbiBjZW50ZXIyKGEsIHgsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgY29uc3QgaSA9IGxlZnQyKGEsIHgsIGxvLCBoaSAtIDEpOwogICAgcmV0dXJuIGkgPiBsbyAmJiBkZWx0YShhW2kgLSAxXSwgeCkgPiAtZGVsdGEoYVtpXSwgeCkgPyBpIC0gMSA6IGk7CiAgfQogIHJldHVybiB7IGxlZnQ6IGxlZnQyLCBjZW50ZXI6IGNlbnRlcjIsIHJpZ2h0OiByaWdodDIgfTsKfQpmdW5jdGlvbiB6ZXJvKCkgewogIHJldHVybiAwOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIyKHgpIHsKICByZXR1cm4geCA9PT0gbnVsbCA/IE5hTiA6ICt4Owp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2Jpc2VjdC5qcwp2YXIgYXNjZW5kaW5nQmlzZWN0ID0gYmlzZWN0b3IoYXNjZW5kaW5nKTsKdmFyIGJpc2VjdFJpZ2h0ID0gYXNjZW5kaW5nQmlzZWN0LnJpZ2h0Owp2YXIgYmlzZWN0TGVmdCA9IGFzY2VuZGluZ0Jpc2VjdC5sZWZ0Owp2YXIgYmlzZWN0Q2VudGVyID0gYmlzZWN0b3IobnVtYmVyMikuY2VudGVyOwp2YXIgYmlzZWN0X2RlZmF1bHQgPSBiaXNlY3RSaWdodDsKCi8vIG5vZGVfbW9kdWxlcy9pbnRlcm5tYXAvc3JjL2luZGV4LmpzCnZhciBJbnRlcm5NYXAgPSBjbGFzcyBleHRlbmRzIE1hcCB7CiAgY29uc3RydWN0b3IoZW50cmllcywga2V5ID0ga2V5b2YpIHsKICAgIHN1cGVyKCk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7IF9pbnRlcm46IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkgfSwgX2tleTogeyB2YWx1ZToga2V5IH0gfSk7CiAgICBpZiAoZW50cmllcyAhPSBudWxsKSBmb3IgKGNvbnN0IFtrZXkyLCB2YWx1ZV0gb2YgZW50cmllcykgdGhpcy5zZXQoa2V5MiwgdmFsdWUpOwogIH0KICBnZXQoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuZ2V0KGludGVybl9nZXQodGhpcywga2V5KSk7CiAgfQogIGhhcyhrZXkpIHsKICAgIHJldHVybiBzdXBlci5oYXMoaW50ZXJuX2dldCh0aGlzLCBrZXkpKTsKICB9CiAgc2V0KGtleSwgdmFsdWUpIHsKICAgIHJldHVybiBzdXBlci5zZXQoaW50ZXJuX3NldCh0aGlzLCBrZXkpLCB2YWx1ZSk7CiAgfQogIGRlbGV0ZShrZXkpIHsKICAgIHJldHVybiBzdXBlci5kZWxldGUoaW50ZXJuX2RlbGV0ZSh0aGlzLCBrZXkpKTsKICB9Cn07CmZ1bmN0aW9uIGludGVybl9nZXQoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgcmV0dXJuIF9pbnRlcm4uaGFzKGtleSkgPyBfaW50ZXJuLmdldChrZXkpIDogdmFsdWU7Cn0KZnVuY3Rpb24gaW50ZXJuX3NldCh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICBpZiAoX2ludGVybi5oYXMoa2V5KSkgcmV0dXJuIF9pbnRlcm4uZ2V0KGtleSk7CiAgX2ludGVybi5zZXQoa2V5LCB2YWx1ZSk7CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGludGVybl9kZWxldGUoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgaWYgKF9pbnRlcm4uaGFzKGtleSkpIHsKICAgIHZhbHVlID0gX2ludGVybi5nZXQoa2V5KTsKICAgIF9pbnRlcm4uZGVsZXRlKGtleSk7CiAgfQogIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBrZXlvZih2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiID8gdmFsdWUudmFsdWVPZigpIDogdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvdGlja3MuanMKdmFyIGUxMCA9IE1hdGguc3FydCg1MCk7CnZhciBlNSA9IE1hdGguc3FydCgxMCk7CnZhciBlMiA9IE1hdGguc3FydCgyKTsKZnVuY3Rpb24gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50MikgewogIGNvbnN0IHN0ZXAgPSAoc3RvcCAtIHN0YXJ0KSAvIE1hdGgubWF4KDAsIGNvdW50MiksIHBvd2VyID0gTWF0aC5mbG9vcihNYXRoLmxvZzEwKHN0ZXApKSwgZXJyb3IgPSBzdGVwIC8gTWF0aC5wb3coMTAsIHBvd2VyKSwgZmFjdG9yID0gZXJyb3IgPj0gZTEwID8gMTAgOiBlcnJvciA+PSBlNSA/IDUgOiBlcnJvciA+PSBlMiA/IDIgOiAxOwogIGxldCBpMSwgaTIsIGluYzsKICBpZiAocG93ZXIgPCAwKSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgLXBvd2VyKSAvIGZhY3RvcjsKICAgIGkxID0gTWF0aC5yb3VuZChzdGFydCAqIGluYyk7CiAgICBpMiA9IE1hdGgucm91bmQoc3RvcCAqIGluYyk7CiAgICBpZiAoaTEgLyBpbmMgPCBzdGFydCkgKytpMTsKICAgIGlmIChpMiAvIGluYyA+IHN0b3ApIC0taTI7CiAgICBpbmMgPSAtaW5jOwogIH0gZWxzZSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgcG93ZXIpICogZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0IC8gaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wIC8gaW5jKTsKICAgIGlmIChpMSAqIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyICogaW5jID4gc3RvcCkgLS1pMjsKICB9CiAgaWYgKGkyIDwgaTEgJiYgMC41IDw9IGNvdW50MiAmJiBjb3VudDIgPCAyKSByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50MiAqIDIpOwogIHJldHVybiBbaTEsIGkyLCBpbmNdOwp9CmZ1bmN0aW9uIHRpY2tzKHN0YXJ0LCBzdG9wLCBjb3VudDIpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudDIgPSArY291bnQyOwogIGlmICghKGNvdW50MiA+IDApKSByZXR1cm4gW107CiAgaWYgKHN0YXJ0ID09PSBzdG9wKSByZXR1cm4gW3N0YXJ0XTsKICBjb25zdCByZXZlcnNlID0gc3RvcCA8IHN0YXJ0LCBbaTEsIGkyLCBpbmNdID0gcmV2ZXJzZSA/IHRpY2tTcGVjKHN0b3AsIHN0YXJ0LCBjb3VudDIpIDogdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50Mik7CiAgaWYgKCEoaTIgPj0gaTEpKSByZXR1cm4gW107CiAgY29uc3QgbiA9IGkyIC0gaTEgKyAxLCB0aWNrczIgPSBuZXcgQXJyYXkobik7CiAgaWYgKHJldmVyc2UpIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgKiBpbmM7CiAgfSBlbHNlIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgKiBpbmM7CiAgfQogIHJldHVybiB0aWNrczI7Cn0KZnVuY3Rpb24gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQyKSB7CiAgc3RvcCA9ICtzdG9wLCBzdGFydCA9ICtzdGFydCwgY291bnQyID0gK2NvdW50MjsKICByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50MilbMl07Cn0KZnVuY3Rpb24gdGlja1N0ZXAoc3RhcnQsIHN0b3AsIGNvdW50MikgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50MiA9ICtjb3VudDI7CiAgY29uc3QgcmV2ZXJzZSA9IHN0b3AgPCBzdGFydCwgaW5jID0gcmV2ZXJzZSA/IHRpY2tJbmNyZW1lbnQoc3RvcCwgc3RhcnQsIGNvdW50MikgOiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudDIpOwogIHJldHVybiAocmV2ZXJzZSA/IC0xIDogMSkgKiAoaW5jIDwgMCA/IDEgLyAtaW5jIDogaW5jKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9pbml0LmpzCmZ1bmN0aW9uIGluaXRSYW5nZShkb21haW4sIHJhbmdlKSB7CiAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICB0aGlzLnJhbmdlKGRvbWFpbik7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhpcy5yYW5nZShyYW5nZSkuZG9tYWluKGRvbWFpbik7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gdGhpczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9vcmRpbmFsLmpzCnZhciBpbXBsaWNpdCA9IFN5bWJvbCgiaW1wbGljaXQiKTsKZnVuY3Rpb24gb3JkaW5hbCgpIHsKICB2YXIgaW5kZXggPSBuZXcgSW50ZXJuTWFwKCksIGRvbWFpbiA9IFtdLCByYW5nZSA9IFtdLCB1bmtub3duID0gaW1wbGljaXQ7CiAgZnVuY3Rpb24gc2NhbGUoZCkgewogICAgbGV0IGkgPSBpbmRleC5nZXQoZCk7CiAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgIGlmICh1bmtub3duICE9PSBpbXBsaWNpdCkgcmV0dXJuIHVua25vd247CiAgICAgIGluZGV4LnNldChkLCBpID0gZG9tYWluLnB1c2goZCkgLSAxKTsKICAgIH0KICAgIHJldHVybiByYW5nZVtpICUgcmFuZ2UubGVuZ3RoXTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXSwgaW5kZXggPSBuZXcgSW50ZXJuTWFwKCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIF8pIHsKICAgICAgaWYgKGluZGV4Lmhhcyh2YWx1ZSkpIGNvbnRpbnVlOwogICAgICBpbmRleC5zZXQodmFsdWUsIGRvbWFpbi5wdXNoKHZhbHVlKSAtIDEpOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZSA9IEFycmF5LmZyb20oXyksIHNjYWxlKSA6IHJhbmdlLnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gb3JkaW5hbChkb21haW4sIHJhbmdlKS51bmtub3duKHVua25vd24pOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9kZWZpbmUuanMKZnVuY3Rpb24gZGVmaW5lX2RlZmF1bHQoY29uc3RydWN0b3IsIGZhY3RvcnksIHByb3RvdHlwZSkgewogIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IGZhY3RvcnkucHJvdG90eXBlID0gcHJvdG90eXBlOwogIHByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwp9CmZ1bmN0aW9uIGV4dGVuZChwYXJlbnQsIGRlZmluaXRpb24pIHsKICB2YXIgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKICBmb3IgKHZhciBrZXkgaW4gZGVmaW5pdGlvbikgcHJvdG90eXBlW2tleV0gPSBkZWZpbml0aW9uW2tleV07CiAgcmV0dXJuIHByb3RvdHlwZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9jb2xvci5qcwpmdW5jdGlvbiBDb2xvcigpIHsKfQp2YXIgZGFya2VyID0gMC43Owp2YXIgYnJpZ2h0ZXIgPSAxIC8gZGFya2VyOwp2YXIgcmVJID0gIlxccyooWystXT9cXGQrKVxccyoiOwp2YXIgcmVOID0gIlxccyooWystXT8oPzpcXGQqXFwuKT9cXGQrKD86W2VFXVsrLV0/XFxkKyk/KVxccyoiOwp2YXIgcmVQID0gIlxccyooWystXT8oPzpcXGQqXFwuKT9cXGQrKD86W2VFXVsrLV0/XFxkKyk/KSVcXHMqIjsKdmFyIHJlSGV4ID0gL14jKFswLTlhLWZdezMsOH0pJC87CnZhciByZVJnYkludGVnZXIgPSBuZXcgUmVnRXhwKGBecmdiXFwoJHtyZUl9LCR7cmVJfSwke3JlSX1cXCkkYCk7CnZhciByZVJnYlBlcmNlbnQgPSBuZXcgUmVnRXhwKGBecmdiXFwoJHtyZVB9LCR7cmVQfSwke3JlUH1cXCkkYCk7CnZhciByZVJnYmFJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYmFcXCgke3JlSX0sJHtyZUl9LCR7cmVJfSwke3JlTn1cXCkkYCk7CnZhciByZVJnYmFQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYmFcXCgke3JlUH0sJHtyZVB9LCR7cmVQfSwke3JlTn1cXCkkYCk7CnZhciByZUhzbFBlcmNlbnQgPSBuZXcgUmVnRXhwKGBeaHNsXFwoJHtyZU59LCR7cmVQfSwke3JlUH1cXCkkYCk7CnZhciByZUhzbGFQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbGFcXCgke3JlTn0sJHtyZVB9LCR7cmVQfSwke3JlTn1cXCkkYCk7CnZhciBuYW1lZCA9IHsKICBhbGljZWJsdWU6IDE1NzkyMzgzLAogIGFudGlxdWV3aGl0ZTogMTY0NDQzNzUsCiAgYXF1YTogNjU1MzUsCiAgYXF1YW1hcmluZTogODM4ODU2NCwKICBhenVyZTogMTU3OTQxNzUsCiAgYmVpZ2U6IDE2MTE5MjYwLAogIGJpc3F1ZTogMTY3NzAyNDQsCiAgYmxhY2s6IDAsCiAgYmxhbmNoZWRhbG1vbmQ6IDE2NzcyMDQ1LAogIGJsdWU6IDI1NSwKICBibHVldmlvbGV0OiA5MDU1MjAyLAogIGJyb3duOiAxMDgyNDIzNCwKICBidXJseXdvb2Q6IDE0NTk2MjMxLAogIGNhZGV0Ymx1ZTogNjI2NjUyOCwKICBjaGFydHJldXNlOiA4Mzg4MzUyLAogIGNob2NvbGF0ZTogMTM3ODk0NzAsCiAgY29yYWw6IDE2NzQ0MjcyLAogIGNvcm5mbG93ZXJibHVlOiA2NTkxOTgxLAogIGNvcm5zaWxrOiAxNjc3NTM4OCwKICBjcmltc29uOiAxNDQyMzEwMCwKICBjeWFuOiA2NTUzNSwKICBkYXJrYmx1ZTogMTM5LAogIGRhcmtjeWFuOiAzNTcyMywKICBkYXJrZ29sZGVucm9kOiAxMjA5MjkzOSwKICBkYXJrZ3JheTogMTExMTkwMTcsCiAgZGFya2dyZWVuOiAyNTYwMCwKICBkYXJrZ3JleTogMTExMTkwMTcsCiAgZGFya2toYWtpOiAxMjQzMzI1OSwKICBkYXJrbWFnZW50YTogOTEwOTY0MywKICBkYXJrb2xpdmVncmVlbjogNTU5Nzk5OSwKICBkYXJrb3JhbmdlOiAxNjc0NzUyMCwKICBkYXJrb3JjaGlkOiAxMDA0MDAxMiwKICBkYXJrcmVkOiA5MTA5NTA0LAogIGRhcmtzYWxtb246IDE1MzA4NDEwLAogIGRhcmtzZWFncmVlbjogOTQxOTkxOSwKICBkYXJrc2xhdGVibHVlOiA0NzM0MzQ3LAogIGRhcmtzbGF0ZWdyYXk6IDMxMDA0OTUsCiAgZGFya3NsYXRlZ3JleTogMzEwMDQ5NSwKICBkYXJrdHVycXVvaXNlOiA1Mjk0NSwKICBkYXJrdmlvbGV0OiA5Njk5NTM5LAogIGRlZXBwaW5rOiAxNjcxNjk0NywKICBkZWVwc2t5Ymx1ZTogNDkxNTEsCiAgZGltZ3JheTogNjkwODI2NSwKICBkaW1ncmV5OiA2OTA4MjY1LAogIGRvZGdlcmJsdWU6IDIwMDMxOTksCiAgZmlyZWJyaWNrOiAxMTY3NDE0NiwKICBmbG9yYWx3aGl0ZTogMTY3NzU5MjAsCiAgZm9yZXN0Z3JlZW46IDIyNjM4NDIsCiAgZnVjaHNpYTogMTY3MTE5MzUsCiAgZ2FpbnNib3JvOiAxNDQ3NDQ2MCwKICBnaG9zdHdoaXRlOiAxNjMxNjY3MSwKICBnb2xkOiAxNjc2NjcyMCwKICBnb2xkZW5yb2Q6IDE0MzI5MTIwLAogIGdyYXk6IDg0MjE1MDQsCiAgZ3JlZW46IDMyNzY4LAogIGdyZWVueWVsbG93OiAxMTQwMzA1NSwKICBncmV5OiA4NDIxNTA0LAogIGhvbmV5ZGV3OiAxNTc5NDE2MCwKICBob3RwaW5rOiAxNjczODc0MCwKICBpbmRpYW5yZWQ6IDEzNDU4NTI0LAogIGluZGlnbzogNDkxNTMzMCwKICBpdm9yeTogMTY3NzcyMDAsCiAga2hha2k6IDE1Nzg3NjYwLAogIGxhdmVuZGVyOiAxNTEzMjQxMCwKICBsYXZlbmRlcmJsdXNoOiAxNjc3MzM2NSwKICBsYXduZ3JlZW46IDgxOTA5NzYsCiAgbGVtb25jaGlmZm9uOiAxNjc3NTg4NSwKICBsaWdodGJsdWU6IDExMzkzMjU0LAogIGxpZ2h0Y29yYWw6IDE1NzYxNTM2LAogIGxpZ2h0Y3lhbjogMTQ3NDU1OTksCiAgbGlnaHRnb2xkZW5yb2R5ZWxsb3c6IDE2NDQ4MjEwLAogIGxpZ2h0Z3JheTogMTM4ODIzMjMsCiAgbGlnaHRncmVlbjogOTQ5ODI1NiwKICBsaWdodGdyZXk6IDEzODgyMzIzLAogIGxpZ2h0cGluazogMTY3NTg0NjUsCiAgbGlnaHRzYWxtb246IDE2NzUyNzYyLAogIGxpZ2h0c2VhZ3JlZW46IDIxNDI4OTAsCiAgbGlnaHRza3libHVlOiA4OTAwMzQ2LAogIGxpZ2h0c2xhdGVncmF5OiA3ODMzNzUzLAogIGxpZ2h0c2xhdGVncmV5OiA3ODMzNzUzLAogIGxpZ2h0c3RlZWxibHVlOiAxMTU4NDczNCwKICBsaWdodHllbGxvdzogMTY3NzcxODQsCiAgbGltZTogNjUyODAsCiAgbGltZWdyZWVuOiAzMzI5MzMwLAogIGxpbmVuOiAxNjQ0NTY3MCwKICBtYWdlbnRhOiAxNjcxMTkzNSwKICBtYXJvb246IDgzODg2MDgsCiAgbWVkaXVtYXF1YW1hcmluZTogNjczNzMyMiwKICBtZWRpdW1ibHVlOiAyMDUsCiAgbWVkaXVtb3JjaGlkOiAxMjIxMTY2NywKICBtZWRpdW1wdXJwbGU6IDk2NjI2ODMsCiAgbWVkaXVtc2VhZ3JlZW46IDM5NzgwOTcsCiAgbWVkaXVtc2xhdGVibHVlOiA4MDg3NzkwLAogIG1lZGl1bXNwcmluZ2dyZWVuOiA2NDE1NCwKICBtZWRpdW10dXJxdW9pc2U6IDQ3NzIzMDAsCiAgbWVkaXVtdmlvbGV0cmVkOiAxMzA0NzE3MywKICBtaWRuaWdodGJsdWU6IDE2NDQ5MTIsCiAgbWludGNyZWFtOiAxNjEyMTg1MCwKICBtaXN0eXJvc2U6IDE2NzcwMjczLAogIG1vY2Nhc2luOiAxNjc3MDIyOSwKICBuYXZham93aGl0ZTogMTY3Njg2ODUsCiAgbmF2eTogMTI4LAogIG9sZGxhY2U6IDE2NjQzNTU4LAogIG9saXZlOiA4NDIxMzc2LAogIG9saXZlZHJhYjogNzA0ODczOSwKICBvcmFuZ2U6IDE2NzUzOTIwLAogIG9yYW5nZXJlZDogMTY3MjkzNDQsCiAgb3JjaGlkOiAxNDMxNTczNCwKICBwYWxlZ29sZGVucm9kOiAxNTY1NzEzMCwKICBwYWxlZ3JlZW46IDEwMDI1ODgwLAogIHBhbGV0dXJxdW9pc2U6IDExNTI5OTY2LAogIHBhbGV2aW9sZXRyZWQ6IDE0MzgxMjAzLAogIHBhcGF5YXdoaXA6IDE2NzczMDc3LAogIHBlYWNocHVmZjogMTY3Njc2NzMsCiAgcGVydTogMTM0Njg5OTEsCiAgcGluazogMTY3NjEwMzUsCiAgcGx1bTogMTQ1MjQ2MzcsCiAgcG93ZGVyYmx1ZTogMTE1OTE5MTAsCiAgcHVycGxlOiA4Mzg4NzM2LAogIHJlYmVjY2FwdXJwbGU6IDY2OTc4ODEsCiAgcmVkOiAxNjcxMTY4MCwKICByb3N5YnJvd246IDEyMzU3NTE5LAogIHJveWFsYmx1ZTogNDI4Njk0NSwKICBzYWRkbGVicm93bjogOTEyNzE4NywKICBzYWxtb246IDE2NDE2ODgyLAogIHNhbmR5YnJvd246IDE2MDMyODY0LAogIHNlYWdyZWVuOiAzMDUwMzI3LAogIHNlYXNoZWxsOiAxNjc3NDYzOCwKICBzaWVubmE6IDEwNTA2Nzk3LAogIHNpbHZlcjogMTI2MzIyNTYsCiAgc2t5Ymx1ZTogODkwMDMzMSwKICBzbGF0ZWJsdWU6IDY5NzAwNjEsCiAgc2xhdGVncmF5OiA3MzcyOTQ0LAogIHNsYXRlZ3JleTogNzM3Mjk0NCwKICBzbm93OiAxNjc3NTkzMCwKICBzcHJpbmdncmVlbjogNjU0MDcsCiAgc3RlZWxibHVlOiA0NjIwOTgwLAogIHRhbjogMTM4MDg3ODAsCiAgdGVhbDogMzI4OTYsCiAgdGhpc3RsZTogMTQyMDQ4ODgsCiAgdG9tYXRvOiAxNjczNzA5NSwKICB0dXJxdW9pc2U6IDQyNTE4NTYsCiAgdmlvbGV0OiAxNTYzMTA4NiwKICB3aGVhdDogMTYxMTMzMzEsCiAgd2hpdGU6IDE2Nzc3MjE1LAogIHdoaXRlc21va2U6IDE2MTE5Mjg1LAogIHllbGxvdzogMTY3NzY5NjAsCiAgeWVsbG93Z3JlZW46IDEwMTQ1MDc0Cn07CmRlZmluZV9kZWZhdWx0KENvbG9yLCBjb2xvciwgewogIGNvcHkoY2hhbm5lbHMpIHsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyB0aGlzLmNvbnN0cnVjdG9yKCksIHRoaXMsIGNoYW5uZWxzKTsKICB9LAogIGRpc3BsYXlhYmxlKCkgewogICAgcmV0dXJuIHRoaXMucmdiKCkuZGlzcGxheWFibGUoKTsKICB9LAogIGhleDogY29sb3JfZm9ybWF0SGV4LAogIC8vIERlcHJlY2F0ZWQhIFVzZSBjb2xvci5mb3JtYXRIZXguCiAgZm9ybWF0SGV4OiBjb2xvcl9mb3JtYXRIZXgsCiAgZm9ybWF0SGV4ODogY29sb3JfZm9ybWF0SGV4OCwKICBmb3JtYXRIc2w6IGNvbG9yX2Zvcm1hdEhzbCwKICBmb3JtYXRSZ2I6IGNvbG9yX2Zvcm1hdFJnYiwKICB0b1N0cmluZzogY29sb3JfZm9ybWF0UmdiCn0pOwpmdW5jdGlvbiBjb2xvcl9mb3JtYXRIZXgoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4KCk7Cn0KZnVuY3Rpb24gY29sb3JfZm9ybWF0SGV4OCgpIHsKICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRIZXg4KCk7Cn0KZnVuY3Rpb24gY29sb3JfZm9ybWF0SHNsKCkgewogIHJldHVybiBoc2xDb252ZXJ0KHRoaXMpLmZvcm1hdEhzbCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdFJnYigpIHsKICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRSZ2IoKTsKfQpmdW5jdGlvbiBjb2xvcihmb3JtYXQyKSB7CiAgdmFyIG0sIGw7CiAgZm9ybWF0MiA9IChmb3JtYXQyICsgIiIpLnRyaW0oKS50b0xvd2VyQ2FzZSgpOwogIHJldHVybiAobSA9IHJlSGV4LmV4ZWMoZm9ybWF0MikpID8gKGwgPSBtWzFdLmxlbmd0aCwgbSA9IHBhcnNlSW50KG1bMV0sIDE2KSwgbCA9PT0gNiA/IHJnYm4obSkgOiBsID09PSAzID8gbmV3IFJnYihtID4+IDggJiAxNSB8IG0gPj4gNCAmIDI0MCwgbSA+PiA0ICYgMTUgfCBtICYgMjQwLCAobSAmIDE1KSA8PCA0IHwgbSAmIDE1LCAxKSA6IGwgPT09IDggPyByZ2JhKG0gPj4gMjQgJiAyNTUsIG0gPj4gMTYgJiAyNTUsIG0gPj4gOCAmIDI1NSwgKG0gJiAyNTUpIC8gMjU1KSA6IGwgPT09IDQgPyByZ2JhKG0gPj4gMTIgJiAxNSB8IG0gPj4gOCAmIDI0MCwgbSA+PiA4ICYgMTUgfCBtID4+IDQgJiAyNDAsIG0gPj4gNCAmIDE1IHwgbSAmIDI0MCwgKChtICYgMTUpIDw8IDQgfCBtICYgMTUpIC8gMjU1KSA6IG51bGwpIDogKG0gPSByZVJnYkludGVnZXIuZXhlYyhmb3JtYXQyKSkgPyBuZXcgUmdiKG1bMV0sIG1bMl0sIG1bM10sIDEpIDogKG0gPSByZVJnYlBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBuZXcgUmdiKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIDEpIDogKG0gPSByZVJnYmFJbnRlZ2VyLmV4ZWMoZm9ybWF0MikpID8gcmdiYShtWzFdLCBtWzJdLCBtWzNdLCBtWzRdKSA6IChtID0gcmVSZ2JhUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IHJnYmEobVsxXSAqIDI1NSAvIDEwMCwgbVsyXSAqIDI1NSAvIDEwMCwgbVszXSAqIDI1NSAvIDEwMCwgbVs0XSkgOiAobSA9IHJlSHNsUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IGhzbGEobVsxXSwgbVsyXSAvIDEwMCwgbVszXSAvIDEwMCwgMSkgOiAobSA9IHJlSHNsYVBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIG1bNF0pIDogbmFtZWQuaGFzT3duUHJvcGVydHkoZm9ybWF0MikgPyByZ2JuKG5hbWVkW2Zvcm1hdDJdKSA6IGZvcm1hdDIgPT09ICJ0cmFuc3BhcmVudCIgPyBuZXcgUmdiKE5hTiwgTmFOLCBOYU4sIDApIDogbnVsbDsKfQpmdW5jdGlvbiByZ2JuKG4pIHsKICByZXR1cm4gbmV3IFJnYihuID4+IDE2ICYgMjU1LCBuID4+IDggJiAyNTUsIG4gJiAyNTUsIDEpOwp9CmZ1bmN0aW9uIHJnYmEociwgZywgYiwgYSkgewogIGlmIChhIDw9IDApIHIgPSBnID0gYiA9IE5hTjsKICByZXR1cm4gbmV3IFJnYihyLCBnLCBiLCBhKTsKfQpmdW5jdGlvbiByZ2JDb252ZXJ0KG8pIHsKICBpZiAoIShvIGluc3RhbmNlb2YgQ29sb3IpKSBvID0gY29sb3Iobyk7CiAgaWYgKCFvKSByZXR1cm4gbmV3IFJnYigpOwogIG8gPSBvLnJnYigpOwogIHJldHVybiBuZXcgUmdiKG8uciwgby5nLCBvLmIsIG8ub3BhY2l0eSk7Cn0KZnVuY3Rpb24gcmdiKHIsIGcsIGIsIG9wYWNpdHkpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHJnYkNvbnZlcnQocikgOiBuZXcgUmdiKHIsIGcsIGIsIG9wYWNpdHkgPT0gbnVsbCA/IDEgOiBvcGFjaXR5KTsKfQpmdW5jdGlvbiBSZ2IociwgZywgYiwgb3BhY2l0eSkgewogIHRoaXMuciA9ICtyOwogIHRoaXMuZyA9ICtnOwogIHRoaXMuYiA9ICtiOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KFJnYiwgcmdiLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgayk7CiAgICByZXR1cm4gbmV3IFJnYih0aGlzLnIgKiBrLCB0aGlzLmcgKiBrLCB0aGlzLmIgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGspOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHJldHVybiB0aGlzOwogIH0sCiAgY2xhbXAoKSB7CiAgICByZXR1cm4gbmV3IFJnYihjbGFtcGkodGhpcy5yKSwgY2xhbXBpKHRoaXMuZyksIGNsYW1waSh0aGlzLmIpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiAtMC41IDw9IHRoaXMuciAmJiB0aGlzLnIgPCAyNTUuNSAmJiAoLTAuNSA8PSB0aGlzLmcgJiYgdGhpcy5nIDwgMjU1LjUpICYmICgtMC41IDw9IHRoaXMuYiAmJiB0aGlzLmIgPCAyNTUuNSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGhleDogcmdiX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogcmdiX2Zvcm1hdEhleCwKICBmb3JtYXRIZXg4OiByZ2JfZm9ybWF0SGV4OCwKICBmb3JtYXRSZ2I6IHJnYl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IHJnYl9mb3JtYXRSZ2IKfSkpOwpmdW5jdGlvbiByZ2JfZm9ybWF0SGV4KCkgewogIHJldHVybiBgIyR7aGV4KHRoaXMucil9JHtoZXgodGhpcy5nKX0ke2hleCh0aGlzLmIpfWA7Cn0KZnVuY3Rpb24gcmdiX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9JHtoZXgoKGlzTmFOKHRoaXMub3BhY2l0eSkgPyAxIDogdGhpcy5vcGFjaXR5KSAqIDI1NSl9YDsKfQpmdW5jdGlvbiByZ2JfZm9ybWF0UmdiKCkgewogIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICByZXR1cm4gYCR7YSA9PT0gMSA/ICJyZ2IoIiA6ICJyZ2JhKCJ9JHtjbGFtcGkodGhpcy5yKX0sICR7Y2xhbXBpKHRoaXMuZyl9LCAke2NsYW1waSh0aGlzLmIpfSR7YSA9PT0gMSA/ICIpIiA6IGAsICR7YX0pYH1gOwp9CmZ1bmN0aW9uIGNsYW1wYShvcGFjaXR5KSB7CiAgcmV0dXJuIGlzTmFOKG9wYWNpdHkpID8gMSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wYWNpdHkpKTsKfQpmdW5jdGlvbiBjbGFtcGkodmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMjU1LCBNYXRoLnJvdW5kKHZhbHVlKSB8fCAwKSk7Cn0KZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgdmFsdWUgPSBjbGFtcGkodmFsdWUpOwogIHJldHVybiAodmFsdWUgPCAxNiA/ICIwIiA6ICIiKSArIHZhbHVlLnRvU3RyaW5nKDE2KTsKfQpmdW5jdGlvbiBoc2xhKGgsIHMsIGwsIGEpIHsKICBpZiAoYSA8PSAwKSBoID0gcyA9IGwgPSBOYU47CiAgZWxzZSBpZiAobCA8PSAwIHx8IGwgPj0gMSkgaCA9IHMgPSBOYU47CiAgZWxzZSBpZiAocyA8PSAwKSBoID0gTmFOOwogIHJldHVybiBuZXcgSHNsKGgsIHMsIGwsIGEpOwp9CmZ1bmN0aW9uIGhzbENvbnZlcnQobykgewogIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbmV3IEhzbChvLmgsIG8ucywgby5sLCBvLm9wYWNpdHkpOwogIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpIG8gPSBjb2xvcihvKTsKICBpZiAoIW8pIHJldHVybiBuZXcgSHNsKCk7CiAgaWYgKG8gaW5zdGFuY2VvZiBIc2wpIHJldHVybiBvOwogIG8gPSBvLnJnYigpOwogIHZhciByID0gby5yIC8gMjU1LCBnID0gby5nIC8gMjU1LCBiID0gby5iIC8gMjU1LCBtaW4zID0gTWF0aC5taW4ociwgZywgYiksIG1heDMgPSBNYXRoLm1heChyLCBnLCBiKSwgaCA9IE5hTiwgcyA9IG1heDMgLSBtaW4zLCBsID0gKG1heDMgKyBtaW4zKSAvIDI7CiAgaWYgKHMpIHsKICAgIGlmIChyID09PSBtYXgzKSBoID0gKGcgLSBiKSAvIHMgKyAoZyA8IGIpICogNjsKICAgIGVsc2UgaWYgKGcgPT09IG1heDMpIGggPSAoYiAtIHIpIC8gcyArIDI7CiAgICBlbHNlIGggPSAociAtIGcpIC8gcyArIDQ7CiAgICBzIC89IGwgPCAwLjUgPyBtYXgzICsgbWluMyA6IDIgLSBtYXgzIC0gbWluMzsKICAgIGggKj0gNjA7CiAgfSBlbHNlIHsKICAgIHMgPSBsID4gMCAmJiBsIDwgMSA/IDAgOiBoOwogIH0KICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIGhzbChoLCBzLCBsLCBvcGFjaXR5KSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBoc2xDb252ZXJ0KGgpIDogbmV3IEhzbChoLCBzLCBsLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gSHNsKGgsIHMsIGwsIG9wYWNpdHkpIHsKICB0aGlzLmggPSAraDsKICB0aGlzLnMgPSArczsKICB0aGlzLmwgPSArbDsKICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKfQpkZWZpbmVfZGVmYXVsdChIc2wsIGhzbCwgZXh0ZW5kKENvbG9yLCB7CiAgYnJpZ2h0ZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICBkYXJrZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGRhcmtlciA6IE1hdGgucG93KGRhcmtlciwgayk7CiAgICByZXR1cm4gbmV3IEhzbCh0aGlzLmgsIHRoaXMucywgdGhpcy5sICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHZhciBoID0gdGhpcy5oICUgMzYwICsgKHRoaXMuaCA8IDApICogMzYwLCBzID0gaXNOYU4oaCkgfHwgaXNOYU4odGhpcy5zKSA/IDAgOiB0aGlzLnMsIGwgPSB0aGlzLmwsIG0yID0gbCArIChsIDwgMC41ID8gbCA6IDEgLSBsKSAqIHMsIG0xID0gMiAqIGwgLSBtMjsKICAgIHJldHVybiBuZXcgUmdiKAogICAgICBoc2wycmdiKGggPj0gMjQwID8gaCAtIDI0MCA6IGggKyAxMjAsIG0xLCBtMiksCiAgICAgIGhzbDJyZ2IoaCwgbTEsIG0yKSwKICAgICAgaHNsMnJnYihoIDwgMTIwID8gaCArIDI0MCA6IGggLSAxMjAsIG0xLCBtMiksCiAgICAgIHRoaXMub3BhY2l0eQogICAgKTsKICB9LAogIGNsYW1wKCkgewogICAgcmV0dXJuIG5ldyBIc2woY2xhbXBoKHRoaXMuaCksIGNsYW1wdCh0aGlzLnMpLCBjbGFtcHQodGhpcy5sKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gKDAgPD0gdGhpcy5zICYmIHRoaXMucyA8PSAxIHx8IGlzTmFOKHRoaXMucykpICYmICgwIDw9IHRoaXMubCAmJiB0aGlzLmwgPD0gMSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGZvcm1hdEhzbCgpIHsKICAgIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthID09PSAxID8gImhzbCgiIDogImhzbGEoIn0ke2NsYW1waCh0aGlzLmgpfSwgJHtjbGFtcHQodGhpcy5zKSAqIDEwMH0lLCAke2NsYW1wdCh0aGlzLmwpICogMTAwfSUke2EgPT09IDEgPyAiKSIgOiBgLCAke2F9KWB9YDsKICB9Cn0pKTsKZnVuY3Rpb24gY2xhbXBoKHZhbHVlKSB7CiAgdmFsdWUgPSAodmFsdWUgfHwgMCkgJSAzNjA7CiAgcmV0dXJuIHZhbHVlIDwgMCA/IHZhbHVlICsgMzYwIDogdmFsdWU7Cn0KZnVuY3Rpb24gY2xhbXB0KHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZhbHVlIHx8IDApKTsKfQpmdW5jdGlvbiBoc2wycmdiKGgsIG0xLCBtMikgewogIHJldHVybiAoaCA8IDYwID8gbTEgKyAobTIgLSBtMSkgKiBoIC8gNjAgOiBoIDwgMTgwID8gbTIgOiBoIDwgMjQwID8gbTEgKyAobTIgLSBtMSkgKiAoMjQwIC0gaCkgLyA2MCA6IG0xKSAqIDI1NTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpcy5qcwpmdW5jdGlvbiBiYXNpcyh0MTIsIHYwLCB2MSwgdjIsIHYzKSB7CiAgdmFyIHQyID0gdDEyICogdDEyLCB0MyA9IHQyICogdDEyOwogIHJldHVybiAoKDEgLSAzICogdDEyICsgMyAqIHQyIC0gdDMpICogdjAgKyAoNCAtIDYgKiB0MiArIDMgKiB0MykgKiB2MSArICgxICsgMyAqIHQxMiArIDMgKiB0MiAtIDMgKiB0MykgKiB2MiArIHQzICogdjMpIC8gNjsKfQpmdW5jdGlvbiBiYXNpc19kZWZhdWx0KHZhbHVlcykgewogIHZhciBuID0gdmFsdWVzLmxlbmd0aCAtIDE7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpID0gdCA8PSAwID8gdCA9IDAgOiB0ID49IDEgPyAodCA9IDEsIG4gLSAxKSA6IE1hdGguZmxvb3IodCAqIG4pLCB2MSA9IHZhbHVlc1tpXSwgdjIgPSB2YWx1ZXNbaSArIDFdLCB2MCA9IGkgPiAwID8gdmFsdWVzW2kgLSAxXSA6IDIgKiB2MSAtIHYyLCB2MyA9IGkgPCBuIC0gMSA/IHZhbHVlc1tpICsgMl0gOiAyICogdjIgLSB2MTsKICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzQ2xvc2VkLmpzCmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQodmFsdWVzKSB7CiAgdmFyIG4gPSB2YWx1ZXMubGVuZ3RoOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB2YXIgaSA9IE1hdGguZmxvb3IoKCh0ICU9IDEpIDwgMCA/ICsrdCA6IHQpICogbiksIHYwID0gdmFsdWVzWyhpICsgbiAtIDEpICUgbl0sIHYxID0gdmFsdWVzW2kgJSBuXSwgdjIgPSB2YWx1ZXNbKGkgKyAxKSAlIG5dLCB2MyA9IHZhbHVlc1soaSArIDIpICUgbl07CiAgICByZXR1cm4gYmFzaXMoKHQgLSBpIC8gbikgKiBuLCB2MCwgdjEsIHYyLCB2Myk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb25zdGFudC5qcwp2YXIgY29uc3RhbnRfZGVmYXVsdCA9ICh4KSA9PiAoKSA9PiB4OwoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb2xvci5qcwpmdW5jdGlvbiBsaW5lYXIyKGEsIGQpIHsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEgKyB0ICogZDsKICB9Owp9CmZ1bmN0aW9uIGV4cG9uZW50aWFsKGEsIGIsIHkpIHsKICByZXR1cm4gYSA9IE1hdGgucG93KGEsIHkpLCBiID0gTWF0aC5wb3coYiwgeSkgLSBhLCB5ID0gMSAvIHksIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBNYXRoLnBvdyhhICsgdCAqIGIsIHkpOwogIH07Cn0KZnVuY3Rpb24gZ2FtbWEoeSkgewogIHJldHVybiAoeSA9ICt5KSA9PT0gMSA/IG5vZ2FtbWEgOiBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gYiAtIGEgPyBleHBvbmVudGlhbChhLCBiLCB5KSA6IGNvbnN0YW50X2RlZmF1bHQoaXNOYU4oYSkgPyBiIDogYSk7CiAgfTsKfQpmdW5jdGlvbiBub2dhbW1hKGEsIGIpIHsKICB2YXIgZCA9IGIgLSBhOwogIHJldHVybiBkID8gbGluZWFyMihhLCBkKSA6IGNvbnN0YW50X2RlZmF1bHQoaXNOYU4oYSkgPyBiIDogYSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcmdiLmpzCnZhciByZ2JfZGVmYXVsdCA9IGZ1bmN0aW9uIHJnYkdhbW1hKHkpIHsKICB2YXIgY29sb3IyID0gZ2FtbWEoeSk7CiAgZnVuY3Rpb24gcmdiMihzdGFydCwgZW5kKSB7CiAgICB2YXIgciA9IGNvbG9yMigoc3RhcnQgPSByZ2Ioc3RhcnQpKS5yLCAoZW5kID0gcmdiKGVuZCkpLnIpLCBnID0gY29sb3IyKHN0YXJ0LmcsIGVuZC5nKSwgYiA9IGNvbG9yMihzdGFydC5iLCBlbmQuYiksIG9wYWNpdHkgPSBub2dhbW1hKHN0YXJ0Lm9wYWNpdHksIGVuZC5vcGFjaXR5KTsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHN0YXJ0LnIgPSByKHQpOwogICAgICBzdGFydC5nID0gZyh0KTsKICAgICAgc3RhcnQuYiA9IGIodCk7CiAgICAgIHN0YXJ0Lm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgIH07CiAgfQogIHJnYjIuZ2FtbWEgPSByZ2JHYW1tYTsKICByZXR1cm4gcmdiMjsKfSgxKTsKZnVuY3Rpb24gcmdiU3BsaW5lKHNwbGluZSkgewogIHJldHVybiBmdW5jdGlvbihjb2xvcnMpIHsKICAgIHZhciBuID0gY29sb3JzLmxlbmd0aCwgciA9IG5ldyBBcnJheShuKSwgZyA9IG5ldyBBcnJheShuKSwgYiA9IG5ldyBBcnJheShuKSwgaSwgY29sb3IyOwogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICBjb2xvcjIgPSByZ2IoY29sb3JzW2ldKTsKICAgICAgcltpXSA9IGNvbG9yMi5yIHx8IDA7CiAgICAgIGdbaV0gPSBjb2xvcjIuZyB8fCAwOwogICAgICBiW2ldID0gY29sb3IyLmIgfHwgMDsKICAgIH0KICAgIHIgPSBzcGxpbmUocik7CiAgICBnID0gc3BsaW5lKGcpOwogICAgYiA9IHNwbGluZShiKTsKICAgIGNvbG9yMi5vcGFjaXR5ID0gMTsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIGNvbG9yMi5yID0gcih0KTsKICAgICAgY29sb3IyLmcgPSBnKHQpOwogICAgICBjb2xvcjIuYiA9IGIodCk7CiAgICAgIHJldHVybiBjb2xvcjIgKyAiIjsKICAgIH07CiAgfTsKfQp2YXIgcmdiQmFzaXMgPSByZ2JTcGxpbmUoYmFzaXNfZGVmYXVsdCk7CnZhciByZ2JCYXNpc0Nsb3NlZCA9IHJnYlNwbGluZShiYXNpc0Nsb3NlZF9kZWZhdWx0KTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvbnVtYmVyQXJyYXkuanMKZnVuY3Rpb24gbnVtYmVyQXJyYXlfZGVmYXVsdChhLCBiKSB7CiAgaWYgKCFiKSBiID0gW107CiAgdmFyIG4gPSBhID8gTWF0aC5taW4oYi5sZW5ndGgsIGEubGVuZ3RoKSA6IDAsIGMgPSBiLnNsaWNlKCksIGk7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIGNbaV0gPSBhW2ldICogKDEgLSB0KSArIGJbaV0gKiB0OwogICAgcmV0dXJuIGM7CiAgfTsKfQpmdW5jdGlvbiBpc051bWJlckFycmF5KHgpIHsKICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgpICYmICEoeCBpbnN0YW5jZW9mIERhdGFWaWV3KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9hcnJheS5qcwpmdW5jdGlvbiBnZW5lcmljQXJyYXkoYSwgYikgewogIHZhciBuYiA9IGIgPyBiLmxlbmd0aCA6IDAsIG5hID0gYSA/IE1hdGgubWluKG5iLCBhLmxlbmd0aCkgOiAwLCB4ID0gbmV3IEFycmF5KG5hKSwgYyA9IG5ldyBBcnJheShuYiksIGk7CiAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIHhbaV0gPSB2YWx1ZV9kZWZhdWx0KGFbaV0sIGJbaV0pOwogIGZvciAoOyBpIDwgbmI7ICsraSkgY1tpXSA9IGJbaV07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSBjW2ldID0geFtpXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvZGF0ZS5qcwpmdW5jdGlvbiBkYXRlX2RlZmF1bHQoYSwgYikgewogIHZhciBkID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CiAgcmV0dXJuIGEgPSArYSwgYiA9ICtiLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gZC5zZXRUaW1lKGEgKiAoMSAtIHQpICsgYiAqIHQpLCBkOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcl9kZWZhdWx0KGEsIGIpIHsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBhICogKDEgLSB0KSArIGIgKiB0OwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvb2JqZWN0LmpzCmZ1bmN0aW9uIG9iamVjdF9kZWZhdWx0KGEsIGIpIHsKICB2YXIgaSA9IHt9LCBjID0ge30sIGs7CiAgaWYgKGEgPT09IG51bGwgfHwgdHlwZW9mIGEgIT09ICJvYmplY3QiKSBhID0ge307CiAgaWYgKGIgPT09IG51bGwgfHwgdHlwZW9mIGIgIT09ICJvYmplY3QiKSBiID0ge307CiAgZm9yIChrIGluIGIpIHsKICAgIGlmIChrIGluIGEpIHsKICAgICAgaVtrXSA9IHZhbHVlX2RlZmF1bHQoYVtrXSwgYltrXSk7CiAgICB9IGVsc2UgewogICAgICBjW2tdID0gYltrXTsKICAgIH0KICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoayBpbiBpKSBjW2tdID0gaVtrXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvc3RyaW5nLmpzCnZhciByZUEgPSAvWy0rXT8oPzpcZCtcLj9cZCp8XC4/XGQrKSg/OltlRV1bLStdP1xkKyk/L2c7CnZhciByZUIgPSBuZXcgUmVnRXhwKHJlQS5zb3VyY2UsICJnIik7CmZ1bmN0aW9uIHplcm8yKGIpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYjsKICB9Owp9CmZ1bmN0aW9uIG9uZShiKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBiKHQpICsgIiI7CiAgfTsKfQpmdW5jdGlvbiBzdHJpbmdfZGVmYXVsdChhLCBiKSB7CiAgdmFyIGJpID0gcmVBLmxhc3RJbmRleCA9IHJlQi5sYXN0SW5kZXggPSAwLCBhbSwgYm0sIGJzLCBpID0gLTEsIHMgPSBbXSwgcSA9IFtdOwogIGEgPSBhICsgIiIsIGIgPSBiICsgIiI7CiAgd2hpbGUgKChhbSA9IHJlQS5leGVjKGEpKSAmJiAoYm0gPSByZUIuZXhlYyhiKSkpIHsKICAgIGlmICgoYnMgPSBibS5pbmRleCkgPiBiaSkgewogICAgICBicyA9IGIuc2xpY2UoYmksIGJzKTsKICAgICAgaWYgKHNbaV0pIHNbaV0gKz0gYnM7CiAgICAgIGVsc2Ugc1srK2ldID0gYnM7CiAgICB9CiAgICBpZiAoKGFtID0gYW1bMF0pID09PSAoYm0gPSBibVswXSkpIHsKICAgICAgaWYgKHNbaV0pIHNbaV0gKz0gYm07CiAgICAgIGVsc2Ugc1srK2ldID0gYm07CiAgICB9IGVsc2UgewogICAgICBzWysraV0gPSBudWxsOwogICAgICBxLnB1c2goeyBpLCB4OiBudW1iZXJfZGVmYXVsdChhbSwgYm0pIH0pOwogICAgfQogICAgYmkgPSByZUIubGFzdEluZGV4OwogIH0KICBpZiAoYmkgPCBiLmxlbmd0aCkgewogICAgYnMgPSBiLnNsaWNlKGJpKTsKICAgIGlmIChzW2ldKSBzW2ldICs9IGJzOwogICAgZWxzZSBzWysraV0gPSBiczsKICB9CiAgcmV0dXJuIHMubGVuZ3RoIDwgMiA/IHFbMF0gPyBvbmUocVswXS54KSA6IHplcm8yKGIpIDogKGIgPSBxLmxlbmd0aCwgZnVuY3Rpb24odCkgewogICAgZm9yICh2YXIgaTIgPSAwLCBvOyBpMiA8IGI7ICsraTIpIHNbKG8gPSBxW2kyXSkuaV0gPSBvLngodCk7CiAgICByZXR1cm4gcy5qb2luKCIiKTsKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy92YWx1ZS5qcwpmdW5jdGlvbiB2YWx1ZV9kZWZhdWx0KGEsIGIpIHsKICB2YXIgdCA9IHR5cGVvZiBiLCBjOwogIHJldHVybiBiID09IG51bGwgfHwgdCA9PT0gImJvb2xlYW4iID8gY29uc3RhbnRfZGVmYXVsdChiKSA6ICh0ID09PSAibnVtYmVyIiA/IG51bWJlcl9kZWZhdWx0IDogdCA9PT0gInN0cmluZyIgPyAoYyA9IGNvbG9yKGIpKSA/IChiID0gYywgcmdiX2RlZmF1bHQpIDogc3RyaW5nX2RlZmF1bHQgOiBiIGluc3RhbmNlb2YgY29sb3IgPyByZ2JfZGVmYXVsdCA6IGIgaW5zdGFuY2VvZiBEYXRlID8gZGF0ZV9kZWZhdWx0IDogaXNOdW1iZXJBcnJheShiKSA/IG51bWJlckFycmF5X2RlZmF1bHQgOiBBcnJheS5pc0FycmF5KGIpID8gZ2VuZXJpY0FycmF5IDogdHlwZW9mIGIudmFsdWVPZiAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYi50b1N0cmluZyAhPT0gImZ1bmN0aW9uIiB8fCBpc05hTihiKSA/IG9iamVjdF9kZWZhdWx0IDogbnVtYmVyX2RlZmF1bHQpKGEsIGIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3JvdW5kLmpzCmZ1bmN0aW9uIHJvdW5kX2RlZmF1bHQoYSwgYikgewogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIE1hdGgucm91bmQoYSAqICgxIC0gdCkgKyBiICogdCk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9jb25zdGFudC5qcwpmdW5jdGlvbiBjb25zdGFudHMoeCkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB4OwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcjMoeCkgewogIHJldHVybiAreDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9jb250aW51b3VzLmpzCnZhciB1bml0ID0gWzAsIDFdOwpmdW5jdGlvbiBpZGVudGl0eTIoeCkgewogIHJldHVybiB4Owp9CmZ1bmN0aW9uIG5vcm1hbGl6ZShhLCBiKSB7CiAgcmV0dXJuIChiIC09IGEgPSArYSkgPyBmdW5jdGlvbih4KSB7CiAgICByZXR1cm4gKHggLSBhKSAvIGI7CiAgfSA6IGNvbnN0YW50cyhpc05hTihiKSA/IE5hTiA6IDAuNSk7Cn0KZnVuY3Rpb24gY2xhbXBlcihhLCBiKSB7CiAgdmFyIHQ7CiAgaWYgKGEgPiBiKSB0ID0gYSwgYSA9IGIsIGIgPSB0OwogIHJldHVybiBmdW5jdGlvbih4KSB7CiAgICByZXR1cm4gTWF0aC5tYXgoYSwgTWF0aC5taW4oYiwgeCkpOwogIH07Cn0KZnVuY3Rpb24gYmltYXAoZG9tYWluLCByYW5nZSwgaW50ZXJwb2xhdGUpIHsKICB2YXIgZDAgPSBkb21haW5bMF0sIGQxID0gZG9tYWluWzFdLCByMCA9IHJhbmdlWzBdLCByMSA9IHJhbmdlWzFdOwogIGlmIChkMSA8IGQwKSBkMCA9IG5vcm1hbGl6ZShkMSwgZDApLCByMCA9IGludGVycG9sYXRlKHIxLCByMCk7CiAgZWxzZSBkMCA9IG5vcm1hbGl6ZShkMCwgZDEpLCByMCA9IGludGVycG9sYXRlKHIwLCByMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKHgpIHsKICAgIHJldHVybiByMChkMCh4KSk7CiAgfTsKfQpmdW5jdGlvbiBwb2x5bWFwKGRvbWFpbiwgcmFuZ2UsIGludGVycG9sYXRlKSB7CiAgdmFyIGogPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZS5sZW5ndGgpIC0gMSwgZCA9IG5ldyBBcnJheShqKSwgciA9IG5ldyBBcnJheShqKSwgaSA9IC0xOwogIGlmIChkb21haW5bal0gPCBkb21haW5bMF0pIHsKICAgIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpLnJldmVyc2UoKTsKICAgIHJhbmdlID0gcmFuZ2Uuc2xpY2UoKS5yZXZlcnNlKCk7CiAgfQogIHdoaWxlICgrK2kgPCBqKSB7CiAgICBkW2ldID0gbm9ybWFsaXplKGRvbWFpbltpXSwgZG9tYWluW2kgKyAxXSk7CiAgICByW2ldID0gaW50ZXJwb2xhdGUocmFuZ2VbaV0sIHJhbmdlW2kgKyAxXSk7CiAgfQogIHJldHVybiBmdW5jdGlvbih4KSB7CiAgICB2YXIgaTIgPSBiaXNlY3RfZGVmYXVsdChkb21haW4sIHgsIDEsIGopIC0gMTsKICAgIHJldHVybiByW2kyXShkW2kyXSh4KSk7CiAgfTsKfQpmdW5jdGlvbiBjb3B5KHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5yYW5nZShzb3VyY2UucmFuZ2UoKSkuaW50ZXJwb2xhdGUoc291cmNlLmludGVycG9sYXRlKCkpLmNsYW1wKHNvdXJjZS5jbGFtcCgpKS51bmtub3duKHNvdXJjZS51bmtub3duKCkpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybWVyKCkgewogIHZhciBkb21haW4gPSB1bml0LCByYW5nZSA9IHVuaXQsIGludGVycG9sYXRlID0gdmFsdWVfZGVmYXVsdCwgdHJhbnNmb3JtLCB1bnRyYW5zZm9ybSwgdW5rbm93biwgY2xhbXAgPSBpZGVudGl0eTIsIHBpZWNld2lzZSwgb3V0cHV0LCBpbnB1dDsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZS5sZW5ndGgpOwogICAgaWYgKGNsYW1wICE9PSBpZGVudGl0eTIpIGNsYW1wID0gY2xhbXBlcihkb21haW5bMF0sIGRvbWFpbltuIC0gMV0pOwogICAgcGllY2V3aXNlID0gbiA+IDIgPyBwb2x5bWFwIDogYmltYXA7CiAgICBvdXRwdXQgPSBpbnB1dCA9IG51bGw7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIGZ1bmN0aW9uIHNjYWxlKHgpIHsKICAgIHJldHVybiB4ID09IG51bGwgfHwgaXNOYU4oeCA9ICt4KSA/IHVua25vd24gOiAob3V0cHV0IHx8IChvdXRwdXQgPSBwaWVjZXdpc2UoZG9tYWluLm1hcCh0cmFuc2Zvcm0pLCByYW5nZSwgaW50ZXJwb2xhdGUpKSkodHJhbnNmb3JtKGNsYW1wKHgpKSk7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkpIHsKICAgIHJldHVybiBjbGFtcCh1bnRyYW5zZm9ybSgoaW5wdXQgfHwgKGlucHV0ID0gcGllY2V3aXNlKHJhbmdlLCBkb21haW4ubWFwKHRyYW5zZm9ybSksIG51bWJlcl9kZWZhdWx0KSkpKHkpKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8sIG51bWJlcjMpLCByZXNjYWxlKCkpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlID0gQXJyYXkuZnJvbShfKSwgcmVzY2FsZSgpKSA6IHJhbmdlLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHJhbmdlID0gQXJyYXkuZnJvbShfKSwgaW50ZXJwb2xhdGUgPSByb3VuZF9kZWZhdWx0LCByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gXyA/IHRydWUgOiBpZGVudGl0eTIsIHJlc2NhbGUoKSkgOiBjbGFtcCAhPT0gaWRlbnRpdHkyOwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdGUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0ZSA9IF8sIHJlc2NhbGUoKSkgOiBpbnRlcnBvbGF0ZTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0LCB1KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB1bnRyYW5zZm9ybSA9IHU7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07Cn0KZnVuY3Rpb24gY29udGludW91cygpIHsKICByZXR1cm4gdHJhbnNmb3JtZXIoKShpZGVudGl0eTIsIGlkZW50aXR5Mik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGlja0Zvcm1hdC5qcwpmdW5jdGlvbiB0aWNrRm9ybWF0KHN0YXJ0LCBzdG9wLCBjb3VudDIsIHNwZWNpZmllcikgewogIHZhciBzdGVwID0gdGlja1N0ZXAoc3RhcnQsIHN0b3AsIGNvdW50MiksIHByZWNpc2lvbjsKICBzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyID09IG51bGwgPyAiLGYiIDogc3BlY2lmaWVyKTsKICBzd2l0Y2ggKHNwZWNpZmllci50eXBlKSB7CiAgICBjYXNlICJzIjogewogICAgICB2YXIgdmFsdWUgPSBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKTsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uUHJlZml4X2RlZmF1bHQoc3RlcCwgdmFsdWUpKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbjsKICAgICAgcmV0dXJuIGZvcm1hdFByZWZpeChzcGVjaWZpZXIsIHZhbHVlKTsKICAgIH0KICAgIGNhc2UgIiI6CiAgICBjYXNlICJlIjoKICAgIGNhc2UgImciOgogICAgY2FzZSAicCI6CiAgICBjYXNlICJyIjogewogICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25Sb3VuZF9kZWZhdWx0KHN0ZXAsIE1hdGgubWF4KE1hdGguYWJzKHN0YXJ0KSwgTWF0aC5hYnMoc3RvcCkpKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb24gLSAoc3BlY2lmaWVyLnR5cGUgPT09ICJlIik7CiAgICAgIGJyZWFrOwogICAgfQogICAgY2FzZSAiZiI6CiAgICBjYXNlICIlIjogewogICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25GaXhlZF9kZWZhdWx0KHN0ZXApKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbiAtIChzcGVjaWZpZXIudHlwZSA9PT0gIiUiKSAqIDI7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gZm9ybWF0KHNwZWNpZmllcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbGluZWFyLmpzCmZ1bmN0aW9uIGxpbmVhcmlzaChzY2FsZSkgewogIHZhciBkb21haW4gPSBzY2FsZS5kb21haW47CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihjb3VudDIpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja3MoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBjb3VudDIgPT0gbnVsbCA/IDEwIDogY291bnQyKTsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSBmdW5jdGlvbihjb3VudDIsIHNwZWNpZmllcikgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrRm9ybWF0KGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgY291bnQyID09IG51bGwgPyAxMCA6IGNvdW50Miwgc3BlY2lmaWVyKTsKICB9OwogIHNjYWxlLm5pY2UgPSBmdW5jdGlvbihjb3VudDIpIHsKICAgIGlmIChjb3VudDIgPT0gbnVsbCkgY291bnQyID0gMTA7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgdmFyIGkwID0gMDsKICAgIHZhciBpMSA9IGQubGVuZ3RoIC0gMTsKICAgIHZhciBzdGFydCA9IGRbaTBdOwogICAgdmFyIHN0b3AgPSBkW2kxXTsKICAgIHZhciBwcmVzdGVwOwogICAgdmFyIHN0ZXA7CiAgICB2YXIgbWF4SXRlciA9IDEwOwogICAgaWYgKHN0b3AgPCBzdGFydCkgewogICAgICBzdGVwID0gc3RhcnQsIHN0YXJ0ID0gc3RvcCwgc3RvcCA9IHN0ZXA7CiAgICAgIHN0ZXAgPSBpMCwgaTAgPSBpMSwgaTEgPSBzdGVwOwogICAgfQogICAgd2hpbGUgKG1heEl0ZXItLSA+IDApIHsKICAgICAgc3RlcCA9IHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50Mik7CiAgICAgIGlmIChzdGVwID09PSBwcmVzdGVwKSB7CiAgICAgICAgZFtpMF0gPSBzdGFydDsKICAgICAgICBkW2kxXSA9IHN0b3A7CiAgICAgICAgcmV0dXJuIGRvbWFpbihkKTsKICAgICAgfSBlbHNlIGlmIChzdGVwID4gMCkgewogICAgICAgIHN0YXJ0ID0gTWF0aC5mbG9vcihzdGFydCAvIHN0ZXApICogc3RlcDsKICAgICAgICBzdG9wID0gTWF0aC5jZWlsKHN0b3AgLyBzdGVwKSAqIHN0ZXA7CiAgICAgIH0gZWxzZSBpZiAoc3RlcCA8IDApIHsKICAgICAgICBzdGFydCA9IE1hdGguY2VpbChzdGFydCAqIHN0ZXApIC8gc3RlcDsKICAgICAgICBzdG9wID0gTWF0aC5mbG9vcihzdG9wICogc3RlcCkgLyBzdGVwOwogICAgICB9IGVsc2UgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHByZXN0ZXAgPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIGxpbmVhcjMoKSB7CiAgdmFyIHNjYWxlID0gY29udGludW91cygpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBsaW5lYXIzKCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL25pY2UuanMKZnVuY3Rpb24gbmljZShkb21haW4sIGludGVydmFsMikgewogIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpOwogIHZhciBpMCA9IDAsIGkxID0gZG9tYWluLmxlbmd0aCAtIDEsIHgwID0gZG9tYWluW2kwXSwgeDEgPSBkb21haW5baTFdLCB0OwogIGlmICh4MSA8IHgwKSB7CiAgICB0ID0gaTAsIGkwID0gaTEsIGkxID0gdDsKICAgIHQgPSB4MCwgeDAgPSB4MSwgeDEgPSB0OwogIH0KICBkb21haW5baTBdID0gaW50ZXJ2YWwyLmZsb29yKHgwKTsKICBkb21haW5baTFdID0gaW50ZXJ2YWwyLmNlaWwoeDEpOwogIHJldHVybiBkb21haW47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbG9nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybUxvZyh4KSB7CiAgcmV0dXJuIE1hdGgubG9nKHgpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cCh4KSB7CiAgcmV0dXJuIE1hdGguZXhwKHgpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUxvZ24oeCkgewogIHJldHVybiAtTWF0aC5sb2coLXgpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cG4oeCkgewogIHJldHVybiAtTWF0aC5leHAoLXgpOwp9CmZ1bmN0aW9uIHBvdzEwKHgpIHsKICByZXR1cm4gaXNGaW5pdGUoeCkgPyArKCIxZSIgKyB4KSA6IHggPCAwID8gMCA6IHg7Cn0KZnVuY3Rpb24gcG93cChiYXNlKSB7CiAgcmV0dXJuIGJhc2UgPT09IDEwID8gcG93MTAgOiBiYXNlID09PSBNYXRoLkUgPyBNYXRoLmV4cCA6ICh4KSA9PiBNYXRoLnBvdyhiYXNlLCB4KTsKfQpmdW5jdGlvbiBsb2dwKGJhc2UpIHsKICByZXR1cm4gYmFzZSA9PT0gTWF0aC5FID8gTWF0aC5sb2cgOiBiYXNlID09PSAxMCAmJiBNYXRoLmxvZzEwIHx8IGJhc2UgPT09IDIgJiYgTWF0aC5sb2cyIHx8IChiYXNlID0gTWF0aC5sb2coYmFzZSksICh4KSA9PiBNYXRoLmxvZyh4KSAvIGJhc2UpOwp9CmZ1bmN0aW9uIHJlZmxlY3QoZikgewogIHJldHVybiAoeCwgaykgPT4gLWYoLXgsIGspOwp9CmZ1bmN0aW9uIGxvZ2dpc2godHJhbnNmb3JtKSB7CiAgY29uc3Qgc2NhbGUgPSB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogIGNvbnN0IGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBsZXQgYmFzZSA9IDEwOwogIGxldCBsb2dzOwogIGxldCBwb3dzOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICBsb2dzID0gbG9ncChiYXNlKSwgcG93cyA9IHBvd3AoYmFzZSk7CiAgICBpZiAoZG9tYWluKClbMF0gPCAwKSB7CiAgICAgIGxvZ3MgPSByZWZsZWN0KGxvZ3MpLCBwb3dzID0gcmVmbGVjdChwb3dzKTsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZ24sIHRyYW5zZm9ybUV4cG4pOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZywgdHJhbnNmb3JtRXhwKTsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9CiAgc2NhbGUuYmFzZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGJhc2UgPSArXywgcmVzY2FsZSgpKSA6IGJhc2U7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4oXyksIHJlc2NhbGUoKSkgOiBkb21haW4oKTsKICB9OwogIHNjYWxlLnRpY2tzID0gKGNvdW50MikgPT4gewogICAgY29uc3QgZCA9IGRvbWFpbigpOwogICAgbGV0IHUgPSBkWzBdOwogICAgbGV0IHYgPSBkW2QubGVuZ3RoIC0gMV07CiAgICBjb25zdCByID0gdiA8IHU7CiAgICBpZiAocikgW3UsIHZdID0gW3YsIHVdOwogICAgbGV0IGkgPSBsb2dzKHUpOwogICAgbGV0IGogPSBsb2dzKHYpOwogICAgbGV0IGs7CiAgICBsZXQgdDsKICAgIGNvbnN0IG4gPSBjb3VudDIgPT0gbnVsbCA/IDEwIDogK2NvdW50MjsKICAgIGxldCB6ID0gW107CiAgICBpZiAoIShiYXNlICUgMSkgJiYgaiAtIGkgPCBuKSB7CiAgICAgIGkgPSBNYXRoLmZsb29yKGkpLCBqID0gTWF0aC5jZWlsKGopOwogICAgICBpZiAodSA+IDApIGZvciAoOyBpIDw9IGo7ICsraSkgewogICAgICAgIGZvciAoayA9IDE7IGsgPCBiYXNlOyArK2spIHsKICAgICAgICAgIHQgPSBpIDwgMCA/IGsgLyBwb3dzKC1pKSA6IGsgKiBwb3dzKGkpOwogICAgICAgICAgaWYgKHQgPCB1KSBjb250aW51ZTsKICAgICAgICAgIGlmICh0ID4gdikgYnJlYWs7CiAgICAgICAgICB6LnB1c2godCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgZm9yICg7IGkgPD0gajsgKytpKSB7CiAgICAgICAgZm9yIChrID0gYmFzZSAtIDE7IGsgPj0gMTsgLS1rKSB7CiAgICAgICAgICB0ID0gaSA+IDAgPyBrIC8gcG93cygtaSkgOiBrICogcG93cyhpKTsKICAgICAgICAgIGlmICh0IDwgdSkgY29udGludWU7CiAgICAgICAgICBpZiAodCA+IHYpIGJyZWFrOwogICAgICAgICAgei5wdXNoKHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoei5sZW5ndGggKiAyIDwgbikgeiA9IHRpY2tzKHUsIHYsIG4pOwogICAgfSBlbHNlIHsKICAgICAgeiA9IHRpY2tzKGksIGosIE1hdGgubWluKGogLSBpLCBuKSkubWFwKHBvd3MpOwogICAgfQogICAgcmV0dXJuIHIgPyB6LnJldmVyc2UoKSA6IHo7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gKGNvdW50Miwgc3BlY2lmaWVyKSA9PiB7CiAgICBpZiAoY291bnQyID09IG51bGwpIGNvdW50MiA9IDEwOwogICAgaWYgKHNwZWNpZmllciA9PSBudWxsKSBzcGVjaWZpZXIgPSBiYXNlID09PSAxMCA/ICJzIiA6ICIsIjsKICAgIGlmICh0eXBlb2Ygc3BlY2lmaWVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICghKGJhc2UgJSAxKSAmJiAoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikpLnByZWNpc2lvbiA9PSBudWxsKSBzcGVjaWZpZXIudHJpbSA9IHRydWU7CiAgICAgIHNwZWNpZmllciA9IGZvcm1hdChzcGVjaWZpZXIpOwogICAgfQogICAgaWYgKGNvdW50MiA9PT0gSW5maW5pdHkpIHJldHVybiBzcGVjaWZpZXI7CiAgICBjb25zdCBrID0gTWF0aC5tYXgoMSwgYmFzZSAqIGNvdW50MiAvIHNjYWxlLnRpY2tzKCkubGVuZ3RoKTsKICAgIHJldHVybiAoZCkgPT4gewogICAgICBsZXQgaSA9IGQgLyBwb3dzKE1hdGgucm91bmQobG9ncyhkKSkpOwogICAgICBpZiAoaSAqIGJhc2UgPCBiYXNlIC0gMC41KSBpICo9IGJhc2U7CiAgICAgIHJldHVybiBpIDw9IGsgPyBzcGVjaWZpZXIoZCkgOiAiIjsKICAgIH07CiAgfTsKICBzY2FsZS5uaWNlID0gKCkgPT4gewogICAgcmV0dXJuIGRvbWFpbihuaWNlKGRvbWFpbigpLCB7CiAgICAgIGZsb29yOiAoeCkgPT4gcG93cyhNYXRoLmZsb29yKGxvZ3MoeCkpKSwKICAgICAgY2VpbDogKHgpID0+IHBvd3MoTWF0aC5jZWlsKGxvZ3MoeCkpKQogICAgfSkpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIGxvZygpIHsKICBjb25zdCBzY2FsZSA9IGxvZ2dpc2godHJhbnNmb3JtZXIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSAoKSA9PiBjb3B5KHNjYWxlLCBsb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcG93LmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVBvdyhleHBvbmVudCkgewogIHJldHVybiBmdW5jdGlvbih4KSB7CiAgICByZXR1cm4geCA8IDAgPyAtTWF0aC5wb3coLXgsIGV4cG9uZW50KSA6IE1hdGgucG93KHgsIGV4cG9uZW50KTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVNxcnQoeCkgewogIHJldHVybiB4IDwgMCA/IC1NYXRoLnNxcnQoLXgpIDogTWF0aC5zcXJ0KHgpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybVNxdWFyZSh4KSB7CiAgcmV0dXJuIHggPCAwID8gLXggKiB4IDogeCAqIHg7Cn0KZnVuY3Rpb24gcG93aXNoKHRyYW5zZm9ybSkgewogIHZhciBzY2FsZSA9IHRyYW5zZm9ybShpZGVudGl0eTIsIGlkZW50aXR5MiksIGV4cG9uZW50ID0gMTsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgcmV0dXJuIGV4cG9uZW50ID09PSAxID8gdHJhbnNmb3JtKGlkZW50aXR5MiwgaWRlbnRpdHkyKSA6IGV4cG9uZW50ID09PSAwLjUgPyB0cmFuc2Zvcm0odHJhbnNmb3JtU3FydCwgdHJhbnNmb3JtU3F1YXJlKSA6IHRyYW5zZm9ybSh0cmFuc2Zvcm1Qb3coZXhwb25lbnQpLCB0cmFuc2Zvcm1Qb3coMSAvIGV4cG9uZW50KSk7CiAgfQogIHNjYWxlLmV4cG9uZW50ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZXhwb25lbnQgPSArXywgcmVzY2FsZSgpKSA6IGV4cG9uZW50OwogIH07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KZnVuY3Rpb24gcG93KCkgewogIHZhciBzY2FsZSA9IHBvd2lzaCh0cmFuc2Zvcm1lcigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgcG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2ludGVydmFsLmpzCnZhciB0MCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwp2YXIgdDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKZnVuY3Rpb24gdGltZUludGVydmFsKGZsb29yaSwgb2Zmc2V0aSwgY291bnQyLCBmaWVsZDIpIHsKICBmdW5jdGlvbiBpbnRlcnZhbDIoZGF0ZTMpIHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTMgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwID8gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkgOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUzKSksIGRhdGUzOwogIH0KICBpbnRlcnZhbDIuZmxvb3IgPSAoZGF0ZTMpID0+IHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTMgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUzKSksIGRhdGUzOwogIH07CiAgaW50ZXJ2YWwyLmNlaWwgPSAoZGF0ZTMpID0+IHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTMgPSBuZXcgRGF0ZShkYXRlMyAtIDEpKSwgb2Zmc2V0aShkYXRlMywgMSksIGZsb29yaShkYXRlMyksIGRhdGUzOwogIH07CiAgaW50ZXJ2YWwyLnJvdW5kID0gKGRhdGUzKSA9PiB7CiAgICBjb25zdCBkMCA9IGludGVydmFsMihkYXRlMyksIGQxID0gaW50ZXJ2YWwyLmNlaWwoZGF0ZTMpOwogICAgcmV0dXJuIGRhdGUzIC0gZDAgPCBkMSAtIGRhdGUzID8gZDAgOiBkMTsKICB9OwogIGludGVydmFsMi5vZmZzZXQgPSAoZGF0ZTMsIHN0ZXApID0+IHsKICAgIHJldHVybiBvZmZzZXRpKGRhdGUzID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMyksIHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApKSwgZGF0ZTM7CiAgfTsKICBpbnRlcnZhbDIucmFuZ2UgPSAoc3RhcnQsIHN0b3AsIHN0ZXApID0+IHsKICAgIGNvbnN0IHJhbmdlID0gW107CiAgICBzdGFydCA9IGludGVydmFsMi5jZWlsKHN0YXJ0KTsKICAgIHN0ZXAgPSBzdGVwID09IG51bGwgPyAxIDogTWF0aC5mbG9vcihzdGVwKTsKICAgIGlmICghKHN0YXJ0IDwgc3RvcCkgfHwgIShzdGVwID4gMCkpIHJldHVybiByYW5nZTsKICAgIGxldCBwcmV2aW91czsKICAgIGRvCiAgICAgIHJhbmdlLnB1c2gocHJldmlvdXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK3N0YXJ0KSksIG9mZnNldGkoc3RhcnQsIHN0ZXApLCBmbG9vcmkoc3RhcnQpOwogICAgd2hpbGUgKHByZXZpb3VzIDwgc3RhcnQgJiYgc3RhcnQgPCBzdG9wKTsKICAgIHJldHVybiByYW5nZTsKICB9OwogIGludGVydmFsMi5maWx0ZXIgPSAodGVzdCkgPT4gewogICAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICAgICAgaWYgKGRhdGUzID49IGRhdGUzKSB3aGlsZSAoZmxvb3JpKGRhdGUzKSwgIXRlc3QoZGF0ZTMpKSBkYXRlMy5zZXRUaW1lKGRhdGUzIC0gMSk7CiAgICB9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICAgICAgaWYgKGRhdGUzID49IGRhdGUzKSB7CiAgICAgICAgaWYgKHN0ZXAgPCAwKSB3aGlsZSAoKytzdGVwIDw9IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUzLCAtMSksICF0ZXN0KGRhdGUzKSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHdoaWxlICgtLXN0ZXAgPj0gMCkgewogICAgICAgICAgd2hpbGUgKG9mZnNldGkoZGF0ZTMsIDEpLCAhdGVzdChkYXRlMykpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CiAgaWYgKGNvdW50MikgewogICAgaW50ZXJ2YWwyLmNvdW50ID0gKHN0YXJ0LCBlbmQpID0+IHsKICAgICAgdDAuc2V0VGltZSgrc3RhcnQpLCB0MS5zZXRUaW1lKCtlbmQpOwogICAgICBmbG9vcmkodDApLCBmbG9vcmkodDEpOwogICAgICByZXR1cm4gTWF0aC5mbG9vcihjb3VudDIodDAsIHQxKSk7CiAgICB9OwogICAgaW50ZXJ2YWwyLmV2ZXJ5ID0gKHN0ZXApID0+IHsKICAgICAgc3RlcCA9IE1hdGguZmxvb3Ioc3RlcCk7CiAgICAgIHJldHVybiAhaXNGaW5pdGUoc3RlcCkgfHwgIShzdGVwID4gMCkgPyBudWxsIDogIShzdGVwID4gMSkgPyBpbnRlcnZhbDIgOiBpbnRlcnZhbDIuZmlsdGVyKGZpZWxkMiA/IChkKSA9PiBmaWVsZDIoZCkgJSBzdGVwID09PSAwIDogKGQpID0+IGludGVydmFsMi5jb3VudCgwLCBkKSAlIHN0ZXAgPT09IDApOwogICAgfTsKICB9CiAgcmV0dXJuIGludGVydmFsMjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbGxpc2Vjb25kLmpzCnZhciBtaWxsaXNlY29uZCA9IHRpbWVJbnRlcnZhbCgoKSA9PiB7Cn0sIChkYXRlMywgc3RlcCkgPT4gewogIGRhdGUzLnNldFRpbWUoK2RhdGUzICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZCAtIHN0YXJ0Owp9KTsKbWlsbGlzZWNvbmQuZXZlcnkgPSAoaykgPT4gewogIGsgPSBNYXRoLmZsb29yKGspOwogIGlmICghaXNGaW5pdGUoaykgfHwgIShrID4gMCkpIHJldHVybiBudWxsOwogIGlmICghKGsgPiAxKSkgcmV0dXJuIG1pbGxpc2Vjb25kOwogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUzKSA9PiB7CiAgICBkYXRlMy5zZXRUaW1lKE1hdGguZmxvb3IoZGF0ZTMgLyBrKSAqIGspOwogIH0sIChkYXRlMywgc3RlcCkgPT4gewogICAgZGF0ZTMuc2V0VGltZSgrZGF0ZTMgKyBzdGVwICogayk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gazsKICB9KTsKfTsKdmFyIG1pbGxpc2Vjb25kcyA9IG1pbGxpc2Vjb25kLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2R1cmF0aW9uLmpzCnZhciBkdXJhdGlvblNlY29uZCA9IDFlMzsKdmFyIGR1cmF0aW9uTWludXRlID0gZHVyYXRpb25TZWNvbmQgKiA2MDsKdmFyIGR1cmF0aW9uSG91ciA9IGR1cmF0aW9uTWludXRlICogNjA7CnZhciBkdXJhdGlvbkRheSA9IGR1cmF0aW9uSG91ciAqIDI0Owp2YXIgZHVyYXRpb25XZWVrID0gZHVyYXRpb25EYXkgKiA3Owp2YXIgZHVyYXRpb25Nb250aCA9IGR1cmF0aW9uRGF5ICogMzA7CnZhciBkdXJhdGlvblllYXIgPSBkdXJhdGlvbkRheSAqIDM2NTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9zZWNvbmQuanMKdmFyIHNlY29uZCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXRUaW1lKGRhdGUzIC0gZGF0ZTMuZ2V0TWlsbGlzZWNvbmRzKCkpOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRUaW1lKCtkYXRlMyArIHN0ZXAgKiBkdXJhdGlvblNlY29uZCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvblNlY29uZDsKfSwgKGRhdGUzKSA9PiB7CiAgcmV0dXJuIGRhdGUzLmdldFVUQ1NlY29uZHMoKTsKfSk7CnZhciBzZWNvbmRzID0gc2Vjb25kLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbnV0ZS5qcwp2YXIgdGltZU1pbnV0ZSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXRUaW1lKGRhdGUzIC0gZGF0ZTMuZ2V0TWlsbGlzZWNvbmRzKCkgLSBkYXRlMy5nZXRTZWNvbmRzKCkgKiBkdXJhdGlvblNlY29uZCk7Cn0sIChkYXRlMywgc3RlcCkgPT4gewogIGRhdGUzLnNldFRpbWUoK2RhdGUzICsgc3RlcCAqIGR1cmF0aW9uTWludXRlKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uTWludXRlOwp9LCAoZGF0ZTMpID0+IHsKICByZXR1cm4gZGF0ZTMuZ2V0TWludXRlcygpOwp9KTsKdmFyIHRpbWVNaW51dGVzID0gdGltZU1pbnV0ZS5yYW5nZTsKdmFyIHV0Y01pbnV0ZSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXRVVENTZWNvbmRzKDAsIDApOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRUaW1lKCtkYXRlMyArIHN0ZXAgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbk1pbnV0ZTsKfSwgKGRhdGUzKSA9PiB7CiAgcmV0dXJuIGRhdGUzLmdldFVUQ01pbnV0ZXMoKTsKfSk7CnZhciB1dGNNaW51dGVzID0gdXRjTWludXRlLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2hvdXIuanMKdmFyIHRpbWVIb3VyID0gdGltZUludGVydmFsKChkYXRlMykgPT4gewogIGRhdGUzLnNldFRpbWUoZGF0ZTMgLSBkYXRlMy5nZXRNaWxsaXNlY29uZHMoKSAtIGRhdGUzLmdldFNlY29uZHMoKSAqIGR1cmF0aW9uU2Vjb25kIC0gZGF0ZTMuZ2V0TWludXRlcygpICogZHVyYXRpb25NaW51dGUpOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRUaW1lKCtkYXRlMyArIHN0ZXAgKiBkdXJhdGlvbkhvdXIpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25Ib3VyOwp9LCAoZGF0ZTMpID0+IHsKICByZXR1cm4gZGF0ZTMuZ2V0SG91cnMoKTsKfSk7CnZhciB0aW1lSG91cnMgPSB0aW1lSG91ci5yYW5nZTsKdmFyIHV0Y0hvdXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUzKSA9PiB7CiAgZGF0ZTMuc2V0VVRDTWludXRlcygwLCAwLCAwKTsKfSwgKGRhdGUzLCBzdGVwKSA9PiB7CiAgZGF0ZTMuc2V0VGltZSgrZGF0ZTMgKyBzdGVwICogZHVyYXRpb25Ib3VyKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uSG91cjsKfSwgKGRhdGUzKSA9PiB7CiAgcmV0dXJuIGRhdGUzLmdldFVUQ0hvdXJzKCk7Cn0pOwp2YXIgdXRjSG91cnMgPSB1dGNIb3VyLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2RheS5qcwp2YXIgdGltZURheSA9IHRpbWVJbnRlcnZhbCgKICAoZGF0ZTMpID0+IGRhdGUzLnNldEhvdXJzKDAsIDAsIDAsIDApLAogIChkYXRlMywgc3RlcCkgPT4gZGF0ZTMuc2V0RGF0ZShkYXRlMy5nZXREYXRlKCkgKyBzdGVwKSwKICAoc3RhcnQsIGVuZCkgPT4gKGVuZCAtIHN0YXJ0IC0gKGVuZC5nZXRUaW1lem9uZU9mZnNldCgpIC0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiBkdXJhdGlvbk1pbnV0ZSkgLyBkdXJhdGlvbkRheSwKICAoZGF0ZTMpID0+IGRhdGUzLmdldERhdGUoKSAtIDEKKTsKdmFyIHRpbWVEYXlzID0gdGltZURheS5yYW5nZTsKdmFyIHV0Y0RheSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUzLCBzdGVwKSA9PiB7CiAgZGF0ZTMuc2V0VVRDRGF0ZShkYXRlMy5nZXRVVENEYXRlKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uRGF5Owp9LCAoZGF0ZTMpID0+IHsKICByZXR1cm4gZGF0ZTMuZ2V0VVRDRGF0ZSgpIC0gMTsKfSk7CnZhciB1dGNEYXlzID0gdXRjRGF5LnJhbmdlOwp2YXIgdW5peERheSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUzLCBzdGVwKSA9PiB7CiAgZGF0ZTMuc2V0VVRDRGF0ZShkYXRlMy5nZXRVVENEYXRlKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uRGF5Owp9LCAoZGF0ZTMpID0+IHsKICByZXR1cm4gTWF0aC5mbG9vcihkYXRlMyAvIGR1cmF0aW9uRGF5KTsKfSk7CnZhciB1bml4RGF5cyA9IHVuaXhEYXkucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvd2Vlay5qcwpmdW5jdGlvbiB0aW1lV2Vla2RheShpKSB7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICAgIGRhdGUzLnNldERhdGUoZGF0ZTMuZ2V0RGF0ZSgpIC0gKGRhdGUzLmdldERheSgpICsgNyAtIGkpICUgNyk7CiAgICBkYXRlMy5zZXRIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICAgIGRhdGUzLnNldERhdGUoZGF0ZTMuZ2V0RGF0ZSgpICsgc3RlcCAqIDcpOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0IC0gKGVuZC5nZXRUaW1lem9uZU9mZnNldCgpIC0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiBkdXJhdGlvbk1pbnV0ZSkgLyBkdXJhdGlvbldlZWs7CiAgfSk7Cn0KdmFyIHRpbWVTdW5kYXkgPSB0aW1lV2Vla2RheSgwKTsKdmFyIHRpbWVNb25kYXkgPSB0aW1lV2Vla2RheSgxKTsKdmFyIHRpbWVUdWVzZGF5ID0gdGltZVdlZWtkYXkoMik7CnZhciB0aW1lV2VkbmVzZGF5ID0gdGltZVdlZWtkYXkoMyk7CnZhciB0aW1lVGh1cnNkYXkgPSB0aW1lV2Vla2RheSg0KTsKdmFyIHRpbWVGcmlkYXkgPSB0aW1lV2Vla2RheSg1KTsKdmFyIHRpbWVTYXR1cmRheSA9IHRpbWVXZWVrZGF5KDYpOwp2YXIgdGltZVN1bmRheXMgPSB0aW1lU3VuZGF5LnJhbmdlOwp2YXIgdGltZU1vbmRheXMgPSB0aW1lTW9uZGF5LnJhbmdlOwp2YXIgdGltZVR1ZXNkYXlzID0gdGltZVR1ZXNkYXkucmFuZ2U7CnZhciB0aW1lV2VkbmVzZGF5cyA9IHRpbWVXZWRuZXNkYXkucmFuZ2U7CnZhciB0aW1lVGh1cnNkYXlzID0gdGltZVRodXJzZGF5LnJhbmdlOwp2YXIgdGltZUZyaWRheXMgPSB0aW1lRnJpZGF5LnJhbmdlOwp2YXIgdGltZVNhdHVyZGF5cyA9IHRpbWVTYXR1cmRheS5yYW5nZTsKZnVuY3Rpb24gdXRjV2Vla2RheShpKSB7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICAgIGRhdGUzLnNldFVUQ0RhdGUoZGF0ZTMuZ2V0VVRDRGF0ZSgpIC0gKGRhdGUzLmdldFVUQ0RheSgpICsgNyAtIGkpICUgNyk7CiAgICBkYXRlMy5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICAgIGRhdGUzLnNldFVUQ0RhdGUoZGF0ZTMuZ2V0VVRDRGF0ZSgpICsgc3RlcCAqIDcpOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uV2VlazsKICB9KTsKfQp2YXIgdXRjU3VuZGF5ID0gdXRjV2Vla2RheSgwKTsKdmFyIHV0Y01vbmRheSA9IHV0Y1dlZWtkYXkoMSk7CnZhciB1dGNUdWVzZGF5ID0gdXRjV2Vla2RheSgyKTsKdmFyIHV0Y1dlZG5lc2RheSA9IHV0Y1dlZWtkYXkoMyk7CnZhciB1dGNUaHVyc2RheSA9IHV0Y1dlZWtkYXkoNCk7CnZhciB1dGNGcmlkYXkgPSB1dGNXZWVrZGF5KDUpOwp2YXIgdXRjU2F0dXJkYXkgPSB1dGNXZWVrZGF5KDYpOwp2YXIgdXRjU3VuZGF5cyA9IHV0Y1N1bmRheS5yYW5nZTsKdmFyIHV0Y01vbmRheXMgPSB1dGNNb25kYXkucmFuZ2U7CnZhciB1dGNUdWVzZGF5cyA9IHV0Y1R1ZXNkYXkucmFuZ2U7CnZhciB1dGNXZWRuZXNkYXlzID0gdXRjV2VkbmVzZGF5LnJhbmdlOwp2YXIgdXRjVGh1cnNkYXlzID0gdXRjVGh1cnNkYXkucmFuZ2U7CnZhciB1dGNGcmlkYXlzID0gdXRjRnJpZGF5LnJhbmdlOwp2YXIgdXRjU2F0dXJkYXlzID0gdXRjU2F0dXJkYXkucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbW9udGguanMKdmFyIHRpbWVNb250aCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXREYXRlKDEpOwogIGRhdGUzLnNldEhvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRNb250aChkYXRlMy5nZXRNb250aCgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRNb250aCgpIC0gc3RhcnQuZ2V0TW9udGgoKSArIChlbmQuZ2V0RnVsbFllYXIoKSAtIHN0YXJ0LmdldEZ1bGxZZWFyKCkpICogMTI7Cn0sIChkYXRlMykgPT4gewogIHJldHVybiBkYXRlMy5nZXRNb250aCgpOwp9KTsKdmFyIHRpbWVNb250aHMgPSB0aW1lTW9udGgucmFuZ2U7CnZhciB1dGNNb250aCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTMpID0+IHsKICBkYXRlMy5zZXRVVENEYXRlKDEpOwogIGRhdGUzLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRVVENNb250aChkYXRlMy5nZXRVVENNb250aCgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRVVENNb250aCgpIC0gc3RhcnQuZ2V0VVRDTW9udGgoKSArIChlbmQuZ2V0VVRDRnVsbFllYXIoKSAtIHN0YXJ0LmdldFVUQ0Z1bGxZZWFyKCkpICogMTI7Cn0sIChkYXRlMykgPT4gewogIHJldHVybiBkYXRlMy5nZXRVVENNb250aCgpOwp9KTsKdmFyIHV0Y01vbnRocyA9IHV0Y01vbnRoLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3llYXIuanMKdmFyIHRpbWVZZWFyID0gdGltZUludGVydmFsKChkYXRlMykgPT4gewogIGRhdGUzLnNldE1vbnRoKDAsIDEpOwogIGRhdGUzLnNldEhvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRGdWxsWWVhcihkYXRlMy5nZXRGdWxsWWVhcigpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRGdWxsWWVhcigpIC0gc3RhcnQuZ2V0RnVsbFllYXIoKTsKfSwgKGRhdGUzKSA9PiB7CiAgcmV0dXJuIGRhdGUzLmdldEZ1bGxZZWFyKCk7Cn0pOwp0aW1lWWVhci5ldmVyeSA9IChrKSA9PiB7CiAgcmV0dXJuICFpc0Zpbml0ZShrID0gTWF0aC5mbG9vcihrKSkgfHwgIShrID4gMCkgPyBudWxsIDogdGltZUludGVydmFsKChkYXRlMykgPT4gewogICAgZGF0ZTMuc2V0RnVsbFllYXIoTWF0aC5mbG9vcihkYXRlMy5nZXRGdWxsWWVhcigpIC8gaykgKiBrKTsKICAgIGRhdGUzLnNldE1vbnRoKDAsIDEpOwogICAgZGF0ZTMuc2V0SG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUzLCBzdGVwKSA9PiB7CiAgICBkYXRlMy5zZXRGdWxsWWVhcihkYXRlMy5nZXRGdWxsWWVhcigpICsgc3RlcCAqIGspOwogIH0pOwp9Owp2YXIgdGltZVllYXJzID0gdGltZVllYXIucmFuZ2U7CnZhciB1dGNZZWFyID0gdGltZUludGVydmFsKChkYXRlMykgPT4gewogIGRhdGUzLnNldFVUQ01vbnRoKDAsIDEpOwogIGRhdGUzLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICBkYXRlMy5zZXRVVENGdWxsWWVhcihkYXRlMy5nZXRVVENGdWxsWWVhcigpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRVVENGdWxsWWVhcigpIC0gc3RhcnQuZ2V0VVRDRnVsbFllYXIoKTsKfSwgKGRhdGUzKSA9PiB7CiAgcmV0dXJuIGRhdGUzLmdldFVUQ0Z1bGxZZWFyKCk7Cn0pOwp1dGNZZWFyLmV2ZXJ5ID0gKGspID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsgPSBNYXRoLmZsb29yKGspKSB8fCAhKGsgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUzKSA9PiB7CiAgICBkYXRlMy5zZXRVVENGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUzLmdldFVUQ0Z1bGxZZWFyKCkgLyBrKSAqIGspOwogICAgZGF0ZTMuc2V0VVRDTW9udGgoMCwgMSk7CiAgICBkYXRlMy5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTMsIHN0ZXApID0+IHsKICAgIGRhdGUzLnNldFVUQ0Z1bGxZZWFyKGRhdGUzLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwICogayk7CiAgfSk7Cn07CnZhciB1dGNZZWFycyA9IHV0Y1llYXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvdGlja3MuanMKZnVuY3Rpb24gdGlja2VyKHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSkgewogIGNvbnN0IHRpY2tJbnRlcnZhbHMgPSBbCiAgICBbc2Vjb25kLCAxLCBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCA1LCA1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMTUsIDE1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMzAsIDMwICogZHVyYXRpb25TZWNvbmRdLAogICAgW21pbnV0ZSwgMSwgZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgNSwgNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDE1LCAxNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDMwLCAzMCAqIGR1cmF0aW9uTWludXRlXSwKICAgIFtob3VyLCAxLCBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDMsIDMgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDYsIDYgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDEyLCAxMiAqIGR1cmF0aW9uSG91cl0sCiAgICBbZGF5LCAxLCBkdXJhdGlvbkRheV0sCiAgICBbZGF5LCAyLCAyICogZHVyYXRpb25EYXldLAogICAgW3dlZWssIDEsIGR1cmF0aW9uV2Vla10sCiAgICBbbW9udGgsIDEsIGR1cmF0aW9uTW9udGhdLAogICAgW21vbnRoLCAzLCAzICogZHVyYXRpb25Nb250aF0sCiAgICBbeWVhciwgMSwgZHVyYXRpb25ZZWFyXQogIF07CiAgZnVuY3Rpb24gdGlja3MyKHN0YXJ0LCBzdG9wLCBjb3VudDIpIHsKICAgIGNvbnN0IHJldmVyc2UgPSBzdG9wIDwgc3RhcnQ7CiAgICBpZiAocmV2ZXJzZSkgW3N0YXJ0LCBzdG9wXSA9IFtzdG9wLCBzdGFydF07CiAgICBjb25zdCBpbnRlcnZhbDIgPSBjb3VudDIgJiYgdHlwZW9mIGNvdW50Mi5yYW5nZSA9PT0gImZ1bmN0aW9uIiA/IGNvdW50MiA6IHRpY2tJbnRlcnZhbChzdGFydCwgc3RvcCwgY291bnQyKTsKICAgIGNvbnN0IHRpY2tzMyA9IGludGVydmFsMiA/IGludGVydmFsMi5yYW5nZShzdGFydCwgK3N0b3AgKyAxKSA6IFtdOwogICAgcmV0dXJuIHJldmVyc2UgPyB0aWNrczMucmV2ZXJzZSgpIDogdGlja3MzOwogIH0KICBmdW5jdGlvbiB0aWNrSW50ZXJ2YWwoc3RhcnQsIHN0b3AsIGNvdW50MikgewogICAgY29uc3QgdGFyZ2V0ID0gTWF0aC5hYnMoc3RvcCAtIHN0YXJ0KSAvIGNvdW50MjsKICAgIGNvbnN0IGkgPSBiaXNlY3RvcigoWywgLCBzdGVwMl0pID0+IHN0ZXAyKS5yaWdodCh0aWNrSW50ZXJ2YWxzLCB0YXJnZXQpOwogICAgaWYgKGkgPT09IHRpY2tJbnRlcnZhbHMubGVuZ3RoKSByZXR1cm4geWVhci5ldmVyeSh0aWNrU3RlcChzdGFydCAvIGR1cmF0aW9uWWVhciwgc3RvcCAvIGR1cmF0aW9uWWVhciwgY291bnQyKSk7CiAgICBpZiAoaSA9PT0gMCkgcmV0dXJuIG1pbGxpc2Vjb25kLmV2ZXJ5KE1hdGgubWF4KHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudDIpLCAxKSk7CiAgICBjb25zdCBbdCwgc3RlcF0gPSB0aWNrSW50ZXJ2YWxzW3RhcmdldCAvIHRpY2tJbnRlcnZhbHNbaSAtIDFdWzJdIDwgdGlja0ludGVydmFsc1tpXVsyXSAvIHRhcmdldCA/IGkgLSAxIDogaV07CiAgICByZXR1cm4gdC5ldmVyeShzdGVwKTsKICB9CiAgcmV0dXJuIFt0aWNrczIsIHRpY2tJbnRlcnZhbF07Cn0KdmFyIFt1dGNUaWNrcywgdXRjVGlja0ludGVydmFsXSA9IHRpY2tlcih1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1bml4RGF5LCB1dGNIb3VyLCB1dGNNaW51dGUpOwp2YXIgW3RpbWVUaWNrcywgdGltZVRpY2tJbnRlcnZhbF0gPSB0aWNrZXIodGltZVllYXIsIHRpbWVNb250aCwgdGltZVN1bmRheSwgdGltZURheSwgdGltZUhvdXIsIHRpbWVNaW51dGUpOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9sb2NhbGUuanMKZnVuY3Rpb24gbG9jYWxEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTMgPSBuZXcgRGF0ZSgtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7CiAgICBkYXRlMy5zZXRGdWxsWWVhcihkLnkpOwogICAgcmV0dXJuIGRhdGUzOwogIH0KICByZXR1cm4gbmV3IERhdGUoZC55LCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKTsKfQpmdW5jdGlvbiB1dGNEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTMgPSBuZXcgRGF0ZShEYXRlLlVUQygtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwogICAgZGF0ZTMuc2V0VVRDRnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMzsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwp9CmZ1bmN0aW9uIG5ld0RhdGUoeSwgbSwgZCkgewogIHJldHVybiB7IHksIG0sIGQsIEg6IDAsIE06IDAsIFM6IDAsIEw6IDAgfTsKfQpmdW5jdGlvbiBmb3JtYXRMb2NhbGUobG9jYWxlMykgewogIHZhciBsb2NhbGVfZGF0ZVRpbWUgPSBsb2NhbGUzLmRhdGVUaW1lLCBsb2NhbGVfZGF0ZSA9IGxvY2FsZTMuZGF0ZSwgbG9jYWxlX3RpbWUgPSBsb2NhbGUzLnRpbWUsIGxvY2FsZV9wZXJpb2RzID0gbG9jYWxlMy5wZXJpb2RzLCBsb2NhbGVfd2Vla2RheXMgPSBsb2NhbGUzLmRheXMsIGxvY2FsZV9zaG9ydFdlZWtkYXlzID0gbG9jYWxlMy5zaG9ydERheXMsIGxvY2FsZV9tb250aHMgPSBsb2NhbGUzLm1vbnRocywgbG9jYWxlX3Nob3J0TW9udGhzID0gbG9jYWxlMy5zaG9ydE1vbnRoczsKICB2YXIgcGVyaW9kUmUgPSBmb3JtYXRSZShsb2NhbGVfcGVyaW9kcyksIHBlcmlvZExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfcGVyaW9kcyksIHdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV93ZWVrZGF5cyksIHdlZWtkYXlMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3dlZWtkYXlzKSwgc2hvcnRXZWVrZGF5UmUgPSBmb3JtYXRSZShsb2NhbGVfc2hvcnRXZWVrZGF5cyksIHNob3J0V2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRXZWVrZGF5cyksIG1vbnRoUmUgPSBmb3JtYXRSZShsb2NhbGVfbW9udGhzKSwgbW9udGhMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX21vbnRocyksIHNob3J0TW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydE1vbnRocyksIHNob3J0TW9udGhMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3Nob3J0TW9udGhzKTsKICB2YXIgZm9ybWF0cyA9IHsKICAgICJhIjogZm9ybWF0U2hvcnRXZWVrZGF5LAogICAgIkEiOiBmb3JtYXRXZWVrZGF5LAogICAgImIiOiBmb3JtYXRTaG9ydE1vbnRoLAogICAgIkIiOiBmb3JtYXRNb250aDIsCiAgICAiYyI6IG51bGwsCiAgICAiZCI6IGZvcm1hdERheU9mTW9udGgsCiAgICAiZSI6IGZvcm1hdERheU9mTW9udGgsCiAgICAiZiI6IGZvcm1hdE1pY3Jvc2Vjb25kcywKICAgICJnIjogZm9ybWF0WWVhcklTTywKICAgICJHIjogZm9ybWF0RnVsbFllYXJJU08sCiAgICAiSCI6IGZvcm1hdEhvdXIyNCwKICAgICJJIjogZm9ybWF0SG91cjEyLAogICAgImoiOiBmb3JtYXREYXlPZlllYXIsCiAgICAiTCI6IGZvcm1hdE1pbGxpc2Vjb25kcywKICAgICJtIjogZm9ybWF0TW9udGhOdW1iZXIsCiAgICAiTSI6IGZvcm1hdE1pbnV0ZXMsCiAgICAicCI6IGZvcm1hdFBlcmlvZCwKICAgICJxIjogZm9ybWF0UXVhcnRlciwKICAgICJRIjogZm9ybWF0VW5peFRpbWVzdGFtcCwKICAgICJzIjogZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMsCiAgICAiUyI6IGZvcm1hdFNlY29uZHMsCiAgICAidSI6IGZvcm1hdFdlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IGZvcm1hdFdlZWtOdW1iZXJTdW5kYXksCiAgICAiViI6IGZvcm1hdFdlZWtOdW1iZXJJU08sCiAgICAidyI6IGZvcm1hdFdlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IGZvcm1hdFdlZWtOdW1iZXJNb25kYXksCiAgICAieCI6IG51bGwsCiAgICAiWCI6IG51bGwsCiAgICAieSI6IGZvcm1hdFllYXIsCiAgICAiWSI6IGZvcm1hdEZ1bGxZZWFyLAogICAgIloiOiBmb3JtYXRab25lLAogICAgIiUiOiBmb3JtYXRMaXRlcmFsUGVyY2VudAogIH07CiAgdmFyIHV0Y0Zvcm1hdHMgPSB7CiAgICAiYSI6IGZvcm1hdFVUQ1Nob3J0V2Vla2RheSwKICAgICJBIjogZm9ybWF0VVRDV2Vla2RheSwKICAgICJiIjogZm9ybWF0VVRDU2hvcnRNb250aCwKICAgICJCIjogZm9ybWF0VVRDTW9udGgsCiAgICAiYyI6IG51bGwsCiAgICAiZCI6IGZvcm1hdFVUQ0RheU9mTW9udGgsCiAgICAiZSI6IGZvcm1hdFVUQ0RheU9mTW9udGgsCiAgICAiZiI6IGZvcm1hdFVUQ01pY3Jvc2Vjb25kcywKICAgICJnIjogZm9ybWF0VVRDWWVhcklTTywKICAgICJHIjogZm9ybWF0VVRDRnVsbFllYXJJU08sCiAgICAiSCI6IGZvcm1hdFVUQ0hvdXIyNCwKICAgICJJIjogZm9ybWF0VVRDSG91cjEyLAogICAgImoiOiBmb3JtYXRVVENEYXlPZlllYXIsCiAgICAiTCI6IGZvcm1hdFVUQ01pbGxpc2Vjb25kcywKICAgICJtIjogZm9ybWF0VVRDTW9udGhOdW1iZXIsCiAgICAiTSI6IGZvcm1hdFVUQ01pbnV0ZXMsCiAgICAicCI6IGZvcm1hdFVUQ1BlcmlvZCwKICAgICJxIjogZm9ybWF0VVRDUXVhcnRlciwKICAgICJRIjogZm9ybWF0VW5peFRpbWVzdGFtcCwKICAgICJzIjogZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMsCiAgICAiUyI6IGZvcm1hdFVUQ1NlY29uZHMsCiAgICAidSI6IGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IGZvcm1hdFVUQ1dlZWtOdW1iZXJTdW5kYXksCiAgICAiViI6IGZvcm1hdFVUQ1dlZWtOdW1iZXJJU08sCiAgICAidyI6IGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IGZvcm1hdFVUQ1dlZWtOdW1iZXJNb25kYXksCiAgICAieCI6IG51bGwsCiAgICAiWCI6IG51bGwsCiAgICAieSI6IGZvcm1hdFVUQ1llYXIsCiAgICAiWSI6IGZvcm1hdFVUQ0Z1bGxZZWFyLAogICAgIloiOiBmb3JtYXRVVENab25lLAogICAgIiUiOiBmb3JtYXRMaXRlcmFsUGVyY2VudAogIH07CiAgdmFyIHBhcnNlcyA9IHsKICAgICJhIjogcGFyc2VTaG9ydFdlZWtkYXksCiAgICAiQSI6IHBhcnNlV2Vla2RheSwKICAgICJiIjogcGFyc2VTaG9ydE1vbnRoLAogICAgIkIiOiBwYXJzZU1vbnRoLAogICAgImMiOiBwYXJzZUxvY2FsZURhdGVUaW1lLAogICAgImQiOiBwYXJzZURheU9mTW9udGgsCiAgICAiZSI6IHBhcnNlRGF5T2ZNb250aCwKICAgICJmIjogcGFyc2VNaWNyb3NlY29uZHMsCiAgICAiZyI6IHBhcnNlWWVhciwKICAgICJHIjogcGFyc2VGdWxsWWVhciwKICAgICJIIjogcGFyc2VIb3VyMjQsCiAgICAiSSI6IHBhcnNlSG91cjI0LAogICAgImoiOiBwYXJzZURheU9mWWVhciwKICAgICJMIjogcGFyc2VNaWxsaXNlY29uZHMsCiAgICAibSI6IHBhcnNlTW9udGhOdW1iZXIsCiAgICAiTSI6IHBhcnNlTWludXRlcywKICAgICJwIjogcGFyc2VQZXJpb2QsCiAgICAicSI6IHBhcnNlUXVhcnRlciwKICAgICJRIjogcGFyc2VVbml4VGltZXN0YW1wLAogICAgInMiOiBwYXJzZVVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBwYXJzZVNlY29uZHMsCiAgICAidSI6IHBhcnNlV2Vla2RheU51bWJlck1vbmRheSwKICAgICJVIjogcGFyc2VXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBwYXJzZVdlZWtOdW1iZXJJU08sCiAgICAidyI6IHBhcnNlV2Vla2RheU51bWJlclN1bmRheSwKICAgICJXIjogcGFyc2VXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBwYXJzZUxvY2FsZURhdGUsCiAgICAiWCI6IHBhcnNlTG9jYWxlVGltZSwKICAgICJ5IjogcGFyc2VZZWFyLAogICAgIlkiOiBwYXJzZUZ1bGxZZWFyLAogICAgIloiOiBwYXJzZVpvbmUsCiAgICAiJSI6IHBhcnNlTGl0ZXJhbFBlcmNlbnQKICB9OwogIGZvcm1hdHMueCA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZSwgZm9ybWF0cyk7CiAgZm9ybWF0cy5YID0gbmV3Rm9ybWF0KGxvY2FsZV90aW1lLCBmb3JtYXRzKTsKICBmb3JtYXRzLmMgPSBuZXdGb3JtYXQobG9jYWxlX2RhdGVUaW1lLCBmb3JtYXRzKTsKICB1dGNGb3JtYXRzLnggPSBuZXdGb3JtYXQobG9jYWxlX2RhdGUsIHV0Y0Zvcm1hdHMpOwogIHV0Y0Zvcm1hdHMuWCA9IG5ld0Zvcm1hdChsb2NhbGVfdGltZSwgdXRjRm9ybWF0cyk7CiAgdXRjRm9ybWF0cy5jID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlVGltZSwgdXRjRm9ybWF0cyk7CiAgZnVuY3Rpb24gbmV3Rm9ybWF0KHNwZWNpZmllciwgZm9ybWF0czIpIHsKICAgIHJldHVybiBmdW5jdGlvbihkYXRlMykgewogICAgICB2YXIgc3RyaW5nID0gW10sIGkgPSAtMSwgaiA9IDAsIG4gPSBzcGVjaWZpZXIubGVuZ3RoLCBjLCBwYWQyLCBmb3JtYXQyOwogICAgICBpZiAoIShkYXRlMyBpbnN0YW5jZW9mIERhdGUpKSBkYXRlMyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTMpOwogICAgICB3aGlsZSAoKytpIDwgbikgewogICAgICAgIGlmIChzcGVjaWZpZXIuY2hhckNvZGVBdChpKSA9PT0gMzcpIHsKICAgICAgICAgIHN0cmluZy5wdXNoKHNwZWNpZmllci5zbGljZShqLCBpKSk7CiAgICAgICAgICBpZiAoKHBhZDIgPSBwYWRzW2MgPSBzcGVjaWZpZXIuY2hhckF0KCsraSldKSAhPSBudWxsKSBjID0gc3BlY2lmaWVyLmNoYXJBdCgrK2kpOwogICAgICAgICAgZWxzZSBwYWQyID0gYyA9PT0gImUiID8gIiAiIDogIjAiOwogICAgICAgICAgaWYgKGZvcm1hdDIgPSBmb3JtYXRzMltjXSkgYyA9IGZvcm1hdDIoZGF0ZTMsIHBhZDIpOwogICAgICAgICAgc3RyaW5nLnB1c2goYyk7CiAgICAgICAgICBqID0gaSArIDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN0cmluZy5wdXNoKHNwZWNpZmllci5zbGljZShqLCBpKSk7CiAgICAgIHJldHVybiBzdHJpbmcuam9pbigiIik7CiAgICB9OwogIH0KICBmdW5jdGlvbiBuZXdQYXJzZShzcGVjaWZpZXIsIFopIHsKICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdmFyIGQgPSBuZXdEYXRlKDE5MDAsIHZvaWQgMCwgMSksIGkgPSBwYXJzZVNwZWNpZmllcihkLCBzcGVjaWZpZXIsIHN0cmluZyArPSAiIiwgMCksIHdlZWssIGRheTsKICAgICAgaWYgKGkgIT0gc3RyaW5nLmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgICAgIGlmICgiUSIgaW4gZCkgcmV0dXJuIG5ldyBEYXRlKGQuUSk7CiAgICAgIGlmICgicyIgaW4gZCkgcmV0dXJuIG5ldyBEYXRlKGQucyAqIDFlMyArICgiTCIgaW4gZCA/IGQuTCA6IDApKTsKICAgICAgaWYgKFogJiYgISgiWiIgaW4gZCkpIGQuWiA9IDA7CiAgICAgIGlmICgicCIgaW4gZCkgZC5IID0gZC5IICUgMTIgKyBkLnAgKiAxMjsKICAgICAgaWYgKGQubSA9PT0gdm9pZCAwKSBkLm0gPSAicSIgaW4gZCA/IGQucSA6IDA7CiAgICAgIGlmICgiViIgaW4gZCkgewogICAgICAgIGlmIChkLlYgPCAxIHx8IGQuViA+IDUzKSByZXR1cm4gbnVsbDsKICAgICAgICBpZiAoISgidyIgaW4gZCkpIGQudyA9IDE7CiAgICAgICAgaWYgKCJaIiBpbiBkKSB7CiAgICAgICAgICB3ZWVrID0gdXRjRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLCBkYXkgPSB3ZWVrLmdldFVUQ0RheSgpOwogICAgICAgICAgd2VlayA9IGRheSA+IDQgfHwgZGF5ID09PSAwID8gdXRjTW9uZGF5LmNlaWwod2VlaykgOiB1dGNNb25kYXkod2Vlayk7CiAgICAgICAgICB3ZWVrID0gdXRjRGF5Lm9mZnNldCh3ZWVrLCAoZC5WIC0gMSkgKiA3KTsKICAgICAgICAgIGQueSA9IHdlZWsuZ2V0VVRDRnVsbFllYXIoKTsKICAgICAgICAgIGQubSA9IHdlZWsuZ2V0VVRDTW9udGgoKTsKICAgICAgICAgIGQuZCA9IHdlZWsuZ2V0VVRDRGF0ZSgpICsgKGQudyArIDYpICUgNzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2VlayA9IGxvY2FsRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLCBkYXkgPSB3ZWVrLmdldERheSgpOwogICAgICAgICAgd2VlayA9IGRheSA+IDQgfHwgZGF5ID09PSAwID8gdGltZU1vbmRheS5jZWlsKHdlZWspIDogdGltZU1vbmRheSh3ZWVrKTsKICAgICAgICAgIHdlZWsgPSB0aW1lRGF5Lm9mZnNldCh3ZWVrLCAoZC5WIC0gMSkgKiA3KTsKICAgICAgICAgIGQueSA9IHdlZWsuZ2V0RnVsbFllYXIoKTsKICAgICAgICAgIGQubSA9IHdlZWsuZ2V0TW9udGgoKTsKICAgICAgICAgIGQuZCA9IHdlZWsuZ2V0RGF0ZSgpICsgKGQudyArIDYpICUgNzsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoIlciIGluIGQgfHwgIlUiIGluIGQpIHsKICAgICAgICBpZiAoISgidyIgaW4gZCkpIGQudyA9ICJ1IiBpbiBkID8gZC51ICUgNyA6ICJXIiBpbiBkID8gMSA6IDA7CiAgICAgICAgZGF5ID0gIloiIGluIGQgPyB1dGNEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSkuZ2V0VVRDRGF5KCkgOiBsb2NhbERhdGUobmV3RGF0ZShkLnksIDAsIDEpKS5nZXREYXkoKTsKICAgICAgICBkLm0gPSAwOwogICAgICAgIGQuZCA9ICJXIiBpbiBkID8gKGQudyArIDYpICUgNyArIGQuVyAqIDcgLSAoZGF5ICsgNSkgJSA3IDogZC53ICsgZC5VICogNyAtIChkYXkgKyA2KSAlIDc7CiAgICAgIH0KICAgICAgaWYgKCJaIiBpbiBkKSB7CiAgICAgICAgZC5IICs9IGQuWiAvIDEwMCB8IDA7CiAgICAgICAgZC5NICs9IGQuWiAlIDEwMDsKICAgICAgICByZXR1cm4gdXRjRGF0ZShkKTsKICAgICAgfQogICAgICByZXR1cm4gbG9jYWxEYXRlKGQpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTcGVjaWZpZXIoZCwgc3BlY2lmaWVyLCBzdHJpbmcsIGopIHsKICAgIHZhciBpID0gMCwgbiA9IHNwZWNpZmllci5sZW5ndGgsIG0gPSBzdHJpbmcubGVuZ3RoLCBjLCBwYXJzZTsKICAgIHdoaWxlIChpIDwgbikgewogICAgICBpZiAoaiA+PSBtKSByZXR1cm4gLTE7CiAgICAgIGMgPSBzcGVjaWZpZXIuY2hhckNvZGVBdChpKyspOwogICAgICBpZiAoYyA9PT0gMzcpIHsKICAgICAgICBjID0gc3BlY2lmaWVyLmNoYXJBdChpKyspOwogICAgICAgIHBhcnNlID0gcGFyc2VzW2MgaW4gcGFkcyA/IHNwZWNpZmllci5jaGFyQXQoaSsrKSA6IGNdOwogICAgICAgIGlmICghcGFyc2UgfHwgKGogPSBwYXJzZShkLCBzdHJpbmcsIGopKSA8IDApIHJldHVybiAtMTsKICAgICAgfSBlbHNlIGlmIChjICE9IHN0cmluZy5jaGFyQ29kZUF0KGorKykpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBqOwogIH0KICBmdW5jdGlvbiBwYXJzZVBlcmlvZChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gcGVyaW9kUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5wID0gcGVyaW9kTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlU2hvcnRXZWVrZGF5KGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBzaG9ydFdlZWtkYXlSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLncgPSBzaG9ydFdlZWtkYXlMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VXZWVrZGF5KGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSB3ZWVrZGF5UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC53ID0gd2Vla2RheUxvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVNob3J0TW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHNob3J0TW9udGhSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLm0gPSBzaG9ydE1vbnRoTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTW9udGgoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IG1vbnRoUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5tID0gbW9udGhMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVEYXRlVGltZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfZGF0ZVRpbWUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlRGF0ZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfZGF0ZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVUaW1lKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV90aW1lLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBmb3JtYXRTaG9ydFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydFdlZWtkYXlzW2QuZ2V0RGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfd2Vla2RheXNbZC5nZXREYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFNob3J0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydE1vbnRoc1tkLmdldE1vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRNb250aDIoZCkgewogICAgcmV0dXJuIGxvY2FsZV9tb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UGVyaW9kKGQpIHsKICAgIHJldHVybiBsb2NhbGVfcGVyaW9kc1srKGQuZ2V0SG91cnMoKSA+PSAxMildOwogIH0KICBmdW5jdGlvbiBmb3JtYXRRdWFydGVyKGQpIHsKICAgIHJldHVybiAxICsgfn4oZC5nZXRNb250aCgpIC8gMyk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1Nob3J0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0V2Vla2RheXNbZC5nZXRVVENEYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV93ZWVrZGF5c1tkLmdldFVUQ0RheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDU2hvcnRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0TW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfbW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1BlcmlvZChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3BlcmlvZHNbKyhkLmdldFVUQ0hvdXJzKCkgPj0gMTIpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDUXVhcnRlcihkKSB7CiAgICByZXR1cm4gMSArIH5+KGQuZ2V0VVRDTW9udGgoKSAvIDMpOwogIH0KICByZXR1cm4gewogICAgZm9ybWF0OiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIGYgPSBuZXdGb3JtYXQoc3BlY2lmaWVyICs9ICIiLCBmb3JtYXRzKTsKICAgICAgZi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIHAgPSBuZXdQYXJzZShzcGVjaWZpZXIgKz0gIiIsIGZhbHNlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfSwKICAgIHV0Y0Zvcm1hdDogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBmID0gbmV3Rm9ybWF0KHNwZWNpZmllciArPSAiIiwgdXRjRm9ybWF0cyk7CiAgICAgIGYudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gZjsKICAgIH0sCiAgICB1dGNQYXJzZTogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBwID0gbmV3UGFyc2Uoc3BlY2lmaWVyICs9ICIiLCB0cnVlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfQogIH07Cn0KdmFyIHBhZHMgPSB7ICItIjogIiIsICJfIjogIiAiLCAiMCI6ICIwIiB9Owp2YXIgbnVtYmVyUmUgPSAvXlxzKlxkKy87CnZhciBwZXJjZW50UmUgPSAvXiUvOwp2YXIgcmVxdW90ZVJlID0gL1tcXF4kKis/fFtcXSgpLnt9XS9nOwpmdW5jdGlvbiBwYWQodmFsdWUsIGZpbGwsIHdpZHRoKSB7CiAgdmFyIHNpZ24yID0gdmFsdWUgPCAwID8gIi0iIDogIiIsIHN0cmluZyA9IChzaWduMiA/IC12YWx1ZSA6IHZhbHVlKSArICIiLCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoOwogIHJldHVybiBzaWduMiArIChsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgKyBzdHJpbmcgOiBzdHJpbmcpOwp9CmZ1bmN0aW9uIHJlcXVvdGUocykgewogIHJldHVybiBzLnJlcGxhY2UocmVxdW90ZVJlLCAiXFwkJiIpOwp9CmZ1bmN0aW9uIGZvcm1hdFJlKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBSZWdFeHAoIl4oPzoiICsgbmFtZXMubWFwKHJlcXVvdGUpLmpvaW4oInwiKSArICIpIiwgImkiKTsKfQpmdW5jdGlvbiBmb3JtYXRMb29rdXAobmFtZXMpIHsKICByZXR1cm4gbmV3IE1hcChuYW1lcy5tYXAoKG5hbWUsIGkpID0+IFtuYW1lLnRvTG93ZXJDYXNlKCksIGldKSk7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrZGF5TnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLncgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC51ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJTdW5kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVySVNPKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlYgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5XID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUZ1bGxZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDQpKTsKICByZXR1cm4gbiA/IChkLnkgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0gKyAoK25bMF0gPiA2OCA/IDE5MDAgOiAyZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2Vab25lKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gL14oWil8KFsrLV1cZFxkKSg/Ojo/KFxkXGQpKT8vLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA2KSk7CiAgcmV0dXJuIG4gPyAoZC5aID0gblsxXSA/IDAgOiAtKG5bMl0gKyAoblszXSB8fCAiMDAiKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVF1YXJ0ZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQucSA9IG5bMF0gKiAzIC0gMywgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTW9udGhOdW1iZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQubSA9IG5bMF0gLSAxLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VEYXlPZk1vbnRoKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLm0gPSAwLCBkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlSG91cjI0KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLkggPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWludXRlcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5NID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuUyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWxsaXNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMykpOwogIHJldHVybiBuID8gKGQuTCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWNyb3NlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuTCA9IE1hdGguZmxvb3IoblswXSAvIDFlMyksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUxpdGVyYWxQZXJjZW50KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gcGVyY2VudFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyBpICsgblswXS5sZW5ndGggOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXAoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgcmV0dXJuIG4gPyAoZC5RID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXBTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQucyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldERhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXREYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHRpbWVEYXkuY291bnQodGltZVllYXIoZCksIGQpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRNaWxsaXNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaWxsaXNlY29uZHMoKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWljcm9zZWNvbmRzKGQsIHApIHsKICByZXR1cm4gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApICsgIjAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TW9udGhOdW1iZXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNb250aCgpICsgMSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0TWludXRlcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldE1pbnV0ZXMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0U2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFNlY29uZHMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlck1vbmRheShkKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgcmV0dXJuIGRheSA9PT0gMCA/IDcgOiBkYXk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlclN1bmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lU3VuZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGRJU08oZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB0aW1lVGh1cnNkYXkoZCkgOiB0aW1lVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKHRpbWVUaHVyc2RheS5jb3VudCh0aW1lWWVhcihkKSwgZCkgKyAodGltZVllYXIoZCkuZ2V0RGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXREYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHRpbWVNb25kYXkuY291bnQodGltZVllYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0WWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXJJU08oZCwgcCkgewogIGQgPSBkSVNPKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdEZ1bGxZZWFySVNPKGQsIHApIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICBkID0gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFpvbmUoZCkgewogIHZhciB6ID0gZC5nZXRUaW1lem9uZU9mZnNldCgpOwogIHJldHVybiAoeiA+IDAgPyAiLSIgOiAoeiAqPSAtMSwgIisiKSkgKyBwYWQoeiAvIDYwIHwgMCwgIjAiLCAyKSArIHBhZCh6ICUgNjAsICIwIiwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0RhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENEYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHV0Y0RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1NlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkb3cgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkb3cgPT09IDAgPyA3IDogZG93Owp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodXRjU3VuZGF5LmNvdW50KHV0Y1llYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gVVRDZElTTyhkKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgcmV0dXJuIGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKHV0Y1RodXJzZGF5LmNvdW50KHV0Y1llYXIoZCksIGQpICsgKHV0Y1llYXIoZCkuZ2V0VVRDRGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXRVVENEYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y01vbmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1llYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRVVENGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWm9uZSgpIHsKICByZXR1cm4gIiswMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRMaXRlcmFsUGVyY2VudCgpIHsKICByZXR1cm4gIiUiOwp9CmZ1bmN0aW9uIGZvcm1hdFVuaXhUaW1lc3RhbXAoZCkgewogIHJldHVybiArZDsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcyhkKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoK2QgLyAxZTMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS1mb3JtYXQvc3JjL2RlZmF1bHRMb2NhbGUuanMKdmFyIGxvY2FsZTI7CnZhciB0aW1lRm9ybWF0Owp2YXIgdGltZVBhcnNlOwp2YXIgdXRjRm9ybWF0Owp2YXIgdXRjUGFyc2U7CmRlZmF1bHRMb2NhbGUyKHsKICBkYXRlVGltZTogIiV4LCAlWCIsCiAgZGF0ZTogIiUtbS8lLWQvJVkiLAogIHRpbWU6ICIlLUk6JU06JVMgJXAiLAogIHBlcmlvZHM6IFsiQU0iLCAiUE0iXSwKICBkYXlzOiBbIlN1bmRheSIsICJNb25kYXkiLCAiVHVlc2RheSIsICJXZWRuZXNkYXkiLCAiVGh1cnNkYXkiLCAiRnJpZGF5IiwgIlNhdHVyZGF5Il0sCiAgc2hvcnREYXlzOiBbIlN1biIsICJNb24iLCAiVHVlIiwgIldlZCIsICJUaHUiLCAiRnJpIiwgIlNhdCJdLAogIG1vbnRoczogWyJKYW51YXJ5IiwgIkZlYnJ1YXJ5IiwgIk1hcmNoIiwgIkFwcmlsIiwgIk1heSIsICJKdW5lIiwgIkp1bHkiLCAiQXVndXN0IiwgIlNlcHRlbWJlciIsICJPY3RvYmVyIiwgIk5vdmVtYmVyIiwgIkRlY2VtYmVyIl0sCiAgc2hvcnRNb250aHM6IFsiSmFuIiwgIkZlYiIsICJNYXIiLCAiQXByIiwgIk1heSIsICJKdW4iLCAiSnVsIiwgIkF1ZyIsICJTZXAiLCAiT2N0IiwgIk5vdiIsICJEZWMiXQp9KTsKZnVuY3Rpb24gZGVmYXVsdExvY2FsZTIoZGVmaW5pdGlvbikgewogIGxvY2FsZTIgPSBmb3JtYXRMb2NhbGUoZGVmaW5pdGlvbik7CiAgdGltZUZvcm1hdCA9IGxvY2FsZTIuZm9ybWF0OwogIHRpbWVQYXJzZSA9IGxvY2FsZTIucGFyc2U7CiAgdXRjRm9ybWF0ID0gbG9jYWxlMi51dGNGb3JtYXQ7CiAgdXRjUGFyc2UgPSBsb2NhbGUyLnV0Y1BhcnNlOwogIHJldHVybiBsb2NhbGUyOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RpbWUuanMKZnVuY3Rpb24gZGF0ZSh0KSB7CiAgcmV0dXJuIG5ldyBEYXRlKHQpOwp9CmZ1bmN0aW9uIG51bWJlcjQodCkgewogIHJldHVybiB0IGluc3RhbmNlb2YgRGF0ZSA/ICt0IDogKy8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrdCk7Cn0KZnVuY3Rpb24gY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikgewogIHZhciBzY2FsZSA9IGNvbnRpbnVvdXMoKSwgaW52ZXJ0MiA9IHNjYWxlLmludmVydCwgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIHZhciBmb3JtYXRNaWxsaXNlY29uZDIgPSBmb3JtYXQyKCIuJUwiKSwgZm9ybWF0U2Vjb25kMiA9IGZvcm1hdDIoIjolUyIpLCBmb3JtYXRNaW51dGUyID0gZm9ybWF0MigiJUk6JU0iKSwgZm9ybWF0SG91cjIgPSBmb3JtYXQyKCIlSSAlcCIpLCBmb3JtYXREYXkyID0gZm9ybWF0MigiJWEgJWQiKSwgZm9ybWF0V2VlazIgPSBmb3JtYXQyKCIlYiAlZCIpLCBmb3JtYXRNb250aDIgPSBmb3JtYXQyKCIlQiIpLCBmb3JtYXRZZWFyMyA9IGZvcm1hdDIoIiVZIik7CiAgZnVuY3Rpb24gdGlja0Zvcm1hdDIoZGF0ZTMpIHsKICAgIHJldHVybiAoc2Vjb25kMihkYXRlMykgPCBkYXRlMyA/IGZvcm1hdE1pbGxpc2Vjb25kMiA6IG1pbnV0ZShkYXRlMykgPCBkYXRlMyA/IGZvcm1hdFNlY29uZDIgOiBob3VyKGRhdGUzKSA8IGRhdGUzID8gZm9ybWF0TWludXRlMiA6IGRheShkYXRlMykgPCBkYXRlMyA/IGZvcm1hdEhvdXIyIDogbW9udGgoZGF0ZTMpIDwgZGF0ZTMgPyB3ZWVrKGRhdGUzKSA8IGRhdGUzID8gZm9ybWF0RGF5MiA6IGZvcm1hdFdlZWsyIDogeWVhcihkYXRlMykgPCBkYXRlMyA/IGZvcm1hdE1vbnRoMiA6IGZvcm1hdFllYXIzKShkYXRlMyk7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkpIHsKICAgIHJldHVybiBuZXcgRGF0ZShpbnZlcnQyKHkpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gZG9tYWluKEFycmF5LmZyb20oXywgbnVtYmVyNCkpIDogZG9tYWluKCkubWFwKGRhdGUpOwogIH07CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihpbnRlcnZhbDIpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja3MyKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgaW50ZXJ2YWwyID09IG51bGwgPyAxMCA6IGludGVydmFsMik7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gZnVuY3Rpb24oY291bnQyLCBzcGVjaWZpZXIpIHsKICAgIHJldHVybiBzcGVjaWZpZXIgPT0gbnVsbCA/IHRpY2tGb3JtYXQyIDogZm9ybWF0MihzcGVjaWZpZXIpOwogIH07CiAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGludGVydmFsMikgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIGlmICghaW50ZXJ2YWwyIHx8IHR5cGVvZiBpbnRlcnZhbDIucmFuZ2UgIT09ICJmdW5jdGlvbiIpIGludGVydmFsMiA9IHRpY2tJbnRlcnZhbChkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGludGVydmFsMiA9PSBudWxsID8gMTAgOiBpbnRlcnZhbDIpOwogICAgcmV0dXJuIGludGVydmFsMiA/IGRvbWFpbihuaWNlKGQsIGludGVydmFsMikpIDogc2NhbGU7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHRpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih0aW1lVGlja3MsIHRpbWVUaWNrSW50ZXJ2YWwsIHRpbWVZZWFyLCB0aW1lTW9udGgsIHRpbWVTdW5kYXksIHRpbWVEYXksIHRpbWVIb3VyLCB0aW1lTWludXRlLCBzZWNvbmQsIHRpbWVGb3JtYXQpLmRvbWFpbihbbmV3IERhdGUoMmUzLCAwLCAxKSwgbmV3IERhdGUoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9uYW1lc3BhY2VzLmpzCnZhciB4aHRtbCA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKdmFyIG5hbWVzcGFjZXNfZGVmYXVsdCA9IHsKICBzdmc6ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsCiAgeGh0bWwsCiAgeGxpbms6ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICB4bWw6ICJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2UiLAogIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC94bWxucy8iCn07CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9uYW1lc3BhY2UuanMKZnVuY3Rpb24gbmFtZXNwYWNlX2RlZmF1bHQobmFtZSkgewogIHZhciBwcmVmaXggPSBuYW1lICs9ICIiLCBpID0gcHJlZml4LmluZGV4T2YoIjoiKTsKICBpZiAoaSA+PSAwICYmIChwcmVmaXggPSBuYW1lLnNsaWNlKDAsIGkpKSAhPT0gInhtbG5zIikgbmFtZSA9IG5hbWUuc2xpY2UoaSArIDEpOwogIHJldHVybiBuYW1lc3BhY2VzX2RlZmF1bHQuaGFzT3duUHJvcGVydHkocHJlZml4KSA/IHsgc3BhY2U6IG5hbWVzcGFjZXNfZGVmYXVsdFtwcmVmaXhdLCBsb2NhbDogbmFtZSB9IDogbmFtZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvY3JlYXRvci5qcwpmdW5jdGlvbiBjcmVhdG9ySW5oZXJpdChuYW1lKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIGRvY3VtZW50MiA9IHRoaXMub3duZXJEb2N1bWVudCwgdXJpID0gdGhpcy5uYW1lc3BhY2VVUkk7CiAgICByZXR1cm4gdXJpID09PSB4aHRtbCAmJiBkb2N1bWVudDIuZG9jdW1lbnRFbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0geGh0bWwgPyBkb2N1bWVudDIuY3JlYXRlRWxlbWVudChuYW1lKSA6IGRvY3VtZW50Mi5jcmVhdGVFbGVtZW50TlModXJpLCBuYW1lKTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0b3JGaXhlZChmdWxsbmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKGZ1bGxuYW1lLnNwYWNlLCBmdWxsbmFtZS5sb2NhbCk7CiAgfTsKfQpmdW5jdGlvbiBjcmVhdG9yX2RlZmF1bHQobmFtZSkgewogIHZhciBmdWxsbmFtZSA9IG5hbWVzcGFjZV9kZWZhdWx0KG5hbWUpOwogIHJldHVybiAoZnVsbG5hbWUubG9jYWwgPyBjcmVhdG9yRml4ZWQgOiBjcmVhdG9ySW5oZXJpdCkoZnVsbG5hbWUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rvci5qcwpmdW5jdGlvbiBub25lKCkgewp9CmZ1bmN0aW9uIHNlbGVjdG9yX2RlZmF1bHQoc2VsZWN0b3IpIHsKICByZXR1cm4gc2VsZWN0b3IgPT0gbnVsbCA/IG5vbmUgOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9zZWxlY3QuanMKZnVuY3Rpb24gc2VsZWN0X2RlZmF1bHQoc2VsZWN0KSB7CiAgaWYgKHR5cGVvZiBzZWxlY3QgIT09ICJmdW5jdGlvbiIpIHNlbGVjdCA9IHNlbGVjdG9yX2RlZmF1bHQoc2VsZWN0KTsKICBmb3IgKHZhciBncm91cHMgPSB0aGlzLl9ncm91cHMsIG0gPSBncm91cHMubGVuZ3RoLCBzdWJncm91cHMgPSBuZXcgQXJyYXkobSksIGogPSAwOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgbiA9IGdyb3VwLmxlbmd0aCwgc3ViZ3JvdXAgPSBzdWJncm91cHNbal0gPSBuZXcgQXJyYXkobiksIG5vZGUsIHN1Ym5vZGUsIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIGlmICgobm9kZSA9IGdyb3VwW2ldKSAmJiAoc3Vibm9kZSA9IHNlbGVjdC5jYWxsKG5vZGUsIG5vZGUuX19kYXRhX18sIGksIGdyb3VwKSkpIHsKICAgICAgICBpZiAoIl9fZGF0YV9fIiBpbiBub2RlKSBzdWJub2RlLl9fZGF0YV9fID0gbm9kZS5fX2RhdGFfXzsKICAgICAgICBzdWJncm91cFtpXSA9IHN1Ym5vZGU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG5ldyBTZWxlY3Rpb24oc3ViZ3JvdXBzLCB0aGlzLl9wYXJlbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvYXJyYXkuanMKZnVuY3Rpb24gYXJyYXkoeCkgewogIHJldHVybiB4ID09IG51bGwgPyBbXSA6IEFycmF5LmlzQXJyYXkoeCkgPyB4IDogQXJyYXkuZnJvbSh4KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0b3JBbGwuanMKZnVuY3Rpb24gZW1wdHkoKSB7CiAgcmV0dXJuIFtdOwp9CmZ1bmN0aW9uIHNlbGVjdG9yQWxsX2RlZmF1bHQoc2VsZWN0b3IpIHsKICByZXR1cm4gc2VsZWN0b3IgPT0gbnVsbCA/IGVtcHR5IDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vc2VsZWN0QWxsLmpzCmZ1bmN0aW9uIGFycmF5QWxsKHNlbGVjdCkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcnJheShzZWxlY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgfTsKfQpmdW5jdGlvbiBzZWxlY3RBbGxfZGVmYXVsdChzZWxlY3QpIHsKICBpZiAodHlwZW9mIHNlbGVjdCA9PT0gImZ1bmN0aW9uIikgc2VsZWN0ID0gYXJyYXlBbGwoc2VsZWN0KTsKICBlbHNlIHNlbGVjdCA9IHNlbGVjdG9yQWxsX2RlZmF1bHQoc2VsZWN0KTsKICBmb3IgKHZhciBncm91cHMgPSB0aGlzLl9ncm91cHMsIG0gPSBncm91cHMubGVuZ3RoLCBzdWJncm91cHMgPSBbXSwgcGFyZW50cyA9IFtdLCBqID0gMDsgaiA8IG07ICsraikgewogICAgZm9yICh2YXIgZ3JvdXAgPSBncm91cHNbal0sIG4gPSBncm91cC5sZW5ndGgsIG5vZGUsIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgICBzdWJncm91cHMucHVzaChzZWxlY3QuY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCkpOwogICAgICAgIHBhcmVudHMucHVzaChub2RlKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbmV3IFNlbGVjdGlvbihzdWJncm91cHMsIHBhcmVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9tYXRjaGVyLmpzCmZ1bmN0aW9uIG1hdGNoZXJfZGVmYXVsdChzZWxlY3RvcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLm1hdGNoZXMoc2VsZWN0b3IpOwogIH07Cn0KZnVuY3Rpb24gY2hpbGRNYXRjaGVyKHNlbGVjdG9yKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKG5vZGUpIHsKICAgIHJldHVybiBub2RlLm1hdGNoZXMoc2VsZWN0b3IpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9zZWxlY3RDaGlsZC5qcwp2YXIgZmluZCA9IEFycmF5LnByb3RvdHlwZS5maW5kOwpmdW5jdGlvbiBjaGlsZEZpbmQobWF0Y2gpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZmluZC5jYWxsKHRoaXMuY2hpbGRyZW4sIG1hdGNoKTsKICB9Owp9CmZ1bmN0aW9uIGNoaWxkRmlyc3QoKSB7CiAgcmV0dXJuIHRoaXMuZmlyc3RFbGVtZW50Q2hpbGQ7Cn0KZnVuY3Rpb24gc2VsZWN0Q2hpbGRfZGVmYXVsdChtYXRjaCkgewogIHJldHVybiB0aGlzLnNlbGVjdChtYXRjaCA9PSBudWxsID8gY2hpbGRGaXJzdCA6IGNoaWxkRmluZCh0eXBlb2YgbWF0Y2ggPT09ICJmdW5jdGlvbiIgPyBtYXRjaCA6IGNoaWxkTWF0Y2hlcihtYXRjaCkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL3NlbGVjdENoaWxkcmVuLmpzCnZhciBmaWx0ZXIgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyOwpmdW5jdGlvbiBjaGlsZHJlbigpIHsKICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmNoaWxkcmVuKTsKfQpmdW5jdGlvbiBjaGlsZHJlbkZpbHRlcihtYXRjaCkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmaWx0ZXIuY2FsbCh0aGlzLmNoaWxkcmVuLCBtYXRjaCk7CiAgfTsKfQpmdW5jdGlvbiBzZWxlY3RDaGlsZHJlbl9kZWZhdWx0KG1hdGNoKSB7CiAgcmV0dXJuIHRoaXMuc2VsZWN0QWxsKG1hdGNoID09IG51bGwgPyBjaGlsZHJlbiA6IGNoaWxkcmVuRmlsdGVyKHR5cGVvZiBtYXRjaCA9PT0gImZ1bmN0aW9uIiA/IG1hdGNoIDogY2hpbGRNYXRjaGVyKG1hdGNoKSkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZmlsdGVyLmpzCmZ1bmN0aW9uIGZpbHRlcl9kZWZhdWx0KG1hdGNoKSB7CiAgaWYgKHR5cGVvZiBtYXRjaCAhPT0gImZ1bmN0aW9uIikgbWF0Y2ggPSBtYXRjaGVyX2RlZmF1bHQobWF0Y2gpOwogIGZvciAodmFyIGdyb3VwcyA9IHRoaXMuX2dyb3VwcywgbSA9IGdyb3Vwcy5sZW5ndGgsIHN1Ymdyb3VwcyA9IG5ldyBBcnJheShtKSwgaiA9IDA7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBuID0gZ3JvdXAubGVuZ3RoLCBzdWJncm91cCA9IHN1Ymdyb3Vwc1tqXSA9IFtdLCBub2RlLCBpID0gMDsgaSA8IG47ICsraSkgewogICAgICBpZiAoKG5vZGUgPSBncm91cFtpXSkgJiYgbWF0Y2guY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCkpIHsKICAgICAgICBzdWJncm91cC5wdXNoKG5vZGUpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBuZXcgU2VsZWN0aW9uKHN1Ymdyb3VwcywgdGhpcy5fcGFyZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9zcGFyc2UuanMKZnVuY3Rpb24gc3BhcnNlX2RlZmF1bHQodXBkYXRlKSB7CiAgcmV0dXJuIG5ldyBBcnJheSh1cGRhdGUubGVuZ3RoKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2VudGVyLmpzCmZ1bmN0aW9uIGVudGVyX2RlZmF1bHQoKSB7CiAgcmV0dXJuIG5ldyBTZWxlY3Rpb24odGhpcy5fZW50ZXIgfHwgdGhpcy5fZ3JvdXBzLm1hcChzcGFyc2VfZGVmYXVsdCksIHRoaXMuX3BhcmVudHMpOwp9CmZ1bmN0aW9uIEVudGVyTm9kZShwYXJlbnQsIGRhdHVtMikgewogIHRoaXMub3duZXJEb2N1bWVudCA9IHBhcmVudC5vd25lckRvY3VtZW50OwogIHRoaXMubmFtZXNwYWNlVVJJID0gcGFyZW50Lm5hbWVzcGFjZVVSSTsKICB0aGlzLl9uZXh0ID0gbnVsbDsKICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7CiAgdGhpcy5fX2RhdGFfXyA9IGRhdHVtMjsKfQpFbnRlck5vZGUucHJvdG90eXBlID0gewogIGNvbnN0cnVjdG9yOiBFbnRlck5vZGUsCiAgYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICByZXR1cm4gdGhpcy5fcGFyZW50Lmluc2VydEJlZm9yZShjaGlsZCwgdGhpcy5fbmV4dCk7CiAgfSwKICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKGNoaWxkLCBuZXh0KSB7CiAgICByZXR1cm4gdGhpcy5fcGFyZW50Lmluc2VydEJlZm9yZShjaGlsZCwgbmV4dCk7CiAgfSwKICBxdWVyeVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgcmV0dXJuIHRoaXMuX3BhcmVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICB9LAogIHF1ZXJ5U2VsZWN0b3JBbGw6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICByZXR1cm4gdGhpcy5fcGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL2NvbnN0YW50LmpzCmZ1bmN0aW9uIGNvbnN0YW50X2RlZmF1bHQyKHgpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4geDsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZGF0YS5qcwpmdW5jdGlvbiBiaW5kSW5kZXgocGFyZW50LCBncm91cCwgZW50ZXIsIHVwZGF0ZSwgZXhpdCwgZGF0YSkgewogIHZhciBpID0gMCwgbm9kZSwgZ3JvdXBMZW5ndGggPSBncm91cC5sZW5ndGgsIGRhdGFMZW5ndGggPSBkYXRhLmxlbmd0aDsKICBmb3IgKDsgaSA8IGRhdGFMZW5ndGg7ICsraSkgewogICAgaWYgKG5vZGUgPSBncm91cFtpXSkgewogICAgICBub2RlLl9fZGF0YV9fID0gZGF0YVtpXTsKICAgICAgdXBkYXRlW2ldID0gbm9kZTsKICAgIH0gZWxzZSB7CiAgICAgIGVudGVyW2ldID0gbmV3IEVudGVyTm9kZShwYXJlbnQsIGRhdGFbaV0pOwogICAgfQogIH0KICBmb3IgKDsgaSA8IGdyb3VwTGVuZ3RoOyArK2kpIHsKICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgZXhpdFtpXSA9IG5vZGU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGJpbmRLZXkocGFyZW50LCBncm91cCwgZW50ZXIsIHVwZGF0ZSwgZXhpdCwgZGF0YSwga2V5KSB7CiAgdmFyIGksIG5vZGUsIG5vZGVCeUtleVZhbHVlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgZ3JvdXBMZW5ndGggPSBncm91cC5sZW5ndGgsIGRhdGFMZW5ndGggPSBkYXRhLmxlbmd0aCwga2V5VmFsdWVzID0gbmV3IEFycmF5KGdyb3VwTGVuZ3RoKSwga2V5VmFsdWU7CiAgZm9yIChpID0gMDsgaSA8IGdyb3VwTGVuZ3RoOyArK2kpIHsKICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAga2V5VmFsdWVzW2ldID0ga2V5VmFsdWUgPSBrZXkuY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCkgKyAiIjsKICAgICAgaWYgKG5vZGVCeUtleVZhbHVlLmhhcyhrZXlWYWx1ZSkpIHsKICAgICAgICBleGl0W2ldID0gbm9kZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlQnlLZXlWYWx1ZS5zZXQoa2V5VmFsdWUsIG5vZGUpOwogICAgICB9CiAgICB9CiAgfQogIGZvciAoaSA9IDA7IGkgPCBkYXRhTGVuZ3RoOyArK2kpIHsKICAgIGtleVZhbHVlID0ga2V5LmNhbGwocGFyZW50LCBkYXRhW2ldLCBpLCBkYXRhKSArICIiOwogICAgaWYgKG5vZGUgPSBub2RlQnlLZXlWYWx1ZS5nZXQoa2V5VmFsdWUpKSB7CiAgICAgIHVwZGF0ZVtpXSA9IG5vZGU7CiAgICAgIG5vZGUuX19kYXRhX18gPSBkYXRhW2ldOwogICAgICBub2RlQnlLZXlWYWx1ZS5kZWxldGUoa2V5VmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgZW50ZXJbaV0gPSBuZXcgRW50ZXJOb2RlKHBhcmVudCwgZGF0YVtpXSk7CiAgICB9CiAgfQogIGZvciAoaSA9IDA7IGkgPCBncm91cExlbmd0aDsgKytpKSB7CiAgICBpZiAoKG5vZGUgPSBncm91cFtpXSkgJiYgbm9kZUJ5S2V5VmFsdWUuZ2V0KGtleVZhbHVlc1tpXSkgPT09IG5vZGUpIHsKICAgICAgZXhpdFtpXSA9IG5vZGU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGRhdHVtKG5vZGUpIHsKICByZXR1cm4gbm9kZS5fX2RhdGFfXzsKfQpmdW5jdGlvbiBkYXRhX2RlZmF1bHQodmFsdWUsIGtleSkgewogIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIEFycmF5LmZyb20odGhpcywgZGF0dW0pOwogIHZhciBiaW5kID0ga2V5ID8gYmluZEtleSA6IGJpbmRJbmRleCwgcGFyZW50cyA9IHRoaXMuX3BhcmVudHMsIGdyb3VwcyA9IHRoaXMuX2dyb3VwczsKICBpZiAodHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iKSB2YWx1ZSA9IGNvbnN0YW50X2RlZmF1bHQyKHZhbHVlKTsKICBmb3IgKHZhciBtID0gZ3JvdXBzLmxlbmd0aCwgdXBkYXRlID0gbmV3IEFycmF5KG0pLCBlbnRlciA9IG5ldyBBcnJheShtKSwgZXhpdCA9IG5ldyBBcnJheShtKSwgaiA9IDA7IGogPCBtOyArK2opIHsKICAgIHZhciBwYXJlbnQgPSBwYXJlbnRzW2pdLCBncm91cCA9IGdyb3Vwc1tqXSwgZ3JvdXBMZW5ndGggPSBncm91cC5sZW5ndGgsIGRhdGEgPSBhcnJheWxpa2UodmFsdWUuY2FsbChwYXJlbnQsIHBhcmVudCAmJiBwYXJlbnQuX19kYXRhX18sIGosIHBhcmVudHMpKSwgZGF0YUxlbmd0aCA9IGRhdGEubGVuZ3RoLCBlbnRlckdyb3VwID0gZW50ZXJbal0gPSBuZXcgQXJyYXkoZGF0YUxlbmd0aCksIHVwZGF0ZUdyb3VwID0gdXBkYXRlW2pdID0gbmV3IEFycmF5KGRhdGFMZW5ndGgpLCBleGl0R3JvdXAgPSBleGl0W2pdID0gbmV3IEFycmF5KGdyb3VwTGVuZ3RoKTsKICAgIGJpbmQocGFyZW50LCBncm91cCwgZW50ZXJHcm91cCwgdXBkYXRlR3JvdXAsIGV4aXRHcm91cCwgZGF0YSwga2V5KTsKICAgIGZvciAodmFyIGkwID0gMCwgaTEgPSAwLCBwcmV2aW91cywgbmV4dDsgaTAgPCBkYXRhTGVuZ3RoOyArK2kwKSB7CiAgICAgIGlmIChwcmV2aW91cyA9IGVudGVyR3JvdXBbaTBdKSB7CiAgICAgICAgaWYgKGkwID49IGkxKSBpMSA9IGkwICsgMTsKICAgICAgICB3aGlsZSAoIShuZXh0ID0gdXBkYXRlR3JvdXBbaTFdKSAmJiArK2kxIDwgZGF0YUxlbmd0aCkgOwogICAgICAgIHByZXZpb3VzLl9uZXh0ID0gbmV4dCB8fCBudWxsOwogICAgICB9CiAgICB9CiAgfQogIHVwZGF0ZSA9IG5ldyBTZWxlY3Rpb24odXBkYXRlLCBwYXJlbnRzKTsKICB1cGRhdGUuX2VudGVyID0gZW50ZXI7CiAgdXBkYXRlLl9leGl0ID0gZXhpdDsKICByZXR1cm4gdXBkYXRlOwp9CmZ1bmN0aW9uIGFycmF5bGlrZShkYXRhKSB7CiAgcmV0dXJuIHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiAibGVuZ3RoIiBpbiBkYXRhID8gZGF0YSA6IEFycmF5LmZyb20oZGF0YSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9leGl0LmpzCmZ1bmN0aW9uIGV4aXRfZGVmYXVsdCgpIHsKICByZXR1cm4gbmV3IFNlbGVjdGlvbih0aGlzLl9leGl0IHx8IHRoaXMuX2dyb3Vwcy5tYXAoc3BhcnNlX2RlZmF1bHQpLCB0aGlzLl9wYXJlbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2pvaW4uanMKZnVuY3Rpb24gam9pbl9kZWZhdWx0KG9uZW50ZXIsIG9udXBkYXRlLCBvbmV4aXQpIHsKICB2YXIgZW50ZXIgPSB0aGlzLmVudGVyKCksIHVwZGF0ZSA9IHRoaXMsIGV4aXQgPSB0aGlzLmV4aXQoKTsKICBpZiAodHlwZW9mIG9uZW50ZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgIGVudGVyID0gb25lbnRlcihlbnRlcik7CiAgICBpZiAoZW50ZXIpIGVudGVyID0gZW50ZXIuc2VsZWN0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGVudGVyID0gZW50ZXIuYXBwZW5kKG9uZW50ZXIgKyAiIik7CiAgfQogIGlmIChvbnVwZGF0ZSAhPSBudWxsKSB7CiAgICB1cGRhdGUgPSBvbnVwZGF0ZSh1cGRhdGUpOwogICAgaWYgKHVwZGF0ZSkgdXBkYXRlID0gdXBkYXRlLnNlbGVjdGlvbigpOwogIH0KICBpZiAob25leGl0ID09IG51bGwpIGV4aXQucmVtb3ZlKCk7CiAgZWxzZSBvbmV4aXQoZXhpdCk7CiAgcmV0dXJuIGVudGVyICYmIHVwZGF0ZSA/IGVudGVyLm1lcmdlKHVwZGF0ZSkub3JkZXIoKSA6IHVwZGF0ZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL21lcmdlLmpzCmZ1bmN0aW9uIG1lcmdlX2RlZmF1bHQoY29udGV4dCkgewogIHZhciBzZWxlY3Rpb24yID0gY29udGV4dC5zZWxlY3Rpb24gPyBjb250ZXh0LnNlbGVjdGlvbigpIDogY29udGV4dDsKICBmb3IgKHZhciBncm91cHMwID0gdGhpcy5fZ3JvdXBzLCBncm91cHMxID0gc2VsZWN0aW9uMi5fZ3JvdXBzLCBtMCA9IGdyb3VwczAubGVuZ3RoLCBtMSA9IGdyb3VwczEubGVuZ3RoLCBtID0gTWF0aC5taW4obTAsIG0xKSwgbWVyZ2VzID0gbmV3IEFycmF5KG0wKSwgaiA9IDA7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGdyb3VwMCA9IGdyb3VwczBbal0sIGdyb3VwMSA9IGdyb3VwczFbal0sIG4gPSBncm91cDAubGVuZ3RoLCBtZXJnZSA9IG1lcmdlc1tqXSA9IG5ldyBBcnJheShuKSwgbm9kZSwgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgaWYgKG5vZGUgPSBncm91cDBbaV0gfHwgZ3JvdXAxW2ldKSB7CiAgICAgICAgbWVyZ2VbaV0gPSBub2RlOwogICAgICB9CiAgICB9CiAgfQogIGZvciAoOyBqIDwgbTA7ICsraikgewogICAgbWVyZ2VzW2pdID0gZ3JvdXBzMFtqXTsKICB9CiAgcmV0dXJuIG5ldyBTZWxlY3Rpb24obWVyZ2VzLCB0aGlzLl9wYXJlbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL29yZGVyLmpzCmZ1bmN0aW9uIG9yZGVyX2RlZmF1bHQoKSB7CiAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBqID0gLTEsIG0gPSBncm91cHMubGVuZ3RoOyArK2ogPCBtOyApIHsKICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBpID0gZ3JvdXAubGVuZ3RoIC0gMSwgbmV4dCA9IGdyb3VwW2ldLCBub2RlOyAtLWkgPj0gMDsgKSB7CiAgICAgIGlmIChub2RlID0gZ3JvdXBbaV0pIHsKICAgICAgICBpZiAobmV4dCAmJiBub2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5leHQpIF4gNCkgbmV4dC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCBuZXh0KTsKICAgICAgICBuZXh0ID0gbm9kZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gdGhpczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL3NvcnQuanMKZnVuY3Rpb24gc29ydF9kZWZhdWx0KGNvbXBhcmUpIHsKICBpZiAoIWNvbXBhcmUpIGNvbXBhcmUgPSBhc2NlbmRpbmcyOwogIGZ1bmN0aW9uIGNvbXBhcmVOb2RlKGEsIGIpIHsKICAgIHJldHVybiBhICYmIGIgPyBjb21wYXJlKGEuX19kYXRhX18sIGIuX19kYXRhX18pIDogIWEgLSAhYjsKICB9CiAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBtID0gZ3JvdXBzLmxlbmd0aCwgc29ydGdyb3VwcyA9IG5ldyBBcnJheShtKSwgaiA9IDA7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBuID0gZ3JvdXAubGVuZ3RoLCBzb3J0Z3JvdXAgPSBzb3J0Z3JvdXBzW2pdID0gbmV3IEFycmF5KG4pLCBub2RlLCBpID0gMDsgaSA8IG47ICsraSkgewogICAgICBpZiAobm9kZSA9IGdyb3VwW2ldKSB7CiAgICAgICAgc29ydGdyb3VwW2ldID0gbm9kZTsKICAgICAgfQogICAgfQogICAgc29ydGdyb3VwLnNvcnQoY29tcGFyZU5vZGUpOwogIH0KICByZXR1cm4gbmV3IFNlbGVjdGlvbihzb3J0Z3JvdXBzLCB0aGlzLl9wYXJlbnRzKS5vcmRlcigpOwp9CmZ1bmN0aW9uIGFzY2VuZGluZzIoYSwgYikgewogIHJldHVybiBhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogYSA+PSBiID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2NhbGwuanMKZnVuY3Rpb24gY2FsbF9kZWZhdWx0KCkgewogIHZhciBjYWxsYmFjayA9IGFyZ3VtZW50c1swXTsKICBhcmd1bWVudHNbMF0gPSB0aGlzOwogIGNhbGxiYWNrLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHRoaXM7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9ub2Rlcy5qcwpmdW5jdGlvbiBub2Rlc19kZWZhdWx0KCkgewogIHJldHVybiBBcnJheS5mcm9tKHRoaXMpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vbm9kZS5qcwpmdW5jdGlvbiBub2RlX2RlZmF1bHQoKSB7CiAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBqID0gMCwgbSA9IGdyb3Vwcy5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBpID0gMCwgbiA9IGdyb3VwLmxlbmd0aDsgaSA8IG47ICsraSkgewogICAgICB2YXIgbm9kZSA9IGdyb3VwW2ldOwogICAgICBpZiAobm9kZSkgcmV0dXJuIG5vZGU7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vc2l6ZS5qcwpmdW5jdGlvbiBzaXplX2RlZmF1bHQoKSB7CiAgbGV0IHNpemUgPSAwOwogIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzKSArK3NpemU7CiAgcmV0dXJuIHNpemU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9lbXB0eS5qcwpmdW5jdGlvbiBlbXB0eV9kZWZhdWx0KCkgewogIHJldHVybiAhdGhpcy5ub2RlKCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9lYWNoLmpzCmZ1bmN0aW9uIGVhY2hfZGVmYXVsdChjYWxsYmFjaykgewogIGZvciAodmFyIGdyb3VwcyA9IHRoaXMuX2dyb3VwcywgaiA9IDAsIG0gPSBncm91cHMubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBncm91cCA9IGdyb3Vwc1tqXSwgaSA9IDAsIG4gPSBncm91cC5sZW5ndGgsIG5vZGU7IGkgPCBuOyArK2kpIHsKICAgICAgaWYgKG5vZGUgPSBncm91cFtpXSkgY2FsbGJhY2suY2FsbChub2RlLCBub2RlLl9fZGF0YV9fLCBpLCBncm91cCk7CiAgICB9CiAgfQogIHJldHVybiB0aGlzOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vYXR0ci5qcwpmdW5jdGlvbiBhdHRyUmVtb3ZlKG5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICB9Owp9CmZ1bmN0aW9uIGF0dHJSZW1vdmVOUyhmdWxsbmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlTlMoZnVsbG5hbWUuc3BhY2UsIGZ1bGxuYW1lLmxvY2FsKTsKICB9Owp9CmZ1bmN0aW9uIGF0dHJDb25zdGFudChuYW1lLCB2YWx1ZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICB9Owp9CmZ1bmN0aW9uIGF0dHJDb25zdGFudE5TKGZ1bGxuYW1lLCB2YWx1ZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2V0QXR0cmlidXRlTlMoZnVsbG5hbWUuc3BhY2UsIGZ1bGxuYW1lLmxvY2FsLCB2YWx1ZSk7CiAgfTsKfQpmdW5jdGlvbiBhdHRyRnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgdiA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAodiA9PSBudWxsKSB0aGlzLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICAgIGVsc2UgdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgdik7CiAgfTsKfQpmdW5jdGlvbiBhdHRyRnVuY3Rpb25OUyhmdWxsbmFtZSwgdmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgdiA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAodiA9PSBudWxsKSB0aGlzLnJlbW92ZUF0dHJpYnV0ZU5TKGZ1bGxuYW1lLnNwYWNlLCBmdWxsbmFtZS5sb2NhbCk7CiAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlTlMoZnVsbG5hbWUuc3BhY2UsIGZ1bGxuYW1lLmxvY2FsLCB2KTsKICB9Owp9CmZ1bmN0aW9uIGF0dHJfZGVmYXVsdChuYW1lLCB2YWx1ZSkgewogIHZhciBmdWxsbmFtZSA9IG5hbWVzcGFjZV9kZWZhdWx0KG5hbWUpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgdmFyIG5vZGUgPSB0aGlzLm5vZGUoKTsKICAgIHJldHVybiBmdWxsbmFtZS5sb2NhbCA/IG5vZGUuZ2V0QXR0cmlidXRlTlMoZnVsbG5hbWUuc3BhY2UsIGZ1bGxuYW1lLmxvY2FsKSA6IG5vZGUuZ2V0QXR0cmlidXRlKGZ1bGxuYW1lKTsKICB9CiAgcmV0dXJuIHRoaXMuZWFjaCgodmFsdWUgPT0gbnVsbCA/IGZ1bGxuYW1lLmxvY2FsID8gYXR0clJlbW92ZU5TIDogYXR0clJlbW92ZSA6IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIiA/IGZ1bGxuYW1lLmxvY2FsID8gYXR0ckZ1bmN0aW9uTlMgOiBhdHRyRnVuY3Rpb24gOiBmdWxsbmFtZS5sb2NhbCA/IGF0dHJDb25zdGFudE5TIDogYXR0ckNvbnN0YW50KShmdWxsbmFtZSwgdmFsdWUpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvd2luZG93LmpzCmZ1bmN0aW9uIHdpbmRvd19kZWZhdWx0KG5vZGUpIHsKICByZXR1cm4gbm9kZS5vd25lckRvY3VtZW50ICYmIG5vZGUub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCBub2RlLmRvY3VtZW50ICYmIG5vZGUgfHwgbm9kZS5kZWZhdWx0VmlldzsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL3N0eWxlLmpzCmZ1bmN0aW9uIHN0eWxlUmVtb3ZlKG5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB0aGlzLnN0eWxlLnJlbW92ZVByb3BlcnR5KG5hbWUpOwogIH07Cn0KZnVuY3Rpb24gc3R5bGVDb25zdGFudChuYW1lLCB2YWx1ZSwgcHJpb3JpdHkpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB0aGlzLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbHVlLCBwcmlvcml0eSk7CiAgfTsKfQpmdW5jdGlvbiBzdHlsZUZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBwcmlvcml0eSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciB2ID0gdmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmICh2ID09IG51bGwpIHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkobmFtZSk7CiAgICBlbHNlIHRoaXMuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdiwgcHJpb3JpdHkpOwogIH07Cn0KZnVuY3Rpb24gc3R5bGVfZGVmYXVsdChuYW1lLCB2YWx1ZSwgcHJpb3JpdHkpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyB0aGlzLmVhY2goKHZhbHVlID09IG51bGwgPyBzdHlsZVJlbW92ZSA6IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIiA/IHN0eWxlRnVuY3Rpb24gOiBzdHlsZUNvbnN0YW50KShuYW1lLCB2YWx1ZSwgcHJpb3JpdHkgPT0gbnVsbCA/ICIiIDogcHJpb3JpdHkpKSA6IHN0eWxlVmFsdWUodGhpcy5ub2RlKCksIG5hbWUpOwp9CmZ1bmN0aW9uIHN0eWxlVmFsdWUobm9kZSwgbmFtZSkgewogIHJldHVybiBub2RlLnN0eWxlLmdldFByb3BlcnR5VmFsdWUobmFtZSkgfHwgd2luZG93X2RlZmF1bHQobm9kZSkuZ2V0Q29tcHV0ZWRTdHlsZShub2RlLCBudWxsKS5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vcHJvcGVydHkuanMKZnVuY3Rpb24gcHJvcGVydHlSZW1vdmUobmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogIH07Cn0KZnVuY3Rpb24gcHJvcGVydHlDb25zdGFudChuYW1lLCB2YWx1ZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHRoaXNbbmFtZV0gPSB2YWx1ZTsKICB9Owp9CmZ1bmN0aW9uIHByb3BlcnR5RnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgdiA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAodiA9PSBudWxsKSBkZWxldGUgdGhpc1tuYW1lXTsKICAgIGVsc2UgdGhpc1tuYW1lXSA9IHY7CiAgfTsKfQpmdW5jdGlvbiBwcm9wZXJ0eV9kZWZhdWx0KG5hbWUsIHZhbHVlKSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAxID8gdGhpcy5lYWNoKCh2YWx1ZSA9PSBudWxsID8gcHJvcGVydHlSZW1vdmUgOiB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyBwcm9wZXJ0eUZ1bmN0aW9uIDogcHJvcGVydHlDb25zdGFudCkobmFtZSwgdmFsdWUpKSA6IHRoaXMubm9kZSgpW25hbWVdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vY2xhc3NlZC5qcwpmdW5jdGlvbiBjbGFzc0FycmF5KHN0cmluZykgewogIHJldHVybiBzdHJpbmcudHJpbSgpLnNwbGl0KC9efFxzKy8pOwp9CmZ1bmN0aW9uIGNsYXNzTGlzdChub2RlKSB7CiAgcmV0dXJuIG5vZGUuY2xhc3NMaXN0IHx8IG5ldyBDbGFzc0xpc3Qobm9kZSk7Cn0KZnVuY3Rpb24gQ2xhc3NMaXN0KG5vZGUpIHsKICB0aGlzLl9ub2RlID0gbm9kZTsKICB0aGlzLl9uYW1lcyA9IGNsYXNzQXJyYXkobm9kZS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIpOwp9CkNsYXNzTGlzdC5wcm90b3R5cGUgPSB7CiAgYWRkOiBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgaSA9IHRoaXMuX25hbWVzLmluZGV4T2YobmFtZSk7CiAgICBpZiAoaSA8IDApIHsKICAgICAgdGhpcy5fbmFtZXMucHVzaChuYW1lKTsKICAgICAgdGhpcy5fbm9kZS5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgdGhpcy5fbmFtZXMuam9pbigiICIpKTsKICAgIH0KICB9LAogIHJlbW92ZTogZnVuY3Rpb24obmFtZSkgewogICAgdmFyIGkgPSB0aGlzLl9uYW1lcy5pbmRleE9mKG5hbWUpOwogICAgaWYgKGkgPj0gMCkgewogICAgICB0aGlzLl9uYW1lcy5zcGxpY2UoaSwgMSk7CiAgICAgIHRoaXMuX25vZGUuc2V0QXR0cmlidXRlKCJjbGFzcyIsIHRoaXMuX25hbWVzLmpvaW4oIiAiKSk7CiAgICB9CiAgfSwKICBjb250YWluczogZnVuY3Rpb24obmFtZSkgewogICAgcmV0dXJuIHRoaXMuX25hbWVzLmluZGV4T2YobmFtZSkgPj0gMDsKICB9Cn07CmZ1bmN0aW9uIGNsYXNzZWRBZGQobm9kZSwgbmFtZXMpIHsKICB2YXIgbGlzdDIgPSBjbGFzc0xpc3Qobm9kZSksIGkgPSAtMSwgbiA9IG5hbWVzLmxlbmd0aDsKICB3aGlsZSAoKytpIDwgbikgbGlzdDIuYWRkKG5hbWVzW2ldKTsKfQpmdW5jdGlvbiBjbGFzc2VkUmVtb3ZlKG5vZGUsIG5hbWVzKSB7CiAgdmFyIGxpc3QyID0gY2xhc3NMaXN0KG5vZGUpLCBpID0gLTEsIG4gPSBuYW1lcy5sZW5ndGg7CiAgd2hpbGUgKCsraSA8IG4pIGxpc3QyLnJlbW92ZShuYW1lc1tpXSk7Cn0KZnVuY3Rpb24gY2xhc3NlZFRydWUobmFtZXMpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICBjbGFzc2VkQWRkKHRoaXMsIG5hbWVzKTsKICB9Owp9CmZ1bmN0aW9uIGNsYXNzZWRGYWxzZShuYW1lcykgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIGNsYXNzZWRSZW1vdmUodGhpcywgbmFtZXMpOwogIH07Cn0KZnVuY3Rpb24gY2xhc3NlZEZ1bmN0aW9uKG5hbWVzLCB2YWx1ZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgICh2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpID8gY2xhc3NlZEFkZCA6IGNsYXNzZWRSZW1vdmUpKHRoaXMsIG5hbWVzKTsKICB9Owp9CmZ1bmN0aW9uIGNsYXNzZWRfZGVmYXVsdChuYW1lLCB2YWx1ZSkgewogIHZhciBuYW1lcyA9IGNsYXNzQXJyYXkobmFtZSArICIiKTsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgIHZhciBsaXN0MiA9IGNsYXNzTGlzdCh0aGlzLm5vZGUoKSksIGkgPSAtMSwgbiA9IG5hbWVzLmxlbmd0aDsKICAgIHdoaWxlICgrK2kgPCBuKSBpZiAoIWxpc3QyLmNvbnRhaW5zKG5hbWVzW2ldKSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiB0aGlzLmVhY2goKHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIiA/IGNsYXNzZWRGdW5jdGlvbiA6IHZhbHVlID8gY2xhc3NlZFRydWUgOiBjbGFzc2VkRmFsc2UpKG5hbWVzLCB2YWx1ZSkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vdGV4dC5qcwpmdW5jdGlvbiB0ZXh0UmVtb3ZlKCkgewogIHRoaXMudGV4dENvbnRlbnQgPSAiIjsKfQpmdW5jdGlvbiB0ZXh0Q29uc3RhbnQodmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB0aGlzLnRleHRDb250ZW50ID0gdmFsdWU7CiAgfTsKfQpmdW5jdGlvbiB0ZXh0RnVuY3Rpb24odmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgdiA9IHZhbHVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLnRleHRDb250ZW50ID0gdiA9PSBudWxsID8gIiIgOiB2OwogIH07Cn0KZnVuY3Rpb24gdGV4dF9kZWZhdWx0KHZhbHVlKSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyB0aGlzLmVhY2godmFsdWUgPT0gbnVsbCA/IHRleHRSZW1vdmUgOiAodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iID8gdGV4dEZ1bmN0aW9uIDogdGV4dENvbnN0YW50KSh2YWx1ZSkpIDogdGhpcy5ub2RlKCkudGV4dENvbnRlbnQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9odG1sLmpzCmZ1bmN0aW9uIGh0bWxSZW1vdmUoKSB7CiAgdGhpcy5pbm5lckhUTUwgPSAiIjsKfQpmdW5jdGlvbiBodG1sQ29uc3RhbnQodmFsdWUpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmlubmVySFRNTCA9IHZhbHVlOwogIH07Cn0KZnVuY3Rpb24gaHRtbEZ1bmN0aW9uKHZhbHVlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIHYgPSB2YWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5pbm5lckhUTUwgPSB2ID09IG51bGwgPyAiIiA6IHY7CiAgfTsKfQpmdW5jdGlvbiBodG1sX2RlZmF1bHQodmFsdWUpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRoaXMuZWFjaCh2YWx1ZSA9PSBudWxsID8gaHRtbFJlbW92ZSA6ICh0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgPyBodG1sRnVuY3Rpb24gOiBodG1sQ29uc3RhbnQpKHZhbHVlKSkgOiB0aGlzLm5vZGUoKS5pbm5lckhUTUw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9yYWlzZS5qcwpmdW5jdGlvbiByYWlzZSgpIHsKICBpZiAodGhpcy5uZXh0U2libGluZykgdGhpcy5wYXJlbnROb2RlLmFwcGVuZENoaWxkKHRoaXMpOwp9CmZ1bmN0aW9uIHJhaXNlX2RlZmF1bHQoKSB7CiAgcmV0dXJuIHRoaXMuZWFjaChyYWlzZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9sb3dlci5qcwpmdW5jdGlvbiBsb3dlcigpIHsKICBpZiAodGhpcy5wcmV2aW91c1NpYmxpbmcpIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcywgdGhpcy5wYXJlbnROb2RlLmZpcnN0Q2hpbGQpOwp9CmZ1bmN0aW9uIGxvd2VyX2RlZmF1bHQoKSB7CiAgcmV0dXJuIHRoaXMuZWFjaChsb3dlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9hcHBlbmQuanMKZnVuY3Rpb24gYXBwZW5kX2RlZmF1bHQobmFtZSkgewogIHZhciBjcmVhdGUyID0gdHlwZW9mIG5hbWUgPT09ICJmdW5jdGlvbiIgPyBuYW1lIDogY3JlYXRvcl9kZWZhdWx0KG5hbWUpOwogIHJldHVybiB0aGlzLnNlbGVjdChmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmFwcGVuZENoaWxkKGNyZWF0ZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9pbnNlcnQuanMKZnVuY3Rpb24gY29uc3RhbnROdWxsKCkgewogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGluc2VydF9kZWZhdWx0KG5hbWUsIGJlZm9yZSkgewogIHZhciBjcmVhdGUyID0gdHlwZW9mIG5hbWUgPT09ICJmdW5jdGlvbiIgPyBuYW1lIDogY3JlYXRvcl9kZWZhdWx0KG5hbWUpLCBzZWxlY3QgPSBiZWZvcmUgPT0gbnVsbCA/IGNvbnN0YW50TnVsbCA6IHR5cGVvZiBiZWZvcmUgPT09ICJmdW5jdGlvbiIgPyBiZWZvcmUgOiBzZWxlY3Rvcl9kZWZhdWx0KGJlZm9yZSk7CiAgcmV0dXJuIHRoaXMuc2VsZWN0KGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuaW5zZXJ0QmVmb3JlKGNyZWF0ZTIuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgc2VsZWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgbnVsbCk7CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zZWxlY3Rpb24vc3JjL3NlbGVjdGlvbi9yZW1vdmUuanMKZnVuY3Rpb24gcmVtb3ZlKCkgewogIHZhciBwYXJlbnQgPSB0aGlzLnBhcmVudE5vZGU7CiAgaWYgKHBhcmVudCkgcGFyZW50LnJlbW92ZUNoaWxkKHRoaXMpOwp9CmZ1bmN0aW9uIHJlbW92ZV9kZWZhdWx0KCkgewogIHJldHVybiB0aGlzLmVhY2gocmVtb3ZlKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2Nsb25lLmpzCmZ1bmN0aW9uIHNlbGVjdGlvbl9jbG9uZVNoYWxsb3coKSB7CiAgdmFyIGNsb25lMiA9IHRoaXMuY2xvbmVOb2RlKGZhbHNlKSwgcGFyZW50ID0gdGhpcy5wYXJlbnROb2RlOwogIHJldHVybiBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNsb25lMiwgdGhpcy5uZXh0U2libGluZykgOiBjbG9uZTI7Cn0KZnVuY3Rpb24gc2VsZWN0aW9uX2Nsb25lRGVlcCgpIHsKICB2YXIgY2xvbmUyID0gdGhpcy5jbG9uZU5vZGUodHJ1ZSksIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKICByZXR1cm4gcGFyZW50ID8gcGFyZW50Lmluc2VydEJlZm9yZShjbG9uZTIsIHRoaXMubmV4dFNpYmxpbmcpIDogY2xvbmUyOwp9CmZ1bmN0aW9uIGNsb25lX2RlZmF1bHQoZGVlcCkgewogIHJldHVybiB0aGlzLnNlbGVjdChkZWVwID8gc2VsZWN0aW9uX2Nsb25lRGVlcCA6IHNlbGVjdGlvbl9jbG9uZVNoYWxsb3cpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZGF0dW0uanMKZnVuY3Rpb24gZGF0dW1fZGVmYXVsdCh2YWx1ZSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gdGhpcy5wcm9wZXJ0eSgiX19kYXRhX18iLCB2YWx1ZSkgOiB0aGlzLm5vZGUoKS5fX2RhdGFfXzsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL29uLmpzCmZ1bmN0aW9uIGNvbnRleHRMaXN0ZW5lcihsaXN0ZW5lcikgewogIHJldHVybiBmdW5jdGlvbihldmVudCkgewogICAgbGlzdGVuZXIuY2FsbCh0aGlzLCBldmVudCwgdGhpcy5fX2RhdGFfXyk7CiAgfTsKfQpmdW5jdGlvbiBwYXJzZVR5cGVuYW1lcyh0eXBlbmFtZXMpIHsKICByZXR1cm4gdHlwZW5hbWVzLnRyaW0oKS5zcGxpdCgvXnxccysvKS5tYXAoZnVuY3Rpb24odCkgewogICAgdmFyIG5hbWUgPSAiIiwgaSA9IHQuaW5kZXhPZigiLiIpOwogICAgaWYgKGkgPj0gMCkgbmFtZSA9IHQuc2xpY2UoaSArIDEpLCB0ID0gdC5zbGljZSgwLCBpKTsKICAgIHJldHVybiB7IHR5cGU6IHQsIG5hbWUgfTsKICB9KTsKfQpmdW5jdGlvbiBvblJlbW92ZSh0eXBlbmFtZSkgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBvbiA9IHRoaXMuX19vbjsKICAgIGlmICghb24pIHJldHVybjsKICAgIGZvciAodmFyIGogPSAwLCBpID0gLTEsIG0gPSBvbi5sZW5ndGgsIG87IGogPCBtOyArK2opIHsKICAgICAgaWYgKG8gPSBvbltqXSwgKCF0eXBlbmFtZS50eXBlIHx8IG8udHlwZSA9PT0gdHlwZW5hbWUudHlwZSkgJiYgby5uYW1lID09PSB0eXBlbmFtZS5uYW1lKSB7CiAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKG8udHlwZSwgby5saXN0ZW5lciwgby5vcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvblsrK2ldID0gbzsKICAgICAgfQogICAgfQogICAgaWYgKCsraSkgb24ubGVuZ3RoID0gaTsKICAgIGVsc2UgZGVsZXRlIHRoaXMuX19vbjsKICB9Owp9CmZ1bmN0aW9uIG9uQWRkKHR5cGVuYW1lLCB2YWx1ZSwgb3B0aW9ucykgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBvbiA9IHRoaXMuX19vbiwgbywgbGlzdGVuZXIgPSBjb250ZXh0TGlzdGVuZXIodmFsdWUpOwogICAgaWYgKG9uKSBmb3IgKHZhciBqID0gMCwgbSA9IG9uLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgICBpZiAoKG8gPSBvbltqXSkudHlwZSA9PT0gdHlwZW5hbWUudHlwZSAmJiBvLm5hbWUgPT09IHR5cGVuYW1lLm5hbWUpIHsKICAgICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoby50eXBlLCBvLmxpc3RlbmVyLCBvLm9wdGlvbnMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihvLnR5cGUsIG8ubGlzdGVuZXIgPSBsaXN0ZW5lciwgby5vcHRpb25zID0gb3B0aW9ucyk7CiAgICAgICAgby52YWx1ZSA9IHZhbHVlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGVuYW1lLnR5cGUsIGxpc3RlbmVyLCBvcHRpb25zKTsKICAgIG8gPSB7IHR5cGU6IHR5cGVuYW1lLnR5cGUsIG5hbWU6IHR5cGVuYW1lLm5hbWUsIHZhbHVlLCBsaXN0ZW5lciwgb3B0aW9ucyB9OwogICAgaWYgKCFvbikgdGhpcy5fX29uID0gW29dOwogICAgZWxzZSBvbi5wdXNoKG8pOwogIH07Cn0KZnVuY3Rpb24gb25fZGVmYXVsdCh0eXBlbmFtZSwgdmFsdWUsIG9wdGlvbnMpIHsKICB2YXIgdHlwZW5hbWVzID0gcGFyc2VUeXBlbmFtZXModHlwZW5hbWUgKyAiIiksIGksIG4gPSB0eXBlbmFtZXMubGVuZ3RoLCB0OwogIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgdmFyIG9uID0gdGhpcy5ub2RlKCkuX19vbjsKICAgIGlmIChvbikgZm9yICh2YXIgaiA9IDAsIG0gPSBvbi5sZW5ndGgsIG87IGogPCBtOyArK2opIHsKICAgICAgZm9yIChpID0gMCwgbyA9IG9uW2pdOyBpIDwgbjsgKytpKSB7CiAgICAgICAgaWYgKCh0ID0gdHlwZW5hbWVzW2ldKS50eXBlID09PSBvLnR5cGUgJiYgdC5uYW1lID09PSBvLm5hbWUpIHsKICAgICAgICAgIHJldHVybiBvLnZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuOwogIH0KICBvbiA9IHZhbHVlID8gb25BZGQgOiBvblJlbW92ZTsKICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB0aGlzLmVhY2gob24odHlwZW5hbWVzW2ldLCB2YWx1ZSwgb3B0aW9ucykpOwogIHJldHVybiB0aGlzOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vZGlzcGF0Y2guanMKZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChub2RlLCB0eXBlLCBwYXJhbXMpIHsKICB2YXIgd2luZG93MiA9IHdpbmRvd19kZWZhdWx0KG5vZGUpLCBldmVudCA9IHdpbmRvdzIuQ3VzdG9tRXZlbnQ7CiAgaWYgKHR5cGVvZiBldmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgZXZlbnQgPSBuZXcgZXZlbnQodHlwZSwgcGFyYW1zKTsKICB9IGVsc2UgewogICAgZXZlbnQgPSB3aW5kb3cyLmRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgaWYgKHBhcmFtcykgZXZlbnQuaW5pdEV2ZW50KHR5cGUsIHBhcmFtcy5idWJibGVzLCBwYXJhbXMuY2FuY2VsYWJsZSksIGV2ZW50LmRldGFpbCA9IHBhcmFtcy5kZXRhaWw7CiAgICBlbHNlIGV2ZW50LmluaXRFdmVudCh0eXBlLCBmYWxzZSwgZmFsc2UpOwogIH0KICBub2RlLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwp9CmZ1bmN0aW9uIGRpc3BhdGNoQ29uc3RhbnQodHlwZSwgcGFyYW1zKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRpc3BhdGNoRXZlbnQodGhpcywgdHlwZSwgcGFyYW1zKTsKICB9Owp9CmZ1bmN0aW9uIGRpc3BhdGNoRnVuY3Rpb24odHlwZSwgcGFyYW1zKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRpc3BhdGNoRXZlbnQodGhpcywgdHlwZSwgcGFyYW1zLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogIH07Cn0KZnVuY3Rpb24gZGlzcGF0Y2hfZGVmYXVsdCh0eXBlLCBwYXJhbXMpIHsKICByZXR1cm4gdGhpcy5lYWNoKCh0eXBlb2YgcGFyYW1zID09PSAiZnVuY3Rpb24iID8gZGlzcGF0Y2hGdW5jdGlvbiA6IGRpc3BhdGNoQ29uc3RhbnQpKHR5cGUsIHBhcmFtcykpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3Rpb24vaXRlcmF0b3IuanMKZnVuY3Rpb24qIGl0ZXJhdG9yX2RlZmF1bHQoKSB7CiAgZm9yICh2YXIgZ3JvdXBzID0gdGhpcy5fZ3JvdXBzLCBqID0gMCwgbSA9IGdyb3Vwcy5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGdyb3VwID0gZ3JvdXBzW2pdLCBpID0gMCwgbiA9IGdyb3VwLmxlbmd0aCwgbm9kZTsgaSA8IG47ICsraSkgewogICAgICBpZiAobm9kZSA9IGdyb3VwW2ldKSB5aWVsZCBub2RlOwogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNlbGVjdGlvbi9zcmMvc2VsZWN0aW9uL2luZGV4LmpzCnZhciByb290ID0gW251bGxdOwpmdW5jdGlvbiBTZWxlY3Rpb24oZ3JvdXBzLCBwYXJlbnRzKSB7CiAgdGhpcy5fZ3JvdXBzID0gZ3JvdXBzOwogIHRoaXMuX3BhcmVudHMgPSBwYXJlbnRzOwp9CmZ1bmN0aW9uIHNlbGVjdGlvbigpIHsKICByZXR1cm4gbmV3IFNlbGVjdGlvbihbW2RvY3VtZW50LmRvY3VtZW50RWxlbWVudF1dLCByb290KTsKfQpmdW5jdGlvbiBzZWxlY3Rpb25fc2VsZWN0aW9uKCkgewogIHJldHVybiB0aGlzOwp9ClNlbGVjdGlvbi5wcm90b3R5cGUgPSBzZWxlY3Rpb24ucHJvdG90eXBlID0gewogIGNvbnN0cnVjdG9yOiBTZWxlY3Rpb24sCiAgc2VsZWN0OiBzZWxlY3RfZGVmYXVsdCwKICBzZWxlY3RBbGw6IHNlbGVjdEFsbF9kZWZhdWx0LAogIHNlbGVjdENoaWxkOiBzZWxlY3RDaGlsZF9kZWZhdWx0LAogIHNlbGVjdENoaWxkcmVuOiBzZWxlY3RDaGlsZHJlbl9kZWZhdWx0LAogIGZpbHRlcjogZmlsdGVyX2RlZmF1bHQsCiAgZGF0YTogZGF0YV9kZWZhdWx0LAogIGVudGVyOiBlbnRlcl9kZWZhdWx0LAogIGV4aXQ6IGV4aXRfZGVmYXVsdCwKICBqb2luOiBqb2luX2RlZmF1bHQsCiAgbWVyZ2U6IG1lcmdlX2RlZmF1bHQsCiAgc2VsZWN0aW9uOiBzZWxlY3Rpb25fc2VsZWN0aW9uLAogIG9yZGVyOiBvcmRlcl9kZWZhdWx0LAogIHNvcnQ6IHNvcnRfZGVmYXVsdCwKICBjYWxsOiBjYWxsX2RlZmF1bHQsCiAgbm9kZXM6IG5vZGVzX2RlZmF1bHQsCiAgbm9kZTogbm9kZV9kZWZhdWx0LAogIHNpemU6IHNpemVfZGVmYXVsdCwKICBlbXB0eTogZW1wdHlfZGVmYXVsdCwKICBlYWNoOiBlYWNoX2RlZmF1bHQsCiAgYXR0cjogYXR0cl9kZWZhdWx0LAogIHN0eWxlOiBzdHlsZV9kZWZhdWx0LAogIHByb3BlcnR5OiBwcm9wZXJ0eV9kZWZhdWx0LAogIGNsYXNzZWQ6IGNsYXNzZWRfZGVmYXVsdCwKICB0ZXh0OiB0ZXh0X2RlZmF1bHQsCiAgaHRtbDogaHRtbF9kZWZhdWx0LAogIHJhaXNlOiByYWlzZV9kZWZhdWx0LAogIGxvd2VyOiBsb3dlcl9kZWZhdWx0LAogIGFwcGVuZDogYXBwZW5kX2RlZmF1bHQsCiAgaW5zZXJ0OiBpbnNlcnRfZGVmYXVsdCwKICByZW1vdmU6IHJlbW92ZV9kZWZhdWx0LAogIGNsb25lOiBjbG9uZV9kZWZhdWx0LAogIGRhdHVtOiBkYXR1bV9kZWZhdWx0LAogIG9uOiBvbl9kZWZhdWx0LAogIGRpc3BhdGNoOiBkaXNwYXRjaF9kZWZhdWx0LAogIFtTeW1ib2wuaXRlcmF0b3JdOiBpdGVyYXRvcl9kZWZhdWx0Cn07CgovLyBub2RlX21vZHVsZXMvZDMtc2VsZWN0aW9uL3NyYy9zZWxlY3QuanMKZnVuY3Rpb24gc2VsZWN0X2RlZmF1bHQyKHNlbGVjdG9yKSB7CiAgcmV0dXJuIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgPyBuZXcgU2VsZWN0aW9uKFtbZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcildXSwgW2RvY3VtZW50LmRvY3VtZW50RWxlbWVudF0pIDogbmV3IFNlbGVjdGlvbihbW3NlbGVjdG9yXV0sIHJvb3QpOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2NvbnN0YW50cy5qcwp2YXIgTUFHSUMgPSBVaW50OEFycmF5Lm9mKDY1LCA4MiwgODIsIDc5LCA4NywgNDkpOwp2YXIgRU9TID0gVWludDhBcnJheS5vZigyNTUsIDI1NSwgMjU1LCAyNTUsIDAsIDAsIDAsIDApOwp2YXIgVmVyc2lvbiA9ICgKICAvKiogQHR5cGUge2NvbnN0fSAqLwogIHsKICAgIC8qKiAwLjEuMCAoT2N0b2JlciAyMDE2KS4gKi8KICAgIFYxOiAwLAogICAgLyoqIDAuMi4wIChGZWJydWFyeSAyMDE3KS4gTm9uLWJhY2t3YXJkcyBjb21wYXRpYmxlIHdpdGggVjEuICovCiAgICBWMjogMSwKICAgIC8qKiAwLjMuMCAtPiAwLjcuMSAoTWF5IC0gRGVjZW1iZXIgMjAxNykuIE5vbi1iYWNrd2FyZHMgY29tcGF0aWJsZSB3aXRoIFYyLiAqLwogICAgVjM6IDIsCiAgICAvKiogPj0gMC44LjAgKERlY2VtYmVyIDIwMTcpLiBOb24tYmFja3dhcmRzIGNvbXBhdGlibGUgd2l0aCBWMy4gKi8KICAgIFY0OiAzLAogICAgLyoqCiAgICAgKiA+PSAxLjAuMCAoSnVseSAyMDIwKS4gQmFja3dhcmRzIGNvbXBhdGlibGUgd2l0aCBWNCAoVjUgcmVhZGVycyBjYW4gcmVhZCBWNAogICAgICogbWV0YWRhdGEgYW5kIElQQyBtZXNzYWdlcykuIEltcGxlbWVudGF0aW9ucyBhcmUgcmVjb21tZW5kZWQgdG8gcHJvdmlkZSBhCiAgICAgKiBWNCBjb21wYXRpYmlsaXR5IG1vZGUgd2l0aCBWNSBmb3JtYXQgY2hhbmdlcyBkaXNhYmxlZC4KICAgICAqCiAgICAgKiBJbmNvbXBhdGlibGUgY2hhbmdlcyBiZXR3ZWVuIFY0IGFuZCBWNToKICAgICAqIC0gVW5pb24gYnVmZmVyIGxheW91dCBoYXMgY2hhbmdlZC4KICAgICAqICAgSW4gVjUsIFVuaW9ucyBkb24ndCBoYXZlIGEgdmFsaWRpdHkgYml0bWFwIGJ1ZmZlci4KICAgICAqLwogICAgVjU6IDQKICB9Cik7CnZhciBNZXNzYWdlSGVhZGVyID0gKAogIC8qKiBAdHlwZSB7Y29uc3R9ICovCiAgewogICAgTk9ORTogMCwKICAgIC8qKgogICAgICogQSBTY2hlbWEgZGVzY3JpYmVzIHRoZSBjb2x1bW5zIGluIGEgcmVjb3JkIGJhdGNoLgogICAgICovCiAgICBTY2hlbWE6IDEsCiAgICAvKioKICAgICAqIEZvciBzZW5kaW5nIGRpY3Rpb25hcnkgZW5jb2RpbmcgaW5mb3JtYXRpb24uIEFueSBGaWVsZCBjYW4gYmUKICAgICAqIGRpY3Rpb25hcnktZW5jb2RlZCwgYnV0IGluIHRoaXMgY2FzZSBub25lIG9mIGl0cyBjaGlsZHJlbiBtYXkgYmUKICAgICAqIGRpY3Rpb25hcnktZW5jb2RlZC4KICAgICAqIFRoZXJlIGlzIG9uZSB2ZWN0b3IgLyBjb2x1bW4gcGVyIGRpY3Rpb25hcnksIGJ1dCB0aGF0IHZlY3RvciAvIGNvbHVtbgogICAgICogbWF5IGJlIHNwcmVhZCBhY3Jvc3MgbXVsdGlwbGUgZGljdGlvbmFyeSBiYXRjaGVzIGJ5IHVzaW5nIHRoZSBpc0RlbHRhCiAgICAgKiBmbGFnLgogICAgICovCiAgICBEaWN0aW9uYXJ5QmF0Y2g6IDIsCiAgICAvKioKICAgICAqIEEgZGF0YSBoZWFkZXIgZGVzY3JpYmluZyB0aGUgc2hhcmVkIG1lbW9yeSBsYXlvdXQgb2YgYSAicmVjb3JkIiBvciAicm93IgogICAgICogYmF0Y2guIFNvbWUgc3lzdGVtcyBjYWxsIHRoaXMgYSAicm93IGJhdGNoIiBpbnRlcm5hbGx5IGFuZCBvdGhlcnMgYSAicmVjb3JkCiAgICAgKiBiYXRjaCIuCiAgICAgKi8KICAgIFJlY29yZEJhdGNoOiAzLAogICAgLyoqCiAgICAgKiBFWFBFUklNRU5UQUw6IE1ldGFkYXRhIGZvciBuLWRpbWVuc2lvbmFsIGFycmF5cywgYWthICJ0ZW5zb3JzIiBvcgogICAgICogIm5kYXJyYXlzIi4gQXJyb3cgaW1wbGVtZW50YXRpb25zIGluIGdlbmVyYWwgYXJlIG5vdCByZXF1aXJlZCB0byBpbXBsZW1lbnQKICAgICAqIHRoaXMgdHlwZS4KICAgICAqCiAgICAgKiBOb3QgY3VycmVudGx5IHN1cHBvcnRlZCBieSBGbGVjaGV0dGUuCiAgICAgKi8KICAgIFRlbnNvcjogNCwKICAgIC8qKgogICAgICogRVhQRVJJTUVOVEFMOiBNZXRhZGF0YSBmb3Igbi1kaW1lbnNpb25hbCBzcGFyc2UgYXJyYXlzLCBha2EgInNwYXJzZQogICAgICogdGVuc29ycyIuIEFycm93IGltcGxlbWVudGF0aW9ucyBpbiBnZW5lcmFsIGFyZSBub3QgcmVxdWlyZWQgdG8gaW1wbGVtZW50CiAgICAgKiB0aGlzIHR5cGUuCiAgICAgKgogICAgICogTm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgYnkgRmxlY2hldHRlLgogICAgICovCiAgICBTcGFyc2VUZW5zb3I6IDUKICB9Cik7CnZhciBUeXBlID0gKAogIC8qKiBAdHlwZSB7Y29uc3R9ICovCiAgewogICAgLyoqCiAgICAgKiBEaWN0aW9uYXJ5IHR5cGVzIGNvbXByZXNzIGRhdGEgYnkgdXNpbmcgYSBzZXQgb2YgaW50ZWdlciBpbmRpY2VzIHRvCiAgICAgKiBsb29rdXAgcG90ZW50aWFsbHkgcmVwZWF0ZWQgdmFsZXMgaW4gYSBzZXBhcmF0ZSBkaWN0aW9uYXJ5IG9mIHZhbHVlcy4KICAgICAqCiAgICAgKiBUaGlzIHR5cGUgZW50cnkgaXMgcHJvdmlkZWQgZm9yIEFQSSBjb252ZW5pZW5jZSwgaXQgZG9lcyBub3Qgb2NjdXIKICAgICAqIGluIGFjdHVhbCBBcnJvdyBJUEMgYmluYXJ5IGRhdGEuCiAgICAgKi8KICAgIERpY3Rpb25hcnk6IC0xLAogICAgLyoqIE5vIGRhdGEgdHlwZS4gSW5jbHVkZWQgZm9yIGZsYXRidWZmZXIgY29tcGF0aWJpbGl0eS4gKi8KICAgIE5PTkU6IDAsCiAgICAvKiogTnVsbCB2YWx1ZXMgb25seS4gKi8KICAgIE51bGw6IDEsCiAgICAvKiogSW50ZWdlcnMsIGVpdGhlciBzaWduZWQgb3IgdW5zaWduZWQsIHdpdGggOCwgMTYsIDMyLCBvciA2NCBiaXQgd2lkdGhzLiAqLwogICAgSW50OiAyLAogICAgLyoqIEZsb2F0aW5nIHBvaW50IG51bWJlcnMgd2l0aCAxNiwgMzIsIG9yIDY0IGJpdCBwcmVjaXNpb24uICovCiAgICBGbG9hdDogMywKICAgIC8qKiBPcGFxdWUgYmluYXJ5IGRhdGEuICovCiAgICBCaW5hcnk6IDQsCiAgICAvKiogVW5pY29kZSB3aXRoIFVURi04IGVuY29kaW5nLiAqLwogICAgVXRmODogNSwKICAgIC8qKiBCb29sZWFucyByZXByZXNlbnRlZCBhcyA4IGJpdCBieXRlcy4gKi8KICAgIEJvb2w6IDYsCiAgICAvKioKICAgICAqIEV4YWN0IGRlY2ltYWwgdmFsdWUgcmVwcmVzZW50ZWQgYXMgYW4gaW50ZWdlciB2YWx1ZSBpbiB0d28ncyBjb21wbGVtZW50LgogICAgICogQ3VycmVudGx5IG9ubHkgMTI4LWJpdCAoMTYtYnl0ZSkgYW5kIDI1Ni1iaXQgKDMyLWJ5dGUpIGludGVnZXJzIGFyZSB1c2VkLgogICAgICogVGhlIHJlcHJlc2VudGF0aW9uIHVzZXMgdGhlIGVuZGlhbm5lc3MgaW5kaWNhdGVkIGluIHRoZSBzY2hlbWEuCiAgICAgKi8KICAgIERlY2ltYWw6IDcsCiAgICAvKioKICAgICAqIERhdGUgaXMgZWl0aGVyIGEgMzItYml0IG9yIDY0LWJpdCBzaWduZWQgaW50ZWdlciB0eXBlIHJlcHJlc2VudGluZyBhbgogICAgICogZWxhcHNlZCB0aW1lIHNpbmNlIFVOSVggZXBvY2ggKDE5NzAtMDEtMDEpLCBzdG9yZWQgaW4gZWl0aGVyIG9mIHR3byB1bml0czoKICAgICAqIC0gTWlsbGlzZWNvbmRzICg2NCBiaXRzKSBpbmRpY2F0aW5nIFVOSVggdGltZSBlbGFwc2VkIHNpbmNlIHRoZSBlcG9jaCAobm8KICAgICAqIGxlYXAgc2Vjb25kcyksIHdoZXJlIHRoZSB2YWx1ZXMgYXJlIGV2ZW5seSBkaXZpc2libGUgYnkgODY0MDAwMDAKICAgICAqIC0gRGF5cyAoMzIgYml0cykgc2luY2UgdGhlIFVOSVggZXBvY2gKICAgICAqLwogICAgRGF0ZTogOCwKICAgIC8qKgogICAgICogVGltZSBpcyBlaXRoZXIgYSAzMi1iaXQgb3IgNjQtYml0IHNpZ25lZCBpbnRlZ2VyIHR5cGUgcmVwcmVzZW50aW5nIGFuCiAgICAgKiBlbGFwc2VkIHRpbWUgc2luY2UgbWlkbmlnaHQsIHN0b3JlZCBpbiBlaXRoZXIgb2YgZm91ciB1bml0czogc2Vjb25kcywKICAgICAqIG1pbGxpc2Vjb25kcywgbWljcm9zZWNvbmRzIG9yIG5hbm9zZWNvbmRzLgogICAgICoKICAgICAqIFRoZSBpbnRlZ2VyIGBiaXRXaWR0aGAgZGVwZW5kcyBvbiB0aGUgYHVuaXRgIGFuZCBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOgogICAgICogLSBTRUNPTkQgYW5kIE1JTExJU0VDT05EOiAzMiBiaXRzCiAgICAgKiAtIE1JQ1JPU0VDT05EIGFuZCBOQU5PU0VDT05EOiA2NCBiaXRzCiAgICAgKgogICAgICogVGhlIGFsbG93ZWQgdmFsdWVzIGFyZSBiZXR3ZWVuIDAgKGluY2x1c2l2ZSkgYW5kIDg2NDAwICg9MjQqNjAqNjApIHNlY29uZHMKICAgICAqIChleGNsdXNpdmUpLCBhZGp1c3RlZCBmb3IgdGhlIHRpbWUgdW5pdCAoZm9yIGV4YW1wbGUsIHVwIHRvIDg2NDAwMDAwCiAgICAgKiBleGNsdXNpdmUgZm9yIHRoZSBNSUxMSVNFQ09ORCB1bml0KS4KICAgICAqIFRoaXMgZGVmaW5pdGlvbiBkb2Vzbid0IGFsbG93IGZvciBsZWFwIHNlY29uZHMuIFRpbWUgdmFsdWVzIGZyb20KICAgICAqIG1lYXN1cmVtZW50cyB3aXRoIGxlYXAgc2Vjb25kcyB3aWxsIG5lZWQgdG8gYmUgY29ycmVjdGVkIHdoZW4gaW5nZXN0aW5nCiAgICAgKiBpbnRvIEFycm93IChmb3IgZXhhbXBsZSBieSByZXBsYWNpbmcgdGhlIHZhbHVlIDg2NDAwIHdpdGggODYzOTkpLgogICAgICovCiAgICBUaW1lOiA5LAogICAgLyoqCiAgICAgKiBUaW1lc3RhbXAgaXMgYSA2NC1iaXQgc2lnbmVkIGludGVnZXIgcmVwcmVzZW50aW5nIGFuIGVsYXBzZWQgdGltZSBzaW5jZSBhCiAgICAgKiBmaXhlZCBlcG9jaCwgc3RvcmVkIGluIGVpdGhlciBvZiBmb3VyIHVuaXRzOiBzZWNvbmRzLCBtaWxsaXNlY29uZHMsCiAgICAgKiBtaWNyb3NlY29uZHMgb3IgbmFub3NlY29uZHMsIGFuZCBpcyBvcHRpb25hbGx5IGFubm90YXRlZCB3aXRoIGEgdGltZXpvbmUuCiAgICAgKgogICAgICogVGltZXN0YW1wIHZhbHVlcyBkbyBub3QgaW5jbHVkZSBhbnkgbGVhcCBzZWNvbmRzIChpbiBvdGhlciB3b3JkcywgYWxsCiAgICAgKiBkYXlzIGFyZSBjb25zaWRlcmVkIDg2NDAwIHNlY29uZHMgbG9uZykuCiAgICAgKgogICAgICogVGhlIHRpbWV6b25lIGlzIGFuIG9wdGlvbmFsIHN0cmluZyBmb3IgdGhlIG5hbWUgb2YgYSB0aW1lem9uZSwgb25lIG9mOgogICAgICoKICAgICAqICAtIEFzIHVzZWQgaW4gdGhlIE9sc29uIHRpbWV6b25lIGRhdGFiYXNlICh0aGUgInR6IGRhdGFiYXNlIiBvcgogICAgICogICAgInR6ZGF0YSIpLCBzdWNoIGFzICJBbWVyaWNhL05ld19Zb3JrIi4KICAgICAqICAtIEFuIGFic29sdXRlIHRpbWV6b25lIG9mZnNldCBvZiB0aGUgZm9ybSAiK1hYOlhYIiBvciAiLVhYOlhYIiwKICAgICAqICAgIHN1Y2ggYXMgIiswNzozMCIuCiAgICAgKgogICAgICogV2hldGhlciBhIHRpbWV6b25lIHN0cmluZyBpcyBwcmVzZW50IGluZGljYXRlcyBkaWZmZXJlbnQgc2VtYW50aWNzIGFib3V0CiAgICAgKiB0aGUgZGF0YS4KICAgICAqLwogICAgVGltZXN0YW1wOiAxMCwKICAgIC8qKgogICAgICogQSAiY2FsZW5kYXIiIGludGVydmFsIHdoaWNoIG1vZGVscyB0eXBlcyB0aGF0IGRvbid0IG5lY2Vzc2FyaWx5CiAgICAgKiBoYXZlIGEgcHJlY2lzZSBkdXJhdGlvbiB3aXRob3V0IHRoZSBjb250ZXh0IG9mIGEgYmFzZSB0aW1lc3RhbXAgKGUuZy4KICAgICAqIGRheXMgY2FuIGRpZmZlciBpbiBsZW5ndGggZHVyaW5nIGRheSBsaWdodCBzYXZpbmdzIHRpbWUgdHJhbnNpdGlvbnMpLgogICAgICogQWxsIGludGVnZXJzIGluIHRoZSB1bml0cyBiZWxvdyBhcmUgc3RvcmVkIGluIHRoZSBlbmRpYW5uZXNzIGluZGljYXRlZAogICAgICogYnkgdGhlIHNjaGVtYS4KICAgICAqCiAgICAgKiAgLSBZRUFSX01PTlRIIC0gSW5kaWNhdGVzIHRoZSBudW1iZXIgb2YgZWxhcHNlZCB3aG9sZSBtb250aHMsIHN0b3JlZCBhcwogICAgICogICAgNC1ieXRlIHNpZ25lZCBpbnRlZ2Vycy4KICAgICAqICAtIERBWV9USU1FIC0gSW5kaWNhdGVzIHRoZSBudW1iZXIgb2YgZWxhcHNlZCBkYXlzIGFuZCBtaWxsaXNlY29uZHMgKG5vCiAgICAgKiAgICBsZWFwIHNlY29uZHMpLCBzdG9yZWQgYXMgMiBjb250aWd1b3VzIDMyLWJpdCBzaWduZWQgaW50ZWdlcnMgKDgtYnl0ZXMKICAgICAqICAgIGluIHRvdGFsKS4gU3VwcG9ydCBvZiB0aGlzIEludGVydmFsVW5pdCBpcyBub3QgcmVxdWlyZWQgZm9yIGZ1bGwgYXJyb3cKICAgICAqICAgIGNvbXBhdGliaWxpdHkuCiAgICAgKiAgLSBNT05USF9EQVlfTkFOTyAtIEEgdHJpcGxlIG9mIHRoZSBudW1iZXIgb2YgZWxhcHNlZCBtb250aHMsIGRheXMsIGFuZAogICAgICogICAgbmFub3NlY29uZHMuIFRoZSB2YWx1ZXMgYXJlIHN0b3JlZCBjb250aWd1b3VzbHkgaW4gMTYtYnl0ZSBibG9ja3MuCiAgICAgKiAgICBNb250aHMgYW5kIGRheXMgYXJlIGVuY29kZWQgYXMgMzItYml0IHNpZ25lZCBpbnRlZ2VycyBhbmQgbmFub3NlY29uZHMKICAgICAqICAgIGlzIGVuY29kZWQgYXMgYSA2NC1iaXQgc2lnbmVkIGludGVnZXIuIE5hbm9zZWNvbmRzIGRvZXMgbm90IGFsbG93IGZvcgogICAgICogICAgbGVhcCBzZWNvbmRzLiBFYWNoIGZpZWxkIGlzIGluZGVwZW5kZW50IChlLmcuIHRoZXJlIGlzIG5vIGNvbnN0cmFpbnQKICAgICAqICAgIHRoYXQgbmFub3NlY29uZHMgaGF2ZSB0aGUgc2FtZSBzaWduIGFzIGRheXMgb3IgdGhhdCB0aGUgcXVhbnRpdHkgb2YKICAgICAqICAgIG5hbm9zZWNvbmRzIHJlcHJlc2VudHMgbGVzcyB0aGFuIGEgZGF5J3Mgd29ydGggb2YgdGltZSkuCiAgICAgKi8KICAgIEludGVydmFsOiAxMSwKICAgIC8qKgogICAgICogTGlzdCAodmVjdG9yKSBkYXRhIHN1cHBvcnRpbmcgdmFyaWFibHktc2l6ZWQgbGlzdHMuCiAgICAgKiBBIGxpc3QgaGFzIGEgc2luZ2xlIGNoaWxkIGRhdGEgdHlwZSBmb3IgbGlzdCBlbnRyaWVzLgogICAgICovCiAgICBMaXN0OiAxMiwKICAgIC8qKgogICAgICogQSBzdHJ1Y3QgY29uc2lzdGluZyBvZiBtdWx0aXBsZSBuYW1lZCBjaGlsZCBkYXRhIHR5cGVzLgogICAgICovCiAgICBTdHJ1Y3Q6IDEzLAogICAgLyoqCiAgICAgKiBBIHVuaW9uIGlzIGEgY29tcGxleCB0eXBlIHdpdGggcGFyYWxsZWwgY2hpbGQgZGF0YSB0eXBlcy4gQnkgZGVmYXVsdCBpZHMKICAgICAqIGluIHRoZSB0eXBlIHZlY3RvciByZWZlciB0byB0aGUgb2Zmc2V0cyBpbiB0aGUgY2hpbGRyZW4uIE9wdGlvbmFsbHkKICAgICAqIHR5cGVJZHMgcHJvdmlkZXMgYW4gaW5kaXJlY3Rpb24gYmV0d2VlbiB0aGUgY2hpbGQgb2Zmc2V0IGFuZCB0aGUgdHlwZSBpZC4KICAgICAqIEZvciBlYWNoIGNoaWxkIGB0eXBlSWRzW29mZnNldF1gIGlzIHRoZSBpZCB1c2VkIGluIHRoZSB0eXBlIHZlY3Rvci4KICAgICAqLwogICAgVW5pb246IDE0LAogICAgLyoqCiAgICAgKiBCaW5hcnkgZGF0YSB3aGVyZSBlYWNoIGVudHJ5IGhhcyB0aGUgc2FtZSBmaXhlZCBzaXplLgogICAgICovCiAgICBGaXhlZFNpemVCaW5hcnk6IDE1LAogICAgLyoqCiAgICAgKiBMaXN0ICh2ZWN0b3IpIGRhdGEgd2hlcmUgZXZlcnkgbGlzdCBoYXMgdGhlIHNhbWUgZml4ZWQgc2l6ZS4KICAgICAqIEEgbGlzdCBoYXMgYSBzaW5nbGUgY2hpbGQgZGF0YSB0eXBlIGZvciBsaXN0IGVudHJpZXMuCiAgICAgKi8KICAgIEZpeGVkU2l6ZUxpc3Q6IDE2LAogICAgLyoqCiAgICAgKiBBIE1hcCBpcyBhIGxvZ2ljYWwgbmVzdGVkIHR5cGUgdGhhdCBpcyByZXByZXNlbnRlZCBhcwogICAgICogTGlzdDxlbnRyaWVzOiBTdHJ1Y3Q8a2V5OiBLLCB2YWx1ZTogVj4+CiAgICAgKgogICAgICogSW4gdGhpcyBsYXlvdXQsIHRoZSBrZXlzIGFuZCB2YWx1ZXMgYXJlIGVhY2ggcmVzcGVjdGl2ZWx5IGNvbnRpZ3VvdXMuIFdlIGRvCiAgICAgKiBub3QgY29uc3RyYWluIHRoZSBrZXkgYW5kIHZhbHVlIHR5cGVzLCBzbyB0aGUgYXBwbGljYXRpb24gaXMgcmVzcG9uc2libGUKICAgICAqIGZvciBlbnN1cmluZyB0aGF0IHRoZSBrZXlzIGFyZSBoYXNoYWJsZSBhbmQgdW5pcXVlLiBXaGV0aGVyIHRoZSBrZXlzIGFyZSBzb3J0ZWQKICAgICAqIG1heSBiZSBzZXQgaW4gdGhlIG1ldGFkYXRhIGZvciB0aGlzIGZpZWxkLgogICAgICoKICAgICAqIEluIGEgZmllbGQgd2l0aCBNYXAgdHlwZSwgdGhlIGZpZWxkIGhhcyBhIGNoaWxkIFN0cnVjdCBmaWVsZCwgd2hpY2ggdGhlbgogICAgICogaGFzIHR3byBjaGlsZHJlbjoga2V5IHR5cGUgYW5kIHRoZSBzZWNvbmQgdGhlIHZhbHVlIHR5cGUuIFRoZSBuYW1lcyBvZiB0aGUKICAgICAqIGNoaWxkIGZpZWxkcyBtYXkgYmUgcmVzcGVjdGl2ZWx5ICJlbnRyaWVzIiwgImtleSIsIGFuZCAidmFsdWUiLCBidXQgdGhpcyBpcwogICAgICogbm90IGVuZm9yY2VkLgogICAgICoKICAgICAqIE1hcAogICAgICogYGBgdGV4dAogICAgICogICAtIGNoaWxkWzBdIGVudHJpZXM6IFN0cnVjdAogICAgICogICAtIGNoaWxkWzBdIGtleTogSwogICAgICogICAtIGNoaWxkWzFdIHZhbHVlOiBWCiAgICAgKiAgYGBgCiAgICAgKiBOZWl0aGVyIHRoZSAiZW50cmllcyIgZmllbGQgbm9yIHRoZSAia2V5IiBmaWVsZCBtYXkgYmUgbnVsbGFibGUuCiAgICAgKgogICAgICogVGhlIG1ldGFkYXRhIGlzIHN0cnVjdHVyZWQgc28gdGhhdCBBcnJvdyBzeXN0ZW1zIHdpdGhvdXQgc3BlY2lhbCBoYW5kbGluZwogICAgICogZm9yIE1hcCBjYW4gbWFrZSBNYXAgYW4gYWxpYXMgZm9yIExpc3QuIFRoZSAibGF5b3V0IiBhdHRyaWJ1dGUgZm9yIHRoZSBNYXAKICAgICAqIGZpZWxkIG11c3QgaGF2ZSB0aGUgc2FtZSBjb250ZW50cyBhcyBhIExpc3QuCiAgICAgKi8KICAgIE1hcDogMTcsCiAgICAvKioKICAgICAqIEFuIGFic29sdXRlIGxlbmd0aCBvZiB0aW1lIHVucmVsYXRlZCB0byBhbnkgY2FsZW5kYXIgYXJ0aWZhY3RzLiBGb3IgdGhlCiAgICAgKiBwdXJwb3NlcyBvZiBBcnJvdyBpbXBsZW1lbnRhdGlvbnMsIGFkZGluZyB0aGlzIHZhbHVlIHRvIGEgVGltZXN0YW1wCiAgICAgKiAoInQxIikgbmFpdmVseSAoaS5lLiBzaW1wbHkgc3VtbWluZyB0aGUgdHdvIG51bWJlcnMpIGlzIGFjY2VwdGFibGUgZXZlbgogICAgICogdGhvdWdoIGluIHNvbWUgY2FzZXMgdGhlIHJlc3VsdGluZyBUaW1lc3RhbXAgKHQyKSB3b3VsZCBub3QgYWNjb3VudCBmb3IKICAgICAqIGxlYXAtc2Vjb25kcyBkdXJpbmcgdGhlIGVsYXBzZWQgdGltZSBiZXR3ZWVuICJ0MSIgYW5kICJ0MiIuIFNpbWlsYXJseSwKICAgICAqIHJlcHJlc2VudGluZyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHR3byBVbml4IHRpbWVzdGFtcCBpcyBhY2NlcHRhYmxlLCBidXQKICAgICAqIHdvdWxkIHlpZWxkIGEgdmFsdWUgdGhhdCBpcyBwb3NzaWJseSBhIGZldyBzZWNvbmRzIG9mZiBmcm9tIHRoZSB0cnVlCiAgICAgKiBlbGFwc2VkIHRpbWUuCiAgICAgKgogICAgICogVGhlIHJlc29sdXRpb24gZGVmYXVsdHMgdG8gbWlsbGlzZWNvbmQsIGJ1dCBjYW4gYmUgYW55IG9mIHRoZSBvdGhlcgogICAgICogc3VwcG9ydGVkIFRpbWVVbml0IHZhbHVlcyBhcyB3aXRoIFRpbWVzdGFtcCBhbmQgVGltZSB0eXBlcy4gVGhpcyB0eXBlIGlzCiAgICAgKiBhbHdheXMgcmVwcmVzZW50ZWQgYXMgYW4gOC1ieXRlIGludGVnZXIuCiAgICAgKi8KICAgIER1cmF0aW9uOiAxOCwKICAgIC8qKgogICAgICogU2FtZSBhcyBCaW5hcnksIGJ1dCB3aXRoIDY0LWJpdCBvZmZzZXRzLCBhbGxvd2luZyByZXByZXNlbnRhdGlvbiBvZgogICAgICogZXh0cmVtZWx5IGxhcmdlIGRhdGEgdmFsdWVzLgogICAgICovCiAgICBMYXJnZUJpbmFyeTogMTksCiAgICAvKioKICAgICAqIFNhbWUgYXMgVXRmOCwgYnV0IHdpdGggNjQtYml0IG9mZnNldHMsIGFsbG93aW5nIHJlcHJlc2VudGF0aW9uIG9mCiAgICAgKiBleHRyZW1lbHkgbGFyZ2UgZGF0YSB2YWx1ZXMuCiAgICAgKi8KICAgIExhcmdlVXRmODogMjAsCiAgICAvKioKICAgICAqIFNhbWUgYXMgTGlzdCwgYnV0IHdpdGggNjQtYml0IG9mZnNldHMsIGFsbG93aW5nIHJlcHJlc2VudGF0aW9uIG9mCiAgICAgKiBleHRyZW1lbHkgbGFyZ2UgZGF0YSB2YWx1ZXMuCiAgICAgKi8KICAgIExhcmdlTGlzdDogMjEsCiAgICAvKioKICAgICAqIENvbnRhaW5zIHR3byBjaGlsZCBhcnJheXMsIHJ1bl9lbmRzIGFuZCB2YWx1ZXMuIFRoZSBydW5fZW5kcyBjaGlsZCBhcnJheQogICAgICogbXVzdCBiZSBhIDE2LzMyLzY0LWJpdCBpbnRlZ2VyIGFycmF5IHdoaWNoIGVuY29kZXMgdGhlIGluZGljZXMgYXQgd2hpY2gKICAgICAqIHRoZSBydW4gd2l0aCB0aGUgdmFsdWUgaW4gZWFjaCBjb3JyZXNwb25kaW5nIGluZGV4IGluIHRoZSB2YWx1ZXMgY2hpbGQKICAgICAqIGFycmF5IGVuZHMuIExpa2UgbGlzdC9zdHJ1Y3QgdHlwZXMsIHRoZSB2YWx1ZSBhcnJheSBjYW4gYmUgb2YgYW55IHR5cGUuCiAgICAgKi8KICAgIFJ1bkVuZEVuY29kZWQ6IDIyLAogICAgLyoqCiAgICAgKiBMb2dpY2FsbHkgdGhlIHNhbWUgYXMgQmluYXJ5LCBidXQgdGhlIGludGVybmFsIHJlcHJlc2VudGF0aW9uIHVzZXMgYSB2aWV3CiAgICAgKiBzdHJ1Y3QgdGhhdCBjb250YWlucyB0aGUgc3RyaW5nIGxlbmd0aCBhbmQgZWl0aGVyIHRoZSBzdHJpbmcncyBlbnRpcmUgZGF0YQogICAgICogaW5saW5lIChmb3Igc21hbGwgc3RyaW5ncykgb3IgYW4gaW5saW5lZCBwcmVmaXgsIGFuIGluZGV4IG9mIGFub3RoZXIgYnVmZmVyLAogICAgICogYW5kIGFuIG9mZnNldCBwb2ludGluZyB0byBhIHNsaWNlIGluIHRoYXQgYnVmZmVyIChmb3Igbm9uLXNtYWxsIHN0cmluZ3MpLgogICAgICoKICAgICAqIFNpbmNlIGl0IHVzZXMgYSB2YXJpYWJsZSBudW1iZXIgb2YgZGF0YSBidWZmZXJzLCBlYWNoIEZpZWxkIHdpdGggdGhpcyB0eXBlCiAgICAgKiBtdXN0IGhhdmUgYSBjb3JyZXNwb25kaW5nIGVudHJ5IGluIGB2YXJpYWRpY0J1ZmZlckNvdW50c2AuCiAgICAgKi8KICAgIEJpbmFyeVZpZXc6IDIzLAogICAgLyoqCiAgICAgKiBMb2dpY2FsbHkgdGhlIHNhbWUgYXMgVXRmOCwgYnV0IHRoZSBpbnRlcm5hbCByZXByZXNlbnRhdGlvbiB1c2VzIGEgdmlldwogICAgICogc3RydWN0IHRoYXQgY29udGFpbnMgdGhlIHN0cmluZyBsZW5ndGggYW5kIGVpdGhlciB0aGUgc3RyaW5nJ3MgZW50aXJlIGRhdGEKICAgICAqIGlubGluZSAoZm9yIHNtYWxsIHN0cmluZ3MpIG9yIGFuIGlubGluZWQgcHJlZml4LCBhbiBpbmRleCBvZiBhbm90aGVyIGJ1ZmZlciwKICAgICAqIGFuZCBhbiBvZmZzZXQgcG9pbnRpbmcgdG8gYSBzbGljZSBpbiB0aGF0IGJ1ZmZlciAoZm9yIG5vbi1zbWFsbCBzdHJpbmdzKS4KICAgICAqCiAgICAgKiBTaW5jZSBpdCB1c2VzIGEgdmFyaWFibGUgbnVtYmVyIG9mIGRhdGEgYnVmZmVycywgZWFjaCBGaWVsZCB3aXRoIHRoaXMgdHlwZQogICAgICogbXVzdCBoYXZlIGEgY29ycmVzcG9uZGluZyBlbnRyeSBpbiBgdmFyaWFkaWNCdWZmZXJDb3VudHNgLgogICAgICovCiAgICBVdGY4VmlldzogMjQsCiAgICAvKioKICAgICAqIFJlcHJlc2VudHMgdGhlIHNhbWUgbG9naWNhbCB0eXBlcyB0aGF0IExpc3QgY2FuLCBidXQgY29udGFpbnMgb2Zmc2V0cyBhbmQKICAgICAqIHNpemVzIGFsbG93aW5nIGZvciB3cml0ZXMgaW4gYW55IG9yZGVyIGFuZCBzaGFyaW5nIG9mIGNoaWxkIHZhbHVlcyBhbW9uZwogICAgICogbGlzdCB2YWx1ZXMuCiAgICAgKi8KICAgIExpc3RWaWV3OiAyNSwKICAgIC8qKgogICAgICogU2FtZSBhcyBMaXN0VmlldywgYnV0IHdpdGggNjQtYml0IG9mZnNldHMgYW5kIHNpemVzLCBhbGxvd2luZyB0byByZXByZXNlbnQKICAgICAqIGV4dHJlbWVseSBsYXJnZSBkYXRhIHZhbHVlcy4KICAgICAqLwogICAgTGFyZ2VMaXN0VmlldzogMjYKICB9Cik7CnZhciBQcmVjaXNpb24gPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICAvKiogMTYtYml0IGZsb2F0aW5nIHBvaW50IG51bWJlci4gKi8KICAgIEhBTEY6IDAsCiAgICAvKiogMzItYml0IGZsb2F0aW5nIHBvaW50IG51bWJlci4gKi8KICAgIFNJTkdMRTogMSwKICAgIC8qKiA2NC1iaXQgZmxvYXRpbmcgcG9pbnQgbnVtYmVyLiAqLwogICAgRE9VQkxFOiAyCiAgfQopOwp2YXIgRGF0ZVVuaXQgPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICAvKiBEYXlzIChhcyAzMiBiaXQgaW50KSBzaW5jZSB0aGUgVU5JWCBlcG9jaC4gKi8KICAgIERBWTogMCwKICAgIC8qKgogICAgICogTWlsbGlzZWNvbmRzIChhcyA2NCBiaXQgaW50KSBpbmRpY2F0aW5nIFVOSVggdGltZSBlbGFwc2VkIHNpbmNlIHRoZSBlcG9jaAogICAgICogKG5vIGxlYXAgc2Vjb25kcyksIHdpdGggdmFsdWVzIGV2ZW5seSBkaXZpc2libGUgYnkgODY0MDAwMDAuCiAgICAgKi8KICAgIE1JTExJU0VDT05EOiAxCiAgfQopOwp2YXIgVGltZVVuaXQgPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICAvKiogU2Vjb25kcy4gKi8KICAgIFNFQ09ORDogMCwKICAgIC8qKiBNaWxsaXNlY29uZHMuICovCiAgICBNSUxMSVNFQ09ORDogMSwKICAgIC8qKiBNaWNyb3NlY29uZHMuICovCiAgICBNSUNST1NFQ09ORDogMiwKICAgIC8qKiBOYW5vc2Vjb25kcy4gKi8KICAgIE5BTk9TRUNPTkQ6IDMKICB9Cik7CnZhciBJbnRlcnZhbFVuaXQgPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICAvKioKICAgICAqIEluZGljYXRlcyB0aGUgbnVtYmVyIG9mIGVsYXBzZWQgd2hvbGUgbW9udGhzLCBzdG9yZWQgYXMgNC1ieXRlIHNpZ25lZAogICAgICogaW50ZWdlcnMuCiAgICAgKi8KICAgIFlFQVJfTU9OVEg6IDAsCiAgICAvKioKICAgICAqIEluZGljYXRlcyB0aGUgbnVtYmVyIG9mIGVsYXBzZWQgZGF5cyBhbmQgbWlsbGlzZWNvbmRzIChubyBsZWFwIHNlY29uZHMpLAogICAgICogc3RvcmVkIGFzIDIgY29udGlndW91cyAzMi1iaXQgc2lnbmVkIGludGVnZXJzICg4LWJ5dGVzIGluIHRvdGFsKS4gU3VwcG9ydAogICAgICogb2YgdGhpcyBJbnRlcnZhbFVuaXQgaXMgbm90IHJlcXVpcmVkIGZvciBmdWxsIGFycm93IGNvbXBhdGliaWxpdHkuCiAgICAgKi8KICAgIERBWV9USU1FOiAxLAogICAgLyoqCiAgICAgKiBBIHRyaXBsZSBvZiB0aGUgbnVtYmVyIG9mIGVsYXBzZWQgbW9udGhzLCBkYXlzLCBhbmQgbmFub3NlY29uZHMuCiAgICAgKiBUaGUgdmFsdWVzIGFyZSBzdG9yZWQgY29udGlndW91c2x5IGluIDE2LWJ5dGUgYmxvY2tzLiBNb250aHMgYW5kIGRheXMgYXJlCiAgICAgKiBlbmNvZGVkIGFzIDMyLWJpdCBzaWduZWQgaW50ZWdlcnMgYW5kIG5hbm9zZWNvbmRzIGlzIGVuY29kZWQgYXMgYSA2NC1iaXQKICAgICAqIHNpZ25lZCBpbnRlZ2VyLiBOYW5vc2Vjb25kcyBkb2VzIG5vdCBhbGxvdyBmb3IgbGVhcCBzZWNvbmRzLiBFYWNoIGZpZWxkIGlzCiAgICAgKiBpbmRlcGVuZGVudCAoZS5nLiB0aGVyZSBpcyBubyBjb25zdHJhaW50IHRoYXQgbmFub3NlY29uZHMgaGF2ZSB0aGUgc2FtZQogICAgICogc2lnbiBhcyBkYXlzIG9yIHRoYXQgdGhlIHF1YW50aXR5IG9mIG5hbm9zZWNvbmRzIHJlcHJlc2VudHMgbGVzcyB0aGFuIGEKICAgICAqIGRheSdzIHdvcnRoIG9mIHRpbWUpLgogICAgICovCiAgICBNT05USF9EQVlfTkFOTzogMgogIH0KKTsKdmFyIFVuaW9uTW9kZSA9ICgKICAvKiogQHR5cGUge2NvbnN0fSAqLwogIHsKICAgIC8qKiBTcGFyc2UgdW5pb24gbGF5b3V0IHdpdGggZnVsbCBhcnJheXMgZm9yIGVhY2ggc3ViLXR5cGUuICovCiAgICBTcGFyc2U6IDAsCiAgICAvKiogRGVuc2UgdW5pb24gbGF5b3V0IHdpdGggb2Zmc2V0cyBpbnRvIHZhbHVlIGFycmF5cy4gKi8KICAgIERlbnNlOiAxCiAgfQopOwoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy91dGlsL2FycmF5cy5qcwp2YXIgdWludDhBcnJheSA9IFVpbnQ4QXJyYXk7CnZhciB1aW50MTZBcnJheSA9IFVpbnQxNkFycmF5Owp2YXIgdWludDMyQXJyYXkgPSBVaW50MzJBcnJheTsKdmFyIHVpbnQ2NEFycmF5ID0gQmlnVWludDY0QXJyYXk7CnZhciBpbnQ4QXJyYXkgPSBJbnQ4QXJyYXk7CnZhciBpbnQxNkFycmF5ID0gSW50MTZBcnJheTsKdmFyIGludDMyQXJyYXkgPSBJbnQzMkFycmF5Owp2YXIgaW50NjRBcnJheSA9IEJpZ0ludDY0QXJyYXk7CnZhciBmbG9hdDMyQXJyYXkgPSBGbG9hdDMyQXJyYXk7CnZhciBmbG9hdDY0QXJyYXkgPSBGbG9hdDY0QXJyYXk7CmZ1bmN0aW9uIGludEFycmF5VHlwZShiaXRXaWR0aCwgc2lnbmVkKSB7CiAgY29uc3QgaSA9IE1hdGgubG9nMihiaXRXaWR0aCkgLSAzOwogIHJldHVybiAoc2lnbmVkID8gW2ludDhBcnJheSwgaW50MTZBcnJheSwgaW50MzJBcnJheSwgaW50NjRBcnJheV0gOiBbdWludDhBcnJheSwgdWludDE2QXJyYXksIHVpbnQzMkFycmF5LCB1aW50NjRBcnJheV0pW2ldOwp9CnZhciBUeXBlZEFycmF5ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKEludDhBcnJheSk7CmZ1bmN0aW9uIGJpc2VjdChvZmZzZXRzLCBpbmRleCkgewogIGxldCBhID0gMDsKICBsZXQgYiA9IG9mZnNldHMubGVuZ3RoOwogIGlmIChiIDw9IDIxNDc0ODM2NDgpIHsKICAgIGRvIHsKICAgICAgY29uc3QgbWlkID0gYSArIGIgPj4+IDE7CiAgICAgIGlmIChvZmZzZXRzW21pZF0gPD0gaW5kZXgpIGEgPSBtaWQgKyAxOwogICAgICBlbHNlIGIgPSBtaWQ7CiAgICB9IHdoaWxlIChhIDwgYik7CiAgfSBlbHNlIHsKICAgIGRvIHsKICAgICAgY29uc3QgbWlkID0gTWF0aC50cnVuYygoYSArIGIpIC8gMik7CiAgICAgIGlmIChvZmZzZXRzW21pZF0gPD0gaW5kZXgpIGEgPSBtaWQgKyAxOwogICAgICBlbHNlIGIgPSBtaWQ7CiAgICB9IHdoaWxlIChhIDwgYik7CiAgfQogIHJldHVybiBhOwp9CmZ1bmN0aW9uIHJlc2l6ZShhcnJheTIsIG5ld0xlbmd0aCwgb2Zmc2V0ID0gMCkgewogIGNvbnN0IG5ld0FycmF5ID0gbmV3IGFycmF5Mi5jb25zdHJ1Y3RvcihuZXdMZW5ndGgpOwogIG5ld0FycmF5LnNldChhcnJheTIsIG9mZnNldCk7CiAgcmV0dXJuIG5ld0FycmF5Owp9CmZ1bmN0aW9uIGdyb3coYXJyYXkyLCBpbmRleCwgc2hpZnQpIHsKICB3aGlsZSAoYXJyYXkyLmxlbmd0aCA8PSBpbmRleCkgewogICAgYXJyYXkyID0gcmVzaXplKGFycmF5MiwgYXJyYXkyLmxlbmd0aCA8PCAxLCBzaGlmdCA/IGFycmF5Mi5sZW5ndGggOiAwKTsKICB9CiAgcmV0dXJuIGFycmF5MjsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy91dGlsL29iamVjdHMuanMKZnVuY3Rpb24gY2hlY2sodmFsdWUsIHRlc3QsIG1lc3NhZ2UpIHsKICBpZiAodGVzdCh2YWx1ZSkpIHJldHVybiB2YWx1ZTsKICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSh2YWx1ZSkpOwp9CmZ1bmN0aW9uIGNoZWNrT25lT2YodmFsdWUsIHNldCwgbWVzc2FnZSkgewogIHNldCA9IEFycmF5LmlzQXJyYXkoc2V0KSA/IHNldCA6IE9iamVjdC52YWx1ZXMoc2V0KTsKICByZXR1cm4gY2hlY2soCiAgICB2YWx1ZSwKICAgICh2YWx1ZTIpID0+IHNldC5pbmNsdWRlcyh2YWx1ZTIpLAogICAgbWVzc2FnZSA/PyAoKCkgPT4gYCR7dmFsdWV9IG11c3QgYmUgb25lIG9mICR7c2V0fWApCiAgKTsKfQpmdW5jdGlvbiBrZXlGb3Iob2JqZWN0LCB2YWx1ZSkgewogIGZvciAoY29uc3QgW2tleSwgdmFsXSBvZiBPYmplY3QuZW50cmllcyhvYmplY3QpKSB7CiAgICBpZiAodmFsID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKICB9CiAgcmV0dXJuICI8VW5rbm93bj4iOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2RhdGEtdHlwZXMuanMKdmFyIGludmFsaWREYXRhVHlwZSA9ICh0eXBlSWQpID0+IGBVbnN1cHBvcnRlZCBkYXRhIHR5cGU6ICIke2tleUZvcihUeXBlLCB0eXBlSWQpfSIgKGlkICR7dHlwZUlkfSlgOwp2YXIgZmllbGQgPSAobmFtZSwgdHlwZSwgbnVsbGFibGUgPSB0cnVlLCBtZXRhZGF0YSA9IG51bGwpID0+ICh7CiAgbmFtZSwKICB0eXBlLAogIG51bGxhYmxlLAogIG1ldGFkYXRhCn0pOwpmdW5jdGlvbiBpc0ZpZWxkKHZhbHVlKSB7CiAgcmV0dXJuIE9iamVjdC5oYXNPd24odmFsdWUsICJuYW1lIikgJiYgaXNEYXRhVHlwZSh2YWx1ZS50eXBlKTsKfQpmdW5jdGlvbiBpc0RhdGFUeXBlKHZhbHVlKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZT8udHlwZUlkID09PSAibnVtYmVyIjsKfQpmdW5jdGlvbiBhc0ZpZWxkKHZhbHVlLCBkZWZhdWx0TmFtZSA9ICIiLCBkZWZhdWx0TnVsbGFibGUgPSB0cnVlKSB7CiAgcmV0dXJuIGlzRmllbGQodmFsdWUpID8gdmFsdWUgOiBmaWVsZCgKICAgIGRlZmF1bHROYW1lLAogICAgY2hlY2sodmFsdWUsIGlzRGF0YVR5cGUsICgpID0+IGBEYXRhIHR5cGUgZXhwZWN0ZWQuYCksCiAgICBkZWZhdWx0TnVsbGFibGUKICApOwp9CnZhciBkaWN0aW9uYXJ5ID0gKHR5cGUsIGluZGV4VHlwZSwgb3JkZXJlZCA9IGZhbHNlLCBpZCA9IC0xKSA9PiAoewogIHR5cGVJZDogVHlwZS5EaWN0aW9uYXJ5LAogIGlkLAogIGRpY3Rpb25hcnk6IHR5cGUsCiAgaW5kaWNlczogaW5kZXhUeXBlIHx8IGludDMyKCksCiAgb3JkZXJlZAp9KTsKdmFyIGludCA9IChiaXRXaWR0aCA9IDMyLCBzaWduZWQgPSB0cnVlKSA9PiAoewogIHR5cGVJZDogVHlwZS5JbnQsCiAgYml0V2lkdGg6IGNoZWNrT25lT2YoYml0V2lkdGgsIFs4LCAxNiwgMzIsIDY0XSksCiAgc2lnbmVkLAogIHZhbHVlczogaW50QXJyYXlUeXBlKGJpdFdpZHRoLCBzaWduZWQpCn0pOwp2YXIgaW50MzIgPSAoKSA9PiBpbnQoMzIpOwp2YXIgZmxvYXQgPSAocHJlY2lzaW9uID0gMikgPT4gKHsKICB0eXBlSWQ6IFR5cGUuRmxvYXQsCiAgcHJlY2lzaW9uOiBjaGVja09uZU9mKHByZWNpc2lvbiwgUHJlY2lzaW9uKSwKICB2YWx1ZXM6IFt1aW50MTZBcnJheSwgZmxvYXQzMkFycmF5LCBmbG9hdDY0QXJyYXldW3ByZWNpc2lvbl0KfSk7CnZhciBiaW5hcnkgPSAoKSA9PiAoewogIHR5cGVJZDogVHlwZS5CaW5hcnksCiAgb2Zmc2V0czogaW50MzJBcnJheQp9KTsKdmFyIHV0ZjggPSAoKSA9PiAoewogIHR5cGVJZDogVHlwZS5VdGY4LAogIG9mZnNldHM6IGludDMyQXJyYXkKfSk7CnZhciBkZWNpbWFsID0gKHByZWNpc2lvbiwgc2NhbGUsIGJpdFdpZHRoID0gMTI4KSA9PiAoewogIHR5cGVJZDogVHlwZS5EZWNpbWFsLAogIHByZWNpc2lvbiwKICBzY2FsZSwKICBiaXRXaWR0aDogY2hlY2tPbmVPZihiaXRXaWR0aCwgWzMyLCA2NCwgMTI4LCAyNTZdKSwKICB2YWx1ZXM6IGJpdFdpZHRoID09PSAzMiA/IGludDMyQXJyYXkgOiB1aW50NjRBcnJheQp9KTsKdmFyIGRhdGUyID0gKHVuaXQyKSA9PiAoewogIHR5cGVJZDogVHlwZS5EYXRlLAogIHVuaXQ6IGNoZWNrT25lT2YodW5pdDIsIERhdGVVbml0KSwKICB2YWx1ZXM6IHVuaXQyID09PSBEYXRlVW5pdC5EQVkgPyBpbnQzMkFycmF5IDogaW50NjRBcnJheQp9KTsKdmFyIHRpbWUyID0gKHVuaXQyID0gVGltZVVuaXQuTUlMTElTRUNPTkQsIGJpdFdpZHRoID0gMzIpID0+ICh7CiAgdHlwZUlkOiBUeXBlLlRpbWUsCiAgdW5pdDogY2hlY2tPbmVPZih1bml0MiwgVGltZVVuaXQpLAogIGJpdFdpZHRoOiBjaGVja09uZU9mKGJpdFdpZHRoLCBbMzIsIDY0XSksCiAgdmFsdWVzOiBiaXRXaWR0aCA9PT0gMzIgPyBpbnQzMkFycmF5IDogaW50NjRBcnJheQp9KTsKdmFyIHRpbWVzdGFtcCA9ICh1bml0MiA9IFRpbWVVbml0Lk1JTExJU0VDT05ELCB0aW1lem9uZSA9IG51bGwpID0+ICh7CiAgdHlwZUlkOiBUeXBlLlRpbWVzdGFtcCwKICB1bml0OiBjaGVja09uZU9mKHVuaXQyLCBUaW1lVW5pdCksCiAgdGltZXpvbmUsCiAgdmFsdWVzOiBpbnQ2NEFycmF5Cn0pOwp2YXIgaW50ZXJ2YWwgPSAodW5pdDIgPSBJbnRlcnZhbFVuaXQuTU9OVEhfREFZX05BTk8pID0+ICh7CiAgdHlwZUlkOiBUeXBlLkludGVydmFsLAogIHVuaXQ6IGNoZWNrT25lT2YodW5pdDIsIEludGVydmFsVW5pdCksCiAgdmFsdWVzOiB1bml0MiA9PT0gSW50ZXJ2YWxVbml0Lk1PTlRIX0RBWV9OQU5PID8gdm9pZCAwIDogaW50MzJBcnJheQp9KTsKdmFyIGxpc3QgPSAoY2hpbGQpID0+ICh7CiAgdHlwZUlkOiBUeXBlLkxpc3QsCiAgY2hpbGRyZW46IFthc0ZpZWxkKGNoaWxkKV0sCiAgb2Zmc2V0czogaW50MzJBcnJheQp9KTsKdmFyIHN0cnVjdCA9IChjaGlsZHJlbjIpID0+ICh7CiAgdHlwZUlkOiBUeXBlLlN0cnVjdCwKICBjaGlsZHJlbjogQXJyYXkuaXNBcnJheShjaGlsZHJlbjIpICYmIGlzRmllbGQoY2hpbGRyZW4yWzBdKSA/ICgKICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuL3R5cGVzLmpzJykuRmllbGRbXX0gKi8KICAgIGNoaWxkcmVuMgogICkgOiBPYmplY3QuZW50cmllcyhjaGlsZHJlbjIpLm1hcCgoW25hbWUsIHR5cGVdKSA9PiBmaWVsZChuYW1lLCB0eXBlKSkKfSk7CnZhciB1bmlvbiA9IChtb2RlLCBjaGlsZHJlbjIsIHR5cGVJZHMsIHR5cGVJZEZvclZhbHVlKSA9PiB7CiAgdHlwZUlkcyA/Pz0gY2hpbGRyZW4yLm1hcCgodiwgaSkgPT4gaSk7CiAgcmV0dXJuIHsKICAgIHR5cGVJZDogVHlwZS5VbmlvbiwKICAgIG1vZGU6IGNoZWNrT25lT2YobW9kZSwgVW5pb25Nb2RlKSwKICAgIHR5cGVJZHMsCiAgICB0eXBlTWFwOiB0eXBlSWRzLnJlZHVjZSgobSwgaWQsIGkpID0+IChtW2lkXSA9IGksIG0pLCB7fSksCiAgICBjaGlsZHJlbjogY2hpbGRyZW4yLm1hcCgodiwgaSkgPT4gYXNGaWVsZCh2LCBgXyR7aX1gKSksCiAgICB0eXBlSWRGb3JWYWx1ZSwKICAgIG9mZnNldHM6IGludDMyQXJyYXkKICB9Owp9Owp2YXIgZml4ZWRTaXplQmluYXJ5ID0gKHN0cmlkZSkgPT4gKHsKICB0eXBlSWQ6IFR5cGUuRml4ZWRTaXplQmluYXJ5LAogIHN0cmlkZQp9KTsKdmFyIGZpeGVkU2l6ZUxpc3QgPSAoY2hpbGQsIHN0cmlkZSkgPT4gKHsKICB0eXBlSWQ6IFR5cGUuRml4ZWRTaXplTGlzdCwKICBzdHJpZGUsCiAgY2hpbGRyZW46IFthc0ZpZWxkKGNoaWxkKV0KfSk7CnZhciBtYXBUeXBlID0gKGtleXNTb3J0ZWQsIGNoaWxkKSA9PiAoewogIHR5cGVJZDogVHlwZS5NYXAsCiAga2V5c1NvcnRlZCwKICBjaGlsZHJlbjogW2NoaWxkXSwKICBvZmZzZXRzOiBpbnQzMkFycmF5Cn0pOwp2YXIgZHVyYXRpb24gPSAodW5pdDIgPSBUaW1lVW5pdC5NSUxMSVNFQ09ORCkgPT4gKHsKICB0eXBlSWQ6IFR5cGUuRHVyYXRpb24sCiAgdW5pdDogY2hlY2tPbmVPZih1bml0MiwgVGltZVVuaXQpLAogIHZhbHVlczogaW50NjRBcnJheQp9KTsKdmFyIGxhcmdlQmluYXJ5ID0gKCkgPT4gKHsKICB0eXBlSWQ6IFR5cGUuTGFyZ2VCaW5hcnksCiAgb2Zmc2V0czogaW50NjRBcnJheQp9KTsKdmFyIGxhcmdlVXRmOCA9ICgpID0+ICh7CiAgdHlwZUlkOiBUeXBlLkxhcmdlVXRmOCwKICBvZmZzZXRzOiBpbnQ2NEFycmF5Cn0pOwp2YXIgbGFyZ2VMaXN0ID0gKGNoaWxkKSA9PiAoewogIHR5cGVJZDogVHlwZS5MYXJnZUxpc3QsCiAgY2hpbGRyZW46IFthc0ZpZWxkKGNoaWxkKV0sCiAgb2Zmc2V0czogaW50NjRBcnJheQp9KTsKdmFyIHJ1bkVuZEVuY29kZWQgPSAocnVuc0ZpZWxkLCB2YWx1ZXNGaWVsZCkgPT4gKHsKICB0eXBlSWQ6IFR5cGUuUnVuRW5kRW5jb2RlZCwKICBjaGlsZHJlbjogWwogICAgY2hlY2soCiAgICAgIGFzRmllbGQocnVuc0ZpZWxkLCAicnVuX2VuZHMiKSwKICAgICAgKGZpZWxkMikgPT4gZmllbGQyLnR5cGUudHlwZUlkID09PSBUeXBlLkludCwKICAgICAgKCkgPT4gIlJ1bi1lbmRzIG11c3QgaGF2ZSBhbiBpbnRlZ2VyIHR5cGUuIgogICAgKSwKICAgIGFzRmllbGQodmFsdWVzRmllbGQsICJ2YWx1ZXMiKQogIF0KfSk7CnZhciBsaXN0VmlldyA9IChjaGlsZCkgPT4gKHsKICB0eXBlSWQ6IFR5cGUuTGlzdFZpZXcsCiAgY2hpbGRyZW46IFthc0ZpZWxkKGNoaWxkLCAidmFsdWUiKV0sCiAgb2Zmc2V0czogaW50MzJBcnJheQp9KTsKdmFyIGxhcmdlTGlzdFZpZXcgPSAoY2hpbGQpID0+ICh7CiAgdHlwZUlkOiBUeXBlLkxhcmdlTGlzdFZpZXcsCiAgY2hpbGRyZW46IFthc0ZpZWxkKGNoaWxkLCAidmFsdWUiKV0sCiAgb2Zmc2V0czogaW50NjRBcnJheQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvdXRpbC9udW1iZXJzLmpzCnZhciBmNjQgPSBuZXcgZmxvYXQ2NEFycmF5KDIpOwp2YXIgYnVmID0gZjY0LmJ1ZmZlcjsKdmFyIGk2NCA9IG5ldyBpbnQ2NEFycmF5KGJ1Zik7CnZhciB1MzIgPSBuZXcgdWludDMyQXJyYXkoYnVmKTsKdmFyIGkzMiA9IG5ldyBpbnQzMkFycmF5KGJ1Zik7CnZhciB1OCA9IG5ldyB1aW50OEFycmF5KGJ1Zik7CmZ1bmN0aW9uIHRvTnVtYmVyKHZhbHVlKSB7CiAgaWYgKHZhbHVlID4gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgfHwgdmFsdWUgPCBOdW1iZXIuTUlOX1NBRkVfSU5URUdFUikgewogICAgdGhyb3cgRXJyb3IoYEJpZ0ludCBleGNlZWRzIGludGVnZXIgbnVtYmVyIHJlcHJlc2VudGF0aW9uOiAke3ZhbHVlfWApOwogIH0KICByZXR1cm4gTnVtYmVyKHZhbHVlKTsKfQpmdW5jdGlvbiBkaXZpZGUobnVtLCBkaXYpIHsKICByZXR1cm4gTnVtYmVyKG51bSAvIGRpdikgKyBOdW1iZXIobnVtICUgZGl2KSAvIE51bWJlcihkaXYpOwp9CnZhciBhc1VpbnQ2NCA9ICh2KSA9PiBCaWdJbnQuYXNVaW50Tig2NCwgdik7CmZ1bmN0aW9uIGZyb21EZWNpbWFsNjQoYnVmMiwgb2Zmc2V0KSB7CiAgcmV0dXJuIEJpZ0ludC5hc0ludE4oNjQsIGJ1ZjJbb2Zmc2V0XSk7Cn0KZnVuY3Rpb24gZnJvbURlY2ltYWwxMjgoYnVmMiwgb2Zmc2V0KSB7CiAgY29uc3QgaSA9IG9mZnNldCA8PCAxOwogIGxldCB4OwogIGlmIChCaWdJbnQuYXNJbnROKDY0LCBidWYyW2kgKyAxXSkgPCAwKSB7CiAgICB4ID0gYXNVaW50NjQofmJ1ZjJbaV0pIHwgYXNVaW50NjQofmJ1ZjJbaSArIDFdKSA8PCA2NG47CiAgICB4ID0gLSh4ICsgMW4pOwogIH0gZWxzZSB7CiAgICB4ID0gYnVmMltpXSB8IGJ1ZjJbaSArIDFdIDw8IDY0bjsKICB9CiAgcmV0dXJuIHg7Cn0KZnVuY3Rpb24gZnJvbURlY2ltYWwyNTYoYnVmMiwgb2Zmc2V0KSB7CiAgY29uc3QgaSA9IG9mZnNldCA8PCAyOwogIGxldCB4OwogIGlmIChCaWdJbnQuYXNJbnROKDY0LCBidWYyW2kgKyAzXSkgPCAwKSB7CiAgICB4ID0gYXNVaW50NjQofmJ1ZjJbaV0pIHwgYXNVaW50NjQofmJ1ZjJbaSArIDFdKSA8PCA2NG4gfCBhc1VpbnQ2NCh+YnVmMltpICsgMl0pIDw8IDEyOG4gfCBhc1VpbnQ2NCh+YnVmMltpICsgM10pIDw8IDE5Mm47CiAgICB4ID0gLSh4ICsgMW4pOwogIH0gZWxzZSB7CiAgICB4ID0gYnVmMltpXSB8IGJ1ZjJbaSArIDFdIDw8IDY0biB8IGJ1ZjJbaSArIDJdIDw8IDEyOG4gfCBidWYyW2kgKyAzXSA8PCAxOTJuOwogIH0KICByZXR1cm4geDsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy91dGlsL3N0cmluZ3MuanMKdmFyIHRleHREZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCJ1dGYtOCIpOwp2YXIgdGV4dEVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKZnVuY3Rpb24gZGVjb2RlVXRmOChidWYyKSB7CiAgcmV0dXJuIHRleHREZWNvZGVyLmRlY29kZShidWYyKTsKfQpmdW5jdGlvbiBlbmNvZGVVdGY4KHN0cikgewogIHJldHVybiB0ZXh0RW5jb2Rlci5lbmNvZGUoc3RyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy91dGlsL3JlYWQuanMKdmFyIFNJWkVPRl9JTlQgPSA0Owp2YXIgU0laRU9GX1NIT1JUID0gMjsKZnVuY3Rpb24gZGVjb2RlQml0KGJpdG1hcDIsIGluZGV4KSB7CiAgcmV0dXJuIChiaXRtYXAyW2luZGV4ID4+IDNdICYgMSA8PCBpbmRleCAlIDgpICE9PSAwOwp9CmZ1bmN0aW9uIHJlYWRPYmplY3QoYnVmMiwgaW5kZXgpIHsKICBjb25zdCBwb3MgPSBpbmRleCArIHJlYWRJbnQzMihidWYyLCBpbmRleCk7CiAgY29uc3QgdnRhYmxlID0gcG9zIC0gcmVhZEludDMyKGJ1ZjIsIHBvcyk7CiAgY29uc3Qgc2l6ZSA9IHJlYWRJbnQxNihidWYyLCB2dGFibGUpOwogIHJldHVybiAoaW5kZXgyLCByZWFkLCBmYWxsYmFjayA9IG51bGwpID0+IHsKICAgIGlmIChpbmRleDIgPCBzaXplKSB7CiAgICAgIGNvbnN0IG9mZiA9IHJlYWRJbnQxNihidWYyLCB2dGFibGUgKyBpbmRleDIpOwogICAgICBpZiAob2ZmKSByZXR1cm4gcmVhZChidWYyLCBwb3MgKyBvZmYpOwogICAgfQogICAgcmV0dXJuIGZhbGxiYWNrOwogIH07Cn0KZnVuY3Rpb24gcmVhZE9mZnNldChidWYyLCBvZmZzZXQpIHsKICByZXR1cm4gb2Zmc2V0Owp9CmZ1bmN0aW9uIHJlYWRCb29sZWFuKGJ1ZjIsIG9mZnNldCkgewogIHJldHVybiAhIXJlYWRJbnQ4KGJ1ZjIsIG9mZnNldCk7Cn0KZnVuY3Rpb24gcmVhZEludDgoYnVmMiwgb2Zmc2V0KSB7CiAgcmV0dXJuIHJlYWRVaW50OChidWYyLCBvZmZzZXQpIDw8IDI0ID4+IDI0Owp9CmZ1bmN0aW9uIHJlYWRVaW50OChidWYyLCBvZmZzZXQpIHsKICByZXR1cm4gYnVmMltvZmZzZXRdOwp9CmZ1bmN0aW9uIHJlYWRJbnQxNihidWYyLCBvZmZzZXQpIHsKICByZXR1cm4gcmVhZFVpbnQxNihidWYyLCBvZmZzZXQpIDw8IDE2ID4+IDE2Owp9CmZ1bmN0aW9uIHJlYWRVaW50MTYoYnVmMiwgb2Zmc2V0KSB7CiAgcmV0dXJuIGJ1ZjJbb2Zmc2V0XSB8IGJ1ZjJbb2Zmc2V0ICsgMV0gPDwgODsKfQpmdW5jdGlvbiByZWFkSW50MzIoYnVmMiwgb2Zmc2V0KSB7CiAgcmV0dXJuIGJ1ZjJbb2Zmc2V0XSB8IGJ1ZjJbb2Zmc2V0ICsgMV0gPDwgOCB8IGJ1ZjJbb2Zmc2V0ICsgMl0gPDwgMTYgfCBidWYyW29mZnNldCArIDNdIDw8IDI0Owp9CmZ1bmN0aW9uIHJlYWRVaW50MzIoYnVmMiwgb2Zmc2V0KSB7CiAgcmV0dXJuIHJlYWRJbnQzMihidWYyLCBvZmZzZXQpID4+PiAwOwp9CmZ1bmN0aW9uIHJlYWRJbnQ2NChidWYyLCBvZmZzZXQpIHsKICByZXR1cm4gdG9OdW1iZXIoQmlnSW50LmFzSW50TigKICAgIDY0LAogICAgQmlnSW50KHJlYWRVaW50MzIoYnVmMiwgb2Zmc2V0KSkgKyAoQmlnSW50KHJlYWRVaW50MzIoYnVmMiwgb2Zmc2V0ICsgU0laRU9GX0lOVCkpIDw8IDMybikKICApKTsKfQpmdW5jdGlvbiByZWFkU3RyaW5nKGJ1ZjIsIGluZGV4KSB7CiAgbGV0IG9mZnNldCA9IGluZGV4ICsgcmVhZEludDMyKGJ1ZjIsIGluZGV4KTsKICBjb25zdCBsZW5ndGggPSByZWFkSW50MzIoYnVmMiwgb2Zmc2V0KTsKICBvZmZzZXQgKz0gU0laRU9GX0lOVDsKICByZXR1cm4gZGVjb2RlVXRmOChidWYyLnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoKSk7Cn0KZnVuY3Rpb24gcmVhZFZlY3RvcihidWYyLCBvZmZzZXQsIHN0cmlkZSwgZXh0cmFjdCkgewogIGlmICghb2Zmc2V0KSByZXR1cm4gW107CiAgY29uc3QgYmFzZSA9IG9mZnNldCArIHJlYWRJbnQzMihidWYyLCBvZmZzZXQpOwogIHJldHVybiBBcnJheS5mcm9tKAogICAgeyBsZW5ndGg6IHJlYWRJbnQzMihidWYyLCBiYXNlKSB9LAogICAgKF8sIGkpID0+IGV4dHJhY3QoYnVmMiwgYmFzZSArIFNJWkVPRl9JTlQgKyBpICogc3RyaWRlKQogICk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvdXRpbC9zdHJ1Y3QuanMKdmFyIFJvd0luZGV4ID0gU3ltYm9sKCJyb3dJbmRleCIpOwpmdW5jdGlvbiBwcm94eUZhY3RvcnkobmFtZXMsIGJhdGNoZXMpIHsKICBjbGFzcyBSb3dPYmplY3QgewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgcHJveHkgcm93IG9iamVjdCByZXByZXNlbnRpbmcgYSBzdHJ1Y3Qgb3IgdGFibGUgcm93LgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSByZWNvcmQgYmF0Y2ggcm93IGluZGV4LgogICAgICovCiAgICBjb25zdHJ1Y3RvcihpbmRleCkgewogICAgICB0aGlzW1Jvd0luZGV4XSA9IGluZGV4OwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gYSBKU09OLWNvbXBhdGlibGUgb2JqZWN0IHJlcHJlc2VudGF0aW9uLgogICAgICovCiAgICB0b0pTT04oKSB7CiAgICAgIHJldHVybiBzdHJ1Y3RPYmplY3QobmFtZXMsIGJhdGNoZXMsIHRoaXNbUm93SW5kZXhdKTsKICAgIH0KICB9CiAgOwogIGNvbnN0IHByb3RvID0gUm93T2JqZWN0LnByb3RvdHlwZTsKICBmb3IgKGxldCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgKytpKSB7CiAgICBpZiAoT2JqZWN0Lmhhc093bihwcm90bywgbmFtZXNbaV0pKSBjb250aW51ZTsKICAgIGNvbnN0IGJhdGNoID0gYmF0Y2hlc1tpXTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90bywgbmFtZXNbaV0sIHsKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiBiYXRjaC5hdCh0aGlzW1Jvd0luZGV4XSk7CiAgICAgIH0sCiAgICAgIGVudW1lcmFibGU6IHRydWUKICAgIH0pOwogIH0KICByZXR1cm4gKGluZGV4KSA9PiBuZXcgUm93T2JqZWN0KGluZGV4KTsKfQpmdW5jdGlvbiBvYmplY3RGYWN0b3J5KG5hbWVzLCBiYXRjaGVzKSB7CiAgcmV0dXJuIChpbmRleCkgPT4gc3RydWN0T2JqZWN0KG5hbWVzLCBiYXRjaGVzLCBpbmRleCk7Cn0KZnVuY3Rpb24gc3RydWN0T2JqZWN0KG5hbWVzLCBiYXRjaGVzLCBpbmRleCkgewogIGNvbnN0IG9iaiA9IHt9OwogIGZvciAobGV0IGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyArK2kpIHsKICAgIG9ialtuYW1lc1tpXV0gPSBiYXRjaGVzW2ldLmF0KGluZGV4KTsKICB9CiAgcmV0dXJuIG9iajsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy9iYXRjaC5qcwpmdW5jdGlvbiBpc0RpcmVjdEJhdGNoKGJhdGNoKSB7CiAgcmV0dXJuIGJhdGNoIGluc3RhbmNlb2YgRGlyZWN0QmF0Y2g7Cn0KdmFyIEJhdGNoID0gY2xhc3MgewogIC8qKgogICAqIFRoZSBhcnJheSB0eXBlIHRvIHVzZSB3aGVuIGV4dHJhY3RpbmcgZGF0YSBmcm9tIHRoZSBiYXRjaC4KICAgKiBBIG51bGwgdmFsdWUgaW5kaWNhdGVzIHRoYXQgdGhlIGFycmF5IHR5cGUgc2hvdWxkIG1hdGNoCiAgICogdGhlIHR5cGUgb2YgdGhlIGJhdGNoJ3MgdmFsdWVzIGFycmF5LgogICAqIEB0eXBlIHtBcnJheUNvbnN0cnVjdG9yIHwgaW1wb3J0KCcuL3R5cGVzLmpzJykuVHlwZWRBcnJheUNvbnN0cnVjdG9yIHwgbnVsbH0KICAgKi8KICBzdGF0aWMgQXJyYXlUeXBlID0gbnVsbDsKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgY29sdW1uIGJhdGNoLgogICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubGVuZ3RoIFRoZSBsZW5ndGggb2YgdGhlIGJhdGNoCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubnVsbENvdW50IFRoZSBudWxsIHZhbHVlIGNvdW50CiAgICogQHBhcmFtIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5EYXRhVHlwZX0gb3B0aW9ucy50eXBlIFRoZSBkYXRhIHR5cGUuCiAgICogQHBhcmFtIHtVaW50OEFycmF5fSBbb3B0aW9ucy52YWxpZGl0eV0gVmFsaWRpdHkgYml0bWFwIGJ1ZmZlcgogICAqIEBwYXJhbSB7aW1wb3J0KCcuL3R5cGVzLmpzJykuVHlwZWRBcnJheX0gW29wdGlvbnMudmFsdWVzXSBWYWx1ZXMgYnVmZmVyCiAgICogQHBhcmFtIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5PZmZzZXRBcnJheX0gW29wdGlvbnMub2Zmc2V0c10gT2Zmc2V0cyBidWZmZXIKICAgKiBAcGFyYW0ge2ltcG9ydCgnLi90eXBlcy5qcycpLk9mZnNldEFycmF5fSBbb3B0aW9ucy5zaXplc10gU2l6ZXMgYnVmZmVyCiAgICogQHBhcmFtIHtCYXRjaFtdfSBbb3B0aW9ucy5jaGlsZHJlbl0gQ2hpbGRyZW4gYmF0Y2hlcwogICAqLwogIGNvbnN0cnVjdG9yKHsKICAgIGxlbmd0aCwKICAgIG51bGxDb3VudCwKICAgIHR5cGUsCiAgICB2YWxpZGl0eSwKICAgIHZhbHVlcywKICAgIG9mZnNldHMsCiAgICBzaXplcywKICAgIGNoaWxkcmVuOiBjaGlsZHJlbjIKICB9KSB7CiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aDsKICAgIHRoaXMubnVsbENvdW50ID0gbnVsbENvdW50OwogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMudmFsaWRpdHkgPSB2YWxpZGl0eTsKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzOwogICAgdGhpcy5vZmZzZXRzID0gb2Zmc2V0czsKICAgIHRoaXMuc2l6ZXMgPSBzaXplczsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjI7CiAgICBpZiAoIW51bGxDb3VudCB8fCAhdGhpcy52YWxpZGl0eSkgewogICAgICB0aGlzLmF0ID0gKGluZGV4KSA9PiB0aGlzLnZhbHVlKGluZGV4KTsKICAgIH0KICB9CiAgLyoqCiAgICogUHJvdmlkZSBhbiBpbmZvcm1hdGl2ZSBvYmplY3Qgc3RyaW5nIHRhZy4KICAgKi8KICBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7CiAgICByZXR1cm4gIkJhdGNoIjsKICB9CiAgLyoqCiAgICogUmV0dXJuIHRoZSB2YWx1ZSBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleC4KICAgKiBAcmV0dXJucyB7VCB8IG51bGx9IFRoZSB2YWx1ZS4KICAgKi8KICBhdChpbmRleCkgewogICAgcmV0dXJuIHRoaXMuaXNWYWxpZChpbmRleCkgPyB0aGlzLnZhbHVlKGluZGV4KSA6IG51bGw7CiAgfQogIC8qKgogICAqIENoZWNrIGlmIGEgdmFsdWUgYXQgdGhlIGdpdmVuIGluZGV4IGlzIHZhbGlkIChub24tbnVsbCkuCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleC4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB2YWxpZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIGlzVmFsaWQoaW5kZXgpIHsKICAgIHJldHVybiBkZWNvZGVCaXQodGhpcy52YWxpZGl0eSwgaW5kZXgpOwogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIHZhbHVlIGF0IHRoZSBnaXZlbiBpbmRleC4gVGhpcyBtZXRob2QgZG9lcyBub3QgY2hlY2sgdGhlCiAgICogdmFsaWRpdHkgYml0bWFwIGFuZCBpcyBpbnRlbmRlZCBwcmltYXJpbHkgZm9yIGludGVybmFsIHVzZS4gSW4gbW9zdAogICAqIGNhc2VzLCBjYWxsZXJzIHNob3VsZCB1c2UgdGhlIGBhdCgpYCBtZXRob2QgaW5zdGVhZC4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICogQHJldHVybnMge1R9IFRoZSB2YWx1ZSwgaWdub3JpbmcgdGhlIHZhbGlkaXR5IGJpdG1hcC4KICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuICgKICAgICAgLyoqIEB0eXBlIHtUfSAqLwogICAgICB0aGlzLnZhbHVlc1tpbmRleF0KICAgICk7CiAgfQogIC8qKgogICAqIEV4dHJhY3QgYW4gYXJyYXkgb2YgdmFsdWVzIHdpdGhpbiB0aGUgZ2l2ZW4gaW5kZXggcmFuZ2UuIFVubGlrZQogICAqIEFycmF5LnNsaWNlLCBhbGwgYXJndW1lbnRzIGFyZSByZXF1aXJlZCBhbmQgbWF5IG5vdCBiZSBuZWdhdGl2ZSBpbmRpY2VzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBUaGUgc3RhcnRpbmcgaW5kZXgsIGluY2x1c2l2ZQogICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZGluZyBpbmRleCwgZXhjbHVzaXZlCiAgICogQHJldHVybnMge2ltcG9ydCgnLi90eXBlcy5qcycpLlZhbHVlQXJyYXk8VD8+fSBUaGUgc2xpY2Ugb2YgdmFsdWVzCiAgICovCiAgc2xpY2Uoc3RhcnQsIGVuZCkgewogICAgY29uc3QgbiA9IGVuZCAtIHN0YXJ0OwogICAgY29uc3QgdmFsdWVzID0gQXJyYXkobik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YWx1ZXNbaV0gPSB0aGlzLmF0KHN0YXJ0ICsgaSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH0KICAvKioKICAgKiBSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgdmFsdWVzIGluIHRoaXMgYmF0Y2guCiAgICogQHJldHVybnMge0l0ZXJhdG9yPFQ/Pn0KICAgKi8KICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyArK2kpIHsKICAgICAgeWllbGQgdGhpcy5hdChpKTsKICAgIH0KICB9Cn07CnZhciBEaXJlY3RCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQmF0Y2ggewogIC8qKgogICAqIENyZWF0ZSBhIG5ldyBjb2x1bW4gYmF0Y2ggd2l0aCBkaXJlY3QgdmFsdWUgYXJyYXkgYWNjZXNzLgogICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubGVuZ3RoIFRoZSBsZW5ndGggb2YgdGhlIGJhdGNoCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubnVsbENvdW50IFRoZSBudWxsIHZhbHVlIGNvdW50CiAgICogQHBhcmFtIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5EYXRhVHlwZX0gb3B0aW9ucy50eXBlIFRoZSBkYXRhIHR5cGUuCiAgICogQHBhcmFtIHtVaW50OEFycmF5fSBbb3B0aW9ucy52YWxpZGl0eV0gVmFsaWRpdHkgYml0bWFwIGJ1ZmZlcgogICAqIEBwYXJhbSB7aW1wb3J0KCcuL3R5cGVzLmpzJykuVHlwZWRBcnJheX0gb3B0aW9ucy52YWx1ZXMgVmFsdWVzIGJ1ZmZlcgogICAqLwogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgIHN1cGVyKG9wdGlvbnMpOwogICAgY29uc3QgeyBsZW5ndGgsIHZhbHVlcyB9ID0gdGhpczsKICAgIHRoaXMudmFsdWVzID0gdmFsdWVzLnN1YmFycmF5KDAsIGxlbmd0aCk7CiAgfQogIC8qKgogICAqIEV4dHJhY3QgYW4gYXJyYXkgb2YgdmFsdWVzIHdpdGhpbiB0aGUgZ2l2ZW4gaW5kZXggcmFuZ2UuIFVubGlrZQogICAqIEFycmF5LnNsaWNlLCBhbGwgYXJndW1lbnRzIGFyZSByZXF1aXJlZCBhbmQgbWF5IG5vdCBiZSBuZWdhdGl2ZSBpbmRpY2VzLgogICAqIFdoZW4gZmVhc2libGUsIGEgemVyby1jb3B5IHN1YmFycmF5IG9mIGEgdHlwZWQgYXJyYXkgaXMgcmV0dXJuZWQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IFRoZSBzdGFydGluZyBpbmRleCwgaW5jbHVzaXZlCiAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kaW5nIGluZGV4LCBleGNsdXNpdmUKICAgKiBAcmV0dXJucyB7aW1wb3J0KCcuL3R5cGVzLmpzJykuVmFsdWVBcnJheTxUPz59IFRoZSBzbGljZSBvZiB2YWx1ZXMKICAgKi8KICBzbGljZShzdGFydCwgZW5kKSB7CiAgICByZXR1cm4gdGhpcy5udWxsQ291bnQgPyBzdXBlci5zbGljZShzdGFydCwgZW5kKSA6IHRoaXMudmFsdWVzLnN1YmFycmF5KHN0YXJ0LCBlbmQpOwogIH0KICAvKioKICAgKiBSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgdmFsdWVzIGluIHRoaXMgYmF0Y2guCiAgICogQHJldHVybnMge0l0ZXJhdG9yPFQ/Pn0KICAgKi8KICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLm51bGxDb3VudCA/IHN1cGVyW1N5bWJvbC5pdGVyYXRvcl0oKSA6ICgKICAgICAgLyoqIEB0eXBlIHtJdGVyYXRvcjxUPz59ICovCiAgICAgIHRoaXMudmFsdWVzW1N5bWJvbC5pdGVyYXRvcl0oKQogICAgKTsKICB9Cn07CnZhciBOdW1iZXJCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQmF0Y2ggewogIHN0YXRpYyBBcnJheVR5cGUgPSBmbG9hdDY0QXJyYXk7Cn07CnZhciBBcnJheUJhdGNoID0gY2xhc3MgZXh0ZW5kcyBCYXRjaCB7CiAgc3RhdGljIEFycmF5VHlwZSA9IEFycmF5Owp9Owp2YXIgTnVsbEJhdGNoID0gY2xhc3MgZXh0ZW5kcyBBcnJheUJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICogQHJldHVybnMge251bGx9CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKdmFyIEludDY0QmF0Y2ggPSBjbGFzcyBleHRlbmRzIE51bWJlckJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiB0b051bWJlcigKICAgICAgLyoqIEB0eXBlIHtiaWdpbnR9ICovCiAgICAgIHRoaXMudmFsdWVzW2luZGV4XQogICAgKTsKICB9Cn07CnZhciBGbG9hdDE2QmF0Y2ggPSBjbGFzcyBleHRlbmRzIE51bWJlckJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIGNvbnN0IHYgPSAoCiAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLwogICAgICB0aGlzLnZhbHVlc1tpbmRleF0KICAgICk7CiAgICBjb25zdCBleHBvID0gKHYgJiAzMTc0NCkgPj4gMTA7CiAgICBjb25zdCBzaWdmID0gKHYgJiAxMDIzKSAvIDEwMjQ7CiAgICBjb25zdCBzaWduMiA9ICgtMSkgKiogKCh2ICYgMzI3NjgpID4+IDE1KTsKICAgIHN3aXRjaCAoZXhwbykgewogICAgICBjYXNlIDMxOgogICAgICAgIHJldHVybiBzaWduMiAqIChzaWdmID8gTnVtYmVyLk5hTiA6IDEgLyAwKTsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiBzaWduMiAqIChzaWdmID8gNjEwMzUxNTYyNWUtMTQgKiBzaWdmIDogMCk7CiAgICB9CiAgICByZXR1cm4gc2lnbjIgKiAyICoqIChleHBvIC0gMTUpICogKDEgKyBzaWdmKTsKICB9Cn07CnZhciBCb29sQmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXgKICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIGRlY29kZUJpdCgKICAgICAgLyoqIEB0eXBlIHtVaW50OEFycmF5fSAqLwogICAgICB0aGlzLnZhbHVlcywKICAgICAgaW5kZXgKICAgICk7CiAgfQp9Owp2YXIgRGVjaW1hbDMyTnVtYmVyQmF0Y2ggPSBjbGFzcyBleHRlbmRzIE51bWJlckJhdGNoIHsKICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICBzdXBlcihvcHRpb25zKTsKICAgIGNvbnN0IHsgc2NhbGUgfSA9ICgKICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5EZWNpbWFsVHlwZX0gKi8KICAgICAgdGhpcy50eXBlCiAgICApOwogICAgdGhpcy5zY2FsZSA9IDEwICoqIHNjYWxlOwogIH0KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiAoCiAgICAgIC8qKiBAdHlwZSB7bnVtYmVyfSAqLwogICAgICB0aGlzLnZhbHVlc1tpbmRleF0gLyB0aGlzLnNjYWxlCiAgICApOwogIH0KfTsKdmFyIERlY2ltYWxCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQmF0Y2ggewogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgIHN1cGVyKG9wdGlvbnMpOwogICAgY29uc3QgeyBiaXRXaWR0aCwgc2NhbGUgfSA9ICgKICAgICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5EZWNpbWFsVHlwZX0gKi8KICAgICAgdGhpcy50eXBlCiAgICApOwogICAgdGhpcy5kZWNpbWFsID0gYml0V2lkdGggPT09IDY0ID8gZnJvbURlY2ltYWw2NCA6IGJpdFdpZHRoID09PSAxMjggPyBmcm9tRGVjaW1hbDEyOCA6IGZyb21EZWNpbWFsMjU2OwogICAgdGhpcy5zY2FsZSA9IDEwbiAqKiBCaWdJbnQoc2NhbGUpOwogIH0KfTsKdmFyIERlY2ltYWxOdW1iZXJCYXRjaCA9IGNsYXNzIGV4dGVuZHMgRGVjaW1hbEJhdGNoIHsKICBzdGF0aWMgQXJyYXlUeXBlID0gZmxvYXQ2NEFycmF5OwogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXgKICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIGRpdmlkZSgKICAgICAgdGhpcy5kZWNpbWFsKAogICAgICAgIC8qKiBAdHlwZSB7QmlnVWludDY0QXJyYXl9ICovCiAgICAgICAgdGhpcy52YWx1ZXMsCiAgICAgICAgaW5kZXgKICAgICAgKSwKICAgICAgdGhpcy5zY2FsZQogICAgKTsKICB9Cn07CnZhciBEZWNpbWFsQmlnSW50QmF0Y2ggPSBjbGFzcyBleHRlbmRzIERlY2ltYWxCYXRjaCB7CiAgc3RhdGljIEFycmF5VHlwZSA9IEFycmF5OwogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXgKICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIHRoaXMuZGVjaW1hbCgKICAgICAgLyoqIEB0eXBlIHtCaWdVaW50NjRBcnJheX0gKi8KICAgICAgdGhpcy52YWx1ZXMsCiAgICAgIGluZGV4CiAgICApOwogIH0KfTsKdmFyIERhdGVCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IGRhdGUgYmF0Y2guCiAgICogQHBhcmFtIHtCYXRjaDxudW1iZXI+fSBiYXRjaCBBIGJhdGNoIG9mIHRpbWVzdGFtcCB2YWx1ZXMuCiAgICovCiAgY29uc3RydWN0b3IoYmF0Y2gpIHsKICAgIHN1cGVyKGJhdGNoKTsKICAgIHRoaXMuc291cmNlID0gYmF0Y2g7CiAgfQogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXgKICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMuc291cmNlLnZhbHVlKGluZGV4KSk7CiAgfQp9Owp2YXIgRGF0ZURheUJhdGNoID0gY2xhc3MgZXh0ZW5kcyBOdW1iZXJCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleAogICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiA4NjRlNSAqIC8qKiBAdHlwZSB7bnVtYmVyfSAqLwogICAgdGhpcy52YWx1ZXNbaW5kZXhdOwogIH0KfTsKdmFyIERhdGVEYXlNaWxsaXNlY29uZEJhdGNoID0gSW50NjRCYXRjaDsKdmFyIFRpbWVzdGFtcFNlY29uZEJhdGNoID0gY2xhc3MgZXh0ZW5kcyBJbnQ2NEJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBzdXBlci52YWx1ZShpbmRleCkgKiAxZTM7CiAgfQp9Owp2YXIgVGltZXN0YW1wTWlsbGlzZWNvbmRCYXRjaCA9IEludDY0QmF0Y2g7CnZhciBUaW1lc3RhbXBNaWNyb3NlY29uZEJhdGNoID0gY2xhc3MgZXh0ZW5kcyBJbnQ2NEJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBkaXZpZGUoCiAgICAgIC8qKiBAdHlwZSB7YmlnaW50fSAqLwogICAgICB0aGlzLnZhbHVlc1tpbmRleF0sCiAgICAgIDEwMDBuCiAgICApOwogIH0KfTsKdmFyIFRpbWVzdGFtcE5hbm9zZWNvbmRCYXRjaCA9IGNsYXNzIGV4dGVuZHMgSW50NjRCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleAogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICByZXR1cm4gZGl2aWRlKAogICAgICAvKiogQHR5cGUge2JpZ2ludH0gKi8KICAgICAgdGhpcy52YWx1ZXNbaW5kZXhdLAogICAgICAxMDAwMDAwbgogICAgKTsKICB9Cn07CnZhciBJbnRlcnZhbERheVRpbWVCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleAogICAqIEByZXR1cm5zIHtJbnQzMkFycmF5fQogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICBjb25zdCB2YWx1ZXMgPSAoCiAgICAgIC8qKiBAdHlwZSB7SW50MzJBcnJheX0gKi8KICAgICAgdGhpcy52YWx1ZXMKICAgICk7CiAgICByZXR1cm4gdmFsdWVzLnN1YmFycmF5KGluZGV4IDw8IDEsIGluZGV4ICsgMSA8PCAxKTsKICB9Cn07CnZhciBJbnRlcnZhbE1vbnRoRGF5TmFub0JhdGNoID0gY2xhc3MgZXh0ZW5kcyBBcnJheUJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIGNvbnN0IHZhbHVlcyA9ICgKICAgICAgLyoqIEB0eXBlIHtVaW50OEFycmF5fSAqLwogICAgICB0aGlzLnZhbHVlcwogICAgKTsKICAgIGNvbnN0IGJhc2UgPSBpbmRleCA8PCA0OwogICAgcmV0dXJuIEZsb2F0NjRBcnJheS5vZigKICAgICAgcmVhZEludDMyKHZhbHVlcywgYmFzZSksCiAgICAgIHJlYWRJbnQzMih2YWx1ZXMsIGJhc2UgKyA0KSwKICAgICAgcmVhZEludDY0KHZhbHVlcywgYmFzZSArIDgpCiAgICApOwogIH0KfTsKdmFyIG9mZnNldDMyID0gKHsgdmFsdWVzLCBvZmZzZXRzIH0sIGluZGV4KSA9PiB2YWx1ZXMuc3ViYXJyYXkob2Zmc2V0c1tpbmRleF0sIG9mZnNldHNbaW5kZXggKyAxXSk7CnZhciBvZmZzZXQ2NCA9ICh7IHZhbHVlcywgb2Zmc2V0cyB9LCBpbmRleCkgPT4gdmFsdWVzLnN1YmFycmF5KHRvTnVtYmVyKG9mZnNldHNbaW5kZXhdKSwgdG9OdW1iZXIob2Zmc2V0c1tpbmRleCArIDFdKSk7CnZhciBCaW5hcnlCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICogQHJldHVybnMge1VpbnQ4QXJyYXl9CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBvZmZzZXQzMih0aGlzLCBpbmRleCk7CiAgfQp9Owp2YXIgTGFyZ2VCaW5hcnlCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICogQHJldHVybnMge1VpbnQ4QXJyYXl9CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBvZmZzZXQ2NCh0aGlzLCBpbmRleCk7CiAgfQp9Owp2YXIgVXRmOEJhdGNoID0gY2xhc3MgZXh0ZW5kcyBBcnJheUJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIGRlY29kZVV0Zjgob2Zmc2V0MzIodGhpcywgaW5kZXgpKTsKICB9Cn07CnZhciBMYXJnZVV0ZjhCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBkZWNvZGVVdGY4KG9mZnNldDY0KHRoaXMsIGluZGV4KSk7CiAgfQp9Owp2YXIgTGlzdEJhdGNoID0gY2xhc3MgZXh0ZW5kcyBBcnJheUJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgKiBAcmV0dXJucyB7aW1wb3J0KCcuL3R5cGVzLmpzJykuVmFsdWVBcnJheTxWPn0KICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgY29uc3Qgb2Zmc2V0cyA9ICgKICAgICAgLyoqIEB0eXBlIHtJbnQzMkFycmF5fSAqLwogICAgICB0aGlzLm9mZnNldHMKICAgICk7CiAgICByZXR1cm4gdGhpcy5jaGlsZHJlblswXS5zbGljZShvZmZzZXRzW2luZGV4XSwgb2Zmc2V0c1tpbmRleCArIDFdKTsKICB9Cn07CnZhciBMYXJnZUxpc3RCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICogQHJldHVybnMge2ltcG9ydCgnLi90eXBlcy5qcycpLlZhbHVlQXJyYXk8Vj59CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIGNvbnN0IG9mZnNldHMgPSAoCiAgICAgIC8qKiBAdHlwZSB7QmlnSW50NjRBcnJheX0gKi8KICAgICAgdGhpcy5vZmZzZXRzCiAgICApOwogICAgcmV0dXJuIHRoaXMuY2hpbGRyZW5bMF0uc2xpY2UodG9OdW1iZXIob2Zmc2V0c1tpbmRleF0pLCB0b051bWJlcihvZmZzZXRzW2luZGV4ICsgMV0pKTsKICB9Cn07CnZhciBMaXN0Vmlld0JhdGNoID0gY2xhc3MgZXh0ZW5kcyBBcnJheUJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgKiBAcmV0dXJucyB7aW1wb3J0KCcuL3R5cGVzLmpzJykuVmFsdWVBcnJheTxWPn0KICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgY29uc3QgYSA9ICgKICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICAgIHRoaXMub2Zmc2V0c1tpbmRleF0KICAgICk7CiAgICBjb25zdCBiID0gYSArIC8qKiBAdHlwZSB7bnVtYmVyfSAqLwogICAgdGhpcy5zaXplc1tpbmRleF07CiAgICByZXR1cm4gdGhpcy5jaGlsZHJlblswXS5zbGljZShhLCBiKTsKICB9Cn07CnZhciBMYXJnZUxpc3RWaWV3QmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogICAqIEByZXR1cm5zIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5WYWx1ZUFycmF5PFY+fQogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICBjb25zdCBhID0gKAogICAgICAvKiogQHR5cGUge2JpZ2ludH0gKi8KICAgICAgdGhpcy5vZmZzZXRzW2luZGV4XQogICAgKTsKICAgIGNvbnN0IGIgPSBhICsgLyoqIEB0eXBlIHtiaWdpbnR9ICovCiAgICB0aGlzLnNpemVzW2luZGV4XTsKICAgIHJldHVybiB0aGlzLmNoaWxkcmVuWzBdLnNsaWNlKHRvTnVtYmVyKGEpLCB0b051bWJlcihiKSk7CiAgfQp9Owp2YXIgRml4ZWRCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgc3VwZXIob3B0aW9ucyk7CiAgICB0aGlzLnN0cmlkZSA9IHRoaXMudHlwZS5zdHJpZGU7CiAgfQp9Owp2YXIgRml4ZWRCaW5hcnlCYXRjaCA9IGNsYXNzIGV4dGVuZHMgRml4ZWRCYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICogQHJldHVybnMge1VpbnQ4QXJyYXl9CiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIGNvbnN0IHsgc3RyaWRlLCB2YWx1ZXMgfSA9IHRoaXM7CiAgICByZXR1cm4gKAogICAgICAvKiogQHR5cGUge1VpbnQ4QXJyYXl9ICovCiAgICAgIHZhbHVlcy5zdWJhcnJheShpbmRleCAqIHN0cmlkZSwgKGluZGV4ICsgMSkgKiBzdHJpZGUpCiAgICApOwogIH0KfTsKdmFyIEZpeGVkTGlzdEJhdGNoID0gY2xhc3MgZXh0ZW5kcyBGaXhlZEJhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgKiBAcmV0dXJucyB7aW1wb3J0KCcuL3R5cGVzLmpzJykuVmFsdWVBcnJheTxWPn0KICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgY29uc3QgeyBjaGlsZHJlbjogY2hpbGRyZW4yLCBzdHJpZGUgfSA9IHRoaXM7CiAgICByZXR1cm4gY2hpbGRyZW4yWzBdLnNsaWNlKGluZGV4ICogc3RyaWRlLCAoaW5kZXggKyAxKSAqIHN0cmlkZSk7CiAgfQp9OwpmdW5jdGlvbiBwYWlycyh7IGNoaWxkcmVuOiBjaGlsZHJlbjIsIG9mZnNldHMgfSwgaW5kZXgpIHsKICBjb25zdCBba2V5czIsIHZhbHNdID0gY2hpbGRyZW4yWzBdLmNoaWxkcmVuOwogIGNvbnN0IHN0YXJ0ID0gb2Zmc2V0c1tpbmRleF07CiAgY29uc3QgZW5kID0gb2Zmc2V0c1tpbmRleCArIDFdOwogIGNvbnN0IGVudHJpZXMgPSBbXTsKICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgZW50cmllcy5wdXNoKFtrZXlzMi5hdChpKSwgdmFscy5hdChpKV0pOwogIH0KICByZXR1cm4gZW50cmllczsKfQp2YXIgTWFwRW50cnlCYXRjaCA9IGNsYXNzIGV4dGVuZHMgQXJyYXlCYXRjaCB7CiAgLyoqCiAgICogUmV0dXJuIHRoZSB2YWx1ZSBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleC4KICAgKiBAcmV0dXJucyB7W0ssIFZdW119IFRoZSBtYXAgZW50cmllcyBhcyBhbiBhcnJheSBvZiBba2V5LCB2YWx1ZV0gYXJyYXlzLgogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICByZXR1cm4gKAogICAgICAvKiogQHR5cGUge1tLLCBWXVtdfSAqLwogICAgICBwYWlycyh0aGlzLCBpbmRleCkKICAgICk7CiAgfQp9Owp2YXIgTWFwQmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIC8qKgogICAqIFJldHVybiB0aGUgdmFsdWUgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXguCiAgICogQHJldHVybnMge01hcDxLLCBWPn0gVGhlIG1hcCB2YWx1ZS4KICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIG5ldyBNYXAoCiAgICAgIC8qKiBAdHlwZSB7W0ssIFZdW119ICovCiAgICAgIHBhaXJzKHRoaXMsIGluZGV4KQogICAgKTsKICB9Cn07CnZhciBTcGFyc2VVbmlvbkJhdGNoID0gY2xhc3MgZXh0ZW5kcyBBcnJheUJhdGNoIHsKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgY29sdW1uIGJhdGNoLgogICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubGVuZ3RoIFRoZSBsZW5ndGggb2YgdGhlIGJhdGNoCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubnVsbENvdW50IFRoZSBudWxsIHZhbHVlIGNvdW50CiAgICogQHBhcmFtIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5EYXRhVHlwZX0gb3B0aW9ucy50eXBlIFRoZSBkYXRhIHR5cGUuCiAgICogQHBhcmFtIHtVaW50OEFycmF5fSBbb3B0aW9ucy52YWxpZGl0eV0gVmFsaWRpdHkgYml0bWFwIGJ1ZmZlcgogICAqIEBwYXJhbSB7SW50MzJBcnJheX0gW29wdGlvbnMub2Zmc2V0c10gT2Zmc2V0cyBidWZmZXIKICAgKiBAcGFyYW0ge0JhdGNoW119IG9wdGlvbnMuY2hpbGRyZW4gQ2hpbGRyZW4gYmF0Y2hlcwogICAqIEBwYXJhbSB7SW50OEFycmF5fSBvcHRpb25zLnR5cGVJZHMgVW5pb24gdHlwZSBpZHMgYnVmZmVyCiAgICogQHBhcmFtIHtSZWNvcmQ8c3RyaW5nLCBudW1iZXI+fSBvcHRpb25zLm1hcCBBIHR5cGVJZCB0byBjaGlsZHJlbiBpbmRleCBtYXAKICAgKi8KICBjb25zdHJ1Y3Rvcih7IHR5cGVJZHMsIC4uLm9wdGlvbnMgfSkgewogICAgc3VwZXIob3B0aW9ucyk7CiAgICB0aGlzLnR5cGVJZHMgPSB0eXBlSWRzOwogICAgdGhpcy50eXBlTWFwID0gdGhpcy50eXBlLnR5cGVNYXA7CiAgfQogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXguCiAgICovCiAgdmFsdWUoaW5kZXgsIG9mZnNldCA9IGluZGV4KSB7CiAgICBjb25zdCB7IHR5cGVJZHMsIGNoaWxkcmVuOiBjaGlsZHJlbjIsIHR5cGVNYXAgfSA9IHRoaXM7CiAgICByZXR1cm4gY2hpbGRyZW4yW3R5cGVNYXBbdHlwZUlkc1tpbmRleF1dXS5hdChvZmZzZXQpOwogIH0KfTsKdmFyIERlbnNlVW5pb25CYXRjaCA9IGNsYXNzIGV4dGVuZHMgU3BhcnNlVW5pb25CYXRjaCB7CiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSB2YWx1ZSBpbmRleC4KICAgKi8KICB2YWx1ZShpbmRleCkgewogICAgcmV0dXJuIHN1cGVyLnZhbHVlKAogICAgICBpbmRleCwKICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICAgIHRoaXMub2Zmc2V0c1tpbmRleF0KICAgICk7CiAgfQp9Owp2YXIgU3RydWN0QmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIGNvbnN0cnVjdG9yKG9wdGlvbnMsIGZhY3RvcnkgPSBvYmplY3RGYWN0b3J5KSB7CiAgICBzdXBlcihvcHRpb25zKTsKICAgIHRoaXMubmFtZXMgPSB0aGlzLnR5cGUuY2hpbGRyZW4ubWFwKChjaGlsZCkgPT4gY2hpbGQubmFtZSk7CiAgICB0aGlzLmZhY3RvcnkgPSBmYWN0b3J5KHRoaXMubmFtZXMsIHRoaXMuY2hpbGRyZW4pOwogIH0KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4LgogICAqIEByZXR1cm5zIHtSZWNvcmQ8c3RyaW5nLCBhbnk+fQogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5mYWN0b3J5KGluZGV4KTsKICB9Cn07CnZhciBTdHJ1Y3RQcm94eUJhdGNoID0gY2xhc3MgZXh0ZW5kcyBTdHJ1Y3RCYXRjaCB7CiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgc3VwZXIob3B0aW9ucywgcHJveHlGYWN0b3J5KTsKICB9Cn07CnZhciBSdW5FbmRFbmNvZGVkQmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXguCiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIGNvbnN0IFt7IHZhbHVlczogcnVucyB9LCB2YWxzXSA9IHRoaXMuY2hpbGRyZW47CiAgICByZXR1cm4gdmFscy5hdCgKICAgICAgYmlzZWN0KAogICAgICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuL3R5cGVzLmpzJykuSW50ZWdlckFycmF5fSAqLwogICAgICAgIHJ1bnMsCiAgICAgICAgaW5kZXgKICAgICAgKQogICAgKTsKICB9Cn07CnZhciBEaWN0aW9uYXJ5QmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIC8qKgogICAqIFJlZ2lzdGVyIHRoZSBiYWNraW5nIGRpY3Rpb25hcnkuIERpY3Rpb25hcmllcyBhcmUgYWRkZWQKICAgKiBhZnRlciBiYXRjaCBjcmVhdGlvbiBhcyB0aGUgY29tcGxldGUgZGljdGlvbmFyeSBtYXkgbm90CiAgICogYmUgZmluaXNoZWQgYWNyb3NzIG11bHRpcGxlIHJlY29yZCBiYXRjaGVzLgogICAqIEBwYXJhbSB7aW1wb3J0KCcuL2NvbHVtbi5qcycpLkNvbHVtbjxUPn0gZGljdGlvbmFyeQogICAqIFRoZSBkaWN0aW9uYXJ5IG9mIGNvbHVtbiB2YWx1ZXMuCiAgICovCiAgc2V0RGljdGlvbmFyeShkaWN0aW9uYXJ5MikgewogICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTI7CiAgICB0aGlzLmNhY2hlID0gZGljdGlvbmFyeTIuY2FjaGUoKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4LgogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5jYWNoZVt0aGlzLmtleShpbmRleCldOwogIH0KICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4LgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBkaWN0aW9uYXJ5IGtleQogICAqLwogIGtleShpbmRleCkgewogICAgcmV0dXJuICgKICAgICAgLyoqIEB0eXBlIHtudW1iZXJ9ICovCiAgICAgIHRoaXMudmFsdWVzW2luZGV4XQogICAgKTsKICB9Cn07CnZhciBWaWV3QmF0Y2ggPSBjbGFzcyBleHRlbmRzIEFycmF5QmF0Y2ggewogIC8qKgogICAqIENyZWF0ZSBhIG5ldyB2aWV3IGJhdGNoLgogICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIEJhdGNoIG9wdGlvbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubGVuZ3RoIFRoZSBsZW5ndGggb2YgdGhlIGJhdGNoCiAgICogQHBhcmFtIHtudW1iZXJ9IG9wdGlvbnMubnVsbENvdW50IFRoZSBudWxsIHZhbHVlIGNvdW50CiAgICogQHBhcmFtIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5EYXRhVHlwZX0gb3B0aW9ucy50eXBlIFRoZSBkYXRhIHR5cGUuCiAgICogQHBhcmFtIHtVaW50OEFycmF5fSBbb3B0aW9ucy52YWxpZGl0eV0gVmFsaWRpdHkgYml0bWFwIGJ1ZmZlcgogICAqIEBwYXJhbSB7VWludDhBcnJheX0gb3B0aW9ucy52YWx1ZXMgVmFsdWVzIGJ1ZmZlcgogICAqIEBwYXJhbSB7VWludDhBcnJheVtdfSBvcHRpb25zLmRhdGEgVmlldyBkYXRhIGJ1ZmZlcnMKICAgKi8KICBjb25zdHJ1Y3Rvcih7IGRhdGEsIC4uLm9wdGlvbnMgfSkgewogICAgc3VwZXIob3B0aW9ucyk7CiAgICB0aGlzLmRhdGEgPSBkYXRhOwogIH0KICAvKioKICAgKiBHZXQgdGhlIGJpbmFyeSBkYXRhIGF0IHRoZSBwcm92aWRlZCBpbmRleC4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4LgogICAqIEByZXR1cm5zIHtVaW50OEFycmF5fQogICAqLwogIHZpZXcoaW5kZXgpIHsKICAgIGNvbnN0IHsgdmFsdWVzLCBkYXRhIH0gPSB0aGlzOwogICAgY29uc3Qgb2Zmc2V0ID0gaW5kZXggPDwgNDsKICAgIGxldCBzdGFydCA9IG9mZnNldCArIDQ7CiAgICBsZXQgYnVmMiA9ICgKICAgICAgLyoqIEB0eXBlIHtVaW50OEFycmF5fSAqLwogICAgICB2YWx1ZXMKICAgICk7CiAgICBjb25zdCBsZW5ndGggPSByZWFkSW50MzIoYnVmMiwgb2Zmc2V0KTsKICAgIGlmIChsZW5ndGggPiAxMikgewogICAgICBzdGFydCA9IHJlYWRJbnQzMihidWYyLCBvZmZzZXQgKyAxMik7CiAgICAgIGJ1ZjIgPSBkYXRhW3JlYWRJbnQzMihidWYyLCBvZmZzZXQgKyA4KV07CiAgICB9CiAgICByZXR1cm4gYnVmMi5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBsZW5ndGgpOwogIH0KfTsKdmFyIEJpbmFyeVZpZXdCYXRjaCA9IGNsYXNzIGV4dGVuZHMgVmlld0JhdGNoIHsKICAvKioKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHZhbHVlIGluZGV4LgogICAqLwogIHZhbHVlKGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy52aWV3KGluZGV4KTsKICB9Cn07CnZhciBVdGY4Vmlld0JhdGNoID0gY2xhc3MgZXh0ZW5kcyBWaWV3QmF0Y2ggewogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgdmFsdWUgaW5kZXguCiAgICovCiAgdmFsdWUoaW5kZXgpIHsKICAgIHJldHVybiBkZWNvZGVVdGY4KHRoaXMudmlldyhpbmRleCkpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvY29sdW1uLmpzCmZ1bmN0aW9uIGNvbHVtbkJ1aWxkZXIodHlwZSkgewogIGxldCBkYXRhID0gW107CiAgcmV0dXJuIHsKICAgIGFkZChiYXRjaCkgewogICAgICBkYXRhLnB1c2goYmF0Y2gpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBjbGVhcjogKCkgPT4gZGF0YSA9IFtdLAogICAgZG9uZTogKCkgPT4gbmV3IENvbHVtbihkYXRhLCB0eXBlKQogIH07Cn0KdmFyIENvbHVtbiA9IGNsYXNzIHsKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgY29sdW1uIGluc3RhbmNlLgogICAqIEBwYXJhbSB7aW1wb3J0KCcuL2JhdGNoLmpzJykuQmF0Y2g8VD5bXX0gZGF0YSBUaGUgdmFsdWUgYmF0Y2hlcy4KICAgKiBAcGFyYW0ge2ltcG9ydCgnLi90eXBlcy5qcycpLkRhdGFUeXBlfSBbdHlwZV0gVGhlIGNvbHVtbiBkYXRhIHR5cGUuCiAgICogIElmIG5vdCBzcGVjaWZpZWQsIHRoZSB0eXBlIGlzIGV4dHJhY3RlZCBmcm9tIHRoZSBiYXRjaGVzLgogICAqLwogIGNvbnN0cnVjdG9yKGRhdGEsIHR5cGUgPSBkYXRhWzBdPy50eXBlKSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy5sZW5ndGggPSBkYXRhLnJlZHVjZSgobSwgYykgPT4gbSArIGMubGVuZ3RoLCAwKTsKICAgIHRoaXMubnVsbENvdW50ID0gZGF0YS5yZWR1Y2UoKG0sIGMpID0+IG0gKyBjLm51bGxDb3VudCwgMCk7CiAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgY29uc3QgbiA9IGRhdGEubGVuZ3RoOwogICAgY29uc3Qgb2Zmc2V0cyA9IG5ldyBJbnQzMkFycmF5KG4gKyAxKTsKICAgIGlmIChuID09PSAxKSB7CiAgICAgIGNvbnN0IFtiYXRjaF0gPSBkYXRhOwogICAgICBvZmZzZXRzWzFdID0gYmF0Y2gubGVuZ3RoOwogICAgICB0aGlzLmF0ID0gKGluZGV4KSA9PiBiYXRjaC5hdChpbmRleCk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGxldCBpID0gMCwgcyA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgICBvZmZzZXRzW2kgKyAxXSA9IHMgKz0gZGF0YVtpXS5sZW5ndGg7CiAgICAgIH0KICAgIH0KICAgIHRoaXMub2Zmc2V0cyA9IG9mZnNldHM7CiAgfQogIC8qKgogICAqIFByb3ZpZGUgYW4gaW5mb3JtYXRpdmUgb2JqZWN0IHN0cmluZyB0YWcuCiAgICovCiAgZ2V0IFtTeW1ib2wudG9TdHJpbmdUYWddKCkgewogICAgcmV0dXJuICJDb2x1bW4iOwogIH0KICAvKioKICAgKiBSZXR1cm4gYW4gaXRlcmF0b3Igb3ZlciB0aGUgdmFsdWVzIGluIHRoaXMgY29sdW1uLgogICAqIEByZXR1cm5zIHtJdGVyYXRvcjxUPz59CiAgICovCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAxID8gZGF0YVswXVtTeW1ib2wuaXRlcmF0b3JdKCkgOiBiYXRjaGVkSXRlcmF0b3IoZGF0YSk7CiAgfQogIC8qKgogICAqIFJldHVybiB0aGUgY29sdW1uIHZhbHVlIGF0IHRoZSBnaXZlbiBpbmRleC4gSWYgYSBjb2x1bW4gaGFzIG11bHRpcGxlCiAgICogYmF0Y2hlcywgdGhpcyBtZXRob2QgcGVyZm9ybXMgYmluYXJ5IHNlYXJjaCBvdmVyIHRoZSBiYXRjaCBsZW5ndGhzIHRvCiAgICogZGV0ZXJtaW5lIHRoZSBiYXRjaCBmcm9tIHdoaWNoIHRvIHJldHJpZXZlIHRoZSB2YWx1ZS4gVGhlIHNlYXJjaCBtYWtlcwogICAqIGxvb2t1cCBsZXNzIGVmZmljaWVudCB0aGFuIGEgc3RhbmRhcmQgYXJyYXkgYWNjZXNzLiBJZiBtYWtpbmcgYSBmdWxsCiAgICogc2NhbiBvZiBhIGNvbHVtbiwgY29uc2lkZXIgZXh0cmFjdGluZyBhcnJheXMgdmlhIGB0b0FycmF5KClgIG9yIHVzaW5nIGFuCiAgICogaXRlcmF0b3IgKGBmb3IgKGNvbnN0IHZhbHVlIG9mIGNvbHVtbikgey4uLn1gKS4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHJvdyBpbmRleC4KICAgKiBAcmV0dXJucyB7VCB8IG51bGx9IFRoZSB2YWx1ZS4KICAgKi8KICBhdChpbmRleCkgewogICAgY29uc3QgeyBkYXRhLCBvZmZzZXRzIH0gPSB0aGlzOwogICAgY29uc3QgaSA9IGJpc2VjdChvZmZzZXRzLCBpbmRleCkgLSAxOwogICAgcmV0dXJuIGRhdGFbaV0/LmF0KGluZGV4IC0gb2Zmc2V0c1tpXSk7CiAgfQogIC8qKgogICAqIFJldHVybiB0aGUgY29sdW1uIHZhbHVlIGF0IHRoZSBnaXZlbiBpbmRleC4gVGhpcyBtZXRob2QgaXMgdGhlIHNhbWUgYXMKICAgKiBgYXQoKWAgYW5kIGlzIHByb3ZpZGVkIGZvciBiZXR0ZXIgY29tcGF0aWJpbGl0eSB3aXRoIEFwYWNoZSBBcnJvdyBKUy4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHJvdyBpbmRleC4KICAgKiBAcmV0dXJucyB7VCB8IG51bGx9IFRoZSB2YWx1ZS4KICAgKi8KICBnZXQoaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLmF0KGluZGV4KTsKICB9CiAgLyoqCiAgICogRXh0cmFjdCBjb2x1bW4gdmFsdWVzIGludG8gYSBzaW5nbGUgYXJyYXkgaW5zdGFuY2UuIFdoZW4gcG9zc2libGUsCiAgICogYSB6ZXJvLWNvcHkgc3ViYXJyYXkgb2YgdGhlIGlucHV0IEFycm93IGRhdGEgaXMgcmV0dXJuZWQuCiAgICogQHJldHVybnMge2ltcG9ydCgnLi90eXBlcy5qcycpLlZhbHVlQXJyYXk8VD8+fQogICAqLwogIHRvQXJyYXkoKSB7CiAgICBjb25zdCB7IGxlbmd0aCwgbnVsbENvdW50LCBkYXRhIH0gPSB0aGlzOwogICAgY29uc3QgY29weTIgPSAhbnVsbENvdW50ICYmIGlzRGlyZWN0QmF0Y2goZGF0YVswXSk7CiAgICBjb25zdCBuID0gZGF0YS5sZW5ndGg7CiAgICBpZiAoY29weTIgJiYgbiA9PT0gMSkgewogICAgICByZXR1cm4gZGF0YVswXS52YWx1ZXM7CiAgICB9CiAgICBjb25zdCBBcnJheVR5cGUgPSAhbiB8fCBudWxsQ291bnQgPiAwID8gQXJyYXkgOiBkYXRhWzBdLmNvbnN0cnVjdG9yLkFycmF5VHlwZSA/PyBkYXRhWzBdLnZhbHVlcy5jb25zdHJ1Y3RvcjsKICAgIGNvbnN0IGFycmF5MiA9IG5ldyBBcnJheVR5cGUobGVuZ3RoKTsKICAgIHJldHVybiBjb3B5MiA/IGNvcHlBcnJheShhcnJheTIsIGRhdGEpIDogZXh0cmFjdEFycmF5KGFycmF5MiwgZGF0YSk7CiAgfQogIC8qKgogICAqIFJldHVybiBhbiBhcnJheSBvZiBjYWNoZWQgY29sdW1uIHZhbHVlcy4KICAgKiBVc2VkIGludGVybmFsbHkgdG8gYWNjZWxlcmF0ZSBkaWN0aW9uYXJ5IHR5cGVzLgogICAqLwogIGNhY2hlKCkgewogICAgcmV0dXJuIHRoaXMuX2NhY2hlID8/ICh0aGlzLl9jYWNoZSA9IHRoaXMudG9BcnJheSgpKTsKICB9Cn07CmZ1bmN0aW9uKiBiYXRjaGVkSXRlcmF0b3IoZGF0YSkgewogIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkgewogICAgY29uc3QgaXRlciA9IGRhdGFbaV1bU3ltYm9sLml0ZXJhdG9yXSgpOwogICAgZm9yIChsZXQgbmV4dCA9IGl0ZXIubmV4dCgpOyAhbmV4dC5kb25lOyBuZXh0ID0gaXRlci5uZXh0KCkpIHsKICAgICAgeWllbGQgbmV4dC52YWx1ZTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gY29weUFycmF5KGFycmF5MiwgZGF0YSkgewogIGZvciAobGV0IGkgPSAwLCBvZmZzZXQgPSAwOyBpIDwgZGF0YS5sZW5ndGg7ICsraSkgewogICAgY29uc3QgeyB2YWx1ZXMgfSA9IGRhdGFbaV07CiAgICBhcnJheTIuc2V0KHZhbHVlcywgb2Zmc2V0KTsKICAgIG9mZnNldCArPSB2YWx1ZXMubGVuZ3RoOwogIH0KICByZXR1cm4gYXJyYXkyOwp9CmZ1bmN0aW9uIGV4dHJhY3RBcnJheShhcnJheTIsIGRhdGEpIHsKICBsZXQgaW5kZXggPSAtMTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyArK2kpIHsKICAgIGNvbnN0IGJhdGNoID0gZGF0YVtpXTsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYmF0Y2gubGVuZ3RoOyArK2opIHsKICAgICAgYXJyYXkyWysraW5kZXhdID0gYmF0Y2guYXQoaik7CiAgICB9CiAgfQogIHJldHVybiBhcnJheTI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvdGFibGUuanMKdmFyIFRhYmxlID0gY2xhc3MgX1RhYmxlIHsKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgdGFibGUgd2l0aCB0aGUgZ2l2ZW4gc2NoZW1hIGFuZCBjb2x1bW5zIChjaGlsZHJlbikuCiAgICogQHBhcmFtIHtpbXBvcnQoJy4vdHlwZXMuanMnKS5TY2hlbWF9IHNjaGVtYSBUaGUgdGFibGUgc2NoZW1hLgogICAqIEBwYXJhbSB7aW1wb3J0KCcuL2NvbHVtbi5qcycpLkNvbHVtbltdfSBjaGlsZHJlbiBUaGUgdGFibGUgY29sdW1ucy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VQcm94eT1mYWxzZV0gRmxhZyBpbmRpY2F0aW5nIGlmIHJvdyBwcm94eQogICAqICBvYmplY3RzIHNob3VsZCBiZSB1c2VkIHRvIHJlcHJlc2VudCB0YWJsZSByb3dzIChkZWZhdWx0IGBmYWxzZWApLgogICAqLwogIGNvbnN0cnVjdG9yKHNjaGVtYSwgY2hpbGRyZW4yLCB1c2VQcm94eSA9IGZhbHNlKSB7CiAgICBjb25zdCBuYW1lcyA9IHNjaGVtYS5maWVsZHMubWFwKChmKSA9PiBmLm5hbWUpOwogICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7CiAgICB0aGlzLm5hbWVzID0gbmFtZXM7CiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW4yOwogICAgdGhpcy5mYWN0b3J5ID0gdXNlUHJveHkgPyBwcm94eUZhY3RvcnkgOiBvYmplY3RGYWN0b3J5OwogICAgY29uc3QgZ2VuID0gW107CiAgICB0aGlzLmdldEZhY3RvcnkgPSAoYikgPT4gZ2VuW2JdID8/IChnZW5bYl0gPSB0aGlzLmZhY3RvcnkobmFtZXMsIGNoaWxkcmVuMi5tYXAoKGMpID0+IGMuZGF0YVtiXSkpKTsKICB9CiAgLyoqCiAgICogUHJvdmlkZSBhbiBpbmZvcm1hdGl2ZSBvYmplY3Qgc3RyaW5nIHRhZy4KICAgKi8KICBnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7CiAgICByZXR1cm4gIlRhYmxlIjsKICB9CiAgLyoqCiAgICogVGhlIG51bWJlciBvZiBjb2x1bW5zIGluIHRoaXMgdGFibGUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGNvbHVtbnMuCiAgICovCiAgZ2V0IG51bUNvbHMoKSB7CiAgICByZXR1cm4gdGhpcy5uYW1lcy5sZW5ndGg7CiAgfQogIC8qKgogICAqIFRoZSBudW1iZXIgb2Ygcm93cyBpbiB0aGlzIHRhYmxlLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiByb3dzLgogICAqLwogIGdldCBudW1Sb3dzKCkgewogICAgcmV0dXJuIHRoaXMuY2hpbGRyZW5bMF0/Lmxlbmd0aCA/PyAwOwogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIGNoaWxkIGNvbHVtbiBhdCB0aGUgZ2l2ZW4gaW5kZXggcG9zaXRpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSBjb2x1bW4gaW5kZXguCiAgICogQHJldHVybnMge2ltcG9ydCgnLi9jb2x1bW4uanMnKS5Db2x1bW48YW55Pn0KICAgKi8KICBnZXRDaGlsZEF0KGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbltpbmRleF07CiAgfQogIC8qKgogICAqIFJldHVybiB0aGUgZmlyc3QgY2hpbGQgY29sdW1uIHdpdGggdGhlIGdpdmVuIG5hbWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIGNvbHVtbiBuYW1lLgogICAqIEByZXR1cm5zIHtpbXBvcnQoJy4vY29sdW1uLmpzJykuQ29sdW1uPGFueT59CiAgICovCiAgZ2V0Q2hpbGQobmFtZSkgewogICAgY29uc3QgaSA9IHRoaXMubmFtZXMuZmluZEluZGV4KCh4KSA9PiB4ID09PSBuYW1lKTsKICAgIHJldHVybiBpID4gLTEgPyB0aGlzLmNoaWxkcmVuW2ldIDogdm9pZCAwOwogIH0KICAvKioKICAgKiBDb25zdHJ1Y3QgYSBuZXcgdGFibGUgY29udGFpbmluZyBvbmx5IGNvbHVtbnMgYXQgdGhlIHNwZWNpZmllZCBpbmRpY2VzLgogICAqIFRoZSBvcmRlciBvZiBjb2x1bW5zIGluIHRoZSBuZXcgdGFibGUgbWF0Y2hlcyB0aGUgb3JkZXIgb2YgaW5wdXQgaW5kaWNlcy4KICAgKiBAcGFyYW0ge251bWJlcltdfSBpbmRpY2VzIFRoZSBpbmRpY2VzIG9mIGNvbHVtbnMgdG8ga2VlcC4KICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBbYXNdIE9wdGlvbmFsIG5ldyBuYW1lcyBmb3Igc2VsZWN0ZWQgY29sdW1ucy4KICAgKiBAcmV0dXJucyB7VGFibGV9IEEgbmV3IHRhYmxlIHdpdGggY29sdW1ucyBhdCB0aGUgc3BlY2lmaWVkIGluZGljZXMuCiAgICovCiAgc2VsZWN0QXQoaW5kaWNlcywgYXMgPSBbXSkgewogICAgY29uc3QgeyBjaGlsZHJlbjogY2hpbGRyZW4yLCBmYWN0b3J5LCBzY2hlbWEgfSA9IHRoaXM7CiAgICBjb25zdCB7IGZpZWxkcyB9ID0gc2NoZW1hOwogICAgcmV0dXJuIG5ldyBfVGFibGUoCiAgICAgIHsKICAgICAgICAuLi5zY2hlbWEsCiAgICAgICAgZmllbGRzOiBpbmRpY2VzLm1hcCgoaSwgaikgPT4gcmVuYW1lRmllbGQoZmllbGRzW2ldLCBhc1tqXSkpCiAgICAgIH0sCiAgICAgIGluZGljZXMubWFwKChpKSA9PiBjaGlsZHJlbjJbaV0pLAogICAgICBmYWN0b3J5ID09PSBwcm94eUZhY3RvcnkKICAgICk7CiAgfQogIC8qKgogICAqIENvbnN0cnVjdCBhIG5ldyB0YWJsZSBjb250YWluaW5nIG9ubHkgY29sdW1ucyB3aXRoIHRoZSBzcGVjaWZpZWQgbmFtZXMuCiAgICogSWYgY29sdW1ucyBoYXZlIGR1cGxpY2F0ZSBuYW1lcywgdGhlIGZpcnN0ICh3aXRoIGxvd2VzdCBpbmRleCkgaXMgdXNlZC4KICAgKiBUaGUgb3JkZXIgb2YgY29sdW1ucyBpbiB0aGUgbmV3IHRhYmxlIG1hdGNoZXMgdGhlIG9yZGVyIG9mIGlucHV0IG5hbWVzLgogICAqIEBwYXJhbSB7c3RyaW5nW119IG5hbWVzIE5hbWVzIG9mIGNvbHVtbnMgdG8ga2VlcC4KICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBbYXNdIE9wdGlvbmFsIG5ldyBuYW1lcyBmb3Igc2VsZWN0ZWQgY29sdW1ucy4KICAgKiBAcmV0dXJucyB7VGFibGV9IEEgbmV3IHRhYmxlIHdpdGggY29sdW1ucyBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIG5hbWVzLgogICAqLwogIHNlbGVjdChuYW1lcywgYXMpIHsKICAgIGNvbnN0IGFsbCA9IHRoaXMubmFtZXM7CiAgICBjb25zdCBpbmRpY2VzID0gbmFtZXMubWFwKChuYW1lKSA9PiBhbGwuaW5kZXhPZihuYW1lKSk7CiAgICByZXR1cm4gdGhpcy5zZWxlY3RBdChpbmRpY2VzLCBhcyk7CiAgfQogIC8qKgogICAqIFJldHVybiBhbiBvYmplY3QgbWFwcGluZyBjb2x1bW4gbmFtZXMgdG8gZXh0cmFjdGVkIHZhbHVlIGFycmF5cy4KICAgKiBAcmV0dXJucyB7UmVjb3JkPHN0cmluZywgaW1wb3J0KCcuL3R5cGVzLmpzJykuVmFsdWVBcnJheTxhbnk+Pn0KICAgKi8KICB0b0NvbHVtbnMoKSB7CiAgICBjb25zdCB7IGNoaWxkcmVuOiBjaGlsZHJlbjIsIG5hbWVzIH0gPSB0aGlzOwogICAgY29uc3QgY29scyA9IHt9OwogICAgbmFtZXMuZm9yRWFjaCgobmFtZSwgaSkgPT4gY29sc1tuYW1lXSA9IGNoaWxkcmVuMltpXT8udG9BcnJheSgpID8/IFtdKTsKICAgIHJldHVybiBjb2xzOwogIH0KICAvKioKICAgKiBSZXR1cm4gYW4gYXJyYXkgb2Ygb2JqZWN0cyByZXByZXNlbnRpbmcgdGhlIHJvd3Mgb2YgdGhpcyB0YWJsZS4KICAgKiBAcmV0dXJucyB7UmVjb3JkPHN0cmluZywgYW55PltdfQogICAqLwogIHRvQXJyYXkoKSB7CiAgICBjb25zdCB7IGNoaWxkcmVuOiBjaGlsZHJlbjIsIGdldEZhY3RvcnksIG51bVJvd3MgfSA9IHRoaXM7CiAgICBjb25zdCBkYXRhID0gY2hpbGRyZW4yWzBdPy5kYXRhID8/IFtdOwogICAgY29uc3Qgb3V0cHV0ID0gQXJyYXkobnVtUm93cyk7CiAgICBmb3IgKGxldCBiID0gMCwgcm93ID0gLTE7IGIgPCBkYXRhLmxlbmd0aDsgKytiKSB7CiAgICAgIGNvbnN0IGYgPSBnZXRGYWN0b3J5KGIpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGFbYl0ubGVuZ3RoOyArK2kpIHsKICAgICAgICBvdXRwdXRbKytyb3ddID0gZihpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG91dHB1dDsKICB9CiAgLyoqCiAgICogUmV0dXJuIGFuIGl0ZXJhdG9yIG92ZXIgb2JqZWN0cyByZXByZXNlbnRpbmcgdGhlIHJvd3Mgb2YgdGhpcyB0YWJsZS4KICAgKiBAcmV0dXJucyB7R2VuZXJhdG9yPFJlY29yZDxzdHJpbmcsIGFueT4sIGFueSwgbnVsbD59CiAgICovCiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgY29uc3QgeyBjaGlsZHJlbjogY2hpbGRyZW4yLCBnZXRGYWN0b3J5IH0gPSB0aGlzOwogICAgY29uc3QgZGF0YSA9IGNoaWxkcmVuMlswXT8uZGF0YSA/PyBbXTsKICAgIGZvciAobGV0IGIgPSAwOyBiIDwgZGF0YS5sZW5ndGg7ICsrYikgewogICAgICBjb25zdCBmID0gZ2V0RmFjdG9yeShiKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhW2JdLmxlbmd0aDsgKytpKSB7CiAgICAgICAgeWllbGQgZihpKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm4gYSByb3cgb2JqZWN0IGZvciB0aGUgZ2l2ZW4gaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IFRoZSByb3cgaW5kZXguCiAgICogQHJldHVybnMge1JlY29yZDxzdHJpbmcsIGFueT59IFRoZSByb3cgb2JqZWN0LgogICAqLwogIGF0KGluZGV4KSB7CiAgICBjb25zdCB7IGNoaWxkcmVuOiBjaGlsZHJlbjIsIGdldEZhY3RvcnksIG51bVJvd3MgfSA9IHRoaXM7CiAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IG51bVJvd3MpIHJldHVybiBudWxsOwogICAgY29uc3QgW3sgb2Zmc2V0cyB9XSA9IGNoaWxkcmVuMjsKICAgIGNvbnN0IGIgPSBiaXNlY3Qob2Zmc2V0cywgaW5kZXgpIC0gMTsKICAgIHJldHVybiBnZXRGYWN0b3J5KGIpKGluZGV4IC0gb2Zmc2V0c1tiXSk7CiAgfQogIC8qKgogICAqIFJldHVybiBhIHJvdyBvYmplY3QgZm9yIHRoZSBnaXZlbiBpbmRleC4gVGhpcyBtZXRob2QgaXMgdGhlIHNhbWUgYXMKICAgKiBgYXQoKWAgYW5kIGlzIHByb3ZpZGVkIGZvciBiZXR0ZXIgY29tcGF0aWJpbGl0eSB3aXRoIEFwYWNoZSBBcnJvdyBKUy4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHJvdyBpbmRleC4KICAgKiBAcmV0dXJucyB7UmVjb3JkPHN0cmluZywgYW55Pn0gVGhlIHJvdyBvYmplY3QuCiAgICovCiAgZ2V0KGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5hdChpbmRleCk7CiAgfQp9OwpmdW5jdGlvbiByZW5hbWVGaWVsZChmaWVsZDIsIG5hbWUpIHsKICByZXR1cm4gbmFtZSAhPSBudWxsICYmIG5hbWUgIT09IGZpZWxkMi5uYW1lID8geyAuLi5maWVsZDIsIG5hbWUgfSA6IGZpZWxkMjsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy9iYXRjaC10eXBlLmpzCmZ1bmN0aW9uIGJhdGNoVHlwZSh0eXBlLCBvcHRpb25zID0ge30pIHsKICBjb25zdCB7IHR5cGVJZCwgYml0V2lkdGgsIHByZWNpc2lvbiwgdW5pdDogdW5pdDIgfSA9IHR5cGU7CiAgY29uc3QgeyB1c2VCaWdJbnQsIHVzZURhdGUsIHVzZURlY2ltYWxJbnQsIHVzZU1hcCwgdXNlUHJveHkgfSA9IG9wdGlvbnM7CiAgc3dpdGNoICh0eXBlSWQpIHsKICAgIGNhc2UgVHlwZS5OdWxsOgogICAgICByZXR1cm4gTnVsbEJhdGNoOwogICAgY2FzZSBUeXBlLkJvb2w6CiAgICAgIHJldHVybiBCb29sQmF0Y2g7CiAgICBjYXNlIFR5cGUuSW50OgogICAgY2FzZSBUeXBlLlRpbWU6CiAgICBjYXNlIFR5cGUuRHVyYXRpb246CiAgICAgIHJldHVybiB1c2VCaWdJbnQgfHwgYml0V2lkdGggPCA2NCA/IERpcmVjdEJhdGNoIDogSW50NjRCYXRjaDsKICAgIGNhc2UgVHlwZS5GbG9hdDoKICAgICAgcmV0dXJuIHByZWNpc2lvbiA/IERpcmVjdEJhdGNoIDogRmxvYXQxNkJhdGNoOwogICAgY2FzZSBUeXBlLkRhdGU6CiAgICAgIHJldHVybiB3cmFwKAogICAgICAgIHVuaXQyID09PSBEYXRlVW5pdC5EQVkgPyBEYXRlRGF5QmF0Y2ggOiBEYXRlRGF5TWlsbGlzZWNvbmRCYXRjaCwKICAgICAgICB1c2VEYXRlICYmIERhdGVCYXRjaAogICAgICApOwogICAgY2FzZSBUeXBlLlRpbWVzdGFtcDoKICAgICAgcmV0dXJuIHdyYXAoCiAgICAgICAgdW5pdDIgPT09IFRpbWVVbml0LlNFQ09ORCA/IFRpbWVzdGFtcFNlY29uZEJhdGNoIDogdW5pdDIgPT09IFRpbWVVbml0Lk1JTExJU0VDT05EID8gVGltZXN0YW1wTWlsbGlzZWNvbmRCYXRjaCA6IHVuaXQyID09PSBUaW1lVW5pdC5NSUNST1NFQ09ORCA/IFRpbWVzdGFtcE1pY3Jvc2Vjb25kQmF0Y2ggOiBUaW1lc3RhbXBOYW5vc2Vjb25kQmF0Y2gsCiAgICAgICAgdXNlRGF0ZSAmJiBEYXRlQmF0Y2gKICAgICAgKTsKICAgIGNhc2UgVHlwZS5EZWNpbWFsOgogICAgICByZXR1cm4gYml0V2lkdGggPT09IDMyID8gdXNlRGVjaW1hbEludCA/IERpcmVjdEJhdGNoIDogRGVjaW1hbDMyTnVtYmVyQmF0Y2ggOiB1c2VEZWNpbWFsSW50ID8gRGVjaW1hbEJpZ0ludEJhdGNoIDogRGVjaW1hbE51bWJlckJhdGNoOwogICAgY2FzZSBUeXBlLkludGVydmFsOgogICAgICByZXR1cm4gdW5pdDIgPT09IEludGVydmFsVW5pdC5EQVlfVElNRSA/IEludGVydmFsRGF5VGltZUJhdGNoIDogdW5pdDIgPT09IEludGVydmFsVW5pdC5ZRUFSX01PTlRIID8gRGlyZWN0QmF0Y2ggOiBJbnRlcnZhbE1vbnRoRGF5TmFub0JhdGNoOwogICAgY2FzZSBUeXBlLkZpeGVkU2l6ZUJpbmFyeToKICAgICAgcmV0dXJuIEZpeGVkQmluYXJ5QmF0Y2g7CiAgICBjYXNlIFR5cGUuVXRmODoKICAgICAgcmV0dXJuIFV0ZjhCYXRjaDsKICAgIGNhc2UgVHlwZS5MYXJnZVV0Zjg6CiAgICAgIHJldHVybiBMYXJnZVV0ZjhCYXRjaDsKICAgIGNhc2UgVHlwZS5CaW5hcnk6CiAgICAgIHJldHVybiBCaW5hcnlCYXRjaDsKICAgIGNhc2UgVHlwZS5MYXJnZUJpbmFyeToKICAgICAgcmV0dXJuIExhcmdlQmluYXJ5QmF0Y2g7CiAgICBjYXNlIFR5cGUuQmluYXJ5VmlldzoKICAgICAgcmV0dXJuIEJpbmFyeVZpZXdCYXRjaDsKICAgIGNhc2UgVHlwZS5VdGY4VmlldzoKICAgICAgcmV0dXJuIFV0ZjhWaWV3QmF0Y2g7CiAgICBjYXNlIFR5cGUuTGlzdDoKICAgICAgcmV0dXJuIExpc3RCYXRjaDsKICAgIGNhc2UgVHlwZS5MYXJnZUxpc3Q6CiAgICAgIHJldHVybiBMYXJnZUxpc3RCYXRjaDsKICAgIGNhc2UgVHlwZS5NYXA6CiAgICAgIHJldHVybiB1c2VNYXAgPyBNYXBCYXRjaCA6IE1hcEVudHJ5QmF0Y2g7CiAgICBjYXNlIFR5cGUuTGlzdFZpZXc6CiAgICAgIHJldHVybiBMaXN0Vmlld0JhdGNoOwogICAgY2FzZSBUeXBlLkxhcmdlTGlzdFZpZXc6CiAgICAgIHJldHVybiBMYXJnZUxpc3RWaWV3QmF0Y2g7CiAgICBjYXNlIFR5cGUuRml4ZWRTaXplTGlzdDoKICAgICAgcmV0dXJuIEZpeGVkTGlzdEJhdGNoOwogICAgY2FzZSBUeXBlLlN0cnVjdDoKICAgICAgcmV0dXJuIHVzZVByb3h5ID8gU3RydWN0UHJveHlCYXRjaCA6IFN0cnVjdEJhdGNoOwogICAgY2FzZSBUeXBlLlJ1bkVuZEVuY29kZWQ6CiAgICAgIHJldHVybiBSdW5FbmRFbmNvZGVkQmF0Y2g7CiAgICBjYXNlIFR5cGUuRGljdGlvbmFyeToKICAgICAgcmV0dXJuIERpY3Rpb25hcnlCYXRjaDsKICAgIGNhc2UgVHlwZS5VbmlvbjoKICAgICAgcmV0dXJuIHR5cGUubW9kZSA/IERlbnNlVW5pb25CYXRjaCA6IFNwYXJzZVVuaW9uQmF0Y2g7CiAgfQogIHRocm93IG5ldyBFcnJvcihpbnZhbGlkRGF0YVR5cGUodHlwZUlkKSk7Cn0KZnVuY3Rpb24gd3JhcChCYXNlQ2xhc3MsIFdyYXBwZXJDbGFzcykgewogIHJldHVybiBXcmFwcGVyQ2xhc3MgPyBjbGFzcyBXcmFwQmF0Y2ggZXh0ZW5kcyBXcmFwcGVyQ2xhc3MgewogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBzdXBlcihuZXcgQmFzZUNsYXNzKG9wdGlvbnMpKTsKICAgIH0KICB9IDogQmFzZUNsYXNzOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2RlY29kZS9ibG9jay5qcwpmdW5jdGlvbiBkZWNvZGVCbG9jayhidWYyLCBpbmRleCkgewogIHJldHVybiB7CiAgICBvZmZzZXQ6IHJlYWRJbnQ2NChidWYyLCBpbmRleCksCiAgICBtZXRhZGF0YUxlbmd0aDogcmVhZEludDMyKGJ1ZjIsIGluZGV4ICsgOCksCiAgICBib2R5TGVuZ3RoOiByZWFkSW50NjQoYnVmMiwgaW5kZXggKyAxNikKICB9Owp9CmZ1bmN0aW9uIGRlY29kZUJsb2NrcyhidWYyLCBpbmRleCkgewogIHJldHVybiByZWFkVmVjdG9yKGJ1ZjIsIGluZGV4LCAyNCwgZGVjb2RlQmxvY2spOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2RlY29kZS9yZWNvcmQtYmF0Y2guanMKZnVuY3Rpb24gZGVjb2RlUmVjb3JkQmF0Y2goYnVmMiwgaW5kZXgsIHZlcnNpb24zKSB7CiAgY29uc3QgZ2V0ID0gcmVhZE9iamVjdChidWYyLCBpbmRleCk7CiAgaWYgKGdldCgxMCwgcmVhZE9mZnNldCwgMCkpIHsKICAgIHRocm93IG5ldyBFcnJvcigiUmVjb3JkIGJhdGNoIGNvbXByZXNzaW9uIG5vdCBpbXBsZW1lbnRlZCIpOwogIH0KICBjb25zdCBvZmZzZXQgPSB2ZXJzaW9uMyA8IFZlcnNpb24uVjQgPyA4IDogMDsKICByZXR1cm4gewogICAgbGVuZ3RoOiBnZXQoNCwgcmVhZEludDY0LCAwKSwKICAgIG5vZGVzOiByZWFkVmVjdG9yKGJ1ZjIsIGdldCg2LCByZWFkT2Zmc2V0KSwgMTYsIChidWYzLCBwb3MpID0+ICh7CiAgICAgIGxlbmd0aDogcmVhZEludDY0KGJ1ZjMsIHBvcyksCiAgICAgIG51bGxDb3VudDogcmVhZEludDY0KGJ1ZjMsIHBvcyArIDgpCiAgICB9KSksCiAgICByZWdpb25zOiByZWFkVmVjdG9yKGJ1ZjIsIGdldCg4LCByZWFkT2Zmc2V0KSwgMTYgKyBvZmZzZXQsIChidWYzLCBwb3MpID0+ICh7CiAgICAgIG9mZnNldDogcmVhZEludDY0KGJ1ZjMsIHBvcyArIG9mZnNldCksCiAgICAgIGxlbmd0aDogcmVhZEludDY0KGJ1ZjMsIHBvcyArIG9mZnNldCArIDgpCiAgICB9KSksCiAgICB2YXJpYWRpYzogcmVhZFZlY3RvcihidWYyLCBnZXQoMTIsIHJlYWRPZmZzZXQpLCA4LCByZWFkSW50NjQpCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy9kZWNvZGUvZGljdGlvbmFyeS1iYXRjaC5qcwpmdW5jdGlvbiBkZWNvZGVEaWN0aW9uYXJ5QmF0Y2goYnVmMiwgaW5kZXgsIHZlcnNpb24zKSB7CiAgY29uc3QgZ2V0ID0gcmVhZE9iamVjdChidWYyLCBpbmRleCk7CiAgcmV0dXJuIHsKICAgIGlkOiBnZXQoNCwgcmVhZEludDY0LCAwKSwKICAgIGRhdGE6IGdldCg2LCAoYnVmMywgb2ZmKSA9PiBkZWNvZGVSZWNvcmRCYXRjaChidWYzLCBvZmYsIHZlcnNpb24zKSksCiAgICAvKioKICAgICAqIElmIGlzRGVsdGEgaXMgdHJ1ZSB0aGUgdmFsdWVzIGluIHRoZSBkaWN0aW9uYXJ5IGFyZSB0byBiZSBhcHBlbmRlZCB0byBhCiAgICAgKiBkaWN0aW9uYXJ5IHdpdGggdGhlIGluZGljYXRlZCBpZC4gSWYgaXNEZWx0YSBpcyBmYWxzZSB0aGlzIGRpY3Rpb25hcnkKICAgICAqIHNob3VsZCByZXBsYWNlIHRoZSBleGlzdGluZyBkaWN0aW9uYXJ5LgogICAgICovCiAgICBpc0RlbHRhOiBnZXQoOCwgcmVhZEJvb2xlYW4sIGZhbHNlKQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZGVjb2RlL2RhdGEtdHlwZS5qcwpmdW5jdGlvbiBkZWNvZGVEYXRhVHlwZShidWYyLCBpbmRleCwgdHlwZUlkLCBjaGlsZHJlbjIpIHsKICBjaGVja09uZU9mKHR5cGVJZCwgVHlwZSwgaW52YWxpZERhdGFUeXBlKTsKICBjb25zdCBnZXQgPSByZWFkT2JqZWN0KGJ1ZjIsIGluZGV4KTsKICBzd2l0Y2ggKHR5cGVJZCkgewogICAgLy8gdHlwZXMgd2l0aG91dCBmbGF0YnVmZmVyIG9iamVjdHMKICAgIGNhc2UgVHlwZS5CaW5hcnk6CiAgICAgIHJldHVybiBiaW5hcnkoKTsKICAgIGNhc2UgVHlwZS5VdGY4OgogICAgICByZXR1cm4gdXRmOCgpOwogICAgY2FzZSBUeXBlLkxhcmdlQmluYXJ5OgogICAgICByZXR1cm4gbGFyZ2VCaW5hcnkoKTsKICAgIGNhc2UgVHlwZS5MYXJnZVV0Zjg6CiAgICAgIHJldHVybiBsYXJnZVV0ZjgoKTsKICAgIGNhc2UgVHlwZS5MaXN0OgogICAgICByZXR1cm4gbGlzdChjaGlsZHJlbjJbMF0pOwogICAgY2FzZSBUeXBlLkxpc3RWaWV3OgogICAgICByZXR1cm4gbGlzdFZpZXcoY2hpbGRyZW4yWzBdKTsKICAgIGNhc2UgVHlwZS5MYXJnZUxpc3Q6CiAgICAgIHJldHVybiBsYXJnZUxpc3QoY2hpbGRyZW4yWzBdKTsKICAgIGNhc2UgVHlwZS5MYXJnZUxpc3RWaWV3OgogICAgICByZXR1cm4gbGFyZ2VMaXN0VmlldyhjaGlsZHJlbjJbMF0pOwogICAgY2FzZSBUeXBlLlN0cnVjdDoKICAgICAgcmV0dXJuIHN0cnVjdChjaGlsZHJlbjIpOwogICAgY2FzZSBUeXBlLlJ1bkVuZEVuY29kZWQ6CiAgICAgIHJldHVybiBydW5FbmRFbmNvZGVkKGNoaWxkcmVuMlswXSwgY2hpbGRyZW4yWzFdKTsKICAgIC8vIHR5cGVzIHdpdGggZmxhdGJ1ZmZlciBvYmplY3RzCiAgICBjYXNlIFR5cGUuSW50OgogICAgICByZXR1cm4gaW50KAogICAgICAgIC8vIEB0cy1pZ25vcmUKICAgICAgICBnZXQoNCwgcmVhZEludDMyLCAwKSwKICAgICAgICAvLyBiaXR3aWR0aAogICAgICAgIGdldCg2LCByZWFkQm9vbGVhbiwgZmFsc2UpCiAgICAgICAgLy8gc2lnbmVkCiAgICAgICk7CiAgICBjYXNlIFR5cGUuRmxvYXQ6CiAgICAgIHJldHVybiBmbG9hdCgKICAgICAgICAvLyBAdHMtaWdub3JlCiAgICAgICAgZ2V0KDQsIHJlYWRJbnQxNiwgUHJlY2lzaW9uLkhBTEYpCiAgICAgICAgLy8gcHJlY2lzaW9uCiAgICAgICk7CiAgICBjYXNlIFR5cGUuRGVjaW1hbDoKICAgICAgcmV0dXJuIGRlY2ltYWwoCiAgICAgICAgZ2V0KDQsIHJlYWRJbnQzMiwgMCksCiAgICAgICAgLy8gcHJlY2lzaW9uCiAgICAgICAgZ2V0KDYsIHJlYWRJbnQzMiwgMCksCiAgICAgICAgLy8gc2NhbGUKICAgICAgICAvLyBAdHMtaWdub3JlCiAgICAgICAgZ2V0KDgsIHJlYWRJbnQzMiwgMTI4KQogICAgICAgIC8vIGJpdHdpZHRoCiAgICAgICk7CiAgICBjYXNlIFR5cGUuRGF0ZToKICAgICAgcmV0dXJuIGRhdGUyKAogICAgICAgIC8vIEB0cy1pZ25vcmUKICAgICAgICBnZXQoNCwgcmVhZEludDE2LCBEYXRlVW5pdC5NSUxMSVNFQ09ORCkKICAgICAgICAvLyB1bml0CiAgICAgICk7CiAgICBjYXNlIFR5cGUuVGltZToKICAgICAgcmV0dXJuIHRpbWUyKAogICAgICAgIC8vIEB0cy1pZ25vcmUKICAgICAgICBnZXQoNCwgcmVhZEludDE2LCBUaW1lVW5pdC5NSUxMSVNFQ09ORCksCiAgICAgICAgLy8gdW5pdAogICAgICAgIGdldCg2LCByZWFkSW50MzIsIDMyKQogICAgICAgIC8vIGJpdFdpZHRoCiAgICAgICk7CiAgICBjYXNlIFR5cGUuVGltZXN0YW1wOgogICAgICByZXR1cm4gdGltZXN0YW1wKAogICAgICAgIC8vIEB0cy1pZ25vcmUKICAgICAgICBnZXQoNCwgcmVhZEludDE2LCBUaW1lVW5pdC5TRUNPTkQpLAogICAgICAgIC8vIHVuaXQKICAgICAgICBnZXQoNiwgcmVhZFN0cmluZykKICAgICAgICAvLyB0aW1lem9uZQogICAgICApOwogICAgY2FzZSBUeXBlLkludGVydmFsOgogICAgICByZXR1cm4gaW50ZXJ2YWwoCiAgICAgICAgLy8gQHRzLWlnbm9yZQogICAgICAgIGdldCg0LCByZWFkSW50MTYsIEludGVydmFsVW5pdC5ZRUFSX01PTlRIKQogICAgICAgIC8vIHVuaXQKICAgICAgKTsKICAgIGNhc2UgVHlwZS5EdXJhdGlvbjoKICAgICAgcmV0dXJuIGR1cmF0aW9uKAogICAgICAgIC8vIEB0cy1pZ25vcmUKICAgICAgICBnZXQoNCwgcmVhZEludDE2LCBUaW1lVW5pdC5NSUxMSVNFQ09ORCkKICAgICAgICAvLyB1bml0CiAgICAgICk7CiAgICBjYXNlIFR5cGUuRml4ZWRTaXplQmluYXJ5OgogICAgICByZXR1cm4gZml4ZWRTaXplQmluYXJ5KAogICAgICAgIGdldCg0LCByZWFkSW50MzIsIDApCiAgICAgICAgLy8gc3RyaWRlCiAgICAgICk7CiAgICBjYXNlIFR5cGUuRml4ZWRTaXplTGlzdDoKICAgICAgcmV0dXJuIGZpeGVkU2l6ZUxpc3QoCiAgICAgICAgY2hpbGRyZW4yWzBdLAogICAgICAgIGdldCg0LCByZWFkSW50MzIsIDApCiAgICAgICAgLy8gc3RyaWRlCiAgICAgICk7CiAgICBjYXNlIFR5cGUuTWFwOgogICAgICByZXR1cm4gbWFwVHlwZSgKICAgICAgICBnZXQoNCwgcmVhZEJvb2xlYW4sIGZhbHNlKSwKICAgICAgICAvLyBrZXlzU29ydGVkCiAgICAgICAgY2hpbGRyZW4yWzBdCiAgICAgICk7CiAgICBjYXNlIFR5cGUuVW5pb246CiAgICAgIHJldHVybiB1bmlvbigKICAgICAgICAvLyBAdHMtaWdub3JlCiAgICAgICAgZ2V0KDQsIHJlYWRJbnQxNiwgVW5pb25Nb2RlLlNwYXJzZSksCiAgICAgICAgLy8gbW9kZQogICAgICAgIGNoaWxkcmVuMiwKICAgICAgICByZWFkVmVjdG9yKGJ1ZjIsIGdldCg2LCByZWFkT2Zmc2V0KSwgNCwgcmVhZEludDMyKQogICAgICAgIC8vIHR5cGUgaWRzCiAgICAgICk7CiAgfQogIHJldHVybiB7IHR5cGVJZCB9Owp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2RlY29kZS9tZXRhZGF0YS5qcwpmdW5jdGlvbiBkZWNvZGVNZXRhZGF0YShidWYyLCBpbmRleCkgewogIGNvbnN0IGVudHJpZXMgPSByZWFkVmVjdG9yKGJ1ZjIsIGluZGV4LCA0LCAoYnVmMywgcG9zKSA9PiB7CiAgICBjb25zdCBnZXQgPSByZWFkT2JqZWN0KGJ1ZjMsIHBvcyk7CiAgICByZXR1cm4gKAogICAgICAvKiogQHR5cGUge1tzdHJpbmcsIHN0cmluZ119ICovCiAgICAgIFsKICAgICAgICBnZXQoNCwgcmVhZFN0cmluZyksCiAgICAgICAgLy8gNDoga2V5IChzdHJpbmcpCiAgICAgICAgZ2V0KDYsIHJlYWRTdHJpbmcpCiAgICAgICAgLy8gNjoga2V5IChzdHJpbmcpCiAgICAgIF0KICAgICk7CiAgfSk7CiAgcmV0dXJuIGVudHJpZXMubGVuZ3RoID8gbmV3IE1hcChlbnRyaWVzKSA6IG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZGVjb2RlL3NjaGVtYS5qcwpmdW5jdGlvbiBkZWNvZGVTY2hlbWEoYnVmMiwgaW5kZXgsIHZlcnNpb24zKSB7CiAgY29uc3QgZ2V0ID0gcmVhZE9iamVjdChidWYyLCBpbmRleCk7CiAgcmV0dXJuIHsKICAgIHZlcnNpb246IHZlcnNpb24zLAogICAgZW5kaWFubmVzczogKAogICAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vdHlwZXMuanMnKS5FbmRpYW5uZXNzX30gKi8KICAgICAgZ2V0KDQsIHJlYWRJbnQxNiwgMCkKICAgICksCiAgICBmaWVsZHM6IGdldCg2LCBkZWNvZGVTY2hlbWFGaWVsZHMsIFtdKSwKICAgIG1ldGFkYXRhOiBnZXQoOCwgZGVjb2RlTWV0YWRhdGEpCiAgfTsKfQpmdW5jdGlvbiBkZWNvZGVTY2hlbWFGaWVsZHMoYnVmMiwgZmllbGRzT2Zmc2V0KSB7CiAgcmV0dXJuIHJlYWRWZWN0b3IoYnVmMiwgZmllbGRzT2Zmc2V0LCA0LCBkZWNvZGVGaWVsZCk7Cn0KZnVuY3Rpb24gZGVjb2RlRmllbGQoYnVmMiwgaW5kZXgpIHsKICBjb25zdCBnZXQgPSByZWFkT2JqZWN0KGJ1ZjIsIGluZGV4KTsKICBjb25zdCB0eXBlSWQgPSBnZXQoOCwgcmVhZFVpbnQ4LCBUeXBlLk5PTkUpOwogIGNvbnN0IHR5cGVPZmZzZXQgPSBnZXQoMTAsIHJlYWRPZmZzZXQsIDApOwogIGNvbnN0IGRpY3QgPSBnZXQoMTIsIGRlY29kZURpY3Rpb25hcnkpOwogIGNvbnN0IGNoaWxkcmVuMiA9IGdldCgxNCwgKGJ1ZjMsIG9mZikgPT4gZGVjb2RlRmllbGRDaGlsZHJlbihidWYzLCBvZmYpKTsKICBsZXQgdHlwZSA9IGRlY29kZURhdGFUeXBlKGJ1ZjIsIHR5cGVPZmZzZXQsIHR5cGVJZCwgY2hpbGRyZW4yKTsKICBpZiAoZGljdCkgewogICAgZGljdC5kaWN0aW9uYXJ5ID0gdHlwZTsKICAgIHR5cGUgPSBkaWN0OwogIH0KICByZXR1cm4gewogICAgbmFtZTogZ2V0KDQsIHJlYWRTdHJpbmcpLAogICAgdHlwZSwKICAgIG51bGxhYmxlOiBnZXQoNiwgcmVhZEJvb2xlYW4sIGZhbHNlKSwKICAgIG1ldGFkYXRhOiBnZXQoMTYsIGRlY29kZU1ldGFkYXRhKQogIH07Cn0KZnVuY3Rpb24gZGVjb2RlRmllbGRDaGlsZHJlbihidWYyLCBmaWVsZE9mZnNldCkgewogIGNvbnN0IGNoaWxkcmVuMiA9IHJlYWRWZWN0b3IoYnVmMiwgZmllbGRPZmZzZXQsIDQsIGRlY29kZUZpZWxkKTsKICByZXR1cm4gY2hpbGRyZW4yLmxlbmd0aCA/IGNoaWxkcmVuMiA6IG51bGw7Cn0KZnVuY3Rpb24gZGVjb2RlRGljdGlvbmFyeShidWYyLCBpbmRleCkgewogIGlmICghaW5kZXgpIHJldHVybiBudWxsOwogIGNvbnN0IGdldCA9IHJlYWRPYmplY3QoYnVmMiwgaW5kZXgpOwogIHJldHVybiBkaWN0aW9uYXJ5KAogICAgbnVsbCwKICAgIC8vIGRhdGEgdHlwZSB3aWxsIGJlIHBvcHVsYXRlZCBieSBjYWxsZXIKICAgIGdldCg2LCBkZWNvZGVJbnQsIGludDMyKCkpLAogICAgLy8gaW5kZXggdHlwZQogICAgZ2V0KDgsIHJlYWRCb29sZWFuLCBmYWxzZSksCiAgICAvLyBvcmRlcmVkCiAgICBnZXQoNCwgcmVhZEludDY0LCAwKQogICAgLy8gaWQKICApOwp9CmZ1bmN0aW9uIGRlY29kZUludChidWYyLCBpbmRleCkgewogIHJldHVybiAoCiAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vdHlwZXMuanMnKS5JbnRUeXBlfSAqLwogICAgZGVjb2RlRGF0YVR5cGUoYnVmMiwgaW5kZXgsIFR5cGUuSW50KQogICk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZGVjb2RlL21lc3NhZ2UuanMKdmFyIGludmFsaWRNZXNzYWdlTWV0YWRhdGEgPSAoZXhwZWN0ZWQsIGFjdHVhbCkgPT4gYEV4cGVjdGVkIHRvIHJlYWQgJHtleHBlY3RlZH0gbWV0YWRhdGEgYnl0ZXMsIGJ1dCBvbmx5IHJlYWQgJHthY3R1YWx9LmA7CnZhciBpbnZhbGlkTWVzc2FnZUJvZHlMZW5ndGggPSAoZXhwZWN0ZWQsIGFjdHVhbCkgPT4gYEV4cGVjdGVkIHRvIHJlYWQgJHtleHBlY3RlZH0gYnl0ZXMgZm9yIG1lc3NhZ2UgYm9keSwgYnV0IG9ubHkgcmVhZCAke2FjdHVhbH0uYDsKdmFyIGludmFsaWRNZXNzYWdlVHlwZSA9ICh0eXBlKSA9PiBgVW5zdXBwb3J0ZWQgbWVzc2FnZSB0eXBlOiAke3R5cGV9ICgke2tleUZvcihNZXNzYWdlSGVhZGVyLCB0eXBlKX0pYDsKZnVuY3Rpb24gZGVjb2RlTWVzc2FnZShidWYyLCBpbmRleCkgewogIGxldCBtZXRhZGF0YUxlbmd0aCA9IHJlYWRJbnQzMihidWYyLCBpbmRleCkgfHwgMDsKICBpbmRleCArPSBTSVpFT0ZfSU5UOwogIGlmIChtZXRhZGF0YUxlbmd0aCA9PT0gLTEpIHsKICAgIG1ldGFkYXRhTGVuZ3RoID0gcmVhZEludDMyKGJ1ZjIsIGluZGV4KSB8fCAwOwogICAgaW5kZXggKz0gU0laRU9GX0lOVDsKICB9CiAgaWYgKG1ldGFkYXRhTGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDsKICBjb25zdCBoZWFkID0gYnVmMi5zdWJhcnJheShpbmRleCwgaW5kZXggKz0gbWV0YWRhdGFMZW5ndGgpOwogIGlmIChoZWFkLmJ5dGVMZW5ndGggPCBtZXRhZGF0YUxlbmd0aCkgewogICAgdGhyb3cgbmV3IEVycm9yKGludmFsaWRNZXNzYWdlTWV0YWRhdGEobWV0YWRhdGFMZW5ndGgsIGhlYWQuYnl0ZUxlbmd0aCkpOwogIH0KICBjb25zdCBnZXQgPSByZWFkT2JqZWN0KGhlYWQsIDApOwogIGNvbnN0IHZlcnNpb24zID0gKAogICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uL3R5cGVzLmpzJykuVmVyc2lvbl99ICovCiAgICBnZXQoNCwgcmVhZEludDE2LCBWZXJzaW9uLlYxKQogICk7CiAgY29uc3QgdHlwZSA9ICgKICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi90eXBlcy5qcycpLk1lc3NhZ2VIZWFkZXJffSAqLwogICAgZ2V0KDYsIHJlYWRVaW50OCwgTWVzc2FnZUhlYWRlci5OT05FKQogICk7CiAgY29uc3Qgb2Zmc2V0ID0gZ2V0KDgsIHJlYWRPZmZzZXQsIDApOwogIGNvbnN0IGJvZHlMZW5ndGggPSBnZXQoMTAsIHJlYWRJbnQ2NCwgMCk7CiAgbGV0IGNvbnRlbnQ7CiAgaWYgKG9mZnNldCkgewogICAgY29uc3QgZGVjb2RlciA9IHR5cGUgPT09IE1lc3NhZ2VIZWFkZXIuU2NoZW1hID8gZGVjb2RlU2NoZW1hIDogdHlwZSA9PT0gTWVzc2FnZUhlYWRlci5EaWN0aW9uYXJ5QmF0Y2ggPyBkZWNvZGVEaWN0aW9uYXJ5QmF0Y2ggOiB0eXBlID09PSBNZXNzYWdlSGVhZGVyLlJlY29yZEJhdGNoID8gZGVjb2RlUmVjb3JkQmF0Y2ggOiBudWxsOwogICAgaWYgKCFkZWNvZGVyKSB0aHJvdyBuZXcgRXJyb3IoaW52YWxpZE1lc3NhZ2VUeXBlKHR5cGUpKTsKICAgIGNvbnRlbnQgPSBkZWNvZGVyKGhlYWQsIG9mZnNldCwgdmVyc2lvbjMpOwogICAgaWYgKGJvZHlMZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGJvZHkgPSBidWYyLnN1YmFycmF5KGluZGV4LCBpbmRleCArPSBib2R5TGVuZ3RoKTsKICAgICAgaWYgKGJvZHkuYnl0ZUxlbmd0aCA8IGJvZHlMZW5ndGgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoaW52YWxpZE1lc3NhZ2VCb2R5TGVuZ3RoKGJvZHlMZW5ndGgsIGJvZHkuYnl0ZUxlbmd0aCkpOwogICAgICB9CiAgICAgIGNvbnRlbnQuYm9keSA9IGJvZHk7CiAgICB9CiAgfQogIHJldHVybiB7IHZlcnNpb246IHZlcnNpb24zLCB0eXBlLCBpbmRleCwgY29udGVudCB9Owp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2RlY29kZS9kZWNvZGUtaXBjLmpzCmZ1bmN0aW9uIGRlY29kZUlQQyhkYXRhKSB7CiAgY29uc3Qgc291cmNlID0gZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyID8gbmV3IFVpbnQ4QXJyYXkoZGF0YSkgOiBkYXRhOwogIHJldHVybiBzb3VyY2UgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGlzQXJyb3dGaWxlRm9ybWF0KHNvdXJjZSkgPyBkZWNvZGVJUENGaWxlKHNvdXJjZSkgOiBkZWNvZGVJUENTdHJlYW0oc291cmNlKTsKfQpmdW5jdGlvbiBpc0Fycm93RmlsZUZvcm1hdChidWYyKSB7CiAgaWYgKCFidWYyIHx8IGJ1ZjIubGVuZ3RoIDwgNCkgcmV0dXJuIGZhbHNlOwogIGZvciAobGV0IGkgPSAwOyBpIDwgNjsgKytpKSB7CiAgICBpZiAoTUFHSUNbaV0gIT09IGJ1ZjJbaV0pIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gZGVjb2RlSVBDU3RyZWFtKGRhdGEpIHsKICBjb25zdCBzdHJlYW0gPSBbZGF0YV0uZmxhdCgpOwogIGxldCBzY2hlbWE7CiAgY29uc3QgcmVjb3JkcyA9IFtdOwogIGNvbnN0IGRpY3Rpb25hcmllcyA9IFtdOwogIGZvciAoY29uc3QgYnVmMiBvZiBzdHJlYW0pIHsKICAgIGlmICghKGJ1ZjIgaW5zdGFuY2VvZiBVaW50OEFycmF5KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYElQQyBkYXRhIGJhdGNoIHdhcyBub3QgYSBVaW50OEFycmF5LmApOwogICAgfQogICAgbGV0IG9mZnNldCA9IDA7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBjb25zdCBtID0gZGVjb2RlTWVzc2FnZShidWYyLCBvZmZzZXQpOwogICAgICBpZiAobSA9PT0gbnVsbCkgYnJlYWs7CiAgICAgIG9mZnNldCA9IG0uaW5kZXg7CiAgICAgIGlmICghbS5jb250ZW50KSBjb250aW51ZTsKICAgICAgc3dpdGNoIChtLnR5cGUpIHsKICAgICAgICBjYXNlIE1lc3NhZ2VIZWFkZXIuU2NoZW1hOgogICAgICAgICAgaWYgKCFzY2hlbWEpIHNjaGVtYSA9IG0uY29udGVudDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgTWVzc2FnZUhlYWRlci5SZWNvcmRCYXRjaDoKICAgICAgICAgIHJlY29yZHMucHVzaChtLmNvbnRlbnQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBNZXNzYWdlSGVhZGVyLkRpY3Rpb25hcnlCYXRjaDoKICAgICAgICAgIGRpY3Rpb25hcmllcy5wdXNoKG0uY29udGVudCk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gKAogICAgLyoqIEB0eXBlIHtpbXBvcnQoJy4uL3R5cGVzLmpzJykuQXJyb3dEYXRhfSAqLwogICAgeyBzY2hlbWEsIGRpY3Rpb25hcmllcywgcmVjb3JkcywgbWV0YWRhdGE6IG51bGwgfQogICk7Cn0KZnVuY3Rpb24gZGVjb2RlSVBDRmlsZShkYXRhKSB7CiAgY29uc3Qgb2Zmc2V0ID0gZGF0YS5ieXRlTGVuZ3RoIC0gKE1BR0lDLmxlbmd0aCArIDQpOwogIGNvbnN0IGxlbmd0aCA9IHJlYWRJbnQzMihkYXRhLCBvZmZzZXQpOwogIGNvbnN0IGdldCA9IHJlYWRPYmplY3QoZGF0YSwgb2Zmc2V0IC0gbGVuZ3RoKTsKICBjb25zdCB2ZXJzaW9uMyA9ICgKICAgIC8qKiBAdHlwZSB7aW1wb3J0KCcuLi90eXBlcy5qcycpLlZlcnNpb25ffSAqLwogICAgZ2V0KDQsIHJlYWRJbnQxNiwgVmVyc2lvbi5WMSkKICApOwogIGNvbnN0IGRpY3RzID0gZ2V0KDgsIGRlY29kZUJsb2NrcywgW10pOwogIGNvbnN0IHJlY3MgPSBnZXQoMTAsIGRlY29kZUJsb2NrcywgW10pOwogIHJldHVybiAoCiAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vdHlwZXMuanMnKS5BcnJvd0RhdGF9ICovCiAgICB7CiAgICAgIHNjaGVtYTogZ2V0KDYsIChidWYyLCBpbmRleCkgPT4gZGVjb2RlU2NoZW1hKGJ1ZjIsIGluZGV4LCB2ZXJzaW9uMykpLAogICAgICBkaWN0aW9uYXJpZXM6IGRpY3RzLm1hcCgoeyBvZmZzZXQ6IG9mZnNldDIgfSkgPT4gZGVjb2RlTWVzc2FnZShkYXRhLCBvZmZzZXQyKS5jb250ZW50KSwKICAgICAgcmVjb3JkczogcmVjcy5tYXAoKHsgb2Zmc2V0OiBvZmZzZXQyIH0pID0+IGRlY29kZU1lc3NhZ2UoZGF0YSwgb2Zmc2V0MikuY29udGVudCksCiAgICAgIG1ldGFkYXRhOiBnZXQoMTIsIGRlY29kZU1ldGFkYXRhKQogICAgfQogICk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZGVjb2RlL3RhYmxlLWZyb20taXBjLmpzCmZ1bmN0aW9uIHRhYmxlRnJvbUlQQyhkYXRhLCBvcHRpb25zKSB7CiAgcmV0dXJuIGNyZWF0ZVRhYmxlKGRlY29kZUlQQyhkYXRhKSwgb3B0aW9ucyk7Cn0KZnVuY3Rpb24gY3JlYXRlVGFibGUoZGF0YSwgb3B0aW9ucyA9IHt9KSB7CiAgY29uc3QgeyBzY2hlbWEgPSB7IGZpZWxkczogW10gfSwgZGljdGlvbmFyaWVzLCByZWNvcmRzIH0gPSBkYXRhOwogIGNvbnN0IHsgdmVyc2lvbjogdmVyc2lvbjMsIGZpZWxkcyB9ID0gc2NoZW1hOwogIGNvbnN0IGRpY3Rpb25hcnlNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IGNvbnRleHQgPSBjb250ZXh0R2VuZXJhdG9yKG9wdGlvbnMsIHZlcnNpb24zLCBkaWN0aW9uYXJ5TWFwKTsKICBjb25zdCBkaWN0aW9uYXJ5VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHZpc2l0U2NoZW1hRmllbGRzKHNjaGVtYSwgKGZpZWxkMikgPT4gewogICAgY29uc3QgdHlwZSA9IGZpZWxkMi50eXBlOwogICAgaWYgKHR5cGUudHlwZUlkID09PSBUeXBlLkRpY3Rpb25hcnkpIHsKICAgICAgZGljdGlvbmFyeVR5cGVzLnNldCh0eXBlLmlkLCB0eXBlLmRpY3Rpb25hcnkpOwogICAgfQogIH0pOwogIGNvbnN0IGRpY3RzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBmb3IgKGNvbnN0IGRpY3Qgb2YgZGljdGlvbmFyaWVzKSB7CiAgICBjb25zdCB7IGlkLCBkYXRhOiBkYXRhMiwgaXNEZWx0YSwgYm9keSB9ID0gZGljdDsKICAgIGNvbnN0IHR5cGUgPSBkaWN0aW9uYXJ5VHlwZXMuZ2V0KGlkKTsKICAgIGNvbnN0IGJhdGNoID0gdmlzaXQodHlwZSwgY29udGV4dCh7IC4uLmRhdGEyLCBib2R5IH0pKTsKICAgIGlmICghZGljdHMuaGFzKGlkKSkgewogICAgICBpZiAoaXNEZWx0YSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRGVsdGEgdXBkYXRlIGNhbiBub3QgYmUgZmlyc3QgZGljdGlvbmFyeSBiYXRjaC4iKTsKICAgICAgfQogICAgICBkaWN0cy5zZXQoaWQsIGNvbHVtbkJ1aWxkZXIodHlwZSkuYWRkKGJhdGNoKSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBkaWN0MiA9IGRpY3RzLmdldChpZCk7CiAgICAgIGlmICghaXNEZWx0YSkgZGljdDIuY2xlYXIoKTsKICAgICAgZGljdDIuYWRkKGJhdGNoKTsKICAgIH0KICB9CiAgZGljdHMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4gZGljdGlvbmFyeU1hcC5zZXQoa2V5LCB2YWx1ZS5kb25lKCkpKTsKICBjb25zdCBjb2xzID0gZmllbGRzLm1hcCgoZikgPT4gY29sdW1uQnVpbGRlcihmLnR5cGUpKTsKICBmb3IgKGNvbnN0IGJhdGNoIG9mIHJlY29yZHMpIHsKICAgIGNvbnN0IGN0eCA9IGNvbnRleHQoYmF0Y2gpOwogICAgZmllbGRzLmZvckVhY2goKGYsIGkpID0+IGNvbHNbaV0uYWRkKHZpc2l0KGYudHlwZSwgY3R4KSkpOwogIH0KICByZXR1cm4gbmV3IFRhYmxlKHNjaGVtYSwgY29scy5tYXAoKGMpID0+IGMuZG9uZSgpKSwgb3B0aW9ucy51c2VQcm94eSk7Cn0KZnVuY3Rpb24gdmlzaXRTY2hlbWFGaWVsZHMoc2NoZW1hLCB2aXNpdG9yKSB7CiAgc2NoZW1hLmZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uIHZpc2l0RmllbGQoZmllbGQyKSB7CiAgICB2aXNpdG9yKGZpZWxkMik7CiAgICBmaWVsZDIudHlwZS5kaWN0aW9uYXJ5Py5jaGlsZHJlbj8uZm9yRWFjaCh2aXNpdEZpZWxkKTsKICAgIGZpZWxkMi50eXBlLmNoaWxkcmVuPy5mb3JFYWNoKHZpc2l0RmllbGQpOwogIH0pOwp9CmZ1bmN0aW9uIGNvbnRleHRHZW5lcmF0b3Iob3B0aW9ucywgdmVyc2lvbjMsIGRpY3Rpb25hcnlNYXApIHsKICBjb25zdCBiYXNlID0gewogICAgdmVyc2lvbjogdmVyc2lvbjMsCiAgICBvcHRpb25zLAogICAgZGljdGlvbmFyeTogKGlkKSA9PiBkaWN0aW9uYXJ5TWFwLmdldChpZCkKICB9OwogIHJldHVybiAoYmF0Y2gpID0+IHsKICAgIGNvbnN0IHsgbGVuZ3RoLCBub2RlcywgcmVnaW9ucywgdmFyaWFkaWMsIGJvZHkgfSA9IGJhdGNoOwogICAgbGV0IG5vZGVJbmRleCA9IC0xOwogICAgbGV0IGJ1ZmZlckluZGV4ID0gLTE7CiAgICBsZXQgdmFyaWFkaWNJbmRleCA9IC0xOwogICAgcmV0dXJuIHsKICAgICAgLi4uYmFzZSwKICAgICAgbGVuZ3RoLAogICAgICBub2RlOiAoKSA9PiBub2Rlc1srK25vZGVJbmRleF0sCiAgICAgIGJ1ZmZlcjogKEFycmF5VHlwZSkgPT4gewogICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyLCBvZmZzZXQgfSA9IHJlZ2lvbnNbKytidWZmZXJJbmRleF07CiAgICAgICAgcmV0dXJuIEFycmF5VHlwZSA/IG5ldyBBcnJheVR5cGUoYm9keS5idWZmZXIsIGJvZHkuYnl0ZU9mZnNldCArIG9mZnNldCwgbGVuZ3RoMiAvIEFycmF5VHlwZS5CWVRFU19QRVJfRUxFTUVOVCkgOiBib2R5LnN1YmFycmF5KG9mZnNldCwgb2Zmc2V0ICsgbGVuZ3RoMik7CiAgICAgIH0sCiAgICAgIHZhcmlhZGljOiAoKSA9PiB2YXJpYWRpY1srK3ZhcmlhZGljSW5kZXhdLAogICAgICB2aXNpdChjaGlsZHJlbjIpIHsKICAgICAgICByZXR1cm4gY2hpbGRyZW4yLm1hcCgoZikgPT4gdmlzaXQoZi50eXBlLCB0aGlzKSk7CiAgICAgIH0KICAgIH07CiAgfTsKfQpmdW5jdGlvbiB2aXNpdCh0eXBlLCBjdHgpIHsKICBjb25zdCB7IHR5cGVJZCB9ID0gdHlwZTsKICBjb25zdCB7IGxlbmd0aCwgb3B0aW9ucywgbm9kZSwgYnVmZmVyOiBidWZmZXIyLCB2YXJpYWRpYywgdmVyc2lvbjogdmVyc2lvbjMgfSA9IGN0eDsKICBjb25zdCBCYXRjaFR5cGUgPSBiYXRjaFR5cGUodHlwZSwgb3B0aW9ucyk7CiAgaWYgKHR5cGVJZCA9PT0gVHlwZS5OdWxsKSB7CiAgICByZXR1cm4gbmV3IEJhdGNoVHlwZSh7IGxlbmd0aCwgbnVsbENvdW50OiBsZW5ndGgsIHR5cGUgfSk7CiAgfQogIGNvbnN0IGJhc2UgPSB7IC4uLm5vZGUoKSwgdHlwZSB9OwogIHN3aXRjaCAodHlwZUlkKSB7CiAgICAvLyB2YWxpZGl0eSBhbmQgZGF0YSB2YWx1ZSBidWZmZXJzCiAgICBjYXNlIFR5cGUuQm9vbDoKICAgIGNhc2UgVHlwZS5JbnQ6CiAgICBjYXNlIFR5cGUuVGltZToKICAgIGNhc2UgVHlwZS5EdXJhdGlvbjoKICAgIGNhc2UgVHlwZS5GbG9hdDoKICAgIGNhc2UgVHlwZS5EZWNpbWFsOgogICAgY2FzZSBUeXBlLkRhdGU6CiAgICBjYXNlIFR5cGUuVGltZXN0YW1wOgogICAgY2FzZSBUeXBlLkludGVydmFsOgogICAgY2FzZSBUeXBlLkZpeGVkU2l6ZUJpbmFyeToKICAgICAgcmV0dXJuIG5ldyBCYXRjaFR5cGUoewogICAgICAgIC4uLmJhc2UsCiAgICAgICAgdmFsaWRpdHk6IGJ1ZmZlcjIoKSwKICAgICAgICB2YWx1ZXM6IGJ1ZmZlcjIodHlwZS52YWx1ZXMpCiAgICAgIH0pOwogICAgLy8gdmFsaWRpdHksIG9mZnNldCwgYW5kIHZhbHVlIGJ1ZmZlcnMKICAgIGNhc2UgVHlwZS5VdGY4OgogICAgY2FzZSBUeXBlLkxhcmdlVXRmODoKICAgIGNhc2UgVHlwZS5CaW5hcnk6CiAgICBjYXNlIFR5cGUuTGFyZ2VCaW5hcnk6CiAgICAgIHJldHVybiBuZXcgQmF0Y2hUeXBlKHsKICAgICAgICAuLi5iYXNlLAogICAgICAgIHZhbGlkaXR5OiBidWZmZXIyKCksCiAgICAgICAgb2Zmc2V0czogYnVmZmVyMih0eXBlLm9mZnNldHMpLAogICAgICAgIHZhbHVlczogYnVmZmVyMigpCiAgICAgIH0pOwogICAgLy8gdmlld3Mgd2l0aCB2YXJpYWRpYyBidWZmZXJzCiAgICBjYXNlIFR5cGUuQmluYXJ5VmlldzoKICAgIGNhc2UgVHlwZS5VdGY4VmlldzoKICAgICAgcmV0dXJuIG5ldyBCYXRjaFR5cGUoewogICAgICAgIC4uLmJhc2UsCiAgICAgICAgdmFsaWRpdHk6IGJ1ZmZlcjIoKSwKICAgICAgICB2YWx1ZXM6IGJ1ZmZlcjIoKSwKICAgICAgICAvLyB2aWV3cyBidWZmZXIKICAgICAgICBkYXRhOiBBcnJheS5mcm9tKHsgbGVuZ3RoOiB2YXJpYWRpYygpIH0sICgpID0+IGJ1ZmZlcjIoKSkKICAgICAgICAvLyBkYXRhIGJ1ZmZlcnMKICAgICAgfSk7CiAgICAvLyB2YWxpZGl0eSwgb2Zmc2V0LCBhbmQgbGlzdCBjaGlsZAogICAgY2FzZSBUeXBlLkxpc3Q6CiAgICBjYXNlIFR5cGUuTGFyZ2VMaXN0OgogICAgY2FzZSBUeXBlLk1hcDoKICAgICAgcmV0dXJuIG5ldyBCYXRjaFR5cGUoewogICAgICAgIC4uLmJhc2UsCiAgICAgICAgdmFsaWRpdHk6IGJ1ZmZlcjIoKSwKICAgICAgICBvZmZzZXRzOiBidWZmZXIyKHR5cGUub2Zmc2V0cyksCiAgICAgICAgY2hpbGRyZW46IGN0eC52aXNpdCh0eXBlLmNoaWxkcmVuKQogICAgICB9KTsKICAgIC8vIHZhbGlkaXR5LCBvZmZzZXQsIHNpemUsIGFuZCBsaXN0IGNoaWxkCiAgICBjYXNlIFR5cGUuTGlzdFZpZXc6CiAgICBjYXNlIFR5cGUuTGFyZ2VMaXN0VmlldzoKICAgICAgcmV0dXJuIG5ldyBCYXRjaFR5cGUoewogICAgICAgIC4uLmJhc2UsCiAgICAgICAgdmFsaWRpdHk6IGJ1ZmZlcjIoKSwKICAgICAgICBvZmZzZXRzOiBidWZmZXIyKHR5cGUub2Zmc2V0cyksCiAgICAgICAgc2l6ZXM6IGJ1ZmZlcjIodHlwZS5vZmZzZXRzKSwKICAgICAgICBjaGlsZHJlbjogY3R4LnZpc2l0KHR5cGUuY2hpbGRyZW4pCiAgICAgIH0pOwogICAgLy8gdmFsaWRpdHkgYW5kIGNoaWxkcmVuCiAgICBjYXNlIFR5cGUuRml4ZWRTaXplTGlzdDoKICAgIGNhc2UgVHlwZS5TdHJ1Y3Q6CiAgICAgIHJldHVybiBuZXcgQmF0Y2hUeXBlKHsKICAgICAgICAuLi5iYXNlLAogICAgICAgIHZhbGlkaXR5OiBidWZmZXIyKCksCiAgICAgICAgY2hpbGRyZW46IGN0eC52aXNpdCh0eXBlLmNoaWxkcmVuKQogICAgICB9KTsKICAgIC8vIGNoaWxkcmVuIG9ubHkKICAgIGNhc2UgVHlwZS5SdW5FbmRFbmNvZGVkOgogICAgICByZXR1cm4gbmV3IEJhdGNoVHlwZSh7CiAgICAgICAgLi4uYmFzZSwKICAgICAgICBjaGlsZHJlbjogY3R4LnZpc2l0KHR5cGUuY2hpbGRyZW4pCiAgICAgIH0pOwogICAgLy8gZGljdGlvbmFyeQogICAgY2FzZSBUeXBlLkRpY3Rpb25hcnk6IHsKICAgICAgY29uc3QgeyBpZCwgaW5kaWNlcyB9ID0gdHlwZTsKICAgICAgcmV0dXJuIG5ldyBCYXRjaFR5cGUoewogICAgICAgIC4uLmJhc2UsCiAgICAgICAgdmFsaWRpdHk6IGJ1ZmZlcjIoKSwKICAgICAgICB2YWx1ZXM6IGJ1ZmZlcjIoaW5kaWNlcy52YWx1ZXMpCiAgICAgIH0pLnNldERpY3Rpb25hcnkoY3R4LmRpY3Rpb25hcnkoaWQpKTsKICAgIH0KICAgIC8vIHVuaW9uCiAgICBjYXNlIFR5cGUuVW5pb246IHsKICAgICAgaWYgKHZlcnNpb24zIDwgVmVyc2lvbi5WNSkgewogICAgICAgIGJ1ZmZlcjIoKTsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEJhdGNoVHlwZSh7CiAgICAgICAgLi4uYmFzZSwKICAgICAgICB0eXBlSWRzOiBidWZmZXIyKGludDhBcnJheSksCiAgICAgICAgb2Zmc2V0czogdHlwZS5tb2RlID09PSBVbmlvbk1vZGUuU3BhcnNlID8gbnVsbCA6IGJ1ZmZlcjIodHlwZS5vZmZzZXRzKSwKICAgICAgICBjaGlsZHJlbjogY3R4LnZpc2l0KHR5cGUuY2hpbGRyZW4pCiAgICAgIH0pOwogICAgfQogICAgLy8gdW5zdXBwb3J0ZWQgdHlwZQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKGludmFsaWREYXRhVHlwZSh0eXBlSWQpKTsKICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZW5jb2RlL2J1aWxkZXIuanMKZnVuY3Rpb24gd3JpdGVJbnQzMihidWYyLCBpbmRleCwgdmFsdWUpIHsKICBidWYyW2luZGV4XSA9IHZhbHVlOwogIGJ1ZjJbaW5kZXggKyAxXSA9IHZhbHVlID4+IDg7CiAgYnVmMltpbmRleCArIDJdID0gdmFsdWUgPj4gMTY7CiAgYnVmMltpbmRleCArIDNdID0gdmFsdWUgPj4gMjQ7Cn0KdmFyIElOSVRfU0laRSA9IDEwMjQ7CnZhciBCdWlsZGVyID0gY2xhc3MgewogIC8qKgogICAqIENyZWF0ZSBhIG5ldyBidWlsZGVyIGluc3RhbmNlLgogICAqIEBwYXJhbSB7aW1wb3J0KCcuL3NpbmsuanMnKS5TaW5rfSBzaW5rIFRoZSBieXRlIGNvbnN1bWVyLgogICAqLwogIGNvbnN0cnVjdG9yKHNpbmspIHsKICAgIHRoaXMuc2luayA9IHNpbms7CiAgICB0aGlzLm1pbmFsaWduID0gMTsKICAgIHRoaXMuYnVmID0gbmV3IFVpbnQ4QXJyYXkoSU5JVF9TSVpFKTsKICAgIHRoaXMuc3BhY2UgPSBJTklUX1NJWkU7CiAgICB0aGlzLnZ0YWJsZXMgPSBbXTsKICAgIHRoaXMub3V0cHV0Qnl0ZXMgPSAwOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBmbGF0YnVmZmVyIG9mZnNldCwgcmVsYXRpdmUgdG8gdGhlIGVuZCBvZiB0aGUgY3VycmVudCBidWZmZXIuCiAgICogQHJldHVybnMge251bWJlcn0gT2Zmc2V0IHJlbGF0aXZlIHRvIHRoZSBlbmQgb2YgdGhlIGJ1ZmZlci4KICAgKi8KICBvZmZzZXQoKSB7CiAgICByZXR1cm4gdGhpcy5idWYubGVuZ3RoIC0gdGhpcy5zcGFjZTsKICB9CiAgLyoqCiAgICogV3JpdGUgYSBmbGF0YnVmZmVyIGludDggdmFsdWUgYXQgdGhlIGN1cnJlbnQgYnVmZmVyIHBvc2l0aW9uCiAgICogYW5kIGFkdmFuY2UgdGhlIGludGVybmFsIGN1cnNvci4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICAgKi8KICB3cml0ZUludDgodmFsdWUpIHsKICAgIHRoaXMuYnVmW3RoaXMuc3BhY2UgLT0gMV0gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogV3JpdGUgYSBmbGF0YnVmZmVyIGludDE2IHZhbHVlIGF0IHRoZSBjdXJyZW50IGJ1ZmZlciBwb3NpdGlvbgogICAqIGFuZCBhZHZhbmNlIHRoZSBpbnRlcm5hbCBjdXJzb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAgICovCiAgd3JpdGVJbnQxNih2YWx1ZSkgewogICAgdGhpcy5idWZbdGhpcy5zcGFjZSAtPSAyXSA9IHZhbHVlOwogICAgdGhpcy5idWZbdGhpcy5zcGFjZSArIDFdID0gdmFsdWUgPj4gODsKICB9CiAgLyoqCiAgICogV3JpdGUgYSBmbGF0YnVmZmVyIGludDMyIHZhbHVlIGF0IHRoZSBjdXJyZW50IGJ1ZmZlciBwb3NpdGlvbgogICAqIGFuZCBhZHZhbmNlIHRoZSBpbnRlcm5hbCBjdXJzb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAgICovCiAgd3JpdGVJbnQzMih2YWx1ZSkgewogICAgd3JpdGVJbnQzMih0aGlzLmJ1ZiwgdGhpcy5zcGFjZSAtPSA0LCB2YWx1ZSk7CiAgfQogIC8qKgogICAqIFdyaXRlIGEgZmxhdGJ1ZmZlciBpbnQ2NCB2YWx1ZSBhdCB0aGUgY3VycmVudCBidWZmZXIgcG9zaXRpb24KICAgKiBhbmQgYWR2YW5jZSB0aGUgaW50ZXJuYWwgY3Vyc29yLgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogICAqLwogIHdyaXRlSW50NjQodmFsdWUpIHsKICAgIGNvbnN0IHYgPSBCaWdJbnQodmFsdWUpOwogICAgdGhpcy53cml0ZUludDMyKE51bWJlcihCaWdJbnQuYXNJbnROKDMyLCB2ID4+IEJpZ0ludCgzMikpKSk7CiAgICB0aGlzLndyaXRlSW50MzIoTnVtYmVyKEJpZ0ludC5hc0ludE4oMzIsIHYpKSk7CiAgfQogIC8qKgogICAqIEFkZCBhIGZsYXRidWZmZXIgaW50OCB2YWx1ZSwgcHJvcGVybHkgYWxpZ25lZCwKICAgKiBAcGFyYW0gdmFsdWUgVGhlIGludDggdmFsdWUgdG8gYWRkIHRoZSBidWZmZXIuCiAgICovCiAgYWRkSW50OCh2YWx1ZSkgewogICAgcHJlcCh0aGlzLCAxLCAwKTsKICAgIHRoaXMud3JpdGVJbnQ4KHZhbHVlKTsKICB9CiAgLyoqCiAgICogQWRkIGEgZmxhdGJ1ZmZlciBpbnQxNiB2YWx1ZSwgcHJvcGVybHkgYWxpZ25lZCwKICAgKiBAcGFyYW0gdmFsdWUgVGhlIGludDE2IHZhbHVlIHRvIGFkZCB0aGUgYnVmZmVyLgogICAqLwogIGFkZEludDE2KHZhbHVlKSB7CiAgICBwcmVwKHRoaXMsIDIsIDApOwogICAgdGhpcy53cml0ZUludDE2KHZhbHVlKTsKICB9CiAgLyoqCiAgICogQWRkIGEgZmxhdGJ1ZmZlciBpbnQzMiB2YWx1ZSwgcHJvcGVybHkgYWxpZ25lZCwKICAgKiBAcGFyYW0gdmFsdWUgVGhlIGludDMyIHZhbHVlIHRvIGFkZCB0aGUgYnVmZmVyLgogICAqLwogIGFkZEludDMyKHZhbHVlKSB7CiAgICBwcmVwKHRoaXMsIDQsIDApOwogICAgdGhpcy53cml0ZUludDMyKHZhbHVlKTsKICB9CiAgLyoqCiAgICogQWRkIGEgZmxhdGJ1ZmZlciBpbnQ2NCB2YWx1ZXMsIHByb3Blcmx5IGFsaWduZWQuCiAgICogQHBhcmFtIHZhbHVlIFRoZSBpbnQ2NCB2YWx1ZSB0byBhZGQgdGhlIGJ1ZmZlci4KICAgKi8KICBhZGRJbnQ2NCh2YWx1ZSkgewogICAgcHJlcCh0aGlzLCA4LCAwKTsKICAgIHRoaXMud3JpdGVJbnQ2NCh2YWx1ZSk7CiAgfQogIC8qKgogICAqIEFkZCBhIGZsYXRidWZmZXIgb2Zmc2V0LCByZWxhdGl2ZSB0byB3aGVyZSBpdCB3aWxsIGJlIHdyaXR0ZW4uCiAgICogQHBhcmFtIHtudW1iZXJ9IG9mZnNldCBUaGUgb2Zmc2V0IHRvIGFkZC4KICAgKi8KICBhZGRPZmZzZXQob2Zmc2V0KSB7CiAgICBwcmVwKHRoaXMsIFNJWkVPRl9JTlQsIDApOwogICAgdGhpcy53cml0ZUludDMyKHRoaXMub2Zmc2V0KCkgLSBvZmZzZXQgKyBTSVpFT0ZfSU5UKTsKICB9CiAgLyoqCiAgICogQWRkIGEgZmxhdGJ1ZmZlciBvYmplY3QgKHZ0YWJsZSkuCiAgICogQHBhcmFtIHtudW1iZXJ9IG51bUZpZWxkcyBUaGUgbWF4aW11bSBudW1iZXIgb2YgZmllbGRzCiAgICogIHRoaXMgb2JqZWN0IG1heSBpbmNsdWRlLgogICAqIEBwYXJhbSB7KHRhYmxlQnVpbGRlcjogUmV0dXJuVHlwZTxvYmplY3RCdWlsZGVyPikgPT4gdm9pZH0gW2FkZEZpZWxkc10KICAgKiAgQSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdyaXRlcyBhbGwgZmllbGRzIHVzaW5nIGFuIG9iamVjdCBidWlsZGVyLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBvYmplY3Qgb2Zmc2V0LgogICAqLwogIGFkZE9iamVjdChudW1GaWVsZHMsIGFkZEZpZWxkcykgewogICAgY29uc3QgYiA9IG9iamVjdEJ1aWxkZXIodGhpcywgbnVtRmllbGRzKTsKICAgIGFkZEZpZWxkcz8uKGIpOwogICAgcmV0dXJuIGIuZmluaXNoKCk7CiAgfQogIC8qKgogICAqIEFkZCBhIGZsYXRidWZmZXIgdmVjdG9yIChsaXN0KS4KICAgKiBAdGVtcGxhdGUgVAogICAqIEBwYXJhbSB7VFtdfSBpdGVtcyBBbiBhcnJheSBvZiBpdGVtcyB0byB3cml0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgVGhlIHNpemUgaW4gYnl0ZXMgb2YgYSBzZXJpYWxpemVkIGl0ZW0uCiAgICogQHBhcmFtIHtudW1iZXJ9IGFsaWdubWVudCBUaGUgZGVzaXJlZCBieXRlIGFsaWdubWVudCB2YWx1ZS4KICAgKiBAcGFyYW0geyhidWlsZGVyOiB0aGlzLCBpdGVtOiBUKSA9PiB2b2lkfSB3cml0ZUl0ZW0gQSBjYWxsYmFjawogICAqICBmdW5jdGlvbiB0aGF0IHdyaXRlcyBhIHZlY3RvciBpdGVtIHRvIHRoaXMgYnVpbGRlci4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdmVjdG9yIG9mZnNldC4KICAgKi8KICBhZGRWZWN0b3IoaXRlbXMsIGl0ZW1TaXplLCBhbGlnbm1lbnQsIHdyaXRlSXRlbSkgewogICAgY29uc3QgbiA9IGl0ZW1zPy5sZW5ndGg7CiAgICBpZiAoIW4pIHJldHVybiAwOwogICAgcHJlcCh0aGlzLCBTSVpFT0ZfSU5ULCBpdGVtU2l6ZSAqIG4pOwogICAgcHJlcCh0aGlzLCBhbGlnbm1lbnQsIGl0ZW1TaXplICogbik7CiAgICBmb3IgKGxldCBpID0gbjsgLS1pID49IDA7ICkgewogICAgICB3cml0ZUl0ZW0odGhpcywgaXRlbXNbaV0pOwogICAgfQogICAgdGhpcy53cml0ZUludDMyKG4pOwogICAgcmV0dXJuIHRoaXMub2Zmc2V0KCk7CiAgfQogIC8qKgogICAqIENvbnZlbmllbmNlIG1ldGhvZCBmb3Igd3JpdGluZyBhIHZlY3RvciBvZiBieXRlIGJ1ZmZlciBvZmZzZXRzLgogICAqIEBwYXJhbSB7bnVtYmVyW119IG9mZnNldHMKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdmVjdG9yIG9mZnNldC4KICAgKi8KICBhZGRPZmZzZXRWZWN0b3Iob2Zmc2V0cykgewogICAgcmV0dXJuIHRoaXMuYWRkVmVjdG9yKG9mZnNldHMsIDQsIDQsIChiLCBvZmYpID0+IGIuYWRkT2Zmc2V0KG9mZikpOwogIH0KICAvKioKICAgKiBBZGQgYSBmbGF0YnVmZmVyIFVURi04IHN0cmluZy4KICAgKiBAcGFyYW0ge3N0cmluZ30gcyBUaGUgc3RyaW5nIHRvIGVuY29kZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBzdHJpbmcgb2Zmc2V0LgogICAqLwogIGFkZFN0cmluZyhzKSB7CiAgICBpZiAocyA9PSBudWxsKSByZXR1cm4gMDsKICAgIGNvbnN0IHV0ZjgyID0gZW5jb2RlVXRmOChzKTsKICAgIGNvbnN0IG4gPSB1dGY4Mi5sZW5ndGg7CiAgICB0aGlzLmFkZEludDgoMCk7CiAgICBwcmVwKHRoaXMsIFNJWkVPRl9JTlQsIG4pOwogICAgdGhpcy5idWYuc2V0KHV0ZjgyLCB0aGlzLnNwYWNlIC09IG4pOwogICAgdGhpcy53cml0ZUludDMyKG4pOwogICAgcmV0dXJuIHRoaXMub2Zmc2V0KCk7CiAgfQogIC8qKgogICAqIEZpbmlzaCB0aGUgY3VycmVudCBmbGF0YnVmZmVyIGJ5IGFkZGluZyBhIHJvb3Qgb2Zmc2V0LgogICAqIEBwYXJhbSB7bnVtYmVyfSByb290T2Zmc2V0IFRoZSByb290IG9mZnNldC4KICAgKi8KICBmaW5pc2gocm9vdE9mZnNldCkgewogICAgcHJlcCh0aGlzLCB0aGlzLm1pbmFsaWduLCBTSVpFT0ZfSU5UKTsKICAgIHRoaXMuYWRkT2Zmc2V0KHJvb3RPZmZzZXQpOwogIH0KICAvKioKICAgKiBGbHVzaCB0aGUgY3VycmVudCBmbGF0YnVmZmVyIGJ5dGUgYnVmZmVyIGNvbnRlbnQgdG8gdGhlIHNpbmssCiAgICogYW5kIHJlc2V0IHRoZSBmbGF0YnVmZmVyIGJ1aWxkZXIgc3RhdGUuCiAgICovCiAgZmx1c2goKSB7CiAgICBjb25zdCB7IGJ1ZjogYnVmMiwgc2luayB9ID0gdGhpczsKICAgIGNvbnN0IGJ5dGVzID0gYnVmMi5zdWJhcnJheSh0aGlzLnNwYWNlLCBidWYyLmxlbmd0aCk7CiAgICBzaW5rLndyaXRlKGJ5dGVzKTsKICAgIHRoaXMub3V0cHV0Qnl0ZXMgKz0gYnl0ZXMuYnl0ZUxlbmd0aDsKICAgIHRoaXMubWluYWxpZ24gPSAxOwogICAgdGhpcy52dGFibGVzID0gW107CiAgICB0aGlzLmJ1ZiA9IG5ldyBVaW50OEFycmF5KElOSVRfU0laRSk7CiAgICB0aGlzLnNwYWNlID0gSU5JVF9TSVpFOwogIH0KICAvKioKICAgKiBBZGQgYSBieXRlIGJ1ZmZlciBkaXJlY3RseSB0byB0aGUgYnVpbGRlciBzaW5rLiBUaGlzIG1ldGhvZCBieXBhc3NlcwogICAqIGFueSB1bmZsdXNoZWQgZmxhdGJ1ZmZlciBzdGF0ZSBhbmQgbGVhdmVzIGl0IHVuY2hhbmdlZCwgd3JpdGluZyB0aGUKICAgKiBidWZmZXIgdG8gdGhlIHNpbmsgKmJlZm9yZSogdGhlIGZsYXRidWZmZXIuCiAgICogVGhlIGJ1ZmZlciB3aWxsIGJlIHBhZGRlZCBmb3IgNjQtYml0ICg4LWJ5dGUpIGFsaWdubWVudCBhcyBuZWVkZWQuCiAgICogQHBhcmFtIHtVaW50OEFycmF5fSBidWZmZXIgVGhlIGJ1ZmZlciB0byBhZGQuCiAgICogQHJldHVybnMge251bWJlcn0gVGhlIHRvdGFsIGJ5dGUgY291bnQgb2YgdGhlIGJ1ZmZlciBhbmQgcGFkZGluZy4KICAgKi8KICBhZGRCdWZmZXIoYnVmZmVyMikgewogICAgY29uc3Qgc2l6ZSA9IGJ1ZmZlcjIuYnl0ZUxlbmd0aDsKICAgIGlmICghc2l6ZSkgcmV0dXJuIDA7CiAgICB0aGlzLnNpbmsud3JpdGUoYnVmZmVyMik7CiAgICB0aGlzLm91dHB1dEJ5dGVzICs9IHNpemU7CiAgICBjb25zdCBwYWQyID0gKHNpemUgKyA3ICYgfjcpIC0gc2l6ZTsKICAgIHRoaXMuYWRkUGFkZGluZyhwYWQyKTsKICAgIHJldHVybiBzaXplICsgcGFkMjsKICB9CiAgLyoqCiAgICogV3JpdGUgcGFkZGluZyBieXRlcyBkaXJlY3RseSB0byB0aGUgYnVpbGRlciBzaW5rLiBUaGlzIG1ldGhvZCBieXBhc3NlcwogICAqIGFueSB1bmZsdXNoZWQgZmxhdGJ1ZmZlciBzdGF0ZSBhbmQgbGVhdmVzIGl0IHVuY2hhbmdlZCwgd3JpdGluZyB0aGUKICAgKiBwYWRkaW5nIGJ5dGVzIHRvIHRoZSBzaW5rICpiZWZvcmUqIHRoZSBmbGF0YnVmZmVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBieXRlQ291bnQgVGhlIG51bWJlciBvZiBwYWRkaW5nIGJ5dGVzLgogICAqLwogIGFkZFBhZGRpbmcoYnl0ZUNvdW50KSB7CiAgICBpZiAoYnl0ZUNvdW50ID4gMCkgewogICAgICB0aGlzLnNpbmsud3JpdGUobmV3IFVpbnQ4QXJyYXkoYnl0ZUNvdW50KSk7CiAgICAgIHRoaXMub3V0cHV0Qnl0ZXMgKz0gYnl0ZUNvdW50OwogICAgfQogIH0KfTsKZnVuY3Rpb24gcHJlcChidWlsZGVyMiwgc2l6ZSwgYWRkaXRpb25hbEJ5dGVzKSB7CiAgbGV0IHsgYnVmOiBidWYyLCBzcGFjZSwgbWluYWxpZ24gfSA9IGJ1aWxkZXIyOwogIGlmIChzaXplID4gbWluYWxpZ24pIHsKICAgIGJ1aWxkZXIyLm1pbmFsaWduID0gc2l6ZTsKICB9CiAgY29uc3QgYnVmU2l6ZSA9IGJ1ZjIubGVuZ3RoOwogIGNvbnN0IHVzZWQgPSBidWZTaXplIC0gc3BhY2UgKyBhZGRpdGlvbmFsQnl0ZXM7CiAgY29uc3QgYWxpZ25TaXplID0gfnVzZWQgKyAxICYgc2l6ZSAtIDE7CiAgYnVmMiA9IGdyb3coYnVmMiwgdXNlZCArIGFsaWduU2l6ZSArIHNpemUgLSAxLCB0cnVlKTsKICBzcGFjZSArPSBidWYyLmxlbmd0aCAtIGJ1ZlNpemU7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGlnblNpemU7ICsraSkgewogICAgYnVmMlstLXNwYWNlXSA9IDA7CiAgfQogIGJ1aWxkZXIyLmJ1ZiA9IGJ1ZjI7CiAgYnVpbGRlcjIuc3BhY2UgPSBzcGFjZTsKfQpmdW5jdGlvbiBvYmplY3RCdWlsZGVyKGJ1aWxkZXIyLCBudW1GaWVsZHMpIHsKICBjb25zdCB2dGFibGUgPSBBcnJheShudW1GaWVsZHMpLmZpbGwoMCk7CiAgY29uc3Qgc3RhcnRPZmZzZXQgPSBidWlsZGVyMi5vZmZzZXQoKTsKICBmdW5jdGlvbiBzbG90KGluZGV4KSB7CiAgICB2dGFibGVbaW5kZXhdID0gYnVpbGRlcjIub2Zmc2V0KCk7CiAgfQogIHJldHVybiB7CiAgICAvKioKICAgICAqIEFkZCBhbiBpbnQ4LXZhbHVlZCB0YWJsZSBmaWVsZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVmYXVsdFZhbHVlCiAgICAgKi8KICAgIGFkZEludDgoaW5kZXgsIHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHZhbHVlICE9IGRlZmF1bHRWYWx1ZSkgewogICAgICAgIGJ1aWxkZXIyLmFkZEludDgodmFsdWUpOwogICAgICAgIHNsb3QoaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgLyoqCiAgICAgKiBBZGQgYW4gaW50MTYtdmFsdWVkIHRhYmxlIGZpZWxkLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4CiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWZhdWx0VmFsdWUKICAgICAqLwogICAgYWRkSW50MTYoaW5kZXgsIHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHZhbHVlICE9IGRlZmF1bHRWYWx1ZSkgewogICAgICAgIGJ1aWxkZXIyLmFkZEludDE2KHZhbHVlKTsKICAgICAgICBzbG90KGluZGV4KTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogQWRkIGFuIGludDMyLXZhbHVlZCB0YWJsZSBmaWVsZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVmYXVsdFZhbHVlCiAgICAgKi8KICAgIGFkZEludDMyKGluZGV4LCB2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBkZWZhdWx0VmFsdWUpIHsKICAgICAgICBidWlsZGVyMi5hZGRJbnQzMih2YWx1ZSk7CiAgICAgICAgc2xvdChpbmRleCk7CiAgICAgIH0KICAgIH0sCiAgICAvKioKICAgICAqIEFkZCBhbiBpbnQ2NC12YWx1ZWQgdGFibGUgZmllbGQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRlZmF1bHRWYWx1ZQogICAgICovCiAgICBhZGRJbnQ2NChpbmRleCwgdmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAodmFsdWUgIT0gZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgYnVpbGRlcjIuYWRkSW50NjQodmFsdWUpOwogICAgICAgIHNsb3QoaW5kZXgpOwogICAgICB9CiAgICB9LAogICAgLyoqCiAgICAgKiBBZGQgYSBidWZmZXIgb2Zmc2V0LXZhbHVlZCB0YWJsZSBmaWVsZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleAogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVmYXVsdFZhbHVlCiAgICAgKi8KICAgIGFkZE9mZnNldChpbmRleCwgdmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAodmFsdWUgIT0gZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgYnVpbGRlcjIuYWRkT2Zmc2V0KHZhbHVlKTsKICAgICAgICBzbG90KGluZGV4KTsKICAgICAgfQogICAgfSwKICAgIC8qKgogICAgICogV3JpdGUgdGhlIHZ0YWJsZSB0byB0aGUgYnVmZmVyIGFuZCByZXR1cm4gdGhlIHRhYmxlIG9mZnNldC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBidWZmZXIgb2Zmc2V0IHRvIHRoZSB2dGFibGUuCiAgICAgKi8KICAgIGZpbmlzaCgpIHsKICAgICAgYnVpbGRlcjIuYWRkSW50MzIoMCk7CiAgICAgIGNvbnN0IHZ0YWJsZU9mZnNldCA9IGJ1aWxkZXIyLm9mZnNldCgpOwogICAgICBsZXQgaSA9IG51bUZpZWxkczsKICAgICAgd2hpbGUgKC0taSA+PSAwICYmIHZ0YWJsZVtpXSA9PT0gMCkgewogICAgICB9CiAgICAgIGNvbnN0IHNpemUgPSBpICsgMTsKICAgICAgZm9yICg7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgYnVpbGRlcjIuYWRkSW50MTYodnRhYmxlW2ldID8gdnRhYmxlT2Zmc2V0IC0gdnRhYmxlW2ldIDogMCk7CiAgICAgIH0KICAgICAgY29uc3Qgc3RhbmRhcmRGaWVsZHMgPSAyOwogICAgICBidWlsZGVyMi5hZGRJbnQxNih2dGFibGVPZmZzZXQgLSBzdGFydE9mZnNldCk7CiAgICAgIGNvbnN0IGxlbiA9IChzaXplICsgc3RhbmRhcmRGaWVsZHMpICogU0laRU9GX1NIT1JUOwogICAgICBidWlsZGVyMi5hZGRJbnQxNihsZW4pOwogICAgICBsZXQgZXhpc3RpbmdUYWJsZSA9IDA7CiAgICAgIGNvbnN0IHsgYnVmOiBidWYyLCB2dGFibGVzLCBzcGFjZTogdnQxIH0gPSBidWlsZGVyMjsKICAgICAgb3V0ZXJfbG9vcDoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdnRhYmxlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgdnQyID0gYnVmMi5sZW5ndGggLSB2dGFibGVzW2ldOwogICAgICAgICAgaWYgKGxlbiA9PSByZWFkSW50MTYoYnVmMiwgdnQyKSkgewogICAgICAgICAgICBmb3IgKGxldCBqID0gU0laRU9GX1NIT1JUOyBqIDwgbGVuOyBqICs9IFNJWkVPRl9TSE9SVCkgewogICAgICAgICAgICAgIGlmIChyZWFkSW50MTYoYnVmMiwgdnQxICsgaikgIT0gcmVhZEludDE2KGJ1ZjIsIHZ0MiArIGopKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBvdXRlcl9sb29wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBleGlzdGluZ1RhYmxlID0gdnRhYmxlc1tpXTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBpZiAoZXhpc3RpbmdUYWJsZSkgewogICAgICAgIGJ1aWxkZXIyLnNwYWNlID0gYnVmMi5sZW5ndGggLSB2dGFibGVPZmZzZXQ7CiAgICAgICAgd3JpdGVJbnQzMihidWYyLCBidWlsZGVyMi5zcGFjZSwgZXhpc3RpbmdUYWJsZSAtIHZ0YWJsZU9mZnNldCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgb2ZmID0gYnVpbGRlcjIub2Zmc2V0KCk7CiAgICAgICAgdnRhYmxlcy5wdXNoKG9mZik7CiAgICAgICAgd3JpdGVJbnQzMihidWYyLCBidWYyLmxlbmd0aCAtIHZ0YWJsZU9mZnNldCwgb2ZmIC0gdnRhYmxlT2Zmc2V0KTsKICAgICAgfQogICAgICByZXR1cm4gdnRhYmxlT2Zmc2V0OwogICAgfQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZW5jb2RlL3JlY29yZC1iYXRjaC5qcwpmdW5jdGlvbiBlbmNvZGVSZWNvcmRCYXRjaChidWlsZGVyMiwgYmF0Y2gpIHsKICBjb25zdCB7IG5vZGVzLCByZWdpb25zLCB2YXJpYWRpYyB9ID0gYmF0Y2g7CiAgY29uc3Qgbm9kZVZlY3RvciA9IGJ1aWxkZXIyLmFkZFZlY3RvcigKICAgIG5vZGVzLAogICAgMTYsCiAgICA4LAogICAgKGJ1aWxkZXIzLCBub2RlKSA9PiB7CiAgICAgIGJ1aWxkZXIzLndyaXRlSW50NjQobm9kZS5udWxsQ291bnQpOwogICAgICBidWlsZGVyMy53cml0ZUludDY0KG5vZGUubGVuZ3RoKTsKICAgICAgcmV0dXJuIGJ1aWxkZXIzLm9mZnNldCgpOwogICAgfQogICk7CiAgY29uc3QgcmVnaW9uVmVjdG9yID0gYnVpbGRlcjIuYWRkVmVjdG9yKAogICAgcmVnaW9ucywKICAgIDE2LAogICAgOCwKICAgIChidWlsZGVyMywgcmVnaW9uKSA9PiB7CiAgICAgIGJ1aWxkZXIzLndyaXRlSW50NjQocmVnaW9uLmxlbmd0aCk7CiAgICAgIGJ1aWxkZXIzLndyaXRlSW50NjQocmVnaW9uLm9mZnNldCk7CiAgICAgIHJldHVybiBidWlsZGVyMy5vZmZzZXQoKTsKICAgIH0KICApOwogIGNvbnN0IHZhcmlhZGljVmVjdG9yID0gYnVpbGRlcjIuYWRkVmVjdG9yKAogICAgdmFyaWFkaWMsCiAgICA4LAogICAgOCwKICAgIChidWlsZGVyMywgY291bnQyKSA9PiBidWlsZGVyMy5hZGRJbnQ2NChjb3VudDIpCiAgKTsKICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDUsIChiKSA9PiB7CiAgICBiLmFkZEludDY0KDAsIG5vZGVzWzBdLmxlbmd0aCwgMCk7CiAgICBiLmFkZE9mZnNldCgxLCBub2RlVmVjdG9yLCAwKTsKICAgIGIuYWRkT2Zmc2V0KDIsIHJlZ2lvblZlY3RvciwgMCk7CiAgICBiLmFkZE9mZnNldCg0LCB2YXJpYWRpY1ZlY3RvciwgMCk7CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZW5jb2RlL2RpY3Rpb25hcnktYmF0Y2guanMKZnVuY3Rpb24gZW5jb2RlRGljdGlvbmFyeUJhdGNoKGJ1aWxkZXIyLCBkaWN0aW9uYXJ5QmF0Y2gpIHsKICBjb25zdCBkYXRhT2Zmc2V0ID0gZW5jb2RlUmVjb3JkQmF0Y2goYnVpbGRlcjIsIGRpY3Rpb25hcnlCYXRjaC5kYXRhKTsKICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDMsIChiKSA9PiB7CiAgICBiLmFkZEludDY0KDAsIGRpY3Rpb25hcnlCYXRjaC5pZCwgMCk7CiAgICBiLmFkZE9mZnNldCgxLCBkYXRhT2Zmc2V0LCAwKTsKICAgIGIuYWRkSW50OCgyLCArZGljdGlvbmFyeUJhdGNoLmlzRGVsdGEsIDApOwogIH0pOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2VuY29kZS9tZXRhZGF0YS5qcwpmdW5jdGlvbiBlbmNvZGVNZXRhZGF0YShidWlsZGVyMiwgbWV0YWRhdGEpIHsKICByZXR1cm4gbWV0YWRhdGE/LnNpemUgPiAwID8gYnVpbGRlcjIuYWRkT2Zmc2V0VmVjdG9yKEFycmF5LmZyb20obWV0YWRhdGEsIChbaywgdl0pID0+IHsKICAgIGNvbnN0IGtleSA9IGJ1aWxkZXIyLmFkZFN0cmluZyhgJHtrfWApOwogICAgY29uc3QgdmFsID0gYnVpbGRlcjIuYWRkU3RyaW5nKGAke3Z9YCk7CiAgICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDIsIChiKSA9PiB7CiAgICAgIGIuYWRkT2Zmc2V0KDAsIGtleSwgMCk7CiAgICAgIGIuYWRkT2Zmc2V0KDEsIHZhbCwgMCk7CiAgICB9KTsKICB9KSkgOiAwOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2VuY29kZS9kYXRhLXR5cGUuanMKZnVuY3Rpb24gZW5jb2RlRGF0YVR5cGUoYnVpbGRlcjIsIHR5cGUpIHsKICBjb25zdCB0eXBlSWQgPSBjaGVja09uZU9mKHR5cGUudHlwZUlkLCBUeXBlLCBpbnZhbGlkRGF0YVR5cGUpOwogIHN3aXRjaCAodHlwZUlkKSB7CiAgICBjYXNlIFR5cGUuRGljdGlvbmFyeToKICAgICAgcmV0dXJuIGVuY29kZURpY3Rpb25hcnkoYnVpbGRlcjIsIHR5cGUpOwogICAgY2FzZSBUeXBlLkludDoKICAgICAgcmV0dXJuIGVuY29kZUludChidWlsZGVyMiwgdHlwZSk7CiAgICBjYXNlIFR5cGUuRmxvYXQ6CiAgICAgIHJldHVybiBlbmNvZGVGbG9hdChidWlsZGVyMiwgdHlwZSk7CiAgICBjYXNlIFR5cGUuRGVjaW1hbDoKICAgICAgcmV0dXJuIGVuY29kZURlY2ltYWwoYnVpbGRlcjIsIHR5cGUpOwogICAgY2FzZSBUeXBlLkRhdGU6CiAgICAgIHJldHVybiBlbmNvZGVEYXRlKGJ1aWxkZXIyLCB0eXBlKTsKICAgIGNhc2UgVHlwZS5UaW1lOgogICAgICByZXR1cm4gZW5jb2RlVGltZShidWlsZGVyMiwgdHlwZSk7CiAgICBjYXNlIFR5cGUuVGltZXN0YW1wOgogICAgICByZXR1cm4gZW5jb2RlVGltZXN0YW1wKGJ1aWxkZXIyLCB0eXBlKTsKICAgIGNhc2UgVHlwZS5JbnRlcnZhbDoKICAgICAgcmV0dXJuIGVuY29kZUludGVydmFsKGJ1aWxkZXIyLCB0eXBlKTsKICAgIGNhc2UgVHlwZS5EdXJhdGlvbjoKICAgICAgcmV0dXJuIGVuY29kZUR1cmF0aW9uKGJ1aWxkZXIyLCB0eXBlKTsKICAgIGNhc2UgVHlwZS5GaXhlZFNpemVCaW5hcnk6CiAgICBjYXNlIFR5cGUuRml4ZWRTaXplTGlzdDoKICAgICAgcmV0dXJuIGVuY29kZUZpeGVkU2l6ZShidWlsZGVyMiwgdHlwZSk7CiAgICBjYXNlIFR5cGUuTWFwOgogICAgICByZXR1cm4gZW5jb2RlTWFwKGJ1aWxkZXIyLCB0eXBlKTsKICAgIGNhc2UgVHlwZS5VbmlvbjoKICAgICAgcmV0dXJuIGVuY29kZVVuaW9uKGJ1aWxkZXIyLCB0eXBlKTsKICB9CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCgwKTsKfQpmdW5jdGlvbiBlbmNvZGVEYXRlKGJ1aWxkZXIyLCB0eXBlKSB7CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCgxLCAoYikgPT4gewogICAgYi5hZGRJbnQxNigwLCB0eXBlLnVuaXQsIERhdGVVbml0Lk1JTExJU0VDT05EKTsKICB9KTsKfQpmdW5jdGlvbiBlbmNvZGVEZWNpbWFsKGJ1aWxkZXIyLCB0eXBlKSB7CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCgzLCAoYikgPT4gewogICAgYi5hZGRJbnQzMigwLCB0eXBlLnByZWNpc2lvbiwgMCk7CiAgICBiLmFkZEludDMyKDEsIHR5cGUuc2NhbGUsIDApOwogICAgYi5hZGRJbnQzMigyLCB0eXBlLmJpdFdpZHRoLCAxMjgpOwogIH0pOwp9CmZ1bmN0aW9uIGVuY29kZUR1cmF0aW9uKGJ1aWxkZXIyLCB0eXBlKSB7CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCgxLCAoYikgPT4gewogICAgYi5hZGRJbnQxNigwLCB0eXBlLnVuaXQsIFRpbWVVbml0Lk1JTExJU0VDT05EKTsKICB9KTsKfQpmdW5jdGlvbiBlbmNvZGVGaXhlZFNpemUoYnVpbGRlcjIsIHR5cGUpIHsKICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDEsIChiKSA9PiB7CiAgICBiLmFkZEludDMyKDAsIHR5cGUuc3RyaWRlLCAwKTsKICB9KTsKfQpmdW5jdGlvbiBlbmNvZGVGbG9hdChidWlsZGVyMiwgdHlwZSkgewogIHJldHVybiBidWlsZGVyMi5hZGRPYmplY3QoMSwgKGIpID0+IHsKICAgIGIuYWRkSW50MTYoMCwgdHlwZS5wcmVjaXNpb24sIFByZWNpc2lvbi5IQUxGKTsKICB9KTsKfQpmdW5jdGlvbiBlbmNvZGVJbnQoYnVpbGRlcjIsIHR5cGUpIHsKICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDIsIChiKSA9PiB7CiAgICBiLmFkZEludDMyKDAsIHR5cGUuYml0V2lkdGgsIDApOwogICAgYi5hZGRJbnQ4KDEsICt0eXBlLnNpZ25lZCwgMCk7CiAgfSk7Cn0KZnVuY3Rpb24gZW5jb2RlSW50ZXJ2YWwoYnVpbGRlcjIsIHR5cGUpIHsKICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDEsIChiKSA9PiB7CiAgICBiLmFkZEludDE2KDAsIHR5cGUudW5pdCwgSW50ZXJ2YWxVbml0LllFQVJfTU9OVEgpOwogIH0pOwp9CmZ1bmN0aW9uIGVuY29kZU1hcChidWlsZGVyMiwgdHlwZSkgewogIHJldHVybiBidWlsZGVyMi5hZGRPYmplY3QoMSwgKGIpID0+IHsKICAgIGIuYWRkSW50OCgwLCArdHlwZS5rZXlzU29ydGVkLCAwKTsKICB9KTsKfQpmdW5jdGlvbiBlbmNvZGVUaW1lKGJ1aWxkZXIyLCB0eXBlKSB7CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCgyLCAoYikgPT4gewogICAgYi5hZGRJbnQxNigwLCB0eXBlLnVuaXQsIFRpbWVVbml0Lk1JTExJU0VDT05EKTsKICAgIGIuYWRkSW50MzIoMSwgdHlwZS5iaXRXaWR0aCwgMzIpOwogIH0pOwp9CmZ1bmN0aW9uIGVuY29kZVRpbWVzdGFtcChidWlsZGVyMiwgdHlwZSkgewogIGNvbnN0IHRpbWV6b25lT2Zmc2V0ID0gYnVpbGRlcjIuYWRkU3RyaW5nKHR5cGUudGltZXpvbmUpOwogIHJldHVybiBidWlsZGVyMi5hZGRPYmplY3QoMiwgKGIpID0+IHsKICAgIGIuYWRkSW50MTYoMCwgdHlwZS51bml0LCBUaW1lVW5pdC5TRUNPTkQpOwogICAgYi5hZGRPZmZzZXQoMSwgdGltZXpvbmVPZmZzZXQsIDApOwogIH0pOwp9CmZ1bmN0aW9uIGVuY29kZVVuaW9uKGJ1aWxkZXIyLCB0eXBlKSB7CiAgY29uc3QgdHlwZUlkc09mZnNldCA9IGJ1aWxkZXIyLmFkZFZlY3RvcigKICAgIHR5cGUudHlwZUlkcywKICAgIDQsCiAgICA0LAogICAgKGJ1aWxkZXIzLCB2YWx1ZSkgPT4gYnVpbGRlcjMuYWRkSW50MzIodmFsdWUpCiAgKTsKICByZXR1cm4gYnVpbGRlcjIuYWRkT2JqZWN0KDIsIChiKSA9PiB7CiAgICBiLmFkZEludDE2KDAsIHR5cGUubW9kZSwgVW5pb25Nb2RlLlNwYXJzZSk7CiAgICBiLmFkZE9mZnNldCgxLCB0eXBlSWRzT2Zmc2V0LCAwKTsKICB9KTsKfQpmdW5jdGlvbiBlbmNvZGVEaWN0aW9uYXJ5KGJ1aWxkZXIyLCB0eXBlKSB7CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCg0LCAoYikgPT4gewogICAgYi5hZGRJbnQ2NCgwLCB0eXBlLmlkLCAwKTsKICAgIGIuYWRkT2Zmc2V0KDEsIGVuY29kZURhdGFUeXBlKGJ1aWxkZXIyLCB0eXBlLmluZGljZXMpLCAwKTsKICAgIGIuYWRkSW50OCgyLCArdHlwZS5vcmRlcmVkLCAwKTsKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy9lbmNvZGUvc2NoZW1hLmpzCnZhciBpc0xpdHRsZUVuZGlhbiA9IG5ldyBVaW50MTZBcnJheShuZXcgVWludDhBcnJheShbMSwgMF0pLmJ1ZmZlcilbMF0gPT09IDE7CmZ1bmN0aW9uIGVuY29kZVNjaGVtYShidWlsZGVyMiwgc2NoZW1hKSB7CiAgY29uc3QgeyBmaWVsZHMsIG1ldGFkYXRhIH0gPSBzY2hlbWE7CiAgY29uc3QgZmllbGRPZmZzZXRzID0gZmllbGRzLm1hcCgoZikgPT4gZW5jb2RlRmllbGQoYnVpbGRlcjIsIGYpKTsKICBjb25zdCBmaWVsZHNWZWN0b3JPZmZzZXQgPSBidWlsZGVyMi5hZGRPZmZzZXRWZWN0b3IoZmllbGRPZmZzZXRzKTsKICBjb25zdCBtZXRhZGF0YU9mZnNldCA9IGVuY29kZU1ldGFkYXRhKGJ1aWxkZXIyLCBtZXRhZGF0YSk7CiAgcmV0dXJuIGJ1aWxkZXIyLmFkZE9iamVjdCg0LCAoYikgPT4gewogICAgYi5hZGRJbnQxNigwLCArIWlzTGl0dGxlRW5kaWFuLCAwKTsKICAgIGIuYWRkT2Zmc2V0KDEsIGZpZWxkc1ZlY3Rvck9mZnNldCwgMCk7CiAgICBiLmFkZE9mZnNldCgyLCBtZXRhZGF0YU9mZnNldCwgMCk7CiAgfSk7Cn0KZnVuY3Rpb24gZW5jb2RlRmllbGQoYnVpbGRlcjIsIGZpZWxkMikgewogIGNvbnN0IHsgbmFtZSwgbnVsbGFibGUsIHR5cGUsIG1ldGFkYXRhIH0gPSBmaWVsZDI7CiAgbGV0IHsgdHlwZUlkIH0gPSB0eXBlOwogIGxldCB0eXBlT2Zmc2V0ID0gMDsKICBsZXQgZGljdGlvbmFyeU9mZnNldCA9IDA7CiAgaWYgKHR5cGVJZCAhPT0gVHlwZS5EaWN0aW9uYXJ5KSB7CiAgICB0eXBlT2Zmc2V0ID0gZW5jb2RlRGF0YVR5cGUoYnVpbGRlcjIsIHR5cGUpOwogIH0gZWxzZSB7CiAgICBjb25zdCBkaWN0ID0gKAogICAgICAvKiogQHR5cGUge2ltcG9ydCgnLi4vdHlwZXMuanMnKS5EaWN0aW9uYXJ5VHlwZX0gKi8KICAgICAgdHlwZS5kaWN0aW9uYXJ5CiAgICApOwogICAgdHlwZUlkID0gZGljdC50eXBlSWQ7CiAgICBkaWN0aW9uYXJ5T2Zmc2V0ID0gZW5jb2RlRGF0YVR5cGUoYnVpbGRlcjIsIHR5cGUpOwogICAgdHlwZU9mZnNldCA9IGVuY29kZURhdGFUeXBlKGJ1aWxkZXIyLCBkaWN0KTsKICB9CiAgY29uc3QgY2hpbGRPZmZzZXRzID0gKHR5cGUuY2hpbGRyZW4gfHwgW10pLm1hcCgoZikgPT4gZW5jb2RlRmllbGQoYnVpbGRlcjIsIGYpKTsKICBjb25zdCBjaGlsZHJlblZlY3Rvck9mZnNldCA9IGJ1aWxkZXIyLmFkZE9mZnNldFZlY3RvcihjaGlsZE9mZnNldHMpOwogIGNvbnN0IG1ldGFkYXRhT2Zmc2V0ID0gZW5jb2RlTWV0YWRhdGEoYnVpbGRlcjIsIG1ldGFkYXRhKTsKICBjb25zdCBuYW1lT2Zmc2V0ID0gYnVpbGRlcjIuYWRkU3RyaW5nKG5hbWUpOwogIHJldHVybiBidWlsZGVyMi5hZGRPYmplY3QoNywgKGIpID0+IHsKICAgIGIuYWRkT2Zmc2V0KDAsIG5hbWVPZmZzZXQsIDApOwogICAgYi5hZGRJbnQ4KDEsICtudWxsYWJsZSwgMCk7CiAgICBiLmFkZEludDgoMiwgdHlwZUlkLCBUeXBlLk5PTkUpOwogICAgYi5hZGRPZmZzZXQoMywgdHlwZU9mZnNldCwgMCk7CiAgICBiLmFkZE9mZnNldCg0LCBkaWN0aW9uYXJ5T2Zmc2V0LCAwKTsKICAgIGIuYWRkT2Zmc2V0KDUsIGNoaWxkcmVuVmVjdG9yT2Zmc2V0LCAwKTsKICAgIGIuYWRkT2Zmc2V0KDYsIG1ldGFkYXRhT2Zmc2V0LCAwKTsKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy9lbmNvZGUvZm9vdGVyLmpzCmZ1bmN0aW9uIHdyaXRlRm9vdGVyKGJ1aWxkZXIyLCBzY2hlbWEsIGRpY3RCbG9ja3MsIHJlY29yZEJsb2NrcywgbWV0YWRhdGEpIHsKICBjb25zdCBtZXRhZGF0YU9mZnNldCA9IGVuY29kZU1ldGFkYXRhKGJ1aWxkZXIyLCBtZXRhZGF0YSk7CiAgY29uc3QgcmVjc09mZnNldCA9IGJ1aWxkZXIyLmFkZFZlY3RvcihyZWNvcmRCbG9ja3MsIDI0LCA4LCBlbmNvZGVCbG9jayk7CiAgY29uc3QgZGljdHNPZmZzZXQgPSBidWlsZGVyMi5hZGRWZWN0b3IoZGljdEJsb2NrcywgMjQsIDgsIGVuY29kZUJsb2NrKTsKICBjb25zdCBzY2hlbWFPZmZzZXQgPSBlbmNvZGVTY2hlbWEoYnVpbGRlcjIsIHNjaGVtYSk7CiAgYnVpbGRlcjIuZmluaXNoKAogICAgYnVpbGRlcjIuYWRkT2JqZWN0KDUsIChiKSA9PiB7CiAgICAgIGIuYWRkSW50MTYoMCwgVmVyc2lvbi5WNSwgVmVyc2lvbi5WMSk7CiAgICAgIGIuYWRkT2Zmc2V0KDEsIHNjaGVtYU9mZnNldCwgMCk7CiAgICAgIGIuYWRkT2Zmc2V0KDIsIGRpY3RzT2Zmc2V0LCAwKTsKICAgICAgYi5hZGRPZmZzZXQoMywgcmVjc09mZnNldCwgMCk7CiAgICAgIGIuYWRkT2Zmc2V0KDQsIG1ldGFkYXRhT2Zmc2V0LCAwKTsKICAgIH0pCiAgKTsKICBjb25zdCBzaXplID0gYnVpbGRlcjIub2Zmc2V0KCk7CiAgYnVpbGRlcjIuYWRkSW50MzIoMCk7CiAgYnVpbGRlcjIuYWRkSW50MzIoLTEpOwogIGJ1aWxkZXIyLmZsdXNoKCk7CiAgYnVpbGRlcjIuc2luay53cml0ZShuZXcgVWludDhBcnJheShJbnQzMkFycmF5Lm9mKHNpemUpLmJ1ZmZlcikpOwogIGJ1aWxkZXIyLnNpbmsud3JpdGUoTUFHSUMpOwp9CmZ1bmN0aW9uIGVuY29kZUJsb2NrKGJ1aWxkZXIyLCB7IG9mZnNldCwgbWV0YWRhdGFMZW5ndGgsIGJvZHlMZW5ndGggfSkgewogIGJ1aWxkZXIyLndyaXRlSW50NjQoYm9keUxlbmd0aCk7CiAgYnVpbGRlcjIud3JpdGVJbnQzMigwKTsKICBidWlsZGVyMi53cml0ZUludDMyKG1ldGFkYXRhTGVuZ3RoKTsKICBidWlsZGVyMi53cml0ZUludDY0KG9mZnNldCk7CiAgcmV0dXJuIGJ1aWxkZXIyLm9mZnNldCgpOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2VuY29kZS9tZXNzYWdlLmpzCmZ1bmN0aW9uIHdyaXRlTWVzc2FnZShidWlsZGVyMiwgaGVhZGVyVHlwZSwgaGVhZGVyT2Zmc2V0LCBib2R5TGVuZ3RoLCBibG9ja3MpIHsKICBidWlsZGVyMi5maW5pc2goCiAgICBidWlsZGVyMi5hZGRPYmplY3QoNSwgKGIpID0+IHsKICAgICAgYi5hZGRJbnQxNigwLCBWZXJzaW9uLlY1LCBWZXJzaW9uLlYxKTsKICAgICAgYi5hZGRJbnQ4KDEsIGhlYWRlclR5cGUsIE1lc3NhZ2VIZWFkZXIuTk9ORSk7CiAgICAgIGIuYWRkT2Zmc2V0KDIsIGhlYWRlck9mZnNldCwgMCk7CiAgICAgIGIuYWRkSW50NjQoMywgYm9keUxlbmd0aCwgMCk7CiAgICB9KQogICk7CiAgY29uc3QgcHJlZml4U2l6ZSA9IDg7CiAgY29uc3QgbWVzc2FnZVNpemUgPSBidWlsZGVyMi5vZmZzZXQoKTsKICBjb25zdCBhbGlnbmVkU2l6ZSA9IG1lc3NhZ2VTaXplICsgcHJlZml4U2l6ZSArIDcgJiB+NzsKICBibG9ja3M/LnB1c2goewogICAgb2Zmc2V0OiBidWlsZGVyMi5vdXRwdXRCeXRlcywKICAgIG1ldGFkYXRhTGVuZ3RoOiBhbGlnbmVkU2l6ZSwKICAgIGJvZHlMZW5ndGgKICB9KTsKICBidWlsZGVyMi5hZGRJbnQzMihhbGlnbmVkU2l6ZSAtIHByZWZpeFNpemUpOwogIGJ1aWxkZXIyLmFkZEludDMyKC0xKTsKICBidWlsZGVyMi5mbHVzaCgpOwogIGJ1aWxkZXIyLmFkZFBhZGRpbmcoYWxpZ25lZFNpemUgLSBtZXNzYWdlU2l6ZSAtIHByZWZpeFNpemUpOwp9CgovLyBub2RlX21vZHVsZXMvQHV3ZGF0YS9mbGVjaGV0dGUvc3JjL2VuY29kZS9zaW5rLmpzCnZhciBTaW5rID0gY2xhc3MgewogIC8qKgogICAqIFdyaXRlIGJ5dGVzIHRvIHRoaXMgc2luay4KICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGJ5dGVzIFRoZSBieXRlIGJ1ZmZlciB0byB3cml0ZS4KICAgKi8KICB3cml0ZShieXRlcykgewogIH0KICAvKioKICAgKiBXcml0ZSBwYWRkaW5nIGJ5dGVzICh6ZXJvZXMpIHRvIHRoaXMgc2luay4KICAgKiBAcGFyYW0ge251bWJlcn0gYnl0ZUNvdW50IFRoZSBudW1iZXIgb2YgcGFkZGluZyBieXRlcy4KICAgKi8KICBwYWQoYnl0ZUNvdW50KSB7CiAgICB0aGlzLndyaXRlKG5ldyBVaW50OEFycmF5KGJ5dGVDb3VudCkpOwogIH0KICAvKioKICAgKiBAcmV0dXJucyB7VWludDhBcnJheSB8IG51bGx9CiAgICovCiAgZmluaXNoKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQp9Owp2YXIgTWVtb3J5U2luayA9IGNsYXNzIGV4dGVuZHMgU2luayB7CiAgLyoqCiAgICogQSBzaW5rIHRoYXQgY29sbGVjdHMgYnl0ZXMgaW4gbWVtb3J5LgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKTsKICAgIHRoaXMuYnVmZmVycyA9IFtdOwogIH0KICAvKioKICAgKiBXcml0ZSBieXRlcwogICAqIEBwYXJhbSB7VWludDhBcnJheX0gYnl0ZXMKICAgKi8KICB3cml0ZShieXRlcykgewogICAgdGhpcy5idWZmZXJzLnB1c2goYnl0ZXMpOwogIH0KICAvKioKICAgKiBAcmV0dXJucyB7VWludDhBcnJheX0KICAgKi8KICBmaW5pc2goKSB7CiAgICBjb25zdCBidWZzID0gdGhpcy5idWZmZXJzOwogICAgY29uc3Qgc2l6ZSA9IGJ1ZnMucmVkdWNlKChzdW0sIGIpID0+IHN1bSArIGIuYnl0ZUxlbmd0aCwgMCk7CiAgICBjb25zdCBidWYyID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICBmb3IgKGxldCBpID0gMCwgb2ZmID0gMDsgaSA8IGJ1ZnMubGVuZ3RoOyArK2kpIHsKICAgICAgYnVmMi5zZXQoYnVmc1tpXSwgb2ZmKTsKICAgICAgb2ZmICs9IGJ1ZnNbaV0uYnl0ZUxlbmd0aDsKICAgIH0KICAgIHJldHVybiBidWYyOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy9AdXdkYXRhL2ZsZWNoZXR0ZS9zcmMvZW5jb2RlL2VuY29kZS1pcGMuanMKdmFyIFNUUkVBTSA9ICJzdHJlYW0iOwp2YXIgRklMRSA9ICJmaWxlIjsKZnVuY3Rpb24gZW5jb2RlSVBDKGRhdGEsIHsgc2luaywgZm9ybWF0OiBmb3JtYXQyID0gU1RSRUFNIH0gPSB7fSkgewogIGlmIChmb3JtYXQyICE9PSBTVFJFQU0gJiYgZm9ybWF0MiAhPT0gRklMRSkgewogICAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgQXJyb3cgSVBDIGZvcm1hdDogJHtmb3JtYXQyfWApOwogIH0KICBjb25zdCB7IHNjaGVtYSwgZGljdGlvbmFyaWVzID0gW10sIHJlY29yZHMgPSBbXSwgbWV0YWRhdGEgfSA9IGRhdGE7CiAgY29uc3QgYnVpbGRlcjIgPSBuZXcgQnVpbGRlcihzaW5rIHx8IG5ldyBNZW1vcnlTaW5rKCkpOwogIGNvbnN0IGZpbGUgPSBmb3JtYXQyID09PSBGSUxFOwogIGNvbnN0IGRpY3RCbG9ja3MgPSBbXTsKICBjb25zdCByZWNvcmRCbG9ja3MgPSBbXTsKICBpZiAoZmlsZSkgewogICAgYnVpbGRlcjIuYWRkQnVmZmVyKE1BR0lDKTsKICB9CiAgaWYgKHNjaGVtYSkgewogICAgd3JpdGVNZXNzYWdlKAogICAgICBidWlsZGVyMiwKICAgICAgTWVzc2FnZUhlYWRlci5TY2hlbWEsCiAgICAgIGVuY29kZVNjaGVtYShidWlsZGVyMiwgc2NoZW1hKSwKICAgICAgMAogICAgKTsKICB9CiAgZm9yIChjb25zdCBkaWN0IG9mIGRpY3Rpb25hcmllcykgewogICAgY29uc3QgeyBkYXRhOiBkYXRhMiB9ID0gZGljdDsKICAgIHdyaXRlTWVzc2FnZSgKICAgICAgYnVpbGRlcjIsCiAgICAgIE1lc3NhZ2VIZWFkZXIuRGljdGlvbmFyeUJhdGNoLAogICAgICBlbmNvZGVEaWN0aW9uYXJ5QmF0Y2goYnVpbGRlcjIsIGRpY3QpLAogICAgICBkYXRhMi5ieXRlTGVuZ3RoLAogICAgICBkaWN0QmxvY2tzCiAgICApOwogICAgd3JpdGVCdWZmZXJzKGJ1aWxkZXIyLCBkYXRhMi5idWZmZXJzKTsKICB9CiAgZm9yIChjb25zdCBiYXRjaCBvZiByZWNvcmRzKSB7CiAgICB3cml0ZU1lc3NhZ2UoCiAgICAgIGJ1aWxkZXIyLAogICAgICBNZXNzYWdlSGVhZGVyLlJlY29yZEJhdGNoLAogICAgICBlbmNvZGVSZWNvcmRCYXRjaChidWlsZGVyMiwgYmF0Y2gpLAogICAgICBiYXRjaC5ieXRlTGVuZ3RoLAogICAgICByZWNvcmRCbG9ja3MKICAgICk7CiAgICB3cml0ZUJ1ZmZlcnMoYnVpbGRlcjIsIGJhdGNoLmJ1ZmZlcnMpOwogIH0KICBidWlsZGVyMi5hZGRCdWZmZXIoRU9TKTsKICBpZiAoZmlsZSkgewogICAgd3JpdGVGb290ZXIoYnVpbGRlcjIsIHNjaGVtYSwgZGljdEJsb2NrcywgcmVjb3JkQmxvY2tzLCBtZXRhZGF0YSk7CiAgfQogIHJldHVybiBidWlsZGVyMi5zaW5rOwp9CmZ1bmN0aW9uIHdyaXRlQnVmZmVycyhidWlsZGVyMiwgYnVmZmVycykgewogIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7ICsraSkgewogICAgYnVpbGRlcjIuYWRkQnVmZmVyKGJ1ZmZlcnNbaV0pOwogIH0KfQoKLy8gbm9kZV9tb2R1bGVzL0B1d2RhdGEvZmxlY2hldHRlL3NyYy9lbmNvZGUvdGFibGUtdG8taXBjLmpzCmZ1bmN0aW9uIHRhYmxlVG9JUEModGFibGUsIG9wdGlvbnMpIHsKICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciKSB7CiAgICBvcHRpb25zID0geyBmb3JtYXQ6IG9wdGlvbnMgfTsKICB9CiAgY29uc3QgY29sdW1ucyA9IHRhYmxlLmNoaWxkcmVuOwogIGNoZWNrQmF0Y2hMZW5ndGhzKGNvbHVtbnMpOwogIGNvbnN0IHsgZGljdGlvbmFyaWVzLCBpZE1hcCB9ID0gYXNzZW1ibGVEaWN0aW9uYXJ5QmF0Y2hlcyhjb2x1bW5zKTsKICBjb25zdCByZWNvcmRzID0gYXNzZW1ibGVSZWNvcmRCYXRjaGVzKGNvbHVtbnMpOwogIGNvbnN0IHNjaGVtYSA9IGFzc2VtYmxlU2NoZW1hKHRhYmxlLnNjaGVtYSwgaWRNYXApOwogIGNvbnN0IGRhdGEgPSB7IHNjaGVtYSwgZGljdGlvbmFyaWVzLCByZWNvcmRzIH07CiAgcmV0dXJuIGVuY29kZUlQQyhkYXRhLCBvcHRpb25zKS5maW5pc2goKTsKfQpmdW5jdGlvbiBjaGVja0JhdGNoTGVuZ3Rocyhjb2x1bW5zKSB7CiAgY29uc3QgbiA9IGNvbHVtbnNbMF0/LmRhdGEubWFwKChkKSA9PiBkLmxlbmd0aCk7CiAgY29sdW1ucy5mb3JFYWNoKCh7IGRhdGEgfSkgPT4gewogICAgaWYgKGRhdGEubGVuZ3RoICE9PSBuLmxlbmd0aCB8fCBkYXRhLnNvbWUoKGIsIGkpID0+IGIubGVuZ3RoICE9PSBuW2ldKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbHVtbnMgaGF2ZSBpbmNvbnNpc3RlbnQgYmF0Y2ggc2l6ZXMuIik7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gYXNzZW1ibGVDb250ZXh0KCkgewogIGxldCBieXRlTGVuZ3RoID0gMDsKICBjb25zdCBub2RlcyA9IFtdOwogIGNvbnN0IHJlZ2lvbnMgPSBbXTsKICBjb25zdCBidWZmZXJzID0gW107CiAgY29uc3QgdmFyaWFkaWMgPSBbXTsKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbnVsbENvdW50CiAgICAgKi8KICAgIG5vZGUobGVuZ3RoLCBudWxsQ291bnQpIHsKICAgICAgbm9kZXMucHVzaCh7IGxlbmd0aCwgbnVsbENvdW50IH0pOwogICAgfSwKICAgIC8qKgogICAgICogQHBhcmFtIHtpbXBvcnQoJy4uL3R5cGVzLmpzJykuVHlwZWRBcnJheX0gYgogICAgICovCiAgICBidWZmZXIoYikgewogICAgICBjb25zdCBzaXplID0gYi5ieXRlTGVuZ3RoOwogICAgICBjb25zdCBsZW5ndGggPSBzaXplICsgNyAmIH43OwogICAgICByZWdpb25zLnB1c2goeyBvZmZzZXQ6IGJ5dGVMZW5ndGgsIGxlbmd0aCB9KTsKICAgICAgYnl0ZUxlbmd0aCArPSBsZW5ndGg7CiAgICAgIGJ1ZmZlcnMucHVzaChuZXcgVWludDhBcnJheShiLmJ1ZmZlciwgYi5ieXRlT2Zmc2V0LCBzaXplKSk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoCiAgICAgKi8KICAgIHZhcmlhZGljKGxlbmd0aCkgewogICAgICB2YXJpYWRpYy5wdXNoKGxlbmd0aCk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAcGFyYW0ge2ltcG9ydCgnLi4vdHlwZXMuanMnKS5EYXRhVHlwZX0gdHlwZQogICAgICogQHBhcmFtIHtpbXBvcnQoJy4uL2JhdGNoLmpzJykuQmF0Y2h9IGJhdGNoCiAgICAgKi8KICAgIGNoaWxkcmVuKHR5cGUsIGJhdGNoKSB7CiAgICAgIHR5cGUuY2hpbGRyZW4uZm9yRWFjaCgoZmllbGQyLCBpbmRleCkgPT4gewogICAgICAgIHZpc2l0MihmaWVsZDIudHlwZSwgYmF0Y2guY2hpbGRyZW5baW5kZXhdLCB0aGlzKTsKICAgICAgfSk7CiAgICB9LAogICAgLyoqCiAgICAgKiBAcmV0dXJucyB7aW1wb3J0KCcuLi90eXBlcy5qcycpLlJlY29yZEJhdGNofQogICAgICovCiAgICBkb25lKCkgewogICAgICByZXR1cm4geyBieXRlTGVuZ3RoLCBub2RlcywgcmVnaW9ucywgdmFyaWFkaWMsIGJ1ZmZlcnMgfTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGFzc2VtYmxlRGljdGlvbmFyeUJhdGNoZXMoY29sdW1ucykgewogIGNvbnN0IGRpY3Rpb25hcmllcyA9IFtdOwogIGNvbnN0IGRpY3RNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IGlkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBsZXQgaWQgPSAtMTsKICBjb25zdCB2aXNpdG9yID0gKGRpY3Rpb25hcnlDb2x1bW4pID0+IHsKICAgIGlmICghZGljdE1hcC5oYXMoZGljdGlvbmFyeUNvbHVtbikpIHsKICAgICAgZGljdE1hcC5zZXQoZGljdGlvbmFyeUNvbHVtbiwgKytpZCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGljdGlvbmFyeUNvbHVtbi5kYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgZGljdGlvbmFyaWVzLnB1c2goewogICAgICAgICAgaWQsCiAgICAgICAgICBpc0RlbHRhOiBpID4gMCwKICAgICAgICAgIGRhdGE6IGFzc2VtYmxlUmVjb3JkQmF0Y2goW2RpY3Rpb25hcnlDb2x1bW5dLCBpKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlkTWFwLnNldChkaWN0aW9uYXJ5Q29sdW1uLnR5cGUsIGlkKTsKICAgIH0gZWxzZSB7CiAgICAgIGlkTWFwLnNldChkaWN0aW9uYXJ5Q29sdW1uLnR5cGUsIGRpY3RNYXAuZ2V0KGRpY3Rpb25hcnlDb2x1bW4pKTsKICAgIH0KICB9OwogIGNvbHVtbnMuZm9yRWFjaCgoY29sKSA9PiB2aXNpdERpY3Rpb25hcmllcyhjb2wuZGF0YVswXSwgdmlzaXRvcikpOwogIHJldHVybiB7IGRpY3Rpb25hcmllcywgaWRNYXAgfTsKfQpmdW5jdGlvbiB2aXNpdERpY3Rpb25hcmllcyhiYXRjaCwgdmlzaXRvcikgewogIGlmIChiYXRjaD8udHlwZS50eXBlSWQgPT09IFR5cGUuRGljdGlvbmFyeSkgewogICAgY29uc3QgZGljdGlvbmFyeTIgPSBiYXRjaC5kaWN0aW9uYXJ5OwogICAgdmlzaXRvcihkaWN0aW9uYXJ5Mik7CiAgICB2aXNpdERpY3Rpb25hcmllcyhkaWN0aW9uYXJ5Mi5kYXRhWzBdLCB2aXNpdG9yKTsKICB9CiAgYmF0Y2g/LmNoaWxkcmVuPy5mb3JFYWNoKChjaGlsZCkgPT4gdmlzaXREaWN0aW9uYXJpZXMoY2hpbGQsIHZpc2l0b3IpKTsKfQpmdW5jdGlvbiBhc3NlbWJsZVNjaGVtYShzY2hlbWEsIGlkTWFwKSB7CiAgaWYgKCFpZE1hcC5zaXplKSByZXR1cm4gc2NoZW1hOwogIGNvbnN0IHZpc2l0MyA9ICh0eXBlKSA9PiB7CiAgICBpZiAodHlwZS50eXBlSWQgPT09IFR5cGUuRGljdGlvbmFyeSkgewogICAgICB0eXBlLmlkID0gaWRNYXAuZ2V0KHR5cGUuZGljdGlvbmFyeSk7CiAgICAgIHZpc2l0RGljdFR5cGUodHlwZSk7CiAgICB9CiAgICBpZiAodHlwZS5jaGlsZHJlbikgewogICAgICAodHlwZS5jaGlsZHJlbiA9IHR5cGUuY2hpbGRyZW4uc2xpY2UoKSkuZm9yRWFjaCh2aXNpdEZpZWxkcyk7CiAgICB9CiAgfTsKICBjb25zdCB2aXNpdEZpZWxkcyA9IChmaWVsZDIsIGluZGV4LCBhcnJheTIpID0+IHsKICAgIGNvbnN0IHR5cGUgPSB7IC4uLmZpZWxkMi50eXBlIH07CiAgICBhcnJheTJbaW5kZXhdID0geyAuLi5maWVsZDIsIHR5cGUgfTsKICAgIHZpc2l0Myh0eXBlKTsKICB9OwogIGNvbnN0IHZpc2l0RGljdFR5cGUgPSAocGFyZW50VHlwZSkgPT4gewogICAgY29uc3QgdHlwZSA9IHsgLi4ucGFyZW50VHlwZS5kaWN0aW9uYXJ5IH07CiAgICBwYXJlbnRUeXBlLmRpY3Rpb25hcnkgPSB0eXBlOwogICAgdmlzaXQzKHR5cGUpOwogIH07CiAgc2NoZW1hID0geyAuLi5zY2hlbWEsIGZpZWxkczogc2NoZW1hLmZpZWxkcy5zbGljZSgpIH07CiAgc2NoZW1hLmZpZWxkcy5mb3JFYWNoKHZpc2l0RmllbGRzKTsKICByZXR1cm4gc2NoZW1hOwp9CmZ1bmN0aW9uIGFzc2VtYmxlUmVjb3JkQmF0Y2hlcyhjb2x1bW5zKSB7CiAgcmV0dXJuIChjb2x1bW5zWzBdPy5kYXRhIHx8IFtdKS5tYXAoKF8sIGluZGV4KSA9PiBhc3NlbWJsZVJlY29yZEJhdGNoKGNvbHVtbnMsIGluZGV4KSk7Cn0KZnVuY3Rpb24gYXNzZW1ibGVSZWNvcmRCYXRjaChjb2x1bW5zLCBiYXRjaEluZGV4ID0gMCkgewogIGNvbnN0IGN0eCA9IGFzc2VtYmxlQ29udGV4dCgpOwogIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7CiAgICB2aXNpdDIoY29sdW1uLnR5cGUsIGNvbHVtbi5kYXRhW2JhdGNoSW5kZXhdLCBjdHgpOwogIH0pOwogIHJldHVybiBjdHguZG9uZSgpOwp9CmZ1bmN0aW9uIHZpc2l0Mih0eXBlLCBiYXRjaCwgY3R4KSB7CiAgY29uc3QgeyB0eXBlSWQgfSA9IHR5cGU7CiAgaWYgKHR5cGVJZCA9PT0gVHlwZS5OdWxsKSByZXR1cm47CiAgY3R4Lm5vZGUoYmF0Y2gubGVuZ3RoLCBiYXRjaC5udWxsQ291bnQpOwogIHN3aXRjaCAodHlwZUlkKSB7CiAgICAvLyB2YWxpZGl0eSBhbmQgdmFsdWUgYnVmZmVycwogICAgLy8gYmFja2luZyBkaWN0aW9uYXJpZXMgaGFuZGxlZCBlbHNld2hlcmUKICAgIGNhc2UgVHlwZS5Cb29sOgogICAgY2FzZSBUeXBlLkludDoKICAgIGNhc2UgVHlwZS5UaW1lOgogICAgY2FzZSBUeXBlLkR1cmF0aW9uOgogICAgY2FzZSBUeXBlLkZsb2F0OgogICAgY2FzZSBUeXBlLkRhdGU6CiAgICBjYXNlIFR5cGUuVGltZXN0YW1wOgogICAgY2FzZSBUeXBlLkRlY2ltYWw6CiAgICBjYXNlIFR5cGUuSW50ZXJ2YWw6CiAgICBjYXNlIFR5cGUuRml4ZWRTaXplQmluYXJ5OgogICAgY2FzZSBUeXBlLkRpY3Rpb25hcnk6CiAgICAgIGN0eC5idWZmZXIoYmF0Y2gudmFsaWRpdHkpOwogICAgICBjdHguYnVmZmVyKGJhdGNoLnZhbHVlcyk7CiAgICAgIHJldHVybjsKICAgIC8vIHZhbGlkaXR5LCBvZmZzZXQsIGFuZCB2YWx1ZSBidWZmZXJzCiAgICBjYXNlIFR5cGUuVXRmODoKICAgIGNhc2UgVHlwZS5MYXJnZVV0Zjg6CiAgICBjYXNlIFR5cGUuQmluYXJ5OgogICAgY2FzZSBUeXBlLkxhcmdlQmluYXJ5OgogICAgICBjdHguYnVmZmVyKGJhdGNoLnZhbGlkaXR5KTsKICAgICAgY3R4LmJ1ZmZlcihiYXRjaC5vZmZzZXRzKTsKICAgICAgY3R4LmJ1ZmZlcihiYXRjaC52YWx1ZXMpOwogICAgICByZXR1cm47CiAgICAvLyB2aWV3cyB3aXRoIHZhcmlhZGljIGJ1ZmZlcnMKICAgIGNhc2UgVHlwZS5CaW5hcnlWaWV3OgogICAgY2FzZSBUeXBlLlV0ZjhWaWV3OgogICAgICBjdHguYnVmZmVyKGJhdGNoLnZhbGlkaXR5KTsKICAgICAgY3R4LmJ1ZmZlcihiYXRjaC52YWx1ZXMpOwogICAgICBjdHgudmFyaWFkaWMoYmF0Y2guZGF0YS5sZW5ndGgpOwogICAgICBiYXRjaC5kYXRhLmZvckVhY2goKGIpID0+IGN0eC5idWZmZXIoYikpOwogICAgICByZXR1cm47CiAgICAvLyB2YWxpZGl0eSwgb2Zmc2V0LCBhbmQgbGlzdCBjaGlsZAogICAgY2FzZSBUeXBlLkxpc3Q6CiAgICBjYXNlIFR5cGUuTGFyZ2VMaXN0OgogICAgY2FzZSBUeXBlLk1hcDoKICAgICAgY3R4LmJ1ZmZlcihiYXRjaC52YWxpZGl0eSk7CiAgICAgIGN0eC5idWZmZXIoYmF0Y2gub2Zmc2V0cyk7CiAgICAgIGN0eC5jaGlsZHJlbih0eXBlLCBiYXRjaCk7CiAgICAgIHJldHVybjsKICAgIC8vIHZhbGlkaXR5LCBvZmZzZXQsIHNpemUsIGFuZCBsaXN0IGNoaWxkCiAgICBjYXNlIFR5cGUuTGlzdFZpZXc6CiAgICBjYXNlIFR5cGUuTGFyZ2VMaXN0VmlldzoKICAgICAgY3R4LmJ1ZmZlcihiYXRjaC52YWxpZGl0eSk7CiAgICAgIGN0eC5idWZmZXIoYmF0Y2gub2Zmc2V0cyk7CiAgICAgIGN0eC5idWZmZXIoYmF0Y2guc2l6ZXMpOwogICAgICBjdHguY2hpbGRyZW4odHlwZSwgYmF0Y2gpOwogICAgICByZXR1cm47CiAgICAvLyB2YWxpZGl0eSBhbmQgY2hpbGRyZW4KICAgIGNhc2UgVHlwZS5GaXhlZFNpemVMaXN0OgogICAgY2FzZSBUeXBlLlN0cnVjdDoKICAgICAgY3R4LmJ1ZmZlcihiYXRjaC52YWxpZGl0eSk7CiAgICAgIGN0eC5jaGlsZHJlbih0eXBlLCBiYXRjaCk7CiAgICAgIHJldHVybjsKICAgIC8vIGNoaWxkcmVuIG9ubHkKICAgIGNhc2UgVHlwZS5SdW5FbmRFbmNvZGVkOgogICAgICBjdHguY2hpbGRyZW4odHlwZSwgYmF0Y2gpOwogICAgICByZXR1cm47CiAgICAvLyB1bmlvbgogICAgY2FzZSBUeXBlLlVuaW9uOiB7CiAgICAgIGN0eC5idWZmZXIoYmF0Y2gudHlwZUlkcyk7CiAgICAgIGlmICh0eXBlLm1vZGUgPT09IFVuaW9uTW9kZS5EZW5zZSkgewogICAgICAgIGN0eC5idWZmZXIoYmF0Y2gub2Zmc2V0cyk7CiAgICAgIH0KICAgICAgY3R4LmNoaWxkcmVuKHR5cGUsIGJhdGNoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgLy8gdW5zdXBwb3J0ZWQgdHlwZQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKGludmFsaWREYXRhVHlwZSh0eXBlSWQpKTsKICB9Cn0KCi8vIHNyYy91dGlscy5qcwp2YXIgY2FtZWxUb1NuYWtlUmVnZXggPSAvW1x3XShbQS1aXSkvZzsKZnVuY3Rpb24gY2FtZWxUb1NuYWtlKHN0cmluZykgewogIHJldHVybiBzdHJpbmcucmVwbGFjZShjYW1lbFRvU25ha2VSZWdleCwgKG0pID0+IGAke21bMF19XyR7bVsxXX1gKS50b0xvd2VyQ2FzZSgpOwp9CnZhciBzbmFrZVRvQ2FtZWxSZWdleCA9IC9bLV9dW2Etel0vZzsKZnVuY3Rpb24gc25ha2VUb0NhbWVsKHN0cmluZykgewogIHJldHVybiBzdHJpbmcudG9Mb3dlckNhc2UoKS5yZXBsYWNlKHNuYWtlVG9DYW1lbFJlZ2V4LCAoZ3JvdXApID0+IGdyb3VwLnNsaWNlKC0xKS50b1VwcGVyQ2FzZSgpKTsKfQpmdW5jdGlvbiB0b0NhcGl0YWxDYXNlKHN0cmluZykgewogIGlmIChzdHJpbmcubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gc3RyaW5nOwogIH0KICByZXR1cm4gc3RyaW5nLmF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc2xpY2UoMSk7Cn0KdmFyIHRpdGxlQ2FzZVJlZ2V4ID0gL1tcc19dLzsKZnVuY3Rpb24gdG9UaXRsZUNhc2Uoc3RyaW5nKSB7CiAgcmV0dXJuIHN0cmluZy5zcGxpdCh0aXRsZUNhc2VSZWdleCkubWFwKChzKSA9PiB0b0NhcGl0YWxDYXNlKHMpKS5qb2luKCIgIikuc3BsaXQoIi0iKS5tYXAoKHMpID0+IHRvQ2FwaXRhbENhc2UocykpLmpvaW4oIi0iKTsKfQpmdW5jdGlvbiB0b0h0bWxDbGFzcyhzdHJpbmcpIHsKICByZXR1cm4gc3RyaW5nLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXlteYS16XSovZywgIiIpLnJlcGxhY2UoL1xzL2csICItIikucmVwbGFjZSgvW15hLXowLTlfLV0vZywgIiIpOwp9CmZ1bmN0aW9uIGRvd25sb2FkQmxvYihibG9iLCBuYW1lKSB7CiAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICBsaW5rLmhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogIGxpbmsuZG93bmxvYWQgPSBuYW1lIHx8ICJqc2NhdHRlci5wbmciOwogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGluayk7CiAgbGluay5kaXNwYXRjaEV2ZW50KAogICAgbmV3IE1vdXNlRXZlbnQoImNsaWNrIiwgewogICAgICBidWJibGVzOiB0cnVlLAogICAgICBjYW5jZWxhYmxlOiB0cnVlLAogICAgICB2aWV3OiB3aW5kb3cKICAgIH0pCiAgKTsKICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmspOwp9CmZ1bmN0aW9uIGdldFNjYWxlKHNjYWxlVHlwZSkgewogIGlmIChzY2FsZVR5cGUuc3RhcnRzV2l0aCgibG9nIikpIHsKICAgIHJldHVybiBsb2coKS5iYXNlKHNjYWxlVHlwZS5zcGxpdCgiXyIpWzFdIHx8IDEwKTsKICB9CiAgaWYgKHNjYWxlVHlwZS5zdGFydHNXaXRoKCJwb3ciKSkgewogICAgcmV0dXJuIHBvdygpLmV4cG9uZW50KHNjYWxlVHlwZS5zcGxpdCgiXyIpWzFdIHx8IDIpOwogIH0KICBpZiAoc2NhbGVUeXBlID09PSAidGltZSIpIHsKICAgIHJldHVybiB0aW1lKCk7CiAgfQogIGlmIChzY2FsZVR5cGUgPT09ICJsaW5lYXIiKSB7CiAgICByZXR1cm4gbGluZWFyMygpOwogIH0KICByZXR1cm4gb3JkaW5hbCgpOwp9CmZ1bmN0aW9uIGludmVydE9ialRvTWFwKG9iaikgewogIHJldHVybiBPYmplY3Qua2V5cyhvYmopLnJlZHVjZSgoaW52ZXJ0ZWRNYXAsIGtleSkgPT4gewogICAgaW52ZXJ0ZWRNYXAuc2V0KG9ialtrZXldLCBrZXkpOwogICAgcmV0dXJuIGludmVydGVkTWFwOwogIH0sIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwp9CmZ1bmN0aW9uIGNyZWF0ZU9yZGluYWxTY2FsZUludmVydGVyKGRvbWFpbikgewogIGNvbnN0IGludmVydGVkRG9tYWluTWFwID0gaW52ZXJ0T2JqVG9NYXAoZG9tYWluKTsKICByZXR1cm4gKHZhbHVlKSA9PiBpbnZlcnRlZERvbWFpbk1hcC5nZXQodmFsdWUpOwp9CmZ1bmN0aW9uIGdldFRvb2x0aXBGb250U2l6ZShzaXplKSB7CiAgaWYgKHNpemUgPT09ICJsYXJnZSIpIHsKICAgIHJldHVybiAiMXJlbSI7CiAgfQogIGlmIChzaXplID09PSAibWVkaXVtIikgewogICAgcmV0dXJuICIwLjg1cmVtIjsKICB9CiAgcmV0dXJuICIwLjY3NXJlbSI7Cn0KZnVuY3Rpb24gY3JlYXRlTnVtZXJpY2FsQmluR2V0dGVyKGhpc3RvZ3JhbSwgZG9tYWluKSB7CiAgY29uc3QgbWF4QmluSWQgPSBoaXN0b2dyYW0ubGVuZ3RoIC0gMTsKICBjb25zdCBtaW4zID0gZG9tYWluWzBdOwogIGNvbnN0IGV4dGVudCA9IGRvbWFpblsxXSAtIGRvbWFpblswXTsKICByZXR1cm4gKHZhbHVlKSA9PiBNYXRoLnJvdW5kKCh2YWx1ZSAtIG1pbjMpIC8gZXh0ZW50ICogbWF4QmluSWQpOwp9CmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoQ2xhc3ModGFnTmFtZSwgY2xhc3NOYW1lKSB7CiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgaWYgKGNsYXNzTmFtZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoY2xhc3NOYW1lKSkgewogICAgICBmb3IgKGNvbnN0IG5hbWUgb2YgY2xhc3NOYW1lKSB7CiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKG5hbWUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKICAgIH0KICB9CiAgcmV0dXJuIGVsZW1lbnQ7Cn0KZnVuY3Rpb24gcmVtVG9QeChyZW0pIHsKICByZXR1cm4gcmVtICogTnVtYmVyLnBhcnNlRmxvYXQoZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpLmZvbnRTaXplKTsKfQp2YXIgZm9ybWF0TWlsbGlzZWNvbmQgPSB1dGNGb3JtYXQoIiVhLCAlYiAlZSwgJVkgJUg6JU06JVMuJUwiKTsKdmFyIGZvcm1hdFNlY29uZCA9IHV0Y0Zvcm1hdCgiJWEsICViICVlLCAlWSAlSDolTTolUyIpOwp2YXIgZm9ybWF0TWludXRlID0gdXRjRm9ybWF0KCIlYSwgJWIgJWUsICVZICVIOiVNIik7CnZhciBmb3JtYXRIb3VyID0gdXRjRm9ybWF0KCIlYSwgJWIgJWUsICVZICVIIik7CnZhciBmb3JtYXREYXkgPSB1dGNGb3JtYXQoIiVhLCAlYiAlZSwgJVkiKTsKdmFyIGZvcm1hdFdlZWsgPSB1dGNGb3JtYXQoIiViICVlLCAlWSIpOwp2YXIgZm9ybWF0TW9udGggPSB1dGNGb3JtYXQoIiViICVZIik7CnZhciBmb3JtYXRZZWFyMiA9IHV0Y0Zvcm1hdCgiJVkiKTsKdmFyIFNFQ19NU0VDID0gMWUzOwp2YXIgTUlOX01TRUMgPSA2MCAqIFNFQ19NU0VDOwp2YXIgSE9VUl9NU0VDID0gNjAgKiBNSU5fTVNFQzsKdmFyIERBWV9NU0VDID0gMjQgKiBIT1VSX01TRUM7CnZhciBXRUVLX01TRUMgPSA3ICogREFZX01TRUM7CnZhciBNT05USF9NU0VDID0gNCAqIFdFRUtfTVNFQzsKdmFyIFlFQVJfTVNFQyA9IDM2NSAqIERBWV9NU0VDOwpmdW5jdGlvbiBtZWRpYW5UaW1lSW50ZXJ2YWwocG9pbnRzLCBhY2Nlc3NvcikgewogIGNvbnN0IHZhbHVlcyA9IFtdOwogIGZvciAoY29uc3QgcG9pbnQgb2YgcG9pbnRzKSB7CiAgICB2YWx1ZXMucHVzaChhY2Nlc3Nvcihwb2ludCkpOwogIH0KICB2YWx1ZXMuc29ydCgpOwogIGNvbnN0IGludGVydmFscyA9IFtdOwogIGZvciAobGV0IGkgPSAxOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBpbnRlcnZhbDIgPSB2YWx1ZXNbaV0gLSB2YWx1ZXNbaSAtIDFdOwogICAgaWYgKGludGVydmFsMiA+IDApIHsKICAgICAgaW50ZXJ2YWxzLnB1c2goaW50ZXJ2YWwyKTsKICAgIH0KICB9CiAgaW50ZXJ2YWxzLnNvcnQoKTsKICByZXR1cm4gaW50ZXJ2YWxzW01hdGguZmxvb3IoaW50ZXJ2YWxzLmxlbmd0aCAvIDIpXTsKfQpmdW5jdGlvbiBjcmVhdGVUaW1lRm9ybWF0KHBvaW50cywgYWNjZXNzb3IpIHsKICBjb25zdCBtZWRpYW5JbnRlcnZhbCA9IG1lZGlhblRpbWVJbnRlcnZhbChwb2ludHMsIGFjY2Vzc29yKTsKICBpZiAobWVkaWFuSW50ZXJ2YWwgPiBZRUFSX01TRUMpIHsKICAgIHJldHVybiBmb3JtYXRZZWFyMjsKICB9CiAgaWYgKG1lZGlhbkludGVydmFsID4gTU9OVEhfTVNFQykgewogICAgcmV0dXJuIGZvcm1hdE1vbnRoOwogIH0KICBpZiAobWVkaWFuSW50ZXJ2YWwgPiBXRUVLX01TRUMpIHsKICAgIHJldHVybiBmb3JtYXRXZWVrOwogIH0KICBpZiAobWVkaWFuSW50ZXJ2YWwgPiBEQVlfTVNFQykgewogICAgcmV0dXJuIGZvcm1hdERheTsKICB9CiAgaWYgKG1lZGlhbkludGVydmFsID4gSE9VUl9NU0VDKSB7CiAgICByZXR1cm4gZm9ybWF0SG91cjsKICB9CiAgaWYgKG1lZGlhbkludGVydmFsID4gTUlOX01TRUMpIHsKICAgIHJldHVybiBmb3JtYXRNaW51dGU7CiAgfQogIGlmIChtZWRpYW5JbnRlcnZhbCA+IFNFQ19NU0VDKSB7CiAgICByZXR1cm4gZm9ybWF0U2Vjb25kOwogIH0KICByZXR1cm4gZm9ybWF0TWlsbGlzZWNvbmQ7Cn0KdmFyIHRvUmdiYUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKZnVuY3Rpb24gdG9SZ2JhMihjb2xvcjIpIHsKICBpZiAoQXJyYXkuaXNBcnJheSkgewogICAgaWYgKGNvbG9yMi5sZW5ndGggPj0gNCkgewogICAgICByZXR1cm4gY29sb3IyLm1hcCgoYykgPT4gYyAqIDI1NSk7CiAgICB9CiAgICBpZiAoY29sb3IyLmxlbmd0aCA9PT0gMykgewogICAgICByZXR1cm4gWy4uLmNvbG9yMi5tYXAoKGMpID0+IGMgKiAyNTUpLCAyNTVdOwogICAgfQogICAgcmV0dXJuIFswLCAwLCAwLCAwXTsKICB9CiAgdG9SZ2JhRWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjI7CiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0b1JnYmFFbGVtZW50KTsKICBjb25zdCByZ2JhMiA9IGdldENvbXB1dGVkU3R5bGUodG9SZ2JhRWxlbWVudClbImJhY2tncm91bmQtY29sb3IiXTsKICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRvUmdiYUVsZW1lbnQpOwogIHJldHVybiByZ2JhMi5zbGljZShyZ2JhMi5pbmRleE9mKCIoIikgKyAxLCByZ2JhMi5pbmRleE9mKCIpIikpLnNwbGl0KCIsIikubWFwKE51bWJlcik7Cn0KZnVuY3Rpb24gYmxlbmQoaW1hZ2VEYXRhQmFjaywgaW1hZ2VEYXRhRnJvbnQpIHsKICBpZiAoaW1hZ2VEYXRhQmFjay53aWR0aCAhPT0gaW1hZ2VEYXRhRnJvbnQud2lkdGggfHwgaW1hZ2VEYXRhQmFjay5oZWlnaHQgIT09IGltYWdlRGF0YUZyb250LmhlaWdodCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJJbWFnZSBkaW1lbnNpb25zIG11c3QgbWF0Y2ggZm9yIGJsZW5kaW5nIik7CiAgfQogIGNvbnN0IHdpZHRoID0gaW1hZ2VEYXRhQmFjay53aWR0aDsKICBjb25zdCBoZWlnaHQgPSBpbWFnZURhdGFCYWNrLmhlaWdodDsKICBjb25zdCBuZXdEYXRhID0gbmV3IFVpbnQ4Q2xhbXBlZEFycmF5KHdpZHRoICogaGVpZ2h0ICogNCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbWFnZURhdGFCYWNrLmRhdGEubGVuZ3RoOyBpICs9IDQpIHsKICAgIGNvbnN0IGJnUiA9IGltYWdlRGF0YUJhY2suZGF0YVtpXTsKICAgIGNvbnN0IGJnRyA9IGltYWdlRGF0YUJhY2suZGF0YVtpICsgMV07CiAgICBjb25zdCBiZ0IgPSBpbWFnZURhdGFCYWNrLmRhdGFbaSArIDJdOwogICAgY29uc3QgYmdBID0gaW1hZ2VEYXRhQmFjay5kYXRhW2kgKyAzXSAvIDI1NTsKICAgIGNvbnN0IGZnUiA9IGltYWdlRGF0YUZyb250LmRhdGFbaV07CiAgICBjb25zdCBmZ0cgPSBpbWFnZURhdGFGcm9udC5kYXRhW2kgKyAxXTsKICAgIGNvbnN0IGZnQiA9IGltYWdlRGF0YUZyb250LmRhdGFbaSArIDJdOwogICAgY29uc3QgZmdBID0gaW1hZ2VEYXRhRnJvbnQuZGF0YVtpICsgM10gLyAyNTU7CiAgICBjb25zdCBvdXRBID0gZmdBICsgYmdBICogKDEgLSBmZ0EpOwogICAgbmV3RGF0YVtpXSA9IE1hdGgucm91bmQoKGZnUiAqIGZnQSArIGJnUiAqIGJnQSAqICgxIC0gZmdBKSkgLyBvdXRBKTsKICAgIG5ld0RhdGFbaSArIDFdID0gTWF0aC5yb3VuZCgoZmdHICogZmdBICsgYmdHICogYmdBICogKDEgLSBmZ0EpKSAvIG91dEEpOwogICAgbmV3RGF0YVtpICsgMl0gPSBNYXRoLnJvdW5kKChmZ0IgKiBmZ0EgKyBiZ0IgKiBiZ0EgKiAoMSAtIGZnQSkpIC8gb3V0QSk7CiAgICBuZXdEYXRhW2kgKyAzXSA9IE1hdGgucm91bmQob3V0QSAqIDI1NSk7CiAgfQogIHJldHVybiBuZXcgSW1hZ2VEYXRhKG5ld0RhdGEsIHdpZHRoLCBoZWlnaHQpOwp9CmZ1bmN0aW9uIGFkZEJhY2tncm91bmRDb2xvcihpbWFnZURhdGEsIGJhY2tncm91bmRDb2xvcikgewogIGNvbnN0IG5ld0RhdGEgPSBuZXcgVWludDhDbGFtcGVkQXJyYXkoaW1hZ2VEYXRhLndpZHRoICogaW1hZ2VEYXRhLmhlaWdodCAqIDQpOwogIGNvbnN0IGJnID0gdG9SZ2JhMihiYWNrZ3JvdW5kQ29sb3IpOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbmV3RGF0YS5sZW5ndGg7IGkgKz0gNCkgewogICAgY29uc3QgYmdBbHBoYSA9IDEgLSBpbWFnZURhdGEuZGF0YVtpICsgM10gLyAyNTU7CiAgICBjb25zdCBmZ0FscGhhID0gaW1hZ2VEYXRhLmRhdGFbaSArIDNdIC8gMjU1OwogICAgbmV3RGF0YVtpXSA9IGJnWzBdICogYmdBbHBoYSArIGltYWdlRGF0YS5kYXRhW2ldICogZmdBbHBoYTsKICAgIG5ld0RhdGFbaSArIDFdID0gYmdbMV0gKiBiZ0FscGhhICsgaW1hZ2VEYXRhLmRhdGFbaSArIDFdICogZmdBbHBoYTsKICAgIG5ld0RhdGFbaSArIDJdID0gYmdbMl0gKiBiZ0FscGhhICsgaW1hZ2VEYXRhLmRhdGFbaSArIDJdICogZmdBbHBoYTsKICAgIG5ld0RhdGFbaSArIDNdID0gMjU1OwogIH0KICByZXR1cm4gbmV3IEltYWdlRGF0YShuZXdEYXRhLCBpbWFnZURhdGEud2lkdGgsIGltYWdlRGF0YS5oZWlnaHQpOwp9CmZ1bmN0aW9uIGltYWdlRGF0YVRvQ2FudmFzKGltYWdlRGF0YSkgewogIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogIGNhbnZhcy53aWR0aCA9IGltYWdlRGF0YS53aWR0aDsKICBjYW52YXMuaGVpZ2h0ID0gaW1hZ2VEYXRhLmhlaWdodDsKICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICBjdHgucHV0SW1hZ2VEYXRhKGltYWdlRGF0YSwgMCwgMCk7CiAgcmV0dXJuIGNhbnZhczsKfQpmdW5jdGlvbiB6b29tU2NhbGVUb1pvb21MZXZlbCh6b29tU2NhbGUpIHsKICBpZiAoem9vbVNjYWxlIDw9IDEpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLmxvZzIoem9vbVNjYWxlKSk7Cn0KZnVuY3Rpb24gem9vbUxldmVsVG9ab29tU2NhbGUoem9vbUxldmVsKSB7CiAgcmV0dXJuIDIgKiogem9vbUxldmVsOwp9CmZ1bmN0aW9uIGNyZWF0ZVZpZXdUb1RpbGVzKHhEb21haW4sIHlEb21haW4sIGJhc2Vab29tU2NhbGUsIG1heFpvb21MZXZlbCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSkgewogIGNvbnN0IFt4TWluLCB4TWF4XSA9IHhEb21haW47CiAgY29uc3QgeEV4dGVudCA9IHhNYXggLSB4TWluOwogIGNvbnN0IFt5TWluLCB5TWF4XSA9IHlEb21haW47CiAgY29uc3QgeUV4dGVudCA9IHlNYXggLSB5TWluOwogIGZ1bmN0aW9uIHRvVGlsZVpvb21MZXZlbCh6b29tU2NhbGUpIHsKICAgIHJldHVybiBNYXRoLm1pbihtYXhab29tTGV2ZWwsIHpvb21TY2FsZVRvWm9vbUxldmVsKHpvb21TY2FsZSkpOwogIH0KICBmdW5jdGlvbiB0b1RpbGVYKHgsIHRpbGVab29tU2NhbGUpIHsKICAgIHJldHVybiBNYXRoLmZsb29yKCh4IC0geE1pbikgLyAoeEV4dGVudCAvIHRpbGVab29tU2NhbGUpKTsKICB9CiAgZnVuY3Rpb24gdG9UaWxlWSh5LCB0aWxlWm9vbVNjYWxlKSB7CiAgICByZXR1cm4gTWF0aC5mbG9vcigoeSAtIHlNaW4pIC8gKHlFeHRlbnQgLyB0aWxlWm9vbVNjYWxlKSk7CiAgfQogIHJldHVybiBmdW5jdGlvbiB2aWV3VG9UaWxlcyh4VmlldywgeVZpZXcsIHpvb21TY2FsZVZpZXcpIHsKICAgIGNvbnN0IHpvb21TY2FsZSA9IGJhc2Vab29tU2NhbGUgKiB6b29tU2NhbGVWaWV3OwogICAgY29uc3QgdGlsZVpvb21MZXZlbCA9IHRvVGlsZVpvb21MZXZlbCh6b29tU2NhbGUpOwogICAgY29uc3QgdGlsZVpvb21TY2FsZSA9IHpvb21MZXZlbFRvWm9vbVNjYWxlKHRpbGVab29tTGV2ZWwpOwogICAgY29uc3QgW3RpbGVYTWluLCB0aWxlWE1heF0gPSB4Vmlldy5tYXAoKHgpID0+IHRvVGlsZVgoeCwgdGlsZVpvb21TY2FsZSkpOwogICAgY29uc3QgW3RpbGVZTWluLCB0aWxlWU1heF0gPSB5Vmlldy5tYXAoKHkpID0+IHRvVGlsZVkoeSwgdGlsZVpvb21TY2FsZSkpOwogICAgY29uc3QgdGlsZXMgPSBbXTsKICAgIGZvciAobGV0IHkgPSB0aWxlWU1pbjsgeSA8PSB0aWxlWU1heDsgeSsrKSB7CiAgICAgIGZvciAobGV0IHggPSB0aWxlWE1pbjsgeCA8PSB0aWxlWE1heDsgeCsrKSB7CiAgICAgICAgdGlsZXMucHVzaChgJHt4fSwke3l9LCR7dGlsZVpvb21MZXZlbH1gKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRpbGVzOwogIH07Cn0KCi8vIHNyYy9jb2RlY3MuanMKdmFyIERUWVBFUyA9IHsKICB1aW50ODogVWludDhBcnJheSwKICBpbnQ4OiBJbnQ4QXJyYXksCiAgdWludDE2OiBVaW50MTZBcnJheSwKICBpbnQxNjogSW50MTZBcnJheSwKICB1aW50MzI6IFVpbnQzMkFycmF5LAogIGludDMyOiBJbnQzMkFycmF5LAogIGZsb2F0MzI6IEZsb2F0MzJBcnJheSwKICBmbG9hdDY0OiBGbG9hdDY0QXJyYXkKfTsKZnVuY3Rpb24gTnVtcHlJbWFnZSgpIHsKICByZXR1cm4gewogICAgLyoqCiAgICAgKiBAcGFyYW0ge1NlcmlhbGl6ZWRBcnJheTxbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0+fSBkYXRhCiAgICAgKiBAcmV0dXJucyB7SW1hZ2VEYXRhIHwgbnVsbH0KICAgICAqLwogICAgZGVzZXJpYWxpemUoZGF0YSkgewogICAgICBpZiAoZGF0YSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IGRhdGFBcnJheSA9IG5ldyBVaW50OENsYW1wZWRBcnJheShkYXRhLnZpZXcuYnVmZmVyKTsKICAgICAgY29uc3QgW2hlaWdodCwgd2lkdGhdID0gZGF0YS5zaGFwZTsKICAgICAgcmV0dXJuIG5ldyBJbWFnZURhdGEoZGF0YUFycmF5LCB3aWR0aCwgaGVpZ2h0KTsKICAgIH0sCiAgICAvKioKICAgICAqIEBwYXJhbSB7SW1hZ2VEYXRhfSBkYXRhCiAgICAgKiBAcmV0dXJucyB7U2VyaWFsaXplZEFycmF5PFtudW1iZXIsIG51bWJlciwgbnVtYmVyXT59CiAgICAgKi8KICAgIHNlcmlhbGl6ZShpbWFnZURhdGEpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2aWV3OiBuZXcgRGF0YVZpZXcoaW1hZ2VEYXRhLmRhdGEuYnVmZmVyKSwKICAgICAgICBkdHlwZTogInVpbnQ4IiwKICAgICAgICBzaGFwZTogW2ltYWdlRGF0YS5oZWlnaHQsIGltYWdlRGF0YS53aWR0aCwgNF0KICAgICAgfTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIE51bXB5MkQoZHR5cGUpIHsKICBpZiAoIShkdHlwZSBpbiBEVFlQRVMpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYER0eXBlIG5vdCBzdXBwb3J0ZWQsIGdvdCAke0pTT04uc3RyaW5naWZ5KGR0eXBlKX0uYCk7CiAgfQogIHJldHVybiB7CiAgICAvKioKICAgICAqIEBwYXJhbSB7U2VyaWFsaXplZEFycmF5PFtudW1iZXIsIG51bWJlcl0+fSBkYXRhCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW11bXSB8IG51bGx9CiAgICAgKi8KICAgIGRlc2VyaWFsaXplKGRhdGEpIHsKICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBjb25zdCBhcnIgPSBuZXcgRFRZUEVTW2R0eXBlXShkYXRhLnZpZXcuYnVmZmVyKTsKICAgICAgY29uc3QgW2hlaWdodCwgd2lkdGhdID0gZGF0YS5zaGFwZTsKICAgICAgY29uc3QgcG9pbnRzID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogaGVpZ2h0IH0pLm1hcCgKICAgICAgICAoXywgaSkgPT4gQXJyYXkuZnJvbShhcnIuc3ViYXJyYXkoaSAqIHdpZHRoLCAoaSArIDEpICogd2lkdGgpKQogICAgICApOwogICAgICByZXR1cm4gcG9pbnRzOwogICAgfSwKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJbXVtdfSBkYXRhCiAgICAgKiBAcmV0dXJucyB7U2VyaWFsaXplZEFycmF5PFtudW1iZXIsIG51bWJlcl0+fQogICAgICovCiAgICBzZXJpYWxpemUoZGF0YSkgewogICAgICBjb25zdCBoZWlnaHQgPSBkYXRhLmxlbmd0aDsKICAgICAgY29uc3Qgd2lkdGggPSBoZWlnaHQgPiAwID8gZGF0YVswXS5sZW5ndGggOiAwOwogICAgICBpZiAoaGVpZ2h0ID09PSAwIHx8IHdpZHRoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgYXJyID0gbmV3IERUWVBFU1tkdHlwZV0oaGVpZ2h0ICogd2lkdGgpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnIuc2V0KGRhdGFbaV0sIGkgKiB3aWR0aCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB2aWV3OiBuZXcgRGF0YVZpZXcoYXJyLmJ1ZmZlciksCiAgICAgICAgZHR5cGUsCiAgICAgICAgc2hhcGU6IFtoZWlnaHQsIHdpZHRoXQogICAgICB9OwogICAgfQogIH07Cn0KZnVuY3Rpb24gTnVtcHkxRChkdHlwZSkgewogIGlmICghKGR0eXBlIGluIERUWVBFUykpIHsKICAgIHRocm93IG5ldyBFcnJvcihgRHR5cGUgbm90IHN1cHBvcnRlZCwgZ290ICR7SlNPTi5zdHJpbmdpZnkoZHR5cGUpfS5gKTsKICB9CiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQHBhcmFtIHtTZXJpYWxpemVkQXJyYXk8W251bWJlcl0+fSBkYXRhCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW10gfCBudWxsfQogICAgICovCiAgICBkZXNlcmlhbGl6ZShkYXRhKSB7CiAgICAgIGlmIChkYXRhID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIEFycmF5LmZyb20obmV3IERUWVBFU1tkdHlwZV0oZGF0YS52aWV3LmJ1ZmZlcikpOwogICAgfSwKICAgIC8qKgogICAgICogQHBhcmFtIHtudW1iZXJbXX0gZGF0YQogICAgICogQHJldHVybnMge1NlcmlhbGl6ZWRBcnJheTxbbnVtYmVyXT59CiAgICAgKi8KICAgIHNlcmlhbGl6ZShkYXRhKSB7CiAgICAgIGNvbnN0IGFyciA9IG5ldyBEVFlQRVNbZHR5cGVdKGRhdGEpOwogICAgICByZXR1cm4gewogICAgICAgIHZpZXc6IG5ldyBEYXRhVmlldyhhcnIuYnVmZmVyKSwKICAgICAgICBkdHlwZSwKICAgICAgICBzaGFwZTogW2RhdGEubGVuZ3RoXQogICAgICB9OwogICAgfQogIH07Cn0KZnVuY3Rpb24gQW5ub3RhdGlvbnMoKSB7CiAgY29uc3QgcHlUb0pzS2V5ID0geyB4X3N0YXJ0OiAieDEiLCB4X2VuZDogIngyIiwgeV9zdGFydDogInkxIiwgeV9lbmQ6ICJ5MiIgfTsKICBjb25zdCBqc1RvUHlLZXkgPSB7IHgxOiAieF9zdGFydCIsIHgyOiAieF9lbmQiLCB5MTogInlfc3RhcnQiLCB5MjogInlfZW5kIiB9OwogIHJldHVybiB7CiAgICAvKioKICAgICAqIEBwYXJhbSB7c3RyaW5nW10gfCBudWxsfSBhbm5vdGF0aW9uU3RycwogICAgICogQHJldHVybnMge29iamVjdFtdfQogICAgICovCiAgICBkZXNlcmlhbGl6ZTogKGFubm90YXRpb25TdHJzKSA9PiB7CiAgICAgIGlmIChhbm5vdGF0aW9uU3RycyA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBhbm5vdGF0aW9uU3Rycy5tYXAoKGFubm90YXRpb25TdHIpID0+IHsKICAgICAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoSlNPTi5wYXJzZShhbm5vdGF0aW9uU3RyKSkucmVkdWNlKAogICAgICAgICAgKGFjYywgW2tleSwgdmFsdWVdKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGpzS2V5ID0ga2V5IGluIHB5VG9Kc0tleSA/IHB5VG9Kc0tleVtrZXldIDogc25ha2VUb0NhbWVsKGtleSk7CiAgICAgICAgICAgIGFjY1tqc0tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIGFjYzsKICAgICAgICAgIH0sCiAgICAgICAgICB7fQogICAgICAgICk7CiAgICAgIH0pOwogICAgfSwKICAgIC8qKgogICAgICogQHBhcmFtIHtvYmplY3RbXSB8IG51bGx9IGFubm90YXRpb25zCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nW119CiAgICAgKi8KICAgIHNlcmlhbGl6ZTogKGFubm90YXRpb25zKSA9PiB7CiAgICAgIGlmIChhbm5vdGF0aW9ucyA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBhbm5vdGF0aW9ucy5tYXAoKGFubm90YXRpb24pID0+IHsKICAgICAgICBjb25zdCBweUFubm90YXRpb24gPSBPYmplY3QuZW50cmllcyhhbm5vdGF0aW9uKS5yZWR1Y2UoCiAgICAgICAgICAoYWNjLCBba2V5LCB2YWx1ZV0pID0+IHsKICAgICAgICAgICAgY29uc3QgcHlLZXkgPSBrZXkgaW4ganNUb1B5S2V5ID8ganNUb1B5S2V5W2tleV0gOiBjYW1lbFRvU25ha2Uoa2V5KTsKICAgICAgICAgICAgYWNjW3B5S2V5XSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gYWNjOwogICAgICAgICAgfSwKICAgICAgICAgIHt9CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocHlBbm5vdGF0aW9uKTsKICAgICAgfSk7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiBUYWJsZTIoKSB7CiAgcmV0dXJuIHsKICAgIC8qKgogICAgICogQHBhcmFtIHtEYXRhVmlld30gZGF0YVZpZXcKICAgICAqIEByZXR1cm5zIHtzdHJpbmdbXX0KICAgICAqLwogICAgZGVzZXJpYWxpemUoZGF0YVZpZXcpIHsKICAgICAgaWYgKGRhdGFWaWV3ID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHRhYmxlRnJvbUlQQyhkYXRhVmlldy5idWZmZXIsIHsgdXNlUHJveHk6IHRydWUgfSk7CiAgICB9LAogICAgc2VyaWFsaXplKHRhYmxlKSB7CiAgICAgIGlmICh0YWJsZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHJldHVybiB0YWJsZVRvSVBDKHRhYmxlKTsKICAgIH0KICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaGllcmFyY2h5L3NyYy9oaWVyYXJjaHkvY291bnQuanMKZnVuY3Rpb24gY291bnQobm9kZSkgewogIHZhciBzdW0gPSAwLCBjaGlsZHJlbjIgPSBub2RlLmNoaWxkcmVuLCBpID0gY2hpbGRyZW4yICYmIGNoaWxkcmVuMi5sZW5ndGg7CiAgaWYgKCFpKSBzdW0gPSAxOwogIGVsc2Ugd2hpbGUgKC0taSA+PSAwKSBzdW0gKz0gY2hpbGRyZW4yW2ldLnZhbHVlOwogIG5vZGUudmFsdWUgPSBzdW07Cn0KZnVuY3Rpb24gY291bnRfZGVmYXVsdCgpIHsKICByZXR1cm4gdGhpcy5lYWNoQWZ0ZXIoY291bnQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaGllcmFyY2h5L3NyYy9oaWVyYXJjaHkvZWFjaC5qcwpmdW5jdGlvbiBlYWNoX2RlZmF1bHQyKGNhbGxiYWNrLCB0aGF0KSB7CiAgbGV0IGluZGV4ID0gLTE7CiAgZm9yIChjb25zdCBub2RlIG9mIHRoaXMpIHsKICAgIGNhbGxiYWNrLmNhbGwodGhhdCwgbm9kZSwgKytpbmRleCwgdGhpcyk7CiAgfQogIHJldHVybiB0aGlzOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaGllcmFyY2h5L3NyYy9oaWVyYXJjaHkvZWFjaEJlZm9yZS5qcwpmdW5jdGlvbiBlYWNoQmVmb3JlX2RlZmF1bHQoY2FsbGJhY2ssIHRoYXQpIHsKICB2YXIgbm9kZSA9IHRoaXMsIG5vZGVzID0gW25vZGVdLCBjaGlsZHJlbjIsIGksIGluZGV4ID0gLTE7CiAgd2hpbGUgKG5vZGUgPSBub2Rlcy5wb3AoKSkgewogICAgY2FsbGJhY2suY2FsbCh0aGF0LCBub2RlLCArK2luZGV4LCB0aGlzKTsKICAgIGlmIChjaGlsZHJlbjIgPSBub2RlLmNoaWxkcmVuKSB7CiAgICAgIGZvciAoaSA9IGNoaWxkcmVuMi5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIG5vZGVzLnB1c2goY2hpbGRyZW4yW2ldKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gdGhpczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvaGllcmFyY2h5L2VhY2hBZnRlci5qcwpmdW5jdGlvbiBlYWNoQWZ0ZXJfZGVmYXVsdChjYWxsYmFjaywgdGhhdCkgewogIHZhciBub2RlID0gdGhpcywgbm9kZXMgPSBbbm9kZV0sIG5leHQgPSBbXSwgY2hpbGRyZW4yLCBpLCBuLCBpbmRleCA9IC0xOwogIHdoaWxlIChub2RlID0gbm9kZXMucG9wKCkpIHsKICAgIG5leHQucHVzaChub2RlKTsKICAgIGlmIChjaGlsZHJlbjIgPSBub2RlLmNoaWxkcmVuKSB7CiAgICAgIGZvciAoaSA9IDAsIG4gPSBjaGlsZHJlbjIubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICAgICAgbm9kZXMucHVzaChjaGlsZHJlbjJbaV0pOwogICAgICB9CiAgICB9CiAgfQogIHdoaWxlIChub2RlID0gbmV4dC5wb3AoKSkgewogICAgY2FsbGJhY2suY2FsbCh0aGF0LCBub2RlLCArK2luZGV4LCB0aGlzKTsKICB9CiAgcmV0dXJuIHRoaXM7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL2hpZXJhcmNoeS9maW5kLmpzCmZ1bmN0aW9uIGZpbmRfZGVmYXVsdChjYWxsYmFjaywgdGhhdCkgewogIGxldCBpbmRleCA9IC0xOwogIGZvciAoY29uc3Qgbm9kZSBvZiB0aGlzKSB7CiAgICBpZiAoY2FsbGJhY2suY2FsbCh0aGF0LCBub2RlLCArK2luZGV4LCB0aGlzKSkgewogICAgICByZXR1cm4gbm9kZTsKICAgIH0KICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL2hpZXJhcmNoeS9zdW0uanMKZnVuY3Rpb24gc3VtX2RlZmF1bHQodmFsdWUpIHsKICByZXR1cm4gdGhpcy5lYWNoQWZ0ZXIoZnVuY3Rpb24obm9kZSkgewogICAgdmFyIHN1bSA9ICt2YWx1ZShub2RlLmRhdGEpIHx8IDAsIGNoaWxkcmVuMiA9IG5vZGUuY2hpbGRyZW4sIGkgPSBjaGlsZHJlbjIgJiYgY2hpbGRyZW4yLmxlbmd0aDsKICAgIHdoaWxlICgtLWkgPj0gMCkgc3VtICs9IGNoaWxkcmVuMltpXS52YWx1ZTsKICAgIG5vZGUudmFsdWUgPSBzdW07CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL2hpZXJhcmNoeS9zb3J0LmpzCmZ1bmN0aW9uIHNvcnRfZGVmYXVsdDIoY29tcGFyZSkgewogIHJldHVybiB0aGlzLmVhY2hCZWZvcmUoZnVuY3Rpb24obm9kZSkgewogICAgaWYgKG5vZGUuY2hpbGRyZW4pIHsKICAgICAgbm9kZS5jaGlsZHJlbi5zb3J0KGNvbXBhcmUpOwogICAgfQogIH0pOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaGllcmFyY2h5L3NyYy9oaWVyYXJjaHkvcGF0aC5qcwpmdW5jdGlvbiBwYXRoX2RlZmF1bHQoZW5kKSB7CiAgdmFyIHN0YXJ0ID0gdGhpcywgYW5jZXN0b3IgPSBsZWFzdENvbW1vbkFuY2VzdG9yKHN0YXJ0LCBlbmQpLCBub2RlcyA9IFtzdGFydF07CiAgd2hpbGUgKHN0YXJ0ICE9PSBhbmNlc3RvcikgewogICAgc3RhcnQgPSBzdGFydC5wYXJlbnQ7CiAgICBub2Rlcy5wdXNoKHN0YXJ0KTsKICB9CiAgdmFyIGsgPSBub2Rlcy5sZW5ndGg7CiAgd2hpbGUgKGVuZCAhPT0gYW5jZXN0b3IpIHsKICAgIG5vZGVzLnNwbGljZShrLCAwLCBlbmQpOwogICAgZW5kID0gZW5kLnBhcmVudDsKICB9CiAgcmV0dXJuIG5vZGVzOwp9CmZ1bmN0aW9uIGxlYXN0Q29tbW9uQW5jZXN0b3IoYSwgYikgewogIGlmIChhID09PSBiKSByZXR1cm4gYTsKICB2YXIgYU5vZGVzID0gYS5hbmNlc3RvcnMoKSwgYk5vZGVzID0gYi5hbmNlc3RvcnMoKSwgYyA9IG51bGw7CiAgYSA9IGFOb2Rlcy5wb3AoKTsKICBiID0gYk5vZGVzLnBvcCgpOwogIHdoaWxlIChhID09PSBiKSB7CiAgICBjID0gYTsKICAgIGEgPSBhTm9kZXMucG9wKCk7CiAgICBiID0gYk5vZGVzLnBvcCgpOwogIH0KICByZXR1cm4gYzsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvaGllcmFyY2h5L2FuY2VzdG9ycy5qcwpmdW5jdGlvbiBhbmNlc3RvcnNfZGVmYXVsdCgpIHsKICB2YXIgbm9kZSA9IHRoaXMsIG5vZGVzID0gW25vZGVdOwogIHdoaWxlIChub2RlID0gbm9kZS5wYXJlbnQpIHsKICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgfQogIHJldHVybiBub2RlczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvaGllcmFyY2h5L2Rlc2NlbmRhbnRzLmpzCmZ1bmN0aW9uIGRlc2NlbmRhbnRzX2RlZmF1bHQoKSB7CiAgcmV0dXJuIEFycmF5LmZyb20odGhpcyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL2hpZXJhcmNoeS9sZWF2ZXMuanMKZnVuY3Rpb24gbGVhdmVzX2RlZmF1bHQoKSB7CiAgdmFyIGxlYXZlcyA9IFtdOwogIHRoaXMuZWFjaEJlZm9yZShmdW5jdGlvbihub2RlKSB7CiAgICBpZiAoIW5vZGUuY2hpbGRyZW4pIHsKICAgICAgbGVhdmVzLnB1c2gobm9kZSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIGxlYXZlczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvaGllcmFyY2h5L2xpbmtzLmpzCmZ1bmN0aW9uIGxpbmtzX2RlZmF1bHQoKSB7CiAgdmFyIHJvb3QyID0gdGhpcywgbGlua3MgPSBbXTsKICByb290Mi5lYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgIGlmIChub2RlICE9PSByb290MikgewogICAgICBsaW5rcy5wdXNoKHsgc291cmNlOiBub2RlLnBhcmVudCwgdGFyZ2V0OiBub2RlIH0pOwogICAgfQogIH0pOwogIHJldHVybiBsaW5rczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvaGllcmFyY2h5L2l0ZXJhdG9yLmpzCmZ1bmN0aW9uKiBpdGVyYXRvcl9kZWZhdWx0MigpIHsKICB2YXIgbm9kZSA9IHRoaXMsIGN1cnJlbnQsIG5leHQgPSBbbm9kZV0sIGNoaWxkcmVuMiwgaSwgbjsKICBkbyB7CiAgICBjdXJyZW50ID0gbmV4dC5yZXZlcnNlKCksIG5leHQgPSBbXTsKICAgIHdoaWxlIChub2RlID0gY3VycmVudC5wb3AoKSkgewogICAgICB5aWVsZCBub2RlOwogICAgICBpZiAoY2hpbGRyZW4yID0gbm9kZS5jaGlsZHJlbikgewogICAgICAgIGZvciAoaSA9IDAsIG4gPSBjaGlsZHJlbjIubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICAgICAgICBuZXh0LnB1c2goY2hpbGRyZW4yW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9IHdoaWxlIChuZXh0Lmxlbmd0aCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL2hpZXJhcmNoeS9pbmRleC5qcwpmdW5jdGlvbiBoaWVyYXJjaHkoZGF0YSwgY2hpbGRyZW4yKSB7CiAgaWYgKGRhdGEgaW5zdGFuY2VvZiBNYXApIHsKICAgIGRhdGEgPSBbdm9pZCAwLCBkYXRhXTsKICAgIGlmIChjaGlsZHJlbjIgPT09IHZvaWQgMCkgY2hpbGRyZW4yID0gbWFwQ2hpbGRyZW47CiAgfSBlbHNlIGlmIChjaGlsZHJlbjIgPT09IHZvaWQgMCkgewogICAgY2hpbGRyZW4yID0gb2JqZWN0Q2hpbGRyZW47CiAgfQogIHZhciByb290MiA9IG5ldyBOb2RlKGRhdGEpLCBub2RlLCBub2RlcyA9IFtyb290Ml0sIGNoaWxkLCBjaGlsZHMsIGksIG47CiAgd2hpbGUgKG5vZGUgPSBub2Rlcy5wb3AoKSkgewogICAgaWYgKChjaGlsZHMgPSBjaGlsZHJlbjIobm9kZS5kYXRhKSkgJiYgKG4gPSAoY2hpbGRzID0gQXJyYXkuZnJvbShjaGlsZHMpKS5sZW5ndGgpKSB7CiAgICAgIG5vZGUuY2hpbGRyZW4gPSBjaGlsZHM7CiAgICAgIGZvciAoaSA9IG4gLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIG5vZGVzLnB1c2goY2hpbGQgPSBjaGlsZHNbaV0gPSBuZXcgTm9kZShjaGlsZHNbaV0pKTsKICAgICAgICBjaGlsZC5wYXJlbnQgPSBub2RlOwogICAgICAgIGNoaWxkLmRlcHRoID0gbm9kZS5kZXB0aCArIDE7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJvb3QyLmVhY2hCZWZvcmUoY29tcHV0ZUhlaWdodCk7Cn0KZnVuY3Rpb24gbm9kZV9jb3B5KCkgewogIHJldHVybiBoaWVyYXJjaHkodGhpcykuZWFjaEJlZm9yZShjb3B5RGF0YSk7Cn0KZnVuY3Rpb24gb2JqZWN0Q2hpbGRyZW4oZCkgewogIHJldHVybiBkLmNoaWxkcmVuOwp9CmZ1bmN0aW9uIG1hcENoaWxkcmVuKGQpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShkKSA/IGRbMV0gOiBudWxsOwp9CmZ1bmN0aW9uIGNvcHlEYXRhKG5vZGUpIHsKICBpZiAobm9kZS5kYXRhLnZhbHVlICE9PSB2b2lkIDApIG5vZGUudmFsdWUgPSBub2RlLmRhdGEudmFsdWU7CiAgbm9kZS5kYXRhID0gbm9kZS5kYXRhLmRhdGE7Cn0KZnVuY3Rpb24gY29tcHV0ZUhlaWdodChub2RlKSB7CiAgdmFyIGhlaWdodCA9IDA7CiAgZG8KICAgIG5vZGUuaGVpZ2h0ID0gaGVpZ2h0OwogIHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50KSAmJiBub2RlLmhlaWdodCA8ICsraGVpZ2h0KTsKfQpmdW5jdGlvbiBOb2RlKGRhdGEpIHsKICB0aGlzLmRhdGEgPSBkYXRhOwogIHRoaXMuZGVwdGggPSB0aGlzLmhlaWdodCA9IDA7CiAgdGhpcy5wYXJlbnQgPSBudWxsOwp9Ck5vZGUucHJvdG90eXBlID0gaGllcmFyY2h5LnByb3RvdHlwZSA9IHsKICBjb25zdHJ1Y3RvcjogTm9kZSwKICBjb3VudDogY291bnRfZGVmYXVsdCwKICBlYWNoOiBlYWNoX2RlZmF1bHQyLAogIGVhY2hBZnRlcjogZWFjaEFmdGVyX2RlZmF1bHQsCiAgZWFjaEJlZm9yZTogZWFjaEJlZm9yZV9kZWZhdWx0LAogIGZpbmQ6IGZpbmRfZGVmYXVsdCwKICBzdW06IHN1bV9kZWZhdWx0LAogIHNvcnQ6IHNvcnRfZGVmYXVsdDIsCiAgcGF0aDogcGF0aF9kZWZhdWx0LAogIGFuY2VzdG9yczogYW5jZXN0b3JzX2RlZmF1bHQsCiAgZGVzY2VuZGFudHM6IGRlc2NlbmRhbnRzX2RlZmF1bHQsCiAgbGVhdmVzOiBsZWF2ZXNfZGVmYXVsdCwKICBsaW5rczogbGlua3NfZGVmYXVsdCwKICBjb3B5OiBub2RlX2NvcHksCiAgW1N5bWJvbC5pdGVyYXRvcl06IGl0ZXJhdG9yX2RlZmF1bHQyCn07CgovLyBub2RlX21vZHVsZXMvZDMtaGllcmFyY2h5L3NyYy9hY2Nlc3NvcnMuanMKZnVuY3Rpb24gcmVxdWlyZWQoZikgewogIGlmICh0eXBlb2YgZiAhPT0gImZ1bmN0aW9uIikgdGhyb3cgbmV3IEVycm9yKCk7CiAgcmV0dXJuIGY7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL2NvbnN0YW50LmpzCmZ1bmN0aW9uIGNvbnN0YW50WmVybygpIHsKICByZXR1cm4gMDsKfQpmdW5jdGlvbiBjb25zdGFudF9kZWZhdWx0Myh4KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHg7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvdHJlZW1hcC9yb3VuZC5qcwpmdW5jdGlvbiByb3VuZF9kZWZhdWx0Mihub2RlKSB7CiAgbm9kZS54MCA9IE1hdGgucm91bmQobm9kZS54MCk7CiAgbm9kZS55MCA9IE1hdGgucm91bmQobm9kZS55MCk7CiAgbm9kZS54MSA9IE1hdGgucm91bmQobm9kZS54MSk7CiAgbm9kZS55MSA9IE1hdGgucm91bmQobm9kZS55MSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL3RyZWVtYXAvZGljZS5qcwpmdW5jdGlvbiBkaWNlX2RlZmF1bHQocGFyZW50LCB4MCwgeTAsIHgxLCB5MSkgewogIHZhciBub2RlcyA9IHBhcmVudC5jaGlsZHJlbiwgbm9kZSwgaSA9IC0xLCBuID0gbm9kZXMubGVuZ3RoLCBrID0gcGFyZW50LnZhbHVlICYmICh4MSAtIHgwKSAvIHBhcmVudC52YWx1ZTsKICB3aGlsZSAoKytpIDwgbikgewogICAgbm9kZSA9IG5vZGVzW2ldLCBub2RlLnkwID0geTAsIG5vZGUueTEgPSB5MTsKICAgIG5vZGUueDAgPSB4MCwgbm9kZS54MSA9IHgwICs9IG5vZGUudmFsdWUgKiBrOwogIH0KfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWhpZXJhcmNoeS9zcmMvdHJlZW1hcC9zbGljZS5qcwpmdW5jdGlvbiBzbGljZV9kZWZhdWx0KHBhcmVudCwgeDAsIHkwLCB4MSwgeTEpIHsKICB2YXIgbm9kZXMgPSBwYXJlbnQuY2hpbGRyZW4sIG5vZGUsIGkgPSAtMSwgbiA9IG5vZGVzLmxlbmd0aCwgayA9IHBhcmVudC52YWx1ZSAmJiAoeTEgLSB5MCkgLyBwYXJlbnQudmFsdWU7CiAgd2hpbGUgKCsraSA8IG4pIHsKICAgIG5vZGUgPSBub2Rlc1tpXSwgbm9kZS54MCA9IHgwLCBub2RlLngxID0geDE7CiAgICBub2RlLnkwID0geTAsIG5vZGUueTEgPSB5MCArPSBub2RlLnZhbHVlICogazsKICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL3RyZWVtYXAvc3F1YXJpZnkuanMKdmFyIHBoaSA9ICgxICsgTWF0aC5zcXJ0KDUpKSAvIDI7CmZ1bmN0aW9uIHNxdWFyaWZ5UmF0aW8ocmF0aW8sIHBhcmVudCwgeDAsIHkwLCB4MSwgeTEpIHsKICB2YXIgcm93cyA9IFtdLCBub2RlcyA9IHBhcmVudC5jaGlsZHJlbiwgcm93LCBub2RlVmFsdWUsIGkwID0gMCwgaTEgPSAwLCBuID0gbm9kZXMubGVuZ3RoLCBkeCwgZHksIHZhbHVlID0gcGFyZW50LnZhbHVlLCBzdW1WYWx1ZSwgbWluVmFsdWUsIG1heFZhbHVlLCBuZXdSYXRpbywgbWluUmF0aW8sIGFscGhhLCBiZXRhOwogIHdoaWxlIChpMCA8IG4pIHsKICAgIGR4ID0geDEgLSB4MCwgZHkgPSB5MSAtIHkwOwogICAgZG8KICAgICAgc3VtVmFsdWUgPSBub2Rlc1tpMSsrXS52YWx1ZTsKICAgIHdoaWxlICghc3VtVmFsdWUgJiYgaTEgPCBuKTsKICAgIG1pblZhbHVlID0gbWF4VmFsdWUgPSBzdW1WYWx1ZTsKICAgIGFscGhhID0gTWF0aC5tYXgoZHkgLyBkeCwgZHggLyBkeSkgLyAodmFsdWUgKiByYXRpbyk7CiAgICBiZXRhID0gc3VtVmFsdWUgKiBzdW1WYWx1ZSAqIGFscGhhOwogICAgbWluUmF0aW8gPSBNYXRoLm1heChtYXhWYWx1ZSAvIGJldGEsIGJldGEgLyBtaW5WYWx1ZSk7CiAgICBmb3IgKDsgaTEgPCBuOyArK2kxKSB7CiAgICAgIHN1bVZhbHVlICs9IG5vZGVWYWx1ZSA9IG5vZGVzW2kxXS52YWx1ZTsKICAgICAgaWYgKG5vZGVWYWx1ZSA8IG1pblZhbHVlKSBtaW5WYWx1ZSA9IG5vZGVWYWx1ZTsKICAgICAgaWYgKG5vZGVWYWx1ZSA+IG1heFZhbHVlKSBtYXhWYWx1ZSA9IG5vZGVWYWx1ZTsKICAgICAgYmV0YSA9IHN1bVZhbHVlICogc3VtVmFsdWUgKiBhbHBoYTsKICAgICAgbmV3UmF0aW8gPSBNYXRoLm1heChtYXhWYWx1ZSAvIGJldGEsIGJldGEgLyBtaW5WYWx1ZSk7CiAgICAgIGlmIChuZXdSYXRpbyA+IG1pblJhdGlvKSB7CiAgICAgICAgc3VtVmFsdWUgLT0gbm9kZVZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIG1pblJhdGlvID0gbmV3UmF0aW87CiAgICB9CiAgICByb3dzLnB1c2gocm93ID0geyB2YWx1ZTogc3VtVmFsdWUsIGRpY2U6IGR4IDwgZHksIGNoaWxkcmVuOiBub2Rlcy5zbGljZShpMCwgaTEpIH0pOwogICAgaWYgKHJvdy5kaWNlKSBkaWNlX2RlZmF1bHQocm93LCB4MCwgeTAsIHgxLCB2YWx1ZSA/IHkwICs9IGR5ICogc3VtVmFsdWUgLyB2YWx1ZSA6IHkxKTsKICAgIGVsc2Ugc2xpY2VfZGVmYXVsdChyb3csIHgwLCB5MCwgdmFsdWUgPyB4MCArPSBkeCAqIHN1bVZhbHVlIC8gdmFsdWUgOiB4MSwgeTEpOwogICAgdmFsdWUgLT0gc3VtVmFsdWUsIGkwID0gaTE7CiAgfQogIHJldHVybiByb3dzOwp9CnZhciBzcXVhcmlmeV9kZWZhdWx0ID0gZnVuY3Rpb24gY3VzdG9tKHJhdGlvKSB7CiAgZnVuY3Rpb24gc3F1YXJpZnkocGFyZW50LCB4MCwgeTAsIHgxLCB5MSkgewogICAgc3F1YXJpZnlSYXRpbyhyYXRpbywgcGFyZW50LCB4MCwgeTAsIHgxLCB5MSk7CiAgfQogIHNxdWFyaWZ5LnJhdGlvID0gZnVuY3Rpb24oeCkgewogICAgcmV0dXJuIGN1c3RvbSgoeCA9ICt4KSA+IDEgPyB4IDogMSk7CiAgfTsKICByZXR1cm4gc3F1YXJpZnk7Cn0ocGhpKTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1oaWVyYXJjaHkvc3JjL3RyZWVtYXAvaW5kZXguanMKZnVuY3Rpb24gdHJlZW1hcF9kZWZhdWx0KCkgewogIHZhciB0aWxlID0gc3F1YXJpZnlfZGVmYXVsdCwgcm91bmQgPSBmYWxzZSwgZHggPSAxLCBkeSA9IDEsIHBhZGRpbmdTdGFjayA9IFswXSwgcGFkZGluZ0lubmVyID0gY29uc3RhbnRaZXJvLCBwYWRkaW5nVG9wID0gY29uc3RhbnRaZXJvLCBwYWRkaW5nUmlnaHQgPSBjb25zdGFudFplcm8sIHBhZGRpbmdCb3R0b20gPSBjb25zdGFudFplcm8sIHBhZGRpbmdMZWZ0ID0gY29uc3RhbnRaZXJvOwogIGZ1bmN0aW9uIHRyZWVtYXAocm9vdDIpIHsKICAgIHJvb3QyLngwID0gcm9vdDIueTAgPSAwOwogICAgcm9vdDIueDEgPSBkeDsKICAgIHJvb3QyLnkxID0gZHk7CiAgICByb290Mi5lYWNoQmVmb3JlKHBvc2l0aW9uTm9kZSk7CiAgICBwYWRkaW5nU3RhY2sgPSBbMF07CiAgICBpZiAocm91bmQpIHJvb3QyLmVhY2hCZWZvcmUocm91bmRfZGVmYXVsdDIpOwogICAgcmV0dXJuIHJvb3QyOwogIH0KICBmdW5jdGlvbiBwb3NpdGlvbk5vZGUobm9kZSkgewogICAgdmFyIHAgPSBwYWRkaW5nU3RhY2tbbm9kZS5kZXB0aF0sIHgwID0gbm9kZS54MCArIHAsIHkwID0gbm9kZS55MCArIHAsIHgxID0gbm9kZS54MSAtIHAsIHkxID0gbm9kZS55MSAtIHA7CiAgICBpZiAoeDEgPCB4MCkgeDAgPSB4MSA9ICh4MCArIHgxKSAvIDI7CiAgICBpZiAoeTEgPCB5MCkgeTAgPSB5MSA9ICh5MCArIHkxKSAvIDI7CiAgICBub2RlLngwID0geDA7CiAgICBub2RlLnkwID0geTA7CiAgICBub2RlLngxID0geDE7CiAgICBub2RlLnkxID0geTE7CiAgICBpZiAobm9kZS5jaGlsZHJlbikgewogICAgICBwID0gcGFkZGluZ1N0YWNrW25vZGUuZGVwdGggKyAxXSA9IHBhZGRpbmdJbm5lcihub2RlKSAvIDI7CiAgICAgIHgwICs9IHBhZGRpbmdMZWZ0KG5vZGUpIC0gcDsKICAgICAgeTAgKz0gcGFkZGluZ1RvcChub2RlKSAtIHA7CiAgICAgIHgxIC09IHBhZGRpbmdSaWdodChub2RlKSAtIHA7CiAgICAgIHkxIC09IHBhZGRpbmdCb3R0b20obm9kZSkgLSBwOwogICAgICBpZiAoeDEgPCB4MCkgeDAgPSB4MSA9ICh4MCArIHgxKSAvIDI7CiAgICAgIGlmICh5MSA8IHkwKSB5MCA9IHkxID0gKHkwICsgeTEpIC8gMjsKICAgICAgdGlsZShub2RlLCB4MCwgeTAsIHgxLCB5MSk7CiAgICB9CiAgfQogIHRyZWVtYXAucm91bmQgPSBmdW5jdGlvbih4KSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyb3VuZCA9ICEheCwgdHJlZW1hcCkgOiByb3VuZDsKICB9OwogIHRyZWVtYXAuc2l6ZSA9IGZ1bmN0aW9uKHgpIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGR4ID0gK3hbMF0sIGR5ID0gK3hbMV0sIHRyZWVtYXApIDogW2R4LCBkeV07CiAgfTsKICB0cmVlbWFwLnRpbGUgPSBmdW5jdGlvbih4KSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh0aWxlID0gcmVxdWlyZWQoeCksIHRyZWVtYXApIDogdGlsZTsKICB9OwogIHRyZWVtYXAucGFkZGluZyA9IGZ1bmN0aW9uKHgpIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gdHJlZW1hcC5wYWRkaW5nSW5uZXIoeCkucGFkZGluZ091dGVyKHgpIDogdHJlZW1hcC5wYWRkaW5nSW5uZXIoKTsKICB9OwogIHRyZWVtYXAucGFkZGluZ0lubmVyID0gZnVuY3Rpb24oeCkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ0lubmVyID0gdHlwZW9mIHggPT09ICJmdW5jdGlvbiIgPyB4IDogY29uc3RhbnRfZGVmYXVsdDMoK3gpLCB0cmVlbWFwKSA6IHBhZGRpbmdJbm5lcjsKICB9OwogIHRyZWVtYXAucGFkZGluZ091dGVyID0gZnVuY3Rpb24oeCkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyB0cmVlbWFwLnBhZGRpbmdUb3AoeCkucGFkZGluZ1JpZ2h0KHgpLnBhZGRpbmdCb3R0b20oeCkucGFkZGluZ0xlZnQoeCkgOiB0cmVlbWFwLnBhZGRpbmdUb3AoKTsKICB9OwogIHRyZWVtYXAucGFkZGluZ1RvcCA9IGZ1bmN0aW9uKHgpIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdUb3AgPSB0eXBlb2YgeCA9PT0gImZ1bmN0aW9uIiA/IHggOiBjb25zdGFudF9kZWZhdWx0MygreCksIHRyZWVtYXApIDogcGFkZGluZ1RvcDsKICB9OwogIHRyZWVtYXAucGFkZGluZ1JpZ2h0ID0gZnVuY3Rpb24oeCkgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ1JpZ2h0ID0gdHlwZW9mIHggPT09ICJmdW5jdGlvbiIgPyB4IDogY29uc3RhbnRfZGVmYXVsdDMoK3gpLCB0cmVlbWFwKSA6IHBhZGRpbmdSaWdodDsKICB9OwogIHRyZWVtYXAucGFkZGluZ0JvdHRvbSA9IGZ1bmN0aW9uKHgpIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdCb3R0b20gPSB0eXBlb2YgeCA9PT0gImZ1bmN0aW9uIiA/IHggOiBjb25zdGFudF9kZWZhdWx0MygreCksIHRyZWVtYXApIDogcGFkZGluZ0JvdHRvbTsKICB9OwogIHRyZWVtYXAucGFkZGluZ0xlZnQgPSBmdW5jdGlvbih4KSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nTGVmdCA9IHR5cGVvZiB4ID09PSAiZnVuY3Rpb24iID8geCA6IGNvbnN0YW50X2RlZmF1bHQzKCt4KSwgdHJlZW1hcCkgOiBwYWRkaW5nTGVmdDsKICB9OwogIHJldHVybiB0cmVlbWFwOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaGllcmFyY2h5L3NyYy90cmVlbWFwL2JpbmFyeS5qcwpmdW5jdGlvbiBiaW5hcnlfZGVmYXVsdChwYXJlbnQsIHgwLCB5MCwgeDEsIHkxKSB7CiAgdmFyIG5vZGVzID0gcGFyZW50LmNoaWxkcmVuLCBpLCBuID0gbm9kZXMubGVuZ3RoLCBzdW0sIHN1bXMgPSBuZXcgQXJyYXkobiArIDEpOwogIGZvciAoc3Vtc1swXSA9IHN1bSA9IGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICBzdW1zW2kgKyAxXSA9IHN1bSArPSBub2Rlc1tpXS52YWx1ZTsKICB9CiAgcGFydGl0aW9uKDAsIG4sIHBhcmVudC52YWx1ZSwgeDAsIHkwLCB4MSwgeTEpOwogIGZ1bmN0aW9uIHBhcnRpdGlvbihpMiwgaiwgdmFsdWUsIHgwMiwgeTAyLCB4MTIsIHkxMikgewogICAgaWYgKGkyID49IGogLSAxKSB7CiAgICAgIHZhciBub2RlID0gbm9kZXNbaTJdOwogICAgICBub2RlLngwID0geDAyLCBub2RlLnkwID0geTAyOwogICAgICBub2RlLngxID0geDEyLCBub2RlLnkxID0geTEyOwogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdmFsdWVPZmZzZXQgPSBzdW1zW2kyXSwgdmFsdWVUYXJnZXQgPSB2YWx1ZSAvIDIgKyB2YWx1ZU9mZnNldCwgayA9IGkyICsgMSwgaGkgPSBqIC0gMTsKICAgIHdoaWxlIChrIDwgaGkpIHsKICAgICAgdmFyIG1pZCA9IGsgKyBoaSA+Pj4gMTsKICAgICAgaWYgKHN1bXNbbWlkXSA8IHZhbHVlVGFyZ2V0KSBrID0gbWlkICsgMTsKICAgICAgZWxzZSBoaSA9IG1pZDsKICAgIH0KICAgIGlmICh2YWx1ZVRhcmdldCAtIHN1bXNbayAtIDFdIDwgc3Vtc1trXSAtIHZhbHVlVGFyZ2V0ICYmIGkyICsgMSA8IGspIC0tazsKICAgIHZhciB2YWx1ZUxlZnQgPSBzdW1zW2tdIC0gdmFsdWVPZmZzZXQsIHZhbHVlUmlnaHQgPSB2YWx1ZSAtIHZhbHVlTGVmdDsKICAgIGlmICh4MTIgLSB4MDIgPiB5MTIgLSB5MDIpIHsKICAgICAgdmFyIHhrID0gdmFsdWUgPyAoeDAyICogdmFsdWVSaWdodCArIHgxMiAqIHZhbHVlTGVmdCkgLyB2YWx1ZSA6IHgxMjsKICAgICAgcGFydGl0aW9uKGkyLCBrLCB2YWx1ZUxlZnQsIHgwMiwgeTAyLCB4aywgeTEyKTsKICAgICAgcGFydGl0aW9uKGssIGosIHZhbHVlUmlnaHQsIHhrLCB5MDIsIHgxMiwgeTEyKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB5ayA9IHZhbHVlID8gKHkwMiAqIHZhbHVlUmlnaHQgKyB5MTIgKiB2YWx1ZUxlZnQpIC8gdmFsdWUgOiB5MTI7CiAgICAgIHBhcnRpdGlvbihpMiwgaywgdmFsdWVMZWZ0LCB4MDIsIHkwMiwgeDEyLCB5ayk7CiAgICAgIHBhcnRpdGlvbihrLCBqLCB2YWx1ZVJpZ2h0LCB4MDIsIHlrLCB4MTIsIHkxMik7CiAgICB9CiAgfQp9CgovLyBzcmMvaGlzdG9ncmFtLmpzCnZhciBERUZBVUxUX0JBQ0tHUk9VTkRfQ09MT1IgPSAicmdiKDE1MywgMTUzLCAxNTMpIjsKdmFyIERFRkFVTFRfSElHSExJR0hUX0NPTE9SID0gInJnYigwLCAwLCAwKSI7CnZhciBCSU5fU1BBQ0UgPSAxOwp2YXIgQk9SREVSX1dJRFRIID0gMjsKdmFyIFZFUk1JTElPTiA9ICIjRDU1RTAwIjsKdmFyIGNyZWF0ZVRyZWVtYXAgPSAoZGF0YSwgd2lkdGgsIGhlaWdodCkgPT4gewogIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogIGNvbnN0IHBhZGRpbmcgPSBCT1JERVJfV0lEVEggKiBkcHIgKyBkcHI7CiAgY29uc3QgdGlsaW5nID0gT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoID4gMTAgPyBiaW5hcnlfZGVmYXVsdCA6IGRpY2VfZGVmYXVsdDsKICByZXR1cm4gdHJlZW1hcF9kZWZhdWx0KCkudGlsZSh0aWxpbmcpLnNpemUoW3dpZHRoIC0gcGFkZGluZyAqIDIsIGhlaWdodF0pLnBhZGRpbmcoZHByKS5yb3VuZCh0cnVlKSgKICAgIGhpZXJhcmNoeSh7CiAgICAgIGtleTogIl9fcm9vdF9fIiwKICAgICAgY2hpbGRyZW46IE9iamVjdC5lbnRyaWVzKGRhdGEpLm1hcCgoW2tleSwgdmFsdWVdKSA9PiAoeyBrZXksIHZhbHVlIH0pKQogICAgfSkuc3VtKChkKSA9PiBkLnZhbHVlKS5zb3J0KChhLCBiKSA9PiBiLnZhbHVlIC0gYS52YWx1ZSkKICApOwp9Owp2YXIgY3JlYXRlQ2F0ZWdvcmljYWxIaXN0b2dyYW1CYWNrZ3JvdW5kID0gKGNhbnZhcywgZGF0YSkgPT4gewogIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogIGNvbnN0IGxhc3RJID0gZGF0YS5sZW5ndGggLSAxOwogIGNvbnN0IHN0YXRlID0gewogICAgd2lkdGg6IDEwMCwKICAgIGhlaWdodDogMTAsCiAgICBsYXN0SSwKICAgIGNvbG9yOiBERUZBVUxUX0JBQ0tHUk9VTkRfQ09MT1IKICB9OwogIGNvbnN0IHN0eWxlID0gKG5ld0NvbG9yKSA9PiB7CiAgICBzdGF0ZS5jb2xvciA9IG5ld0NvbG9yOwogIH07CiAgY29uc3QgZHJhdyA9ICgpID0+IHsKICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgIGN0eC5maWxsU3R5bGUgPSBzdGF0ZS5jb2xvcjsKICAgIGZvciAoY29uc3QgcmVjdCBvZiBzdGF0ZS5yZWN0cykgewogICAgICBjdHguZmlsbFJlY3QocmVjdC54LCByZWN0LnksIHJlY3Qud2lkdGgsIHJlY3QuaGVpZ2h0KTsKICAgIH0KICB9OwogIGNvbnN0IHJlc2l6ZTIgPSAod2lkdGgsIGhlaWdodCkgPT4gewogICAgc3RhdGUud2lkdGggPSB3aWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgc3RhdGUuaGVpZ2h0ID0gaGVpZ2h0ICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBpbml0KCk7CiAgfTsKICBjb25zdCBpbml0ID0gKCkgPT4gewogICAgY29uc3QgZHByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBjb25zdCBwYWRkaW5nID0gQk9SREVSX1dJRFRIICogZHByICsgZHByOwogICAgY29uc3QgdHJlZSA9IGNyZWF0ZVRyZWVtYXAoZGF0YSwgc3RhdGUud2lkdGgsIHN0YXRlLmhlaWdodCk7CiAgICBzdGF0ZS5yZWN0cyA9IHRyZWUubGVhdmVzKCkubWFwKChsZWFmKSA9PiAoewogICAgICB4OiBsZWFmLngwICsgcGFkZGluZywKICAgICAgeTogbGVhZi55MCwKICAgICAgd2lkdGg6IGxlYWYueDEgLSBsZWFmLngwLAogICAgICBoZWlnaHQ6IGxlYWYueTEgLSBsZWFmLnkwCiAgICB9KSk7CiAgfTsKICBpbml0KCk7CiAgcmV0dXJuIHsgZHJhdywgc3R5bGUsIHJlc2l6ZTogcmVzaXplMiB9Owp9Owp2YXIgY3JlYXRlQ2F0ZWdvcmljYWxIaXN0b2dyYW1IaWdobGlnaHQgPSAoY2FudmFzLCBkYXRhKSA9PiB7CiAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgY29uc3QgbGFzdEkgPSBPYmplY3QudmFsdWVzKGRhdGEpLmxlbmd0aCAtIDE7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB3aWR0aDogMTAwLAogICAgaGVpZ2h0OiAxMCwKICAgIGxhc3RJLAogICAgY29sb3I6IERFRkFVTFRfSElHSExJR0hUX0NPTE9SCiAgfTsKICBjb25zdCBzdHlsZSA9IChuZXdDb2xvcikgPT4gewogICAgc3RhdGUuY29sb3IgPSBuZXdDb2xvcjsKICB9OwogIGNvbnN0IGRyYXcgPSAoa2V5KSA9PiB7CiAgICBjb25zdCByZWN0ID0gc3RhdGUucmVjdHNba2V5XTsKICAgIGlmIChyZWN0ID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgY3R4LmZpbGxTdHlsZSA9IHN0YXRlLmNvbG9yOwogICAgY3R4LmZpbGxSZWN0KHJlY3QueCwgcmVjdC55LCByZWN0LndpZHRoLCByZWN0LmhlaWdodCk7CiAgfTsKICBjb25zdCByZXNpemUyID0gKHdpZHRoLCBoZWlnaHQpID0+IHsKICAgIHN0YXRlLndpZHRoID0gd2lkdGggKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbzsKICAgIHN0YXRlLmhlaWdodCA9IGhlaWdodCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgaW5pdCgpOwogIH07CiAgY29uc3QgaW5pdCA9ICgpID0+IHsKICAgIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgY29uc3QgcGFkZGluZyA9IEJPUkRFUl9XSURUSCAqIGRwciArIGRwcjsKICAgIGNvbnN0IHRyZWUgPSBjcmVhdGVUcmVlbWFwKGRhdGEsIHN0YXRlLndpZHRoLCBzdGF0ZS5oZWlnaHQpOwogICAgc3RhdGUucmVjdHMgPSB0cmVlLmxlYXZlcygpLnJlZHVjZSgoYWNjLCBsZWFmKSA9PiB7CiAgICAgIGFjY1tsZWFmLmRhdGEua2V5XSA9IHsKICAgICAgICB4OiBsZWFmLngwICsgcGFkZGluZywKICAgICAgICB5OiBsZWFmLnkwLAogICAgICAgIHdpZHRoOiBsZWFmLngxIC0gbGVhZi54MCwKICAgICAgICBoZWlnaHQ6IGxlYWYueTEgLSBsZWFmLnkwCiAgICAgIH07CiAgICAgIHJldHVybiBhY2M7CiAgICB9LCB7fSk7CiAgfTsKICBpbml0KCk7CiAgcmV0dXJuIHsgZHJhdywgc3R5bGUsIHJlc2l6ZTogcmVzaXplMiB9Owp9Owp2YXIgY3JlYXRlTnVtZXJpY2FsSGlzdG9ncmFtQmFja2dyb3VuZCA9IChjYW52YXMsIGRhdGEpID0+IHsKICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICBjb25zdCBzdGF0ZSA9IHsKICAgIHdpZHRoOiAxMDAsCiAgICBoZWlnaHQ6IDEwLAogICAgY29sb3I6IERFRkFVTFRfQkFDS0dST1VORF9DT0xPUgogIH07CiAgY29uc3Qgc3R5bGUgPSAobmV3Q29sb3IpID0+IHsKICAgIHN0YXRlLmNvbG9yID0gbmV3Q29sb3I7CiAgfTsKICBjb25zdCBkcmF3ID0gKCkgPT4gewogICAgY3R4LmNsZWFyUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgY3R4LmZpbGxTdHlsZSA9IHN0YXRlLmNvbG9yOwogICAgZm9yIChjb25zdCByZWN0IG9mIHN0YXRlLnJlY3RzKSB7CiAgICAgIGN0eC5maWxsUmVjdChyZWN0LngsIHJlY3QueSwgc3RhdGUuYmluV2lkdGgsIHJlY3QuaGVpZ2h0KTsKICAgIH0KICB9OwogIGNvbnN0IHJlc2l6ZTIgPSAod2lkdGgsIGhlaWdodCkgPT4gewogICAgc3RhdGUud2lkdGggPSB3aWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgc3RhdGUuaGVpZ2h0ID0gaGVpZ2h0ICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBpbml0KCk7CiAgfTsKICBjb25zdCBpbml0ID0gKCkgPT4gewogICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBzdGF0ZTsKICAgIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgY29uc3QgcGFkZGluZyA9IEJPUkRFUl9XSURUSCAqIGRwciArIGRwcjsKICAgIGNvbnN0IGhpc3RvZ3JhbVdpZHRoID0gd2lkdGggLSBwYWRkaW5nICogMjsKICAgIHN0YXRlLmJpblN0ZXAgPSBoaXN0b2dyYW1XaWR0aCAvIGRhdGEubGVuZ3RoOwogICAgc3RhdGUuYmluV2lkdGggPSBzdGF0ZS5iaW5TdGVwIC0gQklOX1NQQUNFICogZHByOwogICAgc3RhdGUucmVjdHMgPSBkYXRhLm1hcCgodmFsdWUsIGkpID0+ICh7CiAgICAgIHg6IHBhZGRpbmcgKyBpICogc3RhdGUuYmluU3RlcCwKICAgICAgeTogKDEgLSB2YWx1ZSkgKiBoZWlnaHQsCiAgICAgIGhlaWdodDogdmFsdWUgKiBoZWlnaHQKICAgIH0pKTsKICB9OwogIGluaXQoKTsKICByZXR1cm4geyBkcmF3LCBzdHlsZSwgcmVzaXplOiByZXNpemUyIH07Cn07CnZhciBjcmVhdGVOdW1lcmljYWxIaXN0b2dyYW1IaWdobGlnaHQgPSAoY2FudmFzLCBkYXRhKSA9PiB7CiAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgY29uc3QgbGFzdEkgPSBPYmplY3QudmFsdWVzKGRhdGEpLmxlbmd0aCAtIDE7CiAgY29uc3QgdG9CZyA9IChjb2xvcjIpID0+IGByZ2IoJHtjb2xvcjIubWF0Y2goL1xkKy9nKS5qb2luKCIsICIpfSwgMC4xKWA7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB3aWR0aDogMTAwLAogICAgaGVpZ2h0OiAxMCwKICAgIGNvbG9yOiBERUZBVUxUX0hJR0hMSUdIVF9DT0xPUiwKICAgIGJnQ29sb3I6IHRvQmcoREVGQVVMVF9ISUdITElHSFRfQ09MT1IpCiAgfTsKICBjb25zdCBzdHlsZSA9IChuZXdDb2xvcikgPT4gewogICAgc3RhdGUuY29sb3IgPSBuZXdDb2xvcjsKICAgIHN0YXRlLmJnQ29sb3IgPSB0b0JnKG5ld0NvbG9yKTsKICB9OwogIGNvbnN0IGRyYXcgPSAoYmluKSA9PiB7CiAgICBjdHguY2xlYXJSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICBjb25zdCBkcHIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbzsKICAgIGlmIChiaW4gPCAwKSB7CiAgICAgIGN0eC5maWxsU3R5bGUgPSBWRVJNSUxJT047CiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzdGF0ZS5ib3JkZXJXaWR0aCwgZHByKTsKICAgICAgY3R4LmZpbGxSZWN0KHN0YXRlLmJvcmRlcldpZHRoIC0gZHByLCAwLCBkcHIsIHN0YXRlLmhlaWdodCk7CiAgICAgIGN0eC5maWxsUmVjdCgwLCBzdGF0ZS5oZWlnaHQgLSBkcHIsIHN0YXRlLmJvcmRlcldpZHRoLCBkcHIpOwogICAgfSBlbHNlIGlmIChiaW4gPiBsYXN0SSkgewogICAgICBjdHguZmlsbFN0eWxlID0gVkVSTUlMSU9OOwogICAgICBjb25zdCB4ID0gc3RhdGUud2lkdGggLSBzdGF0ZS5ib3JkZXJXaWR0aDsKICAgICAgY3R4LmZpbGxSZWN0KHgsIDAsIHN0YXRlLmJvcmRlcldpZHRoLCBkcHIpOwogICAgICBjdHguZmlsbFJlY3QoeCwgMCwgZHByLCBzdGF0ZS5oZWlnaHQpOwogICAgICBjdHguZmlsbFJlY3QoeCwgc3RhdGUuaGVpZ2h0IC0gZHByLCBzdGF0ZS5ib3JkZXJXaWR0aCwgZHByKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHJlY3QgPSBzdGF0ZS5yZWN0c1tiaW5dOwogICAgICBjdHgubGluZVdpZHRoID0gZHByOwogICAgICBjdHguc3Ryb2tlU3R5bGUgPSBzdGF0ZS5iZ0NvbG9yOwogICAgICBjdHguc3Ryb2tlUmVjdChyZWN0LngsIDAsIHN0YXRlLmJpbldpZHRoLCBzdGF0ZS5oZWlnaHQpOwogICAgICBjdHguZmlsbFN0eWxlID0gc3RhdGUuY29sb3I7CiAgICAgIGN0eC5maWxsUmVjdChyZWN0LngsIHJlY3QueSwgc3RhdGUuYmluV2lkdGgsIHJlY3QuaGVpZ2h0KTsKICAgIH0KICB9OwogIGNvbnN0IHJlc2l6ZTIgPSAod2lkdGgsIGhlaWdodCkgPT4gewogICAgc3RhdGUud2lkdGggPSB3aWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgc3RhdGUuaGVpZ2h0ID0gaGVpZ2h0ICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBpbml0KCk7CiAgfTsKICBjb25zdCBpbml0ID0gKCkgPT4gewogICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBzdGF0ZTsKICAgIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgc3RhdGUuYm9yZGVyV2lkdGggPSBCT1JERVJfV0lEVEggKiBkcHI7CiAgICBjb25zdCBwYWRkaW5nID0gc3RhdGUuYm9yZGVyV2lkdGggKyBkcHI7CiAgICBjb25zdCBoaXN0b2dyYW1XaWR0aCA9IHdpZHRoIC0gcGFkZGluZyAqIDI7CiAgICBjb25zdCBiaW5TdGVwID0gaGlzdG9ncmFtV2lkdGggLyBkYXRhLmxlbmd0aDsKICAgIHN0YXRlLmJpbldpZHRoID0gYmluU3RlcCAtIEJJTl9TUEFDRSAqIGRwcjsKICAgIHN0YXRlLnJlY3RzID0gZGF0YS5tYXAoKHZhbHVlLCBpKSA9PiAoewogICAgICB4OiBwYWRkaW5nICsgaSAqIGJpblN0ZXAsCiAgICAgIHk6ICgxIC0gdmFsdWUpICogaGVpZ2h0LAogICAgICBoZWlnaHQ6IHZhbHVlICogaGVpZ2h0CiAgICB9KSk7CiAgfTsKICBpbml0KCk7CiAgcmV0dXJuIHsgZHJhdywgc3R5bGUsIHJlc2l6ZTogcmVzaXplMiB9Owp9Owp2YXIgY3JlYXRlSGlzdG9ncmFtID0gKHdpZHRoLCBoZWlnaHQpID0+IHsKICBjb25zdCBlbGVtZW50ID0gY3JlYXRlRWxlbWVudFdpdGhDbGFzcygiZGl2IiwgImhpc3RvZ3JhbSIpOwogIGVsZW1lbnQuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogIGVsZW1lbnQuc3R5bGUud2lkdGggPSB3aWR0aDsKICBlbGVtZW50LnN0eWxlLmhlaWdodCA9IGhlaWdodDsKICBjb25zdCBiYWNrZ3JvdW5kID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgYmFja2dyb3VuZC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgYmFja2dyb3VuZC5zdHlsZS50b3AgPSAwOwogIGJhY2tncm91bmQuc3R5bGUubGVmdCA9IDA7CiAgY29uc3QgZm9yZWdyb3VuZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogIGZvcmVncm91bmQuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogIGZvcmVncm91bmQuc3R5bGUudG9wID0gMDsKICBmb3JlZ3JvdW5kLnN0eWxlLmxlZnQgPSAwOwogIGVsZW1lbnQuYXBwZW5kQ2hpbGQoYmFja2dyb3VuZCk7CiAgZWxlbWVudC5hcHBlbmRDaGlsZChmb3JlZ3JvdW5kKTsKICBsZXQgaGlzdG9ncmFtQmFja2dyb3VuZDsKICBsZXQgaGlzdG9ncmFtSGlnaGxpZ2h0OwogIGxldCBpc0luaXQgPSBmYWxzZTsKICBsZXQgaXNCYWNrZ3JvdW5kRHJhd24gPSBmYWxzZTsKICBjb25zdCBkcmF3ID0gKGtleSkgPT4gewogICAgaWYgKCFpc0luaXQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFpc0JhY2tncm91bmREcmF3bikgewogICAgICBoaXN0b2dyYW1CYWNrZ3JvdW5kLmRyYXcoKTsKICAgICAgaXNCYWNrZ3JvdW5kRHJhd24gPSB0cnVlOwogICAgfQogICAgaGlzdG9ncmFtSGlnaGxpZ2h0LmRyYXcoa2V5KTsKICB9OwogIGNvbnN0IHN0eWxlID0gKGNvbG9yMiwgYmFja2dyb3VuZDIpID0+IHsKICAgIGlmICghaXNJbml0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGhpc3RvZ3JhbUJhY2tncm91bmQuc3R5bGUoYmFja2dyb3VuZDIpOwogICAgaGlzdG9ncmFtSGlnaGxpZ2h0LnN0eWxlKGNvbG9yMik7CiAgfTsKICBjb25zdCByZXNpemUyID0gKCkgPT4gewogICAgY29uc3QgYkJveCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCB3aWR0aDIgPSBNYXRoLnJvdW5kKGJCb3gud2lkdGgpOwogICAgY29uc3QgaGVpZ2h0MiA9IE1hdGgucm91bmQoYkJveC5oZWlnaHQpOwogICAgYmFja2dyb3VuZC53aWR0aCA9IHdpZHRoMiAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgYmFja2dyb3VuZC5oZWlnaHQgPSBoZWlnaHQyICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBiYWNrZ3JvdW5kLnN0eWxlLndpZHRoID0gYCR7d2lkdGgyfXB4YDsKICAgIGJhY2tncm91bmQuc3R5bGUuaGVpZ2h0ID0gYCR7aGVpZ2h0Mn1weGA7CiAgICBmb3JlZ3JvdW5kLndpZHRoID0gd2lkdGgyICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICBmb3JlZ3JvdW5kLmhlaWdodCA9IGhlaWdodDIgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbzsKICAgIGZvcmVncm91bmQuc3R5bGUud2lkdGggPSBgJHt3aWR0aDJ9cHhgOwogICAgZm9yZWdyb3VuZC5zdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHQyfXB4YDsKICAgIGlmICghaXNJbml0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGhpc3RvZ3JhbUJhY2tncm91bmQucmVzaXplKHdpZHRoMiwgaGVpZ2h0Mik7CiAgICBoaXN0b2dyYW1IaWdobGlnaHQucmVzaXplKHdpZHRoMiwgaGVpZ2h0Mik7CiAgfTsKICBjb25zdCBpbml0ID0gKGRhdGEsIGlzQ2F0ZWdvcmljYWwpID0+IHsKICAgIGlzSW5pdCA9IEJvb2xlYW4oZGF0YSk7CiAgICBpZiAoIWlzSW5pdCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoaXNDYXRlZ29yaWNhbCkgewogICAgICBoaXN0b2dyYW1CYWNrZ3JvdW5kID0gY3JlYXRlQ2F0ZWdvcmljYWxIaXN0b2dyYW1CYWNrZ3JvdW5kKAogICAgICAgIGJhY2tncm91bmQsCiAgICAgICAgZGF0YQogICAgICApOwogICAgICBoaXN0b2dyYW1IaWdobGlnaHQgPSBjcmVhdGVDYXRlZ29yaWNhbEhpc3RvZ3JhbUhpZ2hsaWdodCgKICAgICAgICBmb3JlZ3JvdW5kLAogICAgICAgIGRhdGEKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGhpc3RvZ3JhbUJhY2tncm91bmQgPSBjcmVhdGVOdW1lcmljYWxIaXN0b2dyYW1CYWNrZ3JvdW5kKAogICAgICAgIGJhY2tncm91bmQsCiAgICAgICAgZGF0YQogICAgICApOwogICAgICBoaXN0b2dyYW1IaWdobGlnaHQgPSBjcmVhdGVOdW1lcmljYWxIaXN0b2dyYW1IaWdobGlnaHQoZm9yZWdyb3VuZCwgZGF0YSk7CiAgICB9CiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgcmVzaXplMigpOwogICAgfSk7CiAgfTsKICByZXR1cm4geyBlbGVtZW50LCBpbml0LCBkcmF3LCBzdHlsZSwgcmVzaXplOiByZXNpemUyIH07Cn07CgovLyBzcmMvbGFiZWwtcmVuZGVyZXIuanMKdmFyIEFTSU5IXzEgPSBNYXRoLmFzaW5oKDEpOwp2YXIgTElORV9IRUlHSFQgPSAxLjI7CnZhciBPVVRfT0ZfVklFV19QQURESU5HID0gMC4wNTsKdmFyIFNIQURPV19DT0xPUiA9ICJibGFjayI7CnZhciBERUZBVUxUX1RFWFRfQUxJR04gPSAiY2VudGVyIjsKdmFyIERFRkFVTFRfRk9OVF9TSEFET1dfQ09MT1IgPSAid2hpdGUiOwp2YXIgYXNpbmhab29tU2NhbGUgPSAoem9vbVNjYWxlKSA9PiB7CiAgaWYgKHpvb21TY2FsZSA+IDEpIHsKICAgIHJldHVybiBNYXRoLmFzaW5oKHpvb21TY2FsZSkgLyBBU0lOSF8xOwogIH0KICByZXR1cm4gMTsKfTsKdmFyIGNyZWF0ZUxhYmVsUmVuZGVyZXIgPSAoY2FudmFzKSA9PiB7CiAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgZnVuY3Rpb24gZHJhd1RleHRMaW5lV2l0aFNoYWRvdyh0ZXh0LCB4LCB5LCBmaWxsQ29sb3IsIG9wYWNpdHksIHNoYWRvd0NvbG9yID0gU0hBRE9XX0NPTE9SKSB7CiAgICBjdHguZ2xvYmFsQWxwaGEgPSBvcGFjaXR5OwogICAgY3R4LnNoYWRvd0NvbG9yID0gc2hhZG93Q29sb3I7CiAgICBjdHguc2hhZG93Qmx1ciA9IGN0eC5saW5lV2lkdGg7CiAgICBjdHguc2hhZG93T2Zmc2V0WCA9IDA7CiAgICBjdHguc2hhZG93T2Zmc2V0WSA9IDA7CiAgICBjdHguZmlsbFN0eWxlID0gZmlsbENvbG9yOwogICAgY3R4LmZpbGxUZXh0KHRleHQsIHgsIHkpOwogIH0KICBmdW5jdGlvbiBkcmF3TXVsdGlMaW5lT3V0bGluZWRUZXh0KHRleHQsIHgsIHksIGZpbGxDb2xvciwgb3BhY2l0eSwgc2hhZG93Q29sb3IpIHsKICAgIGNvbnN0IGxpbmVzID0gdGV4dC5zcGxpdCgiXG4iKTsKICAgIGNvbnN0IGZvbnRNZXRyaWNzID0gY3R4Lm1lYXN1cmVUZXh0KCJNZyIpOwogICAgY29uc3QgbGluZUhlaWdodCA9IChmb250TWV0cmljcy5hY3R1YWxCb3VuZGluZ0JveEFzY2VudCArIGZvbnRNZXRyaWNzLmFjdHVhbEJvdW5kaW5nQm94RGVzY2VudCkgKiBMSU5FX0hFSUdIVDsKICAgIGxldCBzdGFydFkgPSB5OwogICAgaWYgKGN0eC50ZXh0QmFzZWxpbmUgPT09ICJtaWRkbGUiKSB7CiAgICAgIHN0YXJ0WSA9IHkgLSBsaW5lSGVpZ2h0ICogKGxpbmVzLmxlbmd0aCAtIDEpIC8gMjsKICAgIH0gZWxzZSBpZiAoY3R4LnRleHRCYXNlbGluZSA9PT0gImJvdHRvbSIpIHsKICAgICAgc3RhcnRZID0geSAtIGxpbmVIZWlnaHQgKiAobGluZXMubGVuZ3RoIC0gMSk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGxpbmVZID0gc3RhcnRZICsgaSAqIGxpbmVIZWlnaHQ7CiAgICAgIGRyYXdUZXh0TGluZVdpdGhTaGFkb3coCiAgICAgICAgbGluZXNbaV0sCiAgICAgICAgeCwKICAgICAgICBsaW5lWSwKICAgICAgICBmaWxsQ29sb3IsCiAgICAgICAgb3BhY2l0eSwKICAgICAgICBzaGFkb3dDb2xvcgogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBkcmF3VGV4dCh0ZXh0LCB4LCB5LCBmaWxsQ29sb3IsIG9wYWNpdHksIHNoYWRvd0NvbG9yKSB7CiAgICBpZiAodGV4dC5pbmNsdWRlcygiXG4iKSkgewogICAgICBkcmF3TXVsdGlMaW5lT3V0bGluZWRUZXh0KHRleHQsIHgsIHksIGZpbGxDb2xvciwgb3BhY2l0eSwgc2hhZG93Q29sb3IpOwogICAgfSBlbHNlIHsKICAgICAgZHJhd1RleHRMaW5lV2l0aFNoYWRvdyh0ZXh0LCB4LCB5LCBmaWxsQ29sb3IsIG9wYWNpdHksIHNoYWRvd0NvbG9yKTsKICAgIH0KICB9CiAgY29uc3Qgc2V0VGV4dEFsaWdubWVudCA9ICh0ZXh0QWxpZ24pID0+IHsKICAgIHN3aXRjaCAodGV4dEFsaWduKSB7CiAgICAgIGNhc2UgInRvcCI6IHsKICAgICAgICBjdHgudGV4dEFsaWduID0gImNlbnRlciI7CiAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgInRvcC1sZWZ0IjogewogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAicmlnaHQiOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAiYm90dG9tIjsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlICJ0b3AtcmlnaHQiOiB7CiAgICAgICAgY3R4LnRleHRBbGlnbiA9ICJsZWZ0IjsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gImJvdHRvbSI7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAiYm90dG9tIjogewogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAiY2VudGVyIjsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gInRvcCI7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAiYm90dG9tLWxlZnQiOiB7CiAgICAgICAgY3R4LnRleHRBbGlnbiA9ICJyaWdodCI7CiAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJ0b3AiOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgImJvdHRvbS1yaWdodCI6IHsKICAgICAgICBjdHgudGV4dEFsaWduID0gImxlZnQiOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAidG9wIjsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlICJsZWZ0IjogewogICAgICAgIGN0eC50ZXh0QWxpZ24gPSAicmlnaHQiOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlICJyaWdodCI6IHsKICAgICAgICBjdHgudGV4dEFsaWduID0gImxlZnQiOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBkZWZhdWx0OiB7CiAgICAgICAgY3R4LnRleHRBbGlnbiA9ICJjZW50ZXIiOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH07CiAgY29uc3QgZ2V0VmlzaWJpYmxlRG9tYWlucyA9ICh4U2NhbGUsIHlTY2FsZSkgPT4gewogICAgY29uc3QgW21pbkRhdGFYLCBtYXhEYXRhWF0gPSB4U2NhbGUuZG9tYWluKCk7CiAgICBjb25zdCBbbWluRGF0YVksIG1heERhdGFZXSA9IHlTY2FsZS5kb21haW4oKTsKICAgIGNvbnN0IG91dE9mVmlld1hQYWRkaW5nID0gKG1heERhdGFYIC0gbWluRGF0YVgpICogT1VUX09GX1ZJRVdfUEFERElORzsKICAgIGNvbnN0IG91dE9mVmlld1lQYWRkaW5nID0gKG1heERhdGFZIC0gbWluRGF0YVkpICogT1VUX09GX1ZJRVdfUEFERElORzsKICAgIHJldHVybiBbCiAgICAgIG1pbkRhdGFYIC0gb3V0T2ZWaWV3WFBhZGRpbmcsCiAgICAgIG1heERhdGFYICsgb3V0T2ZWaWV3WFBhZGRpbmcsCiAgICAgIG1pbkRhdGFZIC0gb3V0T2ZWaWV3WVBhZGRpbmcsCiAgICAgIG1heERhdGFZICsgb3V0T2ZWaWV3WVBhZGRpbmcKICAgIF07CiAgfTsKICBjb25zdCBjbGVhciA9ICgpID0+IHsKICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICB9OwogIGNvbnN0IHJlbmRlcjIgPSAobGFiZWxzLCB6b29tLCB4U2NhbGUsIHlTY2FsZSwgb3B0aW9ucykgPT4gewogICAgY2xlYXIoKTsKICAgIGNvbnN0IGRwciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgY29uc3QgW21pbkRhdGFYLCBtYXhEYXRhWCwgbWluRGF0YVksIG1heERhdGFZXSA9IGdldFZpc2liaWJsZURvbWFpbnMoCiAgICAgIHhTY2FsZSwKICAgICAgeVNjYWxlCiAgICApOwogICAgY3R4LmxpbmVXaWR0aCA9IDQgKiBkcHI7CiAgICBzZXRUZXh0QWxpZ25tZW50KG9wdGlvbnMuYWxpZ24gfHwgREVGQVVMVF9URVhUX0FMSUdOKTsKICAgIGNvbnN0IGZvbnRTY2FsZSA9IG9wdGlvbnMuc2NhbGVGdW5jdGlvbiA9PT0gImNvbnN0YW50IiA/IDEgOiBhc2luaFpvb21TY2FsZSh6b29tKTsKICAgIGNvbnN0IFt4T2Zmc2V0LCB5T2Zmc2V0XSA9IG9wdGlvbnMub2Zmc2V0OwogICAgY29uc3Qgc2hhZG93Q29sb3IgPSBvcHRpb25zLnNoYWRvd0NvbG9yIHx8IERFRkFVTFRfRk9OVF9TSEFET1dfQ09MT1I7CiAgICBjb25zdCBudW1MYWJlbHMgPSBsYWJlbHMubnVtUm93czsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtTGFiZWxzOyArK2kpIHsKICAgICAgY29uc3Qgem9vbUluID0gbGFiZWxzLmdldENoaWxkKCJ6b29tSW4iKS5hdChpKTsKICAgICAgY29uc3Qgem9vbU91dCA9IGxhYmVscy5nZXRDaGlsZCgiem9vbU91dCIpLmF0KGkpOwogICAgICBpZiAoem9vbUluID4gem9vbSB8fCB6b29tID4gem9vbU91dCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGRhdGFYID0gbGFiZWxzLmdldENoaWxkKCJ4IikuYXQoaSk7CiAgICAgIGNvbnN0IGRhdGFZID0gbGFiZWxzLmdldENoaWxkKCJ5IikuYXQoaSk7CiAgICAgIGlmIChkYXRhWCA8IG1pbkRhdGFYIHx8IGRhdGFYID4gbWF4RGF0YVggfHwgZGF0YVkgPCBtaW5EYXRhWSB8fCBkYXRhWSA+IG1heERhdGFZKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgdGV4dCA9IGxhYmVscy5nZXRDaGlsZCgibGFiZWwiKS5hdChpKTsKICAgICAgY29uc3QgZm9udENvbG9yID0gbGFiZWxzLmdldENoaWxkKCJmb250Q29sb3IiKS5hdChpKTsKICAgICAgY29uc3QgZm9udEZhY2UgPSBsYWJlbHMuZ2V0Q2hpbGQoImZvbnRGYWNlIikuYXQoaSk7CiAgICAgIGNvbnN0IGZvbnRTdHlsZSA9IGxhYmVscy5nZXRDaGlsZCgiZm9udFN0eWxlIikuYXQoaSk7CiAgICAgIGNvbnN0IGZvbnRXZWlnaHQgPSBsYWJlbHMuZ2V0Q2hpbGQoImZvbnRXZWlnaHQiKS5hdChpKTsKICAgICAgY29uc3QgZm9udFNpemUgPSBsYWJlbHMuZ2V0Q2hpbGQoImZvbnRTaXplIikuYXQoaSkgKiBmb250U2NhbGU7CiAgICAgIGNvbnN0IHpvb21GYWRlRXh0ZW50ID0gbGFiZWxzLmdldENoaWxkKCJ6b29tRmFkZUV4dGVudCIpLmF0KGkpOwogICAgICBjb25zdCBhbHBoYUZhZGVPdXQgPSBNYXRoLm1heCgKICAgICAgICAwLAogICAgICAgIE1hdGgubWluKDEsICh6b29tT3V0IC0gem9vbSkgLyB6b29tRmFkZUV4dGVudCkKICAgICAgKTsKICAgICAgY3R4LmZvbnQgPSBgJHtmb250U3R5bGV9ICR7Zm9udFdlaWdodH0gJHtmb250U2l6ZSAqIGRwcn1weCAke2ZvbnRGYWNlfWA7CiAgICAgIGRyYXdUZXh0KAogICAgICAgIHRleHQsCiAgICAgICAgKHhTY2FsZShkYXRhWCkgKyB4T2Zmc2V0KSAqIGRwciwKICAgICAgICAoeVNjYWxlKGRhdGFZKSArIHlPZmZzZXQpICogZHByLAogICAgICAgIGZvbnRDb2xvciwKICAgICAgICBhbHBoYUZhZGVPdXQsCiAgICAgICAgc2hhZG93Q29sb3IKICAgICAgKTsKICAgIH0KICB9OwogIHJldHVybiB7IGNsZWFyLCByZW5kZXI6IHJlbmRlcjIgfTsKfTsKCi8vIHNyYy9sZWdlbmQuanMKdmFyIHNvcnRPcmRlciA9IHsKICBjb2xvcjogMCwKICBvcGFjaXR5OiAxLAogIHNpemU6IDIsCiAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogQ29taW5nIGZyb20gUHl0aG9uIGxhbmQKICBjb25uZWN0aW9uX2NvbG9yOiAzLAogIC8vIGJpb21lLWlnbm9yZSBsaW50L3N0eWxlL3VzZU5hbWluZ0NvbnZlbnRpb246IENvbWluZyBmcm9tIFB5dGhvbiBsYW5kCiAgY29ubmVjdGlvbl9vcGFjaXR5OiA0LAogIC8vIGJpb21lLWlnbm9yZSBsaW50L3N0eWxlL3VzZU5hbWluZ0NvbnZlbnRpb246IENvbWluZyBmcm9tIFB5dGhvbiBsYW5kCiAgY29ubmVjdGlvbl9zaXplOiA1Cn07CmZ1bmN0aW9uIGNyZWF0ZUxhYmVsRm9ybWF0dGVyKHZhbHVlUmFuZ2UsIGlzQ2F0ZWdvcmljYWwpIHsKICBjb25zdCBtaW4zID0gdmFsdWVSYW5nZVswXTsKICBjb25zdCBtYXgzID0gdmFsdWVSYW5nZVsxXTsKICBpZiAoaXNDYXRlZ29yaWNhbCB8fCBOdW1iZXIuaXNOYU4oTnVtYmVyKG1pbjMpKSB8fCBOdW1iZXIuaXNOYU4oTnVtYmVyKG1heDMpKSkgewogICAgcmV0dXJuICh2YWx1ZSkgPT4gdmFsdWU7CiAgfQogIHJldHVybiBmb3JtYXQoZ2V0RDNGb3JtYXRTcGVjaWZpZXIodmFsdWVSYW5nZSkpOwp9CmZ1bmN0aW9uIGNyZWF0ZVZhbHVlKHZhbHVlKSB7CiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICBlbGVtZW50LmNsYXNzTmFtZSA9ICJsZWdlbmQtdmFsdWUiOwogIGVsZW1lbnQuc3R5bGUubWFyZ2luTGVmdCA9ICIwLjI1cmVtIjsKICBlbGVtZW50LnRleHRDb250ZW50ID0gdmFsdWU7CiAgcmV0dXJuIGVsZW1lbnQ7Cn0KZnVuY3Rpb24gY3JlYXRlTGFiZWwobGFiZWwpIHsKICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogIGVsZW1lbnQuY2xhc3NOYW1lID0gImxlZ2VuZC1sYWJlbCI7CiAgZWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gMC41OwogIGVsZW1lbnQudGV4dENvbnRlbnQgPSBsYWJlbCB8fCAiIjsKICByZXR1cm4gZWxlbWVudDsKfQpmdW5jdGlvbiBjcmVhdGVJY29uKHZpc3VhbENoYW5uZWwsIGVuY29kaW5nLCBlbmNvZGluZ1JhbmdlLCBzaXplUHgsIGZvbnRDb2xvcikgewogIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBlbGVtZW50LmNsYXNzTmFtZSA9ICJsZWdlbmQtaWNvbiI7CiAgZWxlbWVudC5zdHlsZS53aWR0aCA9IGAke3NpemVQeH1weGA7CiAgZWxlbWVudC5zdHlsZS5oZWlnaHQgPSBgJHtzaXplUHh9cHhgOwogIGVsZW1lbnQuc3R5bGUuYm9yZGVyUmFkaXVzID0gYCR7c2l6ZVB4fXB4YDsKICBlbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGByZ2IoJHtmb250Q29sb3J9LCR7Zm9udENvbG9yfSwke2ZvbnRDb2xvcn0pYDsKICBpZiAodmlzdWFsQ2hhbm5lbC5pbmNsdWRlcygiY29sb3IiKSkgewogICAgZWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBBcnJheS5pc0FycmF5KGVuY29kaW5nKSA/IGByZ2IoJHtlbmNvZGluZy5zbGljZSgwLCAzKS5tYXAoKHYpID0+IHYgKiAyNTUpLmpvaW4oIiwiKX0pYCA6IGVuY29kaW5nOwogIH0gZWxzZSBpZiAodmlzdWFsQ2hhbm5lbC5pbmNsdWRlcygib3BhY2l0eSIpKSB7CiAgICBlbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGByZ2JhKCR7Zm9udENvbG9yfSwke2ZvbnRDb2xvcn0sJHtmb250Q29sb3J9LCR7ZW5jb2Rpbmd9KWA7CiAgICBpZiAoZW5jb2RpbmcgPCAwLjIpIHsKICAgICAgZWxlbWVudC5zdHlsZS5ib3hTaGFkb3cgPSBgaW5zZXQgMCAwIDFweCByZ2JhKCR7Zm9udENvbG9yfSwke2ZvbnRDb2xvcn0sJHtmb250Q29sb3J9LDAuNjYpYDsKICAgIH0KICB9IGVsc2UgaWYgKHZpc3VhbENoYW5uZWwuaW5jbHVkZXMoInNpemUiKSkgewogICAgY29uc3QgbWluVmFsdWUgPSBNYXRoLm1pbi5hcHBseShudWxsLCBlbmNvZGluZ1JhbmdlKTsKICAgIGNvbnN0IG1heFZhbHVlID0gTWF0aC5tYXguYXBwbHkobnVsbCwgZW5jb2RpbmdSYW5nZSk7CiAgICBjb25zdCBleHRlbnQgPSBtYXhWYWx1ZSAtIG1pblZhbHVlOwogICAgY29uc3Qgbm9ybUVuY29kaW5nID0gMC4yICsgKGVuY29kaW5nIC0gbWluVmFsdWUpIC8gZXh0ZW50ICogMC44OwogICAgZWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSBgc2NhbGUoJHtub3JtRW5jb2Rpbmd9KWA7CiAgfQogIHJldHVybiBlbGVtZW50Owp9CmZ1bmN0aW9uIGNyZWF0ZUVudHJ5KHZpc3VhbENoYW5uZWwsIHZhbHVlLCBlbmNvZGVkVmFsdWUsIGVuY29kaW5nUmFuZ2UsIHNpemVQeCwgZm9udENvbG9yKSB7CiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIGVsZW1lbnQuY2xhc3NOYW1lID0gImxlZ2VuZC1lbnRyeSI7CiAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogIGVsZW1lbnQuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogIGVsZW1lbnQuYXBwZW5kQ2hpbGQoCiAgICBjcmVhdGVJY29uKHZpc3VhbENoYW5uZWwsIGVuY29kZWRWYWx1ZSwgZW5jb2RpbmdSYW5nZSwgc2l6ZVB4LCBmb250Q29sb3IpCiAgKTsKICBlbGVtZW50LmFwcGVuZENoaWxkKGNyZWF0ZVZhbHVlKHZhbHVlKSk7CiAgcmV0dXJuIGVsZW1lbnQ7Cn0KZnVuY3Rpb24gY3JlYXRlVGl0bGUodmlzdWFsQ2hhbm5lbCwgaXNSaWdodEFsaWduZWQpIHsKICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgZWxlbWVudC5jbGFzc05hbWUgPSAibGVnZW5kLXRpdGxlIjsKICBlbGVtZW50LnN0eWxlLnRleHRUcmFuc2Zvcm0gPSAiY2FwaXRhbGl6ZSI7CiAgZWxlbWVudC5zdHlsZS5mb250V2VpZ2h0ID0gImJvbGQiOwogIGlmIChpc1JpZ2h0QWxpZ25lZCkgewogICAgZWxlbWVudC5zdHlsZS50ZXh0QWxpZ24gPSAicmlnaHQiOwogIH0KICBlbGVtZW50LnRleHRDb250ZW50ID0gdmlzdWFsQ2hhbm5lbC5yZXBsYWNlKCJjb25uZWN0aW9uIiwgImxpbmUiKS5yZXBsYWNlQWxsKCJfIiwgIiAiKTsKICByZXR1cm4gZWxlbWVudDsKfQpmdW5jdGlvbiBjcmVhdGVFbmNvZGluZygpIHsKICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgZWxlbWVudC5jbGFzc05hbWUgPSAibGVnZW5kLWVuY29kaW5nIjsKICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiZ3JpZCI7CiAgZWxlbWVudC5zdHlsZS5ncmlkVGVtcGxhdGVDb2x1bW5zID0gIm1heC1jb250ZW50IG1heC1jb250ZW50IjsKICBlbGVtZW50LnN0eWxlLmdhcCA9ICIwIDAuMnJlbSI7CiAgZWxlbWVudC5zdHlsZS5oZWlnaHQgPSAibWluLWNvbnRlbnQiOwogIHJldHVybiBlbGVtZW50Owp9CmZ1bmN0aW9uIGNyZWF0ZUxlZ2VuZChlbmNvZGluZ3MsIGZvbnRDb2xvciwgYmFja2dyb3VuZENvbG9yLCBzaXplKSB7CiAgY29uc3QgZiA9IGZvbnRDb2xvciA/IGZvbnRDb2xvclswXSAqIDI1NSA6IDA7CiAgY29uc3QgYiA9IGJhY2tncm91bmRDb2xvciA/IGJhY2tncm91bmRDb2xvclswXSAqIDI1NSA6IDI1NTsKICBsZXQgc2l6ZVB4ID0gMTA7CiAgaWYgKHNpemUgPT09ICJtZWRpdW0iKSB7CiAgICBzaXplUHggPSAxMjsKICB9IGVsc2UgaWYgKHNpemUgPT09ICJsYXJnZSIpIHsKICAgIHNpemVQeCA9IDE2OwogIH0KICBjb25zdCByb290MiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIHJvb3QyLmNsYXNzTmFtZSA9ICJsZWdlbmQiOwogIHJvb3QyLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgcm9vdDIuc3R5bGUuZ2FwID0gYCR7c2l6ZVB4fXB4YDsKICByb290Mi5zdHlsZS5tYXJnaW4gPSBgJHtzaXplUHggKiAwLjJ9cHhgOwogIHJvb3QyLnN0eWxlLnBhZGRpbmcgPSBgJHtzaXplUHggKiAwLjI1fXB4YDsKICByb290Mi5zdHlsZS5mb250U2l6ZSA9IGAke3NpemVQeH1weGA7CiAgcm9vdDIuc3R5bGUuYm9yZGVyUmFkaXVzID0gYCR7c2l6ZVB4ICogMC4yNX1weGA7CiAgcm9vdDIuc3R5bGUuY29sb3IgPSBgcmdiKCR7Zn0sJHtmfSwke2Z9KWA7CiAgcm9vdDIuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYHJnYmEoJHtifSwke2J9LCR7Yn0sMC44NSlgOwogIHJvb3QyLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgcm9vdDIuc3R5bGUudXNlclNlbGVjdCA9ICJub25lIjsKICBjb25zdCBzb3J0ZWRFbmNvZGluZ3MgPSBPYmplY3QuZW50cmllcyhlbmNvZGluZ3MpLnNvcnQoCiAgICAoYSwgYjIpID0+IHNvcnRPcmRlclthWzBdXSAtIHNvcnRPcmRlcltiMlswXV0KICApOwogIGZvciAoY29uc3QgZW5jb2RpbmdFbnRyeSBvZiBzb3J0ZWRFbmNvZGluZ3MpIHsKICAgIGNvbnN0IHZpc3VhbENoYW5uZWwgPSBlbmNvZGluZ0VudHJ5WzBdOwogICAgY29uc3QgdmlzdWFsRW5jb2RpbmcgPSBlbmNvZGluZ0VudHJ5WzFdOwogICAgY29uc3QgZW5jb2RpbmcgPSBjcmVhdGVFbmNvZGluZygpOwogICAgZW5jb2RpbmcuYXBwZW5kQ2hpbGQoCiAgICAgIGNyZWF0ZVRpdGxlKHZpc3VhbENoYW5uZWwsIEJvb2xlYW4odmlzdWFsRW5jb2RpbmcudmFyaWFibGUpKQogICAgKTsKICAgIGVuY29kaW5nLmFwcGVuZENoaWxkKGNyZWF0ZUxhYmVsKHZpc3VhbEVuY29kaW5nLnZhcmlhYmxlKSk7CiAgICBjb25zdCB2YWx1ZVJhbmdlID0gWwogICAgICB2aXN1YWxFbmNvZGluZy52YWx1ZXMuYXQoMCkuYXQoMCksCiAgICAgIHZpc3VhbEVuY29kaW5nLnZhbHVlcy5hdCgtMSkuYXQoMCkKICAgIF07CiAgICBjb25zdCBlbmNvZGluZ1JhbmdlID0gWwogICAgICB2aXN1YWxFbmNvZGluZy52YWx1ZXMuYXQoMCkuYXQoMSksCiAgICAgIHZpc3VhbEVuY29kaW5nLnZhbHVlcy5hdCgtMSkuYXQoMSkKICAgIF07CiAgICBjb25zdCBmb3JtYXR0ZXIgPSBjcmVhdGVMYWJlbEZvcm1hdHRlcigKICAgICAgdmFsdWVSYW5nZSwKICAgICAgdmlzdWFsRW5jb2RpbmcuY2F0ZWdvcmljYWwKICAgICk7CiAgICBjb25zdCB2YWx1ZXMgPSB0eXBlb2YgdmlzdWFsRW5jb2RpbmcudmFsdWVzWzBdWzBdID09PSAibnVtYmVyIiA/IFsuLi52aXN1YWxFbmNvZGluZy52YWx1ZXNdLnJldmVyc2UoKSA6IHZpc3VhbEVuY29kaW5nLnZhbHVlczsKICAgIGZvciAoY29uc3QgW3ZhbHVlLCBlbmNvZGVkVmFsdWUsIGxhYmVsXSBvZiB2YWx1ZXMpIHsKICAgICAgZW5jb2RpbmcuYXBwZW5kQ2hpbGQoCiAgICAgICAgY3JlYXRlRW50cnkoCiAgICAgICAgICB2aXN1YWxDaGFubmVsLAogICAgICAgICAgZm9ybWF0dGVyKHZhbHVlKSwKICAgICAgICAgIGVuY29kZWRWYWx1ZSwKICAgICAgICAgIGVuY29kaW5nUmFuZ2UsCiAgICAgICAgICBzaXplUHgsCiAgICAgICAgICBmCiAgICAgICAgKQogICAgICApOwogICAgICBlbmNvZGluZy5hcHBlbmRDaGlsZChjcmVhdGVMYWJlbChsYWJlbCkpOwogICAgfQogICAgcm9vdDIuYXBwZW5kKGVuY29kaW5nKTsKICB9CiAgcmV0dXJuIHJvb3QyOwp9CgovLyBwYWNrYWdlLmpzb24KdmFyIHZlcnNpb24yID0gIjAuMjIuMiI7CgovLyBzcmMvaW5kZXguanMKdmFyIEFYRVNfTEFCRUxfU0laRSA9IDEyOwp2YXIgQVhFU19QQURESU5HX1ggPSA2MDsKdmFyIEFYRVNfUEFERElOR19YX1dJVEhfTEFCRUwgPSBBWEVTX1BBRERJTkdfWCArIEFYRVNfTEFCRUxfU0laRTsKdmFyIEFYRVNfUEFERElOR19ZID0gMjA7CnZhciBBWEVTX1BBRERJTkdfWV9XSVRIX0xBQkVMID0gQVhFU19QQURESU5HX1kgKyBBWEVTX0xBQkVMX1NJWkU7CnZhciBUT09MVElQX0RFQk9VTkNFX1RJTUUgPSA1MDA7CnZhciBUT09MVElQX01BTkRBVE9SWV9WSVNVQUxfUFJPUEVSVElFUyA9ICgKICAvKiogQHR5cGUge2NvbnN0fSAqLwogIHsKICAgIHg6ICJYIiwKICAgIHk6ICJZIgogIH0KKTsKdmFyIFRPT0xUSVBfT1BUSU9OQUxfVklTVUFMX1BST1BFUlRJRVMgPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICBjb2xvcjogIkNvbCIsCiAgICBvcGFjaXR5OiAiT3BhIiwKICAgIHNpemU6ICJTaXplIgogIH0KKTsKdmFyIFRPT0xUSVBfQUxMX1ZJU1VBTF9QUk9QRVJUSUVTID0gKAogIC8qKiBAdHlwZSB7Y29uc3R9ICovCiAgewogICAgLi4uVE9PTFRJUF9NQU5EQVRPUllfVklTVUFMX1BST1BFUlRJRVMsCiAgICAuLi5UT09MVElQX09QVElPTkFMX1ZJU1VBTF9QUk9QRVJUSUVTCiAgfQopOwp2YXIgVE9PTFRJUF9ISVNUT0dSQU1fV0lEVEggPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICBzbWFsbDogIjZlbSIsCiAgICBtZWRpdW06ICIxMGVtIiwKICAgIGxhcmdlOiAiMTRlbSIKICB9Cik7CnZhciBUT09MVElQX0hJU1RPR1JBTV9IRUlHSFQgPSAoCiAgLyoqIEB0eXBlIHtjb25zdH0gKi8KICB7CiAgICBzbWFsbDogIjFlbSIsCiAgICBtZWRpdW06ICIxLjI1ZW0iLAogICAgbGFyZ2U6ICIxLjVlbSIKICB9Cik7CnZhciBUT09MVElQX09GRlNFVF9SRU0gPSAwLjU7CnZhciBwcm9wZXJ0aWVzID0gewogIGFubm90YXRpb25zOiAiYW5ub3RhdGlvbnMiLAogIGJhY2tncm91bmRDb2xvcjogImJhY2tncm91bmRDb2xvciIsCiAgYmFja2dyb3VuZEltYWdlOiAiYmFja2dyb3VuZEltYWdlIiwKICBjYW1lcmFEaXN0YW5jZTogImNhbWVyYURpc3RhbmNlIiwKICBjYW1lcmFSb3RhdGlvbjogImNhbWVyYVJvdGF0aW9uIiwKICBjYW1lcmFUYXJnZXQ6ICJjYW1lcmFUYXJnZXQiLAogIGNhbWVyYVZpZXc6ICJjYW1lcmFWaWV3IiwKICBjYW1lcmFJc0ZpeGVkOiAiY2FtZXJhSXNGaXhlZCIsCiAgY29sb3I6ICJwb2ludENvbG9yIiwKICBjb2xvclNlbGVjdGVkOiAicG9pbnRDb2xvckFjdGl2ZSIsCiAgY29sb3JCeTogImNvbG9yQnkiLAogIGNvbG9ySG92ZXI6ICJwb2ludENvbG9ySG92ZXIiLAogIHdpZHRoOiAid2lkdGgiLAogIGhlaWdodDogImhlaWdodCIsCiAgbGFiZWxzOiAibGFiZWxzIiwKICBsYWJlbFNoYWRvd0NvbG9yOiAibGFiZWxTaGFkb3dDb2xvciIsCiAgbGFiZWxBbGlnbjogImxhYmVsQWxpZ24iLAogIGxhYmVsT2Zmc2V0OiAibGFiZWxPZmZzZXQiLAogIGxhYmVsU2NhbGVGdW5jdGlvbjogImxhYmVsU2NhbGVGdW5jdGlvbiIsCiAgbGFiZWxUaWxlU2l6ZTogImxhYmVsVGlsZVNpemUiLAogIGxhc3NvQ29sb3I6ICJsYXNzb0NvbG9yIiwKICBsYXNzb0luaXRpYXRvcjogImxhc3NvSW5pdGlhdG9yIiwKICBsYXNzb09uTG9uZ1ByZXNzOiAibGFzc29PbkxvbmdQcmVzcyIsCiAgbGFzc29NaW5EZWxheTogImxhc3NvTWluRGVsYXkiLAogIGxhc3NvTWluRGlzdDogImxhc3NvTWluRGlzdCIsCiAgbGFzc29UeXBlOiAibGFzc29UeXBlIiwKICBsYXNzb0JydXNoU2l6ZTogImxhc3NvQnJ1c2hTaXplIiwKICBtb3VzZU1vZGU6ICJtb3VzZU1vZGUiLAogIG9wYWNpdHk6ICJvcGFjaXR5IiwKICBvcGFjaXR5Qnk6ICJvcGFjaXR5QnkiLAogIG9wYWNpdHlVbnNlbGVjdGVkOiAib3BhY2l0eUluYWN0aXZlU2NhbGUiLAogIHJlZ2xTY2F0dGVycGxvdE9wdGlvbnM6ICJyZWdsU2NhdHRlcnBsb3RPcHRpb25zIiwKICBwb2ludHM6ICJwb2ludHMiLAogIHJldGljbGU6ICJzaG93UmV0aWNsZSIsCiAgcmV0aWNsZUNvbG9yOiAicmV0aWNsZUNvbG9yIiwKICBzZWxlY3Rpb246ICJzZWxlY3RlZFBvaW50cyIsCiAgZmlsdGVyOiAiZmlsdGVyZWRQb2ludHMiLAogIHNpemU6ICJwb2ludFNpemUiLAogIHNpemVCeTogInNpemVCeSIsCiAgc2l6ZVNjYWxlRnVuY3Rpb246ICJwb2ludFNjYWxlTW9kZSIsCiAgY29ubmVjdDogInNob3dQb2ludENvbm5lY3Rpb25zIiwKICBjb25uZWN0aW9uQ29sb3I6ICJwb2ludENvbm5lY3Rpb25Db2xvciIsCiAgY29ubmVjdGlvbkNvbG9yU2VsZWN0ZWQ6ICJwb2ludENvbm5lY3Rpb25Db2xvckFjdGl2ZSIsCiAgY29ubmVjdGlvbkNvbG9ySG92ZXI6ICJwb2ludENvbm5lY3Rpb25Db2xvckhvdmVyIiwKICBjb25uZWN0aW9uQ29sb3JCeTogInBvaW50Q29ubmVjdGlvbkNvbG9yQnkiLAogIGNvbm5lY3Rpb25PcGFjaXR5OiAicG9pbnRDb25uZWN0aW9uT3BhY2l0eSIsCiAgY29ubmVjdGlvbk9wYWNpdHlCeTogInBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeSIsCiAgY29ubmVjdGlvblNpemU6ICJwb2ludENvbm5lY3Rpb25TaXplIiwKICBjb25uZWN0aW9uU2l6ZUJ5OiAicG9pbnRDb25uZWN0aW9uU2l6ZUJ5IiwKICB2aWV3U3luYzogInZpZXdTeW5jIiwKICBob3ZlcmluZzogImhvdmVyaW5nIiwKICBheGVzOiAiYXhlcyIsCiAgYXhlc0NvbG9yOiAiYXhlc0NvbG9yIiwKICBheGVzR3JpZDogImF4ZXNHcmlkIiwKICBheGVzTGFiZWxzOiAiYXhlc0xhYmVscyIsCiAgbGVnZW5kOiAibGVnZW5kIiwKICBsZWdlbmRTaXplOiAibGVnZW5kU2l6ZSIsCiAgbGVnZW5kQ29sb3I6ICJsZWdlbmRDb2xvciIsCiAgbGVnZW5kUG9zaXRpb246ICJsZWdlbmRQb3NpdGlvbiIsCiAgbGVnZW5kRW5jb2Rpbmc6ICJsZWdlbmRFbmNvZGluZyIsCiAgdG9vbHRpcEVuYWJsZTogInRvb2x0aXBFbmFibGUiLAogIHRvb2x0aXBTaXplOiAidG9vbHRpcFNpemUiLAogIHRvb2x0aXBDb2xvcjogInRvb2x0aXBDb2xvciIsCiAgdG9vbHRpcFBvc2l0aW9uOiAidG9vbHRpcFBvc2l0aW9uIiwKICB0b29sdGlwUHJvcGVydGllczogInRvb2x0aXBQcm9wZXJ0aWVzIiwKICB0b29sdGlwSGlzdG9ncmFtczogInRvb2x0aXBIaXN0b2dyYW1zIiwKICB0b29sdGlwSGlzdG9ncmFtc1JhbmdlczogInRvb2x0aXBIaXN0b2dyYW1zUmFuZ2VzIiwKICB0b29sdGlwSGlzdG9ncmFtc1NpemU6ICJ0b29sdGlwSGlzdG9ncmFtc1NpemUiLAogIHRvb2x0aXBQcm9wZXJ0aWVzTm9uVmlzdWFsSW5mbzogInRvb2x0aXBQcm9wZXJ0aWVzTm9uVmlzdWFsSW5mbyIsCiAgdG9vbHRpcFByZXZpZXc6ICJ0b29sdGlwUHJldmlldyIsCiAgdG9vbHRpcFByZXZpZXdUeXBlOiAidG9vbHRpcFByZXZpZXdUeXBlIiwKICB0b29sdGlwUHJldmlld1RleHRMaW5lczogInRvb2x0aXBQcmV2aWV3VGV4dExpbmVzIiwKICB0b29sdGlwUHJldmlld1RleHRNYXJrZG93bjogInRvb2x0aXBQcmV2aWV3VGV4dE1hcmtkb3duIiwKICB0b29sdGlwUHJldmlld0ltYWdlUG9zaXRpb246ICJ0b29sdGlwUHJldmlld0ltYWdlUG9zaXRpb24iLAogIHRvb2x0aXBQcmV2aWV3SW1hZ2VTaXplOiAidG9vbHRpcFByZXZpZXdJbWFnZVNpemUiLAogIHRvb2x0aXBQcmV2aWV3SW1hZ2VIZWlnaHQ6ICJ0b29sdGlwUHJldmlld0ltYWdlSGVpZ2h0IiwKICB0b29sdGlwUHJldmlld0F1ZGlvTGVuZ3RoOiAidG9vbHRpcFByZXZpZXdBdWRpb0xlbmd0aCIsCiAgdG9vbHRpcFByZXZpZXdBdWRpb0xvb3A6ICJ0b29sdGlwUHJldmlld0F1ZGlvTG9vcCIsCiAgeFNjYWxlOiAieFNjYWxlIiwKICB5U2NhbGU6ICJ5U2NhbGUiLAogIGNvbG9yU2NhbGU6ICJjb2xvclNjYWxlIiwKICBvcGFjaXR5U2NhbGU6ICJvcGFjaXR5U2NhbGUiLAogIHNpemVTY2FsZTogInNpemVTY2FsZSIsCiAgeERvbWFpbjogInhEb21haW4iLAogIHlEb21haW46ICJ5RG9tYWluIiwKICB4U2NhbGVEb21haW46ICJ4U2NhbGVEb21haW4iLAogIHlTY2FsZURvbWFpbjogInlTY2FsZURvbWFpbiIsCiAgY29sb3JEb21haW46ICJjb2xvckRvbWFpbiIsCiAgb3BhY2l0eURvbWFpbjogIm9wYWNpdHlEb21haW4iLAogIHNpemVEb21haW46ICJzaXplRG9tYWluIiwKICB4SGlzdG9ncmFtOiAieEhpc3RvZ3JhbSIsCiAgeUhpc3RvZ3JhbTogInlIaXN0b2dyYW0iLAogIGNvbG9ySGlzdG9ncmFtOiAiY29sb3JIaXN0b2dyYW0iLAogIG9wYWNpdHlIaXN0b2dyYW06ICJvcGFjaXR5SGlzdG9ncmFtIiwKICBzaXplSGlzdG9ncmFtOiAic2l6ZUhpc3RvZ3JhbSIsCiAgeEhpc3RvZ3JhbVJhbmdlOiAieEhpc3RvZ3JhbVJhbmdlIiwKICB5SGlzdG9ncmFtUmFuZ2U6ICJ5SGlzdG9ncmFtUmFuZ2UiLAogIGNvbG9ySGlzdG9ncmFtUmFuZ2U6ICJjb2xvckhpc3RvZ3JhbVJhbmdlIiwKICBvcGFjaXR5SGlzdG9ncmFtUmFuZ2U6ICJvcGFjaXR5SGlzdG9ncmFtUmFuZ2UiLAogIHNpemVIaXN0b2dyYW1SYW5nZTogInNpemVIaXN0b2dyYW1SYW5nZSIsCiAgeFRpdGxlOiAieFRpdGxlIiwKICB5VGl0bGU6ICJ5VGl0bGUiLAogIGNvbG9yVGl0bGU6ICJjb2xvclRpdGxlIiwKICBvcGFjaXR5VGl0bGU6ICJvcGFjaXR5VGl0bGUiLAogIHNpemVUaXRsZTogInNpemVUaXRsZSIsCiAgem9vbVRvOiAiem9vbVRvIiwKICB6b29tVG9DYWxsSWR4OiAiem9vbVRvQ2FsbElkeCIsCiAgem9vbUFuaW1hdGlvbjogInpvb21BbmltYXRpb24iLAogIHpvb21QYWRkaW5nOiAiem9vbVBhZGRpbmciLAogIHpvb21PblNlbGVjdGlvbjogInpvb21PblNlbGVjdGlvbiIsCiAgem9vbU9uRmlsdGVyOiAiem9vbU9uRmlsdGVyIgp9Owp2YXIgcmVnbFNjYXR0ZXJwbG90UHJvcGVydHkgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbCiAgImJhY2tncm91bmRDb2xvciIsCiAgImJhY2tncm91bmRJbWFnZSIsCiAgImNhbWVyYURpc3RhbmNlIiwKICAiY2FtZXJhUm90YXRpb24iLAogICJjYW1lcmFUYXJnZXQiLAogICJjYW1lcmFWaWV3IiwKICAiY2FtZXJhSXNGaXhlZCIsCiAgInBvaW50Q29sb3IiLAogICJwb2ludENvbG9yQWN0aXZlIiwKICAiY29sb3JCeSIsCiAgInBvaW50Q29sb3JIb3ZlciIsCiAgIndpZHRoIiwKICAiaGVpZ2h0IiwKICAibGFzc29Db2xvciIsCiAgImxhc3NvSW5pdGlhdG9yIiwKICAibGFzc29PbkxvbmdQcmVzcyIsCiAgImxhc3NvTWluRGVsYXkiLAogICJsYXNzb01pbkRpc3QiLAogICJsYXNzb1R5cGUiLAogICJsYXNzb0JydXNoU2l6ZSIsCiAgIm1vdXNlTW9kZSIsCiAgIm9wYWNpdHkiLAogICJvcGFjaXR5QnkiLAogICJvcGFjaXR5SW5hY3RpdmVTY2FsZSIsCiAgInBvaW50cyIsCiAgInNob3dSZXRpY2xlIiwKICAicmV0aWNsZUNvbG9yIiwKICAic2VsZWN0ZWRQb2ludHMiLAogICJmaWx0ZXJlZFBvaW50cyIsCiAgInBvaW50U2l6ZSIsCiAgInNpemVCeSIsCiAgInBvaW50U2NhbGVNb2RlIiwKICAic2hvd1BvaW50Q29ubmVjdGlvbnMiLAogICJwb2ludENvbm5lY3Rpb25Db2xvciIsCiAgInBvaW50Q29ubmVjdGlvbkNvbG9yQWN0aXZlIiwKICAicG9pbnRDb25uZWN0aW9uQ29sb3JIb3ZlciIsCiAgInBvaW50Q29ubmVjdGlvbkNvbG9yQnkiLAogICJwb2ludENvbm5lY3Rpb25PcGFjaXR5IiwKICAicG9pbnRDb25uZWN0aW9uT3BhY2l0eUJ5IiwKICAicG9pbnRDb25uZWN0aW9uU2l6ZSIsCiAgInBvaW50Q29ubmVjdGlvblNpemVCeSIKXSk7CnZhciBKdXB5dGVyU2NhdHRlclZpZXcgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoeyBlbCwgbW9kZWwgfSkgewogICAgdGhpcy5lbCA9IGVsOwogICAgdGhpcy5tb2RlbCA9IG1vZGVsOwogICAgdGhpcy5ldmVudFR5cGVzID0gbW9kZWwuZ2V0KCJldmVudF90eXBlcyIpOwogIH0KICByZW5kZXIoKSB7CiAgICBpZiAoIXdpbmRvdy5qdXB5dGVyU2NhdHRlcikgewogICAgICB3aW5kb3cuanVweXRlclNjYXR0ZXIgPSB7CiAgICAgICAgcmVuZGVyZXI6IGNyZWF0ZVJlbmRlcmVyKCksCiAgICAgICAgdmVyc2lvbkxvZzogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIG9mIE9iamVjdC5rZXlzKHByb3BlcnRpZXMpKSB7CiAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHRoaXMubW9kZWwuZ2V0KGNhbWVsVG9TbmFrZShwcm9wZXJ0eU5hbWUpKTsKICAgIH0KICAgIHRoaXMud2lkdGggPSAhTnVtYmVyLmlzTmFOKCt0aGlzLm1vZGVsLmdldCgid2lkdGgiKSkgJiYgK3RoaXMubW9kZWwuZ2V0KCJ3aWR0aCIpID4gMCA/ICt0aGlzLm1vZGVsLmdldCgid2lkdGgiKSA6ICJhdXRvIjsKICAgIHRoaXMucmFuZG9tU3RyID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDUpICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDUpOwogICAgdGhpcy5tb2RlbC5zZXQoImRvbV9lbGVtZW50X2lkIiwgdGhpcy5yYW5kb21TdHIpOwogICAgdGhpcy5mdWxsc2NyZWVuQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0aGlzLmZ1bGxzY3JlZW5Db250YWluZXIuc2V0QXR0cmlidXRlKCJpZCIsIHRoaXMucmFuZG9tU3RyKTsKICAgIHRoaXMuZnVsbHNjcmVlbkNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB0aGlzLmZ1bGxzY3JlZW5Db250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgIHRoaXMuZnVsbHNjcmVlbkNvbnRhaW5lci5zdHlsZS5mbGV4RGlyZWN0aW9uID0gImNvbHVtbiI7CiAgICB0aGlzLmZ1bGxzY3JlZW5Db250YWluZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAiY2VudGVyIjsKICAgIHRoaXMuZnVsbHNjcmVlbkNvbnRhaW5lci5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgICB0aGlzLmZ1bGxzY3JlZW5Db250YWluZXIuc3R5bGUud2lkdGggPSB0aGlzLndpZHRoID09PSAiYXV0byIgPyAiMTAwJSIgOiBgJHt0aGlzLndpZHRofXB4YDsKICAgIHRoaXMuZnVsbHNjcmVlbkNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBgJHt0aGlzLm1vZGVsLmdldCgiaGVpZ2h0Iil9cHhgOwogICAgdGhpcy5mdWxsc2NyZWVuQ29udGFpbmVyLnN0eWxlLmJhY2tncm91bmQgPSAidmFyKC0tanAtbGF5b3V0LWNvbG9yMCkiOwogICAgdGhpcy5lbC5hcHBlbmRDaGlsZCh0aGlzLmZ1bGxzY3JlZW5Db250YWluZXIpOwogICAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHRoaXMuY29udGFpbmVyLnNldEF0dHJpYnV0ZSgiaWQiLCB0aGlzLnJhbmRvbVN0cik7CiAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS53aWR0aCA9IHRoaXMud2lkdGggPT09ICJhdXRvIiA/ICIxMDAlIiA6IGAke3RoaXMud2lkdGh9cHhgOwogICAgdGhpcy5jb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gYCR7dGhpcy5tb2RlbC5nZXQoImhlaWdodCIpfXB4YDsKICAgIHRoaXMuZnVsbHNjcmVlbkNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmNvbnRhaW5lcik7CiAgICB0aGlzLmNhbnZhc1dyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHRoaXMuY2FudmFzV3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICB0aGlzLmNhbnZhc1dyYXBwZXIuc3R5bGUuaW5zZXQgPSAiMCI7CiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmNhbnZhc1dyYXBwZXIpOwogICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgIHRoaXMuY2FudmFzLnN0eWxlLndpZHRoID0gIjEwMCUiOwogICAgdGhpcy5jYW52YXMuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgdGhpcy5jYW52YXNXcmFwcGVyLmFwcGVuZENoaWxkKHRoaXMuY2FudmFzKTsKICAgIHRoaXMuY2FudmFzTGFiZWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICB0aGlzLmNhbnZhc0xhYmVscy5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICB0aGlzLmNhbnZhc0xhYmVscy5zdHlsZS50b3AgPSAiMCI7CiAgICB0aGlzLmNhbnZhc0xhYmVscy5zdHlsZS5sZWZ0ID0gIjAiOwogICAgdGhpcy5jYW52YXNMYWJlbHMuc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICB0aGlzLmNhbnZhc0xhYmVscy5zdHlsZS5oZWlnaHQgPSAiMTAwJSI7CiAgICB0aGlzLmNhbnZhc0xhYmVscy5zdHlsZS5wb2ludGVyRXZlbnRzID0gIm5vbmUiOwogICAgdGhpcy5jYW52YXNXcmFwcGVyLmFwcGVuZENoaWxkKHRoaXMuY2FudmFzTGFiZWxzKTsKICAgIHRoaXMubGFiZWxSZW5kZXJlciA9IGNyZWF0ZUxhYmVsUmVuZGVyZXIodGhpcy5jYW52YXNMYWJlbHMpOwogICAgdGhpcy5ncmFuZFBhcmVudEVsZW1lbnQgPSB0aGlzLmVsLnBhcmVudEVsZW1lbnQ/LnBhcmVudEVsZW1lbnQ7CiAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50ID0gdGhpcy5ncmFuZFBhcmVudEVsZW1lbnQ/LnBhcmVudEVsZW1lbnQ7CiAgICB0aGlzLmZ1bGxzY3JlZW5CdXR0b25JY29uID0gdGhpcy5ncmFuZFBhcmVudEVsZW1lbnQ/LmNoaWxkcmVuPy5bMF0ucXVlcnlTZWxlY3RvcigKICAgICAgJ1t0aXRsZT0iRnVsbCBTY3JlZW4iXScKICAgICk/LmNoaWxkcmVuPy5bMF0/LmNoaWxkcmVuPy5bMF07CiAgICB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VIYW5kbGVyQm91bmQgPSB0aGlzLmZ1bGxzY3JlZW5DaGFuZ2VIYW5kbGVyLmJpbmQodGhpcyk7CiAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50Py5hZGRFdmVudExpc3RlbmVyKAogICAgICAiZnVsbHNjcmVlbmNoYW5nZSIsCiAgICAgIHRoaXMuZnVsbHNjcmVlbkNoYW5nZUhhbmRsZXJCb3VuZAogICAgKTsKICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICBjb25zdCBpbml0aWFsT3B0aW9ucyA9IHsKICAgICAgICByZW5kZXJlcjogd2luZG93Lmp1cHl0ZXJTY2F0dGVyLnJlbmRlcmVyLAogICAgICAgIGNhbnZhczogdGhpcy5jYW52YXMsCiAgICAgICAgYWN0aW9uS2V5TWFwOiB7IG1lcmdlOiAibWV0YSIsIHJlbW92ZTogImFsdCIgfQogICAgICB9OwogICAgICBpZiAodGhpcy53aWR0aCAhPT0gImF1dG8iKSB7CiAgICAgICAgaW5pdGlhbE9wdGlvbnMud2lkdGggPSB0aGlzLndpZHRoOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgT2JqZWN0LmVudHJpZXMocHJvcGVydGllcykpIHsKICAgICAgICBjb25zdCBweU5hbWUgPSBwcm9wZXJ0eVswXTsKICAgICAgICBjb25zdCBqc05hbWUgPSBwcm9wZXJ0eVsxXTsKICAgICAgICBpZiAodGhpc1tweU5hbWVdICE9PSBudWxsICYmIHJlZ2xTY2F0dGVycGxvdFByb3BlcnR5Lmhhcyhqc05hbWUpKSB7CiAgICAgICAgICBpbml0aWFsT3B0aW9uc1tqc05hbWVdID0gdGhpc1tweU5hbWVdOwogICAgICAgIH0KICAgICAgICBpZiAodGhpc1tweU5hbWVdICE9PSBudWxsICYmIGpzTmFtZSA9PT0gInJlZ2xTY2F0dGVycGxvdE9wdGlvbnMiKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzW3B5TmFtZV0pKSB7CiAgICAgICAgICAgIGluaXRpYWxPcHRpb25zW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaW5pdGlhbE9wdGlvbnMueFNjYWxlID0gbGluZWFyMygpLmRvbWFpbigKICAgICAgICB0aGlzLm1vZGVsLmdldCgieF9zY2FsZV9kb21haW4iKQogICAgICApOwogICAgICBpbml0aWFsT3B0aW9ucy55U2NhbGUgPSBsaW5lYXIzKCkuZG9tYWluKAogICAgICAgIHRoaXMubW9kZWwuZ2V0KCJ5X3NjYWxlX2RvbWFpbiIpCiAgICAgICk7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3QgPSBjcmVhdGVTY2F0dGVycGxvdChpbml0aWFsT3B0aW9ucyk7CiAgICAgIGlmICghd2luZG93Lmp1cHl0ZXJTY2F0dGVyLnZlcnNpb25Mb2cpIHsKICAgICAgICBjb25zb2xlLmluZm8oCiAgICAgICAgICBganVweXRlci1zY2F0dGVyIHYke3ZlcnNpb24yfSB3aXRoIHJlZ2wtc2NhdHRlcnBsb3QgdiR7dGhpcy5zY2F0dGVycGxvdC5nZXQoInZlcnNpb24iKX1gCiAgICAgICAgKTsKICAgICAgICB3aW5kb3cuanVweXRlclNjYXR0ZXIudmVyc2lvbkxvZyA9IHRydWU7CiAgICAgIH0KICAgICAgdGhpcy5jb250YWluZXIuYXBpID0gdGhpcy5zY2F0dGVycGxvdDsKICAgICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJheGVzIikpIHsKICAgICAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICAgICAgfQogICAgICBpZiAodGhpcy5tb2RlbC5nZXQoImF4ZXNfZ3JpZCIpKSB7CiAgICAgICAgdGhpcy5jcmVhdGVBeGVzR3JpZCgpOwogICAgICB9CiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgibGVnZW5kIikpIHsKICAgICAgICB0aGlzLnNob3dMZWdlbmQoKTsKICAgICAgfQogICAgICB0aGlzLnBvaW50b3ZlckhhbmRsZXJCb3VuZCA9IHRoaXMucG9pbnRvdmVySGFuZGxlci5iaW5kKHRoaXMpOwogICAgICB0aGlzLnBvaW50b3V0SGFuZGxlckJvdW5kID0gdGhpcy5wb2ludG91dEhhbmRsZXIuYmluZCh0aGlzKTsKICAgICAgdGhpcy5zZWxlY3RIYW5kbGVyQm91bmQgPSB0aGlzLnNlbGVjdEhhbmRsZXIuYmluZCh0aGlzKTsKICAgICAgdGhpcy5kZXNlbGVjdEhhbmRsZXJCb3VuZCA9IHRoaXMuZGVzZWxlY3RIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgIHRoaXMubGFzc29FbmRIYW5kbGVyQm91bmQgPSB0aGlzLmxhc3NvRW5kSGFuZGxlci5iaW5kKHRoaXMpOwogICAgICB0aGlzLmZpbHRlckV2ZW50SGFuZGxlckJvdW5kID0gdGhpcy5maWx0ZXJFdmVudEhhbmRsZXIuYmluZCh0aGlzKTsKICAgICAgdGhpcy5leHRlcm5hbFZpZXdDaGFuZ2VIYW5kbGVyQm91bmQgPSB0aGlzLmV4dGVybmFsVmlld0NoYW5nZUhhbmRsZXIuYmluZCh0aGlzKTsKICAgICAgdGhpcy52aWV3Q2hhbmdlSGFuZGxlckJvdW5kID0gdGhpcy52aWV3Q2hhbmdlSGFuZGxlci5iaW5kKHRoaXMpOwogICAgICB0aGlzLnJlc2l6ZUhhbmRsZXJCb3VuZCA9IHRoaXMucmVzaXplSGFuZGxlci5iaW5kKHRoaXMpOwogICAgICB0aGlzLmZ1bGxzY3JlZW5GdWxsV2lkdGhIZWlnaHRDaGFuZ2VIYW5kbGVyQm91bmQgPSB0aGlzLmZ1bGxzY3JlZW5GdWxsV2lkdGhIZWlnaHRDaGFuZ2VIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoQ2hhbmdlSGFuZGxlckJvdW5kID0gdGhpcy5mdWxsc2NyZWVuV2lkdGhDaGFuZ2VIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodENoYW5nZUhhbmRsZXJCb3VuZCA9IHRoaXMuZnVsbHNjcmVlbkhlaWdodENoYW5nZUhhbmRsZXIuYmluZCh0aGlzKTsKICAgICAgdGhpcy5mdWxsc2NyZWVuRXhwb3J0U2NhbGVDaGFuZ2VIYW5kbGVyQm91bmQgPSB0aGlzLmZ1bGxzY3JlZW5FeHBvcnRTY2FsZUNoYW5nZUhhbmRsZXIuYmluZCh0aGlzKTsKICAgICAgdGhpcy5mdWxsc2NyZWVuRG93bmxvYWRCb3VuZCA9IHRoaXMuZnVsbHNjcmVlbkRvd25sb2FkLmJpbmQodGhpcyk7CiAgICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoQ2hhbmdlSGFuZGxlckRlYm91bmNlZCA9IGRlYm91bmNlKAogICAgICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoQ2hhbmdlSGFuZGxlckJvdW5kLAogICAgICAgIDUwMAogICAgICApOwogICAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHRDaGFuZ2VIYW5kbGVyRGVib3VuY2VkID0gZGVib3VuY2UoCiAgICAgICAgdGhpcy5mdWxsc2NyZWVuSGVpZ2h0Q2hhbmdlSGFuZGxlckJvdW5kLAogICAgICAgIDUwMAogICAgICApOwogICAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWxUb2dnbGVCb3VuZCA9IHRoaXMuZnVsbHNjcmVlblNpemVQYW5lbFRvZ2dsZS5iaW5kKHRoaXMpOwogICAgICB0aGlzLmRyYXdpbmdIYW5kbGVyQm91bmQgPSB0aGlzLmRyYXdpbmdIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgIHRoaXMudXBkYXRlTGFiZWxUaWxlc0JvdW5kID0gdGhpcy51cGRhdGVMYWJlbFRpbGVzLmJpbmQodGhpcyk7CiAgICAgIHRoaXMudXBkYXRlTGFiZWxUaWxlc0RlYm91bmNlZCA9IHRocm90dGxlQW5kRGVib3VuY2UoCiAgICAgICAgdGhpcy51cGRhdGVMYWJlbFRpbGVzQm91bmQsCiAgICAgICAgMjUwLAogICAgICAgIDI1MAogICAgICApOwogICAgICB0aGlzLnVwZGF0ZVpvb21MZXZlbEJvdW5kID0gdGhpcy51cGRhdGVab29tTGV2ZWwuYmluZCh0aGlzKTsKICAgICAgdGhpcy51cGRhdGVab29tTGV2ZWxEZWJvdW5jZWQgPSB0aHJvdHRsZUFuZERlYm91bmNlKAogICAgICAgIHRoaXMudXBkYXRlWm9vbUxldmVsQm91bmQsCiAgICAgICAgMjUwLAogICAgICAgIDI1MAogICAgICApOwogICAgICB0aGlzLnNjYXR0ZXJwbG90LnN1YnNjcmliZSgicG9pbnRvdmVyIiwgdGhpcy5wb2ludG92ZXJIYW5kbGVyQm91bmQpOwogICAgICB0aGlzLnNjYXR0ZXJwbG90LnN1YnNjcmliZSgicG9pbnRvdXQiLCB0aGlzLnBvaW50b3V0SGFuZGxlckJvdW5kKTsKICAgICAgdGhpcy5zY2F0dGVycGxvdC5zdWJzY3JpYmUoInNlbGVjdCIsIHRoaXMuc2VsZWN0SGFuZGxlckJvdW5kKTsKICAgICAgdGhpcy5zY2F0dGVycGxvdC5zdWJzY3JpYmUoImRlc2VsZWN0IiwgdGhpcy5kZXNlbGVjdEhhbmRsZXJCb3VuZCk7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3Quc3Vic2NyaWJlKCJsYXNzb0VuZCIsIHRoaXMubGFzc29FbmRIYW5kbGVyQm91bmQpOwogICAgICB0aGlzLnNjYXR0ZXJwbG90LnN1YnNjcmliZSgiZmlsdGVyIiwgdGhpcy5maWx0ZXJFdmVudEhhbmRsZXJCb3VuZCk7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3Quc3Vic2NyaWJlKCJ2aWV3IiwgdGhpcy52aWV3Q2hhbmdlSGFuZGxlckJvdW5kKTsKICAgICAgdGhpcy5zY2F0dGVycGxvdC5zdWJzY3JpYmUoImRyYXdpbmciLCB0aGlzLmRyYXdpbmdIYW5kbGVyQm91bmQpOwogICAgICB0aGlzLnZpZXdTeW5jID0gdGhpcy5tb2RlbC5nZXQoInZpZXdfc3luYyIpOwogICAgICB0aGlzLnZpZXdTeW5jSGFuZGxlcih0aGlzLnZpZXdTeW5jKTsKICAgICAgaWYgKCJSZXNpemVPYnNlcnZlciIgaW4gd2luZG93KSB7CiAgICAgICAgdGhpcy5jYW52YXNSZXNpemVPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoKSA9PiB7CiAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgICAgICAgdGhpcy5yZXNpemVIYW5kbGVyQm91bmQoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuY2FudmFzUmVzaXplT2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmNhbnZhcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHRoaXMucmVzaXplSGFuZGxlckJvdW5kKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3JpZW50YXRpb25jaGFuZ2UiLCB0aGlzLnJlc2l6ZUhhbmRsZXJCb3VuZCk7CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgb2YgT2JqZWN0LmtleXMocHJvcGVydGllcykpIHsKICAgICAgICBjb25zdCBoYW5kbGVyID0gdGhpc1tgJHtwcm9wZXJ0eU5hbWV9SGFuZGxlcmBdOwogICAgICAgIGlmICghaGFuZGxlcikgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIHRoaXMubW9kZWwub24oCiAgICAgICAgICBgY2hhbmdlOiR7Y2FtZWxUb1NuYWtlKHByb3BlcnR5TmFtZSl9YCwKICAgICAgICAgICgpID0+IHsKICAgICAgICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gdGhpcy5tb2RlbC5nZXQoY2FtZWxUb1NuYWtlKHByb3BlcnR5TmFtZSkpOwogICAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgdGhpc1twcm9wZXJ0eU5hbWVdKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aGlzCiAgICAgICAgKTsKICAgICAgfQogICAgICB0aGlzLm1vZGVsLm9uKAogICAgICAgICJjaGFuZ2U6cmVnbF9zY2F0dGVycGxvdF9vcHRpb25zIiwKICAgICAgICAoKSA9PiB7CiAgICAgICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLm1vZGVsLmdldCgicmVnbF9zY2F0dGVycGxvdF9vcHRpb25zIik7CiAgICAgICAgICB0aGlzLm9wdGlvbnNIYW5kbGVyLmNhbGwodGhpcywgdGhpcy5vcHRpb25zKTsKICAgICAgICB9LAogICAgICAgIHRoaXMKICAgICAgKTsKICAgICAgdGhpcy5tb2RlbC5vbigKICAgICAgICAibXNnOmN1c3RvbSIsCiAgICAgICAgKGV2ZW50KSA9PiB7CiAgICAgICAgICB0aGlzLmN1c3RvbUV2ZW50SGFuZGxlci5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgICB9LAogICAgICAgIHRoaXMKICAgICAgKTsKICAgICAgdGhpcy5jb2xvckNhbnZhcygpOwogICAgICB0aGlzLmdldE91dGVyRGltZW5zaW9ucygpOwogICAgICB0aGlzLmNyZWF0ZVhTY2FsZSgpOwogICAgICB0aGlzLmNyZWF0ZVlTY2FsZSgpOwogICAgICB0aGlzLmNyZWF0ZUNvbG9yU2NhbGUoKTsKICAgICAgdGhpcy5jcmVhdGVPcGFjaXR5U2NhbGUoKTsKICAgICAgdGhpcy5jcmVhdGVTaXplU2NhbGUoKTsKICAgICAgdGhpcy5jcmVhdGVYR2V0dGVyKCk7CiAgICAgIHRoaXMuY3JlYXRlWUdldHRlcigpOwogICAgICB0aGlzLmNyZWF0ZUNvbG9yR2V0dGVyKCk7CiAgICAgIHRoaXMuY3JlYXRlT3BhY2l0eUdldHRlcigpOwogICAgICB0aGlzLmNyZWF0ZVNpemVHZXR0ZXIoKTsKICAgICAgdGhpcy5jcmVhdGVUb29sdGlwKCk7CiAgICAgIHRoaXMuY2FudmFzTGFiZWxzLndpZHRoID0gdGhpcy5pbm5lcldpZHRoICogd2luZG93LmRldmljZVBpeGVsUmF0aW87CiAgICAgIHRoaXMuY2FudmFzTGFiZWxzLmhlaWdodCA9IHRoaXMuaW5uZXJIZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbzsKICAgICAgdGhpcy5sYWJlbFRpbGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgdGhpcy5jcmVhdGVWaWV3VG9MYWJlbFRpbGVzKCk7CiAgICAgIHRoaXMuc2hvd1Rvb2x0aXBEZWJvdW5jZWQgPSBkZWJvdW5jZSgKICAgICAgICB0aGlzLnNob3dUb29sdGlwLmJpbmQodGhpcyksCiAgICAgICAgVE9PTFRJUF9ERUJPVU5DRV9USU1FCiAgICAgICk7CiAgICAgIGlmICh0aGlzLnBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHt9OwogICAgICAgIGlmICh0aGlzLmZpbHRlcj8ubGVuZ3RoID4gMCkgewogICAgICAgICAgb3B0aW9ucy5maWx0ZXIgPSB0aGlzLmZpbHRlcjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uLmxlbmd0aCA+IDApIHsKICAgICAgICAgIG9wdGlvbnMuc2VsZWN0ID0gdGhpcy5zZWxlY3Rpb247CiAgICAgICAgfQogICAgICAgIHRoaXMuc2NhdHRlcnBsb3QuZHJhdyh0aGlzLnBvaW50cywgb3B0aW9ucykudGhlbigoKSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5hbm5vdGF0aW9ucykgewogICAgICAgICAgICB0aGlzLnNjYXR0ZXJwbG90LmRyYXdBbm5vdGF0aW9ucyh0aGlzLmFubm90YXRpb25zKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmZpbHRlcj8ubGVuZ3RoID4gMCAmJiB0aGlzLm1vZGVsLmdldCgiem9vbV9vbl9maWx0ZXIiKSkgewogICAgICAgICAgICB0aGlzLnpvb21Ub0hhbmRsZXIodGhpcy5maWx0ZXIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uLmxlbmd0aCA+IDAgJiYgdGhpcy5tb2RlbC5nZXQoInpvb21fb25fc2VsZWN0aW9uIikpIHsKICAgICAgICAgICAgdGhpcy56b29tVG9IYW5kbGVyKHRoaXMuc2VsZWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLmxhc3NvU3RhcnRIYW5kbGVyQm91bmQgPSB0aGlzLmxhc3NvU3RhcnRIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgICAgdGhpcy5zY2F0dGVycGxvdC5zdWJzY3JpYmUoImxhc3NvU3RhcnQiLCB0aGlzLmxhc3NvU3RhcnRIYW5kbGVyQm91bmQpOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMubW9kZWwuc2F2ZV9jaGFuZ2VzKCk7CiAgfQogIGN1c3RvbUV2ZW50SGFuZGxlcihldmVudCkgewogICAgaWYgKGV2ZW50LnR5cGUgPT09IHRoaXMuZXZlbnRUeXBlcy5UT09MVElQKSB7CiAgICAgIGlmIChldmVudC5pbmRleCAhPT0gdGhpcy50b29sdGlwUG9pbnRJZHggJiYgZXZlbnQuc2hvdyAhPT0gdHJ1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRvb2x0aXBEYXRhSGFuZGxlcnMoZXZlbnQpOwogICAgICBpZiAoZXZlbnQuc2hvdykgewogICAgICAgIHRoaXMuc2hvd1Rvb2x0aXAoZXZlbnQuaW5kZXgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChldmVudC50eXBlID09PSB0aGlzLmV2ZW50VHlwZXMuVklFV19ET1dOTE9BRCkgewogICAgICB0aGlzLnZpZXdEb3dubG9hZCh7CiAgICAgICAgdHJhbnNwYXJlbnRCYWNrZ3JvdW5kQ29sb3I6IGV2ZW50LnRyYW5zcGFyZW50QmFja2dyb3VuZENvbG9yCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnQudHlwZSA9PT0gdGhpcy5ldmVudFR5cGVzLlZJRVdfUkVTRVQpIHsKICAgICAgaWYgKCF0aGlzLnNjYXR0ZXJwbG90KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChldmVudC5hcmVhKSB7CiAgICAgICAgdGhpcy5zY2F0dGVycGxvdC56b29tVG9BcmVhKGV2ZW50LmFyZWEsIHsKICAgICAgICAgIHRyYW5zaXRpb246IGV2ZW50LmFuaW1hdGlvbiA+IDAsCiAgICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb246IGV2ZW50LmFuaW1hdGlvbiwKICAgICAgICAgIHRyYW5zaXRpb25FYXNpbmc6ICJxdWFkSW5PdXQiCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zY2F0dGVycGxvdC56b29tVG9PcmlnaW4oewogICAgICAgICAgdHJhbnNpdGlvbjogZXZlbnQuYW5pbWF0aW9uID4gMCwKICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogZXZlbnQuYW5pbWF0aW9uLAogICAgICAgICAgdHJhbnNpdGlvbkVhc2luZzogInF1YWRJbk91dCIKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnQudHlwZSA9PT0gdGhpcy5ldmVudFR5cGVzLlZJRVdfU0FWRSkgewogICAgICB0aGlzLnZpZXdTYXZlKGV2ZW50LnRyYW5zcGFyZW50QmFja2dyb3VuZENvbG9yKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGV2ZW50LnR5cGUgPT09IHRoaXMuZXZlbnRUeXBlcy5GVUxMX1NDUkVFTikgewogICAgICB0aGlzLnRvZ2dsZUZ1bGxzY3JlZW4oKTsKICAgICAgcmV0dXJuOwogICAgfQogIH0KICBsYXNzb1N0YXJ0SGFuZGxlcigpIHsKICAgIHRoaXMuaGlkZVRvb2x0aXAoKTsKICB9CiAgZ2V0V2lkdGgoKSB7CiAgICBpZiAoZG9jdW1lbnQuZnVsbHNjcmVlbkVsZW1lbnQpIHsKICAgICAgaWYgKHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodCkgewogICAgICAgIHJldHVybiAiYXV0byI7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZnVsbHNjcmVlbldpZHRoOwogICAgfQogICAgcmV0dXJuIHRoaXMubW9kZWwuZ2V0KCJ3aWR0aCIpOwogIH0KICBnZXRIZWlnaHQoKSB7CiAgICBpZiAoZG9jdW1lbnQuZnVsbHNjcmVlbkVsZW1lbnQpIHsKICAgICAgaWYgKHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodCkgewogICAgICAgIHJldHVybiAiYXV0byI7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZnVsbHNjcmVlbkhlaWdodDsKICAgIH0KICAgIHJldHVybiB0aGlzLm1vZGVsLmdldCgiaGVpZ2h0Iik7CiAgfQogIGdldE91dGVyRGltZW5zaW9ucygpIHsKICAgIGxldCB4UGFkZGluZyA9IDA7CiAgICBsZXQgeVBhZGRpbmcgPSAwOwogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJheGVzIikpIHsKICAgICAgeFBhZGRpbmcgPSB0aGlzLmdldFhQYWRkaW5nKCk7CiAgICAgIHlQYWRkaW5nID0gdGhpcy5nZXRZUGFkZGluZygpOwogICAgfQogICAgY29uc3QgYkJveCA9IHRoaXMuY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgY29uc3Qgd2lkdGggPSB0aGlzLmdldFdpZHRoKCk7CiAgICBjb25zdCBvdXRlcldpZHRoID0gd2lkdGggPT09ICJhdXRvIiA/IGJCb3gud2lkdGggOiB3aWR0aCArIHhQYWRkaW5nOwogICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5nZXRIZWlnaHQoKTsKICAgIGNvbnN0IG91dGVySGVpZ2h0ID0gaGVpZ2h0ID09PSAiYXV0byIgPyBiQm94LmhlaWdodCA6IGhlaWdodCArIHlQYWRkaW5nOwogICAgdGhpcy5pbm5lcldpZHRoID0gTWF0aC5tYXgoMSwgb3V0ZXJXaWR0aCAtIHhQYWRkaW5nKTsKICAgIHRoaXMuaW5uZXJIZWlnaHQgPSBNYXRoLm1heCgxLCBvdXRlckhlaWdodCAtIHlQYWRkaW5nKTsKICAgIHRoaXMub3V0ZXJXaWR0aCA9IE1hdGgubWF4KDEsIG91dGVyV2lkdGgpOwogICAgdGhpcy5vdXRlckhlaWdodCA9IE1hdGgubWF4KDEsIG91dGVySGVpZ2h0KTsKICAgIHJldHVybiBbdGhpcy5vdXRlcldpZHRoLCB0aGlzLm91dGVySGVpZ2h0XTsKICB9CiAgY3JlYXRlQXhlcygpIHsKICAgIHRoaXMuYXhlc1N2ZyA9IHNlbGVjdF9kZWZhdWx0Mih0aGlzLmNvbnRhaW5lcikuc2VsZWN0KCJzdmciKS5ub2RlKCkgPyBzZWxlY3RfZGVmYXVsdDIodGhpcy5jb250YWluZXIpLnNlbGVjdCgic3ZnIikgOiBzZWxlY3RfZGVmYXVsdDIodGhpcy5jb250YWluZXIpLmFwcGVuZCgic3ZnIik7CiAgICB0aGlzLmF4ZXNTdmcuc3R5bGUoInRvcCIsIDApOwogICAgdGhpcy5heGVzU3ZnLnN0eWxlKCJsZWZ0IiwgMCk7CiAgICB0aGlzLmF4ZXNTdmcuc3R5bGUoIndpZHRoIiwgIjEwMCUiKTsKICAgIHRoaXMuYXhlc1N2Zy5zdHlsZSgiaGVpZ2h0IiwgIjEwMCUiKTsKICAgIHRoaXMuYXhlc1N2Zy5zdHlsZSgicG9pbnRlci1ldmVudHMiLCAibm9uZSIpOwogICAgdGhpcy5heGVzU3ZnLnN0eWxlKCJ1c2VyLXNlbGVjdCIsICJub25lIik7CiAgICBjb25zdCBjb2xvcjIgPSB0aGlzLm1vZGVsLmdldCgiYXhlc19jb2xvciIpLm1hcCgoYykgPT4gTWF0aC5yb3VuZChjICogMjU1KSk7CiAgICB0aGlzLmF4ZXNTdmcuc3R5bGUoCiAgICAgICJjb2xvciIsCiAgICAgIGByZ2JhKCR7Y29sb3IyWzBdfSwgJHtjb2xvcjJbMV19LCAke2NvbG9yMlsyXX0sIDEpYAogICAgKTsKICAgIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuZ2V0T3V0ZXJEaW1lbnNpb25zKCk7CiAgICBjb25zdCBjdXJyZW50WFNjYWxlUmVnbCA9IHRoaXMuc2NhdHRlcnBsb3QuZ2V0KCJ4U2NhbGUiKTsKICAgIGNvbnN0IGN1cnJlbnRZU2NhbGVSZWdsID0gdGhpcy5zY2F0dGVycGxvdC5nZXQoInlTY2FsZSIpOwogICAgY29uc3QgW3hMYWJlbCwgeUxhYmVsXSA9IHRoaXMubW9kZWwuZ2V0KCJheGVzX2xhYmVscyIpIHx8IFtdOwogICAgY29uc3QgeFBhZGRpbmcgPSB0aGlzLmdldFhQYWRkaW5nKCk7CiAgICBjb25zdCB5UGFkZGluZyA9IHRoaXMuZ2V0WVBhZGRpbmcoKTsKICAgIGNvbnN0IHhTY2FsZURvbWFpbiA9IHRoaXMubW9kZWwuZ2V0KCJ4X3NjYWxlX2RvbWFpbiIpOwogICAgdGhpcy54U2NhbGVSZWdsID0gbGluZWFyMygpLmRvbWFpbih4U2NhbGVEb21haW4pLnJhbmdlKFswLCB3aWR0aCAtIHhQYWRkaW5nXSk7CiAgICB0aGlzLnhTY2FsZUF4aXMgPSBnZXRTY2FsZSh0aGlzLm1vZGVsLmdldCgieF9zY2FsZSIpKS5kb21haW4oeFNjYWxlRG9tYWluKS5yYW5nZShbMCwgd2lkdGggLSB4UGFkZGluZ10pOwogICAgdGhpcy54U2NhbGVSZWdsMkF4aXMgPSBnZXRTY2FsZSh0aGlzLm1vZGVsLmdldCgieF9zY2FsZSIpKS5kb21haW4oeFNjYWxlRG9tYWluKS5yYW5nZSh4U2NhbGVEb21haW4pOwogICAgY29uc3QgeVNjYWxlRG9tYWluID0gdGhpcy5tb2RlbC5nZXQoInlfc2NhbGVfZG9tYWluIik7CiAgICB0aGlzLnlTY2FsZVJlZ2wgPSBsaW5lYXIzKCkuZG9tYWluKHlTY2FsZURvbWFpbikucmFuZ2UoW2hlaWdodCAtIHlQYWRkaW5nLCAwXSk7CiAgICB0aGlzLnlTY2FsZUF4aXMgPSBnZXRTY2FsZSh0aGlzLm1vZGVsLmdldCgieV9zY2FsZSIpKS5kb21haW4oeVNjYWxlRG9tYWluKS5yYW5nZShbaGVpZ2h0IC0geVBhZGRpbmcsIDBdKTsKICAgIHRoaXMueVNjYWxlUmVnbDJBeGlzID0gZ2V0U2NhbGUodGhpcy5tb2RlbC5nZXQoInlfc2NhbGUiKSkuZG9tYWluKHlTY2FsZURvbWFpbikucmFuZ2UoeVNjYWxlRG9tYWluKTsKICAgIGlmIChjdXJyZW50WFNjYWxlUmVnbCkgewogICAgICB0aGlzLnhTY2FsZUF4aXMuZG9tYWluKAogICAgICAgIGN1cnJlbnRYU2NhbGVSZWdsLmRvbWFpbigpLm1hcCh0aGlzLnhTY2FsZVJlZ2wyQXhpcy5pbnZlcnQpCiAgICAgICk7CiAgICB9CiAgICBpZiAoY3VycmVudFlTY2FsZVJlZ2wpIHsKICAgICAgdGhpcy55U2NhbGVBeGlzLmRvbWFpbigKICAgICAgICBjdXJyZW50WVNjYWxlUmVnbC5kb21haW4oKS5tYXAodGhpcy55U2NhbGVSZWdsMkF4aXMuaW52ZXJ0KQogICAgICApOwogICAgfQogICAgdGhpcy54QXhpcyA9IGF4aXNCb3R0b20odGhpcy54U2NhbGVBeGlzKTsKICAgIHRoaXMueUF4aXMgPSBheGlzUmlnaHQodGhpcy55U2NhbGVBeGlzKTsKICAgIHRoaXMueEF4aXNDb250YWluZXIgPSB0aGlzLmF4ZXNTdmcuc2VsZWN0KCIueC1heGlzIikubm9kZSgpID8gdGhpcy5heGVzU3ZnLnNlbGVjdCgiLngtYXhpcyIpIDogdGhpcy5heGVzU3ZnLmFwcGVuZCgiZyIpLmF0dHIoImNsYXNzIiwgIngtYXhpcyIpOwogICAgdGhpcy54QXhpc0NvbnRhaW5lci5hdHRyKCJ0cmFuc2Zvcm0iLCBgdHJhbnNsYXRlKDAsICR7aGVpZ2h0IC0geVBhZGRpbmd9KWApLmNhbGwodGhpcy54QXhpcyk7CiAgICB0aGlzLnlBeGlzQ29udGFpbmVyID0gdGhpcy5heGVzU3ZnLnNlbGVjdCgiLnktYXhpcyIpLm5vZGUoKSA/IHRoaXMuYXhlc1N2Zy5zZWxlY3QoIi55LWF4aXMiKSA6IHRoaXMuYXhlc1N2Zy5hcHBlbmQoImciKS5hdHRyKCJjbGFzcyIsICJ5LWF4aXMiKTsKICAgIHRoaXMueUF4aXNDb250YWluZXIuYXR0cigidHJhbnNmb3JtIiwgYHRyYW5zbGF0ZSgke3dpZHRoIC0geFBhZGRpbmd9LCAwKWApLmNhbGwodGhpcy55QXhpcyk7CiAgICB0aGlzLmF4ZXNTdmcuc2VsZWN0QWxsKCIuZG9tYWluIikuYXR0cigib3BhY2l0eSIsIDApOwogICAgaWYgKHhMYWJlbCkgewogICAgICB0aGlzLnhBeGlzTGFiZWwgPSB0aGlzLmF4ZXNTdmcuc2VsZWN0KCIueC1heGlzLWxhYmVsIikubm9kZSgpID8gdGhpcy5heGVzU3ZnLnNlbGVjdCgiLngtYXhpcy1sYWJlbCIpIDogdGhpcy5heGVzU3ZnLmFwcGVuZCgidGV4dCIpLmF0dHIoImNsYXNzIiwgIngtYXhpcy1sYWJlbCIpOwogICAgICB0aGlzLnhBeGlzTGFiZWwudGV4dCh4TGFiZWwpLmF0dHIoImZpbGwiLCAiY3VycmVudENvbG9yIikuYXR0cigidGV4dC1hbmNob3IiLCAibWlkZGxlIikuYXR0cigiZm9udC1zaXplIiwgIjEycHgiKS5hdHRyKCJmb250LXdlaWdodCIsICJib2xkIikuYXR0cigieCIsICh3aWR0aCAtIHhQYWRkaW5nKSAvIDIpLmF0dHIoInkiLCBoZWlnaHQpOwogICAgfQogICAgaWYgKHlMYWJlbCkgewogICAgICB0aGlzLnlBeGlzTGFiZWwgPSB0aGlzLmF4ZXNTdmcuc2VsZWN0KCIueS1heGlzLWxhYmVsIikubm9kZSgpID8gdGhpcy5heGVzU3ZnLnNlbGVjdCgiLnktYXhpcy1sYWJlbCIpIDogdGhpcy5heGVzU3ZnLmFwcGVuZCgidGV4dCIpLmF0dHIoImNsYXNzIiwgInktYXhpcy1sYWJlbCIpOwogICAgICB0aGlzLnlBeGlzTGFiZWwudGV4dCh5TGFiZWwpLmF0dHIoImZpbGwiLCAiY3VycmVudENvbG9yIikuYXR0cigidGV4dC1hbmNob3IiLCAibWlkZGxlIikuYXR0cigiZG9taW5hbnQtYmFzZWxpbmUiLCAiaGFuZ2luZyIpLmF0dHIoIngiLCAoaGVpZ2h0IC0geVBhZGRpbmcpIC8gMikuYXR0cigieSIsIC13aWR0aCkuYXR0cigiZm9udC1zaXplIiwgIjEycHgiKS5hdHRyKCJmb250LXdlaWdodCIsICJib2xkIikuYXR0cigidHJhbnNmb3JtIiwgInJvdGF0ZSg5MCkiKTsKICAgIH0KICAgIHRoaXMudXBkYXRlQ29udGFpbmVyRGltZW5zaW9ucygpOwogICAgdGhpcy5zY2F0dGVycGxvdC5zZXQoewogICAgICB4U2NhbGU6IHRoaXMueFNjYWxlUmVnbCwKICAgICAgeVNjYWxlOiB0aGlzLnlTY2FsZVJlZ2wKICAgIH0pOwogICAgdGhpcy5jYW52YXNXcmFwcGVyLnN0eWxlLnJpZ2h0ID0gYCR7eFBhZGRpbmd9cHhgOwogICAgdGhpcy5jYW52YXNXcmFwcGVyLnN0eWxlLmJvdHRvbSA9IGAke3lQYWRkaW5nfXB4YDsKICAgIGlmICh0aGlzLm1vZGVsLmdldCgiYXhlc19ncmlkIikpIHsKICAgICAgdGhpcy5jcmVhdGVBeGVzR3JpZCgpOwogICAgfQogICAgdGhpcy51cGRhdGVMZWdlbmRXcmFwcGVyUG9zaXRpb24oKTsKICAgIHRoaXMudXBkYXRlQXhlcyh0aGlzLnhTY2FsZVJlZ2wuZG9tYWluKCksIHRoaXMueVNjYWxlUmVnbC5kb21haW4oKSk7CiAgfQogIHJlbW92ZUF4ZXMoKSB7CiAgICB0aGlzLmF4ZXNTdmcubm9kZSgpLnJlbW92ZSgpOwogICAgdGhpcy5heGVzU3ZnID0gdm9pZCAwOwogICAgdGhpcy54QXhpcyA9IHZvaWQgMDsKICAgIHRoaXMueUF4aXMgPSB2b2lkIDA7CiAgICB0aGlzLnhBeGlzQ29udGFpbmVyID0gdm9pZCAwOwogICAgdGhpcy55QXhpc0NvbnRhaW5lciA9IHZvaWQgMDsKICAgIHRoaXMueEF4aXNDb250YWluZXIgPSB2b2lkIDA7CiAgICB0aGlzLnhBeGlzTGFiZWwgPSB2b2lkIDA7CiAgICB0aGlzLnlBeGlzTGFiZWwgPSB2b2lkIDA7CiAgICB0aGlzLmNhbnZhc1dyYXBwZXIuc3R5bGUudG9wID0gIjAiOwogICAgdGhpcy5jYW52YXNXcmFwcGVyLnN0eWxlLmxlZnQgPSAiMCI7CiAgICB0aGlzLmNhbnZhc1dyYXBwZXIuc3R5bGUucmlnaHQgPSAiMCI7CiAgICB0aGlzLmNhbnZhc1dyYXBwZXIuc3R5bGUuYm90dG9tID0gIjAiOwogICAgdGhpcy51cGRhdGVDb250YWluZXJEaW1lbnNpb25zKCk7CiAgICB0aGlzLnNjYXR0ZXJwbG90LnNldCh7CiAgICAgIHhTY2FsZTogdm9pZCAwLAogICAgICB5U2NhbGU6IHZvaWQgMAogICAgfSk7CiAgfQogIGNyZWF0ZUF4ZXNHcmlkKCkgewogICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLmNhbnZhc1dyYXBwZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBpZiAodGhpcy54QXhpcykgewogICAgICB0aGlzLnhBeGlzLnRpY2tTaXplSW5uZXIoLWhlaWdodCk7CiAgICAgIHRoaXMueEF4aXNDb250YWluZXIuY2FsbCh0aGlzLnhBeGlzKTsKICAgIH0KICAgIGlmICh0aGlzLnlBeGlzKSB7CiAgICAgIHRoaXMueUF4aXMudGlja1NpemVJbm5lcigtd2lkdGgpOwogICAgICB0aGlzLnlBeGlzQ29udGFpbmVyLmNhbGwodGhpcy55QXhpcyk7CiAgICB9CiAgICBpZiAodGhpcy5heGVzU3ZnKSB7CiAgICAgIHRoaXMuYXhlc1N2Zy5zZWxlY3RBbGwoImxpbmUiKS5hdHRyKCJzdHJva2Utb3BhY2l0eSIsIDAuMikuYXR0cigic3Ryb2tlLWRhc2hhcnJheSIsIDIpOwogICAgfQogIH0KICByZW1vdmVBeGVzR3JpZCgpIHsKICAgIGlmICh0aGlzLnhBeGlzKSB7CiAgICAgIHRoaXMueEF4aXMudGlja1NpemVJbm5lcig2KTsKICAgICAgdGhpcy54QXhpc0NvbnRhaW5lci5jYWxsKHRoaXMueEF4aXMpOwogICAgfQogICAgaWYgKHRoaXMueUF4aXMpIHsKICAgICAgdGhpcy55QXhpcy50aWNrU2l6ZUlubmVyKDYpOwogICAgICB0aGlzLnlBeGlzQ29udGFpbmVyLmNhbGwodGhpcy55QXhpcyk7CiAgICB9CiAgICBpZiAodGhpcy5heGVzU3ZnKSB7CiAgICAgIHRoaXMuYXhlc1N2Zy5zZWxlY3RBbGwoImxpbmUiKS5hdHRyKCJzdHJva2Utb3BhY2l0eSIsIG51bGwpLmF0dHIoInN0cm9rZS1kYXNoYXJyYXkiLCBudWxsKTsKICAgIH0KICB9CiAgc2hvd0xlZ2VuZCgpIHsKICAgIHRoaXMuaGlkZUxlZ2VuZCgpOwogICAgdGhpcy5sZWdlbmRXcmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0aGlzLmxlZ2VuZFdyYXBwZXIuY2xhc3NOYW1lID0gImxlZ2VuZC13cmFwcGVyIjsKICAgIHRoaXMubGVnZW5kV3JhcHBlci5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICB0aGlzLmxlZ2VuZFdyYXBwZXIuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJub25lIjsKICAgIHRoaXMudXBkYXRlTGVnZW5kV3JhcHBlclBvc2l0aW9uKCk7CiAgICB0aGlzLmxlZ2VuZCA9IGNyZWF0ZUxlZ2VuZCgKICAgICAgdGhpcy5tb2RlbC5nZXQoImxlZ2VuZF9lbmNvZGluZyIpLAogICAgICB0aGlzLm1vZGVsLmdldCgibGVnZW5kX2NvbG9yIiksCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJiYWNrZ3JvdW5kX2NvbG9yIiksCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJsZWdlbmRfc2l6ZSIpCiAgICApOwogICAgdGhpcy51cGRhdGVMZWdlbmRQb3NpdGlvbigpOwogICAgdGhpcy5sZWdlbmRXcmFwcGVyLmFwcGVuZENoaWxkKHRoaXMubGVnZW5kKTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMubGVnZW5kV3JhcHBlcik7CiAgfQogIGhpZGVMZWdlbmQoKSB7CiAgICBpZiAoIXRoaXMubGVnZW5kV3JhcHBlcikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzLmxlZ2VuZFdyYXBwZXIpOwogICAgdGhpcy5sZWdlbmRXcmFwcGVyID0gdm9pZCAwOwogICAgdGhpcy5sZWdlbmQgPSB2b2lkIDA7CiAgfQogIGNyZWF0ZVRvb2x0aXBQcmV2aWV3RG9tRWxlbWVudHMoKSB7CiAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KAogICAgICB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcmV2aWV3X3R5cGUiKSA9PT0gImF1ZGlvIiA/ICJhdWRpbyIgOiAiZGl2IgogICAgKTsKICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZUhlbHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy50b29sdGlwUHJldmlld0JvcmRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZUhlbHBlcik7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJldmlldy5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUpOwogICAgdGhpcy50b29sdGlwQ29udGVudFByZXZpZXcuYXBwZW5kQ2hpbGQodGhpcy50b29sdGlwUHJldmlld0JvcmRlcik7CiAgfQogIGNyZWF0ZVRvb2x0aXBQcm9wZXJ0eURvbUVsZW1lbnRzKHByb3BlcnR5KSB7CiAgICBjb25zdCBjYXBpdGFsUHJvcGVydHkgPSB0b0NhcGl0YWxDYXNlKHByb3BlcnR5KTsKICAgIGNvbnN0IGh0bWxDbGFzc1Byb3BlcnR5ID0gdG9IdG1sQ2xhc3MocHJvcGVydHkpOwogICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9VGl0bGVgXSA9IGNyZWF0ZUVsZW1lbnRXaXRoQ2xhc3MoCiAgICAgICJkaXYiLAogICAgICBbInRpdGxlIiwgYCR7aHRtbENsYXNzUHJvcGVydHl9LXRpdGxlYF0KICAgICk7CiAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1WYWx1ZWBdID0gY3JlYXRlRWxlbWVudFdpdGhDbGFzcygKICAgICAgImRpdiIsCiAgICAgIFsidmFsdWUiLCBgJHtodG1sQ2xhc3NQcm9wZXJ0eX0tdmFsdWVgXQogICAgKTsKICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fVZhbHVlVGV4dGBdID0gY3JlYXRlRWxlbWVudFdpdGhDbGFzcygKICAgICAgImRpdiIsCiAgICAgIFsidmFsdWUtdGV4dCIsIGAke2h0bWxDbGFzc1Byb3BlcnR5fS12YWx1ZS10ZXh0YF0KICAgICk7CiAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1DaGFubmVsYF0gPSBjcmVhdGVFbGVtZW50V2l0aENsYXNzKAogICAgICAiZGl2IiwKICAgICAgWyJjaGFubmVsIiwgYCR7aHRtbENsYXNzUHJvcGVydHl9LWNoYW5uZWxgXQogICAgKTsKICAgIGlmIChwcm9wZXJ0eSBpbiBUT09MVElQX0FMTF9WSVNVQUxfUFJPUEVSVElFUykgewogICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1DaGFubmVsTmFtZWBdID0gY3JlYXRlRWxlbWVudFdpdGhDbGFzcygiZGl2IiwgWwogICAgICAgICJjaGFubmVsLW5hbWUiLAogICAgICAgIGAke2h0bWxDbGFzc1Byb3BlcnR5fS1jaGFubmVsLW5hbWVgCiAgICAgIF0pOwogICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1DaGFubmVsTmFtZWBdLnRleHRDb250ZW50ID0gVE9PTFRJUF9BTExfVklTVUFMX1BST1BFUlRJRVNbcHJvcGVydHldOwogICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1DaGFubmVsYF0uYXBwZW5kQ2hpbGQoCiAgICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9Q2hhbm5lbE5hbWVgXQogICAgICApOwogICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1DaGFubmVsQmFkZ2VgXSA9IGNyZWF0ZUVsZW1lbnRXaXRoQ2xhc3MoImRpdiIsIFsKICAgICAgICAiY2hhbm5lbC1iYWRnZSIsCiAgICAgICAgYCR7aHRtbENsYXNzUHJvcGVydHl9LWNoYW5uZWwtYmFkZ2VgCiAgICAgIF0pOwogICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1DaGFubmVsQmFkZ2VNYXJrYF0gPSBjcmVhdGVFbGVtZW50V2l0aENsYXNzKCJkaXYiLCBbCiAgICAgICAgImNoYW5uZWwtYmFkZ2UtbWFyayIsCiAgICAgICAgYCR7aHRtbENsYXNzUHJvcGVydHl9LWNoYW5uZWwtYmFkZ2UtbWFya2AKICAgICAgXSk7CiAgICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fUNoYW5uZWxCYWRnZUJnYF0gPSBjcmVhdGVFbGVtZW50V2l0aENsYXNzKCJkaXYiLCBbCiAgICAgICAgImNoYW5uZWwtYmFkZ2UtYmciLAogICAgICAgIGAke2h0bWxDbGFzc1Byb3BlcnR5fS1jaGFubmVsLWJhZGdlLWJnYAogICAgICBdKTsKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9Q2hhbm5lbEJhZGdlYF0uYXBwZW5kQ2hpbGQoCiAgICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9Q2hhbm5lbEJhZGdlTWFya2BdCiAgICAgICk7CiAgICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fUNoYW5uZWxCYWRnZWBdLmFwcGVuZENoaWxkKAogICAgICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fUNoYW5uZWxCYWRnZUJnYF0KICAgICAgKTsKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9Q2hhbm5lbGBdLmFwcGVuZENoaWxkKAogICAgICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fUNoYW5uZWxCYWRnZWBdCiAgICAgICk7CiAgICB9CiAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1WYWx1ZWBdLmFwcGVuZENoaWxkKAogICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1WYWx1ZVRleHRgXQogICAgKTsKICAgIGlmICh0aGlzLnNob3dIaXN0b2dyYW0ocHJvcGVydHkpKSB7CiAgICAgIGNvbnN0IGhpc3RvZ3JhbSA9IHRoaXMubW9kZWwuZ2V0KGAke3Byb3BlcnR5fV9oaXN0b2dyYW1gKSB8fCB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcm9wZXJ0aWVzX25vbl92aXN1YWxfaW5mbyIpW3Byb3BlcnR5XT8uaGlzdG9ncmFtOwogICAgICBjb25zdCBzY2FsZSA9IHRoaXMubW9kZWwuZ2V0KGAke3Byb3BlcnR5fV9zY2FsZWApIHx8IHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX3Byb3BlcnRpZXNfbm9uX3Zpc3VhbF9pbmZvIilbcHJvcGVydHldPy5zY2FsZTsKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9VmFsdWVIaXN0b2dyYW1gXSA9IGNyZWF0ZUhpc3RvZ3JhbSgKICAgICAgICBUT09MVElQX0hJU1RPR1JBTV9XSURUSFt0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9oaXN0b2dyYW1zX3NpemUiKV0gfHwgVE9PTFRJUF9ISVNUT0dSQU1fV0lEVEguc21hbGwsCiAgICAgICAgVE9PTFRJUF9ISVNUT0dSQU1fSEVJR0hUW3RoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX2hpc3RvZ3JhbXNfc2l6ZSIpXSB8fCBUT09MVElQX0hJU1RPR1JBTV9IRUlHSFQuc21hbGwKICAgICAgKTsKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9VmFsdWVgXS5hcHBlbmRDaGlsZCgKICAgICAgICB0aGlzW2B0b29sdGlwUHJvcGVydHkke2NhcGl0YWxQcm9wZXJ0eX1WYWx1ZUhpc3RvZ3JhbWBdLmVsZW1lbnQKICAgICAgKTsKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9VmFsdWVIaXN0b2dyYW1gXS5pbml0KAogICAgICAgIGhpc3RvZ3JhbSwKICAgICAgICBzY2FsZSA9PT0gImNhdGVnb3JpY2FsIgogICAgICApOwogICAgfQogICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9VmFsdWVUZXh0YF0uY2xhc3NMaXN0LnRvZ2dsZSgKICAgICAgInZhbHVlLW9ubHkiLAogICAgICAhdGhpcy5zaG93SGlzdG9ncmFtKHByb3BlcnR5KQogICAgKTsKICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fVRpdGxlYF0udGV4dENvbnRlbnQgPSB0b1RpdGxlQ2FzZSgKICAgICAgdGhpcy5tb2RlbC5nZXQoYCR7cHJvcGVydHl9X3RpdGxlYCkgfHwgcHJvcGVydHkgfHwgIiIKICAgICk7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5hcHBlbmRDaGlsZCgKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9Q2hhbm5lbGBdCiAgICApOwogICAgdGhpcy50b29sdGlwQ29udGVudFByb3BlcnRpZXMuYXBwZW5kQ2hpbGQoCiAgICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7Y2FwaXRhbFByb3BlcnR5fVRpdGxlYF0KICAgICk7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5hcHBlbmRDaGlsZCgKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtjYXBpdGFsUHJvcGVydHl9VmFsdWVgXQogICAgKTsKICB9CiAgY3JlYXRlVG9vbHRpcENvbnRlbnRzRG9tRWxlbWVudHMoKSB7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJldmlldy5yZXBsYWNlQ2hpbGRyZW4oKTsKICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnJlcGxhY2VDaGlsZHJlbigpOwogICAgdGhpcy5jcmVhdGVUb29sdGlwUHJldmlld0RvbUVsZW1lbnRzKCk7CiAgICBjb25zdCBwcm9wZXJ0aWVzMiA9IG5ldyBTZXQodGhpcy50b29sdGlwUHJvcGVydGllc0FsbCk7CiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHByb3BlcnRpZXMyKSB7CiAgICAgIHRoaXMuY3JlYXRlVG9vbHRpcFByb3BlcnR5RG9tRWxlbWVudHMocHJvcGVydHkpOwogICAgfQogICAgdGhpcy5zdHlsZVRvb2x0aXAoKTsKICB9CiAgY3JlYXRlVG9vbHRpcENvbnRlbnRzKCkgewogICAgdGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbCA9IG5ldyBTZXQoCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX3Byb3BlcnRpZXMiKQogICAgKTsKICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgdGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbCkgewogICAgICBpZiAocHJvcGVydHkgaW4gVE9PTFRJUF9NQU5EQVRPUllfVklTVUFMX1BST1BFUlRJRVMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAocHJvcGVydHkgaW4gVE9PTFRJUF9PUFRJT05BTF9WSVNVQUxfUFJPUEVSVElFUykgewogICAgICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy5tb2RlbC5nZXQoYCR7cHJvcGVydHl9X2J5YCk7CiAgICAgICAgaWYgKHByb3BlcnR5ID09PSAib3BhY2l0eSIgJiYgZW5jb2RpbmcgJiYgZW5jb2RpbmcgIT09ICJkZW5zaXR5IikgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChwcm9wZXJ0eSAhPT0gIm9wYWNpdHkiICYmIGVuY29kaW5nKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbC5kZWxldGUocHJvcGVydHkpOwogICAgfQogICAgdGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbCA9IEFycmF5LmZyb20odGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbCk7CiAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0aWVzTm9uVmlzdWFsID0gbmV3IFNldCgKICAgICAgdGhpcy5tb2RlbC5nZXQoInRvb2x0aXBfcHJvcGVydGllcyIpCiAgICApOwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPYmplY3Qua2V5cyhUT09MVElQX0FMTF9WSVNVQUxfUFJPUEVSVElFUykpIHsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydGllc05vblZpc3VhbC5kZWxldGUocHJvcGVydHkpOwogICAgfQogICAgdGhpcy50b29sdGlwUHJvcGVydGllc05vblZpc3VhbCA9IEFycmF5LmZyb20oCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnRpZXNOb25WaXN1YWwKICAgICk7CiAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0aWVzQWxsID0gWwogICAgICAuLi50aGlzLnRvb2x0aXBQcm9wZXJ0aWVzVmlzdWFsLAogICAgICAuLi50aGlzLnRvb2x0aXBQcm9wZXJ0aWVzTm9uVmlzdWFsCiAgICBdOwogICAgdGhpcy50b29sdGlwUHJldmlldyA9IHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX3ByZXZpZXciKTsKICAgIHRoaXMuY3JlYXRlVG9vbHRpcENvbnRlbnRzRG9tRWxlbWVudHMoKTsKICB9CiAgY3JlYXRlVG9vbHRpcCgpIHsKICAgIHRoaXMudG9vbHRpcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy50b29sdGlwLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgIHRoaXMudG9vbHRpcC5zdHlsZS50b3AgPSAwOwogICAgdGhpcy50b29sdGlwLnN0eWxlLmxlZnQgPSAwOwogICAgdGhpcy50b29sdGlwLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAibm9uZSI7CiAgICB0aGlzLnRvb2x0aXAuc3R5bGUudXNlclNlbGVjdCA9ICJub25lIjsKICAgIHRoaXMudG9vbHRpcC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMC4ycmVtIjsKICAgIHRoaXMudG9vbHRpcC5zdHlsZS5vcGFjaXR5ID0gMDsKICAgIHRoaXMudG9vbHRpcC5zdHlsZS50cmFuc2l0aW9uID0gIm9wYWNpdHkgMC4ycyBlYXNlLWluLW91dCI7CiAgICB0aGlzLnRvb2x0aXBBcnJvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUud2lkdGggPSAiMC41cmVtIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLmhlaWdodCA9ICIwLjVyZW0iOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUudHJhbnNmb3JtT3JpZ2luID0gImNlbnRlciI7CiAgICB0aGlzLnRvb2x0aXAuYXBwZW5kQ2hpbGQodGhpcy50b29sdGlwQXJyb3cpOwogICAgdGhpcy50b29sdGlwQ29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy50b29sdGlwQ29udGVudC5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50LnN0eWxlLmRpc3BsYXkgPSAiZ3JpZCI7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50LnN0eWxlLmdyaWRUZW1wbGF0ZUNvbHVtbnMgPSAibWluLWNvbnRlbnQiOwogICAgdGhpcy50b29sdGlwQ29udGVudC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMC4ycmVtIjsKICAgIHRoaXMudG9vbHRpcC5hcHBlbmRDaGlsZCh0aGlzLnRvb2x0aXBDb250ZW50KTsKICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcmV2aWV3ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJldmlldy5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcENvbnRlbnRQcmV2aWV3KTsKICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5zdHlsZS5kaXNwbGF5ID0gImdyaWQiOwogICAgdGhpcy50b29sdGlwQ29udGVudFByb3BlcnRpZXMuc3R5bGUuZ2FwID0gIjAuNWVtIjsKICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnN0eWxlLnVzZXJTZWxlY3QgPSAibm9uZSI7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMC4ycmVtIjsKICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnN0eWxlLnBhZGRpbmcgPSAiMC4yNWVtIjsKICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnN0eWxlLmZvbnRTaXplID0gZ2V0VG9vbHRpcEZvbnRTaXplKAogICAgICB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9zaXplIikKICAgICk7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50LmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzKTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMudG9vbHRpcCk7CiAgICB0aGlzLmNyZWF0ZVRvb2x0aXBDb250ZW50cygpOwogICAgdGhpcy5lbmFibGVUb29sdGlwSGlzdG9ncmFtcygpOwogICAgdGhpcy5jcmVhdGVUb29sdGlwQ29udGVudFVwZGF0ZXIoKTsKICB9CiAgcG9zaXRpb25Ub29sdGlwVG9wQ2VudGVyKCkgewogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoInRvcCIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoInJpZ2h0Iik7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5ib3R0b20gPSAwOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUubGVmdCA9ICI1MCUiOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZSgtNTAlLCBjYWxjKDUwJSAtIDFweCkpIHJvdGF0ZSgtNDVkZWcpIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLmJveFNoYWRvdyA9IGAwIDAgMXB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSksIC0xcHggMXB4IDJweCByZ2JhKDAsIDAsIDAsICR7dGhpcy50b29sdGlwT3BhY2l0eX0pYDsKICAgIHRoaXMubW92ZVRvb2x0aXAgPSAoeCwgeSkgPT4gewogICAgICB0aGlzLnRvb2x0aXAuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKCR7eH1weCAtIDUwJSksIGNhbGMoJHt5fXB4IC0gJHtUT09MVElQX09GRlNFVF9SRU19cmVtIC0gMTAwJSkpYDsKICAgIH07CiAgfQogIHBvc2l0aW9uVG9vbHRpcFRvcExlZnQoKSB7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgidG9wIik7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5yaWdodCA9ICIwLjEyNXJlbSI7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5ib3R0b20gPSAwOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoImxlZnQiKTsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoLTUwJSwgY2FsYyg1MCUgLSAxcHgpKSByb3RhdGUoLTQ1ZGVnKSI7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5ib3hTaGFkb3cgPSBgMCAwIDFweCByZ2JhKDAsIDAsIDAsICR7dGhpcy50b29sdGlwT3BhY2l0eX0pLCAtMXB4IDFweCAycHggcmdiYSgwLCAwLCAwLCAke3RoaXMudG9vbHRpcE9wYWNpdHl9KWA7CiAgICB0aGlzLm1vdmVUb29sdGlwID0gKHgsIHkpID0+IHsKICAgICAgdGhpcy50b29sdGlwLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygke3h9cHggLSAxMDAlICsgJHtUT09MVElQX09GRlNFVF9SRU19cmVtKSwgY2FsYygke3l9cHggLSAke1RPT0xUSVBfT0ZGU0VUX1JFTX1yZW0gLSAxMDAlKSlgOwogICAgfTsKICB9CiAgcG9zaXRpb25Ub29sdGlwVG9wUmlnaHQoKSB7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgidG9wIik7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgicmlnaHQiKTsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLmJvdHRvbSA9IDA7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5sZWZ0ID0gIjAuNXJlbSI7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlKC01MCUsIGNhbGMoNTAlIC0gMXB4KSkgcm90YXRlKC00NWRlZykiOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUuYm94U2hhZG93ID0gYDAgMCAxcHggcmdiYSgwLCAwLCAwLCAke3RoaXMudG9vbHRpcE9wYWNpdHl9KSwgLTFweCAxcHggMnB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSlgOwogICAgdGhpcy5tb3ZlVG9vbHRpcCA9ICh4LCB5KSA9PiB7CiAgICAgIHRoaXMudG9vbHRpcC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoJHt4fXB4IC0gJHtUT09MVElQX09GRlNFVF9SRU19cmVtKSwgY2FsYygke3l9cHggLSAke1RPT0xUSVBfT0ZGU0VUX1JFTX1yZW0gLSAxMDAlKSlgOwogICAgfTsKICB9CiAgcG9zaXRpb25Ub29sdGlwQm90dG9tQ2VudGVyKCkgewogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUudG9wID0gMDsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnJlbW92ZVByb3BlcnR5KCJyaWdodCIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoImJvdHRvbSIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUubGVmdCA9ICI1MCUiOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZSgtNTAlLCBjYWxjKC01MCUgKyAxcHgpKSByb3RhdGUoLTQ1ZGVnKSI7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5ib3hTaGFkb3cgPSBgMCAwIDFweCByZ2JhKDAsIDAsIDAsICR7dGhpcy50b29sdGlwT3BhY2l0eX0pLCAtMXB4IC0xcHggMnB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSlgOwogICAgdGhpcy5tb3ZlVG9vbHRpcCA9ICh4LCB5KSA9PiB7CiAgICAgIHRoaXMudG9vbHRpcC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoJHt4fXB4IC0gNTAlKSwgY2FsYygke3l9cHggKyAke1RPT0xUSVBfT0ZGU0VUX1JFTX1yZW0pKWA7CiAgICB9OwogIH0KICBwb3NpdGlvblRvb2x0aXBCb3R0b21MZWZ0KCkgewogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUudG9wID0gMDsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnJpZ2h0ID0gIjAuMTI1cmVtIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnJlbW92ZVByb3BlcnR5KCJib3R0b20iKTsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnJlbW92ZVByb3BlcnR5KCJsZWZ0Iik7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlKC01MCUsIGNhbGMoLTUwJSArIDFweCkpIHJvdGF0ZSgtNDVkZWcpIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLmJveFNoYWRvdyA9IGAwIDAgMXB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSksIC0xcHggLTFweCAycHggcmdiYSgwLCAwLCAwLCAke3RoaXMudG9vbHRpcE9wYWNpdHl9KWA7CiAgICB0aGlzLm1vdmVUb29sdGlwID0gKHgsIHkpID0+IHsKICAgICAgdGhpcy50b29sdGlwLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygke3h9cHggLSAxMDAlICsgJHtUT09MVElQX09GRlNFVF9SRU19cmVtKSwgY2FsYygke3l9cHggKyAke1RPT0xUSVBfT0ZGU0VUX1JFTX1yZW0pKWA7CiAgICB9OwogIH0KICBwb3NpdGlvblRvb2x0aXBCb3R0b21SaWdodCgpIHsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnRvcCA9IDA7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5yZW1vdmVQcm9wZXJ0eSgicmlnaHQiKTsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnJlbW92ZVByb3BlcnR5KCJib3R0b20iKTsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLmxlZnQgPSAiMC41cmVtIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoLTUwJSwgY2FsYygtNTAlICsgMXB4KSkgcm90YXRlKC00NWRlZykiOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUuYm94U2hhZG93ID0gYDAgMCAxcHggcmdiYSgwLCAwLCAwLCAke3RoaXMudG9vbHRpcE9wYWNpdHl9KSwgLTFweCAtMXB4IDJweCByZ2JhKDAsIDAsIDAsICR7dGhpcy50b29sdGlwT3BhY2l0eX0pYDsKICAgIHRoaXMubW92ZVRvb2x0aXAgPSAoeCwgeSkgPT4gewogICAgICB0aGlzLnRvb2x0aXAuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZShjYWxjKCR7eH1weCAtICR7VE9PTFRJUF9PRkZTRVRfUkVNfXJlbSksIGNhbGMoJHt5fXB4ICsgJHtUT09MVElQX09GRlNFVF9SRU19cmVtKSlgOwogICAgfTsKICB9CiAgcG9zaXRpb25Ub29sdGlwTGVmdENlbnRlcigpIHsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnRvcCA9ICI1MCUiOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmlnaHQgPSAwOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoImJvdHRvbSIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoImxlZnQiKTsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoY2FsYyg1MCUgLSAxcHgpLCAtNTAlKSByb3RhdGUoLTQ1ZGVnKSI7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5ib3hTaGFkb3cgPSBgMCAwIDFweCByZ2JhKDAsIDAsIDAsICR7dGhpcy50b29sdGlwT3BhY2l0eX0pLCAtMXB4IC0xcHggMnB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSlgOwogICAgdGhpcy5tb3ZlVG9vbHRpcCA9ICh4LCB5KSA9PiB7CiAgICAgIHRoaXMudG9vbHRpcC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoJHt4fXB4IC0gJHtUT09MVElQX09GRlNFVF9SRU19cmVtIC0gMTAwJSksIGNhbGMoJHt5fXB4IC0gNTAlKSlgOwogICAgfTsKICB9CiAgcG9zaXRpb25Ub29sdGlwUmlnaHRDZW50ZXIoKSB7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS50b3AgPSAiNTAlIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLnJlbW92ZVByb3BlcnR5KCJyaWdodCIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUucmVtb3ZlUHJvcGVydHkoImJvdHRvbSIpOwogICAgdGhpcy50b29sdGlwQXJyb3cuc3R5bGUubGVmdCA9IDA7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlKGNhbGMoLTUwJSArIDFweCksIC01MCUpIHJvdGF0ZSgtNDVkZWcpIjsKICAgIHRoaXMudG9vbHRpcEFycm93LnN0eWxlLmJveFNoYWRvdyA9IGAwIDAgMXB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSksIDFweCAxcHggMnB4IHJnYmEoMCwgMCwgMCwgJHt0aGlzLnRvb2x0aXBPcGFjaXR5fSlgOwogICAgdGhpcy5tb3ZlVG9vbHRpcCA9ICh4LCB5KSA9PiB7CiAgICAgIHRoaXMudG9vbHRpcC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoJHt4fXB4ICsgJHtUT09MVElQX09GRlNFVF9SRU19cmVtKSwgY2FsYygke3l9cHggLSA1MCUpKWA7CiAgICB9OwogIH0KICBwb3NpdGlvblRvb2x0aXAocG9zaXRpb24pIHsKICAgIHN3aXRjaCAocG9zaXRpb24pIHsKICAgICAgY2FzZSAiYm90dG9tLWNlbnRlciI6CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb25Ub29sdGlwQm90dG9tQ2VudGVyKCk7CiAgICAgIGNhc2UgImJvdHRvbS1sZWZ0IjoKICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvblRvb2x0aXBCb3R0b21MZWZ0KCk7CiAgICAgIGNhc2UgImJvdHRvbS1yaWdodCI6CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb25Ub29sdGlwQm90dG9tUmlnaHQoKTsKICAgICAgY2FzZSAibGVmdC1jZW50ZXIiOgogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uVG9vbHRpcExlZnRDZW50ZXIoKTsKICAgICAgY2FzZSAicmlnaHQtY2VudGVyIjoKICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvblRvb2x0aXBSaWdodENlbnRlcigpOwogICAgICBjYXNlICJ0b3AtbGVmdCI6CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb25Ub29sdGlwVG9wTGVmdCgpOwogICAgICBjYXNlICJ0b3AtcmlnaHQiOgogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uVG9vbHRpcFRvcFJpZ2h0KCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhpcy5wb3NpdGlvblRvb2x0aXBUb3BDZW50ZXIoKTsKICAgIH0KICB9CiAgZ2V0VG9vbHRpcFBvc2l0aW9uKHgsIHkpIHsKICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy50b29sdGlwLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgY29uc3QgeEN1dG9mZiA9IHdpZHRoIC8gMjsKICAgIGNvbnN0IHlDdXRvZmYgPSBoZWlnaHQ7CiAgICBjb25zdCB0b29sdGlwT2Zmc2V0ID0gcmVtVG9QeChUT09MVElQX09GRlNFVF9SRU0pOwogICAgaWYgKHggPCB4Q3V0b2ZmICsgdG9vbHRpcE9mZnNldCkgewogICAgICBpZiAoeSA8IHlDdXRvZmYgKyB0b29sdGlwT2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuICJib3R0b20tcmlnaHQiOwogICAgICB9CiAgICAgIGlmICh5ID4gdGhpcy5vdXRlckhlaWdodCAtIHlDdXRvZmYgLSB0b29sdGlwT2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuICJ0b3AtcmlnaHQiOwogICAgICB9CiAgICAgIHJldHVybiAicmlnaHQtY2VudGVyIjsKICAgIH0KICAgIGlmICh4ID4gdGhpcy5vdXRlcldpZHRoIC0geEN1dG9mZiAtIHRvb2x0aXBPZmZzZXQpIHsKICAgICAgaWYgKHkgPCB5Q3V0b2ZmICsgdG9vbHRpcE9mZnNldCkgewogICAgICAgIHJldHVybiAiYm90dG9tLWxlZnQiOwogICAgICB9CiAgICAgIGlmICh5ID4gdGhpcy5vdXRlckhlaWdodCAtIHlDdXRvZmYgLSB0b29sdGlwT2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuICJ0b3AtbGVmdCI7CiAgICAgIH0KICAgICAgcmV0dXJuICJsZWZ0LWNlbnRlciI7CiAgICB9CiAgICBpZiAoeSA8IHlDdXRvZmYgKyB0b29sdGlwT2Zmc2V0KSB7CiAgICAgIHJldHVybiAiYm90dG9tLWNlbnRlciI7CiAgICB9CiAgICByZXR1cm4gInRvcC1jZW50ZXIiOwogIH0KICBlbmFibGVUb29sdGlwSGlzdG9ncmFtcygpIHsKICAgIGNvbnN0IHNob3dIaXN0b2dyYW1zID0gdGhpcy5tb2RlbC5nZXQoInRvb2x0aXBfaGlzdG9ncmFtcyIpOwogICAgY29uc3QgZGlzcGxheSA9IHNob3dIaXN0b2dyYW1zID09PSB0cnVlIHx8IHNob3dIaXN0b2dyYW1zLmxlbmd0aCA+IDAgPyAiYmxvY2siIDogIm5vbmUiOwogICAgY29uc3QgaGlzdG9ncmFtcyA9IHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnF1ZXJ5U2VsZWN0b3JBbGwoIi5oaXN0b2dyYW0iKTsKICAgIGZvciAoY29uc3QgaGlzdG9ncmFtIG9mIGhpc3RvZ3JhbXMpIHsKICAgICAgaGlzdG9ncmFtLnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5OwogICAgfQogIH0KICAvLyBiaW9tZS1pZ25vcmUgbGludC9jb21wbGV4aXR5L25vRXhjZXNzaXZlQ29nbml0aXZlQ29tcGxleGl0eTogV2lsbCByZWZhY3RvciB0aGlzIGxhdGVyCiAgc3R5bGVUb29sdGlwKCkgewogICAgaWYgKCF0aGlzLnRvb2x0aXApIHsKICAgICAgdGhpcy5jcmVhdGVUb29sdGlwKCk7CiAgICB9CiAgICBjb25zdCBjb2xvcjIgPSB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9jb2xvciIpLm1hcCgoYykgPT4gTWF0aC5yb3VuZChjICogMjU1KSk7CiAgICBjb25zdCBpc0RhcmsgPSBjb2xvcjJbMF0gPD0gMTI3OwogICAgY29uc3QgY29udHJhc3QgPSBpc0RhcmsgPyAyNTUgOiAwOwogICAgY29uc3QgZmcgPSBgcmdiKCR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSwgJHtjb250cmFzdH0pYDsKICAgIGNvbnN0IGJnID0gYHJnYigke2NvbG9yMlswXX0sICR7Y29sb3IyWzFdfSwgJHtjb2xvcjJbMl19KWA7CiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHRoaXMudG9vbHRpcFByb3BlcnRpZXNBbGwpIHsKICAgICAgdGhpc1tgdG9vbHRpcFByb3BlcnR5JHt0b0NhcGl0YWxDYXNlKHByb3BlcnR5KX1WYWx1ZUhpc3RvZ3JhbWBdPy5zdHlsZSgKICAgICAgICBmZywKICAgICAgICBgcmdiKCR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sIDAuMilgCiAgICAgICk7CiAgICB9CiAgICBpZiAodGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbC5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnN0eWxlLmdyaWRUZW1wbGF0ZUNvbHVtbnMgPSAibWF4LWNvbnRlbnQgbWF4LWNvbnRlbnQgbWF4LWNvbnRlbnQiOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy50b29sdGlwQ29udGVudFByb3BlcnRpZXMuc3R5bGUuZ3JpZFRlbXBsYXRlQ29sdW1ucyA9ICJtYXgtY29udGVudCBtYXgtY29udGVudCI7CiAgICAgIGZvciAoY29uc3QgY2hhbm5lbCBvZiB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5xdWVyeVNlbGVjdG9yQWxsKAogICAgICAgICIuY2hhbm5lbCIKICAgICAgKSkgewogICAgICAgIGNoYW5uZWwuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgfQogICAgfQogICAgdGhpcy50b29sdGlwT3BhY2l0eSA9IGlzRGFyayA/IDAuMzMgOiAwLjI7CiAgICB0aGlzLnRvb2x0aXAuc3R5bGUub3BhY2l0eSA9IDA7CiAgICB0aGlzLnRvb2x0aXAuc3R5bGUuY29sb3IgPSBmZzsKICAgIHRoaXMudG9vbHRpcC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBiZzsKICAgIHRoaXMudG9vbHRpcC5zdHlsZS5ib3hTaGFkb3cgPSBgMCAwIDFweCByZ2JhKDAsIDAsIDAsICR7dGhpcy50b29sdGlwT3BhY2l0eX0pLCAwIDFweCAycHggcmdiYSgwLCAwLCAwLCAke3RoaXMudG9vbHRpcE9wYWNpdHl9KWA7CiAgICB0aGlzLnRvb2x0aXBBcnJvdy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBiZzsKICAgIHRoaXMudG9vbHRpcENvbnRlbnQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYmc7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoInRvb2x0aXBfcHJldmlldyIpKSB7CiAgICAgIGNvbnN0IHByZXZpZXdUeXBlID0gdGhpcy5tb2RlbC5nZXQoInRvb2x0aXBfcHJldmlld190eXBlIik7CiAgICAgIGlmIChwcmV2aWV3VHlwZSA9PT0gInRleHQiKSB7CiAgICAgICAgY29uc3QgbGluZXMgPSB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcmV2aWV3X3RleHRfbGluZXMiKTsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5zdHlsZS53aWR0aCA9ICIxMDAlIjsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWVIZWxwZXIuc3R5bGUubWFyZ2luID0gIjAuMjVlbSI7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld0JvcmRlci5zdHlsZS5oZWlnaHQgPSAiMXB4IjsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3Qm9yZGVyLnN0eWxlLm1hcmdpbkJvdHRvbSA9ICIwLjI1ZW0iOwogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdCb3JkZXIuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYHJnYigke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAwLjIpYDsKICAgICAgICBpZiAobGluZXMgPiAwKSB7CiAgICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWVIZWxwZXIuc3R5bGUuZGlzcGxheSA9ICItd2Via2l0LWJveCI7CiAgICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWVIZWxwZXIuc3R5bGUud2Via2l0TGluZUNsYW1wID0gbGluZXM7CiAgICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWVIZWxwZXIuc3R5bGUud2Via2l0Qm94T3JpZW50ID0gInZlcnRpY2FsIjsKICAgICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZUhlbHBlci5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwcmV2aWV3VHlwZSA9PT0gImltYWdlIikgewogICAgICAgIGNvbnN0IGJhY2tncm91bmRDb2xvciA9IHRoaXMubW9kZWwuZ2V0KAogICAgICAgICAgInRvb2x0aXBfcHJldmlld19pbWFnZV9iYWNrZ3JvdW5kX2NvbG9yIgogICAgICAgICk7CiAgICAgICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcmV2aWV3X2ltYWdlX3Bvc2l0aW9uIik7CiAgICAgICAgY29uc3Qgc2l6ZSA9IHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX3ByZXZpZXdfaW1hZ2Vfc2l6ZSIpOwogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGJhY2tncm91bmRDb2xvciA9PT0gImF1dG8iID8gYmcgOiBiYWNrZ3JvdW5kQ29sb3I7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLnN0eWxlLmJhY2tncm91bmRSZXBlYXQgPSAibm8tcmVwZWF0IjsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuc3R5bGUuYmFja2dyb3VuZFBvc2l0aW9uID0gcG9zaXRpb247CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLnN0eWxlLmJhY2tncm91bmRTaXplID0gc2l6ZTsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjAuMnJlbSAwLjJyZW0gMCAwIjsKICAgICAgICBjb25zdCBoZWlnaHQgPSB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcmV2aWV3X2ltYWdlX2hlaWdodCIpOwogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZUhlbHBlci5zdHlsZS5wYWRkaW5nVG9wID0gaGVpZ2h0ID8gYCR7aGVpZ2h0fXB4YCA6ICI2ZW0iOwogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdCb3JkZXIuc3R5bGUuaGVpZ2h0ID0gIjFweCI7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld0JvcmRlci5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMC4yNWVtIjsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3Qm9yZGVyLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGByZ2IoJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSwgMC4yKWA7CiAgICAgIH0gZWxzZSBpZiAocHJldmlld1R5cGUgPT09ICJhdWRpbyIpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcmV2aWV3X2F1ZGlvX2xlbmd0aCIpOwogICAgICAgIGNvbnN0IGxvb3AgPSB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcmV2aWV3X2F1ZGlvX2xvb3AiKTsKICAgICAgICBjb25zdCBjb250cm9scyA9IHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX3ByZXZpZXdfYXVkaW9fY29udHJvbHMiKTsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuY29udHJvbHMgPSBjb250cm9sczsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuYXV0b3BsYXkgPSB0cnVlOwogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5sb29wID0gbG9vcDsKICAgICAgICBpZiAobGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuYWRkRXZlbnRMaXN0ZW5lcigidGltZXVwZGF0ZSIsICgpID0+IHsKICAgICAgICAgICAgaWYgKHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5jdXJyZW50VGltZSA+IGxlbmd0aCkgewogICAgICAgICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5wYXVzZSgpOwogICAgICAgICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuY3VycmVudFRpbWUgPSAwOwogICAgICAgICAgICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLnBsYXkoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbC5sZW5ndGggPiAwIHx8IHRoaXMudG9vbHRpcFByb3BlcnRpZXNOb25WaXN1YWwubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMudG9vbHRpcENvbnRlbnQuc3R5bGUuZ3JpZFRlbXBsYXRlQ29sdW1ucyA9ICJtaW4tY29udGVudCI7CiAgICAgICAgdGhpcy50b29sdGlwQ29udGVudFByb3BlcnRpZXMuc3R5bGUuZGlzcGxheSA9ICJncmlkIjsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3Qm9yZGVyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9vbHRpcENvbnRlbnQuc3R5bGUuZ3JpZFRlbXBsYXRlQ29sdW1ucyA9ICJtaW5tYXgoYXV0bywgMjBlbSkiOwogICAgICAgIHRoaXMudG9vbHRpcENvbnRlbnRQcm9wZXJ0aWVzLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld0JvcmRlci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CiAgICB9CiAgICBjb25zdCBjaGFubmVsQmFkZ2VzID0gdGhpcy50b29sdGlwQ29udGVudFByb3BlcnRpZXMucXVlcnlTZWxlY3RvckFsbCgiLmNoYW5uZWwtYmFkZ2UiKTsKICAgIGZvciAoY29uc3QgY2hhbm5lbEJhZGdlIG9mIGNoYW5uZWxCYWRnZXMpIHsKICAgICAgY2hhbm5lbEJhZGdlLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgICAgY2hhbm5lbEJhZGdlLnN0eWxlLmZvbnRTaXplID0gIjAuNzVlbSI7CiAgICAgIGNoYW5uZWxCYWRnZS5zdHlsZS53aWR0aCA9ICIxZW0iOwogICAgICBjaGFubmVsQmFkZ2Uuc3R5bGUuaGVpZ2h0ID0gIjFlbSI7CiAgICAgIGNoYW5uZWxCYWRnZS5zdHlsZS5tYXJnaW5SaWdodCA9ICIwLjEyNXJlbSI7CiAgICB9CiAgICBjb25zdCBjaGFubmVsQmFkZ2VCZ3MgPSB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5xdWVyeVNlbGVjdG9yQWxsKCIuY2hhbm5lbC1iYWRnZS1iZyIpOwogICAgZm9yIChjb25zdCBjaGFubmVsQmFkZ2VCZyBvZiBjaGFubmVsQmFkZ2VCZ3MpIHsKICAgICAgY2hhbm5lbEJhZGdlQmcuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICBjaGFubmVsQmFkZ2VCZy5zdHlsZS56SW5kZXggPSAyOwogICAgICBjaGFubmVsQmFkZ2VCZy5zdHlsZS50b3AgPSAwOwogICAgICBjaGFubmVsQmFkZ2VCZy5zdHlsZS5sZWZ0ID0gMDsKICAgICAgY2hhbm5lbEJhZGdlQmcuc3R5bGUud2lkdGggPSAiMWVtIjsKICAgICAgY2hhbm5lbEJhZGdlQmcuc3R5bGUuaGVpZ2h0ID0gIjFlbSI7CiAgICB9CiAgICBpZiAodGhpcy50b29sdGlwUHJvcGVydHlYQ2hhbm5lbEJhZGdlQmcpIHsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlYQ2hhbm5lbEJhZGdlQmcuc3R5bGUuekluZGV4ID0gMDsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlYQ2hhbm5lbEJhZGdlQmcuc3R5bGUudG9wID0gIjUwJSI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WENoYW5uZWxCYWRnZUJnLnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoMCwgLTUwJSkiOwogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eVhDaGFubmVsQmFkZ2VCZy5zdHlsZS5oZWlnaHQgPSAiMnB4IjsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlYQ2hhbm5lbEJhZGdlQmcuc3R5bGUuYmFja2dyb3VuZCA9IGByZ2JhKCR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sIDAuMilgOwogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eVhDaGFubmVsQmFkZ2VNYXJrLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlYQ2hhbm5lbEJhZGdlTWFyay5zdHlsZS56SW5kZXggPSAxOwogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eVhDaGFubmVsQmFkZ2VNYXJrLnN0eWxlLnRvcCA9ICI1MCUiOwogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eVhDaGFubmVsQmFkZ2VNYXJrLnN0eWxlLndpZHRoID0gIjJweCI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WENoYW5uZWxCYWRnZU1hcmsuc3R5bGUuaGVpZ2h0ID0gIjZweCI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WENoYW5uZWxCYWRnZU1hcmsuc3R5bGUuYmFja2dyb3VuZCA9IGByZ2IoJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSlgOwogICAgfQogICAgaWYgKHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZUJnKSB7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZUJnLnN0eWxlLnpJbmRleCA9IDA7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZUJnLnN0eWxlLmxlZnQgPSAiNTAlIjsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZQ2hhbm5lbEJhZGdlQmcuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZSgtNTAlLCAwKSI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZUJnLnN0eWxlLndpZHRoID0gIjJweCI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZUJnLnN0eWxlLmJhY2tncm91bmQgPSBgcmdiYSgke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAwLjIpYDsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZQ2hhbm5lbEJhZGdlTWFyay5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZU1hcmsuc3R5bGUuekluZGV4ID0gMTsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZQ2hhbm5lbEJhZGdlTWFyay5zdHlsZS5sZWZ0ID0gIjUwJSI7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWxCYWRnZU1hcmsuc3R5bGUud2lkdGggPSAiNnB4IjsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZQ2hhbm5lbEJhZGdlTWFyay5zdHlsZS5oZWlnaHQgPSAiMnB4IjsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZQ2hhbm5lbEJhZGdlTWFyay5zdHlsZS5iYWNrZ3JvdW5kID0gYHJnYigke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sICR7Y29udHJhc3R9KWA7CiAgICB9CiAgICBjb25zdCBvcGFjaXR5U2l6ZUJhZGdlQmdFbGVtZW50cyA9IFsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlPcGFjaXR5Q2hhbm5lbEJhZGdlQmcsCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5U2l6ZUNoYW5uZWxCYWRnZUJnCiAgICBdLmZpbHRlcigoeCkgPT4geCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2Ygb3BhY2l0eVNpemVCYWRnZUJnRWxlbWVudHMpIHsKICAgICAgZWxlbWVudC5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMWVtIjsKICAgICAgZWxlbWVudC5zdHlsZS5ib3hTaGFkb3cgPSBgaW5zZXQgMCAwIDAgMXB4IHJnYmEoJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSwgMC4yKWA7CiAgICB9CiAgICBjb25zdCBiYWRnZU1hcmtFbGVtZW50cyA9IFsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlDb2xvckNoYW5uZWxCYWRnZU1hcmssCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5T3BhY2l0eUNoYW5uZWxCYWRnZU1hcmssCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5U2l6ZUNoYW5uZWxCYWRnZU1hcmsKICAgIF0uZmlsdGVyKCh4KSA9PiB4KTsKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBiYWRnZU1hcmtFbGVtZW50cykgewogICAgICBlbGVtZW50LnN0eWxlLndpZHRoID0gIjFlbSI7CiAgICAgIGVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjFlbSI7CiAgICAgIGVsZW1lbnQuc3R5bGUuYm9yZGVyUmFkaXVzID0gIjFlbSI7CiAgICAgIGVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZCA9IGByZ2IoJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSlgOwogICAgfQogICAgY29uc3Qgb3BhY2l0eVNpemVCYWRnZU1hcmtFbGVtZW50cyA9IFsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlPcGFjaXR5Q2hhbm5lbEJhZGdlTWFyaywKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlTaXplQ2hhbm5lbEJhZGdlTWFyawogICAgXS5maWx0ZXIoKHgpID0+IHgpOwogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIG9wYWNpdHlTaXplQmFkZ2VNYXJrRWxlbWVudHMpIHsKICAgICAgZWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kID0gYHJnYigke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sICR7Y29udHJhc3R9KWA7CiAgICB9CiAgICBjb25zdCBjaGFubmVsQmcgPSBgcmdiYSgke2NvbnRyYXN0fSwgJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAwLjA3NSlgOwogICAgY29uc3QgY2hhbm5lbENvbG9yID0gYHJnYmEoJHtjb250cmFzdH0sICR7Y29udHJhc3R9LCAke2NvbnRyYXN0fSwgMC41KWA7CiAgICBjb25zdCBjaGFubmVsRWxlbWVudHMgPSBbCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WENoYW5uZWwsCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WUNoYW5uZWwsCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5Q29sb3JDaGFubmVsLAogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eU9wYWNpdHlDaGFubmVsLAogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eVNpemVDaGFubmVsCiAgICBdLmZpbHRlcigoeCkgPT4geCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgY2hhbm5lbEVsZW1lbnRzKSB7CiAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgICAgZWxlbWVudC5zdHlsZS5nYXAgPSAiMCAwLjMzZW0iOwogICAgICBlbGVtZW50LnN0eWxlLmp1c3RpZnlDb250ZW50ID0gImNlbnRlciI7CiAgICAgIGVsZW1lbnQuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgICBlbGVtZW50LnN0eWxlLnBhZGRpbmcgPSAiMCAwLjI1ZW0iOwogICAgICBlbGVtZW50LnN0eWxlLmJvcmRlclJhZGl1cyA9ICIwLjI1cmVtIjsKICAgICAgZWxlbWVudC5zdHlsZS5jb2xvciA9IGNoYW5uZWxDb2xvcjsKICAgICAgZWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMS4zZW0iOwogICAgICBlbGVtZW50LnN0eWxlLmZvbnRXZWlnaHQgPSAiYm9sZCI7CiAgICAgIGVsZW1lbnQuc3R5bGUudGV4dFRyYW5zZm9ybSA9ICJ1cHBlcmNhc2UiOwogICAgICBlbGVtZW50LnN0eWxlLmJhY2tncm91bmQgPSBjaGFubmVsQmc7CiAgICB9CiAgICBjb25zdCBjaGFubmVsTmFtZUVsZW1lbnRzID0gWwogICAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eVhDaGFubmVsTmFtZSwKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZQ2hhbm5lbE5hbWUsCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5Q29sb3JDaGFubmVsTmFtZSwKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlPcGFjaXR5Q2hhbm5lbE5hbWUsCiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5U2l6ZUNoYW5uZWxOYW1lCiAgICBdLmZpbHRlcigoeCkgPT4geCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgY2hhbm5lbE5hbWVFbGVtZW50cykgewogICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgIGVsZW1lbnQuc3R5bGUuZmxleEdyb3cgPSAiMSI7CiAgICAgIGVsZW1lbnQuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAiY2VudGVyIjsKICAgICAgZWxlbWVudC5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgICAgIGVsZW1lbnQuc3R5bGUuZm9udFNpemUgPSAiMC43NWVtIjsKICAgICAgZWxlbWVudC5zdHlsZS5saW5lSGVpZ2h0ID0gIjFlbSI7CiAgICB9CiAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5xdWVyeVNlbGVjdG9yQWxsKCIudmFsdWUiKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIHZhbHVlLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICAgIHZhbHVlLnN0eWxlLmdhcCA9ICIwIDAuMjVlbSI7CiAgICAgIHZhbHVlLnN0eWxlLmZvbnRXZWlnaHQgPSAiYm9sZCI7CiAgICAgIHZhbHVlLnN0eWxlLmFsaWduSXRlbXMgPSAidG9wIjsKICAgIH0KICAgIGNvbnN0IHZhbHVlVGV4dHMgPSB0aGlzLnRvb2x0aXBDb250ZW50UHJvcGVydGllcy5xdWVyeVNlbGVjdG9yQWxsKCIudmFsdWUtdGV4dCIpOwogICAgZm9yIChjb25zdCB2YWx1ZVRleHQgb2YgdmFsdWVUZXh0cykgewogICAgICB2YWx1ZVRleHQuc3R5bGUuZmxleEdyb3cgPSAiMSI7CiAgICAgIHZhbHVlVGV4dC5zdHlsZS5tYXhXaWR0aCA9IHZhbHVlVGV4dC5jbGFzc0xpc3QuY29udGFpbnMoInZhbHVlLW9ubHkiKSA/ICIxNmVtIiA6ICIxMmVtIjsKICAgICAgdmFsdWVUZXh0LnN0eWxlLmRpc3BsYXkgPSAiLXdlYmtpdC1ib3giOwogICAgICB2YWx1ZVRleHQuc3R5bGUud2Via2l0TGluZUNsYW1wID0gMzsKICAgICAgdmFsdWVUZXh0LnN0eWxlLndlYmtpdEJveE9yaWVudCA9ICJ2ZXJ0aWNhbCI7CiAgICAgIHZhbHVlVGV4dC5zdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgfQogIH0KICBnZXRQb2ludChpKSB7CiAgICByZXR1cm4gdGhpcy5zY2F0dGVycGxvdC5nZXQoInBvaW50cyIpW2ldOwogIH0KICBnZXRQb2ludHMoKSB7CiAgICByZXR1cm4gdGhpcy5zY2F0dGVycGxvdC5nZXQoInBvaW50cyIpOwogIH0KICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBYR2V0dGVyIHN0YW5kcyBmb3IgWCBHZXR0ZXIKICBjcmVhdGVYR2V0dGVyKCkgewogICAgaWYgKCF0aGlzLnhTY2FsZSkgewogICAgICB0aGlzLmNyZWF0ZVhTY2FsZSgpOwogICAgfQogICAgdGhpcy5nZXRYQmluID0gY3JlYXRlTnVtZXJpY2FsQmluR2V0dGVyKAogICAgICB0aGlzLm1vZGVsLmdldCgieF9oaXN0b2dyYW0iKSwKICAgICAgdGhpcy5tb2RlbC5nZXQoInhfZG9tYWluIikKICAgICk7CiAgICBjb25zdCB0b1JlbFZhbHVlID0gbGluZWFyMygpLmRvbWFpbih0aGlzLm1vZGVsLmdldCgieF9kb21haW4iKSkucmFuZ2UoWzAsIDFdKTsKICAgIHRoaXMuZ2V0WCA9IChpKSA9PiB7CiAgICAgIGNvbnN0IG5kYyA9IHRoaXMuZ2V0UG9pbnQoaSlbMF07CiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy54U2NhbGUuaW52ZXJ0KG5kYyk7CiAgICAgIHJldHVybiBbdG9SZWxWYWx1ZSh2YWx1ZSksIHRoaXMueEZvcm1hdCh2YWx1ZSksIHRoaXMuZ2V0WEJpbih2YWx1ZSldOwogICAgfTsKICB9CiAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogWUdldHRlciBzdGFuZHMgZm9yIFkgR2V0dGVyCiAgY3JlYXRlWUdldHRlcigpIHsKICAgIGlmICghdGhpcy55U2NhbGUpIHsKICAgICAgdGhpcy5jcmVhdGVZU2NhbGUoKTsKICAgIH0KICAgIHRoaXMuZ2V0WUJpbiA9IGNyZWF0ZU51bWVyaWNhbEJpbkdldHRlcigKICAgICAgdGhpcy5tb2RlbC5nZXQoInlfaGlzdG9ncmFtIiksCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJ5X2RvbWFpbiIpCiAgICApOwogICAgY29uc3QgdG9SZWxWYWx1ZSA9IGxpbmVhcjMoKS5kb21haW4odGhpcy5tb2RlbC5nZXQoInlfZG9tYWluIikpLnJhbmdlKFswLCAxXSk7CiAgICB0aGlzLmdldFkgPSAoaSkgPT4gewogICAgICBjb25zdCBuZGMgPSB0aGlzLmdldFBvaW50KGkpWzFdOwogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMueVNjYWxlLmludmVydChuZGMpOwogICAgICByZXR1cm4gW3RvUmVsVmFsdWUodmFsdWUpLCB0aGlzLnlGb3JtYXQodmFsdWUpLCB0aGlzLmdldFlCaW4odmFsdWUpXTsKICAgIH07CiAgfQogIGNyZWF0ZUNvbG9yR2V0dGVyKCkgewogICAgaWYgKCF0aGlzLmNvbG9yU2NhbGUpIHsKICAgICAgdGhpcy5jcmVhdGVDb2xvclNjYWxlKCk7CiAgICB9CiAgICBpZiAoIXRoaXMuY29sb3JTY2FsZSkgewogICAgICB0aGlzLmdldENvbG9yID0gKCkgPT4gWyIjODA4MDgwIiwgIlVua25vd24iLCAwXTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgZGltID0gdGhpcy5tb2RlbC5nZXQoImNvbG9yX2J5IikgPT09ICJ2YWx1ZUEiID8gMiA6IDM7CiAgICBjb25zdCBjb2xvcnMgPSB0aGlzLm1vZGVsLmdldCgiY29sb3IiKS5tYXAoCiAgICAgIChjb2xvcjIpID0+IGByZ2IoJHtjb2xvcjIuc2xpY2UoMCwgMykubWFwKCh2KSA9PiBNYXRoLnJvdW5kKHYgKiAyNTUpKS5qb2luKCIsICIpfSlgCiAgICApOwogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJjb2xvcl9zY2FsZSIpID09PSAiY2F0ZWdvcmljYWwiKSB7CiAgICAgIHRoaXMuZ2V0Q29sb3IgPSAoaSkgPT4gewogICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRQb2ludChpKVtkaW1dOwogICAgICAgIHJldHVybiBbCiAgICAgICAgICBjb2xvcnNbdmFsdWVdIHx8ICIjODA4MDgwIiwKICAgICAgICAgIHRoaXMuY29sb3JGb3JtYXQodGhpcy5jb2xvclNjYWxlLmludmVydCh2YWx1ZSkpLAogICAgICAgICAgdmFsdWUKICAgICAgICBdOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgbnVtQ29sb3JzID0gY29sb3JzLmxlbmd0aDsKICAgICAgdGhpcy5nZXRDb2xvckJpbiA9IGNyZWF0ZU51bWVyaWNhbEJpbkdldHRlcigKICAgICAgICB0aGlzLm1vZGVsLmdldCgiY29sb3JfaGlzdG9ncmFtIiksCiAgICAgICAgdGhpcy5tb2RlbC5nZXQoImNvbG9yX2RvbWFpbiIpCiAgICAgICk7CiAgICAgIHRoaXMuZ2V0Q29sb3IgPSAoaSkgPT4gewogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRWYWx1ZSA9IHRoaXMuZ2V0UG9pbnQoaSlbZGltXTsKICAgICAgICBjb25zdCBjb2xvcklkeCA9IE1hdGgubWluKAogICAgICAgICAgbnVtQ29sb3JzIC0gMSwKICAgICAgICAgIE1hdGguZmxvb3IobnVtQ29sb3JzICogbm9ybWFsaXplZFZhbHVlKQogICAgICAgICk7CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmNvbG9yU2NhbGUuaW52ZXJ0KG5vcm1hbGl6ZWRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgIGNvbG9yc1tjb2xvcklkeF0gfHwgIiM4MDgwODAiLAogICAgICAgICAgdGhpcy5jb2xvckZvcm1hdCh2YWx1ZSksCiAgICAgICAgICB0aGlzLmdldENvbG9yQmluKHZhbHVlKQogICAgICAgIF07CiAgICAgIH07CiAgICB9CiAgfQogIGNyZWF0ZU9wYWNpdHlHZXR0ZXIoKSB7CiAgICBpZiAoIXRoaXMub3BhY2l0eVNjYWxlKSB7CiAgICAgIHRoaXMuY3JlYXRlT3BhY2l0eVNjYWxlKCk7CiAgICB9CiAgICBpZiAoIXRoaXMub3BhY2l0eVNjYWxlKSB7CiAgICAgIHRoaXMuZ2V0T3BhY2l0eSA9ICgpID0+IFswLjUsICJVbmtub3duIiwgMF07CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGRpbSA9IHRoaXMubW9kZWwuZ2V0KCJvcGFjaXR5X2J5IikgPT09ICJ2YWx1ZUEiID8gMiA6IDM7CiAgICBjb25zdCBvcGFjaXRpZXMgPSB0aGlzLm1vZGVsLmdldCgib3BhY2l0eSIpOwogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJvcGFjaXR5X3NjYWxlIikgPT09ICJjYXRlZ29yaWNhbCIpIHsKICAgICAgdGhpcy5nZXRPcGFjaXR5ID0gKGkpID0+IHsKICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0UG9pbnQoaSlbZGltXTsKICAgICAgICByZXR1cm4gWwogICAgICAgICAgb3BhY2l0aWVzW3ZhbHVlXSB8fCAiIzgwODA4MCIsCiAgICAgICAgICB0aGlzLm9wYWNpdHlGb3JtYXQodGhpcy5vcGFjaXR5U2NhbGUuaW52ZXJ0KHZhbHVlKSksCiAgICAgICAgICB2YWx1ZQogICAgICAgIF07CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBjb25zdCBudW1PcGFjaXRpZXMgPSBvcGFjaXRpZXMubGVuZ3RoOwogICAgICB0aGlzLmdldE9wYWNpdHlCaW4gPSBjcmVhdGVOdW1lcmljYWxCaW5HZXR0ZXIoCiAgICAgICAgdGhpcy5tb2RlbC5nZXQoIm9wYWNpdHlfaGlzdG9ncmFtIiksCiAgICAgICAgdGhpcy5tb2RlbC5nZXQoIm9wYWNpdHlfZG9tYWluIikKICAgICAgKTsKICAgICAgdGhpcy5nZXRPcGFjaXR5ID0gKGkpID0+IHsKICAgICAgICBjb25zdCBub3JtYWxpemVkVmFsdWUgPSB0aGlzLmdldFBvaW50KGkpW2RpbV07CiAgICAgICAgY29uc3QgaWR4ID0gTWF0aC5taW4oCiAgICAgICAgICBudW1PcGFjaXRpZXMgLSAxLAogICAgICAgICAgTWF0aC5mbG9vcihudW1PcGFjaXRpZXMgKiBub3JtYWxpemVkVmFsdWUpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMub3BhY2l0eVNjYWxlLmludmVydChub3JtYWxpemVkVmFsdWUpOwogICAgICAgIHJldHVybiBbCiAgICAgICAgICBvcGFjaXRpZXNbaWR4XSB8fCAwLjUsCiAgICAgICAgICB0aGlzLm9wYWNpdHlGb3JtYXQodmFsdWUpLAogICAgICAgICAgdGhpcy5nZXRPcGFjaXR5QmluKHZhbHVlKQogICAgICAgIF07CiAgICAgIH07CiAgICB9CiAgfQogIGNyZWF0ZVNpemVHZXR0ZXIoKSB7CiAgICBpZiAoIXRoaXMuc2l6ZVNjYWxlKSB7CiAgICAgIHRoaXMuY3JlYXRlU2l6ZVNjYWxlKCk7CiAgICB9CiAgICBpZiAoIXRoaXMuc2l6ZVNjYWxlKSB7CiAgICAgIHRoaXMuZ2V0U2l6ZSA9ICgpID0+IFswLjUsICJVbmtub3duIiwgMF07CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGRpbSA9IHRoaXMubW9kZWwuZ2V0KCJzaXplX2J5IikgPT09ICJ2YWx1ZUEiID8gMiA6IDM7CiAgICBjb25zdCBzaXplcyA9IHRoaXMubW9kZWwuZ2V0KCJzaXplIik7CiAgICBjb25zdCBzaXplc01pbiA9IEFycmF5LmlzQXJyYXkoc2l6ZXMpID8gbWluKHNpemVzKSA6IHNpemVzOwogICAgY29uc3Qgc2l6ZXNNYXggPSBBcnJheS5pc0FycmF5KHNpemVzKSA/IG1heChzaXplcykgOiBzaXplczsKICAgIGNvbnN0IHNpemVzRXh0ZW50ID0gc2l6ZXNNYXggLSBzaXplc01pbiB8fCAxOwogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJzaXplX3NjYWxlIikgPT09ICJjYXRlZ29yaWNhbCIpIHsKICAgICAgdGhpcy5nZXRTaXplID0gKGkpID0+IHsKICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0UG9pbnQoaSlbZGltXTsKICAgICAgICByZXR1cm4gWwogICAgICAgICAgc2l6ZXNbdmFsdWVdICE9PSB2b2lkIDAgPyBNYXRoLm1heCgwLjEsIChzaXplc1t2YWx1ZV0gLSBzaXplc01pbikgLyBzaXplc0V4dGVudCkgOiAiIzgwODA4MCIsCiAgICAgICAgICB0aGlzLnNpemVGb3JtYXQodGhpcy5zaXplU2NhbGUuaW52ZXJ0KHZhbHVlKSksCiAgICAgICAgICB2YWx1ZQogICAgICAgIF07CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBjb25zdCBudW1TaXplcyA9IHNpemVzLmxlbmd0aDsKICAgICAgdGhpcy5nZXRTaXplQmluID0gY3JlYXRlTnVtZXJpY2FsQmluR2V0dGVyKAogICAgICAgIHRoaXMubW9kZWwuZ2V0KCJzaXplX2hpc3RvZ3JhbSIpLAogICAgICAgIHRoaXMubW9kZWwuZ2V0KCJzaXplX2RvbWFpbiIpCiAgICAgICk7CiAgICAgIHRoaXMuZ2V0U2l6ZSA9IChpKSA9PiB7CiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFZhbHVlID0gdGhpcy5nZXRQb2ludChpKVtkaW1dOwogICAgICAgIGNvbnN0IGlkeCA9IE1hdGgubWluKAogICAgICAgICAgbnVtU2l6ZXMgLSAxLAogICAgICAgICAgTWF0aC5mbG9vcihudW1TaXplcyAqIG5vcm1hbGl6ZWRWYWx1ZSkKICAgICAgICApOwogICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5zaXplU2NhbGUuaW52ZXJ0KG5vcm1hbGl6ZWRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgIE1hdGgubWF4KDAuMSwgKHNpemVzW2lkeF0gLSBzaXplc01pbikgLyBzaXplc0V4dGVudCksCiAgICAgICAgICB0aGlzLnNpemVGb3JtYXQodmFsdWUpLAogICAgICAgICAgdGhpcy5nZXRTaXplQmluKHZhbHVlKQogICAgICAgIF07CiAgICAgIH07CiAgICB9CiAgfQogIGNyZWF0ZVRvb2x0aXBDb250ZW50VXBkYXRlcigpIHsKICAgIGNvbnN0IHZpc3VhbFVwZGF0ZXJzID0gdGhpcy50b29sdGlwUHJvcGVydGllc1Zpc3VhbC5tYXAoKHByb3BlcnR5KSA9PiB7CiAgICAgIGNvbnN0IHByb3BlcnR5VGl0bGUgPSB0b0NhcGl0YWxDYXNlKHByb3BlcnR5KTsKICAgICAgY29uc3QgZ2V0ID0gKHBvaW50SWR4KSA9PiB0aGlzW2BnZXQke3Byb3BlcnR5VGl0bGV9YF0ocG9pbnRJZHgpOwogICAgICBjb25zdCB0ZXh0RWxlbWVudCA9IHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7cHJvcGVydHlUaXRsZX1WYWx1ZVRleHRgXTsKICAgICAgY29uc3QgYmFkZ2VFbGVtZW50ID0gdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtwcm9wZXJ0eVRpdGxlfUNoYW5uZWxCYWRnZU1hcmtgXTsKICAgICAgY29uc3QgaGlzdG9ncmFtID0gdGhpc1tgdG9vbHRpcFByb3BlcnR5JHtwcm9wZXJ0eVRpdGxlfVZhbHVlSGlzdG9ncmFtYF07CiAgICAgIGlmIChwcm9wZXJ0eSA9PT0gIngiKSB7CiAgICAgICAgcmV0dXJuIChwb2ludElkeCkgPT4gewogICAgICAgICAgY29uc3QgW3gsIHRleHQsIGhpc3RvZ3JhbUtleV0gPSBnZXQocG9pbnRJZHgpOwogICAgICAgICAgYmFkZ2VFbGVtZW50LnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoY2FsYygke3h9ZW0gLSA1MCUpLCAtNTAlKWA7CiAgICAgICAgICB0ZXh0RWxlbWVudC50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgICBpZiAodGhpcy5zaG93SGlzdG9ncmFtKHByb3BlcnR5KSkgewogICAgICAgICAgICBoaXN0b2dyYW0uZHJhdyhoaXN0b2dyYW1LZXkpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKHByb3BlcnR5ID09PSAieSIpIHsKICAgICAgICByZXR1cm4gKHBvaW50SWR4KSA9PiB7CiAgICAgICAgICBjb25zdCBbeSwgdGV4dCwgaGlzdG9ncmFtS2V5XSA9IGdldChwb2ludElkeCk7CiAgICAgICAgICBiYWRnZUVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gYHRyYW5zbGF0ZSgtNTAlLCBjYWxjKCR7MSAtIHl9ZW0gLSA1MCUpKWA7CiAgICAgICAgICB0ZXh0RWxlbWVudC50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgICBpZiAodGhpcy5zaG93SGlzdG9ncmFtKHByb3BlcnR5KSkgewogICAgICAgICAgICBoaXN0b2dyYW0uZHJhdyhoaXN0b2dyYW1LZXkpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKHByb3BlcnR5ID09PSAiY29sb3IiKSB7CiAgICAgICAgcmV0dXJuIChwb2ludElkeCkgPT4gewogICAgICAgICAgY29uc3QgW2NvbG9yMiwgdGV4dCwgaGlzdG9ncmFtS2V5XSA9IGdldChwb2ludElkeCk7CiAgICAgICAgICBiYWRnZUVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZCA9IGNvbG9yMjsKICAgICAgICAgIHRleHRFbGVtZW50LnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICAgIGlmICh0aGlzLnNob3dIaXN0b2dyYW0ocHJvcGVydHkpKSB7CiAgICAgICAgICAgIGhpc3RvZ3JhbS5kcmF3KGhpc3RvZ3JhbUtleSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAocHJvcGVydHkgPT09ICJvcGFjaXR5IikgewogICAgICAgIHJldHVybiAocG9pbnRJZHgpID0+IHsKICAgICAgICAgIGNvbnN0IFtvcGFjaXR5LCB0ZXh0LCBoaXN0b2dyYW1LZXldID0gZ2V0KHBvaW50SWR4KTsKICAgICAgICAgIGJhZGdlRWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gb3BhY2l0eTsKICAgICAgICAgIHRleHRFbGVtZW50LnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICAgIGlmICh0aGlzLnNob3dIaXN0b2dyYW0ocHJvcGVydHkpKSB7CiAgICAgICAgICAgIGhpc3RvZ3JhbS5kcmF3KGhpc3RvZ3JhbUtleSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAocHJvcGVydHkgPT09ICJzaXplIikgewogICAgICAgIHJldHVybiAocG9pbnRJZHgpID0+IHsKICAgICAgICAgIGNvbnN0IFtzY2FsZSwgdGV4dCwgaGlzdG9ncmFtS2V5XSA9IGdldChwb2ludElkeCk7CiAgICAgICAgICBiYWRnZUVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gYHNjYWxlKCR7c2NhbGV9KWA7CiAgICAgICAgICB0ZXh0RWxlbWVudC50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgICBpZiAodGhpcy5zaG93SGlzdG9ncmFtKHByb3BlcnR5KSkgewogICAgICAgICAgICBoaXN0b2dyYW0uZHJhdyhoaXN0b2dyYW1LZXkpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIChwb2ludElkeCkgPT4gewogICAgICAgIHRleHRFbGVtZW50LnRleHRDb250ZW50ID0gZ2V0KHBvaW50SWR4KTsKICAgICAgfTsKICAgIH0pOwogICAgY29uc3Qgbm9uVmlzdWFsSW5mbyA9IHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX3Byb3BlcnRpZXNfbm9uX3Zpc3VhbF9pbmZvIik7CiAgICBjb25zdCBub25WaXN1YWxEYXRhID0gdGhpcy50b29sdGlwUHJvcGVydGllc05vblZpc3VhbC5tYXAoKHByb3BlcnR5KSA9PiB7CiAgICAgIGNvbnN0IHByb3BlcnR5VGl0bGUgPSB0b0NhcGl0YWxDYXNlKHByb3BlcnR5KTsKICAgICAgY29uc3QgdGV4dEVsZW1lbnQgPSB0aGlzW2B0b29sdGlwUHJvcGVydHkke3Byb3BlcnR5VGl0bGV9VmFsdWVUZXh0YF07CiAgICAgIGNvbnN0IGhpc3RvZ3JhbSA9IHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7cHJvcGVydHlUaXRsZX1WYWx1ZUhpc3RvZ3JhbWBdOwogICAgICBjb25zdCBpbmZvID0gbm9uVmlzdWFsSW5mb1twcm9wZXJ0eV07CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJvcGVydHksCiAgICAgICAgdGV4dEVsZW1lbnQsCiAgICAgICAgaGlzdG9ncmFtLAogICAgICAgIGdldEhpc3RvZ3JhbUtleTogaW5mby5zY2FsZSA9PT0gbnVsbCA/IHZvaWQgMCA6IGluZm8uc2NhbGUgPT09ICJjYXRlZ29yaWNhbCIgPyAodikgPT4gaW5mby5kb21haW5bdl0gOiBjcmVhdGVOdW1lcmljYWxCaW5HZXR0ZXIoCiAgICAgICAgICBpbmZvLmhpc3RvZ3JhbSwKICAgICAgICAgIGluZm8ucmFuZ2UgfHwgaW5mby5kb21haW4KICAgICAgICApLAogICAgICAgIGZvcm1hdDogaW5mby5zY2FsZSA9PT0gImxpbmVhciIgPyBmb3JtYXQoZ2V0RDNGb3JtYXRTcGVjaWZpZXIoaW5mby5kb21haW4pKSA6IChzKSA9PiBzCiAgICAgIH07CiAgICB9KTsKICAgIGNvbnN0IHByZXZpZXdUeXBlID0gdGhpcy5tb2RlbC5nZXQoInRvb2x0aXBfcHJldmlld190eXBlIik7CiAgICBsZXQgcHJldmlld1VwZGF0ZXI7CiAgICBpZiAocHJldmlld1R5cGUgPT09ICJ0ZXh0IikgewogICAgICBwcmV2aWV3VXBkYXRlciA9ICh0ZXh0KSA9PiB7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlSGVscGVyLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgfTsKICAgIH0KICAgIGlmIChwcmV2aWV3VHlwZSA9PT0gImltYWdlIikgewogICAgICBwcmV2aWV3VXBkYXRlciA9IChpbWFnZVVybCkgPT4gewogICAgICAgIHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSBgdXJsKCR7aW1hZ2VVcmx9KWA7CiAgICAgIH07CiAgICB9CiAgICBpZiAocHJldmlld1R5cGUgPT09ICJhdWRpbyIpIHsKICAgICAgcHJldmlld1VwZGF0ZXIgPSAoYXVkaW9TcmMpID0+IHsKICAgICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUuc3JjID0gYXVkaW9TcmM7CiAgICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLmN1cnJlbnRUaW1lID0gMDsKICAgICAgfTsKICAgIH0KICAgIHRoaXMudG9vbHRpcERhdGFIYW5kbGVycyA9IChldmVudCkgPT4gewogICAgICBmb3IgKGNvbnN0IGQgb2Ygbm9uVmlzdWFsRGF0YSkgewogICAgICAgIGlmICghKGQucHJvcGVydHkgaW4gZXZlbnQucHJvcGVydGllcykpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBjb25zdCB2YWx1ZSA9IGV2ZW50LnByb3BlcnRpZXNbZC5wcm9wZXJ0eV07CiAgICAgICAgZC50ZXh0RWxlbWVudC50ZXh0Q29udGVudCA9IGQuZm9ybWF0KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy5zaG93SGlzdG9ncmFtKGQucHJvcGVydHkpKSB7CiAgICAgICAgICBkLmhpc3RvZ3JhbT8uZHJhdyhkLmdldEhpc3RvZ3JhbUtleT8uKHZhbHVlKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChldmVudC5wcmV2aWV3KSB7CiAgICAgICAgcHJldmlld1VwZGF0ZXIoZXZlbnQucHJldmlldyk7CiAgICAgIH0KICAgIH07CiAgICB0aGlzLnRvb2x0aXBDb250ZW50c1VwZGF0ZXIgPSAocG9pbnRJZHgpID0+IHsKICAgICAgdGhpcy5tb2RlbC5zZW5kKHsKICAgICAgICB0eXBlOiB0aGlzLmV2ZW50VHlwZXMuVE9PTFRJUCwKICAgICAgICBpbmRleDogcG9pbnRJZHgsCiAgICAgICAgcHJvcGVydGllczogdGhpcy50b29sdGlwUHJvcGVydGllc05vblZpc3VhbCwKICAgICAgICBwcmV2aWV3OiB0aGlzLnRvb2x0aXBQcmV2aWV3CiAgICAgIH0pOwogICAgICBmb3IgKGNvbnN0IHVwZGF0ZXIgb2YgdmlzdWFsVXBkYXRlcnMpIHsKICAgICAgICB1cGRhdGVyKHBvaW50SWR4KTsKICAgICAgfQogICAgfTsKICB9CiAgc2hvd1Rvb2x0aXAocG9pbnRJZHgpIHsKICAgIHRoaXMucHJldlRvb2x0aXBQb2ludElkeCA9IHZvaWQgMDsKICAgIHRoaXMudG9vbHRpcFBvaW50SWR4ID0gcG9pbnRJZHg7CiAgICBjb25zdCBbeCwgeV0gPSB0aGlzLnNjYXR0ZXJwbG90LmdldFNjcmVlblBvc2l0aW9uKHBvaW50SWR4KTsKICAgIGNvbnN0IG5ld1Rvb2x0aXBQb3NpdGlvbiA9IHRoaXMuZ2V0VG9vbHRpcFBvc2l0aW9uKHgsIHkpOwogICAgaWYgKG5ld1Rvb2x0aXBQb3NpdGlvbiAhPT0gdGhpcy50b29sdGlwUG9zaXRpb24pIHsKICAgICAgdGhpcy50b29sdGlwUG9zaXRpb24gPSBuZXdUb29sdGlwUG9zaXRpb247CiAgICAgIHRoaXMucG9zaXRpb25Ub29sdGlwKHRoaXMudG9vbHRpcFBvc2l0aW9uKTsKICAgIH0KICAgIHRoaXMubW92ZVRvb2x0aXAoeCwgeSk7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50c1VwZGF0ZXIocG9pbnRJZHgpOwogICAgdGhpcy50b29sdGlwLnN0eWxlLm9wYWNpdHkgPSAxOwogIH0KICBoaWRlVG9vbHRpcCgpIHsKICAgIHRoaXMudG9vbHRpcFBvaW50SWR4ID0gdm9pZCAwOwogICAgdGhpcy50b29sdGlwLnN0eWxlLm9wYWNpdHkgPSAwOwogICAgaWYgKHRoaXMudG9vbHRpcFByZXZpZXdWYWx1ZS5ub2RlTmFtZSA9PT0gIkFVRElPIikgewogICAgICB0aGlzLnRvb2x0aXBQcmV2aWV3VmFsdWUucGF1c2UoKTsKICAgICAgdGhpcy50b29sdGlwUHJldmlld1ZhbHVlLmN1cnJlbnRUaW1lID0gMDsKICAgIH0KICB9CiAgdG9vbHRpcEVuYWJsZUhhbmRsZXIodG9vbHRpcCkgewogICAgaWYgKCF0b29sdGlwKSB7CiAgICAgIHRoaXMuaGlkZVRvb2x0aXA7CiAgICB9CiAgfQogIHRvb2x0aXBTaXplSGFuZGxlcihuZXdTaXplKSB7CiAgICB0aGlzLnRvb2x0aXBDb250ZW50LnN0eWxlLmZvbnRTaXplID0gZ2V0VG9vbHRpcEZvbnRTaXplKG5ld1NpemUpOwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiB0aGlzLnRvb2x0aXBQcm9wZXJ0aWVzQWxsKSB7CiAgICAgIHRoaXNbYHRvb2x0aXBQcm9wZXJ0eSR7dG9DYXBpdGFsQ2FzZShwcm9wZXJ0eSl9VmFsdWVIaXN0b2dyYW1gXS5yZXNpemUoKTsKICAgIH0KICB9CiAgdG9vbHRpcENvbG9ySGFuZGxlcigpIHsKICAgIHRoaXMuc3R5bGVUb29sdGlwKCk7CiAgfQogIHJlZnJlc2hUb29sdGlwKCkgewogICAgdGhpcy5jcmVhdGVUb29sdGlwQ29udGVudHMoKTsKICAgIHRoaXMuY3JlYXRlVG9vbHRpcENvbnRlbnRVcGRhdGVyKCk7CiAgfQogIHRvb2x0aXBQcm9wZXJ0aWVzSGFuZGxlcigpIHsKICAgIHRoaXMucmVmcmVzaFRvb2x0aXAoKTsKICB9CiAgdG9vbHRpcFByb3BlcnRpZXNOb25WaXN1YWxJbmZvSGFuZGxlcigpIHsKICAgIHRoaXMucmVmcmVzaFRvb2x0aXAoKTsKICB9CiAgdG9vbHRpcEhpc3RvZ3JhbXNTaXplSGFuZGxlcigpIHsKICAgIHRoaXMucmVmcmVzaFRvb2x0aXAoKTsKICB9CiAgdG9vbHRpcEhpc3RvZ3JhbXNSYW5nZXNIYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVYR2V0dGVyKCk7CiAgICB0aGlzLmNyZWF0ZVlHZXR0ZXIoKTsKICAgIHRoaXMuY3JlYXRlQ29sb3JHZXR0ZXIoKTsKICAgIHRoaXMuY3JlYXRlT3BhY2l0eUdldHRlcigpOwogICAgdGhpcy5jcmVhdGVTaXplR2V0dGVyKCk7CiAgICB0aGlzLnJlZnJlc2hUb29sdGlwKCk7CiAgfQogIHRvb2x0aXBIaXN0b2dyYW1zSGFuZGxlcigpIHsKICAgIHRoaXMuZW5hYmxlVG9vbHRpcEhpc3RvZ3JhbXMoKTsKICB9CiAgdXBkYXRlTGVnZW5kV3JhcHBlclBvc2l0aW9uKCkgewogICAgaWYgKCF0aGlzLmxlZ2VuZFdyYXBwZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5sZWdlbmRXcmFwcGVyLnN0eWxlLnRvcCA9IDA7CiAgICB0aGlzLmxlZ2VuZFdyYXBwZXIuc3R5bGUuYm90dG9tID0gYCR7dGhpcy5nZXRZUGFkZGluZygpfXB4YDsKICAgIHRoaXMubGVnZW5kV3JhcHBlci5zdHlsZS5sZWZ0ID0gMDsKICAgIHRoaXMubGVnZW5kV3JhcHBlci5zdHlsZS5yaWdodCA9IGAke3RoaXMuZ2V0WFBhZGRpbmcoKX1weGA7CiAgfQogIHVwZGF0ZUxlZ2VuZFBvc2l0aW9uKCkgewogICAgaWYgKCF0aGlzLmxlZ2VuZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmxlZ2VuZC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICB0aGlzLmxlZ2VuZC5zdHlsZS50b3AgPSBudWxsOwogICAgdGhpcy5sZWdlbmQuc3R5bGUuYm90dG9tID0gbnVsbDsKICAgIHRoaXMubGVnZW5kLnN0eWxlLmxlZnQgPSBudWxsOwogICAgdGhpcy5sZWdlbmQuc3R5bGUucmlnaHQgPSBudWxsOwogICAgdGhpcy5sZWdlbmQuc3R5bGUudHJhbnNmb3JtID0gbnVsbDsKICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5tb2RlbC5nZXQoImxlZ2VuZF9wb3NpdGlvbiIpOwogICAgbGV0IHRyYW5zbGF0ZVgyID0gMDsKICAgIGxldCB0cmFuc2xhdGVZMiA9IDA7CiAgICBpZiAocG9zaXRpb24uaW5kZXhPZigidG9wIikgPj0gMCkgewogICAgICB0aGlzLmxlZ2VuZC5zdHlsZS50b3AgPSAwOwogICAgfSBlbHNlIGlmIChwb3NpdGlvbi5pbmRleE9mKCJib3R0b20iKSA+PSAwKSB7CiAgICAgIHRoaXMubGVnZW5kLnN0eWxlLmJvdHRvbSA9IDA7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxlZ2VuZC5zdHlsZS50b3AgPSAiNTAlIjsKICAgICAgdHJhbnNsYXRlWTIgPSAiLTUwJSI7CiAgICB9CiAgICBpZiAocG9zaXRpb24uaW5kZXhPZigibGVmdCIpID49IDApIHsKICAgICAgdGhpcy5sZWdlbmQuc3R5bGUubGVmdCA9IDA7CiAgICB9IGVsc2UgaWYgKHBvc2l0aW9uLmluZGV4T2YoInJpZ2h0IikgPj0gMCkgewogICAgICB0aGlzLmxlZ2VuZC5zdHlsZS5yaWdodCA9IDA7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxlZ2VuZC5zdHlsZS5sZWZ0ID0gIjUwJSI7CiAgICAgIHRyYW5zbGF0ZVgyID0gIi01MCUiOwogICAgfQogICAgaWYgKHRyYW5zbGF0ZVgyIHx8IHRyYW5zbGF0ZVkyKSB7CiAgICAgIHRoaXMubGVnZW5kLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHt0cmFuc2xhdGVYMn0sICR7dHJhbnNsYXRlWTJ9KWA7CiAgICB9CiAgfQogIHVwZGF0ZUNvbnRhaW5lckRpbWVuc2lvbnMoKSB7CiAgICBjb25zdCB3aWR0aCA9IHRoaXMuZ2V0V2lkdGgoKTsKICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuZ2V0SGVpZ2h0KCk7CiAgICBsZXQgeFBhZGRpbmcgPSAwOwogICAgbGV0IHlQYWRkaW5nID0gMDsKICAgIGlmICh0aGlzLm1vZGVsLmdldCgiYXhlcyIpKSB7CiAgICAgIHhQYWRkaW5nID0gdGhpcy5nZXRYUGFkZGluZygpOwogICAgICB5UGFkZGluZyA9IHRoaXMuZ2V0WVBhZGRpbmcoKTsKICAgIH0KICAgIGNvbnN0IHdpZHRoQ3NzID0gd2lkdGggPT09ICJhdXRvIiA/ICIxMDAlIiA6IGAke3dpZHRoICsgeFBhZGRpbmd9cHhgOwogICAgY29uc3QgaGVpZ2h0Q3NzID0gaGVpZ2h0ID09PSAiYXV0byIgPyAiMTAwJSIgOiBgJHtoZWlnaHQgKyB5UGFkZGluZ31weGA7CiAgICBpZiAoZG9jdW1lbnQuZnVsbHNjcmVlbkVsZW1lbnQpIHsKICAgICAgdGhpcy5mdWxsc2NyZWVuQ29udGFpbmVyLnN0eWxlLndpZHRoID0gIjEwMCUiOwogICAgICB0aGlzLmZ1bGxzY3JlZW5Db250YWluZXIuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5mdWxsc2NyZWVuQ29udGFpbmVyLnN0eWxlLndpZHRoID0gd2lkdGhDc3M7CiAgICAgIHRoaXMuZnVsbHNjcmVlbkNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBoZWlnaHRDc3M7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS53aWR0aCA9IHdpZHRoQ3NzOwogICAgdGhpcy5jb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0Q3NzOwogICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgIHRoaXMucmVzaXplSGFuZGxlckJvdW5kKCk7CiAgICB9KTsKICB9CiAgcmVzaXplSGFuZGxlcigpIHsKICAgIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuZ2V0T3V0ZXJEaW1lbnNpb25zKCk7CiAgICB0aGlzLmNhbnZhc0xhYmVscy53aWR0aCA9IHRoaXMuaW5uZXJXaWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgdGhpcy5jYW52YXNMYWJlbHMuaGVpZ2h0ID0gdGhpcy5pbm5lckhlaWdodCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgdGhpcy5jcmVhdGVWaWV3VG9MYWJlbFRpbGVzKCk7CiAgICB0aGlzLnJlbmRlckxhYmVscygpOwogICAgaWYgKCF0aGlzLm1vZGVsLmdldCgiYXhlcyIpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IFt4TGFiZWwsIHlMYWJlbF0gPSB0aGlzLm1vZGVsLmdldCgiYXhlc19sYWJlbHMiKSB8fCBbXTsKICAgIGNvbnN0IHhQYWRkaW5nID0gdGhpcy5nZXRYUGFkZGluZygpOwogICAgY29uc3QgeVBhZGRpbmcgPSB0aGlzLmdldFlQYWRkaW5nKCk7CiAgICBjb25zdCB4U2NhbGVEb21haW4gPSB0aGlzLnNjYXR0ZXJwbG90LmdldCgieFNjYWxlIikuZG9tYWluKCk7CiAgICBjb25zdCB5U2NhbGVEb21haW4gPSB0aGlzLnNjYXR0ZXJwbG90LmdldCgieVNjYWxlIikuZG9tYWluKCk7CiAgICB0aGlzLnhTY2FsZUF4aXMuZG9tYWluKHhTY2FsZURvbWFpbi5tYXAodGhpcy54U2NhbGVSZWdsMkF4aXMuaW52ZXJ0KSk7CiAgICB0aGlzLnlTY2FsZUF4aXMuZG9tYWluKHlTY2FsZURvbWFpbi5tYXAodGhpcy55U2NhbGVSZWdsMkF4aXMuaW52ZXJ0KSk7CiAgICB0aGlzLnhBeGlzQ29udGFpbmVyLmNhbGwodGhpcy54QXhpcy5zY2FsZSh0aGlzLnhTY2FsZUF4aXMpKTsKICAgIHRoaXMueUF4aXNDb250YWluZXIuY2FsbCh0aGlzLnlBeGlzLnNjYWxlKHRoaXMueVNjYWxlQXhpcykpOwogICAgdGhpcy54U2NhbGVBeGlzLnJhbmdlKFswLCB3aWR0aCAtIHhQYWRkaW5nXSk7CiAgICB0aGlzLnlTY2FsZUF4aXMucmFuZ2UoW2hlaWdodCAtIHlQYWRkaW5nLCAwXSk7CiAgICB0aGlzLnhBeGlzLnNjYWxlKHRoaXMueFNjYWxlQXhpcyk7CiAgICB0aGlzLnlBeGlzLnNjYWxlKHRoaXMueVNjYWxlQXhpcyk7CiAgICB0aGlzLnhBeGlzQ29udGFpbmVyLmF0dHIoInRyYW5zZm9ybSIsIGB0cmFuc2xhdGUoMCwgJHtoZWlnaHQgLSB5UGFkZGluZ30pYCkuY2FsbCh0aGlzLnhBeGlzKTsKICAgIHRoaXMueUF4aXNDb250YWluZXIuYXR0cigidHJhbnNmb3JtIiwgYHRyYW5zbGF0ZSgke3dpZHRoIC0geFBhZGRpbmd9LCAwKWApLmNhbGwodGhpcy55QXhpcyk7CiAgICB0aGlzLnVwZGF0ZUxlZ2VuZFdyYXBwZXJQb3NpdGlvbigpOwogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJ3aWR0aCIsIHRoaXMuZ2V0V2lkdGgpOwogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJoZWlnaHQiLCB0aGlzLmdldEhlaWdodCk7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoImF4ZXNfZ3JpZCIpKSB7CiAgICAgIHRoaXMueEF4aXMudGlja1NpemVJbm5lcigtKGhlaWdodCAtIHlQYWRkaW5nKSk7CiAgICAgIHRoaXMueUF4aXMudGlja1NpemVJbm5lcigtKHdpZHRoIC0geFBhZGRpbmcpKTsKICAgICAgdGhpcy5heGVzU3ZnLnNlbGVjdEFsbCgibGluZSIpLmF0dHIoInN0cm9rZS1vcGFjaXR5IiwgMC4yKS5hdHRyKCJzdHJva2UtZGFzaGFycmF5IiwgMik7CiAgICB9CiAgICBpZiAoeExhYmVsKSB7CiAgICAgIHRoaXMueEF4aXNMYWJlbC5hdHRyKCJ4IiwgKHdpZHRoIC0geFBhZGRpbmcpIC8gMikuYXR0cigieSIsIGhlaWdodCAtIDQpOwogICAgfQogICAgaWYgKHlMYWJlbCkgewogICAgICB0aGlzLnlBeGlzTGFiZWwuYXR0cigieCIsIChoZWlnaHQgLSB5UGFkZGluZykgLyAyKS5hdHRyKCJ5IiwgLXdpZHRoKTsKICAgIH0KICB9CiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmNhbnZhc1Jlc2l6ZU9ic2VydmVyKSB7CiAgICAgIHRoaXMuY2FudmFzUmVzaXplT2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgfSBlbHNlIHsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHRoaXMucmVzaXplSGFuZGxlckJvdW5kKTsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm9yaWVudGF0aW9uY2hhbmdlIiwgdGhpcy5yZXNpemVIYW5kbGVyQm91bmQpOwogICAgfQogICAgZ2xvYmFsUHViU3ViLnVuc3Vic2NyaWJlKAogICAgICAianNjYXR0ZXI6OnZpZXciLAogICAgICB0aGlzLmV4dGVybmFsVmlld0NoYW5nZUhhbmRsZXJCb3VuZAogICAgKTsKICAgIHRoaXMuc2NhdHRlcnBsb3QudW5zdWJzY3JpYmUoInBvaW50b3ZlciIsIHRoaXMucG9pbnRvdmVySGFuZGxlckJvdW5kKTsKICAgIHRoaXMuc2NhdHRlcnBsb3QudW5zdWJzY3JpYmUoInBvaW50b3V0IiwgdGhpcy5wb2ludG91dEhhbmRsZXJCb3VuZCk7CiAgICB0aGlzLnNjYXR0ZXJwbG90LnVuc3Vic2NyaWJlKCJzZWxlY3QiLCB0aGlzLnNlbGVjdEhhbmRsZXJCb3VuZCk7CiAgICB0aGlzLnNjYXR0ZXJwbG90LnVuc3Vic2NyaWJlKCJkZXNlbGVjdCIsIHRoaXMuZGVzZWxlY3RIYW5kbGVyQm91bmQpOwogICAgdGhpcy5zY2F0dGVycGxvdC51bnN1YnNjcmliZSgiZmlsdGVyIiwgdGhpcy5maWx0ZXJFdmVudEhhbmRsZXJCb3VuZCk7CiAgICB0aGlzLnNjYXR0ZXJwbG90LnVuc3Vic2NyaWJlKCJ2aWV3IiwgdGhpcy52aWV3Q2hhbmdlSGFuZGxlckJvdW5kKTsKICAgIHRoaXMuc2hvd1Rvb2x0aXBEZWJvdW5jZWQuY2FuY2VsKCk7CiAgICB0aGlzLnNjYXR0ZXJwbG90LmRlc3Ryb3koKTsKICAgIHRoaXMuZ3JlYXRHcmFuZFBhcmVudEVsZW1lbnQ/LnJlbW92ZUV2ZW50TGlzdGVuZXIoCiAgICAgICJmdWxsc2NyZWVuY2hhbmdlIiwKICAgICAgdGhpcy5mdWxsc2NyZWVuQ2hhbmdlSGFuZGxlckJvdW5kCiAgICApOwogICAgdGhpcy5mdWxsc2NyZWVuT2JzZXJ2ZXI/LmRpc2Nvbm5lY3QoKTsKICB9CiAgLy8gSGVscGVyCiAgY29sb3JDYW52YXMoKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmJhY2tncm91bmRDb2xvcikpIHsKICAgICAgY29uc3QgcmdiU3RyID0gdGhpcy5iYWNrZ3JvdW5kQ29sb3Iuc2xpY2UoMCwgMykubWFwKCh4KSA9PiB4ICogMjU1KS5qb2luKCIsIik7CiAgICAgIGNvbnN0IGNvbG9yU3RyID0gdGhpcy5iYWNrZ3JvdW5kQ29sb3IubGVuZ3RoID09PSA0ID8gYHJnYmEoJHtyZ2JTdHJ9LCAke3RoaXMuYmFja2dyb3VuZENvbG9yWzNdfSlgIDogYHJnYigke3JnYlN0cn0pYDsKICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3JTdHI7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLmJhY2tncm91bmRDb2xvcjsKICAgIH0KICB9CiAgYW5ub3RhdGlvbnNIYW5kbGVyKGFubm90YXRpb25zKSB7CiAgICB0aGlzLnNjYXR0ZXJwbG90LmRyYXdBbm5vdGF0aW9ucyhhbm5vdGF0aW9ucyB8fCBbXSk7CiAgfQogIC8vIEV2ZW50IGhhbmRsZXJzIGZvciBKUy10cmlnZ2VyZWQgZXZlbnRzCiAgcG9pbnRvdmVySGFuZGxlcihwb2ludEluZGV4KSB7CiAgICB0aGlzLmhvdmVyaW5nQ2hhbmdlZEJ5SnMgPSB0cnVlOwogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX2VuYWJsZSIpKSB7CiAgICAgIHRoaXMuc2hvd1Rvb2x0aXBEZWJvdW5jZWQocG9pbnRJbmRleCk7CiAgICB9CiAgICB0aGlzLm1vZGVsLnNldCgiaG92ZXJpbmciLCBwb2ludEluZGV4KTsKICAgIHRoaXMubW9kZWwuc2F2ZV9jaGFuZ2VzKCk7CiAgfQogIHBvaW50b3V0SGFuZGxlcigpIHsKICAgIHRoaXMuaG92ZXJpbmdDaGFuZ2VkQnlKcyA9IHRydWU7CiAgICB0aGlzLnNob3dUb29sdGlwRGVib3VuY2VkLmNhbmNlbCgpOwogICAgdGhpcy5oaWRlVG9vbHRpcCgpOwogICAgdGhpcy5tb2RlbC5zZXQoImhvdmVyaW5nIiwgbnVsbCk7CiAgICB0aGlzLm1vZGVsLnNhdmVfY2hhbmdlcygpOwogIH0KICBzZWxlY3RIYW5kbGVyKGV2ZW50KSB7CiAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWRCeUpzID0gdHJ1ZTsKICAgIGlmICh0aGlzLm1vZGVsLmdldCgiem9vbV9vbl9zZWxlY3Rpb24iKSkgewogICAgICB0aGlzLnpvb21Ub0hhbmRsZXIoZXZlbnQucG9pbnRzKTsKICAgIH0KICAgIHRoaXMubW9kZWwuc2V0KCJzZWxlY3Rpb24iLCBbLi4uZXZlbnQucG9pbnRzXSk7CiAgICB0aGlzLm1vZGVsLnNhdmVfY2hhbmdlcygpOwogIH0KICBkZXNlbGVjdEhhbmRsZXIoKSB7CiAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWRCeUpzID0gdHJ1ZTsKICAgIGlmICh0aGlzLm1vZGVsLmdldCgiem9vbV9vbl9zZWxlY3Rpb24iKSkgewogICAgICB0aGlzLnpvb21Ub0hhbmRsZXIoKTsKICAgIH0KICAgIHRoaXMubW9kZWwuc2V0KCJzZWxlY3Rpb24iLCBbXSk7CiAgICB0aGlzLm1vZGVsLnNldCgibGFzc29fc2VsZWN0aW9uX3BvbHlnb24iLCBbXSk7CiAgICB0aGlzLm1vZGVsLnNhdmVfY2hhbmdlcygpOwogIH0KICBsYXNzb0VuZEhhbmRsZXIoZXZlbnQpIHsKICAgIGNvbnN0IGRhdGFDb29yZGluYXRlcyA9IGV2ZW50LmNvb3JkaW5hdGVzLm1hcCgoW3gsIHldKSA9PiB7CiAgICAgIHJldHVybiBbdGhpcy54U2NhbGUuaW52ZXJ0KHgpLCB0aGlzLnlTY2FsZS5pbnZlcnQoeSldOwogICAgfSk7CiAgICB0aGlzLm1vZGVsLnNldCgibGFzc29fc2VsZWN0aW9uX3BvbHlnb24iLCBkYXRhQ29vcmRpbmF0ZXMpOwogICAgdGhpcy5tb2RlbC5zYXZlX2NoYW5nZXMoKTsKICB9CiAgZmlsdGVyRXZlbnRIYW5kbGVyKGV2ZW50KSB7CiAgICB0aGlzLmZpbHRlckNoYW5nZWRCeUpzID0gdHJ1ZTsKICAgIGlmICh0aGlzLm1vZGVsLmdldCgiem9vbV9vbl9maWx0ZXIiKSkgewogICAgICB0aGlzLnpvb21Ub0hhbmRsZXIoZXZlbnQucG9pbnRzKTsKICAgIH0KICAgIHRoaXMubW9kZWwuc2V0KCJmaWx0ZXIiLCBbLi4uZXZlbnQucG9pbnRzXSk7CiAgICB0aGlzLm1vZGVsLnNhdmVfY2hhbmdlcygpOwogIH0KICB2aWV3U3luY0hhbmRsZXIodmlld1N5bmMpIHsKICAgIGlmICh2aWV3U3luYykgewogICAgICBnbG9iYWxQdWJTdWIuc3Vic2NyaWJlKAogICAgICAgICJqc2NhdHRlcjo6dmlldyIsCiAgICAgICAgdGhpcy5leHRlcm5hbFZpZXdDaGFuZ2VIYW5kbGVyQm91bmQKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGdsb2JhbFB1YlN1Yi51bnN1YnNjcmliZSgKICAgICAgICAianNjYXR0ZXI6OnZpZXciLAogICAgICAgIHRoaXMuZXh0ZXJuYWxWaWV3Q2hhbmdlSGFuZGxlckJvdW5kCiAgICAgICk7CiAgICB9CiAgfQogIHVwZGF0ZUF4ZXMoeFNjYWxlRG9tYWluLCB5U2NhbGVEb21haW4pIHsKICAgIGlmICghdGhpcy5tb2RlbC5nZXQoImF4ZXMiKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnhTY2FsZUF4aXMuZG9tYWluKHhTY2FsZURvbWFpbi5tYXAodGhpcy54U2NhbGVSZWdsMkF4aXMuaW52ZXJ0KSk7CiAgICB0aGlzLnlTY2FsZUF4aXMuZG9tYWluKHlTY2FsZURvbWFpbi5tYXAodGhpcy55U2NhbGVSZWdsMkF4aXMuaW52ZXJ0KSk7CiAgICB0aGlzLnhBeGlzQ29udGFpbmVyLmNhbGwodGhpcy54QXhpcy5zY2FsZSh0aGlzLnhTY2FsZUF4aXMpKTsKICAgIHRoaXMueUF4aXNDb250YWluZXIuY2FsbCh0aGlzLnlBeGlzLnNjYWxlKHRoaXMueVNjYWxlQXhpcykpOwogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJheGVzX2dyaWQiKSkgewogICAgICB0aGlzLmF4ZXNTdmcuc2VsZWN0QWxsKCJsaW5lIikuYXR0cigic3Ryb2tlLW9wYWNpdHkiLCAwLjIpLmF0dHIoInN0cm9rZS1kYXNoYXJyYXkiLCAyKTsKICAgIH0KICB9CiAgZXh0ZXJuYWxWaWV3Q2hhbmdlSGFuZGxlcihldmVudCkgewogICAgaWYgKGV2ZW50LnV1aWQgPT09IHRoaXMudmlld1N5bmMgJiYgZXZlbnQuc3JjICE9PSB0aGlzLnJhbmRvbVN0cikgewogICAgICB0aGlzLnNjYXR0ZXJwbG90LnZpZXcoZXZlbnQudmlldywgeyBwcmV2ZW50RXZlbnQ6IHRydWUgfSk7CiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgiYXhlcyIpKSB7CiAgICAgICAgdGhpcy51cGRhdGVBeGVzKHRoaXMueFNjYWxlUmVnbC5kb21haW4oKSwgdGhpcy55U2NhbGVSZWdsLmRvbWFpbigpKTsKICAgICAgfQogICAgfQogIH0KICB1cGRhdGVMYWJlbFRpbGVzKHhEb21haW4sIHlEb21haW4sIHpvb21TY2FsZSkgewogICAgaWYgKCF0aGlzLnZpZXdUb0xhYmVsVGlsZXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbmV3VGlsZXMgPSB0aGlzLnZpZXdUb0xhYmVsVGlsZXMoeERvbWFpbiwgeURvbWFpbiwgem9vbVNjYWxlKTsKICAgIGlmIChuZXdUaWxlcy5zb21lKCh0aWxlKSA9PiAhdGhpcy5sYWJlbFRpbGVzLmhhcyh0aWxlKSkpIHsKICAgICAgdGhpcy5sYWJlbFRpbGVzID0gbmV3IFNldChuZXdUaWxlcyk7CiAgICAgIHRoaXMubW9kZWwuc2V0KCJsYWJlbF90aWxlcyIsIG5ld1RpbGVzKTsKICAgICAgdGhpcy5tb2RlbC5zYXZlX2NoYW5nZXMoKTsKICAgIH0KICB9CiAgdXBkYXRlWm9vbUxldmVsKHpvb21TY2FsZSkgewogICAgdGhpcy5tb2RlbC5zZXQoInpvb21fbGV2ZWwiLCBNYXRoLmxvZzIoem9vbVNjYWxlKSk7CiAgICB0aGlzLm1vZGVsLnNhdmVfY2hhbmdlcygpOwogIH0KICB2aWV3Q2hhbmdlSGFuZGxlcihldmVudCkgewogICAgaWYgKHRoaXMudmlld1N5bmMpIHsKICAgICAgZ2xvYmFsUHViU3ViLnB1Ymxpc2goCiAgICAgICAgImpzY2F0dGVyOjp2aWV3IiwKICAgICAgICB7CiAgICAgICAgICBzcmM6IHRoaXMucmFuZG9tU3RyLAogICAgICAgICAgdXVpZDogdGhpcy52aWV3U3luYywKICAgICAgICAgIHZpZXc6IGV2ZW50LnZpZXcsCiAgICAgICAgICB4U2NhbGVEb21haW46IGV2ZW50LnhTY2FsZT8uZG9tYWluKCksCiAgICAgICAgICB5U2NhbGVEb21haW46IGV2ZW50LnlTY2FsZT8uZG9tYWluKCkKICAgICAgICB9LAogICAgICAgIHsgYXN5bmM6IHRydWUgfQogICAgICApOwogICAgfQogICAgaWYgKHRoaXMubW9kZWwuZ2V0KCJheGVzIikpIHsKICAgICAgdGhpcy51cGRhdGVBeGVzKGV2ZW50LnhTY2FsZS5kb21haW4oKSwgZXZlbnQueVNjYWxlLmRvbWFpbigpKTsKICAgIH0KICAgIGlmIChldmVudC54U2NhbGUgJiYgZXZlbnQueVNjYWxlKSB7CiAgICAgIHRoaXMudXBkYXRlTGFiZWxUaWxlc0RlYm91bmNlZCgKICAgICAgICBldmVudC54U2NhbGUuZG9tYWluKCksCiAgICAgICAgZXZlbnQueVNjYWxlLmRvbWFpbigpLAogICAgICAgIGV2ZW50LmNhbWVyYS5zY2FsaW5nWzBdCiAgICAgICk7CiAgICB9CiAgICB0aGlzLnVwZGF0ZVpvb21MZXZlbERlYm91bmNlZChldmVudC5jYW1lcmEuc2NhbGluZ1swXSk7CiAgICBpZiAodGhpcy50b29sdGlwUG9pbnRJZHgpIHsKICAgICAgdGhpcy5wcmV2VG9vbHRpcFBvaW50SWR4ID0gdGhpcy50b29sdGlwUG9pbnRJZHg7CiAgICAgIHRoaXMuaGlkZVRvb2x0aXAoKTsKICAgIH0KICAgIGlmICh0aGlzLnByZXZUb29sdGlwUG9pbnRJZHgpIHsKICAgICAgdGhpcy5zaG93VG9vbHRpcERlYm91bmNlZCh0aGlzLnByZXZUb29sdGlwUG9pbnRJZHgpOwogICAgfQogIH0KICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBYU2NhbGUgc3RhbmRzIGZvciBYIFNjYWxlCiAgY3JlYXRlWFNjYWxlKCkgewogICAgY29uc3QgZG9tYWluID0gdGhpcy5tb2RlbC5nZXQoInhfc2NhbGVfZG9tYWluIik7CiAgICBjb25zdCBzY2FsZSA9IHRoaXMubW9kZWwuZ2V0KCJ4X3NjYWxlIik7CiAgICB0aGlzLnhTY2FsZSA9IGdldFNjYWxlKHNjYWxlKS5kb21haW4oZG9tYWluKS5yYW5nZShbLTEsIDFdKTsKICAgIHRoaXMueEZvcm1hdCA9IHNjYWxlID09PSAidGltZSIgPyBjcmVhdGVUaW1lRm9ybWF0KAogICAgICB0aGlzLnBvaW50cywKICAgICAgKHBvaW50KSA9PiBNYXRoLmZsb29yKHRoaXMueFNjYWxlLmludmVydChwb2ludFswXSkuZ2V0VGltZSgpIC8gMWUzKQogICAgKSA6IGZvcm1hdChnZXREM0Zvcm1hdFNwZWNpZmllcihkb21haW4pKTsKICB9CiAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogWVNjYWxlIHN0YW5kcyBmb3IgWSBTY2FsZQogIGNyZWF0ZVlTY2FsZSgpIHsKICAgIGNvbnN0IGRvbWFpbiA9IHRoaXMubW9kZWwuZ2V0KCJ5X3NjYWxlX2RvbWFpbiIpOwogICAgY29uc3Qgc2NhbGUgPSB0aGlzLm1vZGVsLmdldCgieV9zY2FsZSIpOwogICAgdGhpcy55U2NhbGUgPSBnZXRTY2FsZShzY2FsZSkuZG9tYWluKGRvbWFpbikucmFuZ2UoWy0xLCAxXSk7CiAgICB0aGlzLnlGb3JtYXQgPSBzY2FsZSA9PT0gInRpbWUiID8gY3JlYXRlVGltZUZvcm1hdCh0aGlzLnBvaW50cywgKHApID0+IHRoaXMueVNjYWxlLmludmVydChwWzFdKSkgOiBmb3JtYXQoZ2V0RDNGb3JtYXRTcGVjaWZpZXIoZG9tYWluKSk7CiAgfQogIGNyZWF0ZUNvbG9yU2NhbGUoKSB7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoImNvbG9yX2J5IikpIHsKICAgICAgY29uc3Qgc2NhbGVUeXBlID0gdGhpcy5tb2RlbC5nZXQoImNvbG9yX3NjYWxlIik7CiAgICAgIGNvbnN0IHNjYWxlID0gZ2V0U2NhbGUoc2NhbGVUeXBlKTsKICAgICAgY29uc3QgZG9tYWluID0gdGhpcy5tb2RlbC5nZXQoImNvbG9yX2RvbWFpbiIpOwogICAgICBpZiAoc2NhbGVUeXBlID09PSAiY2F0ZWdvcmljYWwiKSB7CiAgICAgICAgdGhpcy5jb2xvclNjYWxlID0gc2NhbGUuZG9tYWluKE9iamVjdC5rZXlzKGRvbWFpbikpLnJhbmdlKE9iamVjdC52YWx1ZXMoZG9tYWluKSk7CiAgICAgICAgdGhpcy5jb2xvclNjYWxlLmludmVydCA9IGNyZWF0ZU9yZGluYWxTY2FsZUludmVydGVyKGRvbWFpbik7CiAgICAgICAgdGhpcy5jb2xvckZvcm1hdCA9IChzKSA9PiBzOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY29sb3JTY2FsZSA9IHNjYWxlLmRvbWFpbihkb21haW4pLnJhbmdlKFswLCAxXSk7CiAgICAgICAgdGhpcy5jb2xvckZvcm1hdCA9IGZvcm1hdChnZXREM0Zvcm1hdFNwZWNpZmllcihkb21haW4pKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5jb2xvclNjYWxlID0gdm9pZCAwOwogICAgICB0aGlzLmNvbG9yRm9ybWF0ID0gdm9pZCAwOwogICAgfQogIH0KICBjcmVhdGVPcGFjaXR5U2NhbGUoKSB7CiAgICBjb25zdCBvcGFjaXR5QnkgPSB0aGlzLm1vZGVsLmdldCgib3BhY2l0eV9ieSIpOwogICAgaWYgKG9wYWNpdHlCeSAmJiBvcGFjaXR5QnkgIT09ICJkZW5zaXR5IikgewogICAgICBjb25zdCBzY2FsZVR5cGUgPSB0aGlzLm1vZGVsLmdldCgib3BhY2l0eV9zY2FsZSIpOwogICAgICBjb25zdCBzY2FsZSA9IGdldFNjYWxlKHNjYWxlVHlwZSk7CiAgICAgIGNvbnN0IGRvbWFpbiA9IHRoaXMubW9kZWwuZ2V0KCJvcGFjaXR5X2RvbWFpbiIpOwogICAgICBpZiAoc2NhbGVUeXBlID09PSAiY2F0ZWdvcmljYWwiKSB7CiAgICAgICAgdGhpcy5vcGFjaXR5U2NhbGUgPSBzY2FsZS5kb21haW4oT2JqZWN0LmtleXMoZG9tYWluKSkucmFuZ2UoT2JqZWN0LnZhbHVlcyhkb21haW4pKTsKICAgICAgICB0aGlzLm9wYWNpdHlTY2FsZS5pbnZlcnQgPSBjcmVhdGVPcmRpbmFsU2NhbGVJbnZlcnRlcihkb21haW4pOwogICAgICAgIHRoaXMub3BhY2l0eUZvcm1hdCA9IChzKSA9PiBzOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3BhY2l0eVNjYWxlID0gc2NhbGUuZG9tYWluKGRvbWFpbikucmFuZ2UoWzAsIDFdKTsKICAgICAgICB0aGlzLm9wYWNpdHlGb3JtYXQgPSBmb3JtYXQoZ2V0RDNGb3JtYXRTcGVjaWZpZXIoZG9tYWluKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMub3BhY2l0eVNjYWxlID0gdm9pZCAwOwogICAgICB0aGlzLm9wYWNpdHlGb3JtYXQgPSB2b2lkIDA7CiAgICB9CiAgfQogIGNyZWF0ZVNpemVTY2FsZSgpIHsKICAgIGlmICh0aGlzLm1vZGVsLmdldCgic2l6ZV9ieSIpKSB7CiAgICAgIGNvbnN0IHNjYWxlVHlwZSA9IHRoaXMubW9kZWwuZ2V0KCJzaXplX3NjYWxlIik7CiAgICAgIGNvbnN0IHNjYWxlID0gZ2V0U2NhbGUoc2NhbGVUeXBlKTsKICAgICAgY29uc3QgZG9tYWluID0gdGhpcy5tb2RlbC5nZXQoInNpemVfZG9tYWluIik7CiAgICAgIGlmIChzY2FsZVR5cGUgPT09ICJjYXRlZ29yaWNhbCIpIHsKICAgICAgICB0aGlzLnNpemVTY2FsZSA9IHNjYWxlLmRvbWFpbihPYmplY3Qua2V5cyhkb21haW4pKS5yYW5nZShPYmplY3QudmFsdWVzKGRvbWFpbikpOwogICAgICAgIHRoaXMuc2l6ZVNjYWxlLmludmVydCA9IGNyZWF0ZU9yZGluYWxTY2FsZUludmVydGVyKGRvbWFpbik7CiAgICAgICAgdGhpcy5zaXplRm9ybWF0ID0gKHMpID0+IHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zaXplU2NhbGUgPSBzY2FsZS5kb21haW4oZG9tYWluKS5yYW5nZShbMCwgMV0pOwogICAgICAgIHRoaXMuc2l6ZUZvcm1hdCA9IGZvcm1hdChnZXREM0Zvcm1hdFNwZWNpZmllcihkb21haW4pKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zaXplU2NhbGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuc2l6ZUZvcm1hdCA9IHZvaWQgMDsKICAgIH0KICB9CiAgeFNjYWxlSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlWFNjYWxlKCk7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoImF4ZXMiKSkgewogICAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICAgIH0KICB9CiAgeVNjYWxlSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlWVNjYWxlKCk7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoImF4ZXMiKSkgewogICAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICAgIH0KICB9CiAgeFNjYWxlRG9tYWluSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlWFNjYWxlKCk7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoImF4ZXMiKSkgewogICAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICAgIH0KICB9CiAgeVNjYWxlRG9tYWluSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlWVNjYWxlKCk7CiAgICBpZiAodGhpcy5tb2RlbC5nZXQoImF4ZXMiKSkgewogICAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICAgIH0KICB9CiAgY29sb3JEb21haW5IYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVDb2xvclNjYWxlKCk7CiAgfQogIG9wYWNpdHlEb21haW5IYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVPcGFjaXR5U2NhbGUoKTsKICB9CiAgc2l6ZURvbWFpbkhhbmRsZXIoKSB7CiAgICB0aGlzLmNyZWF0ZVNpemVTY2FsZSgpOwogIH0KICB4SGlzdG9ncmFtSGFuZGxlcigpIHsKICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WFZhbHVlSGlzdG9ncmFtPy5pbml0KHRoaXMubW9kZWwuZ2V0KCJ4X2hpc3RvZ3JhbSIpKTsKICAgIHRoaXMuY3JlYXRlWEdldHRlcigpOwogIH0KICB4SGlzdG9ncmFtUmFuZ2VIYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVYR2V0dGVyKCk7CiAgfQogIHlIaXN0b2dyYW1IYW5kbGVyKCkgewogICAgdGhpcy50b29sdGlwUHJvcGVydHlZVmFsdWVIaXN0b2dyYW0/LmluaXQodGhpcy5tb2RlbC5nZXQoInlfaGlzdG9ncmFtIikpOwogICAgdGhpcy5jcmVhdGVZR2V0dGVyKCk7CiAgfQogIHlIaXN0b2dyYW1SYW5nZUhhbmRsZXIoKSB7CiAgICB0aGlzLmNyZWF0ZVlHZXR0ZXIoKTsKICB9CiAgY29sb3JIaXN0b2dyYW1IYW5kbGVyKCkgewogICAgdGhpcy50b29sdGlwUHJvcGVydHlDb2xvclZhbHVlSGlzdG9ncmFtPy5pbml0KAogICAgICB0aGlzLm1vZGVsLmdldCgiY29sb3JfaGlzdG9ncmFtIiksCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJjb2xvcl9zY2FsZSIpID09PSAiY2F0ZWdvcmljYWwiCiAgICApOwogICAgdGhpcy5jcmVhdGVDb2xvckdldHRlcigpOwogIH0KICBjb2xvckhpc3RvZ3JhbVJhbmdlSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlQ29sb3JHZXR0ZXIoKTsKICB9CiAgb3BhY2l0eUhpc3RvZ3JhbUhhbmRsZXIoKSB7CiAgICB0aGlzLnRvb2x0aXBQcm9wZXJ0eU9wYWNpdHlWYWx1ZUhpc3RvZ3JhbT8uaW5pdCgKICAgICAgdGhpcy5tb2RlbC5nZXQoIm9wYWNpdHlfaGlzdG9ncmFtIiksCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJvcGFjaXR5X3NjYWxlIikgPT09ICJjYXRlZ29yaWNhbCIKICAgICk7CiAgICB0aGlzLmNyZWF0ZU9wYWNpdHlHZXR0ZXIoKTsKICB9CiAgb3BhY2l0eUhpc3RvZ3JhbVJhbmdlSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlT3BhY2l0eUdldHRlcigpOwogIH0KICBzaXplSGlzdG9ncmFtSGFuZGxlcigpIHsKICAgIHRoaXMudG9vbHRpcFByb3BlcnR5U2l6ZVZhbHVlSGlzdG9ncmFtPy5pbml0KAogICAgICB0aGlzLm1vZGVsLmdldCgic2l6ZV9oaXN0b2dyYW0iKSwKICAgICAgdGhpcy5tb2RlbC5nZXQoInNpemVfc2NhbGUiKSA9PT0gImNhdGVnb3JpY2FsIgogICAgKTsKICAgIHRoaXMuY3JlYXRlU2l6ZUdldHRlcigpOwogIH0KICBzaXplSGlzdG9ncmFtUmFuZ2VIYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVTaXplR2V0dGVyKCk7CiAgfQogIC8vIEV2ZW50IGhhbmRsZXJzIGZvciBQeXRob24tdHJpZ2dlcmVkIGV2ZW50cwogIHBvaW50c0hhbmRsZXIobmV3UG9pbnRzKSB7CiAgICBpZiAobmV3UG9pbnRzLmxlbmd0aCA9PT0gdGhpcy5zY2F0dGVycGxvdC5nZXQoInBvaW50cyIpLmxlbmd0aCkgewogICAgICB0aGlzLnNjYXR0ZXJwbG90LmRyYXcobmV3UG9pbnRzLCB7CiAgICAgICAgdHJhbnNpdGlvbjogdGhpcy5tb2RlbC5nZXQoInRyYW5zaXRpb25fcG9pbnRzIiksCiAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0aGlzLm1vZGVsLmdldCgidHJhbnNpdGlvbl9wb2ludHNfZHVyYXRpb24iKSwKICAgICAgICB0cmFuc2l0aW9uRWFzaW5nOiAicXVhZEluT3V0IiwKICAgICAgICBwcmV2ZW50RmlsdGVyUmVzZXQ6IHRoaXMubW9kZWwuZ2V0KCJwcmV2ZW50X2ZpbHRlcl9yZXNldCIpLAogICAgICAgIHNwYXRpYWxJbmRleDogdGhpcy5tb2RlbC5nZXQoIm5vbl9zcGF0aWFsX3BvaW50c191cGRhdGUiKSA/IHRoaXMuc2NhdHRlcnBsb3QuZ2V0KCJzcGF0aWFsSW5kZXgiKSA6IHZvaWQgMAogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3QuZGVzZWxlY3QoKTsKICAgICAgdGhpcy5zY2F0dGVycGxvdC5kcmF3KG5ld1BvaW50cyk7CiAgICB9CiAgfQogIHNlbGVjdGlvbkhhbmRsZXIocG9pbnRJZHhzKSB7CiAgICBpZiAodGhpcy5zZWxlY3Rpb25DaGFuZ2VkQnlKcykgewogICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZWRCeUpzID0gdm9pZCAwOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzZWxlY3Rpb24yID0gcG9pbnRJZHhzPy5sZW5ndGggPiAwID8gcG9pbnRJZHhzIDogdm9pZCAwOwogICAgY29uc3Qgb3B0aW9ucyA9IHsgcHJldmVudEV2ZW50OiB0cnVlIH07CiAgICBpZiAoc2VsZWN0aW9uMikgewogICAgICB0aGlzLnNjYXR0ZXJwbG90LnNlbGVjdChzZWxlY3Rpb24yLCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3QuZGVzZWxlY3Qob3B0aW9ucyk7CiAgICAgIHRoaXMubW9kZWwuc2V0KCJsYXNzb19zZWxlY3Rpb25fcG9seWdvbiIsIFtdKTsKICAgICAgdGhpcy5tb2RlbC5zYXZlX2NoYW5nZXMoKTsKICAgIH0KICAgIGlmICh0aGlzLm1vZGVsLmdldCgiem9vbV9vbl9zZWxlY3Rpb24iKSkgewogICAgICB0aGlzLnpvb21Ub0hhbmRsZXIoc2VsZWN0aW9uMik7CiAgICB9CiAgfQogIGZpbHRlckhhbmRsZXIocG9pbnRJZHhzKSB7CiAgICBpZiAodGhpcy5maWx0ZXJDaGFuZ2VkQnlKcykgewogICAgICB0aGlzLmZpbHRlckNoYW5nZWRCeUpzID0gdm9pZCAwOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocG9pbnRJZHhzKSB7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3QuZmlsdGVyKHBvaW50SWR4cywgeyBwcmV2ZW50RXZlbnQ6IHRydWUgfSk7CiAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgiem9vbV9vbl9maWx0ZXIiKSkgewogICAgICAgIHRoaXMuem9vbVRvSGFuZGxlcihwb2ludElkeHMpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLnNjYXR0ZXJwbG90LnVuZmlsdGVyKHsgcHJldmVudEV2ZW50OiB0cnVlIH0pOwogICAgICBpZiAodGhpcy5tb2RlbC5nZXQoInpvb21fb25fZmlsdGVyIikpIHsKICAgICAgICB0aGlzLnpvb21Ub0hhbmRsZXIoKTsKICAgICAgfQogICAgfQogIH0KICBob3ZlcmluZ0hhbmRsZXIobmV3SG92ZXJpbmcpIHsKICAgIGlmICh0aGlzLmhvdmVyaW5nQ2hhbmdlZEJ5SnMpIHsKICAgICAgdGhpcy5ob3ZlcmluZ0NoYW5nZWRCeUpzID0gdm9pZCAwOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoTnVtYmVyLmlzTmFOKCtuZXdIb3ZlcmluZykpIHsKICAgICAgdGhpcy5zY2F0dGVycGxvdC5ob3Zlcih7IHByZXZlbnRFdmVudDogdHJ1ZSB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3QuaG92ZXIoK25ld0hvdmVyaW5nLCB7IHByZXZlbnRFdmVudDogdHJ1ZSB9KTsKICAgIH0KICB9CiAgd2lkdGhIYW5kbGVyKCkgewogICAgdGhpcy51cGRhdGVDb250YWluZXJEaW1lbnNpb25zKCk7CiAgfQogIGhlaWdodEhhbmRsZXIoKSB7CiAgICB0aGlzLnVwZGF0ZUNvbnRhaW5lckRpbWVuc2lvbnMoKTsKICB9CiAgYmFja2dyb3VuZENvbG9ySGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJiYWNrZ3JvdW5kQ29sb3IiLCBuZXdWYWx1ZSk7CiAgICB0aGlzLmNvbG9yQ2FudmFzKCk7CiAgfQogIGJhY2tncm91bmRJbWFnZUhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigiYmFja2dyb3VuZEltYWdlIiwgbmV3VmFsdWUpOwogIH0KICBsYXNzb0NvbG9ySGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJsYXNzb0NvbG9yIiwgbmV3VmFsdWUpOwogIH0KICBsYXNzb01pbkRlbGF5SGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJsYXNzb01pbkRlbGF5IiwgbmV3VmFsdWUpOwogIH0KICBsYXNzb01pbkRpc3RIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoImxhc3NvTWluRGlzdCIsIG5ld1ZhbHVlKTsKICB9CiAgbGFzc29UeXBlSGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJsYXNzb1R5cGUiLCBuZXdWYWx1ZSk7CiAgfQogIGxhc3NvQnJ1c2hTaXplSGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJsYXNzb0JydXNoU2l6ZSIsIG5ld1ZhbHVlKTsKICB9CiAgeFRpdGxlSGFuZGxlcihuZXdUaXRsZSkgewogICAgaWYgKHRoaXMudG9vbHRpcFByb3BlcnR5WFRpdGxlKSB7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5WFRpdGxlLnRleHRDb250ZW50ID0gdG9UaXRsZUNhc2UobmV3VGl0bGUgfHwgIiIpOwogICAgfQogIH0KICB5VGl0bGVIYW5kbGVyKG5ld1RpdGxlKSB7CiAgICBpZiAodGhpcy50b29sdGlwUHJvcGVydHlZVGl0bGUpIHsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlZVGl0bGUudGV4dENvbnRlbnQgPSB0b1RpdGxlQ2FzZShuZXdUaXRsZSB8fCAiIik7CiAgICB9CiAgfQogIGNvbG9ySGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy5jcmVhdGVDb2xvclNjYWxlKCk7CiAgICB0aGlzLmNyZWF0ZUNvbG9yR2V0dGVyKCk7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29sb3IiLCBuZXdWYWx1ZSk7CiAgfQogIGNvbG9yU2VsZWN0ZWRIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29sb3JBY3RpdmUiLCBuZXdWYWx1ZSk7CiAgfQogIGNvbG9ySG92ZXJIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29sb3JIb3ZlciIsIG5ld1ZhbHVlKTsKICB9CiAgY29sb3JCeUhhbmRsZXIobmV3VmFsdWUpIHsKICAgIGNvbnN0IGN1cnJWYWx1ZSA9IHRoaXMuc2NhdHRlcnBsb3QuZ2V0KCJjb2xvckJ5Iik7CiAgICB0aGlzLmNyZWF0ZUNvbG9yU2NhbGUoKTsKICAgIHRoaXMuY3JlYXRlQ29sb3JHZXR0ZXIoKTsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigiY29sb3JCeSIsIG5ld1ZhbHVlKTsKICAgIGlmICghY3VyclZhbHVlICYmIG5ld1ZhbHVlKSB7CiAgICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigicG9pbnRDb2xvciIsIHRoaXMubW9kZWwuZ2V0KCJjb2xvciIpKTsKICAgIH0KICB9CiAgY29sb3JUaXRsZUhhbmRsZXIobmV3VGl0bGUpIHsKICAgIGlmICh0aGlzLnRvb2x0aXBQcm9wZXJ0eUNvbG9yVGl0bGUpIHsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlDb2xvclRpdGxlLnRleHRDb250ZW50ID0gdG9DYXBpdGFsQ2FzZSgKICAgICAgICBuZXdUaXRsZSB8fCAiIgogICAgICApOwogICAgfQogIH0KICBvcGFjaXR5SGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy5jcmVhdGVPcGFjaXR5U2NhbGUoKTsKICAgIHRoaXMuY3JlYXRlT3BhY2l0eUdldHRlcigpOwogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJvcGFjaXR5IiwgbmV3VmFsdWUpOwogIH0KICBvcGFjaXR5VW5zZWxlY3RlZEhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigib3BhY2l0eUluYWN0aXZlU2NhbGUiLCBuZXdWYWx1ZSk7CiAgfQogIG9wYWNpdHlCeUhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMuY3JlYXRlT3BhY2l0eVNjYWxlKCk7CiAgICB0aGlzLmNyZWF0ZU9wYWNpdHlHZXR0ZXIoKTsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigib3BhY2l0eUJ5IiwgbmV3VmFsdWUpOwogIH0KICBvcGFjaXR5VGl0bGVIYW5kbGVyKG5ld1RpdGxlKSB7CiAgICBpZiAodGhpcy50b29sdGlwUHJvcGVydHlPcGFjaXR5VGl0bGUpIHsKICAgICAgdGhpcy50b29sdGlwUHJvcGVydHlPcGFjaXR5VGl0bGUudGV4dENvbnRlbnQgPSB0b0NhcGl0YWxDYXNlKAogICAgICAgIG5ld1RpdGxlIHx8ICIiCiAgICAgICk7CiAgICB9CiAgfQogIHNpemVIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLmNyZWF0ZVNpemVTY2FsZSgpOwogICAgdGhpcy5jcmVhdGVTaXplR2V0dGVyKCk7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50U2l6ZSIsIG5ld1ZhbHVlKTsKICB9CiAgc2l6ZUJ5SGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy5jcmVhdGVTaXplU2NhbGUoKTsKICAgIHRoaXMuY3JlYXRlU2l6ZUdldHRlcigpOwogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJzaXplQnkiLCBuZXdWYWx1ZSk7CiAgfQogIHNpemVTY2FsZUZ1bmN0aW9uSGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJwb2ludFNjYWxlTW9kZSIsIG5ld1ZhbHVlKTsKICB9CiAgc2l6ZVRpdGxlSGFuZGxlcihuZXdUaXRsZSkgewogICAgaWYgKHRoaXMudG9vbHRpcFByb3BlcnR5U2l6ZVRpdGxlKSB7CiAgICAgIHRoaXMudG9vbHRpcFByb3BlcnR5U2l6ZVRpdGxlLnRleHRDb250ZW50ID0gdG9DYXBpdGFsQ2FzZShuZXdUaXRsZSB8fCAiIik7CiAgICB9CiAgfQogIGNvbm5lY3RIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInNob3dQb2ludENvbm5lY3Rpb25zIiwgQm9vbGVhbihuZXdWYWx1ZSkpOwogIH0KICBjb25uZWN0aW9uQ29sb3JIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29ubmVjdGlvbkNvbG9yIiwgbmV3VmFsdWUpOwogIH0KICBjb25uZWN0aW9uQ29sb3JTZWxlY3RlZEhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigicG9pbnRDb25uZWN0aW9uQ29sb3JBY3RpdmUiLCBuZXdWYWx1ZSk7CiAgfQogIGNvbm5lY3Rpb25Db2xvckhvdmVySGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJwb2ludENvbm5lY3Rpb25Db2xvckhvdmVyIiwgbmV3VmFsdWUpOwogIH0KICBjb25uZWN0aW9uQ29sb3JCeUhhbmRsZXIobmV3VmFsdWUpIHsKICAgIGNvbnN0IGN1cnJWYWx1ZSA9IHRoaXMuc2NhdHRlcnBsb3QuZ2V0KCJwb2ludENvbm5lY3Rpb25Db2xvckJ5Iik7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29ubmVjdGlvbkNvbG9yQnkiLCBuZXdWYWx1ZSk7CiAgICBpZiAoY3VyclZhbHVlID09PSAic2VnbWVudCIgfHwgbmV3VmFsdWUgPT09ICJzZWdtZW50IikgewogICAgICB0aGlzLnNjYXR0ZXJwbG90LmRyYXcodGhpcy5zY2F0dGVycGxvdC5nZXQoInBvaW50cyIpKTsKICAgIH0KICB9CiAgY29ubmVjdGlvbk9wYWNpdHlIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29ubmVjdGlvbk9wYWNpdHkiLCBuZXdWYWx1ZSk7CiAgfQogIGNvbm5lY3Rpb25PcGFjaXR5QnlIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29ubmVjdGlvbk9wYWNpdHlCeSIsIG5ld1ZhbHVlKTsKICB9CiAgY29ubmVjdGlvblNpemVIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29ubmVjdGlvblNpemUiLCBuZXdWYWx1ZSk7CiAgfQogIGNvbm5lY3Rpb25TaXplQnlIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoInBvaW50Q29ubmVjdGlvblNpemVCeSIsIG5ld1ZhbHVlKTsKICB9CiAgcmV0aWNsZUhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigic2hvd1JldGljbGUiLCBuZXdWYWx1ZSk7CiAgfQogIHJldGljbGVDb2xvckhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigicmV0aWNsZUNvbG9yIiwgbmV3VmFsdWUpOwogIH0KICBjYW1lcmFUYXJnZXRIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoImNhbWVyYVRhcmdldCIsIG5ld1ZhbHVlKTsKICB9CiAgY2FtZXJhRGlzdGFuY2VIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoImNhbWVyYURpc3RhbmNlIiwgbmV3VmFsdWUpOwogIH0KICBjYW1lcmFSb3RhdGlvbkhhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigiY2FtZXJhUm90YXRpb24iLCBuZXdWYWx1ZSk7CiAgfQogIGNhbWVyYVZpZXdIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoImNhbWVyYVZpZXciLCBuZXdWYWx1ZSk7CiAgfQogIGNhbWVyYUlzRml4ZWRIYW5kbGVyKG5ld1ZhbHVlKSB7CiAgICB0aGlzLndpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIoImNhbWVyYUlzRml4ZWQiLCBuZXdWYWx1ZSk7CiAgfQogIGxhc3NvSW5pdGlhdG9ySGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJsYXNzb0luaXRpYXRvciIsIG5ld1ZhbHVlKTsKICB9CiAgbGFzc29PbkxvbmdQcmVzc0hhbmRsZXIobmV3VmFsdWUpIHsKICAgIHRoaXMud2l0aFByb3BlcnR5Q2hhbmdlSGFuZGxlcigibGFzc29PbkxvbmdQcmVzcyIsIG5ld1ZhbHVlKTsKICB9CiAgbW91c2VNb2RlSGFuZGxlcihuZXdWYWx1ZSkgewogICAgdGhpcy53aXRoUHJvcGVydHlDaGFuZ2VIYW5kbGVyKCJtb3VzZU1vZGUiLCBuZXdWYWx1ZSk7CiAgICB0aGlzLnNjYXR0ZXJwbG90LmdldCgiY2FtZXJhIikuY29uZmlnKHsgaXNSb3RhdGU6IG5ld1ZhbHVlID09PSAicm90YXRlIiB9KTsKICB9CiAgYXhlc0hhbmRsZXIobmV3VmFsdWUpIHsKICAgIGlmIChuZXdWYWx1ZSkgewogICAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVtb3ZlQXhlcygpOwogICAgfQogIH0KICBheGVzQ29sb3JIYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVBeGVzKCk7CiAgfQogIGF4ZXNHcmlkSGFuZGxlcihuZXdWYWx1ZSkgewogICAgaWYgKG5ld1ZhbHVlKSB7CiAgICAgIHRoaXMuY3JlYXRlQXhlc0dyaWQoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVtb3ZlQXhlc0dyaWQoKTsKICAgIH0KICB9CiAgYXhlc0xhYmVsc0hhbmRsZXIobmV3VmFsdWUpIHsKICAgIGlmICghbmV3VmFsdWUpIHsKICAgICAgdGhpcy5yZW1vdmVBeGVzKCk7CiAgICB9CiAgICB0aGlzLmNyZWF0ZUF4ZXMoKTsKICB9CiAgbGVnZW5kSGFuZGxlcihuZXdWYWx1ZSkgewogICAgaWYgKG5ld1ZhbHVlKSB7CiAgICAgIHRoaXMuc2hvd0xlZ2VuZCgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5oaWRlTGVnZW5kKCk7CiAgICB9CiAgfQogIGxlZ2VuZENvbG9ySGFuZGxlcigpIHsKICAgIHRoaXMuaGlkZUxlZ2VuZCgpOwogICAgdGhpcy5zaG93TGVnZW5kKCk7CiAgfQogIGxlZ2VuZFNpemVIYW5kbGVyKCkgewogICAgdGhpcy5oaWRlTGVnZW5kKCk7CiAgICB0aGlzLnNob3dMZWdlbmQoKTsKICB9CiAgbGVnZW5kUG9zaXRpb25IYW5kbGVyKCkgewogICAgdGhpcy51cGRhdGVMZWdlbmRQb3NpdGlvbigpOwogIH0KICBsZWdlbmRFbmNvZGluZ0hhbmRsZXIoKSB7CiAgICBpZiAoIXRoaXMubW9kZWwuZ2V0KCJsZWdlbmQiKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnNob3dMZWdlbmQoKTsKICB9CiAgem9vbVRvSGFuZGxlcihwb2ludHMpIHsKICAgIGNvbnN0IGFuaW1hdGlvbiA9IHRoaXMubW9kZWwuZ2V0KCJ6b29tX2FuaW1hdGlvbiIpOwogICAgY29uc3QgcGFkZGluZyA9IHRoaXMubW9kZWwuZ2V0KCJ6b29tX3BhZGRpbmciKTsKICAgIGNvbnN0IHRyYW5zaXRpb24gPSBhbmltYXRpb24gPiAwOwogICAgY29uc3QgdHJhbnNpdGlvbkR1cmF0aW9uID0gYW5pbWF0aW9uOwogICAgY29uc3Qgb3B0aW9ucyA9IHRyYW5zaXRpb24gPyB7IHBhZGRpbmcsIHRyYW5zaXRpb24sIHRyYW5zaXRpb25EdXJhdGlvbiB9IDogeyBwYWRkaW5nIH07CiAgICBpZiAocG9pbnRzPy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3Quem9vbVRvUG9pbnRzKHBvaW50cywgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnNjYXR0ZXJwbG90Lnpvb21Ub09yaWdpbihvcHRpb25zKTsKICAgIH0KICB9CiAgem9vbVRvQ2FsbElkeEhhbmRsZXIoKSB7CiAgICB0aGlzLnpvb21Ub0hhbmRsZXIodGhpcy5tb2RlbC5nZXQoInpvb21fdG8iKSk7CiAgfQogIHZpZXdEb3dubG9hZChvcHRpb25zKSB7CiAgICAoYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHNjYXR0ZXJJbWFnZSA9IGF3YWl0IHRoaXMuc2NhdHRlcnBsb3QuZXhwb3J0KHsKICAgICAgICAgIHNjYWxlOiBvcHRpb25zPy5zY2FsZSwKICAgICAgICAgIGFudGlBbGlhc2luZzogMSwKICAgICAgICAgIHBpeGVsQWxpZ25lZDogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGxhYmVsSW1hZ2UgPSB0aGlzLmNhbnZhc0xhYmVscz8uZ2V0Q29udGV4dCgiMmQiKT8uZ2V0SW1hZ2VEYXRhKAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICB0aGlzLmNhbnZhc0xhYmVscy53aWR0aCwKICAgICAgICAgIHRoaXMuY2FudmFzTGFiZWxzLmhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3QgYmxlbmRlZEltYWdlID0gbGFiZWxJbWFnZSA/IGJsZW5kKHNjYXR0ZXJJbWFnZSwgbGFiZWxJbWFnZSkgOiBzY2F0dGVySW1hZ2U7CiAgICAgICAgY29uc3QgZmluYWxJbWFnZSA9IG9wdGlvbnM/LnRyYW5zcGFyZW50QmFja2dyb3VuZENvbG9yID8gYmxlbmRlZEltYWdlIDogYWRkQmFja2dyb3VuZENvbG9yKGJsZW5kZWRJbWFnZSwgdGhpcy5iYWNrZ3JvdW5kQ29sb3IpOwogICAgICAgIGltYWdlRGF0YVRvQ2FudmFzKGZpbmFsSW1hZ2UpLnRvQmxvYigoYmxvYikgPT4gewogICAgICAgICAgZG93bmxvYWRCbG9iKGJsb2IsICJqdXB5dGVyLXNjYXR0ZXIucG5nIik7CiAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gZXhwb3J0IGltYWdlIiwgZSk7CiAgICAgIH0KICAgIH0pKCk7CiAgfQogIHZpZXdTYXZlKHRyYW5zcGFyZW50QmFja2dyb3VuZENvbG9yKSB7CiAgICBjb25zdCBpbWFnZSA9IHRoaXMuc2NhdHRlcnBsb3QuZXhwb3J0KCk7CiAgICBjb25zdCBmaW5hbEltYWdlID0gdHJhbnNwYXJlbnRCYWNrZ3JvdW5kQ29sb3IgPyBpbWFnZSA6IGFkZEJhY2tncm91bmRDb2xvcihpbWFnZSwgdGhpcy5iYWNrZ3JvdW5kQ29sb3IpOwogICAgdGhpcy5tb2RlbC5zZXQoInZpZXdfZGF0YSIsIGZpbmFsSW1hZ2UpOwogICAgdGhpcy5tb2RlbC5zYXZlX2NoYW5nZXMoKTsKICB9CiAgdG9nZ2xlRnVsbHNjcmVlbigpIHsKICAgIGlmIChkb2N1bWVudC5mdWxsc2NyZWVuRWxlbWVudCkgewogICAgICBkb2N1bWVudC5leGl0RnVsbHNjcmVlbigpOwogICAgfSBlbHNlIGlmICh0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50KSB7CiAgICAgIHRoaXMuZ3JlYXRHcmFuZFBhcmVudEVsZW1lbnQucmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZ3JhbmRQYXJlbnRFbGVtZW50ID0gdGhpcy5lbC5wYXJlbnRFbGVtZW50Py5wYXJlbnRFbGVtZW50OwogICAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50ID0gdGhpcy5ncmFuZFBhcmVudEVsZW1lbnQ/LnBhcmVudEVsZW1lbnQ7CiAgICAgIHRoaXMuZ3JlYXRHcmFuZFBhcmVudEVsZW1lbnQ/LmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICAgImZ1bGxzY3JlZW5jaGFuZ2UiLAogICAgICAgIHRoaXMuZnVsbHNjcmVlbkNoYW5nZUhhbmRsZXJCb3VuZAogICAgICApOwogICAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50Py5yZXF1ZXN0RnVsbHNjcmVlbigpOwogICAgfQogIH0KICBmdWxsc2NyZWVuQ29udGFpbmVyU3R5bGUoKSB7CiAgICBpZiAodGhpcy5mdWxsc2NyZWVuRnVsbFdpZHRoSGVpZ2h0KSB7CiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLm91dGxpbmUgPSBudWxsOwogICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5ib3hTaGFkb3cgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUub3V0bGluZSA9ICIxcHggc29saWQgdmFyKC0tanAtYm9yZGVyLWNvbG9yMikiOwogICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5ib3hTaGFkb3cgPSAiMCAwLjFyZW0gMXJlbSAwIHJnYmEoMCwgMCwgMCwgLjIpIjsKICAgIH0KICB9CiAgZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodENoYW5nZUhhbmRsZXIoZXZlbnQpIHsKICAgIHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodCA9IGV2ZW50LnRhcmdldC5jaGVja2VkOwogICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhJbnB1dC5kaXNhYmxlZCA9IHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodDsKICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodElucHV0LmRpc2FibGVkID0gdGhpcy5mdWxsc2NyZWVuRnVsbFdpZHRoSGVpZ2h0OwogICAgdGhpcy51cGRhdGVDb250YWluZXJEaW1lbnNpb25zKCk7CiAgICB0aGlzLmZ1bGxzY3JlZW5Db250YWluZXJTdHlsZSgpOwogICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVXBkYXRlRG93bmxvYWRMYWJlbCgpOwogICAgaWYgKHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodCkgewogICAgICB0aGlzLmZ1bGxzY3JlZW5XaWR0aExhYmVsLnN0eWxlLmNvbG9yID0gInZhcigtLWpwLWNvbnRlbnQtZm9udC1jb2xvcjIpIjsKICAgICAgdGhpcy5mdWxsc2NyZWVuSGVpZ2h0TGFiZWwuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMikiOwogICAgICB0aGlzLmZ1bGxzY3JlZW5XaWR0aElucHV0LnN0eWxlLmNvbG9yID0gInZhcigtLWpwLWNvbnRlbnQtZm9udC1jb2xvcjMpIjsKICAgICAgdGhpcy5mdWxsc2NyZWVuSGVpZ2h0SW5wdXQuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMykiOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhMYWJlbC5zdHlsZS5jb2xvciA9ICJ2YXIoLS1qcC1jb250ZW50LWZvbnQtY29sb3IpIjsKICAgICAgdGhpcy5mdWxsc2NyZWVuSGVpZ2h0TGFiZWwuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yKSI7CiAgICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoSW5wdXQuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yKSI7CiAgICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodElucHV0LnN0eWxlLmNvbG9yID0gInZhcigtLWpwLWNvbnRlbnQtZm9udC1jb2xvcikiOwogICAgfQogICAgaWYgKCF0aGlzLmZ1bGxzY3JlZW5GdWxsV2lkdGhIZWlnaHQpIHsKICAgICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhJbnB1dC5mb2N1cygpOwogICAgfQogIH0KICBmdWxsc2NyZWVuV2lkdGhDaGFuZ2VIYW5kbGVyKGV2ZW50KSB7CiAgICBjb25zdCBuZXdXaWR0aCA9IE51bWJlcihldmVudC50YXJnZXQudmFsdWUpOwogICAgdGhpcy5mdWxsc2NyZWVuV2lkdGggPSBNYXRoLm1heCgKICAgICAgMSwKICAgICAgTWF0aC5taW4odGhpcy5mdWxsc2NyZWVuV2lkdGhNYXgsIG5ld1dpZHRoKQogICAgKTsKICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoSW5wdXQudmFsdWUgPSB0aGlzLmZ1bGxzY3JlZW5XaWR0aDsKICAgIHRoaXMudXBkYXRlQ29udGFpbmVyRGltZW5zaW9ucygpOwogICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVXBkYXRlRG93bmxvYWRMYWJlbCgpOwogIH0KICBmdWxsc2NyZWVuSGVpZ2h0Q2hhbmdlSGFuZGxlcihldmVudCkgewogICAgY29uc3QgbmV3SGVpZ2h0ID0gTnVtYmVyKGV2ZW50LnRhcmdldC52YWx1ZSk7CiAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHQgPSBNYXRoLm1heCgKICAgICAgMSwKICAgICAgTWF0aC5taW4odGhpcy5mdWxsc2NyZWVuSGVpZ2h0TWF4LCBuZXdIZWlnaHQpCiAgICApOwogICAgdGhpcy5mdWxsc2NyZWVuSGVpZ2h0SW5wdXQudmFsdWUgPSB0aGlzLmZ1bGxzY3JlZW5IZWlnaHQ7CiAgICB0aGlzLnVwZGF0ZUNvbnRhaW5lckRpbWVuc2lvbnMoKTsKICAgIHRoaXMuZnVsbHNjcmVlblNpemVQYW5lbFVwZGF0ZURvd25sb2FkTGFiZWwoKTsKICB9CiAgZnVsbHNjcmVlbkV4cG9ydFNjYWxlQ2hhbmdlSGFuZGxlcihldmVudCkgewogICAgY29uc3QgbmV3U2NhbGUgPSBOdW1iZXIoZXZlbnQudGFyZ2V0LnZhbHVlKTsKICAgIHRoaXMuZnVsbHNjcmVlbkV4cG9ydFNjYWxlID0gbmV3U2NhbGU7CiAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWxVcGRhdGVEb3dubG9hZExhYmVsKCk7CiAgfQogIGZ1bGxzY3JlZW5TaXplUGFuZWxUb2dnbGUoKSB7CiAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWxWaXNpYmxlID0gIXRoaXMuZnVsbHNjcmVlblNpemVQYW5lbFZpc2libGU7CiAgICBpZiAodGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVmlzaWJsZSkgewogICAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWxUb2dnbGVCdXR0b25JY29uLmNsYXNzTGlzdC5yZW1vdmUoImZhLWFuZ2xlLXVwIik7CiAgICAgIHRoaXMuZnVsbHNjcmVlblNpemVQYW5lbFRvZ2dsZUJ1dHRvbkljb24uY2xhc3NMaXN0LmFkZCgiZmEtYW5nbGUtZG93biIpOwogICAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWwuc3R5bGUuaGVpZ2h0ID0gIjNyZW0iOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVG9nZ2xlQnV0dG9uSWNvbi5jbGFzc0xpc3QucmVtb3ZlKAogICAgICAgICJmYS1hbmdsZS1kb3duIgogICAgICApOwogICAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWxUb2dnbGVCdXR0b25JY29uLmNsYXNzTGlzdC5hZGQoImZhLWFuZ2xlLXVwIik7CiAgICAgIHRoaXMuZnVsbHNjcmVlblNpemVQYW5lbC5zdHlsZS5oZWlnaHQgPSAiMCI7CiAgICAgIGlmICghdGhpcy5mdWxsc2NyZWVuRnVsbFdpZHRoSGVpZ2h0KSB7CiAgICAgICAgdGhpcy5mdWxsc2NyZWVuRnVsbFdpZHRoSGVpZ2h0SW5wdXQuY2xpY2soKTsKICAgICAgfQogICAgfQogIH0KICBmdWxsc2NyZWVuU2l6ZVBhbmVsVXBkYXRlRG93bmxvYWRMYWJlbCgpIHsKICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5jYW52YXM7CiAgICBjb25zdCB3ID0gd2lkdGggKiB0aGlzLmZ1bGxzY3JlZW5FeHBvcnRTY2FsZTsKICAgIGNvbnN0IGggPSBoZWlnaHQgKiB0aGlzLmZ1bGxzY3JlZW5FeHBvcnRTY2FsZTsKICAgIHRoaXMuZnVsbHNjcmVlbkRvd25sb2FkLnRleHRDb250ZW50ID0gYERvd25sb2FkIGFzIFBORyBhdCAke3d9XHhENyR7aH0gcHhgOwogICAgdGhpcy5mdWxsc2NyZWVuRG93bmxvYWQudGl0bGUgPSBgRG93bmxvYWQgYXMgUE5HIGF0ICR7d31ceEQ3JHtofSBwaXhlbHNgOwogIH0KICBmdWxsc2NyZWVuRG93bmxvYWQoKSB7CiAgICB0aGlzLnZpZXdEb3dubG9hZCh7IHNjYWxlOiB0aGlzLmZ1bGxzY3JlZW5FeHBvcnRTY2FsZSB9KTsKICB9CiAgY3JlYXRlRnVsbHNjcmVlblNpemVQYW5lbCgpIHsKICAgIGlmICh0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWwpIHsKICAgICAgdGhpcy5kZXN0cm95RnVsbHNjcmVlblJlc2l6ZVBhbmVsKCk7CiAgICB9CiAgICBjb25zdCBwYW5lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgcGFuZWwuaWQgPSAianNjYXR0ZXItZnVsbHNjcmVlbi1zaXplLXBhbmVsIjsKICAgIHBhbmVsLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsKICAgIHBhbmVsLnN0eWxlLmhlaWdodCA9ICIwIjsKICAgIHBhbmVsLnN0eWxlLnRyYW5zaXRpb24gPSAiaGVpZ2h0IDI1MG1zIGVhc2UiOwogICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsID0gcGFuZWw7CiAgICBjb25zdCB0b2dnbGVCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgIHRvZ2dsZUJ1dHRvbi5jbGFzc0xpc3QuYWRkKAogICAgICAianVweXRlci13aWRnZXRzIiwKICAgICAgImp1cHl0ZXItYnV0dG9uIiwKICAgICAgIndpZGdldC1idXR0b24iCiAgICApOwogICAgdG9nZ2xlQnV0dG9uLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgIHRvZ2dsZUJ1dHRvbi5zdHlsZS5sZWZ0ID0gIjAiOwogICAgdG9nZ2xlQnV0dG9uLnN0eWxlLmJvdHRvbSA9ICIxMDAlIjsKICAgIHRvZ2dsZUJ1dHRvbi5zdHlsZS53aWR0aCA9ICIzNnB4IjsKICAgIHRvZ2dsZUJ1dHRvbi5zdHlsZS5oZWlnaHQgPSAiMThweCI7CiAgICB0b2dnbGVCdXR0b24uc3R5bGUubWFyZ2luID0gIjAgMnB4IjsKICAgIHRvZ2dsZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgdG9nZ2xlQnV0dG9uLnN0eWxlLmp1c3RpZnlDb250ZW50ID0gImNlbnRlciI7CiAgICB0b2dnbGVCdXR0b24uc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgdG9nZ2xlQnV0dG9uLnN0eWxlLmJvcmRlckJvdHRvbUxlZnRSYWRpdXMgPSAiMCI7CiAgICB0b2dnbGVCdXR0b24uc3R5bGUuYm9yZGVyQm90dG9tUmlnaHRSYWRpdXMgPSAiMCI7CiAgICB0b2dnbGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWxUb2dnbGVCb3VuZCk7CiAgICBwYW5lbC5hcHBlbmQodG9nZ2xlQnV0dG9uKTsKICAgIHRoaXMuZnVsbHNjcmVlblNpemVQYW5lbFRvZ2dsZUJ1dHRvbiA9IHRvZ2dsZUJ1dHRvbjsKICAgIGNvbnN0IHRvZ2dsZUJ1dHRvbkljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpIik7CiAgICB0b2dnbGVCdXR0b25JY29uLmNsYXNzTGlzdC5hZGQoImZhIiwgImZhLWFuZ2xlLXVwIik7CiAgICB0b2dnbGVCdXR0b25JY29uLmFyaWFIaWRkZW4gPSAidHJ1ZSI7CiAgICB0b2dnbGVCdXR0b24uYXBwZW5kKHRvZ2dsZUJ1dHRvbkljb24pOwogICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVG9nZ2xlQnV0dG9uSWNvbiA9IHRvZ2dsZUJ1dHRvbkljb247CiAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CiAgICBjb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgIGNvbnRhaW5lci5zdHlsZS5hbGlnbkl0ZW1zID0gImNlbnRlciI7CiAgICBjb250YWluZXIuc3R5bGUuZ2FwID0gIjAgMXJlbSI7CiAgICBjb250YWluZXIuc3R5bGUucGFkZGluZyA9ICIwLjVyZW0gMnB4IjsKICAgIGNvbnRhaW5lci5zdHlsZS5ib3JkZXJUb3AgPSAiMnB4IHNvbGlkIHZhcigtLWpwLWxheW91dC1jb2xvcjIpIjsKICAgIHBhbmVsLmFwcGVuZChjb250YWluZXIpOwogICAgY29uc3QgYkJveCA9IHRoaXMuZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCBoYXNBeGVzID0gdGhpcy5tb2RlbC5nZXQoImF4ZXMiKTsKICAgIGNvbnN0IHhQYWRkaW5nID0gaGFzQXhlcyA/IHRoaXMuZ2V0WFBhZGRpbmcoKSA6IDA7CiAgICBjb25zdCB5UGFkZGluZyA9IGhhc0F4ZXMgPyB0aGlzLmdldFlQYWRkaW5nKCkgOiAwOwogICAgY29uc3QgZnVsbFdpZHRoSGVpZ2h0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKICAgIGZ1bGxXaWR0aEhlaWdodC50ZXh0Q29udGVudCA9ICJGdWxsIFdpZHRoICYgSGVpZ2h0IjsKICAgIGZ1bGxXaWR0aEhlaWdodC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgZnVsbFdpZHRoSGVpZ2h0LnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgIGZ1bGxXaWR0aEhlaWdodC5zdHlsZS5nYXAgPSAiMCAwLjI1cmVtIjsKICAgIGZ1bGxXaWR0aEhlaWdodC5zdHlsZS51c2VyU2VsZWN0ID0gIm5vbmUiOwogICAgY29udGFpbmVyLmFwcGVuZChmdWxsV2lkdGhIZWlnaHQpOwogICAgdGhpcy5mdWxsc2NyZWVuRnVsbFdpZHRoSGVpZ2h0ID0gdHJ1ZTsKICAgIGNvbnN0IGZ1bGxXaWR0aEhlaWdodElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIGZ1bGxXaWR0aEhlaWdodElucHV0LnR5cGUgPSAiY2hlY2tib3giOwogICAgZnVsbFdpZHRoSGVpZ2h0SW5wdXQuY2hlY2tlZCA9IHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodDsKICAgIGZ1bGxXaWR0aEhlaWdodElucHV0LmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICJjaGFuZ2UiLAogICAgICB0aGlzLmZ1bGxzY3JlZW5GdWxsV2lkdGhIZWlnaHRDaGFuZ2VIYW5kbGVyQm91bmQKICAgICk7CiAgICB0aGlzLmZ1bGxzY3JlZW5GdWxsV2lkdGhIZWlnaHRJbnB1dCA9IGZ1bGxXaWR0aEhlaWdodElucHV0OwogICAgZnVsbFdpZHRoSGVpZ2h0LmFwcGVuZChmdWxsV2lkdGhIZWlnaHRJbnB1dCk7CiAgICBjb25zdCB3aWR0aCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICB3aWR0aC50ZXh0Q29udGVudCA9ICJXaWR0aCI7CiAgICB3aWR0aC5zdHlsZS5kaXNwbGF5ID0gImZsZXgiOwogICAgd2lkdGguc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgd2lkdGguc3R5bGUuZ2FwID0gIjAgMC4yNXJlbSI7CiAgICB3aWR0aC5zdHlsZS51c2VyU2VsZWN0ID0gIm5vbmUiOwogICAgd2lkdGguc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMikiOwogICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhMYWJlbCA9IHdpZHRoOwogICAgY29udGFpbmVyLmFwcGVuZCh3aWR0aCk7CiAgICB0aGlzLmZ1bGxzY3JlZW5XaWR0aE1heCA9IGJCb3gud2lkdGggLSB4UGFkZGluZzsKICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoID0gdGhpcy5mdWxsc2NyZWVuV2lkdGhNYXg7CiAgICBjb25zdCB3aWR0aElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIHdpZHRoSW5wdXQudHlwZSA9ICJudW1iZXIiOwogICAgd2lkdGhJbnB1dC52YWx1ZSA9IGAke3RoaXMuZnVsbHNjcmVlbldpZHRofWA7CiAgICB3aWR0aElucHV0LmRpc2FibGVkID0gdHJ1ZTsKICAgIHdpZHRoSW5wdXQuc3RlcCA9ICIxIjsKICAgIHdpZHRoSW5wdXQubWluID0gIjEiOwogICAgd2lkdGhJbnB1dC5tYXggPSBgJHt0aGlzLmZ1bGxzY3JlZW5XaWR0aE1heH1gOwogICAgd2lkdGhJbnB1dC5zdHlsZS51c2VyU2VsZWN0ID0gImF1dG8iOwogICAgd2lkdGhJbnB1dC5zdHlsZS5jb2xvciA9ICJ2YXIoLS1qcC1jb250ZW50LWZvbnQtY29sb3IzKSI7CiAgICB3aWR0aElucHV0LnN0eWxlLmJvcmRlciA9ICJ2YXIoLS1qcC13aWRnZXRzLWlucHV0LWJvcmRlci13aWR0aCkgc29saWQgdmFyKC0tanAtd2lkZ2V0cy1pbnB1dC1ib3JkZXItY29sb3IpIjsKICAgIHdpZHRoSW5wdXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInZhcigtLWpwLXdpZGdldHMtaW5wdXQtYmFja2dyb3VuZC1jb2xvcikiOwogICAgd2lkdGhJbnB1dC5hZGRFdmVudExpc3RlbmVyKAogICAgICAiY2hhbmdlIiwKICAgICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhDaGFuZ2VIYW5kbGVyQm91bmQKICAgICk7CiAgICB3aWR0aElucHV0LmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICJpbnB1dCIsCiAgICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoQ2hhbmdlSGFuZGxlckRlYm91bmNlZAogICAgKTsKICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoSW5wdXQgPSB3aWR0aElucHV0OwogICAgd2lkdGguYXBwZW5kKHdpZHRoSW5wdXQpOwogICAgY29uc3QgaGVpZ2h0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKICAgIGhlaWdodC50ZXh0Q29udGVudCA9ICJIZWlnaHQiOwogICAgaGVpZ2h0LnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICBoZWlnaHQuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgaGVpZ2h0LnN0eWxlLmdhcCA9ICIwIDAuMjVyZW0iOwogICAgaGVpZ2h0LnN0eWxlLnVzZXJTZWxlY3QgPSAibm9uZSI7CiAgICBoZWlnaHQuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMikiOwogICAgdGhpcy5mdWxsc2NyZWVuSGVpZ2h0TGFiZWwgPSBoZWlnaHQ7CiAgICBjb250YWluZXIuYXBwZW5kKGhlaWdodCk7CiAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHRNYXggPSBiQm94LmhlaWdodCAtIHlQYWRkaW5nIC0gcmVtVG9QeCgzKTsKICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodCA9IHRoaXMuZnVsbHNjcmVlbkhlaWdodE1heDsKICAgIGNvbnN0IGhlaWdodElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIGhlaWdodElucHV0LnR5cGUgPSAibnVtYmVyIjsKICAgIGhlaWdodElucHV0LnZhbHVlID0gYCR7dGhpcy5mdWxsc2NyZWVuSGVpZ2h0fWA7CiAgICBoZWlnaHRJbnB1dC5kaXNhYmxlZCA9IHRydWU7CiAgICBoZWlnaHRJbnB1dC5zdGVwID0gIjEiOwogICAgaGVpZ2h0SW5wdXQubWluID0gIjEiOwogICAgaGVpZ2h0SW5wdXQubWF4ID0gYCR7dGhpcy5mdWxsc2NyZWVuSGVpZ2h0TWF4fWA7CiAgICBoZWlnaHRJbnB1dC5zdHlsZS51c2VyU2VsZWN0ID0gImF1dG8iOwogICAgaGVpZ2h0SW5wdXQuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMykiOwogICAgaGVpZ2h0SW5wdXQuc3R5bGUuYm9yZGVyID0gInZhcigtLWpwLXdpZGdldHMtaW5wdXQtYm9yZGVyLXdpZHRoKSBzb2xpZCB2YXIoLS1qcC13aWRnZXRzLWlucHV0LWJvcmRlci1jb2xvcikiOwogICAgaGVpZ2h0SW5wdXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInZhcigtLWpwLXdpZGdldHMtaW5wdXQtYmFja2dyb3VuZC1jb2xvcikiOwogICAgaGVpZ2h0SW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgImNoYW5nZSIsCiAgICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodENoYW5nZUhhbmRsZXJCb3VuZAogICAgKTsKICAgIGhlaWdodElucHV0LmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICJpbnB1dCIsCiAgICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodENoYW5nZUhhbmRsZXJEZWJvdW5jZWQKICAgICk7CiAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHRJbnB1dCA9IGhlaWdodElucHV0OwogICAgaGVpZ2h0LmFwcGVuZChoZWlnaHRJbnB1dCk7CiAgICBjb25zdCBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXZpZGVyLnN0eWxlLndpZHRoID0gIjJweCI7CiAgICBkaXZpZGVyLnN0eWxlLmhlaWdodCA9ICIycmVtIjsKICAgIGRpdmlkZXIuc3R5bGUuYmFja2dyb3VuZCA9ICJ2YXIoLS1qcC1ib3JkZXItY29sb3IyKSI7CiAgICBjb250YWluZXIuYXBwZW5kKGRpdmlkZXIpOwogICAgY29uc3Qgc2NhbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgc2NhbGUudGV4dENvbnRlbnQgPSAiU2NhbGUiOwogICAgc2NhbGUuc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgIHNjYWxlLnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgIHNjYWxlLnN0eWxlLmdhcCA9ICIwIDAuMjVyZW0iOwogICAgc2NhbGUuc3R5bGUudXNlclNlbGVjdCA9ICJub25lIjsKICAgIGNvbnRhaW5lci5hcHBlbmQoc2NhbGUpOwogICAgY29uc3Qgc2NhbGVTZWxlY3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzZWxlY3QiKTsKICAgIHNjYWxlU2VsZWN0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ2YXIoLS1qcC13aWRnZXRzLWlucHV0LWJhY2tncm91bmQtY29sb3IpIjsKICAgIHNjYWxlU2VsZWN0LnN0eWxlLmNvbG9yID0gInZhcigtLWpwLXdpZGdldHMtaW5wdXQtY29sb3IpIjsKICAgIHRoaXMuZnVsbHNjcmVlbkV4cG9ydFNjYWxlID0gMTsKICAgIHNjYWxlU2VsZWN0LmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICJjaGFuZ2UiLAogICAgICB0aGlzLmZ1bGxzY3JlZW5FeHBvcnRTY2FsZUNoYW5nZUhhbmRsZXJCb3VuZAogICAgKTsKICAgIHRoaXMuZnVsbHNjcmVlblNjYWxlU2VsZWN0ID0gc2NhbGVTZWxlY3Q7CiAgICBzY2FsZS5hcHBlbmQoc2NhbGVTZWxlY3QpOwogICAgY29uc3Qgc2NhbGVzID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogMyB9LCAoXywgaSkgPT4gaSArIDEpOwogICAgZm9yIChjb25zdCBzIG9mIHNjYWxlcykgewogICAgICBjb25zdCBzY2FsZU9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgICBzY2FsZU9wdGlvbi50ZXh0Q29udGVudCA9IHM7CiAgICAgIHNjYWxlT3B0aW9uLnZhbHVlID0gczsKICAgICAgc2NhbGVPcHRpb24uc2VsZWN0ZWQgPSBzID09PSB0aGlzLmZ1bGxzY3JlZW5FeHBvcnRTY2FsZTsKICAgICAgc2NhbGVTZWxlY3QuYXBwZW5kKHNjYWxlT3B0aW9uKTsKICAgIH0KICAgIGNvbnN0IGRwciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICBkcHIudGV4dENvbnRlbnQgPSAiRFBSIjsKICAgIGRwci50aXRsZSA9ICJEZXZpY2UgUGl4ZWwgUmF0aW8iOwogICAgZHByLnN0eWxlLmRpc3BsYXkgPSAiZmxleCI7CiAgICBkcHIuc3R5bGUuYWxpZ25JdGVtcyA9ICJjZW50ZXIiOwogICAgZHByLnN0eWxlLmdhcCA9ICIwIDAuMjVyZW0iOwogICAgZHByLnN0eWxlLnVzZXJTZWxlY3QgPSAibm9uZSI7CiAgICBkcHIuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMikiOwogICAgY29udGFpbmVyLmFwcGVuZChkcHIpOwogICAgY29uc3QgZHBySW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgZHBySW5wdXQudHlwZSA9ICJudW1iZXIiOwogICAgZHBySW5wdXQubWluID0gIjEiOwogICAgZHBySW5wdXQubWF4ID0gIjEwIjsKICAgIGRwcklucHV0LnN0ZXAgPSAiMSI7CiAgICBkcHJJbnB1dC52YWx1ZSA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvOwogICAgZHBySW5wdXQuZGlzYWJsZWQgPSB0cnVlOwogICAgZHBySW5wdXQuc3R5bGUuY29sb3IgPSAidmFyKC0tanAtY29udGVudC1mb250LWNvbG9yMykiOwogICAgZHBySW5wdXQuc3R5bGUuYm9yZGVyID0gInZhcigtLWpwLXdpZGdldHMtaW5wdXQtYm9yZGVyLXdpZHRoKSBzb2xpZCB2YXIoLS1qcC13aWRnZXRzLWlucHV0LWJvcmRlci1jb2xvcikiOwogICAgZHBySW5wdXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInZhcigtLWpwLXdpZGdldHMtaW5wdXQtYmFja2dyb3VuZC1jb2xvcikiOwogICAgZHByLmFwcGVuZChkcHJJbnB1dCk7CiAgICBjb25zdCBkb3dubG9hZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgZG93bmxvYWQuY2xhc3NMaXN0LmFkZCgKICAgICAgImp1cHl0ZXItd2lkZ2V0cyIsCiAgICAgICJqdXB5dGVyLWJ1dHRvbiIsCiAgICAgICJ3aWRnZXQtYnV0dG9uIgogICAgKTsKICAgIGRvd25sb2FkLnRleHRDb250ZW50ID0gIkRvd25sb2FkIGFzIFBORyI7CiAgICBkb3dubG9hZC5zdHlsZS53aWR0aCA9ICJhdXRvIjsKICAgIGRvd25sb2FkLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5mdWxsc2NyZWVuRG93bmxvYWRCb3VuZCk7CiAgICB0aGlzLmZ1bGxzY3JlZW5Eb3dubG9hZCA9IGRvd25sb2FkOwogICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVXBkYXRlRG93bmxvYWRMYWJlbCgpOwogICAgY29udGFpbmVyLmFwcGVuZChkb3dubG9hZCk7CiAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50LmFwcGVuZChwYW5lbCk7CiAgfQogIGRlc3Ryb3lGdWxsc2NyZWVuUmVzaXplUGFuZWwoKSB7CiAgICB0aGlzLmZ1bGxzY3JlZW5GdWxsV2lkdGhIZWlnaHRJbnB1dC5yZW1vdmVFdmVudExpc3RlbmVyKAogICAgICAiY2hhbmdlIiwKICAgICAgdGhpcy5mdWxsc2NyZWVuRnVsbFdpZHRoSGVpZ2h0Q2hhbmdlSGFuZGxlckJvdW5kCiAgICApOwogICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhJbnB1dC5yZW1vdmVFdmVudExpc3RlbmVyKAogICAgICAiY2hhbmdlIiwKICAgICAgdGhpcy5mdWxsc2NyZWVuV2lkdGhDaGFuZ2VIYW5kbGVyQm91bmQKICAgICk7CiAgICB0aGlzLmZ1bGxzY3JlZW5XaWR0aElucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoCiAgICAgICJpbnB1dCIsCiAgICAgIHRoaXMuZnVsbHNjcmVlbldpZHRoQ2hhbmdlSGFuZGxlckRlYm91bmNlZAogICAgKTsKICAgIHRoaXMuZnVsbHNjcmVlbkhlaWdodElucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoCiAgICAgICJjaGFuZ2UiLAogICAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHRDaGFuZ2VIYW5kbGVyQm91bmQKICAgICk7CiAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHRJbnB1dC5yZW1vdmVFdmVudExpc3RlbmVyKAogICAgICAiaW5wdXQiLAogICAgICB0aGlzLmZ1bGxzY3JlZW5IZWlnaHRDaGFuZ2VIYW5kbGVyRGVib3VuY2VkCiAgICApOwogICAgdGhpcy5mdWxsc2NyZWVuU2l6ZVBhbmVsVG9nZ2xlQnV0dG9uLnJlbW92ZUV2ZW50TGlzdGVuZXIoCiAgICAgICJjbGljayIsCiAgICAgIHRoaXMuZnVsbHNjcmVlblNpemVQYW5lbFRvZ2dsZUJvdW5kCiAgICApOwogICAgdGhpcy5mdWxsc2NyZWVuU2NhbGVTZWxlY3QucmVtb3ZlRXZlbnRMaXN0ZW5lcigKICAgICAgImNoYW5nZSIsCiAgICAgIHRoaXMuZnVsbHNjcmVlbkV4cG9ydFNjYWxlQ2hhbmdlSGFuZGxlckJvdW5kCiAgICApOwogICAgdGhpcy5mdWxsc2NyZWVuRG93bmxvYWQucmVtb3ZlRXZlbnRMaXN0ZW5lcigKICAgICAgImNsaWNrIiwKICAgICAgdGhpcy5mdWxsc2NyZWVuRG93bmxvYWRCb3VuZAogICAgKTsKICAgIGlmICh0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWwpIHsKICAgICAgdGhpcy5ncmVhdEdyYW5kUGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWwpOwogICAgICB0aGlzLmZ1bGxzY3JlZW5TaXplUGFuZWwgPSB2b2lkIDA7CiAgICB9CiAgfQogIGZ1bGxzY3JlZW5DaGFuZ2VIYW5kbGVyKCkgewogICAgaWYgKGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50KSB7CiAgICAgIHRoaXMuZnVsbHNjcmVlbk9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKCgpID0+IHsKICAgICAgICBuZXh0QW5pbWF0aW9uRnJhbWUoMikudGhlbigoKSA9PiB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgdGhpcy5jcmVhdGVGdWxsc2NyZWVuU2l6ZVBhbmVsKCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlQ29udGFpbmVyRGltZW5zaW9ucygpOwogICAgICAgICAgfSwgMCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICB0aGlzLmZ1bGxzY3JlZW5PYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50KTsKICAgICAgdGhpcy5ncmFuZFBhcmVudEVsZW1lbnRGbGV4R3JvdyA9IHRoaXMuZ3JhbmRQYXJlbnRFbGVtZW50LnN0eWxlLmZsZXhHcm93OwogICAgICB0aGlzLmdyYW5kUGFyZW50RWxlbWVudC5zdHlsZS5mbGV4R3JvdyA9IDE7CiAgICAgIHRoaXMuZ3JlYXRHcmFuZFBhcmVudEVsZW1lbnRCYWNrZ3JvdW5kID0gdGhpcy5ncmVhdEdyYW5kUGFyZW50RWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kOwogICAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50LnN0eWxlLmJhY2tncm91bmQgPSAidmFyKC0tanAtbGF5b3V0LWNvbG9yMCkiOwogICAgICB0aGlzLmVsLnN0eWxlLmhlaWdodCA9ICIxMDAlIjsKICAgICAgdGhpcy5mdWxsc2NyZWVuQnV0dG9uSWNvbj8uY2xhc3NMaXN0LnJlbW92ZSgiZmEtZXhwYW5kIik7CiAgICAgIHRoaXMuZnVsbHNjcmVlbkJ1dHRvbkljb24/LmNsYXNzTGlzdC5hZGQoImZhLWNvbXByZXNzIik7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3Quc2V0KHsKICAgICAgICBsYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQ6IGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50LAogICAgICAgIGxhc3NvTG9uZ1ByZXNzSW5kaWNhdG9yUGFyZW50RWxlbWVudDogZG9jdW1lbnQuZnVsbHNjcmVlbkVsZW1lbnQKICAgICAgfSk7CiAgICAgIHRoaXMuZnVsbHNjcmVlbkZ1bGxXaWR0aEhlaWdodCA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmZ1bGxzY3JlZW5PYnNlcnZlcj8uZGlzY29ubmVjdCgpOwogICAgICB0aGlzLmZ1bGxzY3JlZW5PYnNlcnZlciA9IHZvaWQgMDsKICAgICAgdGhpcy5ncmFuZFBhcmVudEVsZW1lbnQuc3R5bGUuZmxleEdyb3cgPSB0aGlzLmdyYW5kUGFyZW50RWxlbWVudEZsZXhHcm93OwogICAgICB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50LnN0eWxlLmJhY2tncm91bmQgPSB0aGlzLmdyZWF0R3JhbmRQYXJlbnRFbGVtZW50QmFja2dyb3VuZDsKICAgICAgdGhpcy5mdWxsc2NyZWVuQnV0dG9uSWNvbj8uY2xhc3NMaXN0LmFkZCgiZmEtZXhwYW5kIik7CiAgICAgIHRoaXMuZnVsbHNjcmVlbkJ1dHRvbkljb24/LmNsYXNzTGlzdC5yZW1vdmUoImZhLWNvbXByZXNzIik7CiAgICAgIHRoaXMuZWwuc3R5bGUuaGVpZ2h0ID0gbnVsbDsKICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUub3V0bGluZSA9IG51bGw7CiAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLmJveFNoYWRvdyA9IG51bGw7CiAgICAgIHRoaXMuc2NhdHRlcnBsb3Quc2V0KHsKICAgICAgICBsYXNzb0luaXRpYXRvclBhcmVudEVsZW1lbnQ6IGRvY3VtZW50LmJvZHksCiAgICAgICAgbGFzc29Mb25nUHJlc3NJbmRpY2F0b3JQYXJlbnRFbGVtZW50OiBkb2N1bWVudC5ib2R5CiAgICAgIH0pOwogICAgICB0aGlzLmRlc3Ryb3lGdWxsc2NyZWVuUmVzaXplUGFuZWwoKTsKICAgICAgbmV4dEFuaW1hdGlvbkZyYW1lKDIpLnRoZW4oKCkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGhpcy51cGRhdGVDb250YWluZXJEaW1lbnNpb25zKCk7CiAgICAgICAgfSwgMCk7CiAgICAgIH0pOwogICAgfQogICAgdGhpcy5zY2F0dGVycGxvdC5zZXQoewogICAgICB3aWR0aDogdGhpcy5nZXRXaWR0aCgpLAogICAgICBoZWlnaHQ6IHRoaXMuZ2V0SGVpZ2h0KCkKICAgIH0pOwogIH0KICByZW5kZXJMYWJlbHMoKSB7CiAgICBpZiAodGhpcy5sYWJlbHM/Lm51bVJvd3MpIHsKICAgICAgdGhpcy5sYWJlbFJlbmRlcmVyLnJlbmRlcigKICAgICAgICB0aGlzLmxhYmVscywKICAgICAgICB0aGlzLmxhYmVsQmFzZVpvb21TY2FsZSAqIHRoaXMuc2NhdHRlcnBsb3QuZ2V0KCJjYW1lcmEiKS5zY2FsaW5nWzBdLAogICAgICAgIHRoaXMuc2NhdHRlcnBsb3QuZ2V0KCJ4U2NhbGUiKSwKICAgICAgICB0aGlzLnNjYXR0ZXJwbG90LmdldCgieVNjYWxlIiksCiAgICAgICAgewogICAgICAgICAgYWxpZ246IHRoaXMubW9kZWwuZ2V0KCJsYWJlbF9hbGlnbiIpLAogICAgICAgICAgb2Zmc2V0OiB0aGlzLm1vZGVsLmdldCgibGFiZWxfb2Zmc2V0IiksCiAgICAgICAgICBzaGFkb3dDb2xvcjogdGhpcy5tb2RlbC5nZXQoImxhYmVsX3NoYWRvd19jb2xvciIpLAogICAgICAgICAgc2NhbGVGdW5jdGlvbjogdGhpcy5tb2RlbC5nZXQoImxhYmVsX3NjYWxlX2Z1bmN0aW9uIikKICAgICAgICB9CiAgICAgICk7CiAgICB9CiAgfQogIGNyZWF0ZVZpZXdUb0xhYmVsVGlsZXMoKSB7CiAgICBjb25zdCB0aWxlU2l6ZSA9IHRoaXMubW9kZWwuZ2V0KCJsYWJlbF90aWxlX3NpemUiKTsKICAgIHRoaXMubGFiZWxCYXNlWm9vbVNjYWxlID0gdGhpcy5vdXRlckhlaWdodCAvIHRpbGVTaXplOwogICAgdGhpcy52aWV3VG9MYWJlbFRpbGVzID0gY3JlYXRlVmlld1RvVGlsZXMoCiAgICAgIHRoaXMubW9kZWwuZ2V0KCJ4X2RvbWFpbiIpLAogICAgICB0aGlzLm1vZGVsLmdldCgieV9kb21haW4iKSwKICAgICAgdGhpcy5sYWJlbEJhc2Vab29tU2NhbGUKICAgICk7CiAgfQogIHhEb21haW5IYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVWaWV3VG9MYWJlbFRpbGVzKCk7CiAgfQogIHlEb21haW5IYW5kbGVyKCkgewogICAgdGhpcy5jcmVhdGVWaWV3VG9MYWJlbFRpbGVzKCk7CiAgfQogIGxhYmVsc0hhbmRsZXIobGFiZWxzKSB7CiAgICB0aGlzLmxhYmVscyA9IGxhYmVsczsKICAgIHRoaXMucmVuZGVyTGFiZWxzKCk7CiAgfQogIGxhYmVsU2hhZG93Q29sb3JIYW5kbGVyKCkgewogICAgdGhpcy5yZW5kZXJMYWJlbHMoKTsKICB9CiAgbGFiZWxBbGlnbkhhbmRsZXIoKSB7CiAgICB0aGlzLnJlbmRlckxhYmVscygpOwogIH0KICBsYWJlbE9mZnNldEhhbmRsZXIoKSB7CiAgICB0aGlzLnJlbmRlckxhYmVscygpOwogIH0KICBsYWJlbFRpbGVTaXplSGFuZGxlcigpIHsKICAgIHRoaXMuY3JlYXRlVmlld1RvTGFiZWxUaWxlcygpOwogIH0KICBkcmF3aW5nSGFuZGxlcih7IGlzVmlld0NoYW5nZWQgfSkgewogICAgaWYgKGlzVmlld0NoYW5nZWQpIHsKICAgICAgdGhpcy5yZW5kZXJMYWJlbHMoKTsKICAgIH0KICB9CiAgb3B0aW9uc0hhbmRsZXIobmV3T3B0aW9ucykgewogICAgdGhpcy5zY2F0dGVycGxvdC5zZXQobmV3T3B0aW9ucyk7CiAgfQogIHdpdGhQcm9wZXJ0eUNoYW5nZUhhbmRsZXIocHJvcGVydHksIGNoYW5nZWRWYWx1ZSkgewogICAgY29uc3QgcCA9IHt9OwogICAgcFtwcm9wZXJ0eV0gPSBjaGFuZ2VkVmFsdWU7CiAgICB0aGlzLnNjYXR0ZXJwbG90LnNldChwKTsKICB9CiAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogWFBhZGRpbmcgc3RhbmRzIGZvciBYIFBhZGRpbmcKICBnZXRYUGFkZGluZygpIHsKICAgIGNvbnN0IHlMYWJlbCA9IHRoaXMubW9kZWwuZ2V0KCJheGVzX2xhYmVscyIpPy5bMV07CiAgICByZXR1cm4geUxhYmVsID8gQVhFU19QQURESU5HX1hfV0lUSF9MQUJFTCA6IEFYRVNfUEFERElOR19YOwogIH0KICAvLyBiaW9tZS1pZ25vcmUgbGludC9zdHlsZS91c2VOYW1pbmdDb252ZW50aW9uOiBZUGFkZGluZyBzdGFuZHMgZm9yIFkgUGFkZGluZwogIGdldFlQYWRkaW5nKCkgewogICAgY29uc3QgeExhYmVsID0gdGhpcy5tb2RlbC5nZXQoImF4ZXNfbGFiZWxzIik/LlswXTsKICAgIHJldHVybiB4TGFiZWwgPyBBWEVTX1BBRERJTkdfWV9XSVRIX0xBQkVMIDogQVhFU19QQURESU5HX1k7CiAgfQogIHNob3dIaXN0b2dyYW0ocHJvcGVydHkpIHsKICAgIGNvbnN0IGhhc0hpc3RvZ3JhbSA9IHRoaXMubW9kZWwuZ2V0KGAke3Byb3BlcnR5fV9oaXN0b2dyYW1gKSB8fCB0aGlzLm1vZGVsLmdldCgidG9vbHRpcF9wcm9wZXJ0aWVzX25vbl92aXN1YWxfaW5mbyIpW3Byb3BlcnR5XT8uaGlzdG9ncmFtOwogICAgaWYgKCFoYXNIaXN0b2dyYW0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3Qgc2hvd0hpc3RvZ3JhbSA9IHRoaXMubW9kZWwuZ2V0KCJ0b29sdGlwX2hpc3RvZ3JhbXMiKTsKICAgIGlmIChzaG93SGlzdG9ncmFtID09PSB0cnVlKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHNob3dIaXN0b2dyYW0gPT09IGZhbHNlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiBzaG93SGlzdG9ncmFtLmluY2x1ZGVzKHByb3BlcnR5KTsKICB9Cn07CmZ1bmN0aW9uIG1vZGVsV2l0aFNlcmlhbGl6ZXJzKG1vZGVsLCBzZXJpYWxpemVycykgewogIHJldHVybiB7CiAgICBnZXQoa2V5KSB7CiAgICAgIGNvbnN0IHZhbHVlID0gbW9kZWwuZ2V0KGtleSk7CiAgICAgIGNvbnN0IHNlcmlhbGl6ZXIgPSBzZXJpYWxpemVyc1trZXldOwogICAgICBpZiAoc2VyaWFsaXplcikgewogICAgICAgIHJldHVybiBzZXJpYWxpemVyLmRlc2VyaWFsaXplKHZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgc2V0KGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSBpbiBzZXJpYWxpemVycykgewogICAgICAgIG1vZGVsLnNldChrZXksIHNlcmlhbGl6ZXJzW2tleV0uc2VyaWFsaXplKHZhbHVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbW9kZWwuc2V0KGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9LAogICAgb246IG1vZGVsLm9uLmJpbmQobW9kZWwpLAogICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogY29taW5nIGZyb20gUHl0aG9uLWxhbmQKICAgIHNhdmVfY2hhbmdlczogbW9kZWwuc2F2ZV9jaGFuZ2VzLmJpbmQobW9kZWwpLAogICAgc2VuZDogbW9kZWwuc2VuZC5iaW5kKG1vZGVsKQogIH07Cn0KYXN5bmMgZnVuY3Rpb24gcmVuZGVyKHsgbW9kZWwsIGVsIH0pIHsKICBjb25zdCB2aWV3ID0gbmV3IEp1cHl0ZXJTY2F0dGVyVmlldyh7CiAgICBlbCwKICAgIG1vZGVsOiBtb2RlbFdpdGhTZXJpYWxpemVycyhtb2RlbCwgewogICAgICBwb2ludHM6IE51bXB5MkQoImZsb2F0MzIiKSwKICAgICAgc2VsZWN0aW9uOiBOdW1weTFEKCJ1aW50MzIiKSwKICAgICAgZmlsdGVyOiBOdW1weTFEKCJ1aW50MzIiKSwKICAgICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogY29taW5nIGZyb20gUHl0aG9uLWxhbmQKICAgICAgdmlld19kYXRhOiBOdW1weUltYWdlKCksCiAgICAgIC8vIGJpb21lLWlnbm9yZSBsaW50L3N0eWxlL3VzZU5hbWluZ0NvbnZlbnRpb246IGNvbWluZyBmcm9tIFB5dGhvbi1sYW5kCiAgICAgIHpvb21fdG86IE51bXB5MUQoInVpbnQzMiIpLAogICAgICBhbm5vdGF0aW9uczogQW5ub3RhdGlvbnMoKSwKICAgICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogY29taW5nIGZyb20gUHl0aG9uLWxhbmQKICAgICAgbGFzc29fc2VsZWN0aW9uX3BvbHlnb246IE51bXB5MkQoImZsb2F0MzIiKSwKICAgICAgLy8gYmlvbWUtaWdub3JlIGxpbnQvc3R5bGUvdXNlTmFtaW5nQ29udmVudGlvbjogY29taW5nIGZyb20gUHl0aG9uLWxhbmQKICAgICAgbGFiZWxzOiBUYWJsZTIoKQogICAgfSkKICB9KTsKICB2aWV3LnJlbmRlcigpOwogIHJldHVybiAoKSA9PiB2aWV3LmRlc3Ryb3koKTsKfQp2YXIgaW5kZXhfZGVmYXVsdCA9IHsgcmVuZGVyIH07CmV4cG9ydCB7CiAgaW5kZXhfZGVmYXVsdCBhcyBkZWZhdWx0Cn07Ci8qISBCdW5kbGVkIGxpY2Vuc2UgaW5mb3JtYXRpb246CgpyZWdsLXNjYXR0ZXJwbG90L2Rpc3QvcmVnbC1zY2F0dGVycGxvdC5lc20uanM6CiAgKCoqCiAgICogS0RCdXNoIC0gQSBmYXN0IHN0YXRpYyBpbmRleCBmb3IgMkQgcG9pbnRzCiAgICogQGxpY2Vuc2UgSVNDIExpY2Vuc2UKICAgKiBAY29weXJpZ2h0IFZsYWRpbWlyIEFnYWZvbmtpbiAyMDE4CiAgICogQHZlcnNpb24gNC4wLjIKICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9tb3VybmVyL2tkYnVzaC8KICAgKikKICAoKioKICAgKiBEb3VnbGFzIFBldWNrZXIgc3F1YXJlIHNlZ21lbnQgZGlzdGFuY2UKICAgKiBJbXBsZW1lbnRhdGlvbiBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9tb3VybmVyL3NpbXBsaWZ5LWpzCiAgICogQGF1dGhvciBWbGFkaW1pciBBZ2Fmb25raW4KICAgKiBAY29weXJpZ2h0IFZsYWRpbWlyIEFnYWZvbmtpbiAyMDEzCiAgICogQGxpY2Vuc2UgQlNECiAgICogQHBhcmFtIHthcnJheX0gcCAtIFBvaW50CiAgICogQHBhcmFtIHthcnJheX0gcDEgLSBGaXJzdCBib3VuZGFyeSBwb2ludAogICAqIEBwYXJhbSB7YXJyYXl9IHAyIC0gU2Vjb25kIGJvdW5kYXJ5IHBvaW50CiAgICogQHJldHVybiB7bnVtYmVyfSBEaXN0YW5jZQogICAqKQogICgqKgogICAqIERvdWdsYXMgUGV1Y2tlciBzdGVwIGZ1bmN0aW9uCiAgICogSW1wbGVtZW50YXRpb24gZnJvbSBodHRwczovL2dpdGh1Yi5jb20vbW91cm5lci9zaW1wbGlmeS1qcwogICAqIEBhdXRob3IgVmxhZGltaXIgQWdhZm9ua2luCiAgICogQGNvcHlyaWdodCBWbGFkaW1pciBBZ2Fmb25raW4gMjAxMwogICAqIEBsaWNlbnNlIEJTRAogICAqIEBwYXJhbSAgIHtbdHlwZV19ICBwb2ludHMgIFtkZXNjcmlwdGlvbl0KICAgKiBAcGFyYW0gICB7W3R5cGVdfSAgZmlyc3QgIFtkZXNjcmlwdGlvbl0KICAgKiBAcGFyYW0gICB7W3R5cGVdfSAgbGFzdCAgW2Rlc2NyaXB0aW9uXQogICAqIEBwYXJhbSAgIHtbdHlwZV19ICB0b2xlcmFuY2UgIFtkZXNjcmlwdGlvbl0KICAgKiBAcGFyYW0gICB7W3R5cGVdfSAgc2ltcGxpZmllZCAgW2Rlc2NyaXB0aW9uXQogICAqIEByZXR1cm4gIHtbdHlwZV19ICBbZGVzY3JpcHRpb25dCiAgICopCiAgKCoqCiAgICogRG91Z2xhcyBQZXVja2VyLiBJbXBsZW1lbnRhdGlvbiBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9tb3VybmVyL3NpbXBsaWZ5LWpzCiAgICogQGF1dGhvciBWbGFkaW1pciBBZ2Fmb25raW4KICAgKiBAY29weXJpZ2h0IFZsYWRpbWlyIEFnYWZvbmtpbiAyMDEzCiAgICogQGxpY2Vuc2UgQlNECiAgICogQHBhcmFtIHthcnJheX0gcG9pbnRzIC0gTGlzdCBvZiBwb2ludHMgdG8gYmUgc2ltcGxpZmllZAogICAqIEBwYXJhbSB7bnVtYmVyfSB0b2xlcmFuY2UgLSBUb2xlcmFuY2UgbGV2ZWwuIFBvaW50cyBiZWxvdyB0aGlzIGRpc3RhbmNlIGxldmVsIHdpbGwgYmUgaWdub3JlZAogICAqIEByZXR1cm4ge2FycmF5fSBTaW1wbGlmaWVkIHBvaW50IGxpc3QKICAgKikKKi8K&quot;' data-js-hash='&quot;e7e57847f521ee2120cc5980f9d0dfa0&quot;'></marimo-anywidget></marimo-ui-element>"
          }
        }
      ],
      "console": []
    },
    {
      "id": "vblA",
      "code_hash": "52b131ba8c06c6c68b5f1f4d3ed3d037",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/html": "<pre class='text-xs'>array([], shape=(0, 2), dtype=float64)</pre>"
          }
        }
      ],
      "console": []
    },
    {
      "id": "bkHC",
      "code_hash": "e4b26b684402a8a42dbc640e129a1b05",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/plain": ""
          }
        }
      ],
      "console": []
    }
  ]
}