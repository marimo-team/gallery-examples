{
  "version": "1",
  "metadata": {
    "marimo_version": "0.19.11"
  },
  "cells": [
    {
      "id": "Hbol",
      "code_hash": null,
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/plain": ""
          }
        }
      ],
      "console": []
    },
    {
      "id": "MJUe",
      "code_hash": "bbcaefe2eedbbc2cfc6e00bf3168cda4",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/plain": ""
          }
        }
      ],
      "console": []
    },
    {
      "id": "vblA",
      "code_hash": "149adf51fad3b8f0be27d87643205097",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/markdown": "<span class=\"markdown prose dark:prose-invert contents\"><h1 id=\"parametric-bookshelf\">Parametric Bookshelf</h1>\n<span class=\"paragraph\">Adjust sliders - camera position is preserved!</span></span>"
          }
        }
      ],
      "console": []
    },
    {
      "id": "bkHC",
      "code_hash": "b8fb64e80c3d4a8156640c4b95329f23",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/plain": ""
          }
        }
      ],
      "console": []
    },
    {
      "id": "lEQa",
      "code_hash": "b2a6be8445513be2bfcafdb61c240dac",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/plain": ""
          }
        }
      ],
      "console": []
    },
    {
      "id": "PKri",
      "code_hash": "94e19d9c83bb828abb5cecfd4de57640",
      "outputs": [
        {
          "type": "data",
          "data": {
            "text/html": "<div style='display: flex;flex: 1;flex-direction: column;justify-content: flex-start;align-items: normal;flex-wrap: nowrap;gap: 0.5rem'><div style='display: flex;flex: 1;flex-direction: row;justify-content: space-between;align-items: normal;flex-wrap: nowrap;gap: 0.5rem'><marimo-ui-element object-id='bkHC-0' random-id='68d2596e-cfbb-4230-9079-c95e3a18cd42'><marimo-slider data-initial-value='4' data-label='&quot;&lt;span class=&#92;&quot;markdown prose dark:prose-invert contents&#92;&quot;&gt;&lt;span class=&#92;&quot;paragraph&#92;&quot;&gt;Shelves&lt;/span&gt;&lt;/span&gt;&quot;' data-start='2' data-stop='8' data-steps='[]' data-debounce='false' data-disabled='false' data-orientation='&quot;horizontal&quot;' data-show-value='false' data-include-input='false' data-full-width='false'></marimo-slider></marimo-ui-element><marimo-ui-element object-id='bkHC-1' random-id='36e6a1e5-7b2d-6f94-9e2e-3bc0945c26e0'><marimo-slider data-initial-value='120' data-label='&quot;&lt;span class=&#92;&quot;markdown prose dark:prose-invert contents&#92;&quot;&gt;&lt;span class=&#92;&quot;paragraph&#92;&quot;&gt;Height (cm)&lt;/span&gt;&lt;/span&gt;&quot;' data-start='60' data-stop='200' data-steps='[]' data-debounce='false' data-disabled='false' data-orientation='&quot;horizontal&quot;' data-show-value='false' data-include-input='false' data-full-width='false'></marimo-slider></marimo-ui-element></div><marimo-ui-element object-id='lEQa-0' random-id='14f32215-4f50-80e4-5dc3-3a948b2bbc47'><marimo-anywidget data-initial-value='{&quot;model_id&quot;:&quot;2984efc4ea45470d8a1408d80a43f31d&quot;}' data-label='null' data-js-url='&quot;data:text/javascript;base64,dmFyIGZ4ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5Owp2YXIgbXggPSAoYSwgdCwgZSkgPT4gdCBpbiBhID8gZngoYSwgdCwgeyBlbnVtZXJhYmxlOiAhMCwgY29uZmlndXJhYmxlOiAhMCwgd3JpdGFibGU6ICEwLCB2YWx1ZTogZSB9KSA6IGFbdF0gPSBlOwp2YXIgayA9IChhLCB0LCBlKSA9PiBteChhLCB0eXBlb2YgdCAhPSAic3ltYm9sIiA/IHQgKyAiIiA6IHQsIGUpOwovKioKICogQGxpY2Vuc2UKICogQ29weXJpZ2h0IDIwMTAtMjAyNSBUaHJlZS5qcyBBdXRob3JzCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKICovCmNvbnN0IFRjID0gIjE4MCIsIFplID0geyBMRUZUOiAwLCBNSURETEU6IDEsIFJJR0hUOiAyLCBST1RBVEU6IDAsIERPTExZOiAxLCBQQU46IDIgfSwgemkgPSB7IFJPVEFURTogMCwgUEFOOiAxLCBET0xMWV9QQU46IDIsIERPTExZX1JPVEFURTogMyB9LCB3MCA9IDAsIFlkID0gMSwgQTAgPSAyLCBneCA9IDMsIHl4ID0gMCwgTXAgPSAxLCBFMCA9IDIsIFNuID0gMywgJGkgPSAwLCBIZSA9IDEsIE1pID0gMiwgWW4gPSAwLCB3cyA9IDEsIFpkID0gMiwgamQgPSAzLCBKZCA9IDQsIFQwID0gNSwgdnMgPSAxMDAsIEMwID0gMTAxLCBSMCA9IDEwMiwgUDAgPSAxMDMsIEkwID0gMTA0LCBMMCA9IDIwMCwgRDAgPSAyMDEsIEYwID0gMjAyLCBVMCA9IDIwMywgSWggPSAyMDQsIExoID0gMjA1LCBCMCA9IDIwNiwgejAgPSAyMDcsIE4wID0gMjA4LCBPMCA9IDIwOSwgazAgPSAyMTAsIFYwID0gMjExLCBIMCA9IDIxMiwgRzAgPSAyMTMsIFcwID0gMjE0LCBEaCA9IDAsIEZoID0gMSwgVWggPSAyLCBwciA9IDMsIEJoID0gNCwgemggPSA1LCBOaCA9IDYsIE9oID0gNywgem8gPSAwLCBxMCA9IDEsICQwID0gMiwgWm4gPSAwLCBYMCA9IDEsIFkwID0gMiwgWjAgPSAzLCBqMCA9IDQsIEowID0gNSwgSzAgPSA2LCBRMCA9IDcsIEtkID0gImF0dGFjaGVkIiwgdHkgPSAiZGV0YWNoZWQiLCBDYyA9IDMwMCwgaXMgPSAzMDEsIFRzID0gMzAyLCB2byA9IDMwMywgYm8gPSAzMDQsIFNhID0gMzA2LCBNbyA9IDFlMywgU2kgPSAxMDAxLCBTbyA9IDEwMDIsIGplID0gMTAwMywgU3AgPSAxMDA0LCBfeCA9IDEwMDQsIHNhID0gMTAwNSwgeHggPSAxMDA1LCBDZSA9IDEwMDYsIGxvID0gMTAwNywgdnggPSAxMDA3LCBFbiA9IDEwMDgsIGJ4ID0gMTAwOCwgcG4gPSAxMDA5LCB3cCA9IDEwMTAsIEFwID0gMTAxMSwgZGEgPSAxMDEyLCBSYyA9IDEwMTMsIG5zID0gMTAxNCwgd2kgPSAxMDE1LCB3YSA9IDEwMTYsIFBjID0gMTAxNywgSWMgPSAxMDE4LCBwYSA9IDEwMjAsIEVwID0gMzU5MDIsIFRwID0gMzU4OTksIENwID0gMTAyMSwgUnAgPSAxMDIyLCBnaSA9IDEwMjMsIGZhID0gMTAyNiwgbWEgPSAxMDI3LCBMYyA9IDEwMjgsIE5vID0gMTAyOSwgUHAgPSAxMDMwLCBEYyA9IDEwMzEsIE14ID0gMTAzMiwgRmMgPSAxMDMzLCBobyA9IDMzNzc2LCBjbyA9IDMzNzc3LCB1byA9IDMzNzc4LCBwbyA9IDMzNzc5LCBraCA9IDM1ODQwLCBWaCA9IDM1ODQxLCBIaCA9IDM1ODQyLCBHaCA9IDM1ODQzLCBXaCA9IDM2MTk2LCBxaCA9IDM3NDkyLCAkaCA9IDM3NDk2LCBYaCA9IDM3ODA4LCBZaCA9IDM3ODA5LCBaaCA9IDM3ODEwLCBqaCA9IDM3ODExLCBKaCA9IDM3ODEyLCBLaCA9IDM3ODEzLCBRaCA9IDM3ODE0LCB0YyA9IDM3ODE1LCBlYyA9IDM3ODE2LCBpYyA9IDM3ODE3LCBuYyA9IDM3ODE4LCBzYyA9IDM3ODE5LCByYyA9IDM3ODIwLCBhYyA9IDM3ODIxLCBvYyA9IDM2NDkyLCBsYyA9IDM2NDk0LCBoYyA9IDM2NDk1LCBjYyA9IDM2MjgzLCB1YyA9IDM2Mjg0LCBkYyA9IDM2Mjg1LCBwYyA9IDM2Mjg2LCBleSA9IDIyMDAsIElwID0gMjIwMSwgTHAgPSAyMjAyLCB3byA9IDIzMDAsIGZjID0gMjMwMSwgYmggPSAyMzAyLCBzciA9IDI0MDAsIHJyID0gMjQwMSwgQW8gPSAyNDAyLCBVYyA9IDI1MDAsIERwID0gMjUwMSwgU3ggPSAwLCB3eCA9IDEsIEF4ID0gMiwgaXkgPSAzMjAwLCBueSA9IDMyMDEsIEV4ID0gMzIwMiwgVHggPSAzMjAzLCBJcyA9IDAsIHN5ID0gMSwgJG4gPSAiIiwgcmkgPSAic3JnYiIsIENzID0gInNyZ2ItbGluZWFyIiwgRW8gPSAibGluZWFyIiwgY2UgPSAic3JnYiIsIEN4ID0gMCwgZXIgPSA3NjgwLCBNaCA9IDc2ODEsIFJ4ID0gNzY4MiwgUHggPSA3NjgzLCBTaCA9IDM0MDU1LCB3aCA9IDM0MDU2LCBJeCA9IDUzODYsIEx4ID0gNTEyLCBEeCA9IDUxMywgRnggPSA1MTQsIFV4ID0gNTE1LCBCeCA9IDUxNiwgcnkgPSA1MTcsIHp4ID0gNTE4LCBUbyA9IDUxOSwgYXkgPSA1MTIsIG95ID0gNTEzLCBseSA9IDUxNCwgRnAgPSA1MTUsIGh5ID0gNTE2LCBjeSA9IDUxNywgdXkgPSA1MTgsIGR5ID0gNTE5LCBDbyA9IDM1MDQ0LCBOeCA9IDM1MDQ4LCBPeCA9IDM1MDQwLCBreCA9IDM1MDQ1LCBWeCA9IDM1MDQ5LCBIeCA9IDM1MDQxLCBHeCA9IDM1MDQ2LCBXeCA9IDM1MDUwLCBxeCA9IDM1MDQyLCAkeCA9ICIxMDAiLCBRZCA9ICIzMDAgZXMiLCBOaSA9IDJlMywgZ2EgPSAyMDAxLCBYeCA9IHsKICBDT01QVVRFOiAiY29tcHV0ZSIsCiAgUkVOREVSOiAicmVuZGVyIgp9LCBZeCA9IHsKICBQRVJTUEVDVElWRTogInBlcnNwZWN0aXZlIiwKICBMSU5FQVI6ICJsaW5lYXIiLAogIEZMQVQ6ICJmbGF0Igp9LCBaeCA9IHsKICBOT1JNQUw6ICJub3JtYWwiLAogIENFTlRST0lEOiAiY2VudHJvaWQiLAogIFNBTVBMRTogInNhbXBsZSIsCiAgRklSU1Q6ICJmaXJzdCIsCiAgRUlUSEVSOiAiZWl0aGVyIgp9OwpsZXQgRWkgPSBjbGFzcyB7CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gZXZlbnQgbGlzdGVuZXIgdG8gdGhlIGdpdmVuIGV2ZW50IHR5cGUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSB0eXBlIG9mIGV2ZW50IHRvIGxpc3RlbiB0by4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIHdoZW4gdGhlIGV2ZW50IGlzIGZpcmVkLgogICAqLwogIGFkZEV2ZW50TGlzdGVuZXIodCwgZSkgewogICAgdGhpcy5fbGlzdGVuZXJzID09PSB2b2lkIDAgJiYgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsKICAgIGNvbnN0IGkgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICBpW3RdID09PSB2b2lkIDAgJiYgKGlbdF0gPSBbXSksIGlbdF0uaW5kZXhPZihlKSA9PT0gLTEgJiYgaVt0XS5wdXNoKGUpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gZXZlbnQgbGlzdGVuZXIgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGdpdmVuIGV2ZW50IHR5cGUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSB0eXBlIG9mIGV2ZW50LgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIC0gVGhlIGxpc3RlbmVyIHRvIGNoZWNrLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGdpdmVuIGV2ZW50IGxpc3RlbmVyIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBnaXZlbiBldmVudCB0eXBlLgogICAqLwogIGhhc0V2ZW50TGlzdGVuZXIodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuX2xpc3RlbmVyczsKICAgIHJldHVybiBpID09PSB2b2lkIDAgPyAhMSA6IGlbdF0gIT09IHZvaWQgMCAmJiBpW3RdLmluZGV4T2YoZSkgIT09IC0xOwogIH0KICAvKioKICAgKiBSZW1vdmVzIHRoZSBnaXZlbiBldmVudCBsaXN0ZW5lciBmcm9tIHRoZSBnaXZlbiBldmVudCB0eXBlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBvZiBldmVudC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFRoZSBsaXN0ZW5lciB0byByZW1vdmUuCiAgICovCiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5fbGlzdGVuZXJzOwogICAgaWYgKGkgPT09IHZvaWQgMCkgcmV0dXJuOwogICAgY29uc3QgbiA9IGlbdF07CiAgICBpZiAobiAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IHMgPSBuLmluZGV4T2YoZSk7CiAgICAgIHMgIT09IC0xICYmIG4uc3BsaWNlKHMsIDEpOwogICAgfQogIH0KICAvKioKICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCAtIFRoZSBldmVudCB0aGF0IGdldHMgZmlyZWQuCiAgICovCiAgZGlzcGF0Y2hFdmVudCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5fbGlzdGVuZXJzOwogICAgaWYgKGUgPT09IHZvaWQgMCkgcmV0dXJuOwogICAgY29uc3QgaSA9IGVbdC50eXBlXTsKICAgIGlmIChpICE9PSB2b2lkIDApIHsKICAgICAgdC50YXJnZXQgPSB0aGlzOwogICAgICBjb25zdCBuID0gaS5zbGljZSgwKTsKICAgICAgZm9yIChsZXQgcyA9IDAsIHIgPSBuLmxlbmd0aDsgcyA8IHI7IHMrKykKICAgICAgICBuW3NdLmNhbGwodGhpcywgdCk7CiAgICAgIHQudGFyZ2V0ID0gbnVsbDsKICAgIH0KICB9Cn07CmNvbnN0IEplID0gWyIwMCIsICIwMSIsICIwMiIsICIwMyIsICIwNCIsICIwNSIsICIwNiIsICIwNyIsICIwOCIsICIwOSIsICIwYSIsICIwYiIsICIwYyIsICIwZCIsICIwZSIsICIwZiIsICIxMCIsICIxMSIsICIxMiIsICIxMyIsICIxNCIsICIxNSIsICIxNiIsICIxNyIsICIxOCIsICIxOSIsICIxYSIsICIxYiIsICIxYyIsICIxZCIsICIxZSIsICIxZiIsICIyMCIsICIyMSIsICIyMiIsICIyMyIsICIyNCIsICIyNSIsICIyNiIsICIyNyIsICIyOCIsICIyOSIsICIyYSIsICIyYiIsICIyYyIsICIyZCIsICIyZSIsICIyZiIsICIzMCIsICIzMSIsICIzMiIsICIzMyIsICIzNCIsICIzNSIsICIzNiIsICIzNyIsICIzOCIsICIzOSIsICIzYSIsICIzYiIsICIzYyIsICIzZCIsICIzZSIsICIzZiIsICI0MCIsICI0MSIsICI0MiIsICI0MyIsICI0NCIsICI0NSIsICI0NiIsICI0NyIsICI0OCIsICI0OSIsICI0YSIsICI0YiIsICI0YyIsICI0ZCIsICI0ZSIsICI0ZiIsICI1MCIsICI1MSIsICI1MiIsICI1MyIsICI1NCIsICI1NSIsICI1NiIsICI1NyIsICI1OCIsICI1OSIsICI1YSIsICI1YiIsICI1YyIsICI1ZCIsICI1ZSIsICI1ZiIsICI2MCIsICI2MSIsICI2MiIsICI2MyIsICI2NCIsICI2NSIsICI2NiIsICI2NyIsICI2OCIsICI2OSIsICI2YSIsICI2YiIsICI2YyIsICI2ZCIsICI2ZSIsICI2ZiIsICI3MCIsICI3MSIsICI3MiIsICI3MyIsICI3NCIsICI3NSIsICI3NiIsICI3NyIsICI3OCIsICI3OSIsICI3YSIsICI3YiIsICI3YyIsICI3ZCIsICI3ZSIsICI3ZiIsICI4MCIsICI4MSIsICI4MiIsICI4MyIsICI4NCIsICI4NSIsICI4NiIsICI4NyIsICI4OCIsICI4OSIsICI4YSIsICI4YiIsICI4YyIsICI4ZCIsICI4ZSIsICI4ZiIsICI5MCIsICI5MSIsICI5MiIsICI5MyIsICI5NCIsICI5NSIsICI5NiIsICI5NyIsICI5OCIsICI5OSIsICI5YSIsICI5YiIsICI5YyIsICI5ZCIsICI5ZSIsICI5ZiIsICJhMCIsICJhMSIsICJhMiIsICJhMyIsICJhNCIsICJhNSIsICJhNiIsICJhNyIsICJhOCIsICJhOSIsICJhYSIsICJhYiIsICJhYyIsICJhZCIsICJhZSIsICJhZiIsICJiMCIsICJiMSIsICJiMiIsICJiMyIsICJiNCIsICJiNSIsICJiNiIsICJiNyIsICJiOCIsICJiOSIsICJiYSIsICJiYiIsICJiYyIsICJiZCIsICJiZSIsICJiZiIsICJjMCIsICJjMSIsICJjMiIsICJjMyIsICJjNCIsICJjNSIsICJjNiIsICJjNyIsICJjOCIsICJjOSIsICJjYSIsICJjYiIsICJjYyIsICJjZCIsICJjZSIsICJjZiIsICJkMCIsICJkMSIsICJkMiIsICJkMyIsICJkNCIsICJkNSIsICJkNiIsICJkNyIsICJkOCIsICJkOSIsICJkYSIsICJkYiIsICJkYyIsICJkZCIsICJkZSIsICJkZiIsICJlMCIsICJlMSIsICJlMiIsICJlMyIsICJlNCIsICJlNSIsICJlNiIsICJlNyIsICJlOCIsICJlOSIsICJlYSIsICJlYiIsICJlYyIsICJlZCIsICJlZSIsICJlZiIsICJmMCIsICJmMSIsICJmMiIsICJmMyIsICJmNCIsICJmNSIsICJmNiIsICJmNyIsICJmOCIsICJmOSIsICJmYSIsICJmYiIsICJmYyIsICJmZCIsICJmZSIsICJmZiJdOwpsZXQgUGYgPSAxMjM0NTY3Owpjb25zdCBsciA9IE1hdGguUEkgLyAxODAsIHlhID0gMTgwIC8gTWF0aC5QSTsKZnVuY3Rpb24gT2koKSB7CiAgY29uc3QgYSA9IE1hdGgucmFuZG9tKCkgKiA0Mjk0OTY3Mjk1IHwgMCwgdCA9IE1hdGgucmFuZG9tKCkgKiA0Mjk0OTY3Mjk1IHwgMCwgZSA9IE1hdGgucmFuZG9tKCkgKiA0Mjk0OTY3Mjk1IHwgMCwgaSA9IE1hdGgucmFuZG9tKCkgKiA0Mjk0OTY3Mjk1IHwgMDsKICByZXR1cm4gKEplW2EgJiAyNTVdICsgSmVbYSA+PiA4ICYgMjU1XSArIEplW2EgPj4gMTYgJiAyNTVdICsgSmVbYSA+PiAyNCAmIDI1NV0gKyAiLSIgKyBKZVt0ICYgMjU1XSArIEplW3QgPj4gOCAmIDI1NV0gKyAiLSIgKyBKZVt0ID4+IDE2ICYgMTUgfCA2NF0gKyBKZVt0ID4+IDI0ICYgMjU1XSArICItIiArIEplW2UgJiA2MyB8IDEyOF0gKyBKZVtlID4+IDggJiAyNTVdICsgIi0iICsgSmVbZSA+PiAxNiAmIDI1NV0gKyBKZVtlID4+IDI0ICYgMjU1XSArIEplW2kgJiAyNTVdICsgSmVbaSA+PiA4ICYgMjU1XSArIEplW2kgPj4gMTYgJiAyNTVdICsgSmVbaSA+PiAyNCAmIDI1NV0pLnRvTG93ZXJDYXNlKCk7Cn0KZnVuY3Rpb24ga3QoYSwgdCwgZSkgewogIHJldHVybiBNYXRoLm1heCh0LCBNYXRoLm1pbihlLCBhKSk7Cn0KZnVuY3Rpb24gVXAoYSwgdCkgewogIHJldHVybiAoYSAlIHQgKyB0KSAlIHQ7Cn0KZnVuY3Rpb24gangoYSwgdCwgZSwgaSwgbikgewogIHJldHVybiBpICsgKGEgLSB0KSAqIChuIC0gaSkgLyAoZSAtIHQpOwp9CmZ1bmN0aW9uIEp4KGEsIHQsIGUpIHsKICByZXR1cm4gYSAhPT0gdCA/IChlIC0gYSkgLyAodCAtIGEpIDogMDsKfQpmdW5jdGlvbiBmbyhhLCB0LCBlKSB7CiAgcmV0dXJuICgxIC0gZSkgKiBhICsgZSAqIHQ7Cn0KZnVuY3Rpb24gS3goYSwgdCwgZSwgaSkgewogIHJldHVybiBmbyhhLCB0LCAxIC0gTWF0aC5leHAoLWUgKiBpKSk7Cn0KZnVuY3Rpb24gUXgoYSwgdCA9IDEpIHsKICByZXR1cm4gdCAtIE1hdGguYWJzKFVwKGEsIHQgKiAyKSAtIHQpOwp9CmZ1bmN0aW9uIHR2KGEsIHQsIGUpIHsKICByZXR1cm4gYSA8PSB0ID8gMCA6IGEgPj0gZSA/IDEgOiAoYSA9IChhIC0gdCkgLyAoZSAtIHQpLCBhICogYSAqICgzIC0gMiAqIGEpKTsKfQpmdW5jdGlvbiBldihhLCB0LCBlKSB7CiAgcmV0dXJuIGEgPD0gdCA/IDAgOiBhID49IGUgPyAxIDogKGEgPSAoYSAtIHQpIC8gKGUgLSB0KSwgYSAqIGEgKiBhICogKGEgKiAoYSAqIDYgLSAxNSkgKyAxMCkpOwp9CmZ1bmN0aW9uIGl2KGEsIHQpIHsKICByZXR1cm4gYSArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqICh0IC0gYSArIDEpKTsKfQpmdW5jdGlvbiBudihhLCB0KSB7CiAgcmV0dXJuIGEgKyBNYXRoLnJhbmRvbSgpICogKHQgLSBhKTsKfQpmdW5jdGlvbiBzdihhKSB7CiAgcmV0dXJuIGEgKiAoMC41IC0gTWF0aC5yYW5kb20oKSk7Cn0KZnVuY3Rpb24gcnYoYSkgewogIGEgIT09IHZvaWQgMCAmJiAoUGYgPSBhKTsKICBsZXQgdCA9IFBmICs9IDE4MzE1NjU4MTM7CiAgcmV0dXJuIHQgPSBNYXRoLmltdWwodCBeIHQgPj4+IDE1LCB0IHwgMSksIHQgXj0gdCArIE1hdGguaW11bCh0IF4gdCA+Pj4gNywgdCB8IDYxKSwgKCh0IF4gdCA+Pj4gMTQpID4+PiAwKSAvIDQyOTQ5NjcyOTY7Cn0KZnVuY3Rpb24gYXYoYSkgewogIHJldHVybiBhICogbHI7Cn0KZnVuY3Rpb24gb3YoYSkgewogIHJldHVybiBhICogeWE7Cn0KZnVuY3Rpb24gbHYoYSkgewogIHJldHVybiAoYSAmIGEgLSAxKSA9PT0gMCAmJiBhICE9PSAwOwp9CmZ1bmN0aW9uIGh2KGEpIHsKICByZXR1cm4gTWF0aC5wb3coMiwgTWF0aC5jZWlsKE1hdGgubG9nKGEpIC8gTWF0aC5MTjIpKTsKfQpmdW5jdGlvbiBjdihhKSB7CiAgcmV0dXJuIE1hdGgucG93KDIsIE1hdGguZmxvb3IoTWF0aC5sb2coYSkgLyBNYXRoLkxOMikpOwp9CmZ1bmN0aW9uIHV2KGEsIHQsIGUsIGksIG4pIHsKICBjb25zdCBzID0gTWF0aC5jb3MsIHIgPSBNYXRoLnNpbiwgbyA9IHMoZSAvIDIpLCBsID0gcihlIC8gMiksIGggPSBzKCh0ICsgaSkgLyAyKSwgYyA9IHIoKHQgKyBpKSAvIDIpLCB1ID0gcygodCAtIGkpIC8gMiksIGQgPSByKCh0IC0gaSkgLyAyKSwgcCA9IHMoKGkgLSB0KSAvIDIpLCBmID0gcigoaSAtIHQpIC8gMik7CiAgc3dpdGNoIChuKSB7CiAgICBjYXNlICJYWVgiOgogICAgICBhLnNldChvICogYywgbCAqIHUsIGwgKiBkLCBvICogaCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWVpZIjoKICAgICAgYS5zZXQobCAqIGQsIG8gKiBjLCBsICogdSwgbyAqIGgpOwogICAgICBicmVhazsKICAgIGNhc2UgIlpYWiI6CiAgICAgIGEuc2V0KGwgKiB1LCBsICogZCwgbyAqIGMsIG8gKiBoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJYWlgiOgogICAgICBhLnNldChvICogYywgbCAqIGYsIGwgKiBwLCBvICogaCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWVhZIjoKICAgICAgYS5zZXQobCAqIHAsIG8gKiBjLCBsICogZiwgbyAqIGgpOwogICAgICBicmVhazsKICAgIGNhc2UgIlpZWiI6CiAgICAgIGEuc2V0KGwgKiBmLCBsICogcCwgbyAqIGMsIG8gKiBoKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICBjb25zb2xlLndhcm4oIlRIUkVFLk1hdGhVdGlsczogLnNldFF1YXRlcm5pb25Gcm9tUHJvcGVyRXVsZXIoKSBlbmNvdW50ZXJlZCBhbiB1bmtub3duIG9yZGVyOiAiICsgbik7CiAgfQp9CmZ1bmN0aW9uIG1pKGEsIHQpIHsKICBzd2l0Y2ggKHQuY29uc3RydWN0b3IpIHsKICAgIGNhc2UgRmxvYXQzMkFycmF5OgogICAgICByZXR1cm4gYTsKICAgIGNhc2UgVWludDMyQXJyYXk6CiAgICAgIHJldHVybiBhIC8gNDI5NDk2NzI5NTsKICAgIGNhc2UgVWludDE2QXJyYXk6CiAgICAgIHJldHVybiBhIC8gNjU1MzU7CiAgICBjYXNlIFVpbnQ4QXJyYXk6CiAgICAgIHJldHVybiBhIC8gMjU1OwogICAgY2FzZSBJbnQzMkFycmF5OgogICAgICByZXR1cm4gTWF0aC5tYXgoYSAvIDIxNDc0ODM2NDcsIC0xKTsKICAgIGNhc2UgSW50MTZBcnJheToKICAgICAgcmV0dXJuIE1hdGgubWF4KGEgLyAzMjc2NywgLTEpOwogICAgY2FzZSBJbnQ4QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLm1heChhIC8gMTI3LCAtMSk7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgY29tcG9uZW50IHR5cGUuIik7CiAgfQp9CmZ1bmN0aW9uIFl0KGEsIHQpIHsKICBzd2l0Y2ggKHQuY29uc3RydWN0b3IpIHsKICAgIGNhc2UgRmxvYXQzMkFycmF5OgogICAgICByZXR1cm4gYTsKICAgIGNhc2UgVWludDMyQXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiA0Mjk0OTY3Mjk1KTsKICAgIGNhc2UgVWludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiA2NTUzNSk7CiAgICBjYXNlIFVpbnQ4QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiAyNTUpOwogICAgY2FzZSBJbnQzMkFycmF5OgogICAgICByZXR1cm4gTWF0aC5yb3VuZChhICogMjE0NzQ4MzY0Nyk7CiAgICBjYXNlIEludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiAzMjc2Nyk7CiAgICBjYXNlIEludDhBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYSAqIDEyNyk7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgY29tcG9uZW50IHR5cGUuIik7CiAgfQp9CmNvbnN0IHB5ID0gewogIERFRzJSQUQ6IGxyLAogIFJBRDJERUc6IHlhLAogIC8qKgogICAqIEdlbmVyYXRlIGEgW1VVSURde0BsaW5rIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1VuaXZlcnNhbGx5X3VuaXF1ZV9pZGVudGlmaWVyfQogICAqICh1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllcikuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIFVVSUQuCiAgICovCiAgZ2VuZXJhdGVVVUlEOiBPaSwKICAvKioKICAgKiBDbGFtcHMgdGhlIGdpdmVuIHZhbHVlIGJldHdlZW4gbWluIGFuZCBtYXguCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBjbGFtcC4KICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbiB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heCB2YWx1ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBjbGFtcGVkIHZhbHVlLgogICAqLwogIGNsYW1wOiBrdCwKICAvKioKICAgKiBDb21wdXRlcyB0aGUgRXVjbGlkZWFuIG1vZHVsbyBvZiB0aGUgZ2l2ZW4gcGFyYW1ldGVycyB0aGF0CiAgICogaXMgYCggKCBuICUgbSApICsgbSApICUgbWAuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEBwYXJhbSB7bnVtYmVyfSBuIC0gVGhlIGZpcnN0IHBhcmFtZXRlci4KICAgKiBAcGFyYW0ge251bWJlcn0gbSAtIFRoZSBzZWNvbmQgcGFyYW1ldGVyLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIEV1Y2xpZGVhbiBtb2R1bG8uCiAgICovCiAgZXVjbGlkZWFuTW9kdWxvOiBVcCwKICAvKioKICAgKiBQZXJmb3JtcyBhIGxpbmVhciBtYXBwaW5nIGZyb20gcmFuZ2UgYDxhMSwgYTI+YCB0byByYW5nZSBgPGIxLCBiMj5gCiAgICogZm9yIHRoZSBnaXZlbiB2YWx1ZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gYmUgbWFwcGVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhMSAtIE1pbmltdW0gdmFsdWUgZm9yIHJhbmdlIEEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGEyIC0gTWF4aW11bSB2YWx1ZSBmb3IgcmFuZ2UgQS4KICAgKiBAcGFyYW0ge251bWJlcn0gYjEgLSBNaW5pbXVtIHZhbHVlIGZvciByYW5nZSBCLgogICAqIEBwYXJhbSB7bnVtYmVyfSBiMiAtIE1heGltdW0gdmFsdWUgZm9yIHJhbmdlIEIuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbWFwcGVkIHZhbHVlLgogICAqLwogIG1hcExpbmVhcjogangsCiAgLyoqCiAgICogUmV0dXJucyB0aGUgcGVyY2VudGFnZSBpbiB0aGUgY2xvc2VkIGludGVydmFsIGBbMCwgMV1gIG9mIHRoZSBnaXZlbiB2YWx1ZQogICAqIGJldHdlZW4gdGhlIHN0YXJ0IGFuZCBlbmQgcG9pbnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHN0YXJ0IHBvaW50CiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgZW5kIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIEEgdmFsdWUgYmV0d2VlbiBzdGFydCBhbmQgZW5kLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yLgogICAqLwogIGludmVyc2VMZXJwOiBKeCwKICAvKioKICAgKiBSZXR1cm5zIGEgdmFsdWUgbGluZWFybHkgaW50ZXJwb2xhdGVkIGZyb20gdHdvIGtub3duIHBvaW50cyBiYXNlZCBvbiB0aGUgZ2l2ZW4gaW50ZXJ2YWwgLQogICAqIGB0ID0gMGAgd2lsbCByZXR1cm4gYHhgIGFuZCBgdCA9IDFgIHdpbGwgcmV0dXJuIGB5YC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgc3RhcnQgcG9pbnQKICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBlbmQgcG9pbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUuCiAgICovCiAgbGVycDogZm8sCiAgLyoqCiAgICogU21vb3RobHkgaW50ZXJwb2xhdGUgYSBudW1iZXIgZnJvbSBgeGAgdG8gYHlgIGluICBhIHNwcmluZy1saWtlIG1hbm5lciB1c2luZyBhIGRlbHRhCiAgICogdGltZSB0byBtYWludGFpbiBmcmFtZSByYXRlIGluZGVwZW5kZW50IG1vdmVtZW50LiBGb3IgZGV0YWlscywgc2VlCiAgICogW0ZyYW1lIHJhdGUgaW5kZXBlbmRlbnQgZGFtcGluZyB1c2luZyBsZXJwXXtAbGluayBodHRwOi8vd3d3LnJvcnlkcmlzY29sbC5jb20vMjAxNi8wMy8wNy9mcmFtZS1yYXRlLWluZGVwZW5kZW50LWRhbXBpbmctdXNpbmctbGVycC99LgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBjdXJyZW50IHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHRhcmdldCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gbGFtYmRhIC0gQSBoaWdoZXIgbGFtYmRhIHZhbHVlIHdpbGwgbWFrZSB0aGUgbW92ZW1lbnQgbW9yZSBzdWRkZW4sCiAgICogYW5kIGEgbG93ZXIgdmFsdWUgd2lsbCBtYWtlIHRoZSBtb3ZlbWVudCBtb3JlIGdyYWR1YWwuCiAgICogQHBhcmFtIHtudW1iZXJ9IGR0IC0gRGVsdGEgdGltZSBpbiBzZWNvbmRzLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGludGVycG9sYXRlZCB2YWx1ZS4KICAgKi8KICBkYW1wOiBLeCwKICAvKioKICAgKiBSZXR1cm5zIGEgdmFsdWUgdGhhdCBhbHRlcm5hdGVzIGJldHdlZW4gYDBgIGFuZCB0aGUgZ2l2ZW4gYGxlbmd0aGAgcGFyYW1ldGVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSB0byBwaW5ncG9uZy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2xlbmd0aD0xXSAtIFRoZSBwb3NpdGl2ZSB2YWx1ZSB0aGUgZnVuY3Rpb24gd2lsbCBwaW5ncG9uZyB0by4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbHRlcm5hdGVkIHZhbHVlLgogICAqLwogIHBpbmdwb25nOiBReCwKICAvKioKICAgKiBSZXR1cm5zIGEgdmFsdWUgaW4gdGhlIHJhbmdlIGBbMCwxXWAgdGhhdCByZXByZXNlbnRzIHRoZSBwZXJjZW50YWdlIHRoYXQgYHhgIGhhcwogICAqIG1vdmVkIGJldHdlZW4gYG1pbmAgYW5kIGBtYXhgLCBidXQgc21vb3RoZWQgb3Igc2xvd2VkIGRvd24gdGhlIGNsb3NlciBgeGAgaXMgdG8KICAgKiB0aGUgYG1pbmAgYW5kIGBtYXhgLgogICAqCiAgICogU2VlIFtTbW9vdGhzdGVwXXtAbGluayBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1Ntb290aHN0ZXB9IGZvciBtb3JlIGRldGFpbHMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIGV2YWx1YXRlIGJhc2VkIG9uIGl0cyBwb3NpdGlvbiBiZXR3ZWVuIG1pbiBhbmQgbWF4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluIHZhbHVlLiBBbnkgeCB2YWx1ZSBiZWxvdyBtaW4gd2lsbCBiZSBgMGAuCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXggdmFsdWUuIEFueSB4IHZhbHVlIGFib3ZlIG1heCB3aWxsIGJlIGAxYC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbHRlcm5hdGVkIHZhbHVlLgogICAqLwogIHNtb290aHN0ZXA6IHR2LAogIC8qKgogICAqIEEgW3ZhcmlhdGlvbiBvbiBzbW9vdGhzdGVwXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TbW9vdGhzdGVwI1ZhcmlhdGlvbnN9CiAgICogdGhhdCBoYXMgemVybyAxc3QgYW5kIDJuZCBvcmRlciBkZXJpdmF0aXZlcyBhdCB4PTAgYW5kIHg9MS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUgYmFzZWQgb24gaXRzIHBvc2l0aW9uIGJldHdlZW4gbWluIGFuZCBtYXguCiAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW4gdmFsdWUuIEFueSB4IHZhbHVlIGJlbG93IG1pbiB3aWxsIGJlIGAwYC4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heCB2YWx1ZS4gQW55IHggdmFsdWUgYWJvdmUgbWF4IHdpbGwgYmUgYDFgLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFsdGVybmF0ZWQgdmFsdWUuCiAgICovCiAgc21vb3RoZXJzdGVwOiBldiwKICAvKioKICAgKiBSZXR1cm5zIGEgcmFuZG9tIGludGVnZXIgZnJvbSBgPGxvdywgaGlnaD5gIGludGVydmFsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0gbG93IC0gVGhlIGxvd2VyIHZhbHVlIGJvdW5kYXJ5LgogICAqIEBwYXJhbSB7bnVtYmVyfSBoaWdoIC0gVGhlIHVwcGVyIHZhbHVlIGJvdW5kYXJ5CiAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBpbnRlZ2VyLgogICAqLwogIHJhbmRJbnQ6IGl2LAogIC8qKgogICAqIFJldHVybnMgYSByYW5kb20gZmxvYXQgZnJvbSBgPGxvdywgaGlnaD5gIGludGVydmFsLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0gbG93IC0gVGhlIGxvd2VyIHZhbHVlIGJvdW5kYXJ5LgogICAqIEBwYXJhbSB7bnVtYmVyfSBoaWdoIC0gVGhlIHVwcGVyIHZhbHVlIGJvdW5kYXJ5CiAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBmbG9hdC4KICAgKi8KICByYW5kRmxvYXQ6IG52LAogIC8qKgogICAqIFJldHVybnMgYSByYW5kb20gaW50ZWdlciBmcm9tIGA8LXJhbmdlLzIsIHJhbmdlLzI+YCBpbnRlcnZhbC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhbmdlIC0gRGVmaW5lcyB0aGUgdmFsdWUgcmFuZ2UuCiAgICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBmbG9hdC4KICAgKi8KICByYW5kRmxvYXRTcHJlYWQ6IHN2LAogIC8qKgogICAqIFJldHVybnMgYSBkZXRlcm1pbmlzdGljIHBzZXVkby1yYW5kb20gZmxvYXQgaW4gdGhlIGludGVydmFsIGBbMCwgMV1gLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0gW3NdIC0gVGhlIGludGVnZXIgc2VlZC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgcmFuZG9tIGZsb2F0LgogICAqLwogIHNlZWRlZFJhbmRvbTogcnYsCiAgLyoqCiAgICogQ29udmVydHMgZGVncmVlcyB0byByYWRpYW5zLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0gZGVncmVlcyAtIEEgdmFsdWUgaW4gZGVncmVlcy4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBjb252ZXJ0ZWQgdmFsdWUgaW4gcmFkaWFucy4KICAgKi8KICBkZWdUb1JhZDogYXYsCiAgLyoqCiAgICogQ29udmVydHMgcmFkaWFucyB0byBkZWdyZWVzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0gcmFkaWFucyAtIEEgdmFsdWUgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBjb252ZXJ0ZWQgdmFsdWUgaW4gZGVncmVlcy4KICAgKi8KICByYWRUb0RlZzogb3YsCiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBhIHBvd2VyIG9mIHR3by4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGdpdmVuIG51bWJlciBpcyBhIHBvd2VyIG9mIHR3byBvciBub3QuCiAgICovCiAgaXNQb3dlck9mVHdvOiBsdiwKICAvKioKICAgKiBSZXR1cm5zIHRoZSBzbWFsbGVzdCBwb3dlciBvZiB0d28gdGhhdCBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIGdpdmVuIG51bWJlci4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGZpbmQgYSBQT1QgZm9yLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNtYWxsZXN0IHBvd2VyIG9mIHR3byB0aGF0IGlzIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB0aGUgZ2l2ZW4gbnVtYmVyLgogICAqLwogIGNlaWxQb3dlck9mVHdvOiBodiwKICAvKioKICAgKiBSZXR1cm5zIHRoZSBsYXJnZXN0IHBvd2VyIG9mIHR3byB0aGF0IGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byB0aGUgZ2l2ZW4gbnVtYmVyLgogICAqCiAgICogQHN0YXRpYwogICAqIEBtZXRob2QKICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmluZCBhIFBPVCBmb3IuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGFyZ2VzdCBwb3dlciBvZiB0d28gdGhhdCBpcyBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gdGhlIGdpdmVuIG51bWJlci4KICAgKi8KICBmbG9vclBvd2VyT2ZUd286IGN2LAogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIHF1YXRlcm5pb24gZnJvbSB0aGUgW0ludHJpbnNpYyBQcm9wZXIgRXVsZXIgQW5nbGVzXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9FdWxlcl9hbmdsZXN9CiAgICogZGVmaW5lZCBieSB0aGUgZ2l2ZW4gYW5nbGVzIGFuZCBvcmRlci4KICAgKgogICAqIFJvdGF0aW9ucyBhcmUgYXBwbGllZCB0byB0aGUgYXhlcyBpbiB0aGUgb3JkZXIgc3BlY2lmaWVkIGJ5IG9yZGVyOgogICAqIHJvdGF0aW9uIGJ5IGFuZ2xlIGBhYCBpcyBhcHBsaWVkIGZpcnN0LCB0aGVuIGJ5IGFuZ2xlIGBiYCwgdGhlbiBieSBhbmdsZSBgY2AuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcSAtIFRoZSBxdWF0ZXJuaW9uIHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0gYSAtIFRoZSByb3RhdGlvbiBhcHBsaWVkIHRvIHRoZSBmaXJzdCBheGlzLCBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBiIC0gVGhlIHJvdGF0aW9uIGFwcGxpZWQgdG8gdGhlIHNlY29uZCBheGlzLCBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjIC0gVGhlIHJvdGF0aW9uIGFwcGxpZWQgdG8gdGhlIHRoaXJkIGF4aXMsIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHsoJ1hZWCd8J1haWCd8J1lYWSd8J1laWSd8J1pYWid8J1pZWicpfSBvcmRlciAtIEEgc3RyaW5nIHNwZWNpZnlpbmcgdGhlIGF4ZXMgb3JkZXIuCiAgICovCiAgc2V0UXVhdGVybmlvbkZyb21Qcm9wZXJFdWxlcjogdXYsCiAgLyoqCiAgICogTm9ybWFsaXplcyB0aGUgZ2l2ZW4gdmFsdWUgYWNjb3JkaW5nIHRvIHRoZSBnaXZlbiB0eXBlZCBhcnJheS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWV0aG9kCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIGZsb2F0IHZhbHVlIGluIHRoZSByYW5nZSBgWzAsMV1gIHRvIG5vcm1hbGl6ZS4KICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IGFycmF5IC0gVGhlIHR5cGVkIGFycmF5IHRoYXQgZGVmaW5lcyB0aGUgZGF0YSB0eXBlIG9mIHRoZSB2YWx1ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBub3JtYWxpemUgdmFsdWUuCiAgICovCiAgbm9ybWFsaXplOiBZdCwKICAvKioKICAgKiBEZW5vcm1hbGl6ZXMgdGhlIGdpdmVuIHZhbHVlIGFjY29yZGluZyB0byB0aGUgZ2l2ZW4gdHlwZWQgYXJyYXkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1ldGhvZAogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBkZW5vcm1hbGl6ZS4KICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IGFycmF5IC0gVGhlIHR5cGVkIGFycmF5IHRoYXQgZGVmaW5lcyB0aGUgZGF0YSB0eXBlIG9mIHRoZSB2YWx1ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZW5vcm1hbGl6ZSAoZmxvYXQpIHZhbHVlIGluIHRoZSByYW5nZSBgWzAsMV1gLgogICAqLwogIGRlbm9ybWFsaXplOiBtaQp9OwpsZXQgSiA9IGNsYXNzIGZ5IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IDJEIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSB4IHZhbHVlIG9mIHRoaXMgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IHZhbHVlIG9mIHRoaXMgdmVjdG9yLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAwLCBlID0gMCkgewogICAgZnkucHJvdG90eXBlLmlzVmVjdG9yMiA9ICEwLCB0aGlzLnggPSB0LCB0aGlzLnkgPSBlOwogIH0KICAvKioKICAgKiBBbGlhcyBmb3Ige0BsaW5rIFZlY3RvcjIjeH0uCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCB3aWR0aCgpIHsKICAgIHJldHVybiB0aGlzLng7CiAgfQogIHNldCB3aWR0aCh0KSB7CiAgICB0aGlzLnggPSB0OwogIH0KICAvKioKICAgKiBBbGlhcyBmb3Ige0BsaW5rIFZlY3RvcjIjeX0uCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCBoZWlnaHQoKSB7CiAgICByZXR1cm4gdGhpcy55OwogIH0KICBzZXQgaGVpZ2h0KHQpIHsKICAgIHRoaXMueSA9IHQ7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgb2YgdGhlIHggY29tcG9uZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIG9mIHRoZSB5IGNvbXBvbmVudC4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIHRvIHRoZSBzYW1lIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxhciAtIFRoZSB2YWx1ZSB0byBzZXQgZm9yIGFsbCB2ZWN0b3IgY29tcG9uZW50cy4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQsIHRoaXMueSA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvcidzIHggY29tcG9uZW50IHRvIHRoZSBnaXZlbiB2YWx1ZQogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldFgodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvcidzIHkgY29tcG9uZW50IHRvIHRoZSBnaXZlbiB2YWx1ZQogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldFkodCkgewogICAgcmV0dXJuIHRoaXMueSA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIEFsbG93cyB0byBzZXQgYSB2ZWN0b3IgY29tcG9uZW50IHdpdGggYW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgY29tcG9uZW50IGluZGV4LiBgMGAgZXF1YWxzIHRvIHgsIGAxYCBlcXVhbHMgdG8geS4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldENvbXBvbmVudCh0LCBlKSB7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMueCA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSBlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHZlY3RvciBjb21wb25lbnQgd2hpY2ggbWF0Y2hlcyB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgY29tcG9uZW50IGluZGV4LiBgMGAgZXF1YWxzIHRvIHgsIGAxYCBlcXVhbHMgdG8geS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgdmVjdG9yIGNvbXBvbmVudCB2YWx1ZS4KICAgKi8KICBnZXRDb21wb25lbnQodCkgewogICAgc3dpdGNoICh0KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgICBjYXNlIDE6CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImluZGV4IGlzIG91dCBvZiByYW5nZTogIiArIHQpOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHZlY3RvciB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMueCwgdGhpcy55KTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBjb3B5LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCwgdGhpcy55ID0gdC55LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gYWRkLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZCh0KSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQueCwgdGhpcy55ICs9IHQueSwgdGhpczsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIHRvIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBzY2FsYXIgdG8gYWRkLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQsIHRoaXMueSArPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3JzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBhIC0gVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IGIgLSBUaGUgc2Vjb25kIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhZGRWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKyBlLngsIHRoaXMueSA9IHQueSArIGUueSwgdGhpczsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gdmVjdG9yIHNjYWxlZCBieSB0aGUgZ2l2ZW4gZmFjdG9yIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIGZhY3RvciB0aGF0IHNjYWxlcyBgdmAuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkU2NhbGVkVmVjdG9yKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54ICogZSwgdGhpcy55ICs9IHQueSAqIGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gdmVjdG9yIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gc3VidHJhY3QuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc3ViKHQpIHsKICAgIHJldHVybiB0aGlzLnggLT0gdC54LCB0aGlzLnkgLT0gdC55LCB0aGlzOwogIH0KICAvKioKICAgKiBTdWJ0cmFjdHMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSBmcm9tIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBzY2FsYXIgdG8gc3VidHJhY3QuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc3ViU2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggLT0gdCwgdGhpcy55IC09IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gdmVjdG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gYSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBiIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc3ViVmVjdG9ycyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54IC0gZS54LCB0aGlzLnkgPSB0LnkgLSBlLnksIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHZlY3RvciB3aXRoIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIG11bHRpcGx5LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIG11bHRpcGx5KHQpIHsKICAgIHJldHVybiB0aGlzLnggKj0gdC54LCB0aGlzLnkgKj0gdC55LCB0aGlzOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoZSBnaXZlbiBzY2FsYXIgdmFsdWUgd2l0aCBhbGwgY29tcG9uZW50cyBvZiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxhciAtIFRoZSBzY2FsYXIgdG8gbXVsdGlwbHkuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHlTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LCB0aGlzLnkgKj0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogRGl2aWRlcyB0aGlzIGluc3RhbmNlIGJ5IHRoZSBnaXZlbiB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGUodCkgewogICAgcmV0dXJuIHRoaXMueCAvPSB0LngsIHRoaXMueSAvPSB0LnksIHRoaXM7CiAgfQogIC8qKgogICAqIERpdmlkZXMgdGhpcyB2ZWN0b3IgYnkgdGhlIGdpdmVuIHNjYWxhci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgc2NhbGFyIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGVTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoMSAvIHQpOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoaXMgdmVjdG9yICh3aXRoIGFuIGltcGxpY2l0IDEgYXMgdGhlIDNyZCBjb21wb25lbnQpIGJ5CiAgICogdGhlIGdpdmVuIDN4MyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbWF0cml4IHRvIGFwcGx5LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFwcGx5TWF0cml4Myh0KSB7CiAgICBjb25zdCBlID0gdGhpcy54LCBpID0gdGhpcy55LCBuID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnggPSBuWzBdICogZSArIG5bM10gKiBpICsgbls2XSwgdGhpcy55ID0gblsxXSAqIGUgKyBuWzRdICogaSArIG5bN10sIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCBvciB5IHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgZ2l2ZW4gdmVjdG9yJ3MgeCBvciB5CiAgICogdmFsdWUsIHJlcGxhY2UgdGhhdCB2YWx1ZSB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIG1pbiB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbWluKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1pbih0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdC55KSwgdGhpczsKICB9CiAgLyoqCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4IG9yIHkgdmFsdWUgaXMgbGVzcyB0aGFuIHRoZSBnaXZlbiB2ZWN0b3IncyB4IG9yIHkKICAgKiB2YWx1ZSwgcmVwbGFjZSB0aGF0IHZhbHVlIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgbWF4IHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtYXgodCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWF4KHRoaXMueCwgdC54KSwgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB0LnkpLCB0aGlzOwogIH0KICAvKioKICAgKiBJZiB0aGlzIHZlY3RvcidzIHggb3IgeSB2YWx1ZSBpcyBncmVhdGVyIHRoYW4gdGhlIG1heCB2ZWN0b3IncyB4IG9yIHkKICAgKiB2YWx1ZSwgaXQgaXMgcmVwbGFjZWQgYnkgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUuCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4IG9yIHkgdmFsdWUgaXMgbGVzcyB0aGFuIHRoZSBtaW4gdmVjdG9yJ3MgeCBvciB5IHZhbHVlLAogICAqIGl0IGlzIHJlcGxhY2VkIGJ5IHRoZSBjb3JyZXNwb25kaW5nIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBtaW4gLSBUaGUgbWluaW11bSB4IGFuZCB5IHZhbHVlcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG1heCAtIFRoZSBtYXhpbXVtIHggYW5kIHkgdmFsdWVzIGluIHRoZSBkZXNpcmVkIHJhbmdlLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNsYW1wKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSBrdCh0aGlzLngsIHQueCwgZS54KSwgdGhpcy55ID0ga3QodGhpcy55LCB0LnksIGUueSksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCBvciB5IHZhbHVlcyBhcmUgZ3JlYXRlciB0aGFuIHRoZSBtYXggdmFsdWUsIHRoZXkgYXJlCiAgICogcmVwbGFjZWQgYnkgdGhlIG1heCB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHggb3IgeSB2YWx1ZXMgYXJlIGxlc3MgdGhhbiB0aGUgbWluIHZhbHVlLCB0aGV5IGFyZQogICAqIHJlcGxhY2VkIGJ5IHRoZSBtaW4gdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbWluVmFsIC0gVGhlIG1pbmltdW0gdmFsdWUgdGhlIGNvbXBvbmVudHMgd2lsbCBiZSBjbGFtcGVkIHRvLgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhWYWwgLSBUaGUgbWF4aW11bSB2YWx1ZSB0aGUgY29tcG9uZW50cyB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXBTY2FsYXIodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IGt0KHRoaXMueCwgdCwgZSksIHRoaXMueSA9IGt0KHRoaXMueSwgdCwgZSksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgbGVuZ3RoIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieQogICAqIHRoZSBtYXggdmFsdWUuCiAgICogSWYgdGhpcyB2ZWN0b3IncyBsZW5ndGggaXMgbGVzcyB0aGFuIHRoZSBtaW4gdmFsdWUsIGl0IGlzIHJlcGxhY2VkIGJ5IHRoZQogICAqIG1pbiB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0aGUgdmVjdG9yIGxlbmd0aCB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRoZSB2ZWN0b3IgbGVuZ3RoIHdpbGwgYmUgY2xhbXBlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBjbGFtcExlbmd0aCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcihpIHx8IDEpLm11bHRpcGx5U2NhbGFyKGt0KGksIHQsIGUpKTsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgZG93biB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgZmxvb3IoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpLCB0aGlzLnkgPSBNYXRoLmZsb29yKHRoaXMueSksIHRoaXM7CiAgfQogIC8qKgogICAqIFRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIGFyZSByb3VuZGVkIHVwIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgdmFsdWUuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBjZWlsKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGguY2VpbCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZQogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yb3VuZCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnJvdW5kKHRoaXMueSksIHRoaXM7CiAgfQogIC8qKgogICAqIFRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIGFyZSByb3VuZGVkIHRvd2FyZHMgemVybyAodXAgaWYgbmVnYXRpdmUsCiAgICogZG93biBpZiBwb3NpdGl2ZSkgdG8gYW4gaW50ZWdlciB2YWx1ZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJvdW5kVG9aZXJvKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KSwgdGhpcy55ID0gTWF0aC50cnVuYyh0aGlzLnkpLCB0aGlzOwogIH0KICAvKioKICAgKiBJbnZlcnRzIHRoaXMgdmVjdG9yIC0gaS5lLiBzZXRzIHggPSAteCBhbmQgeSA9IC15LgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbmVnYXRlKCkgewogICAgcmV0dXJuIHRoaXMueCA9IC10aGlzLngsIHRoaXMueSA9IC10aGlzLnksIHRoaXM7CiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIGRvdCBwcm9kdWN0IG9mIHRoZSBnaXZlbiB2ZWN0b3Igd2l0aCB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBkb3QgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgZG90IHByb2R1Y3QuCiAgICovCiAgZG90KHQpIHsKICAgIHJldHVybiB0aGlzLnggKiB0LnggKyB0aGlzLnkgKiB0Lnk7CiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIGNyb3NzIHByb2R1Y3Qgb2YgdGhlIGdpdmVuIHZlY3RvciB3aXRoIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIGNvbXB1dGUgdGhlIGNyb3NzIHByb2R1Y3Qgd2l0aC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSByZXN1bHQgb2YgdGhlIGNyb3NzIHByb2R1Y3QuCiAgICovCiAgY3Jvc3ModCkgewogICAgcmV0dXJuIHRoaXMueCAqIHQueSAtIHRoaXMueSAqIHQueDsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHNxdWFyZSBvZiB0aGUgRXVjbGlkZWFuIGxlbmd0aCAoc3RyYWlnaHQtbGluZSBsZW5ndGgpIGZyb20KICAgKiAoMCwgMCkgdG8gKHgsIHkpLiBJZiB5b3UgYXJlIGNvbXBhcmluZyB0aGUgbGVuZ3RocyBvZiB2ZWN0b3JzLCB5b3Ugc2hvdWxkCiAgICogY29tcGFyZSB0aGUgbGVuZ3RoIHNxdWFyZWQgaW5zdGVhZCBhcyBpdCBpcyBzbGlnaHRseSBtb3JlIGVmZmljaWVudCB0byBjYWxjdWxhdGUuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBzcXVhcmUgbGVuZ3RoIG9mIHRoaXMgdmVjdG9yLgogICAqLwogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlICBFdWNsaWRlYW4gbGVuZ3RoIChzdHJhaWdodC1saW5lIGxlbmd0aCkgZnJvbSAoMCwgMCkgdG8gKHgsIHkpLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbGVuZ3RoIG9mIHRoaXMgdmVjdG9yLgogICAqLwogIGxlbmd0aCgpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55KTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIE1hbmhhdHRhbiBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbWFuaGF0dGFuTGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguYWJzKHRoaXMueCkgKyBNYXRoLmFicyh0aGlzLnkpOwogIH0KICAvKioKICAgKiBDb252ZXJ0cyB0aGlzIHZlY3RvciB0byBhIHVuaXQgdmVjdG9yIC0gdGhhdCBpcywgc2V0cyBpdCBlcXVhbCB0byBhIHZlY3RvcgogICAqIHdpdGggdGhlIHNhbWUgZGlyZWN0aW9uIGFzIHRoaXMgb25lLCBidXQgd2l0aCBhIHZlY3RvciBsZW5ndGggb2YgYDFgLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbm9ybWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKHRoaXMubGVuZ3RoKCkgfHwgMSk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBhbmdsZSBpbiByYWRpYW5zIG9mIHRoaXMgdmVjdG9yIHdpdGggcmVzcGVjdCB0byB0aGUgcG9zaXRpdmUgeC1heGlzLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgKi8KICBhbmdsZSgpIHsKICAgIHJldHVybiBNYXRoLmF0YW4yKC10aGlzLnksIC10aGlzLngpICsgTWF0aC5QSTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgYW5nbGUgYmV0d2VlbiB0aGUgZ2l2ZW4gdmVjdG9yIGFuZCB0aGlzIGluc3RhbmNlIGluIHJhZGlhbnMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIGNvbXB1dGUgdGhlIGFuZ2xlIHdpdGguCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgKi8KICBhbmdsZVRvKHQpIHsKICAgIGNvbnN0IGUgPSBNYXRoLnNxcnQodGhpcy5sZW5ndGhTcSgpICogdC5sZW5ndGhTcSgpKTsKICAgIGlmIChlID09PSAwKSByZXR1cm4gTWF0aC5QSSAvIDI7CiAgICBjb25zdCBpID0gdGhpcy5kb3QodCkgLyBlOwogICAgcmV0dXJuIE1hdGguYWNvcyhrdChpLCAtMSwgMSkpOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgZGlzdGFuY2UgZnJvbSB0aGUgZ2l2ZW4gdmVjdG9yIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIGNvbXB1dGUgdGhlIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlLgogICAqLwogIGRpc3RhbmNlVG8odCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLmRpc3RhbmNlVG9TcXVhcmVkKHQpKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHNxdWFyZWQgZGlzdGFuY2UgZnJvbSB0aGUgZ2l2ZW4gdmVjdG9yIHRvIHRoaXMgaW5zdGFuY2UuCiAgICogSWYgeW91IGFyZSBqdXN0IGNvbXBhcmluZyB0aGUgZGlzdGFuY2Ugd2l0aCBhbm90aGVyIGRpc3RhbmNlLCB5b3Ugc2hvdWxkIGNvbXBhcmUKICAgKiB0aGUgZGlzdGFuY2Ugc3F1YXJlZCBpbnN0ZWFkIGFzIGl0IGlzIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IHRvIGNhbGN1bGF0ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgc3F1YXJlZCBkaXN0YW5jZSB0by4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBzcXVhcmVkIGRpc3RhbmNlLgogICAqLwogIGRpc3RhbmNlVG9TcXVhcmVkKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnggLSB0LngsIGkgPSB0aGlzLnkgLSB0Lnk7CiAgICByZXR1cm4gZSAqIGUgKyBpICogaTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIE1hbmhhdHRhbiBkaXN0YW5jZSBmcm9tIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgTWFuaGF0dGFuIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIE1hbmhhdHRhbiBkaXN0YW5jZS4KICAgKi8KICBtYW5oYXR0YW5EaXN0YW5jZVRvKHQpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLnggLSB0LngpICsgTWF0aC5hYnModGhpcy55IC0gdC55KTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHZlY3RvciB0byBhIHZlY3RvciB3aXRoIHRoZSBzYW1lIGRpcmVjdGlvbiBhcyB0aGlzIG9uZSwgYnV0CiAgICogd2l0aCB0aGUgc3BlY2lmaWVkIGxlbmd0aC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgbmV3IGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRMZW5ndGgodCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodCk7CiAgfQogIC8qKgogICAqIExpbmVhcmx5IGludGVycG9sYXRlcyBiZXR3ZWVuIHRoZSBnaXZlbiB2ZWN0b3IgYW5kIHRoaXMgaW5zdGFuY2UsIHdoZXJlCiAgICogYWxwaGEgaXMgdGhlIHBlcmNlbnQgZGlzdGFuY2UgYWxvbmcgdGhlIGxpbmUgLSBhbHBoYSA9IDAgd2lsbCBiZSB0aGlzCiAgICogdmVjdG9yLCBhbmQgYWxwaGEgPSAxIHdpbGwgYmUgdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gaW50ZXJwb2xhdGUgdG93YXJkcy4KICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IsIHR5cGljYWxseSBpbiB0aGUgY2xvc2VkIGludGVydmFsIGBbMCwgMV1gLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGxlcnAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCArPSAodC54IC0gdGhpcy54KSAqIGUsIHRoaXMueSArPSAodC55IC0gdGhpcy55KSAqIGUsIHRoaXM7CiAgfQogIC8qKgogICAqIExpbmVhcmx5IGludGVycG9sYXRlcyBiZXR3ZWVuIHRoZSBnaXZlbiB2ZWN0b3JzLCB3aGVyZSBhbHBoYSBpcyB0aGUgcGVyY2VudAogICAqIGRpc3RhbmNlIGFsb25nIHRoZSBsaW5lIC0gYWxwaGEgPSAwIHdpbGwgYmUgZmlyc3QgdmVjdG9yLCBhbmQgYWxwaGEgPSAxIHdpbGwKICAgKiBiZSB0aGUgc2Vjb25kIG9uZS4gVGhlIHJlc3VsdCBpcyBzdG9yZWQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdjEgLSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdjIgLSBUaGUgc2Vjb25kIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IsIHR5cGljYWxseSBpbiB0aGUgY2xvc2VkIGludGVydmFsIGBbMCwgMV1gLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGxlcnBWZWN0b3JzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKyAoZS54IC0gdC54KSAqIGksIHRoaXMueSA9IHQueSArIChlLnkgLSB0LnkpICogaSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyB2ZWN0b3IgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgdmVjdG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQueCA9PT0gdGhpcy54ICYmIHQueSA9PT0gdGhpcy55OwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgdmVjdG9yJ3MgeCB2YWx1ZSB0byBiZSBgYXJyYXlbIG9mZnNldCBdYCBhbmQgeQogICAqIHZhbHVlIHRvIGJlIGBhcnJheVsgb2Zmc2V0ICsgMSBdYC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYXJyYXkgLSBBbiBhcnJheSBob2xkaW5nIHRoZSB2ZWN0b3IgY29tcG9uZW50IHZhbHVlcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldD0wXSAtIFRoZSBvZmZzZXQgaW50byB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdFtlXSwgdGhpcy55ID0gdFtlICsgMV0sIHRoaXM7CiAgfQogIC8qKgogICAqIFdyaXRlcyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgdmVjdG9yIGNvbXBvbmVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBJbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gVGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgcmV0dXJuIHRbZV0gPSB0aGlzLngsIHRbZSArIDFdID0gdGhpcy55LCB0OwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIGZyb20gdGhlIGdpdmVuIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckF0dHJpYnV0ZX0gYXR0cmlidXRlIC0gVGhlIGJ1ZmZlciBhdHRyaWJ1dGUgaG9sZGluZyB2ZWN0b3IgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYXR0cmlidXRlLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQuZ2V0WChlKSwgdGhpcy55ID0gdC5nZXRZKGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoaXMgdmVjdG9yIGFyb3VuZCB0aGUgZ2l2ZW4gY2VudGVyIGJ5IHRoZSBnaXZlbiBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gY2VudGVyIC0gVGhlIHBvaW50IGFyb3VuZCB3aGljaCB0byByb3RhdGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIHRvIHJvdGF0ZSwgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICByb3RhdGVBcm91bmQodCwgZSkgewogICAgY29uc3QgaSA9IE1hdGguY29zKGUpLCBuID0gTWF0aC5zaW4oZSksIHMgPSB0aGlzLnggLSB0LngsIHIgPSB0aGlzLnkgLSB0Lnk7CiAgICByZXR1cm4gdGhpcy54ID0gcyAqIGkgLSByICogbiArIHQueCwgdGhpcy55ID0gcyAqIG4gKyByICogaSArIHQueSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyBlYWNoIGNvbXBvbmVudCBvZiB0aGlzIHZlY3RvciB0byBhIHBzZXVkby1yYW5kb20gdmFsdWUgYmV0d2VlbiBgMGAgYW5kCiAgICogYDFgLCBleGNsdWRpbmcgYDFgLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcmFuZG9tKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgucmFuZG9tKCksIHRoaXMueSA9IE1hdGgucmFuZG9tKCksIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueCwgeWllbGQgdGhpcy55OwogIH0KfSwgdmUgPSBjbGFzcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBxdWF0ZXJuaW9uLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gVGhlIHggdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IHZhbHVlIG9mIHRoaXMgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gW3o9MF0gLSBUaGUgeiB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3PTFdIC0gVGhlIHcgdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAwLCBlID0gMCwgaSA9IDAsIG4gPSAxKSB7CiAgICB0aGlzLmlzUXVhdGVybmlvbiA9ICEwLCB0aGlzLl94ID0gdCwgdGhpcy5feSA9IGUsIHRoaXMuX3ogPSBpLCB0aGlzLl93ID0gbjsKICB9CiAgLyoqCiAgICogSW50ZXJwb2xhdGVzIGJldHdlZW4gdHdvIHF1YXRlcm5pb25zIHZpYSBTTEVSUC4gVGhpcyBpbXBsZW1lbnRhdGlvbiBhc3N1bWVzIHRoZQogICAqIHF1YXRlcm5pb24gZGF0YSBhcmUgbWFuYWdlZCAgaW4gZmxhdCBhcnJheXMuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGRzdCAtIFRoZSBkZXN0aW5hdGlvbiBhcnJheS4KICAgKiBAcGFyYW0ge251bWJlcn0gZHN0T2Zmc2V0IC0gQW4gb2Zmc2V0IGludG8gdGhlIGRlc3RpbmF0aW9uIGFycmF5LgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gc3JjMCAtIFRoZSBzb3VyY2UgYXJyYXkgb2YgdGhlIGZpcnN0IHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHNyY09mZnNldDAgLSBBbiBvZmZzZXQgaW50byB0aGUgZmlyc3Qgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gc3JjMSAtICBUaGUgc291cmNlIGFycmF5IG9mIHRoZSBzZWNvbmQgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gc3JjT2Zmc2V0MSAtIEFuIG9mZnNldCBpbnRvIHRoZSBzZWNvbmQgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yIGluIHRoZSByYW5nZSBgWzAsMV1gLgogICAqIEBzZWUge0BsaW5rIFF1YXRlcm5pb24jc2xlcnB9CiAgICovCiAgc3RhdGljIHNsZXJwRmxhdCh0LCBlLCBpLCBuLCBzLCByLCBvKSB7CiAgICBsZXQgbCA9IGlbbiArIDBdLCBoID0gaVtuICsgMV0sIGMgPSBpW24gKyAyXSwgdSA9IGlbbiArIDNdOwogICAgY29uc3QgZCA9IHNbciArIDBdLCBwID0gc1tyICsgMV0sIGYgPSBzW3IgKyAyXSwgeSA9IHNbciArIDNdOwogICAgaWYgKG8gPT09IDApIHsKICAgICAgdFtlICsgMF0gPSBsLCB0W2UgKyAxXSA9IGgsIHRbZSArIDJdID0gYywgdFtlICsgM10gPSB1OwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAobyA9PT0gMSkgewogICAgICB0W2UgKyAwXSA9IGQsIHRbZSArIDFdID0gcCwgdFtlICsgMl0gPSBmLCB0W2UgKyAzXSA9IHk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh1ICE9PSB5IHx8IGwgIT09IGQgfHwgaCAhPT0gcCB8fCBjICE9PSBmKSB7CiAgICAgIGxldCBnID0gMSAtIG87CiAgICAgIGNvbnN0IG0gPSBsICogZCArIGggKiBwICsgYyAqIGYgKyB1ICogeSwgdiA9IG0gPj0gMCA/IDEgOiAtMSwgeCA9IDEgLSBtICogbTsKICAgICAgaWYgKHggPiBOdW1iZXIuRVBTSUxPTikgewogICAgICAgIGNvbnN0IFMgPSBNYXRoLnNxcnQoeCksIHcgPSBNYXRoLmF0YW4yKFMsIG0gKiB2KTsKICAgICAgICBnID0gTWF0aC5zaW4oZyAqIHcpIC8gUywgbyA9IE1hdGguc2luKG8gKiB3KSAvIFM7CiAgICAgIH0KICAgICAgY29uc3QgXyA9IG8gKiB2OwogICAgICBpZiAobCA9IGwgKiBnICsgZCAqIF8sIGggPSBoICogZyArIHAgKiBfLCBjID0gYyAqIGcgKyBmICogXywgdSA9IHUgKiBnICsgeSAqIF8sIGcgPT09IDEgLSBvKSB7CiAgICAgICAgY29uc3QgUyA9IDEgLyBNYXRoLnNxcnQobCAqIGwgKyBoICogaCArIGMgKiBjICsgdSAqIHUpOwogICAgICAgIGwgKj0gUywgaCAqPSBTLCBjICo9IFMsIHUgKj0gUzsKICAgICAgfQogICAgfQogICAgdFtlXSA9IGwsIHRbZSArIDFdID0gaCwgdFtlICsgMl0gPSBjLCB0W2UgKyAzXSA9IHU7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdHdvIHF1YXRlcm5pb25zLiBUaGlzIGltcGxlbWVudGF0aW9uIGFzc3VtZXMgdGhlIHF1YXRlcm5pb24gZGF0YSBhcmUgbWFuYWdlZAogICAqIGluIGZsYXQgYXJyYXlzLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBkc3QgLSBUaGUgZGVzdGluYXRpb24gYXJyYXkuCiAgICogQHBhcmFtIHtudW1iZXJ9IGRzdE9mZnNldCAtIEFuIG9mZnNldCBpbnRvIHRoZSBkZXN0aW5hdGlvbiBhcnJheS4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHNyYzAgLSBUaGUgc291cmNlIGFycmF5IG9mIHRoZSBmaXJzdCBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzcmNPZmZzZXQwIC0gQW4gb2Zmc2V0IGludG8gdGhlIGZpcnN0IHNvdXJjZSBhcnJheS4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHNyYzEgLSAgVGhlIHNvdXJjZSBhcnJheSBvZiB0aGUgc2Vjb25kIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHNyY09mZnNldDEgLSBBbiBvZmZzZXQgaW50byB0aGUgc2Vjb25kIHNvdXJjZSBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgZGVzdGluYXRpb24gYXJyYXkuCiAgICogQHNlZSB7QGxpbmsgUXVhdGVybmlvbiNtdWx0aXBseVF1YXRlcm5pb25zfS4KICAgKi8KICBzdGF0aWMgbXVsdGlwbHlRdWF0ZXJuaW9uc0ZsYXQodCwgZSwgaSwgbiwgcywgcikgewogICAgY29uc3QgbyA9IGlbbl0sIGwgPSBpW24gKyAxXSwgaCA9IGlbbiArIDJdLCBjID0gaVtuICsgM10sIHUgPSBzW3JdLCBkID0gc1tyICsgMV0sIHAgPSBzW3IgKyAyXSwgZiA9IHNbciArIDNdOwogICAgcmV0dXJuIHRbZV0gPSBvICogZiArIGMgKiB1ICsgbCAqIHAgLSBoICogZCwgdFtlICsgMV0gPSBsICogZiArIGMgKiBkICsgaCAqIHUgLSBvICogcCwgdFtlICsgMl0gPSBoICogZiArIGMgKiBwICsgbyAqIGQgLSBsICogdSwgdFtlICsgM10gPSBjICogZiAtIG8gKiB1IC0gbCAqIGQgLSBoICogcCwgdDsKICB9CiAgLyoqCiAgICogVGhlIHggdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IHgoKSB7CiAgICByZXR1cm4gdGhpcy5feDsKICB9CiAgc2V0IHgodCkgewogICAgdGhpcy5feCA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgLyoqCiAgICogVGhlIHkgdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IHkoKSB7CiAgICByZXR1cm4gdGhpcy5feTsKICB9CiAgc2V0IHkodCkgewogICAgdGhpcy5feSA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgLyoqCiAgICogVGhlIHogdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IHooKSB7CiAgICByZXR1cm4gdGhpcy5fejsKICB9CiAgc2V0IHoodCkgewogICAgdGhpcy5feiA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgLyoqCiAgICogVGhlIHcgdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAxCiAgICovCiAgZ2V0IHcoKSB7CiAgICByZXR1cm4gdGhpcy5fdzsKICB9CiAgc2V0IHcodCkgewogICAgdGhpcy5fdyA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgcXVhdGVybmlvbiBjb21wb25lbnRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgeiB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHcgLSBUaGUgdyB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHNldCh0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHQsIHRoaXMuX3kgPSBlLCB0aGlzLl96ID0gaSwgdGhpcy5fdyA9IG4sIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBxdWF0ZXJuaW9uIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5feCwgdGhpcy5feSwgdGhpcy5feiwgdGhpcy5fdyk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBxdWF0ZXJuaW9uIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHF1YXRlcm5pb24gLSBUaGUgcXVhdGVybmlvbiB0byBjb3B5LgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdC54LCB0aGlzLl95ID0gdC55LCB0aGlzLl96ID0gdC56LCB0aGlzLl93ID0gdC53LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBxdWF0ZXJuaW9uIGZyb20gdGhlIHJvdGF0aW9uIHNwZWNpZmllZCBieSB0aGUgZ2l2ZW4KICAgKiBFdWxlciBhbmdsZXMuCiAgICoKICAgKiBAcGFyYW0ge0V1bGVyfSBldWxlciAtIFRoZSBFdWxlciBhbmdsZXMuCiAgICogQHBhcmFtIHtib29sZWFufSBbdXBkYXRlPXRydWVdIC0gV2hldGhlciB0aGUgaW50ZXJuYWwgYG9uQ2hhbmdlYCBjYWxsYmFjayBzaG91bGQgYmUgZXhlY3V0ZWQgb3Igbm90LgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBzZXRGcm9tRXVsZXIodCwgZSA9ICEwKSB7CiAgICBjb25zdCBpID0gdC5feCwgbiA9IHQuX3ksIHMgPSB0Ll96LCByID0gdC5fb3JkZXIsIG8gPSBNYXRoLmNvcywgbCA9IE1hdGguc2luLCBoID0gbyhpIC8gMiksIGMgPSBvKG4gLyAyKSwgdSA9IG8ocyAvIDIpLCBkID0gbChpIC8gMiksIHAgPSBsKG4gLyAyKSwgZiA9IGwocyAvIDIpOwogICAgc3dpdGNoIChyKSB7CiAgICAgIGNhc2UgIlhZWiI6CiAgICAgICAgdGhpcy5feCA9IGQgKiBjICogdSArIGggKiBwICogZiwgdGhpcy5feSA9IGggKiBwICogdSAtIGQgKiBjICogZiwgdGhpcy5feiA9IGggKiBjICogZiArIGQgKiBwICogdSwgdGhpcy5fdyA9IGggKiBjICogdSAtIGQgKiBwICogZjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWVhaIjoKICAgICAgICB0aGlzLl94ID0gZCAqIGMgKiB1ICsgaCAqIHAgKiBmLCB0aGlzLl95ID0gaCAqIHAgKiB1IC0gZCAqIGMgKiBmLCB0aGlzLl96ID0gaCAqIGMgKiBmIC0gZCAqIHAgKiB1LCB0aGlzLl93ID0gaCAqIGMgKiB1ICsgZCAqIHAgKiBmOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaWFkiOgogICAgICAgIHRoaXMuX3ggPSBkICogYyAqIHUgLSBoICogcCAqIGYsIHRoaXMuX3kgPSBoICogcCAqIHUgKyBkICogYyAqIGYsIHRoaXMuX3ogPSBoICogYyAqIGYgKyBkICogcCAqIHUsIHRoaXMuX3cgPSBoICogYyAqIHUgLSBkICogcCAqIGY7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlpZWCI6CiAgICAgICAgdGhpcy5feCA9IGQgKiBjICogdSAtIGggKiBwICogZiwgdGhpcy5feSA9IGggKiBwICogdSArIGQgKiBjICogZiwgdGhpcy5feiA9IGggKiBjICogZiAtIGQgKiBwICogdSwgdGhpcy5fdyA9IGggKiBjICogdSArIGQgKiBwICogZjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWVpYIjoKICAgICAgICB0aGlzLl94ID0gZCAqIGMgKiB1ICsgaCAqIHAgKiBmLCB0aGlzLl95ID0gaCAqIHAgKiB1ICsgZCAqIGMgKiBmLCB0aGlzLl96ID0gaCAqIGMgKiBmIC0gZCAqIHAgKiB1LCB0aGlzLl93ID0gaCAqIGMgKiB1IC0gZCAqIHAgKiBmOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJYWlkiOgogICAgICAgIHRoaXMuX3ggPSBkICogYyAqIHUgLSBoICogcCAqIGYsIHRoaXMuX3kgPSBoICogcCAqIHUgLSBkICogYyAqIGYsIHRoaXMuX3ogPSBoICogYyAqIGYgKyBkICogcCAqIHUsIHRoaXMuX3cgPSBoICogYyAqIHUgKyBkICogcCAqIGY7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5RdWF0ZXJuaW9uOiAuc2V0RnJvbUV1bGVyKCkgZW5jb3VudGVyZWQgYW4gdW5rbm93biBvcmRlcjogIiArIHIpOwogICAgfQogICAgcmV0dXJuIGUgPT09ICEwICYmIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHF1YXRlcm5pb24gZnJvbSB0aGUgZ2l2ZW4gYXhpcyBhbmQgYW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGF4aXMgLSBUaGUgbm9ybWFsaXplZCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBzZXRGcm9tQXhpc0FuZ2xlKHQsIGUpIHsKICAgIGNvbnN0IGkgPSBlIC8gMiwgbiA9IE1hdGguc2luKGkpOwogICAgcmV0dXJuIHRoaXMuX3ggPSB0LnggKiBuLCB0aGlzLl95ID0gdC55ICogbiwgdGhpcy5feiA9IHQueiAqIG4sIHRoaXMuX3cgPSBNYXRoLmNvcyhpKSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgcXVhdGVybmlvbiBmcm9tIHRoZSBnaXZlbiByb3RhdGlvbiBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBBIDR4NCBtYXRyaXggb2Ygd2hpY2ggdGhlIHVwcGVyIDN4MyBvZiBtYXRyaXggaXMgYSBwdXJlIHJvdGF0aW9uIG1hdHJpeCAoaS5lLiB1bnNjYWxlZCkuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHNldEZyb21Sb3RhdGlvbk1hdHJpeCh0KSB7CiAgICBjb25zdCBlID0gdC5lbGVtZW50cywgaSA9IGVbMF0sIG4gPSBlWzRdLCBzID0gZVs4XSwgciA9IGVbMV0sIG8gPSBlWzVdLCBsID0gZVs5XSwgaCA9IGVbMl0sIGMgPSBlWzZdLCB1ID0gZVsxMF0sIGQgPSBpICsgbyArIHU7CiAgICBpZiAoZCA+IDApIHsKICAgICAgY29uc3QgcCA9IDAuNSAvIE1hdGguc3FydChkICsgMSk7CiAgICAgIHRoaXMuX3cgPSAwLjI1IC8gcCwgdGhpcy5feCA9IChjIC0gbCkgKiBwLCB0aGlzLl95ID0gKHMgLSBoKSAqIHAsIHRoaXMuX3ogPSAociAtIG4pICogcDsKICAgIH0gZWxzZSBpZiAoaSA+IG8gJiYgaSA+IHUpIHsKICAgICAgY29uc3QgcCA9IDIgKiBNYXRoLnNxcnQoMSArIGkgLSBvIC0gdSk7CiAgICAgIHRoaXMuX3cgPSAoYyAtIGwpIC8gcCwgdGhpcy5feCA9IDAuMjUgKiBwLCB0aGlzLl95ID0gKG4gKyByKSAvIHAsIHRoaXMuX3ogPSAocyArIGgpIC8gcDsKICAgIH0gZWxzZSBpZiAobyA+IHUpIHsKICAgICAgY29uc3QgcCA9IDIgKiBNYXRoLnNxcnQoMSArIG8gLSBpIC0gdSk7CiAgICAgIHRoaXMuX3cgPSAocyAtIGgpIC8gcCwgdGhpcy5feCA9IChuICsgcikgLyBwLCB0aGlzLl95ID0gMC4yNSAqIHAsIHRoaXMuX3ogPSAobCArIGMpIC8gcDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHAgPSAyICogTWF0aC5zcXJ0KDEgKyB1IC0gaSAtIG8pOwogICAgICB0aGlzLl93ID0gKHIgLSBuKSAvIHAsIHRoaXMuX3ggPSAocyArIGgpIC8gcCwgdGhpcy5feSA9IChsICsgYykgLyBwLCB0aGlzLl96ID0gMC4yNSAqIHA7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgcXVhdGVybmlvbiB0byB0aGUgcm90YXRpb24gcmVxdWlyZWQgdG8gcm90YXRlIHRoZSBkaXJlY3Rpb24gdmVjdG9yCiAgICogYHZGcm9tYCB0byB0aGUgZGlyZWN0aW9uIHZlY3RvciBgdlRvYC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdkZyb20gLSBUaGUgZmlyc3QgKG5vcm1hbGl6ZWQpIGRpcmVjdGlvbiB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2VG8gLSBUaGUgc2Vjb25kIChub3JtYWxpemVkKSBkaXJlY3Rpb24gdmVjdG9yLgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBzZXRGcm9tVW5pdFZlY3RvcnModCwgZSkgewogICAgbGV0IGkgPSB0LmRvdChlKSArIDE7CiAgICByZXR1cm4gaSA8IDFlLTggPyAoaSA9IDAsIE1hdGguYWJzKHQueCkgPiBNYXRoLmFicyh0LnopID8gKHRoaXMuX3ggPSAtdC55LCB0aGlzLl95ID0gdC54LCB0aGlzLl96ID0gMCwgdGhpcy5fdyA9IGkpIDogKHRoaXMuX3ggPSAwLCB0aGlzLl95ID0gLXQueiwgdGhpcy5feiA9IHQueSwgdGhpcy5fdyA9IGkpKSA6ICh0aGlzLl94ID0gdC55ICogZS56IC0gdC56ICogZS55LCB0aGlzLl95ID0gdC56ICogZS54IC0gdC54ICogZS56LCB0aGlzLl96ID0gdC54ICogZS55IC0gdC55ICogZS54LCB0aGlzLl93ID0gaSksIHRoaXMubm9ybWFsaXplKCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGFuZ2xlIGJldHdlZW4gdGhpcyBxdWF0ZXJuaW9uIGFuZCB0aGUgZ2l2ZW4gb25lIGluIHJhZGlhbnMuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgcXVhdGVybmlvbiB0byBjb21wdXRlIHRoZSBhbmdsZSB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICovCiAgYW5nbGVUbyh0KSB7CiAgICByZXR1cm4gMiAqIE1hdGguYWNvcyhNYXRoLmFicyhrdCh0aGlzLmRvdCh0KSwgLTEsIDEpKSk7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhpcyBxdWF0ZXJuaW9uIGJ5IGEgZ2l2ZW4gYW5ndWxhciBzdGVwIHRvIHRoZSBnaXZlbiBxdWF0ZXJuaW9uLgogICAqIFRoZSBtZXRob2QgZW5zdXJlcyB0aGF0IHRoZSBmaW5hbCBxdWF0ZXJuaW9uIHdpbGwgbm90IG92ZXJzaG9vdCBgcWAuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgdGFyZ2V0IHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXAgLSBUaGUgYW5ndWxhciBzdGVwIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHJvdGF0ZVRvd2FyZHModCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuYW5nbGVUbyh0KTsKICAgIGlmIChpID09PSAwKSByZXR1cm4gdGhpczsKICAgIGNvbnN0IG4gPSBNYXRoLm1pbigxLCBlIC8gaSk7CiAgICByZXR1cm4gdGhpcy5zbGVycCh0LCBuKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHF1YXRlcm5pb24gdG8gdGhlIGlkZW50aXR5IHF1YXRlcm5pb247IHRoYXQgaXMsIHRvIHRoZQogICAqIHF1YXRlcm5pb24gdGhhdCByZXByZXNlbnRzICJubyByb3RhdGlvbiIuCiAgICoKICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgaWRlbnRpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCwgMSk7CiAgfQogIC8qKgogICAqIEludmVydHMgdGhpcyBxdWF0ZXJuaW9uIHZpYSB7QGxpbmsgUXVhdGVybmlvbiNjb25qdWdhdGV9LiBUaGUKICAgKiBxdWF0ZXJuaW9uIGlzIGFzc3VtZWQgdG8gaGF2ZSB1bml0IGxlbmd0aC4KICAgKgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBpbnZlcnQoKSB7CiAgICByZXR1cm4gdGhpcy5jb25qdWdhdGUoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgcm90YXRpb25hbCBjb25qdWdhdGUgb2YgdGhpcyBxdWF0ZXJuaW9uLiBUaGUgY29uanVnYXRlIG9mIGEKICAgKiBxdWF0ZXJuaW9uIHJlcHJlc2VudHMgdGhlIHNhbWUgcm90YXRpb24gaW4gdGhlIG9wcG9zaXRlIGRpcmVjdGlvbiBhYm91dAogICAqIHRoZSByb3RhdGlvbmFsIGF4aXMuCiAgICoKICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgY29uanVnYXRlKCkgewogICAgcmV0dXJuIHRoaXMuX3ggKj0gLTEsIHRoaXMuX3kgKj0gLTEsIHRoaXMuX3ogKj0gLTEsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgZG90IHByb2R1Y3Qgb2YgdGhpcyBxdWF0ZXJuaW9uIGFuZCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSB2IC0gVGhlIHF1YXRlcm5pb24gdG8gY29tcHV0ZSB0aGUgZG90IHByb2R1Y3Qgd2l0aC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSByZXN1bHQgb2YgdGhlIGRvdCBwcm9kdWN0LgogICAqLwogIGRvdCh0KSB7CiAgICByZXR1cm4gdGhpcy5feCAqIHQuX3ggKyB0aGlzLl95ICogdC5feSArIHRoaXMuX3ogKiB0Ll96ICsgdGhpcy5fdyAqIHQuX3c7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBzcXVhcmVkIEV1Y2xpZGVhbiBsZW5ndGggKHN0cmFpZ2h0LWxpbmUgbGVuZ3RoKSBvZiB0aGlzIHF1YXRlcm5pb24sCiAgICogY29uc2lkZXJlZCBhcyBhIDQgZGltZW5zaW9uYWwgdmVjdG9yLiBUaGlzIGNhbiBiZSB1c2VmdWwgaWYgeW91IGFyZSBjb21wYXJpbmcgdGhlCiAgICogbGVuZ3RocyBvZiB0d28gcXVhdGVybmlvbnMsIGFzIHRoaXMgaXMgYSBzbGlnaHRseSBtb3JlIGVmZmljaWVudCBjYWxjdWxhdGlvbiB0aGFuCiAgICoge0BsaW5rIFF1YXRlcm5pb24jbGVuZ3RofS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZWQgRXVjbGlkZWFuIGxlbmd0aC4KICAgKi8KICBsZW5ndGhTcSgpIHsKICAgIHJldHVybiB0aGlzLl94ICogdGhpcy5feCArIHRoaXMuX3kgKiB0aGlzLl95ICsgdGhpcy5feiAqIHRoaXMuX3ogKyB0aGlzLl93ICogdGhpcy5fdzsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIEV1Y2xpZGVhbiBsZW5ndGggKHN0cmFpZ2h0LWxpbmUgbGVuZ3RoKSBvZiB0aGlzIHF1YXRlcm5pb24sCiAgICogY29uc2lkZXJlZCBhcyBhIDQgZGltZW5zaW9uYWwgdmVjdG9yLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgRXVjbGlkZWFuIGxlbmd0aC4KICAgKi8KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX3ggKiB0aGlzLl94ICsgdGhpcy5feSAqIHRoaXMuX3kgKyB0aGlzLl96ICogdGhpcy5feiArIHRoaXMuX3cgKiB0aGlzLl93KTsKICB9CiAgLyoqCiAgICogTm9ybWFsaXplcyB0aGlzIHF1YXRlcm5pb24gLSB0aGF0IGlzLCBjYWxjdWxhdGVkIHRoZSBxdWF0ZXJuaW9uIHRoYXQgcGVyZm9ybXMKICAgKiB0aGUgc2FtZSByb3RhdGlvbiBhcyB0aGlzIG9uZSwgYnV0IGhhcyBhIGxlbmd0aCBlcXVhbCB0byBgMWAuCiAgICoKICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgbm9ybWFsaXplKCkgewogICAgbGV0IHQgPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHQgPT09IDAgPyAodGhpcy5feCA9IDAsIHRoaXMuX3kgPSAwLCB0aGlzLl96ID0gMCwgdGhpcy5fdyA9IDEpIDogKHQgPSAxIC8gdCwgdGhpcy5feCA9IHRoaXMuX3ggKiB0LCB0aGlzLl95ID0gdGhpcy5feSAqIHQsIHRoaXMuX3ogPSB0aGlzLl96ICogdCwgdGhpcy5fdyA9IHRoaXMuX3cgKiB0KSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoaXMgcXVhdGVybmlvbiBieSB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIHF1YXRlcm5pb24uCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIG11bHRpcGx5KHQpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5UXVhdGVybmlvbnModGhpcywgdCk7CiAgfQogIC8qKgogICAqIFByZS1tdWx0aXBsaWVzIHRoaXMgcXVhdGVybmlvbiBieSB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIHF1YXRlcm5pb24uCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHByZW11bHRpcGx5KHQpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5UXVhdGVybmlvbnModCwgdGhpcyk7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHF1YXRlcm5pb25zIGFuZCBzdG9yZXMgdGhlIHJlc3VsdCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBhIC0gVGhlIGZpcnN0IHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBiIC0gVGhlIHNlY29uZCBxdWF0ZXJuaW9uLgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBtdWx0aXBseVF1YXRlcm5pb25zKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0Ll94LCBuID0gdC5feSwgcyA9IHQuX3osIHIgPSB0Ll93LCBvID0gZS5feCwgbCA9IGUuX3ksIGggPSBlLl96LCBjID0gZS5fdzsKICAgIHJldHVybiB0aGlzLl94ID0gaSAqIGMgKyByICogbyArIG4gKiBoIC0gcyAqIGwsIHRoaXMuX3kgPSBuICogYyArIHIgKiBsICsgcyAqIG8gLSBpICogaCwgdGhpcy5feiA9IHMgKiBjICsgciAqIGggKyBpICogbCAtIG4gKiBvLCB0aGlzLl93ID0gciAqIGMgLSBpICogbyAtIG4gKiBsIC0gcyAqIGgsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogUGVyZm9ybXMgYSBzcGhlcmljYWwgbGluZWFyIGludGVycG9sYXRpb24gYmV0d2VlbiBxdWF0ZXJuaW9ucy4KICAgKgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcWIgLSBUaGUgdGFyZ2V0IHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgc2xlcnAodCwgZSkgewogICAgaWYgKGUgPT09IDApIHJldHVybiB0aGlzOwogICAgaWYgKGUgPT09IDEpIHJldHVybiB0aGlzLmNvcHkodCk7CiAgICBjb25zdCBpID0gdGhpcy5feCwgbiA9IHRoaXMuX3ksIHMgPSB0aGlzLl96LCByID0gdGhpcy5fdzsKICAgIGxldCBvID0gciAqIHQuX3cgKyBpICogdC5feCArIG4gKiB0Ll95ICsgcyAqIHQuX3o7CiAgICBpZiAobyA8IDAgPyAodGhpcy5fdyA9IC10Ll93LCB0aGlzLl94ID0gLXQuX3gsIHRoaXMuX3kgPSAtdC5feSwgdGhpcy5feiA9IC10Ll96LCBvID0gLW8pIDogdGhpcy5jb3B5KHQpLCBvID49IDEpCiAgICAgIHJldHVybiB0aGlzLl93ID0gciwgdGhpcy5feCA9IGksIHRoaXMuX3kgPSBuLCB0aGlzLl96ID0gcywgdGhpczsKICAgIGNvbnN0IGwgPSAxIC0gbyAqIG87CiAgICBpZiAobCA8PSBOdW1iZXIuRVBTSUxPTikgewogICAgICBjb25zdCBwID0gMSAtIGU7CiAgICAgIHJldHVybiB0aGlzLl93ID0gcCAqIHIgKyBlICogdGhpcy5fdywgdGhpcy5feCA9IHAgKiBpICsgZSAqIHRoaXMuX3gsIHRoaXMuX3kgPSBwICogbiArIGUgKiB0aGlzLl95LCB0aGlzLl96ID0gcCAqIHMgKyBlICogdGhpcy5feiwgdGhpcy5ub3JtYWxpemUoKSwgdGhpczsKICAgIH0KICAgIGNvbnN0IGggPSBNYXRoLnNxcnQobCksIGMgPSBNYXRoLmF0YW4yKGgsIG8pLCB1ID0gTWF0aC5zaW4oKDEgLSBlKSAqIGMpIC8gaCwgZCA9IE1hdGguc2luKGUgKiBjKSAvIGg7CiAgICByZXR1cm4gdGhpcy5fdyA9IHIgKiB1ICsgdGhpcy5fdyAqIGQsIHRoaXMuX3ggPSBpICogdSArIHRoaXMuX3ggKiBkLCB0aGlzLl95ID0gbiAqIHUgKyB0aGlzLl95ICogZCwgdGhpcy5feiA9IHMgKiB1ICsgdGhpcy5feiAqIGQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogUGVyZm9ybXMgYSBzcGhlcmljYWwgbGluZWFyIGludGVycG9sYXRpb24gYmV0d2VlbiB0aGUgZ2l2ZW4gcXVhdGVybmlvbnMKICAgKiBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBxdWF0ZXJuaW9uLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxYSAtIFRoZSBzb3VyY2UgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHFiIC0gVGhlIHRhcmdldCBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yIGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLCAxXWAuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHNsZXJwUXVhdGVybmlvbnModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMuY29weSh0KS5zbGVycChlLCBpKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHF1YXRlcm5pb24gdG8gYSB1bmlmb3JtbHkgcmFuZG9tLCBub3JtYWxpemVkIHF1YXRlcm5pb24uCiAgICoKICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgcmFuZG9tKCkgewogICAgY29uc3QgdCA9IDIgKiBNYXRoLlBJICogTWF0aC5yYW5kb20oKSwgZSA9IDIgKiBNYXRoLlBJICogTWF0aC5yYW5kb20oKSwgaSA9IE1hdGgucmFuZG9tKCksIG4gPSBNYXRoLnNxcnQoMSAtIGkpLCBzID0gTWF0aC5zcXJ0KGkpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBuICogTWF0aC5zaW4odCksCiAgICAgIG4gKiBNYXRoLmNvcyh0KSwKICAgICAgcyAqIE1hdGguc2luKGUpLAogICAgICBzICogTWF0aC5jb3MoZSkKICAgICk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgcXVhdGVybmlvbiBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHF1YXRlcm5pb24gLSBUaGUgcXVhdGVybmlvbiB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgcXVhdGVybmlvbiBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0Ll94ID09PSB0aGlzLl94ICYmIHQuX3kgPT09IHRoaXMuX3kgJiYgdC5feiA9PT0gdGhpcy5feiAmJiB0Ll93ID09PSB0aGlzLl93OwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgcXVhdGVybmlvbidzIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gYXJyYXkuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGFycmF5IC0gQW4gYXJyYXkgaG9sZGluZyB0aGUgcXVhdGVybmlvbiBjb21wb25lbnQgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHRbZV0sIHRoaXMuX3kgPSB0W2UgKyAxXSwgdGhpcy5feiA9IHRbZSArIDJdLCB0aGlzLl93ID0gdFtlICsgM10sIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogV3JpdGVzIHRoZSBjb21wb25lbnRzIG9mIHRoaXMgcXVhdGVybmlvbiB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgcXVhdGVybmlvbiBjb21wb25lbnRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSBxdWF0ZXJuaW9uIGNvbXBvbmVudHMuCiAgICovCiAgdG9BcnJheSh0ID0gW10sIGUgPSAwKSB7CiAgICByZXR1cm4gdFtlXSA9IHRoaXMuX3gsIHRbZSArIDFdID0gdGhpcy5feSwgdFtlICsgMl0gPSB0aGlzLl96LCB0W2UgKyAzXSA9IHRoaXMuX3csIHQ7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGNvbXBvbmVudHMgb2YgdGhpcyBxdWF0ZXJuaW9uIGZyb20gdGhlIGdpdmVuIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckF0dHJpYnV0ZX0gYXR0cmlidXRlIC0gVGhlIGJ1ZmZlciBhdHRyaWJ1dGUgaG9sZGluZyBxdWF0ZXJuaW9uIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHQuZ2V0WChlKSwgdGhpcy5feSA9IHQuZ2V0WShlKSwgdGhpcy5feiA9IHQuZ2V0WihlKSwgdGhpcy5fdyA9IHQuZ2V0VyhlKSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBUaGlzIG1ldGhvZHMgZGVmaW5lcyB0aGUgc2VyaWFsaXphdGlvbiByZXN1bHQgb2YgdGhpcyBjbGFzcy4gUmV0dXJucyB0aGUKICAgKiBudW1lcmljYWwgZWxlbWVudHMgb2YgdGhpcyBxdWF0ZXJuaW9uIGluIGFuIGFycmF5IG9mIGZvcm1hdCBgW3gsIHksIHosIHddYC4KICAgKgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSBzZXJpYWxpemVkIHF1YXRlcm5pb24uCiAgICovCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHRoaXMudG9BcnJheSgpOwogIH0KICBfb25DaGFuZ2UodCkgewogICAgcmV0dXJuIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2sgPSB0LCB0aGlzOwogIH0KICBfb25DaGFuZ2VDYWxsYmFjaygpIHsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy5feCwgeWllbGQgdGhpcy5feSwgeWllbGQgdGhpcy5feiwgeWllbGQgdGhpcy5fdzsKICB9Cn0sIEUgPSBjbGFzcyBteSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzRCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgeCB2YWx1ZSBvZiB0aGlzIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gW3k9MF0gLSBUaGUgeSB2YWx1ZSBvZiB0aGlzIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gW3o9MF0gLSBUaGUgeiB2YWx1ZSBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMCwgZSA9IDAsIGkgPSAwKSB7CiAgICBteS5wcm90b3R5cGUuaXNWZWN0b3IzID0gITAsIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXMueiA9IGk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgb2YgdGhlIHggY29tcG9uZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIG9mIHRoZSB5IGNvbXBvbmVudC4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB2YWx1ZSBvZiB0aGUgeiBjb21wb25lbnQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0KHQsIGUsIGkpIHsKICAgIHJldHVybiBpID09PSB2b2lkIDAgJiYgKGkgPSB0aGlzLnopLCB0aGlzLnggPSB0LCB0aGlzLnkgPSBlLCB0aGlzLnogPSBpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyB0byB0aGUgc2FtZSB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgdmFsdWUgdG8gc2V0IGZvciBhbGwgdmVjdG9yIGNvbXBvbmVudHMuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzLnkgPSB0LCB0aGlzLnogPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB4IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRYKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB5IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRZKHQpIHsKICAgIHJldHVybiB0aGlzLnkgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB6IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRaKHQpIHsKICAgIHJldHVybiB0aGlzLnogPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBbGxvd3MgdG8gc2V0IGEgdmVjdG9yIGNvbXBvbmVudCB3aXRoIGFuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGNvbXBvbmVudCBpbmRleC4gYDBgIGVxdWFscyB0byB4LCBgMWAgZXF1YWxzIHRvIHksIGAyYCBlcXVhbHMgdG8gei4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldENvbXBvbmVudCh0LCBlKSB7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMueCA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSBlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy56ID0gZTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImluZGV4IGlzIG91dCBvZiByYW5nZTogIiArIHQpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSB2ZWN0b3IgY29tcG9uZW50IHdoaWNoIG1hdGNoZXMgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGNvbXBvbmVudCBpbmRleC4gYDBgIGVxdWFscyB0byB4LCBgMWAgZXF1YWxzIHRvIHksIGAyYCBlcXVhbHMgdG8gei4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgdmVjdG9yIGNvbXBvbmVudCB2YWx1ZS4KICAgKi8KICBnZXRDb21wb25lbnQodCkgewogICAgc3dpdGNoICh0KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgICBjYXNlIDE6CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgICAgY2FzZSAyOgogICAgICAgIHJldHVybiB0aGlzLno7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyB0KTsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyB2ZWN0b3Igd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLngsIHRoaXMueSwgdGhpcy56KTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb3B5LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCwgdGhpcy55ID0gdC55LCB0aGlzLnogPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBhZGQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54LCB0aGlzLnkgKz0gdC55LCB0aGlzLnogKz0gdC56LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiBzY2FsYXIgdmFsdWUgdG8gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBhZGQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkU2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdCwgdGhpcy55ICs9IHQsIHRoaXMueiArPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3JzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBhIC0gVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGIgLSBUaGUgc2Vjb25kIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhZGRWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKyBlLngsIHRoaXMueSA9IHQueSArIGUueSwgdGhpcy56ID0gdC56ICsgZS56LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3Igc2NhbGVkIGJ5IHRoZSBnaXZlbiBmYWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM3xWZWN0b3I0fSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBmYWN0b3IgdGhhdCBzY2FsZXMgYHZgLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZFNjYWxlZFZlY3Rvcih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQueCAqIGUsIHRoaXMueSArPSB0LnkgKiBlLCB0aGlzLnogKz0gdC56ICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogU3VidHJhY3RzIHRoZSBnaXZlbiB2ZWN0b3IgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LngsIHRoaXMueSAtPSB0LnksIHRoaXMueiAtPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIGZyb20gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWJTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LCB0aGlzLnkgLT0gdCwgdGhpcy56IC09IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gdmVjdG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBiIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc3ViVmVjdG9ycyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54IC0gZS54LCB0aGlzLnkgPSB0LnkgLSBlLnksIHRoaXMueiA9IHQueiAtIGUueiwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gbXVsdGlwbHkuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LngsIHRoaXMueSAqPSB0LnksIHRoaXMueiAqPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSB3aXRoIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGFyIC0gVGhlIHNjYWxhciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICo9IHQsIHRoaXMueSAqPSB0LCB0aGlzLnogKj0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gdmVjdG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBiIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHlWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKiBlLngsIHRoaXMueSA9IHQueSAqIGUueSwgdGhpcy56ID0gdC56ICogZS56LCB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiBFdWxlciByb3RhdGlvbiB0byB0aGlzIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGFuZ2xlcy4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhcHBseUV1bGVyKHQpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihJZi5zZXRGcm9tRXVsZXIodCkpOwogIH0KICAvKioKICAgKiBBcHBsaWVzIGEgcm90YXRpb24gc3BlY2lmaWVkIGJ5IGFuIGF4aXMgYW5kIGFuIGFuZ2xlIHRvIHRoaXMgdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBheGlzIC0gQSBub3JtYWxpemVkIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIHJvdGF0aW9uIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlBeGlzQW5nbGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlRdWF0ZXJuaW9uKElmLnNldEZyb21BeGlzQW5nbGUodCwgZSkpOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoaXMgdmVjdG9yIHdpdGggdGhlIGdpdmVuIDN4MyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgM3gzIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhcHBseU1hdHJpeDModCkgewogICAgY29uc3QgZSA9IHRoaXMueCwgaSA9IHRoaXMueSwgbiA9IHRoaXMueiwgcyA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy54ID0gc1swXSAqIGUgKyBzWzNdICogaSArIHNbNl0gKiBuLCB0aGlzLnkgPSBzWzFdICogZSArIHNbNF0gKiBpICsgc1s3XSAqIG4sIHRoaXMueiA9IHNbMl0gKiBlICsgc1s1XSAqIGkgKyBzWzhdICogbiwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGlzIHZlY3RvciBieSB0aGUgZ2l2ZW4gbm9ybWFsIG1hdHJpeCBhbmQgbm9ybWFsaXplcwogICAqIHRoZSByZXN1bHQuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbm9ybWFsIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhcHBseU5vcm1hbE1hdHJpeCh0KSB7CiAgICByZXR1cm4gdGhpcy5hcHBseU1hdHJpeDModCkubm9ybWFsaXplKCk7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhpcyB2ZWN0b3IgKHdpdGggYW4gaW1wbGljaXQgMSBpbiB0aGUgNHRoIGRpbWVuc2lvbikgYnkgbSwgYW5kCiAgICogZGl2aWRlcyBieSBwZXJzcGVjdGl2ZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSBtYXRyaXggdG8gYXBwbHkuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0aGlzLnosIHMgPSB0LmVsZW1lbnRzLCByID0gMSAvIChzWzNdICogZSArIHNbN10gKiBpICsgc1sxMV0gKiBuICsgc1sxNV0pOwogICAgcmV0dXJuIHRoaXMueCA9IChzWzBdICogZSArIHNbNF0gKiBpICsgc1s4XSAqIG4gKyBzWzEyXSkgKiByLCB0aGlzLnkgPSAoc1sxXSAqIGUgKyBzWzVdICogaSArIHNbOV0gKiBuICsgc1sxM10pICogciwgdGhpcy56ID0gKHNbMl0gKiBlICsgc1s2XSAqIGkgKyBzWzEwXSAqIG4gKyBzWzE0XSkgKiByLCB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiBRdWF0ZXJuaW9uIHRvIHRoaXMgdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIFF1YXRlcm5pb24uCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlRdWF0ZXJuaW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0aGlzLnosIHMgPSB0LngsIHIgPSB0LnksIG8gPSB0LnosIGwgPSB0LncsIGggPSAyICogKHIgKiBuIC0gbyAqIGkpLCBjID0gMiAqIChvICogZSAtIHMgKiBuKSwgdSA9IDIgKiAocyAqIGkgLSByICogZSk7CiAgICByZXR1cm4gdGhpcy54ID0gZSArIGwgKiBoICsgciAqIHUgLSBvICogYywgdGhpcy55ID0gaSArIGwgKiBjICsgbyAqIGggLSBzICogdSwgdGhpcy56ID0gbiArIGwgKiB1ICsgcyAqIGMgLSByICogaCwgdGhpczsKICB9CiAgLyoqCiAgICogUHJvamVjdHMgdGhpcyB2ZWN0b3IgZnJvbSB3b3JsZCBzcGFjZSBpbnRvIHRoZSBjYW1lcmEncyBub3JtYWxpemVkCiAgICogZGV2aWNlIGNvb3JkaW5hdGUgKE5EQykgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBwcm9qZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkSW52ZXJzZSkuYXBwbHlNYXRyaXg0KHQucHJvamVjdGlvbk1hdHJpeCk7CiAgfQogIC8qKgogICAqIFVucHJvamVjdHMgdGhpcyB2ZWN0b3IgZnJvbSB0aGUgY2FtZXJhJ3Mgbm9ybWFsaXplZCBkZXZpY2UgY29vcmRpbmF0ZSAoTkRDKQogICAqIHNwYWNlIGludG8gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICB1bnByb2plY3QodCkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlNYXRyaXg0KHQucHJvamVjdGlvbk1hdHJpeEludmVyc2UpLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkKTsKICB9CiAgLyoqCiAgICogVHJhbnNmb3JtcyB0aGUgZGlyZWN0aW9uIG9mIHRoaXMgdmVjdG9yIGJ5IGEgbWF0cml4ICh0aGUgdXBwZXIgbGVmdCAzIHggMwogICAqIHN1YnNldCBvZiB0aGUgZ2l2ZW4gNHg0IG1hdHJpeCBhbmQgdGhlbiBub3JtYWxpemVzIHRoZSByZXN1bHQuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHRyYW5zZm9ybURpcmVjdGlvbih0KSB7CiAgICBjb25zdCBlID0gdGhpcy54LCBpID0gdGhpcy55LCBuID0gdGhpcy56LCBzID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnggPSBzWzBdICogZSArIHNbNF0gKiBpICsgc1s4XSAqIG4sIHRoaXMueSA9IHNbMV0gKiBlICsgc1s1XSAqIGkgKyBzWzldICogbiwgdGhpcy56ID0gc1syXSAqIGUgKyBzWzZdICogaSArIHNbMTBdICogbiwgdGhpcy5ub3JtYWxpemUoKTsKICB9CiAgLyoqCiAgICogRGl2aWRlcyB0aGlzIGluc3RhbmNlIGJ5IHRoZSBnaXZlbiB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGUodCkgewogICAgcmV0dXJuIHRoaXMueCAvPSB0LngsIHRoaXMueSAvPSB0LnksIHRoaXMueiAvPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIERpdmlkZXMgdGhpcyB2ZWN0b3IgYnkgdGhlIGdpdmVuIHNjYWxhci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgc2NhbGFyIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGVTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoMSAvIHQpOwogIH0KICAvKioKICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHkgb3IgeiB2YWx1ZSBpcyBncmVhdGVyIHRoYW4gdGhlIGdpdmVuIHZlY3RvcidzIHgsIHkgb3IgegogICAqIHZhbHVlLCByZXBsYWNlIHRoYXQgdmFsdWUgd2l0aCB0aGUgY29ycmVzcG9uZGluZyBtaW4gdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIG1pbih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5taW4odGhpcy54LCB0LngpLCB0aGlzLnkgPSBNYXRoLm1pbih0aGlzLnksIHQueSksIHRoaXMueiA9IE1hdGgubWluKHRoaXMueiwgdC56KSwgdGhpczsKICB9CiAgLyoqCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4LCB5IG9yIHogdmFsdWUgaXMgbGVzcyB0aGFuIHRoZSBnaXZlbiB2ZWN0b3IncyB4LCB5IG9yIHoKICAgKiB2YWx1ZSwgcmVwbGFjZSB0aGF0IHZhbHVlIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgbWF4IHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtYXgodCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWF4KHRoaXMueCwgdC54KSwgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB0LnkpLCB0aGlzLnogPSBNYXRoLm1heCh0aGlzLnosIHQueiksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSBvciB6IHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZlY3RvcidzIHgsIHkgb3IgegogICAqIHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieSB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHkgb3IgeiB2YWx1ZSBpcyBsZXNzIHRoYW4gdGhlIG1pbiB2ZWN0b3IncyB4LCB5IG9yIHogdmFsdWUsCiAgICogaXQgaXMgcmVwbGFjZWQgYnkgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IG1pbiAtIFRoZSBtaW5pbXVtIHgsIHkgYW5kIHogdmFsdWVzLgogICAqIEBwYXJhbSB7VmVjdG9yM30gbWF4IC0gVGhlIG1heGltdW0geCwgeSBhbmQgeiB2YWx1ZXMgaW4gdGhlIGRlc2lyZWQgcmFuZ2UuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IGt0KHRoaXMueCwgdC54LCBlLngpLCB0aGlzLnkgPSBrdCh0aGlzLnksIHQueSwgZS55KSwgdGhpcy56ID0ga3QodGhpcy56LCB0LnosIGUueiksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSBvciB6IHZhbHVlcyBhcmUgZ3JlYXRlciB0aGFuIHRoZSBtYXggdmFsdWUsIHRoZXkgYXJlCiAgICogcmVwbGFjZWQgYnkgdGhlIG1heCB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHkgb3IgeiB2YWx1ZXMgYXJlIGxlc3MgdGhhbiB0aGUgbWluIHZhbHVlLCB0aGV5IGFyZQogICAqIHJlcGxhY2VkIGJ5IHRoZSBtaW4gdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbWluVmFsIC0gVGhlIG1pbmltdW0gdmFsdWUgdGhlIGNvbXBvbmVudHMgd2lsbCBiZSBjbGFtcGVkIHRvLgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhWYWwgLSBUaGUgbWF4aW11bSB2YWx1ZSB0aGUgY29tcG9uZW50cyB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXBTY2FsYXIodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IGt0KHRoaXMueCwgdCwgZSksIHRoaXMueSA9IGt0KHRoaXMueSwgdCwgZSksIHRoaXMueiA9IGt0KHRoaXMueiwgdCwgZSksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgbGVuZ3RoIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieQogICAqIHRoZSBtYXggdmFsdWUuCiAgICogSWYgdGhpcyB2ZWN0b3IncyBsZW5ndGggaXMgbGVzcyB0aGFuIHRoZSBtaW4gdmFsdWUsIGl0IGlzIHJlcGxhY2VkIGJ5IHRoZQogICAqIG1pbiB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0aGUgdmVjdG9yIGxlbmd0aCB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRoZSB2ZWN0b3IgbGVuZ3RoIHdpbGwgYmUgY2xhbXBlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBjbGFtcExlbmd0aCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcihpIHx8IDEpLm11bHRpcGx5U2NhbGFyKGt0KGksIHQsIGUpKTsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgZG93biB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgZmxvb3IoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpLCB0aGlzLnkgPSBNYXRoLmZsb29yKHRoaXMueSksIHRoaXMueiA9IE1hdGguZmxvb3IodGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdXAgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNlaWwoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCksIHRoaXMueSA9IE1hdGguY2VpbCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLmNlaWwodGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZQogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yb3VuZCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnJvdW5kKHRoaXMueSksIHRoaXMueiA9IE1hdGgucm91bmQodGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG93YXJkcyB6ZXJvICh1cCBpZiBuZWdhdGl2ZSwKICAgKiBkb3duIGlmIHBvc2l0aXZlKSB0byBhbiBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmRUb1plcm8oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC50cnVuYyh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnRydW5jKHRoaXMueSksIHRoaXMueiA9IE1hdGgudHJ1bmModGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogSW52ZXJ0cyB0aGlzIHZlY3RvciAtIGkuZS4gc2V0cyB4ID0gLXgsIHkgPSAteSBhbmQgeiA9IC16LgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbmVnYXRlKCkgewogICAgcmV0dXJuIHRoaXMueCA9IC10aGlzLngsIHRoaXMueSA9IC10aGlzLnksIHRoaXMueiA9IC10aGlzLnosIHRoaXM7CiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIGRvdCBwcm9kdWN0IG9mIHRoZSBnaXZlbiB2ZWN0b3Igd2l0aCB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBkb3QgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgZG90IHByb2R1Y3QuCiAgICovCiAgZG90KHQpIHsKICAgIHJldHVybiB0aGlzLnggKiB0LnggKyB0aGlzLnkgKiB0LnkgKyB0aGlzLnogKiB0Lno7CiAgfQogIC8vIFRPRE8gbGVuZ3RoU3F1YXJlZD8KICAvKioKICAgKiBDb21wdXRlcyB0aGUgc3F1YXJlIG9mIHRoZSBFdWNsaWRlYW4gbGVuZ3RoIChzdHJhaWdodC1saW5lIGxlbmd0aCkgZnJvbQogICAqICgwLCAwLCAwKSB0byAoeCwgeSwgeikuIElmIHlvdSBhcmUgY29tcGFyaW5nIHRoZSBsZW5ndGhzIG9mIHZlY3RvcnMsIHlvdSBzaG91bGQKICAgKiBjb21wYXJlIHRoZSBsZW5ndGggc3F1YXJlZCBpbnN0ZWFkIGFzIGl0IGlzIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IHRvIGNhbGN1bGF0ZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgIEV1Y2xpZGVhbiBsZW5ndGggKHN0cmFpZ2h0LWxpbmUgbGVuZ3RoKSBmcm9tICgwLCAwLCAwKSB0byAoeCwgeSwgeikuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnopOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgTWFuaGF0dGFuIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopOwogIH0KICAvKioKICAgKiBDb252ZXJ0cyB0aGlzIHZlY3RvciB0byBhIHVuaXQgdmVjdG9yIC0gdGhhdCBpcywgc2V0cyBpdCBlcXVhbCB0byBhIHZlY3RvcgogICAqIHdpdGggdGhlIHNhbWUgZGlyZWN0aW9uIGFzIHRoaXMgb25lLCBidXQgd2l0aCBhIHZlY3RvciBsZW5ndGggb2YgYDFgLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbm9ybWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKHRoaXMubGVuZ3RoKCkgfHwgMSk7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyB2ZWN0b3IgdG8gYSB2ZWN0b3Igd2l0aCB0aGUgc2FtZSBkaXJlY3Rpb24gYXMgdGhpcyBvbmUsIGJ1dAogICAqIHdpdGggdGhlIHNwZWNpZmllZCBsZW5ndGguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIC0gVGhlIG5ldyBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0TGVuZ3RoKHQpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHQpOwogIH0KICAvKioKICAgKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgYmV0d2VlbiB0aGUgZ2l2ZW4gdmVjdG9yIGFuZCB0aGlzIGluc3RhbmNlLCB3aGVyZQogICAqIGFscGhhIGlzIHRoZSBwZXJjZW50IGRpc3RhbmNlIGFsb25nIHRoZSBsaW5lIC0gYWxwaGEgPSAwIHdpbGwgYmUgdGhpcwogICAqIHZlY3RvciwgYW5kIGFscGhhID0gMSB3aWxsIGJlIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIGludGVycG9sYXRlIHRvd2FyZHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yLCB0eXBpY2FsbHkgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBsZXJwKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gKHQueCAtIHRoaXMueCkgKiBlLCB0aGlzLnkgKz0gKHQueSAtIHRoaXMueSkgKiBlLCB0aGlzLnogKz0gKHQueiAtIHRoaXMueikgKiBlLCB0aGlzOwogIH0KICAvKioKICAgKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgYmV0d2VlbiB0aGUgZ2l2ZW4gdmVjdG9ycywgd2hlcmUgYWxwaGEgaXMgdGhlIHBlcmNlbnQKICAgKiBkaXN0YW5jZSBhbG9uZyB0aGUgbGluZSAtIGFscGhhID0gMCB3aWxsIGJlIGZpcnN0IHZlY3RvciwgYW5kIGFscGhhID0gMSB3aWxsCiAgICogYmUgdGhlIHNlY29uZCBvbmUuIFRoZSByZXN1bHQgaXMgc3RvcmVkIGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYxIC0gVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYyIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yLCB0eXBpY2FsbHkgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBsZXJwVmVjdG9ycyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54ICsgKGUueCAtIHQueCkgKiBpLCB0aGlzLnkgPSB0LnkgKyAoZS55IC0gdC55KSAqIGksIHRoaXMueiA9IHQueiArIChlLnogLSB0LnopICogaSwgdGhpczsKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgY3Jvc3MgcHJvZHVjdCBvZiB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgY3Jvc3MgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSByZXN1bHQgb2YgdGhlIGNyb3NzIHByb2R1Y3QuCiAgICovCiAgY3Jvc3ModCkgewogICAgcmV0dXJuIHRoaXMuY3Jvc3NWZWN0b3JzKHRoaXMsIHQpOwogIH0KICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBjcm9zcyBwcm9kdWN0IG9mIHRoZSBnaXZlbiB2ZWN0b3JzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdAogICAqIGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGEgLSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNyb3NzVmVjdG9ycyh0LCBlKSB7CiAgICBjb25zdCBpID0gdC54LCBuID0gdC55LCBzID0gdC56LCByID0gZS54LCBvID0gZS55LCBsID0gZS56OwogICAgcmV0dXJuIHRoaXMueCA9IG4gKiBsIC0gcyAqIG8sIHRoaXMueSA9IHMgKiByIC0gaSAqIGwsIHRoaXMueiA9IGkgKiBvIC0gbiAqIHIsIHRoaXM7CiAgfQogIC8qKgogICAqIFByb2plY3RzIHRoaXMgdmVjdG9yIG9udG8gdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gcHJvamVjdCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBwcm9qZWN0T25WZWN0b3IodCkgewogICAgY29uc3QgZSA9IHQubGVuZ3RoU3EoKTsKICAgIGlmIChlID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCk7CiAgICBjb25zdCBpID0gdC5kb3QodGhpcykgLyBlOwogICAgcmV0dXJuIHRoaXMuY29weSh0KS5tdWx0aXBseVNjYWxhcihpKTsKICB9CiAgLyoqCiAgICogUHJvamVjdHMgdGhpcyB2ZWN0b3Igb250byBhIHBsYW5lIGJ5IHN1YnRyYWN0aW5nIHRoaXMKICAgKiB2ZWN0b3IgcHJvamVjdGVkIG9udG8gdGhlIHBsYW5lJ3Mgbm9ybWFsIGZyb20gdGhpcyB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBsYW5lTm9ybWFsIC0gVGhlIHBsYW5lIG5vcm1hbC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBwcm9qZWN0T25QbGFuZSh0KSB7CiAgICByZXR1cm4geXUuY29weSh0aGlzKS5wcm9qZWN0T25WZWN0b3IodCksIHRoaXMuc3ViKHl1KTsKICB9CiAgLyoqCiAgICogUmVmbGVjdHMgdGhpcyB2ZWN0b3Igb2ZmIGEgcGxhbmUgb3J0aG9nb25hbCB0byB0aGUgZ2l2ZW4gbm9ybWFsIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gbm9ybWFsIC0gVGhlIChub3JtYWxpemVkKSBub3JtYWwgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJlZmxlY3QodCkgewogICAgcmV0dXJuIHRoaXMuc3ViKHl1LmNvcHkodCkubXVsdGlwbHlTY2FsYXIoMiAqIHRoaXMuZG90KHQpKSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGFuZ2xlIGJldHdlZW4gdGhlIGdpdmVuIHZlY3RvciBhbmQgdGhpcyBpbnN0YW5jZSBpbiByYWRpYW5zLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBhbmdsZSB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICovCiAgYW5nbGVUbyh0KSB7CiAgICBjb25zdCBlID0gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3EoKSAqIHQubGVuZ3RoU3EoKSk7CiAgICBpZiAoZSA9PT0gMCkgcmV0dXJuIE1hdGguUEkgLyAyOwogICAgY29uc3QgaSA9IHRoaXMuZG90KHQpIC8gZTsKICAgIHJldHVybiBNYXRoLmFjb3Moa3QoaSwgLTEsIDEpKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGRpc3RhbmNlIGZyb20gdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBkaXN0YW5jZSB0by4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZVRvKHQpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5kaXN0YW5jZVRvU3F1YXJlZCh0KSk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBzcXVhcmVkIGRpc3RhbmNlIGZyb20gdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqIElmIHlvdSBhcmUganVzdCBjb21wYXJpbmcgdGhlIGRpc3RhbmNlIHdpdGggYW5vdGhlciBkaXN0YW5jZSwgeW91IHNob3VsZCBjb21wYXJlCiAgICogdGhlIGRpc3RhbmNlIHNxdWFyZWQgaW5zdGVhZCBhcyBpdCBpcyBzbGlnaHRseSBtb3JlIGVmZmljaWVudCB0byBjYWxjdWxhdGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIGNvbXB1dGUgdGhlIHNxdWFyZWQgZGlzdGFuY2UgdG8uCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgc3F1YXJlZCBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZVRvU3F1YXJlZCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy54IC0gdC54LCBpID0gdGhpcy55IC0gdC55LCBuID0gdGhpcy56IC0gdC56OwogICAgcmV0dXJuIGUgKiBlICsgaSAqIGkgKyBuICogbjsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIE1hbmhhdHRhbiBkaXN0YW5jZSBmcm9tIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgTWFuaGF0dGFuIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIE1hbmhhdHRhbiBkaXN0YW5jZS4KICAgKi8KICBtYW5oYXR0YW5EaXN0YW5jZVRvKHQpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLnggLSB0LngpICsgTWF0aC5hYnModGhpcy55IC0gdC55KSArIE1hdGguYWJzKHRoaXMueiAtIHQueik7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIHNwaGVyaWNhbCBjb29yZGluYXRlcy4KICAgKgogICAqIEBwYXJhbSB7U3BoZXJpY2FsfSBzIC0gVGhlIHNwaGVyaWNhbCBjb29yZGluYXRlcy4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tU3BoZXJpY2FsKHQpIHsKICAgIHJldHVybiB0aGlzLnNldEZyb21TcGhlcmljYWxDb29yZHModC5yYWRpdXMsIHQucGhpLCB0LnRoZXRhKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gc3BoZXJpY2FsIGNvb3JkaW5hdGVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHBoaSAtIFRoZSBwaGkgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0gdGhldGEgLSBUaGUgdGhldGEgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tU3BoZXJpY2FsQ29vcmRzKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBNYXRoLnNpbihlKSAqIHQ7CiAgICByZXR1cm4gdGhpcy54ID0gbiAqIE1hdGguc2luKGkpLCB0aGlzLnkgPSBNYXRoLmNvcyhlKSAqIHQsIHRoaXMueiA9IG4gKiBNYXRoLmNvcyhpKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gY3lsaW5kcmljYWwgY29vcmRpbmF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge0N5bGluZHJpY2FsfSBjIC0gVGhlIGN5bGluZHJpY2FsIGNvb3JkaW5hdGVzLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldEZyb21DeWxpbmRyaWNhbCh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tQ3lsaW5kcmljYWxDb29yZHModC5yYWRpdXMsIHQudGhldGEsIHQueSk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIGN5bGluZHJpY2FsIGNvb3JkaW5hdGVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHRoZXRhIC0gVGhlIHRoZXRhIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSB2YWx1ZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tQ3lsaW5kcmljYWxDb29yZHModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQgKiBNYXRoLnNpbihlKSwgdGhpcy55ID0gaSwgdGhpcy56ID0gdCAqIE1hdGguY29zKGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyB0byB0aGUgcG9zaXRpb24gZWxlbWVudHMgb2YgdGhlCiAgICogZ2l2ZW4gdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIDR4NCBtYXRyaXguCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMueCA9IGVbMTJdLCB0aGlzLnkgPSBlWzEzXSwgdGhpcy56ID0gZVsxNF0sIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIHRvIHRoZSBzY2FsZSBlbGVtZW50cyBvZiB0aGUKICAgKiBnaXZlbiB0cmFuc2Zvcm1hdGlvbiBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tTWF0cml4U2NhbGUodCkgewogICAgY29uc3QgZSA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAwKS5sZW5ndGgoKSwgaSA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAxKS5sZW5ndGgoKSwgbiA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAyKS5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLnggPSBlLCB0aGlzLnkgPSBpLCB0aGlzLnogPSBuLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyBmcm9tIHRoZSBzcGVjaWZpZWQgbWF0cml4IGNvbHVtbi4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSA0eDQgbWF0cml4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBjb2x1bW4gaW5kZXguCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0RnJvbU1hdHJpeENvbHVtbih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkodC5lbGVtZW50cywgZSAqIDQpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyBmcm9tIHRoZSBzcGVjaWZpZWQgbWF0cml4IGNvbHVtbi4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSAzeDMgbWF0cml4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBjb2x1bW4gaW5kZXguCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0RnJvbU1hdHJpeDNDb2x1bW4odCwgZSkgewogICAgcmV0dXJuIHRoaXMuZnJvbUFycmF5KHQuZWxlbWVudHMsIGUgKiAzKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gRXVsZXIgYW5nbGVzLgogICAqCiAgICogQHBhcmFtIHtFdWxlcn0gZSAtIFRoZSBFdWxlciBhbmdsZXMgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldEZyb21FdWxlcih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC5feCwgdGhpcy55ID0gdC5feSwgdGhpcy56ID0gdC5feiwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgUkdCIGNvbXBvbmVudHMgb2YgdGhlCiAgICogZ2l2ZW4gY29sb3IuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjIC0gVGhlIGNvbG9yIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tQ29sb3IodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQuciwgdGhpcy55ID0gdC5nLCB0aGlzLnogPSB0LmIsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgdmVjdG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIHZlY3RvciBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0LnggPT09IHRoaXMueCAmJiB0LnkgPT09IHRoaXMueSAmJiB0LnogPT09IHRoaXMuejsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHZlY3RvcidzIHggdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgXWAsIHkgdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgKyAxIF1gCiAgICogYW5kIHogdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgKyAyIF1gLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIEFuIGFycmF5IGhvbGRpbmcgdGhlIHZlY3RvciBjb21wb25lbnQgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnggPSB0W2VdLCB0aGlzLnkgPSB0W2UgKyAxXSwgdGhpcy56ID0gdFtlICsgMl0sIHRoaXM7CiAgfQogIC8qKgogICAqIFdyaXRlcyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgdmVjdG9yIGNvbXBvbmVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBJbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gVGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgcmV0dXJuIHRbZV0gPSB0aGlzLngsIHRbZSArIDFdID0gdGhpcy55LCB0W2UgKyAyXSA9IHRoaXMueiwgdDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciBmcm9tIHRoZSBnaXZlbiBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJBdHRyaWJ1dGV9IGF0dHJpYnV0ZSAtIFRoZSBidWZmZXIgYXR0cmlidXRlIGhvbGRpbmcgdmVjdG9yIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmcm9tQnVmZmVyQXR0cmlidXRlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LmdldFgoZSksIHRoaXMueSA9IHQuZ2V0WShlKSwgdGhpcy56ID0gdC5nZXRaKGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIGVhY2ggY29tcG9uZW50IG9mIHRoaXMgdmVjdG9yIHRvIGEgcHNldWRvLXJhbmRvbSB2YWx1ZSBiZXR3ZWVuIGAwYCBhbmQKICAgKiBgMWAsIGV4Y2x1ZGluZyBgMWAuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICByYW5kb20oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yYW5kb20oKSwgdGhpcy55ID0gTWF0aC5yYW5kb20oKSwgdGhpcy56ID0gTWF0aC5yYW5kb20oKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHZlY3RvciB0byBhIHVuaWZvcm1seSByYW5kb20gcG9pbnQgb24gYSB1bml0IHNwaGVyZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJhbmRvbURpcmVjdGlvbigpIHsKICAgIGNvbnN0IHQgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDIsIGUgPSBNYXRoLnJhbmRvbSgpICogMiAtIDEsIGkgPSBNYXRoLnNxcnQoMSAtIGUgKiBlKTsKICAgIHJldHVybiB0aGlzLnggPSBpICogTWF0aC5jb3ModCksIHRoaXMueSA9IGUsIHRoaXMueiA9IGkgKiBNYXRoLnNpbih0KSwgdGhpczsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy54LCB5aWVsZCB0aGlzLnksIHlpZWxkIHRoaXMuejsKICB9Cn07CmNvbnN0IHl1ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIElmID0gLyogQF9fUFVSRV9fICovIG5ldyB2ZSgpOwpsZXQgWHQgPSBjbGFzcyBneSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzeDMgbWF0cml4LiBUaGUgYXJndW1lbnRzIGFyZSBzdXBwb3NlZCB0byBiZQogICAqIGluIHJvdy1tYWpvciBvcmRlci4gSWYgbm8gYXJndW1lbnRzIGFyZSBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdG9yCiAgICogaW5pdGlhbGl6ZXMgdGhlIG1hdHJpeCBhcyBhbiBpZGVudGl0eSBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW24xMV0gLSAxLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTJdIC0gMS0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjEzXSAtIDEtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yMV0gLSAyLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjJdIC0gMi0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIzXSAtIDItMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMV0gLSAzLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzJdIC0gMy0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMzXSAtIDMtMyBtYXRyaXggZWxlbWVudC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKSB7CiAgICBneS5wcm90b3R5cGUuaXNNYXRyaXgzID0gITAsIHRoaXMuZWxlbWVudHMgPSBbCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgIF0sIHQgIT09IHZvaWQgMCAmJiB0aGlzLnNldCh0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZWxlbWVudHMgb2YgdGhlIG1hdHJpeC5UaGUgYXJndW1lbnRzIGFyZSBzdXBwb3NlZCB0byBiZQogICAqIGluIHJvdy1tYWpvciBvcmRlci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjExXSAtIDEtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xMl0gLSAxLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTNdIC0gMS0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIxXSAtIDItMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yMl0gLSAyLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjNdIC0gMi0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMxXSAtIDMtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMl0gLSAzLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzNdIC0gMy0zIG1hdHJpeCBlbGVtZW50LgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHNldCh0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKSB7CiAgICBjb25zdCBjID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiBjWzBdID0gdCwgY1sxXSA9IG4sIGNbMl0gPSBvLCBjWzNdID0gZSwgY1s0XSA9IHMsIGNbNV0gPSBsLCBjWzZdID0gaSwgY1s3XSA9IHIsIGNbOF0gPSBoLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IHRvIHRoZSAzeDMgaWRlbnRpdHkgbWF0cml4LgogICAqCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgaWRlbnRpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBtYXRyaXggdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gY29weS4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBjb3B5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50czsKICAgIHJldHVybiBlWzBdID0gaVswXSwgZVsxXSA9IGlbMV0sIGVbMl0gPSBpWzJdLCBlWzNdID0gaVszXSwgZVs0XSA9IGlbNF0sIGVbNV0gPSBpWzVdLCBlWzZdID0gaVs2XSwgZVs3XSA9IGlbN10sIGVbOF0gPSBpWzhdLCB0aGlzOwogIH0KICAvKioKICAgKiBFeHRyYWN0cyB0aGUgYmFzaXMgb2YgdGhpcyBtYXRyaXggaW50byB0aGUgdGhyZWUgYXhpcyB2ZWN0b3JzIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB4QXhpcyAtIFRoZSBiYXNpcydzIHggYXhpcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHlBeGlzIC0gVGhlIGJhc2lzJ3MgeSBheGlzLgogICAqIEBwYXJhbSB7VmVjdG9yM30gekF4aXMgLSBUaGUgYmFzaXMncyB6IGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgZXh0cmFjdEJhc2lzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0LnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDApLCBlLnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDEpLCBpLnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDIpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXQgdGhpcyBtYXRyaXggdG8gdGhlIHVwcGVyIDN4MyBtYXRyaXggb2YgdGhlIGdpdmVuIDR4NCBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzZXRGcm9tTWF0cml4NCh0KSB7CiAgICBjb25zdCBlID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgZVswXSwKICAgICAgZVs0XSwKICAgICAgZVs4XSwKICAgICAgZVsxXSwKICAgICAgZVs1XSwKICAgICAgZVs5XSwKICAgICAgZVsyXSwKICAgICAgZVs2XSwKICAgICAgZVsxMF0KICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFBvc3QtbXVsdGlwbGllcyB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gM3gzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gbXVsdGlwbHkgd2l0aC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHRoaXMsIHQpOwogIH0KICAvKioKICAgKiBQcmUtbXVsdGlwbGllcyB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gM3gzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gbXVsdGlwbHkgd2l0aC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBwcmVtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHQsIHRoaXMpOwogIH0KICAvKioKICAgKiBNdWx0aXBsZXMgdGhlIGdpdmVuIDN4MyBtYXRyaWNlcyBhbmQgc3RvcmVzIHRoZSByZXN1bHQKICAgKiBpbiB0aGlzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gYSAtIFRoZSBmaXJzdCBtYXRyaXguCiAgICogQHBhcmFtIHtNYXRyaXgzfSBiIC0gVGhlIHNlY29uZCBtYXRyaXguCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbXVsdGlwbHlNYXRyaWNlcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdC5lbGVtZW50cywgbiA9IGUuZWxlbWVudHMsIHMgPSB0aGlzLmVsZW1lbnRzLCByID0gaVswXSwgbyA9IGlbM10sIGwgPSBpWzZdLCBoID0gaVsxXSwgYyA9IGlbNF0sIHUgPSBpWzddLCBkID0gaVsyXSwgcCA9IGlbNV0sIGYgPSBpWzhdLCB5ID0gblswXSwgZyA9IG5bM10sIG0gPSBuWzZdLCB2ID0gblsxXSwgeCA9IG5bNF0sIF8gPSBuWzddLCBTID0gblsyXSwgdyA9IG5bNV0sIFQgPSBuWzhdOwogICAgcmV0dXJuIHNbMF0gPSByICogeSArIG8gKiB2ICsgbCAqIFMsIHNbM10gPSByICogZyArIG8gKiB4ICsgbCAqIHcsIHNbNl0gPSByICogbSArIG8gKiBfICsgbCAqIFQsIHNbMV0gPSBoICogeSArIGMgKiB2ICsgdSAqIFMsIHNbNF0gPSBoICogZyArIGMgKiB4ICsgdSAqIHcsIHNbN10gPSBoICogbSArIGMgKiBfICsgdSAqIFQsIHNbMl0gPSBkICogeSArIHAgKiB2ICsgZiAqIFMsIHNbNV0gPSBkICogZyArIHAgKiB4ICsgZiAqIHcsIHNbOF0gPSBkICogbSArIHAgKiBfICsgZiAqIFQsIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgZXZlcnkgY29tcG9uZW50IG9mIHRoZSBtYXRyaXggYnkgdGhlIGdpdmVuIHNjYWxhci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhci4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiBlWzBdICo9IHQsIGVbM10gKj0gdCwgZVs2XSAqPSB0LCBlWzFdICo9IHQsIGVbNF0gKj0gdCwgZVs3XSAqPSB0LCBlWzJdICo9IHQsIGVbNV0gKj0gdCwgZVs4XSAqPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBhbmQgcmV0dXJucyB0aGUgZGV0ZXJtaW5hbnQgb2YgdGhpcyBtYXRyaXguCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZXRlcm1pbmFudC4KICAgKi8KICBkZXRlcm1pbmFudCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmVsZW1lbnRzLCBlID0gdFswXSwgaSA9IHRbMV0sIG4gPSB0WzJdLCBzID0gdFszXSwgciA9IHRbNF0sIG8gPSB0WzVdLCBsID0gdFs2XSwgaCA9IHRbN10sIGMgPSB0WzhdOwogICAgcmV0dXJuIGUgKiByICogYyAtIGUgKiBvICogaCAtIGkgKiBzICogYyArIGkgKiBvICogbCArIG4gKiBzICogaCAtIG4gKiByICogbDsKICB9CiAgLyoqCiAgICogSW52ZXJ0cyB0aGlzIG1hdHJpeCwgdXNpbmcgdGhlIFthbmFseXRpYyBtZXRob2Rde0BsaW5rIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0ludmVydGlibGVfbWF0cml4I0FuYWx5dGljX3NvbHV0aW9ufS4KICAgKiBZb3UgY2FuIG5vdCBpbnZlcnQgd2l0aCBhIGRldGVybWluYW50IG9mIHplcm8uIElmIHlvdSBhdHRlbXB0IHRoaXMsIHRoZSBtZXRob2QgcHJvZHVjZXMKICAgKiBhIHplcm8gbWF0cml4IGluc3RlYWQuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBpbnZlcnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0sIGkgPSB0WzFdLCBuID0gdFsyXSwgcyA9IHRbM10sIHIgPSB0WzRdLCBvID0gdFs1XSwgbCA9IHRbNl0sIGggPSB0WzddLCBjID0gdFs4XSwgdSA9IGMgKiByIC0gbyAqIGgsIGQgPSBvICogbCAtIGMgKiBzLCBwID0gaCAqIHMgLSByICogbCwgZiA9IGUgKiB1ICsgaSAqIGQgKyBuICogcDsKICAgIGlmIChmID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCk7CiAgICBjb25zdCB5ID0gMSAvIGY7CiAgICByZXR1cm4gdFswXSA9IHUgKiB5LCB0WzFdID0gKG4gKiBoIC0gYyAqIGkpICogeSwgdFsyXSA9IChvICogaSAtIG4gKiByKSAqIHksIHRbM10gPSBkICogeSwgdFs0XSA9IChjICogZSAtIG4gKiBsKSAqIHksIHRbNV0gPSAobiAqIHMgLSBvICogZSkgKiB5LCB0WzZdID0gcCAqIHksIHRbN10gPSAoaSAqIGwgLSBoICogZSkgKiB5LCB0WzhdID0gKHIgKiBlIC0gaSAqIHMpICogeSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNwb3NlcyB0aGlzIG1hdHJpeCBpbiBwbGFjZS4KICAgKgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHRyYW5zcG9zZSgpIHsKICAgIGxldCB0OwogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdCA9IGVbMV0sIGVbMV0gPSBlWzNdLCBlWzNdID0gdCwgdCA9IGVbMl0sIGVbMl0gPSBlWzZdLCBlWzZdID0gdCwgdCA9IGVbNV0sIGVbNV0gPSBlWzddLCBlWzddID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIG5vcm1hbCBtYXRyaXggd2hpY2ggaXMgdGhlIGludmVyc2UgdHJhbnNwb3NlIG9mIHRoZSB1cHBlcgogICAqIGxlZnQgM3gzIHBvcnRpb24gb2YgdGhlIGdpdmVuIDR4NCBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG1hdHJpeDQgLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBnZXROb3JtYWxNYXRyaXgodCkgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbU1hdHJpeDQodCkuaW52ZXJ0KCkudHJhbnNwb3NlKCk7CiAgfQogIC8qKgogICAqIFRyYW5zcG9zZXMgdGhpcyBtYXRyaXggaW50byB0aGUgc3VwcGxpZWQgYXJyYXksIGFuZCByZXR1cm5zIGl0c2VsZiB1bmNoYW5nZWQuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHIgLSBBbiBhcnJheSB0byBzdG9yZSB0aGUgdHJhbnNwb3NlZCBtYXRyaXggZWxlbWVudHMuCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgdHJhbnNwb3NlSW50b0FycmF5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIHRbMF0gPSBlWzBdLCB0WzFdID0gZVszXSwgdFsyXSA9IGVbNl0sIHRbM10gPSBlWzFdLCB0WzRdID0gZVs0XSwgdFs1XSA9IGVbN10sIHRbNl0gPSBlWzJdLCB0WzddID0gZVs1XSwgdFs4XSA9IGVbOF0sIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIFVWIHRyYW5zZm9ybSBtYXRyaXggZnJvbSBvZmZzZXQsIHJlcGVhdCwgcm90YXRpb24sIGFuZCBjZW50ZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdHggLSBPZmZzZXQgeC4KICAgKiBAcGFyYW0ge251bWJlcn0gdHkgLSBPZmZzZXQgeS4KICAgKiBAcGFyYW0ge251bWJlcn0gc3ggLSBSZXBlYXQgeC4KICAgKiBAcGFyYW0ge251bWJlcn0gc3kgLSBSZXBlYXQgeS4KICAgKiBAcGFyYW0ge251bWJlcn0gcm90YXRpb24gLSBSb3RhdGlvbiwgaW4gcmFkaWFucy4gUG9zaXRpdmUgdmFsdWVzIHJvdGF0ZSBjb3VudGVyY2xvY2t3aXNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjeCAtIENlbnRlciB4IG9mIHJvdGF0aW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjeSAtIENlbnRlciB5IG9mIHJvdGF0aW9uCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgc2V0VXZUcmFuc2Zvcm0odCwgZSwgaSwgbiwgcywgciwgbykgewogICAgY29uc3QgbCA9IE1hdGguY29zKHMpLCBoID0gTWF0aC5zaW4ocyk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGkgKiBsLAogICAgICBpICogaCwKICAgICAgLWkgKiAobCAqIHIgKyBoICogbykgKyByICsgdCwKICAgICAgLW4gKiBoLAogICAgICBuICogbCwKICAgICAgLW4gKiAoLWggKiByICsgbCAqIG8pICsgbyArIGUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFNjYWxlcyB0aGlzIG1hdHJpeCB3aXRoIHRoZSBnaXZlbiBzY2FsYXIgdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHN4IC0gVGhlIGFtb3VudCB0byBzY2FsZSBpbiB0aGUgWCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzeSAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzY2FsZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5wcmVtdWx0aXBseShfdS5tYWtlU2NhbGUodCwgZSkpLCB0aGlzOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoaXMgbWF0cml4IGJ5IHRoZSBnaXZlbiBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHJvdGF0ZSh0KSB7CiAgICByZXR1cm4gdGhpcy5wcmVtdWx0aXBseShfdS5tYWtlUm90YXRpb24oLXQpKSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlcyB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0eCAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBYIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHR5IC0gVGhlIGFtb3VudCB0byB0cmFuc2xhdGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICB0cmFuc2xhdGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMucHJlbXVsdGlwbHkoX3UubWFrZVRyYW5zbGF0aW9uKHQsIGUpKSwgdGhpczsKICB9CiAgLy8gZm9yIDJEIFRyYW5zZm9ybXMKICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgMkQgdHJhbnNsYXRpb24gdHJhbnNmb3JtLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ8VmVjdG9yMn0geCAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBYIGF4aXMgb3IgYWx0ZXJuYXRpdmVseSBhIHRyYW5zbGF0aW9uIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBZIGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZVRyYW5zbGF0aW9uKHQsIGUpIHsKICAgIHJldHVybiB0LmlzVmVjdG9yMiA/IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICB0LngsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIHQueSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSA6IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICB0LAogICAgICAwLAogICAgICAxLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgMkQgcm90YXRpb25hbCB0cmFuc2Zvcm1hdGlvbi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VSb3RhdGlvbih0KSB7CiAgICBjb25zdCBlID0gTWF0aC5jb3ModCksIGkgPSBNYXRoLnNpbih0KTsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgZSwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIGksCiAgICAgIGUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBtYXRyaXggYXMgYSAyRCBzY2FsZSB0cmFuc2Zvcm0uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFggYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlU2NhbGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICB0LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIG1hdHJpeCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG1hdHJpeCAtIFRoZSBtYXRyaXggdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIG1hdHJpeCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50czsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgOTsgbisrKQogICAgICBpZiAoZVtuXSAhPT0gaVtuXSkgcmV0dXJuICExOwogICAgcmV0dXJuICEwOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBlbGVtZW50cyBvZiB0aGUgbWF0cml4IGZyb20gdGhlIGdpdmVuIGFycmF5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGZyb21BcnJheSh0LCBlID0gMCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA5OyBpKyspCiAgICAgIHRoaXMuZWxlbWVudHNbaV0gPSB0W2kgKyBlXTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBXcml0ZXMgdGhlIGVsZW1lbnRzIG9mIHRoaXMgbWF0cml4IHRvIHRoZSBnaXZlbiBhcnJheS4gSWYgbm8gYXJyYXkgaXMgcHJvdmlkZWQsCiAgICogdGhlIG1ldGhvZCByZXR1cm5zIGEgbmV3IGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBbYXJyYXk9W11dIC0gVGhlIHRhcmdldCBhcnJheSBob2xkaW5nIHRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgY29uc3QgaSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdFtlXSA9IGlbMF0sIHRbZSArIDFdID0gaVsxXSwgdFtlICsgMl0gPSBpWzJdLCB0W2UgKyAzXSA9IGlbM10sIHRbZSArIDRdID0gaVs0XSwgdFtlICsgNV0gPSBpWzVdLCB0W2UgKyA2XSA9IGlbNl0sIHRbZSArIDddID0gaVs3XSwgdFtlICsgOF0gPSBpWzhdLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbWF0cml4IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5mcm9tQXJyYXkodGhpcy5lbGVtZW50cyk7CiAgfQp9Owpjb25zdCBfdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKTsKZnVuY3Rpb24geXkoYSkgewogIGZvciAobGV0IHQgPSBhLmxlbmd0aCAtIDE7IHQgPj0gMDsgLS10KQogICAgaWYgKGFbdF0gPj0gNjU1MzUpIHJldHVybiAhMDsKICByZXR1cm4gITE7Cn0KY29uc3QgZHYgPSB7CiAgSW50OEFycmF5LAogIFVpbnQ4QXJyYXksCiAgVWludDhDbGFtcGVkQXJyYXksCiAgSW50MTZBcnJheSwKICBVaW50MTZBcnJheSwKICBJbnQzMkFycmF5LAogIFVpbnQzMkFycmF5LAogIEZsb2F0MzJBcnJheSwKICBGbG9hdDY0QXJyYXkKfTsKZnVuY3Rpb24gcmEoYSwgdCkgewogIHJldHVybiBuZXcgZHZbYV0odCk7Cn0KZnVuY3Rpb24gUm8oYSkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiLCBhKTsKfQpmdW5jdGlvbiBfeSgpIHsKICBjb25zdCBhID0gUm8oImNhbnZhcyIpOwogIHJldHVybiBhLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siLCBhOwp9CmNvbnN0IExmID0ge307CmZ1bmN0aW9uIFBvKGEpIHsKICBhIGluIExmIHx8IChMZlthXSA9ICEwLCBjb25zb2xlLndhcm4oYSkpOwp9CmZ1bmN0aW9uIHB2KGEsIHQsIGUpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24oaSwgbikgewogICAgZnVuY3Rpb24gcygpIHsKICAgICAgc3dpdGNoIChhLmNsaWVudFdhaXRTeW5jKHQsIGEuU1lOQ19GTFVTSF9DT01NQU5EU19CSVQsIDApKSB7CiAgICAgICAgY2FzZSBhLldBSVRfRkFJTEVEOgogICAgICAgICAgbigpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBhLlRJTUVPVVRfRVhQSVJFRDoKICAgICAgICAgIHNldFRpbWVvdXQocywgZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaSgpOwogICAgICB9CiAgICB9CiAgICBzZXRUaW1lb3V0KHMsIGUpOwogIH0pOwp9CmNvbnN0IERmID0gLyogQF9fUFVSRV9fICovIG5ldyBYdCgpLnNldCgKICAwLjQxMjM5MDgsCiAgMC4zNTc1ODQzLAogIDAuMTgwNDgwOCwKICAwLjIxMjYzOSwKICAwLjcxNTE2ODcsCiAgMC4wNzIxOTIzLAogIDAuMDE5MzMwOCwKICAwLjExOTE5NDgsCiAgMC45NTA1MzIyCiksIEZmID0gLyogQF9fUFVSRV9fICovIG5ldyBYdCgpLnNldCgKICAzLjI0MDk2OTksCiAgLTEuNTM3MzgzMiwKICAtMC40OTg2MTA4LAogIC0wLjk2OTI0MzYsCiAgMS44NzU5Njc1LAogIDAuMDQxNTU1MSwKICAwLjA1NTYzMDEsCiAgLTAuMjAzOTc3LAogIDEuMDU2OTcxNQopOwpmdW5jdGlvbiBmdigpIHsKICBjb25zdCBhID0gewogICAgZW5hYmxlZDogITAsCiAgICB3b3JraW5nQ29sb3JTcGFjZTogQ3MsCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9ucyBvZiBzdXBwb3J0ZWQgY29sb3Igc3BhY2VzLgogICAgICoKICAgICAqIFJlcXVpcmVkOgogICAgICoJLSBwcmltYXJpZXM6IGNocm9tYXRpY2l0eSBjb29yZGluYXRlcyBbIHJ4IHJ5IGd4IGd5IGJ4IGJ5IF0KICAgICAqCS0gd2hpdGVQb2ludDogcmVmZXJlbmNlIHdoaXRlIFsgeCB5IF0KICAgICAqCS0gdHJhbnNmZXI6IHRyYW5zZmVyIGZ1bmN0aW9uIChwcmUtZGVmaW5lZCkKICAgICAqCS0gdG9YWVo6IE1hdHJpeDMgUkdCIHRvIFhZWiB0cmFuc2Zvcm0KICAgICAqCS0gZnJvbVhZWjogTWF0cml4MyBYWVogdG8gUkdCIHRyYW5zZm9ybQogICAgICoJLSBsdW1pbmFuY2VDb2VmZmljaWVudHM6IFJHQiBsdW1pbmFuY2UgY29lZmZpY2llbnRzCiAgICAgKgogICAgICogT3B0aW9uYWw6CiAgICAgKiAgLSBvdXRwdXRDb2xvclNwYWNlQ29uZmlnOiB7IGRyYXdpbmdCdWZmZXJDb2xvclNwYWNlOiBDb2xvclNwYWNlLCB0b25lTWFwcGluZ01vZGU6ICdleHRlbmRlZCcgfCAnc3RhbmRhcmQnIH0KICAgICAqICAtIHdvcmtpbmdDb2xvclNwYWNlQ29uZmlnOiB7IHVucGFja0NvbG9yU3BhY2U6IENvbG9yU3BhY2UgfQogICAgICoKICAgICAqIFJlZmVyZW5jZToKICAgICAqIC0gaHR0cHM6Ly93d3cucnVzc2VsbGNvdHRyZWxsLmNvbS9waG90by9tYXRyaXhDYWxjdWxhdG9yLmh0bQogICAgICovCiAgICBzcGFjZXM6IHt9LAogICAgY29udmVydDogZnVuY3Rpb24obiwgcywgcikgewogICAgICByZXR1cm4gdGhpcy5lbmFibGVkID09PSAhMSB8fCBzID09PSByIHx8ICFzIHx8ICFyIHx8ICh0aGlzLnNwYWNlc1tzXS50cmFuc2ZlciA9PT0gY2UgJiYgKG4uciA9IGpuKG4uciksIG4uZyA9IGpuKG4uZyksIG4uYiA9IGpuKG4uYikpLCB0aGlzLnNwYWNlc1tzXS5wcmltYXJpZXMgIT09IHRoaXMuc3BhY2VzW3JdLnByaW1hcmllcyAmJiAobi5hcHBseU1hdHJpeDModGhpcy5zcGFjZXNbc10udG9YWVopLCBuLmFwcGx5TWF0cml4Myh0aGlzLnNwYWNlc1tyXS5mcm9tWFlaKSksIHRoaXMuc3BhY2VzW3JdLnRyYW5zZmVyID09PSBjZSAmJiAobi5yID0gb2Eobi5yKSwgbi5nID0gb2Eobi5nKSwgbi5iID0gb2Eobi5iKSkpLCBuOwogICAgfSwKICAgIHdvcmtpbmdUb0NvbG9yU3BhY2U6IGZ1bmN0aW9uKG4sIHMpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmVydChuLCB0aGlzLndvcmtpbmdDb2xvclNwYWNlLCBzKTsKICAgIH0sCiAgICBjb2xvclNwYWNlVG9Xb3JraW5nOiBmdW5jdGlvbihuLCBzKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZlcnQobiwgcywgdGhpcy53b3JraW5nQ29sb3JTcGFjZSk7CiAgICB9LAogICAgZ2V0UHJpbWFyaWVzOiBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiB0aGlzLnNwYWNlc1tuXS5wcmltYXJpZXM7CiAgICB9LAogICAgZ2V0VHJhbnNmZXI6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT09ICRuID8gRW8gOiB0aGlzLnNwYWNlc1tuXS50cmFuc2ZlcjsKICAgIH0sCiAgICBnZXRUb25lTWFwcGluZ01vZGU6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIHRoaXMuc3BhY2VzW25dLm91dHB1dENvbG9yU3BhY2VDb25maWcudG9uZU1hcHBpbmdNb2RlIHx8ICJzdGFuZGFyZCI7CiAgICB9LAogICAgZ2V0THVtaW5hbmNlQ29lZmZpY2llbnRzOiBmdW5jdGlvbihuLCBzID0gdGhpcy53b3JraW5nQ29sb3JTcGFjZSkgewogICAgICByZXR1cm4gbi5mcm9tQXJyYXkodGhpcy5zcGFjZXNbc10ubHVtaW5hbmNlQ29lZmZpY2llbnRzKTsKICAgIH0sCiAgICBkZWZpbmU6IGZ1bmN0aW9uKG4pIHsKICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnNwYWNlcywgbik7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgQVBJcwogICAgX2dldE1hdHJpeDogZnVuY3Rpb24obiwgcywgcikgewogICAgICByZXR1cm4gbi5jb3B5KHRoaXMuc3BhY2VzW3NdLnRvWFlaKS5tdWx0aXBseSh0aGlzLnNwYWNlc1tyXS5mcm9tWFlaKTsKICAgIH0sCiAgICBfZ2V0RHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIHRoaXMuc3BhY2VzW25dLm91dHB1dENvbG9yU3BhY2VDb25maWcuZHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U7CiAgICB9LAogICAgX2dldFVucGFja0NvbG9yU3BhY2U6IGZ1bmN0aW9uKG4gPSB0aGlzLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICAgIHJldHVybiB0aGlzLnNwYWNlc1tuXS53b3JraW5nQ29sb3JTcGFjZUNvbmZpZy51bnBhY2tDb2xvclNwYWNlOwogICAgfSwKICAgIC8vIERlcHJlY2F0ZWQKICAgIGZyb21Xb3JraW5nQ29sb3JTcGFjZTogZnVuY3Rpb24obiwgcykgewogICAgICByZXR1cm4gUG8oIlRIUkVFLkNvbG9yTWFuYWdlbWVudDogLmZyb21Xb3JraW5nQ29sb3JTcGFjZSgpIGhhcyBiZWVuIHJlbmFtZWQgdG8gLndvcmtpbmdUb0NvbG9yU3BhY2UoKS4iKSwgYS53b3JraW5nVG9Db2xvclNwYWNlKG4sIHMpOwogICAgfSwKICAgIHRvV29ya2luZ0NvbG9yU3BhY2U6IGZ1bmN0aW9uKG4sIHMpIHsKICAgICAgcmV0dXJuIFBvKCJUSFJFRS5Db2xvck1hbmFnZW1lbnQ6IC50b1dvcmtpbmdDb2xvclNwYWNlKCkgaGFzIGJlZW4gcmVuYW1lZCB0byAuY29sb3JTcGFjZVRvV29ya2luZygpLiIpLCBhLmNvbG9yU3BhY2VUb1dvcmtpbmcobiwgcyk7CiAgICB9CiAgfSwgdCA9IFswLjY0LCAwLjMzLCAwLjMsIDAuNiwgMC4xNSwgMC4wNl0sIGUgPSBbMC4yMTI2LCAwLjcxNTIsIDAuMDcyMl0sIGkgPSBbMC4zMTI3LCAwLjMyOV07CiAgcmV0dXJuIGEuZGVmaW5lKHsKICAgIFtDc106IHsKICAgICAgcHJpbWFyaWVzOiB0LAogICAgICB3aGl0ZVBvaW50OiBpLAogICAgICB0cmFuc2ZlcjogRW8sCiAgICAgIHRvWFlaOiBEZiwKICAgICAgZnJvbVhZWjogRmYsCiAgICAgIGx1bWluYW5jZUNvZWZmaWNpZW50czogZSwKICAgICAgd29ya2luZ0NvbG9yU3BhY2VDb25maWc6IHsgdW5wYWNrQ29sb3JTcGFjZTogcmkgfSwKICAgICAgb3V0cHV0Q29sb3JTcGFjZUNvbmZpZzogeyBkcmF3aW5nQnVmZmVyQ29sb3JTcGFjZTogcmkgfQogICAgfSwKICAgIFtyaV06IHsKICAgICAgcHJpbWFyaWVzOiB0LAogICAgICB3aGl0ZVBvaW50OiBpLAogICAgICB0cmFuc2ZlcjogY2UsCiAgICAgIHRvWFlaOiBEZiwKICAgICAgZnJvbVhZWjogRmYsCiAgICAgIGx1bWluYW5jZUNvZWZmaWNpZW50czogZSwKICAgICAgb3V0cHV0Q29sb3JTcGFjZUNvbmZpZzogeyBkcmF3aW5nQnVmZmVyQ29sb3JTcGFjZTogcmkgfQogICAgfQogIH0pLCBhOwp9CmNvbnN0IGVlID0gLyogQF9fUFVSRV9fICovIGZ2KCk7CmZ1bmN0aW9uIGpuKGEpIHsKICByZXR1cm4gYSA8IDAuMDQwNDUgPyBhICogMC4wNzczOTkzODA4IDogTWF0aC5wb3coYSAqIDAuOTQ3ODY3Mjk4NiArIDAuMDUyMTMyNzAxNCwgMi40KTsKfQpmdW5jdGlvbiBvYShhKSB7CiAgcmV0dXJuIGEgPCAzMTMwOGUtNyA/IGEgKiAxMi45MiA6IDEuMDU1ICogTWF0aC5wb3coYSwgMC40MTY2NikgLSAwLjA1NTsKfQpsZXQgdnIsIHh5ID0gY2xhc3MgewogIC8qKgogICAqIFJldHVybnMgYSBkYXRhIFVSSSBjb250YWluaW5nIGEgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIGltYWdlLgogICAqCiAgICogQHBhcmFtIHsoSFRNTEltYWdlRWxlbWVudHxIVE1MQ2FudmFzRWxlbWVudCl9IGltYWdlIC0gVGhlIGltYWdlIG9iamVjdC4KICAgKiBAcGFyYW0ge3N0cmluZ30gW3R5cGU9J2ltYWdlL3BuZyddIC0gSW5kaWNhdGVzIHRoZSBpbWFnZSBmb3JtYXQuCiAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgZGF0YSBVUkkuCiAgICovCiAgc3RhdGljIGdldERhdGFVUkwodCwgZSA9ICJpbWFnZS9wbmciKSB7CiAgICBpZiAoL15kYXRhOi9pLnRlc3QodC5zcmMpIHx8IHR5cGVvZiBIVE1MQ2FudmFzRWxlbWVudCA+ICJ1IikKICAgICAgcmV0dXJuIHQuc3JjOwogICAgbGV0IGk7CiAgICBpZiAodCBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50KQogICAgICBpID0gdDsKICAgIGVsc2UgewogICAgICB2ciA9PT0gdm9pZCAwICYmICh2ciA9IFJvKCJjYW52YXMiKSksIHZyLndpZHRoID0gdC53aWR0aCwgdnIuaGVpZ2h0ID0gdC5oZWlnaHQ7CiAgICAgIGNvbnN0IG4gPSB2ci5nZXRDb250ZXh0KCIyZCIpOwogICAgICB0IGluc3RhbmNlb2YgSW1hZ2VEYXRhID8gbi5wdXRJbWFnZURhdGEodCwgMCwgMCkgOiBuLmRyYXdJbWFnZSh0LCAwLCAwLCB0LndpZHRoLCB0LmhlaWdodCksIGkgPSB2cjsKICAgIH0KICAgIHJldHVybiBpLnRvRGF0YVVSTChlKTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIHNSR0IgaW1hZ2UgZGF0YSB0byBsaW5lYXIgY29sb3Igc3BhY2UuCiAgICoKICAgKiBAcGFyYW0geyhIVE1MSW1hZ2VFbGVtZW50fEhUTUxDYW52YXNFbGVtZW50fEltYWdlQml0bWFwfE9iamVjdCl9IGltYWdlIC0gVGhlIGltYWdlIG9iamVjdC4KICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudHxPYmplY3R9IFRoZSBjb252ZXJ0ZWQgaW1hZ2UuCiAgICovCiAgc3RhdGljIHNSR0JUb0xpbmVhcih0KSB7CiAgICBpZiAodHlwZW9mIEhUTUxJbWFnZUVsZW1lbnQgPCAidSIgJiYgdCBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQgfHwgdHlwZW9mIEhUTUxDYW52YXNFbGVtZW50IDwgInUiICYmIHQgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCB8fCB0eXBlb2YgSW1hZ2VCaXRtYXAgPCAidSIgJiYgdCBpbnN0YW5jZW9mIEltYWdlQml0bWFwKSB7CiAgICAgIGNvbnN0IGUgPSBSbygiY2FudmFzIik7CiAgICAgIGUud2lkdGggPSB0LndpZHRoLCBlLmhlaWdodCA9IHQuaGVpZ2h0OwogICAgICBjb25zdCBpID0gZS5nZXRDb250ZXh0KCIyZCIpOwogICAgICBpLmRyYXdJbWFnZSh0LCAwLCAwLCB0LndpZHRoLCB0LmhlaWdodCk7CiAgICAgIGNvbnN0IG4gPSBpLmdldEltYWdlRGF0YSgwLCAwLCB0LndpZHRoLCB0LmhlaWdodCksIHMgPSBuLmRhdGE7CiAgICAgIGZvciAobGV0IHIgPSAwOyByIDwgcy5sZW5ndGg7IHIrKykKICAgICAgICBzW3JdID0gam4oc1tyXSAvIDI1NSkgKiAyNTU7CiAgICAgIHJldHVybiBpLnB1dEltYWdlRGF0YShuLCAwLCAwKSwgZTsKICAgIH0gZWxzZSBpZiAodC5kYXRhKSB7CiAgICAgIGNvbnN0IGUgPSB0LmRhdGEuc2xpY2UoMCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZS5sZW5ndGg7IGkrKykKICAgICAgICBlIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCBlIGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXkgPyBlW2ldID0gTWF0aC5mbG9vcihqbihlW2ldIC8gMjU1KSAqIDI1NSkgOiBlW2ldID0gam4oZVtpXSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogZSwKICAgICAgICB3aWR0aDogdC53aWR0aCwKICAgICAgICBoZWlnaHQ6IHQuaGVpZ2h0CiAgICAgIH07CiAgICB9IGVsc2UKICAgICAgcmV0dXJuIGNvbnNvbGUud2FybigiVEhSRUUuSW1hZ2VVdGlscy5zUkdCVG9MaW5lYXIoKTogVW5zdXBwb3J0ZWQgaW1hZ2UgdHlwZS4gTm8gY29sb3Igc3BhY2UgY29udmVyc2lvbiBhcHBsaWVkLiIpLCB0OwogIH0KfSwgbXYgPSAwLCBNcyA9IGNsYXNzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHZpZGVvIHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0ge2FueX0gW2RhdGE9bnVsbF0gLSBUaGUgZGF0YSBkZWZpbml0aW9uIG9mIGEgdGV4dHVyZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbnVsbCkgewogICAgdGhpcy5pc1NvdXJjZSA9ICEwLCBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgImlkIiwgeyB2YWx1ZTogbXYrKyB9KSwgdGhpcy51dWlkID0gT2koKSwgdGhpcy5kYXRhID0gdCwgdGhpcy5kYXRhUmVhZHkgPSAhMCwgdGhpcy52ZXJzaW9uID0gMDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZGltZW5zaW9ucyBvZiB0aGUgc291cmNlIGludG8gdGhlIGdpdmVuIHRhcmdldCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0geyhWZWN0b3IyfFZlY3RvcjMpfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IG9iamVjdCB0aGUgcmVzdWx0IGlzIHdyaXR0ZW4gaW50by4KICAgKiBAcmV0dXJuIHsoVmVjdG9yMnxWZWN0b3IzKX0gVGhlIGRpbWVuc2lvbnMgb2YgdGhlIHNvdXJjZS4KICAgKi8KICBnZXRTaXplKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmRhdGE7CiAgICByZXR1cm4gdHlwZW9mIEhUTUxWaWRlb0VsZW1lbnQgPCAidSIgJiYgZSBpbnN0YW5jZW9mIEhUTUxWaWRlb0VsZW1lbnQgPyB0LnNldChlLnZpZGVvV2lkdGgsIGUudmlkZW9IZWlnaHQsIDApIDogZSBpbnN0YW5jZW9mIFZpZGVvRnJhbWUgPyB0LnNldChlLmRpc3BsYXlIZWlnaHQsIGUuZGlzcGxheVdpZHRoLCAwKSA6IGUgIT09IG51bGwgPyB0LnNldChlLndpZHRoLCBlLmhlaWdodCwgZS5kZXB0aCB8fCAwKSA6IHQuc2V0KDAsIDAsIDApLCB0OwogIH0KICAvKioKICAgKiBXaGVuIHRoZSBwcm9wZXJ0eSBpcyBzZXQgdG8gYHRydWVgLCB0aGUgZW5naW5lIGFsbG9jYXRlcyB0aGUgbWVtb3J5CiAgICogZm9yIHRoZSB0ZXh0dXJlIChpZiBuZWNlc3NhcnkpIGFuZCB0cmlnZ2VycyB0aGUgYWN0dWFsIHRleHR1cmUgdXBsb2FkCiAgICogdG8gdGhlIEdQVSBuZXh0IHRpbWUgdGhlIHNvdXJjZSBpcyB1c2VkLgogICAqCiAgICogQHR5cGUge2Jvb2xlYW59CiAgICogQGRlZmF1bHQgZmFsc2UKICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAgICovCiAgc2V0IG5lZWRzVXBkYXRlKHQpIHsKICAgIHQgPT09ICEwICYmIHRoaXMudmVyc2lvbisrOwogIH0KICAvKioKICAgKiBTZXJpYWxpemVzIHRoZSBzb3VyY2UgaW50byBKU09OLgogICAqCiAgICogQHBhcmFtIHs/KE9iamVjdHxzdHJpbmcpfSBtZXRhIC0gQW4gb3B0aW9uYWwgdmFsdWUgaG9sZGluZyBtZXRhIGluZm9ybWF0aW9uIGFib3V0IHRoZSBzZXJpYWxpemF0aW9uLgogICAqIEByZXR1cm4ge09iamVjdH0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgc291cmNlLgogICAqIEBzZWUge0BsaW5rIE9iamVjdExvYWRlciNwYXJzZX0KICAgKi8KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHQgPT09IHZvaWQgMCB8fCB0eXBlb2YgdCA9PSAic3RyaW5nIjsKICAgIGlmICghZSAmJiB0LmltYWdlc1t0aGlzLnV1aWRdICE9PSB2b2lkIDApCiAgICAgIHJldHVybiB0LmltYWdlc1t0aGlzLnV1aWRdOwogICAgY29uc3QgaSA9IHsKICAgICAgdXVpZDogdGhpcy51dWlkLAogICAgICB1cmw6ICIiCiAgICB9LCBuID0gdGhpcy5kYXRhOwogICAgaWYgKG4gIT09IG51bGwpIHsKICAgICAgbGV0IHM7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KG4pKSB7CiAgICAgICAgcyA9IFtdOwogICAgICAgIGZvciAobGV0IHIgPSAwLCBvID0gbi5sZW5ndGg7IHIgPCBvOyByKyspCiAgICAgICAgICBuW3JdLmlzRGF0YVRleHR1cmUgPyBzLnB1c2goeHUobltyXS5pbWFnZSkpIDogcy5wdXNoKHh1KG5bcl0pKTsKICAgICAgfSBlbHNlCiAgICAgICAgcyA9IHh1KG4pOwogICAgICBpLnVybCA9IHM7CiAgICB9CiAgICByZXR1cm4gZSB8fCAodC5pbWFnZXNbdGhpcy51dWlkXSA9IGkpLCBpOwogIH0KfTsKZnVuY3Rpb24geHUoYSkgewogIHJldHVybiB0eXBlb2YgSFRNTEltYWdlRWxlbWVudCA8ICJ1IiAmJiBhIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCB8fCB0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgPCAidSIgJiYgYSBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50IHx8IHR5cGVvZiBJbWFnZUJpdG1hcCA8ICJ1IiAmJiBhIGluc3RhbmNlb2YgSW1hZ2VCaXRtYXAgPyB4eS5nZXREYXRhVVJMKGEpIDogYS5kYXRhID8gewogICAgZGF0YTogQXJyYXkuZnJvbShhLmRhdGEpLAogICAgd2lkdGg6IGEud2lkdGgsCiAgICBoZWlnaHQ6IGEuaGVpZ2h0LAogICAgdHlwZTogYS5kYXRhLmNvbnN0cnVjdG9yLm5hbWUKICB9IDogKGNvbnNvbGUud2FybigiVEhSRUUuVGV4dHVyZTogVW5hYmxlIHRvIHNlcmlhbGl6ZSBUZXh0dXJlLiIpLCB7fSk7Cn0KbGV0IGd2ID0gMDsKY29uc3QgdnUgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKbGV0IE5lID0gY2xhc3MgQWggZXh0ZW5kcyBFaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyB0ZXh0dXJlLgogICAqCiAgICogQHBhcmFtIHs/T2JqZWN0fSBbaW1hZ2U9VGV4dHVyZS5ERUZBVUxUX0lNQUdFXSAtIFRoZSBpbWFnZSBob2xkaW5nIHRoZSB0ZXh0dXJlIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttYXBwaW5nPVRleHR1cmUuREVGQVVMVF9NQVBQSU5HXSAtIFRoZSB0ZXh0dXJlIG1hcHBpbmcuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwUz1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwUyB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dyYXBUPUNsYW1wVG9FZGdlV3JhcHBpbmddIC0gVGhlIHdyYXBUIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFnRmlsdGVyPUxpbmVhckZpbHRlcl0gLSBUaGUgbWFnIGZpbHRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21pbkZpbHRlcj1MaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXJdIC0gVGhlIG1pbiBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtmb3JtYXQ9UkdCQUZvcm1hdF0gLSBUaGUgdGV4dHVyZSBmb3JtYXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0eXBlPVVuc2lnbmVkQnl0ZVR5cGVdIC0gVGhlIHRleHR1cmUgdHlwZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FuaXNvdHJvcHk9VGV4dHVyZS5ERUZBVUxUX0FOSVNPVFJPUFldIC0gVGhlIGFuaXNvdHJvcHkgdmFsdWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPU5vQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICovCiAgY29uc3RydWN0b3IodCA9IEFoLkRFRkFVTFRfSU1BR0UsIGUgPSBBaC5ERUZBVUxUX01BUFBJTkcsIGkgPSBTaSwgbiA9IFNpLCBzID0gQ2UsIHIgPSBFbiwgbyA9IGdpLCBsID0gcG4sIGggPSBBaC5ERUZBVUxUX0FOSVNPVFJPUFksIGMgPSAkbikgewogICAgc3VwZXIoKSwgdGhpcy5pc1RleHR1cmUgPSAhMCwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJpZCIsIHsgdmFsdWU6IGd2KysgfSksIHRoaXMudXVpZCA9IE9pKCksIHRoaXMubmFtZSA9ICIiLCB0aGlzLnNvdXJjZSA9IG5ldyBNcyh0KSwgdGhpcy5taXBtYXBzID0gW10sIHRoaXMubWFwcGluZyA9IGUsIHRoaXMuY2hhbm5lbCA9IDAsIHRoaXMud3JhcFMgPSBpLCB0aGlzLndyYXBUID0gbiwgdGhpcy5tYWdGaWx0ZXIgPSBzLCB0aGlzLm1pbkZpbHRlciA9IHIsIHRoaXMuYW5pc290cm9weSA9IGgsIHRoaXMuZm9ybWF0ID0gbywgdGhpcy5pbnRlcm5hbEZvcm1hdCA9IG51bGwsIHRoaXMudHlwZSA9IGwsIHRoaXMub2Zmc2V0ID0gbmV3IEooMCwgMCksIHRoaXMucmVwZWF0ID0gbmV3IEooMSwgMSksIHRoaXMuY2VudGVyID0gbmV3IEooMCwgMCksIHRoaXMucm90YXRpb24gPSAwLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSAhMCwgdGhpcy5tYXRyaXggPSBuZXcgWHQoKSwgdGhpcy5nZW5lcmF0ZU1pcG1hcHMgPSAhMCwgdGhpcy5wcmVtdWx0aXBseUFscGhhID0gITEsIHRoaXMuZmxpcFkgPSAhMCwgdGhpcy51bnBhY2tBbGlnbm1lbnQgPSA0LCB0aGlzLmNvbG9yU3BhY2UgPSBjLCB0aGlzLnVzZXJEYXRhID0ge30sIHRoaXMudXBkYXRlUmFuZ2VzID0gW10sIHRoaXMudmVyc2lvbiA9IDAsIHRoaXMub25VcGRhdGUgPSBudWxsLCB0aGlzLnJlbmRlclRhcmdldCA9IG51bGwsIHRoaXMuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID0gITEsIHRoaXMuaXNBcnJheVRleHR1cmUgPSAhISh0ICYmIHQuZGVwdGggJiYgdC5kZXB0aCA+IDEpLCB0aGlzLnBtcmVtVmVyc2lvbiA9IDA7CiAgfQogIC8qKgogICAqIFRoZSB3aWR0aCBvZiB0aGUgdGV4dHVyZSBpbiBwaXhlbHMuCiAgICovCiAgZ2V0IHdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMuc291cmNlLmdldFNpemUodnUpLng7CiAgfQogIC8qKgogICAqIFRoZSBoZWlnaHQgb2YgdGhlIHRleHR1cmUgaW4gcGl4ZWxzLgogICAqLwogIGdldCBoZWlnaHQoKSB7CiAgICByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0U2l6ZSh2dSkueTsKICB9CiAgLyoqCiAgICogVGhlIGRlcHRoIG9mIHRoZSB0ZXh0dXJlIGluIHBpeGVscy4KICAgKi8KICBnZXQgZGVwdGgoKSB7CiAgICByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0U2l6ZSh2dSkuejsKICB9CiAgLyoqCiAgICogVGhlIGltYWdlIG9iamVjdCBob2xkaW5nIHRoZSB0ZXh0dXJlIGRhdGEuCiAgICoKICAgKiBAdHlwZSB7P09iamVjdH0KICAgKi8KICBnZXQgaW1hZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5zb3VyY2UuZGF0YTsKICB9CiAgc2V0IGltYWdlKHQgPSBudWxsKSB7CiAgICB0aGlzLnNvdXJjZS5kYXRhID0gdDsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgdGV4dHVyZSB0cmFuc2Zvcm1hdGlvbiBtYXRyaXggZnJvbSB0aGUgZnJvbSB0aGUgcHJvcGVydGllcyB7QGxpbmsgVGV4dHVyZSNvZmZzZXR9LAogICAqIHtAbGluayBUZXh0dXJlI3JlcGVhdH0sIHtAbGluayBUZXh0dXJlI3JvdGF0aW9ufSwgYW5kIHtAbGluayBUZXh0dXJlI2NlbnRlcn0uCiAgICovCiAgdXBkYXRlTWF0cml4KCkgewogICAgdGhpcy5tYXRyaXguc2V0VXZUcmFuc2Zvcm0odGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSwgdGhpcy5yZXBlYXQueCwgdGhpcy5yZXBlYXQueSwgdGhpcy5yb3RhdGlvbiwgdGhpcy5jZW50ZXIueCwgdGhpcy5jZW50ZXIueSk7CiAgfQogIC8qKgogICAqIEFkZHMgYSByYW5nZSBvZiBkYXRhIGluIHRoZSBkYXRhIHRleHR1cmUgdG8gYmUgdXBkYXRlZCBvbiB0aGUgR1BVLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IC0gUG9zaXRpb24gYXQgd2hpY2ggdG8gc3RhcnQgdXBkYXRlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb3VudCAtIFRoZSBudW1iZXIgb2YgY29tcG9uZW50cyB0byB1cGRhdGUuCiAgICovCiAgYWRkVXBkYXRlUmFuZ2UodCwgZSkgewogICAgdGhpcy51cGRhdGVSYW5nZXMucHVzaCh7IHN0YXJ0OiB0LCBjb3VudDogZSB9KTsKICB9CiAgLyoqCiAgICogQ2xlYXJzIHRoZSB1cGRhdGUgcmFuZ2VzLgogICAqLwogIGNsZWFyVXBkYXRlUmFuZ2VzKCkgewogICAgdGhpcy51cGRhdGVSYW5nZXMubGVuZ3RoID0gMDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyB0ZXh0dXJlIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtUZXh0dXJlfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KHRoaXMpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gdGV4dHVyZSB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtUZXh0dXJlfSBzb3VyY2UgLSBUaGUgdGV4dHVyZSB0byBjb3B5LgogICAqIEByZXR1cm4ge1RleHR1cmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5uYW1lID0gdC5uYW1lLCB0aGlzLnNvdXJjZSA9IHQuc291cmNlLCB0aGlzLm1pcG1hcHMgPSB0Lm1pcG1hcHMuc2xpY2UoMCksIHRoaXMubWFwcGluZyA9IHQubWFwcGluZywgdGhpcy5jaGFubmVsID0gdC5jaGFubmVsLCB0aGlzLndyYXBTID0gdC53cmFwUywgdGhpcy53cmFwVCA9IHQud3JhcFQsIHRoaXMubWFnRmlsdGVyID0gdC5tYWdGaWx0ZXIsIHRoaXMubWluRmlsdGVyID0gdC5taW5GaWx0ZXIsIHRoaXMuYW5pc290cm9weSA9IHQuYW5pc290cm9weSwgdGhpcy5mb3JtYXQgPSB0LmZvcm1hdCwgdGhpcy5pbnRlcm5hbEZvcm1hdCA9IHQuaW50ZXJuYWxGb3JtYXQsIHRoaXMudHlwZSA9IHQudHlwZSwgdGhpcy5vZmZzZXQuY29weSh0Lm9mZnNldCksIHRoaXMucmVwZWF0LmNvcHkodC5yZXBlYXQpLCB0aGlzLmNlbnRlci5jb3B5KHQuY2VudGVyKSwgdGhpcy5yb3RhdGlvbiA9IHQucm90YXRpb24sIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IHQubWF0cml4QXV0b1VwZGF0ZSwgdGhpcy5tYXRyaXguY29weSh0Lm1hdHJpeCksIHRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gdC5nZW5lcmF0ZU1pcG1hcHMsIHRoaXMucHJlbXVsdGlwbHlBbHBoYSA9IHQucHJlbXVsdGlwbHlBbHBoYSwgdGhpcy5mbGlwWSA9IHQuZmxpcFksIHRoaXMudW5wYWNrQWxpZ25tZW50ID0gdC51bnBhY2tBbGlnbm1lbnQsIHRoaXMuY29sb3JTcGFjZSA9IHQuY29sb3JTcGFjZSwgdGhpcy5yZW5kZXJUYXJnZXQgPSB0LnJlbmRlclRhcmdldCwgdGhpcy5pc1JlbmRlclRhcmdldFRleHR1cmUgPSB0LmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSwgdGhpcy5pc0FycmF5VGV4dHVyZSA9IHQuaXNBcnJheVRleHR1cmUsIHRoaXMudXNlckRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHQudXNlckRhdGEpKSwgdGhpcy5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgdGV4dHVyZSdzIHByb3BlcnRpZXMgYmFzZWQgb24gYHZhbHVlc2AuCiAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlcyAtIEEgY29udGFpbmVyIHdpdGggdGV4dHVyZSBwYXJhbWV0ZXJzLgogICAqLwogIHNldFZhbHVlcyh0KSB7CiAgICBmb3IgKGNvbnN0IGUgaW4gdCkgewogICAgICBjb25zdCBpID0gdFtlXTsKICAgICAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnNvbGUud2FybihgVEhSRUUuVGV4dHVyZS5zZXRWYWx1ZXMoKTogcGFyYW1ldGVyICcke2V9JyBoYXMgdmFsdWUgb2YgdW5kZWZpbmVkLmApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IG4gPSB0aGlzW2VdOwogICAgICBpZiAobiA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBUSFJFRS5UZXh0dXJlLnNldFZhbHVlcygpOiBwcm9wZXJ0eSAnJHtlfScgZG9lcyBub3QgZXhpc3QuYCk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbiAmJiBpICYmIG4uaXNWZWN0b3IyICYmIGkuaXNWZWN0b3IyIHx8IG4gJiYgaSAmJiBuLmlzVmVjdG9yMyAmJiBpLmlzVmVjdG9yMyB8fCBuICYmIGkgJiYgbi5pc01hdHJpeDMgJiYgaS5pc01hdHJpeDMgPyBuLmNvcHkoaSkgOiB0aGlzW2VdID0gaTsKICAgIH0KICB9CiAgLyoqCiAgICogU2VyaWFsaXplcyB0aGUgdGV4dHVyZSBpbnRvIEpTT04uCiAgICoKICAgKiBAcGFyYW0gez8oT2JqZWN0fHN0cmluZyl9IG1ldGEgLSBBbiBvcHRpb25hbCB2YWx1ZSBob2xkaW5nIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlcmlhbGl6YXRpb24uCiAgICogQHJldHVybiB7T2JqZWN0fSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCB0ZXh0dXJlLgogICAqIEBzZWUge0BsaW5rIE9iamVjdExvYWRlciNwYXJzZX0KICAgKi8KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHQgPT09IHZvaWQgMCB8fCB0eXBlb2YgdCA9PSAic3RyaW5nIjsKICAgIGlmICghZSAmJiB0LnRleHR1cmVzW3RoaXMudXVpZF0gIT09IHZvaWQgMCkKICAgICAgcmV0dXJuIHQudGV4dHVyZXNbdGhpcy51dWlkXTsKICAgIGNvbnN0IGkgPSB7CiAgICAgIG1ldGFkYXRhOiB7CiAgICAgICAgdmVyc2lvbjogNC43LAogICAgICAgIHR5cGU6ICJUZXh0dXJlIiwKICAgICAgICBnZW5lcmF0b3I6ICJUZXh0dXJlLnRvSlNPTiIKICAgICAgfSwKICAgICAgdXVpZDogdGhpcy51dWlkLAogICAgICBuYW1lOiB0aGlzLm5hbWUsCiAgICAgIGltYWdlOiB0aGlzLnNvdXJjZS50b0pTT04odCkudXVpZCwKICAgICAgbWFwcGluZzogdGhpcy5tYXBwaW5nLAogICAgICBjaGFubmVsOiB0aGlzLmNoYW5uZWwsCiAgICAgIHJlcGVhdDogW3RoaXMucmVwZWF0LngsIHRoaXMucmVwZWF0LnldLAogICAgICBvZmZzZXQ6IFt0aGlzLm9mZnNldC54LCB0aGlzLm9mZnNldC55XSwKICAgICAgY2VudGVyOiBbdGhpcy5jZW50ZXIueCwgdGhpcy5jZW50ZXIueV0sCiAgICAgIHJvdGF0aW9uOiB0aGlzLnJvdGF0aW9uLAogICAgICB3cmFwOiBbdGhpcy53cmFwUywgdGhpcy53cmFwVF0sCiAgICAgIGZvcm1hdDogdGhpcy5mb3JtYXQsCiAgICAgIGludGVybmFsRm9ybWF0OiB0aGlzLmludGVybmFsRm9ybWF0LAogICAgICB0eXBlOiB0aGlzLnR5cGUsCiAgICAgIGNvbG9yU3BhY2U6IHRoaXMuY29sb3JTcGFjZSwKICAgICAgbWluRmlsdGVyOiB0aGlzLm1pbkZpbHRlciwKICAgICAgbWFnRmlsdGVyOiB0aGlzLm1hZ0ZpbHRlciwKICAgICAgYW5pc290cm9weTogdGhpcy5hbmlzb3Ryb3B5LAogICAgICBmbGlwWTogdGhpcy5mbGlwWSwKICAgICAgZ2VuZXJhdGVNaXBtYXBzOiB0aGlzLmdlbmVyYXRlTWlwbWFwcywKICAgICAgcHJlbXVsdGlwbHlBbHBoYTogdGhpcy5wcmVtdWx0aXBseUFscGhhLAogICAgICB1bnBhY2tBbGlnbm1lbnQ6IHRoaXMudW5wYWNrQWxpZ25tZW50CiAgICB9OwogICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMudXNlckRhdGEpLmxlbmd0aCA+IDAgJiYgKGkudXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhKSwgZSB8fCAodC50ZXh0dXJlc1t0aGlzLnV1aWRdID0gaSksIGk7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqCiAgICogQGZpcmVzIFRleHR1cmUjZGlzcG9zZQogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAiZGlzcG9zZSIgfSk7CiAgfQogIC8qKgogICAqIFRyYW5zZm9ybXMgdGhlIGdpdmVuIHV2IHZlY3RvciB3aXRoIHRoZSB0ZXh0dXJlcyB1diB0cmFuc2Zvcm1hdGlvbiBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHV2IC0gVGhlIHV2IHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBUaGUgdHJhbnNmb3JtZWQgdXYgdmVjdG9yLgogICAqLwogIHRyYW5zZm9ybVV2KHQpIHsKICAgIGlmICh0aGlzLm1hcHBpbmcgIT09IENjKSByZXR1cm4gdDsKICAgIGlmICh0LmFwcGx5TWF0cml4Myh0aGlzLm1hdHJpeCksIHQueCA8IDAgfHwgdC54ID4gMSkKICAgICAgc3dpdGNoICh0aGlzLndyYXBTKSB7CiAgICAgICAgY2FzZSBNbzoKICAgICAgICAgIHQueCA9IHQueCAtIE1hdGguZmxvb3IodC54KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgU2k6CiAgICAgICAgICB0LnggPSB0LnggPCAwID8gMCA6IDE7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIFNvOgogICAgICAgICAgTWF0aC5hYnMoTWF0aC5mbG9vcih0LngpICUgMikgPT09IDEgPyB0LnggPSBNYXRoLmNlaWwodC54KSAtIHQueCA6IHQueCA9IHQueCAtIE1hdGguZmxvb3IodC54KTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICBpZiAodC55IDwgMCB8fCB0LnkgPiAxKQogICAgICBzd2l0Y2ggKHRoaXMud3JhcFQpIHsKICAgICAgICBjYXNlIE1vOgogICAgICAgICAgdC55ID0gdC55IC0gTWF0aC5mbG9vcih0LnkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBTaToKICAgICAgICAgIHQueSA9IHQueSA8IDAgPyAwIDogMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgU286CiAgICAgICAgICBNYXRoLmFicyhNYXRoLmZsb29yKHQueSkgJSAyKSA9PT0gMSA/IHQueSA9IE1hdGguY2VpbCh0LnkpIC0gdC55IDogdC55ID0gdC55IC0gTWF0aC5mbG9vcih0LnkpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIHJldHVybiB0aGlzLmZsaXBZICYmICh0LnkgPSAxIC0gdC55KSwgdDsKICB9CiAgLyoqCiAgICogU2V0dGluZyB0aGlzIHByb3BlcnR5IHRvIGB0cnVlYCBpbmRpY2F0ZXMgdGhlIGVuZ2luZSB0aGUgdGV4dHVyZQogICAqIG11c3QgYmUgdXBkYXRlZCBpbiB0aGUgbmV4dCByZW5kZXIuIFRoaXMgdHJpZ2dlcnMgYSB0ZXh0dXJlIHVwbG9hZAogICAqIHRvIHRoZSBHUFUgYW5kIGVuc3VyZXMgY29ycmVjdCB0ZXh0dXJlIHBhcmFtZXRlciBjb25maWd1cmF0aW9uLgogICAqCiAgICogQHR5cGUge2Jvb2xlYW59CiAgICogQGRlZmF1bHQgZmFsc2UKICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAgICovCiAgc2V0IG5lZWRzVXBkYXRlKHQpIHsKICAgIHQgPT09ICEwICYmICh0aGlzLnZlcnNpb24rKywgdGhpcy5zb3VyY2UubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIC8qKgogICAqIFNldHRpbmcgdGhpcyBwcm9wZXJ0eSB0byBgdHJ1ZWAgaW5kaWNhdGVzIHRoZSBlbmdpbmUgdGhlIFBNUkVNCiAgICogbXVzdCBiZSByZWdlbmVyYXRlZC4KICAgKgogICAqIEB0eXBlIHtib29sZWFufQogICAqIEBkZWZhdWx0IGZhbHNlCiAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogICAqLwogIHNldCBuZWVkc1BNUkVNVXBkYXRlKHQpIHsKICAgIHQgPT09ICEwICYmIHRoaXMucG1yZW1WZXJzaW9uKys7CiAgfQp9OwpOZS5ERUZBVUxUX0lNQUdFID0gbnVsbDsKTmUuREVGQVVMVF9NQVBQSU5HID0gQ2M7Ck5lLkRFRkFVTFRfQU5JU09UUk9QWSA9IDE7CmxldCBRdCA9IGNsYXNzIHZ5IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IDREIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSB4IHZhbHVlIG9mIHRoaXMgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IHZhbHVlIG9mIHRoaXMgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbej0wXSAtIFRoZSB6IHZhbHVlIG9mIHRoaXMgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdz0xXSAtIFRoZSB3IHZhbHVlIG9mIHRoaXMgdmVjdG9yLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAwLCBlID0gMCwgaSA9IDAsIG4gPSAxKSB7CiAgICB2eS5wcm90b3R5cGUuaXNWZWN0b3I0ID0gITAsIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXMueiA9IGksIHRoaXMudyA9IG47CiAgfQogIC8qKgogICAqIEFsaWFzIGZvciB7QGxpbmsgVmVjdG9yNCN6fS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgZ2V0IHdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMuejsKICB9CiAgc2V0IHdpZHRoKHQpIHsKICAgIHRoaXMueiA9IHQ7CiAgfQogIC8qKgogICAqIEFsaWFzIGZvciB7QGxpbmsgVmVjdG9yNCN3fS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgZ2V0IGhlaWdodCgpIHsKICAgIHJldHVybiB0aGlzLnc7CiAgfQogIHNldCBoZWlnaHQodCkgewogICAgdGhpcy53ID0gdDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSBvZiB0aGUgeCBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgb2YgdGhlIHkgY29tcG9uZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIHZhbHVlIG9mIHRoZSB6IGNvbXBvbmVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gdyAtIFRoZSB2YWx1ZSBvZiB0aGUgdyBjb21wb25lbnQuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0KHQsIGUsIGksIG4pIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzLnkgPSBlLCB0aGlzLnogPSBpLCB0aGlzLncgPSBuLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyB0byB0aGUgc2FtZSB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgdmFsdWUgdG8gc2V0IGZvciBhbGwgdmVjdG9yIGNvbXBvbmVudHMuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzLnkgPSB0LCB0aGlzLnogPSB0LCB0aGlzLncgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB4IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRYKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB5IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRZKHQpIHsKICAgIHJldHVybiB0aGlzLnkgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB6IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRaKHQpIHsKICAgIHJldHVybiB0aGlzLnogPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB3IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB3IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRXKHQpIHsKICAgIHJldHVybiB0aGlzLncgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBbGxvd3MgdG8gc2V0IGEgdmVjdG9yIGNvbXBvbmVudCB3aXRoIGFuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGNvbXBvbmVudCBpbmRleC4gYDBgIGVxdWFscyB0byB4LCBgMWAgZXF1YWxzIHRvIHksCiAgICogYDJgIGVxdWFscyB0byB6LCBgM2AgZXF1YWxzIHRvIHcuCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRDb21wb25lbnQodCwgZSkgewogICAgc3dpdGNoICh0KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLnggPSBlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy55ID0gZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMueiA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLncgPSBlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHZlY3RvciBjb21wb25lbnQgd2hpY2ggbWF0Y2hlcyB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgY29tcG9uZW50IGluZGV4LiBgMGAgZXF1YWxzIHRvIHgsIGAxYCBlcXVhbHMgdG8geSwKICAgKiBgMmAgZXF1YWxzIHRvIHosIGAzYCBlcXVhbHMgdG8gdy4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgdmVjdG9yIGNvbXBvbmVudCB2YWx1ZS4KICAgKi8KICBnZXRDb21wb25lbnQodCkgewogICAgc3dpdGNoICh0KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgICBjYXNlIDE6CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgICAgY2FzZSAyOgogICAgICAgIHJldHVybiB0aGlzLno7CiAgICAgIGNhc2UgMzoKICAgICAgICByZXR1cm4gdGhpcy53OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgdmVjdG9yIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy54LCB0aGlzLnksIHRoaXMueiwgdGhpcy53KTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfFZlY3RvcjR9IHYgLSBUaGUgdmVjdG9yIHRvIGNvcHkuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54LCB0aGlzLnkgPSB0LnksIHRoaXMueiA9IHQueiwgdGhpcy53ID0gdC53ICE9PSB2b2lkIDAgPyB0LncgOiAxLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yNH0gdiAtIFRoZSB2ZWN0b3IgdG8gYWRkLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZCh0KSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQueCwgdGhpcy55ICs9IHQueSwgdGhpcy56ICs9IHQueiwgdGhpcy53ICs9IHQudywgdGhpczsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIHRvIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBzY2FsYXIgdG8gYWRkLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQsIHRoaXMueSArPSB0LCB0aGlzLnogKz0gdCwgdGhpcy53ICs9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHZlY3RvcnMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0IGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjR9IGEgLSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yNH0gYiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZFZlY3RvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCArIGUueCwgdGhpcy55ID0gdC55ICsgZS55LCB0aGlzLnogPSB0LnogKyBlLnosIHRoaXMudyA9IHQudyArIGUudywgdGhpczsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gdmVjdG9yIHNjYWxlZCBieSB0aGUgZ2l2ZW4gZmFjdG9yIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjR9IHYgLSBUaGUgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIGZhY3RvciB0aGF0IHNjYWxlcyBgdmAuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkU2NhbGVkVmVjdG9yKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54ICogZSwgdGhpcy55ICs9IHQueSAqIGUsIHRoaXMueiArPSB0LnogKiBlLCB0aGlzLncgKz0gdC53ICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogU3VidHJhY3RzIHRoZSBnaXZlbiB2ZWN0b3IgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3I0fSB2IC0gVGhlIHZlY3RvciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LngsIHRoaXMueSAtPSB0LnksIHRoaXMueiAtPSB0LnosIHRoaXMudyAtPSB0LncsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIGZyb20gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWJTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LCB0aGlzLnkgLT0gdCwgdGhpcy56IC09IHQsIHRoaXMudyAtPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTdWJ0cmFjdHMgdGhlIGdpdmVuIHZlY3RvcnMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0IGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjR9IGEgLSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yNH0gYiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHN1YlZlY3RvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCAtIGUueCwgdGhpcy55ID0gdC55IC0gZS55LCB0aGlzLnogPSB0LnogLSBlLnosIHRoaXMudyA9IHQudyAtIGUudywgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yNH0gdiAtIFRoZSB2ZWN0b3IgdG8gbXVsdGlwbHkuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LngsIHRoaXMueSAqPSB0LnksIHRoaXMueiAqPSB0LnosIHRoaXMudyAqPSB0LncsIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSB3aXRoIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGFyIC0gVGhlIHNjYWxhciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICo9IHQsIHRoaXMueSAqPSB0LCB0aGlzLnogKj0gdCwgdGhpcy53ICo9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhpcyB2ZWN0b3Igd2l0aCB0aGUgZ2l2ZW4gNHg0IG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSA0eDQgbWF0cml4LgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFwcGx5TWF0cml4NCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy54LCBpID0gdGhpcy55LCBuID0gdGhpcy56LCBzID0gdGhpcy53LCByID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnggPSByWzBdICogZSArIHJbNF0gKiBpICsgcls4XSAqIG4gKyByWzEyXSAqIHMsIHRoaXMueSA9IHJbMV0gKiBlICsgcls1XSAqIGkgKyByWzldICogbiArIHJbMTNdICogcywgdGhpcy56ID0gclsyXSAqIGUgKyByWzZdICogaSArIHJbMTBdICogbiArIHJbMTRdICogcywgdGhpcy53ID0gclszXSAqIGUgKyByWzddICogaSArIHJbMTFdICogbiArIHJbMTVdICogcywgdGhpczsKICB9CiAgLyoqCiAgICogRGl2aWRlcyB0aGlzIGluc3RhbmNlIGJ5IHRoZSBnaXZlbiB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjR9IHYgLSBUaGUgdmVjdG9yIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGUodCkgewogICAgcmV0dXJuIHRoaXMueCAvPSB0LngsIHRoaXMueSAvPSB0LnksIHRoaXMueiAvPSB0LnosIHRoaXMudyAvPSB0LncsIHRoaXM7CiAgfQogIC8qKgogICAqIERpdmlkZXMgdGhpcyB2ZWN0b3IgYnkgdGhlIGdpdmVuIHNjYWxhci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgc2NhbGFyIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGVTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoMSAvIHQpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB4LCB5IGFuZCB6IGNvbXBvbmVudHMgb2YgdGhpcwogICAqIHZlY3RvciB0byB0aGUgcXVhdGVybmlvbidzIGF4aXMgYW5kIHcgdG8gdGhlIGFuZ2xlLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIFF1YXRlcm5pb24gdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldEF4aXNBbmdsZUZyb21RdWF0ZXJuaW9uKHQpIHsKICAgIHRoaXMudyA9IDIgKiBNYXRoLmFjb3ModC53KTsKICAgIGNvbnN0IGUgPSBNYXRoLnNxcnQoMSAtIHQudyAqIHQudyk7CiAgICByZXR1cm4gZSA8IDFlLTQgPyAodGhpcy54ID0gMSwgdGhpcy55ID0gMCwgdGhpcy56ID0gMCkgOiAodGhpcy54ID0gdC54IC8gZSwgdGhpcy55ID0gdC55IC8gZSwgdGhpcy56ID0gdC56IC8gZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHgsIHkgYW5kIHogY29tcG9uZW50cyBvZiB0aGlzCiAgICogdmVjdG9yIHRvIHRoZSBheGlzIG9mIHJvdGF0aW9uIGFuZCB3IHRvIHRoZSBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIEEgNHg0IG1hdHJpeCBvZiB3aGljaCB0aGUgdXBwZXIgbGVmdCAzeDMgbWF0cml4IGlzIGEgcHVyZSByb3RhdGlvbiBtYXRyaXguCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0QXhpc0FuZ2xlRnJvbVJvdGF0aW9uTWF0cml4KHQpIHsKICAgIGxldCBlLCBpLCBuLCBzOwogICAgY29uc3QgbCA9IHQuZWxlbWVudHMsIGggPSBsWzBdLCBjID0gbFs0XSwgdSA9IGxbOF0sIGQgPSBsWzFdLCBwID0gbFs1XSwgZiA9IGxbOV0sIHkgPSBsWzJdLCBnID0gbFs2XSwgbSA9IGxbMTBdOwogICAgaWYgKE1hdGguYWJzKGMgLSBkKSA8IDAuMDEgJiYgTWF0aC5hYnModSAtIHkpIDwgMC4wMSAmJiBNYXRoLmFicyhmIC0gZykgPCAwLjAxKSB7CiAgICAgIGlmIChNYXRoLmFicyhjICsgZCkgPCAwLjEgJiYgTWF0aC5hYnModSArIHkpIDwgMC4xICYmIE1hdGguYWJzKGYgKyBnKSA8IDAuMSAmJiBNYXRoLmFicyhoICsgcCArIG0gLSAzKSA8IDAuMSkKICAgICAgICByZXR1cm4gdGhpcy5zZXQoMSwgMCwgMCwgMCksIHRoaXM7CiAgICAgIGUgPSBNYXRoLlBJOwogICAgICBjb25zdCB4ID0gKGggKyAxKSAvIDIsIF8gPSAocCArIDEpIC8gMiwgUyA9IChtICsgMSkgLyAyLCB3ID0gKGMgKyBkKSAvIDQsIFQgPSAodSArIHkpIC8gNCwgUiA9IChmICsgZykgLyA0OwogICAgICByZXR1cm4geCA+IF8gJiYgeCA+IFMgPyB4IDwgMC4wMSA/IChpID0gMCwgbiA9IDAuNzA3MTA2NzgxLCBzID0gMC43MDcxMDY3ODEpIDogKGkgPSBNYXRoLnNxcnQoeCksIG4gPSB3IC8gaSwgcyA9IFQgLyBpKSA6IF8gPiBTID8gXyA8IDAuMDEgPyAoaSA9IDAuNzA3MTA2NzgxLCBuID0gMCwgcyA9IDAuNzA3MTA2NzgxKSA6IChuID0gTWF0aC5zcXJ0KF8pLCBpID0gdyAvIG4sIHMgPSBSIC8gbikgOiBTIDwgMC4wMSA/IChpID0gMC43MDcxMDY3ODEsIG4gPSAwLjcwNzEwNjc4MSwgcyA9IDApIDogKHMgPSBNYXRoLnNxcnQoUyksIGkgPSBUIC8gcywgbiA9IFIgLyBzKSwgdGhpcy5zZXQoaSwgbiwgcywgZSksIHRoaXM7CiAgICB9CiAgICBsZXQgdiA9IE1hdGguc3FydCgoZyAtIGYpICogKGcgLSBmKSArICh1IC0geSkgKiAodSAtIHkpICsgKGQgLSBjKSAqIChkIC0gYykpOwogICAgcmV0dXJuIE1hdGguYWJzKHYpIDwgMWUtMyAmJiAodiA9IDEpLCB0aGlzLnggPSAoZyAtIGYpIC8gdiwgdGhpcy55ID0gKHUgLSB5KSAvIHYsIHRoaXMueiA9IChkIC0gYykgLyB2LCB0aGlzLncgPSBNYXRoLmFjb3MoKGggKyBwICsgbSAtIDEpIC8gMiksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIHRvIHRoZSBwb3NpdGlvbiBlbGVtZW50cyBvZiB0aGUKICAgKiBnaXZlbiB0cmFuc2Zvcm1hdGlvbiBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tTWF0cml4UG9zaXRpb24odCkgewogICAgY29uc3QgZSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy54ID0gZVsxMl0sIHRoaXMueSA9IGVbMTNdLCB0aGlzLnogPSBlWzE0XSwgdGhpcy53ID0gZVsxNV0sIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSwgeiBvciB3IHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgZ2l2ZW4gdmVjdG9yJ3MgeCwgeSwgeiBvciB3CiAgICogdmFsdWUsIHJlcGxhY2UgdGhhdCB2YWx1ZSB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIG1pbiB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yNH0gdiAtIFRoZSB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbWluKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1pbih0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdC55KSwgdGhpcy56ID0gTWF0aC5taW4odGhpcy56LCB0LnopLCB0aGlzLncgPSBNYXRoLm1pbih0aGlzLncsIHQudyksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSwgeiBvciB3IHZhbHVlIGlzIGxlc3MgdGhhbiB0aGUgZ2l2ZW4gdmVjdG9yJ3MgeCwgeSwgeiBvciB3CiAgICogdmFsdWUsIHJlcGxhY2UgdGhhdCB2YWx1ZSB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIG1heCB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yNH0gdiAtIFRoZSB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbWF4KHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1heCh0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWF4KHRoaXMueSwgdC55KSwgdGhpcy56ID0gTWF0aC5tYXgodGhpcy56LCB0LnopLCB0aGlzLncgPSBNYXRoLm1heCh0aGlzLncsIHQudyksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSwgeiBvciB3IHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZlY3RvcidzIHgsIHksIHogb3IgdwogICAqIHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieSB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHksIHogb3IgdyB2YWx1ZSBpcyBsZXNzIHRoYW4gdGhlIG1pbiB2ZWN0b3IncyB4LCB5LCB6IG9yIHcgdmFsdWUsCiAgICogaXQgaXMgcmVwbGFjZWQgYnkgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjR9IG1pbiAtIFRoZSBtaW5pbXVtIHgsIHkgYW5kIHogdmFsdWVzLgogICAqIEBwYXJhbSB7VmVjdG9yNH0gbWF4IC0gVGhlIG1heGltdW0geCwgeSBhbmQgeiB2YWx1ZXMgaW4gdGhlIGRlc2lyZWQgcmFuZ2UuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IGt0KHRoaXMueCwgdC54LCBlLngpLCB0aGlzLnkgPSBrdCh0aGlzLnksIHQueSwgZS55KSwgdGhpcy56ID0ga3QodGhpcy56LCB0LnosIGUueiksIHRoaXMudyA9IGt0KHRoaXMudywgdC53LCBlLncpLCB0aGlzOwogIH0KICAvKioKICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHksIHogb3IgdyB2YWx1ZXMgYXJlIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZhbHVlLCB0aGV5IGFyZQogICAqIHJlcGxhY2VkIGJ5IHRoZSBtYXggdmFsdWUuCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4LCB5LCB6IG9yIHcgdmFsdWVzIGFyZSBsZXNzIHRoYW4gdGhlIG1pbiB2YWx1ZSwgdGhleSBhcmUKICAgKiByZXBsYWNlZCBieSB0aGUgbWluIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG1pblZhbCAtIFRoZSBtaW5pbXVtIHZhbHVlIHRoZSBjb21wb25lbnRzIHdpbGwgYmUgY2xhbXBlZCB0by4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4VmFsIC0gVGhlIG1heGltdW0gdmFsdWUgdGhlIGNvbXBvbmVudHMgd2lsbCBiZSBjbGFtcGVkIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNsYW1wU2NhbGFyKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSBrdCh0aGlzLngsIHQsIGUpLCB0aGlzLnkgPSBrdCh0aGlzLnksIHQsIGUpLCB0aGlzLnogPSBrdCh0aGlzLnosIHQsIGUpLCB0aGlzLncgPSBrdCh0aGlzLncsIHQsIGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBJZiB0aGlzIHZlY3RvcidzIGxlbmd0aCBpcyBncmVhdGVyIHRoYW4gdGhlIG1heCB2YWx1ZSwgaXQgaXMgcmVwbGFjZWQgYnkKICAgKiB0aGUgbWF4IHZhbHVlLgogICAqIElmIHRoaXMgdmVjdG9yJ3MgbGVuZ3RoIGlzIGxlc3MgdGhhbiB0aGUgbWluIHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieSB0aGUKICAgKiBtaW4gdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgdGhlIHZlY3RvciBsZW5ndGggd2lsbCBiZSBjbGFtcGVkIHRvLgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSB0aGUgdmVjdG9yIGxlbmd0aCB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXBMZW5ndGgodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMubGVuZ3RoKCk7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIoaSB8fCAxKS5tdWx0aXBseVNjYWxhcihrdChpLCB0LCBlKSk7CiAgfQogIC8qKgogICAqIFRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIGFyZSByb3VuZGVkIGRvd24gdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGZsb29yKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KSwgdGhpcy55ID0gTWF0aC5mbG9vcih0aGlzLnkpLCB0aGlzLnogPSBNYXRoLmZsb29yKHRoaXMueiksIHRoaXMudyA9IE1hdGguZmxvb3IodGhpcy53KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdXAgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNlaWwoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCksIHRoaXMueSA9IE1hdGguY2VpbCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLmNlaWwodGhpcy56KSwgdGhpcy53ID0gTWF0aC5jZWlsKHRoaXMudyksIHRoaXM7CiAgfQogIC8qKgogICAqIFRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIGFyZSByb3VuZGVkIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgdmFsdWUKICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJvdW5kKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KSwgdGhpcy55ID0gTWF0aC5yb3VuZCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLnJvdW5kKHRoaXMueiksIHRoaXMudyA9IE1hdGgucm91bmQodGhpcy53KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG93YXJkcyB6ZXJvICh1cCBpZiBuZWdhdGl2ZSwKICAgKiBkb3duIGlmIHBvc2l0aXZlKSB0byBhbiBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmRUb1plcm8oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC50cnVuYyh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnRydW5jKHRoaXMueSksIHRoaXMueiA9IE1hdGgudHJ1bmModGhpcy56KSwgdGhpcy53ID0gTWF0aC50cnVuYyh0aGlzLncpLCB0aGlzOwogIH0KICAvKioKICAgKiBJbnZlcnRzIHRoaXMgdmVjdG9yIC0gaS5lLiBzZXRzIHggPSAteCwgeSA9IC15LCB6ID0gLXosIHcgPSAtdy4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIG5lZ2F0ZSgpIHsKICAgIHJldHVybiB0aGlzLnggPSAtdGhpcy54LCB0aGlzLnkgPSAtdGhpcy55LCB0aGlzLnogPSAtdGhpcy56LCB0aGlzLncgPSAtdGhpcy53LCB0aGlzOwogIH0KICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBkb3QgcHJvZHVjdCBvZiB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yNH0gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgZG90IHByb2R1Y3Qgd2l0aC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSByZXN1bHQgb2YgdGhlIGRvdCBwcm9kdWN0LgogICAqLwogIGRvdCh0KSB7CiAgICByZXR1cm4gdGhpcy54ICogdC54ICsgdGhpcy55ICogdC55ICsgdGhpcy56ICogdC56ICsgdGhpcy53ICogdC53OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgc3F1YXJlIG9mIHRoZSBFdWNsaWRlYW4gbGVuZ3RoIChzdHJhaWdodC1saW5lIGxlbmd0aCkgZnJvbQogICAqICgwLCAwLCAwLCAwKSB0byAoeCwgeSwgeiwgdykuIElmIHlvdSBhcmUgY29tcGFyaW5nIHRoZSBsZW5ndGhzIG9mIHZlY3RvcnMsIHlvdSBzaG91bGQKICAgKiBjb21wYXJlIHRoZSBsZW5ndGggc3F1YXJlZCBpbnN0ZWFkIGFzIGl0IGlzIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IHRvIGNhbGN1bGF0ZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56ICsgdGhpcy53ICogdGhpcy53OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgIEV1Y2xpZGVhbiBsZW5ndGggKHN0cmFpZ2h0LWxpbmUgbGVuZ3RoKSBmcm9tICgwLCAwLCAwLCAwKSB0byAoeCwgeSwgeiwgdykuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnogKyB0aGlzLncgKiB0aGlzLncpOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgTWFuaGF0dGFuIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopICsgTWF0aC5hYnModGhpcy53KTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhpcyB2ZWN0b3IgdG8gYSB1bml0IHZlY3RvciAtIHRoYXQgaXMsIHNldHMgaXQgZXF1YWwgdG8gYSB2ZWN0b3IKICAgKiB3aXRoIHRoZSBzYW1lIGRpcmVjdGlvbiBhcyB0aGlzIG9uZSwgYnV0IHdpdGggYSB2ZWN0b3IgbGVuZ3RoIG9mIGAxYC4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIG5vcm1hbGl6ZSgpIHsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcih0aGlzLmxlbmd0aCgpIHx8IDEpOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgdmVjdG9yIHRvIGEgdmVjdG9yIHdpdGggdGhlIHNhbWUgZGlyZWN0aW9uIGFzIHRoaXMgb25lLCBidXQKICAgKiB3aXRoIHRoZSBzcGVjaWZpZWQgbGVuZ3RoLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBuZXcgbGVuZ3RoIG9mIHRoaXMgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldExlbmd0aCh0KSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih0KTsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIHZlY3RvciBhbmQgdGhpcyBpbnN0YW5jZSwgd2hlcmUKICAgKiBhbHBoYSBpcyB0aGUgcGVyY2VudCBkaXN0YW5jZSBhbG9uZyB0aGUgbGluZSAtIGFscGhhID0gMCB3aWxsIGJlIHRoaXMKICAgKiB2ZWN0b3IsIGFuZCBhbHBoYSA9IDEgd2lsbCBiZSB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3I0fSB2IC0gVGhlIHZlY3RvciB0byBpbnRlcnBvbGF0ZSB0b3dhcmRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciwgdHlwaWNhbGx5IGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLCAxXWAuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVycCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ICs9ICh0LnggLSB0aGlzLngpICogZSwgdGhpcy55ICs9ICh0LnkgLSB0aGlzLnkpICogZSwgdGhpcy56ICs9ICh0LnogLSB0aGlzLnopICogZSwgdGhpcy53ICs9ICh0LncgLSB0aGlzLncpICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIHZlY3RvcnMsIHdoZXJlIGFscGhhIGlzIHRoZSBwZXJjZW50CiAgICogZGlzdGFuY2UgYWxvbmcgdGhlIGxpbmUgLSBhbHBoYSA9IDAgd2lsbCBiZSBmaXJzdCB2ZWN0b3IsIGFuZCBhbHBoYSA9IDEgd2lsbAogICAqIGJlIHRoZSBzZWNvbmQgb25lLiBUaGUgcmVzdWx0IGlzIHN0b3JlZCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3I0fSB2MSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3I0fSB2MiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciwgdHlwaWNhbGx5IGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLCAxXWAuCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVycFZlY3RvcnModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCArIChlLnggLSB0LngpICogaSwgdGhpcy55ID0gdC55ICsgKGUueSAtIHQueSkgKiBpLCB0aGlzLnogPSB0LnogKyAoZS56IC0gdC56KSAqIGksIHRoaXMudyA9IHQudyArIChlLncgLSB0LncpICogaSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyB2ZWN0b3IgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3I0fSB2IC0gVGhlIHZlY3RvciB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgdmVjdG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQueCA9PT0gdGhpcy54ICYmIHQueSA9PT0gdGhpcy55ICYmIHQueiA9PT0gdGhpcy56ICYmIHQudyA9PT0gdGhpcy53OwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgdmVjdG9yJ3MgeCB2YWx1ZSB0byBiZSBgYXJyYXlbIG9mZnNldCBdYCwgeSB2YWx1ZSB0byBiZSBgYXJyYXlbIG9mZnNldCArIDEgXWAsCiAgICogeiB2YWx1ZSB0byBiZSBgYXJyYXlbIG9mZnNldCArIDIgXWAsIHcgdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgKyAzIF1gLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIEFuIGFycmF5IGhvbGRpbmcgdGhlIHZlY3RvciBjb21wb25lbnQgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtWZWN0b3I0fSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnggPSB0W2VdLCB0aGlzLnkgPSB0W2UgKyAxXSwgdGhpcy56ID0gdFtlICsgMl0sIHRoaXMudyA9IHRbZSArIDNdLCB0aGlzOwogIH0KICAvKioKICAgKiBXcml0ZXMgdGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgdG8gdGhlIGdpdmVuIGFycmF5LiBJZiBubyBhcnJheSBpcyBwcm92aWRlZCwKICAgKiB0aGUgbWV0aG9kIHJldHVybnMgYSBuZXcgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IFthcnJheT1bXV0gLSBUaGUgdGFyZ2V0IGFycmF5IGhvbGRpbmcgdGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSB2ZWN0b3IgY29tcG9uZW50cy4KICAgKi8KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIHJldHVybiB0W2VdID0gdGhpcy54LCB0W2UgKyAxXSA9IHRoaXMueSwgdFtlICsgMl0gPSB0aGlzLnosIHRbZSArIDNdID0gdGhpcy53LCB0OwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIGZyb20gdGhlIGdpdmVuIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckF0dHJpYnV0ZX0gYXR0cmlidXRlIC0gVGhlIGJ1ZmZlciBhdHRyaWJ1dGUgaG9sZGluZyB2ZWN0b3IgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYXR0cmlidXRlLgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQuZ2V0WChlKSwgdGhpcy55ID0gdC5nZXRZKGUpLCB0aGlzLnogPSB0LmdldFooZSksIHRoaXMudyA9IHQuZ2V0VyhlKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyBlYWNoIGNvbXBvbmVudCBvZiB0aGlzIHZlY3RvciB0byBhIHBzZXVkby1yYW5kb20gdmFsdWUgYmV0d2VlbiBgMGAgYW5kCiAgICogYDFgLCBleGNsdWRpbmcgYDFgLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yNH0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcmFuZG9tKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgucmFuZG9tKCksIHRoaXMueSA9IE1hdGgucmFuZG9tKCksIHRoaXMueiA9IE1hdGgucmFuZG9tKCksIHRoaXMudyA9IE1hdGgucmFuZG9tKCksIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueCwgeWllbGQgdGhpcy55LCB5aWVsZCB0aGlzLnosIHlpZWxkIHRoaXMudzsKICB9Cn07CmNsYXNzIEJwIGV4dGVuZHMgRWkgewogIC8qKgogICAqIFJlbmRlciB0YXJnZXQgb3B0aW9ucy4KICAgKgogICAqIEB0eXBlZGVmIHtPYmplY3R9IFJlbmRlclRhcmdldH5PcHRpb25zCiAgICogQHByb3BlcnR5IHtib29sZWFufSBbZ2VuZXJhdGVNaXBtYXBzPWZhbHNlXSAtIFdoZXRoZXIgdG8gZ2VuZXJhdGUgbWlwbWFwcyBvciBub3QuCiAgICogQHByb3BlcnR5IHtudW1iZXJ9IFttYWdGaWx0ZXI9TGluZWFyRmlsdGVyXSAtIFRoZSBtYWcgZmlsdGVyLgogICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbbWluRmlsdGVyPUxpbmVhckZpbHRlcl0gLSBUaGUgbWluIGZpbHRlci4KICAgKiBAcHJvcGVydHkge251bWJlcn0gW2Zvcm1hdD1SR0JBRm9ybWF0XSAtIFRoZSB0ZXh0dXJlIGZvcm1hdC4KICAgKiBAcHJvcGVydHkge251bWJlcn0gW3R5cGU9VW5zaWduZWRCeXRlVHlwZV0gLSBUaGUgdGV4dHVyZSB0eXBlLgogICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gW2ludGVybmFsRm9ybWF0PW51bGxdIC0gVGhlIHRleHR1cmUncyBpbnRlcm5hbCBmb3JtYXQuCiAgICogQHByb3BlcnR5IHtudW1iZXJ9IFt3cmFwUz1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB0ZXh0dXJlJ3MgdXYgd3JhcHBpbmcgbW9kZS4KICAgKiBAcHJvcGVydHkge251bWJlcn0gW3dyYXBUPUNsYW1wVG9FZGdlV3JhcHBpbmddIC0gVGhlIHRleHR1cmUncyB1diB3cmFwcGluZyBtb2RlLgogICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbYW5pc290cm9weT0xXSAtIFRoZSB0ZXh0dXJlJ3MgYW5pc290cm9weSB2YWx1ZS4KICAgKiBAcHJvcGVydHkge3N0cmluZ30gW2NvbG9yU3BhY2U9Tm9Db2xvclNwYWNlXSAtIFRoZSB0ZXh0dXJlJ3MgY29sb3Igc3BhY2UuCiAgICogQHByb3BlcnR5IHtib29sZWFufSBbZGVwdGhCdWZmZXI9dHJ1ZV0gLSBXaGV0aGVyIHRvIGFsbG9jYXRlIGEgZGVwdGggYnVmZmVyIG9yIG5vdC4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtzdGVuY2lsQnVmZmVyPWZhbHNlXSAtIFdoZXRoZXIgdG8gYWxsb2NhdGUgYSBzdGVuY2lsIGJ1ZmZlciBvciBub3QuCiAgICogQHByb3BlcnR5IHtib29sZWFufSBbcmVzb2x2ZURlcHRoQnVmZmVyPXRydWVdIC0gV2hldGhlciB0byByZXNvbHZlIHRoZSBkZXB0aCBidWZmZXIgb3Igbm90LgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3Jlc29sdmVTdGVuY2lsQnVmZmVyPXRydWVdIC0gV2hldGhlciAgdG8gcmVzb2x2ZSB0aGUgc3RlbmNpbCBidWZmZXIgb3Igbm90LgogICAqIEBwcm9wZXJ0eSB7P1RleHR1cmV9IFtkZXB0aFRleHR1cmU9bnVsbF0gLSBSZWZlcmVuY2UgdG8gYSBkZXB0aCB0ZXh0dXJlLgogICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbc2FtcGxlcz0wXSAtIFRoZSBNU0FBIHNhbXBsZXMgY291bnQuCiAgICogQHByb3BlcnR5IHtudW1iZXJ9IFtjb3VudD0xXSAtIERlZmluZXMgdGhlIG51bWJlciBvZiBjb2xvciBhdHRhY2htZW50cyAuIE11c3QgYmUgYXQgbGVhc3QgYDFgLgogICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBbZGVwdGg9MV0gLSBUaGUgdGV4dHVyZSBkZXB0aC4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFttdWx0aXZpZXc9ZmFsc2VdIC0gV2hldGhlciB0aGlzIHRhcmdldCBpcyB1c2VkIGZvciBtdWx0aXZpZXcgcmVuZGVyaW5nLgogICAqLwogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgcmVuZGVyIHRhcmdldC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MV0gLSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlciB0YXJnZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MV0gLSBUaGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGFyZ2V0LgogICAqIEBwYXJhbSB7UmVuZGVyVGFyZ2V0fk9wdGlvbnN9IFtvcHRpb25zXSAtIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMSwgZSA9IDEsIGkgPSB7fSkgewogICAgc3VwZXIoKSwgaSA9IE9iamVjdC5hc3NpZ24oewogICAgICBnZW5lcmF0ZU1pcG1hcHM6ICExLAogICAgICBpbnRlcm5hbEZvcm1hdDogbnVsbCwKICAgICAgbWluRmlsdGVyOiBDZSwKICAgICAgZGVwdGhCdWZmZXI6ICEwLAogICAgICBzdGVuY2lsQnVmZmVyOiAhMSwKICAgICAgcmVzb2x2ZURlcHRoQnVmZmVyOiAhMCwKICAgICAgcmVzb2x2ZVN0ZW5jaWxCdWZmZXI6ICEwLAogICAgICBkZXB0aFRleHR1cmU6IG51bGwsCiAgICAgIHNhbXBsZXM6IDAsCiAgICAgIGNvdW50OiAxLAogICAgICBkZXB0aDogMSwKICAgICAgbXVsdGl2aWV3OiAhMQogICAgfSwgaSksIHRoaXMuaXNSZW5kZXJUYXJnZXQgPSAhMCwgdGhpcy53aWR0aCA9IHQsIHRoaXMuaGVpZ2h0ID0gZSwgdGhpcy5kZXB0aCA9IGkuZGVwdGgsIHRoaXMuc2Npc3NvciA9IG5ldyBRdCgwLCAwLCB0LCBlKSwgdGhpcy5zY2lzc29yVGVzdCA9ICExLCB0aGlzLnZpZXdwb3J0ID0gbmV3IFF0KDAsIDAsIHQsIGUpOwogICAgY29uc3QgbiA9IHsgd2lkdGg6IHQsIGhlaWdodDogZSwgZGVwdGg6IGkuZGVwdGggfSwgcyA9IG5ldyBOZShuKTsKICAgIHRoaXMudGV4dHVyZXMgPSBbXTsKICAgIGNvbnN0IHIgPSBpLmNvdW50OwogICAgZm9yIChsZXQgbyA9IDA7IG8gPCByOyBvKyspCiAgICAgIHRoaXMudGV4dHVyZXNbb10gPSBzLmNsb25lKCksIHRoaXMudGV4dHVyZXNbb10uaXNSZW5kZXJUYXJnZXRUZXh0dXJlID0gITAsIHRoaXMudGV4dHVyZXNbb10ucmVuZGVyVGFyZ2V0ID0gdGhpczsKICAgIHRoaXMuX3NldFRleHR1cmVPcHRpb25zKGkpLCB0aGlzLmRlcHRoQnVmZmVyID0gaS5kZXB0aEJ1ZmZlciwgdGhpcy5zdGVuY2lsQnVmZmVyID0gaS5zdGVuY2lsQnVmZmVyLCB0aGlzLnJlc29sdmVEZXB0aEJ1ZmZlciA9IGkucmVzb2x2ZURlcHRoQnVmZmVyLCB0aGlzLnJlc29sdmVTdGVuY2lsQnVmZmVyID0gaS5yZXNvbHZlU3RlbmNpbEJ1ZmZlciwgdGhpcy5fZGVwdGhUZXh0dXJlID0gbnVsbCwgdGhpcy5kZXB0aFRleHR1cmUgPSBpLmRlcHRoVGV4dHVyZSwgdGhpcy5zYW1wbGVzID0gaS5zYW1wbGVzLCB0aGlzLm11bHRpdmlldyA9IGkubXVsdGl2aWV3OwogIH0KICBfc2V0VGV4dHVyZU9wdGlvbnModCA9IHt9KSB7CiAgICBjb25zdCBlID0gewogICAgICBtaW5GaWx0ZXI6IENlLAogICAgICBnZW5lcmF0ZU1pcG1hcHM6ICExLAogICAgICBmbGlwWTogITEsCiAgICAgIGludGVybmFsRm9ybWF0OiBudWxsCiAgICB9OwogICAgdC5tYXBwaW5nICE9PSB2b2lkIDAgJiYgKGUubWFwcGluZyA9IHQubWFwcGluZyksIHQud3JhcFMgIT09IHZvaWQgMCAmJiAoZS53cmFwUyA9IHQud3JhcFMpLCB0LndyYXBUICE9PSB2b2lkIDAgJiYgKGUud3JhcFQgPSB0LndyYXBUKSwgdC53cmFwUiAhPT0gdm9pZCAwICYmIChlLndyYXBSID0gdC53cmFwUiksIHQubWFnRmlsdGVyICE9PSB2b2lkIDAgJiYgKGUubWFnRmlsdGVyID0gdC5tYWdGaWx0ZXIpLCB0Lm1pbkZpbHRlciAhPT0gdm9pZCAwICYmIChlLm1pbkZpbHRlciA9IHQubWluRmlsdGVyKSwgdC5mb3JtYXQgIT09IHZvaWQgMCAmJiAoZS5mb3JtYXQgPSB0LmZvcm1hdCksIHQudHlwZSAhPT0gdm9pZCAwICYmIChlLnR5cGUgPSB0LnR5cGUpLCB0LmFuaXNvdHJvcHkgIT09IHZvaWQgMCAmJiAoZS5hbmlzb3Ryb3B5ID0gdC5hbmlzb3Ryb3B5KSwgdC5jb2xvclNwYWNlICE9PSB2b2lkIDAgJiYgKGUuY29sb3JTcGFjZSA9IHQuY29sb3JTcGFjZSksIHQuZmxpcFkgIT09IHZvaWQgMCAmJiAoZS5mbGlwWSA9IHQuZmxpcFkpLCB0LmdlbmVyYXRlTWlwbWFwcyAhPT0gdm9pZCAwICYmIChlLmdlbmVyYXRlTWlwbWFwcyA9IHQuZ2VuZXJhdGVNaXBtYXBzKSwgdC5pbnRlcm5hbEZvcm1hdCAhPT0gdm9pZCAwICYmIChlLmludGVybmFsRm9ybWF0ID0gdC5pbnRlcm5hbEZvcm1hdCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudGV4dHVyZXMubGVuZ3RoOyBpKyspCiAgICAgIHRoaXMudGV4dHVyZXNbaV0uc2V0VmFsdWVzKGUpOwogIH0KICAvKioKICAgKiBUaGUgdGV4dHVyZSByZXByZXNlbnRpbmcgdGhlIGRlZmF1bHQgY29sb3IgYXR0YWNobWVudC4KICAgKgogICAqIEB0eXBlIHtUZXh0dXJlfQogICAqLwogIGdldCB0ZXh0dXJlKCkgewogICAgcmV0dXJuIHRoaXMudGV4dHVyZXNbMF07CiAgfQogIHNldCB0ZXh0dXJlKHQpIHsKICAgIHRoaXMudGV4dHVyZXNbMF0gPSB0OwogIH0KICBzZXQgZGVwdGhUZXh0dXJlKHQpIHsKICAgIHRoaXMuX2RlcHRoVGV4dHVyZSAhPT0gbnVsbCAmJiAodGhpcy5fZGVwdGhUZXh0dXJlLnJlbmRlclRhcmdldCA9IG51bGwpLCB0ICE9PSBudWxsICYmICh0LnJlbmRlclRhcmdldCA9IHRoaXMpLCB0aGlzLl9kZXB0aFRleHR1cmUgPSB0OwogIH0KICAvKioKICAgKiBJbnN0ZWFkIG9mIHNhdmluZyB0aGUgZGVwdGggaW4gYSByZW5kZXJidWZmZXIsIGEgdGV4dHVyZQogICAqIGNhbiBiZSB1c2VkIGluc3RlYWQgd2hpY2ggaXMgdXNlZnVsIGZvciBmdXJ0aGVyIHByb2Nlc3NpbmcKICAgKiBlLmcuIGluIGNvbnRleHQgb2YgcG9zdC1wcm9jZXNzaW5nLgogICAqCiAgICogQHR5cGUgez9EZXB0aFRleHR1cmV9CiAgICogQGRlZmF1bHQgbnVsbAogICAqLwogIGdldCBkZXB0aFRleHR1cmUoKSB7CiAgICByZXR1cm4gdGhpcy5fZGVwdGhUZXh0dXJlOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBzaXplIG9mIHRoaXMgcmVuZGVyIHRhcmdldC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aC4KICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoPTFdIC0gVGhlIGRlcHRoLgogICAqLwogIHNldFNpemUodCwgZSwgaSA9IDEpIHsKICAgIGlmICh0aGlzLndpZHRoICE9PSB0IHx8IHRoaXMuaGVpZ2h0ICE9PSBlIHx8IHRoaXMuZGVwdGggIT09IGkpIHsKICAgICAgdGhpcy53aWR0aCA9IHQsIHRoaXMuaGVpZ2h0ID0gZSwgdGhpcy5kZXB0aCA9IGk7CiAgICAgIGZvciAobGV0IG4gPSAwLCBzID0gdGhpcy50ZXh0dXJlcy5sZW5ndGg7IG4gPCBzOyBuKyspCiAgICAgICAgdGhpcy50ZXh0dXJlc1tuXS5pbWFnZS53aWR0aCA9IHQsIHRoaXMudGV4dHVyZXNbbl0uaW1hZ2UuaGVpZ2h0ID0gZSwgdGhpcy50ZXh0dXJlc1tuXS5pbWFnZS5kZXB0aCA9IGksIHRoaXMudGV4dHVyZXNbbl0uaXNBcnJheVRleHR1cmUgPSB0aGlzLnRleHR1cmVzW25dLmltYWdlLmRlcHRoID4gMTsKICAgICAgdGhpcy5kaXNwb3NlKCk7CiAgICB9CiAgICB0aGlzLnZpZXdwb3J0LnNldCgwLCAwLCB0LCBlKSwgdGhpcy5zY2lzc29yLnNldCgwLCAwLCB0LCBlKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyByZW5kZXIgdGFyZ2V0IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtSZW5kZXJUYXJnZXR9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgc2V0dGluZ3Mgb2YgdGhlIGdpdmVuIHJlbmRlciB0YXJnZXQuIFRoaXMgaXMgYSBzdHJ1Y3R1cmFsIGNvcHkgc28KICAgKiBubyByZXNvdXJjZXMgYXJlIHNoYXJlZCBiZXR3ZWVuIHJlbmRlciB0YXJnZXRzIGFmdGVyIHRoZSBjb3B5LiBUaGF0IGluY2x1ZGVzCiAgICogYWxsIE1SVCB0ZXh0dXJlcyBhbmQgdGhlIGRlcHRoIHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0ge1JlbmRlclRhcmdldH0gc291cmNlIC0gVGhlIHJlbmRlciB0YXJnZXQgdG8gY29weS4KICAgKiBAcmV0dXJuIHtSZW5kZXJUYXJnZXR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY29weSh0KSB7CiAgICB0aGlzLndpZHRoID0gdC53aWR0aCwgdGhpcy5oZWlnaHQgPSB0LmhlaWdodCwgdGhpcy5kZXB0aCA9IHQuZGVwdGgsIHRoaXMuc2Npc3Nvci5jb3B5KHQuc2Npc3NvciksIHRoaXMuc2Npc3NvclRlc3QgPSB0LnNjaXNzb3JUZXN0LCB0aGlzLnZpZXdwb3J0LmNvcHkodC52aWV3cG9ydCksIHRoaXMudGV4dHVyZXMubGVuZ3RoID0gMDsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC50ZXh0dXJlcy5sZW5ndGg7IGUgPCBpOyBlKyspIHsKICAgICAgdGhpcy50ZXh0dXJlc1tlXSA9IHQudGV4dHVyZXNbZV0uY2xvbmUoKSwgdGhpcy50ZXh0dXJlc1tlXS5pc1JlbmRlclRhcmdldFRleHR1cmUgPSAhMCwgdGhpcy50ZXh0dXJlc1tlXS5yZW5kZXJUYXJnZXQgPSB0aGlzOwogICAgICBjb25zdCBuID0gT2JqZWN0LmFzc2lnbih7fSwgdC50ZXh0dXJlc1tlXS5pbWFnZSk7CiAgICAgIHRoaXMudGV4dHVyZXNbZV0uc291cmNlID0gbmV3IE1zKG4pOwogICAgfQogICAgcmV0dXJuIHRoaXMuZGVwdGhCdWZmZXIgPSB0LmRlcHRoQnVmZmVyLCB0aGlzLnN0ZW5jaWxCdWZmZXIgPSB0LnN0ZW5jaWxCdWZmZXIsIHRoaXMucmVzb2x2ZURlcHRoQnVmZmVyID0gdC5yZXNvbHZlRGVwdGhCdWZmZXIsIHRoaXMucmVzb2x2ZVN0ZW5jaWxCdWZmZXIgPSB0LnJlc29sdmVTdGVuY2lsQnVmZmVyLCB0LmRlcHRoVGV4dHVyZSAhPT0gbnVsbCAmJiAodGhpcy5kZXB0aFRleHR1cmUgPSB0LmRlcHRoVGV4dHVyZS5jbG9uZSgpKSwgdGhpcy5zYW1wbGVzID0gdC5zYW1wbGVzLCB0aGlzOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKgogICAqIEBmaXJlcyBSZW5kZXJUYXJnZXQjZGlzcG9zZQogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAiZGlzcG9zZSIgfSk7CiAgfQp9CmNsYXNzIFJuIGV4dGVuZHMgQnAgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgM0QgcmVuZGVyIHRhcmdldC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MV0gLSBUaGUgd2lkdGggb2YgdGhlIHJlbmRlciB0YXJnZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MV0gLSBUaGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGFyZ2V0LgogICAqIEBwYXJhbSB7UmVuZGVyVGFyZ2V0fk9wdGlvbnN9IFtvcHRpb25zXSAtIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMSwgZSA9IDEsIGkgPSB7fSkgewogICAgc3VwZXIodCwgZSwgaSksIHRoaXMuaXNXZWJHTFJlbmRlclRhcmdldCA9ICEwOwogIH0KfQpjbGFzcyBCYyBleHRlbmRzIE5lIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGRhdGEgYXJyYXkgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7P1R5cGVkQXJyYXl9IFtkYXRhPW51bGxdIC0gVGhlIGJ1ZmZlciBkYXRhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MV0gLSBUaGUgd2lkdGggb2YgdGhlIHRleHR1cmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MV0gLSBUaGUgaGVpZ2h0IG9mIHRoZSB0ZXh0dXJlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGVwdGg9MV0gLSBUaGUgZGVwdGggb2YgdGhlIHRleHR1cmUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG51bGwsIGUgPSAxLCBpID0gMSwgbiA9IDEpIHsKICAgIHN1cGVyKG51bGwpLCB0aGlzLmlzRGF0YUFycmF5VGV4dHVyZSA9ICEwLCB0aGlzLmltYWdlID0geyBkYXRhOiB0LCB3aWR0aDogZSwgaGVpZ2h0OiBpLCBkZXB0aDogbiB9LCB0aGlzLm1hZ0ZpbHRlciA9IGplLCB0aGlzLm1pbkZpbHRlciA9IGplLCB0aGlzLndyYXBSID0gU2ksIHRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gITEsIHRoaXMuZmxpcFkgPSAhMSwgdGhpcy51bnBhY2tBbGlnbm1lbnQgPSAxLCB0aGlzLmxheWVyVXBkYXRlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgfQogIC8qKgogICAqIERlc2NyaWJlcyB0aGF0IGEgc3BlY2lmaWMgbGF5ZXIgb2YgdGhlIHRleHR1cmUgbmVlZHMgdG8gYmUgdXBkYXRlZC4KICAgKiBOb3JtYWxseSB3aGVuIHtAbGluayBUZXh0dXJlI25lZWRzVXBkYXRlfSBpcyBzZXQgdG8gYHRydWVgLCB0aGUKICAgKiBlbnRpcmUgZGF0YSB0ZXh0dXJlIGFycmF5IGlzIHNlbnQgdG8gdGhlIEdQVS4gTWFya2luZyBzcGVjaWZpYwogICAqIGxheWVycyB3aWxsIG9ubHkgdHJhbnNtaXQgc3Vic2V0cyBvZiBhbGwgbWlwbWFwcyBhc3NvY2lhdGVkIHdpdGggYQogICAqIHNwZWNpZmljIGRlcHRoIGluIHRoZSBhcnJheSB3aGljaCBpcyBvZnRlbiBtdWNoIG1vcmUgcGVyZm9ybWFudC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllckluZGV4IC0gVGhlIGxheWVyIGluZGV4IHRoYXQgc2hvdWxkIGJlIHVwZGF0ZWQuCiAgICovCiAgYWRkTGF5ZXJVcGRhdGUodCkgewogICAgdGhpcy5sYXllclVwZGF0ZXMuYWRkKHQpOwogIH0KICAvKioKICAgKiBSZXNldHMgdGhlIGxheWVyIHVwZGF0ZXMgcmVnaXN0cnkuCiAgICovCiAgY2xlYXJMYXllclVwZGF0ZXMoKSB7CiAgICB0aGlzLmxheWVyVXBkYXRlcy5jbGVhcigpOwogIH0KfQpjbGFzcyB5diBleHRlbmRzIFJuIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGFycmF5IHJlbmRlciB0YXJnZXQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTFdIC0gVGhlIHdpZHRoIG9mIHRoZSByZW5kZXIgdGFyZ2V0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTFdIC0gVGhlIGhlaWdodCBvZiB0aGUgcmVuZGVyIHRhcmdldC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoPTFdIC0gVGhlIGhlaWdodCBvZiB0aGUgcmVuZGVyIHRhcmdldC4KICAgKiBAcGFyYW0ge1JlbmRlclRhcmdldH5PcHRpb25zfSBbb3B0aW9uc10gLSBUaGUgY29uZmlndXJhdGlvbiBvYmplY3QuCiAgICovCiAgY29uc3RydWN0b3IodCA9IDEsIGUgPSAxLCBpID0gMSwgbiA9IHt9KSB7CiAgICBzdXBlcih0LCBlLCBuKSwgdGhpcy5pc1dlYkdMQXJyYXlSZW5kZXJUYXJnZXQgPSAhMCwgdGhpcy5kZXB0aCA9IGksIHRoaXMudGV4dHVyZSA9IG5ldyBCYyhudWxsLCB0LCBlLCBpKSwgdGhpcy5fc2V0VGV4dHVyZU9wdGlvbnMobiksIHRoaXMudGV4dHVyZS5pc1JlbmRlclRhcmdldFRleHR1cmUgPSAhMDsKICB9Cn0KY2xhc3MgemMgZXh0ZW5kcyBOZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBkYXRhIGFycmF5IHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0gez9UeXBlZEFycmF5fSBbZGF0YT1udWxsXSAtIFRoZSBidWZmZXIgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTFdIC0gVGhlIHdpZHRoIG9mIHRoZSB0ZXh0dXJlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTFdIC0gVGhlIGhlaWdodCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoPTFdIC0gVGhlIGRlcHRoIG9mIHRoZSB0ZXh0dXJlLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBudWxsLCBlID0gMSwgaSA9IDEsIG4gPSAxKSB7CiAgICBzdXBlcihudWxsKSwgdGhpcy5pc0RhdGEzRFRleHR1cmUgPSAhMCwgdGhpcy5pbWFnZSA9IHsgZGF0YTogdCwgd2lkdGg6IGUsIGhlaWdodDogaSwgZGVwdGg6IG4gfSwgdGhpcy5tYWdGaWx0ZXIgPSBqZSwgdGhpcy5taW5GaWx0ZXIgPSBqZSwgdGhpcy53cmFwUiA9IFNpLCB0aGlzLmdlbmVyYXRlTWlwbWFwcyA9ICExLCB0aGlzLmZsaXBZID0gITEsIHRoaXMudW5wYWNrQWxpZ25tZW50ID0gMTsKICB9Cn0KY2xhc3MgX3YgZXh0ZW5kcyBSbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzRCByZW5kZXIgdGFyZ2V0LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0xXSAtIFRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRhcmdldC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodD0xXSAtIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0YXJnZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkZXB0aD0xXSAtIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0YXJnZXQuCiAgICogQHBhcmFtIHtSZW5kZXJUYXJnZXR+T3B0aW9uc30gW29wdGlvbnNdIC0gVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMSwgaSA9IDEsIG4gPSB7fSkgewogICAgc3VwZXIodCwgZSwgbiksIHRoaXMuaXNXZWJHTDNEUmVuZGVyVGFyZ2V0ID0gITAsIHRoaXMuZGVwdGggPSBpLCB0aGlzLnRleHR1cmUgPSBuZXcgemMobnVsbCwgdCwgZSwgaSksIHRoaXMuX3NldFRleHR1cmVPcHRpb25zKG4pLCB0aGlzLnRleHR1cmUuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID0gITA7CiAgfQp9CmxldCB3ZSA9IGNsYXNzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJvdW5kaW5nIGJveC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gW21pbj0oSW5maW5pdHksSW5maW5pdHksSW5maW5pdHkpXSAtIEEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgbG93ZXIgYm91bmRhcnkgb2YgdGhlIGJveC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFttYXg9KC1JbmZpbml0eSwtSW5maW5pdHksLUluZmluaXR5KV0gLSBBIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIHVwcGVyIGJvdW5kYXJ5IG9mIHRoZSBib3guCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBFKDEgLyAwLCAxIC8gMCwgMSAvIDApLCBlID0gbmV3IEUoLTEgLyAwLCAtMSAvIDAsIC0xIC8gMCkpIHsKICAgIHRoaXMuaXNCb3gzID0gITAsIHRoaXMubWluID0gdCwgdGhpcy5tYXggPSBlOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBsb3dlciBhbmQgdXBwZXIgYm91bmRhcmllcyBvZiB0aGlzIGJveC4KICAgKiBQbGVhc2Ugbm90ZSB0aGF0IHRoaXMgbWV0aG9kIG9ubHkgY29waWVzIHRoZSB2YWx1ZXMgZnJvbSB0aGUgZ2l2ZW4gb2JqZWN0cy4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gbWluIC0gVGhlIGxvd2VyIGJvdW5kYXJ5IG9mIHRoZSBib3guCiAgICogQHBhcmFtIHtWZWN0b3IzfSBtYXggLSBUaGUgdXBwZXIgYm91bmRhcnkgb2YgdGhlIGJveC4KICAgKiBAcmV0dXJuIHtCb3gzfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICBzZXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMubWluLmNvcHkodCksIHRoaXMubWF4LmNvcHkoZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHVwcGVyIGFuZCBsb3dlciBib3VuZHMgb2YgdGhpcyBib3ggc28gaXQgZW5jbG9zZXMgdGhlIHBvc2l0aW9uIGRhdGEKICAgKiBpbiB0aGUgZ2l2ZW4gYXJyYXkuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGFycmF5IC0gQW4gYXJyYXkgaG9sZGluZyAzRCBwb3NpdGlvbiBkYXRhLgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHNldEZyb21BcnJheSh0KSB7CiAgICB0aGlzLm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0Lmxlbmd0aDsgZSA8IGk7IGUgKz0gMykKICAgICAgdGhpcy5leHBhbmRCeVBvaW50KFppLmZyb21BcnJheSh0LCBlKSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdXBwZXIgYW5kIGxvd2VyIGJvdW5kcyBvZiB0aGlzIGJveCBzbyBpdCBlbmNsb3NlcyB0aGUgcG9zaXRpb24gZGF0YQogICAqIGluIHRoZSBnaXZlbiBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJBdHRyaWJ1dGV9IGF0dHJpYnV0ZSAtIEEgYnVmZmVyIGF0dHJpYnV0ZSBob2xkaW5nIDNEIHBvc2l0aW9uIGRhdGEuCiAgICogQHJldHVybiB7Qm94M30gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZSh0KSB7CiAgICB0aGlzLm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0LmNvdW50OyBlIDwgaTsgZSsrKQogICAgICB0aGlzLmV4cGFuZEJ5UG9pbnQoWmkuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdXBwZXIgYW5kIGxvd2VyIGJvdW5kcyBvZiB0aGlzIGJveCBzbyBpdCBlbmNsb3NlcyB0aGUgcG9zaXRpb24gZGF0YQogICAqIGluIHRoZSBnaXZlbiBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMz59IHBvaW50cyAtIEFuIGFycmF5IGhvbGRpbmcgM0QgcG9zaXRpb24gZGF0YSBhcyBpbnN0YW5jZXMgb2Yge0BsaW5rIFZlY3RvcjN9LgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHNldEZyb21Qb2ludHModCkgewogICAgdGhpcy5tYWtlRW1wdHkoKTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5sZW5ndGg7IGUgPCBpOyBlKyspCiAgICAgIHRoaXMuZXhwYW5kQnlQb2ludCh0W2VdKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBDZW50ZXJzIHRoaXMgYm94IG9uIHRoZSBnaXZlbiBjZW50ZXIgdmVjdG9yIGFuZCBzZXRzIHRoaXMgYm94J3Mgd2lkdGgsIGhlaWdodCBhbmQKICAgKiBkZXB0aCB0byB0aGUgZ2l2ZW4gc2l6ZSB2YWx1ZXMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGNlbnRlciAtIFRoZSBjZW50ZXIgb2YgdGhlIGJveC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHNpemUgLSBUaGUgeCwgeSBhbmQgeiBkaW1lbnNpb25zIG9mIHRoZSBib3guCiAgICogQHJldHVybiB7Qm94M30gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgc2V0RnJvbUNlbnRlckFuZFNpemUodCwgZSkgewogICAgY29uc3QgaSA9IFppLmNvcHkoZSkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgIHJldHVybiB0aGlzLm1pbi5jb3B5KHQpLnN1YihpKSwgdGhpcy5tYXguY29weSh0KS5hZGQoaSksIHRoaXM7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSB3b3JsZC1heGlzLWFsaWduZWQgYm91bmRpbmcgYm94IGZvciB0aGUgZ2l2ZW4gM0Qgb2JqZWN0CiAgICogKGluY2x1ZGluZyBpdHMgY2hpbGRyZW4pLCBhY2NvdW50aW5nIGZvciB0aGUgb2JqZWN0J3MsIGFuZCBjaGlsZHJlbidzLAogICAqIHdvcmxkIHRyYW5zZm9ybXMuIFRoZSBmdW5jdGlvbiBtYXkgcmVzdWx0IGluIGEgbGFyZ2VyIGJveCB0aGFuIHN0cmljdGx5IG5lY2Vzc2FyeS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QgdG8gY29tcHV0ZSB0aGUgYm91bmRpbmcgYm94IGZvci4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtwcmVjaXNlPWZhbHNlXSAtIElmIHNldCB0byBgdHJ1ZWAsIHRoZSBtZXRob2QgY29tcHV0ZXMgdGhlIHNtYWxsZXN0CiAgICogd29ybGQtYXhpcy1hbGlnbmVkIGJvdW5kaW5nIGJveCBhdCB0aGUgZXhwZW5zZSBvZiBtb3JlIGNvbXB1dGF0aW9uLgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHNldEZyb21PYmplY3QodCwgZSA9ICExKSB7CiAgICByZXR1cm4gdGhpcy5tYWtlRW1wdHkoKSwgdGhpcy5leHBhbmRCeU9iamVjdCh0LCBlKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBib3ggd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge0JveDN9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBib3ggdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7Qm94M30gYm94IC0gVGhlIGJveCB0byBjb3B5LgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMubWluLmNvcHkodC5taW4pLCB0aGlzLm1heC5jb3B5KHQubWF4KSwgdGhpczsKICB9CiAgLyoqCiAgICogTWFrZXMgdGhpcyBib3ggZW1wdHkgd2hpY2ggbWVhbnMgaW4gZW5jbG9zZXMgYSB6ZXJvIHNwYWNlIGluIDNELgogICAqCiAgICogQHJldHVybiB7Qm94M30gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgbWFrZUVtcHR5KCkgewogICAgcmV0dXJuIHRoaXMubWluLnggPSB0aGlzLm1pbi55ID0gdGhpcy5taW4ueiA9IDEgLyAwLCB0aGlzLm1heC54ID0gdGhpcy5tYXgueSA9IHRoaXMubWF4LnogPSAtMSAvIDAsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGlzIGJveCBpbmNsdWRlcyB6ZXJvIHBvaW50cyB3aXRoaW4gaXRzIGJvdW5kcy4KICAgKiBOb3RlIHRoYXQgYSBib3ggd2l0aCBlcXVhbCBsb3dlciBhbmQgdXBwZXIgYm91bmRzIHN0aWxsIGluY2x1ZGVzIG9uZQogICAqIHBvaW50LCB0aGUgb25lIGJvdGggYm91bmRzIHNoYXJlLgogICAqCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIGJveCBpcyBlbXB0eSBvciBub3QuCiAgICovCiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLm1heC54IDwgdGhpcy5taW4ueCB8fCB0aGlzLm1heC55IDwgdGhpcy5taW4ueSB8fCB0aGlzLm1heC56IDwgdGhpcy5taW4uejsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY2VudGVyIHBvaW50IG9mIHRoaXMgYm94LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY2VudGVyIHBvaW50LgogICAqLwogIGdldENlbnRlcih0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0LnNldCgwLCAwLCAwKSA6IHQuYWRkVmVjdG9ycyh0aGlzLm1pbiwgdGhpcy5tYXgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGRpbWVuc2lvbnMgb2YgdGhpcyBib3guCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSBzaXplLgogICAqLwogIGdldFNpemUodCkgewogICAgcmV0dXJuIHRoaXMuaXNFbXB0eSgpID8gdC5zZXQoMCwgMCwgMCkgOiB0LnN1YlZlY3RvcnModGhpcy5tYXgsIHRoaXMubWluKTsKICB9CiAgLyoqCiAgICogRXhwYW5kcyB0aGUgYm91bmRhcmllcyBvZiB0aGlzIGJveCB0byBpbmNsdWRlIHRoZSBnaXZlbiBwb2ludC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBUaGUgcG9pbnQgdGhhdCBzaG91bGQgYmUgaW5jbHVkZWQgYnkgdGhlIGJvdW5kaW5nIGJveC4KICAgKiBAcmV0dXJuIHtCb3gzfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICBleHBhbmRCeVBvaW50KHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi5taW4odCksIHRoaXMubWF4Lm1heCh0KSwgdGhpczsKICB9CiAgLyoqCiAgICogRXhwYW5kcyB0aGlzIGJveCBlcXVpbGF0ZXJhbGx5IGJ5IHRoZSBnaXZlbiB2ZWN0b3IuIFRoZSB3aWR0aCBvZiB0aGlzCiAgICogYm94IHdpbGwgYmUgZXhwYW5kZWQgYnkgdGhlIHggY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgaW4gYm90aAogICAqIGRpcmVjdGlvbnMuIFRoZSBoZWlnaHQgb2YgdGhpcyBib3ggd2lsbCBiZSBleHBhbmRlZCBieSB0aGUgeSBjb21wb25lbnQgb2YKICAgKiB0aGUgdmVjdG9yIGluIGJvdGggZGlyZWN0aW9ucy4gVGhlIGRlcHRoIG9mIHRoaXMgYm94IHdpbGwgYmUKICAgKiBleHBhbmRlZCBieSB0aGUgeiBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBpbiBib3RoIGRpcmVjdGlvbnMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHZlY3RvciAtIFRoZSB2ZWN0b3IgdGhhdCBzaG91bGQgZXhwYW5kIHRoZSBib3VuZGluZyBib3guCiAgICogQHJldHVybiB7Qm94M30gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgZXhwYW5kQnlWZWN0b3IodCkgewogICAgcmV0dXJuIHRoaXMubWluLnN1Yih0KSwgdGhpcy5tYXguYWRkKHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBFeHBhbmRzIGVhY2ggZGltZW5zaW9uIG9mIHRoZSBib3ggYnkgdGhlIGdpdmVuIHNjYWxhci4gSWYgbmVnYXRpdmUsIHRoZQogICAqIGRpbWVuc2lvbnMgb2YgdGhlIGJveCB3aWxsIGJlIGNvbnRyYWN0ZWQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGFyIC0gVGhlIHNjYWxhciB2YWx1ZSB0aGF0IHNob3VsZCBleHBhbmQgdGhlIGJvdW5kaW5nIGJveC4KICAgKiBAcmV0dXJuIHtCb3gzfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICBleHBhbmRCeVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy5taW4uYWRkU2NhbGFyKC10KSwgdGhpcy5tYXguYWRkU2NhbGFyKHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBFeHBhbmRzIHRoZSBib3VuZGFyaWVzIG9mIHRoaXMgYm94IHRvIGluY2x1ZGUgdGhlIGdpdmVuIDNEIG9iamVjdCBhbmQKICAgKiBpdHMgY2hpbGRyZW4sIGFjY291bnRpbmcgZm9yIHRoZSBvYmplY3QncywgYW5kIGNoaWxkcmVuJ3MsIHdvcmxkCiAgICogdHJhbnNmb3Jtcy4gVGhlIGZ1bmN0aW9uIG1heSByZXN1bHQgaW4gYSBsYXJnZXIgYm94IHRoYW4gc3RyaWN0bHkKICAgKiBuZWNlc3NhcnkgKHVubGVzcyB0aGUgcHJlY2lzZSBwYXJhbWV0ZXIgaXMgc2V0IHRvIHRydWUpLgogICAqCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdCB0aGF0IHNob3VsZCBleHBhbmQgdGhlIGJvdW5kaW5nIGJveC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IHByZWNpc2UgLSBJZiBzZXQgdG8gYHRydWVgLCB0aGUgbWV0aG9kIGV4cGFuZHMgdGhlIGJvdW5kaW5nIGJveAogICAqIGFzIGxpdHRsZSBhcyBuZWNlc3NhcnkgYXQgdGhlIGV4cGVuc2Ugb2YgbW9yZSBjb21wdXRhdGlvbi4KICAgKiBAcmV0dXJuIHtCb3gzfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICBleHBhbmRCeU9iamVjdCh0LCBlID0gITEpIHsKICAgIHQudXBkYXRlV29ybGRNYXRyaXgoITEsICExKTsKICAgIGNvbnN0IGkgPSB0Lmdlb21ldHJ5OwogICAgaWYgKGkgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBzID0gaS5nZXRBdHRyaWJ1dGUoInBvc2l0aW9uIik7CiAgICAgIGlmIChlID09PSAhMCAmJiBzICE9PSB2b2lkIDAgJiYgdC5pc0luc3RhbmNlZE1lc2ggIT09ICEwKQogICAgICAgIGZvciAobGV0IHIgPSAwLCBvID0gcy5jb3VudDsgciA8IG87IHIrKykKICAgICAgICAgIHQuaXNNZXNoID09PSAhMCA/IHQuZ2V0VmVydGV4UG9zaXRpb24ociwgWmkpIDogWmkuZnJvbUJ1ZmZlckF0dHJpYnV0ZShzLCByKSwgWmkuYXBwbHlNYXRyaXg0KHQubWF0cml4V29ybGQpLCB0aGlzLmV4cGFuZEJ5UG9pbnQoWmkpOwogICAgICBlbHNlCiAgICAgICAgdC5ib3VuZGluZ0JveCAhPT0gdm9pZCAwID8gKHQuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgdC5jb21wdXRlQm91bmRpbmdCb3goKSwgWm8uY29weSh0LmJvdW5kaW5nQm94KSkgOiAoaS5ib3VuZGluZ0JveCA9PT0gbnVsbCAmJiBpLmNvbXB1dGVCb3VuZGluZ0JveCgpLCBaby5jb3B5KGkuYm91bmRpbmdCb3gpKSwgWm8uYXBwbHlNYXRyaXg0KHQubWF0cml4V29ybGQpLCB0aGlzLnVuaW9uKFpvKTsKICAgIH0KICAgIGNvbnN0IG4gPSB0LmNoaWxkcmVuOwogICAgZm9yIChsZXQgcyA9IDAsIHIgPSBuLmxlbmd0aDsgcyA8IHI7IHMrKykKICAgICAgdGhpcy5leHBhbmRCeU9iamVjdChuW3NdLCBlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gcG9pbnQgbGllcyB3aXRoaW4gb3Igb24gdGhlIGJvdW5kYXJpZXMgb2YgdGhpcyBib3guCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBvaW50IHRvIHRlc3QuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgYm91bmRpbmcgYm94IGNvbnRhaW5zIHRoZSBnaXZlbiBwb2ludCBvciBub3QuCiAgICovCiAgY29udGFpbnNQb2ludCh0KSB7CiAgICByZXR1cm4gdC54ID49IHRoaXMubWluLnggJiYgdC54IDw9IHRoaXMubWF4LnggJiYgdC55ID49IHRoaXMubWluLnkgJiYgdC55IDw9IHRoaXMubWF4LnkgJiYgdC56ID49IHRoaXMubWluLnogJiYgdC56IDw9IHRoaXMubWF4Lno7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgYm91bmRpbmcgYm94IGluY2x1ZGVzIHRoZSBlbnRpcmV0eSBvZiB0aGUgZ2l2ZW4gYm91bmRpbmcgYm94LgogICAqIElmIHRoaXMgYm94IGFuZCB0aGUgZ2l2ZW4gb25lIGFyZSBpZGVudGljYWwsIHRoaXMgZnVuY3Rpb24gYWxzbyByZXR1cm5zIGB0cnVlYC4KICAgKgogICAqIEBwYXJhbSB7Qm94M30gYm94IC0gVGhlIGJvdW5kaW5nIGJveCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGJvdW5kaW5nIGJveCBjb250YWlucyB0aGUgZ2l2ZW4gYm91bmRpbmcgYm94IG9yIG5vdC4KICAgKi8KICBjb250YWluc0JveCh0KSB7CiAgICByZXR1cm4gdGhpcy5taW4ueCA8PSB0Lm1pbi54ICYmIHQubWF4LnggPD0gdGhpcy5tYXgueCAmJiB0aGlzLm1pbi55IDw9IHQubWluLnkgJiYgdC5tYXgueSA8PSB0aGlzLm1heC55ICYmIHRoaXMubWluLnogPD0gdC5taW4ueiAmJiB0Lm1heC56IDw9IHRoaXMubWF4Lno7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBwb2ludCBhcyBhIHByb3BvcnRpb24gb2YgdGhpcyBib3gncyB3aWR0aCwgaGVpZ2h0IGFuZCBkZXB0aC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBBIHBvaW50IGluIDNEIHNwYWNlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSBwb2ludCBhcyBhIHByb3BvcnRpb24gb2YgdGhpcyBib3gncyB3aWR0aCwgaGVpZ2h0IGFuZCBkZXB0aC4KICAgKi8KICBnZXRQYXJhbWV0ZXIodCwgZSkgewogICAgcmV0dXJuIGUuc2V0KAogICAgICAodC54IC0gdGhpcy5taW4ueCkgLyAodGhpcy5tYXgueCAtIHRoaXMubWluLngpLAogICAgICAodC55IC0gdGhpcy5taW4ueSkgLyAodGhpcy5tYXgueSAtIHRoaXMubWluLnkpLAogICAgICAodC56IC0gdGhpcy5taW4ueikgLyAodGhpcy5tYXgueiAtIHRoaXMubWluLnopCiAgICApOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gYm91bmRpbmcgYm94IGludGVyc2VjdHMgd2l0aCB0aGlzIGJvdW5kaW5nIGJveC4KICAgKgogICAqIEBwYXJhbSB7Qm94M30gYm94IC0gVGhlIGJvdW5kaW5nIGJveCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGdpdmVuIGJvdW5kaW5nIGJveCBpbnRlcnNlY3RzIHdpdGggdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgaW50ZXJzZWN0c0JveCh0KSB7CiAgICByZXR1cm4gdC5tYXgueCA+PSB0aGlzLm1pbi54ICYmIHQubWluLnggPD0gdGhpcy5tYXgueCAmJiB0Lm1heC55ID49IHRoaXMubWluLnkgJiYgdC5taW4ueSA8PSB0aGlzLm1heC55ICYmIHQubWF4LnogPj0gdGhpcy5taW4ueiAmJiB0Lm1pbi56IDw9IHRoaXMubWF4Lno7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiBib3VuZGluZyBzcGhlcmUgaW50ZXJzZWN0cyB3aXRoIHRoaXMgYm91bmRpbmcgYm94LgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBib3VuZGluZyBzcGhlcmUgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBnaXZlbiBib3VuZGluZyBzcGhlcmUgaW50ZXJzZWN0cyB3aXRoIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGludGVyc2VjdHNTcGhlcmUodCkgewogICAgcmV0dXJuIHRoaXMuY2xhbXBQb2ludCh0LmNlbnRlciwgWmkpLCBaaS5kaXN0YW5jZVRvU3F1YXJlZCh0LmNlbnRlcikgPD0gdC5yYWRpdXMgKiB0LnJhZGl1czsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHBsYW5lIGludGVyc2VjdHMgd2l0aCB0aGlzIGJvdW5kaW5nIGJveC4KICAgKgogICAqIEBwYXJhbSB7UGxhbmV9IHBsYW5lIC0gVGhlIHBsYW5lIHRvIHRlc3QuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZ2l2ZW4gcGxhbmUgaW50ZXJzZWN0cyB3aXRoIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGludGVyc2VjdHNQbGFuZSh0KSB7CiAgICBsZXQgZSwgaTsKICAgIHJldHVybiB0Lm5vcm1hbC54ID4gMCA/IChlID0gdC5ub3JtYWwueCAqIHRoaXMubWluLngsIGkgPSB0Lm5vcm1hbC54ICogdGhpcy5tYXgueCkgOiAoZSA9IHQubm9ybWFsLnggKiB0aGlzLm1heC54LCBpID0gdC5ub3JtYWwueCAqIHRoaXMubWluLngpLCB0Lm5vcm1hbC55ID4gMCA/IChlICs9IHQubm9ybWFsLnkgKiB0aGlzLm1pbi55LCBpICs9IHQubm9ybWFsLnkgKiB0aGlzLm1heC55KSA6IChlICs9IHQubm9ybWFsLnkgKiB0aGlzLm1heC55LCBpICs9IHQubm9ybWFsLnkgKiB0aGlzLm1pbi55KSwgdC5ub3JtYWwueiA+IDAgPyAoZSArPSB0Lm5vcm1hbC56ICogdGhpcy5taW4ueiwgaSArPSB0Lm5vcm1hbC56ICogdGhpcy5tYXgueikgOiAoZSArPSB0Lm5vcm1hbC56ICogdGhpcy5tYXgueiwgaSArPSB0Lm5vcm1hbC56ICogdGhpcy5taW4ueiksIGUgPD0gLXQuY29uc3RhbnQgJiYgaSA+PSAtdC5jb25zdGFudDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHRyaWFuZ2xlIGludGVyc2VjdHMgd2l0aCB0aGlzIGJvdW5kaW5nIGJveC4KICAgKgogICAqIEBwYXJhbSB7VHJpYW5nbGV9IHRyaWFuZ2xlIC0gVGhlIHRyaWFuZ2xlIHRvIHRlc3QuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZ2l2ZW4gdHJpYW5nbGUgaW50ZXJzZWN0cyB3aXRoIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGludGVyc2VjdHNUcmlhbmdsZSh0KSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpCiAgICAgIHJldHVybiAhMTsKICAgIHRoaXMuZ2V0Q2VudGVyKEJhKSwgam8uc3ViVmVjdG9ycyh0aGlzLm1heCwgQmEpLCBici5zdWJWZWN0b3JzKHQuYSwgQmEpLCBNci5zdWJWZWN0b3JzKHQuYiwgQmEpLCBTci5zdWJWZWN0b3JzKHQuYywgQmEpLCBycy5zdWJWZWN0b3JzKE1yLCBiciksIGFzLnN1YlZlY3RvcnMoU3IsIE1yKSwgTnMuc3ViVmVjdG9ycyhiciwgU3IpOwogICAgbGV0IGUgPSBbCiAgICAgIDAsCiAgICAgIC1ycy56LAogICAgICBycy55LAogICAgICAwLAogICAgICAtYXMueiwKICAgICAgYXMueSwKICAgICAgMCwKICAgICAgLU5zLnosCiAgICAgIE5zLnksCiAgICAgIHJzLnosCiAgICAgIDAsCiAgICAgIC1ycy54LAogICAgICBhcy56LAogICAgICAwLAogICAgICAtYXMueCwKICAgICAgTnMueiwKICAgICAgMCwKICAgICAgLU5zLngsCiAgICAgIC1ycy55LAogICAgICBycy54LAogICAgICAwLAogICAgICAtYXMueSwKICAgICAgYXMueCwKICAgICAgMCwKICAgICAgLU5zLnksCiAgICAgIE5zLngsCiAgICAgIDAKICAgIF07CiAgICByZXR1cm4gIWJ1KGUsIGJyLCBNciwgU3IsIGpvKSB8fCAoZSA9IFsxLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAxXSwgIWJ1KGUsIGJyLCBNciwgU3IsIGpvKSkgPyAhMSA6IChKby5jcm9zc1ZlY3RvcnMocnMsIGFzKSwgZSA9IFtKby54LCBKby55LCBKby56XSwgYnUoZSwgYnIsIE1yLCBTciwgam8pKTsKICB9CiAgLyoqCiAgICogQ2xhbXBzIHRoZSBnaXZlbiBwb2ludCB3aXRoaW4gdGhlIGJvdW5kcyBvZiB0aGlzIGJveC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBUaGUgcG9pbnQgdG8gY2xhbXAuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY2xhbXBlZCBwb2ludC4KICAgKi8KICBjbGFtcFBvaW50KHQsIGUpIHsKICAgIHJldHVybiBlLmNvcHkodCkuY2xhbXAodGhpcy5taW4sIHRoaXMubWF4KTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZXVjbGlkZWFuIGRpc3RhbmNlIGZyb20gYW55IGVkZ2Ugb2YgdGhpcyBib3ggdG8gdGhlIHNwZWNpZmllZCBwb2ludC4gSWYKICAgKiB0aGUgZ2l2ZW4gcG9pbnQgbGllcyBpbnNpZGUgb2YgdGhpcyBib3gsIHRoZSBkaXN0YW5jZSB3aWxsIGJlIGAwYC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBUaGUgcG9pbnQgdG8gY29tcHV0ZSB0aGUgZGlzdGFuY2UgdG8uCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZXVjbGlkZWFuIGRpc3RhbmNlLgogICAqLwogIGRpc3RhbmNlVG9Qb2ludCh0KSB7CiAgICByZXR1cm4gdGhpcy5jbGFtcFBvaW50KHQsIFppKS5kaXN0YW5jZVRvKHQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgYm91bmRpbmcgc3BoZXJlIHRoYXQgZW5jbG9zZXMgdGhpcyBib3VuZGluZyBib3guCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyZX0gdGFyZ2V0IC0gVGhlIHRhcmdldCBzcGhlcmUgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7U3BoZXJlfSBUaGUgYm91bmRpbmcgc3BoZXJlIHRoYXQgZW5jbG9zZXMgdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgZ2V0Qm91bmRpbmdTcGhlcmUodCkgewogICAgcmV0dXJuIHRoaXMuaXNFbXB0eSgpID8gdC5tYWtlRW1wdHkoKSA6ICh0aGlzLmdldENlbnRlcih0LmNlbnRlciksIHQucmFkaXVzID0gdGhpcy5nZXRTaXplKFppKS5sZW5ndGgoKSAqIDAuNSksIHQ7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhpcyBib3VuZGluZyBib3ggYW5kIHRoZSBnaXZlbiBvbmUsIHNldHRpbmcgdGhlIHVwcGVyCiAgICogYm91bmQgb2YgdGhpcyBib3ggdG8gdGhlIGxlc3NlciBvZiB0aGUgdHdvIGJveGVzJyB1cHBlciBib3VuZHMgYW5kIHRoZQogICAqIGxvd2VyIGJvdW5kIG9mIHRoaXMgYm94IHRvIHRoZSBncmVhdGVyIG9mIHRoZSB0d28gYm94ZXMnIGxvd2VyIGJvdW5kcy4gSWYKICAgKiB0aGVyZSdzIG5vIG92ZXJsYXAsIG1ha2VzIHRoaXMgYm94IGVtcHR5LgogICAqCiAgICogQHBhcmFtIHtCb3gzfSBib3ggLSBUaGUgYm91bmRpbmcgYm94IHRvIGludGVyc2VjdCB3aXRoLgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGludGVyc2VjdCh0KSB7CiAgICByZXR1cm4gdGhpcy5taW4ubWF4KHQubWluKSwgdGhpcy5tYXgubWluKHQubWF4KSwgdGhpcy5pc0VtcHR5KCkgJiYgdGhpcy5tYWtlRW1wdHkoKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHVuaW9uIG9mIHRoaXMgYm94IGFuZCBhbm90aGVyIGFuZCB0aGUgZ2l2ZW4gb25lLCBzZXR0aW5nIHRoZSB1cHBlcgogICAqIGJvdW5kIG9mIHRoaXMgYm94IHRvIHRoZSBncmVhdGVyIG9mIHRoZSB0d28gYm94ZXMnIHVwcGVyIGJvdW5kcyBhbmQgdGhlCiAgICogbG93ZXIgYm91bmQgb2YgdGhpcyBib3ggdG8gdGhlIGxlc3NlciBvZiB0aGUgdHdvIGJveGVzJyBsb3dlciBib3VuZHMuCiAgICoKICAgKiBAcGFyYW0ge0JveDN9IGJveCAtIFRoZSBib3VuZGluZyBib3ggdGhhdCB3aWxsIGJlIHVuaW9uZWQgd2l0aCB0aGlzIGluc3RhbmNlLgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHVuaW9uKHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi5taW4odC5taW4pLCB0aGlzLm1heC5tYXgodC5tYXgpLCB0aGlzOwogIH0KICAvKioKICAgKiBUcmFuc2Zvcm1zIHRoaXMgYm91bmRpbmcgYm94IGJ5IHRoZSBnaXZlbiA0eDQgdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtYXRyaXggLSBUaGUgdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqIEByZXR1cm4ge0JveDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGFwcGx5TWF0cml4NCh0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0aGlzIDogKExuWzBdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1pbi55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIExuWzFdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1pbi55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIExuWzJdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1heC55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIExuWzNdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1heC55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIExuWzRdLnNldCh0aGlzLm1heC54LCB0aGlzLm1pbi55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIExuWzVdLnNldCh0aGlzLm1heC54LCB0aGlzLm1pbi55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIExuWzZdLnNldCh0aGlzLm1heC54LCB0aGlzLm1heC55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIExuWzddLnNldCh0aGlzLm1heC54LCB0aGlzLm1heC55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIHRoaXMuc2V0RnJvbVBvaW50cyhMbiksIHRoaXMpOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiBvZmZzZXQgdG8gYm90aCB0aGUgdXBwZXIgYW5kIGxvd2VyIGJvdW5kcyBvZiB0aGlzIGJvdW5kaW5nIGJveCwKICAgKiBlZmZlY3RpdmVseSBtb3ZpbmcgaXQgaW4gM0Qgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IG9mZnNldCAtIFRoZSBvZmZzZXQgdGhhdCBzaG91bGQgYmUgdXNlZCB0byB0cmFuc2xhdGUgdGhlIGJvdW5kaW5nIGJveC4KICAgKiBAcmV0dXJuIHtCb3gzfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICB0cmFuc2xhdGUodCkgewogICAgcmV0dXJuIHRoaXMubWluLmFkZCh0KSwgdGhpcy5tYXguYWRkKHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGJvdW5kaW5nIGJveCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge0JveDN9IGJveCAtIFRoZSBib3ggdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIGJvdW5kaW5nIGJveCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0Lm1pbi5lcXVhbHModGhpcy5taW4pICYmIHQubWF4LmVxdWFscyh0aGlzLm1heCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBzZXJpYWxpemVkIHN0cnVjdHVyZSBvZiB0aGUgYm91bmRpbmcgYm94LgogICAqCiAgICogQHJldHVybiB7T2JqZWN0fSBTZXJpYWxpemVkIHN0cnVjdHVyZSB3aXRoIGZpZWxkcyByZXByZXNlbnRpbmcgdGhlIG9iamVjdCBzdGF0ZS4KICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBtaW46IHRoaXMubWluLnRvQXJyYXkoKSwKICAgICAgbWF4OiB0aGlzLm1heC50b0FycmF5KCkKICAgIH07CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBzZXJpYWxpemVkIHN0cnVjdHVyZSBvZiB0aGUgYm91bmRpbmcgYm94LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgc2VyaWFsaXplZCBqc29uIHRvIHNldCB0aGUgYm94IGZyb20uCiAgICogQHJldHVybiB7Qm94M30gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgZnJvbUpTT04odCkgewogICAgcmV0dXJuIHRoaXMubWluLmZyb21BcnJheSh0Lm1pbiksIHRoaXMubWF4LmZyb21BcnJheSh0Lm1heCksIHRoaXM7CiAgfQp9Owpjb25zdCBMbiA9IFsKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoKQpdLCBaaSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBabyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgd2UoKSwgYnIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgTXIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgU3IgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgYXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgTnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgQmEgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgam8gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgSm8gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgT3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKZnVuY3Rpb24gYnUoYSwgdCwgZSwgaSwgbikgewogIGZvciAobGV0IHMgPSAwLCByID0gYS5sZW5ndGggLSAzOyBzIDw9IHI7IHMgKz0gMykgewogICAgT3MuZnJvbUFycmF5KGEsIHMpOwogICAgY29uc3QgbyA9IG4ueCAqIE1hdGguYWJzKE9zLngpICsgbi55ICogTWF0aC5hYnMoT3MueSkgKyBuLnogKiBNYXRoLmFicyhPcy56KSwgbCA9IHQuZG90KE9zKSwgaCA9IGUuZG90KE9zKSwgYyA9IGkuZG90KE9zKTsKICAgIGlmIChNYXRoLm1heCgtTWF0aC5tYXgobCwgaCwgYyksIE1hdGgubWluKGwsIGgsIGMpKSA+IG8pCiAgICAgIHJldHVybiAhMTsKICB9CiAgcmV0dXJuICEwOwp9CmNvbnN0IHh2ID0gLyogQF9fUFVSRV9fICovIG5ldyB3ZSgpLCB6YSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBNdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpOwpsZXQgUmUgPSBjbGFzcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBzcGhlcmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFtjZW50ZXI9KDAsMCwwKV0gLSBUaGUgY2VudGVyIG9mIHRoZSBzcGhlcmUKICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0tMV0gLSBUaGUgcmFkaXVzIG9mIHRoZSBzcGhlcmUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBFKCksIGUgPSAtMSkgewogICAgdGhpcy5pc1NwaGVyZSA9ICEwLCB0aGlzLmNlbnRlciA9IHQsIHRoaXMucmFkaXVzID0gZTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgc3BoZXJlJ3MgY29tcG9uZW50cyBieSBjb3B5aW5nIHRoZSBnaXZlbiB2YWx1ZXMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGNlbnRlciAtIFRoZSBjZW50ZXIuCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHJldHVybiB7U3BoZXJlfSBBIHJlZmVyZW5jZSB0byB0aGlzIHNwaGVyZS4KICAgKi8KICBzZXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMuY2VudGVyLmNvcHkodCksIHRoaXMucmFkaXVzID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIG1pbmltdW0gYm91bmRpbmcgc3BoZXJlIGZvciBsaXN0IG9mIHBvaW50cy4KICAgKiBJZiB0aGUgb3B0aW9uYWwgY2VudGVyIHBvaW50IGlzIGdpdmVuLCBpdCBpcyB1c2VkIGFzIHRoZSBzcGhlcmUncwogICAqIGNlbnRlci4gT3RoZXJ3aXNlLCB0aGUgY2VudGVyIG9mIHRoZSBheGlzLWFsaWduZWQgYm91bmRpbmcgYm94CiAgICogZW5jb21wYXNzaW5nIHRoZSBwb2ludHMgaXMgY2FsY3VsYXRlZC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMz59IHBvaW50cyAtIEEgbGlzdCBvZiBwb2ludHMgaW4gM0Qgc3BhY2UuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbb3B0aW9uYWxDZW50ZXJdIC0gVGhlIGNlbnRlciBvZiB0aGUgc3BoZXJlLgogICAqIEByZXR1cm4ge1NwaGVyZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmUuCiAgICovCiAgc2V0RnJvbVBvaW50cyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5jZW50ZXI7CiAgICBlICE9PSB2b2lkIDAgPyBpLmNvcHkoZSkgOiB4di5zZXRGcm9tUG9pbnRzKHQpLmdldENlbnRlcihpKTsKICAgIGxldCBuID0gMDsKICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgIG4gPSBNYXRoLm1heChuLCBpLmRpc3RhbmNlVG9TcXVhcmVkKHRbc10pKTsKICAgIHJldHVybiB0aGlzLnJhZGl1cyA9IE1hdGguc3FydChuKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHNwaGVyZSB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBzcGhlcmUgdG8gY29weS4KICAgKiBAcmV0dXJuIHtTcGhlcmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgc3BoZXJlLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuY2VudGVyLmNvcHkodC5jZW50ZXIpLCB0aGlzLnJhZGl1cyA9IHQucmFkaXVzLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgc3BoZXJlIGlzIGVtcHR5ICh0aGUgcmFkaXVzIHNldCB0byBhIG5lZ2F0aXZlIG51bWJlcikuCiAgICoKICAgKiBTcGhlcmVzIHdpdGggYSByYWRpdXMgb2YgYDBgIGNvbnRhaW4gb25seSB0aGVpciBjZW50ZXIgcG9pbnQgYW5kIGFyZSBub3QKICAgKiBjb25zaWRlcmVkIHRvIGJlIGVtcHR5LgogICAqCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIHNwaGVyZSBpcyBlbXB0eSBvciBub3QuCiAgICovCiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLnJhZGl1cyA8IDA7CiAgfQogIC8qKgogICAqIE1ha2VzIHRoaXMgc3BoZXJlIGVtcHR5IHdoaWNoIG1lYW5zIGluIGVuY2xvc2VzIGEgemVybyBzcGFjZSBpbiAzRC4KICAgKgogICAqIEByZXR1cm4ge1NwaGVyZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmUuCiAgICovCiAgbWFrZUVtcHR5KCkgewogICAgcmV0dXJuIHRoaXMuY2VudGVyLnNldCgwLCAwLCAwKSwgdGhpcy5yYWRpdXMgPSAtMSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyBzcGhlcmUgY29udGFpbnMgdGhlIGdpdmVuIHBvaW50IGluY2x1c2l2ZSBvZgogICAqIHRoZSBzdXJmYWNlIG9mIHRoZSBzcGhlcmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBvaW50IHRvIGNoZWNrLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyBzcGhlcmUgY29udGFpbnMgdGhlIGdpdmVuIHBvaW50IG9yIG5vdC4KICAgKi8KICBjb250YWluc1BvaW50KHQpIHsKICAgIHJldHVybiB0LmRpc3RhbmNlVG9TcXVhcmVkKHRoaXMuY2VudGVyKSA8PSB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjbG9zZXN0IGRpc3RhbmNlIGZyb20gdGhlIGJvdW5kYXJ5IG9mIHRoZSBzcGhlcmUgdG8gdGhlCiAgICogZ2l2ZW4gcG9pbnQuIElmIHRoZSBzcGhlcmUgY29udGFpbnMgdGhlIHBvaW50LCB0aGUgZGlzdGFuY2Ugd2lsbAogICAqIGJlIG5lZ2F0aXZlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwb2ludCAtIFRoZSBwb2ludCB0byBjb21wdXRlIHRoZSBkaXN0YW5jZSB0by4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSB0byB0aGUgcG9pbnQuCiAgICovCiAgZGlzdGFuY2VUb1BvaW50KHQpIHsKICAgIHJldHVybiB0LmRpc3RhbmNlVG8odGhpcy5jZW50ZXIpIC0gdGhpcy5yYWRpdXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgc3BoZXJlIGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBzcGhlcmUgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgc3BoZXJlIGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gb25lIG9yIG5vdC4KICAgKi8KICBpbnRlcnNlY3RzU3BoZXJlKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnJhZGl1cyArIHQucmFkaXVzOwogICAgcmV0dXJuIHQuY2VudGVyLmRpc3RhbmNlVG9TcXVhcmVkKHRoaXMuY2VudGVyKSA8PSBlICogZTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyBzcGhlcmUgaW50ZXJzZWN0cyB3aXRoIHRoZSBnaXZlbiBib3guCiAgICoKICAgKiBAcGFyYW0ge0JveDN9IGJveCAtIFRoZSBib3ggdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgc3BoZXJlIGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gYm94IG9yIG5vdC4KICAgKi8KICBpbnRlcnNlY3RzQm94KHQpIHsKICAgIHJldHVybiB0LmludGVyc2VjdHNTcGhlcmUodGhpcyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgc3BoZXJlIGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gcGxhbmUuCiAgICoKICAgKiBAcGFyYW0ge1BsYW5lfSBwbGFuZSAtIFRoZSBwbGFuZSB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyBzcGhlcmUgaW50ZXJzZWN0cyB3aXRoIHRoZSBnaXZlbiBwbGFuZSBvciBub3QuCiAgICovCiAgaW50ZXJzZWN0c1BsYW5lKHQpIHsKICAgIHJldHVybiBNYXRoLmFicyh0LmRpc3RhbmNlVG9Qb2ludCh0aGlzLmNlbnRlcikpIDw9IHRoaXMucmFkaXVzOwogIH0KICAvKioKICAgKiBDbGFtcHMgYSBwb2ludCB3aXRoaW4gdGhlIHNwaGVyZS4gSWYgdGhlIHBvaW50IGlzIG91dHNpZGUgdGhlIHNwaGVyZSwgaXQKICAgKiB3aWxsIGNsYW1wIGl0IHRvIHRoZSBjbG9zZXN0IHBvaW50IG9uIHRoZSBlZGdlIG9mIHRoZSBzcGhlcmUuIFBvaW50cwogICAqIGFscmVhZHkgaW5zaWRlIHRoZSBzcGhlcmUgd2lsbCBub3QgYmUgYWZmZWN0ZWQuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBsYW5lIHRvIGNsYW1wLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIGNsYW1wZWQgcG9pbnQuCiAgICovCiAgY2xhbXBQb2ludCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5jZW50ZXIuZGlzdGFuY2VUb1NxdWFyZWQodCk7CiAgICByZXR1cm4gZS5jb3B5KHQpLCBpID4gdGhpcy5yYWRpdXMgKiB0aGlzLnJhZGl1cyAmJiAoZS5zdWIodGhpcy5jZW50ZXIpLm5vcm1hbGl6ZSgpLCBlLm11bHRpcGx5U2NhbGFyKHRoaXMucmFkaXVzKS5hZGQodGhpcy5jZW50ZXIpKSwgZTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIGJvdW5kaW5nIGJveCB0aGF0IGVuY2xvc2VzIHRoaXMgc3BoZXJlLgogICAqCiAgICogQHBhcmFtIHtCb3gzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IGJveCB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtCb3gzfSBUaGUgYm91bmRpbmcgYm94IHRoYXQgZW5jbG9zZXMgdGhpcyBzcGhlcmUuCiAgICovCiAgZ2V0Qm91bmRpbmdCb3godCkgewogICAgcmV0dXJuIHRoaXMuaXNFbXB0eSgpID8gKHQubWFrZUVtcHR5KCksIHQpIDogKHQuc2V0KHRoaXMuY2VudGVyLCB0aGlzLmNlbnRlciksIHQuZXhwYW5kQnlTY2FsYXIodGhpcy5yYWRpdXMpLCB0KTsKICB9CiAgLyoqCiAgICogVHJhbnNmb3JtcyB0aGlzIHNwaGVyZSB3aXRoIHRoZSBnaXZlbiA0eDQgdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtYXRyaXggLSBUaGUgdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqIEByZXR1cm4ge1NwaGVyZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmUuCiAgICovCiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIHJldHVybiB0aGlzLmNlbnRlci5hcHBseU1hdHJpeDQodCksIHRoaXMucmFkaXVzID0gdGhpcy5yYWRpdXMgKiB0LmdldE1heFNjYWxlT25BeGlzKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFRyYW5zbGF0ZXMgdGhlIHNwaGVyZSdzIGNlbnRlciBieSB0aGUgZ2l2ZW4gb2Zmc2V0LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBvZmZzZXQgLSBUaGUgb2Zmc2V0LgogICAqIEByZXR1cm4ge1NwaGVyZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmUuCiAgICovCiAgdHJhbnNsYXRlKHQpIHsKICAgIHJldHVybiB0aGlzLmNlbnRlci5hZGQodCksIHRoaXM7CiAgfQogIC8qKgogICAqIEV4cGFuZHMgdGhlIGJvdW5kYXJpZXMgb2YgdGhpcyBzcGhlcmUgdG8gaW5jbHVkZSB0aGUgZ2l2ZW4gcG9pbnQuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBvaW50IHRvIGluY2x1ZGUuCiAgICogQHJldHVybiB7U3BoZXJlfSBBIHJlZmVyZW5jZSB0byB0aGlzIHNwaGVyZS4KICAgKi8KICBleHBhbmRCeVBvaW50KHQpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkKICAgICAgcmV0dXJuIHRoaXMuY2VudGVyLmNvcHkodCksIHRoaXMucmFkaXVzID0gMCwgdGhpczsKICAgIHphLnN1YlZlY3RvcnModCwgdGhpcy5jZW50ZXIpOwogICAgY29uc3QgZSA9IHphLmxlbmd0aFNxKCk7CiAgICBpZiAoZSA+IHRoaXMucmFkaXVzICogdGhpcy5yYWRpdXMpIHsKICAgICAgY29uc3QgaSA9IE1hdGguc3FydChlKSwgbiA9IChpIC0gdGhpcy5yYWRpdXMpICogMC41OwogICAgICB0aGlzLmNlbnRlci5hZGRTY2FsZWRWZWN0b3IoemEsIG4gLyBpKSwgdGhpcy5yYWRpdXMgKz0gbjsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBFeHBhbmRzIHRoaXMgc3BoZXJlIHRvIGVuY2xvc2UgYm90aCB0aGUgb3JpZ2luYWwgc3BoZXJlIGFuZCB0aGUgZ2l2ZW4gc3BoZXJlLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBzcGhlcmUgdG8gaW5jbHVkZS4KICAgKiBAcmV0dXJuIHtTcGhlcmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgc3BoZXJlLgogICAqLwogIHVuaW9uKHQpIHsKICAgIHJldHVybiB0LmlzRW1wdHkoKSA/IHRoaXMgOiB0aGlzLmlzRW1wdHkoKSA/ICh0aGlzLmNvcHkodCksIHRoaXMpIDogKHRoaXMuY2VudGVyLmVxdWFscyh0LmNlbnRlcikgPT09ICEwID8gdGhpcy5yYWRpdXMgPSBNYXRoLm1heCh0aGlzLnJhZGl1cywgdC5yYWRpdXMpIDogKE11LnN1YlZlY3RvcnModC5jZW50ZXIsIHRoaXMuY2VudGVyKS5zZXRMZW5ndGgodC5yYWRpdXMpLCB0aGlzLmV4cGFuZEJ5UG9pbnQoemEuY29weSh0LmNlbnRlcikuYWRkKE11KSksIHRoaXMuZXhwYW5kQnlQb2ludCh6YS5jb3B5KHQuY2VudGVyKS5zdWIoTXUpKSksIHRoaXMpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIHNwaGVyZSBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyZX0gc3BoZXJlIC0gVGhlIHNwaGVyZSB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgYm91bmRpbmcgc3BoZXJlIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuY2VudGVyLmVxdWFscyh0aGlzLmNlbnRlcikgJiYgdC5yYWRpdXMgPT09IHRoaXMucmFkaXVzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHNwaGVyZSB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7U3BoZXJlfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KHRoaXMpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgc2VyaWFsaXplZCBzdHJ1Y3R1cmUgb2YgdGhlIGJvdW5kaW5nIHNwaGVyZS4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gU2VyaWFsaXplZCBzdHJ1Y3R1cmUgd2l0aCBmaWVsZHMgcmVwcmVzZW50aW5nIHRoZSBvYmplY3Qgc3RhdGUuCiAgICovCiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgcmFkaXVzOiB0aGlzLnJhZGl1cywKICAgICAgY2VudGVyOiB0aGlzLmNlbnRlci50b0FycmF5KCkKICAgIH07CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBzZXJpYWxpemVkIHN0cnVjdHVyZSBvZiB0aGUgYm91bmRpbmcgc3BoZXJlLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgc2VyaWFsaXplZCBqc29uIHRvIHNldCB0aGUgc3BoZXJlIGZyb20uCiAgICogQHJldHVybiB7Qm94M30gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBzcGhlcmUuCiAgICovCiAgZnJvbUpTT04odCkgewogICAgcmV0dXJuIHRoaXMucmFkaXVzID0gdC5yYWRpdXMsIHRoaXMuY2VudGVyLmZyb21BcnJheSh0LmNlbnRlciksIHRoaXM7CiAgfQp9Owpjb25zdCBEbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBTdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBLbyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBvcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCB3dSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBRbyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBBdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpOwpsZXQgQWEgPSBjbGFzcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyByYXkuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFtvcmlnaW49KDAsMCwwKV0gLSBUaGUgb3JpZ2luIG9mIHRoZSByYXkuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbZGlyZWN0aW9uPSgwLDAsLTEpXSAtIFRoZSAobm9ybWFsaXplZCkgZGlyZWN0aW9uIG9mIHRoZSByYXkuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBFKCksIGUgPSBuZXcgRSgwLCAwLCAtMSkpIHsKICAgIHRoaXMub3JpZ2luID0gdCwgdGhpcy5kaXJlY3Rpb24gPSBlOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSByYXkncyBjb21wb25lbnRzIGJ5IGNvcHlpbmcgdGhlIGdpdmVuIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gb3JpZ2luIC0gVGhlIG9yaWdpbi4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGRpcmVjdGlvbiAtIFRoZSBkaXJlY3Rpb24uCiAgICogQHJldHVybiB7UmF5fSBBIHJlZmVyZW5jZSB0byB0aGlzIHJheS4KICAgKi8KICBzZXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMub3JpZ2luLmNvcHkodCksIHRoaXMuZGlyZWN0aW9uLmNvcHkoZSksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiByYXkgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7UmF5fSByYXkgLSBUaGUgcmF5IHRvIGNvcHkuCiAgICogQHJldHVybiB7UmF5fSBBIHJlZmVyZW5jZSB0byB0aGlzIHJheS4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLm9yaWdpbi5jb3B5KHQub3JpZ2luKSwgdGhpcy5kaXJlY3Rpb24uY29weSh0LmRpcmVjdGlvbiksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSB2ZWN0b3IgdGhhdCBpcyBsb2NhdGVkIGF0IGEgZ2l2ZW4gZGlzdGFuY2UgYWxvbmcgdGhpcyByYXkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIFRoZSBkaXN0YW5jZSBhbG9uZyB0aGUgcmF5IHRvIHJldHJpZXZlIGEgcG9zaXRpb24gZm9yLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSBwb3NpdGlvbiBvbiB0aGUgcmF5LgogICAqLwogIGF0KHQsIGUpIHsKICAgIHJldHVybiBlLmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgdCk7CiAgfQogIC8qKgogICAqIEFkanVzdHMgdGhlIGRpcmVjdGlvbiBvZiB0aGUgcmF5IHRvIHBvaW50IGF0IHRoZSBnaXZlbiB2ZWN0b3IgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdGFyZ2V0IHBvc2l0aW9uLgogICAqIEByZXR1cm4ge1JheX0gQSByZWZlcmVuY2UgdG8gdGhpcyByYXkuCiAgICovCiAgbG9va0F0KHQpIHsKICAgIHJldHVybiB0aGlzLmRpcmVjdGlvbi5jb3B5KHQpLnN1Yih0aGlzLm9yaWdpbikubm9ybWFsaXplKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNoaWZ0IHRoZSBvcmlnaW4gb2YgdGhpcyByYXkgYWxvbmcgaXRzIGRpcmVjdGlvbiBieSB0aGUgZ2l2ZW4gZGlzdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIFRoZSBkaXN0YW5jZSBhbG9uZyB0aGUgcmF5IHRvIGludGVycG9sYXRlLgogICAqIEByZXR1cm4ge1JheX0gQSByZWZlcmVuY2UgdG8gdGhpcyByYXkuCiAgICovCiAgcmVjYXN0KHQpIHsKICAgIHJldHVybiB0aGlzLm9yaWdpbi5jb3B5KHRoaXMuYXQodCwgRG4pKSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgcG9pbnQgYWxvbmcgdGhpcyByYXkgdGhhdCBpcyBjbG9zZXN0IHRvIHRoZSBnaXZlbiBwb2ludC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBBIHBvaW50IGluIDNEIHNwYWNlIHRvIGdldCB0aGUgY2xvc2V0IGxvY2F0aW9uIG9uIHRoZSByYXkgZm9yLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIGNsb3Nlc3QgcG9pbnQgb24gdGhpcyByYXkuCiAgICovCiAgY2xvc2VzdFBvaW50VG9Qb2ludCh0LCBlKSB7CiAgICBlLnN1YlZlY3RvcnModCwgdGhpcy5vcmlnaW4pOwogICAgY29uc3QgaSA9IGUuZG90KHRoaXMuZGlyZWN0aW9uKTsKICAgIHJldHVybiBpIDwgMCA/IGUuY29weSh0aGlzLm9yaWdpbikgOiBlLmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgaSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGRpc3RhbmNlIG9mIHRoZSBjbG9zZXN0IGFwcHJvYWNoIGJldHdlZW4gdGhpcyByYXkgYW5kIHRoZSBnaXZlbiBwb2ludC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBBIHBvaW50IGluIDNEIHNwYWNlIHRvIGNvbXB1dGUgdGhlIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlLgogICAqLwogIGRpc3RhbmNlVG9Qb2ludCh0KSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuZGlzdGFuY2VTcVRvUG9pbnQodCkpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBzcXVhcmVkIGRpc3RhbmNlIG9mIHRoZSBjbG9zZXN0IGFwcHJvYWNoIGJldHdlZW4gdGhpcyByYXkgYW5kIHRoZSBnaXZlbiBwb2ludC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBBIHBvaW50IGluIDNEIHNwYWNlIHRvIGNvbXB1dGUgdGhlIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZWQgZGlzdGFuY2UuCiAgICovCiAgZGlzdGFuY2VTcVRvUG9pbnQodCkgewogICAgY29uc3QgZSA9IERuLnN1YlZlY3RvcnModCwgdGhpcy5vcmlnaW4pLmRvdCh0aGlzLmRpcmVjdGlvbik7CiAgICByZXR1cm4gZSA8IDAgPyB0aGlzLm9yaWdpbi5kaXN0YW5jZVRvU3F1YXJlZCh0KSA6IChEbi5jb3B5KHRoaXMub3JpZ2luKS5hZGRTY2FsZWRWZWN0b3IodGhpcy5kaXJlY3Rpb24sIGUpLCBEbi5kaXN0YW5jZVRvU3F1YXJlZCh0KSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHNxdWFyZWQgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIHJheSBhbmQgdGhlIGdpdmVuIGxpbmUgc2VnbWVudC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdjAgLSBUaGUgc3RhcnQgcG9pbnQgb2YgdGhlIGxpbmUgc2VnbWVudC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYxIC0gVGhlIGVuZCBwb2ludCBvZiB0aGUgbGluZSBzZWdtZW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gW29wdGlvbmFsUG9pbnRPblJheV0gLSBXaGVuIHByb3ZpZGVkLCBpdCByZWNlaXZlcyB0aGUgcG9pbnQgb24gdGhpcyByYXkgdGhhdCBpcyBjbG9zZXN0IHRvIHRoZSBzZWdtZW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gW29wdGlvbmFsUG9pbnRPblNlZ21lbnRdIC0gV2hlbiBwcm92aWRlZCwgaXQgcmVjZWl2ZXMgdGhlIHBvaW50IG9uIHRoZSBsaW5lIHNlZ21lbnQgdGhhdCBpcyBjbG9zZXN0IHRvIHRoaXMgcmF5LgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZWQgZGlzdGFuY2UuCiAgICovCiAgZGlzdGFuY2VTcVRvU2VnbWVudCh0LCBlLCBpLCBuKSB7CiAgICBTdS5jb3B5KHQpLmFkZChlKS5tdWx0aXBseVNjYWxhcigwLjUpLCBLby5jb3B5KGUpLnN1Yih0KS5ub3JtYWxpemUoKSwgb3MuY29weSh0aGlzLm9yaWdpbikuc3ViKFN1KTsKICAgIGNvbnN0IHMgPSB0LmRpc3RhbmNlVG8oZSkgKiAwLjUsIHIgPSAtdGhpcy5kaXJlY3Rpb24uZG90KEtvKSwgbyA9IG9zLmRvdCh0aGlzLmRpcmVjdGlvbiksIGwgPSAtb3MuZG90KEtvKSwgaCA9IG9zLmxlbmd0aFNxKCksIGMgPSBNYXRoLmFicygxIC0gciAqIHIpOwogICAgbGV0IHUsIGQsIHAsIGY7CiAgICBpZiAoYyA+IDApCiAgICAgIGlmICh1ID0gciAqIGwgLSBvLCBkID0gciAqIG8gLSBsLCBmID0gcyAqIGMsIHUgPj0gMCkKICAgICAgICBpZiAoZCA+PSAtZikKICAgICAgICAgIGlmIChkIDw9IGYpIHsKICAgICAgICAgICAgY29uc3QgeSA9IDEgLyBjOwogICAgICAgICAgICB1ICo9IHksIGQgKj0geSwgcCA9IHUgKiAodSArIHIgKiBkICsgMiAqIG8pICsgZCAqIChyICogdSArIGQgKyAyICogbCkgKyBoOwogICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgIGQgPSBzLCB1ID0gTWF0aC5tYXgoMCwgLShyICogZCArIG8pKSwgcCA9IC11ICogdSArIGQgKiAoZCArIDIgKiBsKSArIGg7CiAgICAgICAgZWxzZQogICAgICAgICAgZCA9IC1zLCB1ID0gTWF0aC5tYXgoMCwgLShyICogZCArIG8pKSwgcCA9IC11ICogdSArIGQgKiAoZCArIDIgKiBsKSArIGg7CiAgICAgIGVsc2UKICAgICAgICBkIDw9IC1mID8gKHUgPSBNYXRoLm1heCgwLCAtKC1yICogcyArIG8pKSwgZCA9IHUgPiAwID8gLXMgOiBNYXRoLm1pbihNYXRoLm1heCgtcywgLWwpLCBzKSwgcCA9IC11ICogdSArIGQgKiAoZCArIDIgKiBsKSArIGgpIDogZCA8PSBmID8gKHUgPSAwLCBkID0gTWF0aC5taW4oTWF0aC5tYXgoLXMsIC1sKSwgcyksIHAgPSBkICogKGQgKyAyICogbCkgKyBoKSA6ICh1ID0gTWF0aC5tYXgoMCwgLShyICogcyArIG8pKSwgZCA9IHUgPiAwID8gcyA6IE1hdGgubWluKE1hdGgubWF4KC1zLCAtbCksIHMpLCBwID0gLXUgKiB1ICsgZCAqIChkICsgMiAqIGwpICsgaCk7CiAgICBlbHNlCiAgICAgIGQgPSByID4gMCA/IC1zIDogcywgdSA9IE1hdGgubWF4KDAsIC0ociAqIGQgKyBvKSksIHAgPSAtdSAqIHUgKyBkICogKGQgKyAyICogbCkgKyBoOwogICAgcmV0dXJuIGkgJiYgaS5jb3B5KHRoaXMub3JpZ2luKS5hZGRTY2FsZWRWZWN0b3IodGhpcy5kaXJlY3Rpb24sIHUpLCBuICYmIG4uY29weShTdSkuYWRkU2NhbGVkVmVjdG9yKEtvLCBkKSwgcDsKICB9CiAgLyoqCiAgICogSW50ZXJzZWN0cyB0aGlzIHJheSB3aXRoIHRoZSBnaXZlbiBzcGhlcmUsIHJldHVybmluZyB0aGUgaW50ZXJzZWN0aW9uCiAgICogcG9pbnQgb3IgYG51bGxgIGlmIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KICAgKgogICAqIEBwYXJhbSB7U3BoZXJlfSBzcGhlcmUgLSBUaGUgc3BoZXJlIHRvIGludGVyc2VjdC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4gez9WZWN0b3IzfSBUaGUgaW50ZXJzZWN0aW9uIHBvaW50LgogICAqLwogIGludGVyc2VjdFNwaGVyZSh0LCBlKSB7CiAgICBEbi5zdWJWZWN0b3JzKHQuY2VudGVyLCB0aGlzLm9yaWdpbik7CiAgICBjb25zdCBpID0gRG4uZG90KHRoaXMuZGlyZWN0aW9uKSwgbiA9IERuLmRvdChEbikgLSBpICogaSwgcyA9IHQucmFkaXVzICogdC5yYWRpdXM7CiAgICBpZiAobiA+IHMpIHJldHVybiBudWxsOwogICAgY29uc3QgciA9IE1hdGguc3FydChzIC0gbiksIG8gPSBpIC0gciwgbCA9IGkgKyByOwogICAgcmV0dXJuIGwgPCAwID8gbnVsbCA6IG8gPCAwID8gdGhpcy5hdChsLCBlKSA6IHRoaXMuYXQobywgZSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgcmF5IGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gc3BoZXJlLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBzcGhlcmUgdG8gaW50ZXJzZWN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyByYXkgaW50ZXJzZWN0cyB3aXRoIHRoZSBnaXZlbiBzcGhlcmUgb3Igbm90LgogICAqLwogIGludGVyc2VjdHNTcGhlcmUodCkgewogICAgcmV0dXJuIHQucmFkaXVzIDwgMCA/ICExIDogdGhpcy5kaXN0YW5jZVNxVG9Qb2ludCh0LmNlbnRlcikgPD0gdC5yYWRpdXMgKiB0LnJhZGl1czsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGRpc3RhbmNlIGZyb20gdGhlIHJheSdzIG9yaWdpbiB0byB0aGUgZ2l2ZW4gcGxhbmUuIFJldHVybnMgYG51bGxgIGlmIHRoZSByYXkKICAgKiBkb2VzIG5vdCBpbnRlcnNlY3Qgd2l0aCB0aGUgcGxhbmUuCiAgICoKICAgKiBAcGFyYW0ge1BsYW5lfSBwbGFuZSAtIFRoZSBwbGFuZSB0byBjb21wdXRlIHRoZSBkaXN0YW5jZSB0by4KICAgKiBAcmV0dXJuIHs/bnVtYmVyfSBXaGV0aGVyIHRoaXMgcmF5IGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gc3BoZXJlIG9yIG5vdC4KICAgKi8KICBkaXN0YW5jZVRvUGxhbmUodCkgewogICAgY29uc3QgZSA9IHQubm9ybWFsLmRvdCh0aGlzLmRpcmVjdGlvbik7CiAgICBpZiAoZSA9PT0gMCkKICAgICAgcmV0dXJuIHQuZGlzdGFuY2VUb1BvaW50KHRoaXMub3JpZ2luKSA9PT0gMCA/IDAgOiBudWxsOwogICAgY29uc3QgaSA9IC0odGhpcy5vcmlnaW4uZG90KHQubm9ybWFsKSArIHQuY29uc3RhbnQpIC8gZTsKICAgIHJldHVybiBpID49IDAgPyBpIDogbnVsbDsKICB9CiAgLyoqCiAgICogSW50ZXJzZWN0cyB0aGlzIHJheSB3aXRoIHRoZSBnaXZlbiBwbGFuZSwgcmV0dXJuaW5nIHRoZSBpbnRlcnNlY3Rpb24KICAgKiBwb2ludCBvciBgbnVsbGAgaWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtQbGFuZX0gcGxhbmUgLSBUaGUgcGxhbmUgdG8gaW50ZXJzZWN0LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7P1ZlY3RvcjN9IFRoZSBpbnRlcnNlY3Rpb24gcG9pbnQuCiAgICovCiAgaW50ZXJzZWN0UGxhbmUodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuZGlzdGFuY2VUb1BsYW5lKHQpOwogICAgcmV0dXJuIGkgPT09IG51bGwgPyBudWxsIDogdGhpcy5hdChpLCBlKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyByYXkgaW50ZXJzZWN0cyB3aXRoIHRoZSBnaXZlbiBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7UGxhbmV9IHBsYW5lIC0gVGhlIHBsYW5lIHRvIGludGVyc2VjdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgcmF5IGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gcGxhbmUgb3Igbm90LgogICAqLwogIGludGVyc2VjdHNQbGFuZSh0KSB7CiAgICBjb25zdCBlID0gdC5kaXN0YW5jZVRvUG9pbnQodGhpcy5vcmlnaW4pOwogICAgcmV0dXJuIGUgPT09IDAgfHwgdC5ub3JtYWwuZG90KHRoaXMuZGlyZWN0aW9uKSAqIGUgPCAwOwogIH0KICAvKioKICAgKiBJbnRlcnNlY3RzIHRoaXMgcmF5IHdpdGggdGhlIGdpdmVuIGJvdW5kaW5nIGJveCwgcmV0dXJuaW5nIHRoZSBpbnRlcnNlY3Rpb24KICAgKiBwb2ludCBvciBgbnVsbGAgaWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtCb3gzfSBib3ggLSBUaGUgYm94IHRvIGludGVyc2VjdC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4gez9WZWN0b3IzfSBUaGUgaW50ZXJzZWN0aW9uIHBvaW50LgogICAqLwogIGludGVyc2VjdEJveCh0LCBlKSB7CiAgICBsZXQgaSwgbiwgcywgciwgbywgbDsKICAgIGNvbnN0IGggPSAxIC8gdGhpcy5kaXJlY3Rpb24ueCwgYyA9IDEgLyB0aGlzLmRpcmVjdGlvbi55LCB1ID0gMSAvIHRoaXMuZGlyZWN0aW9uLnosIGQgPSB0aGlzLm9yaWdpbjsKICAgIHJldHVybiBoID49IDAgPyAoaSA9ICh0Lm1pbi54IC0gZC54KSAqIGgsIG4gPSAodC5tYXgueCAtIGQueCkgKiBoKSA6IChpID0gKHQubWF4LnggLSBkLngpICogaCwgbiA9ICh0Lm1pbi54IC0gZC54KSAqIGgpLCBjID49IDAgPyAocyA9ICh0Lm1pbi55IC0gZC55KSAqIGMsIHIgPSAodC5tYXgueSAtIGQueSkgKiBjKSA6IChzID0gKHQubWF4LnkgLSBkLnkpICogYywgciA9ICh0Lm1pbi55IC0gZC55KSAqIGMpLCBpID4gciB8fCBzID4gbiB8fCAoKHMgPiBpIHx8IGlzTmFOKGkpKSAmJiAoaSA9IHMpLCAociA8IG4gfHwgaXNOYU4obikpICYmIChuID0gciksIHUgPj0gMCA/IChvID0gKHQubWluLnogLSBkLnopICogdSwgbCA9ICh0Lm1heC56IC0gZC56KSAqIHUpIDogKG8gPSAodC5tYXgueiAtIGQueikgKiB1LCBsID0gKHQubWluLnogLSBkLnopICogdSksIGkgPiBsIHx8IG8gPiBuKSB8fCAoKG8gPiBpIHx8IGkgIT09IGkpICYmIChpID0gbyksIChsIDwgbiB8fCBuICE9PSBuKSAmJiAobiA9IGwpLCBuIDwgMCkgPyBudWxsIDogdGhpcy5hdChpID49IDAgPyBpIDogbiwgZSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgcmF5IGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gYm94LgogICAqCiAgICogQHBhcmFtIHtCb3gzfSBib3ggLSBUaGUgYm94IHRvIGludGVyc2VjdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgcmF5IGludGVyc2VjdHMgd2l0aCB0aGUgZ2l2ZW4gYm94IG9yIG5vdC4KICAgKi8KICBpbnRlcnNlY3RzQm94KHQpIHsKICAgIHJldHVybiB0aGlzLmludGVyc2VjdEJveCh0LCBEbikgIT09IG51bGw7CiAgfQogIC8qKgogICAqIEludGVyc2VjdHMgdGhpcyByYXkgd2l0aCB0aGUgZ2l2ZW4gdHJpYW5nbGUsIHJldHVybmluZyB0aGUgaW50ZXJzZWN0aW9uCiAgICogcG9pbnQgb3IgYG51bGxgIGlmIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCB2ZXJ0ZXggb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgdmVydGV4IG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGMgLSBUaGUgdGhpcmQgdmVydGV4IG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGJhY2tmYWNlQ3VsbGluZyAtIFdoZXRoZXIgdG8gdXNlIGJhY2tmYWNlIGN1bGxpbmcgb3Igbm90LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7P1ZlY3RvcjN9IFRoZSBpbnRlcnNlY3Rpb24gcG9pbnQuCiAgICovCiAgaW50ZXJzZWN0VHJpYW5nbGUodCwgZSwgaSwgbiwgcykgewogICAgd3Uuc3ViVmVjdG9ycyhlLCB0KSwgUW8uc3ViVmVjdG9ycyhpLCB0KSwgQXUuY3Jvc3NWZWN0b3JzKHd1LCBRbyk7CiAgICBsZXQgciA9IHRoaXMuZGlyZWN0aW9uLmRvdChBdSksIG87CiAgICBpZiAociA+IDApIHsKICAgICAgaWYgKG4pIHJldHVybiBudWxsOwogICAgICBvID0gMTsKICAgIH0gZWxzZSBpZiAociA8IDApCiAgICAgIG8gPSAtMSwgciA9IC1yOwogICAgZWxzZQogICAgICByZXR1cm4gbnVsbDsKICAgIG9zLnN1YlZlY3RvcnModGhpcy5vcmlnaW4sIHQpOwogICAgY29uc3QgbCA9IG8gKiB0aGlzLmRpcmVjdGlvbi5kb3QoUW8uY3Jvc3NWZWN0b3JzKG9zLCBRbykpOwogICAgaWYgKGwgPCAwKQogICAgICByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGggPSBvICogdGhpcy5kaXJlY3Rpb24uZG90KHd1LmNyb3NzKG9zKSk7CiAgICBpZiAoaCA8IDAgfHwgbCArIGggPiByKQogICAgICByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGMgPSAtbyAqIG9zLmRvdChBdSk7CiAgICByZXR1cm4gYyA8IDAgPyBudWxsIDogdGhpcy5hdChjIC8gciwgcyk7CiAgfQogIC8qKgogICAqIFRyYW5zZm9ybXMgdGhpcyByYXkgd2l0aCB0aGUgZ2l2ZW4gNHg0IHRyYW5zZm9ybWF0aW9uIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4NCAtIFRoZSB0cmFuc2Zvcm1hdGlvbiBtYXRyaXguCiAgICogQHJldHVybiB7UmF5fSBBIHJlZmVyZW5jZSB0byB0aGlzIHJheS4KICAgKi8KICBhcHBseU1hdHJpeDQodCkgewogICAgcmV0dXJuIHRoaXMub3JpZ2luLmFwcGx5TWF0cml4NCh0KSwgdGhpcy5kaXJlY3Rpb24udHJhbnNmb3JtRGlyZWN0aW9uKHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIHJheSBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1JheX0gcmF5IC0gVGhlIHJheSB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgcmF5IGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQub3JpZ2luLmVxdWFscyh0aGlzLm9yaWdpbikgJiYgdC5kaXJlY3Rpb24uZXF1YWxzKHRoaXMuZGlyZWN0aW9uKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyByYXkgd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge1JheX0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9Cn0sIFZ0ID0gY2xhc3MgdHAgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgNHg0IG1hdHJpeC4gVGhlIGFyZ3VtZW50cyBhcmUgc3VwcG9zZWQgdG8gYmUKICAgKiBpbiByb3ctbWFqb3Igb3JkZXIuIElmIG5vIGFyZ3VtZW50cyBhcmUgcHJvdmlkZWQsIHRoZSBjb25zdHJ1Y3RvcgogICAqIGluaXRpYWxpemVzIHRoZSBtYXRyaXggYXMgYW4gaWRlbnRpdHkgbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTFdIC0gMS0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjEyXSAtIDEtMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xM10gLSAxLTMgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTRdIC0gMS00IG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIxXSAtIDItMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yMl0gLSAyLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjNdIC0gMi0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjI0XSAtIDItNCBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMV0gLSAzLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzJdIC0gMy0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMzXSAtIDMtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zNF0gLSAzLTQgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuNDFdIC0gNC0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjQyXSAtIDQtMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW240M10gLSA0LTMgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuNDRdIC0gNC00IG1hdHJpeCBlbGVtZW50LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgsIGMsIHUsIGQsIHAsIGYsIHksIGcpIHsKICAgIHRwLnByb3RvdHlwZS5pc01hdHJpeDQgPSAhMCwgdGhpcy5lbGVtZW50cyA9IFsKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgXSwgdCAhPT0gdm9pZCAwICYmIHRoaXMuc2V0KHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgsIGMsIHUsIGQsIHAsIGYsIHksIGcpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBlbGVtZW50cyBvZiB0aGUgbWF0cml4LlRoZSBhcmd1bWVudHMgYXJlIHN1cHBvc2VkIHRvIGJlCiAgICogaW4gcm93LW1ham9yIG9yZGVyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTFdIC0gMS0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjEyXSAtIDEtMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xM10gLSAxLTMgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTRdIC0gMS00IG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIxXSAtIDItMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yMl0gLSAyLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjNdIC0gMi0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjI0XSAtIDItNCBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMV0gLSAzLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzJdIC0gMy0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMzXSAtIDMtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zNF0gLSAzLTQgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuNDFdIC0gNC0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjQyXSAtIDQtMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW240M10gLSA0LTMgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuNDRdIC0gNC00IG1hdHJpeCBlbGVtZW50LgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHNldCh0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoLCBjLCB1LCBkLCBwLCBmLCB5LCBnKSB7CiAgICBjb25zdCBtID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiBtWzBdID0gdCwgbVs0XSA9IGUsIG1bOF0gPSBpLCBtWzEyXSA9IG4sIG1bMV0gPSBzLCBtWzVdID0gciwgbVs5XSA9IG8sIG1bMTNdID0gbCwgbVsyXSA9IGgsIG1bNl0gPSBjLCBtWzEwXSA9IHUsIG1bMTRdID0gZCwgbVszXSA9IHAsIG1bN10gPSBmLCBtWzExXSA9IHksIG1bMTVdID0gZywgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCB0byB0aGUgNHg0IGlkZW50aXR5IG1hdHJpeC4KICAgKgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGlkZW50aXR5KCkgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbWF0cml4IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRwKCkuZnJvbUFycmF5KHRoaXMuZWxlbWVudHMpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gbWF0cml4IHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4IHRvIGNvcHkuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgY29weSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gZVswXSA9IGlbMF0sIGVbMV0gPSBpWzFdLCBlWzJdID0gaVsyXSwgZVszXSA9IGlbM10sIGVbNF0gPSBpWzRdLCBlWzVdID0gaVs1XSwgZVs2XSA9IGlbNl0sIGVbN10gPSBpWzddLCBlWzhdID0gaVs4XSwgZVs5XSA9IGlbOV0sIGVbMTBdID0gaVsxMF0sIGVbMTFdID0gaVsxMV0sIGVbMTJdID0gaVsxMl0sIGVbMTNdID0gaVsxM10sIGVbMTRdID0gaVsxNF0sIGVbMTVdID0gaVsxNV0sIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdHJhbnNsYXRpb24gY29tcG9uZW50IG9mIHRoZSBnaXZlbiBtYXRyaXgKICAgKiBpbnRvIHRoaXMgbWF0cml4J3MgdHJhbnNsYXRpb24gY29tcG9uZW50LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIG1hdHJpeCB0byBjb3B5IHRoZSB0cmFuc2xhdGlvbiBjb21wb25lbnQuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgY29weVBvc2l0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50czsKICAgIHJldHVybiBlWzEyXSA9IGlbMTJdLCBlWzEzXSA9IGlbMTNdLCBlWzE0XSA9IGlbMTRdLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXQgdGhlIHVwcGVyIDN4MyBlbGVtZW50cyBvZiB0aGlzIG1hdHJpeCB0byB0aGUgdmFsdWVzIG9mIGdpdmVuIDN4MyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgM3gzIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzZXRGcm9tTWF0cml4Myh0KSB7CiAgICBjb25zdCBlID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgZVswXSwKICAgICAgZVszXSwKICAgICAgZVs2XSwKICAgICAgMCwKICAgICAgZVsxXSwKICAgICAgZVs0XSwKICAgICAgZVs3XSwKICAgICAgMCwKICAgICAgZVsyXSwKICAgICAgZVs1XSwKICAgICAgZVs4XSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIGJhc2lzIG9mIHRoaXMgbWF0cml4IGludG8gdGhlIHRocmVlIGF4aXMgdmVjdG9ycyBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30geEF4aXMgLSBUaGUgYmFzaXMncyB4IGF4aXMuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB5QXhpcyAtIFRoZSBiYXNpcydzIHkgYXhpcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHpBeGlzIC0gVGhlIGJhc2lzJ3MgeiBheGlzLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGV4dHJhY3RCYXNpcyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdC5zZXRGcm9tTWF0cml4Q29sdW1uKHRoaXMsIDApLCBlLnNldEZyb21NYXRyaXhDb2x1bW4odGhpcywgMSksIGkuc2V0RnJvbU1hdHJpeENvbHVtbih0aGlzLCAyKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gYmFzaXMgdmVjdG9ycyB0byB0aGlzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30geEF4aXMgLSBUaGUgYmFzaXMncyB4IGF4aXMuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB5QXhpcyAtIFRoZSBiYXNpcydzIHkgYXhpcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHpBeGlzIC0gVGhlIGJhc2lzJ3MgeiBheGlzLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VCYXNpcyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIHQueCwKICAgICAgZS54LAogICAgICBpLngsCiAgICAgIDAsCiAgICAgIHQueSwKICAgICAgZS55LAogICAgICBpLnksCiAgICAgIDAsCiAgICAgIHQueiwKICAgICAgZS56LAogICAgICBpLnosCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIEV4dHJhY3RzIHRoZSByb3RhdGlvbiBjb21wb25lbnQgb2YgdGhlIGdpdmVuIG1hdHJpeAogICAqIGludG8gdGhpcyBtYXRyaXgncyByb3RhdGlvbiBjb21wb25lbnQuCiAgICoKICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBkb2VzIG5vdCBzdXBwb3J0IHJlZmxlY3Rpb24gbWF0cmljZXMuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4LgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGV4dHJhY3RSb3RhdGlvbih0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQuZWxlbWVudHMsIG4gPSAxIC8gd3Iuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAwKS5sZW5ndGgoKSwgcyA9IDEgLyB3ci5zZXRGcm9tTWF0cml4Q29sdW1uKHQsIDEpLmxlbmd0aCgpLCByID0gMSAvIHdyLnNldEZyb21NYXRyaXhDb2x1bW4odCwgMikubGVuZ3RoKCk7CiAgICByZXR1cm4gZVswXSA9IGlbMF0gKiBuLCBlWzFdID0gaVsxXSAqIG4sIGVbMl0gPSBpWzJdICogbiwgZVszXSA9IDAsIGVbNF0gPSBpWzRdICogcywgZVs1XSA9IGlbNV0gKiBzLCBlWzZdID0gaVs2XSAqIHMsIGVbN10gPSAwLCBlWzhdID0gaVs4XSAqIHIsIGVbOV0gPSBpWzldICogciwgZVsxMF0gPSBpWzEwXSAqIHIsIGVbMTFdID0gMCwgZVsxMl0gPSAwLCBlWzEzXSA9IDAsIGVbMTRdID0gMCwgZVsxNV0gPSAxLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSByb3RhdGlvbiBjb21wb25lbnQgKHRoZSB1cHBlciBsZWZ0IDN4MyBtYXRyaXgpIG9mIHRoaXMgbWF0cml4IHRvCiAgICogdGhlIHJvdGF0aW9uIHNwZWNpZmllZCBieSB0aGUgZ2l2ZW4gRXVsZXIgYW5nbGVzLiBUaGUgcmVzdCBvZgogICAqIHRoZSBtYXRyaXggaXMgc2V0IHRvIHRoZSBpZGVudGl0eS4gRGVwZW5kaW5nIG9uIHRoZSB7QGxpbmsgRXVsZXIjb3JkZXJ9LAogICAqIHRoZXJlIGFyZSBzaXggcG9zc2libGUgb3V0Y29tZXMuIFNlZSBbdGhpcyBwYWdlXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9FdWxlcl9hbmdsZXMjUm90YXRpb25fbWF0cml4fQogICAqIGZvciBhIGNvbXBsZXRlIGxpc3QuCiAgICoKICAgKiBAcGFyYW0ge0V1bGVyfSBldWxlciAtIFRoZSBFdWxlciBhbmdsZXMuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZVJvdGF0aW9uRnJvbUV1bGVyKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC54LCBuID0gdC55LCBzID0gdC56LCByID0gTWF0aC5jb3MoaSksIG8gPSBNYXRoLnNpbihpKSwgbCA9IE1hdGguY29zKG4pLCBoID0gTWF0aC5zaW4obiksIGMgPSBNYXRoLmNvcyhzKSwgdSA9IE1hdGguc2luKHMpOwogICAgaWYgKHQub3JkZXIgPT09ICJYWVoiKSB7CiAgICAgIGNvbnN0IGQgPSByICogYywgcCA9IHIgKiB1LCBmID0gbyAqIGMsIHkgPSBvICogdTsKICAgICAgZVswXSA9IGwgKiBjLCBlWzRdID0gLWwgKiB1LCBlWzhdID0gaCwgZVsxXSA9IHAgKyBmICogaCwgZVs1XSA9IGQgLSB5ICogaCwgZVs5XSA9IC1vICogbCwgZVsyXSA9IHkgLSBkICogaCwgZVs2XSA9IGYgKyBwICogaCwgZVsxMF0gPSByICogbDsKICAgIH0gZWxzZSBpZiAodC5vcmRlciA9PT0gIllYWiIpIHsKICAgICAgY29uc3QgZCA9IGwgKiBjLCBwID0gbCAqIHUsIGYgPSBoICogYywgeSA9IGggKiB1OwogICAgICBlWzBdID0gZCArIHkgKiBvLCBlWzRdID0gZiAqIG8gLSBwLCBlWzhdID0gciAqIGgsIGVbMV0gPSByICogdSwgZVs1XSA9IHIgKiBjLCBlWzldID0gLW8sIGVbMl0gPSBwICogbyAtIGYsIGVbNl0gPSB5ICsgZCAqIG8sIGVbMTBdID0gciAqIGw7CiAgICB9IGVsc2UgaWYgKHQub3JkZXIgPT09ICJaWFkiKSB7CiAgICAgIGNvbnN0IGQgPSBsICogYywgcCA9IGwgKiB1LCBmID0gaCAqIGMsIHkgPSBoICogdTsKICAgICAgZVswXSA9IGQgLSB5ICogbywgZVs0XSA9IC1yICogdSwgZVs4XSA9IGYgKyBwICogbywgZVsxXSA9IHAgKyBmICogbywgZVs1XSA9IHIgKiBjLCBlWzldID0geSAtIGQgKiBvLCBlWzJdID0gLXIgKiBoLCBlWzZdID0gbywgZVsxMF0gPSByICogbDsKICAgIH0gZWxzZSBpZiAodC5vcmRlciA9PT0gIlpZWCIpIHsKICAgICAgY29uc3QgZCA9IHIgKiBjLCBwID0gciAqIHUsIGYgPSBvICogYywgeSA9IG8gKiB1OwogICAgICBlWzBdID0gbCAqIGMsIGVbNF0gPSBmICogaCAtIHAsIGVbOF0gPSBkICogaCArIHksIGVbMV0gPSBsICogdSwgZVs1XSA9IHkgKiBoICsgZCwgZVs5XSA9IHAgKiBoIC0gZiwgZVsyXSA9IC1oLCBlWzZdID0gbyAqIGwsIGVbMTBdID0gciAqIGw7CiAgICB9IGVsc2UgaWYgKHQub3JkZXIgPT09ICJZWlgiKSB7CiAgICAgIGNvbnN0IGQgPSByICogbCwgcCA9IHIgKiBoLCBmID0gbyAqIGwsIHkgPSBvICogaDsKICAgICAgZVswXSA9IGwgKiBjLCBlWzRdID0geSAtIGQgKiB1LCBlWzhdID0gZiAqIHUgKyBwLCBlWzFdID0gdSwgZVs1XSA9IHIgKiBjLCBlWzldID0gLW8gKiBjLCBlWzJdID0gLWggKiBjLCBlWzZdID0gcCAqIHUgKyBmLCBlWzEwXSA9IGQgLSB5ICogdTsKICAgIH0gZWxzZSBpZiAodC5vcmRlciA9PT0gIlhaWSIpIHsKICAgICAgY29uc3QgZCA9IHIgKiBsLCBwID0gciAqIGgsIGYgPSBvICogbCwgeSA9IG8gKiBoOwogICAgICBlWzBdID0gbCAqIGMsIGVbNF0gPSAtdSwgZVs4XSA9IGggKiBjLCBlWzFdID0gZCAqIHUgKyB5LCBlWzVdID0gciAqIGMsIGVbOV0gPSBwICogdSAtIGYsIGVbMl0gPSBmICogdSAtIHAsIGVbNl0gPSBvICogYywgZVsxMF0gPSB5ICogdSArIGQ7CiAgICB9CiAgICByZXR1cm4gZVszXSA9IDAsIGVbN10gPSAwLCBlWzExXSA9IDAsIGVbMTJdID0gMCwgZVsxM10gPSAwLCBlWzE0XSA9IDAsIGVbMTVdID0gMSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgcm90YXRpb24gY29tcG9uZW50IG9mIHRoaXMgbWF0cml4IHRvIHRoZSByb3RhdGlvbiBzcGVjaWZpZWQgYnkKICAgKiB0aGUgZ2l2ZW4gUXVhdGVybmlvbiBhcyBvdXRsaW5lZCBbaGVyZV17QGxpbmsgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUm90YXRpb25fbWF0cml4I1F1YXRlcm5pb259CiAgICogVGhlIHJlc3Qgb2YgdGhlIG1hdHJpeCBpcyBzZXQgdG8gdGhlIGlkZW50aXR5LgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIFF1YXRlcm5pb24uCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZVJvdGF0aW9uRnJvbVF1YXRlcm5pb24odCkgewogICAgcmV0dXJuIHRoaXMuY29tcG9zZSh2diwgdCwgYnYpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSByb3RhdGlvbiBjb21wb25lbnQgb2YgdGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCwgbG9va2luZyBmcm9tIGBleWVgIHRvd2FyZHMKICAgKiBgdGFyZ2V0YCwgYW5kIG9yaWVudGVkIGJ5IHRoZSB1cC1kaXJlY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGV5ZSAtIFRoZSBleWUgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB1cCAtIFRoZSB1cCB2ZWN0b3IuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbG9va0F0KHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIFBpLnN1YlZlY3RvcnModCwgZSksIFBpLmxlbmd0aFNxKCkgPT09IDAgJiYgKFBpLnogPSAxKSwgUGkubm9ybWFsaXplKCksIGxzLmNyb3NzVmVjdG9ycyhpLCBQaSksIGxzLmxlbmd0aFNxKCkgPT09IDAgJiYgKE1hdGguYWJzKGkueikgPT09IDEgPyBQaS54ICs9IDFlLTQgOiBQaS56ICs9IDFlLTQsIFBpLm5vcm1hbGl6ZSgpLCBscy5jcm9zc1ZlY3RvcnMoaSwgUGkpKSwgbHMubm9ybWFsaXplKCksIHRsLmNyb3NzVmVjdG9ycyhQaSwgbHMpLCBuWzBdID0gbHMueCwgbls0XSA9IHRsLngsIG5bOF0gPSBQaS54LCBuWzFdID0gbHMueSwgbls1XSA9IHRsLnksIG5bOV0gPSBQaS55LCBuWzJdID0gbHMueiwgbls2XSA9IHRsLnosIG5bMTBdID0gUGkueiwgdGhpczsKICB9CiAgLyoqCiAgICogUG9zdC1tdWx0aXBsaWVzIHRoaXMgbWF0cml4IGJ5IHRoZSBnaXZlbiA0eDQgbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIG1hdHJpeCB0byBtdWx0aXBseSB3aXRoLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG11bHRpcGx5KHQpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5TWF0cmljZXModGhpcywgdCk7CiAgfQogIC8qKgogICAqIFByZS1tdWx0aXBsaWVzIHRoaXMgbWF0cml4IGJ5IHRoZSBnaXZlbiA0eDQgbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIG1hdHJpeCB0byBtdWx0aXBseSB3aXRoLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHByZW11bHRpcGx5KHQpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5TWF0cmljZXModCwgdGhpcyk7CiAgfQogIC8qKgogICAqIE11bHRpcGxlcyB0aGUgZ2l2ZW4gNHg0IG1hdHJpY2VzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdAogICAqIGluIHRoaXMgbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBhIC0gVGhlIGZpcnN0IG1hdHJpeC4KICAgKiBAcGFyYW0ge01hdHJpeDR9IGIgLSBUaGUgc2Vjb25kIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtdWx0aXBseU1hdHJpY2VzKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0LmVsZW1lbnRzLCBuID0gZS5lbGVtZW50cywgcyA9IHRoaXMuZWxlbWVudHMsIHIgPSBpWzBdLCBvID0gaVs0XSwgbCA9IGlbOF0sIGggPSBpWzEyXSwgYyA9IGlbMV0sIHUgPSBpWzVdLCBkID0gaVs5XSwgcCA9IGlbMTNdLCBmID0gaVsyXSwgeSA9IGlbNl0sIGcgPSBpWzEwXSwgbSA9IGlbMTRdLCB2ID0gaVszXSwgeCA9IGlbN10sIF8gPSBpWzExXSwgUyA9IGlbMTVdLCB3ID0gblswXSwgVCA9IG5bNF0sIFIgPSBuWzhdLCBiID0gblsxMl0sIE0gPSBuWzFdLCBMID0gbls1XSwgVSA9IG5bOV0sIE8gPSBuWzEzXSwgViA9IG5bMl0sIFcgPSBuWzZdLCBHID0gblsxMF0sIGV0ID0gblsxNF0sIEggPSBuWzNdLCBhdCA9IG5bN10sIHB0ID0gblsxMV0sIE10ID0gblsxNV07CiAgICByZXR1cm4gc1swXSA9IHIgKiB3ICsgbyAqIE0gKyBsICogViArIGggKiBILCBzWzRdID0gciAqIFQgKyBvICogTCArIGwgKiBXICsgaCAqIGF0LCBzWzhdID0gciAqIFIgKyBvICogVSArIGwgKiBHICsgaCAqIHB0LCBzWzEyXSA9IHIgKiBiICsgbyAqIE8gKyBsICogZXQgKyBoICogTXQsIHNbMV0gPSBjICogdyArIHUgKiBNICsgZCAqIFYgKyBwICogSCwgc1s1XSA9IGMgKiBUICsgdSAqIEwgKyBkICogVyArIHAgKiBhdCwgc1s5XSA9IGMgKiBSICsgdSAqIFUgKyBkICogRyArIHAgKiBwdCwgc1sxM10gPSBjICogYiArIHUgKiBPICsgZCAqIGV0ICsgcCAqIE10LCBzWzJdID0gZiAqIHcgKyB5ICogTSArIGcgKiBWICsgbSAqIEgsIHNbNl0gPSBmICogVCArIHkgKiBMICsgZyAqIFcgKyBtICogYXQsIHNbMTBdID0gZiAqIFIgKyB5ICogVSArIGcgKiBHICsgbSAqIHB0LCBzWzE0XSA9IGYgKiBiICsgeSAqIE8gKyBnICogZXQgKyBtICogTXQsIHNbM10gPSB2ICogdyArIHggKiBNICsgXyAqIFYgKyBTICogSCwgc1s3XSA9IHYgKiBUICsgeCAqIEwgKyBfICogVyArIFMgKiBhdCwgc1sxMV0gPSB2ICogUiArIHggKiBVICsgXyAqIEcgKyBTICogcHQsIHNbMTVdID0gdiAqIGIgKyB4ICogTyArIF8gKiBldCArIFMgKiBNdCwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyBldmVyeSBjb21wb25lbnQgb2YgdGhlIG1hdHJpeCBieSB0aGUgZ2l2ZW4gc2NhbGFyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHMgLSBUaGUgc2NhbGFyLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG11bHRpcGx5U2NhbGFyKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIGVbMF0gKj0gdCwgZVs0XSAqPSB0LCBlWzhdICo9IHQsIGVbMTJdICo9IHQsIGVbMV0gKj0gdCwgZVs1XSAqPSB0LCBlWzldICo9IHQsIGVbMTNdICo9IHQsIGVbMl0gKj0gdCwgZVs2XSAqPSB0LCBlWzEwXSAqPSB0LCBlWzE0XSAqPSB0LCBlWzNdICo9IHQsIGVbN10gKj0gdCwgZVsxMV0gKj0gdCwgZVsxNV0gKj0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgYW5kIHJldHVybnMgdGhlIGRldGVybWluYW50IG9mIHRoaXMgbWF0cml4LgogICAqCiAgICogQmFzZWQgb24gdGhlIG1ldGhvZCBvdXRsaW5lZCBbaGVyZV17QGxpbmsgaHR0cDovL3d3dy5ldWNsaWRlYW5zcGFjZS5jb20vbWF0aHMvYWxnZWJyYS9tYXRyaXgvZnVuY3Rpb25zL2ludmVyc2UvZm91ckQvaW5kZXguaHRtbH0uCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZXRlcm1pbmFudC4KICAgKi8KICBkZXRlcm1pbmFudCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmVsZW1lbnRzLCBlID0gdFswXSwgaSA9IHRbNF0sIG4gPSB0WzhdLCBzID0gdFsxMl0sIHIgPSB0WzFdLCBvID0gdFs1XSwgbCA9IHRbOV0sIGggPSB0WzEzXSwgYyA9IHRbMl0sIHUgPSB0WzZdLCBkID0gdFsxMF0sIHAgPSB0WzE0XSwgZiA9IHRbM10sIHkgPSB0WzddLCBnID0gdFsxMV0sIG0gPSB0WzE1XTsKICAgIHJldHVybiBmICogKCtzICogbCAqIHUgLSBuICogaCAqIHUgLSBzICogbyAqIGQgKyBpICogaCAqIGQgKyBuICogbyAqIHAgLSBpICogbCAqIHApICsgeSAqICgrZSAqIGwgKiBwIC0gZSAqIGggKiBkICsgcyAqIHIgKiBkIC0gbiAqIHIgKiBwICsgbiAqIGggKiBjIC0gcyAqIGwgKiBjKSArIGcgKiAoK2UgKiBoICogdSAtIGUgKiBvICogcCAtIHMgKiByICogdSArIGkgKiByICogcCArIHMgKiBvICogYyAtIGkgKiBoICogYykgKyBtICogKC1uICogbyAqIGMgLSBlICogbCAqIHUgKyBlICogbyAqIGQgKyBuICogciAqIHUgLSBpICogciAqIGQgKyBpICogbCAqIGMpOwogIH0KICAvKioKICAgKiBUcmFuc3Bvc2VzIHRoaXMgbWF0cml4IGluIHBsYWNlLgogICAqCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgdHJhbnNwb3NlKCkgewogICAgY29uc3QgdCA9IHRoaXMuZWxlbWVudHM7CiAgICBsZXQgZTsKICAgIHJldHVybiBlID0gdFsxXSwgdFsxXSA9IHRbNF0sIHRbNF0gPSBlLCBlID0gdFsyXSwgdFsyXSA9IHRbOF0sIHRbOF0gPSBlLCBlID0gdFs2XSwgdFs2XSA9IHRbOV0sIHRbOV0gPSBlLCBlID0gdFszXSwgdFszXSA9IHRbMTJdLCB0WzEyXSA9IGUsIGUgPSB0WzddLCB0WzddID0gdFsxM10sIHRbMTNdID0gZSwgZSA9IHRbMTFdLCB0WzExXSA9IHRbMTRdLCB0WzE0XSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHBvc2l0aW9uIGNvbXBvbmVudCBmb3IgdGhpcyBtYXRyaXggZnJvbSB0aGUgZ2l2ZW4gdmVjdG9yLAogICAqIHdpdGhvdXQgYWZmZWN0aW5nIHRoZSByZXN0IG9mIHRoZSBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcnxWZWN0b3IzfSB4IC0gVGhlIHggY29tcG9uZW50IG9mIHRoZSB2ZWN0b3Igb3IgYWx0ZXJuYXRpdmVseSB0aGUgdmVjdG9yIG9iamVjdC4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvbXBvbmVudCBvZiB0aGUgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIHogY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgc2V0UG9zaXRpb24odCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdC5pc1ZlY3RvcjMgPyAoblsxMl0gPSB0LngsIG5bMTNdID0gdC55LCBuWzE0XSA9IHQueikgOiAoblsxMl0gPSB0LCBuWzEzXSA9IGUsIG5bMTRdID0gaSksIHRoaXM7CiAgfQogIC8qKgogICAqIEludmVydHMgdGhpcyBtYXRyaXgsIHVzaW5nIHRoZSBbYW5hbHl0aWMgbWV0aG9kXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JbnZlcnRpYmxlX21hdHJpeCNBbmFseXRpY19zb2x1dGlvbn0uCiAgICogWW91IGNhbiBub3QgaW52ZXJ0IHdpdGggYSBkZXRlcm1pbmFudCBvZiB6ZXJvLiBJZiB5b3UgYXR0ZW1wdCB0aGlzLCB0aGUgbWV0aG9kIHByb2R1Y2VzCiAgICogYSB6ZXJvIG1hdHJpeCBpbnN0ZWFkLgogICAqCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgaW52ZXJ0KCkgewogICAgY29uc3QgdCA9IHRoaXMuZWxlbWVudHMsIGUgPSB0WzBdLCBpID0gdFsxXSwgbiA9IHRbMl0sIHMgPSB0WzNdLCByID0gdFs0XSwgbyA9IHRbNV0sIGwgPSB0WzZdLCBoID0gdFs3XSwgYyA9IHRbOF0sIHUgPSB0WzldLCBkID0gdFsxMF0sIHAgPSB0WzExXSwgZiA9IHRbMTJdLCB5ID0gdFsxM10sIGcgPSB0WzE0XSwgbSA9IHRbMTVdLCB2ID0gdSAqIGcgKiBoIC0geSAqIGQgKiBoICsgeSAqIGwgKiBwIC0gbyAqIGcgKiBwIC0gdSAqIGwgKiBtICsgbyAqIGQgKiBtLCB4ID0gZiAqIGQgKiBoIC0gYyAqIGcgKiBoIC0gZiAqIGwgKiBwICsgciAqIGcgKiBwICsgYyAqIGwgKiBtIC0gciAqIGQgKiBtLCBfID0gYyAqIHkgKiBoIC0gZiAqIHUgKiBoICsgZiAqIG8gKiBwIC0gciAqIHkgKiBwIC0gYyAqIG8gKiBtICsgciAqIHUgKiBtLCBTID0gZiAqIHUgKiBsIC0gYyAqIHkgKiBsIC0gZiAqIG8gKiBkICsgciAqIHkgKiBkICsgYyAqIG8gKiBnIC0gciAqIHUgKiBnLCB3ID0gZSAqIHYgKyBpICogeCArIG4gKiBfICsgcyAqIFM7CiAgICBpZiAodyA9PT0gMCkgcmV0dXJuIHRoaXMuc2V0KDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDAsIDApOwogICAgY29uc3QgVCA9IDEgLyB3OwogICAgcmV0dXJuIHRbMF0gPSB2ICogVCwgdFsxXSA9ICh5ICogZCAqIHMgLSB1ICogZyAqIHMgLSB5ICogbiAqIHAgKyBpICogZyAqIHAgKyB1ICogbiAqIG0gLSBpICogZCAqIG0pICogVCwgdFsyXSA9IChvICogZyAqIHMgLSB5ICogbCAqIHMgKyB5ICogbiAqIGggLSBpICogZyAqIGggLSBvICogbiAqIG0gKyBpICogbCAqIG0pICogVCwgdFszXSA9ICh1ICogbCAqIHMgLSBvICogZCAqIHMgLSB1ICogbiAqIGggKyBpICogZCAqIGggKyBvICogbiAqIHAgLSBpICogbCAqIHApICogVCwgdFs0XSA9IHggKiBULCB0WzVdID0gKGMgKiBnICogcyAtIGYgKiBkICogcyArIGYgKiBuICogcCAtIGUgKiBnICogcCAtIGMgKiBuICogbSArIGUgKiBkICogbSkgKiBULCB0WzZdID0gKGYgKiBsICogcyAtIHIgKiBnICogcyAtIGYgKiBuICogaCArIGUgKiBnICogaCArIHIgKiBuICogbSAtIGUgKiBsICogbSkgKiBULCB0WzddID0gKHIgKiBkICogcyAtIGMgKiBsICogcyArIGMgKiBuICogaCAtIGUgKiBkICogaCAtIHIgKiBuICogcCArIGUgKiBsICogcCkgKiBULCB0WzhdID0gXyAqIFQsIHRbOV0gPSAoZiAqIHUgKiBzIC0gYyAqIHkgKiBzIC0gZiAqIGkgKiBwICsgZSAqIHkgKiBwICsgYyAqIGkgKiBtIC0gZSAqIHUgKiBtKSAqIFQsIHRbMTBdID0gKHIgKiB5ICogcyAtIGYgKiBvICogcyArIGYgKiBpICogaCAtIGUgKiB5ICogaCAtIHIgKiBpICogbSArIGUgKiBvICogbSkgKiBULCB0WzExXSA9IChjICogbyAqIHMgLSByICogdSAqIHMgLSBjICogaSAqIGggKyBlICogdSAqIGggKyByICogaSAqIHAgLSBlICogbyAqIHApICogVCwgdFsxMl0gPSBTICogVCwgdFsxM10gPSAoYyAqIHkgKiBuIC0gZiAqIHUgKiBuICsgZiAqIGkgKiBkIC0gZSAqIHkgKiBkIC0gYyAqIGkgKiBnICsgZSAqIHUgKiBnKSAqIFQsIHRbMTRdID0gKGYgKiBvICogbiAtIHIgKiB5ICogbiAtIGYgKiBpICogbCArIGUgKiB5ICogbCArIHIgKiBpICogZyAtIGUgKiBvICogZykgKiBULCB0WzE1XSA9IChyICogdSAqIG4gLSBjICogbyAqIG4gKyBjICogaSAqIGwgLSBlICogdSAqIGwgLSByICogaSAqIGQgKyBlICogbyAqIGQpICogVCwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgY29sdW1ucyBvZiB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHNjYWxlIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzY2FsZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQueCwgbiA9IHQueSwgcyA9IHQuejsKICAgIHJldHVybiBlWzBdICo9IGksIGVbNF0gKj0gbiwgZVs4XSAqPSBzLCBlWzFdICo9IGksIGVbNV0gKj0gbiwgZVs5XSAqPSBzLCBlWzJdICo9IGksIGVbNl0gKj0gbiwgZVsxMF0gKj0gcywgZVszXSAqPSBpLCBlWzddICo9IG4sIGVbMTFdICo9IHMsIHRoaXM7CiAgfQogIC8qKgogICAqIEdldHMgdGhlIG1heGltdW0gc2NhbGUgdmFsdWUgb2YgdGhlIHRocmVlIGF4ZXMuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBtYXhpbXVtIHNjYWxlLgogICAqLwogIGdldE1heFNjYWxlT25BeGlzKCkgewogICAgY29uc3QgdCA9IHRoaXMuZWxlbWVudHMsIGUgPSB0WzBdICogdFswXSArIHRbMV0gKiB0WzFdICsgdFsyXSAqIHRbMl0sIGkgPSB0WzRdICogdFs0XSArIHRbNV0gKiB0WzVdICsgdFs2XSAqIHRbNl0sIG4gPSB0WzhdICogdFs4XSArIHRbOV0gKiB0WzldICsgdFsxMF0gKiB0WzEwXTsKICAgIHJldHVybiBNYXRoLnNxcnQoTWF0aC5tYXgoZSwgaSwgbikpOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgdHJhbnNsYXRpb24gdHJhbnNmb3JtIGZyb20gdGhlIGdpdmVuIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfFZlY3RvcjN9IHggLSBUaGUgYW1vdW50IHRvIHRyYW5zbGF0ZSBpbiB0aGUgWCBheGlzIG9yIGFsdGVybmF0aXZlbHkgYSB0cmFuc2xhdGlvbiB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgYW1vdW50IHRvIHRyYW5zbGF0ZSBpbiB0aGUgWSBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIGFtb3VudCB0byB0cmFuc2xhdGUgaW4gdGhlIHogYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlVHJhbnNsYXRpb24odCwgZSwgaSkgewogICAgcmV0dXJuIHQuaXNWZWN0b3IzID8gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIHQueCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgdC55LAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICB0LnosCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICkgOiB0aGlzLnNldCgKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgdCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCBhcyBhIHJvdGF0aW9uYWwgdHJhbnNmb3JtYXRpb24gYXJvdW5kIHRoZSBYIGF4aXMgYnkKICAgKiB0aGUgZ2l2ZW4gYW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdGhldGEgLSBUaGUgcm90YXRpb24gaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlUm90YXRpb25YKHQpIHsKICAgIGNvbnN0IGUgPSBNYXRoLmNvcyh0KSwgaSA9IE1hdGguc2luKHQpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICBlLAogICAgICAtaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgaSwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCBhcyBhIHJvdGF0aW9uYWwgdHJhbnNmb3JtYXRpb24gYXJvdW5kIHRoZSBZIGF4aXMgYnkKICAgKiB0aGUgZ2l2ZW4gYW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdGhldGEgLSBUaGUgcm90YXRpb24gaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlUm90YXRpb25ZKHQpIHsKICAgIGNvbnN0IGUgPSBNYXRoLmNvcyh0KSwgaSA9IE1hdGguc2luKHQpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBlLAogICAgICAwLAogICAgICBpLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAtaSwKICAgICAgMCwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCBhcyBhIHJvdGF0aW9uYWwgdHJhbnNmb3JtYXRpb24gYXJvdW5kIHRoZSBaIGF4aXMgYnkKICAgKiB0aGUgZ2l2ZW4gYW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdGhldGEgLSBUaGUgcm90YXRpb24gaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlUm90YXRpb25aKHQpIHsKICAgIGNvbnN0IGUgPSBNYXRoLmNvcyh0KSwgaSA9IE1hdGguc2luKHQpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBlLAogICAgICAtaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgaSwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCBhcyBhIHJvdGF0aW9uYWwgdHJhbnNmb3JtYXRpb24gYXJvdW5kIHRoZSBnaXZlbiBheGlzIGJ5CiAgICogdGhlIGdpdmVuIGFuZ2xlLgogICAqCiAgICogVGhpcyBpcyBhIHNvbWV3aGF0IGNvbnRyb3ZlcnNpYWwgYnV0IG1hdGhlbWF0aWNhbGx5IHNvdW5kIGFsdGVybmF0aXZlIHRvCiAgICogcm90YXRpbmcgdmlhIFF1YXRlcm5pb25zLiBTZWUgdGhlIGRpc2N1c3Npb24gW2hlcmVde0BsaW5rIGh0dHBzOi8vd3d3LmdhbWVkZXYubmV0L2FydGljbGVzL3Byb2dyYW1taW5nL21hdGgtYW5kLXBoeXNpY3MvZG8td2UtcmVhbGx5LW5lZWQtcXVhdGVybmlvbnMtcjExOTl9LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBheGlzIC0gVGhlIG5vcm1hbGl6ZWQgcm90YXRpb24gYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgcm90YXRpb24gaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlUm90YXRpb25BeGlzKHQsIGUpIHsKICAgIGNvbnN0IGkgPSBNYXRoLmNvcyhlKSwgbiA9IE1hdGguc2luKGUpLCBzID0gMSAtIGksIHIgPSB0LngsIG8gPSB0LnksIGwgPSB0LnosIGggPSBzICogciwgYyA9IHMgKiBvOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBoICogciArIGksCiAgICAgIGggKiBvIC0gbiAqIGwsCiAgICAgIGggKiBsICsgbiAqIG8sCiAgICAgIDAsCiAgICAgIGggKiBvICsgbiAqIGwsCiAgICAgIGMgKiBvICsgaSwKICAgICAgYyAqIGwgLSBuICogciwKICAgICAgMCwKICAgICAgaCAqIGwgLSBuICogbywKICAgICAgYyAqIGwgKyBuICogciwKICAgICAgcyAqIGwgKiBsICsgaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCBhcyBhIHNjYWxlIHRyYW5zZm9ybWF0aW9uLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgYW1vdW50IHRvIHNjYWxlIGluIHRoZSBYIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgYW1vdW50IHRvIHNjYWxlIGluIHRoZSBZIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgYW1vdW50IHRvIHNjYWxlIGluIHRoZSBaIGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZVNjYWxlKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgdCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCBhcyBhIHNoZWFyIHRyYW5zZm9ybWF0aW9uLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHh5IC0gVGhlIGFtb3VudCB0byBzaGVhciBYIGJ5IFkuCiAgICogQHBhcmFtIHtudW1iZXJ9IHh6IC0gVGhlIGFtb3VudCB0byBzaGVhciBYIGJ5IFouCiAgICogQHBhcmFtIHtudW1iZXJ9IHl4IC0gVGhlIGFtb3VudCB0byBzaGVhciBZIGJ5IFguCiAgICogQHBhcmFtIHtudW1iZXJ9IHl6IC0gVGhlIGFtb3VudCB0byBzaGVhciBZIGJ5IFouCiAgICogQHBhcmFtIHtudW1iZXJ9IHp4IC0gVGhlIGFtb3VudCB0byBzaGVhciBaIGJ5IFguCiAgICogQHBhcmFtIHtudW1iZXJ9IHp5IC0gVGhlIGFtb3VudCB0byBzaGVhciBaIGJ5IFkuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZVNoZWFyKHQsIGUsIGksIG4sIHMsIHIpIHsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgMSwKICAgICAgaSwKICAgICAgcywKICAgICAgMCwKICAgICAgdCwKICAgICAgMSwKICAgICAgciwKICAgICAgMCwKICAgICAgZSwKICAgICAgbiwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCB0byB0aGUgdHJhbnNmb3JtYXRpb24gY29tcG9zZWQgb2YgdGhlIGdpdmVuIHBvc2l0aW9uLAogICAqIHJvdGF0aW9uIChRdWF0ZXJuaW9uKSBhbmQgc2NhbGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvc2l0aW9uIC0gVGhlIHBvc2l0aW9uIHZlY3Rvci4KICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHF1YXRlcm5pb24gLSBUaGUgcm90YXRpb24gYXMgYSBRdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7VmVjdG9yM30gc2NhbGUgLSBUaGUgc2NhbGUgdmVjdG9yLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGNvbXBvc2UodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuZWxlbWVudHMsIHMgPSBlLl94LCByID0gZS5feSwgbyA9IGUuX3osIGwgPSBlLl93LCBoID0gcyArIHMsIGMgPSByICsgciwgdSA9IG8gKyBvLCBkID0gcyAqIGgsIHAgPSBzICogYywgZiA9IHMgKiB1LCB5ID0gciAqIGMsIGcgPSByICogdSwgbSA9IG8gKiB1LCB2ID0gbCAqIGgsIHggPSBsICogYywgXyA9IGwgKiB1LCBTID0gaS54LCB3ID0gaS55LCBUID0gaS56OwogICAgcmV0dXJuIG5bMF0gPSAoMSAtICh5ICsgbSkpICogUywgblsxXSA9IChwICsgXykgKiBTLCBuWzJdID0gKGYgLSB4KSAqIFMsIG5bM10gPSAwLCBuWzRdID0gKHAgLSBfKSAqIHcsIG5bNV0gPSAoMSAtIChkICsgbSkpICogdywgbls2XSA9IChnICsgdikgKiB3LCBuWzddID0gMCwgbls4XSA9IChmICsgeCkgKiBULCBuWzldID0gKGcgLSB2KSAqIFQsIG5bMTBdID0gKDEgLSAoZCArIHkpKSAqIFQsIG5bMTFdID0gMCwgblsxMl0gPSB0LngsIG5bMTNdID0gdC55LCBuWzE0XSA9IHQueiwgblsxNV0gPSAxLCB0aGlzOwogIH0KICAvKioKICAgKiBEZWNvbXBvc2VzIHRoaXMgbWF0cml4IGludG8gaXRzIHBvc2l0aW9uLCByb3RhdGlvbiBhbmQgc2NhbGUgY29tcG9uZW50cwogICAqIGFuZCBwcm92aWRlcyB0aGUgcmVzdWx0IGluIHRoZSBnaXZlbiBvYmplY3RzLgogICAqCiAgICogTm90ZTogTm90IGFsbCBtYXRyaWNlcyBhcmUgZGVjb21wb3NhYmxlIGluIHRoaXMgd2F5LiBGb3IgZXhhbXBsZSwgaWYgYW4KICAgKiBvYmplY3QgaGFzIGEgbm9uLXVuaWZvcm1seSBzY2FsZWQgcGFyZW50LCB0aGVuIHRoZSBvYmplY3QncyB3b3JsZCBtYXRyaXgKICAgKiBtYXkgbm90IGJlIGRlY29tcG9zYWJsZSwgYW5kIHRoaXMgbWV0aG9kIG1heSBub3QgYmUgYXBwcm9wcmlhdGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvc2l0aW9uIC0gVGhlIHBvc2l0aW9uIHZlY3Rvci4KICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHF1YXRlcm5pb24gLSBUaGUgcm90YXRpb24gYXMgYSBRdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7VmVjdG9yM30gc2NhbGUgLSBUaGUgc2NhbGUgdmVjdG9yLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGRlY29tcG9zZSh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0gdGhpcy5lbGVtZW50czsKICAgIGxldCBzID0gd3Iuc2V0KG5bMF0sIG5bMV0sIG5bMl0pLmxlbmd0aCgpOwogICAgY29uc3QgciA9IHdyLnNldChuWzRdLCBuWzVdLCBuWzZdKS5sZW5ndGgoKSwgbyA9IHdyLnNldChuWzhdLCBuWzldLCBuWzEwXSkubGVuZ3RoKCk7CiAgICB0aGlzLmRldGVybWluYW50KCkgPCAwICYmIChzID0gLXMpLCB0LnggPSBuWzEyXSwgdC55ID0gblsxM10sIHQueiA9IG5bMTRdLCBqaS5jb3B5KHRoaXMpOwogICAgY29uc3QgaCA9IDEgLyBzLCBjID0gMSAvIHIsIHUgPSAxIC8gbzsKICAgIHJldHVybiBqaS5lbGVtZW50c1swXSAqPSBoLCBqaS5lbGVtZW50c1sxXSAqPSBoLCBqaS5lbGVtZW50c1syXSAqPSBoLCBqaS5lbGVtZW50c1s0XSAqPSBjLCBqaS5lbGVtZW50c1s1XSAqPSBjLCBqaS5lbGVtZW50c1s2XSAqPSBjLCBqaS5lbGVtZW50c1s4XSAqPSB1LCBqaS5lbGVtZW50c1s5XSAqPSB1LCBqaS5lbGVtZW50c1sxMF0gKj0gdSwgZS5zZXRGcm9tUm90YXRpb25NYXRyaXgoamkpLCBpLnggPSBzLCBpLnkgPSByLCBpLnogPSBvLCB0aGlzOwogIH0KICAvKioKICAJICogQ3JlYXRlcyBhIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4LiBUaGlzIGlzIHVzZWQgaW50ZXJuYWxseSBieQogIAkgKiB7QGxpbmsgUGVyc3BlY3RpdmVDYW1lcmEjdXBkYXRlUHJvamVjdGlvbk1hdHJpeH0uCiAgCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSBsZWZ0IC0gTGVmdCBib3VuZGFyeSBvZiB0aGUgdmlld2luZyBmcnVzdHVtIGF0IHRoZSBuZWFyIHBsYW5lLgogIAkgKiBAcGFyYW0ge251bWJlcn0gcmlnaHQgLSBSaWdodCBib3VuZGFyeSBvZiB0aGUgdmlld2luZyBmcnVzdHVtIGF0IHRoZSBuZWFyIHBsYW5lLgogIAkgKiBAcGFyYW0ge251bWJlcn0gdG9wIC0gVG9wIGJvdW5kYXJ5IG9mIHRoZSB2aWV3aW5nIGZydXN0dW0gYXQgdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSBib3R0b20gLSBCb3R0b20gYm91bmRhcnkgb2YgdGhlIHZpZXdpbmcgZnJ1c3R1bSBhdCB0aGUgbmVhciBwbGFuZS4KICAJICogQHBhcmFtIHtudW1iZXJ9IG5lYXIgLSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgY2FtZXJhIHRvIHRoZSBuZWFyIHBsYW5lLgogIAkgKiBAcGFyYW0ge251bWJlcn0gZmFyIC0gVGhlIGRpc3RhbmNlIGZyb20gdGhlIGNhbWVyYSB0byB0aGUgZmFyIHBsYW5lLgogIAkgKiBAcGFyYW0geyhXZWJHTENvb3JkaW5hdGVTeXN0ZW18V2ViR1BVQ29vcmRpbmF0ZVN5c3RlbSl9IFtjb29yZGluYXRlU3lzdGVtPVdlYkdMQ29vcmRpbmF0ZVN5c3RlbV0gLSBUaGUgY29vcmRpbmF0ZSBzeXN0ZW0uCiAgCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JldmVyc2VkRGVwdGg9ZmFsc2VdIC0gV2hldGhlciB0byB1c2UgYSByZXZlcnNlZCBkZXB0aC4KICAJICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgCSAqLwogIG1ha2VQZXJzcGVjdGl2ZSh0LCBlLCBpLCBuLCBzLCByLCBvID0gTmksIGwgPSAhMSkgewogICAgY29uc3QgaCA9IHRoaXMuZWxlbWVudHMsIGMgPSAyICogcyAvIChlIC0gdCksIHUgPSAyICogcyAvIChpIC0gbiksIGQgPSAoZSArIHQpIC8gKGUgLSB0KSwgcCA9IChpICsgbikgLyAoaSAtIG4pOwogICAgbGV0IGYsIHk7CiAgICBpZiAobCkKICAgICAgZiA9IHMgLyAociAtIHMpLCB5ID0gciAqIHMgLyAociAtIHMpOwogICAgZWxzZSBpZiAobyA9PT0gTmkpCiAgICAgIGYgPSAtKHIgKyBzKSAvIChyIC0gcyksIHkgPSAtMiAqIHIgKiBzIC8gKHIgLSBzKTsKICAgIGVsc2UgaWYgKG8gPT09IGdhKQogICAgICBmID0gLXIgLyAociAtIHMpLCB5ID0gLXIgKiBzIC8gKHIgLSBzKTsKICAgIGVsc2UKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5NYXRyaXg0Lm1ha2VQZXJzcGVjdGl2ZSgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAiICsgbyk7CiAgICByZXR1cm4gaFswXSA9IGMsIGhbNF0gPSAwLCBoWzhdID0gZCwgaFsxMl0gPSAwLCBoWzFdID0gMCwgaFs1XSA9IHUsIGhbOV0gPSBwLCBoWzEzXSA9IDAsIGhbMl0gPSAwLCBoWzZdID0gMCwgaFsxMF0gPSBmLCBoWzE0XSA9IHksIGhbM10gPSAwLCBoWzddID0gMCwgaFsxMV0gPSAtMSwgaFsxNV0gPSAwLCB0aGlzOwogIH0KICAvKioKICAJICogQ3JlYXRlcyBhIG9ydGhvZ3JhcGhpYyBwcm9qZWN0aW9uIG1hdHJpeC4gVGhpcyBpcyB1c2VkIGludGVybmFsbHkgYnkKICAJICoge0BsaW5rIE9ydGhvZ3JhcGhpY0NhbWVyYSN1cGRhdGVQcm9qZWN0aW9uTWF0cml4fS4KICAKICAJICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgLSBMZWZ0IGJvdW5kYXJ5IG9mIHRoZSB2aWV3aW5nIGZydXN0dW0gYXQgdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSByaWdodCAtIFJpZ2h0IGJvdW5kYXJ5IG9mIHRoZSB2aWV3aW5nIGZydXN0dW0gYXQgdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgLSBUb3AgYm91bmRhcnkgb2YgdGhlIHZpZXdpbmcgZnJ1c3R1bSBhdCB0aGUgbmVhciBwbGFuZS4KICAJICogQHBhcmFtIHtudW1iZXJ9IGJvdHRvbSAtIEJvdHRvbSBib3VuZGFyeSBvZiB0aGUgdmlld2luZyBmcnVzdHVtIGF0IHRoZSBuZWFyIHBsYW5lLgogIAkgKiBAcGFyYW0ge251bWJlcn0gbmVhciAtIFRoZSBkaXN0YW5jZSBmcm9tIHRoZSBjYW1lcmEgdG8gdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSBmYXIgLSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgY2FtZXJhIHRvIHRoZSBmYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7KFdlYkdMQ29vcmRpbmF0ZVN5c3RlbXxXZWJHUFVDb29yZGluYXRlU3lzdGVtKX0gW2Nvb3JkaW5hdGVTeXN0ZW09V2ViR0xDb29yZGluYXRlU3lzdGVtXSAtIFRoZSBjb29yZGluYXRlIHN5c3RlbS4KICAJICogQHBhcmFtIHtib29sZWFufSBbcmV2ZXJzZWREZXB0aD1mYWxzZV0gLSBXaGV0aGVyIHRvIHVzZSBhIHJldmVyc2VkIGRlcHRoLgogIAkgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAJICovCiAgbWFrZU9ydGhvZ3JhcGhpYyh0LCBlLCBpLCBuLCBzLCByLCBvID0gTmksIGwgPSAhMSkgewogICAgY29uc3QgaCA9IHRoaXMuZWxlbWVudHMsIGMgPSAyIC8gKGUgLSB0KSwgdSA9IDIgLyAoaSAtIG4pLCBkID0gLShlICsgdCkgLyAoZSAtIHQpLCBwID0gLShpICsgbikgLyAoaSAtIG4pOwogICAgbGV0IGYsIHk7CiAgICBpZiAobCkKICAgICAgZiA9IDEgLyAociAtIHMpLCB5ID0gciAvIChyIC0gcyk7CiAgICBlbHNlIGlmIChvID09PSBOaSkKICAgICAgZiA9IC0yIC8gKHIgLSBzKSwgeSA9IC0ociArIHMpIC8gKHIgLSBzKTsKICAgIGVsc2UgaWYgKG8gPT09IGdhKQogICAgICBmID0gLTEgLyAociAtIHMpLCB5ID0gLXMgLyAociAtIHMpOwogICAgZWxzZQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLk1hdHJpeDQubWFrZU9ydGhvZ3JhcGhpYygpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAiICsgbyk7CiAgICByZXR1cm4gaFswXSA9IGMsIGhbNF0gPSAwLCBoWzhdID0gMCwgaFsxMl0gPSBkLCBoWzFdID0gMCwgaFs1XSA9IHUsIGhbOV0gPSAwLCBoWzEzXSA9IHAsIGhbMl0gPSAwLCBoWzZdID0gMCwgaFsxMF0gPSBmLCBoWzE0XSA9IHksIGhbM10gPSAwLCBoWzddID0gMCwgaFsxMV0gPSAwLCBoWzE1XSA9IDEsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgbWF0cml4IGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIG1hdHJpeCB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgbWF0cml4IGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHMsIGkgPSB0LmVsZW1lbnRzOwogICAgZm9yIChsZXQgbiA9IDA7IG4gPCAxNjsgbisrKQogICAgICBpZiAoZVtuXSAhPT0gaVtuXSkgcmV0dXJuICExOwogICAgcmV0dXJuICEwOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBlbGVtZW50cyBvZiB0aGUgbWF0cml4IGZyb20gdGhlIGdpdmVuIGFycmF5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGZyb21BcnJheSh0LCBlID0gMCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxNjsgaSsrKQogICAgICB0aGlzLmVsZW1lbnRzW2ldID0gdFtpICsgZV07CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogV3JpdGVzIHRoZSBlbGVtZW50cyBvZiB0aGlzIG1hdHJpeCB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgbWF0cml4IGVsZW1lbnRzIGluIGNvbHVtbi1tYWpvciBvcmRlci4KICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldD0wXSAtIEluZGV4IG9mIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgbWF0cml4IGVsZW1lbnRzIGluIGNvbHVtbi1tYWpvciBvcmRlci4KICAgKi8KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIGNvbnN0IGkgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIHRbZV0gPSBpWzBdLCB0W2UgKyAxXSA9IGlbMV0sIHRbZSArIDJdID0gaVsyXSwgdFtlICsgM10gPSBpWzNdLCB0W2UgKyA0XSA9IGlbNF0sIHRbZSArIDVdID0gaVs1XSwgdFtlICsgNl0gPSBpWzZdLCB0W2UgKyA3XSA9IGlbN10sIHRbZSArIDhdID0gaVs4XSwgdFtlICsgOV0gPSBpWzldLCB0W2UgKyAxMF0gPSBpWzEwXSwgdFtlICsgMTFdID0gaVsxMV0sIHRbZSArIDEyXSA9IGlbMTJdLCB0W2UgKyAxM10gPSBpWzEzXSwgdFtlICsgMTRdID0gaVsxNF0sIHRbZSArIDE1XSA9IGlbMTVdLCB0OwogIH0KfTsKY29uc3Qgd3IgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgamkgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIHZ2ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKDAsIDAsIDApLCBidiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgxLCAxLCAxKSwgbHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgdGwgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgUGkgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgVWYgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIEJmID0gLyogQF9fUFVSRV9fICovIG5ldyB2ZSgpOwpsZXQgZm4gPSBjbGFzcyBieSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBldWxlciBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSBhbmdsZSBvZiB0aGUgeCBheGlzIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIGFuZ2xlIG9mIHRoZSB5IGF4aXMgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3o9MF0gLSBUaGUgYW5nbGUgb2YgdGhlIHogYXhpcyBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7c3RyaW5nfSBbb3JkZXI9RXVsZXIuREVGQVVMVF9PUkRFUl0gLSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIG9yZGVyIHRoYXQgdGhlIHJvdGF0aW9ucyBhcmUgYXBwbGllZC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMCwgZSA9IDAsIGkgPSAwLCBuID0gYnkuREVGQVVMVF9PUkRFUikgewogICAgdGhpcy5pc0V1bGVyID0gITAsIHRoaXMuX3ggPSB0LCB0aGlzLl95ID0gZSwgdGhpcy5feiA9IGksIHRoaXMuX29yZGVyID0gbjsKICB9CiAgLyoqCiAgICogVGhlIGFuZ2xlIG9mIHRoZSB4IGF4aXMgaW4gcmFkaWFucy4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMAogICAqLwogIGdldCB4KCkgewogICAgcmV0dXJuIHRoaXMuX3g7CiAgfQogIHNldCB4KHQpIHsKICAgIHRoaXMuX3ggPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIC8qKgogICAqIFRoZSBhbmdsZSBvZiB0aGUgeSBheGlzIGluIHJhZGlhbnMuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgeSgpIHsKICAgIHJldHVybiB0aGlzLl95OwogIH0KICBzZXQgeSh0KSB7CiAgICB0aGlzLl95ID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBUaGUgYW5nbGUgb2YgdGhlIHogYXhpcyBpbiByYWRpYW5zLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IHooKSB7CiAgICByZXR1cm4gdGhpcy5fejsKICB9CiAgc2V0IHoodCkgewogICAgdGhpcy5feiA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgLyoqCiAgICogQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBvcmRlciB0aGF0IHRoZSByb3RhdGlvbnMgYXJlIGFwcGxpZWQuCiAgICoKICAgKiBAdHlwZSB7c3RyaW5nfQogICAqIEBkZWZhdWx0ICdYWVonCiAgICovCiAgZ2V0IG9yZGVyKCkgewogICAgcmV0dXJuIHRoaXMuX29yZGVyOwogIH0KICBzZXQgb3JkZXIodCkgewogICAgdGhpcy5fb3JkZXIgPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIEV1bGVyIGNvbXBvbmVudHMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBhbmdsZSBvZiB0aGUgeCBheGlzIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgYW5nbGUgb2YgdGhlIHkgYXhpcyBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIGFuZ2xlIG9mIHRoZSB6IGF4aXMgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge3N0cmluZ30gW29yZGVyXSAtIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgb3JkZXIgdGhhdCB0aGUgcm90YXRpb25zIGFyZSBhcHBsaWVkLgogICAqIEByZXR1cm4ge0V1bGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIEV1bGVyIGluc3RhbmNlLgogICAqLwogIHNldCh0LCBlLCBpLCBuID0gdGhpcy5fb3JkZXIpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdCwgdGhpcy5feSA9IGUsIHRoaXMuX3ogPSBpLCB0aGlzLl9vcmRlciA9IG4sIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBFdWxlciBpbnN0YW5jZSB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7RXVsZXJ9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLl94LCB0aGlzLl95LCB0aGlzLl96LCB0aGlzLl9vcmRlcik7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBFdWxlciBpbnN0YW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtFdWxlcn0gZXVsZXIgLSBUaGUgRXVsZXIgaW5zdGFuY2UgdG8gY29weS4KICAgKiBAcmV0dXJuIHtFdWxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBFdWxlciBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdC5feCwgdGhpcy5feSA9IHQuX3ksIHRoaXMuX3ogPSB0Ll96LCB0aGlzLl9vcmRlciA9IHQuX29yZGVyLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGFuZ2xlcyBvZiB0aGlzIEV1bGVyIGluc3RhbmNlIGZyb20gYSBwdXJlIHJvdGF0aW9uIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIEEgNHg0IG1hdHJpeCBvZiB3aGljaCB0aGUgdXBwZXIgM3gzIG9mIG1hdHJpeCBpcyBhIHB1cmUgcm90YXRpb24gbWF0cml4IChpLmUuIHVuc2NhbGVkKS4KICAgKiBAcGFyYW0ge3N0cmluZ30gW29yZGVyXSAtIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgb3JkZXIgdGhhdCB0aGUgcm90YXRpb25zIGFyZSBhcHBsaWVkLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VwZGF0ZT10cnVlXSAtIFdoZXRoZXIgdGhlIGludGVybmFsIGBvbkNoYW5nZWAgY2FsbGJhY2sgc2hvdWxkIGJlIGV4ZWN1dGVkIG9yIG5vdC4KICAgKiBAcmV0dXJuIHtFdWxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBFdWxlciBpbnN0YW5jZS4KICAgKi8KICBzZXRGcm9tUm90YXRpb25NYXRyaXgodCwgZSA9IHRoaXMuX29yZGVyLCBpID0gITApIHsKICAgIGNvbnN0IG4gPSB0LmVsZW1lbnRzLCBzID0gblswXSwgciA9IG5bNF0sIG8gPSBuWzhdLCBsID0gblsxXSwgaCA9IG5bNV0sIGMgPSBuWzldLCB1ID0gblsyXSwgZCA9IG5bNl0sIHAgPSBuWzEwXTsKICAgIHN3aXRjaCAoZSkgewogICAgICBjYXNlICJYWVoiOgogICAgICAgIHRoaXMuX3kgPSBNYXRoLmFzaW4oa3QobywgLTEsIDEpKSwgTWF0aC5hYnMobykgPCAwLjk5OTk5OTkgPyAodGhpcy5feCA9IE1hdGguYXRhbjIoLWMsIHApLCB0aGlzLl96ID0gTWF0aC5hdGFuMigtciwgcykpIDogKHRoaXMuX3ggPSBNYXRoLmF0YW4yKGQsIGgpLCB0aGlzLl96ID0gMCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIllYWiI6CiAgICAgICAgdGhpcy5feCA9IE1hdGguYXNpbigta3QoYywgLTEsIDEpKSwgTWF0aC5hYnMoYykgPCAwLjk5OTk5OTkgPyAodGhpcy5feSA9IE1hdGguYXRhbjIobywgcCksIHRoaXMuX3ogPSBNYXRoLmF0YW4yKGwsIGgpKSA6ICh0aGlzLl95ID0gTWF0aC5hdGFuMigtdSwgcyksIHRoaXMuX3ogPSAwKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWlhZIjoKICAgICAgICB0aGlzLl94ID0gTWF0aC5hc2luKGt0KGQsIC0xLCAxKSksIE1hdGguYWJzKGQpIDwgMC45OTk5OTk5ID8gKHRoaXMuX3kgPSBNYXRoLmF0YW4yKC11LCBwKSwgdGhpcy5feiA9IE1hdGguYXRhbjIoLXIsIGgpKSA6ICh0aGlzLl95ID0gMCwgdGhpcy5feiA9IE1hdGguYXRhbjIobCwgcykpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaWVgiOgogICAgICAgIHRoaXMuX3kgPSBNYXRoLmFzaW4oLWt0KHUsIC0xLCAxKSksIE1hdGguYWJzKHUpIDwgMC45OTk5OTk5ID8gKHRoaXMuX3ggPSBNYXRoLmF0YW4yKGQsIHApLCB0aGlzLl96ID0gTWF0aC5hdGFuMihsLCBzKSkgOiAodGhpcy5feCA9IDAsIHRoaXMuX3ogPSBNYXRoLmF0YW4yKC1yLCBoKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIllaWCI6CiAgICAgICAgdGhpcy5feiA9IE1hdGguYXNpbihrdChsLCAtMSwgMSkpLCBNYXRoLmFicyhsKSA8IDAuOTk5OTk5OSA/ICh0aGlzLl94ID0gTWF0aC5hdGFuMigtYywgaCksIHRoaXMuX3kgPSBNYXRoLmF0YW4yKC11LCBzKSkgOiAodGhpcy5feCA9IDAsIHRoaXMuX3kgPSBNYXRoLmF0YW4yKG8sIHApKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWFpZIjoKICAgICAgICB0aGlzLl96ID0gTWF0aC5hc2luKC1rdChyLCAtMSwgMSkpLCBNYXRoLmFicyhyKSA8IDAuOTk5OTk5OSA/ICh0aGlzLl94ID0gTWF0aC5hdGFuMihkLCBoKSwgdGhpcy5feSA9IE1hdGguYXRhbjIobywgcykpIDogKHRoaXMuX3ggPSBNYXRoLmF0YW4yKC1jLCBwKSwgdGhpcy5feSA9IDApOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuRXVsZXI6IC5zZXRGcm9tUm90YXRpb25NYXRyaXgoKSBlbmNvdW50ZXJlZCBhbiB1bmtub3duIG9yZGVyOiAiICsgZSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fb3JkZXIgPSBlLCBpID09PSAhMCAmJiB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGFuZ2xlcyBvZiB0aGlzIEV1bGVyIGluc3RhbmNlIGZyb20gYSBub3JtYWxpemVkIHF1YXRlcm5pb24uCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBBIG5vcm1hbGl6ZWQgUXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge3N0cmluZ30gW29yZGVyXSAtIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgb3JkZXIgdGhhdCB0aGUgcm90YXRpb25zIGFyZSBhcHBsaWVkLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VwZGF0ZT10cnVlXSAtIFdoZXRoZXIgdGhlIGludGVybmFsIGBvbkNoYW5nZWAgY2FsbGJhY2sgc2hvdWxkIGJlIGV4ZWN1dGVkIG9yIG5vdC4KICAgKiBAcmV0dXJuIHtFdWxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBFdWxlciBpbnN0YW5jZS4KICAgKi8KICBzZXRGcm9tUXVhdGVybmlvbih0LCBlLCBpKSB7CiAgICByZXR1cm4gVWYubWFrZVJvdGF0aW9uRnJvbVF1YXRlcm5pb24odCksIHRoaXMuc2V0RnJvbVJvdGF0aW9uTWF0cml4KFVmLCBlLCBpKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgYW5nbGVzIG9mIHRoaXMgRXVsZXIgaW5zdGFuY2UgZnJvbSB0aGUgZ2l2ZW4gdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcGFyYW0ge3N0cmluZ30gW29yZGVyXSAtIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgb3JkZXIgdGhhdCB0aGUgcm90YXRpb25zIGFyZSBhcHBsaWVkLgogICAqIEByZXR1cm4ge0V1bGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIEV1bGVyIGluc3RhbmNlLgogICAqLwogIHNldEZyb21WZWN0b3IzKHQsIGUgPSB0aGlzLl9vcmRlcikgewogICAgcmV0dXJuIHRoaXMuc2V0KHQueCwgdC55LCB0LnosIGUpOwogIH0KICAvKioKICAgKiBSZXNldHMgdGhlIGV1bGVyIGFuZ2xlIHdpdGggYSBuZXcgb3JkZXIgYnkgY3JlYXRpbmcgYSBxdWF0ZXJuaW9uIGZyb20gdGhpcwogICAqIGV1bGVyIGFuZ2xlIGFuZCB0aGVuIHNldHRpbmcgdGhpcyBldWxlciBhbmdsZSB3aXRoIHRoZSBxdWF0ZXJuaW9uIGFuZCB0aGUKICAgKiBuZXcgb3JkZXIuCiAgICoKICAgKiBXYXJuaW5nOiBUaGlzIGRpc2NhcmRzIHJldm9sdXRpb24gaW5mb3JtYXRpb24uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gW25ld09yZGVyXSAtIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgbmV3IG9yZGVyIHRoYXQgdGhlIHJvdGF0aW9ucyBhcmUgYXBwbGllZC4KICAgKiBAcmV0dXJuIHtFdWxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBFdWxlciBpbnN0YW5jZS4KICAgKi8KICByZW9yZGVyKHQpIHsKICAgIHJldHVybiBCZi5zZXRGcm9tRXVsZXIodGhpcyksIHRoaXMuc2V0RnJvbVF1YXRlcm5pb24oQmYsIHQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIEV1bGVyIGluc3RhbmNlIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGluc3RhbmNlIHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyBFdWxlciBpbnN0YW5jZSBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0Ll94ID09PSB0aGlzLl94ICYmIHQuX3kgPT09IHRoaXMuX3kgJiYgdC5feiA9PT0gdGhpcy5feiAmJiB0Ll9vcmRlciA9PT0gdGhpcy5fb3JkZXI7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBFdWxlciBpbnN0YW5jZSdzIGNvbXBvbmVudHMgdG8gdmFsdWVzIGZyb20gdGhlIGdpdmVuIGFycmF5LiBUaGUgZmlyc3QgdGhyZWUKICAgKiBlbnRyaWVzIG9mIHRoZSBhcnJheSBhcmUgYXNzaWduIHRvIHRoZSB4LHkgYW5kIHogY29tcG9uZW50cy4gQW4gb3B0aW9uYWwgZm91cnRoIGVudHJ5CiAgICogZGVmaW5lcyB0aGUgRXVsZXIgb3JkZXIuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcixudW1iZXIsbnVtYmVyLD9zdHJpbmc+fSBhcnJheSAtIEFuIGFycmF5IGhvbGRpbmcgdGhlIEV1bGVyIGNvbXBvbmVudCB2YWx1ZXMuCiAgICogQHJldHVybiB7RXVsZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgRXVsZXIgaW5zdGFuY2UuCiAgICovCiAgZnJvbUFycmF5KHQpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdFswXSwgdGhpcy5feSA9IHRbMV0sIHRoaXMuX3ogPSB0WzJdLCB0WzNdICE9PSB2b2lkIDAgJiYgKHRoaXMuX29yZGVyID0gdFszXSksIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogV3JpdGVzIHRoZSBjb21wb25lbnRzIG9mIHRoaXMgRXVsZXIgaW5zdGFuY2UgdG8gdGhlIGdpdmVuIGFycmF5LiBJZiBubyBhcnJheSBpcyBwcm92aWRlZCwKICAgKiB0aGUgbWV0aG9kIHJldHVybnMgYSBuZXcgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcixudW1iZXIsbnVtYmVyLHN0cmluZz59IFthcnJheT1bXV0gLSBUaGUgdGFyZ2V0IGFycmF5IGhvbGRpbmcgdGhlIEV1bGVyIGNvbXBvbmVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBJbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyLG51bWJlcixudW1iZXIsc3RyaW5nPn0gVGhlIEV1bGVyIGNvbXBvbmVudHMuCiAgICovCiAgdG9BcnJheSh0ID0gW10sIGUgPSAwKSB7CiAgICByZXR1cm4gdFtlXSA9IHRoaXMuX3gsIHRbZSArIDFdID0gdGhpcy5feSwgdFtlICsgMl0gPSB0aGlzLl96LCB0W2UgKyAzXSA9IHRoaXMuX29yZGVyLCB0OwogIH0KICBfb25DaGFuZ2UodCkgewogICAgcmV0dXJuIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2sgPSB0LCB0aGlzOwogIH0KICBfb25DaGFuZ2VDYWxsYmFjaygpIHsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy5feCwgeWllbGQgdGhpcy5feSwgeWllbGQgdGhpcy5feiwgeWllbGQgdGhpcy5fb3JkZXI7CiAgfQp9Owpmbi5ERUZBVUxUX09SREVSID0gIlhZWiI7CmxldCBOYyA9IGNsYXNzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxheWVycyBpbnN0YW5jZSwgd2l0aCBtZW1iZXJzaGlwCiAgICogaW5pdGlhbGx5IHNldCB0byBsYXllciBgMGAuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hc2sgPSAxOwogIH0KICAvKioKICAgKiBTZXRzIG1lbWJlcnNoaXAgdG8gdGhlIGdpdmVuIGxheWVyLCBhbmQgcmVtb3ZlIG1lbWJlcnNoaXAgYWxsIG90aGVyIGxheWVycy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byBzZXQuCiAgICovCiAgc2V0KHQpIHsKICAgIHRoaXMubWFzayA9ICgxIDw8IHQgfCAwKSA+Pj4gMDsKICB9CiAgLyoqCiAgICogQWRkcyBtZW1iZXJzaGlwIG9mIHRoZSBnaXZlbiBsYXllci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byBlbmFibGUuCiAgICovCiAgZW5hYmxlKHQpIHsKICAgIHRoaXMubWFzayB8PSAxIDw8IHQgfCAwOwogIH0KICAvKioKICAgKiBBZGRzIG1lbWJlcnNoaXAgdG8gYWxsIGxheWVycy4KICAgKi8KICBlbmFibGVBbGwoKSB7CiAgICB0aGlzLm1hc2sgPSAtMTsKICB9CiAgLyoqCiAgICogVG9nZ2xlcyB0aGUgbWVtYmVyc2hpcCBvZiB0aGUgZ2l2ZW4gbGF5ZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbGF5ZXIgLSBUaGUgbGF5ZXIgdG8gdG9nZ2xlLgogICAqLwogIHRvZ2dsZSh0KSB7CiAgICB0aGlzLm1hc2sgXj0gMSA8PCB0IHwgMDsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyBtZW1iZXJzaGlwIG9mIHRoZSBnaXZlbiBsYXllci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byBlbmFibGUuCiAgICovCiAgZGlzYWJsZSh0KSB7CiAgICB0aGlzLm1hc2sgJj0gfigxIDw8IHQgfCAwKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgbWVtYmVyc2hpcCBmcm9tIGFsbCBsYXllcnMuCiAgICovCiAgZGlzYWJsZUFsbCgpIHsKICAgIHRoaXMubWFzayA9IDA7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgYW5kIHRoZSBnaXZlbiBsYXllcnMgb2JqZWN0IGhhdmUgYXQgbGVhc3Qgb25lCiAgICogbGF5ZXIgaW4gY29tbW9uLgogICAqCiAgICogQHBhcmFtIHtMYXllcnN9IGxheWVycyAtIFRoZSBsYXllcnMgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFuIH0gV2hldGhlciB0aGlzIGFuZCB0aGUgZ2l2ZW4gbGF5ZXJzIG9iamVjdCBoYXZlIGF0IGxlYXN0IG9uZSBsYXllciBpbiBjb21tb24gb3Igbm90LgogICAqLwogIHRlc3QodCkgewogICAgcmV0dXJuICh0aGlzLm1hc2sgJiB0Lm1hc2spICE9PSAwOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gbGF5ZXIgaXMgZW5hYmxlZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW4gfSBXaGV0aGVyIHRoZSBnaXZlbiBsYXllciBpcyBlbmFibGVkIG9yIG5vdC4KICAgKi8KICBpc0VuYWJsZWQodCkgewogICAgcmV0dXJuICh0aGlzLm1hc2sgJiAoMSA8PCB0IHwgMCkpICE9PSAwOwogIH0KfSwgTXYgPSAwOwpjb25zdCB6ZiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBBciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdmUoKSwgRm4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIGVsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIE5hID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIFN2ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIHd2ID0gLyogQF9fUFVSRV9fICovIG5ldyB2ZSgpLCBOZiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgxLCAwLCAwKSwgT2YgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoMCwgMSwgMCksIGtmID0gLyogQF9fUFVSRV9fICovIG5ldyBFKDAsIDAsIDEpLCBWZiA9IHsgdHlwZTogImFkZGVkIiB9LCBBdiA9IHsgdHlwZTogInJlbW92ZWQiIH0sIEVyID0geyB0eXBlOiAiY2hpbGRhZGRlZCIsIGNoaWxkOiBudWxsIH0sIEV1ID0geyB0eXBlOiAiY2hpbGRyZW1vdmVkIiwgY2hpbGQ6IG51bGwgfTsKbGV0IGxlID0gY2xhc3MgRWggZXh0ZW5kcyBFaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzRCBvYmplY3QuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzT2JqZWN0M0QgPSAhMCwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJpZCIsIHsgdmFsdWU6IE12KysgfSksIHRoaXMudXVpZCA9IE9pKCksIHRoaXMubmFtZSA9ICIiLCB0aGlzLnR5cGUgPSAiT2JqZWN0M0QiLCB0aGlzLnBhcmVudCA9IG51bGwsIHRoaXMuY2hpbGRyZW4gPSBbXSwgdGhpcy51cCA9IEVoLkRFRkFVTFRfVVAuY2xvbmUoKTsKICAgIGNvbnN0IHQgPSBuZXcgRSgpLCBlID0gbmV3IGZuKCksIGkgPSBuZXcgdmUoKSwgbiA9IG5ldyBFKDEsIDEsIDEpOwogICAgZnVuY3Rpb24gcygpIHsKICAgICAgaS5zZXRGcm9tRXVsZXIoZSwgITEpOwogICAgfQogICAgZnVuY3Rpb24gcigpIHsKICAgICAgZS5zZXRGcm9tUXVhdGVybmlvbihpLCB2b2lkIDAsICExKTsKICAgIH0KICAgIGUuX29uQ2hhbmdlKHMpLCBpLl9vbkNoYW5nZShyKSwgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogUmVwcmVzZW50cyB0aGUgb2JqZWN0J3MgbG9jYWwgcG9zaXRpb24uCiAgICAgICAqCiAgICAgICAqIEBuYW1lIE9iamVjdDNEI3Bvc2l0aW9uCiAgICAgICAqIEB0eXBlIHtWZWN0b3IzfQogICAgICAgKiBAZGVmYXVsdCAoMCwwLDApCiAgICAgICAqLwogICAgICBwb3NpdGlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IHQKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFJlcHJlc2VudHMgdGhlIG9iamVjdCdzIGxvY2FsIHJvdGF0aW9uIGFzIEV1bGVyIGFuZ2xlcywgaW4gcmFkaWFucy4KICAgICAgICoKICAgICAgICogQG5hbWUgT2JqZWN0M0Qjcm90YXRpb24KICAgICAgICogQHR5cGUge0V1bGVyfQogICAgICAgKiBAZGVmYXVsdCAoMCwwLDApCiAgICAgICAqLwogICAgICByb3RhdGlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IGUKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFJlcHJlc2VudHMgdGhlIG9iamVjdCdzIGxvY2FsIHJvdGF0aW9uIGFzIFF1YXRlcm5pb25zLgogICAgICAgKgogICAgICAgKiBAbmFtZSBPYmplY3QzRCNxdWF0ZXJuaW9uCiAgICAgICAqIEB0eXBlIHtRdWF0ZXJuaW9ufQogICAgICAgKi8KICAgICAgcXVhdGVybmlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IGkKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFJlcHJlc2VudHMgdGhlIG9iamVjdCdzIGxvY2FsIHNjYWxlLgogICAgICAgKgogICAgICAgKiBAbmFtZSBPYmplY3QzRCNzY2FsZQogICAgICAgKiBAdHlwZSB7VmVjdG9yM30KICAgICAgICogQGRlZmF1bHQgKDEsMSwxKQogICAgICAgKi8KICAgICAgc2NhbGU6IHsKICAgICAgICBjb25maWd1cmFibGU6ICEwLAogICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgIHZhbHVlOiBuCiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBSZXByZXNlbnRzIHRoZSBvYmplY3QncyBtb2RlbC12aWV3IG1hdHJpeC4KICAgICAgICoKICAgICAgICogQG5hbWUgT2JqZWN0M0QjbW9kZWxWaWV3TWF0cml4CiAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgKi8KICAgICAgbW9kZWxWaWV3TWF0cml4OiB7CiAgICAgICAgdmFsdWU6IG5ldyBWdCgpCiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBSZXByZXNlbnRzIHRoZSBvYmplY3QncyBub3JtYWwgbWF0cml4LgogICAgICAgKgogICAgICAgKiBAbmFtZSBPYmplY3QzRCNub3JtYWxNYXRyaXgKICAgICAgICogQHR5cGUge01hdHJpeDN9CiAgICAgICAqLwogICAgICBub3JtYWxNYXRyaXg6IHsKICAgICAgICB2YWx1ZTogbmV3IFh0KCkKICAgICAgfQogICAgfSksIHRoaXMubWF0cml4ID0gbmV3IFZ0KCksIHRoaXMubWF0cml4V29ybGQgPSBuZXcgVnQoKSwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gRWguREVGQVVMVF9NQVRSSVhfQVVUT19VUERBVEUsIHRoaXMubWF0cml4V29ybGRBdXRvVXBkYXRlID0gRWguREVGQVVMVF9NQVRSSVhfV09STERfQVVUT19VUERBVEUsIHRoaXMubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9ICExLCB0aGlzLmxheWVycyA9IG5ldyBOYygpLCB0aGlzLnZpc2libGUgPSAhMCwgdGhpcy5jYXN0U2hhZG93ID0gITEsIHRoaXMucmVjZWl2ZVNoYWRvdyA9ICExLCB0aGlzLmZydXN0dW1DdWxsZWQgPSAhMCwgdGhpcy5yZW5kZXJPcmRlciA9IDAsIHRoaXMuYW5pbWF0aW9ucyA9IFtdLCB0aGlzLmN1c3RvbURlcHRoTWF0ZXJpYWwgPSB2b2lkIDAsIHRoaXMuY3VzdG9tRGlzdGFuY2VNYXRlcmlhbCA9IHZvaWQgMCwgdGhpcy51c2VyRGF0YSA9IHt9OwogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgM0Qgb2JqZWN0IGlzIHJlbmRlcmVkIHRvIGEgc2hhZG93IG1hcC4KICAgKgogICAqIEBwYXJhbSB7UmVuZGVyZXJ8V2ViR0xSZW5kZXJlcn0gcmVuZGVyZXIgLSBUaGUgcmVuZGVyZXIuCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdC4KICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYSB0aGF0IGlzIHVzZWQgdG8gcmVuZGVyIHRoZSBzY2VuZS4KICAgKiBAcGFyYW0ge0NhbWVyYX0gc2hhZG93Q2FtZXJhIC0gVGhlIHNoYWRvdyBjYW1lcmEuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbH0gZGVwdGhNYXRlcmlhbCAtIFRoZSBkZXB0aCBtYXRlcmlhbC4KICAgKiBAcGFyYW0ge09iamVjdH0gZ3JvdXAgLSBUaGUgZ2VvbWV0cnkgZ3JvdXAgZGF0YS4KICAgKi8KICBvbkJlZm9yZVNoYWRvdygpIHsKICB9CiAgLyoqCiAgICogQSBjYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIGltbWVkaWF0ZWx5IGFmdGVyIGEgM0Qgb2JqZWN0IGlzIHJlbmRlcmVkIHRvIGEgc2hhZG93IG1hcC4KICAgKgogICAqIEBwYXJhbSB7UmVuZGVyZXJ8V2ViR0xSZW5kZXJlcn0gcmVuZGVyZXIgLSBUaGUgcmVuZGVyZXIuCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdC4KICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYSB0aGF0IGlzIHVzZWQgdG8gcmVuZGVyIHRoZSBzY2VuZS4KICAgKiBAcGFyYW0ge0NhbWVyYX0gc2hhZG93Q2FtZXJhIC0gVGhlIHNoYWRvdyBjYW1lcmEuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbH0gZGVwdGhNYXRlcmlhbCAtIFRoZSBkZXB0aCBtYXRlcmlhbC4KICAgKiBAcGFyYW0ge09iamVjdH0gZ3JvdXAgLSBUaGUgZ2VvbWV0cnkgZ3JvdXAgZGF0YS4KICAgKi8KICBvbkFmdGVyU2hhZG93KCkgewogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgM0Qgb2JqZWN0IGlzIHJlbmRlcmVkLgogICAqCiAgICogQHBhcmFtIHtSZW5kZXJlcnxXZWJHTFJlbmRlcmVyfSByZW5kZXJlciAtIFRoZSByZW5kZXJlci4KICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgM0Qgb2JqZWN0LgogICAqIEBwYXJhbSB7Q2FtZXJhfSBjYW1lcmEgLSBUaGUgY2FtZXJhIHRoYXQgaXMgdXNlZCB0byByZW5kZXIgdGhlIHNjZW5lLgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IGdlb21ldHJ5IC0gVGhlIDNEIG9iamVjdCdzIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7TWF0ZXJpYWx9IG1hdGVyaWFsIC0gVGhlIDNEIG9iamVjdCdzIG1hdGVyaWFsLgogICAqIEBwYXJhbSB7T2JqZWN0fSBncm91cCAtIFRoZSBnZW9tZXRyeSBncm91cCBkYXRhLgogICAqLwogIG9uQmVmb3JlUmVuZGVyKCkgewogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgYSAzRCBvYmplY3QgaXMgcmVuZGVyZWQuCiAgICoKICAgKiBAcGFyYW0ge1JlbmRlcmVyfFdlYkdMUmVuZGVyZXJ9IHJlbmRlcmVyIC0gVGhlIHJlbmRlcmVyLgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QuCiAgICogQHBhcmFtIHtDYW1lcmF9IGNhbWVyYSAtIFRoZSBjYW1lcmEgdGhhdCBpcyB1c2VkIHRvIHJlbmRlciB0aGUgc2NlbmUuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbH0gbWF0ZXJpYWwgLSBUaGUgM0Qgb2JqZWN0J3MgbWF0ZXJpYWwuCiAgICogQHBhcmFtIHtPYmplY3R9IGdyb3VwIC0gVGhlIGdlb21ldHJ5IGdyb3VwIGRhdGEuCiAgICovCiAgb25BZnRlclJlbmRlcigpIHsKICB9CiAgLyoqCiAgICogQXBwbGllcyB0aGUgZ2l2ZW4gdHJhbnNmb3JtYXRpb24gbWF0cml4IHRvIHRoZSBvYmplY3QgYW5kIHVwZGF0ZXMgdGhlIG9iamVjdCdzIHBvc2l0aW9uLAogICAqIHJvdGF0aW9uIGFuZCBzY2FsZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeC4KICAgKi8KICBhcHBseU1hdHJpeDQodCkgewogICAgdGhpcy5tYXRyaXhBdXRvVXBkYXRlICYmIHRoaXMudXBkYXRlTWF0cml4KCksIHRoaXMubWF0cml4LnByZW11bHRpcGx5KHQpLCB0aGlzLm1hdHJpeC5kZWNvbXBvc2UodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCB0aGlzLnNjYWxlKTsKICB9CiAgLyoqCiAgICogQXBwbGllcyBhIHJvdGF0aW9uIHJlcHJlc2VudGVkIGJ5IGdpdmVuIHRoZSBxdWF0ZXJuaW9uIHRvIHRoZSAzRCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgcXVhdGVybmlvbi4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhcHBseVF1YXRlcm5pb24odCkgewogICAgcmV0dXJuIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseSh0KSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gcm90YXRpb24gcmVwcmVzZW50ZWQgYXMgYW4gYXhpcy9hbmdsZSBjb3VwbGUgdG8gdGhlIDNEIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSAobm9ybWFsaXplZCkgYXhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICovCiAgc2V0Um90YXRpb25Gcm9tQXhpc0FuZ2xlKHQsIGUpIHsKICAgIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKHQsIGUpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiByb3RhdGlvbiByZXByZXNlbnRlZCBhcyBFdWxlciBhbmdsZXMgdG8gdGhlIDNEIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGFuZ2xlcy4KICAgKi8KICBzZXRSb3RhdGlvbkZyb21FdWxlcih0KSB7CiAgICB0aGlzLnF1YXRlcm5pb24uc2V0RnJvbUV1bGVyKHQsICEwKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gcm90YXRpb24gcmVwcmVzZW50ZWQgYXMgcm90YXRpb24gbWF0cml4IHRvIHRoZSAzRCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBBbHRob3VnaCBhIDR4NCBtYXRyaXggaXMgZXhwZWN0ZWQsIHRoZSB1cHBlciAzeDMgcG9ydGlvbiBtdXN0IGJlCiAgICogYSBwdXJlIHJvdGF0aW9uIG1hdHJpeCAoaS5lLCB1bnNjYWxlZCkuCiAgICovCiAgc2V0Um90YXRpb25Gcm9tTWF0cml4KHQpIHsKICAgIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgodCk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIHJvdGF0aW9uIHJlcHJlc2VudGVkIGFzIGEgUXVhdGVybmlvbiB0byB0aGUgM0Qgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIFF1YXRlcm5pb24KICAgKi8KICBzZXRSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKHQpIHsKICAgIHRoaXMucXVhdGVybmlvbi5jb3B5KHQpOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSAzRCBvYmplY3QgYWxvbmcgYW4gYXhpcyBpbiBsb2NhbCBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSAobm9ybWFsaXplZCkgYXhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlT25BeGlzKHQsIGUpIHsKICAgIHJldHVybiBBci5zZXRGcm9tQXhpc0FuZ2xlKHQsIGUpLCB0aGlzLnF1YXRlcm5pb24ubXVsdGlwbHkoQXIpLCB0aGlzOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSAzRCBvYmplY3QgYWxvbmcgYW4gYXhpcyBpbiB3b3JsZCBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSAobm9ybWFsaXplZCkgYXhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlT25Xb3JsZEF4aXModCwgZSkgewogICAgcmV0dXJuIEFyLnNldEZyb21BeGlzQW5nbGUodCwgZSksIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseShBciksIHRoaXM7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhlIDNEIG9iamVjdCBhcm91bmQgaXRzIFggYXhpcyBpbiBsb2NhbCBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHJvdGF0ZVgodCkgewogICAgcmV0dXJuIHRoaXMucm90YXRlT25BeGlzKE5mLCB0KTsKICB9CiAgLyoqCiAgICogUm90YXRlcyB0aGUgM0Qgb2JqZWN0IGFyb3VuZCBpdHMgWSBheGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlWSh0KSB7CiAgICByZXR1cm4gdGhpcy5yb3RhdGVPbkF4aXMoT2YsIHQpOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSAzRCBvYmplY3QgYXJvdW5kIGl0cyBaIGF4aXMgaW4gbG9jYWwgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICByb3RhdGVaKHQpIHsKICAgIHJldHVybiB0aGlzLnJvdGF0ZU9uQXhpcyhrZiwgdCk7CiAgfQogIC8qKgogICAqIFRyYW5zbGF0ZSB0aGUgM0Qgb2JqZWN0IGJ5IGEgZGlzdGFuY2UgYWxvbmcgdGhlIGdpdmVuIGF4aXMgaW4gbG9jYWwgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGF4aXMgLSBUaGUgKG5vcm1hbGl6ZWQpIGF4aXMgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBkaXN0YW5jZSAtIFRoZSBkaXN0YW5jZSBpbiB3b3JsZCB1bml0cy4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICB0cmFuc2xhdGVPbkF4aXModCwgZSkgewogICAgcmV0dXJuIHpmLmNvcHkodCkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMucXVhdGVybmlvbiksIHRoaXMucG9zaXRpb24uYWRkKHpmLm11bHRpcGx5U2NhbGFyKGUpKSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlIHRoZSAzRCBvYmplY3QgYnkgYSBkaXN0YW5jZSBhbG9uZyBpdHMgWC1heGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGluIHdvcmxkIHVuaXRzLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zbGF0ZVgodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKE5mLCB0KTsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlIHRoZSAzRCBvYmplY3QgYnkgYSBkaXN0YW5jZSBhbG9uZyBpdHMgWS1heGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGluIHdvcmxkIHVuaXRzLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zbGF0ZVkodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKE9mLCB0KTsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlIHRoZSAzRCBvYmplY3QgYnkgYSBkaXN0YW5jZSBhbG9uZyBpdHMgWi1heGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGluIHdvcmxkIHVuaXRzLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zbGF0ZVoodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKGtmLCB0KTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIHZlY3RvciBmcm9tIHRoaXMgM0Qgb2JqZWN0J3MgbG9jYWwgc3BhY2UgdG8gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHZlY3RvciAtIFRoZSB2ZWN0b3IgdG8gY29udmVydC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY29udmVydGVkIHZlY3Rvci4KICAgKi8KICBsb2NhbFRvV29ybGQodCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdC5hcHBseU1hdHJpeDQodGhpcy5tYXRyaXhXb3JsZCk7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIHRoZSBnaXZlbiB2ZWN0b3IgZnJvbSB0aGlzIDNEIG9iamVjdCdzIHdvcmQgc3BhY2UgdG8gbG9jYWwgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHZlY3RvciAtIFRoZSB2ZWN0b3IgdG8gY29udmVydC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY29udmVydGVkIHZlY3Rvci4KICAgKi8KICB3b3JsZFRvTG9jYWwodCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdC5hcHBseU1hdHJpeDQoRm4uY29weSh0aGlzLm1hdHJpeFdvcmxkKS5pbnZlcnQoKSk7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhlIG9iamVjdCB0byBmYWNlIGEgcG9pbnQgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCBzdXBwb3J0IG9iamVjdHMgaGF2aW5nIG5vbi11bmlmb3JtbHktc2NhbGVkIHBhcmVudChzKS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfFZlY3RvcjN9IHggLSBUaGUgeCBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlLiBBbHRlcm5hdGl2ZWx5LCBhIHZlY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBpbiB3b3JsZCBzcGFjZQogICAqIEBwYXJhbSB7bnVtYmVyfSBbeV0gLSBUaGUgeSBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbel0gLSBUaGUgeiBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlLgogICAqLwogIGxvb2tBdCh0LCBlLCBpKSB7CiAgICB0LmlzVmVjdG9yMyA/IGVsLmNvcHkodCkgOiBlbC5zZXQodCwgZSwgaSk7CiAgICBjb25zdCBuID0gdGhpcy5wYXJlbnQ7CiAgICB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIE5hLnNldEZyb21NYXRyaXhQb3NpdGlvbih0aGlzLm1hdHJpeFdvcmxkKSwgdGhpcy5pc0NhbWVyYSB8fCB0aGlzLmlzTGlnaHQgPyBGbi5sb29rQXQoTmEsIGVsLCB0aGlzLnVwKSA6IEZuLmxvb2tBdChlbCwgTmEsIHRoaXMudXApLCB0aGlzLnF1YXRlcm5pb24uc2V0RnJvbVJvdGF0aW9uTWF0cml4KEZuKSwgbiAmJiAoRm4uZXh0cmFjdFJvdGF0aW9uKG4ubWF0cml4V29ybGQpLCBBci5zZXRGcm9tUm90YXRpb25NYXRyaXgoRm4pLCB0aGlzLnF1YXRlcm5pb24ucHJlbXVsdGlwbHkoQXIuaW52ZXJ0KCkpKTsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gM0Qgb2JqZWN0IGFzIGEgY2hpbGQgdG8gdGhpcyAzRCBvYmplY3QuIEFuIGFyYml0cmFyeSBudW1iZXIgb2YKICAgKiBvYmplY3RzIG1heSBiZSBhZGRlZC4gQW55IGN1cnJlbnQgcGFyZW50IG9uIGFuIG9iamVjdCBwYXNzZWQgaW4gaGVyZSB3aWxsIGJlCiAgICogcmVtb3ZlZCwgc2luY2UgYW4gb2JqZWN0IGNhbiBoYXZlIGF0IG1vc3Qgb25lIHBhcmVudC4KICAgKgogICAqIEBmaXJlcyBPYmplY3QzRCNhZGRlZAogICAqIEBmaXJlcyBPYmplY3QzRCNjaGlsZGFkZGVkCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdCB0byBhZGQuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgYWRkKHQpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICBmb3IgKGxldCBlID0gMDsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykKICAgICAgICB0aGlzLmFkZChhcmd1bWVudHNbZV0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiB0ID09PSB0aGlzID8gKGNvbnNvbGUuZXJyb3IoIlRIUkVFLk9iamVjdDNELmFkZDogb2JqZWN0IGNhbid0IGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgaXRzZWxmLiIsIHQpLCB0aGlzKSA6ICh0ICYmIHQuaXNPYmplY3QzRCA/ICh0LnJlbW92ZUZyb21QYXJlbnQoKSwgdC5wYXJlbnQgPSB0aGlzLCB0aGlzLmNoaWxkcmVuLnB1c2godCksIHQuZGlzcGF0Y2hFdmVudChWZiksIEVyLmNoaWxkID0gdCwgdGhpcy5kaXNwYXRjaEV2ZW50KEVyKSwgRXIuY2hpbGQgPSBudWxsKSA6IGNvbnNvbGUuZXJyb3IoIlRIUkVFLk9iamVjdDNELmFkZDogb2JqZWN0IG5vdCBhbiBpbnN0YW5jZSBvZiBUSFJFRS5PYmplY3QzRC4iLCB0KSwgdGhpcyk7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgdGhlIGdpdmVuIDNEIG9iamVjdCBhcyBjaGlsZCBmcm9tIHRoaXMgM0Qgb2JqZWN0LgogICAqIEFuIGFyYml0cmFyeSBudW1iZXIgb2Ygb2JqZWN0cyBtYXkgYmUgcmVtb3ZlZC4KICAgKgogICAqIEBmaXJlcyBPYmplY3QzRCNyZW1vdmVkCiAgICogQGZpcmVzIE9iamVjdDNEI2NoaWxkcmVtb3ZlZAogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QgdG8gcmVtb3ZlLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHJlbW92ZSh0KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspCiAgICAgICAgdGhpcy5yZW1vdmUoYXJndW1lbnRzW2ldKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBlID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKHQpOwogICAgcmV0dXJuIGUgIT09IC0xICYmICh0LnBhcmVudCA9IG51bGwsIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGUsIDEpLCB0LmRpc3BhdGNoRXZlbnQoQXYpLCBFdS5jaGlsZCA9IHQsIHRoaXMuZGlzcGF0Y2hFdmVudChFdSksIEV1LmNoaWxkID0gbnVsbCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgdGhpcyAzRCBvYmplY3QgZnJvbSBpdHMgY3VycmVudCBwYXJlbnQuCiAgICoKICAgKiBAZmlyZXMgT2JqZWN0M0QjcmVtb3ZlZAogICAqIEBmaXJlcyBPYmplY3QzRCNjaGlsZHJlbW92ZWQKICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICByZW1vdmVGcm9tUGFyZW50KCkgewogICAgY29uc3QgdCA9IHRoaXMucGFyZW50OwogICAgcmV0dXJuIHQgIT09IG51bGwgJiYgdC5yZW1vdmUodGhpcyksIHRoaXM7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYWxsIGNoaWxkIG9iamVjdHMuCiAgICoKICAgKiBAZmlyZXMgT2JqZWN0M0QjcmVtb3ZlZAogICAqIEBmaXJlcyBPYmplY3QzRCNjaGlsZHJlbW92ZWQKICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbGVhcigpIHsKICAgIHJldHVybiB0aGlzLnJlbW92ZSguLi50aGlzLmNoaWxkcmVuKTsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gM0Qgb2JqZWN0IGFzIGEgY2hpbGQgb2YgdGhpcyAzRCBvYmplY3QsIHdoaWxlIG1haW50YWluaW5nIHRoZSBvYmplY3QncyB3b3JsZAogICAqIHRyYW5zZm9ybS4gVGhpcyBtZXRob2QgZG9lcyBub3Qgc3VwcG9ydCBzY2VuZSBncmFwaHMgaGF2aW5nIG5vbi11bmlmb3JtbHktc2NhbGVkIG5vZGVzKHMpLgogICAqCiAgICogQGZpcmVzIE9iamVjdDNEI2FkZGVkCiAgICogQGZpcmVzIE9iamVjdDNEI2NoaWxkYWRkZWQKICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgM0Qgb2JqZWN0IHRvIGF0dGFjaC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhdHRhY2godCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgRm4uY29weSh0aGlzLm1hdHJpeFdvcmxkKS5pbnZlcnQoKSwgdC5wYXJlbnQgIT09IG51bGwgJiYgKHQucGFyZW50LnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIEZuLm11bHRpcGx5KHQucGFyZW50Lm1hdHJpeFdvcmxkKSksIHQuYXBwbHlNYXRyaXg0KEZuKSwgdC5yZW1vdmVGcm9tUGFyZW50KCksIHQucGFyZW50ID0gdGhpcywgdGhpcy5jaGlsZHJlbi5wdXNoKHQpLCB0LnVwZGF0ZVdvcmxkTWF0cml4KCExLCAhMCksIHQuZGlzcGF0Y2hFdmVudChWZiksIEVyLmNoaWxkID0gdCwgdGhpcy5kaXNwYXRjaEV2ZW50KEVyKSwgRXIuY2hpbGQgPSBudWxsLCB0aGlzOwogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSAzRCBvYmplY3QgYW5kIGl0cyBjaGlsZHJlbiwgc3RhcnRpbmcgd2l0aCB0aGUgM0Qgb2JqZWN0CiAgICogaXRzZWxmLCBhbmQgcmV0dXJucyB0aGUgZmlyc3Qgd2l0aCBhIG1hdGNoaW5nIElELgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGlkIC0gVGhlIGlkLgogICAqIEByZXR1cm4ge09iamVjdDNEfHVuZGVmaW5lZH0gVGhlIGZvdW5kIDNEIG9iamVjdC4gUmV0dXJucyBgdW5kZWZpbmVkYCBpZiBubyAzRCBvYmplY3QgaGFzIGJlZW4gZm91bmQuCiAgICovCiAgZ2V0T2JqZWN0QnlJZCh0KSB7CiAgICByZXR1cm4gdGhpcy5nZXRPYmplY3RCeVByb3BlcnR5KCJpZCIsIHQpOwogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSAzRCBvYmplY3QgYW5kIGl0cyBjaGlsZHJlbiwgc3RhcnRpbmcgd2l0aCB0aGUgM0Qgb2JqZWN0CiAgICogaXRzZWxmLCBhbmQgcmV0dXJucyB0aGUgZmlyc3Qgd2l0aCBhIG1hdGNoaW5nIG5hbWUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lLgogICAqIEByZXR1cm4ge09iamVjdDNEfHVuZGVmaW5lZH0gVGhlIGZvdW5kIDNEIG9iamVjdC4gUmV0dXJucyBgdW5kZWZpbmVkYCBpZiBubyAzRCBvYmplY3QgaGFzIGJlZW4gZm91bmQuCiAgICovCiAgZ2V0T2JqZWN0QnlOYW1lKHQpIHsKICAgIHJldHVybiB0aGlzLmdldE9iamVjdEJ5UHJvcGVydHkoIm5hbWUiLCB0KTsKICB9CiAgLyoqCiAgICogU2VhcmNoZXMgdGhyb3VnaCB0aGUgM0Qgb2JqZWN0IGFuZCBpdHMgY2hpbGRyZW4sIHN0YXJ0aW5nIHdpdGggdGhlIDNEIG9iamVjdAogICAqIGl0c2VsZiwgYW5kIHJldHVybnMgdGhlIGZpcnN0IHdpdGggYSBtYXRjaGluZyBwcm9wZXJ0eSB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5LgogICAqIEBwYXJhbSB7YW55fSB2YWx1ZSAtIFRoZSB2YWx1ZS4KICAgKiBAcmV0dXJuIHtPYmplY3QzRHx1bmRlZmluZWR9IFRoZSBmb3VuZCAzRCBvYmplY3QuIFJldHVybnMgYHVuZGVmaW5lZGAgaWYgbm8gM0Qgb2JqZWN0IGhhcyBiZWVuIGZvdW5kLgogICAqLwogIGdldE9iamVjdEJ5UHJvcGVydHkodCwgZSkgewogICAgaWYgKHRoaXNbdF0gPT09IGUpIHJldHVybiB0aGlzOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5jaGlsZHJlbltpXS5nZXRPYmplY3RCeVByb3BlcnR5KHQsIGUpOwogICAgICBpZiAociAhPT0gdm9pZCAwKQogICAgICAgIHJldHVybiByOwogICAgfQogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSAzRCBvYmplY3QgYW5kIGl0cyBjaGlsZHJlbiwgc3RhcnRpbmcgd2l0aCB0aGUgM0Qgb2JqZWN0CiAgICogaXRzZWxmLCBhbmQgcmV0dXJucyBhbGwgM0Qgb2JqZWN0cyB3aXRoIGEgbWF0Y2hpbmcgcHJvcGVydHkgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eS4KICAgKiBAcGFyYW0ge2FueX0gdmFsdWUgLSBUaGUgdmFsdWUuCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3QzRD59IHJlc3VsdCAtIFRoZSBtZXRob2Qgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxPYmplY3QzRD59IFRoZSBmb3VuZCAzRCBvYmplY3RzLgogICAqLwogIGdldE9iamVjdHNCeVByb3BlcnR5KHQsIGUsIGkgPSBbXSkgewogICAgdGhpc1t0XSA9PT0gZSAmJiBpLnB1c2godGhpcyk7CiAgICBjb25zdCBuID0gdGhpcy5jaGlsZHJlbjsKICAgIGZvciAobGV0IHMgPSAwLCByID0gbi5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgIG5bc10uZ2V0T2JqZWN0c0J5UHJvcGVydHkodCwgZSwgaSk7CiAgICByZXR1cm4gaTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSAzRCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgc3RvcmVkIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSAzRCBvYmplY3QncyBwb3NpdGlvbiBpbiB3b3JsZCBzcGFjZS4KICAgKi8KICBnZXRXb3JsZFBvc2l0aW9uKHQpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHQuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubWF0cml4V29ybGQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgUXVhdGVybmlvbiByZXByZXNlbnRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSAzRCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHRhcmdldCAtIFRoZSB0YXJnZXQgUXVhdGVybmlvbiB0aGUgcmVzdWx0IGlzIHN0b3JlZCB0by4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBUaGUgM0Qgb2JqZWN0J3Mgcm90YXRpb24gaW4gd29ybGQgc3BhY2UuCiAgICovCiAgZ2V0V29ybGRRdWF0ZXJuaW9uKHQpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHRoaXMubWF0cml4V29ybGQuZGVjb21wb3NlKE5hLCB0LCBTdiksIHQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSB2ZWN0b3IgcmVwcmVzZW50aW5nIHRoZSBzY2FsZSBvZiB0aGUgM0Qgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGUgcmVzdWx0IGlzIHN0b3JlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgM0Qgb2JqZWN0J3Mgc2NhbGUgaW4gd29ybGQgc3BhY2UuCiAgICovCiAgZ2V0V29ybGRTY2FsZSh0KSB7CiAgICByZXR1cm4gdGhpcy51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0aGlzLm1hdHJpeFdvcmxkLmRlY29tcG9zZShOYSwgd3YsIHQpLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgKCJsb29rIikgZGlyZWN0aW9uIG9mIHRoZSAzRCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgc3RvcmVkIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSAzRCBvYmplY3QncyBkaXJlY3Rpb24gaW4gd29ybGQgc3BhY2UuCiAgICovCiAgZ2V0V29ybGREaXJlY3Rpb24odCkgewogICAgdGhpcy51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpOwogICAgY29uc3QgZSA9IHRoaXMubWF0cml4V29ybGQuZWxlbWVudHM7CiAgICByZXR1cm4gdC5zZXQoZVs4XSwgZVs5XSwgZVsxMF0pLm5vcm1hbGl6ZSgpOwogIH0KICAvKioKICAgKiBBYnN0cmFjdCBtZXRob2QgdG8gZ2V0IGludGVyc2VjdGlvbnMgYmV0d2VlbiBhIGNhc3RlZCByYXkgYW5kIHRoaXMKICAgKiAzRCBvYmplY3QuIFJlbmRlcmFibGUgM0Qgb2JqZWN0cyBzdWNoIGFzIHtAbGluayBNZXNofSwge0BsaW5rIExpbmV9IG9yIHtAbGluayBQb2ludHN9CiAgICogaW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIG9yZGVyIHRvIHVzZSByYXljYXN0aW5nLgogICAqCiAgICogQGFic3RyYWN0CiAgICogQHBhcmFtIHtSYXljYXN0ZXJ9IHJheWNhc3RlciAtIFRoZSByYXljYXN0ZXIuCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBpbnRlcnNlY3RzIC0gQW4gYXJyYXkgaG9sZGluZyB0aGUgcmVzdWx0IG9mIHRoZSBtZXRob2QuCiAgICovCiAgcmF5Y2FzdCgpIHsKICB9CiAgLyoqCiAgICogRXhlY3V0ZXMgdGhlIGNhbGxiYWNrIG9uIHRoaXMgM0Qgb2JqZWN0IGFuZCBhbGwgZGVzY2VuZGFudHMuCiAgICoKICAgKiBOb3RlOiBNb2RpZnlpbmcgdGhlIHNjZW5lIGdyYXBoIGluc2lkZSB0aGUgY2FsbGJhY2sgaXMgZGlzY291cmFnZWQuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBhbGxvd3MgdG8gcHJvY2VzcyB0aGUgY3VycmVudCAzRCBvYmplY3QuCiAgICovCiAgdHJhdmVyc2UodCkgewogICAgdCh0aGlzKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS50cmF2ZXJzZSh0KTsKICB9CiAgLyoqCiAgICogTGlrZSB7QGxpbmsgT2JqZWN0M0QjdHJhdmVyc2V9LCBidXQgdGhlIGNhbGxiYWNrIHdpbGwgb25seSBiZSBleGVjdXRlZCBmb3IgdmlzaWJsZSAzRCBvYmplY3RzLgogICAqIERlc2NlbmRhbnRzIG9mIGludmlzaWJsZSAzRCBvYmplY3RzIGFyZSBub3QgdHJhdmVyc2VkLgogICAqCiAgICogTm90ZTogTW9kaWZ5aW5nIHRoZSBzY2VuZSBncmFwaCBpbnNpZGUgdGhlIGNhbGxiYWNrIGlzIGRpc2NvdXJhZ2VkLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIHRvIHByb2Nlc3MgdGhlIGN1cnJlbnQgM0Qgb2JqZWN0LgogICAqLwogIHRyYXZlcnNlVmlzaWJsZSh0KSB7CiAgICBpZiAodGhpcy52aXNpYmxlID09PSAhMSkgcmV0dXJuOwogICAgdCh0aGlzKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS50cmF2ZXJzZVZpc2libGUodCk7CiAgfQogIC8qKgogICAqIExpa2Uge0BsaW5rIE9iamVjdDNEI3RyYXZlcnNlfSwgYnV0IHRoZSBjYWxsYmFjayB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgZm9yIGFsbCBhbmNlc3RvcnMuCiAgICoKICAgKiBOb3RlOiBNb2RpZnlpbmcgdGhlIHNjZW5lIGdyYXBoIGluc2lkZSB0aGUgY2FsbGJhY2sgaXMgZGlzY291cmFnZWQuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBhbGxvd3MgdG8gcHJvY2VzcyB0aGUgY3VycmVudCAzRCBvYmplY3QuCiAgICovCiAgdHJhdmVyc2VBbmNlc3RvcnModCkgewogICAgY29uc3QgZSA9IHRoaXMucGFyZW50OwogICAgZSAhPT0gbnVsbCAmJiAodChlKSwgZS50cmF2ZXJzZUFuY2VzdG9ycyh0KSk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCBpbiBsb2NhbCBzcGFjZSBieSBjb21wdXRpbmcgaXQgZnJvbSB0aGUgY3VycmVudAogICAqIHBvc2l0aW9uLCByb3RhdGlvbiBhbmQgc2NhbGUgdmFsdWVzLgogICAqLwogIHVwZGF0ZU1hdHJpeCgpIHsKICAgIHRoaXMubWF0cml4LmNvbXBvc2UodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCB0aGlzLnNjYWxlKSwgdGhpcy5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gITA7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCBpbiB3b3JsZCBzcGFjZSBvZiB0aGlzIDNEIG9iamVjdHMgYW5kIGl0cyBkZXNjZW5kYW50cy4KICAgKgogICAqIFRvIGVuc3VyZSBjb3JyZWN0IHJlc3VsdHMsIHRoaXMgbWV0aG9kIGFsc28gcmVjb21wdXRlcyB0aGUgM0Qgb2JqZWN0J3MgdHJhbnNmb3JtYXRpb24gbWF0cml4IGluCiAgICogbG9jYWwgc3BhY2UuIFRoZSBjb21wdXRhdGlvbiBvZiB0aGUgbG9jYWwgYW5kIHdvcmxkIG1hdHJpeCBjYW4gYmUgY29udHJvbGxlZCB3aXRoIHRoZQogICAqIHtAbGluayBPYmplY3QzRCNtYXRyaXhBdXRvVXBkYXRlfSBhbmQge0BsaW5rIE9iamVjdDNEI21hdHJpeFdvcmxkQXV0b1VwZGF0ZX0gZmxhZ3Mgd2hpY2ggYXJlIGJvdGgKICAgKiBgdHJ1ZWAgYnkgZGVmYXVsdC4gIFNldCB0aGVzZSBmbGFncyB0byBgZmFsc2VgIGlmIHlvdSBuZWVkIG1vcmUgY29udHJvbCBvdmVyIHRoZSB1cGRhdGUgbWF0cml4IHByb2Nlc3MuCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmb3JjZT1mYWxzZV0gLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGEgcmVjb21wdXRhdGlvbiBvZiB3b3JsZCBtYXRyaWNlcyBpcyBmb3JjZWQgZXZlbgogICAqIHdoZW4ge0BsaW5rIE9iamVjdDNEI21hdHJpeFdvcmxkQXV0b1VwZGF0ZX0gaXMgc2V0IHRvIGBmYWxzZWAuCiAgICovCiAgdXBkYXRlTWF0cml4V29ybGQodCkgewogICAgdGhpcy5tYXRyaXhBdXRvVXBkYXRlICYmIHRoaXMudXBkYXRlTWF0cml4KCksICh0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgfHwgdCkgJiYgKHRoaXMubWF0cml4V29ybGRBdXRvVXBkYXRlID09PSAhMCAmJiAodGhpcy5wYXJlbnQgPT09IG51bGwgPyB0aGlzLm1hdHJpeFdvcmxkLmNvcHkodGhpcy5tYXRyaXgpIDogdGhpcy5tYXRyaXhXb3JsZC5tdWx0aXBseU1hdHJpY2VzKHRoaXMucGFyZW50Lm1hdHJpeFdvcmxkLCB0aGlzLm1hdHJpeCkpLCB0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSAhMSwgdCA9ICEwKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS51cGRhdGVNYXRyaXhXb3JsZCh0KTsKICB9CiAgLyoqCiAgICogQW4gYWx0ZXJuYXRpdmUgdmVyc2lvbiBvZiB7QGxpbmsgT2JqZWN0M0QjdXBkYXRlTWF0cml4V29ybGR9IHdpdGggbW9yZSBjb250cm9sIG92ZXIgdGhlCiAgICogdXBkYXRlIG9mIGFuY2VzdG9yIGFuZCBkZXNjZW5kYW50IG5vZGVzLgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBbdXBkYXRlUGFyZW50cz1mYWxzZV0gV2hldGhlciBhbmNlc3RvciBub2RlcyBzaG91bGQgYmUgdXBkYXRlZCBvciBub3QuCiAgICogQHBhcmFtIHtib29sZWFufSBbdXBkYXRlQ2hpbGRyZW49ZmFsc2VdIFdoZXRoZXIgZGVzY2VuZGFudCBub2RlcyBzaG91bGQgYmUgdXBkYXRlZCBvciBub3QuCiAgICovCiAgdXBkYXRlV29ybGRNYXRyaXgodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMucGFyZW50OwogICAgaWYgKHQgPT09ICEwICYmIGkgIT09IG51bGwgJiYgaS51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgJiYgdGhpcy51cGRhdGVNYXRyaXgoKSwgdGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09ICEwICYmICh0aGlzLnBhcmVudCA9PT0gbnVsbCA/IHRoaXMubWF0cml4V29ybGQuY29weSh0aGlzLm1hdHJpeCkgOiB0aGlzLm1hdHJpeFdvcmxkLm11bHRpcGx5TWF0cmljZXModGhpcy5wYXJlbnQubWF0cml4V29ybGQsIHRoaXMubWF0cml4KSksIGUgPT09ICEwKSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLmNoaWxkcmVuOwogICAgICBmb3IgKGxldCBzID0gMCwgciA9IG4ubGVuZ3RoOyBzIDwgcjsgcysrKQogICAgICAgIG5bc10udXBkYXRlV29ybGRNYXRyaXgoITEsICEwKTsKICAgIH0KICB9CiAgLyoqCiAgICogU2VyaWFsaXplcyB0aGUgM0Qgb2JqZWN0IGludG8gSlNPTi4KICAgKgogICAqIEBwYXJhbSB7PyhPYmplY3R8c3RyaW5nKX0gbWV0YSAtIEFuIG9wdGlvbmFsIHZhbHVlIGhvbGRpbmcgbWV0YSBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VyaWFsaXphdGlvbi4KICAgKiBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIDNEIG9iamVjdC4KICAgKiBAc2VlIHtAbGluayBPYmplY3RMb2FkZXIjcGFyc2V9CiAgICovCiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSB0ID09PSB2b2lkIDAgfHwgdHlwZW9mIHQgPT0gInN0cmluZyIsIGkgPSB7fTsKICAgIGUgJiYgKHQgPSB7CiAgICAgIGdlb21ldHJpZXM6IHt9LAogICAgICBtYXRlcmlhbHM6IHt9LAogICAgICB0ZXh0dXJlczoge30sCiAgICAgIGltYWdlczoge30sCiAgICAgIHNoYXBlczoge30sCiAgICAgIHNrZWxldG9uczoge30sCiAgICAgIGFuaW1hdGlvbnM6IHt9LAogICAgICBub2Rlczoge30KICAgIH0sIGkubWV0YWRhdGEgPSB7CiAgICAgIHZlcnNpb246IDQuNywKICAgICAgdHlwZTogIk9iamVjdCIsCiAgICAgIGdlbmVyYXRvcjogIk9iamVjdDNELnRvSlNPTiIKICAgIH0pOwogICAgY29uc3QgbiA9IHt9OwogICAgbi51dWlkID0gdGhpcy51dWlkLCBuLnR5cGUgPSB0aGlzLnR5cGUsIHRoaXMubmFtZSAhPT0gIiIgJiYgKG4ubmFtZSA9IHRoaXMubmFtZSksIHRoaXMuY2FzdFNoYWRvdyA9PT0gITAgJiYgKG4uY2FzdFNoYWRvdyA9ICEwKSwgdGhpcy5yZWNlaXZlU2hhZG93ID09PSAhMCAmJiAobi5yZWNlaXZlU2hhZG93ID0gITApLCB0aGlzLnZpc2libGUgPT09ICExICYmIChuLnZpc2libGUgPSAhMSksIHRoaXMuZnJ1c3R1bUN1bGxlZCA9PT0gITEgJiYgKG4uZnJ1c3R1bUN1bGxlZCA9ICExKSwgdGhpcy5yZW5kZXJPcmRlciAhPT0gMCAmJiAobi5yZW5kZXJPcmRlciA9IHRoaXMucmVuZGVyT3JkZXIpLCBPYmplY3Qua2V5cyh0aGlzLnVzZXJEYXRhKS5sZW5ndGggPiAwICYmIChuLnVzZXJEYXRhID0gdGhpcy51c2VyRGF0YSksIG4ubGF5ZXJzID0gdGhpcy5sYXllcnMubWFzaywgbi5tYXRyaXggPSB0aGlzLm1hdHJpeC50b0FycmF5KCksIG4udXAgPSB0aGlzLnVwLnRvQXJyYXkoKSwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID09PSAhMSAmJiAobi5tYXRyaXhBdXRvVXBkYXRlID0gITEpLCB0aGlzLmlzSW5zdGFuY2VkTWVzaCAmJiAobi50eXBlID0gIkluc3RhbmNlZE1lc2giLCBuLmNvdW50ID0gdGhpcy5jb3VudCwgbi5pbnN0YW5jZU1hdHJpeCA9IHRoaXMuaW5zdGFuY2VNYXRyaXgudG9KU09OKCksIHRoaXMuaW5zdGFuY2VDb2xvciAhPT0gbnVsbCAmJiAobi5pbnN0YW5jZUNvbG9yID0gdGhpcy5pbnN0YW5jZUNvbG9yLnRvSlNPTigpKSksIHRoaXMuaXNCYXRjaGVkTWVzaCAmJiAobi50eXBlID0gIkJhdGNoZWRNZXNoIiwgbi5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkID0gdGhpcy5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkLCBuLnNvcnRPYmplY3RzID0gdGhpcy5zb3J0T2JqZWN0cywgbi5kcmF3UmFuZ2VzID0gdGhpcy5fZHJhd1Jhbmdlcywgbi5yZXNlcnZlZFJhbmdlcyA9IHRoaXMuX3Jlc2VydmVkUmFuZ2VzLCBuLmdlb21ldHJ5SW5mbyA9IHRoaXMuX2dlb21ldHJ5SW5mby5tYXAoKG8pID0+ICh7CiAgICAgIC4uLm8sCiAgICAgIGJvdW5kaW5nQm94OiBvLmJvdW5kaW5nQm94ID8gby5ib3VuZGluZ0JveC50b0pTT04oKSA6IHZvaWQgMCwKICAgICAgYm91bmRpbmdTcGhlcmU6IG8uYm91bmRpbmdTcGhlcmUgPyBvLmJvdW5kaW5nU3BoZXJlLnRvSlNPTigpIDogdm9pZCAwCiAgICB9KSksIG4uaW5zdGFuY2VJbmZvID0gdGhpcy5faW5zdGFuY2VJbmZvLm1hcCgobykgPT4gKHsgLi4ubyB9KSksIG4uYXZhaWxhYmxlSW5zdGFuY2VJZHMgPSB0aGlzLl9hdmFpbGFibGVJbnN0YW5jZUlkcy5zbGljZSgpLCBuLmF2YWlsYWJsZUdlb21ldHJ5SWRzID0gdGhpcy5fYXZhaWxhYmxlR2VvbWV0cnlJZHMuc2xpY2UoKSwgbi5uZXh0SW5kZXhTdGFydCA9IHRoaXMuX25leHRJbmRleFN0YXJ0LCBuLm5leHRWZXJ0ZXhTdGFydCA9IHRoaXMuX25leHRWZXJ0ZXhTdGFydCwgbi5nZW9tZXRyeUNvdW50ID0gdGhpcy5fZ2VvbWV0cnlDb3VudCwgbi5tYXhJbnN0YW5jZUNvdW50ID0gdGhpcy5fbWF4SW5zdGFuY2VDb3VudCwgbi5tYXhWZXJ0ZXhDb3VudCA9IHRoaXMuX21heFZlcnRleENvdW50LCBuLm1heEluZGV4Q291bnQgPSB0aGlzLl9tYXhJbmRleENvdW50LCBuLmdlb21ldHJ5SW5pdGlhbGl6ZWQgPSB0aGlzLl9nZW9tZXRyeUluaXRpYWxpemVkLCBuLm1hdHJpY2VzVGV4dHVyZSA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZS50b0pTT04odCksIG4uaW5kaXJlY3RUZXh0dXJlID0gdGhpcy5faW5kaXJlY3RUZXh0dXJlLnRvSlNPTih0KSwgdGhpcy5fY29sb3JzVGV4dHVyZSAhPT0gbnVsbCAmJiAobi5jb2xvcnNUZXh0dXJlID0gdGhpcy5fY29sb3JzVGV4dHVyZS50b0pTT04odCkpLCB0aGlzLmJvdW5kaW5nU3BoZXJlICE9PSBudWxsICYmIChuLmJvdW5kaW5nU3BoZXJlID0gdGhpcy5ib3VuZGluZ1NwaGVyZS50b0pTT04oKSksIHRoaXMuYm91bmRpbmdCb3ggIT09IG51bGwgJiYgKG4uYm91bmRpbmdCb3ggPSB0aGlzLmJvdW5kaW5nQm94LnRvSlNPTigpKSk7CiAgICBmdW5jdGlvbiBzKG8sIGwpIHsKICAgICAgcmV0dXJuIG9bbC51dWlkXSA9PT0gdm9pZCAwICYmIChvW2wudXVpZF0gPSBsLnRvSlNPTih0KSksIGwudXVpZDsKICAgIH0KICAgIGlmICh0aGlzLmlzU2NlbmUpCiAgICAgIHRoaXMuYmFja2dyb3VuZCAmJiAodGhpcy5iYWNrZ3JvdW5kLmlzQ29sb3IgPyBuLmJhY2tncm91bmQgPSB0aGlzLmJhY2tncm91bmQudG9KU09OKCkgOiB0aGlzLmJhY2tncm91bmQuaXNUZXh0dXJlICYmIChuLmJhY2tncm91bmQgPSB0aGlzLmJhY2tncm91bmQudG9KU09OKHQpLnV1aWQpKSwgdGhpcy5lbnZpcm9ubWVudCAmJiB0aGlzLmVudmlyb25tZW50LmlzVGV4dHVyZSAmJiB0aGlzLmVudmlyb25tZW50LmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSAhPT0gITAgJiYgKG4uZW52aXJvbm1lbnQgPSB0aGlzLmVudmlyb25tZW50LnRvSlNPTih0KS51dWlkKTsKICAgIGVsc2UgaWYgKHRoaXMuaXNNZXNoIHx8IHRoaXMuaXNMaW5lIHx8IHRoaXMuaXNQb2ludHMpIHsKICAgICAgbi5nZW9tZXRyeSA9IHModC5nZW9tZXRyaWVzLCB0aGlzLmdlb21ldHJ5KTsKICAgICAgY29uc3QgbyA9IHRoaXMuZ2VvbWV0cnkucGFyYW1ldGVyczsKICAgICAgaWYgKG8gIT09IHZvaWQgMCAmJiBvLnNoYXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgY29uc3QgbCA9IG8uc2hhcGVzOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGwpKQogICAgICAgICAgZm9yIChsZXQgaCA9IDAsIGMgPSBsLmxlbmd0aDsgaCA8IGM7IGgrKykgewogICAgICAgICAgICBjb25zdCB1ID0gbFtoXTsKICAgICAgICAgICAgcyh0LnNoYXBlcywgdSk7CiAgICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgcyh0LnNoYXBlcywgbCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLmlzU2tpbm5lZE1lc2ggJiYgKG4uYmluZE1vZGUgPSB0aGlzLmJpbmRNb2RlLCBuLmJpbmRNYXRyaXggPSB0aGlzLmJpbmRNYXRyaXgudG9BcnJheSgpLCB0aGlzLnNrZWxldG9uICE9PSB2b2lkIDAgJiYgKHModC5za2VsZXRvbnMsIHRoaXMuc2tlbGV0b24pLCBuLnNrZWxldG9uID0gdGhpcy5za2VsZXRvbi51dWlkKSksIHRoaXMubWF0ZXJpYWwgIT09IHZvaWQgMCkKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5tYXRlcmlhbCkpIHsKICAgICAgICBjb25zdCBvID0gW107CiAgICAgICAgZm9yIChsZXQgbCA9IDAsIGggPSB0aGlzLm1hdGVyaWFsLmxlbmd0aDsgbCA8IGg7IGwrKykKICAgICAgICAgIG8ucHVzaChzKHQubWF0ZXJpYWxzLCB0aGlzLm1hdGVyaWFsW2xdKSk7CiAgICAgICAgbi5tYXRlcmlhbCA9IG87CiAgICAgIH0gZWxzZQogICAgICAgIG4ubWF0ZXJpYWwgPSBzKHQubWF0ZXJpYWxzLCB0aGlzLm1hdGVyaWFsKTsKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgbi5jaGlsZHJlbiA9IFtdOwogICAgICBmb3IgKGxldCBvID0gMDsgbyA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBvKyspCiAgICAgICAgbi5jaGlsZHJlbi5wdXNoKHRoaXMuY2hpbGRyZW5bb10udG9KU09OKHQpLm9iamVjdCk7CiAgICB9CiAgICBpZiAodGhpcy5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgbi5hbmltYXRpb25zID0gW107CiAgICAgIGZvciAobGV0IG8gPSAwOyBvIDwgdGhpcy5hbmltYXRpb25zLmxlbmd0aDsgbysrKSB7CiAgICAgICAgY29uc3QgbCA9IHRoaXMuYW5pbWF0aW9uc1tvXTsKICAgICAgICBuLmFuaW1hdGlvbnMucHVzaChzKHQuYW5pbWF0aW9ucywgbCkpOwogICAgICB9CiAgICB9CiAgICBpZiAoZSkgewogICAgICBjb25zdCBvID0gcih0Lmdlb21ldHJpZXMpLCBsID0gcih0Lm1hdGVyaWFscyksIGggPSByKHQudGV4dHVyZXMpLCBjID0gcih0LmltYWdlcyksIHUgPSByKHQuc2hhcGVzKSwgZCA9IHIodC5za2VsZXRvbnMpLCBwID0gcih0LmFuaW1hdGlvbnMpLCBmID0gcih0Lm5vZGVzKTsKICAgICAgby5sZW5ndGggPiAwICYmIChpLmdlb21ldHJpZXMgPSBvKSwgbC5sZW5ndGggPiAwICYmIChpLm1hdGVyaWFscyA9IGwpLCBoLmxlbmd0aCA+IDAgJiYgKGkudGV4dHVyZXMgPSBoKSwgYy5sZW5ndGggPiAwICYmIChpLmltYWdlcyA9IGMpLCB1Lmxlbmd0aCA+IDAgJiYgKGkuc2hhcGVzID0gdSksIGQubGVuZ3RoID4gMCAmJiAoaS5za2VsZXRvbnMgPSBkKSwgcC5sZW5ndGggPiAwICYmIChpLmFuaW1hdGlvbnMgPSBwKSwgZi5sZW5ndGggPiAwICYmIChpLm5vZGVzID0gZik7CiAgICB9CiAgICByZXR1cm4gaS5vYmplY3QgPSBuLCBpOwogICAgZnVuY3Rpb24gcihvKSB7CiAgICAgIGNvbnN0IGwgPSBbXTsKICAgICAgZm9yIChjb25zdCBoIGluIG8pIHsKICAgICAgICBjb25zdCBjID0gb1toXTsKICAgICAgICBkZWxldGUgYy5tZXRhZGF0YSwgbC5wdXNoKGMpOwogICAgICB9CiAgICAgIHJldHVybiBsOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IDNEIG9iamVjdCB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBbcmVjdXJzaXZlPXRydWVdIC0gV2hlbiBzZXQgdG8gYHRydWVgLCBkZXNjZW5kYW50cyBvZiB0aGUgM0Qgb2JqZWN0IGFyZSBhbHNvIGNsb25lZC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKHQpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcywgdCk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiAzRCBvYmplY3QgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IHNvdXJjZSAtIFRoZSAzRCBvYmplY3QgdG8gY29weS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZWN1cnNpdmU9dHJ1ZV0gLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGRlc2NlbmRhbnRzIG9mIHRoZSAzRCBvYmplY3QgYXJlIGNsb25lZC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQsIGUgPSAhMCkgewogICAgaWYgKHRoaXMubmFtZSA9IHQubmFtZSwgdGhpcy51cC5jb3B5KHQudXApLCB0aGlzLnBvc2l0aW9uLmNvcHkodC5wb3NpdGlvbiksIHRoaXMucm90YXRpb24ub3JkZXIgPSB0LnJvdGF0aW9uLm9yZGVyLCB0aGlzLnF1YXRlcm5pb24uY29weSh0LnF1YXRlcm5pb24pLCB0aGlzLnNjYWxlLmNvcHkodC5zY2FsZSksIHRoaXMubWF0cml4LmNvcHkodC5tYXRyaXgpLCB0aGlzLm1hdHJpeFdvcmxkLmNvcHkodC5tYXRyaXhXb3JsZCksIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IHQubWF0cml4QXV0b1VwZGF0ZSwgdGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPSB0Lm1hdHJpeFdvcmxkQXV0b1VwZGF0ZSwgdGhpcy5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gdC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlLCB0aGlzLmxheWVycy5tYXNrID0gdC5sYXllcnMubWFzaywgdGhpcy52aXNpYmxlID0gdC52aXNpYmxlLCB0aGlzLmNhc3RTaGFkb3cgPSB0LmNhc3RTaGFkb3csIHRoaXMucmVjZWl2ZVNoYWRvdyA9IHQucmVjZWl2ZVNoYWRvdywgdGhpcy5mcnVzdHVtQ3VsbGVkID0gdC5mcnVzdHVtQ3VsbGVkLCB0aGlzLnJlbmRlck9yZGVyID0gdC5yZW5kZXJPcmRlciwgdGhpcy5hbmltYXRpb25zID0gdC5hbmltYXRpb25zLnNsaWNlKCksIHRoaXMudXNlckRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHQudXNlckRhdGEpKSwgZSA9PT0gITApCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdC5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IG4gPSB0LmNoaWxkcmVuW2ldOwogICAgICAgIHRoaXMuYWRkKG4uY2xvbmUoKSk7CiAgICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KfTsKbGUuREVGQVVMVF9VUCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgwLCAxLCAwKTsKbGUuREVGQVVMVF9NQVRSSVhfQVVUT19VUERBVEUgPSAhMDsKbGUuREVGQVVMVF9NQVRSSVhfV09STERfQVVUT19VUERBVEUgPSAhMDsKY29uc3QgSmkgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgVW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgVHUgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgQm4gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgVHIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgQ3IgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgSGYgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgQ3UgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgUnUgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgUHUgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgSXUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFF0KCksIEx1ID0gLyogQF9fUFVSRV9fICovIG5ldyBRdCgpLCBEdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUXQoKTsKbGV0IGJzID0gY2xhc3MgbmEgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgdHJpYW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFthPSgwLDAsMCldIC0gVGhlIGZpcnN0IGNvcm5lciBvZiB0aGUgdHJpYW5nbGUuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbYj0oMCwwLDApXSAtIFRoZSBzZWNvbmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFtjPSgwLDAsMCldIC0gVGhlIHRoaXJkIGNvcm5lciBvZiB0aGUgdHJpYW5nbGUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBFKCksIGUgPSBuZXcgRSgpLCBpID0gbmV3IEUoKSkgewogICAgdGhpcy5hID0gdCwgdGhpcy5iID0gZSwgdGhpcy5jID0gaTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIG5vcm1hbCB2ZWN0b3Igb2YgYSB0cmlhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGMgLSBUaGUgdGhpcmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSB0cmlhbmdsZSdzIG5vcm1hbC4KICAgKi8KICBzdGF0aWMgZ2V0Tm9ybWFsKHQsIGUsIGksIG4pIHsKICAgIG4uc3ViVmVjdG9ycyhpLCBlKSwgSmkuc3ViVmVjdG9ycyh0LCBlKSwgbi5jcm9zcyhKaSk7CiAgICBjb25zdCBzID0gbi5sZW5ndGhTcSgpOwogICAgcmV0dXJuIHMgPiAwID8gbi5tdWx0aXBseVNjYWxhcigxIC8gTWF0aC5zcXJ0KHMpKSA6IG4uc2V0KDAsIDAsIDApOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBhIGJhcnljZW50cmljIGNvb3JkaW5hdGVzIGZyb20gdGhlIGdpdmVuIHZlY3Rvci4KICAgKiBSZXR1cm5zIGBudWxsYCBpZiB0aGUgdHJpYW5nbGUgaXMgZGVnZW5lcmF0ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBBIHBvaW50IGluIDNEIHNwYWNlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGMgLSBUaGUgdGhpcmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4gez9WZWN0b3IzfSBUaGUgYmFyeWNlbnRyaWMgY29vcmRpbmF0ZXMgZm9yIHRoZSBnaXZlbiBwb2ludAogICAqLwogIHN0YXRpYyBnZXRCYXJ5Y29vcmQodCwgZSwgaSwgbiwgcykgewogICAgSmkuc3ViVmVjdG9ycyhuLCBlKSwgVW4uc3ViVmVjdG9ycyhpLCBlKSwgVHUuc3ViVmVjdG9ycyh0LCBlKTsKICAgIGNvbnN0IHIgPSBKaS5kb3QoSmkpLCBvID0gSmkuZG90KFVuKSwgbCA9IEppLmRvdChUdSksIGggPSBVbi5kb3QoVW4pLCBjID0gVW4uZG90KFR1KSwgdSA9IHIgKiBoIC0gbyAqIG87CiAgICBpZiAodSA9PT0gMCkKICAgICAgcmV0dXJuIHMuc2V0KDAsIDAsIDApLCBudWxsOwogICAgY29uc3QgZCA9IDEgLyB1LCBwID0gKGggKiBsIC0gbyAqIGMpICogZCwgZiA9IChyICogYyAtIG8gKiBsKSAqIGQ7CiAgICByZXR1cm4gcy5zZXQoMSAtIHAgLSBmLCBmLCBwKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHBvaW50LCB3aGVuIHByb2plY3RlZCBvbnRvIHRoZSBwbGFuZSBvZiB0aGUKICAgKiB0cmlhbmdsZSwgbGllcyB3aXRoaW4gdGhlIHRyaWFuZ2xlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwb2ludCAtIFRoZSBwb2ludCBpbiAzRCBzcGFjZSB0byB0ZXN0LgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGMgLSBUaGUgdGhpcmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBnaXZlbiBwb2ludCwgd2hlbiBwcm9qZWN0ZWQgb250byB0aGUgcGxhbmUgb2YgdGhlCiAgICogdHJpYW5nbGUsIGxpZXMgd2l0aGluIHRoZSB0cmlhbmdsZSBvciBub3QuCiAgICovCiAgc3RhdGljIGNvbnRhaW5zUG9pbnQodCwgZSwgaSwgbikgewogICAgcmV0dXJuIHRoaXMuZ2V0QmFyeWNvb3JkKHQsIGUsIGksIG4sIEJuKSA9PT0gbnVsbCA/ICExIDogQm4ueCA+PSAwICYmIEJuLnkgPj0gMCAmJiBCbi54ICsgQm4ueSA8PSAxOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgdmFsdWUgYmFyeWNlbnRyaWNhbGx5IGludGVycG9sYXRlZCBmb3IgdGhlIGdpdmVuIHBvaW50IG9uIHRoZQogICAqIHRyaWFuZ2xlLiBSZXR1cm5zIGBudWxsYCBpZiB0aGUgdHJpYW5nbGUgaXMgZGVnZW5lcmF0ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBQb3NpdGlvbiBvZiBpbnRlcnBvbGF0ZWQgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwMSAtIFRoZSBmaXJzdCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gcDIgLSBUaGUgc2Vjb25kIGNvcm5lciBvZiB0aGUgdHJpYW5nbGUuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwMyAtIFRoZSB0aGlyZCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdjEgLSBWYWx1ZSB0byBpbnRlcnBvbGF0ZSBvZiBmaXJzdCB2ZXJ0ZXguCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2MiAtIFZhbHVlIHRvIGludGVycG9sYXRlIG9mIHNlY29uZCB2ZXJ0ZXguCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2MyAtIFZhbHVlIHRvIGludGVycG9sYXRlIG9mIHRoaXJkIHZlcnRleC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4gez9WZWN0b3IzfSBUaGUgaW50ZXJwb2xhdGVkIHZhbHVlLgogICAqLwogIHN0YXRpYyBnZXRJbnRlcnBvbGF0aW9uKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwpIHsKICAgIHJldHVybiB0aGlzLmdldEJhcnljb29yZCh0LCBlLCBpLCBuLCBCbikgPT09IG51bGwgPyAobC54ID0gMCwgbC55ID0gMCwgInoiIGluIGwgJiYgKGwueiA9IDApLCAidyIgaW4gbCAmJiAobC53ID0gMCksIG51bGwpIDogKGwuc2V0U2NhbGFyKDApLCBsLmFkZFNjYWxlZFZlY3RvcihzLCBCbi54KSwgbC5hZGRTY2FsZWRWZWN0b3IociwgQm4ueSksIGwuYWRkU2NhbGVkVmVjdG9yKG8sIEJuLnopLCBsKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHZhbHVlIGJhcnljZW50cmljYWxseSBpbnRlcnBvbGF0ZWQgZm9yIHRoZSBnaXZlbiBhdHRyaWJ1dGUgYW5kIGluZGljZXMuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckF0dHJpYnV0ZX0gYXR0ciAtIFRoZSBhdHRyaWJ1dGUgdG8gaW50ZXJwb2xhdGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGkxIC0gSW5kZXggb2YgZmlyc3QgdmVydGV4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBpMiAtIEluZGV4IG9mIHNlY29uZCB2ZXJ0ZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGkzIC0gSW5kZXggb2YgdGhpcmQgdmVydGV4LgogICAqIEBwYXJhbSB7VmVjdG9yM30gYmFyeWNvb3JkIC0gVGhlIGJhcnljb29yZGluYXRlIHZhbHVlIHRvIHVzZSB0byBpbnRlcnBvbGF0ZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlIHZhbHVlLgogICAqLwogIHN0YXRpYyBnZXRJbnRlcnBvbGF0ZWRBdHRyaWJ1dGUodCwgZSwgaSwgbiwgcywgcikgewogICAgcmV0dXJuIEl1LnNldFNjYWxhcigwKSwgTHUuc2V0U2NhbGFyKDApLCBEdS5zZXRTY2FsYXIoMCksIEl1LmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSksIEx1LmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgaSksIER1LmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgbiksIHIuc2V0U2NhbGFyKDApLCByLmFkZFNjYWxlZFZlY3RvcihJdSwgcy54KSwgci5hZGRTY2FsZWRWZWN0b3IoTHUsIHMueSksIHIuYWRkU2NhbGVkVmVjdG9yKER1LCBzLnopLCByOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdHJpYW5nbGUgaXMgb3JpZW50ZWQgdG93YXJkcyB0aGUgZ2l2ZW4gZGlyZWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBhIC0gVGhlIGZpcnN0IGNvcm5lciBvZiB0aGUgdHJpYW5nbGUuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBiIC0gVGhlIHNlY29uZCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYyAtIFRoZSB0aGlyZCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gZGlyZWN0aW9uIC0gVGhlIChub3JtYWxpemVkKSBkaXJlY3Rpb24gdmVjdG9yLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHRyaWFuZ2xlIGlzIG9yaWVudGVkIHRvd2FyZHMgdGhlIGdpdmVuIGRpcmVjdGlvbiBvciBub3QuCiAgICovCiAgc3RhdGljIGlzRnJvbnRGYWNpbmcodCwgZSwgaSwgbikgewogICAgcmV0dXJuIEppLnN1YlZlY3RvcnMoaSwgZSksIFVuLnN1YlZlY3RvcnModCwgZSksIEppLmNyb3NzKFVuKS5kb3QobikgPCAwOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB0cmlhbmdsZSdzIHZlcnRpY2VzIGJ5IGNvcHlpbmcgdGhlIGdpdmVuIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGMgLSBUaGUgdGhpcmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcmV0dXJuIHtUcmlhbmdsZX0gQSByZWZlcmVuY2UgdG8gdGhpcyB0cmlhbmdsZS4KICAgKi8KICBzZXQodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMuYS5jb3B5KHQpLCB0aGlzLmIuY29weShlKSwgdGhpcy5jLmNvcHkoaSksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHRyaWFuZ2xlJ3MgdmVydGljZXMgYnkgY29weWluZyB0aGUgZ2l2ZW4gYXJyYXkgdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxWZWN0b3IzPn0gcG9pbnRzIC0gQW4gYXJyYXkgd2l0aCAzRCBwb2ludHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGkwIC0gVGhlIGFycmF5IGluZGV4IHJlcHJlc2VudGluZyB0aGUgZmlyc3QgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaTEgLSBUaGUgYXJyYXkgaW5kZXggcmVwcmVzZW50aW5nIHRoZSBzZWNvbmQgY29ybmVyIG9mIHRoZSB0cmlhbmdsZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaTIgLSBUaGUgYXJyYXkgaW5kZXggcmVwcmVzZW50aW5nIHRoZSB0aGlyZCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEByZXR1cm4ge1RyaWFuZ2xlfSBBIHJlZmVyZW5jZSB0byB0aGlzIHRyaWFuZ2xlLgogICAqLwogIHNldEZyb21Qb2ludHNBbmRJbmRpY2VzKHQsIGUsIGksIG4pIHsKICAgIHJldHVybiB0aGlzLmEuY29weSh0W2VdKSwgdGhpcy5iLmNvcHkodFtpXSksIHRoaXMuYy5jb3B5KHRbbl0pLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB0cmlhbmdsZSdzIHZlcnRpY2VzIGJ5IGNvcHlpbmcgdGhlIGdpdmVuIGF0dHJpYnV0ZSB2YWx1ZXMuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckF0dHJpYnV0ZX0gYXR0cmlidXRlIC0gQSBidWZmZXIgYXR0cmlidXRlIHdpdGggM0QgcG9pbnRzIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGkwIC0gVGhlIGF0dHJpYnV0ZSBpbmRleCByZXByZXNlbnRpbmcgdGhlIGZpcnN0IGNvcm5lciBvZiB0aGUgdHJpYW5nbGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGkxIC0gVGhlIGF0dHJpYnV0ZSBpbmRleCByZXByZXNlbnRpbmcgdGhlIHNlY29uZCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpMiAtIFRoZSBhdHRyaWJ1dGUgaW5kZXggcmVwcmVzZW50aW5nIHRoZSB0aGlyZCBjb3JuZXIgb2YgdGhlIHRyaWFuZ2xlLgogICAqIEByZXR1cm4ge1RyaWFuZ2xlfSBBIHJlZmVyZW5jZSB0byB0aGlzIHRyaWFuZ2xlLgogICAqLwogIHNldEZyb21BdHRyaWJ1dGVBbmRJbmRpY2VzKHQsIGUsIGksIG4pIHsKICAgIHJldHVybiB0aGlzLmEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSwgdGhpcy5iLmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgaSksIHRoaXMuYy5mcm9tQnVmZmVyQXR0cmlidXRlKHQsIG4pLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHRyaWFuZ2xlIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtUcmlhbmdsZX0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHRyaWFuZ2xlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1RyaWFuZ2xlfSB0cmlhbmdsZSAtIFRoZSB0cmlhbmdsZSB0byBjb3B5LgogICAqIEByZXR1cm4ge1RyaWFuZ2xlfSBBIHJlZmVyZW5jZSB0byB0aGlzIHRyaWFuZ2xlLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuYS5jb3B5KHQuYSksIHRoaXMuYi5jb3B5KHQuYiksIHRoaXMuYy5jb3B5KHQuYyksIHRoaXM7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBhcmVhIG9mIHRoZSB0cmlhbmdsZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHRyaWFuZ2xlJ3MgYXJlYS4KICAgKi8KICBnZXRBcmVhKCkgewogICAgcmV0dXJuIEppLnN1YlZlY3RvcnModGhpcy5jLCB0aGlzLmIpLCBVbi5zdWJWZWN0b3JzKHRoaXMuYSwgdGhpcy5iKSwgSmkuY3Jvc3MoVW4pLmxlbmd0aCgpICogMC41OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgbWlkcG9pbnQgb2YgdGhlIHRyaWFuZ2xlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgdHJpYW5nbGUncyBtaWRwb2ludC4KICAgKi8KICBnZXRNaWRwb2ludCh0KSB7CiAgICByZXR1cm4gdC5hZGRWZWN0b3JzKHRoaXMuYSwgdGhpcy5iKS5hZGQodGhpcy5jKS5tdWx0aXBseVNjYWxhcigxIC8gMyk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBub3JtYWwgb2YgdGhlIHRyaWFuZ2xlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgdHJpYW5nbGUncyBub3JtYWwuCiAgICovCiAgZ2V0Tm9ybWFsKHQpIHsKICAgIHJldHVybiBuYS5nZXROb3JtYWwodGhpcy5hLCB0aGlzLmIsIHRoaXMuYywgdCk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGEgcGxhbmUgdGhlIHRyaWFuZ2xlIGxpZXMgd2l0aGluLgogICAqCiAgICogQHBhcmFtIHtQbGFuZX0gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7UGxhbmV9IFRoZSBwbGFuZSB0aGUgdHJpYW5nbGUgbGllcyB3aXRoaW4uCiAgICovCiAgZ2V0UGxhbmUodCkgewogICAgcmV0dXJuIHQuc2V0RnJvbUNvcGxhbmFyUG9pbnRzKHRoaXMuYSwgdGhpcy5iLCB0aGlzLmMpOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBhIGJhcnljZW50cmljIGNvb3JkaW5hdGVzIGZyb20gdGhlIGdpdmVuIHZlY3Rvci4KICAgKiBSZXR1cm5zIGBudWxsYCBpZiB0aGUgdHJpYW5nbGUgaXMgZGVnZW5lcmF0ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBBIHBvaW50IGluIDNEIHNwYWNlLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7P1ZlY3RvcjN9IFRoZSBiYXJ5Y2VudHJpYyBjb29yZGluYXRlcyBmb3IgdGhlIGdpdmVuIHBvaW50CiAgICovCiAgZ2V0QmFyeWNvb3JkKHQsIGUpIHsKICAgIHJldHVybiBuYS5nZXRCYXJ5Y29vcmQodCwgdGhpcy5hLCB0aGlzLmIsIHRoaXMuYywgZSk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSB2YWx1ZSBiYXJ5Y2VudHJpY2FsbHkgaW50ZXJwb2xhdGVkIGZvciB0aGUgZ2l2ZW4gcG9pbnQgb24gdGhlCiAgICogdHJpYW5nbGUuIFJldHVybnMgYG51bGxgIGlmIHRoZSB0cmlhbmdsZSBpcyBkZWdlbmVyYXRlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwb2ludCAtIFBvc2l0aW9uIG9mIGludGVycG9sYXRlZCBwb2ludC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYxIC0gVmFsdWUgdG8gaW50ZXJwb2xhdGUgb2YgZmlyc3QgdmVydGV4LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdjIgLSBWYWx1ZSB0byBpbnRlcnBvbGF0ZSBvZiBzZWNvbmQgdmVydGV4LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdjMgLSBWYWx1ZSB0byBpbnRlcnBvbGF0ZSBvZiB0aGlyZCB2ZXJ0ZXguCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHs/VmVjdG9yM30gVGhlIGludGVycG9sYXRlZCB2YWx1ZS4KICAgKi8KICBnZXRJbnRlcnBvbGF0aW9uKHQsIGUsIGksIG4sIHMpIHsKICAgIHJldHVybiBuYS5nZXRJbnRlcnBvbGF0aW9uKHQsIHRoaXMuYSwgdGhpcy5iLCB0aGlzLmMsIGUsIGksIG4sIHMpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gcG9pbnQsIHdoZW4gcHJvamVjdGVkIG9udG8gdGhlIHBsYW5lIG9mIHRoZQogICAqIHRyaWFuZ2xlLCBsaWVzIHdpdGhpbiB0aGUgdHJpYW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBvaW50IGluIDNEIHNwYWNlIHRvIHRlc3QuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZ2l2ZW4gcG9pbnQsIHdoZW4gcHJvamVjdGVkIG9udG8gdGhlIHBsYW5lIG9mIHRoZQogICAqIHRyaWFuZ2xlLCBsaWVzIHdpdGhpbiB0aGUgdHJpYW5nbGUgb3Igbm90LgogICAqLwogIGNvbnRhaW5zUG9pbnQodCkgewogICAgcmV0dXJuIG5hLmNvbnRhaW5zUG9pbnQodCwgdGhpcy5hLCB0aGlzLmIsIHRoaXMuYyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSB0cmlhbmdsZSBpcyBvcmllbnRlZCB0b3dhcmRzIHRoZSBnaXZlbiBkaXJlY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGRpcmVjdGlvbiAtIFRoZSAobm9ybWFsaXplZCkgZGlyZWN0aW9uIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSB0cmlhbmdsZSBpcyBvcmllbnRlZCB0b3dhcmRzIHRoZSBnaXZlbiBkaXJlY3Rpb24gb3Igbm90LgogICAqLwogIGlzRnJvbnRGYWNpbmcodCkgewogICAgcmV0dXJuIG5hLmlzRnJvbnRGYWNpbmcodGhpcy5hLCB0aGlzLmIsIHRoaXMuYywgdCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgdHJpYW5nbGUgaW50ZXJzZWN0cyB3aXRoIHRoZSBnaXZlbiBib3guCiAgICoKICAgKiBAcGFyYW0ge0JveDN9IGJveCAtIFRoZSBib3ggdG8gaW50ZXJzZWN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyB0cmlhbmdsZSBpbnRlcnNlY3RzIHdpdGggdGhlIGdpdmVuIGJveCBvciBub3QuCiAgICovCiAgaW50ZXJzZWN0c0JveCh0KSB7CiAgICByZXR1cm4gdC5pbnRlcnNlY3RzVHJpYW5nbGUodGhpcyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGNsb3Nlc3QgcG9pbnQgb24gdGhlIHRyaWFuZ2xlIHRvIHRoZSBnaXZlbiBwb2ludC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcCAtIFRoZSBwb2ludCB0byBjb21wdXRlIHRoZSBjbG9zZXN0IHBvaW50IGZvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSBjbG9zZXN0IHBvaW50IG9uIHRoZSB0cmlhbmdsZS4KICAgKi8KICBjbG9zZXN0UG9pbnRUb1BvaW50KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmEsIG4gPSB0aGlzLmIsIHMgPSB0aGlzLmM7CiAgICBsZXQgciwgbzsKICAgIFRyLnN1YlZlY3RvcnMobiwgaSksIENyLnN1YlZlY3RvcnMocywgaSksIEN1LnN1YlZlY3RvcnModCwgaSk7CiAgICBjb25zdCBsID0gVHIuZG90KEN1KSwgaCA9IENyLmRvdChDdSk7CiAgICBpZiAobCA8PSAwICYmIGggPD0gMCkKICAgICAgcmV0dXJuIGUuY29weShpKTsKICAgIFJ1LnN1YlZlY3RvcnModCwgbik7CiAgICBjb25zdCBjID0gVHIuZG90KFJ1KSwgdSA9IENyLmRvdChSdSk7CiAgICBpZiAoYyA+PSAwICYmIHUgPD0gYykKICAgICAgcmV0dXJuIGUuY29weShuKTsKICAgIGNvbnN0IGQgPSBsICogdSAtIGMgKiBoOwogICAgaWYgKGQgPD0gMCAmJiBsID49IDAgJiYgYyA8PSAwKQogICAgICByZXR1cm4gciA9IGwgLyAobCAtIGMpLCBlLmNvcHkoaSkuYWRkU2NhbGVkVmVjdG9yKFRyLCByKTsKICAgIFB1LnN1YlZlY3RvcnModCwgcyk7CiAgICBjb25zdCBwID0gVHIuZG90KFB1KSwgZiA9IENyLmRvdChQdSk7CiAgICBpZiAoZiA+PSAwICYmIHAgPD0gZikKICAgICAgcmV0dXJuIGUuY29weShzKTsKICAgIGNvbnN0IHkgPSBwICogaCAtIGwgKiBmOwogICAgaWYgKHkgPD0gMCAmJiBoID49IDAgJiYgZiA8PSAwKQogICAgICByZXR1cm4gbyA9IGggLyAoaCAtIGYpLCBlLmNvcHkoaSkuYWRkU2NhbGVkVmVjdG9yKENyLCBvKTsKICAgIGNvbnN0IGcgPSBjICogZiAtIHAgKiB1OwogICAgaWYgKGcgPD0gMCAmJiB1IC0gYyA+PSAwICYmIHAgLSBmID49IDApCiAgICAgIHJldHVybiBIZi5zdWJWZWN0b3JzKHMsIG4pLCBvID0gKHUgLSBjKSAvICh1IC0gYyArIChwIC0gZikpLCBlLmNvcHkobikuYWRkU2NhbGVkVmVjdG9yKEhmLCBvKTsKICAgIGNvbnN0IG0gPSAxIC8gKGcgKyB5ICsgZCk7CiAgICByZXR1cm4gciA9IHkgKiBtLCBvID0gZCAqIG0sIGUuY29weShpKS5hZGRTY2FsZWRWZWN0b3IoVHIsIHIpLmFkZFNjYWxlZFZlY3RvcihDciwgbyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgdHJpYW5nbGUgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtUcmlhbmdsZX0gdHJpYW5nbGUgLSBUaGUgdHJpYW5nbGUgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIHRyaWFuZ2xlIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuYS5lcXVhbHModGhpcy5hKSAmJiB0LmIuZXF1YWxzKHRoaXMuYikgJiYgdC5jLmVxdWFscyh0aGlzLmMpOwogIH0KfTsKY29uc3QgTXkgPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9LCBocyA9IHsgaDogMCwgczogMCwgbDogMCB9LCBpbCA9IHsgaDogMCwgczogMCwgbDogMCB9OwpmdW5jdGlvbiBGdShhLCB0LCBlKSB7CiAgcmV0dXJuIGUgPCAwICYmIChlICs9IDEpLCBlID4gMSAmJiAoZSAtPSAxKSwgZSA8IDEgLyA2ID8gYSArICh0IC0gYSkgKiA2ICogZSA6IGUgPCAxIC8gMiA/IHQgOiBlIDwgMiAvIDMgPyBhICsgKHQgLSBhKSAqIDYgKiAoMiAvIDMgLSBlKSA6IGE7Cn0KbGV0IGN0ID0gY2xhc3MgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY29sb3IuCiAgICoKICAgKiBOb3RlIHRoYXQgc3RhbmRhcmQgbWV0aG9kIG9mIHNwZWNpZnlpbmcgY29sb3IgaW4gdGhyZWUuanMgaXMgd2l0aCBhIGhleGFkZWNpbWFsIHRyaXBsZXQsCiAgICogYW5kIHRoYXQgbWV0aG9kIGlzIHVzZWQgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGUgZG9jdW1lbnRhdGlvbi4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmd8Q29sb3IpfSBbcl0gLSBUaGUgcmVkIGNvbXBvbmVudCBvZiB0aGUgY29sb3IuIElmIGBnYCBhbmQgYGJgIGFyZQogICAqIG5vdCBwcm92aWRlZCwgaXQgY2FuIGJlIGhleGFkZWNpbWFsIHRyaXBsZXQsIGEgQ1NTLXN0eWxlIHN0cmluZyBvciBhbm90aGVyIGBDb2xvcmAgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtnXSAtIFRoZSBncmVlbiBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtiXSAtIFRoZSBibHVlIGNvbXBvbmVudC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5pc0NvbG9yID0gITAsIHRoaXMuciA9IDEsIHRoaXMuZyA9IDEsIHRoaXMuYiA9IDEsIHRoaXMuc2V0KHQsIGUsIGkpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjb2xvcnMncyBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmd8Q29sb3IpfSBbcl0gLSBUaGUgcmVkIGNvbXBvbmVudCBvZiB0aGUgY29sb3IuIElmIGBnYCBhbmQgYGJgIGFyZQogICAqIG5vdCBwcm92aWRlZCwgaXQgY2FuIGJlIGhleGFkZWNpbWFsIHRyaXBsZXQsIGEgQ1NTLXN0eWxlIHN0cmluZyBvciBhbm90aGVyIGBDb2xvcmAgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtnXSAtIFRoZSBncmVlbiBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtiXSAtIFRoZSBibHVlIGNvbXBvbmVudC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXQodCwgZSwgaSkgewogICAgaWYgKGUgPT09IHZvaWQgMCAmJiBpID09PSB2b2lkIDApIHsKICAgICAgY29uc3QgbiA9IHQ7CiAgICAgIG4gJiYgbi5pc0NvbG9yID8gdGhpcy5jb3B5KG4pIDogdHlwZW9mIG4gPT0gIm51bWJlciIgPyB0aGlzLnNldEhleChuKSA6IHR5cGVvZiBuID09ICJzdHJpbmciICYmIHRoaXMuc2V0U3R5bGUobik7CiAgICB9IGVsc2UKICAgICAgdGhpcy5zZXRSR0IodCwgZSwgaSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29sb3JzJ3MgY29tcG9uZW50cyB0byB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxhciAtIFRoZSBzY2FsYXIgdmFsdWUuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc2V0U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0LCB0aGlzLmcgPSB0LCB0aGlzLmIgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBhIGhleGFkZWNpbWFsIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGhleCAtIFRoZSBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yU3BhY2U9U1JHQkNvbG9yU3BhY2VdIC0gVGhlIGNvbG9yIHNwYWNlLgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIHNldEhleCh0LCBlID0gcmkpIHsKICAgIHJldHVybiB0ID0gTWF0aC5mbG9vcih0KSwgdGhpcy5yID0gKHQgPj4gMTYgJiAyNTUpIC8gMjU1LCB0aGlzLmcgPSAodCA+PiA4ICYgMjU1KSAvIDI1NSwgdGhpcy5iID0gKHQgJiAyNTUpIC8gMjU1LCBlZS5jb2xvclNwYWNlVG9Xb3JraW5nKHRoaXMsIGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBSR0IgdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHIgLSBSZWQgY2hhbm5lbCB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcGFyYW0ge251bWJlcn0gZyAtIEdyZWVuIGNoYW5uZWwgdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgLSBCbHVlIGNoYW5uZWwgdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPUNvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc2V0UkdCKHQsIGUsIGksIG4gPSBlZS53b3JraW5nQ29sb3JTcGFjZSkgewogICAgcmV0dXJuIHRoaXMuciA9IHQsIHRoaXMuZyA9IGUsIHRoaXMuYiA9IGksIGVlLmNvbG9yU3BhY2VUb1dvcmtpbmcodGhpcywgbiksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBjb2xvciBmcm9tIFJHQiB2YWx1ZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaCAtIEh1ZSB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFNhdHVyYXRpb24gdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtudW1iZXJ9IGwgLSBMaWdodG5lc3MgdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPUNvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc2V0SFNMKHQsIGUsIGksIG4gPSBlZS53b3JraW5nQ29sb3JTcGFjZSkgewogICAgaWYgKHQgPSBVcCh0LCAxKSwgZSA9IGt0KGUsIDAsIDEpLCBpID0ga3QoaSwgMCwgMSksIGUgPT09IDApCiAgICAgIHRoaXMuciA9IHRoaXMuZyA9IHRoaXMuYiA9IGk7CiAgICBlbHNlIHsKICAgICAgY29uc3QgcyA9IGkgPD0gMC41ID8gaSAqICgxICsgZSkgOiBpICsgZSAtIGkgKiBlLCByID0gMiAqIGkgLSBzOwogICAgICB0aGlzLnIgPSBGdShyLCBzLCB0ICsgMSAvIDMpLCB0aGlzLmcgPSBGdShyLCBzLCB0KSwgdGhpcy5iID0gRnUociwgcywgdCAtIDEgLyAzKTsKICAgIH0KICAgIHJldHVybiBlZS5jb2xvclNwYWNlVG9Xb3JraW5nKHRoaXMsIG4pLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBhIENTUy1zdHlsZSBzdHJpbmcuIEZvciBleGFtcGxlLCBgcmdiKDI1MCwgMCwwKWAsCiAgICogYHJnYigxMDAlLCAwJSwgMCUpYCwgYGhzbCgwLCAxMDAlLCA1MCUpYCwgYCNmZjAwMDBgLCBgI2YwMGAsIG9yIGByZWRgICggb3IKICAgKiBhbnkgW1gxMSBjb2xvciBuYW1lXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9YMTFfY29sb3JfbmFtZXMjQ29sb3JfbmFtZV9jaGFydH0gLQogICAqIGFsbCAxNDAgY29sb3IgbmFtZXMgYXJlIHN1cHBvcnRlZCkuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3R5bGUgLSBDb2xvciBhcyBhIENTUy1zdHlsZSBzdHJpbmcuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPVNSR0JDb2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXRTdHlsZSh0LCBlID0gcmkpIHsKICAgIGZ1bmN0aW9uIGkocykgewogICAgICBzICE9PSB2b2lkIDAgJiYgcGFyc2VGbG9hdChzKSA8IDEgJiYgY29uc29sZS53YXJuKCJUSFJFRS5Db2xvcjogQWxwaGEgY29tcG9uZW50IG9mICIgKyB0ICsgIiB3aWxsIGJlIGlnbm9yZWQuIik7CiAgICB9CiAgICBsZXQgbjsKICAgIGlmIChuID0gL14oXHcrKVwoKFteXCldKilcKS8uZXhlYyh0KSkgewogICAgICBsZXQgczsKICAgICAgY29uc3QgciA9IG5bMV0sIG8gPSBuWzJdOwogICAgICBzd2l0Y2ggKHIpIHsKICAgICAgICBjYXNlICJyZ2IiOgogICAgICAgIGNhc2UgInJnYmEiOgogICAgICAgICAgaWYgKHMgPSAvXlxzKihcZCspXHMqLFxzKihcZCspXHMqLFxzKihcZCspXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKG8pKQogICAgICAgICAgICByZXR1cm4gaShzWzRdKSwgdGhpcy5zZXRSR0IoCiAgICAgICAgICAgICAgTWF0aC5taW4oMjU1LCBwYXJzZUludChzWzFdLCAxMCkpIC8gMjU1LAogICAgICAgICAgICAgIE1hdGgubWluKDI1NSwgcGFyc2VJbnQoc1syXSwgMTApKSAvIDI1NSwKICAgICAgICAgICAgICBNYXRoLm1pbigyNTUsIHBhcnNlSW50KHNbM10sIDEwKSkgLyAyNTUsCiAgICAgICAgICAgICAgZQogICAgICAgICAgICApOwogICAgICAgICAgaWYgKHMgPSAvXlxzKihcZCspXCVccyosXHMqKFxkKylcJVxzKixccyooXGQrKVwlXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKG8pKQogICAgICAgICAgICByZXR1cm4gaShzWzRdKSwgdGhpcy5zZXRSR0IoCiAgICAgICAgICAgICAgTWF0aC5taW4oMTAwLCBwYXJzZUludChzWzFdLCAxMCkpIC8gMTAwLAogICAgICAgICAgICAgIE1hdGgubWluKDEwMCwgcGFyc2VJbnQoc1syXSwgMTApKSAvIDEwMCwKICAgICAgICAgICAgICBNYXRoLm1pbigxMDAsIHBhcnNlSW50KHNbM10sIDEwKSkgLyAxMDAsCiAgICAgICAgICAgICAgZQogICAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiaHNsIjoKICAgICAgICBjYXNlICJoc2xhIjoKICAgICAgICAgIGlmIChzID0gL15ccyooXGQqXC4/XGQrKVxzKixccyooXGQqXC4/XGQrKVwlXHMqLFxzKihcZCpcLj9cZCspXCVccyooPzosXHMqKFxkKlwuP1xkKylccyopPyQvLmV4ZWMobykpCiAgICAgICAgICAgIHJldHVybiBpKHNbNF0pLCB0aGlzLnNldEhTTCgKICAgICAgICAgICAgICBwYXJzZUZsb2F0KHNbMV0pIC8gMzYwLAogICAgICAgICAgICAgIHBhcnNlRmxvYXQoc1syXSkgLyAxMDAsCiAgICAgICAgICAgICAgcGFyc2VGbG9hdChzWzNdKSAvIDEwMCwKICAgICAgICAgICAgICBlCiAgICAgICAgICAgICk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5Db2xvcjogVW5rbm93biBjb2xvciBtb2RlbCAiICsgdCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobiA9IC9eXCMoW0EtRmEtZlxkXSspJC8uZXhlYyh0KSkgewogICAgICBjb25zdCBzID0gblsxXSwgciA9IHMubGVuZ3RoOwogICAgICBpZiAociA9PT0gMykKICAgICAgICByZXR1cm4gdGhpcy5zZXRSR0IoCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgwKSwgMTYpIC8gMTUsCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgxKSwgMTYpIC8gMTUsCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgyKSwgMTYpIC8gMTUsCiAgICAgICAgICBlCiAgICAgICAgKTsKICAgICAgaWYgKHIgPT09IDYpCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0SGV4KHBhcnNlSW50KHMsIDE2KSwgZSk7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuQ29sb3I6IEludmFsaWQgaGV4IGNvbG9yICIgKyB0KTsKICAgIH0gZWxzZSBpZiAodCAmJiB0Lmxlbmd0aCA+IDApCiAgICAgIHJldHVybiB0aGlzLnNldENvbG9yTmFtZSh0LCBlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBhIGNvbG9yIG5hbWUuIEZhc3RlciB0aGFuIHtAbGluayBDb2xvciNzZXRTdHlsZX0gaWYKICAgKiB5b3UgZG9uJ3QgbmVlZCB0aGUgb3RoZXIgQ1NTLXN0eWxlIGZvcm1hdHMuCiAgICoKICAgKiBGb3IgY29udmVuaWVuY2UsIHRoZSBsaXN0IG9mIG5hbWVzIGlzIGV4cG9zZWQgaW4gYENvbG9yLk5BTUVTYCBhcyBhIGhhc2guCiAgICogYGBganMKICAgKiBDb2xvci5OQU1FUy5hbGljZWJsdWUgLy8gcmV0dXJucyAweEYwRjhGRgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0eWxlIC0gVGhlIGNvbG9yIG5hbWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPVNSR0JDb2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXRDb2xvck5hbWUodCwgZSA9IHJpKSB7CiAgICBjb25zdCBpID0gTXlbdC50b0xvd2VyQ2FzZSgpXTsKICAgIHJldHVybiBpICE9PSB2b2lkIDAgPyB0aGlzLnNldEhleChpLCBlKSA6IGNvbnNvbGUud2FybigiVEhSRUUuQ29sb3I6IFVua25vd24gY29sb3IgIiArIHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IGNvbG9yIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtDb2xvcn0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuciwgdGhpcy5nLCB0aGlzLmIpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gY29sb3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGNvcHkuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gdC5yLCB0aGlzLmcgPSB0LmcsIHRoaXMuYiA9IHQuYiwgdGhpczsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSBnaXZlbiBjb2xvciBpbnRvIHRoaXMgY29sb3IsIGFuZCB0aGVuIGNvbnZlcnRzIHRoaXMgY29sb3IgZnJvbQogICAqIGBTUkdCQ29sb3JTcGFjZWAgdG8gYExpbmVhclNSR0JDb2xvclNwYWNlYC4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGNvcHkvY29udmVydC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBjb3B5U1JHQlRvTGluZWFyKHQpIHsKICAgIHJldHVybiB0aGlzLnIgPSBqbih0LnIpLCB0aGlzLmcgPSBqbih0LmcpLCB0aGlzLmIgPSBqbih0LmIpLCB0aGlzOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIGdpdmVuIGNvbG9yIGludG8gdGhpcyBjb2xvciwgYW5kIHRoZW4gY29udmVydHMgdGhpcyBjb2xvciBmcm9tCiAgICogYExpbmVhclNSR0JDb2xvclNwYWNlYCB0byBgU1JHQkNvbG9yU3BhY2VgLgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gY29weS9jb252ZXJ0LgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGNvcHlMaW5lYXJUb1NSR0IodCkgewogICAgcmV0dXJuIHRoaXMuciA9IG9hKHQuciksIHRoaXMuZyA9IG9hKHQuZyksIHRoaXMuYiA9IG9hKHQuYiksIHRoaXM7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIHRoaXMgY29sb3IgZnJvbSBgU1JHQkNvbG9yU3BhY2VgIHRvIGBMaW5lYXJTUkdCQ29sb3JTcGFjZWAuCiAgICoKICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBjb252ZXJ0U1JHQlRvTGluZWFyKCkgewogICAgcmV0dXJuIHRoaXMuY29weVNSR0JUb0xpbmVhcih0aGlzKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhpcyBjb2xvciBmcm9tIGBMaW5lYXJTUkdCQ29sb3JTcGFjZWAgdG8gYFNSR0JDb2xvclNwYWNlYC4KICAgKgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGNvbnZlcnRMaW5lYXJUb1NSR0IoKSB7CiAgICByZXR1cm4gdGhpcy5jb3B5TGluZWFyVG9TUkdCKHRoaXMpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBoZXhhZGVjaW1hbCB2YWx1ZSBvZiB0aGlzIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPVNSR0JDb2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgKi8KICBnZXRIZXgodCA9IHJpKSB7CiAgICByZXR1cm4gZWUud29ya2luZ1RvQ29sb3JTcGFjZShLZS5jb3B5KHRoaXMpLCB0KSwgTWF0aC5yb3VuZChrdChLZS5yICogMjU1LCAwLCAyNTUpKSAqIDY1NTM2ICsgTWF0aC5yb3VuZChrdChLZS5nICogMjU1LCAwLCAyNTUpKSAqIDI1NiArIE1hdGgucm91bmQoa3QoS2UuYiAqIDI1NSwgMCwgMjU1KSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGhleGFkZWNpbWFsIHZhbHVlIG9mIHRoaXMgY29sb3IgYXMgYSBzdHJpbmcgKGZvciBleGFtcGxlLCAnRkZGRkZGJykuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yU3BhY2U9U1JHQkNvbG9yU3BhY2VdIC0gVGhlIGNvbG9yIHNwYWNlLgogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIGhleGFkZWNpbWFsIHZhbHVlIGFzIGEgc3RyaW5nLgogICAqLwogIGdldEhleFN0cmluZyh0ID0gcmkpIHsKICAgIHJldHVybiAoIjAwMDAwMCIgKyB0aGlzLmdldEhleCh0KS50b1N0cmluZygxNikpLnNsaWNlKC02KTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGNvbG9ycyBSR0IgdmFsdWVzIGludG8gdGhlIEhTTCBmb3JtYXQgYW5kIHN0b3JlcyB0aGVtIGludG8gdGhlCiAgICogZ2l2ZW4gdGFyZ2V0IG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7e2g6bnVtYmVyLHM6bnVtYmVyLGw6bnVtYmVyfX0gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPUNvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7e2g6bnVtYmVyLHM6bnVtYmVyLGw6bnVtYmVyfX0gVGhlIEhTTCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIGNvbG9yLgogICAqLwogIGdldEhTTCh0LCBlID0gZWUud29ya2luZ0NvbG9yU3BhY2UpIHsKICAgIGVlLndvcmtpbmdUb0NvbG9yU3BhY2UoS2UuY29weSh0aGlzKSwgZSk7CiAgICBjb25zdCBpID0gS2UuciwgbiA9IEtlLmcsIHMgPSBLZS5iLCByID0gTWF0aC5tYXgoaSwgbiwgcyksIG8gPSBNYXRoLm1pbihpLCBuLCBzKTsKICAgIGxldCBsLCBoOwogICAgY29uc3QgYyA9IChvICsgcikgLyAyOwogICAgaWYgKG8gPT09IHIpCiAgICAgIGwgPSAwLCBoID0gMDsKICAgIGVsc2UgewogICAgICBjb25zdCB1ID0gciAtIG87CiAgICAgIHN3aXRjaCAoaCA9IGMgPD0gMC41ID8gdSAvIChyICsgbykgOiB1IC8gKDIgLSByIC0gbyksIHIpIHsKICAgICAgICBjYXNlIGk6CiAgICAgICAgICBsID0gKG4gLSBzKSAvIHUgKyAobiA8IHMgPyA2IDogMCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIG46CiAgICAgICAgICBsID0gKHMgLSBpKSAvIHUgKyAyOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBzOgogICAgICAgICAgbCA9IChpIC0gbikgLyB1ICsgNDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGwgLz0gNjsKICAgIH0KICAgIHJldHVybiB0LmggPSBsLCB0LnMgPSBoLCB0LmwgPSBjLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBSR0IgdmFsdWVzIG9mIHRoaXMgY29sb3IgYW5kIHN0b3JlcyB0aGVtIGludG8gdGhlIGdpdmVuIHRhcmdldCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IGNvbG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JTcGFjZT1Db2xvck1hbmFnZW1lbnQud29ya2luZ0NvbG9yU3BhY2VdIC0gVGhlIGNvbG9yIHNwYWNlLgogICAqIEByZXR1cm4ge0NvbG9yfSBUaGUgUkdCIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgY29sb3IuCiAgICovCiAgZ2V0UkdCKHQsIGUgPSBlZS53b3JraW5nQ29sb3JTcGFjZSkgewogICAgcmV0dXJuIGVlLndvcmtpbmdUb0NvbG9yU3BhY2UoS2UuY29weSh0aGlzKSwgZSksIHQuciA9IEtlLnIsIHQuZyA9IEtlLmcsIHQuYiA9IEtlLmIsIHQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoaXMgY29sb3IgYXMgYSBDU1Mgc3R5bGUgc3RyaW5nLiBFeGFtcGxlOiBgcmdiKDI1NSwwLDApYC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JTcGFjZT1TUkdCQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgQ1NTIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgY29sb3IuCiAgICovCiAgZ2V0U3R5bGUodCA9IHJpKSB7CiAgICBlZS53b3JraW5nVG9Db2xvclNwYWNlKEtlLmNvcHkodGhpcyksIHQpOwogICAgY29uc3QgZSA9IEtlLnIsIGkgPSBLZS5nLCBuID0gS2UuYjsKICAgIHJldHVybiB0ICE9PSByaSA/IGBjb2xvcigke3R9ICR7ZS50b0ZpeGVkKDMpfSAke2kudG9GaXhlZCgzKX0gJHtuLnRvRml4ZWQoMyl9KWAgOiBgcmdiKCR7TWF0aC5yb3VuZChlICogMjU1KX0sJHtNYXRoLnJvdW5kKGkgKiAyNTUpfSwke01hdGgucm91bmQobiAqIDI1NSl9KWA7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIEhTTCB2YWx1ZXMgdG8gdGhpcyBjb2xvcidzIHZhbHVlcy4KICAgKiBJbnRlcm5hbGx5LCB0aGlzIGNvbnZlcnRzIHRoZSBjb2xvcidzIFJHQiB2YWx1ZXMgdG8gSFNMLCBhZGRzIEhTTAogICAqIGFuZCB0aGVuIGNvbnZlcnRzIHRoZSBjb2xvciBiYWNrIHRvIFJHQi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBoIC0gSHVlIHZhbHVlIGJldHdlZW4gYDAuMGAgYW5kIGAxLjBgLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gU2F0dXJhdGlvbiB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcGFyYW0ge251bWJlcn0gbCAtIExpZ2h0bmVzcyB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBvZmZzZXRIU0wodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMuZ2V0SFNMKGhzKSwgdGhpcy5zZXRIU0woaHMuaCArIHQsIGhzLnMgKyBlLCBocy5sICsgaSk7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIFJHQiB2YWx1ZXMgb2YgdGhlIGdpdmVuIGNvbG9yIHRvIHRoZSBSR0IgdmFsdWVzIG9mIHRoaXMgY29sb3IuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvciAtIFRoZSBjb2xvciB0byBhZGQuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnIgKz0gdC5yLCB0aGlzLmcgKz0gdC5nLCB0aGlzLmIgKz0gdC5iLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBSR0IgdmFsdWVzIG9mIHRoZSBnaXZlbiBjb2xvcnMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0IGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvcjEgLSBUaGUgZmlyc3QgY29sb3IuCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IyIC0gVGhlIHNlY29uZCBjb2xvci4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBhZGRDb2xvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMuciA9IHQuciArIGUuciwgdGhpcy5nID0gdC5nICsgZS5nLCB0aGlzLmIgPSB0LmIgKyBlLmIsIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSB0byB0aGUgUkdCIHZhbHVlcyBvZiB0aGlzIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHMgLSBUaGUgc2NhbGFyIHRvIGFkZC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBhZGRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMuciArPSB0LCB0aGlzLmcgKz0gdCwgdGhpcy5iICs9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgUkdCIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gY29sb3IgZnJvbSB0aGUgUkdCIHZhbHVlcyBvZiB0aGlzIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gc3VidHJhY3QuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc3ViKHQpIHsKICAgIHJldHVybiB0aGlzLnIgPSBNYXRoLm1heCgwLCB0aGlzLnIgLSB0LnIpLCB0aGlzLmcgPSBNYXRoLm1heCgwLCB0aGlzLmcgLSB0LmcpLCB0aGlzLmIgPSBNYXRoLm1heCgwLCB0aGlzLmIgLSB0LmIpLCB0aGlzOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoZSBSR0IgdmFsdWVzIG9mIHRoZSBnaXZlbiBjb2xvciB3aXRoIHRoZSBSR0IgdmFsdWVzIG9mIHRoaXMgY29sb3IuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvciAtIFRoZSBjb2xvciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5yICo9IHQuciwgdGhpcy5nICo9IHQuZywgdGhpcy5iICo9IHQuYiwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIHdpdGggdGhlIFJHQiB2YWx1ZXMgb2YgdGhpcyBjb2xvci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy5yICo9IHQsIHRoaXMuZyAqPSB0LCB0aGlzLmIgKj0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIHRoaXMgY29sb3IncyBSR0IgdmFsdWVzIHRvd2FyZCB0aGUgUkdCIHZhbHVlcyBvZiB0aGUKICAgKiBnaXZlbiBjb2xvci4gVGhlIGFscGhhIGFyZ3VtZW50IGNhbiBiZSB0aG91Z2h0IG9mIGFzIHRoZSByYXRpbyBiZXR3ZWVuCiAgICogdGhlIHR3byBjb2xvcnMsIHdoZXJlIGAwLjBgIGlzIHRoaXMgY29sb3IgYW5kIGAxLjBgIGlzIHRoZSBmaXJzdCBhcmd1bWVudC4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGNvbnZlcmdlIG9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciBpbiB0aGUgY2xvc2VkIGludGVydmFsIGBbMCwxXWAuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgbGVycCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5yICs9ICh0LnIgLSB0aGlzLnIpICogZSwgdGhpcy5nICs9ICh0LmcgLSB0aGlzLmcpICogZSwgdGhpcy5iICs9ICh0LmIgLSB0aGlzLmIpICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIGNvbG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKiBUaGUgYWxwaGEgYXJndW1lbnQgY2FuIGJlIHRob3VnaHQgb2YgYXMgdGhlIHJhdGlvIGJldHdlZW4gdGhlIHR3byBjb2xvcnMsIHdoZXJlIGAwLjBgCiAgICogaXMgdGhlIGZpcnN0IGFuZCBgMS4wYCBpcyB0aGUgc2Vjb25kIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IxIC0gVGhlIGZpcnN0IGNvbG9yLgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yMiAtIFRoZSBzZWNvbmQgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yIGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLDFdYC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBsZXJwQ29sb3JzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0LnIgKyAoZS5yIC0gdC5yKSAqIGksIHRoaXMuZyA9IHQuZyArIChlLmcgLSB0LmcpICogaSwgdGhpcy5iID0gdC5iICsgKGUuYiAtIHQuYikgKiBpLCB0aGlzOwogIH0KICAvKioKICAgKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgdGhpcyBjb2xvcidzIEhTTCB2YWx1ZXMgdG93YXJkIHRoZSBIU0wgdmFsdWVzIG9mIHRoZQogICAqIGdpdmVuIGNvbG9yLiBJdCBkaWZmZXJzIGZyb20ge0BsaW5rIENvbG9yI2xlcnB9IGJ5IG5vdCBpbnRlcnBvbGF0aW5nIHN0cmFpZ2h0CiAgICogZnJvbSBvbmUgY29sb3IgdG8gdGhlIG90aGVyLCBidXQgaW5zdGVhZCBnb2luZyB0aHJvdWdoIGFsbCB0aGUgaHVlcyBpbiBiZXR3ZWVuCiAgICogdGhvc2UgdHdvIGNvbG9ycy4gVGhlIGFscGhhIGFyZ3VtZW50IGNhbiBiZSB0aG91Z2h0IG9mIGFzIHRoZSByYXRpbyBiZXR3ZWVuCiAgICogdGhlIHR3byBjb2xvcnMsIHdoZXJlIDAuMCBpcyB0aGlzIGNvbG9yIGFuZCAxLjAgaXMgdGhlIGZpcnN0IGFyZ3VtZW50LgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gY29udmVyZ2Ugb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yIGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLDFdYC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBsZXJwSFNMKHQsIGUpIHsKICAgIHRoaXMuZ2V0SFNMKGhzKSwgdC5nZXRIU0woaWwpOwogICAgY29uc3QgaSA9IGZvKGhzLmgsIGlsLmgsIGUpLCBuID0gZm8oaHMucywgaWwucywgZSksIHMgPSBmbyhocy5sLCBpbC5sLCBlKTsKICAgIHJldHVybiB0aGlzLnNldEhTTChpLCBuLCBzKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29sb3IncyBSR0IgY29tcG9uZW50cyBmcm9tIHRoZSBnaXZlbiAzRCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIHNldC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXRGcm9tVmVjdG9yMyh0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gdC54LCB0aGlzLmcgPSB0LnksIHRoaXMuYiA9IHQueiwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNmb3JtcyB0aGlzIGNvbG9yIHdpdGggdGhlIGdpdmVuIDN4MyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbWF0cml4LgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGFwcGx5TWF0cml4Myh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5yLCBpID0gdGhpcy5nLCBuID0gdGhpcy5iLCBzID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnIgPSBzWzBdICogZSArIHNbM10gKiBpICsgc1s2XSAqIG4sIHRoaXMuZyA9IHNbMV0gKiBlICsgc1s0XSAqIGkgKyBzWzddICogbiwgdGhpcy5iID0gc1syXSAqIGUgKyBzWzVdICogaSArIHNbOF0gKiBuLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGNvbG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGMgLSBUaGUgY29sb3IgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIGJvdW5kaW5nIGNvbG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuciA9PT0gdGhpcy5yICYmIHQuZyA9PT0gdGhpcy5nICYmIHQuYiA9PT0gdGhpcy5iOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IncyBSR0IgY29tcG9uZW50cyBmcm9tIHRoZSBnaXZlbiBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYXJyYXkgLSBBbiBhcnJheSBob2xkaW5nIHRoZSBSR0IgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnIgPSB0W2VdLCB0aGlzLmcgPSB0W2UgKyAxXSwgdGhpcy5iID0gdFtlICsgMl0sIHRoaXM7CiAgfQogIC8qKgogICAqIFdyaXRlcyB0aGUgUkdCIGNvbXBvbmVudHMgb2YgdGhpcyBjb2xvciB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgY29sb3IgY29tcG9uZW50cy4KICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldD0wXSAtIEluZGV4IG9mIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgY29sb3IgY29tcG9uZW50cy4KICAgKi8KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIHJldHVybiB0W2VdID0gdGhpcy5yLCB0W2UgKyAxXSA9IHRoaXMuZywgdFtlICsgMl0gPSB0aGlzLmIsIHQ7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGNvbXBvbmVudHMgb2YgdGhpcyBjb2xvciBmcm9tIHRoZSBnaXZlbiBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJBdHRyaWJ1dGV9IGF0dHJpYnV0ZSAtIFRoZSBidWZmZXIgYXR0cmlidXRlIGhvbGRpbmcgY29sb3IgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYXR0cmlidXRlLgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuciA9IHQuZ2V0WChlKSwgdGhpcy5nID0gdC5nZXRZKGUpLCB0aGlzLmIgPSB0LmdldFooZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFRoaXMgbWV0aG9kcyBkZWZpbmVzIHRoZSBzZXJpYWxpemF0aW9uIHJlc3VsdCBvZiB0aGlzIGNsYXNzLiBSZXR1cm5zIHRoZSBjb2xvcgogICAqIGFzIGEgaGV4YWRlY2ltYWwgdmFsdWUuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy5nZXRIZXgoKTsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy5yLCB5aWVsZCB0aGlzLmcsIHlpZWxkIHRoaXMuYjsKICB9Cn07CmNvbnN0IEtlID0gLyogQF9fUFVSRV9fICovIG5ldyBjdCgpOwpjdC5OQU1FUyA9IE15OwpsZXQgRXYgPSAwLCBoaSA9IGNsYXNzIGV4dGVuZHMgRWkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbWF0ZXJpYWwuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWF0ZXJpYWwgPSAhMCwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJpZCIsIHsgdmFsdWU6IEV2KysgfSksIHRoaXMudXVpZCA9IE9pKCksIHRoaXMubmFtZSA9ICIiLCB0aGlzLnR5cGUgPSAiTWF0ZXJpYWwiLCB0aGlzLmJsZW5kaW5nID0gd3MsIHRoaXMuc2lkZSA9ICRpLCB0aGlzLnZlcnRleENvbG9ycyA9ICExLCB0aGlzLm9wYWNpdHkgPSAxLCB0aGlzLnRyYW5zcGFyZW50ID0gITEsIHRoaXMuYWxwaGFIYXNoID0gITEsIHRoaXMuYmxlbmRTcmMgPSBJaCwgdGhpcy5ibGVuZERzdCA9IExoLCB0aGlzLmJsZW5kRXF1YXRpb24gPSB2cywgdGhpcy5ibGVuZFNyY0FscGhhID0gbnVsbCwgdGhpcy5ibGVuZERzdEFscGhhID0gbnVsbCwgdGhpcy5ibGVuZEVxdWF0aW9uQWxwaGEgPSBudWxsLCB0aGlzLmJsZW5kQ29sb3IgPSBuZXcgY3QoMCwgMCwgMCksIHRoaXMuYmxlbmRBbHBoYSA9IDAsIHRoaXMuZGVwdGhGdW5jID0gcHIsIHRoaXMuZGVwdGhUZXN0ID0gITAsIHRoaXMuZGVwdGhXcml0ZSA9ICEwLCB0aGlzLnN0ZW5jaWxXcml0ZU1hc2sgPSAyNTUsIHRoaXMuc3RlbmNpbEZ1bmMgPSBUbywgdGhpcy5zdGVuY2lsUmVmID0gMCwgdGhpcy5zdGVuY2lsRnVuY01hc2sgPSAyNTUsIHRoaXMuc3RlbmNpbEZhaWwgPSBlciwgdGhpcy5zdGVuY2lsWkZhaWwgPSBlciwgdGhpcy5zdGVuY2lsWlBhc3MgPSBlciwgdGhpcy5zdGVuY2lsV3JpdGUgPSAhMSwgdGhpcy5jbGlwcGluZ1BsYW5lcyA9IG51bGwsIHRoaXMuY2xpcEludGVyc2VjdGlvbiA9ICExLCB0aGlzLmNsaXBTaGFkb3dzID0gITEsIHRoaXMuc2hhZG93U2lkZSA9IG51bGwsIHRoaXMuY29sb3JXcml0ZSA9ICEwLCB0aGlzLnByZWNpc2lvbiA9IG51bGwsIHRoaXMucG9seWdvbk9mZnNldCA9ICExLCB0aGlzLnBvbHlnb25PZmZzZXRGYWN0b3IgPSAwLCB0aGlzLnBvbHlnb25PZmZzZXRVbml0cyA9IDAsIHRoaXMuZGl0aGVyaW5nID0gITEsIHRoaXMuYWxwaGFUb0NvdmVyYWdlID0gITEsIHRoaXMucHJlbXVsdGlwbGllZEFscGhhID0gITEsIHRoaXMuZm9yY2VTaW5nbGVQYXNzID0gITEsIHRoaXMuYWxsb3dPdmVycmlkZSA9ICEwLCB0aGlzLnZpc2libGUgPSAhMCwgdGhpcy50b25lTWFwcGVkID0gITAsIHRoaXMudXNlckRhdGEgPSB7fSwgdGhpcy52ZXJzaW9uID0gMCwgdGhpcy5fYWxwaGFUZXN0ID0gMDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgYWxwaGEgdmFsdWUgdG8gYmUgdXNlZCB3aGVuIHJ1bm5pbmcgYW4gYWxwaGEgdGVzdC4gVGhlIG1hdGVyaWFsCiAgICogd2lsbCBub3QgYmUgcmVuZGVyZWQgaWYgdGhlIG9wYWNpdHkgaXMgbG93ZXIgdGhhbiB0aGlzIHZhbHVlLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAcmVhZG9ubHkKICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IGFscGhhVGVzdCgpIHsKICAgIHJldHVybiB0aGlzLl9hbHBoYVRlc3Q7CiAgfQogIHNldCBhbHBoYVRlc3QodCkgewogICAgdGhpcy5fYWxwaGFUZXN0ID4gMCAhPSB0ID4gMCAmJiB0aGlzLnZlcnNpb24rKywgdGhpcy5fYWxwaGFUZXN0ID0gdDsKICB9CiAgLyoqCiAgICogQW4gb3B0aW9uYWwgY2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpbW1lZGlhdGVseSBiZWZvcmUgdGhlIG1hdGVyaWFsIGlzIHVzZWQgdG8gcmVuZGVyIGEgM0Qgb2JqZWN0LgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIG9ubHkgYmUgdXNlZCB3aGVuIHJlbmRlcmluZyB3aXRoIHtAbGluayBXZWJHTFJlbmRlcmVyfS4KICAgKgogICAqIEBwYXJhbSB7V2ViR0xSZW5kZXJlcn0gcmVuZGVyZXIgLSBUaGUgcmVuZGVyZXIuCiAgICogQHBhcmFtIHtTY2VuZX0gc2NlbmUgLSBUaGUgc2NlbmUuCiAgICogQHBhcmFtIHtDYW1lcmF9IGNhbWVyYSAtIFRoZSBjYW1lcmEgdGhhdCBpcyB1c2VkIHRvIHJlbmRlciB0aGUgc2NlbmUuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdC4KICAgKiBAcGFyYW0ge09iamVjdH0gZ3JvdXAgLSBUaGUgZ2VvbWV0cnkgZ3JvdXAgZGF0YS4KICAgKi8KICBvbkJlZm9yZVJlbmRlcigpIHsKICB9CiAgLyoqCiAgICogQW4gb3B0aW9uYWwgY2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpbW1lZGlhdGVseSBiZWZvcmUgdGhlIHNoYWRlcgogICAqIHByb2dyYW0gaXMgY29tcGlsZWQuIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggdGhlIHNoYWRlciBzb3VyY2UgY29kZQogICAqIGFzIGEgcGFyYW1ldGVyLiBVc2VmdWwgZm9yIHRoZSBtb2RpZmljYXRpb24gb2YgYnVpbHQtaW4gbWF0ZXJpYWxzLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIG9ubHkgYmUgdXNlZCB3aGVuIHJlbmRlcmluZyB3aXRoIHtAbGluayBXZWJHTFJlbmRlcmVyfS4gVGhlCiAgICogcmVjb21tZW5kZWQgYXBwcm9hY2ggd2hlbiBjdXN0b21pemluZyBtYXRlcmlhbHMgaXMgdG8gdXNlIGBXZWJHUFVSZW5kZXJlcmAgd2l0aCB0aGUgbmV3CiAgICogTm9kZSBNYXRlcmlhbCBzeXN0ZW0gYW5kIFtUU0xde0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9tcmRvb2IvdGhyZWUuanMvd2lraS9UaHJlZS5qcy1TaGFkaW5nLUxhbmd1YWdlfS4KICAgKgogICAqIEBwYXJhbSB7e3ZlcnRleFNoYWRlcjpzdHJpbmcsZnJhZ21lbnRTaGFkZXI6c3RyaW5nLHVuaWZvcm1zOk9iamVjdH19IHNoYWRlcm9iamVjdCAtIFRoZSBvYmplY3QgaG9sZHMgdGhlIHVuaWZvcm1zIGFuZCB0aGUgdmVydGV4IGFuZCBmcmFnbWVudCBzaGFkZXIgc291cmNlLgogICAqIEBwYXJhbSB7V2ViR0xSZW5kZXJlcn0gcmVuZGVyZXIgLSBBIHJlZmVyZW5jZSB0byB0aGUgcmVuZGVyZXIuCiAgICovCiAgb25CZWZvcmVDb21waWxlKCkgewogIH0KICAvKioKICAgKiBJbiBjYXNlIHtAbGluayBNYXRlcmlhbCNvbkJlZm9yZUNvbXBpbGV9IGlzIHVzZWQsIHRoaXMgY2FsbGJhY2sgY2FuIGJlIHVzZWQgdG8gaWRlbnRpZnkKICAgKiB2YWx1ZXMgb2Ygc2V0dGluZ3MgdXNlZCBpbiBgb25CZWZvcmVDb21waWxlKClgLCBzbyB0aHJlZS5qcyBjYW4gcmV1c2UgYSBjYWNoZWQKICAgKiBzaGFkZXIgb3IgcmVjb21waWxlIHRoZSBzaGFkZXIgZm9yIHRoaXMgbWF0ZXJpYWwgYXMgbmVlZGVkLgogICAqCiAgICogVGhpcyBtZXRob2QgY2FuIG9ubHkgYmUgdXNlZCB3aGVuIHJlbmRlcmluZyB3aXRoIHtAbGluayBXZWJHTFJlbmRlcmVyfS4KICAgKgogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIGN1c3RvbSBwcm9ncmFtIGNhY2hlIGtleS4KICAgKi8KICBjdXN0b21Qcm9ncmFtQ2FjaGVLZXkoKSB7CiAgICByZXR1cm4gdGhpcy5vbkJlZm9yZUNvbXBpbGUudG9TdHJpbmcoKTsKICB9CiAgLyoqCiAgICogVGhpcyBtZXRob2QgY2FuIGJlIHVzZWQgdG8gc2V0IGRlZmF1bHQgdmFsdWVzIGZyb20gcGFyYW1ldGVyIG9iamVjdHMuCiAgICogSXQgaXMgYSBnZW5lcmljIGltcGxlbWVudGF0aW9uIHNvIGl0IGNhbiBiZSB1c2VkIHdpdGggZGlmZmVyZW50IHR5cGVzCiAgICogb2YgbWF0ZXJpYWxzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFt2YWx1ZXNdIC0gVGhlIG1hdGVyaWFsIHZhbHVlcyB0byBzZXQuCiAgICovCiAgc2V0VmFsdWVzKHQpIHsKICAgIGlmICh0ICE9PSB2b2lkIDApCiAgICAgIGZvciAoY29uc3QgZSBpbiB0KSB7CiAgICAgICAgY29uc3QgaSA9IHRbZV07CiAgICAgICAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgICAgICAgY29uc29sZS53YXJuKGBUSFJFRS5NYXRlcmlhbDogcGFyYW1ldGVyICcke2V9JyBoYXMgdmFsdWUgb2YgdW5kZWZpbmVkLmApOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG4gPSB0aGlzW2VdOwogICAgICAgIGlmIChuID09PSB2b2lkIDApIHsKICAgICAgICAgIGNvbnNvbGUud2FybihgVEhSRUUuTWF0ZXJpYWw6ICcke2V9JyBpcyBub3QgYSBwcm9wZXJ0eSBvZiBUSFJFRS4ke3RoaXMudHlwZX0uYCk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbiAmJiBuLmlzQ29sb3IgPyBuLnNldChpKSA6IG4gJiYgbi5pc1ZlY3RvcjMgJiYgaSAmJiBpLmlzVmVjdG9yMyA/IG4uY29weShpKSA6IHRoaXNbZV0gPSBpOwogICAgICB9CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIG1hdGVyaWFsIGludG8gSlNPTi4KICAgKgogICAqIEBwYXJhbSB7PyhPYmplY3R8c3RyaW5nKX0gbWV0YSAtIEFuIG9wdGlvbmFsIHZhbHVlIGhvbGRpbmcgbWV0YSBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VyaWFsaXphdGlvbi4KICAgKiBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIG1hdGVyaWFsLgogICAqIEBzZWUge0BsaW5rIE9iamVjdExvYWRlciNwYXJzZX0KICAgKi8KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHQgPT09IHZvaWQgMCB8fCB0eXBlb2YgdCA9PSAic3RyaW5nIjsKICAgIGUgJiYgKHQgPSB7CiAgICAgIHRleHR1cmVzOiB7fSwKICAgICAgaW1hZ2VzOiB7fQogICAgfSk7CiAgICBjb25zdCBpID0gewogICAgICBtZXRhZGF0YTogewogICAgICAgIHZlcnNpb246IDQuNywKICAgICAgICB0eXBlOiAiTWF0ZXJpYWwiLAogICAgICAgIGdlbmVyYXRvcjogIk1hdGVyaWFsLnRvSlNPTiIKICAgICAgfQogICAgfTsKICAgIGkudXVpZCA9IHRoaXMudXVpZCwgaS50eXBlID0gdGhpcy50eXBlLCB0aGlzLm5hbWUgIT09ICIiICYmIChpLm5hbWUgPSB0aGlzLm5hbWUpLCB0aGlzLmNvbG9yICYmIHRoaXMuY29sb3IuaXNDb2xvciAmJiAoaS5jb2xvciA9IHRoaXMuY29sb3IuZ2V0SGV4KCkpLCB0aGlzLnJvdWdobmVzcyAhPT0gdm9pZCAwICYmIChpLnJvdWdobmVzcyA9IHRoaXMucm91Z2huZXNzKSwgdGhpcy5tZXRhbG5lc3MgIT09IHZvaWQgMCAmJiAoaS5tZXRhbG5lc3MgPSB0aGlzLm1ldGFsbmVzcyksIHRoaXMuc2hlZW4gIT09IHZvaWQgMCAmJiAoaS5zaGVlbiA9IHRoaXMuc2hlZW4pLCB0aGlzLnNoZWVuQ29sb3IgJiYgdGhpcy5zaGVlbkNvbG9yLmlzQ29sb3IgJiYgKGkuc2hlZW5Db2xvciA9IHRoaXMuc2hlZW5Db2xvci5nZXRIZXgoKSksIHRoaXMuc2hlZW5Sb3VnaG5lc3MgIT09IHZvaWQgMCAmJiAoaS5zaGVlblJvdWdobmVzcyA9IHRoaXMuc2hlZW5Sb3VnaG5lc3MpLCB0aGlzLmVtaXNzaXZlICYmIHRoaXMuZW1pc3NpdmUuaXNDb2xvciAmJiAoaS5lbWlzc2l2ZSA9IHRoaXMuZW1pc3NpdmUuZ2V0SGV4KCkpLCB0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ICE9PSB2b2lkIDAgJiYgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSAhPT0gMSAmJiAoaS5lbWlzc2l2ZUludGVuc2l0eSA9IHRoaXMuZW1pc3NpdmVJbnRlbnNpdHkpLCB0aGlzLnNwZWN1bGFyICYmIHRoaXMuc3BlY3VsYXIuaXNDb2xvciAmJiAoaS5zcGVjdWxhciA9IHRoaXMuc3BlY3VsYXIuZ2V0SGV4KCkpLCB0aGlzLnNwZWN1bGFySW50ZW5zaXR5ICE9PSB2b2lkIDAgJiYgKGkuc3BlY3VsYXJJbnRlbnNpdHkgPSB0aGlzLnNwZWN1bGFySW50ZW5zaXR5KSwgdGhpcy5zcGVjdWxhckNvbG9yICYmIHRoaXMuc3BlY3VsYXJDb2xvci5pc0NvbG9yICYmIChpLnNwZWN1bGFyQ29sb3IgPSB0aGlzLnNwZWN1bGFyQ29sb3IuZ2V0SGV4KCkpLCB0aGlzLnNoaW5pbmVzcyAhPT0gdm9pZCAwICYmIChpLnNoaW5pbmVzcyA9IHRoaXMuc2hpbmluZXNzKSwgdGhpcy5jbGVhcmNvYXQgIT09IHZvaWQgMCAmJiAoaS5jbGVhcmNvYXQgPSB0aGlzLmNsZWFyY29hdCksIHRoaXMuY2xlYXJjb2F0Um91Z2huZXNzICE9PSB2b2lkIDAgJiYgKGkuY2xlYXJjb2F0Um91Z2huZXNzID0gdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3MpLCB0aGlzLmNsZWFyY29hdE1hcCAmJiB0aGlzLmNsZWFyY29hdE1hcC5pc1RleHR1cmUgJiYgKGkuY2xlYXJjb2F0TWFwID0gdGhpcy5jbGVhcmNvYXRNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLmNsZWFyY29hdFJvdWdobmVzc01hcCAmJiB0aGlzLmNsZWFyY29hdFJvdWdobmVzc01hcC5pc1RleHR1cmUgJiYgKGkuY2xlYXJjb2F0Um91Z2huZXNzTWFwID0gdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLmNsZWFyY29hdE5vcm1hbE1hcCAmJiB0aGlzLmNsZWFyY29hdE5vcm1hbE1hcC5pc1RleHR1cmUgJiYgKGkuY2xlYXJjb2F0Tm9ybWFsTWFwID0gdGhpcy5jbGVhcmNvYXROb3JtYWxNYXAudG9KU09OKHQpLnV1aWQsIGkuY2xlYXJjb2F0Tm9ybWFsU2NhbGUgPSB0aGlzLmNsZWFyY29hdE5vcm1hbFNjYWxlLnRvQXJyYXkoKSksIHRoaXMuc2hlZW5Db2xvck1hcCAmJiB0aGlzLnNoZWVuQ29sb3JNYXAuaXNUZXh0dXJlICYmIChpLnNoZWVuQ29sb3JNYXAgPSB0aGlzLnNoZWVuQ29sb3JNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLnNoZWVuUm91Z2huZXNzTWFwICYmIHRoaXMuc2hlZW5Sb3VnaG5lc3NNYXAuaXNUZXh0dXJlICYmIChpLnNoZWVuUm91Z2huZXNzTWFwID0gdGhpcy5zaGVlblJvdWdobmVzc01hcC50b0pTT04odCkudXVpZCksIHRoaXMuZGlzcGVyc2lvbiAhPT0gdm9pZCAwICYmIChpLmRpc3BlcnNpb24gPSB0aGlzLmRpc3BlcnNpb24pLCB0aGlzLmlyaWRlc2NlbmNlICE9PSB2b2lkIDAgJiYgKGkuaXJpZGVzY2VuY2UgPSB0aGlzLmlyaWRlc2NlbmNlKSwgdGhpcy5pcmlkZXNjZW5jZUlPUiAhPT0gdm9pZCAwICYmIChpLmlyaWRlc2NlbmNlSU9SID0gdGhpcy5pcmlkZXNjZW5jZUlPUiksIHRoaXMuaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZSAhPT0gdm9pZCAwICYmIChpLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UgPSB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UpLCB0aGlzLmlyaWRlc2NlbmNlTWFwICYmIHRoaXMuaXJpZGVzY2VuY2VNYXAuaXNUZXh0dXJlICYmIChpLmlyaWRlc2NlbmNlTWFwID0gdGhpcy5pcmlkZXNjZW5jZU1hcC50b0pTT04odCkudXVpZCksIHRoaXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgJiYgdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcC5pc1RleHR1cmUgJiYgKGkuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgPSB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5hbmlzb3Ryb3B5ICE9PSB2b2lkIDAgJiYgKGkuYW5pc290cm9weSA9IHRoaXMuYW5pc290cm9weSksIHRoaXMuYW5pc290cm9weVJvdGF0aW9uICE9PSB2b2lkIDAgJiYgKGkuYW5pc290cm9weVJvdGF0aW9uID0gdGhpcy5hbmlzb3Ryb3B5Um90YXRpb24pLCB0aGlzLmFuaXNvdHJvcHlNYXAgJiYgdGhpcy5hbmlzb3Ryb3B5TWFwLmlzVGV4dHVyZSAmJiAoaS5hbmlzb3Ryb3B5TWFwID0gdGhpcy5hbmlzb3Ryb3B5TWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5tYXAgJiYgdGhpcy5tYXAuaXNUZXh0dXJlICYmIChpLm1hcCA9IHRoaXMubWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5tYXRjYXAgJiYgdGhpcy5tYXRjYXAuaXNUZXh0dXJlICYmIChpLm1hdGNhcCA9IHRoaXMubWF0Y2FwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5hbHBoYU1hcCAmJiB0aGlzLmFscGhhTWFwLmlzVGV4dHVyZSAmJiAoaS5hbHBoYU1hcCA9IHRoaXMuYWxwaGFNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLmxpZ2h0TWFwICYmIHRoaXMubGlnaHRNYXAuaXNUZXh0dXJlICYmIChpLmxpZ2h0TWFwID0gdGhpcy5saWdodE1hcC50b0pTT04odCkudXVpZCwgaS5saWdodE1hcEludGVuc2l0eSA9IHRoaXMubGlnaHRNYXBJbnRlbnNpdHkpLCB0aGlzLmFvTWFwICYmIHRoaXMuYW9NYXAuaXNUZXh0dXJlICYmIChpLmFvTWFwID0gdGhpcy5hb01hcC50b0pTT04odCkudXVpZCwgaS5hb01hcEludGVuc2l0eSA9IHRoaXMuYW9NYXBJbnRlbnNpdHkpLCB0aGlzLmJ1bXBNYXAgJiYgdGhpcy5idW1wTWFwLmlzVGV4dHVyZSAmJiAoaS5idW1wTWFwID0gdGhpcy5idW1wTWFwLnRvSlNPTih0KS51dWlkLCBpLmJ1bXBTY2FsZSA9IHRoaXMuYnVtcFNjYWxlKSwgdGhpcy5ub3JtYWxNYXAgJiYgdGhpcy5ub3JtYWxNYXAuaXNUZXh0dXJlICYmIChpLm5vcm1hbE1hcCA9IHRoaXMubm9ybWFsTWFwLnRvSlNPTih0KS51dWlkLCBpLm5vcm1hbE1hcFR5cGUgPSB0aGlzLm5vcm1hbE1hcFR5cGUsIGkubm9ybWFsU2NhbGUgPSB0aGlzLm5vcm1hbFNjYWxlLnRvQXJyYXkoKSksIHRoaXMuZGlzcGxhY2VtZW50TWFwICYmIHRoaXMuZGlzcGxhY2VtZW50TWFwLmlzVGV4dHVyZSAmJiAoaS5kaXNwbGFjZW1lbnRNYXAgPSB0aGlzLmRpc3BsYWNlbWVudE1hcC50b0pTT04odCkudXVpZCwgaS5kaXNwbGFjZW1lbnRTY2FsZSA9IHRoaXMuZGlzcGxhY2VtZW50U2NhbGUsIGkuZGlzcGxhY2VtZW50QmlhcyA9IHRoaXMuZGlzcGxhY2VtZW50QmlhcyksIHRoaXMucm91Z2huZXNzTWFwICYmIHRoaXMucm91Z2huZXNzTWFwLmlzVGV4dHVyZSAmJiAoaS5yb3VnaG5lc3NNYXAgPSB0aGlzLnJvdWdobmVzc01hcC50b0pTT04odCkudXVpZCksIHRoaXMubWV0YWxuZXNzTWFwICYmIHRoaXMubWV0YWxuZXNzTWFwLmlzVGV4dHVyZSAmJiAoaS5tZXRhbG5lc3NNYXAgPSB0aGlzLm1ldGFsbmVzc01hcC50b0pTT04odCkudXVpZCksIHRoaXMuZW1pc3NpdmVNYXAgJiYgdGhpcy5lbWlzc2l2ZU1hcC5pc1RleHR1cmUgJiYgKGkuZW1pc3NpdmVNYXAgPSB0aGlzLmVtaXNzaXZlTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5zcGVjdWxhck1hcCAmJiB0aGlzLnNwZWN1bGFyTWFwLmlzVGV4dHVyZSAmJiAoaS5zcGVjdWxhck1hcCA9IHRoaXMuc3BlY3VsYXJNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLnNwZWN1bGFySW50ZW5zaXR5TWFwICYmIHRoaXMuc3BlY3VsYXJJbnRlbnNpdHlNYXAuaXNUZXh0dXJlICYmIChpLnNwZWN1bGFySW50ZW5zaXR5TWFwID0gdGhpcy5zcGVjdWxhckludGVuc2l0eU1hcC50b0pTT04odCkudXVpZCksIHRoaXMuc3BlY3VsYXJDb2xvck1hcCAmJiB0aGlzLnNwZWN1bGFyQ29sb3JNYXAuaXNUZXh0dXJlICYmIChpLnNwZWN1bGFyQ29sb3JNYXAgPSB0aGlzLnNwZWN1bGFyQ29sb3JNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLmVudk1hcCAmJiB0aGlzLmVudk1hcC5pc1RleHR1cmUgJiYgKGkuZW52TWFwID0gdGhpcy5lbnZNYXAudG9KU09OKHQpLnV1aWQsIHRoaXMuY29tYmluZSAhPT0gdm9pZCAwICYmIChpLmNvbWJpbmUgPSB0aGlzLmNvbWJpbmUpKSwgdGhpcy5lbnZNYXBSb3RhdGlvbiAhPT0gdm9pZCAwICYmIChpLmVudk1hcFJvdGF0aW9uID0gdGhpcy5lbnZNYXBSb3RhdGlvbi50b0FycmF5KCkpLCB0aGlzLmVudk1hcEludGVuc2l0eSAhPT0gdm9pZCAwICYmIChpLmVudk1hcEludGVuc2l0eSA9IHRoaXMuZW52TWFwSW50ZW5zaXR5KSwgdGhpcy5yZWZsZWN0aXZpdHkgIT09IHZvaWQgMCAmJiAoaS5yZWZsZWN0aXZpdHkgPSB0aGlzLnJlZmxlY3Rpdml0eSksIHRoaXMucmVmcmFjdGlvblJhdGlvICE9PSB2b2lkIDAgJiYgKGkucmVmcmFjdGlvblJhdGlvID0gdGhpcy5yZWZyYWN0aW9uUmF0aW8pLCB0aGlzLmdyYWRpZW50TWFwICYmIHRoaXMuZ3JhZGllbnRNYXAuaXNUZXh0dXJlICYmIChpLmdyYWRpZW50TWFwID0gdGhpcy5ncmFkaWVudE1hcC50b0pTT04odCkudXVpZCksIHRoaXMudHJhbnNtaXNzaW9uICE9PSB2b2lkIDAgJiYgKGkudHJhbnNtaXNzaW9uID0gdGhpcy50cmFuc21pc3Npb24pLCB0aGlzLnRyYW5zbWlzc2lvbk1hcCAmJiB0aGlzLnRyYW5zbWlzc2lvbk1hcC5pc1RleHR1cmUgJiYgKGkudHJhbnNtaXNzaW9uTWFwID0gdGhpcy50cmFuc21pc3Npb25NYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLnRoaWNrbmVzcyAhPT0gdm9pZCAwICYmIChpLnRoaWNrbmVzcyA9IHRoaXMudGhpY2tuZXNzKSwgdGhpcy50aGlja25lc3NNYXAgJiYgdGhpcy50aGlja25lc3NNYXAuaXNUZXh0dXJlICYmIChpLnRoaWNrbmVzc01hcCA9IHRoaXMudGhpY2tuZXNzTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5hdHRlbnVhdGlvbkRpc3RhbmNlICE9PSB2b2lkIDAgJiYgdGhpcy5hdHRlbnVhdGlvbkRpc3RhbmNlICE9PSAxIC8gMCAmJiAoaS5hdHRlbnVhdGlvbkRpc3RhbmNlID0gdGhpcy5hdHRlbnVhdGlvbkRpc3RhbmNlKSwgdGhpcy5hdHRlbnVhdGlvbkNvbG9yICE9PSB2b2lkIDAgJiYgKGkuYXR0ZW51YXRpb25Db2xvciA9IHRoaXMuYXR0ZW51YXRpb25Db2xvci5nZXRIZXgoKSksIHRoaXMuc2l6ZSAhPT0gdm9pZCAwICYmIChpLnNpemUgPSB0aGlzLnNpemUpLCB0aGlzLnNoYWRvd1NpZGUgIT09IG51bGwgJiYgKGkuc2hhZG93U2lkZSA9IHRoaXMuc2hhZG93U2lkZSksIHRoaXMuc2l6ZUF0dGVudWF0aW9uICE9PSB2b2lkIDAgJiYgKGkuc2l6ZUF0dGVudWF0aW9uID0gdGhpcy5zaXplQXR0ZW51YXRpb24pLCB0aGlzLmJsZW5kaW5nICE9PSB3cyAmJiAoaS5ibGVuZGluZyA9IHRoaXMuYmxlbmRpbmcpLCB0aGlzLnNpZGUgIT09ICRpICYmIChpLnNpZGUgPSB0aGlzLnNpZGUpLCB0aGlzLnZlcnRleENvbG9ycyA9PT0gITAgJiYgKGkudmVydGV4Q29sb3JzID0gITApLCB0aGlzLm9wYWNpdHkgPCAxICYmIChpLm9wYWNpdHkgPSB0aGlzLm9wYWNpdHkpLCB0aGlzLnRyYW5zcGFyZW50ID09PSAhMCAmJiAoaS50cmFuc3BhcmVudCA9ICEwKSwgdGhpcy5ibGVuZFNyYyAhPT0gSWggJiYgKGkuYmxlbmRTcmMgPSB0aGlzLmJsZW5kU3JjKSwgdGhpcy5ibGVuZERzdCAhPT0gTGggJiYgKGkuYmxlbmREc3QgPSB0aGlzLmJsZW5kRHN0KSwgdGhpcy5ibGVuZEVxdWF0aW9uICE9PSB2cyAmJiAoaS5ibGVuZEVxdWF0aW9uID0gdGhpcy5ibGVuZEVxdWF0aW9uKSwgdGhpcy5ibGVuZFNyY0FscGhhICE9PSBudWxsICYmIChpLmJsZW5kU3JjQWxwaGEgPSB0aGlzLmJsZW5kU3JjQWxwaGEpLCB0aGlzLmJsZW5kRHN0QWxwaGEgIT09IG51bGwgJiYgKGkuYmxlbmREc3RBbHBoYSA9IHRoaXMuYmxlbmREc3RBbHBoYSksIHRoaXMuYmxlbmRFcXVhdGlvbkFscGhhICE9PSBudWxsICYmIChpLmJsZW5kRXF1YXRpb25BbHBoYSA9IHRoaXMuYmxlbmRFcXVhdGlvbkFscGhhKSwgdGhpcy5ibGVuZENvbG9yICYmIHRoaXMuYmxlbmRDb2xvci5pc0NvbG9yICYmIChpLmJsZW5kQ29sb3IgPSB0aGlzLmJsZW5kQ29sb3IuZ2V0SGV4KCkpLCB0aGlzLmJsZW5kQWxwaGEgIT09IDAgJiYgKGkuYmxlbmRBbHBoYSA9IHRoaXMuYmxlbmRBbHBoYSksIHRoaXMuZGVwdGhGdW5jICE9PSBwciAmJiAoaS5kZXB0aEZ1bmMgPSB0aGlzLmRlcHRoRnVuYyksIHRoaXMuZGVwdGhUZXN0ID09PSAhMSAmJiAoaS5kZXB0aFRlc3QgPSB0aGlzLmRlcHRoVGVzdCksIHRoaXMuZGVwdGhXcml0ZSA9PT0gITEgJiYgKGkuZGVwdGhXcml0ZSA9IHRoaXMuZGVwdGhXcml0ZSksIHRoaXMuY29sb3JXcml0ZSA9PT0gITEgJiYgKGkuY29sb3JXcml0ZSA9IHRoaXMuY29sb3JXcml0ZSksIHRoaXMuc3RlbmNpbFdyaXRlTWFzayAhPT0gMjU1ICYmIChpLnN0ZW5jaWxXcml0ZU1hc2sgPSB0aGlzLnN0ZW5jaWxXcml0ZU1hc2spLCB0aGlzLnN0ZW5jaWxGdW5jICE9PSBUbyAmJiAoaS5zdGVuY2lsRnVuYyA9IHRoaXMuc3RlbmNpbEZ1bmMpLCB0aGlzLnN0ZW5jaWxSZWYgIT09IDAgJiYgKGkuc3RlbmNpbFJlZiA9IHRoaXMuc3RlbmNpbFJlZiksIHRoaXMuc3RlbmNpbEZ1bmNNYXNrICE9PSAyNTUgJiYgKGkuc3RlbmNpbEZ1bmNNYXNrID0gdGhpcy5zdGVuY2lsRnVuY01hc2spLCB0aGlzLnN0ZW5jaWxGYWlsICE9PSBlciAmJiAoaS5zdGVuY2lsRmFpbCA9IHRoaXMuc3RlbmNpbEZhaWwpLCB0aGlzLnN0ZW5jaWxaRmFpbCAhPT0gZXIgJiYgKGkuc3RlbmNpbFpGYWlsID0gdGhpcy5zdGVuY2lsWkZhaWwpLCB0aGlzLnN0ZW5jaWxaUGFzcyAhPT0gZXIgJiYgKGkuc3RlbmNpbFpQYXNzID0gdGhpcy5zdGVuY2lsWlBhc3MpLCB0aGlzLnN0ZW5jaWxXcml0ZSA9PT0gITAgJiYgKGkuc3RlbmNpbFdyaXRlID0gdGhpcy5zdGVuY2lsV3JpdGUpLCB0aGlzLnJvdGF0aW9uICE9PSB2b2lkIDAgJiYgdGhpcy5yb3RhdGlvbiAhPT0gMCAmJiAoaS5yb3RhdGlvbiA9IHRoaXMucm90YXRpb24pLCB0aGlzLnBvbHlnb25PZmZzZXQgPT09ICEwICYmIChpLnBvbHlnb25PZmZzZXQgPSAhMCksIHRoaXMucG9seWdvbk9mZnNldEZhY3RvciAhPT0gMCAmJiAoaS5wb2x5Z29uT2Zmc2V0RmFjdG9yID0gdGhpcy5wb2x5Z29uT2Zmc2V0RmFjdG9yKSwgdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMgIT09IDAgJiYgKGkucG9seWdvbk9mZnNldFVuaXRzID0gdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMpLCB0aGlzLmxpbmV3aWR0aCAhPT0gdm9pZCAwICYmIHRoaXMubGluZXdpZHRoICE9PSAxICYmIChpLmxpbmV3aWR0aCA9IHRoaXMubGluZXdpZHRoKSwgdGhpcy5kYXNoU2l6ZSAhPT0gdm9pZCAwICYmIChpLmRhc2hTaXplID0gdGhpcy5kYXNoU2l6ZSksIHRoaXMuZ2FwU2l6ZSAhPT0gdm9pZCAwICYmIChpLmdhcFNpemUgPSB0aGlzLmdhcFNpemUpLCB0aGlzLnNjYWxlICE9PSB2b2lkIDAgJiYgKGkuc2NhbGUgPSB0aGlzLnNjYWxlKSwgdGhpcy5kaXRoZXJpbmcgPT09ICEwICYmIChpLmRpdGhlcmluZyA9ICEwKSwgdGhpcy5hbHBoYVRlc3QgPiAwICYmIChpLmFscGhhVGVzdCA9IHRoaXMuYWxwaGFUZXN0KSwgdGhpcy5hbHBoYUhhc2ggPT09ICEwICYmIChpLmFscGhhSGFzaCA9ICEwKSwgdGhpcy5hbHBoYVRvQ292ZXJhZ2UgPT09ICEwICYmIChpLmFscGhhVG9Db3ZlcmFnZSA9ICEwKSwgdGhpcy5wcmVtdWx0aXBsaWVkQWxwaGEgPT09ICEwICYmIChpLnByZW11bHRpcGxpZWRBbHBoYSA9ICEwKSwgdGhpcy5mb3JjZVNpbmdsZVBhc3MgPT09ICEwICYmIChpLmZvcmNlU2luZ2xlUGFzcyA9ICEwKSwgdGhpcy53aXJlZnJhbWUgPT09ICEwICYmIChpLndpcmVmcmFtZSA9ICEwKSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPiAxICYmIChpLndpcmVmcmFtZUxpbmV3aWR0aCA9IHRoaXMud2lyZWZyYW1lTGluZXdpZHRoKSwgdGhpcy53aXJlZnJhbWVMaW5lY2FwICE9PSAicm91bmQiICYmIChpLndpcmVmcmFtZUxpbmVjYXAgPSB0aGlzLndpcmVmcmFtZUxpbmVjYXApLCB0aGlzLndpcmVmcmFtZUxpbmVqb2luICE9PSAicm91bmQiICYmIChpLndpcmVmcmFtZUxpbmVqb2luID0gdGhpcy53aXJlZnJhbWVMaW5lam9pbiksIHRoaXMuZmxhdFNoYWRpbmcgPT09ICEwICYmIChpLmZsYXRTaGFkaW5nID0gITApLCB0aGlzLnZpc2libGUgPT09ICExICYmIChpLnZpc2libGUgPSAhMSksIHRoaXMudG9uZU1hcHBlZCA9PT0gITEgJiYgKGkudG9uZU1hcHBlZCA9ICExKSwgdGhpcy5mb2cgPT09ICExICYmIChpLmZvZyA9ICExKSwgT2JqZWN0LmtleXModGhpcy51c2VyRGF0YSkubGVuZ3RoID4gMCAmJiAoaS51c2VyRGF0YSA9IHRoaXMudXNlckRhdGEpOwogICAgZnVuY3Rpb24gbihzKSB7CiAgICAgIGNvbnN0IHIgPSBbXTsKICAgICAgZm9yIChjb25zdCBvIGluIHMpIHsKICAgICAgICBjb25zdCBsID0gc1tvXTsKICAgICAgICBkZWxldGUgbC5tZXRhZGF0YSwgci5wdXNoKGwpOwogICAgICB9CiAgICAgIHJldHVybiByOwogICAgfQogICAgaWYgKGUpIHsKICAgICAgY29uc3QgcyA9IG4odC50ZXh0dXJlcyksIHIgPSBuKHQuaW1hZ2VzKTsKICAgICAgcy5sZW5ndGggPiAwICYmIChpLnRleHR1cmVzID0gcyksIHIubGVuZ3RoID4gMCAmJiAoaS5pbWFnZXMgPSByKTsKICAgIH0KICAgIHJldHVybiBpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IG1hdGVyaWFsIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRlcmlhbH0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIG1hdGVyaWFsIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge01hdGVyaWFsfSBzb3VyY2UgLSBUaGUgbWF0ZXJpYWwgdG8gY29weS4KICAgKiBAcmV0dXJuIHtNYXRlcmlhbH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQpIHsKICAgIHRoaXMubmFtZSA9IHQubmFtZSwgdGhpcy5ibGVuZGluZyA9IHQuYmxlbmRpbmcsIHRoaXMuc2lkZSA9IHQuc2lkZSwgdGhpcy52ZXJ0ZXhDb2xvcnMgPSB0LnZlcnRleENvbG9ycywgdGhpcy5vcGFjaXR5ID0gdC5vcGFjaXR5LCB0aGlzLnRyYW5zcGFyZW50ID0gdC50cmFuc3BhcmVudCwgdGhpcy5ibGVuZFNyYyA9IHQuYmxlbmRTcmMsIHRoaXMuYmxlbmREc3QgPSB0LmJsZW5kRHN0LCB0aGlzLmJsZW5kRXF1YXRpb24gPSB0LmJsZW5kRXF1YXRpb24sIHRoaXMuYmxlbmRTcmNBbHBoYSA9IHQuYmxlbmRTcmNBbHBoYSwgdGhpcy5ibGVuZERzdEFscGhhID0gdC5ibGVuZERzdEFscGhhLCB0aGlzLmJsZW5kRXF1YXRpb25BbHBoYSA9IHQuYmxlbmRFcXVhdGlvbkFscGhhLCB0aGlzLmJsZW5kQ29sb3IuY29weSh0LmJsZW5kQ29sb3IpLCB0aGlzLmJsZW5kQWxwaGEgPSB0LmJsZW5kQWxwaGEsIHRoaXMuZGVwdGhGdW5jID0gdC5kZXB0aEZ1bmMsIHRoaXMuZGVwdGhUZXN0ID0gdC5kZXB0aFRlc3QsIHRoaXMuZGVwdGhXcml0ZSA9IHQuZGVwdGhXcml0ZSwgdGhpcy5zdGVuY2lsV3JpdGVNYXNrID0gdC5zdGVuY2lsV3JpdGVNYXNrLCB0aGlzLnN0ZW5jaWxGdW5jID0gdC5zdGVuY2lsRnVuYywgdGhpcy5zdGVuY2lsUmVmID0gdC5zdGVuY2lsUmVmLCB0aGlzLnN0ZW5jaWxGdW5jTWFzayA9IHQuc3RlbmNpbEZ1bmNNYXNrLCB0aGlzLnN0ZW5jaWxGYWlsID0gdC5zdGVuY2lsRmFpbCwgdGhpcy5zdGVuY2lsWkZhaWwgPSB0LnN0ZW5jaWxaRmFpbCwgdGhpcy5zdGVuY2lsWlBhc3MgPSB0LnN0ZW5jaWxaUGFzcywgdGhpcy5zdGVuY2lsV3JpdGUgPSB0LnN0ZW5jaWxXcml0ZTsKICAgIGNvbnN0IGUgPSB0LmNsaXBwaW5nUGxhbmVzOwogICAgbGV0IGkgPSBudWxsOwogICAgaWYgKGUgIT09IG51bGwpIHsKICAgICAgY29uc3QgbiA9IGUubGVuZ3RoOwogICAgICBpID0gbmV3IEFycmF5KG4pOwogICAgICBmb3IgKGxldCBzID0gMDsgcyAhPT0gbjsgKytzKQogICAgICAgIGlbc10gPSBlW3NdLmNsb25lKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jbGlwcGluZ1BsYW5lcyA9IGksIHRoaXMuY2xpcEludGVyc2VjdGlvbiA9IHQuY2xpcEludGVyc2VjdGlvbiwgdGhpcy5jbGlwU2hhZG93cyA9IHQuY2xpcFNoYWRvd3MsIHRoaXMuc2hhZG93U2lkZSA9IHQuc2hhZG93U2lkZSwgdGhpcy5jb2xvcldyaXRlID0gdC5jb2xvcldyaXRlLCB0aGlzLnByZWNpc2lvbiA9IHQucHJlY2lzaW9uLCB0aGlzLnBvbHlnb25PZmZzZXQgPSB0LnBvbHlnb25PZmZzZXQsIHRoaXMucG9seWdvbk9mZnNldEZhY3RvciA9IHQucG9seWdvbk9mZnNldEZhY3RvciwgdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMgPSB0LnBvbHlnb25PZmZzZXRVbml0cywgdGhpcy5kaXRoZXJpbmcgPSB0LmRpdGhlcmluZywgdGhpcy5hbHBoYVRlc3QgPSB0LmFscGhhVGVzdCwgdGhpcy5hbHBoYUhhc2ggPSB0LmFscGhhSGFzaCwgdGhpcy5hbHBoYVRvQ292ZXJhZ2UgPSB0LmFscGhhVG9Db3ZlcmFnZSwgdGhpcy5wcmVtdWx0aXBsaWVkQWxwaGEgPSB0LnByZW11bHRpcGxpZWRBbHBoYSwgdGhpcy5mb3JjZVNpbmdsZVBhc3MgPSB0LmZvcmNlU2luZ2xlUGFzcywgdGhpcy52aXNpYmxlID0gdC52aXNpYmxlLCB0aGlzLnRvbmVNYXBwZWQgPSB0LnRvbmVNYXBwZWQsIHRoaXMudXNlckRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHQudXNlckRhdGEpKSwgdGhpczsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICoKICAgKiBAZmlyZXMgTWF0ZXJpYWwjZGlzcG9zZQogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAiZGlzcG9zZSIgfSk7CiAgfQogIC8qKgogICAqIFNldHRpbmcgdGhpcyBwcm9wZXJ0eSB0byBgdHJ1ZWAgaW5kaWNhdGVzIHRoZSBlbmdpbmUgdGhlIG1hdGVyaWFsCiAgICogbmVlZHMgdG8gYmUgcmVjb21waWxlZC4KICAgKgogICAqIEB0eXBlIHtib29sZWFufQogICAqIEBkZWZhdWx0IGZhbHNlCiAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogICAqLwogIHNldCBuZWVkc1VwZGF0ZSh0KSB7CiAgICB0ID09PSAhMCAmJiB0aGlzLnZlcnNpb24rKzsKICB9Cn0sIGxpID0gY2xhc3MgZXh0ZW5kcyBoaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBtZXNoIGJhc2ljIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbWV0ZXJzXSAtIEFuIG9iamVjdCB3aXRoIG9uZSBvciBtb3JlIHByb3BlcnRpZXMKICAgKiBkZWZpbmluZyB0aGUgbWF0ZXJpYWwncyBhcHBlYXJhbmNlLiBBbnkgcHJvcGVydHkgb2YgdGhlIG1hdGVyaWFsCiAgICogKGluY2x1ZGluZyBhbnkgcHJvcGVydHkgZnJvbSBpbmhlcml0ZWQgbWF0ZXJpYWxzKSBjYW4gYmUgcGFzc2VkCiAgICogaW4gaGVyZS4gQ29sb3IgdmFsdWVzIGNhbiBiZSBwYXNzZWQgYW55IHR5cGUgb2YgdmFsdWUgYWNjZXB0ZWQKICAgKiBieSB7QGxpbmsgQ29sb3Ijc2V0fS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaEJhc2ljTWF0ZXJpYWwgPSAhMCwgdGhpcy50eXBlID0gIk1lc2hCYXNpY01hdGVyaWFsIiwgdGhpcy5jb2xvciA9IG5ldyBjdCgxNjc3NzIxNSksIHRoaXMubWFwID0gbnVsbCwgdGhpcy5saWdodE1hcCA9IG51bGwsIHRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSAxLCB0aGlzLmFvTWFwID0gbnVsbCwgdGhpcy5hb01hcEludGVuc2l0eSA9IDEsIHRoaXMuc3BlY3VsYXJNYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5lbnZNYXAgPSBudWxsLCB0aGlzLmVudk1hcFJvdGF0aW9uID0gbmV3IGZuKCksIHRoaXMuY29tYmluZSA9IHpvLCB0aGlzLnJlZmxlY3Rpdml0eSA9IDEsIHRoaXMucmVmcmFjdGlvblJhdGlvID0gMC45OCwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAicm91bmQiLCB0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gInJvdW5kIiwgdGhpcy5mb2cgPSAhMCwgdGhpcy5zZXRWYWx1ZXModCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuY29sb3IuY29weSh0LmNvbG9yKSwgdGhpcy5tYXAgPSB0Lm1hcCwgdGhpcy5saWdodE1hcCA9IHQubGlnaHRNYXAsIHRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSB0LmxpZ2h0TWFwSW50ZW5zaXR5LCB0aGlzLmFvTWFwID0gdC5hb01hcCwgdGhpcy5hb01hcEludGVuc2l0eSA9IHQuYW9NYXBJbnRlbnNpdHksIHRoaXMuc3BlY3VsYXJNYXAgPSB0LnNwZWN1bGFyTWFwLCB0aGlzLmFscGhhTWFwID0gdC5hbHBoYU1hcCwgdGhpcy5lbnZNYXAgPSB0LmVudk1hcCwgdGhpcy5lbnZNYXBSb3RhdGlvbi5jb3B5KHQuZW52TWFwUm90YXRpb24pLCB0aGlzLmNvbWJpbmUgPSB0LmNvbWJpbmUsIHRoaXMucmVmbGVjdGl2aXR5ID0gdC5yZWZsZWN0aXZpdHksIHRoaXMucmVmcmFjdGlvblJhdGlvID0gdC5yZWZyYWN0aW9uUmF0aW8sIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHQud2lyZWZyYW1lTGluZWNhcCwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHQud2lyZWZyYW1lTGluZWpvaW4sIHRoaXMuZm9nID0gdC5mb2csIHRoaXM7CiAgfQp9Owpjb25zdCBYbiA9IC8qIEBfX1BVUkVfXyAqLyBUdigpOwpmdW5jdGlvbiBUdigpIHsKICBjb25zdCBhID0gbmV3IEFycmF5QnVmZmVyKDQpLCB0ID0gbmV3IEZsb2F0MzJBcnJheShhKSwgZSA9IG5ldyBVaW50MzJBcnJheShhKSwgaSA9IG5ldyBVaW50MzJBcnJheSg1MTIpLCBuID0gbmV3IFVpbnQzMkFycmF5KDUxMik7CiAgZm9yIChsZXQgbCA9IDA7IGwgPCAyNTY7ICsrbCkgewogICAgY29uc3QgaCA9IGwgLSAxMjc7CiAgICBoIDwgLTI3ID8gKGlbbF0gPSAwLCBpW2wgfCAyNTZdID0gMzI3NjgsIG5bbF0gPSAyNCwgbltsIHwgMjU2XSA9IDI0KSA6IGggPCAtMTQgPyAoaVtsXSA9IDEwMjQgPj4gLWggLSAxNCwgaVtsIHwgMjU2XSA9IDEwMjQgPj4gLWggLSAxNCB8IDMyNzY4LCBuW2xdID0gLWggLSAxLCBuW2wgfCAyNTZdID0gLWggLSAxKSA6IGggPD0gMTUgPyAoaVtsXSA9IGggKyAxNSA8PCAxMCwgaVtsIHwgMjU2XSA9IGggKyAxNSA8PCAxMCB8IDMyNzY4LCBuW2xdID0gMTMsIG5bbCB8IDI1Nl0gPSAxMykgOiBoIDwgMTI4ID8gKGlbbF0gPSAzMTc0NCwgaVtsIHwgMjU2XSA9IDY0NTEyLCBuW2xdID0gMjQsIG5bbCB8IDI1Nl0gPSAyNCkgOiAoaVtsXSA9IDMxNzQ0LCBpW2wgfCAyNTZdID0gNjQ1MTIsIG5bbF0gPSAxMywgbltsIHwgMjU2XSA9IDEzKTsKICB9CiAgY29uc3QgcyA9IG5ldyBVaW50MzJBcnJheSgyMDQ4KSwgciA9IG5ldyBVaW50MzJBcnJheSg2NCksIG8gPSBuZXcgVWludDMyQXJyYXkoNjQpOwogIGZvciAobGV0IGwgPSAxOyBsIDwgMTAyNDsgKytsKSB7CiAgICBsZXQgaCA9IGwgPDwgMTMsIGMgPSAwOwogICAgZm9yICg7ICEoaCAmIDgzODg2MDgpOyApCiAgICAgIGggPDw9IDEsIGMgLT0gODM4ODYwODsKICAgIGggJj0gLTgzODg2MDksIGMgKz0gOTQ3OTEyNzA0LCBzW2xdID0gaCB8IGM7CiAgfQogIGZvciAobGV0IGwgPSAxMDI0OyBsIDwgMjA0ODsgKytsKQogICAgc1tsXSA9IDkzOTUyNDA5NiArIChsIC0gMTAyNCA8PCAxMyk7CiAgZm9yIChsZXQgbCA9IDE7IGwgPCAzMTsgKytsKQogICAgcltsXSA9IGwgPDwgMjM7CiAgclszMV0gPSAxMTk5NTcwOTQ0LCByWzMyXSA9IDIxNDc0ODM2NDg7CiAgZm9yIChsZXQgbCA9IDMzOyBsIDwgNjM7ICsrbCkKICAgIHJbbF0gPSAyMTQ3NDgzNjQ4ICsgKGwgLSAzMiA8PCAyMyk7CiAgcls2M10gPSAzMzQ3MDU0NTkyOwogIGZvciAobGV0IGwgPSAxOyBsIDwgNjQ7ICsrbCkKICAgIGwgIT09IDMyICYmIChvW2xdID0gMTAyNCk7CiAgcmV0dXJuIHsKICAgIGZsb2F0VmlldzogdCwKICAgIHVpbnQzMlZpZXc6IGUsCiAgICBiYXNlVGFibGU6IGksCiAgICBzaGlmdFRhYmxlOiBuLAogICAgbWFudGlzc2FUYWJsZTogcywKICAgIGV4cG9uZW50VGFibGU6IHIsCiAgICBvZmZzZXRUYWJsZTogbwogIH07Cn0KZnVuY3Rpb24gYmkoYSkgewogIE1hdGguYWJzKGEpID4gNjU1MDQgJiYgY29uc29sZS53YXJuKCJUSFJFRS5EYXRhVXRpbHMudG9IYWxmRmxvYXQoKTogVmFsdWUgb3V0IG9mIHJhbmdlLiIpLCBhID0ga3QoYSwgLTY1NTA0LCA2NTUwNCksIFhuLmZsb2F0Vmlld1swXSA9IGE7CiAgY29uc3QgdCA9IFhuLnVpbnQzMlZpZXdbMF0sIGUgPSB0ID4+IDIzICYgNTExOwogIHJldHVybiBYbi5iYXNlVGFibGVbZV0gKyAoKHQgJiA4Mzg4NjA3KSA+PiBYbi5zaGlmdFRhYmxlW2VdKTsKfQpmdW5jdGlvbiBubyhhKSB7CiAgY29uc3QgdCA9IGEgPj4gMTA7CiAgcmV0dXJuIFhuLnVpbnQzMlZpZXdbMF0gPSBYbi5tYW50aXNzYVRhYmxlW1huLm9mZnNldFRhYmxlW3RdICsgKGEgJiAxMDIzKV0gKyBYbi5leHBvbmVudFRhYmxlW3RdLCBYbi5mbG9hdFZpZXdbMF07Cn0KY2xhc3MgQ3YgewogIC8qKgogICAqIFJldHVybnMgYSBoYWxmIHByZWNpc2lvbiBmbG9hdGluZyBwb2ludCB2YWx1ZSAoRlAxNikgZnJvbSB0aGUgZ2l2ZW4gc2luZ2xlCiAgICogcHJlY2lzaW9uIGZsb2F0aW5nIHBvaW50IHZhbHVlIChGUDMyKS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgLSBBIHNpbmdsZSBwcmVjaXNpb24gZmxvYXRpbmcgcG9pbnQgdmFsdWUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgRlAxNiB2YWx1ZS4KICAgKi8KICBzdGF0aWMgdG9IYWxmRmxvYXQodCkgewogICAgcmV0dXJuIGJpKHQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgc2luZ2xlIHByZWNpc2lvbiBmbG9hdGluZyBwb2ludCB2YWx1ZSAoRlAzMikgZnJvbSB0aGUgZ2l2ZW4gaGFsZgogICAqIHByZWNpc2lvbiBmbG9hdGluZyBwb2ludCB2YWx1ZSAoRlAxNikuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gQSBoYWxmIHByZWNpc2lvbiBmbG9hdGluZyBwb2ludCB2YWx1ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBGUDMyIHZhbHVlLgogICAqLwogIHN0YXRpYyBmcm9tSGFsZkZsb2F0KHQpIHsKICAgIHJldHVybiBubyh0KTsKICB9Cn0KY29uc3QgSWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgbmwgPSAvKiBAX19QVVJFX18gKi8gbmV3IEooKTsKbGV0IFJ2ID0gMCwgaWUgPSBjbGFzcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBhcnJheSAtIFRoZSBhcnJheSBob2xkaW5nIHRoZSBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vcm1hbGl6ZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgZGF0YSBhcmUgbm9ybWFsaXplZCBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSA9ICExKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0KSkKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVEhSRUUuQnVmZmVyQXR0cmlidXRlOiBhcnJheSBzaG91bGQgYmUgYSBUeXBlZCBBcnJheS4iKTsKICAgIHRoaXMuaXNCdWZmZXJBdHRyaWJ1dGUgPSAhMCwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJpZCIsIHsgdmFsdWU6IFJ2KysgfSksIHRoaXMubmFtZSA9ICIiLCB0aGlzLmFycmF5ID0gdCwgdGhpcy5pdGVtU2l6ZSA9IGUsIHRoaXMuY291bnQgPSB0ICE9PSB2b2lkIDAgPyB0Lmxlbmd0aCAvIGUgOiAwLCB0aGlzLm5vcm1hbGl6ZWQgPSBpLCB0aGlzLnVzYWdlID0gQ28sIHRoaXMudXBkYXRlUmFuZ2VzID0gW10sIHRoaXMuZ3B1VHlwZSA9IHdpLCB0aGlzLnZlcnNpb24gPSAwOwogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgaXMgZXhlY3V0ZWQgYWZ0ZXIgdGhlIHJlbmRlcmVyIGhhcyB0cmFuc2ZlcnJlZCB0aGUgYXR0cmlidXRlCiAgICogYXJyYXkgZGF0YSB0byB0aGUgR1BVLgogICAqLwogIG9uVXBsb2FkQ2FsbGJhY2soKSB7CiAgfQogIC8qKgogICAqIEZsYWcgdG8gaW5kaWNhdGUgdGhhdCB0aGlzIGF0dHJpYnV0ZSBoYXMgY2hhbmdlZCBhbmQgc2hvdWxkIGJlIHJlLXNlbnQgdG8KICAgKiB0aGUgR1BVLiBTZXQgdGhpcyB0byBgdHJ1ZWAgd2hlbiB5b3UgbW9kaWZ5IHRoZSB2YWx1ZSBvZiB0aGUgYXJyYXkuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IGZhbHNlCiAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogICAqLwogIHNldCBuZWVkc1VwZGF0ZSh0KSB7CiAgICB0ID09PSAhMCAmJiB0aGlzLnZlcnNpb24rKzsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdXNhZ2Ugb2YgdGhpcyBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHsoU3RhdGljRHJhd1VzYWdlfER5bmFtaWNEcmF3VXNhZ2V8U3RyZWFtRHJhd1VzYWdlfFN0YXRpY1JlYWRVc2FnZXxEeW5hbWljUmVhZFVzYWdlfFN0cmVhbVJlYWRVc2FnZXxTdGF0aWNDb3B5VXNhZ2V8RHluYW1pY0NvcHlVc2FnZXxTdHJlYW1Db3B5VXNhZ2UpfSB2YWx1ZSAtIFRoZSB1c2FnZSB0byBzZXQuCiAgICogQHJldHVybiB7QnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICovCiAgc2V0VXNhZ2UodCkgewogICAgcmV0dXJuIHRoaXMudXNhZ2UgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGEgcmFuZ2Ugb2YgZGF0YSBpbiB0aGUgZGF0YSBhcnJheSB0byBiZSB1cGRhdGVkIG9uIHRoZSBHUFUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBQb3NpdGlvbiBhdCB3aGljaCB0byBzdGFydCB1cGRhdGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvdW50IC0gVGhlIG51bWJlciBvZiBjb21wb25lbnRzIHRvIHVwZGF0ZS4KICAgKi8KICBhZGRVcGRhdGVSYW5nZSh0LCBlKSB7CiAgICB0aGlzLnVwZGF0ZVJhbmdlcy5wdXNoKHsgc3RhcnQ6IHQsIGNvdW50OiBlIH0pOwogIH0KICAvKioKICAgKiBDbGVhcnMgdGhlIHVwZGF0ZSByYW5nZXMuCiAgICovCiAgY2xlYXJVcGRhdGVSYW5nZXMoKSB7CiAgICB0aGlzLnVwZGF0ZVJhbmdlcy5sZW5ndGggPSAwOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gYnVmZmVyIGF0dHJpYnV0ZSB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJBdHRyaWJ1dGV9IHNvdXJjZSAtIFRoZSBidWZmZXIgYXR0cmlidXRlIHRvIGNvcHkuCiAgICogQHJldHVybiB7QnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMubmFtZSA9IHQubmFtZSwgdGhpcy5hcnJheSA9IG5ldyB0LmFycmF5LmNvbnN0cnVjdG9yKHQuYXJyYXkpLCB0aGlzLml0ZW1TaXplID0gdC5pdGVtU2l6ZSwgdGhpcy5jb3VudCA9IHQuY291bnQsIHRoaXMubm9ybWFsaXplZCA9IHQubm9ybWFsaXplZCwgdGhpcy51c2FnZSA9IHQudXNhZ2UsIHRoaXMuZ3B1VHlwZSA9IHQuZ3B1VHlwZSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29waWVzIGEgdmVjdG9yIGZyb20gdGhlIGdpdmVuIGJ1ZmZlciBhdHRyaWJ1dGUgdG8gdGhpcyBvbmUuIFRoZSBzdGFydAogICAqIGFuZCBkZXN0aW5hdGlvbiBwb3NpdGlvbiBpbiB0aGUgYXR0cmlidXRlIGJ1ZmZlcnMgYXJlIHJlcHJlc2VudGVkIGJ5IHRoZQogICAqIGdpdmVuIGluZGljZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXgxIC0gVGhlIGRlc3RpbmF0aW9uIGluZGV4IGludG8gdGhpcyBidWZmZXIgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7QnVmZmVyQXR0cmlidXRlfSBhdHRyaWJ1dGUgLSBUaGUgYnVmZmVyIGF0dHJpYnV0ZSB0byBjb3B5IGZyb20uCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4MiAtIFRoZSBzb3VyY2UgaW5kZXggaW50byB0aGUgZ2l2ZW4gYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY29weUF0KHQsIGUsIGkpIHsKICAgIHQgKj0gdGhpcy5pdGVtU2l6ZSwgaSAqPSBlLml0ZW1TaXplOwogICAgZm9yIChsZXQgbiA9IDAsIHMgPSB0aGlzLml0ZW1TaXplOyBuIDwgczsgbisrKQogICAgICB0aGlzLmFycmF5W3QgKyBuXSA9IGUuYXJyYXlbaSArIG5dOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgZ2l2ZW4gYXJyYXkgZGF0YSBpbnRvIHRoaXMgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KFR5cGVkQXJyYXl8QXJyYXkpfSBhcnJheSAtIFRoZSBhcnJheSB0byBjb3B5LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5QXJyYXkodCkgewogICAgcmV0dXJuIHRoaXMuYXJyYXkuc2V0KHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiAzeDMgbWF0cml4IHRvIHRoZSBnaXZlbiBhdHRyaWJ1dGUuIFdvcmtzIHdpdGgKICAgKiBpdGVtIHNpemUgYDJgIGFuZCBgM2AuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbWF0cml4IHRvIGFwcGx5LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhcHBseU1hdHJpeDModCkgewogICAgaWYgKHRoaXMuaXRlbVNpemUgPT09IDIpCiAgICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgICBubC5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCBubC5hcHBseU1hdHJpeDModCksIHRoaXMuc2V0WFkoZSwgbmwueCwgbmwueSk7CiAgICBlbHNlIGlmICh0aGlzLml0ZW1TaXplID09PSAzKQogICAgICBmb3IgKGxldCBlID0gMCwgaSA9IHRoaXMuY291bnQ7IGUgPCBpOyBlKyspCiAgICAgICAgSWUuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0aGlzLCBlKSwgSWUuYXBwbHlNYXRyaXgzKHQpLCB0aGlzLnNldFhZWihlLCBJZS54LCBJZS55LCBJZS56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiA0eDQgbWF0cml4IHRvIHRoZSBnaXZlbiBhdHRyaWJ1dGUuIE9ubHkgd29ya3Mgd2l0aAogICAqIGl0ZW0gc2l6ZSBgM2AuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4IHRvIGFwcGx5LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhcHBseU1hdHJpeDQodCkgewogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0aGlzLmNvdW50OyBlIDwgaTsgZSsrKQogICAgICBJZS5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCBJZS5hcHBseU1hdHJpeDQodCksIHRoaXMuc2V0WFlaKGUsIEllLngsIEllLnksIEllLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIEFwcGxpZXMgdGhlIGdpdmVuIDN4MyBub3JtYWwgbWF0cml4IHRvIHRoZSBnaXZlbiBhdHRyaWJ1dGUuIE9ubHkgd29ya3Mgd2l0aAogICAqIGl0ZW0gc2l6ZSBgM2AuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbm9ybWFsIG1hdHJpeCB0byBhcHBseS4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgYXBwbHlOb3JtYWxNYXRyaXgodCkgewogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0aGlzLmNvdW50OyBlIDwgaTsgZSsrKQogICAgICBJZS5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCBJZS5hcHBseU5vcm1hbE1hdHJpeCh0KSwgdGhpcy5zZXRYWVooZSwgSWUueCwgSWUueSwgSWUueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogQXBwbGllcyB0aGUgZ2l2ZW4gNHg0IG1hdHJpeCB0byB0aGUgZ2l2ZW4gYXR0cmlidXRlLiBPbmx5IHdvcmtzIHdpdGgKICAgKiBpdGVtIHNpemUgYDNgIGFuZCB3aXRoIGRpcmVjdGlvbiB2ZWN0b3JzLgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIG1hdHJpeCB0byBhcHBseS4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgdHJhbnNmb3JtRGlyZWN0aW9uKHQpIHsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgSWUuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0aGlzLCBlKSwgSWUudHJhbnNmb3JtRGlyZWN0aW9uKHQpLCB0aGlzLnNldFhZWihlLCBJZS54LCBJZS55LCBJZS56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBhcnJheSBkYXRhIGluIHRoZSBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHsoVHlwZWRBcnJheXxBcnJheSl9IHZhbHVlIC0gVGhlIGFycmF5IGRhdGEgdG8gc2V0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbiB0aGlzIGJ1ZmZlciBhdHRyaWJ1dGUncyBhcnJheS4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy5hcnJheS5zZXQodCwgZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGdpdmVuIGNvbXBvbmVudCBvZiB0aGUgdmVjdG9yIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBpbnRvIHRoZSBidWZmZXIgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb21wb25lbnQgLSBUaGUgY29tcG9uZW50IGluZGV4LgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJldHVybmVkIHZhbHVlLgogICAqLwogIGdldENvbXBvbmVudCh0LCBlKSB7CiAgICBsZXQgaSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyBlXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGkgPSBtaShpLCB0aGlzLmFycmF5KSksIGk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIHZhbHVlIHRvIHRoZSBnaXZlbiBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gY29tcG9uZW50IC0gVGhlIGNvbXBvbmVudCBpbmRleC4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRDb21wb25lbnQodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoaSA9IFl0KGksIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZSArIGVdID0gaSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgeCBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB4IGNvbXBvbmVudC4KICAgKi8KICBnZXRYKHQpIHsKICAgIGxldCBlID0gdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZV07CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gbWkoZSwgdGhpcy5hcnJheSkpLCBlOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB4IGNvbXBvbmVudCBvZiB0aGUgdmVjdG9yIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBpbnRvIHRoZSBidWZmZXIgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0WCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSkpLCB0aGlzLmFycmF5W3QgKiB0aGlzLml0ZW1TaXplXSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHkgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeSBjb21wb25lbnQuCiAgICovCiAgZ2V0WSh0KSB7CiAgICBsZXQgZSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAxXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBtaShlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHkgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRZKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBZdChlLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAxXSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHogY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeiBjb21wb25lbnQuCiAgICovCiAgZ2V0Wih0KSB7CiAgICBsZXQgZSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAyXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBtaShlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHogY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRaKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBZdChlLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAyXSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHcgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgdyBjb21wb25lbnQuCiAgICovCiAgZ2V0Vyh0KSB7CiAgICBsZXQgZSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAzXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBtaShlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHcgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHcgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRXKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBZdChlLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAzXSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHggYW5kIHkgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgZm9yIHRoZSB4IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgZm9yIHRoZSB5IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHJldHVybiB7QnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFhZKHQsIGUsIGkpIHsKICAgIHJldHVybiB0ICo9IHRoaXMuaXRlbVNpemUsIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpLCBpID0gWXQoaSwgdGhpcy5hcnJheSkpLCB0aGlzLmFycmF5W3QgKyAwXSA9IGUsIHRoaXMuYXJyYXlbdCArIDFdID0gaSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgeCwgeSBhbmQgeiBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSBmb3IgdGhlIHggY29tcG9uZW50IHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSBmb3IgdGhlIHkgY29tcG9uZW50IHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB2YWx1ZSBmb3IgdGhlIHogY29tcG9uZW50IHRvIHNldC4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0WFlaKHQsIGUsIGksIG4pIHsKICAgIHJldHVybiB0ICo9IHRoaXMuaXRlbVNpemUsIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpLCBpID0gWXQoaSwgdGhpcy5hcnJheSksIG4gPSBZdChuLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5hcnJheVt0ICsgMV0gPSBpLCB0aGlzLmFycmF5W3QgKyAyXSA9IG4sIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHgsIHksIHogYW5kIHcgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgZm9yIHRoZSB4IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgZm9yIHRoZSB5IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgdmFsdWUgZm9yIHRoZSB6IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHcgLSBUaGUgdmFsdWUgZm9yIHRoZSB3IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHJldHVybiB7QnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFhZWlcodCwgZSwgaSwgbiwgcykgewogICAgcmV0dXJuIHQgKj0gdGhpcy5pdGVtU2l6ZSwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSksIGkgPSBZdChpLCB0aGlzLmFycmF5KSwgbiA9IFl0KG4sIHRoaXMuYXJyYXkpLCBzID0gWXQocywgdGhpcy5hcnJheSkpLCB0aGlzLmFycmF5W3QgKyAwXSA9IGUsIHRoaXMuYXJyYXlbdCArIDFdID0gaSwgdGhpcy5hcnJheVt0ICsgMl0gPSBuLCB0aGlzLmFycmF5W3QgKyAzXSA9IHMsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgaXMgZXhlY3V0ZWQgYWZ0ZXIgdGhlIFJlbmRlcmVyIGhhcyB0cmFuc2ZlcnJlZAogICAqIHRoZSBhdHRyaWJ1dGUgYXJyYXkgZGF0YSB0byB0aGUgR1BVLiBDYW4gYmUgdXNlZCB0byBwZXJmb3JtIGNsZWFuLXVwIG9wZXJhdGlvbnMgYWZ0ZXIKICAgKiB0aGUgdXBsb2FkIHdoZW4gYXR0cmlidXRlIGRhdGEgYXJlIG5vdCBuZWVkZWQgYW55bW9yZSBvbiB0aGUgQ1BVIHNpZGUuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBgb25VcGxvYWQoKWAgY2FsbGJhY2suCiAgICogQHJldHVybiB7QnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIG9uVXBsb2FkKHQpIHsKICAgIHJldHVybiB0aGlzLm9uVXBsb2FkQ2FsbGJhY2sgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IGJ1ZmZlciBhdHRyaWJ1dGUgd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXJyYXksIHRoaXMuaXRlbVNpemUpLmNvcHkodGhpcyk7CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIGJ1ZmZlciBhdHRyaWJ1dGUgaW50byBKU09OLgogICAqCiAgICogQHJldHVybiB7T2JqZWN0fSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBidWZmZXIgYXR0cmlidXRlLgogICAqLwogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSB7CiAgICAgIGl0ZW1TaXplOiB0aGlzLml0ZW1TaXplLAogICAgICB0eXBlOiB0aGlzLmFycmF5LmNvbnN0cnVjdG9yLm5hbWUsCiAgICAgIGFycmF5OiBBcnJheS5mcm9tKHRoaXMuYXJyYXkpLAogICAgICBub3JtYWxpemVkOiB0aGlzLm5vcm1hbGl6ZWQKICAgIH07CiAgICByZXR1cm4gdGhpcy5uYW1lICE9PSAiIiAmJiAodC5uYW1lID0gdGhpcy5uYW1lKSwgdGhpcy51c2FnZSAhPT0gQ28gJiYgKHQudXNhZ2UgPSB0aGlzLnVzYWdlKSwgdDsKICB9Cn07CmNsYXNzIFB2IGV4dGVuZHMgaWUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KEFycmF5PG51bWJlcj58SW50OEFycmF5KX0gYXJyYXkgLSBUaGUgYXJyYXkgaG9sZGluZyB0aGUgYXR0cmlidXRlIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGl0ZW1TaXplIC0gVGhlIGl0ZW0gc2l6ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3JtYWxpemVkPWZhbHNlXSAtIFdoZXRoZXIgdGhlIGRhdGEgYXJlIG5vcm1hbGl6ZWQgb3Igbm90LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHN1cGVyKG5ldyBJbnQ4QXJyYXkodCksIGUsIGkpOwogIH0KfQpjbGFzcyBJdiBleHRlbmRzIGllIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0geyhBcnJheTxudW1iZXI+fFVpbnQ4QXJyYXkpfSBhcnJheSAtIFRoZSBhcnJheSBob2xkaW5nIHRoZSBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vcm1hbGl6ZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgZGF0YSBhcmUgbm9ybWFsaXplZCBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IFVpbnQ4QXJyYXkodCksIGUsIGkpOwogIH0KfQpjbGFzcyBMdiBleHRlbmRzIGllIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0geyhBcnJheTxudW1iZXI+fFVpbnQ4Q2xhbXBlZEFycmF5KX0gYXJyYXkgLSBUaGUgYXJyYXkgaG9sZGluZyB0aGUgYXR0cmlidXRlIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGl0ZW1TaXplIC0gVGhlIGl0ZW0gc2l6ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3JtYWxpemVkPWZhbHNlXSAtIFdoZXRoZXIgdGhlIGRhdGEgYXJlIG5vcm1hbGl6ZWQgb3Igbm90LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHN1cGVyKG5ldyBVaW50OENsYW1wZWRBcnJheSh0KSwgZSwgaSk7CiAgfQp9CmNsYXNzIER2IGV4dGVuZHMgaWUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KEFycmF5PG51bWJlcj58SW50MTZBcnJheSl9IGFycmF5IC0gVGhlIGFycmF5IGhvbGRpbmcgdGhlIGF0dHJpYnV0ZSBkYXRhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpdGVtU2l6ZSAtIFRoZSBpdGVtIHNpemUuCiAgICogQHBhcmFtIHtib29sZWFufSBbbm9ybWFsaXplZD1mYWxzZV0gLSBXaGV0aGVyIHRoZSBkYXRhIGFyZSBub3JtYWxpemVkIG9yIG5vdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBzdXBlcihuZXcgSW50MTZBcnJheSh0KSwgZSwgaSk7CiAgfQp9CmxldCB6cCA9IGNsYXNzIGV4dGVuZHMgaWUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KEFycmF5PG51bWJlcj58VWludDE2QXJyYXkpfSBhcnJheSAtIFRoZSBhcnJheSBob2xkaW5nIHRoZSBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vcm1hbGl6ZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgZGF0YSBhcmUgbm9ybWFsaXplZCBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IFVpbnQxNkFycmF5KHQpLCBlLCBpKTsKICB9Cn07CmNsYXNzIEZ2IGV4dGVuZHMgaWUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KEFycmF5PG51bWJlcj58SW50MzJBcnJheSl9IGFycmF5IC0gVGhlIGFycmF5IGhvbGRpbmcgdGhlIGF0dHJpYnV0ZSBkYXRhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpdGVtU2l6ZSAtIFRoZSBpdGVtIHNpemUuCiAgICogQHBhcmFtIHtib29sZWFufSBbbm9ybWFsaXplZD1mYWxzZV0gLSBXaGV0aGVyIHRoZSBkYXRhIGFyZSBub3JtYWxpemVkIG9yIG5vdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBzdXBlcihuZXcgSW50MzJBcnJheSh0KSwgZSwgaSk7CiAgfQp9CmxldCBOcCA9IGNsYXNzIGV4dGVuZHMgaWUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KEFycmF5PG51bWJlcj58VWludDMyQXJyYXkpfSBhcnJheSAtIFRoZSBhcnJheSBob2xkaW5nIHRoZSBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vcm1hbGl6ZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgZGF0YSBhcmUgbm9ybWFsaXplZCBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IFVpbnQzMkFycmF5KHQpLCBlLCBpKTsKICB9Cn07CmNsYXNzIFV2IGV4dGVuZHMgaWUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7KEFycmF5PG51bWJlcj58VWludDE2QXJyYXkpfSBhcnJheSAtIFRoZSBhcnJheSBob2xkaW5nIHRoZSBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vcm1hbGl6ZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgZGF0YSBhcmUgbm9ybWFsaXplZCBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IFVpbnQxNkFycmF5KHQpLCBlLCBpKSwgdGhpcy5pc0Zsb2F0MTZCdWZmZXJBdHRyaWJ1dGUgPSAhMDsKICB9CiAgZ2V0WCh0KSB7CiAgICBsZXQgZSA9IG5vKHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemVdKTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBtaShlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIHNldFgodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZV0gPSBiaShlKSwgdGhpczsKICB9CiAgZ2V0WSh0KSB7CiAgICBsZXQgZSA9IG5vKHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAxXSk7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gbWkoZSwgdGhpcy5hcnJheSkpLCBlOwogIH0KICBzZXRZKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBZdChlLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAxXSA9IGJpKGUpLCB0aGlzOwogIH0KICBnZXRaKHQpIHsKICAgIGxldCBlID0gbm8odGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZSArIDJdKTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBtaShlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIHNldFoodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZSArIDJdID0gYmkoZSksIHRoaXM7CiAgfQogIGdldFcodCkgewogICAgbGV0IGUgPSBubyh0aGlzLmFycmF5W3QgKiB0aGlzLml0ZW1TaXplICsgM10pOwogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IG1pKGUsIHRoaXMuYXJyYXkpKSwgZTsKICB9CiAgc2V0Vyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSkpLCB0aGlzLmFycmF5W3QgKiB0aGlzLml0ZW1TaXplICsgM10gPSBiaShlKSwgdGhpczsKICB9CiAgc2V0WFkodCwgZSwgaSkgewogICAgcmV0dXJuIHQgKj0gdGhpcy5pdGVtU2l6ZSwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSksIGkgPSBZdChpLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCArIDBdID0gYmkoZSksIHRoaXMuYXJyYXlbdCArIDFdID0gYmkoaSksIHRoaXM7CiAgfQogIHNldFhZWih0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdCAqPSB0aGlzLml0ZW1TaXplLCB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBZdChlLCB0aGlzLmFycmF5KSwgaSA9IFl0KGksIHRoaXMuYXJyYXkpLCBuID0gWXQobiwgdGhpcy5hcnJheSkpLCB0aGlzLmFycmF5W3QgKyAwXSA9IGJpKGUpLCB0aGlzLmFycmF5W3QgKyAxXSA9IGJpKGkpLCB0aGlzLmFycmF5W3QgKyAyXSA9IGJpKG4pLCB0aGlzOwogIH0KICBzZXRYWVpXKHQsIGUsIGksIG4sIHMpIHsKICAgIHJldHVybiB0ICo9IHRoaXMuaXRlbVNpemUsIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpLCBpID0gWXQoaSwgdGhpcy5hcnJheSksIG4gPSBZdChuLCB0aGlzLmFycmF5KSwgcyA9IFl0KHMsIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICsgMF0gPSBiaShlKSwgdGhpcy5hcnJheVt0ICsgMV0gPSBiaShpKSwgdGhpcy5hcnJheVt0ICsgMl0gPSBiaShuKSwgdGhpcy5hcnJheVt0ICsgM10gPSBiaShzKSwgdGhpczsKICB9Cn0KbGV0IHd0ID0gY2xhc3MgZXh0ZW5kcyBpZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHsoQXJyYXk8bnVtYmVyPnxGbG9hdDMyQXJyYXkpfSBhcnJheSAtIFRoZSBhcnJheSBob2xkaW5nIHRoZSBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vcm1hbGl6ZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgZGF0YSBhcmUgbm9ybWFsaXplZCBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IEZsb2F0MzJBcnJheSh0KSwgZSwgaSk7CiAgfQp9LCBCdiA9IDA7CmNvbnN0IEhpID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpLCBVdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgbGUoKSwgUnIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgSWkgPSAvKiBAX19QVVJFX18gKi8gbmV3IHdlKCksIE9hID0gLyogQF9fUFVSRV9fICovIG5ldyB3ZSgpLCBPZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpOwpsZXQgSHQgPSBjbGFzcyBTeSBleHRlbmRzIEVpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGdlb21ldHJ5LgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0J1ZmZlckdlb21ldHJ5ID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiBCdisrIH0pLCB0aGlzLnV1aWQgPSBPaSgpLCB0aGlzLm5hbWUgPSAiIiwgdGhpcy50eXBlID0gIkJ1ZmZlckdlb21ldHJ5IiwgdGhpcy5pbmRleCA9IG51bGwsIHRoaXMuaW5kaXJlY3QgPSBudWxsLCB0aGlzLmF0dHJpYnV0ZXMgPSB7fSwgdGhpcy5tb3JwaEF0dHJpYnV0ZXMgPSB7fSwgdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9ICExLCB0aGlzLmdyb3VwcyA9IFtdLCB0aGlzLmJvdW5kaW5nQm94ID0gbnVsbCwgdGhpcy5ib3VuZGluZ1NwaGVyZSA9IG51bGwsIHRoaXMuZHJhd1JhbmdlID0geyBzdGFydDogMCwgY291bnQ6IDEgLyAwIH0sIHRoaXMudXNlckRhdGEgPSB7fTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgaW5kZXggb2YgdGhpcyBnZW9tZXRyeS4KICAgKgogICAqIEByZXR1cm4gez9CdWZmZXJBdHRyaWJ1dGV9IFRoZSBpbmRleC4gUmV0dXJucyBgbnVsbGAgaWYgbm8gaW5kZXggaXMgZGVmaW5lZC4KICAgKi8KICBnZXRJbmRleCgpIHsKICAgIHJldHVybiB0aGlzLmluZGV4OwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBpbmRleCB0byB0aGlzIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fEJ1ZmZlckF0dHJpYnV0ZX0gaW5kZXggLSBUaGUgaW5kZXggdG8gc2V0LgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldEluZGV4KHQpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHQpID8gdGhpcy5pbmRleCA9IG5ldyAoeXkodCkgPyBOcCA6IHpwKSh0LCAxKSA6IHRoaXMuaW5kZXggPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBpbmRpcmVjdCBhdHRyaWJ1dGUgdG8gdGhpcyBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyQXR0cmlidXRlfSBpbmRpcmVjdCAtIFRoZSBhdHRyaWJ1dGUgaG9sZGluZyBpbmRpcmVjdCBkcmF3IGNhbGxzLgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldEluZGlyZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLmluZGlyZWN0ID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgaW5kaXJlY3QgYXR0cmlidXRlIG9mIHRoaXMgZ2VvbWV0cnkuCiAgICoKICAgKiBAcmV0dXJuIHs/QnVmZmVyQXR0cmlidXRlfSBUaGUgaW5kaXJlY3QgYXR0cmlidXRlLiBSZXR1cm5zIGBudWxsYCBpZiBubyBpbmRpcmVjdCBhdHRyaWJ1dGUgaXMgZGVmaW5lZC4KICAgKi8KICBnZXRJbmRpcmVjdCgpIHsKICAgIHJldHVybiB0aGlzLmluZGlyZWN0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBidWZmZXIgYXR0cmlidXRlIGZvciB0aGUgZ2l2ZW4gbmFtZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIGF0dHJpYnV0ZSBuYW1lLgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZXxJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZXx1bmRlZmluZWR9IFRoZSBidWZmZXIgYXR0cmlidXRlLgogICAqIFJldHVybnMgYHVuZGVmaW5lZGAgaWYgbm90IGF0dHJpYnV0ZSBoYXMgYmVlbiBmb3VuZC4KICAgKi8KICBnZXRBdHRyaWJ1dGUodCkgewogICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1t0XTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gYXR0cmlidXRlIGZvciB0aGUgZ2l2ZW4gbmFtZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIGF0dHJpYnV0ZSBuYW1lLgogICAqIEBwYXJhbSB7QnVmZmVyQXR0cmlidXRlfEludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlfSBhdHRyaWJ1dGUgLSBUaGUgYXR0cmlidXRlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRBdHRyaWJ1dGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1t0XSA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIERlbGV0ZXMgdGhlIGF0dHJpYnV0ZSBmb3IgdGhlIGdpdmVuIG5hbWUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBhdHRyaWJ1dGUgbmFtZSB0byBkZWxldGUuCiAgICogQHJldHVybiB7QnVmZmVyR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgZGVsZXRlQXR0cmlidXRlKHQpIHsKICAgIHJldHVybiBkZWxldGUgdGhpcy5hdHRyaWJ1dGVzW3RdLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGdlb21ldHJ5IGhhcyBhbiBhdHRyaWJ1dGUgZm9yIHRoZSBnaXZlbiBuYW1lLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgYXR0cmlidXRlIG5hbWUuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIGdlb21ldHJ5IGhhcyBhbiBhdHRyaWJ1dGUgZm9yIHRoZSBnaXZlbiBuYW1lIG9yIG5vdC4KICAgKi8KICBoYXNBdHRyaWJ1dGUodCkgewogICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1t0XSAhPT0gdm9pZCAwOwogIH0KICAvKioKICAgKiBBZGRzIGEgZ3JvdXAgdG8gdGhpcyBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFRoZSBmaXJzdCBlbGVtZW50IGluIHRoaXMgZHJhdyBjYWxsLiBUaGF0IGlzIHRoZSBmaXJzdAogICAqIHZlcnRleCBmb3Igbm9uLWluZGV4ZWQgZ2VvbWV0cnksIG90aGVyd2lzZSB0aGUgZmlyc3QgdHJpYW5nbGUgaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvdW50IC0gU3BlY2lmaWVzIGhvdyBtYW55IHZlcnRpY2VzIChvciBpbmRpY2VzKSBhcmUgcGFydCBvZiB0aGlzIGdyb3VwLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF0ZXJpYWxJbmRleD0wXSAtIFRoZSBtYXRlcmlhbCBhcnJheSBpbmRleCB0byB1c2UuCiAgICovCiAgYWRkR3JvdXAodCwgZSwgaSA9IDApIHsKICAgIHRoaXMuZ3JvdXBzLnB1c2goewogICAgICBzdGFydDogdCwKICAgICAgY291bnQ6IGUsCiAgICAgIG1hdGVyaWFsSW5kZXg6IGkKICAgIH0pOwogIH0KICAvKioKICAgKiBDbGVhcnMgYWxsIGdyb3Vwcy4KICAgKi8KICBjbGVhckdyb3VwcygpIHsKICAgIHRoaXMuZ3JvdXBzID0gW107CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGRyYXcgcmFuZ2UgZm9yIHRoaXMgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBUaGUgZmlyc3QgdmVydGV4IGZvciBub24taW5kZXhlZCBnZW9tZXRyeSwgb3RoZXJ3aXNlIHRoZSBmaXJzdCB0cmlhbmdsZSBpbmRleC4KICAgKiBAcGFyYW0ge251bWJlcn0gY291bnQgLSBGb3Igbm9uLWluZGV4ZWQgQnVmZmVyR2VvbWV0cnksIGBjb3VudGAgaXMgdGhlIG51bWJlciBvZiB2ZXJ0aWNlcyB0byByZW5kZXIuCiAgICogRm9yIGluZGV4ZWQgQnVmZmVyR2VvbWV0cnksIGBjb3VudGAgaXMgdGhlIG51bWJlciBvZiBpbmRpY2VzIHRvIHJlbmRlci4KICAgKi8KICBzZXREcmF3UmFuZ2UodCwgZSkgewogICAgdGhpcy5kcmF3UmFuZ2Uuc3RhcnQgPSB0LCB0aGlzLmRyYXdSYW5nZS5jb3VudCA9IGU7CiAgfQogIC8qKgogICAqIEFwcGxpZXMgdGhlIGdpdmVuIDR4NCB0cmFuc2Zvcm1hdGlvbiBtYXRyaXggdG8gdGhlIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtYXRyaXggLSBUaGUgbWF0cml4IHRvIGFwcGx5LgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIGFwcGx5TWF0cml4NCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgZSAhPT0gdm9pZCAwICYmIChlLmFwcGx5TWF0cml4NCh0KSwgZS5uZWVkc1VwZGF0ZSA9ICEwKTsKICAgIGNvbnN0IGkgPSB0aGlzLmF0dHJpYnV0ZXMubm9ybWFsOwogICAgaWYgKGkgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBzID0gbmV3IFh0KCkuZ2V0Tm9ybWFsTWF0cml4KHQpOwogICAgICBpLmFwcGx5Tm9ybWFsTWF0cml4KHMpLCBpLm5lZWRzVXBkYXRlID0gITA7CiAgICB9CiAgICBjb25zdCBuID0gdGhpcy5hdHRyaWJ1dGVzLnRhbmdlbnQ7CiAgICByZXR1cm4gbiAhPT0gdm9pZCAwICYmIChuLnRyYW5zZm9ybURpcmVjdGlvbih0KSwgbi5uZWVkc1VwZGF0ZSA9ICEwKSwgdGhpcy5ib3VuZGluZ0JveCAhPT0gbnVsbCAmJiB0aGlzLmNvbXB1dGVCb3VuZGluZ0JveCgpLCB0aGlzLmJvdW5kaW5nU3BoZXJlICE9PSBudWxsICYmIHRoaXMuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCksIHRoaXM7CiAgfQogIC8qKgogICAqIEFwcGxpZXMgdGhlIHJvdGF0aW9uIHJlcHJlc2VudGVkIGJ5IHRoZSBRdWF0ZXJuaW9uIHRvIHRoZSBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcSAtIFRoZSBRdWF0ZXJuaW9uIHRvIGFwcGx5LgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIGFwcGx5UXVhdGVybmlvbih0KSB7CiAgICByZXR1cm4gSGkubWFrZVJvdGF0aW9uRnJvbVF1YXRlcm5pb24odCksIHRoaXMuYXBwbHlNYXRyaXg0KEhpKSwgdGhpczsKICB9CiAgLyoqCiAgICogUm90YXRlcyB0aGUgZ2VvbWV0cnkgYWJvdXQgdGhlIFggYXhpcy4gVGhpcyBpcyB0eXBpY2FsbHkgZG9uZSBhcyBhIG9uZSB0aW1lCiAgICogb3BlcmF0aW9uLCBhbmQgbm90IGR1cmluZyBhIGxvb3AuIFVzZSB7QGxpbmsgT2JqZWN0M0Qjcm90YXRpb259IGZvciB0eXBpY2FsCiAgICogcmVhbC10aW1lIG1lc2ggcm90YXRpb24uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICByb3RhdGVYKHQpIHsKICAgIHJldHVybiBIaS5tYWtlUm90YXRpb25YKHQpLCB0aGlzLmFwcGx5TWF0cml4NChIaSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhlIGdlb21ldHJ5IGFib3V0IHRoZSBZIGF4aXMuIFRoaXMgaXMgdHlwaWNhbGx5IGRvbmUgYXMgYSBvbmUgdGltZQogICAqIG9wZXJhdGlvbiwgYW5kIG5vdCBkdXJpbmcgYSBsb29wLiBVc2Uge0BsaW5rIE9iamVjdDNEI3JvdGF0aW9ufSBmb3IgdHlwaWNhbAogICAqIHJlYWwtdGltZSBtZXNoIHJvdGF0aW9uLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7QnVmZmVyR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlWSh0KSB7CiAgICByZXR1cm4gSGkubWFrZVJvdGF0aW9uWSh0KSwgdGhpcy5hcHBseU1hdHJpeDQoSGkpLCB0aGlzOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSBnZW9tZXRyeSBhYm91dCB0aGUgWiBheGlzLiBUaGlzIGlzIHR5cGljYWxseSBkb25lIGFzIGEgb25lIHRpbWUKICAgKiBvcGVyYXRpb24sIGFuZCBub3QgZHVyaW5nIGEgbG9vcC4gVXNlIHtAbGluayBPYmplY3QzRCNyb3RhdGlvbn0gZm9yIHR5cGljYWwKICAgKiByZWFsLXRpbWUgbWVzaCByb3RhdGlvbi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHJvdGF0ZVoodCkgewogICAgcmV0dXJuIEhpLm1ha2VSb3RhdGlvbloodCksIHRoaXMuYXBwbHlNYXRyaXg0KEhpKSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlcyB0aGUgZ2VvbWV0cnkuIFRoaXMgaXMgdHlwaWNhbGx5IGRvbmUgYXMgYSBvbmUgdGltZQogICAqIG9wZXJhdGlvbiwgYW5kIG5vdCBkdXJpbmcgYSBsb29wLiBVc2Uge0BsaW5rIE9iamVjdDNEI3Bvc2l0aW9ufSBmb3IgdHlwaWNhbAogICAqIHJlYWwtdGltZSBtZXNoIHJvdGF0aW9uLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBvZmZzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBvZmZzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgeiBvZmZzZXQuCiAgICogQHJldHVybiB7QnVmZmVyR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgdHJhbnNsYXRlKHQsIGUsIGkpIHsKICAgIHJldHVybiBIaS5tYWtlVHJhbnNsYXRpb24odCwgZSwgaSksIHRoaXMuYXBwbHlNYXRyaXg0KEhpKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2NhbGVzIHRoZSBnZW9tZXRyeS4gVGhpcyBpcyB0eXBpY2FsbHkgZG9uZSBhcyBhIG9uZSB0aW1lCiAgICogb3BlcmF0aW9uLCBhbmQgbm90IGR1cmluZyBhIGxvb3AuIFVzZSB7QGxpbmsgT2JqZWN0M0Qjc2NhbGV9IGZvciB0eXBpY2FsCiAgICogcmVhbC10aW1lIG1lc2ggcm90YXRpb24uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IHNjYWxlLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgc2NhbGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgeiBzY2FsZS4KICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzY2FsZSh0LCBlLCBpKSB7CiAgICByZXR1cm4gSGkubWFrZVNjYWxlKHQsIGUsIGkpLCB0aGlzLmFwcGx5TWF0cml4NChIaSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhlIGdlb21ldHJ5IHRvIGZhY2UgYSBwb2ludCBpbiAzRCBzcGFjZS4gVGhpcyBpcyB0eXBpY2FsbHkgZG9uZSBhcyBhIG9uZSB0aW1lCiAgICogb3BlcmF0aW9uLCBhbmQgbm90IGR1cmluZyBhIGxvb3AuIFVzZSB7QGxpbmsgT2JqZWN0M0QjbG9va0F0fSBmb3IgdHlwaWNhbAogICAqIHJlYWwtdGltZSBtZXNoIHJvdGF0aW9uLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2ZWN0b3IgLSBUaGUgdGFyZ2V0IHBvaW50LgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIGxvb2tBdCh0KSB7CiAgICByZXR1cm4gVXUubG9va0F0KHQpLCBVdS51cGRhdGVNYXRyaXgoKSwgdGhpcy5hcHBseU1hdHJpeDQoVXUubWF0cml4KSwgdGhpczsKICB9CiAgLyoqCiAgICogQ2VudGVyIHRoZSBnZW9tZXRyeSBiYXNlZCBvbiBpdHMgYm91bmRpbmcgYm94LgogICAqCiAgICogQHJldHVybiB7QnVmZmVyR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2VudGVyKCkgewogICAgcmV0dXJuIHRoaXMuY29tcHV0ZUJvdW5kaW5nQm94KCksIHRoaXMuYm91bmRpbmdCb3guZ2V0Q2VudGVyKFJyKS5uZWdhdGUoKSwgdGhpcy50cmFuc2xhdGUoUnIueCwgUnIueSwgUnIueiksIHRoaXM7CiAgfQogIC8qKgogICAqIERlZmluZXMgYSBnZW9tZXRyeSBieSBjcmVhdGluZyBhIGBwb3NpdGlvbmAgYXR0cmlidXRlIGJhc2VkIG9uIHRoZSBnaXZlbiBhcnJheSBvZiBwb2ludHMuIFRoZSBhcnJheQogICAqIGNhbiBob2xkIDJEIG9yIDNEIHZlY3RvcnMuIFdoZW4gdXNpbmcgdHdvLWRpbWVuc2lvbmFsIGRhdGEsIHRoZSBgemAgY29vcmRpbmF0ZSBmb3IgYWxsIHZlcnRpY2VzIGlzCiAgICogc2V0IHRvIGAwYC4KICAgKgogICAqIElmIHRoZSBtZXRob2QgaXMgdXNlZCB3aXRoIGFuIGV4aXN0aW5nIGBwb3NpdGlvbmAgYXR0cmlidXRlLCB0aGUgdmVydGV4IGRhdGEgYXJlIG92ZXJ3cml0dGVuIHdpdGggdGhlCiAgICogZGF0YSBmcm9tIHRoZSBhcnJheS4gVGhlIGxlbmd0aCBvZiB0aGUgYXJyYXkgbXVzdCBtYXRjaCB0aGUgdmVydGV4IGNvdW50LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxWZWN0b3IyPnxBcnJheTxWZWN0b3IzPn0gcG9pbnRzIC0gVGhlIHBvaW50cy4KICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRGcm9tUG9pbnRzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKTsKICAgIGlmIChlID09PSB2b2lkIDApIHsKICAgICAgY29uc3QgaSA9IFtdOwogICAgICBmb3IgKGxldCBuID0gMCwgcyA9IHQubGVuZ3RoOyBuIDwgczsgbisrKSB7CiAgICAgICAgY29uc3QgciA9IHRbbl07CiAgICAgICAgaS5wdXNoKHIueCwgci55LCByLnogfHwgMCk7CiAgICAgIH0KICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KGksIDMpKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGkgPSBNYXRoLm1pbih0Lmxlbmd0aCwgZS5jb3VudCk7CiAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgaTsgbisrKSB7CiAgICAgICAgY29uc3QgcyA9IHRbbl07CiAgICAgICAgZS5zZXRYWVoobiwgcy54LCBzLnksIHMueiB8fCAwKTsKICAgICAgfQogICAgICB0Lmxlbmd0aCA+IGUuY291bnQgJiYgY29uc29sZS53YXJuKCJUSFJFRS5CdWZmZXJHZW9tZXRyeTogQnVmZmVyIHNpemUgdG9vIHNtYWxsIGZvciBwb2ludHMgZGF0YS4gVXNlIC5kaXNwb3NlKCkgYW5kIGNyZWF0ZSBhIG5ldyBnZW9tZXRyeS4iKSwgZS5uZWVkc1VwZGF0ZSA9ICEwOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBib3VuZGluZyBib3ggb2YgdGhlIGdlb21ldHJ5LCBhbmQgdXBkYXRlcyB0aGUgYGJvdW5kaW5nQm94YCBtZW1iZXIuCiAgICogVGhlIGJvdW5kaW5nIGJveCBpcyBub3QgY29tcHV0ZWQgYnkgdGhlIGVuZ2luZTsgaXQgbXVzdCBiZSBjb21wdXRlZCBieSB5b3VyIGFwcC4KICAgKiBZb3UgbWF5IG5lZWQgdG8gcmVjb21wdXRlIHRoZSBib3VuZGluZyBib3ggaWYgdGhlIGdlb21ldHJ5IHZlcnRpY2VzIGFyZSBtb2RpZmllZC4KICAgKi8KICBjb21wdXRlQm91bmRpbmdCb3goKSB7CiAgICB0aGlzLmJvdW5kaW5nQm94ID09PSBudWxsICYmICh0aGlzLmJvdW5kaW5nQm94ID0gbmV3IHdlKCkpOwogICAgY29uc3QgdCA9IHRoaXMuYXR0cmlidXRlcy5wb3NpdGlvbiwgZSA9IHRoaXMubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgaWYgKHQgJiYgdC5pc0dMQnVmZmVyQXR0cmlidXRlKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLkJ1ZmZlckdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ0JveCgpOiBHTEJ1ZmZlckF0dHJpYnV0ZSByZXF1aXJlcyBhIG1hbnVhbCBib3VuZGluZyBib3guIiwgdGhpcyksIHRoaXMuYm91bmRpbmdCb3guc2V0KAogICAgICAgIG5ldyBFKC0xIC8gMCwgLTEgLyAwLCAtMSAvIDApLAogICAgICAgIG5ldyBFKDEgLyAwLCAxIC8gMCwgMSAvIDApCiAgICAgICk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0ICE9PSB2b2lkIDApIHsKICAgICAgaWYgKHRoaXMuYm91bmRpbmdCb3guc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZSh0KSwgZSkKICAgICAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBzID0gZVtpXTsKICAgICAgICAgIElpLnNldEZyb21CdWZmZXJBdHRyaWJ1dGUocyksIHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmUgPyAoT2UuYWRkVmVjdG9ycyh0aGlzLmJvdW5kaW5nQm94Lm1pbiwgSWkubWluKSwgdGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KE9lKSwgT2UuYWRkVmVjdG9ycyh0aGlzLmJvdW5kaW5nQm94Lm1heCwgSWkubWF4KSwgdGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KE9lKSkgOiAodGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KElpLm1pbiksIHRoaXMuYm91bmRpbmdCb3guZXhwYW5kQnlQb2ludChJaS5tYXgpKTsKICAgICAgICB9CiAgICB9IGVsc2UKICAgICAgdGhpcy5ib3VuZGluZ0JveC5tYWtlRW1wdHkoKTsKICAgIChpc05hTih0aGlzLmJvdW5kaW5nQm94Lm1pbi54KSB8fCBpc05hTih0aGlzLmJvdW5kaW5nQm94Lm1pbi55KSB8fCBpc05hTih0aGlzLmJvdW5kaW5nQm94Lm1pbi56KSkgJiYgY29uc29sZS5lcnJvcignVEhSRUUuQnVmZmVyR2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCk6IENvbXB1dGVkIG1pbi9tYXggaGF2ZSBOYU4gdmFsdWVzLiBUaGUgInBvc2l0aW9uIiBhdHRyaWJ1dGUgaXMgbGlrZWx5IHRvIGhhdmUgTmFOIHZhbHVlcy4nLCB0aGlzKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIHNwaGVyZSBvZiB0aGUgZ2VvbWV0cnksIGFuZCB1cGRhdGVzIHRoZSBgYm91bmRpbmdTcGhlcmVgIG1lbWJlci4KICAgKiBUaGUgZW5naW5lIGF1dG9tYXRpY2FsbHkgY29tcHV0ZXMgdGhlIGJvdW5kaW5nIHNwaGVyZSB3aGVuIGl0IGlzIG5lZWRlZCwgZS5nLiwgZm9yIHJheSBjYXN0aW5nIG9yIHZpZXcgZnJ1c3R1bSBjdWxsaW5nLgogICAqIFlvdSBtYXkgbmVlZCB0byByZWNvbXB1dGUgdGhlIGJvdW5kaW5nIHNwaGVyZSBpZiB0aGUgZ2VvbWV0cnkgdmVydGljZXMgYXJlIG1vZGlmaWVkLgogICAqLwogIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpIHsKICAgIHRoaXMuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdTcGhlcmUgPSBuZXcgUmUoKSk7CiAgICBjb25zdCB0ID0gdGhpcy5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBlID0gdGhpcy5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb247CiAgICBpZiAodCAmJiB0LmlzR0xCdWZmZXJBdHRyaWJ1dGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuQnVmZmVyR2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk6IEdMQnVmZmVyQXR0cmlidXRlIHJlcXVpcmVzIGEgbWFudWFsIGJvdW5kaW5nIHNwaGVyZS4iLCB0aGlzKSwgdGhpcy5ib3VuZGluZ1NwaGVyZS5zZXQobmV3IEUoKSwgMSAvIDApOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodCkgewogICAgICBjb25zdCBpID0gdGhpcy5ib3VuZGluZ1NwaGVyZS5jZW50ZXI7CiAgICAgIGlmIChJaS5zZXRGcm9tQnVmZmVyQXR0cmlidXRlKHQpLCBlKQogICAgICAgIGZvciAobGV0IHMgPSAwLCByID0gZS5sZW5ndGg7IHMgPCByOyBzKyspIHsKICAgICAgICAgIGNvbnN0IG8gPSBlW3NdOwogICAgICAgICAgT2Euc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZShvKSwgdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSA/IChPZS5hZGRWZWN0b3JzKElpLm1pbiwgT2EubWluKSwgSWkuZXhwYW5kQnlQb2ludChPZSksIE9lLmFkZFZlY3RvcnMoSWkubWF4LCBPYS5tYXgpLCBJaS5leHBhbmRCeVBvaW50KE9lKSkgOiAoSWkuZXhwYW5kQnlQb2ludChPYS5taW4pLCBJaS5leHBhbmRCeVBvaW50KE9hLm1heCkpOwogICAgICAgIH0KICAgICAgSWkuZ2V0Q2VudGVyKGkpOwogICAgICBsZXQgbiA9IDA7CiAgICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5jb3VudDsgcyA8IHI7IHMrKykKICAgICAgICBPZS5mcm9tQnVmZmVyQXR0cmlidXRlKHQsIHMpLCBuID0gTWF0aC5tYXgobiwgaS5kaXN0YW5jZVRvU3F1YXJlZChPZSkpOwogICAgICBpZiAoZSkKICAgICAgICBmb3IgKGxldCBzID0gMCwgciA9IGUubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgICAgICBjb25zdCBvID0gZVtzXSwgbCA9IHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmU7CiAgICAgICAgICBmb3IgKGxldCBoID0gMCwgYyA9IG8uY291bnQ7IGggPCBjOyBoKyspCiAgICAgICAgICAgIE9lLmZyb21CdWZmZXJBdHRyaWJ1dGUobywgaCksIGwgJiYgKFJyLmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgaCksIE9lLmFkZChScikpLCBuID0gTWF0aC5tYXgobiwgaS5kaXN0YW5jZVRvU3F1YXJlZChPZSkpOwogICAgICAgIH0KICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBNYXRoLnNxcnQobiksIGlzTmFOKHRoaXMuYm91bmRpbmdTcGhlcmUucmFkaXVzKSAmJiBjb25zb2xlLmVycm9yKCdUSFJFRS5CdWZmZXJHZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTogQ29tcHV0ZWQgcmFkaXVzIGlzIE5hTi4gVGhlICJwb3NpdGlvbiIgYXR0cmlidXRlIGlzIGxpa2VseSB0byBoYXZlIE5hTiB2YWx1ZXMuJywgdGhpcyk7CiAgICB9CiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgYW5kIGFkZHMgYSB0YW5nZW50IGF0dHJpYnV0ZSB0byB0aGlzIGdlb21ldHJ5LgogICAqCiAgICogVGhlIGNvbXB1dGF0aW9uIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBpbmRleGVkIGdlb21ldHJpZXMgYW5kIGlmIHBvc2l0aW9uLCBub3JtYWwsIGFuZCB1diBhdHRyaWJ1dGVzCiAgICogYXJlIGRlZmluZWQuIFdoZW4gdXNpbmcgYSB0YW5nZW50IHNwYWNlIG5vcm1hbCBtYXAsIHByZWZlciB0aGUgTWlra1RTcGFjZSBhbGdvcml0aG0gcHJvdmlkZWQgYnkKICAgKiB7QGxpbmsgQnVmZmVyR2VvbWV0cnlVdGlscyNjb21wdXRlTWlra1RTcGFjZVRhbmdlbnRzfSBpbnN0ZWFkLgogICAqLwogIGNvbXB1dGVUYW5nZW50cygpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmluZGV4LCBlID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgaWYgKHQgPT09IG51bGwgfHwgZS5wb3NpdGlvbiA9PT0gdm9pZCAwIHx8IGUubm9ybWFsID09PSB2b2lkIDAgfHwgZS51diA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLkJ1ZmZlckdlb21ldHJ5OiAuY29tcHV0ZVRhbmdlbnRzKCkgZmFpbGVkLiBNaXNzaW5nIHJlcXVpcmVkIGF0dHJpYnV0ZXMgKGluZGV4LCBwb3NpdGlvbiwgbm9ybWFsIG9yIHV2KSIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpID0gZS5wb3NpdGlvbiwgbiA9IGUubm9ybWFsLCBzID0gZS51djsKICAgIHRoaXMuaGFzQXR0cmlidXRlKCJ0YW5nZW50IikgPT09ICExICYmIHRoaXMuc2V0QXR0cmlidXRlKCJ0YW5nZW50IiwgbmV3IGllKG5ldyBGbG9hdDMyQXJyYXkoNCAqIGkuY291bnQpLCA0KSk7CiAgICBjb25zdCByID0gdGhpcy5nZXRBdHRyaWJ1dGUoInRhbmdlbnQiKSwgbyA9IFtdLCBsID0gW107CiAgICBmb3IgKGxldCBSID0gMDsgUiA8IGkuY291bnQ7IFIrKykKICAgICAgb1tSXSA9IG5ldyBFKCksIGxbUl0gPSBuZXcgRSgpOwogICAgY29uc3QgaCA9IG5ldyBFKCksIGMgPSBuZXcgRSgpLCB1ID0gbmV3IEUoKSwgZCA9IG5ldyBKKCksIHAgPSBuZXcgSigpLCBmID0gbmV3IEooKSwgeSA9IG5ldyBFKCksIGcgPSBuZXcgRSgpOwogICAgZnVuY3Rpb24gbShSLCBiLCBNKSB7CiAgICAgIGguZnJvbUJ1ZmZlckF0dHJpYnV0ZShpLCBSKSwgYy5mcm9tQnVmZmVyQXR0cmlidXRlKGksIGIpLCB1LmZyb21CdWZmZXJBdHRyaWJ1dGUoaSwgTSksIGQuZnJvbUJ1ZmZlckF0dHJpYnV0ZShzLCBSKSwgcC5mcm9tQnVmZmVyQXR0cmlidXRlKHMsIGIpLCBmLmZyb21CdWZmZXJBdHRyaWJ1dGUocywgTSksIGMuc3ViKGgpLCB1LnN1YihoKSwgcC5zdWIoZCksIGYuc3ViKGQpOwogICAgICBjb25zdCBMID0gMSAvIChwLnggKiBmLnkgLSBmLnggKiBwLnkpOwogICAgICBpc0Zpbml0ZShMKSAmJiAoeS5jb3B5KGMpLm11bHRpcGx5U2NhbGFyKGYueSkuYWRkU2NhbGVkVmVjdG9yKHUsIC1wLnkpLm11bHRpcGx5U2NhbGFyKEwpLCBnLmNvcHkodSkubXVsdGlwbHlTY2FsYXIocC54KS5hZGRTY2FsZWRWZWN0b3IoYywgLWYueCkubXVsdGlwbHlTY2FsYXIoTCksIG9bUl0uYWRkKHkpLCBvW2JdLmFkZCh5KSwgb1tNXS5hZGQoeSksIGxbUl0uYWRkKGcpLCBsW2JdLmFkZChnKSwgbFtNXS5hZGQoZykpOwogICAgfQogICAgbGV0IHYgPSB0aGlzLmdyb3VwczsKICAgIHYubGVuZ3RoID09PSAwICYmICh2ID0gW3sKICAgICAgc3RhcnQ6IDAsCiAgICAgIGNvdW50OiB0LmNvdW50CiAgICB9XSk7CiAgICBmb3IgKGxldCBSID0gMCwgYiA9IHYubGVuZ3RoOyBSIDwgYjsgKytSKSB7CiAgICAgIGNvbnN0IE0gPSB2W1JdLCBMID0gTS5zdGFydCwgVSA9IE0uY291bnQ7CiAgICAgIGZvciAobGV0IE8gPSBMLCBWID0gTCArIFU7IE8gPCBWOyBPICs9IDMpCiAgICAgICAgbSgKICAgICAgICAgIHQuZ2V0WChPICsgMCksCiAgICAgICAgICB0LmdldFgoTyArIDEpLAogICAgICAgICAgdC5nZXRYKE8gKyAyKQogICAgICAgICk7CiAgICB9CiAgICBjb25zdCB4ID0gbmV3IEUoKSwgXyA9IG5ldyBFKCksIFMgPSBuZXcgRSgpLCB3ID0gbmV3IEUoKTsKICAgIGZ1bmN0aW9uIFQoUikgewogICAgICBTLmZyb21CdWZmZXJBdHRyaWJ1dGUobiwgUiksIHcuY29weShTKTsKICAgICAgY29uc3QgYiA9IG9bUl07CiAgICAgIHguY29weShiKSwgeC5zdWIoUy5tdWx0aXBseVNjYWxhcihTLmRvdChiKSkpLm5vcm1hbGl6ZSgpLCBfLmNyb3NzVmVjdG9ycyh3LCBiKTsKICAgICAgY29uc3QgTCA9IF8uZG90KGxbUl0pIDwgMCA/IC0xIDogMTsKICAgICAgci5zZXRYWVpXKFIsIHgueCwgeC55LCB4LnosIEwpOwogICAgfQogICAgZm9yIChsZXQgUiA9IDAsIGIgPSB2Lmxlbmd0aDsgUiA8IGI7ICsrUikgewogICAgICBjb25zdCBNID0gdltSXSwgTCA9IE0uc3RhcnQsIFUgPSBNLmNvdW50OwogICAgICBmb3IgKGxldCBPID0gTCwgViA9IEwgKyBVOyBPIDwgVjsgTyArPSAzKQogICAgICAgIFQodC5nZXRYKE8gKyAwKSksIFQodC5nZXRYKE8gKyAxKSksIFQodC5nZXRYKE8gKyAyKSk7CiAgICB9CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHZlcnRleCBub3JtYWxzIGZvciB0aGUgZ2l2ZW4gdmVydGV4IGRhdGEuIEZvciBpbmRleGVkIGdlb21ldHJpZXMsIHRoZSBtZXRob2Qgc2V0cwogICAqIGVhY2ggdmVydGV4IG5vcm1hbCB0byBiZSB0aGUgYXZlcmFnZSBvZiB0aGUgZmFjZSBub3JtYWxzIG9mIHRoZSBmYWNlcyB0aGF0IHNoYXJlIHRoYXQgdmVydGV4LgogICAqIEZvciBub24taW5kZXhlZCBnZW9tZXRyaWVzLCB2ZXJ0aWNlcyBhcmUgbm90IHNoYXJlZCwgYW5kIHRoZSBtZXRob2Qgc2V0cyBlYWNoIHZlcnRleCBub3JtYWwKICAgKiB0byBiZSB0aGUgc2FtZSBhcyB0aGUgZmFjZSBub3JtYWwuCiAgICovCiAgY29tcHV0ZVZlcnRleE5vcm1hbHMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5pbmRleCwgZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpOwogICAgaWYgKGUgIT09IHZvaWQgMCkgewogICAgICBsZXQgaSA9IHRoaXMuZ2V0QXR0cmlidXRlKCJub3JtYWwiKTsKICAgICAgaWYgKGkgPT09IHZvaWQgMCkKICAgICAgICBpID0gbmV3IGllKG5ldyBGbG9hdDMyQXJyYXkoZS5jb3VudCAqIDMpLCAzKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIGkpOwogICAgICBlbHNlCiAgICAgICAgZm9yIChsZXQgZCA9IDAsIHAgPSBpLmNvdW50OyBkIDwgcDsgZCsrKQogICAgICAgICAgaS5zZXRYWVooZCwgMCwgMCwgMCk7CiAgICAgIGNvbnN0IG4gPSBuZXcgRSgpLCBzID0gbmV3IEUoKSwgciA9IG5ldyBFKCksIG8gPSBuZXcgRSgpLCBsID0gbmV3IEUoKSwgaCA9IG5ldyBFKCksIGMgPSBuZXcgRSgpLCB1ID0gbmV3IEUoKTsKICAgICAgaWYgKHQpCiAgICAgICAgZm9yIChsZXQgZCA9IDAsIHAgPSB0LmNvdW50OyBkIDwgcDsgZCArPSAzKSB7CiAgICAgICAgICBjb25zdCBmID0gdC5nZXRYKGQgKyAwKSwgeSA9IHQuZ2V0WChkICsgMSksIGcgPSB0LmdldFgoZCArIDIpOwogICAgICAgICAgbi5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIGYpLCBzLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgeSksIHIuZnJvbUJ1ZmZlckF0dHJpYnV0ZShlLCBnKSwgYy5zdWJWZWN0b3JzKHIsIHMpLCB1LnN1YlZlY3RvcnMobiwgcyksIGMuY3Jvc3ModSksIG8uZnJvbUJ1ZmZlckF0dHJpYnV0ZShpLCBmKSwgbC5mcm9tQnVmZmVyQXR0cmlidXRlKGksIHkpLCBoLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSwgZyksIG8uYWRkKGMpLCBsLmFkZChjKSwgaC5hZGQoYyksIGkuc2V0WFlaKGYsIG8ueCwgby55LCBvLnopLCBpLnNldFhZWih5LCBsLngsIGwueSwgbC56KSwgaS5zZXRYWVooZywgaC54LCBoLnksIGgueik7CiAgICAgICAgfQogICAgICBlbHNlCiAgICAgICAgZm9yIChsZXQgZCA9IDAsIHAgPSBlLmNvdW50OyBkIDwgcDsgZCArPSAzKQogICAgICAgICAgbi5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIGQgKyAwKSwgcy5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIGQgKyAxKSwgci5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIGQgKyAyKSwgYy5zdWJWZWN0b3JzKHIsIHMpLCB1LnN1YlZlY3RvcnMobiwgcyksIGMuY3Jvc3ModSksIGkuc2V0WFlaKGQgKyAwLCBjLngsIGMueSwgYy56KSwgaS5zZXRYWVooZCArIDEsIGMueCwgYy55LCBjLnopLCBpLnNldFhZWihkICsgMiwgYy54LCBjLnksIGMueik7CiAgICAgIHRoaXMubm9ybWFsaXplTm9ybWFscygpLCBpLm5lZWRzVXBkYXRlID0gITA7CiAgICB9CiAgfQogIC8qKgogICAqIEVuc3VyZXMgZXZlcnkgbm9ybWFsIHZlY3RvciBpbiBhIGdlb21ldHJ5IHdpbGwgaGF2ZSBhIG1hZ25pdHVkZSBvZiBgMWAuIFRoaXMgd2lsbAogICAqIGNvcnJlY3QgbGlnaHRpbmcgb24gdGhlIGdlb21ldHJ5IHN1cmZhY2VzLgogICAqLwogIG5vcm1hbGl6ZU5vcm1hbHMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5hdHRyaWJ1dGVzLm5vcm1hbDsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgT2UuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSwgT2Uubm9ybWFsaXplKCksIHQuc2V0WFlaKGUsIE9lLngsIE9lLnksIE9lLnopOwogIH0KICAvKioKICAgKiBSZXR1cm4gYSBuZXcgbm9uLWluZGV4IHZlcnNpb24gb2YgdGhpcyBpbmRleGVkIGdlb21ldHJ5LiBJZiB0aGUgZ2VvbWV0cnkKICAgKiBpcyBhbHJlYWR5IG5vbi1pbmRleGVkLCB0aGUgbWV0aG9kIGlzIGEgTk9PUC4KICAgKgogICAqIEByZXR1cm4ge0J1ZmZlckdlb21ldHJ5fSBUaGUgbm9uLWluZGV4ZWQgdmVyc2lvbiBvZiB0aGlzIGluZGV4ZWQgZ2VvbWV0cnkuCiAgICovCiAgdG9Ob25JbmRleGVkKCkgewogICAgZnVuY3Rpb24gdChvLCBsKSB7CiAgICAgIGNvbnN0IGggPSBvLmFycmF5LCBjID0gby5pdGVtU2l6ZSwgdSA9IG8ubm9ybWFsaXplZCwgZCA9IG5ldyBoLmNvbnN0cnVjdG9yKGwubGVuZ3RoICogYyk7CiAgICAgIGxldCBwID0gMCwgZiA9IDA7CiAgICAgIGZvciAobGV0IHkgPSAwLCBnID0gbC5sZW5ndGg7IHkgPCBnOyB5KyspIHsKICAgICAgICBvLmlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUgPyBwID0gbFt5XSAqIG8uZGF0YS5zdHJpZGUgKyBvLm9mZnNldCA6IHAgPSBsW3ldICogYzsKICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGM7IG0rKykKICAgICAgICAgIGRbZisrXSA9IGhbcCsrXTsKICAgICAgfQogICAgICByZXR1cm4gbmV3IGllKGQsIGMsIHUpOwogICAgfQogICAgaWYgKHRoaXMuaW5kZXggPT09IG51bGwpCiAgICAgIHJldHVybiBjb25zb2xlLndhcm4oIlRIUkVFLkJ1ZmZlckdlb21ldHJ5LnRvTm9uSW5kZXhlZCgpOiBCdWZmZXJHZW9tZXRyeSBpcyBhbHJlYWR5IG5vbi1pbmRleGVkLiIpLCB0aGlzOwogICAgY29uc3QgZSA9IG5ldyBTeSgpLCBpID0gdGhpcy5pbmRleC5hcnJheSwgbiA9IHRoaXMuYXR0cmlidXRlczsKICAgIGZvciAoY29uc3QgbyBpbiBuKSB7CiAgICAgIGNvbnN0IGwgPSBuW29dLCBoID0gdChsLCBpKTsKICAgICAgZS5zZXRBdHRyaWJ1dGUobywgaCk7CiAgICB9CiAgICBjb25zdCBzID0gdGhpcy5tb3JwaEF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IG8gaW4gcykgewogICAgICBjb25zdCBsID0gW10sIGggPSBzW29dOwogICAgICBmb3IgKGxldCBjID0gMCwgdSA9IGgubGVuZ3RoOyBjIDwgdTsgYysrKSB7CiAgICAgICAgY29uc3QgZCA9IGhbY10sIHAgPSB0KGQsIGkpOwogICAgICAgIGwucHVzaChwKTsKICAgICAgfQogICAgICBlLm1vcnBoQXR0cmlidXRlc1tvXSA9IGw7CiAgICB9CiAgICBlLm1vcnBoVGFyZ2V0c1JlbGF0aXZlID0gdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZTsKICAgIGNvbnN0IHIgPSB0aGlzLmdyb3VwczsKICAgIGZvciAobGV0IG8gPSAwLCBsID0gci5sZW5ndGg7IG8gPCBsOyBvKyspIHsKICAgICAgY29uc3QgaCA9IHJbb107CiAgICAgIGUuYWRkR3JvdXAoaC5zdGFydCwgaC5jb3VudCwgaC5tYXRlcmlhbEluZGV4KTsKICAgIH0KICAgIHJldHVybiBlOwogIH0KICAvKioKICAgKiBTZXJpYWxpemVzIHRoZSBnZW9tZXRyeSBpbnRvIEpTT04uCiAgICoKICAgKiBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqLwogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSB7CiAgICAgIG1ldGFkYXRhOiB7CiAgICAgICAgdmVyc2lvbjogNC43LAogICAgICAgIHR5cGU6ICJCdWZmZXJHZW9tZXRyeSIsCiAgICAgICAgZ2VuZXJhdG9yOiAiQnVmZmVyR2VvbWV0cnkudG9KU09OIgogICAgICB9CiAgICB9OwogICAgaWYgKHQudXVpZCA9IHRoaXMudXVpZCwgdC50eXBlID0gdGhpcy50eXBlLCB0aGlzLm5hbWUgIT09ICIiICYmICh0Lm5hbWUgPSB0aGlzLm5hbWUpLCBPYmplY3Qua2V5cyh0aGlzLnVzZXJEYXRhKS5sZW5ndGggPiAwICYmICh0LnVzZXJEYXRhID0gdGhpcy51c2VyRGF0YSksIHRoaXMucGFyYW1ldGVycyAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLnBhcmFtZXRlcnM7CiAgICAgIGZvciAoY29uc3QgaCBpbiBsKQogICAgICAgIGxbaF0gIT09IHZvaWQgMCAmJiAodFtoXSA9IGxbaF0pOwogICAgICByZXR1cm4gdDsKICAgIH0KICAgIHQuZGF0YSA9IHsgYXR0cmlidXRlczoge30gfTsKICAgIGNvbnN0IGUgPSB0aGlzLmluZGV4OwogICAgZSAhPT0gbnVsbCAmJiAodC5kYXRhLmluZGV4ID0gewogICAgICB0eXBlOiBlLmFycmF5LmNvbnN0cnVjdG9yLm5hbWUsCiAgICAgIGFycmF5OiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlLmFycmF5KQogICAgfSk7CiAgICBjb25zdCBpID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgZm9yIChjb25zdCBsIGluIGkpIHsKICAgICAgY29uc3QgaCA9IGlbbF07CiAgICAgIHQuZGF0YS5hdHRyaWJ1dGVzW2xdID0gaC50b0pTT04odC5kYXRhKTsKICAgIH0KICAgIGNvbnN0IG4gPSB7fTsKICAgIGxldCBzID0gITE7CiAgICBmb3IgKGNvbnN0IGwgaW4gdGhpcy5tb3JwaEF0dHJpYnV0ZXMpIHsKICAgICAgY29uc3QgaCA9IHRoaXMubW9ycGhBdHRyaWJ1dGVzW2xdLCBjID0gW107CiAgICAgIGZvciAobGV0IHUgPSAwLCBkID0gaC5sZW5ndGg7IHUgPCBkOyB1KyspIHsKICAgICAgICBjb25zdCBwID0gaFt1XTsKICAgICAgICBjLnB1c2gocC50b0pTT04odC5kYXRhKSk7CiAgICAgIH0KICAgICAgYy5sZW5ndGggPiAwICYmIChuW2xdID0gYywgcyA9ICEwKTsKICAgIH0KICAgIHMgJiYgKHQuZGF0YS5tb3JwaEF0dHJpYnV0ZXMgPSBuLCB0LmRhdGEubW9ycGhUYXJnZXRzUmVsYXRpdmUgPSB0aGlzLm1vcnBoVGFyZ2V0c1JlbGF0aXZlKTsKICAgIGNvbnN0IHIgPSB0aGlzLmdyb3VwczsKICAgIHIubGVuZ3RoID4gMCAmJiAodC5kYXRhLmdyb3VwcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocikpKTsKICAgIGNvbnN0IG8gPSB0aGlzLmJvdW5kaW5nU3BoZXJlOwogICAgcmV0dXJuIG8gIT09IG51bGwgJiYgKHQuZGF0YS5ib3VuZGluZ1NwaGVyZSA9IG8udG9KU09OKCkpLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IGdlb21ldHJ5IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIGdlb21ldHJ5IHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckdlb21ldHJ5fSBzb3VyY2UgLSBUaGUgZ2VvbWV0cnkgdG8gY29weS4KICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQpIHsKICAgIHRoaXMuaW5kZXggPSBudWxsLCB0aGlzLmF0dHJpYnV0ZXMgPSB7fSwgdGhpcy5tb3JwaEF0dHJpYnV0ZXMgPSB7fSwgdGhpcy5ncm91cHMgPSBbXSwgdGhpcy5ib3VuZGluZ0JveCA9IG51bGwsIHRoaXMuYm91bmRpbmdTcGhlcmUgPSBudWxsOwogICAgY29uc3QgZSA9IHt9OwogICAgdGhpcy5uYW1lID0gdC5uYW1lOwogICAgY29uc3QgaSA9IHQuaW5kZXg7CiAgICBpICE9PSBudWxsICYmIHRoaXMuc2V0SW5kZXgoaS5jbG9uZSgpKTsKICAgIGNvbnN0IG4gPSB0LmF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IGggaW4gbikgewogICAgICBjb25zdCBjID0gbltoXTsKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoaCwgYy5jbG9uZShlKSk7CiAgICB9CiAgICBjb25zdCBzID0gdC5tb3JwaEF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IGggaW4gcykgewogICAgICBjb25zdCBjID0gW10sIHUgPSBzW2hdOwogICAgICBmb3IgKGxldCBkID0gMCwgcCA9IHUubGVuZ3RoOyBkIDwgcDsgZCsrKQogICAgICAgIGMucHVzaCh1W2RdLmNsb25lKGUpKTsKICAgICAgdGhpcy5tb3JwaEF0dHJpYnV0ZXNbaF0gPSBjOwogICAgfQogICAgdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9IHQubW9ycGhUYXJnZXRzUmVsYXRpdmU7CiAgICBjb25zdCByID0gdC5ncm91cHM7CiAgICBmb3IgKGxldCBoID0gMCwgYyA9IHIubGVuZ3RoOyBoIDwgYzsgaCsrKSB7CiAgICAgIGNvbnN0IHUgPSByW2hdOwogICAgICB0aGlzLmFkZEdyb3VwKHUuc3RhcnQsIHUuY291bnQsIHUubWF0ZXJpYWxJbmRleCk7CiAgICB9CiAgICBjb25zdCBvID0gdC5ib3VuZGluZ0JveDsKICAgIG8gIT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdCb3ggPSBvLmNsb25lKCkpOwogICAgY29uc3QgbCA9IHQuYm91bmRpbmdTcGhlcmU7CiAgICByZXR1cm4gbCAhPT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ1NwaGVyZSA9IGwuY2xvbmUoKSksIHRoaXMuZHJhd1JhbmdlLnN0YXJ0ID0gdC5kcmF3UmFuZ2Uuc3RhcnQsIHRoaXMuZHJhd1JhbmdlLmNvdW50ID0gdC5kcmF3UmFuZ2UuY291bnQsIHRoaXMudXNlckRhdGEgPSB0LnVzZXJEYXRhLCB0aGlzOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKgogICAqIEBmaXJlcyBCdWZmZXJHZW9tZXRyeSNkaXNwb3NlCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZGlzcGF0Y2hFdmVudCh7IHR5cGU6ICJkaXNwb3NlIiB9KTsKICB9Cn07CmNvbnN0IEdmID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpLCBrcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWEoKSwgc2wgPSAvKiBAX19QVVJFX18gKi8gbmV3IFJlKCksIFdmID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIHJsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIGFsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIG9sID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIEJ1ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIGxsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIHFmID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIGhsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmxldCByZSA9IGNsYXNzIGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbWVzaC4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IFtnZW9tZXRyeV0gLSBUaGUgbWVzaCBnZW9tZXRyeS4KICAgKiBAcGFyYW0ge01hdGVyaWFsfEFycmF5PE1hdGVyaWFsPn0gW21hdGVyaWFsXSAtIFRoZSBtZXNoIG1hdGVyaWFsLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgSHQoKSwgZSA9IG5ldyBsaSgpKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaCA9ICEwLCB0aGlzLnR5cGUgPSAiTWVzaCIsIHRoaXMuZ2VvbWV0cnkgPSB0LCB0aGlzLm1hdGVyaWFsID0gZSwgdGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnkgPSB2b2lkIDAsIHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzID0gdm9pZCAwLCB0aGlzLmNvdW50ID0gMSwgdGhpcy51cGRhdGVNb3JwaFRhcmdldHMoKTsKICB9CiAgY29weSh0LCBlKSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0LCBlKSwgdC5tb3JwaFRhcmdldEluZmx1ZW5jZXMgIT09IHZvaWQgMCAmJiAodGhpcy5tb3JwaFRhcmdldEluZmx1ZW5jZXMgPSB0Lm1vcnBoVGFyZ2V0SW5mbHVlbmNlcy5zbGljZSgpKSwgdC5tb3JwaFRhcmdldERpY3Rpb25hcnkgIT09IHZvaWQgMCAmJiAodGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnkgPSBPYmplY3QuYXNzaWduKHt9LCB0Lm1vcnBoVGFyZ2V0RGljdGlvbmFyeSkpLCB0aGlzLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheSh0Lm1hdGVyaWFsKSA/IHQubWF0ZXJpYWwuc2xpY2UoKSA6IHQubWF0ZXJpYWwsIHRoaXMuZ2VvbWV0cnkgPSB0Lmdlb21ldHJ5LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2YWx1ZXMgb2Yge0BsaW5rIE1lc2gjbW9ycGhUYXJnZXREaWN0aW9uYXJ5fSBhbmQge0BsaW5rIE1lc2gjbW9ycGhUYXJnZXRJbmZsdWVuY2VzfQogICAqIHRvIG1ha2Ugc3VyZSBleGlzdGluZyBtb3JwaCB0YXJnZXRzIGNhbiBpbmZsdWVuY2UgdGhpcyAzRCBvYmplY3QuCiAgICovCiAgdXBkYXRlTW9ycGhUYXJnZXRzKCkgewogICAgY29uc3QgZSA9IHRoaXMuZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLCBpID0gT2JqZWN0LmtleXMoZSk7CiAgICBpZiAoaS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG4gPSBlW2lbMF1dOwogICAgICBpZiAobiAhPT0gdm9pZCAwKSB7CiAgICAgICAgdGhpcy5tb3JwaFRhcmdldEluZmx1ZW5jZXMgPSBbXSwgdGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnkgPSB7fTsKICAgICAgICBmb3IgKGxldCBzID0gMCwgciA9IG4ubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgICAgICBjb25zdCBvID0gbltzXS5uYW1lIHx8IFN0cmluZyhzKTsKICAgICAgICAgIHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzLnB1c2goMCksIHRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5W29dID0gczsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgbG9jYWwtc3BhY2UgcG9zaXRpb24gb2YgdGhlIHZlcnRleCBhdCB0aGUgZ2l2ZW4gaW5kZXgsIHRha2luZyBpbnRvCiAgICogYWNjb3VudCB0aGUgY3VycmVudCBhbmltYXRpb24gc3RhdGUgb2YgYm90aCBtb3JwaCB0YXJnZXRzIGFuZCBza2lubmluZy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSB2ZXJ0ZXggaW5kZXguCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IG9iamVjdCB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgdmVydGV4IHBvc2l0aW9uIGluIGxvY2FsIHNwYWNlLgogICAqLwogIGdldFZlcnRleFBvc2l0aW9uKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdlb21ldHJ5LCBuID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBzID0gaS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24sIHIgPSBpLm1vcnBoVGFyZ2V0c1JlbGF0aXZlOwogICAgZS5mcm9tQnVmZmVyQXR0cmlidXRlKG4sIHQpOwogICAgY29uc3QgbyA9IHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzOwogICAgaWYgKHMgJiYgbykgewogICAgICBsbC5zZXQoMCwgMCwgMCk7CiAgICAgIGZvciAobGV0IGwgPSAwLCBoID0gcy5sZW5ndGg7IGwgPCBoOyBsKyspIHsKICAgICAgICBjb25zdCBjID0gb1tsXSwgdSA9IHNbbF07CiAgICAgICAgYyAhPT0gMCAmJiAoQnUuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh1LCB0KSwgciA/IGxsLmFkZFNjYWxlZFZlY3RvcihCdSwgYykgOiBsbC5hZGRTY2FsZWRWZWN0b3IoQnUuc3ViKGUpLCBjKSk7CiAgICAgIH0KICAgICAgZS5hZGQobGwpOwogICAgfQogICAgcmV0dXJuIGU7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGludGVyc2VjdGlvbiBwb2ludHMgYmV0d2VlbiBhIGNhc3RlZCByYXkgYW5kIHRoaXMgbGluZS4KICAgKgogICAqIEBwYXJhbSB7UmF5Y2FzdGVyfSByYXljYXN0ZXIgLSBUaGUgcmF5Y2FzdGVyLgogICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gaW50ZXJzZWN0cyAtIFRoZSB0YXJnZXQgYXJyYXkgdGhhdCBob2xkcyB0aGUgaW50ZXJzZWN0aW9uIHBvaW50cy4KICAgKi8KICByYXljYXN0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdlb21ldHJ5LCBuID0gdGhpcy5tYXRlcmlhbCwgcyA9IHRoaXMubWF0cml4V29ybGQ7CiAgICBuICE9PSB2b2lkIDAgJiYgKGkuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgJiYgaS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKSwgc2wuY29weShpLmJvdW5kaW5nU3BoZXJlKSwgc2wuYXBwbHlNYXRyaXg0KHMpLCBrcy5jb3B5KHQucmF5KS5yZWNhc3QodC5uZWFyKSwgIShzbC5jb250YWluc1BvaW50KGtzLm9yaWdpbikgPT09ICExICYmIChrcy5pbnRlcnNlY3RTcGhlcmUoc2wsIFdmKSA9PT0gbnVsbCB8fCBrcy5vcmlnaW4uZGlzdGFuY2VUb1NxdWFyZWQoV2YpID4gKHQuZmFyIC0gdC5uZWFyKSAqKiAyKSkgJiYgKEdmLmNvcHkocykuaW52ZXJ0KCksIGtzLmNvcHkodC5yYXkpLmFwcGx5TWF0cml4NChHZiksICEoaS5ib3VuZGluZ0JveCAhPT0gbnVsbCAmJiBrcy5pbnRlcnNlY3RzQm94KGkuYm91bmRpbmdCb3gpID09PSAhMSkgJiYgdGhpcy5fY29tcHV0ZUludGVyc2VjdGlvbnModCwgZSwga3MpKSk7CiAgfQogIF9jb21wdXRlSW50ZXJzZWN0aW9ucyh0LCBlLCBpKSB7CiAgICBsZXQgbjsKICAgIGNvbnN0IHMgPSB0aGlzLmdlb21ldHJ5LCByID0gdGhpcy5tYXRlcmlhbCwgbyA9IHMuaW5kZXgsIGwgPSBzLmF0dHJpYnV0ZXMucG9zaXRpb24sIGggPSBzLmF0dHJpYnV0ZXMudXYsIGMgPSBzLmF0dHJpYnV0ZXMudXYxLCB1ID0gcy5hdHRyaWJ1dGVzLm5vcm1hbCwgZCA9IHMuZ3JvdXBzLCBwID0gcy5kcmF3UmFuZ2U7CiAgICBpZiAobyAhPT0gbnVsbCkKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocikpCiAgICAgICAgZm9yIChsZXQgZiA9IDAsIHkgPSBkLmxlbmd0aDsgZiA8IHk7IGYrKykgewogICAgICAgICAgY29uc3QgZyA9IGRbZl0sIG0gPSByW2cubWF0ZXJpYWxJbmRleF0sIHYgPSBNYXRoLm1heChnLnN0YXJ0LCBwLnN0YXJ0KSwgeCA9IE1hdGgubWluKG8uY291bnQsIE1hdGgubWluKGcuc3RhcnQgKyBnLmNvdW50LCBwLnN0YXJ0ICsgcC5jb3VudCkpOwogICAgICAgICAgZm9yIChsZXQgXyA9IHYsIFMgPSB4OyBfIDwgUzsgXyArPSAzKSB7CiAgICAgICAgICAgIGNvbnN0IHcgPSBvLmdldFgoXyksIFQgPSBvLmdldFgoXyArIDEpLCBSID0gby5nZXRYKF8gKyAyKTsKICAgICAgICAgICAgbiA9IGNsKHRoaXMsIG0sIHQsIGksIGgsIGMsIHUsIHcsIFQsIFIpLCBuICYmIChuLmZhY2VJbmRleCA9IE1hdGguZmxvb3IoXyAvIDMpLCBuLmZhY2UubWF0ZXJpYWxJbmRleCA9IGcubWF0ZXJpYWxJbmRleCwgZS5wdXNoKG4pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGNvbnN0IGYgPSBNYXRoLm1heCgwLCBwLnN0YXJ0KSwgeSA9IE1hdGgubWluKG8uY291bnQsIHAuc3RhcnQgKyBwLmNvdW50KTsKICAgICAgICBmb3IgKGxldCBnID0gZiwgbSA9IHk7IGcgPCBtOyBnICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHYgPSBvLmdldFgoZyksIHggPSBvLmdldFgoZyArIDEpLCBfID0gby5nZXRYKGcgKyAyKTsKICAgICAgICAgIG4gPSBjbCh0aGlzLCByLCB0LCBpLCBoLCBjLCB1LCB2LCB4LCBfKSwgbiAmJiAobi5mYWNlSW5kZXggPSBNYXRoLmZsb29yKGcgLyAzKSwgZS5wdXNoKG4pKTsKICAgICAgICB9CiAgICAgIH0KICAgIGVsc2UgaWYgKGwgIT09IHZvaWQgMCkKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocikpCiAgICAgICAgZm9yIChsZXQgZiA9IDAsIHkgPSBkLmxlbmd0aDsgZiA8IHk7IGYrKykgewogICAgICAgICAgY29uc3QgZyA9IGRbZl0sIG0gPSByW2cubWF0ZXJpYWxJbmRleF0sIHYgPSBNYXRoLm1heChnLnN0YXJ0LCBwLnN0YXJ0KSwgeCA9IE1hdGgubWluKGwuY291bnQsIE1hdGgubWluKGcuc3RhcnQgKyBnLmNvdW50LCBwLnN0YXJ0ICsgcC5jb3VudCkpOwogICAgICAgICAgZm9yIChsZXQgXyA9IHYsIFMgPSB4OyBfIDwgUzsgXyArPSAzKSB7CiAgICAgICAgICAgIGNvbnN0IHcgPSBfLCBUID0gXyArIDEsIFIgPSBfICsgMjsKICAgICAgICAgICAgbiA9IGNsKHRoaXMsIG0sIHQsIGksIGgsIGMsIHUsIHcsIFQsIFIpLCBuICYmIChuLmZhY2VJbmRleCA9IE1hdGguZmxvb3IoXyAvIDMpLCBuLmZhY2UubWF0ZXJpYWxJbmRleCA9IGcubWF0ZXJpYWxJbmRleCwgZS5wdXNoKG4pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGNvbnN0IGYgPSBNYXRoLm1heCgwLCBwLnN0YXJ0KSwgeSA9IE1hdGgubWluKGwuY291bnQsIHAuc3RhcnQgKyBwLmNvdW50KTsKICAgICAgICBmb3IgKGxldCBnID0gZiwgbSA9IHk7IGcgPCBtOyBnICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHYgPSBnLCB4ID0gZyArIDEsIF8gPSBnICsgMjsKICAgICAgICAgIG4gPSBjbCh0aGlzLCByLCB0LCBpLCBoLCBjLCB1LCB2LCB4LCBfKSwgbiAmJiAobi5mYWNlSW5kZXggPSBNYXRoLmZsb29yKGcgLyAzKSwgZS5wdXNoKG4pKTsKICAgICAgICB9CiAgICAgIH0KICB9Cn07CmZ1bmN0aW9uIHp2KGEsIHQsIGUsIGksIG4sIHMsIHIsIG8pIHsKICBsZXQgbDsKICBpZiAodC5zaWRlID09PSBIZSA/IGwgPSBpLmludGVyc2VjdFRyaWFuZ2xlKHIsIHMsIG4sICEwLCBvKSA6IGwgPSBpLmludGVyc2VjdFRyaWFuZ2xlKG4sIHMsIHIsIHQuc2lkZSA9PT0gJGksIG8pLCBsID09PSBudWxsKSByZXR1cm4gbnVsbDsKICBobC5jb3B5KG8pLCBobC5hcHBseU1hdHJpeDQoYS5tYXRyaXhXb3JsZCk7CiAgY29uc3QgaCA9IGUucmF5Lm9yaWdpbi5kaXN0YW5jZVRvKGhsKTsKICByZXR1cm4gaCA8IGUubmVhciB8fCBoID4gZS5mYXIgPyBudWxsIDogewogICAgZGlzdGFuY2U6IGgsCiAgICBwb2ludDogaGwuY2xvbmUoKSwKICAgIG9iamVjdDogYQogIH07Cn0KZnVuY3Rpb24gY2woYSwgdCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCkgewogIGEuZ2V0VmVydGV4UG9zaXRpb24obywgcmwpLCBhLmdldFZlcnRleFBvc2l0aW9uKGwsIGFsKSwgYS5nZXRWZXJ0ZXhQb3NpdGlvbihoLCBvbCk7CiAgY29uc3QgYyA9IHp2KGEsIHQsIGUsIGksIHJsLCBhbCwgb2wsIHFmKTsKICBpZiAoYykgewogICAgY29uc3QgdSA9IG5ldyBFKCk7CiAgICBicy5nZXRCYXJ5Y29vcmQocWYsIHJsLCBhbCwgb2wsIHUpLCBuICYmIChjLnV2ID0gYnMuZ2V0SW50ZXJwb2xhdGVkQXR0cmlidXRlKG4sIG8sIGwsIGgsIHUsIG5ldyBKKCkpKSwgcyAmJiAoYy51djEgPSBicy5nZXRJbnRlcnBvbGF0ZWRBdHRyaWJ1dGUocywgbywgbCwgaCwgdSwgbmV3IEooKSkpLCByICYmIChjLm5vcm1hbCA9IGJzLmdldEludGVycG9sYXRlZEF0dHJpYnV0ZShyLCBvLCBsLCBoLCB1LCBuZXcgRSgpKSwgYy5ub3JtYWwuZG90KGkuZGlyZWN0aW9uKSA+IDAgJiYgYy5ub3JtYWwubXVsdGlwbHlTY2FsYXIoLTEpKTsKICAgIGNvbnN0IGQgPSB7CiAgICAgIGE6IG8sCiAgICAgIGI6IGwsCiAgICAgIGM6IGgsCiAgICAgIG5vcm1hbDogbmV3IEUoKSwKICAgICAgbWF0ZXJpYWxJbmRleDogMAogICAgfTsKICAgIGJzLmdldE5vcm1hbChybCwgYWwsIG9sLCBkLm5vcm1hbCksIGMuZmFjZSA9IGQsIGMuYmFyeWNvb3JkID0gdTsKICB9CiAgcmV0dXJuIGM7Cn0KY2xhc3MgbXIgZXh0ZW5kcyBIdCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBib3ggZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTFdIC0gVGhlIHdpZHRoLiBUaGF0IGlzLCB0aGUgbGVuZ3RoIG9mIHRoZSBlZGdlcyBwYXJhbGxlbCB0byB0aGUgWCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTFdIC0gVGhlIGhlaWdodC4gVGhhdCBpcywgdGhlIGxlbmd0aCBvZiB0aGUgZWRnZXMgcGFyYWxsZWwgdG8gdGhlIFkgYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoPTFdIC0gVGhlIGRlcHRoLiBUaGF0IGlzLCB0aGUgbGVuZ3RoIG9mIHRoZSBlZGdlcyBwYXJhbGxlbCB0byB0aGUgWiBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGhTZWdtZW50cz0xXSAtIE51bWJlciBvZiBzZWdtZW50ZWQgcmVjdGFuZ3VsYXIgZmFjZXMgYWxvbmcgdGhlIHdpZHRoIG9mIHRoZSBzaWRlcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodFNlZ21lbnRzPTFdIC0gTnVtYmVyIG9mIHNlZ21lbnRlZCByZWN0YW5ndWxhciBmYWNlcyBhbG9uZyB0aGUgaGVpZ2h0IG9mIHRoZSBzaWRlcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoU2VnbWVudHM9MV0gLSBOdW1iZXIgb2Ygc2VnbWVudGVkIHJlY3Rhbmd1bGFyIGZhY2VzIGFsb25nIHRoZSBkZXB0aCBvZiB0aGUgc2lkZXMuCiAgICovCiAgY29uc3RydWN0b3IodCA9IDEsIGUgPSAxLCBpID0gMSwgbiA9IDEsIHMgPSAxLCByID0gMSkgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIkJveEdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICB3aWR0aDogdCwKICAgICAgaGVpZ2h0OiBlLAogICAgICBkZXB0aDogaSwKICAgICAgd2lkdGhTZWdtZW50czogbiwKICAgICAgaGVpZ2h0U2VnbWVudHM6IHMsCiAgICAgIGRlcHRoU2VnbWVudHM6IHIKICAgIH07CiAgICBjb25zdCBvID0gdGhpczsKICAgIG4gPSBNYXRoLmZsb29yKG4pLCBzID0gTWF0aC5mbG9vcihzKSwgciA9IE1hdGguZmxvb3Iocik7CiAgICBjb25zdCBsID0gW10sIGggPSBbXSwgYyA9IFtdLCB1ID0gW107CiAgICBsZXQgZCA9IDAsIHAgPSAwOwogICAgZigieiIsICJ5IiwgIngiLCAtMSwgLTEsIGksIGUsIHQsIHIsIHMsIDApLCBmKCJ6IiwgInkiLCAieCIsIDEsIC0xLCBpLCBlLCAtdCwgciwgcywgMSksIGYoIngiLCAieiIsICJ5IiwgMSwgMSwgdCwgaSwgZSwgbiwgciwgMiksIGYoIngiLCAieiIsICJ5IiwgMSwgLTEsIHQsIGksIC1lLCBuLCByLCAzKSwgZigieCIsICJ5IiwgInoiLCAxLCAtMSwgdCwgZSwgaSwgbiwgcywgNCksIGYoIngiLCAieSIsICJ6IiwgLTEsIC0xLCB0LCBlLCAtaSwgbiwgcywgNSksIHRoaXMuc2V0SW5kZXgobCksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChoLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3QoYywgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QodSwgMikpOwogICAgZnVuY3Rpb24gZih5LCBnLCBtLCB2LCB4LCBfLCBTLCB3LCBULCBSLCBiKSB7CiAgICAgIGNvbnN0IE0gPSBfIC8gVCwgTCA9IFMgLyBSLCBVID0gXyAvIDIsIE8gPSBTIC8gMiwgViA9IHcgLyAyLCBXID0gVCArIDEsIEcgPSBSICsgMTsKICAgICAgbGV0IGV0ID0gMCwgSCA9IDA7CiAgICAgIGNvbnN0IGF0ID0gbmV3IEUoKTsKICAgICAgZm9yIChsZXQgcHQgPSAwOyBwdCA8IEc7IHB0KyspIHsKICAgICAgICBjb25zdCBNdCA9IHB0ICogTCAtIE87CiAgICAgICAgZm9yIChsZXQgTHQgPSAwOyBMdCA8IFc7IEx0KyspIHsKICAgICAgICAgIGNvbnN0IGp0ID0gTHQgKiBNIC0gVTsKICAgICAgICAgIGF0W3ldID0ganQgKiB2LCBhdFtnXSA9IE10ICogeCwgYXRbbV0gPSBWLCBoLnB1c2goYXQueCwgYXQueSwgYXQueiksIGF0W3ldID0gMCwgYXRbZ10gPSAwLCBhdFttXSA9IHcgPiAwID8gMSA6IC0xLCBjLnB1c2goYXQueCwgYXQueSwgYXQueiksIHUucHVzaChMdCAvIFQpLCB1LnB1c2goMSAtIHB0IC8gUiksIGV0ICs9IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAobGV0IHB0ID0gMDsgcHQgPCBSOyBwdCsrKQogICAgICAgIGZvciAobGV0IE10ID0gMDsgTXQgPCBUOyBNdCsrKSB7CiAgICAgICAgICBjb25zdCBMdCA9IGQgKyBNdCArIFcgKiBwdCwganQgPSBkICsgTXQgKyBXICogKHB0ICsgMSksIG5lID0gZCArIChNdCArIDEpICsgVyAqIChwdCArIDEpLCBKdCA9IGQgKyAoTXQgKyAxKSArIFcgKiBwdDsKICAgICAgICAgIGwucHVzaChMdCwganQsIEp0KSwgbC5wdXNoKGp0LCBuZSwgSnQpLCBIICs9IDY7CiAgICAgICAgfQogICAgICBvLmFkZEdyb3VwKHAsIEgsIGIpLCBwICs9IEgsIGQgKz0gZXQ7CiAgICB9CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge0JveEdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBtcih0LndpZHRoLCB0LmhlaWdodCwgdC5kZXB0aCwgdC53aWR0aFNlZ21lbnRzLCB0LmhlaWdodFNlZ21lbnRzLCB0LmRlcHRoU2VnbWVudHMpOwogIH0KfQpmdW5jdGlvbiBfYShhKSB7CiAgY29uc3QgdCA9IHt9OwogIGZvciAoY29uc3QgZSBpbiBhKSB7CiAgICB0W2VdID0ge307CiAgICBmb3IgKGNvbnN0IGkgaW4gYVtlXSkgewogICAgICBjb25zdCBuID0gYVtlXVtpXTsKICAgICAgbiAmJiAobi5pc0NvbG9yIHx8IG4uaXNNYXRyaXgzIHx8IG4uaXNNYXRyaXg0IHx8IG4uaXNWZWN0b3IyIHx8IG4uaXNWZWN0b3IzIHx8IG4uaXNWZWN0b3I0IHx8IG4uaXNUZXh0dXJlIHx8IG4uaXNRdWF0ZXJuaW9uKSA/IG4uaXNSZW5kZXJUYXJnZXRUZXh0dXJlID8gKGNvbnNvbGUud2FybigiVW5pZm9ybXNVdGlsczogVGV4dHVyZXMgb2YgcmVuZGVyIHRhcmdldHMgY2Fubm90IGJlIGNsb25lZCB2aWEgY2xvbmVVbmlmb3JtcygpIG9yIG1lcmdlVW5pZm9ybXMoKS4iKSwgdFtlXVtpXSA9IG51bGwpIDogdFtlXVtpXSA9IG4uY2xvbmUoKSA6IEFycmF5LmlzQXJyYXkobikgPyB0W2VdW2ldID0gbi5zbGljZSgpIDogdFtlXVtpXSA9IG47CiAgICB9CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIHBpKGEpIHsKICBjb25zdCB0ID0ge307CiAgZm9yIChsZXQgZSA9IDA7IGUgPCBhLmxlbmd0aDsgZSsrKSB7CiAgICBjb25zdCBpID0gX2EoYVtlXSk7CiAgICBmb3IgKGNvbnN0IG4gaW4gaSkKICAgICAgdFtuXSA9IGlbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIE52KGEpIHsKICBjb25zdCB0ID0gW107CiAgZm9yIChsZXQgZSA9IDA7IGUgPCBhLmxlbmd0aDsgZSsrKQogICAgdC5wdXNoKGFbZV0uY2xvbmUoKSk7CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gd3koYSkgewogIGNvbnN0IHQgPSBhLmdldFJlbmRlclRhcmdldCgpOwogIHJldHVybiB0ID09PSBudWxsID8gYS5vdXRwdXRDb2xvclNwYWNlIDogdC5pc1hSUmVuZGVyVGFyZ2V0ID09PSAhMCA/IHQudGV4dHVyZS5jb2xvclNwYWNlIDogZWUud29ya2luZ0NvbG9yU3BhY2U7Cn0KY29uc3QgT2MgPSB7IGNsb25lOiBfYSwgbWVyZ2U6IHBpIH07CnZhciBPdiA9IGB2b2lkIG1haW4oKSB7CglnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KCBwb3NpdGlvbiwgMS4wICk7Cn1gLCBrdiA9IGB2b2lkIG1haW4oKSB7CglnbF9GcmFnQ29sb3IgPSB2ZWM0KCAxLjAsIDAuMCwgMC4wLCAxLjAgKTsKfWA7CmxldCBYaSA9IGNsYXNzIGV4dGVuZHMgaGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc2hhZGVyIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbWV0ZXJzXSAtIEFuIG9iamVjdCB3aXRoIG9uZSBvciBtb3JlIHByb3BlcnRpZXMKICAgKiBkZWZpbmluZyB0aGUgbWF0ZXJpYWwncyBhcHBlYXJhbmNlLiBBbnkgcHJvcGVydHkgb2YgdGhlIG1hdGVyaWFsCiAgICogKGluY2x1ZGluZyBhbnkgcHJvcGVydHkgZnJvbSBpbmhlcml0ZWQgbWF0ZXJpYWxzKSBjYW4gYmUgcGFzc2VkCiAgICogaW4gaGVyZS4gQ29sb3IgdmFsdWVzIGNhbiBiZSBwYXNzZWQgYW55IHR5cGUgb2YgdmFsdWUgYWNjZXB0ZWQKICAgKiBieSB7QGxpbmsgQ29sb3Ijc2V0fS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzU2hhZGVyTWF0ZXJpYWwgPSAhMCwgdGhpcy50eXBlID0gIlNoYWRlck1hdGVyaWFsIiwgdGhpcy5kZWZpbmVzID0ge30sIHRoaXMudW5pZm9ybXMgPSB7fSwgdGhpcy51bmlmb3Jtc0dyb3VwcyA9IFtdLCB0aGlzLnZlcnRleFNoYWRlciA9IE92LCB0aGlzLmZyYWdtZW50U2hhZGVyID0ga3YsIHRoaXMubGluZXdpZHRoID0gMSwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLmZvZyA9ICExLCB0aGlzLmxpZ2h0cyA9ICExLCB0aGlzLmNsaXBwaW5nID0gITEsIHRoaXMuZm9yY2VTaW5nbGVQYXNzID0gITAsIHRoaXMuZXh0ZW5zaW9ucyA9IHsKICAgICAgY2xpcEN1bGxEaXN0YW5jZTogITEsCiAgICAgIC8vIHNldCB0byB1c2UgdmVydGV4IHNoYWRlciBjbGlwcGluZwogICAgICBtdWx0aURyYXc6ICExCiAgICAgIC8vIHNldCB0byB1c2UgdmVydGV4IHNoYWRlciBtdWx0aV9kcmF3IC8gZW5hYmxlIGdsX0RyYXdJRAogICAgfSwgdGhpcy5kZWZhdWx0QXR0cmlidXRlVmFsdWVzID0gewogICAgICBjb2xvcjogWzEsIDEsIDFdLAogICAgICB1djogWzAsIDBdLAogICAgICB1djE6IFswLCAwXQogICAgfSwgdGhpcy5pbmRleDBBdHRyaWJ1dGVOYW1lID0gdm9pZCAwLCB0aGlzLnVuaWZvcm1zTmVlZFVwZGF0ZSA9ICExLCB0aGlzLmdsc2xWZXJzaW9uID0gbnVsbCwgdCAhPT0gdm9pZCAwICYmIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmZyYWdtZW50U2hhZGVyID0gdC5mcmFnbWVudFNoYWRlciwgdGhpcy52ZXJ0ZXhTaGFkZXIgPSB0LnZlcnRleFNoYWRlciwgdGhpcy51bmlmb3JtcyA9IF9hKHQudW5pZm9ybXMpLCB0aGlzLnVuaWZvcm1zR3JvdXBzID0gTnYodC51bmlmb3Jtc0dyb3VwcyksIHRoaXMuZGVmaW5lcyA9IE9iamVjdC5hc3NpZ24oe30sIHQuZGVmaW5lcyksIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMuZm9nID0gdC5mb2csIHRoaXMubGlnaHRzID0gdC5saWdodHMsIHRoaXMuY2xpcHBpbmcgPSB0LmNsaXBwaW5nLCB0aGlzLmV4dGVuc2lvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LmV4dGVuc2lvbnMpLCB0aGlzLmdsc2xWZXJzaW9uID0gdC5nbHNsVmVyc2lvbiwgdGhpczsKICB9CiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSBzdXBlci50b0pTT04odCk7CiAgICBlLmdsc2xWZXJzaW9uID0gdGhpcy5nbHNsVmVyc2lvbiwgZS51bmlmb3JtcyA9IHt9OwogICAgZm9yIChjb25zdCBuIGluIHRoaXMudW5pZm9ybXMpIHsKICAgICAgY29uc3QgciA9IHRoaXMudW5pZm9ybXNbbl0udmFsdWU7CiAgICAgIHIgJiYgci5pc1RleHR1cmUgPyBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHR5cGU6ICJ0IiwKICAgICAgICB2YWx1ZTogci50b0pTT04odCkudXVpZAogICAgICB9IDogciAmJiByLmlzQ29sb3IgPyBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHR5cGU6ICJjIiwKICAgICAgICB2YWx1ZTogci5nZXRIZXgoKQogICAgICB9IDogciAmJiByLmlzVmVjdG9yMiA/IGUudW5pZm9ybXNbbl0gPSB7CiAgICAgICAgdHlwZTogInYyIiwKICAgICAgICB2YWx1ZTogci50b0FycmF5KCkKICAgICAgfSA6IHIgJiYgci5pc1ZlY3RvcjMgPyBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHR5cGU6ICJ2MyIsCiAgICAgICAgdmFsdWU6IHIudG9BcnJheSgpCiAgICAgIH0gOiByICYmIHIuaXNWZWN0b3I0ID8gZS51bmlmb3Jtc1tuXSA9IHsKICAgICAgICB0eXBlOiAidjQiLAogICAgICAgIHZhbHVlOiByLnRvQXJyYXkoKQogICAgICB9IDogciAmJiByLmlzTWF0cml4MyA/IGUudW5pZm9ybXNbbl0gPSB7CiAgICAgICAgdHlwZTogIm0zIiwKICAgICAgICB2YWx1ZTogci50b0FycmF5KCkKICAgICAgfSA6IHIgJiYgci5pc01hdHJpeDQgPyBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHR5cGU6ICJtNCIsCiAgICAgICAgdmFsdWU6IHIudG9BcnJheSgpCiAgICAgIH0gOiBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHZhbHVlOiByCiAgICAgIH07CiAgICB9CiAgICBPYmplY3Qua2V5cyh0aGlzLmRlZmluZXMpLmxlbmd0aCA+IDAgJiYgKGUuZGVmaW5lcyA9IHRoaXMuZGVmaW5lcyksIGUudmVydGV4U2hhZGVyID0gdGhpcy52ZXJ0ZXhTaGFkZXIsIGUuZnJhZ21lbnRTaGFkZXIgPSB0aGlzLmZyYWdtZW50U2hhZGVyLCBlLmxpZ2h0cyA9IHRoaXMubGlnaHRzLCBlLmNsaXBwaW5nID0gdGhpcy5jbGlwcGluZzsKICAgIGNvbnN0IGkgPSB7fTsKICAgIGZvciAoY29uc3QgbiBpbiB0aGlzLmV4dGVuc2lvbnMpCiAgICAgIHRoaXMuZXh0ZW5zaW9uc1tuXSA9PT0gITAgJiYgKGlbbl0gPSAhMCk7CiAgICByZXR1cm4gT2JqZWN0LmtleXMoaSkubGVuZ3RoID4gMCAmJiAoZS5leHRlbnNpb25zID0gaSksIGU7CiAgfQp9LCBrYyA9IGNsYXNzIGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY2FtZXJhLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0NhbWVyYSA9ICEwLCB0aGlzLnR5cGUgPSAiQ2FtZXJhIiwgdGhpcy5tYXRyaXhXb3JsZEludmVyc2UgPSBuZXcgVnQoKSwgdGhpcy5wcm9qZWN0aW9uTWF0cml4ID0gbmV3IFZ0KCksIHRoaXMucHJvamVjdGlvbk1hdHJpeEludmVyc2UgPSBuZXcgVnQoKSwgdGhpcy5jb29yZGluYXRlU3lzdGVtID0gTmksIHRoaXMuX3JldmVyc2VkRGVwdGggPSAhMTsKICB9CiAgLyoqCiAgICogVGhlIGZsYWcgdGhhdCBpbmRpY2F0ZXMgd2hldGhlciB0aGUgY2FtZXJhIHVzZXMgYSByZXZlcnNlZCBkZXB0aCBidWZmZXIuCiAgICoKICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKiBAZGVmYXVsdCBmYWxzZQogICAqLwogIGdldCByZXZlcnNlZERlcHRoKCkgewogICAgcmV0dXJuIHRoaXMuX3JldmVyc2VkRGVwdGg7CiAgfQogIGNvcHkodCwgZSkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCwgZSksIHRoaXMubWF0cml4V29ybGRJbnZlcnNlLmNvcHkodC5tYXRyaXhXb3JsZEludmVyc2UpLCB0aGlzLnByb2plY3Rpb25NYXRyaXguY29weSh0LnByb2plY3Rpb25NYXRyaXgpLCB0aGlzLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlLmNvcHkodC5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZSksIHRoaXMuY29vcmRpbmF0ZVN5c3RlbSA9IHQuY29vcmRpbmF0ZVN5c3RlbSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHZlY3RvciByZXByZXNlbnRpbmcgdGhlICgibG9vayIpIGRpcmVjdGlvbiBvZiB0aGUgM0Qgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgogICAqCiAgICogVGhpcyBtZXRob2QgaXMgb3ZlcndyaXR0ZW4gc2luY2UgY2FtZXJhcyBoYXZlIGEgZGlmZmVyZW50IGZvcndhcmQgdmVjdG9yIGNvbXBhcmVkIHRvIG90aGVyCiAgICogM0Qgb2JqZWN0cy4gQSBjYW1lcmEgbG9va3MgZG93biBpdHMgbG9jYWwsIG5lZ2F0aXZlIHotYXhpcyBieSBkZWZhdWx0LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGUgcmVzdWx0IGlzIHN0b3JlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgM0Qgb2JqZWN0J3MgZGlyZWN0aW9uIGluIHdvcmxkIHNwYWNlLgogICAqLwogIGdldFdvcmxkRGlyZWN0aW9uKHQpIHsKICAgIHJldHVybiBzdXBlci5nZXRXb3JsZERpcmVjdGlvbih0KS5uZWdhdGUoKTsKICB9CiAgdXBkYXRlTWF0cml4V29ybGQodCkgewogICAgc3VwZXIudXBkYXRlTWF0cml4V29ybGQodCksIHRoaXMubWF0cml4V29ybGRJbnZlcnNlLmNvcHkodGhpcy5tYXRyaXhXb3JsZCkuaW52ZXJ0KCk7CiAgfQogIHVwZGF0ZVdvcmxkTWF0cml4KHQsIGUpIHsKICAgIHN1cGVyLnVwZGF0ZVdvcmxkTWF0cml4KHQsIGUpLCB0aGlzLm1hdHJpeFdvcmxkSW52ZXJzZS5jb3B5KHRoaXMubWF0cml4V29ybGQpLmludmVydCgpOwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQp9Owpjb25zdCBjcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCAkZiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgSigpLCBYZiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgSigpOwpjbGFzcyBWZSBleHRlbmRzIGtjIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHBlcnNwZWN0aXZlIGNhbWVyYS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm92PTUwXSAtIFRoZSB2ZXJ0aWNhbCBmaWVsZCBvZiB2aWV3LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYXNwZWN0PTFdIC0gVGhlIGFzcGVjdCByYXRpby4KICAgKiBAcGFyYW0ge251bWJlcn0gW25lYXI9MC4xXSAtIFRoZSBjYW1lcmEncyBuZWFyIHBsYW5lLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZmFyPTIwMDBdIC0gVGhlIGNhbWVyYSdzIGZhciBwbGFuZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gNTAsIGUgPSAxLCBpID0gMC4xLCBuID0gMmUzKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzUGVyc3BlY3RpdmVDYW1lcmEgPSAhMCwgdGhpcy50eXBlID0gIlBlcnNwZWN0aXZlQ2FtZXJhIiwgdGhpcy5mb3YgPSB0LCB0aGlzLnpvb20gPSAxLCB0aGlzLm5lYXIgPSBpLCB0aGlzLmZhciA9IG4sIHRoaXMuZm9jdXMgPSAxMCwgdGhpcy5hc3BlY3QgPSBlLCB0aGlzLnZpZXcgPSBudWxsLCB0aGlzLmZpbG1HYXVnZSA9IDM1LCB0aGlzLmZpbG1PZmZzZXQgPSAwLCB0aGlzLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKICB9CiAgY29weSh0LCBlKSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0LCBlKSwgdGhpcy5mb3YgPSB0LmZvdiwgdGhpcy56b29tID0gdC56b29tLCB0aGlzLm5lYXIgPSB0Lm5lYXIsIHRoaXMuZmFyID0gdC5mYXIsIHRoaXMuZm9jdXMgPSB0LmZvY3VzLCB0aGlzLmFzcGVjdCA9IHQuYXNwZWN0LCB0aGlzLnZpZXcgPSB0LnZpZXcgPT09IG51bGwgPyBudWxsIDogT2JqZWN0LmFzc2lnbih7fSwgdC52aWV3KSwgdGhpcy5maWxtR2F1Z2UgPSB0LmZpbG1HYXVnZSwgdGhpcy5maWxtT2Zmc2V0ID0gdC5maWxtT2Zmc2V0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBGT1YgYnkgZm9jYWwgbGVuZ3RoIGluIHJlc3BlY3QgdG8gdGhlIGN1cnJlbnQge0BsaW5rIFBlcnNwZWN0aXZlQ2FtZXJhI2ZpbG1HYXVnZX0uCiAgICoKICAgKiBUaGUgZGVmYXVsdCBmaWxtIGdhdWdlIGlzIDM1LCBzbyB0aGF0IHRoZSBmb2NhbCBsZW5ndGggY2FuIGJlIHNwZWNpZmllZCBmb3IKICAgKiBhIDM1bW0gKGZ1bGwgZnJhbWUpIGNhbWVyYS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBmb2NhbExlbmd0aCAtIFZhbHVlcyBmb3IgZm9jYWwgbGVuZ3RoIGFuZCBmaWxtIGdhdWdlIG11c3QgaGF2ZSB0aGUgc2FtZSB1bml0LgogICAqLwogIHNldEZvY2FsTGVuZ3RoKHQpIHsKICAgIGNvbnN0IGUgPSAwLjUgKiB0aGlzLmdldEZpbG1IZWlnaHQoKSAvIHQ7CiAgICB0aGlzLmZvdiA9IHlhICogMiAqIE1hdGguYXRhbihlKSwgdGhpcy51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGZvY2FsIGxlbmd0aCBmcm9tIHRoZSBjdXJyZW50IHtAbGluayBQZXJzcGVjdGl2ZUNhbWVyYSNmb3Z9IGFuZAogICAqIHtAbGluayBQZXJzcGVjdGl2ZUNhbWVyYSNmaWxtR2F1Z2V9LgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgY29tcHV0ZWQgZm9jYWwgbGVuZ3RoLgogICAqLwogIGdldEZvY2FsTGVuZ3RoKCkgewogICAgY29uc3QgdCA9IE1hdGgudGFuKGxyICogMC41ICogdGhpcy5mb3YpOwogICAgcmV0dXJuIDAuNSAqIHRoaXMuZ2V0RmlsbUhlaWdodCgpIC8gdDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY3VycmVudCB2ZXJ0aWNhbCBmaWVsZCBvZiB2aWV3IGFuZ2xlIGluIGRlZ3JlZXMgY29uc2lkZXJpbmcge0BsaW5rIFBlcnNwZWN0aXZlQ2FtZXJhI3pvb219LgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZWZmZWN0aXZlIEZPVi4KICAgKi8KICBnZXRFZmZlY3RpdmVGT1YoKSB7CiAgICByZXR1cm4geWEgKiAyICogTWF0aC5hdGFuKAogICAgICBNYXRoLnRhbihsciAqIDAuNSAqIHRoaXMuZm92KSAvIHRoaXMuem9vbQogICAgKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgd2lkdGggb2YgdGhlIGltYWdlIG9uIHRoZSBmaWxtLiBJZiB7QGxpbmsgUGVyc3BlY3RpdmVDYW1lcmEjYXNwZWN0fSBpcyBncmVhdGVyIHRoYW4gb3IKICAgKiBlcXVhbCB0byBvbmUgKGxhbmRzY2FwZSBmb3JtYXQpLCB0aGUgcmVzdWx0IGVxdWFscyB7QGxpbmsgUGVyc3BlY3RpdmVDYW1lcmEjZmlsbUdhdWdlfS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGZpbG0gd2lkdGguCiAgICovCiAgZ2V0RmlsbVdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMuZmlsbUdhdWdlICogTWF0aC5taW4odGhpcy5hc3BlY3QsIDEpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBoZWlnaHQgb2YgdGhlIGltYWdlIG9uIHRoZSBmaWxtLiBJZiB7QGxpbmsgUGVyc3BlY3RpdmVDYW1lcmEjYXNwZWN0fSBpcyBncmVhdGVyIHRoYW4gb3IKICAgKiBlcXVhbCB0byBvbmUgKGxhbmRzY2FwZSBmb3JtYXQpLCB0aGUgcmVzdWx0IGVxdWFscyB7QGxpbmsgUGVyc3BlY3RpdmVDYW1lcmEjZmlsbUdhdWdlfS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGZpbG0gd2lkdGguCiAgICovCiAgZ2V0RmlsbUhlaWdodCgpIHsKICAgIHJldHVybiB0aGlzLmZpbG1HYXVnZSAvIE1hdGgubWF4KHRoaXMuYXNwZWN0LCAxKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIDJEIGJvdW5kcyBvZiB0aGUgY2FtZXJhJ3Mgdmlld2FibGUgcmVjdGFuZ2xlIGF0IGEgZ2l2ZW4gZGlzdGFuY2UgYWxvbmcgdGhlIHZpZXdpbmcgZGlyZWN0aW9uLgogICAqIFNldHMgYG1pblRhcmdldGAgYW5kIGBtYXhUYXJnZXRgIHRvIHRoZSBjb29yZGluYXRlcyBvZiB0aGUgbG93ZXItbGVmdCBhbmQgdXBwZXItcmlnaHQgY29ybmVycyBvZiB0aGUgdmlldyByZWN0YW5nbGUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gZGlzdGFuY2UgLSBUaGUgdmlld2luZyBkaXN0YW5jZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG1pblRhcmdldCAtIFRoZSBsb3dlci1sZWZ0IGNvcm5lciBvZiB0aGUgdmlldyByZWN0YW5nbGUgaXMgd3JpdHRlbiBpbnRvIHRoaXMgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gbWF4VGFyZ2V0IC0gVGhlIHVwcGVyLXJpZ2h0IGNvcm5lciBvZiB0aGUgdmlldyByZWN0YW5nbGUgaXMgd3JpdHRlbiBpbnRvIHRoaXMgdmVjdG9yLgogICAqLwogIGdldFZpZXdCb3VuZHModCwgZSwgaSkgewogICAgY3Muc2V0KC0xLCAtMSwgMC41KS5hcHBseU1hdHJpeDQodGhpcy5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZSksIGUuc2V0KGNzLngsIGNzLnkpLm11bHRpcGx5U2NhbGFyKC10IC8gY3MueiksIGNzLnNldCgxLCAxLCAwLjUpLmFwcGx5TWF0cml4NCh0aGlzLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlKSwgaS5zZXQoY3MueCwgY3MueSkubXVsdGlwbHlTY2FsYXIoLXQgLyBjcy56KTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIGNhbWVyYSdzIHZpZXdhYmxlIHJlY3RhbmdsZSBhdCBhIGdpdmVuIGRpc3RhbmNlIGFsb25nIHRoZSB2aWV3aW5nIGRpcmVjdGlvbi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBkaXN0YW5jZSAtIFRoZSB2aWV3aW5nIGRpc3RhbmNlLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHJlc3VsdCB3aGVyZSB4IGlzIHdpZHRoIGFuZCB5IGlzIGhlaWdodC4KICAgKiBAcmV0dXJucyB7VmVjdG9yMn0gVGhlIHZpZXcgc2l6ZS4KICAgKi8KICBnZXRWaWV3U2l6ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5nZXRWaWV3Qm91bmRzKHQsICRmLCBYZiksIGUuc3ViVmVjdG9ycyhYZiwgJGYpOwogIH0KICAvKioKICAgKiBTZXRzIGFuIG9mZnNldCBpbiBhIGxhcmdlciBmcnVzdHVtLiBUaGlzIGlzIHVzZWZ1bCBmb3IgbXVsdGktd2luZG93IG9yCiAgICogbXVsdGktbW9uaXRvci9tdWx0aS1tYWNoaW5lIHNldHVwcy4KICAgKgogICAqIEZvciBleGFtcGxlLCBpZiB5b3UgaGF2ZSAzeDIgbW9uaXRvcnMgYW5kIGVhY2ggbW9uaXRvciBpcyAxOTIweDEwODAgYW5kCiAgICogdGhlIG1vbml0b3JzIGFyZSBpbiBncmlkIGxpa2UgdGhpcwogICAqYGBgCiAgICogICArLS0tKy0tLSstLS0rCiAgICogICB8IEEgfCBCIHwgQyB8CiAgICogICArLS0tKy0tLSstLS0rCiAgICogICB8IEQgfCBFIHwgRiB8CiAgICogICArLS0tKy0tLSstLS0rCiAgICpgYGAKICAgKiB0aGVuIGZvciBlYWNoIG1vbml0b3IgeW91IHdvdWxkIGNhbGwgaXQgbGlrZSB0aGlzOgogICAqYGBganMKICAgKiBjb25zdCB3ID0gMTkyMDsKICAgKiBjb25zdCBoID0gMTA4MDsKICAgKiBjb25zdCBmdWxsV2lkdGggPSB3ICogMzsKICAgKiBjb25zdCBmdWxsSGVpZ2h0ID0gaCAqIDI7CiAgICoKICAgKiAvLyAtLUEtLQogICAqIGNhbWVyYS5zZXRWaWV3T2Zmc2V0KCBmdWxsV2lkdGgsIGZ1bGxIZWlnaHQsIHcgKiAwLCBoICogMCwgdywgaCApOwogICAqIC8vIC0tQi0tCiAgICogY2FtZXJhLnNldFZpZXdPZmZzZXQoIGZ1bGxXaWR0aCwgZnVsbEhlaWdodCwgdyAqIDEsIGggKiAwLCB3LCBoICk7CiAgICogLy8gLS1DLS0KICAgKiBjYW1lcmEuc2V0Vmlld09mZnNldCggZnVsbFdpZHRoLCBmdWxsSGVpZ2h0LCB3ICogMiwgaCAqIDAsIHcsIGggKTsKICAgKiAvLyAtLUQtLQogICAqIGNhbWVyYS5zZXRWaWV3T2Zmc2V0KCBmdWxsV2lkdGgsIGZ1bGxIZWlnaHQsIHcgKiAwLCBoICogMSwgdywgaCApOwogICAqIC8vIC0tRS0tCiAgICogY2FtZXJhLnNldFZpZXdPZmZzZXQoIGZ1bGxXaWR0aCwgZnVsbEhlaWdodCwgdyAqIDEsIGggKiAxLCB3LCBoICk7CiAgICogLy8gLS1GLS0KICAgKiBjYW1lcmEuc2V0Vmlld09mZnNldCggZnVsbFdpZHRoLCBmdWxsSGVpZ2h0LCB3ICogMiwgaCAqIDEsIHcsIGggKTsKICAgKiBgYGAKICAgKgogICAqIE5vdGUgdGhlcmUgaXMgbm8gcmVhc29uIG1vbml0b3JzIGhhdmUgdG8gYmUgdGhlIHNhbWUgc2l6ZSBvciBpbiBhIGdyaWQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gZnVsbFdpZHRoIC0gVGhlIGZ1bGwgd2lkdGggb2YgbXVsdGl2aWV3IHNldHVwLgogICAqIEBwYXJhbSB7bnVtYmVyfSBmdWxsSGVpZ2h0IC0gVGhlIGZ1bGwgaGVpZ2h0IG9mIG11bHRpdmlldyBzZXR1cC4KICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBob3Jpem9udGFsIG9mZnNldCBvZiB0aGUgc3ViY2FtZXJhLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZlcnRpY2FsIG9mZnNldCBvZiB0aGUgc3ViY2FtZXJhLgogICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiBzdWJjYW1lcmEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2Ygc3ViY2FtZXJhLgogICAqLwogIHNldFZpZXdPZmZzZXQodCwgZSwgaSwgbiwgcywgcikgewogICAgdGhpcy5hc3BlY3QgPSB0IC8gZSwgdGhpcy52aWV3ID09PSBudWxsICYmICh0aGlzLnZpZXcgPSB7CiAgICAgIGVuYWJsZWQ6ICEwLAogICAgICBmdWxsV2lkdGg6IDEsCiAgICAgIGZ1bGxIZWlnaHQ6IDEsCiAgICAgIG9mZnNldFg6IDAsCiAgICAgIG9mZnNldFk6IDAsCiAgICAgIHdpZHRoOiAxLAogICAgICBoZWlnaHQ6IDEKICAgIH0pLCB0aGlzLnZpZXcuZW5hYmxlZCA9ICEwLCB0aGlzLnZpZXcuZnVsbFdpZHRoID0gdCwgdGhpcy52aWV3LmZ1bGxIZWlnaHQgPSBlLCB0aGlzLnZpZXcub2Zmc2V0WCA9IGksIHRoaXMudmlldy5vZmZzZXRZID0gbiwgdGhpcy52aWV3LndpZHRoID0gcywgdGhpcy52aWV3LmhlaWdodCA9IHIsIHRoaXMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogIH0KICAvKioKICAgKiBSZW1vdmVzIHRoZSB2aWV3IG9mZnNldCBmcm9tIHRoZSBwcm9qZWN0aW9uIG1hdHJpeC4KICAgKi8KICBjbGVhclZpZXdPZmZzZXQoKSB7CiAgICB0aGlzLnZpZXcgIT09IG51bGwgJiYgKHRoaXMudmlldy5lbmFibGVkID0gITEpLCB0aGlzLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgY2FtZXJhJ3MgcHJvamVjdGlvbiBtYXRyaXguIE11c3QgYmUgY2FsbGVkIGFmdGVyIGFueSBjaGFuZ2Ugb2YKICAgKiBjYW1lcmEgcHJvcGVydGllcy4KICAgKi8KICB1cGRhdGVQcm9qZWN0aW9uTWF0cml4KCkgewogICAgY29uc3QgdCA9IHRoaXMubmVhcjsKICAgIGxldCBlID0gdCAqIE1hdGgudGFuKGxyICogMC41ICogdGhpcy5mb3YpIC8gdGhpcy56b29tLCBpID0gMiAqIGUsIG4gPSB0aGlzLmFzcGVjdCAqIGksIHMgPSAtMC41ICogbjsKICAgIGNvbnN0IHIgPSB0aGlzLnZpZXc7CiAgICBpZiAodGhpcy52aWV3ICE9PSBudWxsICYmIHRoaXMudmlldy5lbmFibGVkKSB7CiAgICAgIGNvbnN0IGwgPSByLmZ1bGxXaWR0aCwgaCA9IHIuZnVsbEhlaWdodDsKICAgICAgcyArPSByLm9mZnNldFggKiBuIC8gbCwgZSAtPSByLm9mZnNldFkgKiBpIC8gaCwgbiAqPSByLndpZHRoIC8gbCwgaSAqPSByLmhlaWdodCAvIGg7CiAgICB9CiAgICBjb25zdCBvID0gdGhpcy5maWxtT2Zmc2V0OwogICAgbyAhPT0gMCAmJiAocyArPSB0ICogbyAvIHRoaXMuZ2V0RmlsbVdpZHRoKCkpLCB0aGlzLnByb2plY3Rpb25NYXRyaXgubWFrZVBlcnNwZWN0aXZlKHMsIHMgKyBuLCBlLCBlIC0gaSwgdCwgdGhpcy5mYXIsIHRoaXMuY29vcmRpbmF0ZVN5c3RlbSwgdGhpcy5yZXZlcnNlZERlcHRoKSwgdGhpcy5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZS5jb3B5KHRoaXMucHJvamVjdGlvbk1hdHJpeCkuaW52ZXJ0KCk7CiAgfQogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gc3VwZXIudG9KU09OKHQpOwogICAgcmV0dXJuIGUub2JqZWN0LmZvdiA9IHRoaXMuZm92LCBlLm9iamVjdC56b29tID0gdGhpcy56b29tLCBlLm9iamVjdC5uZWFyID0gdGhpcy5uZWFyLCBlLm9iamVjdC5mYXIgPSB0aGlzLmZhciwgZS5vYmplY3QuZm9jdXMgPSB0aGlzLmZvY3VzLCBlLm9iamVjdC5hc3BlY3QgPSB0aGlzLmFzcGVjdCwgdGhpcy52aWV3ICE9PSBudWxsICYmIChlLm9iamVjdC52aWV3ID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy52aWV3KSksIGUub2JqZWN0LmZpbG1HYXVnZSA9IHRoaXMuZmlsbUdhdWdlLCBlLm9iamVjdC5maWxtT2Zmc2V0ID0gdGhpcy5maWxtT2Zmc2V0LCBlOwogIH0KfQpjb25zdCBQciA9IC05MCwgSXIgPSAxOwpjbGFzcyBBeSBleHRlbmRzIGxlIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGN1YmUgY2FtZXJhLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG5lYXIgLSBUaGUgY2FtZXJhJ3MgbmVhciBwbGFuZS4KICAgKiBAcGFyYW0ge251bWJlcn0gZmFyIC0gVGhlIGNhbWVyYSdzIGZhciBwbGFuZS4KICAgKiBAcGFyYW0ge1dlYkdMQ3ViZVJlbmRlclRhcmdldH0gcmVuZGVyVGFyZ2V0IC0gVGhlIGN1YmUgcmVuZGVyIHRhcmdldC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBzdXBlcigpLCB0aGlzLnR5cGUgPSAiQ3ViZUNhbWVyYSIsIHRoaXMucmVuZGVyVGFyZ2V0ID0gaSwgdGhpcy5jb29yZGluYXRlU3lzdGVtID0gbnVsbCwgdGhpcy5hY3RpdmVNaXBtYXBMZXZlbCA9IDA7CiAgICBjb25zdCBuID0gbmV3IFZlKFByLCBJciwgdCwgZSk7CiAgICBuLmxheWVycyA9IHRoaXMubGF5ZXJzLCB0aGlzLmFkZChuKTsKICAgIGNvbnN0IHMgPSBuZXcgVmUoUHIsIElyLCB0LCBlKTsKICAgIHMubGF5ZXJzID0gdGhpcy5sYXllcnMsIHRoaXMuYWRkKHMpOwogICAgY29uc3QgciA9IG5ldyBWZShQciwgSXIsIHQsIGUpOwogICAgci5sYXllcnMgPSB0aGlzLmxheWVycywgdGhpcy5hZGQocik7CiAgICBjb25zdCBvID0gbmV3IFZlKFByLCBJciwgdCwgZSk7CiAgICBvLmxheWVycyA9IHRoaXMubGF5ZXJzLCB0aGlzLmFkZChvKTsKICAgIGNvbnN0IGwgPSBuZXcgVmUoUHIsIElyLCB0LCBlKTsKICAgIGwubGF5ZXJzID0gdGhpcy5sYXllcnMsIHRoaXMuYWRkKGwpOwogICAgY29uc3QgaCA9IG5ldyBWZShQciwgSXIsIHQsIGUpOwogICAgaC5sYXllcnMgPSB0aGlzLmxheWVycywgdGhpcy5hZGQoaCk7CiAgfQogIC8qKgogICAqIE11c3QgYmUgY2FsbGVkIHdoZW4gdGhlIGNvb3JkaW5hdGUgc3lzdGVtIG9mIHRoZSBjdWJlIGNhbWVyYSBpcyBjaGFuZ2VkLgogICAqLwogIHVwZGF0ZUNvb3JkaW5hdGVTeXN0ZW0oKSB7CiAgICBjb25zdCB0ID0gdGhpcy5jb29yZGluYXRlU3lzdGVtLCBlID0gdGhpcy5jaGlsZHJlbi5jb25jYXQoKSwgW2ksIG4sIHMsIHIsIG8sIGxdID0gZTsKICAgIGZvciAoY29uc3QgaCBvZiBlKSB0aGlzLnJlbW92ZShoKTsKICAgIGlmICh0ID09PSBOaSkKICAgICAgaS51cC5zZXQoMCwgMSwgMCksIGkubG9va0F0KDEsIDAsIDApLCBuLnVwLnNldCgwLCAxLCAwKSwgbi5sb29rQXQoLTEsIDAsIDApLCBzLnVwLnNldCgwLCAwLCAtMSksIHMubG9va0F0KDAsIDEsIDApLCByLnVwLnNldCgwLCAwLCAxKSwgci5sb29rQXQoMCwgLTEsIDApLCBvLnVwLnNldCgwLCAxLCAwKSwgby5sb29rQXQoMCwgMCwgMSksIGwudXAuc2V0KDAsIDEsIDApLCBsLmxvb2tBdCgwLCAwLCAtMSk7CiAgICBlbHNlIGlmICh0ID09PSBnYSkKICAgICAgaS51cC5zZXQoMCwgLTEsIDApLCBpLmxvb2tBdCgtMSwgMCwgMCksIG4udXAuc2V0KDAsIC0xLCAwKSwgbi5sb29rQXQoMSwgMCwgMCksIHMudXAuc2V0KDAsIDAsIDEpLCBzLmxvb2tBdCgwLCAxLCAwKSwgci51cC5zZXQoMCwgMCwgLTEpLCByLmxvb2tBdCgwLCAtMSwgMCksIG8udXAuc2V0KDAsIC0xLCAwKSwgby5sb29rQXQoMCwgMCwgMSksIGwudXAuc2V0KDAsIC0xLCAwKSwgbC5sb29rQXQoMCwgMCwgLTEpOwogICAgZWxzZQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLkN1YmVDYW1lcmEudXBkYXRlQ29vcmRpbmF0ZVN5c3RlbSgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAiICsgdCk7CiAgICBmb3IgKGNvbnN0IGggb2YgZSkKICAgICAgdGhpcy5hZGQoaCksIGgudXBkYXRlTWF0cml4V29ybGQoKTsKICB9CiAgLyoqCiAgICogQ2FsbGluZyB0aGlzIG1ldGhvZCB3aWxsIHJlbmRlciB0aGUgZ2l2ZW4gc2NlbmUgd2l0aCB0aGUgZ2l2ZW4gcmVuZGVyZXIKICAgKiBpbnRvIHRoZSBjdWJlIHJlbmRlciB0YXJnZXQgb2YgdGhlIGNhbWVyYS4KICAgKgogICAqIEBwYXJhbSB7KFJlbmRlcmVyfFdlYkdMUmVuZGVyZXIpfSByZW5kZXJlciAtIFRoZSByZW5kZXJlci4KICAgKiBAcGFyYW0ge1NjZW5lfSBzY2VuZSAtIFRoZSBzY2VuZSB0byByZW5kZXIuCiAgICovCiAgdXBkYXRlKHQsIGUpIHsKICAgIHRoaXMucGFyZW50ID09PSBudWxsICYmIHRoaXMudXBkYXRlTWF0cml4V29ybGQoKTsKICAgIGNvbnN0IHsgcmVuZGVyVGFyZ2V0OiBpLCBhY3RpdmVNaXBtYXBMZXZlbDogbiB9ID0gdGhpczsKICAgIHRoaXMuY29vcmRpbmF0ZVN5c3RlbSAhPT0gdC5jb29yZGluYXRlU3lzdGVtICYmICh0aGlzLmNvb3JkaW5hdGVTeXN0ZW0gPSB0LmNvb3JkaW5hdGVTeXN0ZW0sIHRoaXMudXBkYXRlQ29vcmRpbmF0ZVN5c3RlbSgpKTsKICAgIGNvbnN0IFtzLCByLCBvLCBsLCBoLCBjXSA9IHRoaXMuY2hpbGRyZW4sIHUgPSB0LmdldFJlbmRlclRhcmdldCgpLCBkID0gdC5nZXRBY3RpdmVDdWJlRmFjZSgpLCBwID0gdC5nZXRBY3RpdmVNaXBtYXBMZXZlbCgpLCBmID0gdC54ci5lbmFibGVkOwogICAgdC54ci5lbmFibGVkID0gITE7CiAgICBjb25zdCB5ID0gaS50ZXh0dXJlLmdlbmVyYXRlTWlwbWFwczsKICAgIGkudGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSAhMSwgdC5zZXRSZW5kZXJUYXJnZXQoaSwgMCwgbiksIHQucmVuZGVyKGUsIHMpLCB0LnNldFJlbmRlclRhcmdldChpLCAxLCBuKSwgdC5yZW5kZXIoZSwgciksIHQuc2V0UmVuZGVyVGFyZ2V0KGksIDIsIG4pLCB0LnJlbmRlcihlLCBvKSwgdC5zZXRSZW5kZXJUYXJnZXQoaSwgMywgbiksIHQucmVuZGVyKGUsIGwpLCB0LnNldFJlbmRlclRhcmdldChpLCA0LCBuKSwgdC5yZW5kZXIoZSwgaCksIGkudGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSB5LCB0LnNldFJlbmRlclRhcmdldChpLCA1LCBuKSwgdC5yZW5kZXIoZSwgYyksIHQuc2V0UmVuZGVyVGFyZ2V0KHUsIGQsIHApLCB0LnhyLmVuYWJsZWQgPSBmLCBpLnRleHR1cmUubmVlZHNQTVJFTVVwZGF0ZSA9ICEwOwogIH0KfQpjbGFzcyBPbyBleHRlbmRzIE5lIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGN1YmUgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8SW1hZ2U+fSBbaW1hZ2VzPVtdXSAtIEFuIGFycmF5IGhvbGRpbmcgYSBpbWFnZSBmb3IgZWFjaCBzaWRlIG9mIGEgY3ViZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21hcHBpbmc9Q3ViZVJlZmxlY3Rpb25NYXBwaW5nXSAtIFRoZSB0ZXh0dXJlIG1hcHBpbmcuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwUz1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwUyB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dyYXBUPUNsYW1wVG9FZGdlV3JhcHBpbmddIC0gVGhlIHdyYXBUIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFnRmlsdGVyPUxpbmVhckZpbHRlcl0gLSBUaGUgbWFnIGZpbHRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21pbkZpbHRlcj1MaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXJdIC0gVGhlIG1pbiBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtmb3JtYXQ9UkdCQUZvcm1hdF0gLSBUaGUgdGV4dHVyZSBmb3JtYXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0eXBlPVVuc2lnbmVkQnl0ZVR5cGVdIC0gVGhlIHRleHR1cmUgdHlwZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FuaXNvdHJvcHk9VGV4dHVyZS5ERUZBVUxUX0FOSVNPVFJPUFldIC0gVGhlIGFuaXNvdHJvcHkgdmFsdWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPU5vQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UgdmFsdWUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IFtdLCBlID0gaXMsIGksIG4sIHMsIHIsIG8sIGwsIGgsIGMpIHsKICAgIHN1cGVyKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgsIGMpLCB0aGlzLmlzQ3ViZVRleHR1cmUgPSAhMCwgdGhpcy5mbGlwWSA9ICExOwogIH0KICAvKioKICAgKiBBbGlhcyBmb3Ige0BsaW5rIEN1YmVUZXh0dXJlI2ltYWdlfS4KICAgKgogICAqIEB0eXBlIHtBcnJheTxJbWFnZT59CiAgICovCiAgZ2V0IGltYWdlcygpIHsKICAgIHJldHVybiB0aGlzLmltYWdlOwogIH0KICBzZXQgaW1hZ2VzKHQpIHsKICAgIHRoaXMuaW1hZ2UgPSB0OwogIH0KfQpjbGFzcyBFeSBleHRlbmRzIFJuIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGN1YmUgcmVuZGVyIHRhcmdldC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xXSAtIFRoZSBzaXplIG9mIHRoZSByZW5kZXIgdGFyZ2V0LgogICAqIEBwYXJhbSB7UmVuZGVyVGFyZ2V0fk9wdGlvbnN9IFtvcHRpb25zXSAtIFRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMSwgZSA9IHt9KSB7CiAgICBzdXBlcih0LCB0LCBlKSwgdGhpcy5pc1dlYkdMQ3ViZVJlbmRlclRhcmdldCA9ICEwOwogICAgY29uc3QgaSA9IHsgd2lkdGg6IHQsIGhlaWdodDogdCwgZGVwdGg6IDEgfSwgbiA9IFtpLCBpLCBpLCBpLCBpLCBpXTsKICAgIHRoaXMudGV4dHVyZSA9IG5ldyBPbyhuKSwgdGhpcy5fc2V0VGV4dHVyZU9wdGlvbnMoZSksIHRoaXMudGV4dHVyZS5pc1JlbmRlclRhcmdldFRleHR1cmUgPSAhMDsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIGVxdWlyZWN0YW5ndWxhciB0ZXh0dXJlIHRvIGEgY3ViZSBtYXAuCiAgICoKICAgKiBAcGFyYW0ge1dlYkdMUmVuZGVyZXJ9IHJlbmRlcmVyIC0gVGhlIHJlbmRlcmVyLgogICAqIEBwYXJhbSB7VGV4dHVyZX0gdGV4dHVyZSAtIFRoZSBlcXVpcmVjdGFuZ3VsYXIgdGV4dHVyZS4KICAgKiBAcmV0dXJuIHtXZWJHTEN1YmVSZW5kZXJUYXJnZXR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY3ViZSByZW5kZXIgdGFyZ2V0LgogICAqLwogIGZyb21FcXVpcmVjdGFuZ3VsYXJUZXh0dXJlKHQsIGUpIHsKICAgIHRoaXMudGV4dHVyZS50eXBlID0gZS50eXBlLCB0aGlzLnRleHR1cmUuY29sb3JTcGFjZSA9IGUuY29sb3JTcGFjZSwgdGhpcy50ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyA9IGUuZ2VuZXJhdGVNaXBtYXBzLCB0aGlzLnRleHR1cmUubWluRmlsdGVyID0gZS5taW5GaWx0ZXIsIHRoaXMudGV4dHVyZS5tYWdGaWx0ZXIgPSBlLm1hZ0ZpbHRlcjsKICAgIGNvbnN0IGkgPSB7CiAgICAgIHVuaWZvcm1zOiB7CiAgICAgICAgdEVxdWlyZWN0OiB7IHZhbHVlOiBudWxsIH0KICAgICAgfSwKICAgICAgdmVydGV4U2hhZGVyOiAoCiAgICAgICAgLyogZ2xzbCAqLwogICAgICAgIGAKCgkJCQl2YXJ5aW5nIHZlYzMgdldvcmxkRGlyZWN0aW9uOwoKCQkJCXZlYzMgdHJhbnNmb3JtRGlyZWN0aW9uKCBpbiB2ZWMzIGRpciwgaW4gbWF0NCBtYXRyaXggKSB7CgoJCQkJCXJldHVybiBub3JtYWxpemUoICggbWF0cml4ICogdmVjNCggZGlyLCAwLjAgKSApLnh5eiApOwoKCQkJCX0KCgkJCQl2b2lkIG1haW4oKSB7CgoJCQkJCXZXb3JsZERpcmVjdGlvbiA9IHRyYW5zZm9ybURpcmVjdGlvbiggcG9zaXRpb24sIG1vZGVsTWF0cml4ICk7CgoJCQkJCSNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CgkJCQkJI2luY2x1ZGUgPHByb2plY3RfdmVydGV4PgoKCQkJCX0KCQkJYAogICAgICApLAogICAgICBmcmFnbWVudFNoYWRlcjogKAogICAgICAgIC8qIGdsc2wgKi8KICAgICAgICBgCgoJCQkJdW5pZm9ybSBzYW1wbGVyMkQgdEVxdWlyZWN0OwoKCQkJCXZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247CgoJCQkJI2luY2x1ZGUgPGNvbW1vbj4KCgkJCQl2b2lkIG1haW4oKSB7CgoJCQkJCXZlYzMgZGlyZWN0aW9uID0gbm9ybWFsaXplKCB2V29ybGREaXJlY3Rpb24gKTsKCgkJCQkJdmVjMiBzYW1wbGVVViA9IGVxdWlyZWN0VXYoIGRpcmVjdGlvbiApOwoKCQkJCQlnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQoIHRFcXVpcmVjdCwgc2FtcGxlVVYgKTsKCgkJCQl9CgkJCWAKICAgICAgKQogICAgfSwgbiA9IG5ldyBtcig1LCA1LCA1KSwgcyA9IG5ldyBYaSh7CiAgICAgIG5hbWU6ICJDdWJlbWFwRnJvbUVxdWlyZWN0IiwKICAgICAgdW5pZm9ybXM6IF9hKGkudW5pZm9ybXMpLAogICAgICB2ZXJ0ZXhTaGFkZXI6IGkudmVydGV4U2hhZGVyLAogICAgICBmcmFnbWVudFNoYWRlcjogaS5mcmFnbWVudFNoYWRlciwKICAgICAgc2lkZTogSGUsCiAgICAgIGJsZW5kaW5nOiBZbgogICAgfSk7CiAgICBzLnVuaWZvcm1zLnRFcXVpcmVjdC52YWx1ZSA9IGU7CiAgICBjb25zdCByID0gbmV3IHJlKG4sIHMpLCBvID0gZS5taW5GaWx0ZXI7CiAgICByZXR1cm4gZS5taW5GaWx0ZXIgPT09IEVuICYmIChlLm1pbkZpbHRlciA9IENlKSwgbmV3IEF5KDEsIDEwLCB0aGlzKS51cGRhdGUodCwgciksIGUubWluRmlsdGVyID0gbywgci5nZW9tZXRyeS5kaXNwb3NlKCksIHIubWF0ZXJpYWwuZGlzcG9zZSgpLCB0aGlzOwogIH0KICAvKioKICAgKiBDbGVhcnMgdGhpcyBjdWJlIHJlbmRlciB0YXJnZXQuCiAgICoKICAgKiBAcGFyYW0ge1dlYkdMUmVuZGVyZXJ9IHJlbmRlcmVyIC0gVGhlIHJlbmRlcmVyLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NvbG9yPXRydWVdIC0gV2hldGhlciB0aGUgY29sb3IgYnVmZmVyIHNob3VsZCBiZSBjbGVhcmVkIG9yIG5vdC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtkZXB0aD10cnVlXSAtIFdoZXRoZXIgdGhlIGRlcHRoIGJ1ZmZlciBzaG91bGQgYmUgY2xlYXJlZCBvciBub3QuCiAgICogQHBhcmFtIHtib29sZWFufSBbc3RlbmNpbD10cnVlXSAtIFdoZXRoZXIgdGhlIHN0ZW5jaWwgYnVmZmVyIHNob3VsZCBiZSBjbGVhcmVkIG9yIG5vdC4KICAgKi8KICBjbGVhcih0LCBlID0gITAsIGkgPSAhMCwgbiA9ICEwKSB7CiAgICBjb25zdCBzID0gdC5nZXRSZW5kZXJUYXJnZXQoKTsKICAgIGZvciAobGV0IHIgPSAwOyByIDwgNjsgcisrKQogICAgICB0LnNldFJlbmRlclRhcmdldCh0aGlzLCByKSwgdC5jbGVhcihlLCBpLCBuKTsKICAgIHQuc2V0UmVuZGVyVGFyZ2V0KHMpOwogIH0KfQpsZXQgeWkgPSBjbGFzcyBleHRlbmRzIGxlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNHcm91cCA9ICEwLCB0aGlzLnR5cGUgPSAiR3JvdXAiOwogIH0KfTsKY29uc3QgVnYgPSB7IHR5cGU6ICJtb3ZlIiB9OwpjbGFzcyBUaCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBYUiBjb250cm9sbGVyLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fdGFyZ2V0UmF5ID0gbnVsbCwgdGhpcy5fZ3JpcCA9IG51bGwsIHRoaXMuX2hhbmQgPSBudWxsOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgZ3JvdXAgcmVwcmVzZW50aW5nIHRoZSBoYW5kIHNwYWNlIG9mIHRoZSBYUiBjb250cm9sbGVyLgogICAqCiAgICogQHJldHVybiB7R3JvdXB9IEEgZ3JvdXAgcmVwcmVzZW50aW5nIHRoZSBoYW5kIHNwYWNlIG9mIHRoZSBYUiBjb250cm9sbGVyLgogICAqLwogIGdldEhhbmRTcGFjZSgpIHsKICAgIHJldHVybiB0aGlzLl9oYW5kID09PSBudWxsICYmICh0aGlzLl9oYW5kID0gbmV3IHlpKCksIHRoaXMuX2hhbmQubWF0cml4QXV0b1VwZGF0ZSA9ICExLCB0aGlzLl9oYW5kLnZpc2libGUgPSAhMSwgdGhpcy5faGFuZC5qb2ludHMgPSB7fSwgdGhpcy5faGFuZC5pbnB1dFN0YXRlID0geyBwaW5jaGluZzogITEgfSksIHRoaXMuX2hhbmQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBncm91cCByZXByZXNlbnRpbmcgdGhlIHRhcmdldCByYXkgc3BhY2Ugb2YgdGhlIFhSIGNvbnRyb2xsZXIuCiAgICoKICAgKiBAcmV0dXJuIHtHcm91cH0gQSBncm91cCByZXByZXNlbnRpbmcgdGhlIHRhcmdldCByYXkgc3BhY2Ugb2YgdGhlIFhSIGNvbnRyb2xsZXIuCiAgICovCiAgZ2V0VGFyZ2V0UmF5U3BhY2UoKSB7CiAgICByZXR1cm4gdGhpcy5fdGFyZ2V0UmF5ID09PSBudWxsICYmICh0aGlzLl90YXJnZXRSYXkgPSBuZXcgeWkoKSwgdGhpcy5fdGFyZ2V0UmF5Lm1hdHJpeEF1dG9VcGRhdGUgPSAhMSwgdGhpcy5fdGFyZ2V0UmF5LnZpc2libGUgPSAhMSwgdGhpcy5fdGFyZ2V0UmF5Lmhhc0xpbmVhclZlbG9jaXR5ID0gITEsIHRoaXMuX3RhcmdldFJheS5saW5lYXJWZWxvY2l0eSA9IG5ldyBFKCksIHRoaXMuX3RhcmdldFJheS5oYXNBbmd1bGFyVmVsb2NpdHkgPSAhMSwgdGhpcy5fdGFyZ2V0UmF5LmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBFKCkpLCB0aGlzLl90YXJnZXRSYXk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBncm91cCByZXByZXNlbnRpbmcgdGhlIGdyaXAgc3BhY2Ugb2YgdGhlIFhSIGNvbnRyb2xsZXIuCiAgICoKICAgKiBAcmV0dXJuIHtHcm91cH0gQSBncm91cCByZXByZXNlbnRpbmcgdGhlIGdyaXAgc3BhY2Ugb2YgdGhlIFhSIGNvbnRyb2xsZXIuCiAgICovCiAgZ2V0R3JpcFNwYWNlKCkgewogICAgcmV0dXJuIHRoaXMuX2dyaXAgPT09IG51bGwgJiYgKHRoaXMuX2dyaXAgPSBuZXcgeWkoKSwgdGhpcy5fZ3JpcC5tYXRyaXhBdXRvVXBkYXRlID0gITEsIHRoaXMuX2dyaXAudmlzaWJsZSA9ICExLCB0aGlzLl9ncmlwLmhhc0xpbmVhclZlbG9jaXR5ID0gITEsIHRoaXMuX2dyaXAubGluZWFyVmVsb2NpdHkgPSBuZXcgRSgpLCB0aGlzLl9ncmlwLmhhc0FuZ3VsYXJWZWxvY2l0eSA9ICExLCB0aGlzLl9ncmlwLmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBFKCkpLCB0aGlzLl9ncmlwOwogIH0KICAvKioKICAgKiBEaXNwYXRjaGVzIHRoZSBnaXZlbiBldmVudCB0byB0aGUgZ3JvdXBzIHJlcHJlc2VudGluZwogICAqIHRoZSBkaWZmZXJlbnQgY29vcmRpbmF0ZSBzcGFjZXMgb2YgdGhlIFhSIGNvbnRyb2xsZXIuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgdG8gZGlzcGF0Y2guCiAgICogQHJldHVybiB7V2ViWFJDb250cm9sbGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIGRpc3BhdGNoRXZlbnQodCkgewogICAgcmV0dXJuIHRoaXMuX3RhcmdldFJheSAhPT0gbnVsbCAmJiB0aGlzLl90YXJnZXRSYXkuZGlzcGF0Y2hFdmVudCh0KSwgdGhpcy5fZ3JpcCAhPT0gbnVsbCAmJiB0aGlzLl9ncmlwLmRpc3BhdGNoRXZlbnQodCksIHRoaXMuX2hhbmQgIT09IG51bGwgJiYgdGhpcy5faGFuZC5kaXNwYXRjaEV2ZW50KHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBDb25uZWN0cyB0aGUgY29udHJvbGxlciB3aXRoIHRoZSBnaXZlbiBYUiBpbnB1dCBzb3VyY2UuCiAgICoKICAgKiBAcGFyYW0ge1hSSW5wdXRTb3VyY2V9IGlucHV0U291cmNlIC0gVGhlIGlucHV0IHNvdXJjZS4KICAgKiBAcmV0dXJuIHtXZWJYUkNvbnRyb2xsZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY29ubmVjdCh0KSB7CiAgICBpZiAodCAmJiB0LmhhbmQpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuX2hhbmQ7CiAgICAgIGlmIChlKQogICAgICAgIGZvciAoY29uc3QgaSBvZiB0LmhhbmQudmFsdWVzKCkpCiAgICAgICAgICB0aGlzLl9nZXRIYW5kSm9pbnQoZSwgaSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5kaXNwYXRjaEV2ZW50KHsgdHlwZTogImNvbm5lY3RlZCIsIGRhdGE6IHQgfSksIHRoaXM7CiAgfQogIC8qKgogICAqIERpc2Nvbm5lY3RzIHRoZSBjb250cm9sbGVyIGZyb20gdGhlIGdpdmVuIFhSIGlucHV0IHNvdXJjZS4KICAgKgogICAqIEBwYXJhbSB7WFJJbnB1dFNvdXJjZX0gaW5wdXRTb3VyY2UgLSBUaGUgaW5wdXQgc291cmNlLgogICAqIEByZXR1cm4ge1dlYlhSQ29udHJvbGxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBkaXNjb25uZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAiZGlzY29ubmVjdGVkIiwgZGF0YTogdCB9KSwgdGhpcy5fdGFyZ2V0UmF5ICE9PSBudWxsICYmICh0aGlzLl90YXJnZXRSYXkudmlzaWJsZSA9ICExKSwgdGhpcy5fZ3JpcCAhPT0gbnVsbCAmJiAodGhpcy5fZ3JpcC52aXNpYmxlID0gITEpLCB0aGlzLl9oYW5kICE9PSBudWxsICYmICh0aGlzLl9oYW5kLnZpc2libGUgPSAhMSksIHRoaXM7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIGNvbnRyb2xsZXIgd2l0aCB0aGUgZ2l2ZW4gaW5wdXQgc291cmNlLCBYUiBmcmFtZSBhbmQgcmVmZXJlbmNlIHNwYWNlLgogICAqIFRoaXMgdXBkYXRlcyB0aGUgdHJhbnNmb3JtYXRpb25zIG9mIHRoZSBncm91cHMgdGhhdCByZXByZXNlbnQgdGhlIGRpZmZlcmVudAogICAqIGNvb3JkaW5hdGUgc3lzdGVtcyBvZiB0aGUgY29udHJvbGxlci4KICAgKgogICAqIEBwYXJhbSB7WFJJbnB1dFNvdXJjZX0gaW5wdXRTb3VyY2UgLSBUaGUgaW5wdXQgc291cmNlLgogICAqIEBwYXJhbSB7WFJGcmFtZX0gZnJhbWUgLSBUaGUgWFIgZnJhbWUuCiAgICogQHBhcmFtIHtYUlJlZmVyZW5jZVNwYWNlfSByZWZlcmVuY2VTcGFjZSAtIFRoZSByZWZlcmVuY2Ugc3BhY2UuCiAgICogQHJldHVybiB7V2ViWFJDb250cm9sbGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHVwZGF0ZSh0LCBlLCBpKSB7CiAgICBsZXQgbiA9IG51bGwsIHMgPSBudWxsLCByID0gbnVsbDsKICAgIGNvbnN0IG8gPSB0aGlzLl90YXJnZXRSYXksIGwgPSB0aGlzLl9ncmlwLCBoID0gdGhpcy5faGFuZDsKICAgIGlmICh0ICYmIGUuc2Vzc2lvbi52aXNpYmlsaXR5U3RhdGUgIT09ICJ2aXNpYmxlLWJsdXJyZWQiKSB7CiAgICAgIGlmIChoICYmIHQuaGFuZCkgewogICAgICAgIHIgPSAhMDsKICAgICAgICBmb3IgKGNvbnN0IHkgb2YgdC5oYW5kLnZhbHVlcygpKSB7CiAgICAgICAgICBjb25zdCBnID0gZS5nZXRKb2ludFBvc2UoeSwgaSksIG0gPSB0aGlzLl9nZXRIYW5kSm9pbnQoaCwgeSk7CiAgICAgICAgICBnICE9PSBudWxsICYmIChtLm1hdHJpeC5mcm9tQXJyYXkoZy50cmFuc2Zvcm0ubWF0cml4KSwgbS5tYXRyaXguZGVjb21wb3NlKG0ucG9zaXRpb24sIG0ucm90YXRpb24sIG0uc2NhbGUpLCBtLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSAhMCwgbS5qb2ludFJhZGl1cyA9IGcucmFkaXVzKSwgbS52aXNpYmxlID0gZyAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgY29uc3QgYyA9IGguam9pbnRzWyJpbmRleC1maW5nZXItdGlwIl0sIHUgPSBoLmpvaW50c1sidGh1bWItdGlwIl0sIGQgPSBjLnBvc2l0aW9uLmRpc3RhbmNlVG8odS5wb3NpdGlvbiksIHAgPSAwLjAyLCBmID0gNWUtMzsKICAgICAgICBoLmlucHV0U3RhdGUucGluY2hpbmcgJiYgZCA+IHAgKyBmID8gKGguaW5wdXRTdGF0ZS5waW5jaGluZyA9ICExLCB0aGlzLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgdHlwZTogInBpbmNoZW5kIiwKICAgICAgICAgIGhhbmRlZG5lc3M6IHQuaGFuZGVkbmVzcywKICAgICAgICAgIHRhcmdldDogdGhpcwogICAgICAgIH0pKSA6ICFoLmlucHV0U3RhdGUucGluY2hpbmcgJiYgZCA8PSBwIC0gZiAmJiAoaC5pbnB1dFN0YXRlLnBpbmNoaW5nID0gITAsIHRoaXMuZGlzcGF0Y2hFdmVudCh7CiAgICAgICAgICB0eXBlOiAicGluY2hzdGFydCIsCiAgICAgICAgICBoYW5kZWRuZXNzOiB0LmhhbmRlZG5lc3MsCiAgICAgICAgICB0YXJnZXQ6IHRoaXMKICAgICAgICB9KSk7CiAgICAgIH0gZWxzZQogICAgICAgIGwgIT09IG51bGwgJiYgdC5ncmlwU3BhY2UgJiYgKHMgPSBlLmdldFBvc2UodC5ncmlwU3BhY2UsIGkpLCBzICE9PSBudWxsICYmIChsLm1hdHJpeC5mcm9tQXJyYXkocy50cmFuc2Zvcm0ubWF0cml4KSwgbC5tYXRyaXguZGVjb21wb3NlKGwucG9zaXRpb24sIGwucm90YXRpb24sIGwuc2NhbGUpLCBsLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSAhMCwgcy5saW5lYXJWZWxvY2l0eSA/IChsLmhhc0xpbmVhclZlbG9jaXR5ID0gITAsIGwubGluZWFyVmVsb2NpdHkuY29weShzLmxpbmVhclZlbG9jaXR5KSkgOiBsLmhhc0xpbmVhclZlbG9jaXR5ID0gITEsIHMuYW5ndWxhclZlbG9jaXR5ID8gKGwuaGFzQW5ndWxhclZlbG9jaXR5ID0gITAsIGwuYW5ndWxhclZlbG9jaXR5LmNvcHkocy5hbmd1bGFyVmVsb2NpdHkpKSA6IGwuaGFzQW5ndWxhclZlbG9jaXR5ID0gITEpKTsKICAgICAgbyAhPT0gbnVsbCAmJiAobiA9IGUuZ2V0UG9zZSh0LnRhcmdldFJheVNwYWNlLCBpKSwgbiA9PT0gbnVsbCAmJiBzICE9PSBudWxsICYmIChuID0gcyksIG4gIT09IG51bGwgJiYgKG8ubWF0cml4LmZyb21BcnJheShuLnRyYW5zZm9ybS5tYXRyaXgpLCBvLm1hdHJpeC5kZWNvbXBvc2Uoby5wb3NpdGlvbiwgby5yb3RhdGlvbiwgby5zY2FsZSksIG8ubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9ICEwLCBuLmxpbmVhclZlbG9jaXR5ID8gKG8uaGFzTGluZWFyVmVsb2NpdHkgPSAhMCwgby5saW5lYXJWZWxvY2l0eS5jb3B5KG4ubGluZWFyVmVsb2NpdHkpKSA6IG8uaGFzTGluZWFyVmVsb2NpdHkgPSAhMSwgbi5hbmd1bGFyVmVsb2NpdHkgPyAoby5oYXNBbmd1bGFyVmVsb2NpdHkgPSAhMCwgby5hbmd1bGFyVmVsb2NpdHkuY29weShuLmFuZ3VsYXJWZWxvY2l0eSkpIDogby5oYXNBbmd1bGFyVmVsb2NpdHkgPSAhMSwgdGhpcy5kaXNwYXRjaEV2ZW50KFZ2KSkpOwogICAgfQogICAgcmV0dXJuIG8gIT09IG51bGwgJiYgKG8udmlzaWJsZSA9IG4gIT09IG51bGwpLCBsICE9PSBudWxsICYmIChsLnZpc2libGUgPSBzICE9PSBudWxsKSwgaCAhPT0gbnVsbCAmJiAoaC52aXNpYmxlID0gciAhPT0gbnVsbCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBncm91cCByZXByZXNlbnRpbmcgdGhlIGhhbmQgam9pbnQgZm9yIHRoZSBnaXZlbiBpbnB1dCBqb2ludC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtHcm91cH0gaGFuZCAtIFRoZSBncm91cCByZXByZXNlbnRpbmcgdGhlIGhhbmQgc3BhY2UuCiAgICogQHBhcmFtIHtYUkpvaW50U3BhY2V9IGlucHV0am9pbnQgLSBUaGUgaGFuZCBqb2ludCBkYXRhLgogICAqIEByZXR1cm4ge0dyb3VwfSBBIGdyb3VwIHJlcHJlc2VudGluZyB0aGUgaGFuZCBqb2ludCBmb3IgdGhlIGdpdmVuIGlucHV0IGpvaW50LgogICAqLwogIF9nZXRIYW5kSm9pbnQodCwgZSkgewogICAgaWYgKHQuam9pbnRzW2Uuam9pbnROYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGkgPSBuZXcgeWkoKTsKICAgICAgaS5tYXRyaXhBdXRvVXBkYXRlID0gITEsIGkudmlzaWJsZSA9ICExLCB0LmpvaW50c1tlLmpvaW50TmFtZV0gPSBpLCB0LmFkZChpKTsKICAgIH0KICAgIHJldHVybiB0LmpvaW50c1tlLmpvaW50TmFtZV07CiAgfQp9CmNsYXNzIFZjIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGZvZy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfENvbG9yfSBjb2xvciAtIFRoZSBmb2cncyBjb2xvci4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlbnNpdHk9MC4wMDAyNV0gLSBEZWZpbmVzIGhvdyBmYXN0IHRoZSBmb2cgd2lsbCBncm93IGRlbnNlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUgPSAyNWUtNSkgewogICAgdGhpcy5pc0ZvZ0V4cDIgPSAhMCwgdGhpcy5uYW1lID0gIiIsIHRoaXMuY29sb3IgPSBuZXcgY3QodCksIHRoaXMuZGVuc2l0eSA9IGU7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgZm9nIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtGb2dFeHAyfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IFZjKHRoaXMuY29sb3IsIHRoaXMuZGVuc2l0eSk7CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIGZvZyBpbnRvIEpTT04uCiAgICoKICAgKiBAcGFyYW0gez8oT2JqZWN0fHN0cmluZyl9IG1ldGEgLSBBbiBvcHRpb25hbCB2YWx1ZSBob2xkaW5nIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlcmlhbGl6YXRpb24uCiAgICogQHJldHVybiB7T2JqZWN0fSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBmb2cKICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAiRm9nRXhwMiIsCiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgY29sb3I6IHRoaXMuY29sb3IuZ2V0SGV4KCksCiAgICAgIGRlbnNpdHk6IHRoaXMuZGVuc2l0eQogICAgfTsKICB9Cn0KY2xhc3MgSGMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgZm9nLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ8Q29sb3J9IGNvbG9yIC0gVGhlIGZvZydzIGNvbG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbmVhcj0xXSAtIFRoZSBtaW5pbXVtIGRpc3RhbmNlIHRvIHN0YXJ0IGFwcGx5aW5nIGZvZy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2Zhcj0xMDAwXSAtIFRoZSBtYXhpbXVtIGRpc3RhbmNlIGF0IHdoaWNoIGZvZyBzdG9wcyBiZWluZyBjYWxjdWxhdGVkIGFuZCBhcHBsaWVkLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUgPSAxLCBpID0gMWUzKSB7CiAgICB0aGlzLmlzRm9nID0gITAsIHRoaXMubmFtZSA9ICIiLCB0aGlzLmNvbG9yID0gbmV3IGN0KHQpLCB0aGlzLm5lYXIgPSBlLCB0aGlzLmZhciA9IGk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgZm9nIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtGb2d9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgSGModGhpcy5jb2xvciwgdGhpcy5uZWFyLCB0aGlzLmZhcik7CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIGZvZyBpbnRvIEpTT04uCiAgICoKICAgKiBAcGFyYW0gez8oT2JqZWN0fHN0cmluZyl9IG1ldGEgLSBBbiBvcHRpb25hbCB2YWx1ZSBob2xkaW5nIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlcmlhbGl6YXRpb24uCiAgICogQHJldHVybiB7T2JqZWN0fSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBmb2cKICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAiRm9nIiwKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBjb2xvcjogdGhpcy5jb2xvci5nZXRIZXgoKSwKICAgICAgbmVhcjogdGhpcy5uZWFyLAogICAgICBmYXI6IHRoaXMuZmFyCiAgICB9OwogIH0KfQpjbGFzcyBrbyBleHRlbmRzIGxlIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHNjZW5lLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc1NjZW5lID0gITAsIHRoaXMudHlwZSA9ICJTY2VuZSIsIHRoaXMuYmFja2dyb3VuZCA9IG51bGwsIHRoaXMuZW52aXJvbm1lbnQgPSBudWxsLCB0aGlzLmZvZyA9IG51bGwsIHRoaXMuYmFja2dyb3VuZEJsdXJyaW5lc3MgPSAwLCB0aGlzLmJhY2tncm91bmRJbnRlbnNpdHkgPSAxLCB0aGlzLmJhY2tncm91bmRSb3RhdGlvbiA9IG5ldyBmbigpLCB0aGlzLmVudmlyb25tZW50SW50ZW5zaXR5ID0gMSwgdGhpcy5lbnZpcm9ubWVudFJvdGF0aW9uID0gbmV3IGZuKCksIHRoaXMub3ZlcnJpZGVNYXRlcmlhbCA9IG51bGwsIHR5cGVvZiBfX1RIUkVFX0RFVlRPT0xTX18gPCAidSIgJiYgX19USFJFRV9ERVZUT09MU19fLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCJvYnNlcnZlIiwgeyBkZXRhaWw6IHRoaXMgfSkpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0LmJhY2tncm91bmQgIT09IG51bGwgJiYgKHRoaXMuYmFja2dyb3VuZCA9IHQuYmFja2dyb3VuZC5jbG9uZSgpKSwgdC5lbnZpcm9ubWVudCAhPT0gbnVsbCAmJiAodGhpcy5lbnZpcm9ubWVudCA9IHQuZW52aXJvbm1lbnQuY2xvbmUoKSksIHQuZm9nICE9PSBudWxsICYmICh0aGlzLmZvZyA9IHQuZm9nLmNsb25lKCkpLCB0aGlzLmJhY2tncm91bmRCbHVycmluZXNzID0gdC5iYWNrZ3JvdW5kQmx1cnJpbmVzcywgdGhpcy5iYWNrZ3JvdW5kSW50ZW5zaXR5ID0gdC5iYWNrZ3JvdW5kSW50ZW5zaXR5LCB0aGlzLmJhY2tncm91bmRSb3RhdGlvbi5jb3B5KHQuYmFja2dyb3VuZFJvdGF0aW9uKSwgdGhpcy5lbnZpcm9ubWVudEludGVuc2l0eSA9IHQuZW52aXJvbm1lbnRJbnRlbnNpdHksIHRoaXMuZW52aXJvbm1lbnRSb3RhdGlvbi5jb3B5KHQuZW52aXJvbm1lbnRSb3RhdGlvbiksIHQub3ZlcnJpZGVNYXRlcmlhbCAhPT0gbnVsbCAmJiAodGhpcy5vdmVycmlkZU1hdGVyaWFsID0gdC5vdmVycmlkZU1hdGVyaWFsLmNsb25lKCkpLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSB0Lm1hdHJpeEF1dG9VcGRhdGUsIHRoaXM7CiAgfQogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gc3VwZXIudG9KU09OKHQpOwogICAgcmV0dXJuIHRoaXMuZm9nICE9PSBudWxsICYmIChlLm9iamVjdC5mb2cgPSB0aGlzLmZvZy50b0pTT04oKSksIHRoaXMuYmFja2dyb3VuZEJsdXJyaW5lc3MgPiAwICYmIChlLm9iamVjdC5iYWNrZ3JvdW5kQmx1cnJpbmVzcyA9IHRoaXMuYmFja2dyb3VuZEJsdXJyaW5lc3MpLCB0aGlzLmJhY2tncm91bmRJbnRlbnNpdHkgIT09IDEgJiYgKGUub2JqZWN0LmJhY2tncm91bmRJbnRlbnNpdHkgPSB0aGlzLmJhY2tncm91bmRJbnRlbnNpdHkpLCBlLm9iamVjdC5iYWNrZ3JvdW5kUm90YXRpb24gPSB0aGlzLmJhY2tncm91bmRSb3RhdGlvbi50b0FycmF5KCksIHRoaXMuZW52aXJvbm1lbnRJbnRlbnNpdHkgIT09IDEgJiYgKGUub2JqZWN0LmVudmlyb25tZW50SW50ZW5zaXR5ID0gdGhpcy5lbnZpcm9ubWVudEludGVuc2l0eSksIGUub2JqZWN0LmVudmlyb25tZW50Um90YXRpb24gPSB0aGlzLmVudmlyb25tZW50Um90YXRpb24udG9BcnJheSgpLCBlOwogIH0KfQpsZXQgR2MgPSBjbGFzcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBpbnRlcmxlYXZlZCBidWZmZXIuCiAgICoKICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IGFycmF5IC0gQSB0eXBlZCBhcnJheSB3aXRoIGEgc2hhcmVkIGJ1ZmZlciBzdG9yaW5nIGF0dHJpYnV0ZSBkYXRhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdHJpZGUgLSBUaGUgbnVtYmVyIG9mIHR5cGVkLWFycmF5IGVsZW1lbnRzIHBlciB2ZXJ0ZXguCiAgICovCiAgY29uc3RydWN0b3IodCwgZSkgewogICAgdGhpcy5pc0ludGVybGVhdmVkQnVmZmVyID0gITAsIHRoaXMuYXJyYXkgPSB0LCB0aGlzLnN0cmlkZSA9IGUsIHRoaXMuY291bnQgPSB0ICE9PSB2b2lkIDAgPyB0Lmxlbmd0aCAvIGUgOiAwLCB0aGlzLnVzYWdlID0gQ28sIHRoaXMudXBkYXRlUmFuZ2VzID0gW10sIHRoaXMudmVyc2lvbiA9IDAsIHRoaXMudXVpZCA9IE9pKCk7CiAgfQogIC8qKgogICAqIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBleGVjdXRlZCBhZnRlciB0aGUgcmVuZGVyZXIgaGFzIHRyYW5zZmVycmVkIHRoZSBhdHRyaWJ1dGUgYXJyYXkKICAgKiBkYXRhIHRvIHRoZSBHUFUuCiAgICovCiAgb25VcGxvYWRDYWxsYmFjaygpIHsKICB9CiAgLyoqCiAgICogRmxhZyB0byBpbmRpY2F0ZSB0aGF0IHRoaXMgYXR0cmlidXRlIGhhcyBjaGFuZ2VkIGFuZCBzaG91bGQgYmUgcmUtc2VudCB0bwogICAqIHRoZSBHUFUuIFNldCB0aGlzIHRvIGB0cnVlYCB3aGVuIHlvdSBtb2RpZnkgdGhlIHZhbHVlIG9mIHRoZSBhcnJheS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgZmFsc2UKICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAgICovCiAgc2V0IG5lZWRzVXBkYXRlKHQpIHsKICAgIHQgPT09ICEwICYmIHRoaXMudmVyc2lvbisrOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB1c2FnZSBvZiB0aGlzIGludGVybGVhdmVkIGJ1ZmZlci4KICAgKgogICAqIEBwYXJhbSB7KFN0YXRpY0RyYXdVc2FnZXxEeW5hbWljRHJhd1VzYWdlfFN0cmVhbURyYXdVc2FnZXxTdGF0aWNSZWFkVXNhZ2V8RHluYW1pY1JlYWRVc2FnZXxTdHJlYW1SZWFkVXNhZ2V8U3RhdGljQ29weVVzYWdlfER5bmFtaWNDb3B5VXNhZ2V8U3RyZWFtQ29weVVzYWdlKX0gdmFsdWUgLSBUaGUgdXNhZ2UgdG8gc2V0LgogICAqIEByZXR1cm4ge0ludGVybGVhdmVkQnVmZmVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGludGVybGVhdmVkIGJ1ZmZlci4KICAgKi8KICBzZXRVc2FnZSh0KSB7CiAgICByZXR1cm4gdGhpcy51c2FnZSA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgYSByYW5nZSBvZiBkYXRhIGluIHRoZSBkYXRhIGFycmF5IHRvIGJlIHVwZGF0ZWQgb24gdGhlIEdQVS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFBvc2l0aW9uIGF0IHdoaWNoIHRvIHN0YXJ0IHVwZGF0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gY291bnQgLSBUaGUgbnVtYmVyIG9mIGNvbXBvbmVudHMgdG8gdXBkYXRlLgogICAqLwogIGFkZFVwZGF0ZVJhbmdlKHQsIGUpIHsKICAgIHRoaXMudXBkYXRlUmFuZ2VzLnB1c2goeyBzdGFydDogdCwgY291bnQ6IGUgfSk7CiAgfQogIC8qKgogICAqIENsZWFycyB0aGUgdXBkYXRlIHJhbmdlcy4KICAgKi8KICBjbGVhclVwZGF0ZVJhbmdlcygpIHsKICAgIHRoaXMudXBkYXRlUmFuZ2VzLmxlbmd0aCA9IDA7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBpbnRlcmxlYXZlZCBidWZmZXIgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7SW50ZXJsZWF2ZWRCdWZmZXJ9IHNvdXJjZSAtIFRoZSBpbnRlcmxlYXZlZCBidWZmZXIgdG8gY29weS4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLmFycmF5ID0gbmV3IHQuYXJyYXkuY29uc3RydWN0b3IodC5hcnJheSksIHRoaXMuY291bnQgPSB0LmNvdW50LCB0aGlzLnN0cmlkZSA9IHQuc3RyaWRlLCB0aGlzLnVzYWdlID0gdC51c2FnZSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29waWVzIGEgdmVjdG9yIGZyb20gdGhlIGdpdmVuIGludGVybGVhdmVkIGJ1ZmZlciB0byB0aGlzIG9uZS4gVGhlIHN0YXJ0CiAgICogYW5kIGRlc3RpbmF0aW9uIHBvc2l0aW9uIGluIHRoZSBhdHRyaWJ1dGUgYnVmZmVycyBhcmUgcmVwcmVzZW50ZWQgYnkgdGhlCiAgICogZ2l2ZW4gaW5kaWNlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleDEgLSBUaGUgZGVzdGluYXRpb24gaW5kZXggaW50byB0aGlzIGludGVybGVhdmVkIGJ1ZmZlci4KICAgKiBAcGFyYW0ge0ludGVybGVhdmVkQnVmZmVyfSBpbnRlcmxlYXZlZEJ1ZmZlciAtIFRoZSBpbnRlcmxlYXZlZCBidWZmZXIgdG8gY29weSBmcm9tLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleDIgLSBUaGUgc291cmNlIGluZGV4IGludG8gdGhlIGdpdmVuIGludGVybGVhdmVkIGJ1ZmZlci4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5QXQodCwgZSwgaSkgewogICAgdCAqPSB0aGlzLnN0cmlkZSwgaSAqPSBlLnN0cmlkZTsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gdGhpcy5zdHJpZGU7IG4gPCBzOyBuKyspCiAgICAgIHRoaXMuYXJyYXlbdCArIG5dID0gZS5hcnJheVtpICsgbl07CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gYXJyYXkgZGF0YSBpbiB0aGUgaW50ZXJsZWF2ZWQgYnVmZmVyLgogICAqCiAgICogQHBhcmFtIHsoVHlwZWRBcnJheXxBcnJheSl9IHZhbHVlIC0gVGhlIGFycmF5IGRhdGEgdG8gc2V0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbiB0aGlzIGludGVybGVhdmVkIGJ1ZmZlcidzIGFycmF5LgogICAqIEByZXR1cm4ge0ludGVybGVhdmVkQnVmZmVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldCh0LCBlID0gMCkgewogICAgcmV0dXJuIHRoaXMuYXJyYXkuc2V0KHQsIGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IGludGVybGVhdmVkIGJ1ZmZlciB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtkYXRhXSAtIEFuIG9iamVjdCB3aXRoIHNoYXJlZCBhcnJheSBidWZmZXJzIHRoYXQgYWxsb3dzIHRvIHJldGFpbiBzaGFyZWQgc3RydWN0dXJlcy4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlcn0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKHQpIHsKICAgIHQuYXJyYXlCdWZmZXJzID09PSB2b2lkIDAgJiYgKHQuYXJyYXlCdWZmZXJzID0ge30pLCB0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCA9PT0gdm9pZCAwICYmICh0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCA9IE9pKCkpLCB0LmFycmF5QnVmZmVyc1t0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZF0gPT09IHZvaWQgMCAmJiAodC5hcnJheUJ1ZmZlcnNbdGhpcy5hcnJheS5idWZmZXIuX3V1aWRdID0gdGhpcy5hcnJheS5zbGljZSgwKS5idWZmZXIpOwogICAgY29uc3QgZSA9IG5ldyB0aGlzLmFycmF5LmNvbnN0cnVjdG9yKHQuYXJyYXlCdWZmZXJzW3RoaXMuYXJyYXkuYnVmZmVyLl91dWlkXSksIGkgPSBuZXcgdGhpcy5jb25zdHJ1Y3RvcihlLCB0aGlzLnN0cmlkZSk7CiAgICByZXR1cm4gaS5zZXRVc2FnZSh0aGlzLnVzYWdlKSwgaTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBleGVjdXRlZCBhZnRlciB0aGUgUmVuZGVyZXIgaGFzIHRyYW5zZmVycmVkCiAgICogdGhlIGFycmF5IGRhdGEgdG8gdGhlIEdQVS4gQ2FuIGJlIHVzZWQgdG8gcGVyZm9ybSBjbGVhbi11cCBvcGVyYXRpb25zIGFmdGVyCiAgICogdGhlIHVwbG9hZCB3aGVuIGRhdGEgYXJlIG5vdCBuZWVkZWQgYW55bW9yZSBvbiB0aGUgQ1BVIHNpZGUuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBgb25VcGxvYWQoKWAgY2FsbGJhY2suCiAgICogQHJldHVybiB7SW50ZXJsZWF2ZWRCdWZmZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgb25VcGxvYWQodCkgewogICAgcmV0dXJuIHRoaXMub25VcGxvYWRDYWxsYmFjayA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIGludGVybGVhdmVkIGJ1ZmZlciBpbnRvIEpTT04uCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW2RhdGFdIC0gQW4gb3B0aW9uYWwgdmFsdWUgaG9sZGluZyBtZXRhIGluZm9ybWF0aW9uIGFib3V0IHRoZSBzZXJpYWxpemF0aW9uLgogICAqIEByZXR1cm4ge09iamVjdH0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgaW50ZXJsZWF2ZWQgYnVmZmVyLgogICAqLwogIHRvSlNPTih0KSB7CiAgICByZXR1cm4gdC5hcnJheUJ1ZmZlcnMgPT09IHZvaWQgMCAmJiAodC5hcnJheUJ1ZmZlcnMgPSB7fSksIHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkID09PSB2b2lkIDAgJiYgKHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkID0gT2koKSksIHQuYXJyYXlCdWZmZXJzW3RoaXMuYXJyYXkuYnVmZmVyLl91dWlkXSA9PT0gdm9pZCAwICYmICh0LmFycmF5QnVmZmVyc1t0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZF0gPSBBcnJheS5mcm9tKG5ldyBVaW50MzJBcnJheSh0aGlzLmFycmF5LmJ1ZmZlcikpKSwgewogICAgICB1dWlkOiB0aGlzLnV1aWQsCiAgICAgIGJ1ZmZlcjogdGhpcy5hcnJheS5idWZmZXIuX3V1aWQsCiAgICAgIHR5cGU6IHRoaXMuYXJyYXkuY29uc3RydWN0b3IubmFtZSwKICAgICAgc3RyaWRlOiB0aGlzLnN0cmlkZQogICAgfTsKICB9Cn07CmNvbnN0IHVpID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmxldCB1biA9IGNsYXNzIFR5IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGludGVybGVhdmVkIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0ge0ludGVybGVhdmVkQnVmZmVyfSBpbnRlcmxlYXZlZEJ1ZmZlciAtIFRoZSBidWZmZXIgaG9sZGluZyB0aGUgaW50ZXJsZWF2ZWQgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaXRlbVNpemUgLSBUaGUgaXRlbSBzaXplLgogICAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXQgLSBUaGUgYXR0cmlidXRlIG9mZnNldCBpbnRvIHRoZSBidWZmZXIuCiAgICogQHBhcmFtIHtib29sZWFufSBbbm9ybWFsaXplZD1mYWxzZV0gLSBXaGV0aGVyIHRoZSBkYXRhIGFyZSBub3JtYWxpemVkIG9yIG5vdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuID0gITEpIHsKICAgIHRoaXMuaXNJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSA9ICEwLCB0aGlzLm5hbWUgPSAiIiwgdGhpcy5kYXRhID0gdCwgdGhpcy5pdGVtU2l6ZSA9IGUsIHRoaXMub2Zmc2V0ID0gaSwgdGhpcy5ub3JtYWxpemVkID0gbjsKICB9CiAgLyoqCiAgICogVGhlIGl0ZW0gY291bnQgb2YgdGhpcyBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAcmVhZG9ubHkKICAgKi8KICBnZXQgY291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5kYXRhLmNvdW50OwogIH0KICAvKioKICAgKiBUaGUgYXJyYXkgaG9sZGluZyB0aGUgaW50ZXJsZWF2ZWQgYnVmZmVyIGF0dHJpYnV0ZSBkYXRhLgogICAqCiAgICogQHR5cGUge1R5cGVkQXJyYXl9CiAgICovCiAgZ2V0IGFycmF5KCkgewogICAgcmV0dXJuIHRoaXMuZGF0YS5hcnJheTsKICB9CiAgLyoqCiAgICogRmxhZyB0byBpbmRpY2F0ZSB0aGF0IHRoaXMgYXR0cmlidXRlIGhhcyBjaGFuZ2VkIGFuZCBzaG91bGQgYmUgcmUtc2VudCB0bwogICAqIHRoZSBHUFUuIFNldCB0aGlzIHRvIGB0cnVlYCB3aGVuIHlvdSBtb2RpZnkgdGhlIHZhbHVlIG9mIHRoZSBhcnJheS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgZmFsc2UKICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAgICovCiAgc2V0IG5lZWRzVXBkYXRlKHQpIHsKICAgIHRoaXMuZGF0YS5uZWVkc1VwZGF0ZSA9IHQ7CiAgfQogIC8qKgogICAqIEFwcGxpZXMgdGhlIGdpdmVuIDR4NCBtYXRyaXggdG8gdGhlIGdpdmVuIGF0dHJpYnV0ZS4gT25seSB3b3JrcyB3aXRoCiAgICogaXRlbSBzaXplIGAzYC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSBtYXRyaXggdG8gYXBwbHkuCiAgICogQHJldHVybiB7SW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5kYXRhLmNvdW50OyBlIDwgaTsgZSsrKQogICAgICB1aS5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCB1aS5hcHBseU1hdHJpeDQodCksIHRoaXMuc2V0WFlaKGUsIHVpLngsIHVpLnksIHVpLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIEFwcGxpZXMgdGhlIGdpdmVuIDN4MyBub3JtYWwgbWF0cml4IHRvIHRoZSBnaXZlbiBhdHRyaWJ1dGUuIE9ubHkgd29ya3Mgd2l0aAogICAqIGl0ZW0gc2l6ZSBgM2AuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbm9ybWFsIG1hdHJpeCB0byBhcHBseS4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhcHBseU5vcm1hbE1hdHJpeCh0KSB7CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHRoaXMuY291bnQ7IGUgPCBpOyBlKyspCiAgICAgIHVpLmZyb21CdWZmZXJBdHRyaWJ1dGUodGhpcywgZSksIHVpLmFwcGx5Tm9ybWFsTWF0cml4KHQpLCB0aGlzLnNldFhZWihlLCB1aS54LCB1aS55LCB1aS56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiA0eDQgbWF0cml4IHRvIHRoZSBnaXZlbiBhdHRyaWJ1dGUuIE9ubHkgd29ya3Mgd2l0aAogICAqIGl0ZW0gc2l6ZSBgM2AgYW5kIHdpdGggZGlyZWN0aW9uIHZlY3RvcnMuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4IHRvIGFwcGx5LgogICAqIEByZXR1cm4ge0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zZm9ybURpcmVjdGlvbih0KSB7CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHRoaXMuY291bnQ7IGUgPCBpOyBlKyspCiAgICAgIHVpLmZyb21CdWZmZXJBdHRyaWJ1dGUodGhpcywgZSksIHVpLnRyYW5zZm9ybURpcmVjdGlvbih0KSwgdGhpcy5zZXRYWVooZSwgdWkueCwgdWkueSwgdWkueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZ2l2ZW4gY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvbXBvbmVudCAtIFRoZSBjb21wb25lbnQgaW5kZXguCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcmV0dXJuZWQgdmFsdWUuCiAgICovCiAgZ2V0Q29tcG9uZW50KHQsIGUpIHsKICAgIGxldCBpID0gdGhpcy5hcnJheVt0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgZV07CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChpID0gbWkoaSwgdGhpcy5hcnJheSkpLCBpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiB2YWx1ZSB0byB0aGUgZ2l2ZW4gY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvbXBvbmVudCAtIFRoZSBjb21wb25lbnQgaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRDb21wb25lbnQodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoaSA9IFl0KGksIHRoaXMuYXJyYXkpKSwgdGhpcy5kYXRhLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgKyBlXSA9IGksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHggY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFgodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpKSwgdGhpcy5kYXRhLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXRdID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgeSBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBzZXQuCiAgICogQHJldHVybiB7SW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0WSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDFdID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgeiBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB2YWx1ZSB0byBzZXQuCiAgICogQHJldHVybiB7SW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0Wih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDJdID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdyBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gdyAtIFRoZSB2YWx1ZSB0byBzZXQuCiAgICogQHJldHVybiB7SW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0Vyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDNdID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgeCBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB4IGNvbXBvbmVudC4KICAgKi8KICBnZXRYKHQpIHsKICAgIGxldCBlID0gdGhpcy5kYXRhLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXRdOwogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IG1pKGUsIHRoaXMuYXJyYXkpKSwgZTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgeSBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB5IGNvbXBvbmVudC4KICAgKi8KICBnZXRZKHQpIHsKICAgIGxldCBlID0gdGhpcy5kYXRhLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgKyAxXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBtaShlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHogY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeiBjb21wb25lbnQuCiAgICovCiAgZ2V0Wih0KSB7CiAgICBsZXQgZSA9IHRoaXMuZGF0YS5hcnJheVt0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgMl07CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gbWkoZSwgdGhpcy5hcnJheSkpLCBlOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSB3IGNvbXBvbmVudCBvZiB0aGUgdmVjdG9yIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBpbnRvIHRoZSBidWZmZXIgYXR0cmlidXRlLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHcgY29tcG9uZW50LgogICAqLwogIGdldFcodCkgewogICAgbGV0IGUgPSB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDNdOwogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IG1pKGUsIHRoaXMuYXJyYXkpKSwgZTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgeCBhbmQgeSBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSBmb3IgdGhlIHggY29tcG9uZW50IHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSBmb3IgdGhlIHkgY29tcG9uZW50IHRvIHNldC4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRYWSh0LCBlLCBpKSB7CiAgICByZXR1cm4gdCA9IHQgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQsIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IFl0KGUsIHRoaXMuYXJyYXkpLCBpID0gWXQoaSwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5kYXRhLmFycmF5W3QgKyAxXSA9IGksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHgsIHkgYW5kIHogY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IgYXQgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgZm9yIHRoZSB4IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgZm9yIHRoZSB5IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgdmFsdWUgZm9yIHRoZSB6IGNvbXBvbmVudCB0byBzZXQuCiAgICogQHJldHVybiB7SW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0WFlaKHQsIGUsIGksIG4pIHsKICAgIHJldHVybiB0ID0gdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSksIGkgPSBZdChpLCB0aGlzLmFycmF5KSwgbiA9IFl0KG4sIHRoaXMuYXJyYXkpKSwgdGhpcy5kYXRhLmFycmF5W3QgKyAwXSA9IGUsIHRoaXMuZGF0YS5hcnJheVt0ICsgMV0gPSBpLCB0aGlzLmRhdGEuYXJyYXlbdCArIDJdID0gbiwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgeCwgeSwgeiBhbmQgdyBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSBmb3IgdGhlIHggY29tcG9uZW50IHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSBmb3IgdGhlIHkgY29tcG9uZW50IHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB2YWx1ZSBmb3IgdGhlIHogY29tcG9uZW50IHRvIHNldC4KICAgKiBAcGFyYW0ge251bWJlcn0gdyAtIFRoZSB2YWx1ZSBmb3IgdGhlIHcgY29tcG9uZW50IHRvIHNldC4KICAgKiBAcmV0dXJuIHtJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRYWVpXKHQsIGUsIGksIG4sIHMpIHsKICAgIHJldHVybiB0ID0gdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gWXQoZSwgdGhpcy5hcnJheSksIGkgPSBZdChpLCB0aGlzLmFycmF5KSwgbiA9IFl0KG4sIHRoaXMuYXJyYXkpLCBzID0gWXQocywgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5kYXRhLmFycmF5W3QgKyAxXSA9IGksIHRoaXMuZGF0YS5hcnJheVt0ICsgMl0gPSBuLCB0aGlzLmRhdGEuYXJyYXlbdCArIDNdID0gcywgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBidWZmZXIgYXR0cmlidXRlIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBJZiBubyBwYXJhbWV0ZXIgaXMgcHJvdmlkZWQsIGNsb25pbmcgYW4gaW50ZXJsZWF2ZWQgYnVmZmVyIGF0dHJpYnV0ZSB3aWxsIGRlLWludGVybGVhdmUgYnVmZmVyIGRhdGEuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW2RhdGFdIC0gQW4gb2JqZWN0IHdpdGggaW50ZXJsZWF2ZWQgYnVmZmVycyB0aGF0IGFsbG93cyB0byByZXRhaW4gdGhlIGludGVybGVhdmVkIHByb3BlcnR5LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZXxJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZX0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKHQpIHsKICAgIGlmICh0ID09PSB2b2lkIDApIHsKICAgICAgY29uc29sZS5sb2coIlRIUkVFLkludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlLmNsb25lKCk6IENsb25pbmcgYW4gaW50ZXJsZWF2ZWQgYnVmZmVyIGF0dHJpYnV0ZSB3aWxsIGRlLWludGVybGVhdmUgYnVmZmVyIGRhdGEuIik7CiAgICAgIGNvbnN0IGUgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvdW50OyBpKyspIHsKICAgICAgICBjb25zdCBuID0gaSAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldDsKICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHRoaXMuaXRlbVNpemU7IHMrKykKICAgICAgICAgIGUucHVzaCh0aGlzLmRhdGEuYXJyYXlbbiArIHNdKTsKICAgICAgfQogICAgICByZXR1cm4gbmV3IGllKG5ldyB0aGlzLmFycmF5LmNvbnN0cnVjdG9yKGUpLCB0aGlzLml0ZW1TaXplLCB0aGlzLm5vcm1hbGl6ZWQpOwogICAgfSBlbHNlCiAgICAgIHJldHVybiB0LmludGVybGVhdmVkQnVmZmVycyA9PT0gdm9pZCAwICYmICh0LmludGVybGVhdmVkQnVmZmVycyA9IHt9KSwgdC5pbnRlcmxlYXZlZEJ1ZmZlcnNbdGhpcy5kYXRhLnV1aWRdID09PSB2b2lkIDAgJiYgKHQuaW50ZXJsZWF2ZWRCdWZmZXJzW3RoaXMuZGF0YS51dWlkXSA9IHRoaXMuZGF0YS5jbG9uZSh0KSksIG5ldyBUeSh0LmludGVybGVhdmVkQnVmZmVyc1t0aGlzLmRhdGEudXVpZF0sIHRoaXMuaXRlbVNpemUsIHRoaXMub2Zmc2V0LCB0aGlzLm5vcm1hbGl6ZWQpOwogIH0KICAvKioKICAgKiBTZXJpYWxpemVzIHRoZSBidWZmZXIgYXR0cmlidXRlIGludG8gSlNPTi4KICAgKgogICAqIElmIG5vIHBhcmFtZXRlciBpcyBwcm92aWRlZCwgY2xvbmluZyBhbiBpbnRlcmxlYXZlZCBidWZmZXIgYXR0cmlidXRlIHdpbGwgZGUtaW50ZXJsZWF2ZSBidWZmZXIgZGF0YS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbZGF0YV0gLSBBbiBvcHRpb25hbCB2YWx1ZSBob2xkaW5nIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlcmlhbGl6YXRpb24uCiAgICogQHJldHVybiB7T2JqZWN0fSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBidWZmZXIgYXR0cmlidXRlLgogICAqLwogIHRvSlNPTih0KSB7CiAgICBpZiAodCA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJUSFJFRS5JbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZS50b0pTT04oKTogU2VyaWFsaXppbmcgYW4gaW50ZXJsZWF2ZWQgYnVmZmVyIGF0dHJpYnV0ZSB3aWxsIGRlLWludGVybGVhdmUgYnVmZmVyIGRhdGEuIik7CiAgICAgIGNvbnN0IGUgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvdW50OyBpKyspIHsKICAgICAgICBjb25zdCBuID0gaSAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldDsKICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHRoaXMuaXRlbVNpemU7IHMrKykKICAgICAgICAgIGUucHVzaCh0aGlzLmRhdGEuYXJyYXlbbiArIHNdKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGl0ZW1TaXplOiB0aGlzLml0ZW1TaXplLAogICAgICAgIHR5cGU6IHRoaXMuYXJyYXkuY29uc3RydWN0b3IubmFtZSwKICAgICAgICBhcnJheTogZSwKICAgICAgICBub3JtYWxpemVkOiB0aGlzLm5vcm1hbGl6ZWQKICAgICAgfTsKICAgIH0gZWxzZQogICAgICByZXR1cm4gdC5pbnRlcmxlYXZlZEJ1ZmZlcnMgPT09IHZvaWQgMCAmJiAodC5pbnRlcmxlYXZlZEJ1ZmZlcnMgPSB7fSksIHQuaW50ZXJsZWF2ZWRCdWZmZXJzW3RoaXMuZGF0YS51dWlkXSA9PT0gdm9pZCAwICYmICh0LmludGVybGVhdmVkQnVmZmVyc1t0aGlzLmRhdGEudXVpZF0gPSB0aGlzLmRhdGEudG9KU09OKHQpKSwgewogICAgICAgIGlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGU6ICEwLAogICAgICAgIGl0ZW1TaXplOiB0aGlzLml0ZW1TaXplLAogICAgICAgIGRhdGE6IHRoaXMuZGF0YS51dWlkLAogICAgICAgIG9mZnNldDogdGhpcy5vZmZzZXQsCiAgICAgICAgbm9ybWFsaXplZDogdGhpcy5ub3JtYWxpemVkCiAgICAgIH07CiAgfQp9OwpjbGFzcyBXYyBleHRlbmRzIGhpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHNwcml0ZSBtYXRlcmlhbC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc1Nwcml0ZU1hdGVyaWFsID0gITAsIHRoaXMudHlwZSA9ICJTcHJpdGVNYXRlcmlhbCIsIHRoaXMuY29sb3IgPSBuZXcgY3QoMTY3NzcyMTUpLCB0aGlzLm1hcCA9IG51bGwsIHRoaXMuYWxwaGFNYXAgPSBudWxsLCB0aGlzLnJvdGF0aW9uID0gMCwgdGhpcy5zaXplQXR0ZW51YXRpb24gPSAhMCwgdGhpcy50cmFuc3BhcmVudCA9ICEwLCB0aGlzLmZvZyA9ICEwLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5jb2xvci5jb3B5KHQuY29sb3IpLCB0aGlzLm1hcCA9IHQubWFwLCB0aGlzLmFscGhhTWFwID0gdC5hbHBoYU1hcCwgdGhpcy5yb3RhdGlvbiA9IHQucm90YXRpb24sIHRoaXMuc2l6ZUF0dGVudWF0aW9uID0gdC5zaXplQXR0ZW51YXRpb24sIHRoaXMuZm9nID0gdC5mb2csIHRoaXM7CiAgfQp9CmxldCBMcjsKY29uc3Qga2EgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgRHIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgRnIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgVXIgPSAvKiBAX19QVVJFX18gKi8gbmV3IEooKSwgVmEgPSAvKiBAX19QVVJFX18gKi8gbmV3IEooKSwgQ3kgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIHVsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIEhhID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIGRsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIFlmID0gLyogQF9fUFVSRV9fICovIG5ldyBKKCksIHp1ID0gLyogQF9fUFVSRV9fICovIG5ldyBKKCksIFpmID0gLyogQF9fUFVSRV9fICovIG5ldyBKKCk7CmNsYXNzIG1jIGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc3ByaXRlLgogICAqCiAgICogQHBhcmFtIHsoU3ByaXRlTWF0ZXJpYWx8U3ByaXRlTm9kZU1hdGVyaWFsKX0gW21hdGVyaWFsXSAtIFRoZSBzcHJpdGUgbWF0ZXJpYWwuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBXYygpKSB7CiAgICBpZiAoc3VwZXIoKSwgdGhpcy5pc1Nwcml0ZSA9ICEwLCB0aGlzLnR5cGUgPSAiU3ByaXRlIiwgTHIgPT09IHZvaWQgMCkgewogICAgICBMciA9IG5ldyBIdCgpOwogICAgICBjb25zdCBlID0gbmV3IEZsb2F0MzJBcnJheShbCiAgICAgICAgLTAuNSwKICAgICAgICAtMC41LAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAuNSwKICAgICAgICAtMC41LAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDAuNSwKICAgICAgICAwLjUsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDEsCiAgICAgICAgLTAuNSwKICAgICAgICAwLjUsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEKICAgICAgXSksIGkgPSBuZXcgR2MoZSwgNSk7CiAgICAgIExyLnNldEluZGV4KFswLCAxLCAyLCAwLCAyLCAzXSksIExyLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgdW4oaSwgMywgMCwgITEpKSwgTHIuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB1bihpLCAyLCAzLCAhMSkpOwogICAgfQogICAgdGhpcy5nZW9tZXRyeSA9IExyLCB0aGlzLm1hdGVyaWFsID0gdCwgdGhpcy5jZW50ZXIgPSBuZXcgSigwLjUsIDAuNSksIHRoaXMuY291bnQgPSAxOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBpbnRlcnNlY3Rpb24gcG9pbnRzIGJldHdlZW4gYSBjYXN0ZWQgcmF5IGFuZCB0aGlzIHNwcml0ZS4KICAgKgogICAqIEBwYXJhbSB7UmF5Y2FzdGVyfSByYXljYXN0ZXIgLSBUaGUgcmF5Y2FzdGVyLgogICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gaW50ZXJzZWN0cyAtIFRoZSB0YXJnZXQgYXJyYXkgdGhhdCBob2xkcyB0aGUgaW50ZXJzZWN0aW9uIHBvaW50cy4KICAgKi8KICByYXljYXN0KHQsIGUpIHsKICAgIHQuY2FtZXJhID09PSBudWxsICYmIGNvbnNvbGUuZXJyb3IoJ1RIUkVFLlNwcml0ZTogIlJheWNhc3Rlci5jYW1lcmEiIG5lZWRzIHRvIGJlIHNldCBpbiBvcmRlciB0byByYXljYXN0IGFnYWluc3Qgc3ByaXRlcy4nKSwgRHIuc2V0RnJvbU1hdHJpeFNjYWxlKHRoaXMubWF0cml4V29ybGQpLCBDeS5jb3B5KHQuY2FtZXJhLm1hdHJpeFdvcmxkKSwgdGhpcy5tb2RlbFZpZXdNYXRyaXgubXVsdGlwbHlNYXRyaWNlcyh0LmNhbWVyYS5tYXRyaXhXb3JsZEludmVyc2UsIHRoaXMubWF0cml4V29ybGQpLCBGci5zZXRGcm9tTWF0cml4UG9zaXRpb24odGhpcy5tb2RlbFZpZXdNYXRyaXgpLCB0LmNhbWVyYS5pc1BlcnNwZWN0aXZlQ2FtZXJhICYmIHRoaXMubWF0ZXJpYWwuc2l6ZUF0dGVudWF0aW9uID09PSAhMSAmJiBEci5tdWx0aXBseVNjYWxhcigtRnIueik7CiAgICBjb25zdCBpID0gdGhpcy5tYXRlcmlhbC5yb3RhdGlvbjsKICAgIGxldCBuLCBzOwogICAgaSAhPT0gMCAmJiAocyA9IE1hdGguY29zKGkpLCBuID0gTWF0aC5zaW4oaSkpOwogICAgY29uc3QgciA9IHRoaXMuY2VudGVyOwogICAgcGwodWwuc2V0KC0wLjUsIC0wLjUsIDApLCBGciwgciwgRHIsIG4sIHMpLCBwbChIYS5zZXQoMC41LCAtMC41LCAwKSwgRnIsIHIsIERyLCBuLCBzKSwgcGwoZGwuc2V0KDAuNSwgMC41LCAwKSwgRnIsIHIsIERyLCBuLCBzKSwgWWYuc2V0KDAsIDApLCB6dS5zZXQoMSwgMCksIFpmLnNldCgxLCAxKTsKICAgIGxldCBvID0gdC5yYXkuaW50ZXJzZWN0VHJpYW5nbGUodWwsIEhhLCBkbCwgITEsIGthKTsKICAgIGlmIChvID09PSBudWxsICYmIChwbChIYS5zZXQoLTAuNSwgMC41LCAwKSwgRnIsIHIsIERyLCBuLCBzKSwgenUuc2V0KDAsIDEpLCBvID0gdC5yYXkuaW50ZXJzZWN0VHJpYW5nbGUodWwsIGRsLCBIYSwgITEsIGthKSwgbyA9PT0gbnVsbCkpCiAgICAgIHJldHVybjsKICAgIGNvbnN0IGwgPSB0LnJheS5vcmlnaW4uZGlzdGFuY2VUbyhrYSk7CiAgICBsIDwgdC5uZWFyIHx8IGwgPiB0LmZhciB8fCBlLnB1c2goewogICAgICBkaXN0YW5jZTogbCwKICAgICAgcG9pbnQ6IGthLmNsb25lKCksCiAgICAgIHV2OiBicy5nZXRJbnRlcnBvbGF0aW9uKGthLCB1bCwgSGEsIGRsLCBZZiwgenUsIFpmLCBuZXcgSigpKSwKICAgICAgZmFjZTogbnVsbCwKICAgICAgb2JqZWN0OiB0aGlzCiAgICB9KTsKICB9CiAgY29weSh0LCBlKSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0LCBlKSwgdC5jZW50ZXIgIT09IHZvaWQgMCAmJiB0aGlzLmNlbnRlci5jb3B5KHQuY2VudGVyKSwgdGhpcy5tYXRlcmlhbCA9IHQubWF0ZXJpYWwsIHRoaXM7CiAgfQp9CmZ1bmN0aW9uIHBsKGEsIHQsIGUsIGksIG4sIHMpIHsKICBVci5zdWJWZWN0b3JzKGEsIGUpLmFkZFNjYWxhcigwLjUpLm11bHRpcGx5KGkpLCBuICE9PSB2b2lkIDAgPyAoVmEueCA9IHMgKiBVci54IC0gbiAqIFVyLnksIFZhLnkgPSBuICogVXIueCArIHMgKiBVci55KSA6IFZhLmNvcHkoVXIpLCBhLmNvcHkodCksIGEueCArPSBWYS54LCBhLnkgKz0gVmEueSwgYS5hcHBseU1hdHJpeDQoQ3kpOwp9CmNvbnN0IGZsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIGpmID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmNsYXNzIFJ5IGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgTE9ELgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0xPRCA9ICEwLCB0aGlzLl9jdXJyZW50TGV2ZWwgPSAwLCB0aGlzLnR5cGUgPSAiTE9EIiwgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogVGhpcyBhcnJheSBob2xkcyB0aGUgTE9EIGxldmVscy4KICAgICAgICoKICAgICAgICogQG5hbWUgTE9EI2xldmVscwogICAgICAgKiBAdHlwZSB7QXJyYXk8e29iamVjdDpPYmplY3QzRCxkaXN0YW5jZTpudW1iZXIsaHlzdGVyZXNpczpudW1iZXJ9Pn0KICAgICAgICovCiAgICAgIGxldmVsczogewogICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgIHZhbHVlOiBbXQogICAgICB9CiAgICB9KSwgdGhpcy5hdXRvVXBkYXRlID0gITA7CiAgfQogIGNvcHkodCkgewogICAgc3VwZXIuY29weSh0LCAhMSk7CiAgICBjb25zdCBlID0gdC5sZXZlbHM7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgIGNvbnN0IHMgPSBlW2ldOwogICAgICB0aGlzLmFkZExldmVsKHMub2JqZWN0LmNsb25lKCksIHMuZGlzdGFuY2UsIHMuaHlzdGVyZXNpcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5hdXRvVXBkYXRlID0gdC5hdXRvVXBkYXRlLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGEgbWVzaCB0aGF0IHdpbGwgZGlzcGxheSBhdCBhIGNlcnRhaW4gZGlzdGFuY2UgYW5kIGdyZWF0ZXIuIFR5cGljYWxseQogICAqIHRoZSBmdXJ0aGVyIGF3YXkgdGhlIGRpc3RhbmNlLCB0aGUgbG93ZXIgdGhlIGRldGFpbCBvbiB0aGUgbWVzaC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QgdG8gZGlzcGxheSBhdCB0aGlzIGxldmVsLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlzdGFuY2U9MF0gLSBUaGUgZGlzdGFuY2UgYXQgd2hpY2ggdG8gZGlzcGxheSB0aGlzIGxldmVsIG9mIGRldGFpbC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2h5c3RlcmVzaXM9MF0gLSBUaHJlc2hvbGQgdXNlZCB0byBhdm9pZCBmbGlja2VyaW5nIGF0IExPRCBib3VuZGFyaWVzLCBhcyBhIGZyYWN0aW9uIG9mIGRpc3RhbmNlLgogICAqIEByZXR1cm4ge0xPRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhZGRMZXZlbCh0LCBlID0gMCwgaSA9IDApIHsKICAgIGUgPSBNYXRoLmFicyhlKTsKICAgIGNvbnN0IG4gPSB0aGlzLmxldmVsczsKICAgIGxldCBzOwogICAgZm9yIChzID0gMDsgcyA8IG4ubGVuZ3RoICYmICEoZSA8IG5bc10uZGlzdGFuY2UpOyBzKyspCiAgICAgIDsKICAgIHJldHVybiBuLnNwbGljZShzLCAwLCB7IGRpc3RhbmNlOiBlLCBoeXN0ZXJlc2lzOiBpLCBvYmplY3Q6IHQgfSksIHRoaXMuYWRkKHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGxldmVsLCBiYXNlZCBvbiB0aGUgZGlzdGFuY2UgZnJvbSB0aGUgY2FtZXJhLgogICAqIFJldHVybnMgYHRydWVgIHdoZW4gdGhlIGxldmVsIGhhcyBiZWVuIHJlbW92ZWQuIE90aGVyd2lzZSBgZmFsc2VgLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gRGlzdGFuY2Ugb2YgdGhlIGxldmVsIHRvIHJlbW92ZS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBsZXZlbCBoYXMgYmVlbiByZW1vdmVkIG9yIG5vdC4KICAgKi8KICByZW1vdmVMZXZlbCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5sZXZlbHM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGUubGVuZ3RoOyBpKyspCiAgICAgIGlmIChlW2ldLmRpc3RhbmNlID09PSB0KSB7CiAgICAgICAgY29uc3QgbiA9IGUuc3BsaWNlKGksIDEpOwogICAgICAgIHJldHVybiB0aGlzLnJlbW92ZShuWzBdLm9iamVjdCksICEwOwogICAgICB9CiAgICByZXR1cm4gITE7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGN1cnJlbnRseSBhY3RpdmUgTE9EIGxldmVsIGluZGV4LgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgY3VycmVudCBhY3RpdmUgTE9EIGxldmVsIGluZGV4LgogICAqLwogIGdldEN1cnJlbnRMZXZlbCgpIHsKICAgIHJldHVybiB0aGlzLl9jdXJyZW50TGV2ZWw7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIGZpcnN0IDNEIG9iamVjdCB0aGF0IGlzIGdyZWF0ZXIgdGhhbgogICAqIHRoZSBnaXZlbiBkaXN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBkaXN0YW5jZSAtIFRoZSBMT0QgZGlzdGFuY2UuCiAgICogQHJldHVybiB7P09iamVjdDNEfSBUaGUgZm91bmQgM0Qgb2JqZWN0LiBgbnVsbGAgaWYgbm8gM0Qgb2JqZWN0IGhhcyBiZWVuIGZvdW5kLgogICAqLwogIGdldE9iamVjdEZvckRpc3RhbmNlKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmxldmVsczsKICAgIGlmIChlLmxlbmd0aCA+IDApIHsKICAgICAgbGV0IGksIG47CiAgICAgIGZvciAoaSA9IDEsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgIGxldCBzID0gZVtpXS5kaXN0YW5jZTsKICAgICAgICBpZiAoZVtpXS5vYmplY3QudmlzaWJsZSAmJiAocyAtPSBzICogZVtpXS5oeXN0ZXJlc2lzKSwgdCA8IHMpCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gZVtpIC0gMV0ub2JqZWN0OwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGludGVyc2VjdGlvbiBwb2ludHMgYmV0d2VlbiBhIGNhc3RlZCByYXkgYW5kIHRoaXMgTE9ELgogICAqCiAgICogQHBhcmFtIHtSYXljYXN0ZXJ9IHJheWNhc3RlciAtIFRoZSByYXljYXN0ZXIuCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBpbnRlcnNlY3RzIC0gVGhlIHRhcmdldCBhcnJheSB0aGF0IGhvbGRzIHRoZSBpbnRlcnNlY3Rpb24gcG9pbnRzLgogICAqLwogIHJheWNhc3QodCwgZSkgewogICAgaWYgKHRoaXMubGV2ZWxzLmxlbmd0aCA+IDApIHsKICAgICAgZmwuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubWF0cml4V29ybGQpOwogICAgICBjb25zdCBuID0gdC5yYXkub3JpZ2luLmRpc3RhbmNlVG8oZmwpOwogICAgICB0aGlzLmdldE9iamVjdEZvckRpc3RhbmNlKG4pLnJheWNhc3QodCwgZSk7CiAgICB9CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIExPRCBieSBjb21wdXRpbmcgd2hpY2ggTE9EIGxldmVsIHNob3VsZCBiZSB2aXNpYmxlIGFjY29yZGluZwogICAqIHRvIHRoZSBjdXJyZW50IGRpc3RhbmNlIG9mIHRoZSBnaXZlbiBjYW1lcmEuCiAgICoKICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYSB0aGUgc2NlbmUgaXMgcmVuZGVyZWQgd2l0aC4KICAgKi8KICB1cGRhdGUodCkgewogICAgY29uc3QgZSA9IHRoaXMubGV2ZWxzOwogICAgaWYgKGUubGVuZ3RoID4gMSkgewogICAgICBmbC5zZXRGcm9tTWF0cml4UG9zaXRpb24odC5tYXRyaXhXb3JsZCksIGpmLnNldEZyb21NYXRyaXhQb3NpdGlvbih0aGlzLm1hdHJpeFdvcmxkKTsKICAgICAgY29uc3QgaSA9IGZsLmRpc3RhbmNlVG8oamYpIC8gdC56b29tOwogICAgICBlWzBdLm9iamVjdC52aXNpYmxlID0gITA7CiAgICAgIGxldCBuLCBzOwogICAgICBmb3IgKG4gPSAxLCBzID0gZS5sZW5ndGg7IG4gPCBzOyBuKyspIHsKICAgICAgICBsZXQgciA9IGVbbl0uZGlzdGFuY2U7CiAgICAgICAgaWYgKGVbbl0ub2JqZWN0LnZpc2libGUgJiYgKHIgLT0gciAqIGVbbl0uaHlzdGVyZXNpcyksIGkgPj0gcikKICAgICAgICAgIGVbbiAtIDFdLm9iamVjdC52aXNpYmxlID0gITEsIGVbbl0ub2JqZWN0LnZpc2libGUgPSAhMDsKICAgICAgICBlbHNlCiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICBmb3IgKHRoaXMuX2N1cnJlbnRMZXZlbCA9IG4gLSAxOyBuIDwgczsgbisrKQogICAgICAgIGVbbl0ub2JqZWN0LnZpc2libGUgPSAhMTsKICAgIH0KICB9CiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSBzdXBlci50b0pTT04odCk7CiAgICB0aGlzLmF1dG9VcGRhdGUgPT09ICExICYmIChlLm9iamVjdC5hdXRvVXBkYXRlID0gITEpLCBlLm9iamVjdC5sZXZlbHMgPSBbXTsKICAgIGNvbnN0IGkgPSB0aGlzLmxldmVsczsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gaS5sZW5ndGg7IG4gPCBzOyBuKyspIHsKICAgICAgY29uc3QgciA9IGlbbl07CiAgICAgIGUub2JqZWN0LmxldmVscy5wdXNoKHsKICAgICAgICBvYmplY3Q6IHIub2JqZWN0LnV1aWQsCiAgICAgICAgZGlzdGFuY2U6IHIuZGlzdGFuY2UsCiAgICAgICAgaHlzdGVyZXNpczogci5oeXN0ZXJlc2lzCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGU7CiAgfQp9CmNvbnN0IEpmID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIEtmID0gLyogQF9fUFVSRV9fICovIG5ldyBRdCgpLCBRZiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUXQoKSwgSHYgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgdG0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIG1sID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIE51ID0gLyogQF9fUFVSRV9fICovIG5ldyBSZSgpLCBlbSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKSwgT3UgPSAvKiBAX19QVVJFX18gKi8gbmV3IEFhKCk7CmNsYXNzIFB5IGV4dGVuZHMgcmUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc2tpbm5lZCBtZXNoLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gW2dlb21ldHJ5XSAtIFRoZSBtZXNoIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7TWF0ZXJpYWx8QXJyYXk8TWF0ZXJpYWw+fSBbbWF0ZXJpYWxdIC0gVGhlIG1lc2ggbWF0ZXJpYWwuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSkgewogICAgc3VwZXIodCwgZSksIHRoaXMuaXNTa2lubmVkTWVzaCA9ICEwLCB0aGlzLnR5cGUgPSAiU2tpbm5lZE1lc2giLCB0aGlzLmJpbmRNb2RlID0gS2QsIHRoaXMuYmluZE1hdHJpeCA9IG5ldyBWdCgpLCB0aGlzLmJpbmRNYXRyaXhJbnZlcnNlID0gbmV3IFZ0KCksIHRoaXMuYm91bmRpbmdCb3ggPSBudWxsLCB0aGlzLmJvdW5kaW5nU3BoZXJlID0gbnVsbDsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgc2tpbm5lZCBtZXNoLCBhbmQgdXBkYXRlcyB7QGxpbmsgU2tpbm5lZE1lc2gjYm91bmRpbmdCb3h9LgogICAqIFRoZSBib3VuZGluZyBib3ggaXMgbm90IGF1dG9tYXRpY2FsbHkgY29tcHV0ZWQgYnkgdGhlIGVuZ2luZTsgdGhpcyBtZXRob2QgbXVzdCBiZSBjYWxsZWQgYnkgeW91ciBhcHAuCiAgICogSWYgdGhlIHNraW5uZWQgbWVzaCBpcyBhbmltYXRlZCwgdGhlIGJvdW5kaW5nIGJveCBzaG91bGQgYmUgcmVjb21wdXRlZCBwZXIgZnJhbWUgaW4gb3JkZXIgdG8gcmVmbGVjdAogICAqIHRoZSBjdXJyZW50IGFuaW1hdGlvbiBzdGF0ZS4KICAgKi8KICBjb21wdXRlQm91bmRpbmdCb3goKSB7CiAgICBjb25zdCB0ID0gdGhpcy5nZW9tZXRyeTsKICAgIHRoaXMuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdCb3ggPSBuZXcgd2UoKSksIHRoaXMuYm91bmRpbmdCb3gubWFrZUVtcHR5KCk7CiAgICBjb25zdCBlID0gdC5nZXRBdHRyaWJ1dGUoInBvc2l0aW9uIik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGUuY291bnQ7IGkrKykKICAgICAgdGhpcy5nZXRWZXJ0ZXhQb3NpdGlvbihpLCBtbCksIHRoaXMuYm91bmRpbmdCb3guZXhwYW5kQnlQb2ludChtbCk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBib3VuZGluZyBzcGhlcmUgb2YgdGhlIHNraW5uZWQgbWVzaCwgYW5kIHVwZGF0ZXMge0BsaW5rIFNraW5uZWRNZXNoI2JvdW5kaW5nU3BoZXJlfS4KICAgKiBUaGUgYm91bmRpbmcgc3BoZXJlIGlzIGF1dG9tYXRpY2FsbHkgY29tcHV0ZWQgYnkgdGhlIGVuZ2luZSBvbmNlIHdoZW4gaXQgaXMgbmVlZGVkLCBlLmcuLCBmb3IgcmF5IGNhc3RpbmcKICAgKiBhbmQgdmlldyBmcnVzdHVtIGN1bGxpbmcuIElmIHRoZSBza2lubmVkIG1lc2ggaXMgYW5pbWF0ZWQsIHRoZSBib3VuZGluZyBzcGhlcmUgc2hvdWxkIGJlIHJlY29tcHV0ZWQKICAgKiBwZXIgZnJhbWUgaW4gb3JkZXIgdG8gcmVmbGVjdCB0aGUgY3VycmVudCBhbmltYXRpb24gc3RhdGUuCiAgICovCiAgY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCkgewogICAgY29uc3QgdCA9IHRoaXMuZ2VvbWV0cnk7CiAgICB0aGlzLmJvdW5kaW5nU3BoZXJlID09PSBudWxsICYmICh0aGlzLmJvdW5kaW5nU3BoZXJlID0gbmV3IFJlKCkpLCB0aGlzLmJvdW5kaW5nU3BoZXJlLm1ha2VFbXB0eSgpOwogICAgY29uc3QgZSA9IHQuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlLmNvdW50OyBpKyspCiAgICAgIHRoaXMuZ2V0VmVydGV4UG9zaXRpb24oaSwgbWwpLCB0aGlzLmJvdW5kaW5nU3BoZXJlLmV4cGFuZEJ5UG9pbnQobWwpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0aGlzLmJpbmRNb2RlID0gdC5iaW5kTW9kZSwgdGhpcy5iaW5kTWF0cml4LmNvcHkodC5iaW5kTWF0cml4KSwgdGhpcy5iaW5kTWF0cml4SW52ZXJzZS5jb3B5KHQuYmluZE1hdHJpeEludmVyc2UpLCB0aGlzLnNrZWxldG9uID0gdC5za2VsZXRvbiwgdC5ib3VuZGluZ0JveCAhPT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ0JveCA9IHQuYm91bmRpbmdCb3guY2xvbmUoKSksIHQuYm91bmRpbmdTcGhlcmUgIT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdTcGhlcmUgPSB0LmJvdW5kaW5nU3BoZXJlLmNsb25lKCkpLCB0aGlzOwogIH0KICByYXljYXN0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLm1hdGVyaWFsLCBuID0gdGhpcy5tYXRyaXhXb3JsZDsKICAgIGkgIT09IHZvaWQgMCAmJiAodGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiB0aGlzLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCBOdS5jb3B5KHRoaXMuYm91bmRpbmdTcGhlcmUpLCBOdS5hcHBseU1hdHJpeDQobiksIHQucmF5LmludGVyc2VjdHNTcGhlcmUoTnUpICE9PSAhMSAmJiAoZW0uY29weShuKS5pbnZlcnQoKSwgT3UuY29weSh0LnJheSkuYXBwbHlNYXRyaXg0KGVtKSwgISh0aGlzLmJvdW5kaW5nQm94ICE9PSBudWxsICYmIE91LmludGVyc2VjdHNCb3godGhpcy5ib3VuZGluZ0JveCkgPT09ICExKSAmJiB0aGlzLl9jb21wdXRlSW50ZXJzZWN0aW9ucyh0LCBlLCBPdSkpKTsKICB9CiAgZ2V0VmVydGV4UG9zaXRpb24odCwgZSkgewogICAgcmV0dXJuIHN1cGVyLmdldFZlcnRleFBvc2l0aW9uKHQsIGUpLCB0aGlzLmFwcGx5Qm9uZVRyYW5zZm9ybSh0LCBlKSwgZTsKICB9CiAgLyoqCiAgICogQmluZHMgdGhlIGdpdmVuIHNrZWxldG9uIHRvIHRoZSBza2lubmVkIG1lc2guCiAgICoKICAgKiBAcGFyYW0ge1NrZWxldG9ufSBza2VsZXRvbiAtIFRoZSBza2VsZXRvbiB0byBiaW5kLgogICAqIEBwYXJhbSB7TWF0cml4NH0gW2JpbmRNYXRyaXhdIC0gVGhlIGJpbmQgbWF0cml4LiBJZiBubyBiaW5kIG1hdHJpeCBpcyBwcm92aWRlZCwKICAgKiB0aGUgc2tpbm5lZCBtZXNoJ3Mgd29ybGQgbWF0cml4IHdpbGwgYmUgdXNlZCBpbnN0ZWFkLgogICAqLwogIGJpbmQodCwgZSkgewogICAgdGhpcy5za2VsZXRvbiA9IHQsIGUgPT09IHZvaWQgMCAmJiAodGhpcy51cGRhdGVNYXRyaXhXb3JsZCghMCksIHRoaXMuc2tlbGV0b24uY2FsY3VsYXRlSW52ZXJzZXMoKSwgZSA9IHRoaXMubWF0cml4V29ybGQpLCB0aGlzLmJpbmRNYXRyaXguY29weShlKSwgdGhpcy5iaW5kTWF0cml4SW52ZXJzZS5jb3B5KGUpLmludmVydCgpOwogIH0KICAvKioKICAgKiBUaGlzIG1ldGhvZCBzZXRzIHRoZSBza2lubmVkIG1lc2ggaW4gdGhlIHJlc3QgcG9zZSkuCiAgICovCiAgcG9zZSgpIHsKICAgIHRoaXMuc2tlbGV0b24ucG9zZSgpOwogIH0KICAvKioKICAgKiBOb3JtYWxpemVzIHRoZSBza2luIHdlaWdodHMgd2hpY2ggYXJlIGRlZmluZWQgYXMgYSBidWZmZXIgYXR0cmlidXRlCiAgICogaW4gdGhlIHNraW5uZWQgbWVzaCdzIGdlb21ldHJ5LgogICAqLwogIG5vcm1hbGl6ZVNraW5XZWlnaHRzKCkgewogICAgY29uc3QgdCA9IG5ldyBRdCgpLCBlID0gdGhpcy5nZW9tZXRyeS5hdHRyaWJ1dGVzLnNraW5XZWlnaHQ7CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUuY291bnQ7IGkgPCBuOyBpKyspIHsKICAgICAgdC5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIGkpOwogICAgICBjb25zdCBzID0gMSAvIHQubWFuaGF0dGFuTGVuZ3RoKCk7CiAgICAgIHMgIT09IDEgLyAwID8gdC5tdWx0aXBseVNjYWxhcihzKSA6IHQuc2V0KDEsIDAsIDAsIDApLCBlLnNldFhZWlcoaSwgdC54LCB0LnksIHQueiwgdC53KTsKICAgIH0KICB9CiAgdXBkYXRlTWF0cml4V29ybGQodCkgewogICAgc3VwZXIudXBkYXRlTWF0cml4V29ybGQodCksIHRoaXMuYmluZE1vZGUgPT09IEtkID8gdGhpcy5iaW5kTWF0cml4SW52ZXJzZS5jb3B5KHRoaXMubWF0cml4V29ybGQpLmludmVydCgpIDogdGhpcy5iaW5kTW9kZSA9PT0gdHkgPyB0aGlzLmJpbmRNYXRyaXhJbnZlcnNlLmNvcHkodGhpcy5iaW5kTWF0cml4KS5pbnZlcnQoKSA6IGNvbnNvbGUud2FybigiVEhSRUUuU2tpbm5lZE1lc2g6IFVucmVjb2duaXplZCBiaW5kTW9kZTogIiArIHRoaXMuYmluZE1vZGUpOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBib25lIHRyYW5zZm9ybSBhc3NvY2lhdGVkIHdpdGggdGhlIGdpdmVuIGluZGV4IHRvIHRoZSBnaXZlbgogICAqIHZlcnRleCBwb3NpdGlvbi4gUmV0dXJucyB0aGUgdXBkYXRlZCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgdmVydGV4IGluZGV4LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogdGhlIHNraW5uZWQgbWVzaCdzIHdvcmxkIG1hdHJpeCB3aWxsIGJlIHVzZWQgaW5zdGVhZC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgdXBkYXRlZCB2ZXJ0ZXggcG9zaXRpb24uCiAgICovCiAgYXBwbHlCb25lVHJhbnNmb3JtKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLnNrZWxldG9uLCBuID0gdGhpcy5nZW9tZXRyeTsKICAgIEtmLmZyb21CdWZmZXJBdHRyaWJ1dGUobi5hdHRyaWJ1dGVzLnNraW5JbmRleCwgdCksIFFmLmZyb21CdWZmZXJBdHRyaWJ1dGUobi5hdHRyaWJ1dGVzLnNraW5XZWlnaHQsIHQpLCBKZi5jb3B5KGUpLmFwcGx5TWF0cml4NCh0aGlzLmJpbmRNYXRyaXgpLCBlLnNldCgwLCAwLCAwKTsKICAgIGZvciAobGV0IHMgPSAwOyBzIDwgNDsgcysrKSB7CiAgICAgIGNvbnN0IHIgPSBRZi5nZXRDb21wb25lbnQocyk7CiAgICAgIGlmIChyICE9PSAwKSB7CiAgICAgICAgY29uc3QgbyA9IEtmLmdldENvbXBvbmVudChzKTsKICAgICAgICB0bS5tdWx0aXBseU1hdHJpY2VzKGkuYm9uZXNbb10ubWF0cml4V29ybGQsIGkuYm9uZUludmVyc2VzW29dKSwgZS5hZGRTY2FsZWRWZWN0b3IoSHYuY29weShKZikuYXBwbHlNYXRyaXg0KHRtKSwgcik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlLmFwcGx5TWF0cml4NCh0aGlzLmJpbmRNYXRyaXhJbnZlcnNlKTsKICB9Cn0KY2xhc3MgT3AgZXh0ZW5kcyBsZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBib25lLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0JvbmUgPSAhMCwgdGhpcy50eXBlID0gIkJvbmUiOwogIH0KfQpjbGFzcyBDbiBleHRlbmRzIE5lIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGRhdGEgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7P1R5cGVkQXJyYXl9IFtkYXRhPW51bGxdIC0gVGhlIGJ1ZmZlciBkYXRhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MV0gLSBUaGUgd2lkdGggb2YgdGhlIHRleHR1cmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MV0gLSBUaGUgaGVpZ2h0IG9mIHRoZSB0ZXh0dXJlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0PVJHQkFGb3JtYXRdIC0gVGhlIHRleHR1cmUgZm9ybWF0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdHlwZT1VbnNpZ25lZEJ5dGVUeXBlXSAtIFRoZSB0ZXh0dXJlIHR5cGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttYXBwaW5nPVRleHR1cmUuREVGQVVMVF9NQVBQSU5HXSAtIFRoZSB0ZXh0dXJlIG1hcHBpbmcuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwUz1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwUyB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dyYXBUPUNsYW1wVG9FZGdlV3JhcHBpbmddIC0gVGhlIHdyYXBUIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFnRmlsdGVyPU5lYXJlc3RGaWx0ZXJdIC0gVGhlIG1hZyBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5GaWx0ZXI9TmVhcmVzdEZpbHRlcl0gLSBUaGUgbWluIGZpbHRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FuaXNvdHJvcHk9VGV4dHVyZS5ERUZBVUxUX0FOSVNPVFJPUFldIC0gVGhlIGFuaXNvdHJvcHkgdmFsdWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPU5vQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG51bGwsIGUgPSAxLCBpID0gMSwgbiwgcywgciwgbywgbCwgaCA9IGplLCBjID0gamUsIHUsIGQpIHsKICAgIHN1cGVyKG51bGwsIHIsIG8sIGwsIGgsIGMsIG4sIHMsIHUsIGQpLCB0aGlzLmlzRGF0YVRleHR1cmUgPSAhMCwgdGhpcy5pbWFnZSA9IHsgZGF0YTogdCwgd2lkdGg6IGUsIGhlaWdodDogaSB9LCB0aGlzLmdlbmVyYXRlTWlwbWFwcyA9ICExLCB0aGlzLmZsaXBZID0gITEsIHRoaXMudW5wYWNrQWxpZ25tZW50ID0gMTsKICB9Cn0KY29uc3QgaW0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIEd2ID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpOwpjbGFzcyBxYyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBza2VsZXRvbi4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8Qm9uZT59IFtib25lc10gLSBBbiBhcnJheSBvZiBib25lcy4KICAgKiBAcGFyYW0ge0FycmF5PE1hdHJpeDQ+fSBbYm9uZUludmVyc2VzXSAtIEFuIGFycmF5IG9mIGJvbmUgaW52ZXJzZSBtYXRyaWNlcy4KICAgKiBJZiBub3QgcHJvdmlkZWQsIHRoZXNlIG1hdHJpY2VzIHdpbGwgYmUgY29tcHV0ZWQgYXV0b21hdGljYWxseSB2aWEge0BsaW5rIFNrZWxldG9uI2NhbGN1bGF0ZUludmVyc2VzfS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gW10sIGUgPSBbXSkgewogICAgdGhpcy51dWlkID0gT2koKSwgdGhpcy5ib25lcyA9IHQuc2xpY2UoMCksIHRoaXMuYm9uZUludmVyc2VzID0gZSwgdGhpcy5ib25lTWF0cmljZXMgPSBudWxsLCB0aGlzLmJvbmVUZXh0dXJlID0gbnVsbCwgdGhpcy5pbml0KCk7CiAgfQogIC8qKgogICAqIEluaXRpYWxpemVzIHRoZSBza2VsZXRvbi4gVGhpcyBtZXRob2QgZ2V0cyBhdXRvbWF0aWNhbGx5IGNhbGxlZCBieSB0aGUgY29uc3RydWN0b3IKICAgKiBidXQgZGVwZW5kaW5nIG9uIGhvdyB0aGUgc2tlbGV0b24gaXMgY3JlYXRlZCBpdCBtaWdodCBiZSBuZWNlc3NhcnkgdG8gY2FsbCB0aGlzIG1ldGhvZAogICAqIG1hbnVhbGx5LgogICAqLwogIGluaXQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5ib25lcywgZSA9IHRoaXMuYm9uZUludmVyc2VzOwogICAgaWYgKHRoaXMuYm9uZU1hdHJpY2VzID0gbmV3IEZsb2F0MzJBcnJheSh0Lmxlbmd0aCAqIDE2KSwgZS5sZW5ndGggPT09IDApCiAgICAgIHRoaXMuY2FsY3VsYXRlSW52ZXJzZXMoKTsKICAgIGVsc2UgaWYgKHQubGVuZ3RoICE9PSBlLmxlbmd0aCkgewogICAgICBjb25zb2xlLndhcm4oIlRIUkVFLlNrZWxldG9uOiBOdW1iZXIgb2YgaW52ZXJzZSBib25lIG1hdHJpY2VzIGRvZXMgbm90IG1hdGNoIGFtb3VudCBvZiBib25lcy4iKSwgdGhpcy5ib25lSW52ZXJzZXMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLmJvbmVzLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgICB0aGlzLmJvbmVJbnZlcnNlcy5wdXNoKG5ldyBWdCgpKTsKICAgIH0KICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGJvbmUgaW52ZXJzZSBtYXRyaWNlcy4gVGhpcyBtZXRob2QgcmVzZXRzIHtAbGluayBTa2VsZXRvbiNib25lSW52ZXJzZXN9CiAgICogYW5kIGZpbGxzIGl0IHdpdGggbmV3IG1hdHJpY2VzLgogICAqLwogIGNhbGN1bGF0ZUludmVyc2VzKCkgewogICAgdGhpcy5ib25lSW52ZXJzZXMubGVuZ3RoID0gMDsKICAgIGZvciAobGV0IHQgPSAwLCBlID0gdGhpcy5ib25lcy5sZW5ndGg7IHQgPCBlOyB0KyspIHsKICAgICAgY29uc3QgaSA9IG5ldyBWdCgpOwogICAgICB0aGlzLmJvbmVzW3RdICYmIGkuY29weSh0aGlzLmJvbmVzW3RdLm1hdHJpeFdvcmxkKS5pbnZlcnQoKSwgdGhpcy5ib25lSW52ZXJzZXMucHVzaChpKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVzZXRzIHRoZSBza2VsZXRvbiB0byB0aGUgYmFzZSBwb3NlLgogICAqLwogIHBvc2UoKSB7CiAgICBmb3IgKGxldCB0ID0gMCwgZSA9IHRoaXMuYm9uZXMubGVuZ3RoOyB0IDwgZTsgdCsrKSB7CiAgICAgIGNvbnN0IGkgPSB0aGlzLmJvbmVzW3RdOwogICAgICBpICYmIGkubWF0cml4V29ybGQuY29weSh0aGlzLmJvbmVJbnZlcnNlc1t0XSkuaW52ZXJ0KCk7CiAgICB9CiAgICBmb3IgKGxldCB0ID0gMCwgZSA9IHRoaXMuYm9uZXMubGVuZ3RoOyB0IDwgZTsgdCsrKSB7CiAgICAgIGNvbnN0IGkgPSB0aGlzLmJvbmVzW3RdOwogICAgICBpICYmIChpLnBhcmVudCAmJiBpLnBhcmVudC5pc0JvbmUgPyAoaS5tYXRyaXguY29weShpLnBhcmVudC5tYXRyaXhXb3JsZCkuaW52ZXJ0KCksIGkubWF0cml4Lm11bHRpcGx5KGkubWF0cml4V29ybGQpKSA6IGkubWF0cml4LmNvcHkoaS5tYXRyaXhXb3JsZCksIGkubWF0cml4LmRlY29tcG9zZShpLnBvc2l0aW9uLCBpLnF1YXRlcm5pb24sIGkuc2NhbGUpKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVzZXRzIHRoZSBza2VsZXRvbiB0byB0aGUgYmFzZSBwb3NlLgogICAqLwogIHVwZGF0ZSgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmJvbmVzLCBlID0gdGhpcy5ib25lSW52ZXJzZXMsIGkgPSB0aGlzLmJvbmVNYXRyaWNlcywgbiA9IHRoaXMuYm9uZVRleHR1cmU7CiAgICBmb3IgKGxldCBzID0gMCwgciA9IHQubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgIGNvbnN0IG8gPSB0W3NdID8gdFtzXS5tYXRyaXhXb3JsZCA6IEd2OwogICAgICBpbS5tdWx0aXBseU1hdHJpY2VzKG8sIGVbc10pLCBpbS50b0FycmF5KGksIHMgKiAxNik7CiAgICB9CiAgICBuICE9PSBudWxsICYmIChuLm5lZWRzVXBkYXRlID0gITApOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHNrZWxldG9uIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtTa2VsZXRvbn0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyBxYyh0aGlzLmJvbmVzLCB0aGlzLmJvbmVJbnZlcnNlcyk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGEgZGF0YSB0ZXh0dXJlIGZvciBwYXNzaW5nIGJvbmUgZGF0YSB0byB0aGUgdmVydGV4IHNoYWRlci4KICAgKgogICAqIEByZXR1cm4ge1NrZWxldG9ufSBBIHJlZmVyZW5jZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNvbXB1dGVCb25lVGV4dHVyZSgpIHsKICAgIGxldCB0ID0gTWF0aC5zcXJ0KHRoaXMuYm9uZXMubGVuZ3RoICogNCk7CiAgICB0ID0gTWF0aC5jZWlsKHQgLyA0KSAqIDQsIHQgPSBNYXRoLm1heCh0LCA0KTsKICAgIGNvbnN0IGUgPSBuZXcgRmxvYXQzMkFycmF5KHQgKiB0ICogNCk7CiAgICBlLnNldCh0aGlzLmJvbmVNYXRyaWNlcyk7CiAgICBjb25zdCBpID0gbmV3IENuKGUsIHQsIHQsIGdpLCB3aSk7CiAgICByZXR1cm4gaS5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzLmJvbmVNYXRyaWNlcyA9IGUsIHRoaXMuYm9uZVRleHR1cmUgPSBpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSBza2VsZXRvbidzIGJvbmUgYXJyYXkgYW5kIHJldHVybnMgdGhlIGZpcnN0IHdpdGggYQogICAqIG1hdGNoaW5nIG5hbWUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBib25lLgogICAqIEByZXR1cm4ge0JvbmV8dW5kZWZpbmVkfSBUaGUgZm91bmQgYm9uZS4gYHVuZGVmaW5lZGAgaWYgbm8gYm9uZSBoYXMgYmVlbiBmb3VuZC4KICAgKi8KICBnZXRCb25lQnlOYW1lKHQpIHsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5ib25lcy5sZW5ndGg7IGUgPCBpOyBlKyspIHsKICAgICAgY29uc3QgbiA9IHRoaXMuYm9uZXNbZV07CiAgICAgIGlmIChuLm5hbWUgPT09IHQpCiAgICAgICAgcmV0dXJuIG47CiAgICB9CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmJvbmVUZXh0dXJlICE9PSBudWxsICYmICh0aGlzLmJvbmVUZXh0dXJlLmRpc3Bvc2UoKSwgdGhpcy5ib25lVGV4dHVyZSA9IG51bGwpOwogIH0KICAvKioKICAgKiBTZXR1cHMgdGhlIHNrZWxldG9uIGJ5IHRoZSBnaXZlbiBKU09OIGFuZCBib25lcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIHNrZWxldG9uIGFzIHNlcmlhbGl6ZWQgSlNPTi4KICAgKiBAcGFyYW0ge09iamVjdDxzdHJpbmcsIEJvbmU+fSBib25lcyAtIEFuIGFycmF5IG9mIGJvbmVzLgogICAqIEByZXR1cm4ge1NrZWxldG9ufSBBIHJlZmVyZW5jZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGZyb21KU09OKHQsIGUpIHsKICAgIHRoaXMudXVpZCA9IHQudXVpZDsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdC5ib25lcy5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgcyA9IHQuYm9uZXNbaV07CiAgICAgIGxldCByID0gZVtzXTsKICAgICAgciA9PT0gdm9pZCAwICYmIChjb25zb2xlLndhcm4oIlRIUkVFLlNrZWxldG9uOiBObyBib25lIGZvdW5kIHdpdGggVVVJRDoiLCBzKSwgciA9IG5ldyBPcCgpKSwgdGhpcy5ib25lcy5wdXNoKHIpLCB0aGlzLmJvbmVJbnZlcnNlcy5wdXNoKG5ldyBWdCgpLmZyb21BcnJheSh0LmJvbmVJbnZlcnNlc1tpXSkpOwogICAgfQogICAgcmV0dXJuIHRoaXMuaW5pdCgpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXJpYWxpemVzIHRoZSBza2VsZXRvbiBpbnRvIEpTT04uCiAgICoKICAgKiBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIHNrZWxldG9uLgogICAqIEBzZWUge0BsaW5rIE9iamVjdExvYWRlciNwYXJzZX0KICAgKi8KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0gewogICAgICBtZXRhZGF0YTogewogICAgICAgIHZlcnNpb246IDQuNywKICAgICAgICB0eXBlOiAiU2tlbGV0b24iLAogICAgICAgIGdlbmVyYXRvcjogIlNrZWxldG9uLnRvSlNPTiIKICAgICAgfSwKICAgICAgYm9uZXM6IFtdLAogICAgICBib25lSW52ZXJzZXM6IFtdCiAgICB9OwogICAgdC51dWlkID0gdGhpcy51dWlkOwogICAgY29uc3QgZSA9IHRoaXMuYm9uZXMsIGkgPSB0aGlzLmJvbmVJbnZlcnNlczsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gZS5sZW5ndGg7IG4gPCBzOyBuKyspIHsKICAgICAgY29uc3QgciA9IGVbbl07CiAgICAgIHQuYm9uZXMucHVzaChyLnV1aWQpOwogICAgICBjb25zdCBvID0gaVtuXTsKICAgICAgdC5ib25lSW52ZXJzZXMucHVzaChvLnRvQXJyYXkoKSk7CiAgICB9CiAgICByZXR1cm4gdDsKICB9Cn0KY2xhc3MgeGEgZXh0ZW5kcyBpZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBpbnN0YW5jZWQgYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gYXJyYXkgLSBUaGUgYXJyYXkgaG9sZGluZyB0aGUgYXR0cmlidXRlIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGl0ZW1TaXplIC0gVGhlIGl0ZW0gc2l6ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3JtYWxpemVkPWZhbHNlXSAtIFdoZXRoZXIgdGhlIGRhdGEgYXJlIG5vcm1hbGl6ZWQgb3Igbm90LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWVzaFBlckF0dHJpYnV0ZT0xXSAtIEhvdyBvZnRlbiBhIHZhbHVlIG9mIHRoaXMgYnVmZmVyIGF0dHJpYnV0ZSBzaG91bGQgYmUgcmVwZWF0ZWQuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiA9IDEpIHsKICAgIHN1cGVyKHQsIGUsIGkpLCB0aGlzLmlzSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlID0gITAsIHRoaXMubWVzaFBlckF0dHJpYnV0ZSA9IG47CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMubWVzaFBlckF0dHJpYnV0ZSA9IHQubWVzaFBlckF0dHJpYnV0ZSwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgcmV0dXJuIHQubWVzaFBlckF0dHJpYnV0ZSA9IHRoaXMubWVzaFBlckF0dHJpYnV0ZSwgdC5pc0luc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZSA9ICEwLCB0OwogIH0KfQpjb25zdCBCciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKSwgbm0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIGdsID0gW10sIHNtID0gLyogQF9fUFVSRV9fICovIG5ldyB3ZSgpLCBXdiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKSwgR2EgPSAvKiBAX19QVVJFX18gKi8gbmV3IHJlKCksIFdhID0gLyogQF9fUFVSRV9fICovIG5ldyBSZSgpOwpjbGFzcyBJeSBleHRlbmRzIHJlIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGluc3RhbmNlZCBtZXNoLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gW2dlb21ldHJ5XSAtIFRoZSBtZXNoIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7TWF0ZXJpYWx8QXJyYXk8TWF0ZXJpYWw+fSBbbWF0ZXJpYWxdIC0gVGhlIG1lc2ggbWF0ZXJpYWwuCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvdW50IC0gVGhlIG51bWJlciBvZiBpbnN0YW5jZXMuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIodCwgZSksIHRoaXMuaXNJbnN0YW5jZWRNZXNoID0gITAsIHRoaXMuaW5zdGFuY2VNYXRyaXggPSBuZXcgeGEobmV3IEZsb2F0MzJBcnJheShpICogMTYpLCAxNiksIHRoaXMuaW5zdGFuY2VDb2xvciA9IG51bGwsIHRoaXMubW9ycGhUZXh0dXJlID0gbnVsbCwgdGhpcy5jb3VudCA9IGksIHRoaXMuYm91bmRpbmdCb3ggPSBudWxsLCB0aGlzLmJvdW5kaW5nU3BoZXJlID0gbnVsbDsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgaTsgbisrKQogICAgICB0aGlzLnNldE1hdHJpeEF0KG4sIFd2KTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgaW5zdGFuY2VkIG1lc2gsIGFuZCB1cGRhdGVzIHtAbGluayBJbnN0YW5jZWRNZXNoI2JvdW5kaW5nQm94fS4KICAgKiBUaGUgYm91bmRpbmcgYm94IGlzIG5vdCBhdXRvbWF0aWNhbGx5IGNvbXB1dGVkIGJ5IHRoZSBlbmdpbmU7IHRoaXMgbWV0aG9kIG11c3QgYmUgY2FsbGVkIGJ5IHlvdXIgYXBwLgogICAqIFlvdSBtYXkgbmVlZCB0byByZWNvbXB1dGUgdGhlIGJvdW5kaW5nIGJveCBpZiBhbiBpbnN0YW5jZSBpcyB0cmFuc2Zvcm1lZCB2aWEge0BsaW5rIEluc3RhbmNlZE1lc2gjc2V0TWF0cml4QXR9LgogICAqLwogIGNvbXB1dGVCb3VuZGluZ0JveCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmdlb21ldHJ5LCBlID0gdGhpcy5jb3VudDsKICAgIHRoaXMuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdCb3ggPSBuZXcgd2UoKSksIHQuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgdC5jb21wdXRlQm91bmRpbmdCb3goKSwgdGhpcy5ib3VuZGluZ0JveC5tYWtlRW1wdHkoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZTsgaSsrKQogICAgICB0aGlzLmdldE1hdHJpeEF0KGksIEJyKSwgc20uY29weSh0LmJvdW5kaW5nQm94KS5hcHBseU1hdHJpeDQoQnIpLCB0aGlzLmJvdW5kaW5nQm94LnVuaW9uKHNtKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIHNwaGVyZSBvZiB0aGUgaW5zdGFuY2VkIG1lc2gsIGFuZCB1cGRhdGVzIHtAbGluayBJbnN0YW5jZWRNZXNoI2JvdW5kaW5nU3BoZXJlfQogICAqIFRoZSBlbmdpbmUgYXV0b21hdGljYWxseSBjb21wdXRlcyB0aGUgYm91bmRpbmcgc3BoZXJlIHdoZW4gaXQgaXMgbmVlZGVkLCBlLmcuLCBmb3IgcmF5IGNhc3Rpbmcgb3IgdmlldyBmcnVzdHVtIGN1bGxpbmcuCiAgICogWW91IG1heSBuZWVkIHRvIHJlY29tcHV0ZSB0aGUgYm91bmRpbmcgc3BoZXJlIGlmIGFuIGluc3RhbmNlIGlzIHRyYW5zZm9ybWVkIHZpYSB7QGxpbmsgSW5zdGFuY2VkTWVzaCNzZXRNYXRyaXhBdH0uCiAgICovCiAgY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCkgewogICAgY29uc3QgdCA9IHRoaXMuZ2VvbWV0cnksIGUgPSB0aGlzLmNvdW50OwogICAgdGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ1NwaGVyZSA9IG5ldyBSZSgpKSwgdC5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiB0LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCB0aGlzLmJvdW5kaW5nU3BoZXJlLm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlOyBpKyspCiAgICAgIHRoaXMuZ2V0TWF0cml4QXQoaSwgQnIpLCBXYS5jb3B5KHQuYm91bmRpbmdTcGhlcmUpLmFwcGx5TWF0cml4NChCciksIHRoaXMuYm91bmRpbmdTcGhlcmUudW5pb24oV2EpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0aGlzLmluc3RhbmNlTWF0cml4LmNvcHkodC5pbnN0YW5jZU1hdHJpeCksIHQubW9ycGhUZXh0dXJlICE9PSBudWxsICYmICh0aGlzLm1vcnBoVGV4dHVyZSA9IHQubW9ycGhUZXh0dXJlLmNsb25lKCkpLCB0Lmluc3RhbmNlQ29sb3IgIT09IG51bGwgJiYgKHRoaXMuaW5zdGFuY2VDb2xvciA9IHQuaW5zdGFuY2VDb2xvci5jbG9uZSgpKSwgdGhpcy5jb3VudCA9IHQuY291bnQsIHQuYm91bmRpbmdCb3ggIT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdCb3ggPSB0LmJvdW5kaW5nQm94LmNsb25lKCkpLCB0LmJvdW5kaW5nU3BoZXJlICE9PSBudWxsICYmICh0aGlzLmJvdW5kaW5nU3BoZXJlID0gdC5ib3VuZGluZ1NwaGVyZS5jbG9uZSgpKSwgdGhpczsKICB9CiAgLyoqCiAgICogR2V0cyB0aGUgY29sb3Igb2YgdGhlIGRlZmluZWQgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5zdGFuY2UgaW5kZXguCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgdGFyZ2V0IG9iamVjdCB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKi8KICBnZXRDb2xvckF0KHQsIGUpIHsKICAgIGUuZnJvbUFycmF5KHRoaXMuaW5zdGFuY2VDb2xvci5hcnJheSwgdCAqIDMpOwogIH0KICAvKioKICAgKiBHZXRzIHRoZSBsb2NhbCB0cmFuc2Zvcm1hdGlvbiBtYXRyaXggb2YgdGhlIGRlZmluZWQgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5zdGFuY2UgaW5kZXguCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtYXRyaXggLSBUaGUgdGFyZ2V0IG9iamVjdCB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKi8KICBnZXRNYXRyaXhBdCh0LCBlKSB7CiAgICBlLmZyb21BcnJheSh0aGlzLmluc3RhbmNlTWF0cml4LmFycmF5LCB0ICogMTYpOwogIH0KICAvKioKICAgKiBHZXRzIHRoZSBtb3JwaCB0YXJnZXQgd2VpZ2h0cyBvZiB0aGUgZGVmaW5lZCBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbnN0YW5jZSBpbmRleC4KICAgKiBAcGFyYW0ge01lc2h9IG9iamVjdCAtIFRoZSB0YXJnZXQgb2JqZWN0IHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqLwogIGdldE1vcnBoQXQodCwgZSkgewogICAgY29uc3QgaSA9IGUubW9ycGhUYXJnZXRJbmZsdWVuY2VzLCBuID0gdGhpcy5tb3JwaFRleHR1cmUuc291cmNlLmRhdGEuZGF0YSwgcyA9IGkubGVuZ3RoICsgMSwgciA9IHQgKiBzICsgMTsKICAgIGZvciAobGV0IG8gPSAwOyBvIDwgaS5sZW5ndGg7IG8rKykKICAgICAgaVtvXSA9IG5bciArIG9dOwogIH0KICByYXljYXN0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLm1hdHJpeFdvcmxkLCBuID0gdGhpcy5jb3VudDsKICAgIGlmIChHYS5nZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnksIEdhLm1hdGVyaWFsID0gdGhpcy5tYXRlcmlhbCwgR2EubWF0ZXJpYWwgIT09IHZvaWQgMCAmJiAodGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiB0aGlzLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCBXYS5jb3B5KHRoaXMuYm91bmRpbmdTcGhlcmUpLCBXYS5hcHBseU1hdHJpeDQoaSksIHQucmF5LmludGVyc2VjdHNTcGhlcmUoV2EpICE9PSAhMSkpCiAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgbjsgcysrKSB7CiAgICAgICAgdGhpcy5nZXRNYXRyaXhBdChzLCBCciksIG5tLm11bHRpcGx5TWF0cmljZXMoaSwgQnIpLCBHYS5tYXRyaXhXb3JsZCA9IG5tLCBHYS5yYXljYXN0KHQsIGdsKTsKICAgICAgICBmb3IgKGxldCByID0gMCwgbyA9IGdsLmxlbmd0aDsgciA8IG87IHIrKykgewogICAgICAgICAgY29uc3QgbCA9IGdsW3JdOwogICAgICAgICAgbC5pbnN0YW5jZUlkID0gcywgbC5vYmplY3QgPSB0aGlzLCBlLnB1c2gobCk7CiAgICAgICAgfQogICAgICAgIGdsLmxlbmd0aCA9IDA7CiAgICAgIH0KICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gY29sb3IgdG8gdGhlIGRlZmluZWQgaW5zdGFuY2UuIE1ha2Ugc3VyZSB5b3Ugc2V0IHRoZSBgbmVlZHNVcGRhdGVgIGZsYWcgb2YKICAgKiB7QGxpbmsgSW5zdGFuY2VkTWVzaCNpbnN0YW5jZUNvbG9yfSB0byBgdHJ1ZWAgYWZ0ZXIgdXBkYXRpbmcgYWxsIHRoZSBjb2xvcnMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5zdGFuY2UgaW5kZXguCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgaW5zdGFuY2UgY29sb3IuCiAgICovCiAgc2V0Q29sb3JBdCh0LCBlKSB7CiAgICB0aGlzLmluc3RhbmNlQ29sb3IgPT09IG51bGwgJiYgKHRoaXMuaW5zdGFuY2VDb2xvciA9IG5ldyB4YShuZXcgRmxvYXQzMkFycmF5KHRoaXMuaW5zdGFuY2VNYXRyaXguY291bnQgKiAzKS5maWxsKDEpLCAzKSksIGUudG9BcnJheSh0aGlzLmluc3RhbmNlQ29sb3IuYXJyYXksIHQgKiAzKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gbG9jYWwgdHJhbnNmb3JtYXRpb24gbWF0cml4IHRvIHRoZSBkZWZpbmVkIGluc3RhbmNlLiBNYWtlIHN1cmUgeW91IHNldCB0aGUgYG5lZWRzVXBkYXRlYCBmbGFnIG9mCiAgICoge0BsaW5rIEluc3RhbmNlZE1lc2gjaW5zdGFuY2VNYXRyaXh9IHRvIGB0cnVlYCBhZnRlciB1cGRhdGluZyBhbGwgdGhlIGNvbG9ycy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbnN0YW5jZSBpbmRleC4KICAgKiBAcGFyYW0ge01hdHJpeDR9IG1hdHJpeCAtIFRoZSBsb2NhbCB0cmFuc2Zvcm1hdGlvbi4KICAgKi8KICBzZXRNYXRyaXhBdCh0LCBlKSB7CiAgICBlLnRvQXJyYXkodGhpcy5pbnN0YW5jZU1hdHJpeC5hcnJheSwgdCAqIDE2KTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgbW9ycGggdGFyZ2V0IHdlaWdodHMgdG8gdGhlIGRlZmluZWQgaW5zdGFuY2UuIE1ha2Ugc3VyZSB5b3Ugc2V0IHRoZSBgbmVlZHNVcGRhdGVgIGZsYWcgb2YKICAgKiB7QGxpbmsgSW5zdGFuY2VkTWVzaCNtb3JwaFRleHR1cmV9IHRvIGB0cnVlYCBhZnRlciB1cGRhdGluZyBhbGwgdGhlIGluZmx1ZW5jZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5zdGFuY2UgaW5kZXguCiAgICogQHBhcmFtIHtNZXNofSBvYmplY3QgLSAgQSBtZXNoIHdoaWNoIGBtb3JwaFRhcmdldEluZmx1ZW5jZXNgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlIG1vcnBoIHRhcmdldCB3ZWlnaHRzCiAgICogb2YgYSBzaW5nbGUgaW5zdGFuY2UuCiAgICovCiAgc2V0TW9ycGhBdCh0LCBlKSB7CiAgICBjb25zdCBpID0gZS5tb3JwaFRhcmdldEluZmx1ZW5jZXMsIG4gPSBpLmxlbmd0aCArIDE7CiAgICB0aGlzLm1vcnBoVGV4dHVyZSA9PT0gbnVsbCAmJiAodGhpcy5tb3JwaFRleHR1cmUgPSBuZXcgQ24obmV3IEZsb2F0MzJBcnJheShuICogdGhpcy5jb3VudCksIG4sIHRoaXMuY291bnQsIExjLCB3aSkpOwogICAgY29uc3QgcyA9IHRoaXMubW9ycGhUZXh0dXJlLnNvdXJjZS5kYXRhLmRhdGE7CiAgICBsZXQgciA9IDA7CiAgICBmb3IgKGxldCBoID0gMDsgaCA8IGkubGVuZ3RoOyBoKyspCiAgICAgIHIgKz0gaVtoXTsKICAgIGNvbnN0IG8gPSB0aGlzLmdlb21ldHJ5Lm1vcnBoVGFyZ2V0c1JlbGF0aXZlID8gMSA6IDEgLSByLCBsID0gbiAqIHQ7CiAgICBzW2xdID0gbywgcy5zZXQoaSwgbCArIDEpOwogIH0KICB1cGRhdGVNb3JwaFRhcmdldHMoKSB7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAiZGlzcG9zZSIgfSksIHRoaXMubW9ycGhUZXh0dXJlICE9PSBudWxsICYmICh0aGlzLm1vcnBoVGV4dHVyZS5kaXNwb3NlKCksIHRoaXMubW9ycGhUZXh0dXJlID0gbnVsbCk7CiAgfQp9CmNvbnN0IGt1ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIHF2ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksICR2ID0gLyogQF9fUFVSRV9fICovIG5ldyBYdCgpOwpjbGFzcyBxbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gW25vcm1hbD0oMSwwLDApXSAtIEEgdW5pdCBsZW5ndGggdmVjdG9yIGRlZmluaW5nIHRoZSBub3JtYWwgb2YgdGhlIHBsYW5lLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbY29uc3RhbnQ9MF0gLSBUaGUgc2lnbmVkIGRpc3RhbmNlIGZyb20gdGhlIG9yaWdpbiB0byB0aGUgcGxhbmUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBFKDEsIDAsIDApLCBlID0gMCkgewogICAgdGhpcy5pc1BsYW5lID0gITAsIHRoaXMubm9ybWFsID0gdCwgdGhpcy5jb25zdGFudCA9IGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHBsYW5lIGNvbXBvbmVudHMgYnkgY29weWluZyB0aGUgZ2l2ZW4gdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBub3JtYWwgLSBUaGUgbm9ybWFsLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25zdGFudCAtIFRoZSBjb25zdGFudC4KICAgKiBAcmV0dXJuIHtQbGFuZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBwbGFuZS4KICAgKi8KICBzZXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsLmNvcHkodCksIHRoaXMuY29uc3RhbnQgPSBlLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBwbGFuZSBjb21wb25lbnRzIGJ5IGRlZmluaW5nIGB4YCwgYHlgLCBgemAgYXMgdGhlCiAgICogcGxhbmUgbm9ybWFsIGFuZCBgd2AgYXMgdGhlIGNvbnN0YW50LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgZm9yIHRoZSBub3JtYWwncyB4IGNvbXBvbmVudC4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSBmb3IgdGhlIG5vcm1hbCdzIHkgY29tcG9uZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIHZhbHVlIGZvciB0aGUgbm9ybWFsJ3MgeiBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHcgLSBUaGUgY29uc3RhbnQgdmFsdWUuCiAgICogQHJldHVybiB7UGxhbmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcGxhbmUuCiAgICovCiAgc2V0Q29tcG9uZW50cyh0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWwuc2V0KHQsIGUsIGkpLCB0aGlzLmNvbnN0YW50ID0gbiwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgcGxhbmUgZnJvbSB0aGUgZ2l2ZW4gbm9ybWFsIGFuZCBjb3BsYW5hciBwb2ludCAodGhhdCBpcyBhIHBvaW50CiAgICogdGhhdCBsaWVzIG9udG8gdGhlIHBsYW5lKS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gbm9ybWFsIC0gVGhlIG5vcm1hbC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gQSBjb3BsYW5hciBwb2ludC4KICAgKiBAcmV0dXJuIHtQbGFuZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBwbGFuZS4KICAgKi8KICBzZXRGcm9tTm9ybWFsQW5kQ29wbGFuYXJQb2ludCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWwuY29weSh0KSwgdGhpcy5jb25zdGFudCA9IC1lLmRvdCh0aGlzLm5vcm1hbCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHBsYW5lIGZyb20gdGhyZWUgY29wbGFuYXIgcG9pbnRzLiBUaGUgd2luZGluZyBvcmRlciBpcwogICAqIGFzc3VtZWQgdG8gYmUgY291bnRlci1jbG9ja3dpc2UsIGFuZCBkZXRlcm1pbmVzIHRoZSBkaXJlY3Rpb24gb2YKICAgKiB0aGUgcGxhbmUgbm9ybWFsLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBhIC0gVGhlIGZpcnN0IGNvcGxhbmFyIHBvaW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgY29wbGFuYXIgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBjIC0gVGhlIHRoaXJkIGNvcGxhbmFyIHBvaW50LgogICAqIEByZXR1cm4ge1BsYW5lfSBBIHJlZmVyZW5jZSB0byB0aGlzIHBsYW5lLgogICAqLwogIHNldEZyb21Db3BsYW5hclBvaW50cyh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0ga3Uuc3ViVmVjdG9ycyhpLCBlKS5jcm9zcyhxdi5zdWJWZWN0b3JzKHQsIGUpKS5ub3JtYWxpemUoKTsKICAgIHJldHVybiB0aGlzLnNldEZyb21Ob3JtYWxBbmRDb3BsYW5hclBvaW50KG4sIHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gcGxhbmUgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7UGxhbmV9IHBsYW5lIC0gVGhlIHBsYW5lIHRvIGNvcHkuCiAgICogQHJldHVybiB7UGxhbmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcGxhbmUuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWwuY29weSh0Lm5vcm1hbCksIHRoaXMuY29uc3RhbnQgPSB0LmNvbnN0YW50LCB0aGlzOwogIH0KICAvKioKICAgKiBOb3JtYWxpemVzIHRoZSBwbGFuZSBub3JtYWwgYW5kIGFkanVzdHMgdGhlIGNvbnN0YW50IGFjY29yZGluZ2x5LgogICAqCiAgICogQHJldHVybiB7UGxhbmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcGxhbmUuCiAgICovCiAgbm9ybWFsaXplKCkgewogICAgY29uc3QgdCA9IDEgLyB0aGlzLm5vcm1hbC5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLm5vcm1hbC5tdWx0aXBseVNjYWxhcih0KSwgdGhpcy5jb25zdGFudCAqPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBOZWdhdGVzIGJvdGggdGhlIHBsYW5lIG5vcm1hbCBhbmQgdGhlIGNvbnN0YW50LgogICAqCiAgICogQHJldHVybiB7UGxhbmV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcGxhbmUuCiAgICovCiAgbmVnYXRlKCkgewogICAgcmV0dXJuIHRoaXMuY29uc3RhbnQgKj0gLTEsIHRoaXMubm9ybWFsLm5lZ2F0ZSgpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBzaWduZWQgZGlzdGFuY2UgZnJvbSB0aGUgZ2l2ZW4gcG9pbnQgdG8gdGhpcyBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBUaGUgcG9pbnQgdG8gY29tcHV0ZSB0aGUgZGlzdGFuY2UgZm9yLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNpZ25lZCBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZVRvUG9pbnQodCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsLmRvdCh0KSArIHRoaXMuY29uc3RhbnQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHNpZ25lZCBkaXN0YW5jZSBmcm9tIHRoZSBnaXZlbiBzcGhlcmUgdG8gdGhpcyBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7U3BoZXJlfSBzcGhlcmUgLSBUaGUgc3BoZXJlIHRvIGNvbXB1dGUgdGhlIGRpc3RhbmNlIGZvci4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBzaWduZWQgZGlzdGFuY2UuCiAgICovCiAgZGlzdGFuY2VUb1NwaGVyZSh0KSB7CiAgICByZXR1cm4gdGhpcy5kaXN0YW5jZVRvUG9pbnQodC5jZW50ZXIpIC0gdC5yYWRpdXM7CiAgfQogIC8qKgogICAqIFByb2plY3RzIGEgdGhlIGdpdmVuIHBvaW50IG9udG8gdGhlIHBsYW5lLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwb2ludCAtIFRoZSBwb2ludCB0byBwcm9qZWN0LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIHByb2plY3RlZCBwb2ludCBvbiB0aGUgcGxhbmUuCiAgICovCiAgcHJvamVjdFBvaW50KHQsIGUpIHsKICAgIHJldHVybiBlLmNvcHkodCkuYWRkU2NhbGVkVmVjdG9yKHRoaXMubm9ybWFsLCAtdGhpcy5kaXN0YW5jZVRvUG9pbnQodCkpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBpbnRlcnNlY3Rpb24gcG9pbnQgb2YgdGhlIHBhc3NlZCBsaW5lIGFuZCB0aGUgcGxhbmUuIFJldHVybnMKICAgKiBgbnVsbGAgaWYgdGhlIGxpbmUgZG9lcyBub3QgaW50ZXJzZWN0LiBSZXR1cm5zIHRoZSBsaW5lJ3Mgc3RhcnRpbmcgcG9pbnQgaWYKICAgKiB0aGUgbGluZSBpcyBjb3BsYW5hciB3aXRoIHRoZSBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7TGluZTN9IGxpbmUgLSBUaGUgbGluZSB0byBjb21wdXRlIHRoZSBpbnRlcnNlY3Rpb24gZm9yLgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7P1ZlY3RvcjN9IFRoZSBpbnRlcnNlY3Rpb24gcG9pbnQuCiAgICovCiAgaW50ZXJzZWN0TGluZSh0LCBlKSB7CiAgICBjb25zdCBpID0gdC5kZWx0YShrdSksIG4gPSB0aGlzLm5vcm1hbC5kb3QoaSk7CiAgICBpZiAobiA9PT0gMCkKICAgICAgcmV0dXJuIHRoaXMuZGlzdGFuY2VUb1BvaW50KHQuc3RhcnQpID09PSAwID8gZS5jb3B5KHQuc3RhcnQpIDogbnVsbDsKICAgIGNvbnN0IHMgPSAtKHQuc3RhcnQuZG90KHRoaXMubm9ybWFsKSArIHRoaXMuY29uc3RhbnQpIC8gbjsKICAgIHJldHVybiBzIDwgMCB8fCBzID4gMSA/IG51bGwgOiBlLmNvcHkodC5zdGFydCkuYWRkU2NhbGVkVmVjdG9yKGksIHMpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gbGluZSBzZWdtZW50IGludGVyc2VjdHMgd2l0aCAocGFzc2VzIHRocm91Z2gpIHRoZSBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7TGluZTN9IGxpbmUgLSBUaGUgbGluZSB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGdpdmVuIGxpbmUgc2VnbWVudCBpbnRlcnNlY3RzIHdpdGggdGhlIHBsYW5lIG9yIG5vdC4KICAgKi8KICBpbnRlcnNlY3RzTGluZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5kaXN0YW5jZVRvUG9pbnQodC5zdGFydCksIGkgPSB0aGlzLmRpc3RhbmNlVG9Qb2ludCh0LmVuZCk7CiAgICByZXR1cm4gZSA8IDAgJiYgaSA+IDAgfHwgaSA8IDAgJiYgZSA+IDA7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiBib3VuZGluZyBib3ggaW50ZXJzZWN0cyB3aXRoIHRoZSBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7Qm94M30gYm94IC0gVGhlIGJvdW5kaW5nIGJveCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGdpdmVuIGJvdW5kaW5nIGJveCBpbnRlcnNlY3RzIHdpdGggdGhlIHBsYW5lIG9yIG5vdC4KICAgKi8KICBpbnRlcnNlY3RzQm94KHQpIHsKICAgIHJldHVybiB0LmludGVyc2VjdHNQbGFuZSh0aGlzKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIGJvdW5kaW5nIHNwaGVyZSBpbnRlcnNlY3RzIHdpdGggdGhlIHBsYW5lLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBib3VuZGluZyBzcGhlcmUgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBnaXZlbiBib3VuZGluZyBzcGhlcmUgaW50ZXJzZWN0cyB3aXRoIHRoZSBwbGFuZSBvciBub3QuCiAgICovCiAgaW50ZXJzZWN0c1NwaGVyZSh0KSB7CiAgICByZXR1cm4gdC5pbnRlcnNlY3RzUGxhbmUodGhpcyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBjb3BsYW5hciB2ZWN0b3IgdG8gdGhlIHBsYW5lLCBieSBjYWxjdWxhdGluZyB0aGUKICAgKiBwcm9qZWN0aW9uIG9mIHRoZSBub3JtYWwgYXQgdGhlIG9yaWdpbiBvbnRvIHRoZSBwbGFuZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIGNvcGxhbmFyIHBvaW50LgogICAqLwogIGNvcGxhbmFyUG9pbnQodCkgewogICAgcmV0dXJuIHQuY29weSh0aGlzLm5vcm1hbCkubXVsdGlwbHlTY2FsYXIoLXRoaXMuY29uc3RhbnQpOwogIH0KICAvKioKICAgKiBBcHBseSBhIDR4NCBtYXRyaXggdG8gdGhlIHBsYW5lLiBUaGUgbWF0cml4IG11c3QgYmUgYW4gYWZmaW5lLCBob21vZ2VuZW91cyB0cmFuc2Zvcm0uCiAgICoKICAgKiBUaGUgb3B0aW9uYWwgbm9ybWFsIG1hdHJpeCBjYW4gYmUgcHJlLWNvbXB1dGVkIGxpa2Ugc286CiAgICogYGBganMKICAgKiBjb25zdCBvcHRpb25hbE5vcm1hbE1hdHJpeCA9IG5ldyBUSFJFRS5NYXRyaXgzKCkuZ2V0Tm9ybWFsTWF0cml4KCBtYXRyaXggKTsKICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeC4KICAgKiBAcGFyYW0ge01hdHJpeDR9IFtvcHRpb25hbE5vcm1hbE1hdHJpeF0gLSBBIHByZS1jb21wdXRlZCBub3JtYWwgbWF0cml4LgogICAqIEByZXR1cm4ge1BsYW5lfSBBIHJlZmVyZW5jZSB0byB0aGlzIHBsYW5lLgogICAqLwogIGFwcGx5TWF0cml4NCh0LCBlKSB7CiAgICBjb25zdCBpID0gZSB8fCAkdi5nZXROb3JtYWxNYXRyaXgodCksIG4gPSB0aGlzLmNvcGxhbmFyUG9pbnQoa3UpLmFwcGx5TWF0cml4NCh0KSwgcyA9IHRoaXMubm9ybWFsLmFwcGx5TWF0cml4MyhpKS5ub3JtYWxpemUoKTsKICAgIHJldHVybiB0aGlzLmNvbnN0YW50ID0gLW4uZG90KHMpLCB0aGlzOwogIH0KICAvKioKICAgKiBUcmFuc2xhdGVzIHRoZSBwbGFuZSBieSB0aGUgZGlzdGFuY2UgZGVmaW5lZCBieSB0aGUgZ2l2ZW4gb2Zmc2V0IHZlY3Rvci4KICAgKiBOb3RlIHRoYXQgdGhpcyBvbmx5IGFmZmVjdHMgdGhlIHBsYW5lIGNvbnN0YW50IGFuZCB3aWxsIG5vdCBhZmZlY3QgdGhlIG5vcm1hbCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IG9mZnNldCAtIFRoZSBvZmZzZXQgdmVjdG9yLgogICAqIEByZXR1cm4ge1BsYW5lfSBBIHJlZmVyZW5jZSB0byB0aGlzIHBsYW5lLgogICAqLwogIHRyYW5zbGF0ZSh0KSB7CiAgICByZXR1cm4gdGhpcy5jb25zdGFudCAtPSB0LmRvdCh0aGlzLm5vcm1hbCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgcGxhbmUgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtQbGFuZX0gcGxhbmUgLSBUaGUgcGxhbmUgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIHBsYW5lIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQubm9ybWFsLmVxdWFscyh0aGlzLm5vcm1hbCkgJiYgdC5jb25zdGFudCA9PT0gdGhpcy5jb25zdGFudDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBwbGFuZSB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7UGxhbmV9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQp9CmNvbnN0IFZzID0gLyogQF9fUFVSRV9fICovIG5ldyBSZSgpLCBYdiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgSigwLjUsIDAuNSksIHlsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmNsYXNzIEVhIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGZydXN0dW0uCiAgICoKICAgKiBAcGFyYW0ge1BsYW5lfSBbcDBdIC0gVGhlIGZpcnN0IHBsYW5lIHRoYXQgZW5jbG9zZXMgdGhlIGZydXN0dW0uCiAgICogQHBhcmFtIHtQbGFuZX0gW3AxXSAtIFRoZSBzZWNvbmQgcGxhbmUgdGhhdCBlbmNsb3NlcyB0aGUgZnJ1c3R1bS4KICAgKiBAcGFyYW0ge1BsYW5lfSBbcDJdIC0gVGhlIHRoaXJkIHBsYW5lIHRoYXQgZW5jbG9zZXMgdGhlIGZydXN0dW0uCiAgICogQHBhcmFtIHtQbGFuZX0gW3AzXSAtIFRoZSBmb3VydGggcGxhbmUgdGhhdCBlbmNsb3NlcyB0aGUgZnJ1c3R1bS4KICAgKiBAcGFyYW0ge1BsYW5lfSBbcDRdIC0gVGhlIGZpZnRoIHBsYW5lIHRoYXQgZW5jbG9zZXMgdGhlIGZydXN0dW0uCiAgICogQHBhcmFtIHtQbGFuZX0gW3A1XSAtIFRoZSBzaXh0aCBwbGFuZSB0aGF0IGVuY2xvc2VzIHRoZSBmcnVzdHVtLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgcW4oKSwgZSA9IG5ldyBxbigpLCBpID0gbmV3IHFuKCksIG4gPSBuZXcgcW4oKSwgcyA9IG5ldyBxbigpLCByID0gbmV3IHFuKCkpIHsKICAgIHRoaXMucGxhbmVzID0gW3QsIGUsIGksIG4sIHMsIHJdOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBmcnVzdHVtIHBsYW5lcyBieSBjb3B5aW5nIHRoZSBnaXZlbiBwbGFuZXMuCiAgICoKICAgKiBAcGFyYW0ge1BsYW5lfSBbcDBdIC0gVGhlIGZpcnN0IHBsYW5lIHRoYXQgZW5jbG9zZXMgdGhlIGZydXN0dW0uCiAgICogQHBhcmFtIHtQbGFuZX0gW3AxXSAtIFRoZSBzZWNvbmQgcGxhbmUgdGhhdCBlbmNsb3NlcyB0aGUgZnJ1c3R1bS4KICAgKiBAcGFyYW0ge1BsYW5lfSBbcDJdIC0gVGhlIHRoaXJkIHBsYW5lIHRoYXQgZW5jbG9zZXMgdGhlIGZydXN0dW0uCiAgICogQHBhcmFtIHtQbGFuZX0gW3AzXSAtIFRoZSBmb3VydGggcGxhbmUgdGhhdCBlbmNsb3NlcyB0aGUgZnJ1c3R1bS4KICAgKiBAcGFyYW0ge1BsYW5lfSBbcDRdIC0gVGhlIGZpZnRoIHBsYW5lIHRoYXQgZW5jbG9zZXMgdGhlIGZydXN0dW0uCiAgICogQHBhcmFtIHtQbGFuZX0gW3A1XSAtIFRoZSBzaXh0aCBwbGFuZSB0aGF0IGVuY2xvc2VzIHRoZSBmcnVzdHVtLgogICAqIEByZXR1cm4ge0ZydXN0dW19IEEgcmVmZXJlbmNlIHRvIHRoaXMgZnJ1c3R1bS4KICAgKi8KICBzZXQodCwgZSwgaSwgbiwgcywgcikgewogICAgY29uc3QgbyA9IHRoaXMucGxhbmVzOwogICAgcmV0dXJuIG9bMF0uY29weSh0KSwgb1sxXS5jb3B5KGUpLCBvWzJdLmNvcHkoaSksIG9bM10uY29weShuKSwgb1s0XS5jb3B5KHMpLCBvWzVdLmNvcHkociksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBmcnVzdHVtIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0ZydXN0dW19IGZydXN0dW0gLSBUaGUgZnJ1c3R1bSB0byBjb3B5LgogICAqIEByZXR1cm4ge0ZydXN0dW19IEEgcmVmZXJlbmNlIHRvIHRoaXMgZnJ1c3R1bS4KICAgKi8KICBjb3B5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnBsYW5lczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjsgaSsrKQogICAgICBlW2ldLmNvcHkodC5wbGFuZXNbaV0pOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGZydXN0dW0gcGxhbmVzIGZyb20gdGhlIGdpdmVuIHByb2plY3Rpb24gbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIHByb2plY3Rpb24gbWF0cml4LgogICAqIEBwYXJhbSB7KFdlYkdMQ29vcmRpbmF0ZVN5c3RlbXxXZWJHUFVDb29yZGluYXRlU3lzdGVtKX0gY29vcmRpbmF0ZVN5c3RlbSAtIFRoZSBjb29yZGluYXRlIHN5c3RlbS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXZlcnNlZERlcHRoPWZhbHNlXSAtIFdoZXRoZXIgdG8gdXNlIGEgcmV2ZXJzZWQgZGVwdGguCiAgICogQHJldHVybiB7RnJ1c3R1bX0gQSByZWZlcmVuY2UgdG8gdGhpcyBmcnVzdHVtLgogICAqLwogIHNldEZyb21Qcm9qZWN0aW9uTWF0cml4KHQsIGUgPSBOaSwgaSA9ICExKSB7CiAgICBjb25zdCBuID0gdGhpcy5wbGFuZXMsIHMgPSB0LmVsZW1lbnRzLCByID0gc1swXSwgbyA9IHNbMV0sIGwgPSBzWzJdLCBoID0gc1szXSwgYyA9IHNbNF0sIHUgPSBzWzVdLCBkID0gc1s2XSwgcCA9IHNbN10sIGYgPSBzWzhdLCB5ID0gc1s5XSwgZyA9IHNbMTBdLCBtID0gc1sxMV0sIHYgPSBzWzEyXSwgeCA9IHNbMTNdLCBfID0gc1sxNF0sIFMgPSBzWzE1XTsKICAgIGlmIChuWzBdLnNldENvbXBvbmVudHMoaCAtIHIsIHAgLSBjLCBtIC0gZiwgUyAtIHYpLm5vcm1hbGl6ZSgpLCBuWzFdLnNldENvbXBvbmVudHMoaCArIHIsIHAgKyBjLCBtICsgZiwgUyArIHYpLm5vcm1hbGl6ZSgpLCBuWzJdLnNldENvbXBvbmVudHMoaCArIG8sIHAgKyB1LCBtICsgeSwgUyArIHgpLm5vcm1hbGl6ZSgpLCBuWzNdLnNldENvbXBvbmVudHMoaCAtIG8sIHAgLSB1LCBtIC0geSwgUyAtIHgpLm5vcm1hbGl6ZSgpLCBpKQogICAgICBuWzRdLnNldENvbXBvbmVudHMobCwgZCwgZywgXykubm9ybWFsaXplKCksIG5bNV0uc2V0Q29tcG9uZW50cyhoIC0gbCwgcCAtIGQsIG0gLSBnLCBTIC0gXykubm9ybWFsaXplKCk7CiAgICBlbHNlIGlmIChuWzRdLnNldENvbXBvbmVudHMoaCAtIGwsIHAgLSBkLCBtIC0gZywgUyAtIF8pLm5vcm1hbGl6ZSgpLCBlID09PSBOaSkKICAgICAgbls1XS5zZXRDb21wb25lbnRzKGggKyBsLCBwICsgZCwgbSArIGcsIFMgKyBfKS5ub3JtYWxpemUoKTsKICAgIGVsc2UgaWYgKGUgPT09IGdhKQogICAgICBuWzVdLnNldENvbXBvbmVudHMobCwgZCwgZywgXykubm9ybWFsaXplKCk7CiAgICBlbHNlCiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuRnJ1c3R1bS5zZXRGcm9tUHJvamVjdGlvbk1hdHJpeCgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAiICsgZSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIDNEIG9iamVjdCdzIGJvdW5kaW5nIHNwaGVyZSBpcyBpbnRlcnNlY3RpbmcgdGhpcyBmcnVzdHVtLgogICAqCiAgICogTm90ZSB0aGF0IHRoZSAzRCBvYmplY3QgbXVzdCBoYXZlIGEgZ2VvbWV0cnkgc28gdGhhdCB0aGUgYm91bmRpbmcgc3BoZXJlIGNhbiBiZSBjYWxjdWxhdGVkLgogICAqCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIDNEIG9iamVjdCdzIGJvdW5kaW5nIHNwaGVyZSBpcyBpbnRlcnNlY3RpbmcgdGhpcyBmcnVzdHVtIG9yIG5vdC4KICAgKi8KICBpbnRlcnNlY3RzT2JqZWN0KHQpIHsKICAgIGlmICh0LmJvdW5kaW5nU3BoZXJlICE9PSB2b2lkIDApCiAgICAgIHQuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgJiYgdC5jb21wdXRlQm91bmRpbmdTcGhlcmUoKSwgVnMuY29weSh0LmJvdW5kaW5nU3BoZXJlKS5hcHBseU1hdHJpeDQodC5tYXRyaXhXb3JsZCk7CiAgICBlbHNlIHsKICAgICAgY29uc3QgZSA9IHQuZ2VvbWV0cnk7CiAgICAgIGUuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgJiYgZS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKSwgVnMuY29weShlLmJvdW5kaW5nU3BoZXJlKS5hcHBseU1hdHJpeDQodC5tYXRyaXhXb3JsZCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5pbnRlcnNlY3RzU3BoZXJlKFZzKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHNwcml0ZSBpcyBpbnRlcnNlY3RpbmcgdGhpcyBmcnVzdHVtLgogICAqCiAgICogQHBhcmFtIHtTcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBzcHJpdGUgaXMgaW50ZXJzZWN0aW5nIHRoaXMgZnJ1c3R1bSBvciBub3QuCiAgICovCiAgaW50ZXJzZWN0c1Nwcml0ZSh0KSB7CiAgICBWcy5jZW50ZXIuc2V0KDAsIDAsIDApOwogICAgY29uc3QgZSA9IFh2LmRpc3RhbmNlVG8odC5jZW50ZXIpOwogICAgcmV0dXJuIFZzLnJhZGl1cyA9IDAuNzA3MTA2NzgxMTg2NTQ3NiArIGUsIFZzLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkKSwgdGhpcy5pbnRlcnNlY3RzU3BoZXJlKFZzKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIGJvdW5kaW5nIHNwaGVyZSBpcyBpbnRlcnNlY3RpbmcgdGhpcyBmcnVzdHVtLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmV9IHNwaGVyZSAtIFRoZSBib3VuZGluZyBzcGhlcmUgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBib3VuZGluZyBzcGhlcmUgaXMgaW50ZXJzZWN0aW5nIHRoaXMgZnJ1c3R1bSBvciBub3QuCiAgICovCiAgaW50ZXJzZWN0c1NwaGVyZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5wbGFuZXMsIGkgPSB0LmNlbnRlciwgbiA9IC10LnJhZGl1czsKICAgIGZvciAobGV0IHMgPSAwOyBzIDwgNjsgcysrKQogICAgICBpZiAoZVtzXS5kaXN0YW5jZVRvUG9pbnQoaSkgPCBuKQogICAgICAgIHJldHVybiAhMTsKICAgIHJldHVybiAhMDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIGJvdW5kaW5nIGJveCBpcyBpbnRlcnNlY3RpbmcgdGhpcyBmcnVzdHVtLgogICAqCiAgICogQHBhcmFtIHtCb3gzfSBib3ggLSBUaGUgYm91bmRpbmcgYm94IHRvIHRlc3QuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgYm91bmRpbmcgYm94IGlzIGludGVyc2VjdGluZyB0aGlzIGZydXN0dW0gb3Igbm90LgogICAqLwogIGludGVyc2VjdHNCb3godCkgewogICAgY29uc3QgZSA9IHRoaXMucGxhbmVzOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHsKICAgICAgY29uc3QgbiA9IGVbaV07CiAgICAgIGlmICh5bC54ID0gbi5ub3JtYWwueCA+IDAgPyB0Lm1heC54IDogdC5taW4ueCwgeWwueSA9IG4ubm9ybWFsLnkgPiAwID8gdC5tYXgueSA6IHQubWluLnksIHlsLnogPSBuLm5vcm1hbC56ID4gMCA/IHQubWF4LnogOiB0Lm1pbi56LCBuLmRpc3RhbmNlVG9Qb2ludCh5bCkgPCAwKQogICAgICAgIHJldHVybiAhMTsKICAgIH0KICAgIHJldHVybiAhMDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHBvaW50IGxpZXMgd2l0aGluIHRoZSBmcnVzdHVtLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBwb2ludCAtIFRoZSBwb2ludCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHBvaW50IGxpZXMgd2l0aGluIHRoaXMgZnJ1c3R1bSBvciBub3QuCiAgICovCiAgY29udGFpbnNQb2ludCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5wbGFuZXM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykKICAgICAgaWYgKGVbaV0uZGlzdGFuY2VUb1BvaW50KHQpIDwgMCkKICAgICAgICByZXR1cm4gITE7CiAgICByZXR1cm4gITA7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgZnJ1c3R1bSB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7RnJ1c3R1bX0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9Cn0KY29uc3QgeW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIF9uID0gLyogQF9fUFVSRV9fICovIG5ldyBFYSgpOwpjbGFzcyAkYyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBmcnVzdHVtIGFycmF5LgogICAqCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmNvb3JkaW5hdGVTeXN0ZW0gPSBOaTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIDNEIG9iamVjdCdzIGJvdW5kaW5nIHNwaGVyZSBpcyBpbnRlcnNlY3RpbmcgYW55IGZydXN0dW0KICAgKiBmcm9tIHRoZSBjYW1lcmEgYXJyYXkuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgM0Qgb2JqZWN0IHRvIHRlc3QuCiAgICogQHBhcmFtIHtPYmplY3R9IGNhbWVyYUFycmF5IC0gQW4gb2JqZWN0IHdpdGggYSBjYW1lcmFzIHByb3BlcnR5IGNvbnRhaW5pbmcgYW4gYXJyYXkgb2YgY2FtZXJhcy4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSAzRCBvYmplY3QgaXMgdmlzaWJsZSBpbiBhbnkgY2FtZXJhLgogICAqLwogIGludGVyc2VjdHNPYmplY3QodCwgZSkgewogICAgaWYgKCFlLmlzQXJyYXlDYW1lcmEgfHwgZS5jYW1lcmFzLmxlbmd0aCA9PT0gMCkKICAgICAgcmV0dXJuICExOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlLmNhbWVyYXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgbiA9IGUuY2FtZXJhc1tpXTsKICAgICAgaWYgKHluLm11bHRpcGx5TWF0cmljZXMoCiAgICAgICAgbi5wcm9qZWN0aW9uTWF0cml4LAogICAgICAgIG4ubWF0cml4V29ybGRJbnZlcnNlCiAgICAgICksIF9uLnNldEZyb21Qcm9qZWN0aW9uTWF0cml4KAogICAgICAgIHluLAogICAgICAgIG4uY29vcmRpbmF0ZVN5c3RlbSwKICAgICAgICBuLnJldmVyc2VkRGVwdGgKICAgICAgKSwgX24uaW50ZXJzZWN0c09iamVjdCh0KSkKICAgICAgICByZXR1cm4gITA7CiAgICB9CiAgICByZXR1cm4gITE7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiBzcHJpdGUgaXMgaW50ZXJzZWN0aW5nIGFueSBmcnVzdHVtCiAgICogZnJvbSB0aGUgY2FtZXJhIGFycmF5LgogICAqCiAgICogQHBhcmFtIHtTcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gdGVzdC4KICAgKiBAcGFyYW0ge09iamVjdH0gY2FtZXJhQXJyYXkgLSBBbiBvYmplY3Qgd2l0aCBhIGNhbWVyYXMgcHJvcGVydHkgY29udGFpbmluZyBhbiBhcnJheSBvZiBjYW1lcmFzLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHNwcml0ZSBpcyB2aXNpYmxlIGluIGFueSBjYW1lcmEuCiAgICovCiAgaW50ZXJzZWN0c1Nwcml0ZSh0LCBlKSB7CiAgICBpZiAoIWUgfHwgIWUuY2FtZXJhcyB8fCBlLmNhbWVyYXMubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gITE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGUuY2FtZXJhcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBuID0gZS5jYW1lcmFzW2ldOwogICAgICBpZiAoeW4ubXVsdGlwbHlNYXRyaWNlcygKICAgICAgICBuLnByb2plY3Rpb25NYXRyaXgsCiAgICAgICAgbi5tYXRyaXhXb3JsZEludmVyc2UKICAgICAgKSwgX24uc2V0RnJvbVByb2plY3Rpb25NYXRyaXgoCiAgICAgICAgeW4sCiAgICAgICAgbi5jb29yZGluYXRlU3lzdGVtLAogICAgICAgIG4ucmV2ZXJzZWREZXB0aAogICAgICApLCBfbi5pbnRlcnNlY3RzU3ByaXRlKHQpKQogICAgICAgIHJldHVybiAhMDsKICAgIH0KICAgIHJldHVybiAhMTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIGJvdW5kaW5nIHNwaGVyZSBpcyBpbnRlcnNlY3RpbmcgYW55IGZydXN0dW0KICAgKiBmcm9tIHRoZSBjYW1lcmEgYXJyYXkuCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyZX0gc3BoZXJlIC0gVGhlIGJvdW5kaW5nIHNwaGVyZSB0byB0ZXN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBjYW1lcmFBcnJheSAtIEFuIG9iamVjdCB3aXRoIGEgY2FtZXJhcyBwcm9wZXJ0eSBjb250YWluaW5nIGFuIGFycmF5IG9mIGNhbWVyYXMuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgc3BoZXJlIGlzIHZpc2libGUgaW4gYW55IGNhbWVyYS4KICAgKi8KICBpbnRlcnNlY3RzU3BoZXJlKHQsIGUpIHsKICAgIGlmICghZSB8fCAhZS5jYW1lcmFzIHx8IGUuY2FtZXJhcy5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAhMTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZS5jYW1lcmFzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IG4gPSBlLmNhbWVyYXNbaV07CiAgICAgIGlmICh5bi5tdWx0aXBseU1hdHJpY2VzKAogICAgICAgIG4ucHJvamVjdGlvbk1hdHJpeCwKICAgICAgICBuLm1hdHJpeFdvcmxkSW52ZXJzZQogICAgICApLCBfbi5zZXRGcm9tUHJvamVjdGlvbk1hdHJpeCgKICAgICAgICB5biwKICAgICAgICBuLmNvb3JkaW5hdGVTeXN0ZW0sCiAgICAgICAgbi5yZXZlcnNlZERlcHRoCiAgICAgICksIF9uLmludGVyc2VjdHNTcGhlcmUodCkpCiAgICAgICAgcmV0dXJuICEwOwogICAgfQogICAgcmV0dXJuICExOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gYm91bmRpbmcgYm94IGlzIGludGVyc2VjdGluZyBhbnkgZnJ1c3R1bQogICAqIGZyb20gdGhlIGNhbWVyYSBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7Qm94M30gYm94IC0gVGhlIGJvdW5kaW5nIGJveCB0byB0ZXN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBjYW1lcmFBcnJheSAtIEFuIG9iamVjdCB3aXRoIGEgY2FtZXJhcyBwcm9wZXJ0eSBjb250YWluaW5nIGFuIGFycmF5IG9mIGNhbWVyYXMuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgYm94IGlzIHZpc2libGUgaW4gYW55IGNhbWVyYS4KICAgKi8KICBpbnRlcnNlY3RzQm94KHQsIGUpIHsKICAgIGlmICghZSB8fCAhZS5jYW1lcmFzIHx8IGUuY2FtZXJhcy5sZW5ndGggPT09IDApCiAgICAgIHJldHVybiAhMTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZS5jYW1lcmFzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IG4gPSBlLmNhbWVyYXNbaV07CiAgICAgIGlmICh5bi5tdWx0aXBseU1hdHJpY2VzKAogICAgICAgIG4ucHJvamVjdGlvbk1hdHJpeCwKICAgICAgICBuLm1hdHJpeFdvcmxkSW52ZXJzZQogICAgICApLCBfbi5zZXRGcm9tUHJvamVjdGlvbk1hdHJpeCgKICAgICAgICB5biwKICAgICAgICBuLmNvb3JkaW5hdGVTeXN0ZW0sCiAgICAgICAgbi5yZXZlcnNlZERlcHRoCiAgICAgICksIF9uLmludGVyc2VjdHNCb3godCkpCiAgICAgICAgcmV0dXJuICEwOwogICAgfQogICAgcmV0dXJuICExOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gcG9pbnQgbGllcyB3aXRoaW4gYW55IGZydXN0dW0KICAgKiBmcm9tIHRoZSBjYW1lcmEgYXJyYXkuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBvaW50IHRvIHRlc3QuCiAgICogQHBhcmFtIHtPYmplY3R9IGNhbWVyYUFycmF5IC0gQW4gb2JqZWN0IHdpdGggYSBjYW1lcmFzIHByb3BlcnR5IGNvbnRhaW5pbmcgYW4gYXJyYXkgb2YgY2FtZXJhcy4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBwb2ludCBpcyB2aXNpYmxlIGluIGFueSBjYW1lcmEuCiAgICovCiAgY29udGFpbnNQb2ludCh0LCBlKSB7CiAgICBpZiAoIWUgfHwgIWUuY2FtZXJhcyB8fCBlLmNhbWVyYXMubGVuZ3RoID09PSAwKQogICAgICByZXR1cm4gITE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGUuY2FtZXJhcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBuID0gZS5jYW1lcmFzW2ldOwogICAgICBpZiAoeW4ubXVsdGlwbHlNYXRyaWNlcygKICAgICAgICBuLnByb2plY3Rpb25NYXRyaXgsCiAgICAgICAgbi5tYXRyaXhXb3JsZEludmVyc2UKICAgICAgKSwgX24uc2V0RnJvbVByb2plY3Rpb25NYXRyaXgoCiAgICAgICAgeW4sCiAgICAgICAgbi5jb29yZGluYXRlU3lzdGVtLAogICAgICAgIG4ucmV2ZXJzZWREZXB0aAogICAgICApLCBfbi5jb250YWluc1BvaW50KHQpKQogICAgICAgIHJldHVybiAhMDsKICAgIH0KICAgIHJldHVybiAhMTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBmcnVzdHVtIGFycmF5IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtGcnVzdHVtQXJyYXl9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgJGMoKTsKICB9Cn0KZnVuY3Rpb24gVnUoYSwgdCkgewogIHJldHVybiBhIC0gdDsKfQpmdW5jdGlvbiBZdihhLCB0KSB7CiAgcmV0dXJuIGEueiAtIHQuejsKfQpmdW5jdGlvbiBadihhLCB0KSB7CiAgcmV0dXJuIHQueiAtIGEuejsKfQpjbGFzcyBqdiB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmluZGV4ID0gMCwgdGhpcy5wb29sID0gW10sIHRoaXMubGlzdCA9IFtdOwogIH0KICBwdXNoKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSB0aGlzLnBvb2wsIHIgPSB0aGlzLmxpc3Q7CiAgICB0aGlzLmluZGV4ID49IHMubGVuZ3RoICYmIHMucHVzaCh7CiAgICAgIHN0YXJ0OiAtMSwKICAgICAgY291bnQ6IC0xLAogICAgICB6OiAtMSwKICAgICAgaW5kZXg6IC0xCiAgICB9KTsKICAgIGNvbnN0IG8gPSBzW3RoaXMuaW5kZXhdOwogICAgci5wdXNoKG8pLCB0aGlzLmluZGV4KyssIG8uc3RhcnQgPSB0LCBvLmNvdW50ID0gZSwgby56ID0gaSwgby5pbmRleCA9IG47CiAgfQogIHJlc2V0KCkgewogICAgdGhpcy5saXN0Lmxlbmd0aCA9IDAsIHRoaXMuaW5kZXggPSAwOwogIH0KfQpjb25zdCB2aSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKSwgSnYgPSAvKiBAX19QVVJFX18gKi8gbmV3IGN0KDEsIDEsIDEpLCBybSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRWEoKSwgS3YgPSAvKiBAX19QVVJFX18gKi8gbmV3ICRjKCksIF9sID0gLyogQF9fUFVSRV9fICovIG5ldyB3ZSgpLCBIcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUmUoKSwgcWEgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgYW0gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgUXYgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgSHUgPSAvKiBAX19QVVJFX18gKi8gbmV3IGp2KCksIFFlID0gLyogQF9fUFVSRV9fICovIG5ldyByZSgpLCB4bCA9IFtdOwpmdW5jdGlvbiB0YihhLCB0LCBlID0gMCkgewogIGNvbnN0IGkgPSB0Lml0ZW1TaXplOwogIGlmIChhLmlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUgfHwgYS5hcnJheS5jb25zdHJ1Y3RvciAhPT0gdC5hcnJheS5jb25zdHJ1Y3RvcikgewogICAgY29uc3QgbiA9IGEuY291bnQ7CiAgICBmb3IgKGxldCBzID0gMDsgcyA8IG47IHMrKykKICAgICAgZm9yIChsZXQgciA9IDA7IHIgPCBpOyByKyspCiAgICAgICAgdC5zZXRDb21wb25lbnQocyArIGUsIHIsIGEuZ2V0Q29tcG9uZW50KHMsIHIpKTsKICB9IGVsc2UKICAgIHQuYXJyYXkuc2V0KGEuYXJyYXksIGUgKiBpKTsKICB0Lm5lZWRzVXBkYXRlID0gITA7Cn0KZnVuY3Rpb24gR3MoYSwgdCkgewogIGlmIChhLmNvbnN0cnVjdG9yICE9PSB0LmNvbnN0cnVjdG9yKSB7CiAgICBjb25zdCBlID0gTWF0aC5taW4oYS5sZW5ndGgsIHQubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZTsgaSsrKQogICAgICB0W2ldID0gYVtpXTsKICB9IGVsc2UgewogICAgY29uc3QgZSA9IE1hdGgubWluKGEubGVuZ3RoLCB0Lmxlbmd0aCk7CiAgICB0LnNldChuZXcgYS5jb25zdHJ1Y3RvcihhLmJ1ZmZlciwgMCwgZSkpOwogIH0KfQpjbGFzcyBMeSBleHRlbmRzIHJlIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJhdGNoZWQgbWVzaC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhJbnN0YW5jZUNvdW50IC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIGluZGl2aWR1YWwgaW5zdGFuY2VzIHBsYW5uZWQgdG8gYmUgYWRkZWQgYW5kIHJlbmRlcmVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhWZXJ0ZXhDb3VudCAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiB2ZXJ0aWNlcyB0byBiZSB1c2VkIGJ5IGFsbCB1bmlxdWUgZ2VvbWV0cmllcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW21heEluZGV4Q291bnQ9bWF4VmVydGV4Q291bnQqMl0gLSBUaGUgbWF4aW11bSBudW1iZXIgb2YgaW5kaWNlcyB0byBiZSB1c2VkIGJ5IGFsbCB1bmlxdWUgZ2VvbWV0cmllcwogICAqIEBwYXJhbSB7TWF0ZXJpYWx8QXJyYXk8TWF0ZXJpYWw+fSBbbWF0ZXJpYWxdIC0gVGhlIG1lc2ggbWF0ZXJpYWwuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSA9IGUgKiAyLCBuKSB7CiAgICBzdXBlcihuZXcgSHQoKSwgbiksIHRoaXMuaXNCYXRjaGVkTWVzaCA9ICEwLCB0aGlzLnBlck9iamVjdEZydXN0dW1DdWxsZWQgPSAhMCwgdGhpcy5zb3J0T2JqZWN0cyA9ICEwLCB0aGlzLmJvdW5kaW5nQm94ID0gbnVsbCwgdGhpcy5ib3VuZGluZ1NwaGVyZSA9IG51bGwsIHRoaXMuY3VzdG9tU29ydCA9IG51bGwsIHRoaXMuX2luc3RhbmNlSW5mbyA9IFtdLCB0aGlzLl9nZW9tZXRyeUluZm8gPSBbXSwgdGhpcy5fYXZhaWxhYmxlSW5zdGFuY2VJZHMgPSBbXSwgdGhpcy5fYXZhaWxhYmxlR2VvbWV0cnlJZHMgPSBbXSwgdGhpcy5fbmV4dEluZGV4U3RhcnQgPSAwLCB0aGlzLl9uZXh0VmVydGV4U3RhcnQgPSAwLCB0aGlzLl9nZW9tZXRyeUNvdW50ID0gMCwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgPSAhMCwgdGhpcy5fZ2VvbWV0cnlJbml0aWFsaXplZCA9ICExLCB0aGlzLl9tYXhJbnN0YW5jZUNvdW50ID0gdCwgdGhpcy5fbWF4VmVydGV4Q291bnQgPSBlLCB0aGlzLl9tYXhJbmRleENvdW50ID0gaSwgdGhpcy5fbXVsdGlEcmF3Q291bnRzID0gbmV3IEludDMyQXJyYXkodCksIHRoaXMuX211bHRpRHJhd1N0YXJ0cyA9IG5ldyBJbnQzMkFycmF5KHQpLCB0aGlzLl9tdWx0aURyYXdDb3VudCA9IDAsIHRoaXMuX211bHRpRHJhd0luc3RhbmNlcyA9IG51bGwsIHRoaXMuX21hdHJpY2VzVGV4dHVyZSA9IG51bGwsIHRoaXMuX2luZGlyZWN0VGV4dHVyZSA9IG51bGwsIHRoaXMuX2NvbG9yc1RleHR1cmUgPSBudWxsLCB0aGlzLl9pbml0TWF0cmljZXNUZXh0dXJlKCksIHRoaXMuX2luaXRJbmRpcmVjdFRleHR1cmUoKTsKICB9CiAgLyoqCiAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIGluZGl2aWR1YWwgaW5zdGFuY2VzIHRoYXQgY2FuIGJlIHN0b3JlZCBpbiB0aGUgYmF0Y2guCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEByZWFkb25seQogICAqLwogIGdldCBtYXhJbnN0YW5jZUNvdW50KCkgewogICAgcmV0dXJuIHRoaXMuX21heEluc3RhbmNlQ291bnQ7CiAgfQogIC8qKgogICAqIFRoZSBpbnN0YW5jZSBjb3VudC4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQHJlYWRvbmx5CiAgICovCiAgZ2V0IGluc3RhbmNlQ291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5faW5zdGFuY2VJbmZvLmxlbmd0aCAtIHRoaXMuX2F2YWlsYWJsZUluc3RhbmNlSWRzLmxlbmd0aDsKICB9CiAgLyoqCiAgICogVGhlIG51bWJlciBvZiB1bnVzZWQgdmVydGljZXMuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEByZWFkb25seQogICAqLwogIGdldCB1bnVzZWRWZXJ0ZXhDb3VudCgpIHsKICAgIHJldHVybiB0aGlzLl9tYXhWZXJ0ZXhDb3VudCAtIHRoaXMuX25leHRWZXJ0ZXhTdGFydDsKICB9CiAgLyoqCiAgICogVGhlIG51bWJlciBvZiB1bnVzZWQgaW5kaWNlcy4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQHJlYWRvbmx5CiAgICovCiAgZ2V0IHVudXNlZEluZGV4Q291bnQoKSB7CiAgICByZXR1cm4gdGhpcy5fbWF4SW5kZXhDb3VudCAtIHRoaXMuX25leHRJbmRleFN0YXJ0OwogIH0KICBfaW5pdE1hdHJpY2VzVGV4dHVyZSgpIHsKICAgIGxldCB0ID0gTWF0aC5zcXJ0KHRoaXMuX21heEluc3RhbmNlQ291bnQgKiA0KTsKICAgIHQgPSBNYXRoLmNlaWwodCAvIDQpICogNCwgdCA9IE1hdGgubWF4KHQsIDQpOwogICAgY29uc3QgZSA9IG5ldyBGbG9hdDMyQXJyYXkodCAqIHQgKiA0KSwgaSA9IG5ldyBDbihlLCB0LCB0LCBnaSwgd2kpOwogICAgdGhpcy5fbWF0cmljZXNUZXh0dXJlID0gaTsKICB9CiAgX2luaXRJbmRpcmVjdFRleHR1cmUoKSB7CiAgICBsZXQgdCA9IE1hdGguc3FydCh0aGlzLl9tYXhJbnN0YW5jZUNvdW50KTsKICAgIHQgPSBNYXRoLmNlaWwodCk7CiAgICBjb25zdCBlID0gbmV3IFVpbnQzMkFycmF5KHQgKiB0KSwgaSA9IG5ldyBDbihlLCB0LCB0LCBObywgbnMpOwogICAgdGhpcy5faW5kaXJlY3RUZXh0dXJlID0gaTsKICB9CiAgX2luaXRDb2xvcnNUZXh0dXJlKCkgewogICAgbGV0IHQgPSBNYXRoLnNxcnQodGhpcy5fbWF4SW5zdGFuY2VDb3VudCk7CiAgICB0ID0gTWF0aC5jZWlsKHQpOwogICAgY29uc3QgZSA9IG5ldyBGbG9hdDMyQXJyYXkodCAqIHQgKiA0KS5maWxsKDEpLCBpID0gbmV3IENuKGUsIHQsIHQsIGdpLCB3aSk7CiAgICBpLmNvbG9yU3BhY2UgPSBlZS53b3JraW5nQ29sb3JTcGFjZSwgdGhpcy5fY29sb3JzVGV4dHVyZSA9IGk7CiAgfQogIF9pbml0aWFsaXplR2VvbWV0cnkodCkgewogICAgY29uc3QgZSA9IHRoaXMuZ2VvbWV0cnksIGkgPSB0aGlzLl9tYXhWZXJ0ZXhDb3VudCwgbiA9IHRoaXMuX21heEluZGV4Q291bnQ7CiAgICBpZiAodGhpcy5fZ2VvbWV0cnlJbml0aWFsaXplZCA9PT0gITEpIHsKICAgICAgZm9yIChjb25zdCBzIGluIHQuYXR0cmlidXRlcykgewogICAgICAgIGNvbnN0IHIgPSB0LmdldEF0dHJpYnV0ZShzKSwgeyBhcnJheTogbywgaXRlbVNpemU6IGwsIG5vcm1hbGl6ZWQ6IGggfSA9IHIsIGMgPSBuZXcgby5jb25zdHJ1Y3RvcihpICogbCksIHUgPSBuZXcgaWUoYywgbCwgaCk7CiAgICAgICAgZS5zZXRBdHRyaWJ1dGUocywgdSk7CiAgICAgIH0KICAgICAgaWYgKHQuZ2V0SW5kZXgoKSAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IHMgPSBpID4gNjU1MzUgPyBuZXcgVWludDMyQXJyYXkobikgOiBuZXcgVWludDE2QXJyYXkobik7CiAgICAgICAgZS5zZXRJbmRleChuZXcgaWUocywgMSkpOwogICAgICB9CiAgICAgIHRoaXMuX2dlb21ldHJ5SW5pdGlhbGl6ZWQgPSAhMDsKICAgIH0KICB9CiAgLy8gTWFrZSBzdXJlIHRoZSBnZW9tZXRyeSBpcyBjb21wYXRpYmxlIHdpdGggdGhlIGV4aXN0aW5nIGNvbWJpbmVkIGdlb21ldHJ5IGF0dHJpYnV0ZXMKICBfdmFsaWRhdGVHZW9tZXRyeSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5nZW9tZXRyeTsKICAgIGlmICghIXQuZ2V0SW5kZXgoKSAhPSAhIWUuZ2V0SW5kZXgoKSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdUSFJFRS5CYXRjaGVkTWVzaDogQWxsIGdlb21ldHJpZXMgbXVzdCBjb25zaXN0ZW50bHkgaGF2ZSAiaW5kZXgiLicpOwogICAgZm9yIChjb25zdCBpIGluIGUuYXR0cmlidXRlcykgewogICAgICBpZiAoIXQuaGFzQXR0cmlidXRlKGkpKQogICAgICAgIHRocm93IG5ldyBFcnJvcihgVEhSRUUuQmF0Y2hlZE1lc2g6IEFkZGVkIGdlb21ldHJ5IG1pc3NpbmcgIiR7aX0iLiBBbGwgZ2VvbWV0cmllcyBtdXN0IGhhdmUgY29uc2lzdGVudCBhdHRyaWJ1dGVzLmApOwogICAgICBjb25zdCBuID0gdC5nZXRBdHRyaWJ1dGUoaSksIHMgPSBlLmdldEF0dHJpYnV0ZShpKTsKICAgICAgaWYgKG4uaXRlbVNpemUgIT09IHMuaXRlbVNpemUgfHwgbi5ub3JtYWxpemVkICE9PSBzLm5vcm1hbGl6ZWQpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5CYXRjaGVkTWVzaDogQWxsIGF0dHJpYnV0ZXMgbXVzdCBoYXZlIGEgY29uc2lzdGVudCBpdGVtU2l6ZSBhbmQgbm9ybWFsaXplZCB2YWx1ZS4iKTsKICAgIH0KICB9CiAgLyoqCiAgICogVmFsaWRhdGVzIHRoZSBpbnN0YW5jZSBkZWZpbmVkIGJ5IHRoZSBnaXZlbiBJRC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnN0YW5jZUlkIC0gVGhlIGluc3RhbmNlIHRvIHZhbGlkYXRlLgogICAqLwogIHZhbGlkYXRlSW5zdGFuY2VJZCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5faW5zdGFuY2VJbmZvOwogICAgaWYgKHQgPCAwIHx8IHQgPj0gZS5sZW5ndGggfHwgZVt0XS5hY3RpdmUgPT09ICExKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYFRIUkVFLkJhdGNoZWRNZXNoOiBJbnZhbGlkIGluc3RhbmNlSWQgJHt0fS4gSW5zdGFuY2UgaXMgZWl0aGVyIG91dCBvZiByYW5nZSBvciBoYXMgYmVlbiBkZWxldGVkLmApOwogIH0KICAvKioKICAgKiBWYWxpZGF0ZXMgdGhlIGdlb21ldHJ5IGRlZmluZWQgYnkgdGhlIGdpdmVuIElELgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGdlb21ldHJ5SWQgLSBUaGUgZ2VvbWV0cnkgdG8gdmFsaWRhdGUuCiAgICovCiAgdmFsaWRhdGVHZW9tZXRyeUlkKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLl9nZW9tZXRyeUluZm87CiAgICBpZiAodCA8IDAgfHwgdCA+PSBlLmxlbmd0aCB8fCBlW3RdLmFjdGl2ZSA9PT0gITEpCiAgICAgIHRocm93IG5ldyBFcnJvcihgVEhSRUUuQmF0Y2hlZE1lc2g6IEludmFsaWQgZ2VvbWV0cnlJZCAke3R9LiBHZW9tZXRyeSBpcyBlaXRoZXIgb3V0IG9mIHJhbmdlIG9yIGhhcyBiZWVuIGRlbGV0ZWQuYCk7CiAgfQogIC8qKgogICAqIFRha2VzIGEgc29ydCBhIGZ1bmN0aW9uIHRoYXQgaXMgcnVuIGJlZm9yZSByZW5kZXIuIFRoZSBmdW5jdGlvbiB0YWtlcyBhIGxpc3Qgb2YgaW5zdGFuY2VzIHRvCiAgICogc29ydCBhbmQgYSBjYW1lcmEuIFRoZSBvYmplY3RzIGluIHRoZSBsaXN0IGluY2x1ZGUgYSAieiIgZmllbGQgdG8gcGVyZm9ybSBhIGRlcHRoLW9yZGVyZWQgc29ydCB3aXRoLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyAtIFRoZSBjdXN0b20gc29ydCBmdW5jdGlvbi4KICAgKiBAcmV0dXJuIHtCYXRjaGVkTWVzaH0gQSByZWZlcmVuY2UgdG8gdGhpcyBiYXRjaGVkIG1lc2guCiAgICovCiAgc2V0Q3VzdG9tU29ydCh0KSB7CiAgICByZXR1cm4gdGhpcy5jdXN0b21Tb3J0ID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIGJveCwgdXBkYXRpbmcge0BsaW5rIEJhdGNoZWRNZXNoI2JvdW5kaW5nQm94fS4KICAgKiBCb3VuZGluZyBib3hlcyBhcmVuJ3QgY29tcHV0ZWQgYnkgZGVmYXVsdC4gVGhleSBuZWVkIHRvIGJlIGV4cGxpY2l0bHkgY29tcHV0ZWQsCiAgICogb3RoZXJ3aXNlIHRoZXkgYXJlIGBudWxsYC4KICAgKi8KICBjb21wdXRlQm91bmRpbmdCb3goKSB7CiAgICB0aGlzLmJvdW5kaW5nQm94ID09PSBudWxsICYmICh0aGlzLmJvdW5kaW5nQm94ID0gbmV3IHdlKCkpOwogICAgY29uc3QgdCA9IHRoaXMuYm91bmRpbmdCb3gsIGUgPSB0aGlzLl9pbnN0YW5jZUluZm87CiAgICB0Lm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBpZiAoZVtpXS5hY3RpdmUgPT09ICExKSBjb250aW51ZTsKICAgICAgY29uc3QgcyA9IGVbaV0uZ2VvbWV0cnlJbmRleDsKICAgICAgdGhpcy5nZXRNYXRyaXhBdChpLCB2aSksIHRoaXMuZ2V0Qm91bmRpbmdCb3hBdChzLCBfbCkuYXBwbHlNYXRyaXg0KHZpKSwgdC51bmlvbihfbCk7CiAgICB9CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBib3VuZGluZyBzcGhlcmUsIHVwZGF0aW5nIHtAbGluayBCYXRjaGVkTWVzaCNib3VuZGluZ1NwaGVyZX0uCiAgICogQm91bmRpbmcgc3BoZXJlcyBhcmVuJ3QgY29tcHV0ZWQgYnkgZGVmYXVsdC4gVGhleSBuZWVkIHRvIGJlIGV4cGxpY2l0bHkgY29tcHV0ZWQsCiAgICogb3RoZXJ3aXNlIHRoZXkgYXJlIGBudWxsYC4KICAgKi8KICBjb21wdXRlQm91bmRpbmdTcGhlcmUoKSB7CiAgICB0aGlzLmJvdW5kaW5nU3BoZXJlID09PSBudWxsICYmICh0aGlzLmJvdW5kaW5nU3BoZXJlID0gbmV3IFJlKCkpOwogICAgY29uc3QgdCA9IHRoaXMuYm91bmRpbmdTcGhlcmUsIGUgPSB0aGlzLl9pbnN0YW5jZUluZm87CiAgICB0Lm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBpZiAoZVtpXS5hY3RpdmUgPT09ICExKSBjb250aW51ZTsKICAgICAgY29uc3QgcyA9IGVbaV0uZ2VvbWV0cnlJbmRleDsKICAgICAgdGhpcy5nZXRNYXRyaXhBdChpLCB2aSksIHRoaXMuZ2V0Qm91bmRpbmdTcGhlcmVBdChzLCBIcykuYXBwbHlNYXRyaXg0KHZpKSwgdC51bmlvbihIcyk7CiAgICB9CiAgfQogIC8qKgogICAqIEFkZHMgYSBuZXcgaW5zdGFuY2UgdG8gdGhlIGJhdGNoIHVzaW5nIHRoZSBnZW9tZXRyeSBvZiB0aGUgZ2l2ZW4gSUQgYW5kIHJldHVybnMKICAgKiBhIG5ldyBpZCByZWZlcnJpbmcgdG8gdGhlIG5ldyBpbnN0YW5jZSB0byBiZSB1c2VkIGJ5IG90aGVyIGZ1bmN0aW9ucy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBnZW9tZXRyeUlkIC0gVGhlIElEIG9mIGEgcHJldmlvdXNseSBhZGRlZCBnZW9tZXRyeSB2aWEge0BsaW5rIEJhdGNoZWRNZXNoI2FkZEdlb21ldHJ5fS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbnN0YW5jZSBJRC4KICAgKi8KICBhZGRJbnN0YW5jZSh0KSB7CiAgICBpZiAodGhpcy5faW5zdGFuY2VJbmZvLmxlbmd0aCA+PSB0aGlzLm1heEluc3RhbmNlQ291bnQgJiYgdGhpcy5fYXZhaWxhYmxlSW5zdGFuY2VJZHMubGVuZ3RoID09PSAwKQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLkJhdGNoZWRNZXNoOiBNYXhpbXVtIGl0ZW0gY291bnQgcmVhY2hlZC4iKTsKICAgIGNvbnN0IGkgPSB7CiAgICAgIHZpc2libGU6ICEwLAogICAgICBhY3RpdmU6ICEwLAogICAgICBnZW9tZXRyeUluZGV4OiB0CiAgICB9OwogICAgbGV0IG4gPSBudWxsOwogICAgdGhpcy5fYXZhaWxhYmxlSW5zdGFuY2VJZHMubGVuZ3RoID4gMCA/ICh0aGlzLl9hdmFpbGFibGVJbnN0YW5jZUlkcy5zb3J0KFZ1KSwgbiA9IHRoaXMuX2F2YWlsYWJsZUluc3RhbmNlSWRzLnNoaWZ0KCksIHRoaXMuX2luc3RhbmNlSW5mb1tuXSA9IGkpIDogKG4gPSB0aGlzLl9pbnN0YW5jZUluZm8ubGVuZ3RoLCB0aGlzLl9pbnN0YW5jZUluZm8ucHVzaChpKSk7CiAgICBjb25zdCBzID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlOwogICAgdmkuaWRlbnRpdHkoKS50b0FycmF5KHMuaW1hZ2UuZGF0YSwgbiAqIDE2KSwgcy5uZWVkc1VwZGF0ZSA9ICEwOwogICAgY29uc3QgciA9IHRoaXMuX2NvbG9yc1RleHR1cmU7CiAgICByZXR1cm4gciAmJiAoSnYudG9BcnJheShyLmltYWdlLmRhdGEsIG4gKiA0KSwgci5uZWVkc1VwZGF0ZSA9ICEwKSwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgPSAhMCwgbjsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gZ2VvbWV0cnkgdG8gdGhlIGJhdGNoIGFuZCByZXR1cm5zIHRoZSBhc3NvY2lhdGVkCiAgICogZ2VvbWV0cnkgaWQgcmVmZXJyaW5nIHRvIGl0IHRvIGJlIHVzZWQgaW4gb3RoZXIgZnVuY3Rpb25zLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgZ2VvbWV0cnkgdG8gYWRkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmVzZXJ2ZWRWZXJ0ZXhDb3VudD0tMV0gLSBPcHRpb25hbCBwYXJhbWV0ZXIgc3BlY2lmeWluZyB0aGUgYW1vdW50IG9mCiAgICogdmVydGV4IGJ1ZmZlciBzcGFjZSB0byByZXNlcnZlIGZvciB0aGUgYWRkZWQgZ2VvbWV0cnkuIFRoaXMgaXMgbmVjZXNzYXJ5IGlmIGl0IGlzIHBsYW5uZWQKICAgKiB0byBzZXQgYSBuZXcgZ2VvbWV0cnkgYXQgdGhpcyBpbmRleCBhdCBhIGxhdGVyIHRpbWUgdGhhdCBpcyBsYXJnZXIgdGhhbiB0aGUgb3JpZ2luYWwgZ2VvbWV0cnkuCiAgICogRGVmYXVsdHMgdG8gdGhlIGxlbmd0aCBvZiB0aGUgZ2l2ZW4gZ2VvbWV0cnkgdmVydGV4IGJ1ZmZlci4KICAgKiBAcGFyYW0ge251bWJlcn0gW3Jlc2VydmVkSW5kZXhDb3VudD0tMV0gLSBPcHRpb25hbCBwYXJhbWV0ZXIgc3BlY2lmeWluZyB0aGUgYW1vdW50IG9mIGluZGV4CiAgICogYnVmZmVyIHNwYWNlIHRvIHJlc2VydmUgZm9yIHRoZSBhZGRlZCBnZW9tZXRyeS4gVGhpcyBpcyBuZWNlc3NhcnkgaWYgaXQgaXMgcGxhbm5lZCB0byBzZXQgYQogICAqIG5ldyBnZW9tZXRyeSBhdCB0aGlzIGluZGV4IGF0IGEgbGF0ZXIgdGltZSB0aGF0IGlzIGxhcmdlciB0aGFuIHRoZSBvcmlnaW5hbCBnZW9tZXRyeS4gRGVmYXVsdHMgdG8KICAgKiB0aGUgbGVuZ3RoIG9mIHRoZSBnaXZlbiBnZW9tZXRyeSBpbmRleCBidWZmZXIuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZ2VvbWV0cnkgSUQuCiAgICovCiAgYWRkR2VvbWV0cnkodCwgZSA9IC0xLCBpID0gLTEpIHsKICAgIHRoaXMuX2luaXRpYWxpemVHZW9tZXRyeSh0KSwgdGhpcy5fdmFsaWRhdGVHZW9tZXRyeSh0KTsKICAgIGNvbnN0IG4gPSB7CiAgICAgIC8vIGdlb21ldHJ5IGluZm9ybWF0aW9uCiAgICAgIHZlcnRleFN0YXJ0OiAtMSwKICAgICAgdmVydGV4Q291bnQ6IC0xLAogICAgICByZXNlcnZlZFZlcnRleENvdW50OiAtMSwKICAgICAgaW5kZXhTdGFydDogLTEsCiAgICAgIGluZGV4Q291bnQ6IC0xLAogICAgICByZXNlcnZlZEluZGV4Q291bnQ6IC0xLAogICAgICAvLyBkcmF3IHJhbmdlIGluZm9ybWF0aW9uCiAgICAgIHN0YXJ0OiAtMSwKICAgICAgY291bnQ6IC0xLAogICAgICAvLyBzdGF0ZQogICAgICBib3VuZGluZ0JveDogbnVsbCwKICAgICAgYm91bmRpbmdTcGhlcmU6IG51bGwsCiAgICAgIGFjdGl2ZTogITAKICAgIH0sIHMgPSB0aGlzLl9nZW9tZXRyeUluZm87CiAgICBuLnZlcnRleFN0YXJ0ID0gdGhpcy5fbmV4dFZlcnRleFN0YXJ0LCBuLnJlc2VydmVkVmVydGV4Q291bnQgPSBlID09PSAtMSA/IHQuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpLmNvdW50IDogZTsKICAgIGNvbnN0IHIgPSB0LmdldEluZGV4KCk7CiAgICBpZiAociAhPT0gbnVsbCAmJiAobi5pbmRleFN0YXJ0ID0gdGhpcy5fbmV4dEluZGV4U3RhcnQsIG4ucmVzZXJ2ZWRJbmRleENvdW50ID0gaSA9PT0gLTEgPyByLmNvdW50IDogaSksIG4uaW5kZXhTdGFydCAhPT0gLTEgJiYgbi5pbmRleFN0YXJ0ICsgbi5yZXNlcnZlZEluZGV4Q291bnQgPiB0aGlzLl9tYXhJbmRleENvdW50IHx8IG4udmVydGV4U3RhcnQgKyBuLnJlc2VydmVkVmVydGV4Q291bnQgPiB0aGlzLl9tYXhWZXJ0ZXhDb3VudCkKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5CYXRjaGVkTWVzaDogUmVzZXJ2ZWQgc3BhY2UgcmVxdWVzdCBleGNlZWRzIHRoZSBtYXhpbXVtIGJ1ZmZlciBzaXplLiIpOwogICAgbGV0IGw7CiAgICByZXR1cm4gdGhpcy5fYXZhaWxhYmxlR2VvbWV0cnlJZHMubGVuZ3RoID4gMCA/ICh0aGlzLl9hdmFpbGFibGVHZW9tZXRyeUlkcy5zb3J0KFZ1KSwgbCA9IHRoaXMuX2F2YWlsYWJsZUdlb21ldHJ5SWRzLnNoaWZ0KCksIHNbbF0gPSBuKSA6IChsID0gdGhpcy5fZ2VvbWV0cnlDb3VudCwgdGhpcy5fZ2VvbWV0cnlDb3VudCsrLCBzLnB1c2gobikpLCB0aGlzLnNldEdlb21ldHJ5QXQobCwgdCksIHRoaXMuX25leHRJbmRleFN0YXJ0ID0gbi5pbmRleFN0YXJ0ICsgbi5yZXNlcnZlZEluZGV4Q291bnQsIHRoaXMuX25leHRWZXJ0ZXhTdGFydCA9IG4udmVydGV4U3RhcnQgKyBuLnJlc2VydmVkVmVydGV4Q291bnQsIGw7CiAgfQogIC8qKgogICAqIFJlcGxhY2VzIHRoZSBnZW9tZXRyeSBhdCB0aGUgZ2l2ZW4gSUQgd2l0aCB0aGUgcHJvdmlkZWQgZ2VvbWV0cnkuIFRocm93cyBhbiBlcnJvciBpZiB0aGVyZQogICAqIGlzIG5vdCBlbm91Z2ggc3BhY2UgcmVzZXJ2ZWQgZm9yIGdlb21ldHJ5LiBDYWxsaW5nIHRoaXMgd2lsbCBjaGFuZ2UgYWxsIGluc3RhbmNlcyB0aGF0IGFyZQogICAqIHJlbmRlcmluZyB0aGF0IGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGdlb21ldHJ5SWQgLSBUaGUgSUQgb2YgdGhlIGdlb21ldHJ5IHRoYXQgc2hvdWxkIGJlIHJlcGxhY2VkIHdpdGggdGhlIGdpdmVuIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IGdlb21ldHJ5IC0gVGhlIG5ldyBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBnZW9tZXRyeSBJRC4KICAgKi8KICBzZXRHZW9tZXRyeUF0KHQsIGUpIHsKICAgIGlmICh0ID49IHRoaXMuX2dlb21ldHJ5Q291bnQpCiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuQmF0Y2hlZE1lc2g6IE1heGltdW0gZ2VvbWV0cnkgY291bnQgcmVhY2hlZC4iKTsKICAgIHRoaXMuX3ZhbGlkYXRlR2VvbWV0cnkoZSk7CiAgICBjb25zdCBpID0gdGhpcy5nZW9tZXRyeSwgbiA9IGkuZ2V0SW5kZXgoKSAhPT0gbnVsbCwgcyA9IGkuZ2V0SW5kZXgoKSwgciA9IGUuZ2V0SW5kZXgoKSwgbyA9IHRoaXMuX2dlb21ldHJ5SW5mb1t0XTsKICAgIGlmIChuICYmIHIuY291bnQgPiBvLnJlc2VydmVkSW5kZXhDb3VudCB8fCBlLmF0dHJpYnV0ZXMucG9zaXRpb24uY291bnQgPiBvLnJlc2VydmVkVmVydGV4Q291bnQpCiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuQmF0Y2hlZE1lc2g6IFJlc2VydmVkIHNwYWNlIG5vdCBsYXJnZSBlbm91Z2ggZm9yIHByb3ZpZGVkIGdlb21ldHJ5LiIpOwogICAgY29uc3QgbCA9IG8udmVydGV4U3RhcnQsIGggPSBvLnJlc2VydmVkVmVydGV4Q291bnQ7CiAgICBvLnZlcnRleENvdW50ID0gZS5nZXRBdHRyaWJ1dGUoInBvc2l0aW9uIikuY291bnQ7CiAgICBmb3IgKGNvbnN0IGMgaW4gaS5hdHRyaWJ1dGVzKSB7CiAgICAgIGNvbnN0IHUgPSBlLmdldEF0dHJpYnV0ZShjKSwgZCA9IGkuZ2V0QXR0cmlidXRlKGMpOwogICAgICB0Yih1LCBkLCBsKTsKICAgICAgY29uc3QgcCA9IHUuaXRlbVNpemU7CiAgICAgIGZvciAobGV0IGYgPSB1LmNvdW50LCB5ID0gaDsgZiA8IHk7IGYrKykgewogICAgICAgIGNvbnN0IGcgPSBsICsgZjsKICAgICAgICBmb3IgKGxldCBtID0gMDsgbSA8IHA7IG0rKykKICAgICAgICAgIGQuc2V0Q29tcG9uZW50KGcsIG0sIDApOwogICAgICB9CiAgICAgIGQubmVlZHNVcGRhdGUgPSAhMCwgZC5hZGRVcGRhdGVSYW5nZShsICogcCwgaCAqIHApOwogICAgfQogICAgaWYgKG4pIHsKICAgICAgY29uc3QgYyA9IG8uaW5kZXhTdGFydCwgdSA9IG8ucmVzZXJ2ZWRJbmRleENvdW50OwogICAgICBvLmluZGV4Q291bnQgPSBlLmdldEluZGV4KCkuY291bnQ7CiAgICAgIGZvciAobGV0IGQgPSAwOyBkIDwgci5jb3VudDsgZCsrKQogICAgICAgIHMuc2V0WChjICsgZCwgbCArIHIuZ2V0WChkKSk7CiAgICAgIGZvciAobGV0IGQgPSByLmNvdW50LCBwID0gdTsgZCA8IHA7IGQrKykKICAgICAgICBzLnNldFgoYyArIGQsIGwpOwogICAgICBzLm5lZWRzVXBkYXRlID0gITAsIHMuYWRkVXBkYXRlUmFuZ2UoYywgby5yZXNlcnZlZEluZGV4Q291bnQpOwogICAgfQogICAgcmV0dXJuIG8uc3RhcnQgPSBuID8gby5pbmRleFN0YXJ0IDogby52ZXJ0ZXhTdGFydCwgby5jb3VudCA9IG4gPyBvLmluZGV4Q291bnQgOiBvLnZlcnRleENvdW50LCBvLmJvdW5kaW5nQm94ID0gbnVsbCwgZS5ib3VuZGluZ0JveCAhPT0gbnVsbCAmJiAoby5ib3VuZGluZ0JveCA9IGUuYm91bmRpbmdCb3guY2xvbmUoKSksIG8uYm91bmRpbmdTcGhlcmUgPSBudWxsLCBlLmJvdW5kaW5nU3BoZXJlICE9PSBudWxsICYmIChvLmJvdW5kaW5nU3BoZXJlID0gZS5ib3VuZGluZ1NwaGVyZS5jbG9uZSgpKSwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgPSAhMCwgdDsKICB9CiAgLyoqCiAgICogRGVsZXRlcyB0aGUgZ2VvbWV0cnkgZGVmaW5lZCBieSB0aGUgZ2l2ZW4gSUQgZnJvbSB0aGlzIGJhdGNoLiBBbnkgaW5zdGFuY2VzIHJlZmVyZW5jaW5nCiAgICogdGhpcyBnZW9tZXRyeSB3aWxsIGFsc28gYmUgcmVtb3ZlZCBhcyBhIHNpZGUgZWZmZWN0LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGdlb21ldHJ5SWQgLSBUaGUgSUQgb2YgdGhlIGdlb21ldHJ5IHRvIHJlbW92ZSBmcm9tIHRoZSBiYXRjaC4KICAgKiBAcmV0dXJuIHtCYXRjaGVkTWVzaH0gQSByZWZlcmVuY2UgdG8gdGhpcyBiYXRjaGVkIG1lc2guCiAgICovCiAgZGVsZXRlR2VvbWV0cnkodCkgewogICAgY29uc3QgZSA9IHRoaXMuX2dlb21ldHJ5SW5mbzsKICAgIGlmICh0ID49IGUubGVuZ3RoIHx8IGVbdF0uYWN0aXZlID09PSAhMSkKICAgICAgcmV0dXJuIHRoaXM7CiAgICBjb25zdCBpID0gdGhpcy5faW5zdGFuY2VJbmZvOwogICAgZm9yIChsZXQgbiA9IDAsIHMgPSBpLmxlbmd0aDsgbiA8IHM7IG4rKykKICAgICAgaVtuXS5hY3RpdmUgJiYgaVtuXS5nZW9tZXRyeUluZGV4ID09PSB0ICYmIHRoaXMuZGVsZXRlSW5zdGFuY2Uobik7CiAgICByZXR1cm4gZVt0XS5hY3RpdmUgPSAhMSwgdGhpcy5fYXZhaWxhYmxlR2VvbWV0cnlJZHMucHVzaCh0KSwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgPSAhMCwgdGhpczsKICB9CiAgLyoqCiAgICogRGVsZXRlcyBhbiBleGlzdGluZyBpbnN0YW5jZSBmcm9tIHRoZSBiYXRjaCB1c2luZyB0aGUgZ2l2ZW4gSUQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5zdGFuY2VJZCAtIFRoZSBJRCBvZiB0aGUgaW5zdGFuY2UgdG8gcmVtb3ZlIGZyb20gdGhlIGJhdGNoLgogICAqIEByZXR1cm4ge0JhdGNoZWRNZXNofSBBIHJlZmVyZW5jZSB0byB0aGlzIGJhdGNoZWQgbWVzaC4KICAgKi8KICBkZWxldGVJbnN0YW5jZSh0KSB7CiAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUluc3RhbmNlSWQodCksIHRoaXMuX2luc3RhbmNlSW5mb1t0XS5hY3RpdmUgPSAhMSwgdGhpcy5fYXZhaWxhYmxlSW5zdGFuY2VJZHMucHVzaCh0KSwgdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgPSAhMCwgdGhpczsKICB9CiAgLyoqCiAgICogUmVwYWNrcyB0aGUgc3ViIGdlb21ldHJpZXMgaW4gW25hbWVdIHRvIHJlbW92ZSBhbnkgdW51c2VkIHNwYWNlIHJlbWFpbmluZyBmcm9tCiAgICogcHJldmlvdXNseSBkZWxldGVkIGdlb21ldHJ5LCBmcmVlaW5nIHVwIHNwYWNlIHRvIGFkZCBuZXcgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5zdGFuY2VJZCAtIFRoZSBJRCBvZiB0aGUgaW5zdGFuY2UgdG8gcmVtb3ZlIGZyb20gdGhlIGJhdGNoLgogICAqIEByZXR1cm4ge0JhdGNoZWRNZXNofSBBIHJlZmVyZW5jZSB0byB0aGlzIGJhdGNoZWQgbWVzaC4KICAgKi8KICBvcHRpbWl6ZSgpIHsKICAgIGxldCB0ID0gMCwgZSA9IDA7CiAgICBjb25zdCBpID0gdGhpcy5fZ2VvbWV0cnlJbmZvLCBuID0gaS5tYXAoKHIsIG8pID0+IG8pLnNvcnQoKHIsIG8pID0+IGlbcl0udmVydGV4U3RhcnQgLSBpW29dLnZlcnRleFN0YXJ0KSwgcyA9IHRoaXMuZ2VvbWV0cnk7CiAgICBmb3IgKGxldCByID0gMCwgbyA9IGkubGVuZ3RoOyByIDwgbzsgcisrKSB7CiAgICAgIGNvbnN0IGwgPSBuW3JdLCBoID0gaVtsXTsKICAgICAgaWYgKGguYWN0aXZlICE9PSAhMSkgewogICAgICAgIGlmIChzLmluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgICBpZiAoaC5pbmRleFN0YXJ0ICE9PSBlKSB7CiAgICAgICAgICAgIGNvbnN0IHsgaW5kZXhTdGFydDogYywgdmVydGV4U3RhcnQ6IHUsIHJlc2VydmVkSW5kZXhDb3VudDogZCB9ID0gaCwgcCA9IHMuaW5kZXgsIGYgPSBwLmFycmF5LCB5ID0gdCAtIHU7CiAgICAgICAgICAgIGZvciAobGV0IGcgPSBjOyBnIDwgYyArIGQ7IGcrKykKICAgICAgICAgICAgICBmW2ddID0gZltnXSArIHk7CiAgICAgICAgICAgIHAuYXJyYXkuY29weVdpdGhpbihlLCBjLCBjICsgZCksIHAuYWRkVXBkYXRlUmFuZ2UoZSwgZCksIGguaW5kZXhTdGFydCA9IGU7CiAgICAgICAgICB9CiAgICAgICAgICBlICs9IGgucmVzZXJ2ZWRJbmRleENvdW50OwogICAgICAgIH0KICAgICAgICBpZiAoaC52ZXJ0ZXhTdGFydCAhPT0gdCkgewogICAgICAgICAgY29uc3QgeyB2ZXJ0ZXhTdGFydDogYywgcmVzZXJ2ZWRWZXJ0ZXhDb3VudDogdSB9ID0gaCwgZCA9IHMuYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoY29uc3QgcCBpbiBkKSB7CiAgICAgICAgICAgIGNvbnN0IGYgPSBkW3BdLCB7IGFycmF5OiB5LCBpdGVtU2l6ZTogZyB9ID0gZjsKICAgICAgICAgICAgeS5jb3B5V2l0aGluKHQgKiBnLCBjICogZywgKGMgKyB1KSAqIGcpLCBmLmFkZFVwZGF0ZVJhbmdlKHQgKiBnLCB1ICogZyk7CiAgICAgICAgICB9CiAgICAgICAgICBoLnZlcnRleFN0YXJ0ID0gdDsKICAgICAgICB9CiAgICAgICAgdCArPSBoLnJlc2VydmVkVmVydGV4Q291bnQsIGguc3RhcnQgPSBzLmluZGV4ID8gaC5pbmRleFN0YXJ0IDogaC52ZXJ0ZXhTdGFydCwgdGhpcy5fbmV4dEluZGV4U3RhcnQgPSBzLmluZGV4ID8gaC5pbmRleFN0YXJ0ICsgaC5yZXNlcnZlZEluZGV4Q291bnQgOiAwLCB0aGlzLl9uZXh0VmVydGV4U3RhcnQgPSBoLnZlcnRleFN0YXJ0ICsgaC5yZXNlcnZlZFZlcnRleENvdW50OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgYm91bmRpbmcgYm94IGZvciB0aGUgZ2l2ZW4gZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gZ2VvbWV0cnlJZCAtIFRoZSBJRCBvZiB0aGUgZ2VvbWV0cnkgdG8gcmV0dXJuIHRoZSBib3VuZGluZyBib3ggZm9yLgogICAqIEBwYXJhbSB7Qm94M30gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7P0JveDN9IFRoZSBnZW9tZXRyeSdzIGJvdW5kaW5nIGJveC4gUmV0dXJucyBgbnVsbGAgaWYgbm8gZ2VvbWV0cnkgaGFzIGJlZW4gZm91bmQgZm9yIHRoZSBnaXZlbiBJRC4KICAgKi8KICBnZXRCb3VuZGluZ0JveEF0KHQsIGUpIHsKICAgIGlmICh0ID49IHRoaXMuX2dlb21ldHJ5Q291bnQpCiAgICAgIHJldHVybiBudWxsOwogICAgY29uc3QgaSA9IHRoaXMuZ2VvbWV0cnksIG4gPSB0aGlzLl9nZW9tZXRyeUluZm9bdF07CiAgICBpZiAobi5ib3VuZGluZ0JveCA9PT0gbnVsbCkgewogICAgICBjb25zdCBzID0gbmV3IHdlKCksIHIgPSBpLmluZGV4LCBvID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICBmb3IgKGxldCBsID0gbi5zdGFydCwgaCA9IG4uc3RhcnQgKyBuLmNvdW50OyBsIDwgaDsgbCsrKSB7CiAgICAgICAgbGV0IGMgPSBsOwogICAgICAgIHIgJiYgKGMgPSByLmdldFgoYykpLCBzLmV4cGFuZEJ5UG9pbnQocWEuZnJvbUJ1ZmZlckF0dHJpYnV0ZShvLCBjKSk7CiAgICAgIH0KICAgICAgbi5ib3VuZGluZ0JveCA9IHM7CiAgICB9CiAgICByZXR1cm4gZS5jb3B5KG4uYm91bmRpbmdCb3gpLCBlOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBib3VuZGluZyBzcGhlcmUgZm9yIHRoZSBnaXZlbiBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBnZW9tZXRyeUlkIC0gVGhlIElEIG9mIHRoZSBnZW9tZXRyeSB0byByZXR1cm4gdGhlIGJvdW5kaW5nIHNwaGVyZSBmb3IuCiAgICogQHBhcmFtIHtTcGhlcmV9IHRhcmdldCAtIFRoZSB0YXJnZXQgb2JqZWN0IHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4gez9TcGhlcmV9IFRoZSBnZW9tZXRyeSdzIGJvdW5kaW5nIHNwaGVyZS4gUmV0dXJucyBgbnVsbGAgaWYgbm8gZ2VvbWV0cnkgaGFzIGJlZW4gZm91bmQgZm9yIHRoZSBnaXZlbiBJRC4KICAgKi8KICBnZXRCb3VuZGluZ1NwaGVyZUF0KHQsIGUpIHsKICAgIGlmICh0ID49IHRoaXMuX2dlb21ldHJ5Q291bnQpCiAgICAgIHJldHVybiBudWxsOwogICAgY29uc3QgaSA9IHRoaXMuZ2VvbWV0cnksIG4gPSB0aGlzLl9nZW9tZXRyeUluZm9bdF07CiAgICBpZiAobi5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCkgewogICAgICBjb25zdCBzID0gbmV3IFJlKCk7CiAgICAgIHRoaXMuZ2V0Qm91bmRpbmdCb3hBdCh0LCBfbCksIF9sLmdldENlbnRlcihzLmNlbnRlcik7CiAgICAgIGNvbnN0IHIgPSBpLmluZGV4LCBvID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICBsZXQgbCA9IDA7CiAgICAgIGZvciAobGV0IGggPSBuLnN0YXJ0LCBjID0gbi5zdGFydCArIG4uY291bnQ7IGggPCBjOyBoKyspIHsKICAgICAgICBsZXQgdSA9IGg7CiAgICAgICAgciAmJiAodSA9IHIuZ2V0WCh1KSksIHFhLmZyb21CdWZmZXJBdHRyaWJ1dGUobywgdSksIGwgPSBNYXRoLm1heChsLCBzLmNlbnRlci5kaXN0YW5jZVRvU3F1YXJlZChxYSkpOwogICAgICB9CiAgICAgIHMucmFkaXVzID0gTWF0aC5zcXJ0KGwpLCBuLmJvdW5kaW5nU3BoZXJlID0gczsKICAgIH0KICAgIHJldHVybiBlLmNvcHkobi5ib3VuZGluZ1NwaGVyZSksIGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIGxvY2FsIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCB0byB0aGUgZGVmaW5lZCBpbnN0YW5jZS4KICAgKiBOZWdhdGl2ZWx5IHNjYWxlZCBtYXRyaWNlcyBhcmUgbm90IHN1cHBvcnRlZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnN0YW5jZUlkIC0gVGhlIElEIG9mIGFuIGluc3RhbmNlIHRvIHNldCB0aGUgbWF0cml4IG9mLgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gQSA0eDQgbWF0cml4IHJlcHJlc2VudGluZyB0aGUgbG9jYWwgdHJhbnNmb3JtYXRpb24gb2YgYSBzaW5nbGUgaW5zdGFuY2UuCiAgICogQHJldHVybiB7QmF0Y2hlZE1lc2h9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYmF0Y2hlZCBtZXNoLgogICAqLwogIHNldE1hdHJpeEF0KHQsIGUpIHsKICAgIHRoaXMudmFsaWRhdGVJbnN0YW5jZUlkKHQpOwogICAgY29uc3QgaSA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZSwgbiA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZS5pbWFnZS5kYXRhOwogICAgcmV0dXJuIGUudG9BcnJheShuLCB0ICogMTYpLCBpLm5lZWRzVXBkYXRlID0gITAsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGxvY2FsIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCBvZiB0aGUgZGVmaW5lZCBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnN0YW5jZUlkIC0gVGhlIElEIG9mIGFuIGluc3RhbmNlIHRvIGdldCB0aGUgbWF0cml4IG9mLgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIHRhcmdldCBvYmplY3QgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7TWF0cml4NH0gVGhlIGluc3RhbmNlJ3MgbG9jYWwgdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqLwogIGdldE1hdHJpeEF0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnZhbGlkYXRlSW5zdGFuY2VJZCh0KSwgZS5mcm9tQXJyYXkodGhpcy5fbWF0cmljZXNUZXh0dXJlLmltYWdlLmRhdGEsIHQgKiAxNik7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIGNvbG9yIHRvIHRoZSBkZWZpbmVkIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluc3RhbmNlSWQgLSBUaGUgSUQgb2YgYW4gaW5zdGFuY2UgdG8gc2V0IHRoZSBjb2xvciBvZi4KICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvciAtIFRoZSBjb2xvciB0byBzZXQgdGhlIGluc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge0JhdGNoZWRNZXNofSBBIHJlZmVyZW5jZSB0byB0aGlzIGJhdGNoZWQgbWVzaC4KICAgKi8KICBzZXRDb2xvckF0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnZhbGlkYXRlSW5zdGFuY2VJZCh0KSwgdGhpcy5fY29sb3JzVGV4dHVyZSA9PT0gbnVsbCAmJiB0aGlzLl9pbml0Q29sb3JzVGV4dHVyZSgpLCBlLnRvQXJyYXkodGhpcy5fY29sb3JzVGV4dHVyZS5pbWFnZS5kYXRhLCB0ICogNCksIHRoaXMuX2NvbG9yc1RleHR1cmUubmVlZHNVcGRhdGUgPSAhMCwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY29sb3Igb2YgdGhlIGRlZmluZWQgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5zdGFuY2VJZCAtIFRoZSBJRCBvZiBhbiBpbnN0YW5jZSB0byBnZXQgdGhlIGNvbG9yIG9mLgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIHRhcmdldCBvYmplY3QgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7Q29sb3J9IFRoZSBpbnN0YW5jZSdzIGNvbG9yLgogICAqLwogIGdldENvbG9yQXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMudmFsaWRhdGVJbnN0YW5jZUlkKHQpLCBlLmZyb21BcnJheSh0aGlzLl9jb2xvcnNUZXh0dXJlLmltYWdlLmRhdGEsIHQgKiA0KTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmlzaWJpbGl0eSBvZiB0aGUgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5zdGFuY2VJZCAtIFRoZSBpZCBvZiB0aGUgaW5zdGFuY2UgdG8gc2V0IHRoZSB2aXNpYmlsaXR5IG9mLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmlzaWJsZSAtIFdoZXRoZXIgdGhlIGluc3RhbmNlIGlzIHZpc2libGUgb3Igbm90LgogICAqIEByZXR1cm4ge0JhdGNoZWRNZXNofSBBIHJlZmVyZW5jZSB0byB0aGlzIGJhdGNoZWQgbWVzaC4KICAgKi8KICBzZXRWaXNpYmxlQXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMudmFsaWRhdGVJbnN0YW5jZUlkKHQpLCB0aGlzLl9pbnN0YW5jZUluZm9bdF0udmlzaWJsZSA9PT0gZSA/IHRoaXMgOiAodGhpcy5faW5zdGFuY2VJbmZvW3RdLnZpc2libGUgPSBlLCB0aGlzLl92aXNpYmlsaXR5Q2hhbmdlZCA9ICEwLCB0aGlzKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgdmlzaWJpbGl0eSBzdGF0ZSBvZiB0aGUgZGVmaW5lZCBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnN0YW5jZUlkIC0gVGhlIElEIG9mIGFuIGluc3RhbmNlIHRvIGdldCB0aGUgdmlzaWJpbGl0eSBzdGF0ZSBvZi4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBpbnN0YW5jZSBpcyB2aXNpYmxlIG9yIG5vdC4KICAgKi8KICBnZXRWaXNpYmxlQXQodCkgewogICAgcmV0dXJuIHRoaXMudmFsaWRhdGVJbnN0YW5jZUlkKHQpLCB0aGlzLl9pbnN0YW5jZUluZm9bdF0udmlzaWJsZTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2VvbWV0cnkgSUQgb2YgdGhlIGluc3RhbmNlIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbnN0YW5jZUlkIC0gVGhlIElEIG9mIHRoZSBpbnN0YW5jZSB0byBzZXQgdGhlIGdlb21ldHJ5IElEIG9mLgogICAqIEBwYXJhbSB7bnVtYmVyfSBnZW9tZXRyeUlkIC0gVGhlIGdlb21ldHJ5IElEIHRvIGJlIHVzZSBieSB0aGUgaW5zdGFuY2UuCiAgICogQHJldHVybiB7QmF0Y2hlZE1lc2h9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYmF0Y2hlZCBtZXNoLgogICAqLwogIHNldEdlb21ldHJ5SWRBdCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUluc3RhbmNlSWQodCksIHRoaXMudmFsaWRhdGVHZW9tZXRyeUlkKGUpLCB0aGlzLl9pbnN0YW5jZUluZm9bdF0uZ2VvbWV0cnlJbmRleCA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGdlb21ldHJ5IElEIG9mIHRoZSBkZWZpbmVkIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluc3RhbmNlSWQgLSBUaGUgSUQgb2YgYW4gaW5zdGFuY2UgdG8gZ2V0IHRoZSBnZW9tZXRyeSBJRCBvZi4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbnN0YW5jZSdzIGdlb21ldHJ5IElELgogICAqLwogIGdldEdlb21ldHJ5SWRBdCh0KSB7CiAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUluc3RhbmNlSWQodCksIHRoaXMuX2luc3RhbmNlSW5mb1t0XS5nZW9tZXRyeUluZGV4OwogIH0KICAvKioKICAgKiBHZXQgdGhlIHJhbmdlIHJlcHJlc2VudGluZyB0aGUgc3Vic2V0IG9mIHRyaWFuZ2xlcyByZWxhdGVkIHRvIHRoZSBhdHRhY2hlZCBnZW9tZXRyeSwKICAgKiBpbmRpY2F0aW5nIHRoZSBzdGFydGluZyBvZmZzZXQgYW5kIGNvdW50LCBvciBgbnVsbGAgaWYgaW52YWxpZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBnZW9tZXRyeUlkIC0gVGhlIGlkIG9mIHRoZSBnZW9tZXRyeSB0byBnZXQgdGhlIHJhbmdlIG9mLgogICAqIEBwYXJhbSB7T2JqZWN0fSBbdGFyZ2V0XSAtIFRoZSB0YXJnZXQgb2JqZWN0IHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge3sKICAgKiAJdmVydGV4U3RhcnQ6bnVtYmVyLHZlcnRleENvdW50Om51bWJlcixyZXNlcnZlZFZlcnRleENvdW50Om51bWJlciwKICAgKiAJaW5kZXhTdGFydDpudW1iZXIsaW5kZXhDb3VudDpudW1iZXIscmVzZXJ2ZWRJbmRleENvdW50Om51bWJlciwKICAgKiAJc3RhcnQ6bnVtYmVyLGNvdW50Om51bWJlcgogICAqIH19IFRoZSByZXN1bHQgb2JqZWN0IHdpdGggcmFuZ2UgZGF0YS4KICAgKi8KICBnZXRHZW9tZXRyeVJhbmdlQXQodCwgZSA9IHt9KSB7CiAgICB0aGlzLnZhbGlkYXRlR2VvbWV0cnlJZCh0KTsKICAgIGNvbnN0IGkgPSB0aGlzLl9nZW9tZXRyeUluZm9bdF07CiAgICByZXR1cm4gZS52ZXJ0ZXhTdGFydCA9IGkudmVydGV4U3RhcnQsIGUudmVydGV4Q291bnQgPSBpLnZlcnRleENvdW50LCBlLnJlc2VydmVkVmVydGV4Q291bnQgPSBpLnJlc2VydmVkVmVydGV4Q291bnQsIGUuaW5kZXhTdGFydCA9IGkuaW5kZXhTdGFydCwgZS5pbmRleENvdW50ID0gaS5pbmRleENvdW50LCBlLnJlc2VydmVkSW5kZXhDb3VudCA9IGkucmVzZXJ2ZWRJbmRleENvdW50LCBlLnN0YXJ0ID0gaS5zdGFydCwgZS5jb3VudCA9IGkuY291bnQsIGU7CiAgfQogIC8qKgogICAqIFJlc2l6ZXMgdGhlIG5lY2Vzc2FyeSBidWZmZXJzIHRvIHN1cHBvcnQgdGhlIHByb3ZpZGVkIG51bWJlciBvZiBpbnN0YW5jZXMuCiAgICogSWYgdGhlIHByb3ZpZGVkIGFyZ3VtZW50cyBzaHJpbmsgdGhlIG51bWJlciBvZiBpbnN0YW5jZXMgYnV0IHRoZXJlIGFyZSBub3QgZW5vdWdoCiAgICogdW51c2VkIElkcyBhdCB0aGUgZW5kIG9mIHRoZSBsaXN0IHRoZW4gYW4gZXJyb3IgaXMgdGhyb3duLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heEluc3RhbmNlQ291bnQgLSBUaGUgbWF4IG51bWJlciBvZiBpbmRpdmlkdWFsIGluc3RhbmNlcyB0aGF0IGNhbiBiZSBhZGRlZCBhbmQgcmVuZGVyZWQgYnkgdGhlIGJhdGNoLgogICovCiAgc2V0SW5zdGFuY2VDb3VudCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5fYXZhaWxhYmxlSW5zdGFuY2VJZHMsIGkgPSB0aGlzLl9pbnN0YW5jZUluZm87CiAgICBmb3IgKGUuc29ydChWdSk7IGVbZS5sZW5ndGggLSAxXSA9PT0gaS5sZW5ndGggLSAxOyApCiAgICAgIGkucG9wKCksIGUucG9wKCk7CiAgICBpZiAodCA8IGkubGVuZ3RoKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhdGNoZWRNZXNoOiBJbnN0YW5jZSBpZHMgb3V0c2lkZSB0aGUgcmFuZ2UgJHt0fSBhcmUgYmVpbmcgdXNlZC4gQ2Fubm90IHNocmluayBpbnN0YW5jZSBjb3VudC5gKTsKICAgIGNvbnN0IG4gPSBuZXcgSW50MzJBcnJheSh0KSwgcyA9IG5ldyBJbnQzMkFycmF5KHQpOwogICAgR3ModGhpcy5fbXVsdGlEcmF3Q291bnRzLCBuKSwgR3ModGhpcy5fbXVsdGlEcmF3U3RhcnRzLCBzKSwgdGhpcy5fbXVsdGlEcmF3Q291bnRzID0gbiwgdGhpcy5fbXVsdGlEcmF3U3RhcnRzID0gcywgdGhpcy5fbWF4SW5zdGFuY2VDb3VudCA9IHQ7CiAgICBjb25zdCByID0gdGhpcy5faW5kaXJlY3RUZXh0dXJlLCBvID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlLCBsID0gdGhpcy5fY29sb3JzVGV4dHVyZTsKICAgIHIuZGlzcG9zZSgpLCB0aGlzLl9pbml0SW5kaXJlY3RUZXh0dXJlKCksIEdzKHIuaW1hZ2UuZGF0YSwgdGhpcy5faW5kaXJlY3RUZXh0dXJlLmltYWdlLmRhdGEpLCBvLmRpc3Bvc2UoKSwgdGhpcy5faW5pdE1hdHJpY2VzVGV4dHVyZSgpLCBHcyhvLmltYWdlLmRhdGEsIHRoaXMuX21hdHJpY2VzVGV4dHVyZS5pbWFnZS5kYXRhKSwgbCAmJiAobC5kaXNwb3NlKCksIHRoaXMuX2luaXRDb2xvcnNUZXh0dXJlKCksIEdzKGwuaW1hZ2UuZGF0YSwgdGhpcy5fY29sb3JzVGV4dHVyZS5pbWFnZS5kYXRhKSk7CiAgfQogIC8qKgogICAqIFJlc2l6ZXMgdGhlIGF2YWlsYWJsZSBzcGFjZSBpbiB0aGUgYmF0Y2gncyB2ZXJ0ZXggYW5kIGluZGV4IGJ1ZmZlciBhdHRyaWJ1dGVzIHRvIHRoZSBwcm92aWRlZCBzaXplcy4KICAgKiBJZiB0aGUgcHJvdmlkZWQgYXJndW1lbnRzIHNocmluayB0aGUgZ2VvbWV0cnkgYnVmZmVycyBidXQgdGhlcmUgaXMgbm90IGVub3VnaCB1bnVzZWQgc3BhY2UgYXQgdGhlCiAgICogZW5kIG9mIHRoZSBnZW9tZXRyeSBhdHRyaWJ1dGVzIHRoZW4gYW4gZXJyb3IgaXMgdGhyb3duLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heFZlcnRleENvdW50IC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHZlcnRpY2VzIHRvIGJlIHVzZWQgYnkgYWxsIHVuaXF1ZSBnZW9tZXRyaWVzIHRvIHJlc2l6ZSB0by4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4SW5kZXhDb3VudCAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiBpbmRpY2VzIHRvIGJlIHVzZWQgYnkgYWxsIHVuaXF1ZSBnZW9tZXRyaWVzIHRvIHJlc2l6ZSB0by4KICAqLwogIHNldEdlb21ldHJ5U2l6ZSh0LCBlKSB7CiAgICBjb25zdCBpID0gWy4uLnRoaXMuX2dlb21ldHJ5SW5mb10uZmlsdGVyKChvKSA9PiBvLmFjdGl2ZSk7CiAgICBpZiAoTWF0aC5tYXgoLi4uaS5tYXAoKG8pID0+IG8udmVydGV4U3RhcnQgKyBvLnJlc2VydmVkVmVydGV4Q291bnQpKSA+IHQpCiAgICAgIHRocm93IG5ldyBFcnJvcihgQmF0Y2hlZE1lc2g6IEdlb21ldHJ5IHZlcnRleCB2YWx1ZXMgYXJlIGJlaW5nIHVzZWQgb3V0c2lkZSB0aGUgcmFuZ2UgJHtlfS4gQ2Fubm90IHNocmluayBmdXJ0aGVyLmApOwogICAgaWYgKHRoaXMuZ2VvbWV0cnkuaW5kZXggJiYgTWF0aC5tYXgoLi4uaS5tYXAoKGwpID0+IGwuaW5kZXhTdGFydCArIGwucmVzZXJ2ZWRJbmRleENvdW50KSkgPiBlKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhdGNoZWRNZXNoOiBHZW9tZXRyeSBpbmRleCB2YWx1ZXMgYXJlIGJlaW5nIHVzZWQgb3V0c2lkZSB0aGUgcmFuZ2UgJHtlfS4gQ2Fubm90IHNocmluayBmdXJ0aGVyLmApOwogICAgY29uc3QgcyA9IHRoaXMuZ2VvbWV0cnk7CiAgICBzLmRpc3Bvc2UoKSwgdGhpcy5fbWF4VmVydGV4Q291bnQgPSB0LCB0aGlzLl9tYXhJbmRleENvdW50ID0gZSwgdGhpcy5fZ2VvbWV0cnlJbml0aWFsaXplZCAmJiAodGhpcy5fZ2VvbWV0cnlJbml0aWFsaXplZCA9ICExLCB0aGlzLmdlb21ldHJ5ID0gbmV3IEh0KCksIHRoaXMuX2luaXRpYWxpemVHZW9tZXRyeShzKSk7CiAgICBjb25zdCByID0gdGhpcy5nZW9tZXRyeTsKICAgIHMuaW5kZXggJiYgR3Mocy5pbmRleC5hcnJheSwgci5pbmRleC5hcnJheSk7CiAgICBmb3IgKGNvbnN0IG8gaW4gcy5hdHRyaWJ1dGVzKQogICAgICBHcyhzLmF0dHJpYnV0ZXNbb10uYXJyYXksIHIuYXR0cmlidXRlc1tvXS5hcnJheSk7CiAgfQogIHJheWNhc3QodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuX2luc3RhbmNlSW5mbywgbiA9IHRoaXMuX2dlb21ldHJ5SW5mbywgcyA9IHRoaXMubWF0cml4V29ybGQsIHIgPSB0aGlzLmdlb21ldHJ5OwogICAgUWUubWF0ZXJpYWwgPSB0aGlzLm1hdGVyaWFsLCBRZS5nZW9tZXRyeS5pbmRleCA9IHIuaW5kZXgsIFFlLmdlb21ldHJ5LmF0dHJpYnV0ZXMgPSByLmF0dHJpYnV0ZXMsIFFlLmdlb21ldHJ5LmJvdW5kaW5nQm94ID09PSBudWxsICYmIChRZS5nZW9tZXRyeS5ib3VuZGluZ0JveCA9IG5ldyB3ZSgpKSwgUWUuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgJiYgKFFlLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gbmV3IFJlKCkpOwogICAgZm9yIChsZXQgbyA9IDAsIGwgPSBpLmxlbmd0aDsgbyA8IGw7IG8rKykgewogICAgICBpZiAoIWlbb10udmlzaWJsZSB8fCAhaVtvXS5hY3RpdmUpCiAgICAgICAgY29udGludWU7CiAgICAgIGNvbnN0IGggPSBpW29dLmdlb21ldHJ5SW5kZXgsIGMgPSBuW2hdOwogICAgICBRZS5nZW9tZXRyeS5zZXREcmF3UmFuZ2UoYy5zdGFydCwgYy5jb3VudCksIHRoaXMuZ2V0TWF0cml4QXQobywgUWUubWF0cml4V29ybGQpLnByZW11bHRpcGx5KHMpLCB0aGlzLmdldEJvdW5kaW5nQm94QXQoaCwgUWUuZ2VvbWV0cnkuYm91bmRpbmdCb3gpLCB0aGlzLmdldEJvdW5kaW5nU3BoZXJlQXQoaCwgUWUuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUpLCBRZS5yYXljYXN0KHQsIHhsKTsKICAgICAgZm9yIChsZXQgdSA9IDAsIGQgPSB4bC5sZW5ndGg7IHUgPCBkOyB1KyspIHsKICAgICAgICBjb25zdCBwID0geGxbdV07CiAgICAgICAgcC5vYmplY3QgPSB0aGlzLCBwLmJhdGNoSWQgPSBvLCBlLnB1c2gocCk7CiAgICAgIH0KICAgICAgeGwubGVuZ3RoID0gMDsKICAgIH0KICAgIFFlLm1hdGVyaWFsID0gbnVsbCwgUWUuZ2VvbWV0cnkuaW5kZXggPSBudWxsLCBRZS5nZW9tZXRyeS5hdHRyaWJ1dGVzID0ge30sIFFlLmdlb21ldHJ5LnNldERyYXdSYW5nZSgwLCAxIC8gMCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuZ2VvbWV0cnkgPSB0Lmdlb21ldHJ5LmNsb25lKCksIHRoaXMucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCA9IHQucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCwgdGhpcy5zb3J0T2JqZWN0cyA9IHQuc29ydE9iamVjdHMsIHRoaXMuYm91bmRpbmdCb3ggPSB0LmJvdW5kaW5nQm94ICE9PSBudWxsID8gdC5ib3VuZGluZ0JveC5jbG9uZSgpIDogbnVsbCwgdGhpcy5ib3VuZGluZ1NwaGVyZSA9IHQuYm91bmRpbmdTcGhlcmUgIT09IG51bGwgPyB0LmJvdW5kaW5nU3BoZXJlLmNsb25lKCkgOiBudWxsLCB0aGlzLl9nZW9tZXRyeUluZm8gPSB0Ll9nZW9tZXRyeUluZm8ubWFwKChlKSA9PiAoewogICAgICAuLi5lLAogICAgICBib3VuZGluZ0JveDogZS5ib3VuZGluZ0JveCAhPT0gbnVsbCA/IGUuYm91bmRpbmdCb3guY2xvbmUoKSA6IG51bGwsCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBlLmJvdW5kaW5nU3BoZXJlICE9PSBudWxsID8gZS5ib3VuZGluZ1NwaGVyZS5jbG9uZSgpIDogbnVsbAogICAgfSkpLCB0aGlzLl9pbnN0YW5jZUluZm8gPSB0Ll9pbnN0YW5jZUluZm8ubWFwKChlKSA9PiAoeyAuLi5lIH0pKSwgdGhpcy5fYXZhaWxhYmxlSW5zdGFuY2VJZHMgPSB0Ll9hdmFpbGFibGVJbnN0YW5jZUlkcy5zbGljZSgpLCB0aGlzLl9hdmFpbGFibGVHZW9tZXRyeUlkcyA9IHQuX2F2YWlsYWJsZUdlb21ldHJ5SWRzLnNsaWNlKCksIHRoaXMuX25leHRJbmRleFN0YXJ0ID0gdC5fbmV4dEluZGV4U3RhcnQsIHRoaXMuX25leHRWZXJ0ZXhTdGFydCA9IHQuX25leHRWZXJ0ZXhTdGFydCwgdGhpcy5fZ2VvbWV0cnlDb3VudCA9IHQuX2dlb21ldHJ5Q291bnQsIHRoaXMuX21heEluc3RhbmNlQ291bnQgPSB0Ll9tYXhJbnN0YW5jZUNvdW50LCB0aGlzLl9tYXhWZXJ0ZXhDb3VudCA9IHQuX21heFZlcnRleENvdW50LCB0aGlzLl9tYXhJbmRleENvdW50ID0gdC5fbWF4SW5kZXhDb3VudCwgdGhpcy5fZ2VvbWV0cnlJbml0aWFsaXplZCA9IHQuX2dlb21ldHJ5SW5pdGlhbGl6ZWQsIHRoaXMuX211bHRpRHJhd0NvdW50cyA9IHQuX211bHRpRHJhd0NvdW50cy5zbGljZSgpLCB0aGlzLl9tdWx0aURyYXdTdGFydHMgPSB0Ll9tdWx0aURyYXdTdGFydHMuc2xpY2UoKSwgdGhpcy5faW5kaXJlY3RUZXh0dXJlID0gdC5faW5kaXJlY3RUZXh0dXJlLmNsb25lKCksIHRoaXMuX2luZGlyZWN0VGV4dHVyZS5pbWFnZS5kYXRhID0gdGhpcy5faW5kaXJlY3RUZXh0dXJlLmltYWdlLmRhdGEuc2xpY2UoKSwgdGhpcy5fbWF0cmljZXNUZXh0dXJlID0gdC5fbWF0cmljZXNUZXh0dXJlLmNsb25lKCksIHRoaXMuX21hdHJpY2VzVGV4dHVyZS5pbWFnZS5kYXRhID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlLmltYWdlLmRhdGEuc2xpY2UoKSwgdGhpcy5fY29sb3JzVGV4dHVyZSAhPT0gbnVsbCAmJiAodGhpcy5fY29sb3JzVGV4dHVyZSA9IHQuX2NvbG9yc1RleHR1cmUuY2xvbmUoKSwgdGhpcy5fY29sb3JzVGV4dHVyZS5pbWFnZS5kYXRhID0gdGhpcy5fY29sb3JzVGV4dHVyZS5pbWFnZS5kYXRhLnNsaWNlKCkpLCB0aGlzOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMuX21hdHJpY2VzVGV4dHVyZS5kaXNwb3NlKCksIHRoaXMuX21hdHJpY2VzVGV4dHVyZSA9IG51bGwsIHRoaXMuX2luZGlyZWN0VGV4dHVyZS5kaXNwb3NlKCksIHRoaXMuX2luZGlyZWN0VGV4dHVyZSA9IG51bGwsIHRoaXMuX2NvbG9yc1RleHR1cmUgIT09IG51bGwgJiYgKHRoaXMuX2NvbG9yc1RleHR1cmUuZGlzcG9zZSgpLCB0aGlzLl9jb2xvcnNUZXh0dXJlID0gbnVsbCk7CiAgfQogIG9uQmVmb3JlUmVuZGVyKHQsIGUsIGksIG4sIHMpIHsKICAgIGlmICghdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgJiYgIXRoaXMucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCAmJiAhdGhpcy5zb3J0T2JqZWN0cykKICAgICAgcmV0dXJuOwogICAgY29uc3QgciA9IG4uZ2V0SW5kZXgoKSwgbyA9IHIgPT09IG51bGwgPyAxIDogci5hcnJheS5CWVRFU19QRVJfRUxFTUVOVCwgbCA9IHRoaXMuX2luc3RhbmNlSW5mbywgaCA9IHRoaXMuX211bHRpRHJhd1N0YXJ0cywgYyA9IHRoaXMuX211bHRpRHJhd0NvdW50cywgdSA9IHRoaXMuX2dlb21ldHJ5SW5mbywgZCA9IHRoaXMucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCwgcCA9IHRoaXMuX2luZGlyZWN0VGV4dHVyZSwgZiA9IHAuaW1hZ2UuZGF0YSwgeSA9IGkuaXNBcnJheUNhbWVyYSA/IEt2IDogcm07CiAgICBkICYmICFpLmlzQXJyYXlDYW1lcmEgJiYgKHZpLm11bHRpcGx5TWF0cmljZXMoaS5wcm9qZWN0aW9uTWF0cml4LCBpLm1hdHJpeFdvcmxkSW52ZXJzZSkubXVsdGlwbHkodGhpcy5tYXRyaXhXb3JsZCksIHJtLnNldEZyb21Qcm9qZWN0aW9uTWF0cml4KAogICAgICB2aSwKICAgICAgaS5jb29yZGluYXRlU3lzdGVtLAogICAgICBpLnJldmVyc2VkRGVwdGgKICAgICkpOwogICAgbGV0IGcgPSAwOwogICAgaWYgKHRoaXMuc29ydE9iamVjdHMpIHsKICAgICAgdmkuY29weSh0aGlzLm1hdHJpeFdvcmxkKS5pbnZlcnQoKSwgcWEuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKGkubWF0cml4V29ybGQpLmFwcGx5TWF0cml4NCh2aSksIGFtLnNldCgwLCAwLCAtMSkudHJhbnNmb3JtRGlyZWN0aW9uKGkubWF0cml4V29ybGQpLnRyYW5zZm9ybURpcmVjdGlvbih2aSk7CiAgICAgIGZvciAobGV0IHggPSAwLCBfID0gbC5sZW5ndGg7IHggPCBfOyB4KyspCiAgICAgICAgaWYgKGxbeF0udmlzaWJsZSAmJiBsW3hdLmFjdGl2ZSkgewogICAgICAgICAgY29uc3QgUyA9IGxbeF0uZ2VvbWV0cnlJbmRleDsKICAgICAgICAgIHRoaXMuZ2V0TWF0cml4QXQoeCwgdmkpLCB0aGlzLmdldEJvdW5kaW5nU3BoZXJlQXQoUywgSHMpLmFwcGx5TWF0cml4NCh2aSk7CiAgICAgICAgICBsZXQgdyA9ICExOwogICAgICAgICAgaWYgKGQgJiYgKHcgPSAheS5pbnRlcnNlY3RzU3BoZXJlKEhzLCBpKSksICF3KSB7CiAgICAgICAgICAgIGNvbnN0IFQgPSB1W1NdLCBSID0gUXYuc3ViVmVjdG9ycyhIcy5jZW50ZXIsIHFhKS5kb3QoYW0pOwogICAgICAgICAgICBIdS5wdXNoKFQuc3RhcnQsIFQuY291bnQsIFIsIHgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgY29uc3QgbSA9IEh1Lmxpc3QsIHYgPSB0aGlzLmN1c3RvbVNvcnQ7CiAgICAgIHYgPT09IG51bGwgPyBtLnNvcnQocy50cmFuc3BhcmVudCA/IFp2IDogWXYpIDogdi5jYWxsKHRoaXMsIG0sIGkpOwogICAgICBmb3IgKGxldCB4ID0gMCwgXyA9IG0ubGVuZ3RoOyB4IDwgXzsgeCsrKSB7CiAgICAgICAgY29uc3QgUyA9IG1beF07CiAgICAgICAgaFtnXSA9IFMuc3RhcnQgKiBvLCBjW2ddID0gUy5jb3VudCwgZltnXSA9IFMuaW5kZXgsIGcrKzsKICAgICAgfQogICAgICBIdS5yZXNldCgpOwogICAgfSBlbHNlCiAgICAgIGZvciAobGV0IG0gPSAwLCB2ID0gbC5sZW5ndGg7IG0gPCB2OyBtKyspCiAgICAgICAgaWYgKGxbbV0udmlzaWJsZSAmJiBsW21dLmFjdGl2ZSkgewogICAgICAgICAgY29uc3QgeCA9IGxbbV0uZ2VvbWV0cnlJbmRleDsKICAgICAgICAgIGxldCBfID0gITE7CiAgICAgICAgICBpZiAoZCAmJiAodGhpcy5nZXRNYXRyaXhBdChtLCB2aSksIHRoaXMuZ2V0Qm91bmRpbmdTcGhlcmVBdCh4LCBIcykuYXBwbHlNYXRyaXg0KHZpKSwgXyA9ICF5LmludGVyc2VjdHNTcGhlcmUoSHMsIGkpKSwgIV8pIHsKICAgICAgICAgICAgY29uc3QgUyA9IHVbeF07CiAgICAgICAgICAgIGhbZ10gPSBTLnN0YXJ0ICogbywgY1tnXSA9IFMuY291bnQsIGZbZ10gPSBtLCBnKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgcC5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzLl9tdWx0aURyYXdDb3VudCA9IGcsIHRoaXMuX3Zpc2liaWxpdHlDaGFuZ2VkID0gITE7CiAgfQogIG9uQmVmb3JlU2hhZG93KHQsIGUsIGksIG4sIHMsIHIpIHsKICAgIHRoaXMub25CZWZvcmVSZW5kZXIodCwgbnVsbCwgbiwgcywgcik7CiAgfQp9CmNsYXNzIFBlIGV4dGVuZHMgaGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbGluZSBiYXNpYyBtYXRlcmlhbC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0xpbmVCYXNpY01hdGVyaWFsID0gITAsIHRoaXMudHlwZSA9ICJMaW5lQmFzaWNNYXRlcmlhbCIsIHRoaXMuY29sb3IgPSBuZXcgY3QoMTY3NzcyMTUpLCB0aGlzLm1hcCA9IG51bGwsIHRoaXMubGluZXdpZHRoID0gMSwgdGhpcy5saW5lY2FwID0gInJvdW5kIiwgdGhpcy5saW5lam9pbiA9ICJyb3VuZCIsIHRoaXMuZm9nID0gITAsIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmNvbG9yLmNvcHkodC5jb2xvciksIHRoaXMubWFwID0gdC5tYXAsIHRoaXMubGluZXdpZHRoID0gdC5saW5ld2lkdGgsIHRoaXMubGluZWNhcCA9IHQubGluZWNhcCwgdGhpcy5saW5lam9pbiA9IHQubGluZWpvaW4sIHRoaXMuZm9nID0gdC5mb2csIHRoaXM7CiAgfQp9CmNvbnN0IGdjID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIHljID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIG9tID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpLCAkYSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWEoKSwgdmwgPSAvKiBAX19QVVJFX18gKi8gbmV3IFJlKCksIEd1ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIGxtID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmNsYXNzIFJzIGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbGluZS4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IFtnZW9tZXRyeV0gLSBUaGUgbGluZSBnZW9tZXRyeS4KICAgKiBAcGFyYW0ge01hdGVyaWFsfEFycmF5PE1hdGVyaWFsPn0gW21hdGVyaWFsXSAtIFRoZSBsaW5lIG1hdGVyaWFsLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgSHQoKSwgZSA9IG5ldyBQZSgpKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTGluZSA9ICEwLCB0aGlzLnR5cGUgPSAiTGluZSIsIHRoaXMuZ2VvbWV0cnkgPSB0LCB0aGlzLm1hdGVyaWFsID0gZSwgdGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnkgPSB2b2lkIDAsIHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzID0gdm9pZCAwLCB0aGlzLnVwZGF0ZU1vcnBoVGFyZ2V0cygpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0aGlzLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheSh0Lm1hdGVyaWFsKSA/IHQubWF0ZXJpYWwuc2xpY2UoKSA6IHQubWF0ZXJpYWwsIHRoaXMuZ2VvbWV0cnkgPSB0Lmdlb21ldHJ5LCB0aGlzOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBhbiBhcnJheSBvZiBkaXN0YW5jZSB2YWx1ZXMgd2hpY2ggYXJlIG5lY2Vzc2FyeSBmb3IgcmVuZGVyaW5nIGRhc2hlZCBsaW5lcy4KICAgKiBGb3IgZWFjaCB2ZXJ0ZXggaW4gdGhlIGdlb21ldHJ5LCB0aGUgbWV0aG9kIGNhbGN1bGF0ZXMgdGhlIGN1bXVsYXRpdmUgbGVuZ3RoIGZyb20gdGhlCiAgICogY3VycmVudCBwb2ludCB0byB0aGUgdmVyeSBiZWdpbm5pbmcgb2YgdGhlIGxpbmUuCiAgICoKICAgKiBAcmV0dXJuIHtMaW5lfSBBIHJlZmVyZW5jZSB0byB0aGlzIGxpbmUuCiAgICovCiAgY29tcHV0ZUxpbmVEaXN0YW5jZXMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5nZW9tZXRyeTsKICAgIGlmICh0LmluZGV4ID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGUgPSB0LmF0dHJpYnV0ZXMucG9zaXRpb24sIGkgPSBbMF07CiAgICAgIGZvciAobGV0IG4gPSAxLCBzID0gZS5jb3VudDsgbiA8IHM7IG4rKykKICAgICAgICBnYy5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIG4gLSAxKSwgeWMuZnJvbUJ1ZmZlckF0dHJpYnV0ZShlLCBuKSwgaVtuXSA9IGlbbiAtIDFdLCBpW25dICs9IGdjLmRpc3RhbmNlVG8oeWMpOwogICAgICB0LnNldEF0dHJpYnV0ZSgibGluZURpc3RhbmNlIiwgbmV3IHd0KGksIDEpKTsKICAgIH0gZWxzZQogICAgICBjb25zb2xlLndhcm4oIlRIUkVFLkxpbmUuY29tcHV0ZUxpbmVEaXN0YW5jZXMoKTogQ29tcHV0YXRpb24gb25seSBwb3NzaWJsZSB3aXRoIG5vbi1pbmRleGVkIEJ1ZmZlckdlb21ldHJ5LiIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGludGVyc2VjdGlvbiBwb2ludHMgYmV0d2VlbiBhIGNhc3RlZCByYXkgYW5kIHRoaXMgbGluZS4KICAgKgogICAqIEBwYXJhbSB7UmF5Y2FzdGVyfSByYXljYXN0ZXIgLSBUaGUgcmF5Y2FzdGVyLgogICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gaW50ZXJzZWN0cyAtIFRoZSB0YXJnZXQgYXJyYXkgdGhhdCBob2xkcyB0aGUgaW50ZXJzZWN0aW9uIHBvaW50cy4KICAgKi8KICByYXljYXN0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdlb21ldHJ5LCBuID0gdGhpcy5tYXRyaXhXb3JsZCwgcyA9IHQucGFyYW1zLkxpbmUudGhyZXNob2xkLCByID0gaS5kcmF3UmFuZ2U7CiAgICBpZiAoaS5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiBpLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCB2bC5jb3B5KGkuYm91bmRpbmdTcGhlcmUpLCB2bC5hcHBseU1hdHJpeDQobiksIHZsLnJhZGl1cyArPSBzLCB0LnJheS5pbnRlcnNlY3RzU3BoZXJlKHZsKSA9PT0gITEpIHJldHVybjsKICAgIG9tLmNvcHkobikuaW52ZXJ0KCksICRhLmNvcHkodC5yYXkpLmFwcGx5TWF0cml4NChvbSk7CiAgICBjb25zdCBvID0gcyAvICgodGhpcy5zY2FsZS54ICsgdGhpcy5zY2FsZS55ICsgdGhpcy5zY2FsZS56KSAvIDMpLCBsID0gbyAqIG8sIGggPSB0aGlzLmlzTGluZVNlZ21lbnRzID8gMiA6IDEsIGMgPSBpLmluZGV4LCBkID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgaWYgKGMgIT09IG51bGwpIHsKICAgICAgY29uc3QgcCA9IE1hdGgubWF4KDAsIHIuc3RhcnQpLCBmID0gTWF0aC5taW4oYy5jb3VudCwgci5zdGFydCArIHIuY291bnQpOwogICAgICBmb3IgKGxldCB5ID0gcCwgZyA9IGYgLSAxOyB5IDwgZzsgeSArPSBoKSB7CiAgICAgICAgY29uc3QgbSA9IGMuZ2V0WCh5KSwgdiA9IGMuZ2V0WCh5ICsgMSksIHggPSBibCh0aGlzLCB0LCAkYSwgbCwgbSwgdiwgeSk7CiAgICAgICAgeCAmJiBlLnB1c2goeCk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuaXNMaW5lTG9vcCkgewogICAgICAgIGNvbnN0IHkgPSBjLmdldFgoZiAtIDEpLCBnID0gYy5nZXRYKHApLCBtID0gYmwodGhpcywgdCwgJGEsIGwsIHksIGcsIGYgLSAxKTsKICAgICAgICBtICYmIGUucHVzaChtKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcCA9IE1hdGgubWF4KDAsIHIuc3RhcnQpLCBmID0gTWF0aC5taW4oZC5jb3VudCwgci5zdGFydCArIHIuY291bnQpOwogICAgICBmb3IgKGxldCB5ID0gcCwgZyA9IGYgLSAxOyB5IDwgZzsgeSArPSBoKSB7CiAgICAgICAgY29uc3QgbSA9IGJsKHRoaXMsIHQsICRhLCBsLCB5LCB5ICsgMSwgeSk7CiAgICAgICAgbSAmJiBlLnB1c2gobSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuaXNMaW5lTG9vcCkgewogICAgICAgIGNvbnN0IHkgPSBibCh0aGlzLCB0LCAkYSwgbCwgZiAtIDEsIHAsIGYgLSAxKTsKICAgICAgICB5ICYmIGUucHVzaCh5KTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2YWx1ZXMgb2Yge0BsaW5rIExpbmUjbW9ycGhUYXJnZXREaWN0aW9uYXJ5fSBhbmQge0BsaW5rIExpbmUjbW9ycGhUYXJnZXRJbmZsdWVuY2VzfQogICAqIHRvIG1ha2Ugc3VyZSBleGlzdGluZyBtb3JwaCB0YXJnZXRzIGNhbiBpbmZsdWVuY2UgdGhpcyAzRCBvYmplY3QuCiAgICovCiAgdXBkYXRlTW9ycGhUYXJnZXRzKCkgewogICAgY29uc3QgZSA9IHRoaXMuZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLCBpID0gT2JqZWN0LmtleXMoZSk7CiAgICBpZiAoaS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IG4gPSBlW2lbMF1dOwogICAgICBpZiAobiAhPT0gdm9pZCAwKSB7CiAgICAgICAgdGhpcy5tb3JwaFRhcmdldEluZmx1ZW5jZXMgPSBbXSwgdGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnkgPSB7fTsKICAgICAgICBmb3IgKGxldCBzID0gMCwgciA9IG4ubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgICAgICBjb25zdCBvID0gbltzXS5uYW1lIHx8IFN0cmluZyhzKTsKICAgICAgICAgIHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzLnB1c2goMCksIHRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5W29dID0gczsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0KZnVuY3Rpb24gYmwoYSwgdCwgZSwgaSwgbiwgcywgcikgewogIGNvbnN0IG8gPSBhLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CiAgaWYgKGdjLmZyb21CdWZmZXJBdHRyaWJ1dGUobywgbiksIHljLmZyb21CdWZmZXJBdHRyaWJ1dGUobywgcyksIGUuZGlzdGFuY2VTcVRvU2VnbWVudChnYywgeWMsIEd1LCBsbSkgPiBpKSByZXR1cm47CiAgR3UuYXBwbHlNYXRyaXg0KGEubWF0cml4V29ybGQpOwogIGNvbnN0IGggPSB0LnJheS5vcmlnaW4uZGlzdGFuY2VUbyhHdSk7CiAgaWYgKCEoaCA8IHQubmVhciB8fCBoID4gdC5mYXIpKQogICAgcmV0dXJuIHsKICAgICAgZGlzdGFuY2U6IGgsCiAgICAgIC8vIFdoYXQgZG8gd2Ugd2FudD8gaW50ZXJzZWN0aW9uIHBvaW50IG9uIHRoZSByYXkgb3Igb24gdGhlIHNlZ21lbnQ/PwogICAgICAvLyBwb2ludDogcmF5Y2FzdGVyLnJheS5hdCggZGlzdGFuY2UgKSwKICAgICAgcG9pbnQ6IGxtLmNsb25lKCkuYXBwbHlNYXRyaXg0KGEubWF0cml4V29ybGQpLAogICAgICBpbmRleDogciwKICAgICAgZmFjZTogbnVsbCwKICAgICAgZmFjZUluZGV4OiBudWxsLAogICAgICBiYXJ5Y29vcmQ6IG51bGwsCiAgICAgIG9iamVjdDogYQogICAgfTsKfQpjb25zdCBobSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBjbSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpOwpjbGFzcyBvaSBleHRlbmRzIFJzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxpbmUgc2VnbWVudHMuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlckdlb21ldHJ5fSBbZ2VvbWV0cnldIC0gVGhlIGxpbmUgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbHxBcnJheTxNYXRlcmlhbD59IFttYXRlcmlhbF0gLSBUaGUgbGluZSBtYXRlcmlhbC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlKSB7CiAgICBzdXBlcih0LCBlKSwgdGhpcy5pc0xpbmVTZWdtZW50cyA9ICEwLCB0aGlzLnR5cGUgPSAiTGluZVNlZ21lbnRzIjsKICB9CiAgY29tcHV0ZUxpbmVEaXN0YW5jZXMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5nZW9tZXRyeTsKICAgIGlmICh0LmluZGV4ID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGUgPSB0LmF0dHJpYnV0ZXMucG9zaXRpb24sIGkgPSBbXTsKICAgICAgZm9yIChsZXQgbiA9IDAsIHMgPSBlLmNvdW50OyBuIDwgczsgbiArPSAyKQogICAgICAgIGhtLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgbiksIGNtLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgbiArIDEpLCBpW25dID0gbiA9PT0gMCA/IDAgOiBpW24gLSAxXSwgaVtuICsgMV0gPSBpW25dICsgaG0uZGlzdGFuY2VUbyhjbSk7CiAgICAgIHQuc2V0QXR0cmlidXRlKCJsaW5lRGlzdGFuY2UiLCBuZXcgd3QoaSwgMSkpOwogICAgfSBlbHNlCiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuTGluZVNlZ21lbnRzLmNvbXB1dGVMaW5lRGlzdGFuY2VzKCk6IENvbXB1dGF0aW9uIG9ubHkgcG9zc2libGUgd2l0aCBub24taW5kZXhlZCBCdWZmZXJHZW9tZXRyeS4iKTsKICAgIHJldHVybiB0aGlzOwogIH0KfQpjbGFzcyBEeSBleHRlbmRzIFJzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxpbmUgbG9vcC4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IFtnZW9tZXRyeV0gLSBUaGUgbGluZSBnZW9tZXRyeS4KICAgKiBAcGFyYW0ge01hdGVyaWFsfEFycmF5PE1hdGVyaWFsPn0gW21hdGVyaWFsXSAtIFRoZSBsaW5lIG1hdGVyaWFsLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIHN1cGVyKHQsIGUpLCB0aGlzLmlzTGluZUxvb3AgPSAhMCwgdGhpcy50eXBlID0gIkxpbmVMb29wIjsKICB9Cn0KY2xhc3MgWGMgZXh0ZW5kcyBoaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwb2ludHMgbWF0ZXJpYWwuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtZXRlcnNdIC0gQW4gb2JqZWN0IHdpdGggb25lIG9yIG1vcmUgcHJvcGVydGllcwogICAqIGRlZmluaW5nIHRoZSBtYXRlcmlhbCdzIGFwcGVhcmFuY2UuIEFueSBwcm9wZXJ0eSBvZiB0aGUgbWF0ZXJpYWwKICAgKiAoaW5jbHVkaW5nIGFueSBwcm9wZXJ0eSBmcm9tIGluaGVyaXRlZCBtYXRlcmlhbHMpIGNhbiBiZSBwYXNzZWQKICAgKiBpbiBoZXJlLiBDb2xvciB2YWx1ZXMgY2FuIGJlIHBhc3NlZCBhbnkgdHlwZSBvZiB2YWx1ZSBhY2NlcHRlZAogICAqIGJ5IHtAbGluayBDb2xvciNzZXR9LgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNQb2ludHNNYXRlcmlhbCA9ICEwLCB0aGlzLnR5cGUgPSAiUG9pbnRzTWF0ZXJpYWwiLCB0aGlzLmNvbG9yID0gbmV3IGN0KDE2Nzc3MjE1KSwgdGhpcy5tYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5zaXplID0gMSwgdGhpcy5zaXplQXR0ZW51YXRpb24gPSAhMCwgdGhpcy5mb2cgPSAhMCwgdGhpcy5zZXRWYWx1ZXModCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuY29sb3IuY29weSh0LmNvbG9yKSwgdGhpcy5tYXAgPSB0Lm1hcCwgdGhpcy5hbHBoYU1hcCA9IHQuYWxwaGFNYXAsIHRoaXMuc2l6ZSA9IHQuc2l6ZSwgdGhpcy5zaXplQXR0ZW51YXRpb24gPSB0LnNpemVBdHRlbnVhdGlvbiwgdGhpcy5mb2cgPSB0LmZvZywgdGhpczsKICB9Cn0KY29uc3QgdW0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIGVwID0gLyogQF9fUFVSRV9fICovIG5ldyBBYSgpLCBNbCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUmUoKSwgU2wgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKY2xhc3Mga3AgZXh0ZW5kcyBsZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwb2ludCBjbG91ZC4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IFtnZW9tZXRyeV0gLSBUaGUgcG9pbnRzIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7TWF0ZXJpYWx8QXJyYXk8TWF0ZXJpYWw+fSBbbWF0ZXJpYWxdIC0gVGhlIHBvaW50cyBtYXRlcmlhbC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbmV3IEh0KCksIGUgPSBuZXcgWGMoKSkgewogICAgc3VwZXIoKSwgdGhpcy5pc1BvaW50cyA9ICEwLCB0aGlzLnR5cGUgPSAiUG9pbnRzIiwgdGhpcy5nZW9tZXRyeSA9IHQsIHRoaXMubWF0ZXJpYWwgPSBlLCB0aGlzLm1vcnBoVGFyZ2V0RGljdGlvbmFyeSA9IHZvaWQgMCwgdGhpcy5tb3JwaFRhcmdldEluZmx1ZW5jZXMgPSB2b2lkIDAsIHRoaXMudXBkYXRlTW9ycGhUYXJnZXRzKCk7CiAgfQogIGNvcHkodCwgZSkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCwgZSksIHRoaXMubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KHQubWF0ZXJpYWwpID8gdC5tYXRlcmlhbC5zbGljZSgpIDogdC5tYXRlcmlhbCwgdGhpcy5nZW9tZXRyeSA9IHQuZ2VvbWV0cnksIHRoaXM7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGludGVyc2VjdGlvbiBwb2ludHMgYmV0d2VlbiBhIGNhc3RlZCByYXkgYW5kIHRoaXMgcG9pbnQgY2xvdWQuCiAgICoKICAgKiBAcGFyYW0ge1JheWNhc3Rlcn0gcmF5Y2FzdGVyIC0gVGhlIHJheWNhc3Rlci4KICAgKiBAcGFyYW0ge0FycmF5PE9iamVjdD59IGludGVyc2VjdHMgLSBUaGUgdGFyZ2V0IGFycmF5IHRoYXQgaG9sZHMgdGhlIGludGVyc2VjdGlvbiBwb2ludHMuCiAgICovCiAgcmF5Y2FzdCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5nZW9tZXRyeSwgbiA9IHRoaXMubWF0cml4V29ybGQsIHMgPSB0LnBhcmFtcy5Qb2ludHMudGhyZXNob2xkLCByID0gaS5kcmF3UmFuZ2U7CiAgICBpZiAoaS5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiBpLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCBNbC5jb3B5KGkuYm91bmRpbmdTcGhlcmUpLCBNbC5hcHBseU1hdHJpeDQobiksIE1sLnJhZGl1cyArPSBzLCB0LnJheS5pbnRlcnNlY3RzU3BoZXJlKE1sKSA9PT0gITEpIHJldHVybjsKICAgIHVtLmNvcHkobikuaW52ZXJ0KCksIGVwLmNvcHkodC5yYXkpLmFwcGx5TWF0cml4NCh1bSk7CiAgICBjb25zdCBvID0gcyAvICgodGhpcy5zY2FsZS54ICsgdGhpcy5zY2FsZS55ICsgdGhpcy5zY2FsZS56KSAvIDMpLCBsID0gbyAqIG8sIGggPSBpLmluZGV4LCB1ID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgaWYgKGggIT09IG51bGwpIHsKICAgICAgY29uc3QgZCA9IE1hdGgubWF4KDAsIHIuc3RhcnQpLCBwID0gTWF0aC5taW4oaC5jb3VudCwgci5zdGFydCArIHIuY291bnQpOwogICAgICBmb3IgKGxldCBmID0gZCwgeSA9IHA7IGYgPCB5OyBmKyspIHsKICAgICAgICBjb25zdCBnID0gaC5nZXRYKGYpOwogICAgICAgIFNsLmZyb21CdWZmZXJBdHRyaWJ1dGUodSwgZyksIGRtKFNsLCBnLCBsLCBuLCB0LCBlLCB0aGlzKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgZCA9IE1hdGgubWF4KDAsIHIuc3RhcnQpLCBwID0gTWF0aC5taW4odS5jb3VudCwgci5zdGFydCArIHIuY291bnQpOwogICAgICBmb3IgKGxldCBmID0gZCwgeSA9IHA7IGYgPCB5OyBmKyspCiAgICAgICAgU2wuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh1LCBmKSwgZG0oU2wsIGYsIGwsIG4sIHQsIGUsIHRoaXMpOwogICAgfQogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2YWx1ZXMgb2Yge0BsaW5rIFBvaW50cyNtb3JwaFRhcmdldERpY3Rpb25hcnl9IGFuZCB7QGxpbmsgUG9pbnRzI21vcnBoVGFyZ2V0SW5mbHVlbmNlc30KICAgKiB0byBtYWtlIHN1cmUgZXhpc3RpbmcgbW9ycGggdGFyZ2V0cyBjYW4gaW5mbHVlbmNlIHRoaXMgM0Qgb2JqZWN0LgogICAqLwogIHVwZGF0ZU1vcnBoVGFyZ2V0cygpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcywgaSA9IE9iamVjdC5rZXlzKGUpOwogICAgaWYgKGkubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBuID0gZVtpWzBdXTsKICAgICAgaWYgKG4gIT09IHZvaWQgMCkgewogICAgICAgIHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzID0gW10sIHRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5ID0ge307CiAgICAgICAgZm9yIChsZXQgcyA9IDAsIHIgPSBuLmxlbmd0aDsgcyA8IHI7IHMrKykgewogICAgICAgICAgY29uc3QgbyA9IG5bc10ubmFtZSB8fCBTdHJpbmcocyk7CiAgICAgICAgICB0aGlzLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcy5wdXNoKDApLCB0aGlzLm1vcnBoVGFyZ2V0RGljdGlvbmFyeVtvXSA9IHM7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGRtKGEsIHQsIGUsIGksIG4sIHMsIHIpIHsKICBjb25zdCBvID0gZXAuZGlzdGFuY2VTcVRvUG9pbnQoYSk7CiAgaWYgKG8gPCBlKSB7CiAgICBjb25zdCBsID0gbmV3IEUoKTsKICAgIGVwLmNsb3Nlc3RQb2ludFRvUG9pbnQoYSwgbCksIGwuYXBwbHlNYXRyaXg0KGkpOwogICAgY29uc3QgaCA9IG4ucmF5Lm9yaWdpbi5kaXN0YW5jZVRvKGwpOwogICAgaWYgKGggPCBuLm5lYXIgfHwgaCA+IG4uZmFyKSByZXR1cm47CiAgICBzLnB1c2goewogICAgICBkaXN0YW5jZTogaCwKICAgICAgZGlzdGFuY2VUb1JheTogTWF0aC5zcXJ0KG8pLAogICAgICBwb2ludDogbCwKICAgICAgaW5kZXg6IHQsCiAgICAgIGZhY2U6IG51bGwsCiAgICAgIGZhY2VJbmRleDogbnVsbCwKICAgICAgYmFyeWNvb3JkOiBudWxsLAogICAgICBvYmplY3Q6IHIKICAgIH0pOwogIH0KfQpjbGFzcyBGeSBleHRlbmRzIE5lIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHZpZGVvIHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0ge0hUTUxWaWRlb0VsZW1lbnR9IHZpZGVvIC0gVGhlIHZpZGVvIGVsZW1lbnQgdG8gdXNlIGFzIGEgZGF0YSBzb3VyY2UgZm9yIHRoZSB0ZXh0dXJlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFwcGluZz1UZXh0dXJlLkRFRkFVTFRfTUFQUElOR10gLSBUaGUgdGV4dHVyZSBtYXBwaW5nLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd3JhcFM9Q2xhbXBUb0VkZ2VXcmFwcGluZ10gLSBUaGUgd3JhcFMgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwVD1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwVCB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21hZ0ZpbHRlcj1MaW5lYXJGaWx0ZXJdIC0gVGhlIG1hZyBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5GaWx0ZXI9TGluZWFyRmlsdGVyXSAtIFRoZSBtaW4gZmlsdGVyIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0PVJHQkFGb3JtYXRdIC0gVGhlIHRleHR1cmUgZm9ybWF0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdHlwZT1VbnNpZ25lZEJ5dGVUeXBlXSAtIFRoZSB0ZXh0dXJlIHR5cGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthbmlzb3Ryb3B5PVRleHR1cmUuREVGQVVMVF9BTklTT1RST1BZXSAtIFRoZSBhbmlzb3Ryb3B5IHZhbHVlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMgPSBDZSwgciA9IENlLCBvLCBsLCBoKSB7CiAgICBzdXBlcih0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKSwgdGhpcy5pc1ZpZGVvVGV4dHVyZSA9ICEwLCB0aGlzLmdlbmVyYXRlTWlwbWFwcyA9ICExLCB0aGlzLl9yZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrSWQgPSAwOwogICAgY29uc3QgYyA9IHRoaXM7CiAgICBmdW5jdGlvbiB1KCkgewogICAgICBjLm5lZWRzVXBkYXRlID0gITAsIGMuX3JlcXVlc3RWaWRlb0ZyYW1lQ2FsbGJhY2tJZCA9IHQucmVxdWVzdFZpZGVvRnJhbWVDYWxsYmFjayh1KTsKICAgIH0KICAgICJyZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrIiBpbiB0ICYmICh0aGlzLl9yZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrSWQgPSB0LnJlcXVlc3RWaWRlb0ZyYW1lQ2FsbGJhY2sodSkpOwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmltYWdlKS5jb3B5KHRoaXMpOwogIH0KICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBieSB0aGUgcmVuZGVyZXIgYW5kIHNldHMge0BsaW5rIFRleHR1cmUjbmVlZHNVcGRhdGV9CiAgICogdG8gYHRydWVgIGV2ZXJ5IHRpbWUgYSBuZXcgZnJhbWUgaXMgYXZhaWxhYmxlLgogICAqCiAgICogT25seSByZWxldmFudCBpZiBgcmVxdWVzdFZpZGVvRnJhbWVDYWxsYmFja2AgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICB1cGRhdGUoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5pbWFnZTsKICAgICJyZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrIiBpbiB0ID09PSAhMSAmJiB0LnJlYWR5U3RhdGUgPj0gdC5IQVZFX0NVUlJFTlRfREFUQSAmJiAodGhpcy5uZWVkc1VwZGF0ZSA9ICEwKTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuX3JlcXVlc3RWaWRlb0ZyYW1lQ2FsbGJhY2tJZCAhPT0gMCAmJiB0aGlzLnNvdXJjZS5kYXRhLmNhbmNlbFZpZGVvRnJhbWVDYWxsYmFjayh0aGlzLl9yZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrSWQpLCBzdXBlci5kaXNwb3NlKCk7CiAgfQp9CmNsYXNzIGViIGV4dGVuZHMgRnkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgdmlkZW8gZnJhbWUgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFwcGluZz1UZXh0dXJlLkRFRkFVTFRfTUFQUElOR10gLSBUaGUgdGV4dHVyZSBtYXBwaW5nLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd3JhcFM9Q2xhbXBUb0VkZ2VXcmFwcGluZ10gLSBUaGUgd3JhcFMgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwVD1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwVCB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21hZ0ZpbHRlcj1MaW5lYXJGaWx0ZXJdIC0gVGhlIG1hZyBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5GaWx0ZXI9TGluZWFyRmlsdGVyXSAtIFRoZSBtaW4gZmlsdGVyIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0PVJHQkFGb3JtYXRdIC0gVGhlIHRleHR1cmUgZm9ybWF0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdHlwZT1VbnNpZ25lZEJ5dGVUeXBlXSAtIFRoZSB0ZXh0dXJlIHR5cGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthbmlzb3Ryb3B5PVRleHR1cmUuREVGQVVMVF9BTklTT1RST1BZXSAtIFRoZSBhbmlzb3Ryb3B5IHZhbHVlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwpIHsKICAgIHN1cGVyKHt9LCB0LCBlLCBpLCBuLCBzLCByLCBvLCBsKSwgdGhpcy5pc1ZpZGVvRnJhbWVUZXh0dXJlID0gITA7CiAgfQogIC8qKgogICAqIFRoaXMgbWV0aG9kIG92ZXJ3cml0dGVuIHdpdGggYW4gZW1wdHkgaW1wbGVtZW50YXRpb24gc2luY2UKICAgKiB0aGlzIHR5cGUgb2YgdGV4dHVyZSBpcyB1cGRhdGVkIHZpYSBgc2V0RnJhbWUoKWAuCiAgICovCiAgdXBkYXRlKCkgewogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGN1cnJlbnQgZnJhbWUgb2YgdGhlIHZpZGVvLiBUaGlzIHdpbGwgYXV0b21hdGljYWxseSB1cGRhdGUgdGhlIHRleHR1cmUKICAgKiBzbyB0aGUgZGF0YSBjYW4gYmUgdXNlZCBmb3IgcmVuZGVyaW5nLgogICAqCiAgICogQHBhcmFtIHtWaWRlb0ZyYW1lfSBmcmFtZSAtIFRoZSB2aWRlbyBmcmFtZS4KICAgKi8KICBzZXRGcmFtZSh0KSB7CiAgICB0aGlzLmltYWdlID0gdCwgdGhpcy5uZWVkc1VwZGF0ZSA9ICEwOwogIH0KfQpjbGFzcyBpYiBleHRlbmRzIE5lIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGZyYW1lYnVmZmVyIHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIFRoZSB3aWR0aCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBUaGUgaGVpZ2h0IG9mIHRoZSB0ZXh0dXJlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIHN1cGVyKHsgd2lkdGg6IHQsIGhlaWdodDogZSB9KSwgdGhpcy5pc0ZyYW1lYnVmZmVyVGV4dHVyZSA9ICEwLCB0aGlzLm1hZ0ZpbHRlciA9IGplLCB0aGlzLm1pbkZpbHRlciA9IGplLCB0aGlzLmdlbmVyYXRlTWlwbWFwcyA9ICExLCB0aGlzLm5lZWRzVXBkYXRlID0gITA7CiAgfQp9CmNsYXNzIFljIGV4dGVuZHMgTmUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY29tcHJlc3NlZCB0ZXh0dXJlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBtaXBtYXBzIC0gVGhpcyBhcnJheSBob2xkcyBmb3IgYWxsIG1pcG1hcHMgKGluY2x1ZGluZyB0aGUgYmFzZXMgbWlwKQogICAqIHRoZSBkYXRhIGFuZCBkaW1lbnNpb25zLgogICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2Zvcm1hdD1SR0JBRm9ybWF0XSAtIFRoZSB0ZXh0dXJlIGZvcm1hdC4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R5cGU9VW5zaWduZWRCeXRlVHlwZV0gLSBUaGUgdGV4dHVyZSB0eXBlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFwcGluZz1UZXh0dXJlLkRFRkFVTFRfTUFQUElOR10gLSBUaGUgdGV4dHVyZSBtYXBwaW5nLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd3JhcFM9Q2xhbXBUb0VkZ2VXcmFwcGluZ10gLSBUaGUgd3JhcFMgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwVD1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwVCB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21hZ0ZpbHRlcj1MaW5lYXJGaWx0ZXJdIC0gVGhlIG1hZyBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5GaWx0ZXI9TGluZWFyTWlwbWFwTGluZWFyRmlsdGVyXSAtIFRoZSBtaW4gZmlsdGVyIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYW5pc290cm9weT1UZXh0dXJlLkRFRkFVTFRfQU5JU09UUk9QWV0gLSBUaGUgYW5pc290cm9weSB2YWx1ZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yU3BhY2U9Tm9Db2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoLCBjLCB1LCBkKSB7CiAgICBzdXBlcihudWxsLCByLCBvLCBsLCBoLCBjLCBuLCBzLCB1LCBkKSwgdGhpcy5pc0NvbXByZXNzZWRUZXh0dXJlID0gITAsIHRoaXMuaW1hZ2UgPSB7IHdpZHRoOiBlLCBoZWlnaHQ6IGkgfSwgdGhpcy5taXBtYXBzID0gdCwgdGhpcy5mbGlwWSA9ICExLCB0aGlzLmdlbmVyYXRlTWlwbWFwcyA9ICExOwogIH0KfQpjbGFzcyBuYiBleHRlbmRzIFljIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGNvbXByZXNzZWQgYXJyYXkgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gbWlwbWFwcyAtIFRoaXMgYXJyYXkgaG9sZHMgZm9yIGFsbCBtaXBtYXBzIChpbmNsdWRpbmcgdGhlIGJhc2VzIG1pcCkKICAgKiB0aGUgZGF0YSBhbmQgZGltZW5zaW9ucy4KICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIHRleHR1cmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHRleHR1cmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGRlcHRoIC0gVGhlIGRlcHRoIG9mIHRoZSB0ZXh0dXJlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0PVJHQkFGb3JtYXRdIC0gVGhlIG1pbiBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0eXBlPVVuc2lnbmVkQnl0ZVR5cGVdIC0gVGhlIG1pbiBmaWx0ZXIgdmFsdWUuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgcikgewogICAgc3VwZXIodCwgZSwgaSwgcywgciksIHRoaXMuaXNDb21wcmVzc2VkQXJyYXlUZXh0dXJlID0gITAsIHRoaXMuaW1hZ2UuZGVwdGggPSBuLCB0aGlzLndyYXBSID0gU2ksIHRoaXMubGF5ZXJVcGRhdGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICB9CiAgLyoqCiAgICogRGVzY3JpYmVzIHRoYXQgYSBzcGVjaWZpYyBsYXllciBvZiB0aGUgdGV4dHVyZSBuZWVkcyB0byBiZSB1cGRhdGVkLgogICAqIE5vcm1hbGx5IHdoZW4ge0BsaW5rIFRleHR1cmUjbmVlZHNVcGRhdGV9IGlzIHNldCB0byBgdHJ1ZWAsIHRoZQogICAqIGVudGlyZSBjb21wcmVzc2VkIHRleHR1cmUgYXJyYXkgaXMgc2VudCB0byB0aGUgR1BVLiBNYXJraW5nIHNwZWNpZmljCiAgICogbGF5ZXJzIHdpbGwgb25seSB0cmFuc21pdCBzdWJzZXRzIG9mIGFsbCBtaXBtYXBzIGFzc29jaWF0ZWQgd2l0aCBhCiAgICogc3BlY2lmaWMgZGVwdGggaW4gdGhlIGFycmF5IHdoaWNoIGlzIG9mdGVuIG11Y2ggbW9yZSBwZXJmb3JtYW50LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGxheWVySW5kZXggLSBUaGUgbGF5ZXIgaW5kZXggdGhhdCBzaG91bGQgYmUgdXBkYXRlZC4KICAgKi8KICBhZGRMYXllclVwZGF0ZSh0KSB7CiAgICB0aGlzLmxheWVyVXBkYXRlcy5hZGQodCk7CiAgfQogIC8qKgogICAqIFJlc2V0cyB0aGUgbGF5ZXIgdXBkYXRlcyByZWdpc3RyeS4KICAgKi8KICBjbGVhckxheWVyVXBkYXRlcygpIHsKICAgIHRoaXMubGF5ZXJVcGRhdGVzLmNsZWFyKCk7CiAgfQp9CmNsYXNzIHNiIGV4dGVuZHMgWWMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY29tcHJlc3NlZCB0ZXh0dXJlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxDb21wcmVzc2VkVGV4dHVyZT59IGltYWdlcyAtIEFuIGFycmF5IG9mIGNvbXByZXNzZWQgdGV4dHVyZXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtmb3JtYXQ9UkdCQUZvcm1hdF0gLSBUaGUgdGV4dHVyZSBmb3JtYXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0eXBlPVVuc2lnbmVkQnl0ZVR5cGVdIC0gVGhlIHRleHR1cmUgdHlwZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBzdXBlcih2b2lkIDAsIHRbMF0ud2lkdGgsIHRbMF0uaGVpZ2h0LCBlLCBpLCBpcyksIHRoaXMuaXNDb21wcmVzc2VkQ3ViZVRleHR1cmUgPSAhMCwgdGhpcy5pc0N1YmVUZXh0dXJlID0gITAsIHRoaXMuaW1hZ2UgPSB0OwogIH0KfQpjbGFzcyBVeSBleHRlbmRzIE5lIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBbY2FudmFzXSAtIFRoZSBIVE1MIGNhbnZhcyBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFwcGluZz1UZXh0dXJlLkRFRkFVTFRfTUFQUElOR10gLSBUaGUgdGV4dHVyZSBtYXBwaW5nLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd3JhcFM9Q2xhbXBUb0VkZ2VXcmFwcGluZ10gLSBUaGUgd3JhcFMgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwVD1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwVCB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21hZ0ZpbHRlcj1MaW5lYXJGaWx0ZXJdIC0gVGhlIG1hZyBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5GaWx0ZXI9TGluZWFyTWlwbWFwTGluZWFyRmlsdGVyXSAtIFRoZSBtaW4gZmlsdGVyIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0PVJHQkFGb3JtYXRdIC0gVGhlIHRleHR1cmUgZm9ybWF0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdHlwZT1VbnNpZ25lZEJ5dGVUeXBlXSAtIFRoZSB0ZXh0dXJlIHR5cGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthbmlzb3Ryb3B5PVRleHR1cmUuREVGQVVMVF9BTklTT1RST1BZXSAtIFRoZSBhbmlzb3Ryb3B5IHZhbHVlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgpIHsKICAgIHN1cGVyKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgpLCB0aGlzLmlzQ2FudmFzVGV4dHVyZSA9ICEwLCB0aGlzLm5lZWRzVXBkYXRlID0gITA7CiAgfQp9CmNsYXNzIFZwIGV4dGVuZHMgTmUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgZGVwdGggdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R5cGU9VW5zaWduZWRJbnRUeXBlXSAtIFRoZSB0ZXh0dXJlIHR5cGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttYXBwaW5nPVRleHR1cmUuREVGQVVMVF9NQVBQSU5HXSAtIFRoZSB0ZXh0dXJlIG1hcHBpbmcuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3cmFwUz1DbGFtcFRvRWRnZVdyYXBwaW5nXSAtIFRoZSB3cmFwUyB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dyYXBUPUNsYW1wVG9FZGdlV3JhcHBpbmddIC0gVGhlIHdyYXBUIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWFnRmlsdGVyPUxpbmVhckZpbHRlcl0gLSBUaGUgbWFnIGZpbHRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21pbkZpbHRlcj1MaW5lYXJGaWx0ZXJdIC0gVGhlIG1pbiBmaWx0ZXIgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthbmlzb3Ryb3B5PVRleHR1cmUuREVGQVVMVF9BTklTT1RST1BZXSAtIFRoZSBhbmlzb3Ryb3B5IHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0PURlcHRoRm9ybWF0XSAtIFRoZSB0ZXh0dXJlIGZvcm1hdC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RlcHRoPTFdIC0gVGhlIGRlcHRoIG9mIHRoZSB0ZXh0dXJlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkgPSBucywgbiwgcywgciwgbyA9IGplLCBsID0gamUsIGgsIGMgPSBmYSwgdSA9IDEpIHsKICAgIGlmIChjICE9PSBmYSAmJiBjICE9PSBtYSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZXB0aFRleHR1cmUgZm9ybWF0IG11c3QgYmUgZWl0aGVyIFRIUkVFLkRlcHRoRm9ybWF0IG9yIFRIUkVFLkRlcHRoU3RlbmNpbEZvcm1hdCIpOwogICAgY29uc3QgZCA9IHsgd2lkdGg6IHQsIGhlaWdodDogZSwgZGVwdGg6IHUgfTsKICAgIHN1cGVyKGQsIG4sIHMsIHIsIG8sIGwsIGMsIGksIGgpLCB0aGlzLmlzRGVwdGhUZXh0dXJlID0gITAsIHRoaXMuZmxpcFkgPSAhMSwgdGhpcy5nZW5lcmF0ZU1pcG1hcHMgPSAhMSwgdGhpcy5jb21wYXJlRnVuY3Rpb24gPSBudWxsOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnNvdXJjZSA9IG5ldyBNcyhPYmplY3QuYXNzaWduKHt9LCB0LmltYWdlKSksIHRoaXMuY29tcGFyZUZ1bmN0aW9uID0gdC5jb21wYXJlRnVuY3Rpb24sIHRoaXM7CiAgfQogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gc3VwZXIudG9KU09OKHQpOwogICAgcmV0dXJuIHRoaXMuY29tcGFyZUZ1bmN0aW9uICE9PSBudWxsICYmIChlLmNvbXBhcmVGdW5jdGlvbiA9IHRoaXMuY29tcGFyZUZ1bmN0aW9uKSwgZTsKICB9Cn0KY2xhc3MgSHAgZXh0ZW5kcyBOZSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyByYXcgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7PyhXZWJHTFRleHR1cmV8R1BVVGV4dHVyZSl9IFtzb3VyY2VUZXh0dXJlPW51bGxdIC0gVGhlIGV4dGVybmFsIHRleHR1cmUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG51bGwpIHsKICAgIHN1cGVyKCksIHRoaXMuc291cmNlVGV4dHVyZSA9IHQsIHRoaXMuaXNFeHRlcm5hbFRleHR1cmUgPSAhMDsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5zb3VyY2VUZXh0dXJlID0gdC5zb3VyY2VUZXh0dXJlLCB0aGlzOwogIH0KfQpjbGFzcyBaYyBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGNhcHN1bGUgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0xXSAtIFJhZGl1cyBvZiB0aGUgY2Fwc3VsZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodD0xXSAtIEhlaWdodCBvZiB0aGUgbWlkZGxlIHNlY3Rpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFtjYXBTZWdtZW50cz00XSAtIE51bWJlciBvZiBjdXJ2ZSBzZWdtZW50cyB1c2VkIHRvIGJ1aWxkIGVhY2ggY2FwLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaWFsU2VnbWVudHM9OF0gLSBOdW1iZXIgb2Ygc2VnbWVudGVkIGZhY2VzIGFyb3VuZCB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgY2Fwc3VsZS4gTXVzdCBiZSBhbiBpbnRlZ2VyID49IDMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHRTZWdtZW50cz0xXSAtIE51bWJlciBvZiByb3dzIG9mIGZhY2VzIGFsb25nIHRoZSBoZWlnaHQgb2YgdGhlIG1pZGRsZSBzZWN0aW9uLiBNdXN0IGJlIGFuIGludGVnZXIgPj0gMS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMSwgZSA9IDEsIGkgPSA0LCBuID0gOCwgcyA9IDEpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJDYXBzdWxlR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIHJhZGl1czogdCwKICAgICAgaGVpZ2h0OiBlLAogICAgICBjYXBTZWdtZW50czogaSwKICAgICAgcmFkaWFsU2VnbWVudHM6IG4sCiAgICAgIGhlaWdodFNlZ21lbnRzOiBzCiAgICB9LCBlID0gTWF0aC5tYXgoMCwgZSksIGkgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKGkpKSwgbiA9IE1hdGgubWF4KDMsIE1hdGguZmxvb3IobikpLCBzID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihzKSk7CiAgICBjb25zdCByID0gW10sIG8gPSBbXSwgbCA9IFtdLCBoID0gW10sIGMgPSBlIC8gMiwgdSA9IE1hdGguUEkgLyAyICogdCwgZCA9IGUsIHAgPSAyICogdSArIGQsIGYgPSBpICogMiArIHMsIHkgPSBuICsgMSwgZyA9IG5ldyBFKCksIG0gPSBuZXcgRSgpOwogICAgZm9yIChsZXQgdiA9IDA7IHYgPD0gZjsgdisrKSB7CiAgICAgIGxldCB4ID0gMCwgXyA9IDAsIFMgPSAwLCB3ID0gMDsKICAgICAgaWYgKHYgPD0gaSkgewogICAgICAgIGNvbnN0IGIgPSB2IC8gaSwgTSA9IGIgKiBNYXRoLlBJIC8gMjsKICAgICAgICBfID0gLWMgLSB0ICogTWF0aC5jb3MoTSksIFMgPSB0ICogTWF0aC5zaW4oTSksIHcgPSAtdCAqIE1hdGguY29zKE0pLCB4ID0gYiAqIHU7CiAgICAgIH0gZWxzZSBpZiAodiA8PSBpICsgcykgewogICAgICAgIGNvbnN0IGIgPSAodiAtIGkpIC8gczsKICAgICAgICBfID0gLWMgKyBiICogZSwgUyA9IHQsIHcgPSAwLCB4ID0gdSArIGIgKiBkOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGIgPSAodiAtIGkgLSBzKSAvIGksIE0gPSBiICogTWF0aC5QSSAvIDI7CiAgICAgICAgXyA9IGMgKyB0ICogTWF0aC5zaW4oTSksIFMgPSB0ICogTWF0aC5jb3MoTSksIHcgPSB0ICogTWF0aC5zaW4oTSksIHggPSB1ICsgZCArIGIgKiB1OwogICAgICB9CiAgICAgIGNvbnN0IFQgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4IC8gcCkpOwogICAgICBsZXQgUiA9IDA7CiAgICAgIHYgPT09IDAgPyBSID0gMC41IC8gbiA6IHYgPT09IGYgJiYgKFIgPSAtMC41IC8gbik7CiAgICAgIGZvciAobGV0IGIgPSAwOyBiIDw9IG47IGIrKykgewogICAgICAgIGNvbnN0IE0gPSBiIC8gbiwgTCA9IE0gKiBNYXRoLlBJICogMiwgVSA9IE1hdGguc2luKEwpLCBPID0gTWF0aC5jb3MoTCk7CiAgICAgICAgbS54ID0gLVMgKiBPLCBtLnkgPSBfLCBtLnogPSBTICogVSwgby5wdXNoKG0ueCwgbS55LCBtLnopLCBnLnNldCgKICAgICAgICAgIC1TICogTywKICAgICAgICAgIHcsCiAgICAgICAgICBTICogVQogICAgICAgICksIGcubm9ybWFsaXplKCksIGwucHVzaChnLngsIGcueSwgZy56KSwgaC5wdXNoKE0gKyBSLCBUKTsKICAgICAgfQogICAgICBpZiAodiA+IDApIHsKICAgICAgICBjb25zdCBiID0gKHYgLSAxKSAqIHk7CiAgICAgICAgZm9yIChsZXQgTSA9IDA7IE0gPCBuOyBNKyspIHsKICAgICAgICAgIGNvbnN0IEwgPSBiICsgTSwgVSA9IGIgKyBNICsgMSwgTyA9IHYgKiB5ICsgTSwgViA9IHYgKiB5ICsgTSArIDE7CiAgICAgICAgICByLnB1c2goTCwgVSwgTyksIHIucHVzaChVLCBWLCBPKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRoaXMuc2V0SW5kZXgociksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChvLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3QobCwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QoaCwgMikpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LnBhcmFtZXRlcnMpLCB0aGlzOwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtDYXBzdWxlR2VvbWV0cnl9IEEgbmV3IGluc3RhbmNlLgogICAqLwogIHN0YXRpYyBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gbmV3IFpjKHQucmFkaXVzLCB0LmhlaWdodCwgdC5jYXBTZWdtZW50cywgdC5yYWRpYWxTZWdtZW50cywgdC5oZWlnaHRTZWdtZW50cyk7CiAgfQp9CmNsYXNzIGpjIGV4dGVuZHMgSHQgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY2lyY2xlIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpdXM9MV0gLSBSYWRpdXMgb2YgdGhlIGNpcmNsZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3NlZ21lbnRzPTMyXSAtIE51bWJlciBvZiBzZWdtZW50cyAodHJpYW5nbGVzKSwgbWluaW11bSA9IGAzYC4KICAgKiBAcGFyYW0ge251bWJlcn0gW3RoZXRhU3RhcnQ9MF0gLSBTdGFydCBhbmdsZSBmb3IgZmlyc3Qgc2VnbWVudCBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGFMZW5ndGg9TWF0aC5QSSoyXSAtIFRoZSBjZW50cmFsIGFuZ2xlLCBvZnRlbiBjYWxsZWQgdGhldGEsCiAgICogb2YgdGhlIGNpcmN1bGFyIHNlY3RvciBpbiByYWRpYW5zLiBUaGUgZGVmYXVsdCB2YWx1ZSByZXN1bHRzIGluIGEgY29tcGxldGUgY2lyY2xlLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMzIsIGkgPSAwLCBuID0gTWF0aC5QSSAqIDIpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJDaXJjbGVHZW9tZXRyeSIsIHRoaXMucGFyYW1ldGVycyA9IHsKICAgICAgcmFkaXVzOiB0LAogICAgICBzZWdtZW50czogZSwKICAgICAgdGhldGFTdGFydDogaSwKICAgICAgdGhldGFMZW5ndGg6IG4KICAgIH0sIGUgPSBNYXRoLm1heCgzLCBlKTsKICAgIGNvbnN0IHMgPSBbXSwgciA9IFtdLCBvID0gW10sIGwgPSBbXSwgaCA9IG5ldyBFKCksIGMgPSBuZXcgSigpOwogICAgci5wdXNoKDAsIDAsIDApLCBvLnB1c2goMCwgMCwgMSksIGwucHVzaCgwLjUsIDAuNSk7CiAgICBmb3IgKGxldCB1ID0gMCwgZCA9IDM7IHUgPD0gZTsgdSsrLCBkICs9IDMpIHsKICAgICAgY29uc3QgcCA9IGkgKyB1IC8gZSAqIG47CiAgICAgIGgueCA9IHQgKiBNYXRoLmNvcyhwKSwgaC55ID0gdCAqIE1hdGguc2luKHApLCByLnB1c2goaC54LCBoLnksIGgueiksIG8ucHVzaCgwLCAwLCAxKSwgYy54ID0gKHJbZF0gLyB0ICsgMSkgLyAyLCBjLnkgPSAocltkICsgMV0gLyB0ICsgMSkgLyAyLCBsLnB1c2goYy54LCBjLnkpOwogICAgfQogICAgZm9yIChsZXQgdSA9IDE7IHUgPD0gZTsgdSsrKQogICAgICBzLnB1c2godSwgdSArIDEsIDApOwogICAgdGhpcy5zZXRJbmRleChzKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KHIsIDMpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIG5ldyB3dChvLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3dChsLCAyKSk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge0NpcmNsZUdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBqYyh0LnJhZGl1cywgdC5zZWdtZW50cywgdC50aGV0YVN0YXJ0LCB0LnRoZXRhTGVuZ3RoKTsKICB9Cn0KY2xhc3MgVGEgZXh0ZW5kcyBIdCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBjeWxpbmRlciBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzVG9wPTFdIC0gUmFkaXVzIG9mIHRoZSBjeWxpbmRlciBhdCB0aGUgdG9wLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzQm90dG9tPTFdIC0gUmFkaXVzIG9mIHRoZSBjeWxpbmRlciBhdCB0aGUgYm90dG9tLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTFdIC0gSGVpZ2h0IG9mIHRoZSBjeWxpbmRlci4KICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGlhbFNlZ21lbnRzPTMyXSAtIE51bWJlciBvZiBzZWdtZW50ZWQgZmFjZXMgYXJvdW5kIHRoZSBjaXJjdW1mZXJlbmNlIG9mIHRoZSBjeWxpbmRlci4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodFNlZ21lbnRzPTFdIC0gTnVtYmVyIG9mIHJvd3Mgb2YgZmFjZXMgYWxvbmcgdGhlIGhlaWdodCBvZiB0aGUgY3lsaW5kZXIuCiAgICogQHBhcmFtIHtib29sZWFufSBbb3BlbkVuZGVkPWZhbHNlXSAtIFdoZXRoZXIgdGhlIGJhc2Ugb2YgdGhlIGN5bGluZGVyIGlzIG9wZW4gb3IgY2FwcGVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGFTdGFydD0wXSAtIFN0YXJ0IGFuZ2xlIGZvciBmaXJzdCBzZWdtZW50LCBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGFMZW5ndGg9TWF0aC5QSSoyXSAtIFRoZSBjZW50cmFsIGFuZ2xlLCBvZnRlbiBjYWxsZWQgdGhldGEsIG9mIHRoZSBjaXJjdWxhciBzZWN0b3IsIGluIHJhZGlhbnMuCiAgICogVGhlIGRlZmF1bHQgdmFsdWUgcmVzdWx0cyBpbiBhIGNvbXBsZXRlIGN5bGluZGVyLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMSwgaSA9IDEsIG4gPSAzMiwgcyA9IDEsIHIgPSAhMSwgbyA9IDAsIGwgPSBNYXRoLlBJICogMikgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIkN5bGluZGVyR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIHJhZGl1c1RvcDogdCwKICAgICAgcmFkaXVzQm90dG9tOiBlLAogICAgICBoZWlnaHQ6IGksCiAgICAgIHJhZGlhbFNlZ21lbnRzOiBuLAogICAgICBoZWlnaHRTZWdtZW50czogcywKICAgICAgb3BlbkVuZGVkOiByLAogICAgICB0aGV0YVN0YXJ0OiBvLAogICAgICB0aGV0YUxlbmd0aDogbAogICAgfTsKICAgIGNvbnN0IGggPSB0aGlzOwogICAgbiA9IE1hdGguZmxvb3IobiksIHMgPSBNYXRoLmZsb29yKHMpOwogICAgY29uc3QgYyA9IFtdLCB1ID0gW10sIGQgPSBbXSwgcCA9IFtdOwogICAgbGV0IGYgPSAwOwogICAgY29uc3QgeSA9IFtdLCBnID0gaSAvIDI7CiAgICBsZXQgbSA9IDA7CiAgICB2KCksIHIgPT09ICExICYmICh0ID4gMCAmJiB4KCEwKSwgZSA+IDAgJiYgeCghMSkpLCB0aGlzLnNldEluZGV4KGMpLCB0aGlzLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QodSwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgibm9ybWFsIiwgbmV3IHd0KGQsIDMpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInV2IiwgbmV3IHd0KHAsIDIpKTsKICAgIGZ1bmN0aW9uIHYoKSB7CiAgICAgIGNvbnN0IF8gPSBuZXcgRSgpLCBTID0gbmV3IEUoKTsKICAgICAgbGV0IHcgPSAwOwogICAgICBjb25zdCBUID0gKGUgLSB0KSAvIGk7CiAgICAgIGZvciAobGV0IFIgPSAwOyBSIDw9IHM7IFIrKykgewogICAgICAgIGNvbnN0IGIgPSBbXSwgTSA9IFIgLyBzLCBMID0gTSAqIChlIC0gdCkgKyB0OwogICAgICAgIGZvciAobGV0IFUgPSAwOyBVIDw9IG47IFUrKykgewogICAgICAgICAgY29uc3QgTyA9IFUgLyBuLCBWID0gTyAqIGwgKyBvLCBXID0gTWF0aC5zaW4oViksIEcgPSBNYXRoLmNvcyhWKTsKICAgICAgICAgIFMueCA9IEwgKiBXLCBTLnkgPSAtTSAqIGkgKyBnLCBTLnogPSBMICogRywgdS5wdXNoKFMueCwgUy55LCBTLnopLCBfLnNldChXLCBULCBHKS5ub3JtYWxpemUoKSwgZC5wdXNoKF8ueCwgXy55LCBfLnopLCBwLnB1c2goTywgMSAtIE0pLCBiLnB1c2goZisrKTsKICAgICAgICB9CiAgICAgICAgeS5wdXNoKGIpOwogICAgICB9CiAgICAgIGZvciAobGV0IFIgPSAwOyBSIDwgbjsgUisrKQogICAgICAgIGZvciAobGV0IGIgPSAwOyBiIDwgczsgYisrKSB7CiAgICAgICAgICBjb25zdCBNID0geVtiXVtSXSwgTCA9IHlbYiArIDFdW1JdLCBVID0geVtiICsgMV1bUiArIDFdLCBPID0geVtiXVtSICsgMV07CiAgICAgICAgICAodCA+IDAgfHwgYiAhPT0gMCkgJiYgKGMucHVzaChNLCBMLCBPKSwgdyArPSAzKSwgKGUgPiAwIHx8IGIgIT09IHMgLSAxKSAmJiAoYy5wdXNoKEwsIFUsIE8pLCB3ICs9IDMpOwogICAgICAgIH0KICAgICAgaC5hZGRHcm91cChtLCB3LCAwKSwgbSArPSB3OwogICAgfQogICAgZnVuY3Rpb24geChfKSB7CiAgICAgIGNvbnN0IFMgPSBmLCB3ID0gbmV3IEooKSwgVCA9IG5ldyBFKCk7CiAgICAgIGxldCBSID0gMDsKICAgICAgY29uc3QgYiA9IF8gPT09ICEwID8gdCA6IGUsIE0gPSBfID09PSAhMCA/IDEgOiAtMTsKICAgICAgZm9yIChsZXQgVSA9IDE7IFUgPD0gbjsgVSsrKQogICAgICAgIHUucHVzaCgwLCBnICogTSwgMCksIGQucHVzaCgwLCBNLCAwKSwgcC5wdXNoKDAuNSwgMC41KSwgZisrOwogICAgICBjb25zdCBMID0gZjsKICAgICAgZm9yIChsZXQgVSA9IDA7IFUgPD0gbjsgVSsrKSB7CiAgICAgICAgY29uc3QgViA9IFUgLyBuICogbCArIG8sIFcgPSBNYXRoLmNvcyhWKSwgRyA9IE1hdGguc2luKFYpOwogICAgICAgIFQueCA9IGIgKiBHLCBULnkgPSBnICogTSwgVC56ID0gYiAqIFcsIHUucHVzaChULngsIFQueSwgVC56KSwgZC5wdXNoKDAsIE0sIDApLCB3LnggPSBXICogMC41ICsgMC41LCB3LnkgPSBHICogMC41ICogTSArIDAuNSwgcC5wdXNoKHcueCwgdy55KSwgZisrOwogICAgICB9CiAgICAgIGZvciAobGV0IFUgPSAwOyBVIDwgbjsgVSsrKSB7CiAgICAgICAgY29uc3QgTyA9IFMgKyBVLCBWID0gTCArIFU7CiAgICAgICAgXyA9PT0gITAgPyBjLnB1c2goViwgViArIDEsIE8pIDogYy5wdXNoKFYgKyAxLCBWLCBPKSwgUiArPSAzOwogICAgICB9CiAgICAgIGguYWRkR3JvdXAobSwgUiwgXyA9PT0gITAgPyAxIDogMiksIG0gKz0gUjsKICAgIH0KICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgdC5wYXJhbWV0ZXJzKSwgdGhpczsKICB9CiAgLyoqCiAgICogRmFjdG9yeSBtZXRob2QgZm9yIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoaXMgY2xhc3MgZnJvbSB0aGUgZ2l2ZW4KICAgKiBKU09OIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIC0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgZ2VvbWV0cnkuCiAgICogQHJldHVybiB7Q3lsaW5kZXJHZW9tZXRyeX0gQSBuZXcgaW5zdGFuY2UuCiAgICovCiAgc3RhdGljIGZyb21KU09OKHQpIHsKICAgIHJldHVybiBuZXcgVGEodC5yYWRpdXNUb3AsIHQucmFkaXVzQm90dG9tLCB0LmhlaWdodCwgdC5yYWRpYWxTZWdtZW50cywgdC5oZWlnaHRTZWdtZW50cywgdC5vcGVuRW5kZWQsIHQudGhldGFTdGFydCwgdC50aGV0YUxlbmd0aCk7CiAgfQp9CmNsYXNzIENhIGV4dGVuZHMgVGEgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY29uZSBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzPTFdIC0gUmFkaXVzIG9mIHRoZSBjb25lIGJhc2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MV0gLSBIZWlnaHQgb2YgdGhlIGNvbmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpYWxTZWdtZW50cz0zMl0gLSBOdW1iZXIgb2Ygc2VnbWVudGVkIGZhY2VzIGFyb3VuZCB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgY29uZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodFNlZ21lbnRzPTFdIC0gTnVtYmVyIG9mIHJvd3Mgb2YgZmFjZXMgYWxvbmcgdGhlIGhlaWdodCBvZiB0aGUgY29uZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcGVuRW5kZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgYmFzZSBvZiB0aGUgY29uZSBpcyBvcGVuIG9yIGNhcHBlZC4KICAgKiBAcGFyYW0ge251bWJlcn0gW3RoZXRhU3RhcnQ9MF0gLSBTdGFydCBhbmdsZSBmb3IgZmlyc3Qgc2VnbWVudCwgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3RoZXRhTGVuZ3RoPU1hdGguUEkqMl0gLSBUaGUgY2VudHJhbCBhbmdsZSwgb2Z0ZW4gY2FsbGVkIHRoZXRhLCBvZiB0aGUgY2lyY3VsYXIgc2VjdG9yLCBpbiByYWRpYW5zLgogICAqIFRoZSBkZWZhdWx0IHZhbHVlIHJlc3VsdHMgaW4gYSBjb21wbGV0ZSBjb25lLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMSwgaSA9IDMyLCBuID0gMSwgcyA9ICExLCByID0gMCwgbyA9IE1hdGguUEkgKiAyKSB7CiAgICBzdXBlcigwLCB0LCBlLCBpLCBuLCBzLCByLCBvKSwgdGhpcy50eXBlID0gIkNvbmVHZW9tZXRyeSIsIHRoaXMucGFyYW1ldGVycyA9IHsKICAgICAgcmFkaXVzOiB0LAogICAgICBoZWlnaHQ6IGUsCiAgICAgIHJhZGlhbFNlZ21lbnRzOiBpLAogICAgICBoZWlnaHRTZWdtZW50czogbiwKICAgICAgb3BlbkVuZGVkOiBzLAogICAgICB0aGV0YVN0YXJ0OiByLAogICAgICB0aGV0YUxlbmd0aDogbwogICAgfTsKICB9CiAgLyoqCiAgICogRmFjdG9yeSBtZXRob2QgZm9yIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoaXMgY2xhc3MgZnJvbSB0aGUgZ2l2ZW4KICAgKiBKU09OIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIC0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgZ2VvbWV0cnkuCiAgICogQHJldHVybiB7Q29uZUdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBDYSh0LnJhZGl1cywgdC5oZWlnaHQsIHQucmFkaWFsU2VnbWVudHMsIHQuaGVpZ2h0U2VnbWVudHMsIHQub3BlbkVuZGVkLCB0LnRoZXRhU3RhcnQsIHQudGhldGFMZW5ndGgpOwogIH0KfQpjbGFzcyBMcyBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHBvbHloZWRyb24gZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IFt2ZXJ0aWNlc10gLSBBIGZsYXQgYXJyYXkgb2YgdmVydGljZXMgZGVzY3JpYmluZyB0aGUgYmFzZSBzaGFwZS4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IFtpbmRpY2VzXSAtIEEgZmxhdCBhcnJheSBvZiBpbmRpY2VzIGRlc2NyaWJpbmcgdGhlIGJhc2Ugc2hhcGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpdXM9MV0gLSBUaGUgcmFkaXVzIG9mIHRoZSBzaGFwZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RldGFpbD0wXSAtIEhvdyBtYW55IGxldmVscyB0byBzdWJkaXZpZGUgdGhlIGdlb21ldHJ5LiBUaGUgbW9yZSBkZXRhaWwsIHRoZSBzbW9vdGhlciB0aGUgc2hhcGUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IFtdLCBlID0gW10sIGkgPSAxLCBuID0gMCkgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIlBvbHloZWRyb25HZW9tZXRyeSIsIHRoaXMucGFyYW1ldGVycyA9IHsKICAgICAgdmVydGljZXM6IHQsCiAgICAgIGluZGljZXM6IGUsCiAgICAgIHJhZGl1czogaSwKICAgICAgZGV0YWlsOiBuCiAgICB9OwogICAgY29uc3QgcyA9IFtdLCByID0gW107CiAgICBvKG4pLCBoKGkpLCBjKCksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChzLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3Qocy5zbGljZSgpLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3dChyLCAyKSksIG4gPT09IDAgPyB0aGlzLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCkgOiB0aGlzLm5vcm1hbGl6ZU5vcm1hbHMoKTsKICAgIGZ1bmN0aW9uIG8odikgewogICAgICBjb25zdCB4ID0gbmV3IEUoKSwgXyA9IG5ldyBFKCksIFMgPSBuZXcgRSgpOwogICAgICBmb3IgKGxldCB3ID0gMDsgdyA8IGUubGVuZ3RoOyB3ICs9IDMpCiAgICAgICAgcChlW3cgKyAwXSwgeCksIHAoZVt3ICsgMV0sIF8pLCBwKGVbdyArIDJdLCBTKSwgbCh4LCBfLCBTLCB2KTsKICAgIH0KICAgIGZ1bmN0aW9uIGwodiwgeCwgXywgUykgewogICAgICBjb25zdCB3ID0gUyArIDEsIFQgPSBbXTsKICAgICAgZm9yIChsZXQgUiA9IDA7IFIgPD0gdzsgUisrKSB7CiAgICAgICAgVFtSXSA9IFtdOwogICAgICAgIGNvbnN0IGIgPSB2LmNsb25lKCkubGVycChfLCBSIC8gdyksIE0gPSB4LmNsb25lKCkubGVycChfLCBSIC8gdyksIEwgPSB3IC0gUjsKICAgICAgICBmb3IgKGxldCBVID0gMDsgVSA8PSBMOyBVKyspCiAgICAgICAgICBVID09PSAwICYmIFIgPT09IHcgPyBUW1JdW1VdID0gYiA6IFRbUl1bVV0gPSBiLmNsb25lKCkubGVycChNLCBVIC8gTCk7CiAgICAgIH0KICAgICAgZm9yIChsZXQgUiA9IDA7IFIgPCB3OyBSKyspCiAgICAgICAgZm9yIChsZXQgYiA9IDA7IGIgPCAyICogKHcgLSBSKSAtIDE7IGIrKykgewogICAgICAgICAgY29uc3QgTSA9IE1hdGguZmxvb3IoYiAvIDIpOwogICAgICAgICAgYiAlIDIgPT09IDAgPyAoZChUW1JdW00gKyAxXSksIGQoVFtSICsgMV1bTV0pLCBkKFRbUl1bTV0pKSA6IChkKFRbUl1bTSArIDFdKSwgZChUW1IgKyAxXVtNICsgMV0pLCBkKFRbUiArIDFdW01dKSk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaCh2KSB7CiAgICAgIGNvbnN0IHggPSBuZXcgRSgpOwogICAgICBmb3IgKGxldCBfID0gMDsgXyA8IHMubGVuZ3RoOyBfICs9IDMpCiAgICAgICAgeC54ID0gc1tfICsgMF0sIHgueSA9IHNbXyArIDFdLCB4LnogPSBzW18gKyAyXSwgeC5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih2KSwgc1tfICsgMF0gPSB4LngsIHNbXyArIDFdID0geC55LCBzW18gKyAyXSA9IHguejsKICAgIH0KICAgIGZ1bmN0aW9uIGMoKSB7CiAgICAgIGNvbnN0IHYgPSBuZXcgRSgpOwogICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHMubGVuZ3RoOyB4ICs9IDMpIHsKICAgICAgICB2LnggPSBzW3ggKyAwXSwgdi55ID0gc1t4ICsgMV0sIHYueiA9IHNbeCArIDJdOwogICAgICAgIGNvbnN0IF8gPSBnKHYpIC8gMiAvIE1hdGguUEkgKyAwLjUsIFMgPSBtKHYpIC8gTWF0aC5QSSArIDAuNTsKICAgICAgICByLnB1c2goXywgMSAtIFMpOwogICAgICB9CiAgICAgIGYoKSwgdSgpOwogICAgfQogICAgZnVuY3Rpb24gdSgpIHsKICAgICAgZm9yIChsZXQgdiA9IDA7IHYgPCByLmxlbmd0aDsgdiArPSA2KSB7CiAgICAgICAgY29uc3QgeCA9IHJbdiArIDBdLCBfID0gclt2ICsgMl0sIFMgPSByW3YgKyA0XSwgdyA9IE1hdGgubWF4KHgsIF8sIFMpLCBUID0gTWF0aC5taW4oeCwgXywgUyk7CiAgICAgICAgdyA+IDAuOSAmJiBUIDwgMC4xICYmICh4IDwgMC4yICYmIChyW3YgKyAwXSArPSAxKSwgXyA8IDAuMiAmJiAoclt2ICsgMl0gKz0gMSksIFMgPCAwLjIgJiYgKHJbdiArIDRdICs9IDEpKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZCh2KSB7CiAgICAgIHMucHVzaCh2LngsIHYueSwgdi56KTsKICAgIH0KICAgIGZ1bmN0aW9uIHAodiwgeCkgewogICAgICBjb25zdCBfID0gdiAqIDM7CiAgICAgIHgueCA9IHRbXyArIDBdLCB4LnkgPSB0W18gKyAxXSwgeC56ID0gdFtfICsgMl07CiAgICB9CiAgICBmdW5jdGlvbiBmKCkgewogICAgICBjb25zdCB2ID0gbmV3IEUoKSwgeCA9IG5ldyBFKCksIF8gPSBuZXcgRSgpLCBTID0gbmV3IEUoKSwgdyA9IG5ldyBKKCksIFQgPSBuZXcgSigpLCBSID0gbmV3IEooKTsKICAgICAgZm9yIChsZXQgYiA9IDAsIE0gPSAwOyBiIDwgcy5sZW5ndGg7IGIgKz0gOSwgTSArPSA2KSB7CiAgICAgICAgdi5zZXQoc1tiICsgMF0sIHNbYiArIDFdLCBzW2IgKyAyXSksIHguc2V0KHNbYiArIDNdLCBzW2IgKyA0XSwgc1tiICsgNV0pLCBfLnNldChzW2IgKyA2XSwgc1tiICsgN10sIHNbYiArIDhdKSwgdy5zZXQocltNICsgMF0sIHJbTSArIDFdKSwgVC5zZXQocltNICsgMl0sIHJbTSArIDNdKSwgUi5zZXQocltNICsgNF0sIHJbTSArIDVdKSwgUy5jb3B5KHYpLmFkZCh4KS5hZGQoXykuZGl2aWRlU2NhbGFyKDMpOwogICAgICAgIGNvbnN0IEwgPSBnKFMpOwogICAgICAgIHkodywgTSArIDAsIHYsIEwpLCB5KFQsIE0gKyAyLCB4LCBMKSwgeShSLCBNICsgNCwgXywgTCk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHkodiwgeCwgXywgUykgewogICAgICBTIDwgMCAmJiB2LnggPT09IDEgJiYgKHJbeF0gPSB2LnggLSAxKSwgXy54ID09PSAwICYmIF8ueiA9PT0gMCAmJiAoclt4XSA9IFMgLyAyIC8gTWF0aC5QSSArIDAuNSk7CiAgICB9CiAgICBmdW5jdGlvbiBnKHYpIHsKICAgICAgcmV0dXJuIE1hdGguYXRhbjIodi56LCAtdi54KTsKICAgIH0KICAgIGZ1bmN0aW9uIG0odikgewogICAgICByZXR1cm4gTWF0aC5hdGFuMigtdi55LCBNYXRoLnNxcnQodi54ICogdi54ICsgdi56ICogdi56KSk7CiAgICB9CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge1BvbHloZWRyb25HZW9tZXRyeX0gQSBuZXcgaW5zdGFuY2UuCiAgICovCiAgc3RhdGljIGZyb21KU09OKHQpIHsKICAgIHJldHVybiBuZXcgTHModC52ZXJ0aWNlcywgdC5pbmRpY2VzLCB0LnJhZGl1cywgdC5kZXRhaWxzKTsKICB9Cn0KY2xhc3MgSmMgZXh0ZW5kcyBMcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBkb2RlY2FoZWRyb24gZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0xXSAtIFJhZGl1cyBvZiB0aGUgZG9kZWNhaGVkcm9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGV0YWlsPTBdIC0gU2V0dGluZyB0aGlzIHRvIGEgdmFsdWUgZ3JlYXRlciB0aGFuIGAwYCBhZGRzIHZlcnRpY2VzIG1ha2luZyBpdCBubyBsb25nZXIgYSBkb2RlY2FoZWRyb24uCiAgICovCiAgY29uc3RydWN0b3IodCA9IDEsIGUgPSAwKSB7CiAgICBjb25zdCBpID0gKDEgKyBNYXRoLnNxcnQoNSkpIC8gMiwgbiA9IDEgLyBpLCBzID0gWwogICAgICAvLyAowrExLCDCsTEsIMKxMSkKICAgICAgLTEsCiAgICAgIC0xLAogICAgICAtMSwKICAgICAgLTEsCiAgICAgIC0xLAogICAgICAxLAogICAgICAtMSwKICAgICAgMSwKICAgICAgLTEsCiAgICAgIC0xLAogICAgICAxLAogICAgICAxLAogICAgICAxLAogICAgICAtMSwKICAgICAgLTEsCiAgICAgIDEsCiAgICAgIC0xLAogICAgICAxLAogICAgICAxLAogICAgICAxLAogICAgICAtMSwKICAgICAgMSwKICAgICAgMSwKICAgICAgMSwKICAgICAgLy8gKDAsIMKxMS/PhiwgwrHPhikKICAgICAgMCwKICAgICAgLW4sCiAgICAgIC1pLAogICAgICAwLAogICAgICAtbiwKICAgICAgaSwKICAgICAgMCwKICAgICAgbiwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIG4sCiAgICAgIGksCiAgICAgIC8vICjCsTEvz4YsIMKxz4YsIDApCiAgICAgIC1uLAogICAgICAtaSwKICAgICAgMCwKICAgICAgLW4sCiAgICAgIGksCiAgICAgIDAsCiAgICAgIG4sCiAgICAgIC1pLAogICAgICAwLAogICAgICBuLAogICAgICBpLAogICAgICAwLAogICAgICAvLyAowrHPhiwgMCwgwrExL8+GKQogICAgICAtaSwKICAgICAgMCwKICAgICAgLW4sCiAgICAgIGksCiAgICAgIDAsCiAgICAgIC1uLAogICAgICAtaSwKICAgICAgMCwKICAgICAgbiwKICAgICAgaSwKICAgICAgMCwKICAgICAgbgogICAgXSwgciA9IFsKICAgICAgMywKICAgICAgMTEsCiAgICAgIDcsCiAgICAgIDMsCiAgICAgIDcsCiAgICAgIDE1LAogICAgICAzLAogICAgICAxNSwKICAgICAgMTMsCiAgICAgIDcsCiAgICAgIDE5LAogICAgICAxNywKICAgICAgNywKICAgICAgMTcsCiAgICAgIDYsCiAgICAgIDcsCiAgICAgIDYsCiAgICAgIDE1LAogICAgICAxNywKICAgICAgNCwKICAgICAgOCwKICAgICAgMTcsCiAgICAgIDgsCiAgICAgIDEwLAogICAgICAxNywKICAgICAgMTAsCiAgICAgIDYsCiAgICAgIDgsCiAgICAgIDAsCiAgICAgIDE2LAogICAgICA4LAogICAgICAxNiwKICAgICAgMiwKICAgICAgOCwKICAgICAgMiwKICAgICAgMTAsCiAgICAgIDAsCiAgICAgIDEyLAogICAgICAxLAogICAgICAwLAogICAgICAxLAogICAgICAxOCwKICAgICAgMCwKICAgICAgMTgsCiAgICAgIDE2LAogICAgICA2LAogICAgICAxMCwKICAgICAgMiwKICAgICAgNiwKICAgICAgMiwKICAgICAgMTMsCiAgICAgIDYsCiAgICAgIDEzLAogICAgICAxNSwKICAgICAgMiwKICAgICAgMTYsCiAgICAgIDE4LAogICAgICAyLAogICAgICAxOCwKICAgICAgMywKICAgICAgMiwKICAgICAgMywKICAgICAgMTMsCiAgICAgIDE4LAogICAgICAxLAogICAgICA5LAogICAgICAxOCwKICAgICAgOSwKICAgICAgMTEsCiAgICAgIDE4LAogICAgICAxMSwKICAgICAgMywKICAgICAgNCwKICAgICAgMTQsCiAgICAgIDEyLAogICAgICA0LAogICAgICAxMiwKICAgICAgMCwKICAgICAgNCwKICAgICAgMCwKICAgICAgOCwKICAgICAgMTEsCiAgICAgIDksCiAgICAgIDUsCiAgICAgIDExLAogICAgICA1LAogICAgICAxOSwKICAgICAgMTEsCiAgICAgIDE5LAogICAgICA3LAogICAgICAxOSwKICAgICAgNSwKICAgICAgMTQsCiAgICAgIDE5LAogICAgICAxNCwKICAgICAgNCwKICAgICAgMTksCiAgICAgIDQsCiAgICAgIDE3LAogICAgICAxLAogICAgICAxMiwKICAgICAgMTQsCiAgICAgIDEsCiAgICAgIDE0LAogICAgICA1LAogICAgICAxLAogICAgICA1LAogICAgICA5CiAgICBdOwogICAgc3VwZXIocywgciwgdCwgZSksIHRoaXMudHlwZSA9ICJEb2RlY2FoZWRyb25HZW9tZXRyeSIsIHRoaXMucGFyYW1ldGVycyA9IHsKICAgICAgcmFkaXVzOiB0LAogICAgICBkZXRhaWw6IGUKICAgIH07CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge0RvZGVjYWhlZHJvbkdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBKYyh0LnJhZGl1cywgdC5kZXRhaWwpOwogIH0KfQpjb25zdCB3bCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBBbCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBXdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBFbCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgYnMoKTsKY2xhc3MgQnkgZXh0ZW5kcyBIdCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBlZGdlcyBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7P0J1ZmZlckdlb21ldHJ5fSBbZ2VvbWV0cnk9bnVsbF0gLSBUaGUgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aHJlc2hvbGRBbmdsZT0xXSAtIEFuIGVkZ2UgaXMgb25seSByZW5kZXJlZCBpZiB0aGUgYW5nbGUgKGluIGRlZ3JlZXMpCiAgICogYmV0d2VlbiB0aGUgZmFjZSBub3JtYWxzIG9mIHRoZSBhZGpvaW5pbmcgZmFjZXMgZXhjZWVkcyB0aGlzIHZhbHVlLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBudWxsLCBlID0gMSkgewogICAgaWYgKHN1cGVyKCksIHRoaXMudHlwZSA9ICJFZGdlc0dlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICBnZW9tZXRyeTogdCwKICAgICAgdGhyZXNob2xkQW5nbGU6IGUKICAgIH0sIHQgIT09IG51bGwpIHsKICAgICAgY29uc3QgbiA9IE1hdGgucG93KDEwLCA0KSwgcyA9IE1hdGguY29zKGxyICogZSksIHIgPSB0LmdldEluZGV4KCksIG8gPSB0LmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKSwgbCA9IHIgPyByLmNvdW50IDogby5jb3VudCwgaCA9IFswLCAwLCAwXSwgYyA9IFsiYSIsICJiIiwgImMiXSwgdSA9IG5ldyBBcnJheSgzKSwgZCA9IHt9LCBwID0gW107CiAgICAgIGZvciAobGV0IGYgPSAwOyBmIDwgbDsgZiArPSAzKSB7CiAgICAgICAgciA/IChoWzBdID0gci5nZXRYKGYpLCBoWzFdID0gci5nZXRYKGYgKyAxKSwgaFsyXSA9IHIuZ2V0WChmICsgMikpIDogKGhbMF0gPSBmLCBoWzFdID0gZiArIDEsIGhbMl0gPSBmICsgMik7CiAgICAgICAgY29uc3QgeyBhOiB5LCBiOiBnLCBjOiBtIH0gPSBFbDsKICAgICAgICBpZiAoeS5mcm9tQnVmZmVyQXR0cmlidXRlKG8sIGhbMF0pLCBnLmZyb21CdWZmZXJBdHRyaWJ1dGUobywgaFsxXSksIG0uZnJvbUJ1ZmZlckF0dHJpYnV0ZShvLCBoWzJdKSwgRWwuZ2V0Tm9ybWFsKFd1KSwgdVswXSA9IGAke01hdGgucm91bmQoeS54ICogbil9LCR7TWF0aC5yb3VuZCh5LnkgKiBuKX0sJHtNYXRoLnJvdW5kKHkueiAqIG4pfWAsIHVbMV0gPSBgJHtNYXRoLnJvdW5kKGcueCAqIG4pfSwke01hdGgucm91bmQoZy55ICogbil9LCR7TWF0aC5yb3VuZChnLnogKiBuKX1gLCB1WzJdID0gYCR7TWF0aC5yb3VuZChtLnggKiBuKX0sJHtNYXRoLnJvdW5kKG0ueSAqIG4pfSwke01hdGgucm91bmQobS56ICogbil9YCwgISh1WzBdID09PSB1WzFdIHx8IHVbMV0gPT09IHVbMl0gfHwgdVsyXSA9PT0gdVswXSkpCiAgICAgICAgICBmb3IgKGxldCB2ID0gMDsgdiA8IDM7IHYrKykgewogICAgICAgICAgICBjb25zdCB4ID0gKHYgKyAxKSAlIDMsIF8gPSB1W3ZdLCBTID0gdVt4XSwgdyA9IEVsW2Nbdl1dLCBUID0gRWxbY1t4XV0sIFIgPSBgJHtffV8ke1N9YCwgYiA9IGAke1N9XyR7X31gOwogICAgICAgICAgICBiIGluIGQgJiYgZFtiXSA/IChXdS5kb3QoZFtiXS5ub3JtYWwpIDw9IHMgJiYgKHAucHVzaCh3LngsIHcueSwgdy56KSwgcC5wdXNoKFQueCwgVC55LCBULnopKSwgZFtiXSA9IG51bGwpIDogUiBpbiBkIHx8IChkW1JdID0gewogICAgICAgICAgICAgIGluZGV4MDogaFt2XSwKICAgICAgICAgICAgICBpbmRleDE6IGhbeF0sCiAgICAgICAgICAgICAgbm9ybWFsOiBXdS5jbG9uZSgpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoY29uc3QgZiBpbiBkKQogICAgICAgIGlmIChkW2ZdKSB7CiAgICAgICAgICBjb25zdCB7IGluZGV4MDogeSwgaW5kZXgxOiBnIH0gPSBkW2ZdOwogICAgICAgICAgd2wuZnJvbUJ1ZmZlckF0dHJpYnV0ZShvLCB5KSwgQWwuZnJvbUJ1ZmZlckF0dHJpYnV0ZShvLCBnKSwgcC5wdXNoKHdsLngsIHdsLnksIHdsLnopLCBwLnB1c2goQWwueCwgQWwueSwgQWwueik7CiAgICAgICAgfQogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QocCwgMykpOwogICAgfQogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LnBhcmFtZXRlcnMpLCB0aGlzOwogIH0KfQpjbGFzcyBtbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBjdXJ2ZS4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMudHlwZSA9ICJDdXJ2ZSIsIHRoaXMuYXJjTGVuZ3RoRGl2aXNpb25zID0gMjAwLCB0aGlzLm5lZWRzVXBkYXRlID0gITEsIHRoaXMuY2FjaGVBcmNMZW5ndGhzID0gbnVsbDsKICB9CiAgLyoqCiAgICogVGhpcyBtZXRob2QgcmV0dXJucyBhIHZlY3RvciBpbiAyRCBvciAzRCBzcGFjZSAoZGVwZW5kaW5nIG9uIHRoZSBjdXJ2ZSBkZWZpbml0aW9uKQogICAqIGZvciB0aGUgZ2l2ZW4gaW50ZXJwb2xhdGlvbiBmYWN0b3IuCiAgICoKICAgKiBAYWJzdHJhY3QKICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIEEgaW50ZXJwb2xhdGlvbiBmYWN0b3IgcmVwcmVzZW50aW5nIGEgcG9zaXRpb24gb24gdGhlIGN1cnZlLiBNdXN0IGJlIGluIHRoZSByYW5nZSBgWzAsMV1gLgogICAqIEBwYXJhbSB7KFZlY3RvcjJ8VmVjdG9yMyl9IFtvcHRpb25hbFRhcmdldF0gLSBUaGUgb3B0aW9uYWwgdGFyZ2V0IHZlY3RvciB0aGUgcmVzdWx0IGlzIHdyaXR0ZW4gdG8uCiAgICogQHJldHVybiB7KFZlY3RvcjJ8VmVjdG9yMyl9IFRoZSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIEl0IGNhbiBiZSBhIDJEIG9yIDNEIHZlY3RvciBkZXBlbmRpbmcgb24gdGhlIGN1cnZlIGRlZmluaXRpb24uCiAgICovCiAgZ2V0UG9pbnQoKSB7CiAgICBjb25zb2xlLndhcm4oIlRIUkVFLkN1cnZlOiAuZ2V0UG9pbnQoKSBub3QgaW1wbGVtZW50ZWQuIik7CiAgfQogIC8qKgogICAqIFRoaXMgbWV0aG9kIHJldHVybnMgYSB2ZWN0b3IgaW4gMkQgb3IgM0Qgc3BhY2UgKGRlcGVuZGluZyBvbiB0aGUgY3VydmUgZGVmaW5pdGlvbikKICAgKiBmb3IgdGhlIGdpdmVuIGludGVycG9sYXRpb24gZmFjdG9yLiBVbmxpa2Uge0BsaW5rIEN1cnZlI2dldFBvaW50fSwgdGhpcyBtZXRob2QgaG9ub3JzIHRoZSBsZW5ndGgKICAgKiBvZiB0aGUgY3VydmUgd2hpY2ggZXF1aWRpc3RhbnQgc2FtcGxlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB1IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIE11c3QgYmUgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHBhcmFtIHsoVmVjdG9yMnxWZWN0b3IzKX0gW29wdGlvbmFsVGFyZ2V0XSAtIFRoZSBvcHRpb25hbCB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgd3JpdHRlbiB0by4KICAgKiBAcmV0dXJuIHsoVmVjdG9yMnxWZWN0b3IzKX0gVGhlIHBvc2l0aW9uIG9uIHRoZSBjdXJ2ZS4gSXQgY2FuIGJlIGEgMkQgb3IgM0QgdmVjdG9yIGRlcGVuZGluZyBvbiB0aGUgY3VydmUgZGVmaW5pdGlvbi4KICAgKi8KICBnZXRQb2ludEF0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdldFV0b1RtYXBwaW5nKHQpOwogICAgcmV0dXJuIHRoaXMuZ2V0UG9pbnQoaSwgZSk7CiAgfQogIC8qKgogICAqIFRoaXMgbWV0aG9kIHNhbXBsZXMgdGhlIGN1cnZlIHZpYSB7QGxpbmsgQ3VydmUjZ2V0UG9pbnR9IGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIHBvaW50cyByZXByZXNlbnRpbmcKICAgKiB0aGUgY3VydmUgc2hhcGUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW2RpdmlzaW9ucz01XSAtIFRoZSBudW1iZXIgb2YgZGl2aXNpb25zLgogICAqIEByZXR1cm4ge0FycmF5PChWZWN0b3IyfFZlY3RvcjMpPn0gQW4gYXJyYXkgaG9sZGluZyB0aGUgc2FtcGxlZCBjdXJ2ZSB2YWx1ZXMuIFRoZSBudW1iZXIgb2YgcG9pbnRzIGlzIGBkaXZpc2lvbnMgKyAxYC4KICAgKi8KICBnZXRQb2ludHModCA9IDUpIHsKICAgIGNvbnN0IGUgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHQ7IGkrKykKICAgICAgZS5wdXNoKHRoaXMuZ2V0UG9pbnQoaSAvIHQpKTsKICAgIHJldHVybiBlOwogIH0KICAvLyBHZXQgc2VxdWVuY2Ugb2YgcG9pbnRzIHVzaW5nIGdldFBvaW50QXQoIHUgKQogIC8qKgogICAqIFRoaXMgbWV0aG9kIHNhbXBsZXMgdGhlIGN1cnZlIHZpYSB7QGxpbmsgQ3VydmUjZ2V0UG9pbnRBdH0gYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgcG9pbnRzIHJlcHJlc2VudGluZwogICAqIHRoZSBjdXJ2ZSBzaGFwZS4gVW5saWtlIHtAbGluayBDdXJ2ZSNnZXRQb2ludHN9LCB0aGlzIG1ldGhvZCByZXR1cm5zIGVxdWktc3BhY2VkIHBvaW50cyBhY3Jvc3MgdGhlIGVudGlyZQogICAqIGN1cnZlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkaXZpc2lvbnM9NV0gLSBUaGUgbnVtYmVyIG9mIGRpdmlzaW9ucy4KICAgKiBAcmV0dXJuIHtBcnJheTwoVmVjdG9yMnxWZWN0b3IzKT59IEFuIGFycmF5IGhvbGRpbmcgdGhlIHNhbXBsZWQgY3VydmUgdmFsdWVzLiBUaGUgbnVtYmVyIG9mIHBvaW50cyBpcyBgZGl2aXNpb25zICsgMWAuCiAgICovCiAgZ2V0U3BhY2VkUG9pbnRzKHQgPSA1KSB7CiAgICBjb25zdCBlID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSB0OyBpKyspCiAgICAgIGUucHVzaCh0aGlzLmdldFBvaW50QXQoaSAvIHQpKTsKICAgIHJldHVybiBlOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSB0b3RhbCBhcmMgbGVuZ3RoIG9mIHRoZSBjdXJ2ZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxlbmd0aCBvZiB0aGUgY3VydmUuCiAgICovCiAgZ2V0TGVuZ3RoKCkgewogICAgY29uc3QgdCA9IHRoaXMuZ2V0TGVuZ3RocygpOwogICAgcmV0dXJuIHRbdC5sZW5ndGggLSAxXTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhbiBhcnJheSBvZiBjdW11bGF0aXZlIHNlZ21lbnQgbGVuZ3RocyBvZiB0aGUgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW2RpdmlzaW9ucz10aGlzLmFyY0xlbmd0aERpdmlzaW9uc10gLSBUaGUgbnVtYmVyIG9mIGRpdmlzaW9ucy4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBBbiBhcnJheSBob2xkaW5nIHRoZSBjdW11bGF0aXZlIHNlZ21lbnQgbGVuZ3Rocy4KICAgKi8KICBnZXRMZW5ndGhzKHQgPSB0aGlzLmFyY0xlbmd0aERpdmlzaW9ucykgewogICAgaWYgKHRoaXMuY2FjaGVBcmNMZW5ndGhzICYmIHRoaXMuY2FjaGVBcmNMZW5ndGhzLmxlbmd0aCA9PT0gdCArIDEgJiYgIXRoaXMubmVlZHNVcGRhdGUpCiAgICAgIHJldHVybiB0aGlzLmNhY2hlQXJjTGVuZ3RoczsKICAgIHRoaXMubmVlZHNVcGRhdGUgPSAhMTsKICAgIGNvbnN0IGUgPSBbXTsKICAgIGxldCBpLCBuID0gdGhpcy5nZXRQb2ludCgwKSwgcyA9IDA7CiAgICBlLnB1c2goMCk7CiAgICBmb3IgKGxldCByID0gMTsgciA8PSB0OyByKyspCiAgICAgIGkgPSB0aGlzLmdldFBvaW50KHIgLyB0KSwgcyArPSBpLmRpc3RhbmNlVG8obiksIGUucHVzaChzKSwgbiA9IGk7CiAgICByZXR1cm4gdGhpcy5jYWNoZUFyY0xlbmd0aHMgPSBlLCBlOwogIH0KICAvKioKICAgKiBVcGRhdGUgdGhlIGN1bXVsYXRpdmUgc2VnbWVudCBkaXN0YW5jZSBjYWNoZS4gVGhlIG1ldGhvZCBtdXN0IGJlIGNhbGxlZAogICAqIGV2ZXJ5IHRpbWUgY3VydmUgcGFyYW1ldGVycyBhcmUgY2hhbmdlZC4gSWYgYW4gdXBkYXRlZCBjdXJ2ZSBpcyBwYXJ0IG9mIGEKICAgKiBjb21wb3NlZCBjdXJ2ZSBsaWtlIHtAbGluayBDdXJ2ZVBhdGh9LCB0aGlzIG1ldGhvZCBtdXN0IGJlIGNhbGxlZCBvbiB0aGUKICAgKiBjb21wb3NlZCBjdXJ2ZSwgdG9vLgogICAqLwogIHVwZGF0ZUFyY0xlbmd0aHMoKSB7CiAgICB0aGlzLm5lZWRzVXBkYXRlID0gITAsIHRoaXMuZ2V0TGVuZ3RocygpOwogIH0KICAvKioKICAgKiBHaXZlbiBhbiBpbnRlcnBvbGF0aW9uIGZhY3RvciBpbiB0aGUgcmFuZ2UgYFswLDFdYCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiB1cGRhdGVkCiAgICogaW50ZXJwb2xhdGlvbiBmYWN0b3IgaW4gdGhlIHNhbWUgcmFuZ2UgdGhhdCBjYW4gYmUgdWVkIHRvIHNhbXBsZSBlcXVpZGlzdGFudCBwb2ludHMKICAgKiBmcm9tIGEgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3Rvci4KICAgKiBAcGFyYW0gez9udW1iZXJ9IGRpc3RhbmNlIC0gQW4gb3B0aW9uYWwgZGlzdGFuY2Ugb24gdGhlIGN1cnZlLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHVwZGF0ZWQgaW50ZXJwb2xhdGlvbiBmYWN0b3IuCiAgICovCiAgZ2V0VXRvVG1hcHBpbmcodCwgZSA9IG51bGwpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdldExlbmd0aHMoKTsKICAgIGxldCBuID0gMDsKICAgIGNvbnN0IHMgPSBpLmxlbmd0aDsKICAgIGxldCByOwogICAgZSA/IHIgPSBlIDogciA9IHQgKiBpW3MgLSAxXTsKICAgIGxldCBvID0gMCwgbCA9IHMgLSAxLCBoOwogICAgZm9yICg7IG8gPD0gbDsgKQogICAgICBpZiAobiA9IE1hdGguZmxvb3IobyArIChsIC0gbykgLyAyKSwgaCA9IGlbbl0gLSByLCBoIDwgMCkKICAgICAgICBvID0gbiArIDE7CiAgICAgIGVsc2UgaWYgKGggPiAwKQogICAgICAgIGwgPSBuIC0gMTsKICAgICAgZWxzZSB7CiAgICAgICAgbCA9IG47CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIGlmIChuID0gbCwgaVtuXSA9PT0gcikKICAgICAgcmV0dXJuIG4gLyAocyAtIDEpOwogICAgY29uc3QgYyA9IGlbbl0sIGQgPSBpW24gKyAxXSAtIGMsIHAgPSAociAtIGMpIC8gZDsKICAgIHJldHVybiAobiArIHApIC8gKHMgLSAxKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHVuaXQgdmVjdG9yIHRhbmdlbnQgZm9yIHRoZSBnaXZlbiBpbnRlcnBvbGF0aW9uIGZhY3Rvci4KICAgKiBJZiB0aGUgZGVyaXZlZCBjdXJ2ZSBkb2VzIG5vdCBpbXBsZW1lbnQgaXRzIHRhbmdlbnQgZGVyaXZhdGlvbiwKICAgKiB0d28gcG9pbnRzIGEgc21hbGwgZGVsdGEgYXBhcnQgd2lsbCBiZSB1c2VkIHRvIGZpbmQgaXRzIGdyYWRpZW50CiAgICogd2hpY2ggc2VlbXMgdG8gZ2l2ZSBhIHJlYXNvbmFibGUgYXBwcm94aW1hdGlvbi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yLgogICAqIEBwYXJhbSB7KFZlY3RvcjJ8VmVjdG9yMyl9IFtvcHRpb25hbFRhcmdldF0gLSBUaGUgb3B0aW9uYWwgdGFyZ2V0IHZlY3RvciB0aGUgcmVzdWx0IGlzIHdyaXR0ZW4gdG8uCiAgICogQHJldHVybiB7KFZlY3RvcjJ8VmVjdG9yMyl9IFRoZSB0YW5nZW50IHZlY3Rvci4KICAgKi8KICBnZXRUYW5nZW50KHQsIGUpIHsKICAgIGxldCBuID0gdCAtIDFlLTQsIHMgPSB0ICsgMWUtNDsKICAgIG4gPCAwICYmIChuID0gMCksIHMgPiAxICYmIChzID0gMSk7CiAgICBjb25zdCByID0gdGhpcy5nZXRQb2ludChuKSwgbyA9IHRoaXMuZ2V0UG9pbnQocyksIGwgPSBlIHx8IChyLmlzVmVjdG9yMiA/IG5ldyBKKCkgOiBuZXcgRSgpKTsKICAgIHJldHVybiBsLmNvcHkobykuc3ViKHIpLm5vcm1hbGl6ZSgpLCBsOwogIH0KICAvKioKICAgKiBTYW1lIGFzIHtAbGluayBDdXJ2ZSNnZXRUYW5nZW50fSBidXQgd2l0aCBlcXVpZGlzdGFudCBzYW1wbGVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHUgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IuCiAgICogQHBhcmFtIHsoVmVjdG9yMnxWZWN0b3IzKX0gW29wdGlvbmFsVGFyZ2V0XSAtIFRoZSBvcHRpb25hbCB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgd3JpdHRlbiB0by4KICAgKiBAcmV0dXJuIHsoVmVjdG9yMnxWZWN0b3IzKX0gVGhlIHRhbmdlbnQgdmVjdG9yLgogICAqIEBzZWUge0BsaW5rIEN1cnZlI2dldFBvaW50QXR9CiAgICovCiAgZ2V0VGFuZ2VudEF0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdldFV0b1RtYXBwaW5nKHQpOwogICAgcmV0dXJuIHRoaXMuZ2V0VGFuZ2VudChpLCBlKTsKICB9CiAgLyoqCiAgICogR2VuZXJhdGVzIHRoZSBGcmVuZXQgRnJhbWVzLiBSZXF1aXJlcyBhIGN1cnZlIGRlZmluaXRpb24gaW4gM0Qgc3BhY2UuIFVzZWQKICAgKiBpbiBnZW9tZXRyaWVzIGxpa2Uge0BsaW5rIFR1YmVHZW9tZXRyeX0gb3Ige0BsaW5rIEV4dHJ1ZGVHZW9tZXRyeX0uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2VnbWVudHMgLSBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2Nsb3NlZD1mYWxzZV0gLSBXaGV0aGVyIHRoZSBjdXJ2ZSBpcyBjbG9zZWQgb3Igbm90LgogICAqIEByZXR1cm4ge3t0YW5nZW50czogQXJyYXk8VmVjdG9yMz4sIG5vcm1hbHM6IEFycmF5PFZlY3RvcjM+LCBiaW5vcm1hbHM6IEFycmF5PFZlY3RvcjM+fX0gVGhlIEZyZW5ldCBGcmFtZXMuCiAgICovCiAgY29tcHV0ZUZyZW5ldEZyYW1lcyh0LCBlID0gITEpIHsKICAgIGNvbnN0IGkgPSBuZXcgRSgpLCBuID0gW10sIHMgPSBbXSwgciA9IFtdLCBvID0gbmV3IEUoKSwgbCA9IG5ldyBWdCgpOwogICAgZm9yIChsZXQgcCA9IDA7IHAgPD0gdDsgcCsrKSB7CiAgICAgIGNvbnN0IGYgPSBwIC8gdDsKICAgICAgbltwXSA9IHRoaXMuZ2V0VGFuZ2VudEF0KGYsIG5ldyBFKCkpOwogICAgfQogICAgc1swXSA9IG5ldyBFKCksIHJbMF0gPSBuZXcgRSgpOwogICAgbGV0IGggPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgY29uc3QgYyA9IE1hdGguYWJzKG5bMF0ueCksIHUgPSBNYXRoLmFicyhuWzBdLnkpLCBkID0gTWF0aC5hYnMoblswXS56KTsKICAgIGMgPD0gaCAmJiAoaCA9IGMsIGkuc2V0KDEsIDAsIDApKSwgdSA8PSBoICYmIChoID0gdSwgaS5zZXQoMCwgMSwgMCkpLCBkIDw9IGggJiYgaS5zZXQoMCwgMCwgMSksIG8uY3Jvc3NWZWN0b3JzKG5bMF0sIGkpLm5vcm1hbGl6ZSgpLCBzWzBdLmNyb3NzVmVjdG9ycyhuWzBdLCBvKSwgclswXS5jcm9zc1ZlY3RvcnMoblswXSwgc1swXSk7CiAgICBmb3IgKGxldCBwID0gMTsgcCA8PSB0OyBwKyspIHsKICAgICAgaWYgKHNbcF0gPSBzW3AgLSAxXS5jbG9uZSgpLCByW3BdID0gcltwIC0gMV0uY2xvbmUoKSwgby5jcm9zc1ZlY3RvcnMobltwIC0gMV0sIG5bcF0pLCBvLmxlbmd0aCgpID4gTnVtYmVyLkVQU0lMT04pIHsKICAgICAgICBvLm5vcm1hbGl6ZSgpOwogICAgICAgIGNvbnN0IGYgPSBNYXRoLmFjb3Moa3QobltwIC0gMV0uZG90KG5bcF0pLCAtMSwgMSkpOwogICAgICAgIHNbcF0uYXBwbHlNYXRyaXg0KGwubWFrZVJvdGF0aW9uQXhpcyhvLCBmKSk7CiAgICAgIH0KICAgICAgcltwXS5jcm9zc1ZlY3RvcnMobltwXSwgc1twXSk7CiAgICB9CiAgICBpZiAoZSA9PT0gITApIHsKICAgICAgbGV0IHAgPSBNYXRoLmFjb3Moa3Qoc1swXS5kb3Qoc1t0XSksIC0xLCAxKSk7CiAgICAgIHAgLz0gdCwgblswXS5kb3Qoby5jcm9zc1ZlY3RvcnMoc1swXSwgc1t0XSkpID4gMCAmJiAocCA9IC1wKTsKICAgICAgZm9yIChsZXQgZiA9IDE7IGYgPD0gdDsgZisrKQogICAgICAgIHNbZl0uYXBwbHlNYXRyaXg0KGwubWFrZVJvdGF0aW9uQXhpcyhuW2ZdLCBwICogZikpLCByW2ZdLmNyb3NzVmVjdG9ycyhuW2ZdLCBzW2ZdKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHRhbmdlbnRzOiBuLAogICAgICBub3JtYWxzOiBzLAogICAgICBiaW5vcm1hbHM6IHIKICAgIH07CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgY3VydmUgd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge0N1cnZlfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KHRoaXMpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gY3VydmUgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7Q3VydmV9IHNvdXJjZSAtIFRoZSBjdXJ2ZSB0byBjb3B5LgogICAqIEByZXR1cm4ge0N1cnZlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGN1cnZlLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuYXJjTGVuZ3RoRGl2aXNpb25zID0gdC5hcmNMZW5ndGhEaXZpc2lvbnMsIHRoaXM7CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIGN1cnZlIGludG8gSlNPTi4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgY3VydmUuCiAgICogQHNlZSB7QGxpbmsgT2JqZWN0TG9hZGVyI3BhcnNlfQogICAqLwogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSB7CiAgICAgIG1ldGFkYXRhOiB7CiAgICAgICAgdmVyc2lvbjogNC43LAogICAgICAgIHR5cGU6ICJDdXJ2ZSIsCiAgICAgICAgZ2VuZXJhdG9yOiAiQ3VydmUudG9KU09OIgogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHQuYXJjTGVuZ3RoRGl2aXNpb25zID0gdGhpcy5hcmNMZW5ndGhEaXZpc2lvbnMsIHQudHlwZSA9IHRoaXMudHlwZSwgdDsKICB9CiAgLyoqCiAgICogRGVzZXJpYWxpemVzIHRoZSBjdXJ2ZSBmcm9tIHRoZSBnaXZlbiBKU09OLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgSlNPTiBob2xkaW5nIHRoZSBzZXJpYWxpemVkIGN1cnZlLgogICAqIEByZXR1cm4ge0N1cnZlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGN1cnZlLgogICAqLwogIGZyb21KU09OKHQpIHsKICAgIHJldHVybiB0aGlzLmFyY0xlbmd0aERpdmlzaW9ucyA9IHQuYXJjTGVuZ3RoRGl2aXNpb25zLCB0aGlzOwogIH0KfQpjbGFzcyBLYyBleHRlbmRzIG1uIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGVsbGlwc2UgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW2FYPTBdIC0gVGhlIFggY2VudGVyIG9mIHRoZSBlbGxpcHNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVk9MF0gLSBUaGUgWSBjZW50ZXIgb2YgdGhlIGVsbGlwc2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt4UmFkaXVzPTFdIC0gVGhlIHJhZGl1cyBvZiB0aGUgZWxsaXBzZSBpbiB0aGUgeCBkaXJlY3Rpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFt5UmFkaXVzPTFdIC0gVGhlIHJhZGl1cyBvZiB0aGUgZWxsaXBzZSBpbiB0aGUgeSBkaXJlY3Rpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFthU3RhcnRBbmdsZT0wXSAtIFRoZSBzdGFydCBhbmdsZSBvZiB0aGUgY3VydmUgaW4gcmFkaWFucyBzdGFydGluZyBmcm9tIHRoZSBwb3NpdGl2ZSBYIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthRW5kQW5nbGU9TWF0aC5QSSoyXSAtIFRoZSBlbmQgYW5nbGUgb2YgdGhlIGN1cnZlIGluIHJhZGlhbnMgc3RhcnRpbmcgZnJvbSB0aGUgcG9zaXRpdmUgWCBheGlzLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FDbG9ja3dpc2U9ZmFsc2VdIC0gV2hldGhlciB0aGUgZWxsaXBzZSBpcyBkcmF3biBjbG9ja3dpc2Ugb3Igbm90LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVJvdGF0aW9uPTBdIC0gVGhlIHJvdGF0aW9uIGFuZ2xlIG9mIHRoZSBlbGxpcHNlIGluIHJhZGlhbnMsIGNvdW50ZXJjbG9ja3dpc2UgZnJvbSB0aGUgcG9zaXRpdmUgWCBheGlzLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAwLCBlID0gMCwgaSA9IDEsIG4gPSAxLCBzID0gMCwgciA9IE1hdGguUEkgKiAyLCBvID0gITEsIGwgPSAwKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzRWxsaXBzZUN1cnZlID0gITAsIHRoaXMudHlwZSA9ICJFbGxpcHNlQ3VydmUiLCB0aGlzLmFYID0gdCwgdGhpcy5hWSA9IGUsIHRoaXMueFJhZGl1cyA9IGksIHRoaXMueVJhZGl1cyA9IG4sIHRoaXMuYVN0YXJ0QW5nbGUgPSBzLCB0aGlzLmFFbmRBbmdsZSA9IHIsIHRoaXMuYUNsb2Nrd2lzZSA9IG8sIHRoaXMuYVJvdGF0aW9uID0gbDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IG9uIHRoZSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIE11c3QgYmUgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbb3B0aW9uYWxUYXJnZXRdIC0gVGhlIG9wdGlvbmFsIHRhcmdldCB2ZWN0b3IgdGhlIHJlc3VsdCBpcyB3cml0dGVuIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IFRoZSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuCiAgICovCiAgZ2V0UG9pbnQodCwgZSA9IG5ldyBKKCkpIHsKICAgIGNvbnN0IGkgPSBlLCBuID0gTWF0aC5QSSAqIDI7CiAgICBsZXQgcyA9IHRoaXMuYUVuZEFuZ2xlIC0gdGhpcy5hU3RhcnRBbmdsZTsKICAgIGNvbnN0IHIgPSBNYXRoLmFicyhzKSA8IE51bWJlci5FUFNJTE9OOwogICAgZm9yICg7IHMgPCAwOyApIHMgKz0gbjsKICAgIGZvciAoOyBzID4gbjsgKSBzIC09IG47CiAgICBzIDwgTnVtYmVyLkVQU0lMT04gJiYgKHIgPyBzID0gMCA6IHMgPSBuKSwgdGhpcy5hQ2xvY2t3aXNlID09PSAhMCAmJiAhciAmJiAocyA9PT0gbiA/IHMgPSAtbiA6IHMgPSBzIC0gbik7CiAgICBjb25zdCBvID0gdGhpcy5hU3RhcnRBbmdsZSArIHQgKiBzOwogICAgbGV0IGwgPSB0aGlzLmFYICsgdGhpcy54UmFkaXVzICogTWF0aC5jb3MobyksIGggPSB0aGlzLmFZICsgdGhpcy55UmFkaXVzICogTWF0aC5zaW4obyk7CiAgICBpZiAodGhpcy5hUm90YXRpb24gIT09IDApIHsKICAgICAgY29uc3QgYyA9IE1hdGguY29zKHRoaXMuYVJvdGF0aW9uKSwgdSA9IE1hdGguc2luKHRoaXMuYVJvdGF0aW9uKSwgZCA9IGwgLSB0aGlzLmFYLCBwID0gaCAtIHRoaXMuYVk7CiAgICAgIGwgPSBkICogYyAtIHAgKiB1ICsgdGhpcy5hWCwgaCA9IGQgKiB1ICsgcCAqIGMgKyB0aGlzLmFZOwogICAgfQogICAgcmV0dXJuIGkuc2V0KGwsIGgpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmFYID0gdC5hWCwgdGhpcy5hWSA9IHQuYVksIHRoaXMueFJhZGl1cyA9IHQueFJhZGl1cywgdGhpcy55UmFkaXVzID0gdC55UmFkaXVzLCB0aGlzLmFTdGFydEFuZ2xlID0gdC5hU3RhcnRBbmdsZSwgdGhpcy5hRW5kQW5nbGUgPSB0LmFFbmRBbmdsZSwgdGhpcy5hQ2xvY2t3aXNlID0gdC5hQ2xvY2t3aXNlLCB0aGlzLmFSb3RhdGlvbiA9IHQuYVJvdGF0aW9uLCB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0gc3VwZXIudG9KU09OKCk7CiAgICByZXR1cm4gdC5hWCA9IHRoaXMuYVgsIHQuYVkgPSB0aGlzLmFZLCB0LnhSYWRpdXMgPSB0aGlzLnhSYWRpdXMsIHQueVJhZGl1cyA9IHRoaXMueVJhZGl1cywgdC5hU3RhcnRBbmdsZSA9IHRoaXMuYVN0YXJ0QW5nbGUsIHQuYUVuZEFuZ2xlID0gdGhpcy5hRW5kQW5nbGUsIHQuYUNsb2Nrd2lzZSA9IHRoaXMuYUNsb2Nrd2lzZSwgdC5hUm90YXRpb24gPSB0aGlzLmFSb3RhdGlvbiwgdDsKICB9CiAgZnJvbUpTT04odCkgewogICAgcmV0dXJuIHN1cGVyLmZyb21KU09OKHQpLCB0aGlzLmFYID0gdC5hWCwgdGhpcy5hWSA9IHQuYVksIHRoaXMueFJhZGl1cyA9IHQueFJhZGl1cywgdGhpcy55UmFkaXVzID0gdC55UmFkaXVzLCB0aGlzLmFTdGFydEFuZ2xlID0gdC5hU3RhcnRBbmdsZSwgdGhpcy5hRW5kQW5nbGUgPSB0LmFFbmRBbmdsZSwgdGhpcy5hQ2xvY2t3aXNlID0gdC5hQ2xvY2t3aXNlLCB0aGlzLmFSb3RhdGlvbiA9IHQuYVJvdGF0aW9uLCB0aGlzOwogIH0KfQpjbGFzcyB6eSBleHRlbmRzIEtjIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGFyYyBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVg9MF0gLSBUaGUgWCBjZW50ZXIgb2YgdGhlIGVsbGlwc2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthWT0wXSAtIFRoZSBZIGNlbnRlciBvZiB0aGUgZWxsaXBzZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FSYWRpdXM9MV0gLSBUaGUgcmFkaXVzIG9mIHRoZSBlbGxpcHNlIGluIHRoZSB4IGRpcmVjdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FTdGFydEFuZ2xlPTBdIC0gVGhlIHN0YXJ0IGFuZ2xlIG9mIHRoZSBjdXJ2ZSBpbiByYWRpYW5zIHN0YXJ0aW5nIGZyb20gdGhlIHBvc2l0aXZlIFggYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FFbmRBbmdsZT1NYXRoLlBJKjJdIC0gVGhlIGVuZCBhbmdsZSBvZiB0aGUgY3VydmUgaW4gcmFkaWFucyBzdGFydGluZyBmcm9tIHRoZSBwb3NpdGl2ZSBYIGF4aXMuCiAgICogQHBhcmFtIHtib29sZWFufSBbYUNsb2Nrd2lzZT1mYWxzZV0gLSBXaGV0aGVyIHRoZSBlbGxpcHNlIGlzIGRyYXduIGNsb2Nrd2lzZSBvciBub3QuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgcikgewogICAgc3VwZXIodCwgZSwgaSwgaSwgbiwgcywgciksIHRoaXMuaXNBcmNDdXJ2ZSA9ICEwLCB0aGlzLnR5cGUgPSAiQXJjQ3VydmUiOwogIH0KfQpmdW5jdGlvbiBHcCgpIHsKICBsZXQgYSA9IDAsIHQgPSAwLCBlID0gMCwgaSA9IDA7CiAgZnVuY3Rpb24gbihzLCByLCBvLCBsKSB7CiAgICBhID0gcywgdCA9IG8sIGUgPSAtMyAqIHMgKyAzICogciAtIDIgKiBvIC0gbCwgaSA9IDIgKiBzIC0gMiAqIHIgKyBvICsgbDsKICB9CiAgcmV0dXJuIHsKICAgIGluaXRDYXRtdWxsUm9tOiBmdW5jdGlvbihzLCByLCBvLCBsLCBoKSB7CiAgICAgIG4ociwgbywgaCAqIChvIC0gcyksIGggKiAobCAtIHIpKTsKICAgIH0sCiAgICBpbml0Tm9udW5pZm9ybUNhdG11bGxSb206IGZ1bmN0aW9uKHMsIHIsIG8sIGwsIGgsIGMsIHUpIHsKICAgICAgbGV0IGQgPSAociAtIHMpIC8gaCAtIChvIC0gcykgLyAoaCArIGMpICsgKG8gLSByKSAvIGMsIHAgPSAobyAtIHIpIC8gYyAtIChsIC0gcikgLyAoYyArIHUpICsgKGwgLSBvKSAvIHU7CiAgICAgIGQgKj0gYywgcCAqPSBjLCBuKHIsIG8sIGQsIHApOwogICAgfSwKICAgIGNhbGM6IGZ1bmN0aW9uKHMpIHsKICAgICAgY29uc3QgciA9IHMgKiBzLCBvID0gciAqIHM7CiAgICAgIHJldHVybiBhICsgdCAqIHMgKyBlICogciArIGkgKiBvOwogICAgfQogIH07Cn0KY29uc3QgVGwgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgcXUgPSAvKiBAX19QVVJFX18gKi8gbmV3IEdwKCksICR1ID0gLyogQF9fUFVSRV9fICovIG5ldyBHcCgpLCBYdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgR3AoKTsKY2xhc3MgTnkgZXh0ZW5kcyBtbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBDYXRtdWxsLVJvbSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMz59IFtwb2ludHNdIC0gQW4gYXJyYXkgb2YgM0QgcG9pbnRzIGRlZmluaW5nIHRoZSBjdXJ2ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjbG9zZWQ9ZmFsc2VdIC0gV2hldGhlciB0aGUgY3VydmUgaXMgY2xvc2VkIG9yIG5vdC4KICAgKiBAcGFyYW0geygnY2VudHJpcGV0YWwnfCdjaG9yZGFsJ3wnY2F0bXVsbHJvbScpfSBbY3VydmVUeXBlPSdjZW50cmlwZXRhbCddIC0gVGhlIGN1cnZlIHR5cGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0ZW5zaW9uPTAuNV0gLSBUZW5zaW9uIG9mIHRoZSBjdXJ2ZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gW10sIGUgPSAhMSwgaSA9ICJjZW50cmlwZXRhbCIsIG4gPSAwLjUpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNDYXRtdWxsUm9tQ3VydmUzID0gITAsIHRoaXMudHlwZSA9ICJDYXRtdWxsUm9tQ3VydmUzIiwgdGhpcy5wb2ludHMgPSB0LCB0aGlzLmNsb3NlZCA9IGUsIHRoaXMuY3VydmVUeXBlID0gaSwgdGhpcy50ZW5zaW9uID0gbjsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IG9uIHRoZSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIE11c3QgYmUgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbb3B0aW9uYWxUYXJnZXRdIC0gVGhlIG9wdGlvbmFsIHRhcmdldCB2ZWN0b3IgdGhlIHJlc3VsdCBpcyB3cml0dGVuIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuCiAgICovCiAgZ2V0UG9pbnQodCwgZSA9IG5ldyBFKCkpIHsKICAgIGNvbnN0IGkgPSBlLCBuID0gdGhpcy5wb2ludHMsIHMgPSBuLmxlbmd0aCwgciA9IChzIC0gKHRoaXMuY2xvc2VkID8gMCA6IDEpKSAqIHQ7CiAgICBsZXQgbyA9IE1hdGguZmxvb3IociksIGwgPSByIC0gbzsKICAgIHRoaXMuY2xvc2VkID8gbyArPSBvID4gMCA/IDAgOiAoTWF0aC5mbG9vcihNYXRoLmFicyhvKSAvIHMpICsgMSkgKiBzIDogbCA9PT0gMCAmJiBvID09PSBzIC0gMSAmJiAobyA9IHMgLSAyLCBsID0gMSk7CiAgICBsZXQgaCwgYzsKICAgIHRoaXMuY2xvc2VkIHx8IG8gPiAwID8gaCA9IG5bKG8gLSAxKSAlIHNdIDogKFRsLnN1YlZlY3RvcnMoblswXSwgblsxXSkuYWRkKG5bMF0pLCBoID0gVGwpOwogICAgY29uc3QgdSA9IG5bbyAlIHNdLCBkID0gblsobyArIDEpICUgc107CiAgICBpZiAodGhpcy5jbG9zZWQgfHwgbyArIDIgPCBzID8gYyA9IG5bKG8gKyAyKSAlIHNdIDogKFRsLnN1YlZlY3RvcnMobltzIC0gMV0sIG5bcyAtIDJdKS5hZGQobltzIC0gMV0pLCBjID0gVGwpLCB0aGlzLmN1cnZlVHlwZSA9PT0gImNlbnRyaXBldGFsIiB8fCB0aGlzLmN1cnZlVHlwZSA9PT0gImNob3JkYWwiKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLmN1cnZlVHlwZSA9PT0gImNob3JkYWwiID8gMC41IDogMC4yNTsKICAgICAgbGV0IGYgPSBNYXRoLnBvdyhoLmRpc3RhbmNlVG9TcXVhcmVkKHUpLCBwKSwgeSA9IE1hdGgucG93KHUuZGlzdGFuY2VUb1NxdWFyZWQoZCksIHApLCBnID0gTWF0aC5wb3coZC5kaXN0YW5jZVRvU3F1YXJlZChjKSwgcCk7CiAgICAgIHkgPCAxZS00ICYmICh5ID0gMSksIGYgPCAxZS00ICYmIChmID0geSksIGcgPCAxZS00ICYmIChnID0geSksIHF1LmluaXROb251bmlmb3JtQ2F0bXVsbFJvbShoLngsIHUueCwgZC54LCBjLngsIGYsIHksIGcpLCAkdS5pbml0Tm9udW5pZm9ybUNhdG11bGxSb20oaC55LCB1LnksIGQueSwgYy55LCBmLCB5LCBnKSwgWHUuaW5pdE5vbnVuaWZvcm1DYXRtdWxsUm9tKGgueiwgdS56LCBkLnosIGMueiwgZiwgeSwgZyk7CiAgICB9IGVsc2UgdGhpcy5jdXJ2ZVR5cGUgPT09ICJjYXRtdWxscm9tIiAmJiAocXUuaW5pdENhdG11bGxSb20oaC54LCB1LngsIGQueCwgYy54LCB0aGlzLnRlbnNpb24pLCAkdS5pbml0Q2F0bXVsbFJvbShoLnksIHUueSwgZC55LCBjLnksIHRoaXMudGVuc2lvbiksIFh1LmluaXRDYXRtdWxsUm9tKGgueiwgdS56LCBkLnosIGMueiwgdGhpcy50ZW5zaW9uKSk7CiAgICByZXR1cm4gaS5zZXQoCiAgICAgIHF1LmNhbGMobCksCiAgICAgICR1LmNhbGMobCksCiAgICAgIFh1LmNhbGMobCkKICAgICksIGk7CiAgfQogIGNvcHkodCkgewogICAgc3VwZXIuY29weSh0KSwgdGhpcy5wb2ludHMgPSBbXTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5wb2ludHMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0LnBvaW50c1tlXTsKICAgICAgdGhpcy5wb2ludHMucHVzaChuLmNsb25lKCkpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY2xvc2VkID0gdC5jbG9zZWQsIHRoaXMuY3VydmVUeXBlID0gdC5jdXJ2ZVR5cGUsIHRoaXMudGVuc2lvbiA9IHQudGVuc2lvbiwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgdC5wb2ludHMgPSBbXTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5wb2ludHMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLnBvaW50c1tlXTsKICAgICAgdC5wb2ludHMucHVzaChuLnRvQXJyYXkoKSk7CiAgICB9CiAgICByZXR1cm4gdC5jbG9zZWQgPSB0aGlzLmNsb3NlZCwgdC5jdXJ2ZVR5cGUgPSB0aGlzLmN1cnZlVHlwZSwgdC50ZW5zaW9uID0gdGhpcy50ZW5zaW9uLCB0OwogIH0KICBmcm9tSlNPTih0KSB7CiAgICBzdXBlci5mcm9tSlNPTih0KSwgdGhpcy5wb2ludHMgPSBbXTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5wb2ludHMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0LnBvaW50c1tlXTsKICAgICAgdGhpcy5wb2ludHMucHVzaChuZXcgRSgpLmZyb21BcnJheShuKSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jbG9zZWQgPSB0LmNsb3NlZCwgdGhpcy5jdXJ2ZVR5cGUgPSB0LmN1cnZlVHlwZSwgdGhpcy50ZW5zaW9uID0gdC50ZW5zaW9uLCB0aGlzOwogIH0KfQpmdW5jdGlvbiBwbShhLCB0LCBlLCBpLCBuKSB7CiAgY29uc3QgcyA9IChpIC0gdCkgKiAwLjUsIHIgPSAobiAtIGUpICogMC41LCBvID0gYSAqIGEsIGwgPSBhICogbzsKICByZXR1cm4gKDIgKiBlIC0gMiAqIGkgKyBzICsgcikgKiBsICsgKC0zICogZSArIDMgKiBpIC0gMiAqIHMgLSByKSAqIG8gKyBzICogYSArIGU7Cn0KZnVuY3Rpb24gcmIoYSwgdCkgewogIGNvbnN0IGUgPSAxIC0gYTsKICByZXR1cm4gZSAqIGUgKiB0Owp9CmZ1bmN0aW9uIGFiKGEsIHQpIHsKICByZXR1cm4gMiAqICgxIC0gYSkgKiBhICogdDsKfQpmdW5jdGlvbiBvYihhLCB0KSB7CiAgcmV0dXJuIGEgKiBhICogdDsKfQpmdW5jdGlvbiBtbyhhLCB0LCBlLCBpKSB7CiAgcmV0dXJuIHJiKGEsIHQpICsgYWIoYSwgZSkgKyBvYihhLCBpKTsKfQpmdW5jdGlvbiBsYihhLCB0KSB7CiAgY29uc3QgZSA9IDEgLSBhOwogIHJldHVybiBlICogZSAqIGUgKiB0Owp9CmZ1bmN0aW9uIGhiKGEsIHQpIHsKICBjb25zdCBlID0gMSAtIGE7CiAgcmV0dXJuIDMgKiBlICogZSAqIGEgKiB0Owp9CmZ1bmN0aW9uIGNiKGEsIHQpIHsKICByZXR1cm4gMyAqICgxIC0gYSkgKiBhICogYSAqIHQ7Cn0KZnVuY3Rpb24gdWIoYSwgdCkgewogIHJldHVybiBhICogYSAqIGEgKiB0Owp9CmZ1bmN0aW9uIGdvKGEsIHQsIGUsIGksIG4pIHsKICByZXR1cm4gbGIoYSwgdCkgKyBoYihhLCBlKSArIGNiKGEsIGkpICsgdWIoYSwgbik7Cn0KY2xhc3MgV3AgZXh0ZW5kcyBtbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBDdWJpYyBCZXppZXIgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IFt2MF0gLSBUaGUgc3RhcnQgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbdjFdIC0gVGhlIGZpcnN0IGNvbnRyb2wgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbdjJdIC0gVGhlIHNlY29uZCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7VmVjdG9yMn0gW3YzXSAtIFRoZSBlbmQgcG9pbnQuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBKKCksIGUgPSBuZXcgSigpLCBpID0gbmV3IEooKSwgbiA9IG5ldyBKKCkpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNDdWJpY0JlemllckN1cnZlID0gITAsIHRoaXMudHlwZSA9ICJDdWJpY0JlemllckN1cnZlIiwgdGhpcy52MCA9IHQsIHRoaXMudjEgPSBlLCB0aGlzLnYyID0gaSwgdGhpcy52MyA9IG47CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBwb2ludCBvbiB0aGUgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIEEgaW50ZXJwb2xhdGlvbiBmYWN0b3IgcmVwcmVzZW50aW5nIGEgcG9zaXRpb24gb24gdGhlIGN1cnZlLiBNdXN0IGJlIGluIHRoZSByYW5nZSBgWzAsMV1gLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gW29wdGlvbmFsVGFyZ2V0XSAtIFRoZSBvcHRpb25hbCB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgd3JpdHRlbiB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBUaGUgcG9zaXRpb24gb24gdGhlIGN1cnZlLgogICAqLwogIGdldFBvaW50KHQsIGUgPSBuZXcgSigpKSB7CiAgICBjb25zdCBpID0gZSwgbiA9IHRoaXMudjAsIHMgPSB0aGlzLnYxLCByID0gdGhpcy52MiwgbyA9IHRoaXMudjM7CiAgICByZXR1cm4gaS5zZXQoCiAgICAgIGdvKHQsIG4ueCwgcy54LCByLngsIG8ueCksCiAgICAgIGdvKHQsIG4ueSwgcy55LCByLnksIG8ueSkKICAgICksIGk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMudjAuY29weSh0LnYwKSwgdGhpcy52MS5jb3B5KHQudjEpLCB0aGlzLnYyLmNvcHkodC52MiksIHRoaXMudjMuY29weSh0LnYzKSwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgcmV0dXJuIHQudjAgPSB0aGlzLnYwLnRvQXJyYXkoKSwgdC52MSA9IHRoaXMudjEudG9BcnJheSgpLCB0LnYyID0gdGhpcy52Mi50b0FycmF5KCksIHQudjMgPSB0aGlzLnYzLnRvQXJyYXkoKSwgdDsKICB9CiAgZnJvbUpTT04odCkgewogICAgcmV0dXJuIHN1cGVyLmZyb21KU09OKHQpLCB0aGlzLnYwLmZyb21BcnJheSh0LnYwKSwgdGhpcy52MS5mcm9tQXJyYXkodC52MSksIHRoaXMudjIuZnJvbUFycmF5KHQudjIpLCB0aGlzLnYzLmZyb21BcnJheSh0LnYzKSwgdGhpczsKICB9Cn0KY2xhc3MgT3kgZXh0ZW5kcyBtbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBDdWJpYyBCZXppZXIgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFt2MF0gLSBUaGUgc3RhcnQgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbdjFdIC0gVGhlIGZpcnN0IGNvbnRyb2wgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbdjJdIC0gVGhlIHNlY29uZCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gW3YzXSAtIFRoZSBlbmQgcG9pbnQuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBFKCksIGUgPSBuZXcgRSgpLCBpID0gbmV3IEUoKSwgbiA9IG5ldyBFKCkpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNDdWJpY0JlemllckN1cnZlMyA9ICEwLCB0aGlzLnR5cGUgPSAiQ3ViaWNCZXppZXJDdXJ2ZTMiLCB0aGlzLnYwID0gdCwgdGhpcy52MSA9IGUsIHRoaXMudjIgPSBpLCB0aGlzLnYzID0gbjsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IG9uIHRoZSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIE11c3QgYmUgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbb3B0aW9uYWxUYXJnZXRdIC0gVGhlIG9wdGlvbmFsIHRhcmdldCB2ZWN0b3IgdGhlIHJlc3VsdCBpcyB3cml0dGVuIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuCiAgICovCiAgZ2V0UG9pbnQodCwgZSA9IG5ldyBFKCkpIHsKICAgIGNvbnN0IGkgPSBlLCBuID0gdGhpcy52MCwgcyA9IHRoaXMudjEsIHIgPSB0aGlzLnYyLCBvID0gdGhpcy52MzsKICAgIHJldHVybiBpLnNldCgKICAgICAgZ28odCwgbi54LCBzLngsIHIueCwgby54KSwKICAgICAgZ28odCwgbi55LCBzLnksIHIueSwgby55KSwKICAgICAgZ28odCwgbi56LCBzLnosIHIueiwgby56KQogICAgKSwgaTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy52MC5jb3B5KHQudjApLCB0aGlzLnYxLmNvcHkodC52MSksIHRoaXMudjIuY29weSh0LnYyKSwgdGhpcy52My5jb3B5KHQudjMpLCB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0gc3VwZXIudG9KU09OKCk7CiAgICByZXR1cm4gdC52MCA9IHRoaXMudjAudG9BcnJheSgpLCB0LnYxID0gdGhpcy52MS50b0FycmF5KCksIHQudjIgPSB0aGlzLnYyLnRvQXJyYXkoKSwgdC52MyA9IHRoaXMudjMudG9BcnJheSgpLCB0OwogIH0KICBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gc3VwZXIuZnJvbUpTT04odCksIHRoaXMudjAuZnJvbUFycmF5KHQudjApLCB0aGlzLnYxLmZyb21BcnJheSh0LnYxKSwgdGhpcy52Mi5mcm9tQXJyYXkodC52MiksIHRoaXMudjMuZnJvbUFycmF5KHQudjMpLCB0aGlzOwogIH0KfQpjbGFzcyBxcCBleHRlbmRzIG1uIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxpbmUgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IFt2MV0gLSBUaGUgc3RhcnQgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbdjJdIC0gVGhlIGVuZCBwb2ludC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbmV3IEooKSwgZSA9IG5ldyBKKCkpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNMaW5lQ3VydmUgPSAhMCwgdGhpcy50eXBlID0gIkxpbmVDdXJ2ZSIsIHRoaXMudjEgPSB0LCB0aGlzLnYyID0gZTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IG9uIHRoZSBsaW5lLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBBIGludGVycG9sYXRpb24gZmFjdG9yIHJlcHJlc2VudGluZyBhIHBvc2l0aW9uIG9uIHRoZSBsaW5lLiBNdXN0IGJlIGluIHRoZSByYW5nZSBgWzAsMV1gLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gW29wdGlvbmFsVGFyZ2V0XSAtIFRoZSBvcHRpb25hbCB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgd3JpdHRlbiB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBUaGUgcG9zaXRpb24gb24gdGhlIGxpbmUuCiAgICovCiAgZ2V0UG9pbnQodCwgZSA9IG5ldyBKKCkpIHsKICAgIGNvbnN0IGkgPSBlOwogICAgcmV0dXJuIHQgPT09IDEgPyBpLmNvcHkodGhpcy52MikgOiAoaS5jb3B5KHRoaXMudjIpLnN1Yih0aGlzLnYxKSwgaS5tdWx0aXBseVNjYWxhcih0KS5hZGQodGhpcy52MSkpLCBpOwogIH0KICAvLyBMaW5lIGN1cnZlIGlzIGxpbmVhciwgc28gd2UgY2FuIG92ZXJ3cml0ZSBkZWZhdWx0IGdldFBvaW50QXQKICBnZXRQb2ludEF0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmdldFBvaW50KHQsIGUpOwogIH0KICBnZXRUYW5nZW50KHQsIGUgPSBuZXcgSigpKSB7CiAgICByZXR1cm4gZS5zdWJWZWN0b3JzKHRoaXMudjIsIHRoaXMudjEpLm5vcm1hbGl6ZSgpOwogIH0KICBnZXRUYW5nZW50QXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMuZ2V0VGFuZ2VudCh0LCBlKTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy52MS5jb3B5KHQudjEpLCB0aGlzLnYyLmNvcHkodC52MiksIHRoaXM7CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSBzdXBlci50b0pTT04oKTsKICAgIHJldHVybiB0LnYxID0gdGhpcy52MS50b0FycmF5KCksIHQudjIgPSB0aGlzLnYyLnRvQXJyYXkoKSwgdDsKICB9CiAgZnJvbUpTT04odCkgewogICAgcmV0dXJuIHN1cGVyLmZyb21KU09OKHQpLCB0aGlzLnYxLmZyb21BcnJheSh0LnYxKSwgdGhpcy52Mi5mcm9tQXJyYXkodC52MiksIHRoaXM7CiAgfQp9CmNsYXNzIGt5IGV4dGVuZHMgbW4gewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbGluZSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gW3YxXSAtIFRoZSBzdGFydCBwb2ludC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFt2Ml0gLSBUaGUgZW5kIHBvaW50LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgRSgpLCBlID0gbmV3IEUoKSkgewogICAgc3VwZXIoKSwgdGhpcy5pc0xpbmVDdXJ2ZTMgPSAhMCwgdGhpcy50eXBlID0gIkxpbmVDdXJ2ZTMiLCB0aGlzLnYxID0gdCwgdGhpcy52MiA9IGU7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBwb2ludCBvbiB0aGUgbGluZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgbGluZS4gTXVzdCBiZSBpbiB0aGUgcmFuZ2UgYFswLDFdYC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFtvcHRpb25hbFRhcmdldF0gLSBUaGUgb3B0aW9uYWwgdGFyZ2V0IHZlY3RvciB0aGUgcmVzdWx0IGlzIHdyaXR0ZW4gdG8uCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIHBvc2l0aW9uIG9uIHRoZSBsaW5lLgogICAqLwogIGdldFBvaW50KHQsIGUgPSBuZXcgRSgpKSB7CiAgICBjb25zdCBpID0gZTsKICAgIHJldHVybiB0ID09PSAxID8gaS5jb3B5KHRoaXMudjIpIDogKGkuY29weSh0aGlzLnYyKS5zdWIodGhpcy52MSksIGkubXVsdGlwbHlTY2FsYXIodCkuYWRkKHRoaXMudjEpKSwgaTsKICB9CiAgLy8gTGluZSBjdXJ2ZSBpcyBsaW5lYXIsIHNvIHdlIGNhbiBvdmVyd3JpdGUgZGVmYXVsdCBnZXRQb2ludEF0CiAgZ2V0UG9pbnRBdCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5nZXRQb2ludCh0LCBlKTsKICB9CiAgZ2V0VGFuZ2VudCh0LCBlID0gbmV3IEUoKSkgewogICAgcmV0dXJuIGUuc3ViVmVjdG9ycyh0aGlzLnYyLCB0aGlzLnYxKS5ub3JtYWxpemUoKTsKICB9CiAgZ2V0VGFuZ2VudEF0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmdldFRhbmdlbnQodCwgZSk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMudjEuY29weSh0LnYxKSwgdGhpcy52Mi5jb3B5KHQudjIpLCB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0gc3VwZXIudG9KU09OKCk7CiAgICByZXR1cm4gdC52MSA9IHRoaXMudjEudG9BcnJheSgpLCB0LnYyID0gdGhpcy52Mi50b0FycmF5KCksIHQ7CiAgfQogIGZyb21KU09OKHQpIHsKICAgIHJldHVybiBzdXBlci5mcm9tSlNPTih0KSwgdGhpcy52MS5mcm9tQXJyYXkodC52MSksIHRoaXMudjIuZnJvbUFycmF5KHQudjIpLCB0aGlzOwogIH0KfQpjbGFzcyAkcCBleHRlbmRzIG1uIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IFF1YWRyYXRpYyBCZXppZXIgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IFt2MF0gLSBUaGUgc3RhcnQgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbdjFdIC0gVGhlIGNvbnRyb2wgcG9pbnQuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbdjJdIC0gVGhlIGVuZCBwb2ludC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbmV3IEooKSwgZSA9IG5ldyBKKCksIGkgPSBuZXcgSigpKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzUXVhZHJhdGljQmV6aWVyQ3VydmUgPSAhMCwgdGhpcy50eXBlID0gIlF1YWRyYXRpY0JlemllckN1cnZlIiwgdGhpcy52MCA9IHQsIHRoaXMudjEgPSBlLCB0aGlzLnYyID0gaTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IG9uIHRoZSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIE11c3QgYmUgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbb3B0aW9uYWxUYXJnZXRdIC0gVGhlIG9wdGlvbmFsIHRhcmdldCB2ZWN0b3IgdGhlIHJlc3VsdCBpcyB3cml0dGVuIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IFRoZSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuCiAgICovCiAgZ2V0UG9pbnQodCwgZSA9IG5ldyBKKCkpIHsKICAgIGNvbnN0IGkgPSBlLCBuID0gdGhpcy52MCwgcyA9IHRoaXMudjEsIHIgPSB0aGlzLnYyOwogICAgcmV0dXJuIGkuc2V0KAogICAgICBtbyh0LCBuLngsIHMueCwgci54KSwKICAgICAgbW8odCwgbi55LCBzLnksIHIueSkKICAgICksIGk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMudjAuY29weSh0LnYwKSwgdGhpcy52MS5jb3B5KHQudjEpLCB0aGlzLnYyLmNvcHkodC52MiksIHRoaXM7CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSBzdXBlci50b0pTT04oKTsKICAgIHJldHVybiB0LnYwID0gdGhpcy52MC50b0FycmF5KCksIHQudjEgPSB0aGlzLnYxLnRvQXJyYXkoKSwgdC52MiA9IHRoaXMudjIudG9BcnJheSgpLCB0OwogIH0KICBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gc3VwZXIuZnJvbUpTT04odCksIHRoaXMudjAuZnJvbUFycmF5KHQudjApLCB0aGlzLnYxLmZyb21BcnJheSh0LnYxKSwgdGhpcy52Mi5mcm9tQXJyYXkodC52MiksIHRoaXM7CiAgfQp9CmNsYXNzIFhwIGV4dGVuZHMgbW4gewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgUXVhZHJhdGljIEJlemllciBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gW3YwXSAtIFRoZSBzdGFydCBwb2ludC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFt2MV0gLSBUaGUgY29udHJvbCBwb2ludC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFt2Ml0gLSBUaGUgZW5kIHBvaW50LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgRSgpLCBlID0gbmV3IEUoKSwgaSA9IG5ldyBFKCkpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNRdWFkcmF0aWNCZXppZXJDdXJ2ZTMgPSAhMCwgdGhpcy50eXBlID0gIlF1YWRyYXRpY0JlemllckN1cnZlMyIsIHRoaXMudjAgPSB0LCB0aGlzLnYxID0gZSwgdGhpcy52MiA9IGk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBwb2ludCBvbiB0aGUgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIEEgaW50ZXJwb2xhdGlvbiBmYWN0b3IgcmVwcmVzZW50aW5nIGEgcG9zaXRpb24gb24gdGhlIGN1cnZlLiBNdXN0IGJlIGluIHRoZSByYW5nZSBgWzAsMV1gLgogICAqIEBwYXJhbSB7VmVjdG9yM30gW29wdGlvbmFsVGFyZ2V0XSAtIFRoZSBvcHRpb25hbCB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgd3JpdHRlbiB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgcG9zaXRpb24gb24gdGhlIGN1cnZlLgogICAqLwogIGdldFBvaW50KHQsIGUgPSBuZXcgRSgpKSB7CiAgICBjb25zdCBpID0gZSwgbiA9IHRoaXMudjAsIHMgPSB0aGlzLnYxLCByID0gdGhpcy52MjsKICAgIHJldHVybiBpLnNldCgKICAgICAgbW8odCwgbi54LCBzLngsIHIueCksCiAgICAgIG1vKHQsIG4ueSwgcy55LCByLnkpLAogICAgICBtbyh0LCBuLnosIHMueiwgci56KQogICAgKSwgaTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy52MC5jb3B5KHQudjApLCB0aGlzLnYxLmNvcHkodC52MSksIHRoaXMudjIuY29weSh0LnYyKSwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgcmV0dXJuIHQudjAgPSB0aGlzLnYwLnRvQXJyYXkoKSwgdC52MSA9IHRoaXMudjEudG9BcnJheSgpLCB0LnYyID0gdGhpcy52Mi50b0FycmF5KCksIHQ7CiAgfQogIGZyb21KU09OKHQpIHsKICAgIHJldHVybiBzdXBlci5mcm9tSlNPTih0KSwgdGhpcy52MC5mcm9tQXJyYXkodC52MCksIHRoaXMudjEuZnJvbUFycmF5KHQudjEpLCB0aGlzLnYyLmZyb21BcnJheSh0LnYyKSwgdGhpczsKICB9Cn0KY2xhc3MgWXAgZXh0ZW5kcyBtbiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAyRCBzcGxpbmUgY3VydmUuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PFZlY3RvcjI+fSBbcG9pbnRzXSAtICBBbiBhcnJheSBvZiAyRCBwb2ludHMgZGVmaW5pbmcgdGhlIGN1cnZlLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBbXSkgewogICAgc3VwZXIoKSwgdGhpcy5pc1NwbGluZUN1cnZlID0gITAsIHRoaXMudHlwZSA9ICJTcGxpbmVDdXJ2ZSIsIHRoaXMucG9pbnRzID0gdDsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IG9uIHRoZSBjdXJ2ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gQSBpbnRlcnBvbGF0aW9uIGZhY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuIE11c3QgYmUgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHBhcmFtIHtWZWN0b3IyfSBbb3B0aW9uYWxUYXJnZXRdIC0gVGhlIG9wdGlvbmFsIHRhcmdldCB2ZWN0b3IgdGhlIHJlc3VsdCBpcyB3cml0dGVuIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IFRoZSBwb3NpdGlvbiBvbiB0aGUgY3VydmUuCiAgICovCiAgZ2V0UG9pbnQodCwgZSA9IG5ldyBKKCkpIHsKICAgIGNvbnN0IGkgPSBlLCBuID0gdGhpcy5wb2ludHMsIHMgPSAobi5sZW5ndGggLSAxKSAqIHQsIHIgPSBNYXRoLmZsb29yKHMpLCBvID0gcyAtIHIsIGwgPSBuW3IgPT09IDAgPyByIDogciAtIDFdLCBoID0gbltyXSwgYyA9IG5bciA+IG4ubGVuZ3RoIC0gMiA/IG4ubGVuZ3RoIC0gMSA6IHIgKyAxXSwgdSA9IG5bciA+IG4ubGVuZ3RoIC0gMyA/IG4ubGVuZ3RoIC0gMSA6IHIgKyAyXTsKICAgIHJldHVybiBpLnNldCgKICAgICAgcG0obywgbC54LCBoLngsIGMueCwgdS54KSwKICAgICAgcG0obywgbC55LCBoLnksIGMueSwgdS55KQogICAgKSwgaTsKICB9CiAgY29weSh0KSB7CiAgICBzdXBlci5jb3B5KHQpLCB0aGlzLnBvaW50cyA9IFtdOwogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0LnBvaW50cy5sZW5ndGg7IGUgPCBpOyBlKyspIHsKICAgICAgY29uc3QgbiA9IHQucG9pbnRzW2VdOwogICAgICB0aGlzLnBvaW50cy5wdXNoKG4uY2xvbmUoKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgdC5wb2ludHMgPSBbXTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5wb2ludHMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLnBvaW50c1tlXTsKICAgICAgdC5wb2ludHMucHVzaChuLnRvQXJyYXkoKSk7CiAgICB9CiAgICByZXR1cm4gdDsKICB9CiAgZnJvbUpTT04odCkgewogICAgc3VwZXIuZnJvbUpTT04odCksIHRoaXMucG9pbnRzID0gW107CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHQucG9pbnRzLmxlbmd0aDsgZSA8IGk7IGUrKykgewogICAgICBjb25zdCBuID0gdC5wb2ludHNbZV07CiAgICAgIHRoaXMucG9pbnRzLnB1c2gobmV3IEooKS5mcm9tQXJyYXkobikpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9CnZhciBfYyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuZnJlZXplKHsKICBfX3Byb3RvX186IG51bGwsCiAgQXJjQ3VydmU6IHp5LAogIENhdG11bGxSb21DdXJ2ZTM6IE55LAogIEN1YmljQmV6aWVyQ3VydmU6IFdwLAogIEN1YmljQmV6aWVyQ3VydmUzOiBPeSwKICBFbGxpcHNlQ3VydmU6IEtjLAogIExpbmVDdXJ2ZTogcXAsCiAgTGluZUN1cnZlMzoga3ksCiAgUXVhZHJhdGljQmV6aWVyQ3VydmU6ICRwLAogIFF1YWRyYXRpY0JlemllckN1cnZlMzogWHAsCiAgU3BsaW5lQ3VydmU6IFlwCn0pOwpjbGFzcyBWeSBleHRlbmRzIG1uIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGN1cnZlIHBhdGguCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpLCB0aGlzLnR5cGUgPSAiQ3VydmVQYXRoIiwgdGhpcy5jdXJ2ZXMgPSBbXSwgdGhpcy5hdXRvQ2xvc2UgPSAhMTsKICB9CiAgLyoqCiAgICogQWRkcyBhIGN1cnZlIHRvIHRoaXMgY3VydmUgcGF0aC4KICAgKgogICAqIEBwYXJhbSB7Q3VydmV9IGN1cnZlIC0gVGhlIGN1cnZlIHRvIGFkZC4KICAgKi8KICBhZGQodCkgewogICAgdGhpcy5jdXJ2ZXMucHVzaCh0KTsKICB9CiAgLyoqCiAgICogQWRkcyBhIGxpbmUgY3VydmUgdG8gY2xvc2UgdGhlIHBhdGguCiAgICoKICAgKiBAcmV0dXJuIHtDdXJ2ZVBhdGh9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY3VydmUgcGF0aC4KICAgKi8KICBjbG9zZVBhdGgoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5jdXJ2ZXNbMF0uZ2V0UG9pbnQoMCksIGUgPSB0aGlzLmN1cnZlc1t0aGlzLmN1cnZlcy5sZW5ndGggLSAxXS5nZXRQb2ludCgxKTsKICAgIGlmICghdC5lcXVhbHMoZSkpIHsKICAgICAgY29uc3QgaSA9IHQuaXNWZWN0b3IyID09PSAhMCA/ICJMaW5lQ3VydmUiIDogIkxpbmVDdXJ2ZTMiOwogICAgICB0aGlzLmN1cnZlcy5wdXNoKG5ldyBfY1tpXShlLCB0KSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogVGhpcyBtZXRob2QgcmV0dXJucyBhIHZlY3RvciBpbiAyRCBvciAzRCBzcGFjZSAoZGVwZW5kaW5nIG9uIHRoZSBjdXJ2ZSBkZWZpbml0aW9ucykKICAgKiBmb3IgdGhlIGdpdmVuIGludGVycG9sYXRpb24gZmFjdG9yLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBBIGludGVycG9sYXRpb24gZmFjdG9yIHJlcHJlc2VudGluZyBhIHBvc2l0aW9uIG9uIHRoZSBjdXJ2ZS4gTXVzdCBiZSBpbiB0aGUgcmFuZ2UgYFswLDFdYC4KICAgKiBAcGFyYW0geyhWZWN0b3IyfFZlY3RvcjMpfSBbb3B0aW9uYWxUYXJnZXRdIC0gVGhlIG9wdGlvbmFsIHRhcmdldCB2ZWN0b3IgdGhlIHJlc3VsdCBpcyB3cml0dGVuIHRvLgogICAqIEByZXR1cm4gez8oVmVjdG9yMnxWZWN0b3IzKX0gVGhlIHBvc2l0aW9uIG9uIHRoZSBjdXJ2ZS4gSXQgY2FuIGJlIGEgMkQgb3IgM0QgdmVjdG9yIGRlcGVuZGluZyBvbiB0aGUgY3VydmUgZGVmaW5pdGlvbi4KICAgKi8KICBnZXRQb2ludCh0LCBlKSB7CiAgICBjb25zdCBpID0gdCAqIHRoaXMuZ2V0TGVuZ3RoKCksIG4gPSB0aGlzLmdldEN1cnZlTGVuZ3RocygpOwogICAgbGV0IHMgPSAwOwogICAgZm9yICg7IHMgPCBuLmxlbmd0aDsgKSB7CiAgICAgIGlmIChuW3NdID49IGkpIHsKICAgICAgICBjb25zdCByID0gbltzXSAtIGksIG8gPSB0aGlzLmN1cnZlc1tzXSwgbCA9IG8uZ2V0TGVuZ3RoKCksIGggPSBsID09PSAwID8gMCA6IDEgLSByIC8gbDsKICAgICAgICByZXR1cm4gby5nZXRQb2ludEF0KGgsIGUpOwogICAgICB9CiAgICAgIHMrKzsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBnZXRMZW5ndGgoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5nZXRDdXJ2ZUxlbmd0aHMoKTsKICAgIHJldHVybiB0W3QubGVuZ3RoIC0gMV07CiAgfQogIHVwZGF0ZUFyY0xlbmd0aHMoKSB7CiAgICB0aGlzLm5lZWRzVXBkYXRlID0gITAsIHRoaXMuY2FjaGVMZW5ndGhzID0gbnVsbCwgdGhpcy5nZXRDdXJ2ZUxlbmd0aHMoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBsaXN0IG9mIGN1bXVsYXRpdmUgY3VydmUgbGVuZ3RocyBvZiB0aGUgZGVmaW5lZCBjdXJ2ZXMuCiAgICoKICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgY3VydmUgbGVuZ3Rocy4KICAgKi8KICBnZXRDdXJ2ZUxlbmd0aHMoKSB7CiAgICBpZiAodGhpcy5jYWNoZUxlbmd0aHMgJiYgdGhpcy5jYWNoZUxlbmd0aHMubGVuZ3RoID09PSB0aGlzLmN1cnZlcy5sZW5ndGgpCiAgICAgIHJldHVybiB0aGlzLmNhY2hlTGVuZ3RoczsKICAgIGNvbnN0IHQgPSBbXTsKICAgIGxldCBlID0gMDsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdGhpcy5jdXJ2ZXMubGVuZ3RoOyBpIDwgbjsgaSsrKQogICAgICBlICs9IHRoaXMuY3VydmVzW2ldLmdldExlbmd0aCgpLCB0LnB1c2goZSk7CiAgICByZXR1cm4gdGhpcy5jYWNoZUxlbmd0aHMgPSB0LCB0OwogIH0KICBnZXRTcGFjZWRQb2ludHModCA9IDQwKSB7CiAgICBjb25zdCBlID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSB0OyBpKyspCiAgICAgIGUucHVzaCh0aGlzLmdldFBvaW50KGkgLyB0KSk7CiAgICByZXR1cm4gdGhpcy5hdXRvQ2xvc2UgJiYgZS5wdXNoKGVbMF0pLCBlOwogIH0KICBnZXRQb2ludHModCA9IDEyKSB7CiAgICBjb25zdCBlID0gW107CiAgICBsZXQgaTsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gdGhpcy5jdXJ2ZXM7IG4gPCBzLmxlbmd0aDsgbisrKSB7CiAgICAgIGNvbnN0IHIgPSBzW25dLCBvID0gci5pc0VsbGlwc2VDdXJ2ZSA/IHQgKiAyIDogci5pc0xpbmVDdXJ2ZSB8fCByLmlzTGluZUN1cnZlMyA/IDEgOiByLmlzU3BsaW5lQ3VydmUgPyB0ICogci5wb2ludHMubGVuZ3RoIDogdCwgbCA9IHIuZ2V0UG9pbnRzKG8pOwogICAgICBmb3IgKGxldCBoID0gMDsgaCA8IGwubGVuZ3RoOyBoKyspIHsKICAgICAgICBjb25zdCBjID0gbFtoXTsKICAgICAgICBpICYmIGkuZXF1YWxzKGMpIHx8IChlLnB1c2goYyksIGkgPSBjKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuYXV0b0Nsb3NlICYmIGUubGVuZ3RoID4gMSAmJiAhZVtlLmxlbmd0aCAtIDFdLmVxdWFscyhlWzBdKSAmJiBlLnB1c2goZVswXSksIGU7CiAgfQogIGNvcHkodCkgewogICAgc3VwZXIuY29weSh0KSwgdGhpcy5jdXJ2ZXMgPSBbXTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5jdXJ2ZXMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0LmN1cnZlc1tlXTsKICAgICAgdGhpcy5jdXJ2ZXMucHVzaChuLmNsb25lKCkpOwogICAgfQogICAgcmV0dXJuIHRoaXMuYXV0b0Nsb3NlID0gdC5hdXRvQ2xvc2UsIHRoaXM7CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSBzdXBlci50b0pTT04oKTsKICAgIHQuYXV0b0Nsb3NlID0gdGhpcy5hdXRvQ2xvc2UsIHQuY3VydmVzID0gW107CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHRoaXMuY3VydmVzLmxlbmd0aDsgZSA8IGk7IGUrKykgewogICAgICBjb25zdCBuID0gdGhpcy5jdXJ2ZXNbZV07CiAgICAgIHQuY3VydmVzLnB1c2gobi50b0pTT04oKSk7CiAgICB9CiAgICByZXR1cm4gdDsKICB9CiAgZnJvbUpTT04odCkgewogICAgc3VwZXIuZnJvbUpTT04odCksIHRoaXMuYXV0b0Nsb3NlID0gdC5hdXRvQ2xvc2UsIHRoaXMuY3VydmVzID0gW107CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHQuY3VydmVzLmxlbmd0aDsgZSA8IGk7IGUrKykgewogICAgICBjb25zdCBuID0gdC5jdXJ2ZXNbZV07CiAgICAgIHRoaXMuY3VydmVzLnB1c2gobmV3IF9jW24udHlwZV0oKS5mcm9tSlNPTihuKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Cn0KY2xhc3MgeGMgZXh0ZW5kcyBWeSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwYXRoLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxWZWN0b3IyPn0gW3BvaW50c10gLSBBbiBhcnJheSBvZiAyRCBwb2ludHMgZGVmaW5pbmcgdGhlIHBhdGguCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIlBhdGgiLCB0aGlzLmN1cnJlbnRQb2ludCA9IG5ldyBKKCksIHQgJiYgdGhpcy5zZXRGcm9tUG9pbnRzKHQpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgcGF0aCBmcm9tIHRoZSBnaXZlbiBsaXN0IG9mIHBvaW50cy4gVGhlIHBvaW50cyBhcmUgYWRkZWQKICAgKiB0byB0aGUgcGF0aCBhcyBpbnN0YW5jZXMgb2Yge0BsaW5rIExpbmVDdXJ2ZX0uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PFZlY3RvcjI+fSBwb2ludHMgLSBBbiBhcnJheSBvZiAyRCBwb2ludHMuCiAgICogQHJldHVybiB7UGF0aH0gQSByZWZlcmVuY2UgdG8gdGhpcyBwYXRoLgogICAqLwogIHNldEZyb21Qb2ludHModCkgewogICAgdGhpcy5tb3ZlVG8odFswXS54LCB0WzBdLnkpOwogICAgZm9yIChsZXQgZSA9IDEsIGkgPSB0Lmxlbmd0aDsgZSA8IGk7IGUrKykKICAgICAgdGhpcy5saW5lVG8odFtlXS54LCB0W2VdLnkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIE1vdmVzIHtAbGluayBQYXRoI2N1cnJlbnRQb2ludH0gdG8gdGhlIGdpdmVuIHBvaW50LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZS4KICAgKiBAcmV0dXJuIHtQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHBhdGguCiAgICovCiAgbW92ZVRvKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRQb2ludC5zZXQodCwgZSksIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIExpbmVDdXJ2ZX0gdG8gdGhlIHBhdGggYnkgY29ubmVjdGluZwogICAqIHRoZSBjdXJyZW50IHBvaW50IHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgZW5kIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgZW5kIHBvaW50LgogICAqIEByZXR1cm4ge1BhdGh9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcGF0aC4KICAgKi8KICBsaW5lVG8odCwgZSkgewogICAgY29uc3QgaSA9IG5ldyBxcCh0aGlzLmN1cnJlbnRQb2ludC5jbG9uZSgpLCBuZXcgSih0LCBlKSk7CiAgICByZXR1cm4gdGhpcy5jdXJ2ZXMucHVzaChpKSwgdGhpcy5jdXJyZW50UG9pbnQuc2V0KHQsIGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGluc3RhbmNlIG9mIHtAbGluayBRdWFkcmF0aWNCZXppZXJDdXJ2ZX0gdG8gdGhlIHBhdGggYnkgY29ubmVjdGluZwogICAqIHRoZSBjdXJyZW50IHBvaW50IHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhQ1B4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY29udHJvbCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gYUNQeSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGNvbnRyb2wgcG9pbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFYIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgZW5kIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhWSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBwb2ludC4KICAgKiBAcmV0dXJuIHtQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHBhdGguCiAgICovCiAgcXVhZHJhdGljQ3VydmVUbyh0LCBlLCBpLCBuKSB7CiAgICBjb25zdCBzID0gbmV3ICRwKAogICAgICB0aGlzLmN1cnJlbnRQb2ludC5jbG9uZSgpLAogICAgICBuZXcgSih0LCBlKSwKICAgICAgbmV3IEooaSwgbikKICAgICk7CiAgICByZXR1cm4gdGhpcy5jdXJ2ZXMucHVzaChzKSwgdGhpcy5jdXJyZW50UG9pbnQuc2V0KGksIG4pLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGluc3RhbmNlIG9mIHtAbGluayBDdWJpY0JlemllckN1cnZlfSB0byB0aGUgcGF0aCBieSBjb25uZWN0aW5nCiAgICogdGhlIGN1cnJlbnQgcG9pbnQgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFDUDF4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgZmlyc3QgY29udHJvbCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gYUNQMXkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBmaXJzdCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhQ1AyeCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHNlY29uZCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhQ1AyeSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHNlY29uZCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhWCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gYVkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBlbmQgcG9pbnQuCiAgICogQHJldHVybiB7UGF0aH0gQSByZWZlcmVuY2UgdG8gdGhpcyBwYXRoLgogICAqLwogIGJlemllckN1cnZlVG8odCwgZSwgaSwgbiwgcywgcikgewogICAgY29uc3QgbyA9IG5ldyBXcCgKICAgICAgdGhpcy5jdXJyZW50UG9pbnQuY2xvbmUoKSwKICAgICAgbmV3IEoodCwgZSksCiAgICAgIG5ldyBKKGksIG4pLAogICAgICBuZXcgSihzLCByKQogICAgKTsKICAgIHJldHVybiB0aGlzLmN1cnZlcy5wdXNoKG8pLCB0aGlzLmN1cnJlbnRQb2ludC5zZXQocywgciksIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIFNwbGluZUN1cnZlfSB0byB0aGUgcGF0aCBieSBjb25uZWN0aW5nCiAgICogdGhlIGN1cnJlbnQgcG9pbnQgd2l0aCB0aGUgZ2l2ZW4gbGlzdCBvZiBwb2ludHMuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PFZlY3RvcjI+fSBwdHMgLSBBbiBhcnJheSBvZiBwb2ludHMgaW4gMkQgc3BhY2UuCiAgICogQHJldHVybiB7UGF0aH0gQSByZWZlcmVuY2UgdG8gdGhpcyBwYXRoLgogICAqLwogIHNwbGluZVRocnUodCkgewogICAgY29uc3QgZSA9IFt0aGlzLmN1cnJlbnRQb2ludC5jbG9uZSgpXS5jb25jYXQodCksIGkgPSBuZXcgWXAoZSk7CiAgICByZXR1cm4gdGhpcy5jdXJ2ZXMucHVzaChpKSwgdGhpcy5jdXJyZW50UG9pbnQuY29weSh0W3QubGVuZ3RoIC0gMV0pLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGFyYyBhcyBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgRWxsaXBzZUN1cnZlfSB0byB0aGUgcGF0aCwgcG9zaXRpb25lZCByZWxhdGl2ZQogICAqIHRvIHRoZSBjdXJyZW50IHBvaW50LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFthWD0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgYXJjIG9mZnNldHRlZCBmcm9tIHRoZSBwcmV2aW91cyBjdXJ2ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FZPTBdIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBhcmMgb2Zmc2V0dGVkIGZyb20gdGhlIHByZXZpb3VzIGN1cnZlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVJhZGl1cz0xXSAtIFRoZSByYWRpdXMgb2YgdGhlIGFyYy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FTdGFydEFuZ2xlPTBdIC0gVGhlIHN0YXJ0IGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthRW5kQW5nbGU9TWF0aC5QSSoyXSAtIFRoZSBlbmQgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthQ2xvY2t3aXNlPWZhbHNlXSAtIFdoZXRoZXIgdG8gc3dlZXAgdGhlIGFyYyBjbG9ja3dpc2Ugb3Igbm90LgogICAqIEByZXR1cm4ge1BhdGh9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcGF0aC4KICAgKi8KICBhcmModCwgZSwgaSwgbiwgcywgcikgewogICAgY29uc3QgbyA9IHRoaXMuY3VycmVudFBvaW50LngsIGwgPSB0aGlzLmN1cnJlbnRQb2ludC55OwogICAgcmV0dXJuIHRoaXMuYWJzYXJjKAogICAgICB0ICsgbywKICAgICAgZSArIGwsCiAgICAgIGksCiAgICAgIG4sCiAgICAgIHMsCiAgICAgIHIKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgYW4gYWJzb2x1dGVseSBwb3NpdGlvbmVkIGFyYyBhcyBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgRWxsaXBzZUN1cnZlfSB0byB0aGUgcGF0aC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVg9MF0gLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGFyYy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FZPTBdIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBhcmMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthUmFkaXVzPTFdIC0gVGhlIHJhZGl1cyBvZiB0aGUgYXJjLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVN0YXJ0QW5nbGU9MF0gLSBUaGUgc3RhcnQgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FFbmRBbmdsZT1NYXRoLlBJKjJdIC0gVGhlIGVuZCBhbmdsZSBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2FDbG9ja3dpc2U9ZmFsc2VdIC0gV2hldGhlciB0byBzd2VlcCB0aGUgYXJjIGNsb2Nrd2lzZSBvciBub3QuCiAgICogQHJldHVybiB7UGF0aH0gQSByZWZlcmVuY2UgdG8gdGhpcyBwYXRoLgogICAqLwogIGFic2FyYyh0LCBlLCBpLCBuLCBzLCByKSB7CiAgICByZXR1cm4gdGhpcy5hYnNlbGxpcHNlKHQsIGUsIGksIGksIG4sIHMsIHIpLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGVsbGlwc2UgYXMgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIEVsbGlwc2VDdXJ2ZX0gdG8gdGhlIHBhdGgsIHBvc2l0aW9uZWQgcmVsYXRpdmUKICAgKiB0byB0aGUgY3VycmVudCBwb2ludAogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFthWD0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgZWxsaXBzZSBvZmZzZXR0ZWQgZnJvbSB0aGUgcHJldmlvdXMgY3VydmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthWT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgZWxsaXBzZSBvZmZzZXR0ZWQgZnJvbSB0aGUgcHJldmlvdXMgY3VydmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt4UmFkaXVzPTFdIC0gVGhlIHJhZGl1cyBvZiB0aGUgZWxsaXBzZSBpbiB0aGUgeCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeVJhZGl1cz0xXSAtIFRoZSByYWRpdXMgb2YgdGhlIGVsbGlwc2UgaW4gdGhlIHkgYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FTdGFydEFuZ2xlPTBdIC0gVGhlIHN0YXJ0IGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthRW5kQW5nbGU9TWF0aC5QSSoyXSAtIFRoZSBlbmQgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthQ2xvY2t3aXNlPWZhbHNlXSAtIFdoZXRoZXIgdG8gc3dlZXAgdGhlIGVsbGlwc2UgY2xvY2t3aXNlIG9yIG5vdC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FSb3RhdGlvbj0wXSAtIFRoZSByb3RhdGlvbiBhbmdsZSBvZiB0aGUgZWxsaXBzZSBpbiByYWRpYW5zLCBjb3VudGVyY2xvY2t3aXNlIGZyb20gdGhlIHBvc2l0aXZlIFggYXhpcy4KICAgKiBAcmV0dXJuIHtQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHBhdGguCiAgICovCiAgZWxsaXBzZSh0LCBlLCBpLCBuLCBzLCByLCBvLCBsKSB7CiAgICBjb25zdCBoID0gdGhpcy5jdXJyZW50UG9pbnQueCwgYyA9IHRoaXMuY3VycmVudFBvaW50Lnk7CiAgICByZXR1cm4gdGhpcy5hYnNlbGxpcHNlKHQgKyBoLCBlICsgYywgaSwgbiwgcywgciwgbywgbCksIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgYW4gYWJzb2x1dGVseSBwb3NpdGlvbmVkIGVsbGlwc2UgYXMgYW4gaW5zdGFuY2Ugb2Yge0BsaW5rIEVsbGlwc2VDdXJ2ZX0gdG8gdGhlIHBhdGguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW2FYPTBdIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgYWJzb2x1dGUgY2VudGVyIG9mIHRoZSBlbGxpcHNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYVk9MF0gLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBhYnNvbHV0ZSBjZW50ZXIgb2YgdGhlIGVsbGlwc2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt4UmFkaXVzPTFdIC0gVGhlIHJhZGl1cyBvZiB0aGUgZWxsaXBzZSBpbiB0aGUgeCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeVJhZGl1cz0xXSAtIFRoZSByYWRpdXMgb2YgdGhlIGVsbGlwc2UgaW4gdGhlIHkgYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FTdGFydEFuZ2xlPTBdIC0gVGhlIHN0YXJ0IGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthRW5kQW5nbGU9TWF0aC5QSSoyXSAtIFRoZSBlbmQgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthQ2xvY2t3aXNlPWZhbHNlXSAtIFdoZXRoZXIgdG8gc3dlZXAgdGhlIGVsbGlwc2UgY2xvY2t3aXNlIG9yIG5vdC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2FSb3RhdGlvbj0wXSAtIFRoZSByb3RhdGlvbiBhbmdsZSBvZiB0aGUgZWxsaXBzZSBpbiByYWRpYW5zLCBjb3VudGVyY2xvY2t3aXNlIGZyb20gdGhlIHBvc2l0aXZlIFggYXhpcy4KICAgKiBAcmV0dXJuIHtQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHBhdGguCiAgICovCiAgYWJzZWxsaXBzZSh0LCBlLCBpLCBuLCBzLCByLCBvLCBsKSB7CiAgICBjb25zdCBoID0gbmV3IEtjKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwpOwogICAgaWYgKHRoaXMuY3VydmVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgdSA9IGguZ2V0UG9pbnQoMCk7CiAgICAgIHUuZXF1YWxzKHRoaXMuY3VycmVudFBvaW50KSB8fCB0aGlzLmxpbmVUbyh1LngsIHUueSk7CiAgICB9CiAgICB0aGlzLmN1cnZlcy5wdXNoKGgpOwogICAgY29uc3QgYyA9IGguZ2V0UG9pbnQoMSk7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50UG9pbnQuY29weShjKSwgdGhpczsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5jdXJyZW50UG9pbnQuY29weSh0LmN1cnJlbnRQb2ludCksIHRoaXM7CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSBzdXBlci50b0pTT04oKTsKICAgIHJldHVybiB0LmN1cnJlbnRQb2ludCA9IHRoaXMuY3VycmVudFBvaW50LnRvQXJyYXkoKSwgdDsKICB9CiAgZnJvbUpTT04odCkgewogICAgcmV0dXJuIHN1cGVyLmZyb21KU09OKHQpLCB0aGlzLmN1cnJlbnRQb2ludC5mcm9tQXJyYXkodC5jdXJyZW50UG9pbnQpLCB0aGlzOwogIH0KfQpjbGFzcyBBcyBleHRlbmRzIHhjIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHNoYXBlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxWZWN0b3IyPn0gW3BvaW50c10gLSBBbiBhcnJheSBvZiAyRCBwb2ludHMgZGVmaW5pbmcgdGhlIHNoYXBlLgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKHQpLCB0aGlzLnV1aWQgPSBPaSgpLCB0aGlzLnR5cGUgPSAiU2hhcGUiLCB0aGlzLmhvbGVzID0gW107CiAgfQogIC8qKgogICAqIFJldHVybnMgYW4gYXJyYXkgcmVwcmVzZW50aW5nIGVhY2ggY29udG91ciBvZiB0aGUgaG9sZXMKICAgKiBhcyBhIGxpc3Qgb2YgMkQgcG9pbnRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpdmlzaW9ucyAtIFRoZSBmaW5lbmVzcyBvZiB0aGUgcmVzdWx0LgogICAqIEByZXR1cm4ge0FycmF5PEFycmF5PFZlY3RvcjI+Pn0gVGhlIGhvbGVzIGFzIGEgc2VyaWVzIG9mIDJEIHBvaW50cy4KICAgKi8KICBnZXRQb2ludHNIb2xlcyh0KSB7CiAgICBjb25zdCBlID0gW107CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IHRoaXMuaG9sZXMubGVuZ3RoOyBpIDwgbjsgaSsrKQogICAgICBlW2ldID0gdGhpcy5ob2xlc1tpXS5nZXRQb2ludHModCk7CiAgICByZXR1cm4gZTsKICB9CiAgLy8gZ2V0IHBvaW50cyBvZiBzaGFwZSBhbmQgaG9sZXMgKGtleXBvaW50cyBiYXNlZCBvbiBzZWdtZW50cyBwYXJhbWV0ZXIpCiAgLyoqCiAgICogUmV0dXJucyBhbiBvYmplY3QgdGhhdCBob2xkcyBjb250b3VyIGRhdGEgZm9yIHRoZSBzaGFwZSBhbmQgaXRzIGhvbGVzIGFzCiAgICogYXJyYXlzIG9mIDJEIHBvaW50cy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBkaXZpc2lvbnMgLSBUaGUgZmluZW5lc3Mgb2YgdGhlIHJlc3VsdC4KICAgKiBAcmV0dXJuIHt7c2hhcGU6QXJyYXk8VmVjdG9yMj4saG9sZXM6QXJyYXk8QXJyYXk8VmVjdG9yMj4+fX0gQW4gb2JqZWN0IHdpdGggY29udG91ciBkYXRhLgogICAqLwogIGV4dHJhY3RQb2ludHModCkgewogICAgcmV0dXJuIHsKICAgICAgc2hhcGU6IHRoaXMuZ2V0UG9pbnRzKHQpLAogICAgICBob2xlczogdGhpcy5nZXRQb2ludHNIb2xlcyh0KQogICAgfTsKICB9CiAgY29weSh0KSB7CiAgICBzdXBlci5jb3B5KHQpLCB0aGlzLmhvbGVzID0gW107CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHQuaG9sZXMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0LmhvbGVzW2VdOwogICAgICB0aGlzLmhvbGVzLnB1c2gobi5jbG9uZSgpKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0gc3VwZXIudG9KU09OKCk7CiAgICB0LnV1aWQgPSB0aGlzLnV1aWQsIHQuaG9sZXMgPSBbXTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5ob2xlcy5sZW5ndGg7IGUgPCBpOyBlKyspIHsKICAgICAgY29uc3QgbiA9IHRoaXMuaG9sZXNbZV07CiAgICAgIHQuaG9sZXMucHVzaChuLnRvSlNPTigpKTsKICAgIH0KICAgIHJldHVybiB0OwogIH0KICBmcm9tSlNPTih0KSB7CiAgICBzdXBlci5mcm9tSlNPTih0KSwgdGhpcy51dWlkID0gdC51dWlkLCB0aGlzLmhvbGVzID0gW107CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHQuaG9sZXMubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSB0LmhvbGVzW2VdOwogICAgICB0aGlzLmhvbGVzLnB1c2gobmV3IHhjKCkuZnJvbUpTT04obikpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9CmZ1bmN0aW9uIGRiKGEsIHQsIGUgPSAyKSB7CiAgY29uc3QgaSA9IHQgJiYgdC5sZW5ndGgsIG4gPSBpID8gdFswXSAqIGUgOiBhLmxlbmd0aDsKICBsZXQgcyA9IEh5KGEsIDAsIG4sIGUsICEwKTsKICBjb25zdCByID0gW107CiAgaWYgKCFzIHx8IHMubmV4dCA9PT0gcy5wcmV2KSByZXR1cm4gcjsKICBsZXQgbywgbCwgaDsKICBpZiAoaSAmJiAocyA9IHliKGEsIHQsIHMsIGUpKSwgYS5sZW5ndGggPiA4MCAqIGUpIHsKICAgIG8gPSAxIC8gMCwgbCA9IDEgLyAwOwogICAgbGV0IGMgPSAtMSAvIDAsIHUgPSAtMSAvIDA7CiAgICBmb3IgKGxldCBkID0gZTsgZCA8IG47IGQgKz0gZSkgewogICAgICBjb25zdCBwID0gYVtkXSwgZiA9IGFbZCArIDFdOwogICAgICBwIDwgbyAmJiAobyA9IHApLCBmIDwgbCAmJiAobCA9IGYpLCBwID4gYyAmJiAoYyA9IHApLCBmID4gdSAmJiAodSA9IGYpOwogICAgfQogICAgaCA9IE1hdGgubWF4KGMgLSBvLCB1IC0gbCksIGggPSBoICE9PSAwID8gMzI3NjcgLyBoIDogMDsKICB9CiAgcmV0dXJuIElvKHMsIHIsIGUsIG8sIGwsIGgsIDApLCByOwp9CmZ1bmN0aW9uIEh5KGEsIHQsIGUsIGksIG4pIHsKICBsZXQgczsKICBpZiAobiA9PT0gQ2IoYSwgdCwgZSwgaSkgPiAwKQogICAgZm9yIChsZXQgciA9IHQ7IHIgPCBlOyByICs9IGkpIHMgPSBmbShyIC8gaSB8IDAsIGFbcl0sIGFbciArIDFdLCBzKTsKICBlbHNlCiAgICBmb3IgKGxldCByID0gZSAtIGk7IHIgPj0gdDsgciAtPSBpKSBzID0gZm0ociAvIGkgfCAwLCBhW3JdLCBhW3IgKyAxXSwgcyk7CiAgcmV0dXJuIHMgJiYgdmEocywgcy5uZXh0KSAmJiAoRG8ocyksIHMgPSBzLm5leHQpLCBzOwp9CmZ1bmN0aW9uIGZyKGEsIHQpIHsKICBpZiAoIWEpIHJldHVybiBhOwogIHQgfHwgKHQgPSBhKTsKICBsZXQgZSA9IGEsIGk7CiAgZG8KICAgIGlmIChpID0gITEsICFlLnN0ZWluZXIgJiYgKHZhKGUsIGUubmV4dCkgfHwgU2UoZS5wcmV2LCBlLCBlLm5leHQpID09PSAwKSkgewogICAgICBpZiAoRG8oZSksIGUgPSB0ID0gZS5wcmV2LCBlID09PSBlLm5leHQpIGJyZWFrOwogICAgICBpID0gITA7CiAgICB9IGVsc2UKICAgICAgZSA9IGUubmV4dDsKICB3aGlsZSAoaSB8fCBlICE9PSB0KTsKICByZXR1cm4gdDsKfQpmdW5jdGlvbiBJbyhhLCB0LCBlLCBpLCBuLCBzLCByKSB7CiAgaWYgKCFhKSByZXR1cm47CiAgIXIgJiYgcyAmJiBNYihhLCBpLCBuLCBzKTsKICBsZXQgbyA9IGE7CiAgZm9yICg7IGEucHJldiAhPT0gYS5uZXh0OyApIHsKICAgIGNvbnN0IGwgPSBhLnByZXYsIGggPSBhLm5leHQ7CiAgICBpZiAocyA/IGZiKGEsIGksIG4sIHMpIDogcGIoYSkpIHsKICAgICAgdC5wdXNoKGwuaSwgYS5pLCBoLmkpLCBEbyhhKSwgYSA9IGgubmV4dCwgbyA9IGgubmV4dDsKICAgICAgY29udGludWU7CiAgICB9CiAgICBpZiAoYSA9IGgsIGEgPT09IG8pIHsKICAgICAgciA/IHIgPT09IDEgPyAoYSA9IG1iKGZyKGEpLCB0KSwgSW8oYSwgdCwgZSwgaSwgbiwgcywgMikpIDogciA9PT0gMiAmJiBnYihhLCB0LCBlLCBpLCBuLCBzKSA6IElvKGZyKGEpLCB0LCBlLCBpLCBuLCBzLCAxKTsKICAgICAgYnJlYWs7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHBiKGEpIHsKICBjb25zdCB0ID0gYS5wcmV2LCBlID0gYSwgaSA9IGEubmV4dDsKICBpZiAoU2UodCwgZSwgaSkgPj0gMCkgcmV0dXJuICExOwogIGNvbnN0IG4gPSB0LngsIHMgPSBlLngsIHIgPSBpLngsIG8gPSB0LnksIGwgPSBlLnksIGggPSBpLnksIGMgPSBNYXRoLm1pbihuLCBzLCByKSwgdSA9IE1hdGgubWluKG8sIGwsIGgpLCBkID0gTWF0aC5tYXgobiwgcywgciksIHAgPSBNYXRoLm1heChvLCBsLCBoKTsKICBsZXQgZiA9IGkubmV4dDsKICBmb3IgKDsgZiAhPT0gdDsgKSB7CiAgICBpZiAoZi54ID49IGMgJiYgZi54IDw9IGQgJiYgZi55ID49IHUgJiYgZi55IDw9IHAgJiYgc28obiwgbywgcywgbCwgciwgaCwgZi54LCBmLnkpICYmIFNlKGYucHJldiwgZiwgZi5uZXh0KSA+PSAwKSByZXR1cm4gITE7CiAgICBmID0gZi5uZXh0OwogIH0KICByZXR1cm4gITA7Cn0KZnVuY3Rpb24gZmIoYSwgdCwgZSwgaSkgewogIGNvbnN0IG4gPSBhLnByZXYsIHMgPSBhLCByID0gYS5uZXh0OwogIGlmIChTZShuLCBzLCByKSA+PSAwKSByZXR1cm4gITE7CiAgY29uc3QgbyA9IG4ueCwgbCA9IHMueCwgaCA9IHIueCwgYyA9IG4ueSwgdSA9IHMueSwgZCA9IHIueSwgcCA9IE1hdGgubWluKG8sIGwsIGgpLCBmID0gTWF0aC5taW4oYywgdSwgZCksIHkgPSBNYXRoLm1heChvLCBsLCBoKSwgZyA9IE1hdGgubWF4KGMsIHUsIGQpLCBtID0gaXAocCwgZiwgdCwgZSwgaSksIHYgPSBpcCh5LCBnLCB0LCBlLCBpKTsKICBsZXQgeCA9IGEucHJldlosIF8gPSBhLm5leHRaOwogIGZvciAoOyB4ICYmIHgueiA+PSBtICYmIF8gJiYgXy56IDw9IHY7ICkgewogICAgaWYgKHgueCA+PSBwICYmIHgueCA8PSB5ICYmIHgueSA+PSBmICYmIHgueSA8PSBnICYmIHggIT09IG4gJiYgeCAhPT0gciAmJiBzbyhvLCBjLCBsLCB1LCBoLCBkLCB4LngsIHgueSkgJiYgU2UoeC5wcmV2LCB4LCB4Lm5leHQpID49IDAgfHwgKHggPSB4LnByZXZaLCBfLnggPj0gcCAmJiBfLnggPD0geSAmJiBfLnkgPj0gZiAmJiBfLnkgPD0gZyAmJiBfICE9PSBuICYmIF8gIT09IHIgJiYgc28obywgYywgbCwgdSwgaCwgZCwgXy54LCBfLnkpICYmIFNlKF8ucHJldiwgXywgXy5uZXh0KSA+PSAwKSkgcmV0dXJuICExOwogICAgXyA9IF8ubmV4dFo7CiAgfQogIGZvciAoOyB4ICYmIHgueiA+PSBtOyApIHsKICAgIGlmICh4LnggPj0gcCAmJiB4LnggPD0geSAmJiB4LnkgPj0gZiAmJiB4LnkgPD0gZyAmJiB4ICE9PSBuICYmIHggIT09IHIgJiYgc28obywgYywgbCwgdSwgaCwgZCwgeC54LCB4LnkpICYmIFNlKHgucHJldiwgeCwgeC5uZXh0KSA+PSAwKSByZXR1cm4gITE7CiAgICB4ID0geC5wcmV2WjsKICB9CiAgZm9yICg7IF8gJiYgXy56IDw9IHY7ICkgewogICAgaWYgKF8ueCA+PSBwICYmIF8ueCA8PSB5ICYmIF8ueSA+PSBmICYmIF8ueSA8PSBnICYmIF8gIT09IG4gJiYgXyAhPT0gciAmJiBzbyhvLCBjLCBsLCB1LCBoLCBkLCBfLngsIF8ueSkgJiYgU2UoXy5wcmV2LCBfLCBfLm5leHQpID49IDApIHJldHVybiAhMTsKICAgIF8gPSBfLm5leHRaOwogIH0KICByZXR1cm4gITA7Cn0KZnVuY3Rpb24gbWIoYSwgdCkgewogIGxldCBlID0gYTsKICBkbyB7CiAgICBjb25zdCBpID0gZS5wcmV2LCBuID0gZS5uZXh0Lm5leHQ7CiAgICAhdmEoaSwgbikgJiYgV3koaSwgZSwgZS5uZXh0LCBuKSAmJiBMbyhpLCBuKSAmJiBMbyhuLCBpKSAmJiAodC5wdXNoKGkuaSwgZS5pLCBuLmkpLCBEbyhlKSwgRG8oZS5uZXh0KSwgZSA9IGEgPSBuKSwgZSA9IGUubmV4dDsKICB9IHdoaWxlIChlICE9PSBhKTsKICByZXR1cm4gZnIoZSk7Cn0KZnVuY3Rpb24gZ2IoYSwgdCwgZSwgaSwgbiwgcykgewogIGxldCByID0gYTsKICBkbyB7CiAgICBsZXQgbyA9IHIubmV4dC5uZXh0OwogICAgZm9yICg7IG8gIT09IHIucHJldjsgKSB7CiAgICAgIGlmIChyLmkgIT09IG8uaSAmJiBBYihyLCBvKSkgewogICAgICAgIGxldCBsID0gcXkociwgbyk7CiAgICAgICAgciA9IGZyKHIsIHIubmV4dCksIGwgPSBmcihsLCBsLm5leHQpLCBJbyhyLCB0LCBlLCBpLCBuLCBzLCAwKSwgSW8obCwgdCwgZSwgaSwgbiwgcywgMCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG8gPSBvLm5leHQ7CiAgICB9CiAgICByID0gci5uZXh0OwogIH0gd2hpbGUgKHIgIT09IGEpOwp9CmZ1bmN0aW9uIHliKGEsIHQsIGUsIGkpIHsKICBjb25zdCBuID0gW107CiAgZm9yIChsZXQgcyA9IDAsIHIgPSB0Lmxlbmd0aDsgcyA8IHI7IHMrKykgewogICAgY29uc3QgbyA9IHRbc10gKiBpLCBsID0gcyA8IHIgLSAxID8gdFtzICsgMV0gKiBpIDogYS5sZW5ndGgsIGggPSBIeShhLCBvLCBsLCBpLCAhMSk7CiAgICBoID09PSBoLm5leHQgJiYgKGguc3RlaW5lciA9ICEwKSwgbi5wdXNoKHdiKGgpKTsKICB9CiAgbi5zb3J0KF9iKTsKICBmb3IgKGxldCBzID0gMDsgcyA8IG4ubGVuZ3RoOyBzKyspCiAgICBlID0geGIobltzXSwgZSk7CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2IoYSwgdCkgewogIGxldCBlID0gYS54IC0gdC54OwogIGlmIChlID09PSAwICYmIChlID0gYS55IC0gdC55LCBlID09PSAwKSkgewogICAgY29uc3QgaSA9IChhLm5leHQueSAtIGEueSkgLyAoYS5uZXh0LnggLSBhLngpLCBuID0gKHQubmV4dC55IC0gdC55KSAvICh0Lm5leHQueCAtIHQueCk7CiAgICBlID0gaSAtIG47CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIHhiKGEsIHQpIHsKICBjb25zdCBlID0gdmIoYSwgdCk7CiAgaWYgKCFlKQogICAgcmV0dXJuIHQ7CiAgY29uc3QgaSA9IHF5KGUsIGEpOwogIHJldHVybiBmcihpLCBpLm5leHQpLCBmcihlLCBlLm5leHQpOwp9CmZ1bmN0aW9uIHZiKGEsIHQpIHsKICBsZXQgZSA9IHQ7CiAgY29uc3QgaSA9IGEueCwgbiA9IGEueTsKICBsZXQgcyA9IC0xIC8gMCwgcjsKICBpZiAodmEoYSwgZSkpIHJldHVybiBlOwogIGRvIHsKICAgIGlmICh2YShhLCBlLm5leHQpKSByZXR1cm4gZS5uZXh0OwogICAgaWYgKG4gPD0gZS55ICYmIG4gPj0gZS5uZXh0LnkgJiYgZS5uZXh0LnkgIT09IGUueSkgewogICAgICBjb25zdCB1ID0gZS54ICsgKG4gLSBlLnkpICogKGUubmV4dC54IC0gZS54KSAvIChlLm5leHQueSAtIGUueSk7CiAgICAgIGlmICh1IDw9IGkgJiYgdSA+IHMgJiYgKHMgPSB1LCByID0gZS54IDwgZS5uZXh0LnggPyBlIDogZS5uZXh0LCB1ID09PSBpKSkKICAgICAgICByZXR1cm4gcjsKICAgIH0KICAgIGUgPSBlLm5leHQ7CiAgfSB3aGlsZSAoZSAhPT0gdCk7CiAgaWYgKCFyKSByZXR1cm4gbnVsbDsKICBjb25zdCBvID0gciwgbCA9IHIueCwgaCA9IHIueTsKICBsZXQgYyA9IDEgLyAwOwogIGUgPSByOwogIGRvIHsKICAgIGlmIChpID49IGUueCAmJiBlLnggPj0gbCAmJiBpICE9PSBlLnggJiYgR3kobiA8IGggPyBpIDogcywgbiwgbCwgaCwgbiA8IGggPyBzIDogaSwgbiwgZS54LCBlLnkpKSB7CiAgICAgIGNvbnN0IHUgPSBNYXRoLmFicyhuIC0gZS55KSAvIChpIC0gZS54KTsKICAgICAgTG8oZSwgYSkgJiYgKHUgPCBjIHx8IHUgPT09IGMgJiYgKGUueCA+IHIueCB8fCBlLnggPT09IHIueCAmJiBiYihyLCBlKSkpICYmIChyID0gZSwgYyA9IHUpOwogICAgfQogICAgZSA9IGUubmV4dDsKICB9IHdoaWxlIChlICE9PSBvKTsKICByZXR1cm4gcjsKfQpmdW5jdGlvbiBiYihhLCB0KSB7CiAgcmV0dXJuIFNlKGEucHJldiwgYSwgdC5wcmV2KSA8IDAgJiYgU2UodC5uZXh0LCBhLCBhLm5leHQpIDwgMDsKfQpmdW5jdGlvbiBNYihhLCB0LCBlLCBpKSB7CiAgbGV0IG4gPSBhOwogIGRvCiAgICBuLnogPT09IDAgJiYgKG4ueiA9IGlwKG4ueCwgbi55LCB0LCBlLCBpKSksIG4ucHJldlogPSBuLnByZXYsIG4ubmV4dFogPSBuLm5leHQsIG4gPSBuLm5leHQ7CiAgd2hpbGUgKG4gIT09IGEpOwogIG4ucHJldloubmV4dFogPSBudWxsLCBuLnByZXZaID0gbnVsbCwgU2Iobik7Cn0KZnVuY3Rpb24gU2IoYSkgewogIGxldCB0LCBlID0gMTsKICBkbyB7CiAgICBsZXQgaSA9IGEsIG47CiAgICBhID0gbnVsbDsKICAgIGxldCBzID0gbnVsbDsKICAgIGZvciAodCA9IDA7IGk7ICkgewogICAgICB0Kys7CiAgICAgIGxldCByID0gaSwgbyA9IDA7CiAgICAgIGZvciAobGV0IGggPSAwOyBoIDwgZSAmJiAobysrLCByID0gci5uZXh0WiwgISFyKTsgaCsrKQogICAgICAgIDsKICAgICAgbGV0IGwgPSBlOwogICAgICBmb3IgKDsgbyA+IDAgfHwgbCA+IDAgJiYgcjsgKQogICAgICAgIG8gIT09IDAgJiYgKGwgPT09IDAgfHwgIXIgfHwgaS56IDw9IHIueikgPyAobiA9IGksIGkgPSBpLm5leHRaLCBvLS0pIDogKG4gPSByLCByID0gci5uZXh0WiwgbC0tKSwgcyA/IHMubmV4dFogPSBuIDogYSA9IG4sIG4ucHJldlogPSBzLCBzID0gbjsKICAgICAgaSA9IHI7CiAgICB9CiAgICBzLm5leHRaID0gbnVsbCwgZSAqPSAyOwogIH0gd2hpbGUgKHQgPiAxKTsKICByZXR1cm4gYTsKfQpmdW5jdGlvbiBpcChhLCB0LCBlLCBpLCBuKSB7CiAgcmV0dXJuIGEgPSAoYSAtIGUpICogbiB8IDAsIHQgPSAodCAtIGkpICogbiB8IDAsIGEgPSAoYSB8IGEgPDwgOCkgJiAxNjcxMTkzNSwgYSA9IChhIHwgYSA8PCA0KSAmIDI1MjY0NTEzNSwgYSA9IChhIHwgYSA8PCAyKSAmIDg1ODk5MzQ1OSwgYSA9IChhIHwgYSA8PCAxKSAmIDE0MzE2NTU3NjUsIHQgPSAodCB8IHQgPDwgOCkgJiAxNjcxMTkzNSwgdCA9ICh0IHwgdCA8PCA0KSAmIDI1MjY0NTEzNSwgdCA9ICh0IHwgdCA8PCAyKSAmIDg1ODk5MzQ1OSwgdCA9ICh0IHwgdCA8PCAxKSAmIDE0MzE2NTU3NjUsIGEgfCB0IDw8IDE7Cn0KZnVuY3Rpb24gd2IoYSkgewogIGxldCB0ID0gYSwgZSA9IGE7CiAgZG8KICAgICh0LnggPCBlLnggfHwgdC54ID09PSBlLnggJiYgdC55IDwgZS55KSAmJiAoZSA9IHQpLCB0ID0gdC5uZXh0OwogIHdoaWxlICh0ICE9PSBhKTsKICByZXR1cm4gZTsKfQpmdW5jdGlvbiBHeShhLCB0LCBlLCBpLCBuLCBzLCByLCBvKSB7CiAgcmV0dXJuIChuIC0gcikgKiAodCAtIG8pID49IChhIC0gcikgKiAocyAtIG8pICYmIChhIC0gcikgKiAoaSAtIG8pID49IChlIC0gcikgKiAodCAtIG8pICYmIChlIC0gcikgKiAocyAtIG8pID49IChuIC0gcikgKiAoaSAtIG8pOwp9CmZ1bmN0aW9uIHNvKGEsIHQsIGUsIGksIG4sIHMsIHIsIG8pIHsKICByZXR1cm4gIShhID09PSByICYmIHQgPT09IG8pICYmIEd5KGEsIHQsIGUsIGksIG4sIHMsIHIsIG8pOwp9CmZ1bmN0aW9uIEFiKGEsIHQpIHsKICByZXR1cm4gYS5uZXh0LmkgIT09IHQuaSAmJiBhLnByZXYuaSAhPT0gdC5pICYmICFFYihhLCB0KSAmJiAvLyBkb2Vzbid0IGludGVyc2VjdCBvdGhlciBlZGdlcwogIChMbyhhLCB0KSAmJiBMbyh0LCBhKSAmJiBUYihhLCB0KSAmJiAvLyBsb2NhbGx5IHZpc2libGUKICAoU2UoYS5wcmV2LCBhLCB0LnByZXYpIHx8IFNlKGEsIHQucHJldiwgdCkpIHx8IC8vIGRvZXMgbm90IGNyZWF0ZSBvcHBvc2l0ZS1mYWNpbmcgc2VjdG9ycwogIHZhKGEsIHQpICYmIFNlKGEucHJldiwgYSwgYS5uZXh0KSA+IDAgJiYgU2UodC5wcmV2LCB0LCB0Lm5leHQpID4gMCk7Cn0KZnVuY3Rpb24gU2UoYSwgdCwgZSkgewogIHJldHVybiAodC55IC0gYS55KSAqIChlLnggLSB0LngpIC0gKHQueCAtIGEueCkgKiAoZS55IC0gdC55KTsKfQpmdW5jdGlvbiB2YShhLCB0KSB7CiAgcmV0dXJuIGEueCA9PT0gdC54ICYmIGEueSA9PT0gdC55Owp9CmZ1bmN0aW9uIFd5KGEsIHQsIGUsIGkpIHsKICBjb25zdCBuID0gUmwoU2UoYSwgdCwgZSkpLCBzID0gUmwoU2UoYSwgdCwgaSkpLCByID0gUmwoU2UoZSwgaSwgYSkpLCBvID0gUmwoU2UoZSwgaSwgdCkpOwogIHJldHVybiAhIShuICE9PSBzICYmIHIgIT09IG8gfHwgbiA9PT0gMCAmJiBDbChhLCBlLCB0KSB8fCBzID09PSAwICYmIENsKGEsIGksIHQpIHx8IHIgPT09IDAgJiYgQ2woZSwgYSwgaSkgfHwgbyA9PT0gMCAmJiBDbChlLCB0LCBpKSk7Cn0KZnVuY3Rpb24gQ2woYSwgdCwgZSkgewogIHJldHVybiB0LnggPD0gTWF0aC5tYXgoYS54LCBlLngpICYmIHQueCA+PSBNYXRoLm1pbihhLngsIGUueCkgJiYgdC55IDw9IE1hdGgubWF4KGEueSwgZS55KSAmJiB0LnkgPj0gTWF0aC5taW4oYS55LCBlLnkpOwp9CmZ1bmN0aW9uIFJsKGEpIHsKICByZXR1cm4gYSA+IDAgPyAxIDogYSA8IDAgPyAtMSA6IDA7Cn0KZnVuY3Rpb24gRWIoYSwgdCkgewogIGxldCBlID0gYTsKICBkbyB7CiAgICBpZiAoZS5pICE9PSBhLmkgJiYgZS5uZXh0LmkgIT09IGEuaSAmJiBlLmkgIT09IHQuaSAmJiBlLm5leHQuaSAhPT0gdC5pICYmIFd5KGUsIGUubmV4dCwgYSwgdCkpIHJldHVybiAhMDsKICAgIGUgPSBlLm5leHQ7CiAgfSB3aGlsZSAoZSAhPT0gYSk7CiAgcmV0dXJuICExOwp9CmZ1bmN0aW9uIExvKGEsIHQpIHsKICByZXR1cm4gU2UoYS5wcmV2LCBhLCBhLm5leHQpIDwgMCA/IFNlKGEsIHQsIGEubmV4dCkgPj0gMCAmJiBTZShhLCBhLnByZXYsIHQpID49IDAgOiBTZShhLCB0LCBhLnByZXYpIDwgMCB8fCBTZShhLCBhLm5leHQsIHQpIDwgMDsKfQpmdW5jdGlvbiBUYihhLCB0KSB7CiAgbGV0IGUgPSBhLCBpID0gITE7CiAgY29uc3QgbiA9IChhLnggKyB0LngpIC8gMiwgcyA9IChhLnkgKyB0LnkpIC8gMjsKICBkbwogICAgZS55ID4gcyAhPSBlLm5leHQueSA+IHMgJiYgZS5uZXh0LnkgIT09IGUueSAmJiBuIDwgKGUubmV4dC54IC0gZS54KSAqIChzIC0gZS55KSAvIChlLm5leHQueSAtIGUueSkgKyBlLnggJiYgKGkgPSAhaSksIGUgPSBlLm5leHQ7CiAgd2hpbGUgKGUgIT09IGEpOwogIHJldHVybiBpOwp9CmZ1bmN0aW9uIHF5KGEsIHQpIHsKICBjb25zdCBlID0gbnAoYS5pLCBhLngsIGEueSksIGkgPSBucCh0LmksIHQueCwgdC55KSwgbiA9IGEubmV4dCwgcyA9IHQucHJldjsKICByZXR1cm4gYS5uZXh0ID0gdCwgdC5wcmV2ID0gYSwgZS5uZXh0ID0gbiwgbi5wcmV2ID0gZSwgaS5uZXh0ID0gZSwgZS5wcmV2ID0gaSwgcy5uZXh0ID0gaSwgaS5wcmV2ID0gcywgaTsKfQpmdW5jdGlvbiBmbShhLCB0LCBlLCBpKSB7CiAgY29uc3QgbiA9IG5wKGEsIHQsIGUpOwogIHJldHVybiBpID8gKG4ubmV4dCA9IGkubmV4dCwgbi5wcmV2ID0gaSwgaS5uZXh0LnByZXYgPSBuLCBpLm5leHQgPSBuKSA6IChuLnByZXYgPSBuLCBuLm5leHQgPSBuKSwgbjsKfQpmdW5jdGlvbiBEbyhhKSB7CiAgYS5uZXh0LnByZXYgPSBhLnByZXYsIGEucHJldi5uZXh0ID0gYS5uZXh0LCBhLnByZXZaICYmIChhLnByZXZaLm5leHRaID0gYS5uZXh0WiksIGEubmV4dFogJiYgKGEubmV4dFoucHJldlogPSBhLnByZXZaKTsKfQpmdW5jdGlvbiBucChhLCB0LCBlKSB7CiAgcmV0dXJuIHsKICAgIGk6IGEsCiAgICAvLyB2ZXJ0ZXggaW5kZXggaW4gY29vcmRpbmF0ZXMgYXJyYXkKICAgIHg6IHQsCiAgICB5OiBlLAogICAgLy8gdmVydGV4IGNvb3JkaW5hdGVzCiAgICBwcmV2OiBudWxsLAogICAgLy8gcHJldmlvdXMgYW5kIG5leHQgdmVydGV4IG5vZGVzIGluIGEgcG9seWdvbiByaW5nCiAgICBuZXh0OiBudWxsLAogICAgejogMCwKICAgIC8vIHotb3JkZXIgY3VydmUgdmFsdWUKICAgIHByZXZaOiBudWxsLAogICAgLy8gcHJldmlvdXMgYW5kIG5leHQgbm9kZXMgaW4gei1vcmRlcgogICAgbmV4dFo6IG51bGwsCiAgICBzdGVpbmVyOiAhMQogICAgLy8gaW5kaWNhdGVzIHdoZXRoZXIgdGhpcyBpcyBhIHN0ZWluZXIgcG9pbnQKICB9Owp9CmZ1bmN0aW9uIENiKGEsIHQsIGUsIGkpIHsKICBsZXQgbiA9IDA7CiAgZm9yIChsZXQgcyA9IHQsIHIgPSBlIC0gaTsgcyA8IGU7IHMgKz0gaSkKICAgIG4gKz0gKGFbcl0gLSBhW3NdKSAqIChhW3MgKyAxXSArIGFbciArIDFdKSwgciA9IHM7CiAgcmV0dXJuIG47Cn0KY2xhc3MgUmIgewogIC8qKgogICAqIFRyaWFuZ3VsYXRlcyB0aGUgZ2l2ZW4gc2hhcGUgZGVmaW5pdGlvbiBieSByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdHJpYW5nbGVzLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBkYXRhIC0gQW4gYXJyYXkgd2l0aCAyRCBwb2ludHMuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBob2xlSW5kaWNlcyAtIEFuIGFycmF5IHdpdGggaW5kaWNlcyBkZWZpbmluZyBob2xlcy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RpbT0yXSAtIFRoZSBudW1iZXIgb2YgY29vcmRpbmF0ZXMgcGVyIHZlcnRleCBpbiB0aGUgaW5wdXQgYXJyYXkuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gQW4gYXJyYXkgcmVwcmVzZW50aW5nIHRoZSB0cmlhbmd1bGF0ZWQgZmFjZXMuIEVhY2ggZmFjZSBpcyBkZWZpbmVkIGJ5IHRocmVlIGNvbnNlY3V0aXZlIG51bWJlcnMKICAgKiByZXByZXNlbnRpbmcgdmVydGV4IGluZGljZXMuCiAgICovCiAgc3RhdGljIHRyaWFuZ3VsYXRlKHQsIGUsIGkgPSAyKSB7CiAgICByZXR1cm4gZGIodCwgZSwgaSk7CiAgfQp9CmNsYXNzIGRuIHsKICAvKioKICAgKiBDYWxjdWxhdGUgYXJlYSBvZiBhICggMkQgKSBjb250b3VyIHBvbHlnb24uCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PFZlY3RvcjI+fSBjb250b3VyIC0gQW4gYXJyYXkgb2YgMkQgcG9pbnRzLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFyZWEuCiAgICovCiAgc3RhdGljIGFyZWEodCkgewogICAgY29uc3QgZSA9IHQubGVuZ3RoOwogICAgbGV0IGkgPSAwOwogICAgZm9yIChsZXQgbiA9IGUgLSAxLCBzID0gMDsgcyA8IGU7IG4gPSBzKyspCiAgICAgIGkgKz0gdFtuXS54ICogdFtzXS55IC0gdFtzXS54ICogdFtuXS55OwogICAgcmV0dXJuIGkgKiAwLjU7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiBjb250b3VyIHVzZXMgYSBjbG9ja3dpc2Ugd2luZGluZyBvcmRlci4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMj59IHB0cyAtIEFuIGFycmF5IG9mIDJEIHBvaW50cyBkZWZpbmluZyBhIHBvbHlnb24uCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZ2l2ZW4gY29udG91ciB1c2VzIGEgY2xvY2t3aXNlIHdpbmRpbmcgb3JkZXIgb3Igbm90LgogICAqLwogIHN0YXRpYyBpc0Nsb2NrV2lzZSh0KSB7CiAgICByZXR1cm4gZG4uYXJlYSh0KSA8IDA7CiAgfQogIC8qKgogICAqIFRyaWFuZ3VsYXRlcyB0aGUgZ2l2ZW4gc2hhcGUgZGVmaW5pdGlvbi4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMj59IGNvbnRvdXIgLSBBbiBhcnJheSBvZiAyRCBwb2ludHMgZGVmaW5pbmcgdGhlIGNvbnRvdXIuCiAgICogQHBhcmFtIHtBcnJheTxBcnJheTxWZWN0b3IyPj59IGhvbGVzIC0gQW4gYXJyYXkgdGhhdCBob2xkcyBhcnJheXMgb2YgMkQgcG9pbnRzIGRlZmluaW5nIHRoZSBob2xlcy4KICAgKiBAcmV0dXJuIHtBcnJheTxBcnJheTxudW1iZXI+Pn0gQW4gYXJyYXkgdGhhdCBob2xkcyBmb3IgZWFjaCBmYWNlIGRlZmluaXRpb24gYW4gYXJyYXkgd2l0aCB0aHJlZSBpbmRpY2VzLgogICAqLwogIHN0YXRpYyB0cmlhbmd1bGF0ZVNoYXBlKHQsIGUpIHsKICAgIGNvbnN0IGkgPSBbXSwgbiA9IFtdLCBzID0gW107CiAgICBtbSh0KSwgZ20oaSwgdCk7CiAgICBsZXQgciA9IHQubGVuZ3RoOwogICAgZS5mb3JFYWNoKG1tKTsKICAgIGZvciAobGV0IGwgPSAwOyBsIDwgZS5sZW5ndGg7IGwrKykKICAgICAgbi5wdXNoKHIpLCByICs9IGVbbF0ubGVuZ3RoLCBnbShpLCBlW2xdKTsKICAgIGNvbnN0IG8gPSBSYi50cmlhbmd1bGF0ZShpLCBuKTsKICAgIGZvciAobGV0IGwgPSAwOyBsIDwgby5sZW5ndGg7IGwgKz0gMykKICAgICAgcy5wdXNoKG8uc2xpY2UobCwgbCArIDMpKTsKICAgIHJldHVybiBzOwogIH0KfQpmdW5jdGlvbiBtbShhKSB7CiAgY29uc3QgdCA9IGEubGVuZ3RoOwogIHQgPiAyICYmIGFbdCAtIDFdLmVxdWFscyhhWzBdKSAmJiBhLnBvcCgpOwp9CmZ1bmN0aW9uIGdtKGEsIHQpIHsKICBmb3IgKGxldCBlID0gMDsgZSA8IHQubGVuZ3RoOyBlKyspCiAgICBhLnB1c2godFtlXS54KSwgYS5wdXNoKHRbZV0ueSk7Cn0KY2xhc3MgVm8gZXh0ZW5kcyBIdCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBleHRydWRlIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtTaGFwZXxBcnJheTxTaGFwZT59IFtzaGFwZXNdIC0gQSBzaGFwZSBvciBhbiBhcnJheSBvZiBzaGFwZXMuCiAgICogQHBhcmFtIHtFeHRydWRlR2VvbWV0cnl+T3B0aW9uc30gW29wdGlvbnNdIC0gVGhlIGV4dHJ1ZGUgc2V0dGluZ3MuCiAgICovCiAgY29uc3RydWN0b3IodCA9IG5ldyBBcyhbbmV3IEooMC41LCAwLjUpLCBuZXcgSigtMC41LCAwLjUpLCBuZXcgSigtMC41LCAtMC41KSwgbmV3IEooMC41LCAtMC41KV0pLCBlID0ge30pIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJFeHRydWRlR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIHNoYXBlczogdCwKICAgICAgb3B0aW9uczogZQogICAgfSwgdCA9IEFycmF5LmlzQXJyYXkodCkgPyB0IDogW3RdOwogICAgY29uc3QgaSA9IHRoaXMsIG4gPSBbXSwgcyA9IFtdOwogICAgZm9yIChsZXQgbyA9IDAsIGwgPSB0Lmxlbmd0aDsgbyA8IGw7IG8rKykgewogICAgICBjb25zdCBoID0gdFtvXTsKICAgICAgcihoKTsKICAgIH0KICAgIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChuLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3dChzLCAyKSksIHRoaXMuY29tcHV0ZVZlcnRleE5vcm1hbHMoKTsKICAgIGZ1bmN0aW9uIHIobykgewogICAgICBjb25zdCBsID0gW10sIGggPSBlLmN1cnZlU2VnbWVudHMgIT09IHZvaWQgMCA/IGUuY3VydmVTZWdtZW50cyA6IDEyLCBjID0gZS5zdGVwcyAhPT0gdm9pZCAwID8gZS5zdGVwcyA6IDEsIHUgPSBlLmRlcHRoICE9PSB2b2lkIDAgPyBlLmRlcHRoIDogMTsKICAgICAgbGV0IGQgPSBlLmJldmVsRW5hYmxlZCAhPT0gdm9pZCAwID8gZS5iZXZlbEVuYWJsZWQgOiAhMCwgcCA9IGUuYmV2ZWxUaGlja25lc3MgIT09IHZvaWQgMCA/IGUuYmV2ZWxUaGlja25lc3MgOiAwLjIsIGYgPSBlLmJldmVsU2l6ZSAhPT0gdm9pZCAwID8gZS5iZXZlbFNpemUgOiBwIC0gMC4xLCB5ID0gZS5iZXZlbE9mZnNldCAhPT0gdm9pZCAwID8gZS5iZXZlbE9mZnNldCA6IDAsIGcgPSBlLmJldmVsU2VnbWVudHMgIT09IHZvaWQgMCA/IGUuYmV2ZWxTZWdtZW50cyA6IDM7CiAgICAgIGNvbnN0IG0gPSBlLmV4dHJ1ZGVQYXRoLCB2ID0gZS5VVkdlbmVyYXRvciAhPT0gdm9pZCAwID8gZS5VVkdlbmVyYXRvciA6IFBiOwogICAgICBsZXQgeCwgXyA9ICExLCBTLCB3LCBULCBSOwogICAgICBtICYmICh4ID0gbS5nZXRTcGFjZWRQb2ludHMoYyksIF8gPSAhMCwgZCA9ICExLCBTID0gbS5jb21wdXRlRnJlbmV0RnJhbWVzKGMsICExKSwgdyA9IG5ldyBFKCksIFQgPSBuZXcgRSgpLCBSID0gbmV3IEUoKSksIGQgfHwgKGcgPSAwLCBwID0gMCwgZiA9IDAsIHkgPSAwKTsKICAgICAgY29uc3QgYiA9IG8uZXh0cmFjdFBvaW50cyhoKTsKICAgICAgbGV0IE0gPSBiLnNoYXBlOwogICAgICBjb25zdCBMID0gYi5ob2xlczsKICAgICAgaWYgKCFkbi5pc0Nsb2NrV2lzZShNKSkgewogICAgICAgIE0gPSBNLnJldmVyc2UoKTsKICAgICAgICBmb3IgKGxldCBvdCA9IDAsIGl0ID0gTC5sZW5ndGg7IG90IDwgaXQ7IG90KyspIHsKICAgICAgICAgIGNvbnN0IFEgPSBMW290XTsKICAgICAgICAgIGRuLmlzQ2xvY2tXaXNlKFEpICYmIChMW290XSA9IFEucmV2ZXJzZSgpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gTyhvdCkgewogICAgICAgIGNvbnN0IFEgPSAxMDAwMDAwMDAwMDAwMDAwMWUtMzY7CiAgICAgICAgbGV0IEsgPSBvdFswXTsKICAgICAgICBmb3IgKGxldCB5dCA9IDE7IHl0IDw9IG90Lmxlbmd0aDsgeXQrKykgewogICAgICAgICAgY29uc3QgdXQgPSB5dCAlIG90Lmxlbmd0aCwgeHQgPSBvdFt1dF0sIFd0ID0geHQueCAtIEsueCwgTnQgPSB4dC55IC0gSy55LCBQID0gV3QgKiBXdCArIE50ICogTnQsIEEgPSBNYXRoLm1heCgKICAgICAgICAgICAgTWF0aC5hYnMoeHQueCksCiAgICAgICAgICAgIE1hdGguYWJzKHh0LnkpLAogICAgICAgICAgICBNYXRoLmFicyhLLngpLAogICAgICAgICAgICBNYXRoLmFicyhLLnkpCiAgICAgICAgICApLCBOID0gUSAqIEEgKiBBOwogICAgICAgICAgaWYgKFAgPD0gTikgewogICAgICAgICAgICBvdC5zcGxpY2UodXQsIDEpLCB5dC0tOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIEsgPSB4dDsKICAgICAgICB9CiAgICAgIH0KICAgICAgTyhNKSwgTC5mb3JFYWNoKE8pOwogICAgICBjb25zdCBWID0gTC5sZW5ndGgsIFcgPSBNOwogICAgICBmb3IgKGxldCBvdCA9IDA7IG90IDwgVjsgb3QrKykgewogICAgICAgIGNvbnN0IGl0ID0gTFtvdF07CiAgICAgICAgTSA9IE0uY29uY2F0KGl0KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBHKG90LCBpdCwgUSkgewogICAgICAgIHJldHVybiBpdCB8fCBjb25zb2xlLmVycm9yKCJUSFJFRS5FeHRydWRlR2VvbWV0cnk6IHZlYyBkb2VzIG5vdCBleGlzdCIpLCBvdC5jbG9uZSgpLmFkZFNjYWxlZFZlY3RvcihpdCwgUSk7CiAgICAgIH0KICAgICAgY29uc3QgZXQgPSBNLmxlbmd0aDsKICAgICAgZnVuY3Rpb24gSChvdCwgaXQsIFEpIHsKICAgICAgICBsZXQgSywgeXQsIHV0OwogICAgICAgIGNvbnN0IHh0ID0gb3QueCAtIGl0LngsIFd0ID0gb3QueSAtIGl0LnksIE50ID0gUS54IC0gb3QueCwgUCA9IFEueSAtIG90LnksIEEgPSB4dCAqIHh0ICsgV3QgKiBXdCwgTiA9IHh0ICogUCAtIFd0ICogTnQ7CiAgICAgICAgaWYgKE1hdGguYWJzKE4pID4gTnVtYmVyLkVQU0lMT04pIHsKICAgICAgICAgIGNvbnN0IFggPSBNYXRoLnNxcnQoQSksIHJ0ID0gTWF0aC5zcXJ0KE50ICogTnQgKyBQICogUCksIFogPSBpdC54IC0gV3QgLyBYLCBJdCA9IGl0LnkgKyB4dCAvIFgsIEkgPSBRLnggLSBQIC8gcnQsIGx0ID0gUS55ICsgTnQgLyBydCwgZ3QgPSAoKEkgLSBaKSAqIFAgLSAobHQgLSBJdCkgKiBOdCkgLyAoeHQgKiBQIC0gV3QgKiBOdCk7CiAgICAgICAgICBLID0gWiArIHh0ICogZ3QgLSBvdC54LCB5dCA9IEl0ICsgV3QgKiBndCAtIG90Lnk7CiAgICAgICAgICBjb25zdCBqID0gSyAqIEsgKyB5dCAqIHl0OwogICAgICAgICAgaWYgKGogPD0gMikKICAgICAgICAgICAgcmV0dXJuIG5ldyBKKEssIHl0KTsKICAgICAgICAgIHV0ID0gTWF0aC5zcXJ0KGogLyAyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGV0IFggPSAhMTsKICAgICAgICAgIHh0ID4gTnVtYmVyLkVQU0lMT04gPyBOdCA+IE51bWJlci5FUFNJTE9OICYmIChYID0gITApIDogeHQgPCAtTnVtYmVyLkVQU0lMT04gPyBOdCA8IC1OdW1iZXIuRVBTSUxPTiAmJiAoWCA9ICEwKSA6IE1hdGguc2lnbihXdCkgPT09IE1hdGguc2lnbihQKSAmJiAoWCA9ICEwKSwgWCA/IChLID0gLVd0LCB5dCA9IHh0LCB1dCA9IE1hdGguc3FydChBKSkgOiAoSyA9IHh0LCB5dCA9IFd0LCB1dCA9IE1hdGguc3FydChBIC8gMikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEooSyAvIHV0LCB5dCAvIHV0KTsKICAgICAgfQogICAgICBjb25zdCBhdCA9IFtdOwogICAgICBmb3IgKGxldCBvdCA9IDAsIGl0ID0gVy5sZW5ndGgsIFEgPSBpdCAtIDEsIEsgPSBvdCArIDE7IG90IDwgaXQ7IG90KyssIFErKywgSysrKQogICAgICAgIFEgPT09IGl0ICYmIChRID0gMCksIEsgPT09IGl0ICYmIChLID0gMCksIGF0W290XSA9IEgoV1tvdF0sIFdbUV0sIFdbS10pOwogICAgICBjb25zdCBwdCA9IFtdOwogICAgICBsZXQgTXQsIEx0ID0gYXQuY29uY2F0KCk7CiAgICAgIGZvciAobGV0IG90ID0gMCwgaXQgPSBWOyBvdCA8IGl0OyBvdCsrKSB7CiAgICAgICAgY29uc3QgUSA9IExbb3RdOwogICAgICAgIE10ID0gW107CiAgICAgICAgZm9yIChsZXQgSyA9IDAsIHl0ID0gUS5sZW5ndGgsIHV0ID0geXQgLSAxLCB4dCA9IEsgKyAxOyBLIDwgeXQ7IEsrKywgdXQrKywgeHQrKykKICAgICAgICAgIHV0ID09PSB5dCAmJiAodXQgPSAwKSwgeHQgPT09IHl0ICYmICh4dCA9IDApLCBNdFtLXSA9IEgoUVtLXSwgUVt1dF0sIFFbeHRdKTsKICAgICAgICBwdC5wdXNoKE10KSwgTHQgPSBMdC5jb25jYXQoTXQpOwogICAgICB9CiAgICAgIGxldCBqdDsKICAgICAgaWYgKGcgPT09IDApCiAgICAgICAganQgPSBkbi50cmlhbmd1bGF0ZVNoYXBlKFcsIEwpOwogICAgICBlbHNlIHsKICAgICAgICBjb25zdCBvdCA9IFtdLCBpdCA9IFtdOwogICAgICAgIGZvciAobGV0IFEgPSAwOyBRIDwgZzsgUSsrKSB7CiAgICAgICAgICBjb25zdCBLID0gUSAvIGcsIHl0ID0gcCAqIE1hdGguY29zKEsgKiBNYXRoLlBJIC8gMiksIHV0ID0gZiAqIE1hdGguc2luKEsgKiBNYXRoLlBJIC8gMikgKyB5OwogICAgICAgICAgZm9yIChsZXQgeHQgPSAwLCBXdCA9IFcubGVuZ3RoOyB4dCA8IFd0OyB4dCsrKSB7CiAgICAgICAgICAgIGNvbnN0IE50ID0gRyhXW3h0XSwgYXRbeHRdLCB1dCk7CiAgICAgICAgICAgIFV0KE50LngsIE50LnksIC15dCksIEsgPT09IDAgJiYgb3QucHVzaChOdCk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCB4dCA9IDAsIFd0ID0gVjsgeHQgPCBXdDsgeHQrKykgewogICAgICAgICAgICBjb25zdCBOdCA9IExbeHRdOwogICAgICAgICAgICBNdCA9IHB0W3h0XTsKICAgICAgICAgICAgY29uc3QgUCA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBBID0gMCwgTiA9IE50Lmxlbmd0aDsgQSA8IE47IEErKykgewogICAgICAgICAgICAgIGNvbnN0IFggPSBHKE50W0FdLCBNdFtBXSwgdXQpOwogICAgICAgICAgICAgIFV0KFgueCwgWC55LCAteXQpLCBLID09PSAwICYmIFAucHVzaChYKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBLID09PSAwICYmIGl0LnB1c2goUCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGp0ID0gZG4udHJpYW5ndWxhdGVTaGFwZShvdCwgaXQpOwogICAgICB9CiAgICAgIGNvbnN0IG5lID0ganQubGVuZ3RoLCBKdCA9IGYgKyB5OwogICAgICBmb3IgKGxldCBvdCA9IDA7IG90IDwgZXQ7IG90KyspIHsKICAgICAgICBjb25zdCBpdCA9IGQgPyBHKE1bb3RdLCBMdFtvdF0sIEp0KSA6IE1bb3RdOwogICAgICAgIF8gPyAoVC5jb3B5KFMubm9ybWFsc1swXSkubXVsdGlwbHlTY2FsYXIoaXQueCksIHcuY29weShTLmJpbm9ybWFsc1swXSkubXVsdGlwbHlTY2FsYXIoaXQueSksIFIuY29weSh4WzBdKS5hZGQoVCkuYWRkKHcpLCBVdChSLngsIFIueSwgUi56KSkgOiBVdChpdC54LCBpdC55LCAwKTsKICAgICAgfQogICAgICBmb3IgKGxldCBvdCA9IDE7IG90IDw9IGM7IG90KyspCiAgICAgICAgZm9yIChsZXQgaXQgPSAwOyBpdCA8IGV0OyBpdCsrKSB7CiAgICAgICAgICBjb25zdCBRID0gZCA/IEcoTVtpdF0sIEx0W2l0XSwgSnQpIDogTVtpdF07CiAgICAgICAgICBfID8gKFQuY29weShTLm5vcm1hbHNbb3RdKS5tdWx0aXBseVNjYWxhcihRLngpLCB3LmNvcHkoUy5iaW5vcm1hbHNbb3RdKS5tdWx0aXBseVNjYWxhcihRLnkpLCBSLmNvcHkoeFtvdF0pLmFkZChUKS5hZGQodyksIFV0KFIueCwgUi55LCBSLnopKSA6IFV0KFEueCwgUS55LCB1IC8gYyAqIG90KTsKICAgICAgICB9CiAgICAgIGZvciAobGV0IG90ID0gZyAtIDE7IG90ID49IDA7IG90LS0pIHsKICAgICAgICBjb25zdCBpdCA9IG90IC8gZywgUSA9IHAgKiBNYXRoLmNvcyhpdCAqIE1hdGguUEkgLyAyKSwgSyA9IGYgKiBNYXRoLnNpbihpdCAqIE1hdGguUEkgLyAyKSArIHk7CiAgICAgICAgZm9yIChsZXQgeXQgPSAwLCB1dCA9IFcubGVuZ3RoOyB5dCA8IHV0OyB5dCsrKSB7CiAgICAgICAgICBjb25zdCB4dCA9IEcoV1t5dF0sIGF0W3l0XSwgSyk7CiAgICAgICAgICBVdCh4dC54LCB4dC55LCB1ICsgUSk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IHl0ID0gMCwgdXQgPSBMLmxlbmd0aDsgeXQgPCB1dDsgeXQrKykgewogICAgICAgICAgY29uc3QgeHQgPSBMW3l0XTsKICAgICAgICAgIE10ID0gcHRbeXRdOwogICAgICAgICAgZm9yIChsZXQgV3QgPSAwLCBOdCA9IHh0Lmxlbmd0aDsgV3QgPCBOdDsgV3QrKykgewogICAgICAgICAgICBjb25zdCBQID0gRyh4dFtXdF0sIE10W1d0XSwgSyk7CiAgICAgICAgICAgIF8gPyBVdChQLngsIFAueSArIHhbYyAtIDFdLnksIHhbYyAtIDFdLnggKyBRKSA6IFV0KFAueCwgUC55LCB1ICsgUSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIFkoKSwgc3QoKTsKICAgICAgZnVuY3Rpb24gWSgpIHsKICAgICAgICBjb25zdCBvdCA9IG4ubGVuZ3RoIC8gMzsKICAgICAgICBpZiAoZCkgewogICAgICAgICAgbGV0IGl0ID0gMCwgUSA9IGV0ICogaXQ7CiAgICAgICAgICBmb3IgKGxldCBLID0gMDsgSyA8IG5lOyBLKyspIHsKICAgICAgICAgICAgY29uc3QgeXQgPSBqdFtLXTsKICAgICAgICAgICAgUHQoeXRbMl0gKyBRLCB5dFsxXSArIFEsIHl0WzBdICsgUSk7CiAgICAgICAgICB9CiAgICAgICAgICBpdCA9IGMgKyBnICogMiwgUSA9IGV0ICogaXQ7CiAgICAgICAgICBmb3IgKGxldCBLID0gMDsgSyA8IG5lOyBLKyspIHsKICAgICAgICAgICAgY29uc3QgeXQgPSBqdFtLXTsKICAgICAgICAgICAgUHQoeXRbMF0gKyBRLCB5dFsxXSArIFEsIHl0WzJdICsgUSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAobGV0IGl0ID0gMDsgaXQgPCBuZTsgaXQrKykgewogICAgICAgICAgICBjb25zdCBRID0ganRbaXRdOwogICAgICAgICAgICBQdChRWzJdLCBRWzFdLCBRWzBdKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAobGV0IGl0ID0gMDsgaXQgPCBuZTsgaXQrKykgewogICAgICAgICAgICBjb25zdCBRID0ganRbaXRdOwogICAgICAgICAgICBQdChRWzBdICsgZXQgKiBjLCBRWzFdICsgZXQgKiBjLCBRWzJdICsgZXQgKiBjKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaS5hZGRHcm91cChvdCwgbi5sZW5ndGggLyAzIC0gb3QsIDApOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN0KCkgewogICAgICAgIGNvbnN0IG90ID0gbi5sZW5ndGggLyAzOwogICAgICAgIGxldCBpdCA9IDA7CiAgICAgICAgRXQoVywgaXQpLCBpdCArPSBXLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBRID0gMCwgSyA9IEwubGVuZ3RoOyBRIDwgSzsgUSsrKSB7CiAgICAgICAgICBjb25zdCB5dCA9IExbUV07CiAgICAgICAgICBFdCh5dCwgaXQpLCBpdCArPSB5dC5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGkuYWRkR3JvdXAob3QsIG4ubGVuZ3RoIC8gMyAtIG90LCAxKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBFdChvdCwgaXQpIHsKICAgICAgICBsZXQgUSA9IG90Lmxlbmd0aDsKICAgICAgICBmb3IgKDsgLS1RID49IDA7ICkgewogICAgICAgICAgY29uc3QgSyA9IFE7CiAgICAgICAgICBsZXQgeXQgPSBRIC0gMTsKICAgICAgICAgIHl0IDwgMCAmJiAoeXQgPSBvdC5sZW5ndGggLSAxKTsKICAgICAgICAgIGZvciAobGV0IHV0ID0gMCwgeHQgPSBjICsgZyAqIDI7IHV0IDwgeHQ7IHV0KyspIHsKICAgICAgICAgICAgY29uc3QgV3QgPSBldCAqIHV0LCBOdCA9IGV0ICogKHV0ICsgMSksIFAgPSBpdCArIEsgKyBXdCwgQSA9IGl0ICsgeXQgKyBXdCwgTiA9IGl0ICsgeXQgKyBOdCwgWCA9IGl0ICsgSyArIE50OwogICAgICAgICAgICBLdChQLCBBLCBOLCBYKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gVXQob3QsIGl0LCBRKSB7CiAgICAgICAgbC5wdXNoKG90KSwgbC5wdXNoKGl0KSwgbC5wdXNoKFEpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIFB0KG90LCBpdCwgUSkgewogICAgICAgIGhlKG90KSwgaGUoaXQpLCBoZShRKTsKICAgICAgICBjb25zdCBLID0gbi5sZW5ndGggLyAzLCB5dCA9IHYuZ2VuZXJhdGVUb3BVVihpLCBuLCBLIC0gMywgSyAtIDIsIEsgLSAxKTsKICAgICAgICBEKHl0WzBdKSwgRCh5dFsxXSksIEQoeXRbMl0pOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIEt0KG90LCBpdCwgUSwgSykgewogICAgICAgIGhlKG90KSwgaGUoaXQpLCBoZShLKSwgaGUoaXQpLCBoZShRKSwgaGUoSyk7CiAgICAgICAgY29uc3QgeXQgPSBuLmxlbmd0aCAvIDMsIHV0ID0gdi5nZW5lcmF0ZVNpZGVXYWxsVVYoaSwgbiwgeXQgLSA2LCB5dCAtIDMsIHl0IC0gMiwgeXQgLSAxKTsKICAgICAgICBEKHV0WzBdKSwgRCh1dFsxXSksIEQodXRbM10pLCBEKHV0WzFdKSwgRCh1dFsyXSksIEQodXRbM10pOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGhlKG90KSB7CiAgICAgICAgbi5wdXNoKGxbb3QgKiAzICsgMF0pLCBuLnB1c2gobFtvdCAqIDMgKyAxXSksIG4ucHVzaChsW290ICogMyArIDJdKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBEKG90KSB7CiAgICAgICAgcy5wdXNoKG90LngpLCBzLnB1c2gob3QueSk7CiAgICAgIH0KICAgIH0KICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgdC5wYXJhbWV0ZXJzKSwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpLCBlID0gdGhpcy5wYXJhbWV0ZXJzLnNoYXBlcywgaSA9IHRoaXMucGFyYW1ldGVycy5vcHRpb25zOwogICAgcmV0dXJuIEliKGUsIGksIHQpOwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcGFyYW0ge0FycmF5PFNoYXBlPn0gc2hhcGVzIC0gQW4gYXJyYXkgb2Ygc2hhcGVzLgogICAqIEByZXR1cm4ge0V4dHJ1ZGVHZW9tZXRyeX0gQSBuZXcgaW5zdGFuY2UuCiAgICovCiAgc3RhdGljIGZyb21KU09OKHQsIGUpIHsKICAgIGNvbnN0IGkgPSBbXTsKICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5zaGFwZXMubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgIGNvbnN0IG8gPSBlW3Quc2hhcGVzW3NdXTsKICAgICAgaS5wdXNoKG8pOwogICAgfQogICAgY29uc3QgbiA9IHQub3B0aW9ucy5leHRydWRlUGF0aDsKICAgIHJldHVybiBuICE9PSB2b2lkIDAgJiYgKHQub3B0aW9ucy5leHRydWRlUGF0aCA9IG5ldyBfY1tuLnR5cGVdKCkuZnJvbUpTT04obikpLCBuZXcgVm8oaSwgdC5vcHRpb25zKTsKICB9Cn0KY29uc3QgUGIgPSB7CiAgZ2VuZXJhdGVUb3BVVjogZnVuY3Rpb24oYSwgdCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IHRbZSAqIDNdLCByID0gdFtlICogMyArIDFdLCBvID0gdFtpICogM10sIGwgPSB0W2kgKiAzICsgMV0sIGggPSB0W24gKiAzXSwgYyA9IHRbbiAqIDMgKyAxXTsKICAgIHJldHVybiBbCiAgICAgIG5ldyBKKHMsIHIpLAogICAgICBuZXcgSihvLCBsKSwKICAgICAgbmV3IEooaCwgYykKICAgIF07CiAgfSwKICBnZW5lcmF0ZVNpZGVXYWxsVVY6IGZ1bmN0aW9uKGEsIHQsIGUsIGksIG4sIHMpIHsKICAgIGNvbnN0IHIgPSB0W2UgKiAzXSwgbyA9IHRbZSAqIDMgKyAxXSwgbCA9IHRbZSAqIDMgKyAyXSwgaCA9IHRbaSAqIDNdLCBjID0gdFtpICogMyArIDFdLCB1ID0gdFtpICogMyArIDJdLCBkID0gdFtuICogM10sIHAgPSB0W24gKiAzICsgMV0sIGYgPSB0W24gKiAzICsgMl0sIHkgPSB0W3MgKiAzXSwgZyA9IHRbcyAqIDMgKyAxXSwgbSA9IHRbcyAqIDMgKyAyXTsKICAgIHJldHVybiBNYXRoLmFicyhvIC0gYykgPCBNYXRoLmFicyhyIC0gaCkgPyBbCiAgICAgIG5ldyBKKHIsIDEgLSBsKSwKICAgICAgbmV3IEooaCwgMSAtIHUpLAogICAgICBuZXcgSihkLCAxIC0gZiksCiAgICAgIG5ldyBKKHksIDEgLSBtKQogICAgXSA6IFsKICAgICAgbmV3IEoobywgMSAtIGwpLAogICAgICBuZXcgSihjLCAxIC0gdSksCiAgICAgIG5ldyBKKHAsIDEgLSBmKSwKICAgICAgbmV3IEooZywgMSAtIG0pCiAgICBdOwogIH0KfTsKZnVuY3Rpb24gSWIoYSwgdCwgZSkgewogIGlmIChlLnNoYXBlcyA9IFtdLCBBcnJheS5pc0FycmF5KGEpKQogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBhLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCBzID0gYVtpXTsKICAgICAgZS5zaGFwZXMucHVzaChzLnV1aWQpOwogICAgfQogIGVsc2UKICAgIGUuc2hhcGVzLnB1c2goYS51dWlkKTsKICByZXR1cm4gZS5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdCksIHQuZXh0cnVkZVBhdGggIT09IHZvaWQgMCAmJiAoZS5vcHRpb25zLmV4dHJ1ZGVQYXRoID0gdC5leHRydWRlUGF0aC50b0pTT04oKSksIGU7Cn0KY2xhc3MgUWMgZXh0ZW5kcyBMcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBpY29zYWhlZHJvbiBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzPTFdIC0gUmFkaXVzIG9mIHRoZSBpY29zYWhlZHJvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RldGFpbD0wXSAtIFNldHRpbmcgdGhpcyB0byBhIHZhbHVlIGdyZWF0ZXIgdGhhbiBgMGAgYWRkcyB2ZXJ0aWNlcyBtYWtpbmcgaXQgbm8gbG9uZ2VyIGEgaWNvc2FoZWRyb24uCiAgICovCiAgY29uc3RydWN0b3IodCA9IDEsIGUgPSAwKSB7CiAgICBjb25zdCBpID0gKDEgKyBNYXRoLnNxcnQoNSkpIC8gMiwgbiA9IFsKICAgICAgLTEsCiAgICAgIGksCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIGksCiAgICAgIDAsCiAgICAgIC0xLAogICAgICAtaSwKICAgICAgMCwKICAgICAgMSwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIC0xLAogICAgICBpLAogICAgICAwLAogICAgICAxLAogICAgICBpLAogICAgICAwLAogICAgICAtMSwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIC1pLAogICAgICBpLAogICAgICAwLAogICAgICAtMSwKICAgICAgaSwKICAgICAgMCwKICAgICAgMSwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIC0xLAogICAgICAtaSwKICAgICAgMCwKICAgICAgMQogICAgXSwgcyA9IFsKICAgICAgMCwKICAgICAgMTEsCiAgICAgIDUsCiAgICAgIDAsCiAgICAgIDUsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDcsCiAgICAgIDAsCiAgICAgIDcsCiAgICAgIDEwLAogICAgICAwLAogICAgICAxMCwKICAgICAgMTEsCiAgICAgIDEsCiAgICAgIDUsCiAgICAgIDksCiAgICAgIDUsCiAgICAgIDExLAogICAgICA0LAogICAgICAxMSwKICAgICAgMTAsCiAgICAgIDIsCiAgICAgIDEwLAogICAgICA3LAogICAgICA2LAogICAgICA3LAogICAgICAxLAogICAgICA4LAogICAgICAzLAogICAgICA5LAogICAgICA0LAogICAgICAzLAogICAgICA0LAogICAgICAyLAogICAgICAzLAogICAgICAyLAogICAgICA2LAogICAgICAzLAogICAgICA2LAogICAgICA4LAogICAgICAzLAogICAgICA4LAogICAgICA5LAogICAgICA0LAogICAgICA5LAogICAgICA1LAogICAgICAyLAogICAgICA0LAogICAgICAxMSwKICAgICAgNiwKICAgICAgMiwKICAgICAgMTAsCiAgICAgIDgsCiAgICAgIDYsCiAgICAgIDcsCiAgICAgIDksCiAgICAgIDgsCiAgICAgIDEKICAgIF07CiAgICBzdXBlcihuLCBzLCB0LCBlKSwgdGhpcy50eXBlID0gIkljb3NhaGVkcm9uR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIHJhZGl1czogdCwKICAgICAgZGV0YWlsOiBlCiAgICB9OwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtJY29zYWhlZHJvbkdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBRYyh0LnJhZGl1cywgdC5kZXRhaWwpOwogIH0KfQpjbGFzcyB0dSBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxhdGhlIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxWZWN0b3IyfFZlY3RvcjM+fSBbcG9pbnRzXSAtIEFuIGFycmF5IG9mIHBvaW50cyBpbiAyRCBzcGFjZS4gVGhlIHgtY29vcmRpbmF0ZSBvZiBlYWNoIHBvaW50CiAgICogbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4KICAgKiBAcGFyYW0ge251bWJlcn0gW3NlZ21lbnRzPTEyXSAtIFRoZSBudW1iZXIgb2YgY2lyY3VtZmVyZW5jZSBzZWdtZW50cyB0byBnZW5lcmF0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3BoaVN0YXJ0PTBdIC0gVGhlIHN0YXJ0aW5nIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtwaGlMZW5ndGg9TWF0aC5QSSoyXSAtIFRoZSByYWRpYW4gKDAgdG8gMlBJKSByYW5nZSBvZiB0aGUgbGF0aGVkIHNlY3Rpb24gMlBJIGlzIGEKICAgKiBjbG9zZWQgbGF0aGUsIGxlc3MgdGhhbiAyUEkgaXMgYSBwb3J0aW9uLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBbbmV3IEooMCwgLTAuNSksIG5ldyBKKDAuNSwgMCksIG5ldyBKKDAsIDAuNSldLCBlID0gMTIsIGkgPSAwLCBuID0gTWF0aC5QSSAqIDIpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJMYXRoZUdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICBwb2ludHM6IHQsCiAgICAgIHNlZ21lbnRzOiBlLAogICAgICBwaGlTdGFydDogaSwKICAgICAgcGhpTGVuZ3RoOiBuCiAgICB9LCBlID0gTWF0aC5mbG9vcihlKSwgbiA9IGt0KG4sIDAsIE1hdGguUEkgKiAyKTsKICAgIGNvbnN0IHMgPSBbXSwgciA9IFtdLCBvID0gW10sIGwgPSBbXSwgaCA9IFtdLCBjID0gMSAvIGUsIHUgPSBuZXcgRSgpLCBkID0gbmV3IEooKSwgcCA9IG5ldyBFKCksIGYgPSBuZXcgRSgpLCB5ID0gbmV3IEUoKTsKICAgIGxldCBnID0gMCwgbSA9IDA7CiAgICBmb3IgKGxldCB2ID0gMDsgdiA8PSB0Lmxlbmd0aCAtIDE7IHYrKykKICAgICAgc3dpdGNoICh2KSB7CiAgICAgICAgY2FzZSAwOgogICAgICAgICAgZyA9IHRbdiArIDFdLnggLSB0W3ZdLngsIG0gPSB0W3YgKyAxXS55IC0gdFt2XS55LCBwLnggPSBtICogMSwgcC55ID0gLWcsIHAueiA9IG0gKiAwLCB5LmNvcHkocCksIHAubm9ybWFsaXplKCksIGwucHVzaChwLngsIHAueSwgcC56KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgdC5sZW5ndGggLSAxOgogICAgICAgICAgbC5wdXNoKHkueCwgeS55LCB5LnopOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGcgPSB0W3YgKyAxXS54IC0gdFt2XS54LCBtID0gdFt2ICsgMV0ueSAtIHRbdl0ueSwgcC54ID0gbSAqIDEsIHAueSA9IC1nLCBwLnogPSBtICogMCwgZi5jb3B5KHApLCBwLnggKz0geS54LCBwLnkgKz0geS55LCBwLnogKz0geS56LCBwLm5vcm1hbGl6ZSgpLCBsLnB1c2gocC54LCBwLnksIHAueiksIHkuY29weShmKTsKICAgICAgfQogICAgZm9yIChsZXQgdiA9IDA7IHYgPD0gZTsgdisrKSB7CiAgICAgIGNvbnN0IHggPSBpICsgdiAqIGMgKiBuLCBfID0gTWF0aC5zaW4oeCksIFMgPSBNYXRoLmNvcyh4KTsKICAgICAgZm9yIChsZXQgdyA9IDA7IHcgPD0gdC5sZW5ndGggLSAxOyB3KyspIHsKICAgICAgICB1LnggPSB0W3ddLnggKiBfLCB1LnkgPSB0W3ddLnksIHUueiA9IHRbd10ueCAqIFMsIHIucHVzaCh1LngsIHUueSwgdS56KSwgZC54ID0gdiAvIGUsIGQueSA9IHcgLyAodC5sZW5ndGggLSAxKSwgby5wdXNoKGQueCwgZC55KTsKICAgICAgICBjb25zdCBUID0gbFszICogdyArIDBdICogXywgUiA9IGxbMyAqIHcgKyAxXSwgYiA9IGxbMyAqIHcgKyAwXSAqIFM7CiAgICAgICAgaC5wdXNoKFQsIFIsIGIpOwogICAgICB9CiAgICB9CiAgICBmb3IgKGxldCB2ID0gMDsgdiA8IGU7IHYrKykKICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0Lmxlbmd0aCAtIDE7IHgrKykgewogICAgICAgIGNvbnN0IF8gPSB4ICsgdiAqIHQubGVuZ3RoLCBTID0gXywgdyA9IF8gKyB0Lmxlbmd0aCwgVCA9IF8gKyB0Lmxlbmd0aCArIDEsIFIgPSBfICsgMTsKICAgICAgICBzLnB1c2goUywgdywgUiksIHMucHVzaChULCBSLCB3KTsKICAgICAgfQogICAgdGhpcy5zZXRJbmRleChzKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KHIsIDMpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInV2IiwgbmV3IHd0KG8sIDIpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIG5ldyB3dChoLCAzKSk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge0xhdGhlR2VvbWV0cnl9IEEgbmV3IGluc3RhbmNlLgogICAqLwogIHN0YXRpYyBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gbmV3IHR1KHQucG9pbnRzLCB0LnNlZ21lbnRzLCB0LnBoaVN0YXJ0LCB0LnBoaUxlbmd0aCk7CiAgfQp9CmNsYXNzIEhvIGV4dGVuZHMgTHMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgb2N0YWhlZHJvbiBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzPTFdIC0gUmFkaXVzIG9mIHRoZSBvY3RhaGVkcm9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGV0YWlsPTBdIC0gU2V0dGluZyB0aGlzIHRvIGEgdmFsdWUgZ3JlYXRlciB0aGFuIGAwYCBhZGRzIHZlcnRpY2VzIG1ha2luZyBpdCBubyBsb25nZXIgYSBvY3RhaGVkcm9uLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMCkgewogICAgY29uc3QgaSA9IFsKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgLTEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIC0xLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAtMQogICAgXSwgbiA9IFsKICAgICAgMCwKICAgICAgMiwKICAgICAgNCwKICAgICAgMCwKICAgICAgNCwKICAgICAgMywKICAgICAgMCwKICAgICAgMywKICAgICAgNSwKICAgICAgMCwKICAgICAgNSwKICAgICAgMiwKICAgICAgMSwKICAgICAgMiwKICAgICAgNSwKICAgICAgMSwKICAgICAgNSwKICAgICAgMywKICAgICAgMSwKICAgICAgMywKICAgICAgNCwKICAgICAgMSwKICAgICAgNCwKICAgICAgMgogICAgXTsKICAgIHN1cGVyKGksIG4sIHQsIGUpLCB0aGlzLnR5cGUgPSAiT2N0YWhlZHJvbkdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICByYWRpdXM6IHQsCiAgICAgIGRldGFpbDogZQogICAgfTsKICB9CiAgLyoqCiAgICogRmFjdG9yeSBtZXRob2QgZm9yIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mIHRoaXMgY2xhc3MgZnJvbSB0aGUgZ2l2ZW4KICAgKiBKU09OIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIC0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgZ2VvbWV0cnkuCiAgICogQHJldHVybiB7T2N0YWhlZHJvbkdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBIbyh0LnJhZGl1cywgdC5kZXRhaWwpOwogIH0KfQpjbGFzcyBEcyBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHBsYW5lIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0xXSAtIFRoZSB3aWR0aCBhbG9uZyB0aGUgWCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTFdIC0gVGhlIGhlaWdodCBhbG9uZyB0aGUgWSBheGlzCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aFNlZ21lbnRzPTFdIC0gVGhlIG51bWJlciBvZiBzZWdtZW50cyBhbG9uZyB0aGUgWCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0U2VnbWVudHM9MV0gLSBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIGFsb25nIHRoZSBZIGF4aXMuCiAgICovCiAgY29uc3RydWN0b3IodCA9IDEsIGUgPSAxLCBpID0gMSwgbiA9IDEpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJQbGFuZUdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICB3aWR0aDogdCwKICAgICAgaGVpZ2h0OiBlLAogICAgICB3aWR0aFNlZ21lbnRzOiBpLAogICAgICBoZWlnaHRTZWdtZW50czogbgogICAgfTsKICAgIGNvbnN0IHMgPSB0IC8gMiwgciA9IGUgLyAyLCBvID0gTWF0aC5mbG9vcihpKSwgbCA9IE1hdGguZmxvb3IobiksIGggPSBvICsgMSwgYyA9IGwgKyAxLCB1ID0gdCAvIG8sIGQgPSBlIC8gbCwgcCA9IFtdLCBmID0gW10sIHkgPSBbXSwgZyA9IFtdOwogICAgZm9yIChsZXQgbSA9IDA7IG0gPCBjOyBtKyspIHsKICAgICAgY29uc3QgdiA9IG0gKiBkIC0gcjsKICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBoOyB4KyspIHsKICAgICAgICBjb25zdCBfID0geCAqIHUgLSBzOwogICAgICAgIGYucHVzaChfLCAtdiwgMCksIHkucHVzaCgwLCAwLCAxKSwgZy5wdXNoKHggLyBvKSwgZy5wdXNoKDEgLSBtIC8gbCk7CiAgICAgIH0KICAgIH0KICAgIGZvciAobGV0IG0gPSAwOyBtIDwgbDsgbSsrKQogICAgICBmb3IgKGxldCB2ID0gMDsgdiA8IG87IHYrKykgewogICAgICAgIGNvbnN0IHggPSB2ICsgaCAqIG0sIF8gPSB2ICsgaCAqIChtICsgMSksIFMgPSB2ICsgMSArIGggKiAobSArIDEpLCB3ID0gdiArIDEgKyBoICogbTsKICAgICAgICBwLnB1c2goeCwgXywgdyksIHAucHVzaChfLCBTLCB3KTsKICAgICAgfQogICAgdGhpcy5zZXRJbmRleChwKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KGYsIDMpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIG5ldyB3dCh5LCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3dChnLCAyKSk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge1BsYW5lR2VvbWV0cnl9IEEgbmV3IGluc3RhbmNlLgogICAqLwogIHN0YXRpYyBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gbmV3IERzKHQud2lkdGgsIHQuaGVpZ2h0LCB0LndpZHRoU2VnbWVudHMsIHQuaGVpZ2h0U2VnbWVudHMpOwogIH0KfQpjbGFzcyBldSBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHJpbmcgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW2lubmVyUmFkaXVzPTAuNV0gLSBUaGUgaW5uZXIgcmFkaXVzIG9mIHRoZSByaW5nLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb3V0ZXJSYWRpdXM9MV0gLSBUaGUgb3V0ZXIgcmFkaXVzIG9mIHRoZSByaW5nLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGFTZWdtZW50cz0zMl0gLSBOdW1iZXIgb2Ygc2VnbWVudHMuIEEgaGlnaGVyIG51bWJlciBtZWFucyB0aGUgcmluZyB3aWxsIGJlIG1vcmUgcm91bmQuIE1pbmltdW0gaXMgYDNgLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcGhpU2VnbWVudHM9MV0gLSBOdW1iZXIgb2Ygc2VnbWVudHMgcGVyIHJpbmcgc2VnbWVudC4gTWluaW11bSBpcyBgMWAuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aGV0YVN0YXJ0PTBdIC0gU3RhcnRpbmcgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3RoZXRhTGVuZ3RoPU1hdGguUEkqMl0gLSBDZW50cmFsIGFuZ2xlIGluIHJhZGlhbnMuCiAgICovCiAgY29uc3RydWN0b3IodCA9IDAuNSwgZSA9IDEsIGkgPSAzMiwgbiA9IDEsIHMgPSAwLCByID0gTWF0aC5QSSAqIDIpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJSaW5nR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIGlubmVyUmFkaXVzOiB0LAogICAgICBvdXRlclJhZGl1czogZSwKICAgICAgdGhldGFTZWdtZW50czogaSwKICAgICAgcGhpU2VnbWVudHM6IG4sCiAgICAgIHRoZXRhU3RhcnQ6IHMsCiAgICAgIHRoZXRhTGVuZ3RoOiByCiAgICB9LCBpID0gTWF0aC5tYXgoMywgaSksIG4gPSBNYXRoLm1heCgxLCBuKTsKICAgIGNvbnN0IG8gPSBbXSwgbCA9IFtdLCBoID0gW10sIGMgPSBbXTsKICAgIGxldCB1ID0gdDsKICAgIGNvbnN0IGQgPSAoZSAtIHQpIC8gbiwgcCA9IG5ldyBFKCksIGYgPSBuZXcgSigpOwogICAgZm9yIChsZXQgeSA9IDA7IHkgPD0gbjsgeSsrKSB7CiAgICAgIGZvciAobGV0IGcgPSAwOyBnIDw9IGk7IGcrKykgewogICAgICAgIGNvbnN0IG0gPSBzICsgZyAvIGkgKiByOwogICAgICAgIHAueCA9IHUgKiBNYXRoLmNvcyhtKSwgcC55ID0gdSAqIE1hdGguc2luKG0pLCBsLnB1c2gocC54LCBwLnksIHAueiksIGgucHVzaCgwLCAwLCAxKSwgZi54ID0gKHAueCAvIGUgKyAxKSAvIDIsIGYueSA9IChwLnkgLyBlICsgMSkgLyAyLCBjLnB1c2goZi54LCBmLnkpOwogICAgICB9CiAgICAgIHUgKz0gZDsKICAgIH0KICAgIGZvciAobGV0IHkgPSAwOyB5IDwgbjsgeSsrKSB7CiAgICAgIGNvbnN0IGcgPSB5ICogKGkgKyAxKTsKICAgICAgZm9yIChsZXQgbSA9IDA7IG0gPCBpOyBtKyspIHsKICAgICAgICBjb25zdCB2ID0gbSArIGcsIHggPSB2LCBfID0gdiArIGkgKyAxLCBTID0gdiArIGkgKyAyLCB3ID0gdiArIDE7CiAgICAgICAgby5wdXNoKHgsIF8sIHcpLCBvLnB1c2goXywgUywgdyk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuc2V0SW5kZXgobyksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChsLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3QoaCwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QoYywgMikpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LnBhcmFtZXRlcnMpLCB0aGlzOwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtSaW5nR2VvbWV0cnl9IEEgbmV3IGluc3RhbmNlLgogICAqLwogIHN0YXRpYyBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gbmV3IGV1KHQuaW5uZXJSYWRpdXMsIHQub3V0ZXJSYWRpdXMsIHQudGhldGFTZWdtZW50cywgdC5waGlTZWdtZW50cywgdC50aGV0YVN0YXJ0LCB0LnRoZXRhTGVuZ3RoKTsKICB9Cn0KY2xhc3MgR28gZXh0ZW5kcyBIdCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBzaGFwZSBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7U2hhcGV8QXJyYXk8U2hhcGU+fSBbc2hhcGVzXSAtIEEgc2hhcGUgb3IgYW4gYXJyYXkgb2Ygc2hhcGVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbY3VydmVTZWdtZW50cz0xMl0gLSBOdW1iZXIgb2Ygc2VnbWVudHMgcGVyIHNoYXBlLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgQXMoW25ldyBKKDAsIDAuNSksIG5ldyBKKC0wLjUsIC0wLjUpLCBuZXcgSigwLjUsIC0wLjUpXSksIGUgPSAxMikgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIlNoYXBlR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIHNoYXBlczogdCwKICAgICAgY3VydmVTZWdtZW50czogZQogICAgfTsKICAgIGNvbnN0IGkgPSBbXSwgbiA9IFtdLCBzID0gW10sIHIgPSBbXTsKICAgIGxldCBvID0gMCwgbCA9IDA7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0KSA9PT0gITEpCiAgICAgIGgodCk7CiAgICBlbHNlCiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgdC5sZW5ndGg7IGMrKykKICAgICAgICBoKHRbY10pLCB0aGlzLmFkZEdyb3VwKG8sIGwsIGMpLCBvICs9IGwsIGwgPSAwOwogICAgdGhpcy5zZXRJbmRleChpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KG4sIDMpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIG5ldyB3dChzLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3dChyLCAyKSk7CiAgICBmdW5jdGlvbiBoKGMpIHsKICAgICAgY29uc3QgdSA9IG4ubGVuZ3RoIC8gMywgZCA9IGMuZXh0cmFjdFBvaW50cyhlKTsKICAgICAgbGV0IHAgPSBkLnNoYXBlOwogICAgICBjb25zdCBmID0gZC5ob2xlczsKICAgICAgZG4uaXNDbG9ja1dpc2UocCkgPT09ICExICYmIChwID0gcC5yZXZlcnNlKCkpOwogICAgICBmb3IgKGxldCBnID0gMCwgbSA9IGYubGVuZ3RoOyBnIDwgbTsgZysrKSB7CiAgICAgICAgY29uc3QgdiA9IGZbZ107CiAgICAgICAgZG4uaXNDbG9ja1dpc2UodikgPT09ICEwICYmIChmW2ddID0gdi5yZXZlcnNlKCkpOwogICAgICB9CiAgICAgIGNvbnN0IHkgPSBkbi50cmlhbmd1bGF0ZVNoYXBlKHAsIGYpOwogICAgICBmb3IgKGxldCBnID0gMCwgbSA9IGYubGVuZ3RoOyBnIDwgbTsgZysrKSB7CiAgICAgICAgY29uc3QgdiA9IGZbZ107CiAgICAgICAgcCA9IHAuY29uY2F0KHYpOwogICAgICB9CiAgICAgIGZvciAobGV0IGcgPSAwLCBtID0gcC5sZW5ndGg7IGcgPCBtOyBnKyspIHsKICAgICAgICBjb25zdCB2ID0gcFtnXTsKICAgICAgICBuLnB1c2godi54LCB2LnksIDApLCBzLnB1c2goMCwgMCwgMSksIHIucHVzaCh2LngsIHYueSk7CiAgICAgIH0KICAgICAgZm9yIChsZXQgZyA9IDAsIG0gPSB5Lmxlbmd0aDsgZyA8IG07IGcrKykgewogICAgICAgIGNvbnN0IHYgPSB5W2ddLCB4ID0gdlswXSArIHUsIF8gPSB2WzFdICsgdSwgUyA9IHZbMl0gKyB1OwogICAgICAgIGkucHVzaCh4LCBfLCBTKSwgbCArPSAzOwogICAgICB9CiAgICB9CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSBzdXBlci50b0pTT04oKSwgZSA9IHRoaXMucGFyYW1ldGVycy5zaGFwZXM7CiAgICByZXR1cm4gTGIoZSwgdCk7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7QXJyYXk8U2hhcGU+fSBzaGFwZXMgLSBBbiBhcnJheSBvZiBzaGFwZXMuCiAgICogQHJldHVybiB7U2hhcGVHZW9tZXRyeX0gQSBuZXcgaW5zdGFuY2UuCiAgICovCiAgc3RhdGljIGZyb21KU09OKHQsIGUpIHsKICAgIGNvbnN0IGkgPSBbXTsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gdC5zaGFwZXMubGVuZ3RoOyBuIDwgczsgbisrKSB7CiAgICAgIGNvbnN0IHIgPSBlW3Quc2hhcGVzW25dXTsKICAgICAgaS5wdXNoKHIpOwogICAgfQogICAgcmV0dXJuIG5ldyBHbyhpLCB0LmN1cnZlU2VnbWVudHMpOwogIH0KfQpmdW5jdGlvbiBMYihhLCB0KSB7CiAgaWYgKHQuc2hhcGVzID0gW10sIEFycmF5LmlzQXJyYXkoYSkpCiAgICBmb3IgKGxldCBlID0gMCwgaSA9IGEubGVuZ3RoOyBlIDwgaTsgZSsrKSB7CiAgICAgIGNvbnN0IG4gPSBhW2VdOwogICAgICB0LnNoYXBlcy5wdXNoKG4udXVpZCk7CiAgICB9CiAgZWxzZQogICAgdC5zaGFwZXMucHVzaChhLnV1aWQpOwogIHJldHVybiB0Owp9CmNsYXNzIFJhIGV4dGVuZHMgSHQgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc3BoZXJlIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpdXM9MV0gLSBUaGUgc3BoZXJlIHJhZGl1cy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoU2VnbWVudHM9MzJdIC0gVGhlIG51bWJlciBvZiBob3Jpem9udGFsIHNlZ21lbnRzLiBNaW5pbXVtIHZhbHVlIGlzIGAzYC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodFNlZ21lbnRzPTE2XSAtIFRoZSBudW1iZXIgb2YgdmVydGljYWwgc2VnbWVudHMuIE1pbmltdW0gdmFsdWUgaXMgYDJgLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcGhpU3RhcnQ9MF0gLSBUaGUgaG9yaXpvbnRhbCBzdGFydGluZyBhbmdsZSBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcGhpTGVuZ3RoPU1hdGguUEkqMl0gLSBUaGUgaG9yaXpvbnRhbCBzd2VlcCBhbmdsZSBzaXplLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGFTdGFydD0wXSAtIFRoZSB2ZXJ0aWNhbCBzdGFydGluZyBhbmdsZSBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGFMZW5ndGg9TWF0aC5QSV0gLSBUaGUgdmVydGljYWwgc3dlZXAgYW5nbGUgc2l6ZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMSwgZSA9IDMyLCBpID0gMTYsIG4gPSAwLCBzID0gTWF0aC5QSSAqIDIsIHIgPSAwLCBvID0gTWF0aC5QSSkgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIlNwaGVyZUdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICByYWRpdXM6IHQsCiAgICAgIHdpZHRoU2VnbWVudHM6IGUsCiAgICAgIGhlaWdodFNlZ21lbnRzOiBpLAogICAgICBwaGlTdGFydDogbiwKICAgICAgcGhpTGVuZ3RoOiBzLAogICAgICB0aGV0YVN0YXJ0OiByLAogICAgICB0aGV0YUxlbmd0aDogbwogICAgfSwgZSA9IE1hdGgubWF4KDMsIE1hdGguZmxvb3IoZSkpLCBpID0gTWF0aC5tYXgoMiwgTWF0aC5mbG9vcihpKSk7CiAgICBjb25zdCBsID0gTWF0aC5taW4ociArIG8sIE1hdGguUEkpOwogICAgbGV0IGggPSAwOwogICAgY29uc3QgYyA9IFtdLCB1ID0gbmV3IEUoKSwgZCA9IG5ldyBFKCksIHAgPSBbXSwgZiA9IFtdLCB5ID0gW10sIGcgPSBbXTsKICAgIGZvciAobGV0IG0gPSAwOyBtIDw9IGk7IG0rKykgewogICAgICBjb25zdCB2ID0gW10sIHggPSBtIC8gaTsKICAgICAgbGV0IF8gPSAwOwogICAgICBtID09PSAwICYmIHIgPT09IDAgPyBfID0gMC41IC8gZSA6IG0gPT09IGkgJiYgbCA9PT0gTWF0aC5QSSAmJiAoXyA9IC0wLjUgLyBlKTsKICAgICAgZm9yIChsZXQgUyA9IDA7IFMgPD0gZTsgUysrKSB7CiAgICAgICAgY29uc3QgdyA9IFMgLyBlOwogICAgICAgIHUueCA9IC10ICogTWF0aC5jb3MobiArIHcgKiBzKSAqIE1hdGguc2luKHIgKyB4ICogbyksIHUueSA9IHQgKiBNYXRoLmNvcyhyICsgeCAqIG8pLCB1LnogPSB0ICogTWF0aC5zaW4obiArIHcgKiBzKSAqIE1hdGguc2luKHIgKyB4ICogbyksIGYucHVzaCh1LngsIHUueSwgdS56KSwgZC5jb3B5KHUpLm5vcm1hbGl6ZSgpLCB5LnB1c2goZC54LCBkLnksIGQueiksIGcucHVzaCh3ICsgXywgMSAtIHgpLCB2LnB1c2goaCsrKTsKICAgICAgfQogICAgICBjLnB1c2godik7CiAgICB9CiAgICBmb3IgKGxldCBtID0gMDsgbSA8IGk7IG0rKykKICAgICAgZm9yIChsZXQgdiA9IDA7IHYgPCBlOyB2KyspIHsKICAgICAgICBjb25zdCB4ID0gY1ttXVt2ICsgMV0sIF8gPSBjW21dW3ZdLCBTID0gY1ttICsgMV1bdl0sIHcgPSBjW20gKyAxXVt2ICsgMV07CiAgICAgICAgKG0gIT09IDAgfHwgciA+IDApICYmIHAucHVzaCh4LCBfLCB3KSwgKG0gIT09IGkgLSAxIHx8IGwgPCBNYXRoLlBJKSAmJiBwLnB1c2goXywgUywgdyk7CiAgICAgIH0KICAgIHRoaXMuc2V0SW5kZXgocCksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChmLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3QoeSwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QoZywgMikpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LnBhcmFtZXRlcnMpLCB0aGlzOwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtTcGhlcmVHZW9tZXRyeX0gQSBuZXcgaW5zdGFuY2UuCiAgICovCiAgc3RhdGljIGZyb21KU09OKHQpIHsKICAgIHJldHVybiBuZXcgUmEodC5yYWRpdXMsIHQud2lkdGhTZWdtZW50cywgdC5oZWlnaHRTZWdtZW50cywgdC5waGlTdGFydCwgdC5waGlMZW5ndGgsIHQudGhldGFTdGFydCwgdC50aGV0YUxlbmd0aCk7CiAgfQp9CmNsYXNzIGl1IGV4dGVuZHMgTHMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgdGV0cmFoZWRyb24gZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0xXSAtIFJhZGl1cyBvZiB0aGUgdGV0cmFoZWRyb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkZXRhaWw9MF0gLSBTZXR0aW5nIHRoaXMgdG8gYSB2YWx1ZSBncmVhdGVyIHRoYW4gYDBgIGFkZHMgdmVydGljZXMgbWFraW5nIGl0IG5vIGxvbmdlciBhIHRldHJhaGVkcm9uLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMCkgewogICAgY29uc3QgaSA9IFsKICAgICAgMSwKICAgICAgMSwKICAgICAgMSwKICAgICAgLTEsCiAgICAgIC0xLAogICAgICAxLAogICAgICAtMSwKICAgICAgMSwKICAgICAgLTEsCiAgICAgIDEsCiAgICAgIC0xLAogICAgICAtMQogICAgXSwgbiA9IFsKICAgICAgMiwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMywKICAgICAgMiwKICAgICAgMSwKICAgICAgMywKICAgICAgMCwKICAgICAgMiwKICAgICAgMywKICAgICAgMQogICAgXTsKICAgIHN1cGVyKGksIG4sIHQsIGUpLCB0aGlzLnR5cGUgPSAiVGV0cmFoZWRyb25HZW9tZXRyeSIsIHRoaXMucGFyYW1ldGVycyA9IHsKICAgICAgcmFkaXVzOiB0LAogICAgICBkZXRhaWw6IGUKICAgIH07CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge1RldHJhaGVkcm9uR2VvbWV0cnl9IEEgbmV3IGluc3RhbmNlLgogICAqLwogIHN0YXRpYyBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gbmV3IGl1KHQucmFkaXVzLCB0LmRldGFpbCk7CiAgfQp9CmNsYXNzIG51IGV4dGVuZHMgSHQgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgdG9ydXMgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0xXSAtIFJhZGl1cyBvZiB0aGUgdG9ydXMsIGZyb20gdGhlIGNlbnRlciBvZiB0aGUgdG9ydXMgdG8gdGhlIGNlbnRlciBvZiB0aGUgdHViZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R1YmU9MC40XSAtIFJhZGl1cyBvZiB0aGUgdHViZS4gTXVzdCBiZSBzbWFsbGVyIHRoYW4gYHJhZGl1c2AuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpYWxTZWdtZW50cz0xMl0gLSBUaGUgbnVtYmVyIG9mIHJhZGlhbCBzZWdtZW50cy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R1YnVsYXJTZWdtZW50cz00OF0gLSBUaGUgbnVtYmVyIG9mIHR1YnVsYXIgc2VnbWVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFthcmM9TWF0aC5QSSoyXSAtIENlbnRyYWwgYW5nbGUgaW4gcmFkaWFucy4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMSwgZSA9IDAuNCwgaSA9IDEyLCBuID0gNDgsIHMgPSBNYXRoLlBJICogMikgewogICAgc3VwZXIoKSwgdGhpcy50eXBlID0gIlRvcnVzR2VvbWV0cnkiLCB0aGlzLnBhcmFtZXRlcnMgPSB7CiAgICAgIHJhZGl1czogdCwKICAgICAgdHViZTogZSwKICAgICAgcmFkaWFsU2VnbWVudHM6IGksCiAgICAgIHR1YnVsYXJTZWdtZW50czogbiwKICAgICAgYXJjOiBzCiAgICB9LCBpID0gTWF0aC5mbG9vcihpKSwgbiA9IE1hdGguZmxvb3Iobik7CiAgICBjb25zdCByID0gW10sIG8gPSBbXSwgbCA9IFtdLCBoID0gW10sIGMgPSBuZXcgRSgpLCB1ID0gbmV3IEUoKSwgZCA9IG5ldyBFKCk7CiAgICBmb3IgKGxldCBwID0gMDsgcCA8PSBpOyBwKyspCiAgICAgIGZvciAobGV0IGYgPSAwOyBmIDw9IG47IGYrKykgewogICAgICAgIGNvbnN0IHkgPSBmIC8gbiAqIHMsIGcgPSBwIC8gaSAqIE1hdGguUEkgKiAyOwogICAgICAgIHUueCA9ICh0ICsgZSAqIE1hdGguY29zKGcpKSAqIE1hdGguY29zKHkpLCB1LnkgPSAodCArIGUgKiBNYXRoLmNvcyhnKSkgKiBNYXRoLnNpbih5KSwgdS56ID0gZSAqIE1hdGguc2luKGcpLCBvLnB1c2godS54LCB1LnksIHUueiksIGMueCA9IHQgKiBNYXRoLmNvcyh5KSwgYy55ID0gdCAqIE1hdGguc2luKHkpLCBkLnN1YlZlY3RvcnModSwgYykubm9ybWFsaXplKCksIGwucHVzaChkLngsIGQueSwgZC56KSwgaC5wdXNoKGYgLyBuKSwgaC5wdXNoKHAgLyBpKTsKICAgICAgfQogICAgZm9yIChsZXQgcCA9IDE7IHAgPD0gaTsgcCsrKQogICAgICBmb3IgKGxldCBmID0gMTsgZiA8PSBuOyBmKyspIHsKICAgICAgICBjb25zdCB5ID0gKG4gKyAxKSAqIHAgKyBmIC0gMSwgZyA9IChuICsgMSkgKiAocCAtIDEpICsgZiAtIDEsIG0gPSAobiArIDEpICogKHAgLSAxKSArIGYsIHYgPSAobiArIDEpICogcCArIGY7CiAgICAgICAgci5wdXNoKHksIGcsIHYpLCByLnB1c2goZywgbSwgdik7CiAgICAgIH0KICAgIHRoaXMuc2V0SW5kZXgociksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChvLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3QobCwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QoaCwgMikpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LnBhcmFtZXRlcnMpLCB0aGlzOwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtUb3J1c0dlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBudSh0LnJhZGl1cywgdC50dWJlLCB0LnJhZGlhbFNlZ21lbnRzLCB0LnR1YnVsYXJTZWdtZW50cywgdC5hcmMpOwogIH0KfQpjbGFzcyBzdSBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHRvcnVzIGtub3QgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0xXSAtIFJhZGl1cyBvZiB0aGUgdG9ydXMga25vdC4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R1YmU9MC40XSAtIFJhZGl1cyBvZiB0aGUgdHViZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R1YnVsYXJTZWdtZW50cz02NF0gLSBUaGUgbnVtYmVyIG9mIHR1YnVsYXIgc2VnbWVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpYWxTZWdtZW50cz04XSAtIFRoZSBudW1iZXIgb2YgcmFkaWFsIHNlZ21lbnRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcD0yXSAtIFRoaXMgdmFsdWUgZGV0ZXJtaW5lcywgaG93IG1hbnkgdGltZXMgdGhlIGdlb21ldHJ5IHdpbmRzIGFyb3VuZCBpdHMgYXhpcyBvZiByb3RhdGlvbmFsIHN5bW1ldHJ5LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcT0zXSAtIFRoaXMgdmFsdWUgZGV0ZXJtaW5lcywgaG93IG1hbnkgdGltZXMgdGhlIGdlb21ldHJ5IHdpbmRzIGFyb3VuZCBhIGNpcmNsZSBpbiB0aGUgaW50ZXJpb3Igb2YgdGhlIHRvcnVzLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMC40LCBpID0gNjQsIG4gPSA4LCBzID0gMiwgciA9IDMpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJUb3J1c0tub3RHZW9tZXRyeSIsIHRoaXMucGFyYW1ldGVycyA9IHsKICAgICAgcmFkaXVzOiB0LAogICAgICB0dWJlOiBlLAogICAgICB0dWJ1bGFyU2VnbWVudHM6IGksCiAgICAgIHJhZGlhbFNlZ21lbnRzOiBuLAogICAgICBwOiBzLAogICAgICBxOiByCiAgICB9LCBpID0gTWF0aC5mbG9vcihpKSwgbiA9IE1hdGguZmxvb3Iobik7CiAgICBjb25zdCBvID0gW10sIGwgPSBbXSwgaCA9IFtdLCBjID0gW10sIHUgPSBuZXcgRSgpLCBkID0gbmV3IEUoKSwgcCA9IG5ldyBFKCksIGYgPSBuZXcgRSgpLCB5ID0gbmV3IEUoKSwgZyA9IG5ldyBFKCksIG0gPSBuZXcgRSgpOwogICAgZm9yIChsZXQgeCA9IDA7IHggPD0gaTsgKyt4KSB7CiAgICAgIGNvbnN0IF8gPSB4IC8gaSAqIHMgKiBNYXRoLlBJICogMjsKICAgICAgdihfLCBzLCByLCB0LCBwKSwgdihfICsgMC4wMSwgcywgciwgdCwgZiksIGcuc3ViVmVjdG9ycyhmLCBwKSwgbS5hZGRWZWN0b3JzKGYsIHApLCB5LmNyb3NzVmVjdG9ycyhnLCBtKSwgbS5jcm9zc1ZlY3RvcnMoeSwgZyksIHkubm9ybWFsaXplKCksIG0ubm9ybWFsaXplKCk7CiAgICAgIGZvciAobGV0IFMgPSAwOyBTIDw9IG47ICsrUykgewogICAgICAgIGNvbnN0IHcgPSBTIC8gbiAqIE1hdGguUEkgKiAyLCBUID0gLWUgKiBNYXRoLmNvcyh3KSwgUiA9IGUgKiBNYXRoLnNpbih3KTsKICAgICAgICB1LnggPSBwLnggKyAoVCAqIG0ueCArIFIgKiB5LngpLCB1LnkgPSBwLnkgKyAoVCAqIG0ueSArIFIgKiB5LnkpLCB1LnogPSBwLnogKyAoVCAqIG0ueiArIFIgKiB5LnopLCBsLnB1c2godS54LCB1LnksIHUueiksIGQuc3ViVmVjdG9ycyh1LCBwKS5ub3JtYWxpemUoKSwgaC5wdXNoKGQueCwgZC55LCBkLnopLCBjLnB1c2goeCAvIGkpLCBjLnB1c2goUyAvIG4pOwogICAgICB9CiAgICB9CiAgICBmb3IgKGxldCB4ID0gMTsgeCA8PSBpOyB4KyspCiAgICAgIGZvciAobGV0IF8gPSAxOyBfIDw9IG47IF8rKykgewogICAgICAgIGNvbnN0IFMgPSAobiArIDEpICogKHggLSAxKSArIChfIC0gMSksIHcgPSAobiArIDEpICogeCArIChfIC0gMSksIFQgPSAobiArIDEpICogeCArIF8sIFIgPSAobiArIDEpICogKHggLSAxKSArIF87CiAgICAgICAgby5wdXNoKFMsIHcsIFIpLCBvLnB1c2godywgVCwgUik7CiAgICAgIH0KICAgIHRoaXMuc2V0SW5kZXgobyksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChsLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJub3JtYWwiLCBuZXcgd3QoaCwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QoYywgMikpOwogICAgZnVuY3Rpb24gdih4LCBfLCBTLCB3LCBUKSB7CiAgICAgIGNvbnN0IFIgPSBNYXRoLmNvcyh4KSwgYiA9IE1hdGguc2luKHgpLCBNID0gUyAvIF8gKiB4LCBMID0gTWF0aC5jb3MoTSk7CiAgICAgIFQueCA9IHcgKiAoMiArIEwpICogMC41ICogUiwgVC55ID0gdyAqICgyICsgTCkgKiBiICogMC41LCBULnogPSB3ICogTWF0aC5zaW4oTSkgKiAwLjU7CiAgICB9CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBpbnN0YW5jZSBvZiB0aGlzIGNsYXNzIGZyb20gdGhlIGdpdmVuCiAgICogSlNPTiBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIGdlb21ldHJ5LgogICAqIEByZXR1cm4ge1RvcnVzS25vdEdlb21ldHJ5fSBBIG5ldyBpbnN0YW5jZS4KICAgKi8KICBzdGF0aWMgZnJvbUpTT04odCkgewogICAgcmV0dXJuIG5ldyBzdSh0LnJhZGl1cywgdC50dWJlLCB0LnR1YnVsYXJTZWdtZW50cywgdC5yYWRpYWxTZWdtZW50cywgdC5wLCB0LnEpOwogIH0KfQpjbGFzcyBydSBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHR1YmUgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge0N1cnZlfSBbcGF0aD1RdWFkcmF0aWNCZXppZXJDdXJ2ZTNdIC0gQSAzRCBjdXJ2ZSBkZWZpbmluZyB0aGUgcGF0aCBvZiB0aGUgdHViZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R1YnVsYXJTZWdtZW50cz02NF0gLSBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIHRoYXQgbWFrZSB1cCB0aGUgdHViZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl1cz0xXSAtVGhlIHJhZGl1cyBvZiB0aGUgdHViZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGlhbFNlZ21lbnRzPThdIC0gVGhlIG51bWJlciBvZiBzZWdtZW50cyB0aGF0IG1ha2UgdXAgdGhlIGNyb3NzLXNlY3Rpb24uCiAgICogQHBhcmFtIHtib29sZWFufSBbY2xvc2VkPWZhbHNlXSAtIFdoZXRoZXIgdGhlIHR1YmUgaXMgY2xvc2VkIG9yIG5vdC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbmV3IFhwKG5ldyBFKC0xLCAtMSwgMCksIG5ldyBFKC0xLCAxLCAwKSwgbmV3IEUoMSwgMSwgMCkpLCBlID0gNjQsIGkgPSAxLCBuID0gOCwgcyA9ICExKSB7CiAgICBzdXBlcigpLCB0aGlzLnR5cGUgPSAiVHViZUdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICBwYXRoOiB0LAogICAgICB0dWJ1bGFyU2VnbWVudHM6IGUsCiAgICAgIHJhZGl1czogaSwKICAgICAgcmFkaWFsU2VnbWVudHM6IG4sCiAgICAgIGNsb3NlZDogcwogICAgfTsKICAgIGNvbnN0IHIgPSB0LmNvbXB1dGVGcmVuZXRGcmFtZXMoZSwgcyk7CiAgICB0aGlzLnRhbmdlbnRzID0gci50YW5nZW50cywgdGhpcy5ub3JtYWxzID0gci5ub3JtYWxzLCB0aGlzLmJpbm9ybWFscyA9IHIuYmlub3JtYWxzOwogICAgY29uc3QgbyA9IG5ldyBFKCksIGwgPSBuZXcgRSgpLCBoID0gbmV3IEooKTsKICAgIGxldCBjID0gbmV3IEUoKTsKICAgIGNvbnN0IHUgPSBbXSwgZCA9IFtdLCBwID0gW10sIGYgPSBbXTsKICAgIHkoKSwgdGhpcy5zZXRJbmRleChmKSwgdGhpcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KHUsIDMpKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIG5ldyB3dChkLCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3dChwLCAyKSk7CiAgICBmdW5jdGlvbiB5KCkgewogICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGU7IHgrKykKICAgICAgICBnKHgpOwogICAgICBnKHMgPT09ICExID8gZSA6IDApLCB2KCksIG0oKTsKICAgIH0KICAgIGZ1bmN0aW9uIGcoeCkgewogICAgICBjID0gdC5nZXRQb2ludEF0KHggLyBlLCBjKTsKICAgICAgY29uc3QgXyA9IHIubm9ybWFsc1t4XSwgUyA9IHIuYmlub3JtYWxzW3hdOwogICAgICBmb3IgKGxldCB3ID0gMDsgdyA8PSBuOyB3KyspIHsKICAgICAgICBjb25zdCBUID0gdyAvIG4gKiBNYXRoLlBJICogMiwgUiA9IE1hdGguc2luKFQpLCBiID0gLU1hdGguY29zKFQpOwogICAgICAgIGwueCA9IGIgKiBfLnggKyBSICogUy54LCBsLnkgPSBiICogXy55ICsgUiAqIFMueSwgbC56ID0gYiAqIF8ueiArIFIgKiBTLnosIGwubm9ybWFsaXplKCksIGQucHVzaChsLngsIGwueSwgbC56KSwgby54ID0gYy54ICsgaSAqIGwueCwgby55ID0gYy55ICsgaSAqIGwueSwgby56ID0gYy56ICsgaSAqIGwueiwgdS5wdXNoKG8ueCwgby55LCBvLnopOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBtKCkgewogICAgICBmb3IgKGxldCB4ID0gMTsgeCA8PSBlOyB4KyspCiAgICAgICAgZm9yIChsZXQgXyA9IDE7IF8gPD0gbjsgXysrKSB7CiAgICAgICAgICBjb25zdCBTID0gKG4gKyAxKSAqICh4IC0gMSkgKyAoXyAtIDEpLCB3ID0gKG4gKyAxKSAqIHggKyAoXyAtIDEpLCBUID0gKG4gKyAxKSAqIHggKyBfLCBSID0gKG4gKyAxKSAqICh4IC0gMSkgKyBfOwogICAgICAgICAgZi5wdXNoKFMsIHcsIFIpLCBmLnB1c2godywgVCwgUik7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gdigpIHsKICAgICAgZm9yIChsZXQgeCA9IDA7IHggPD0gZTsgeCsrKQogICAgICAgIGZvciAobGV0IF8gPSAwOyBfIDw9IG47IF8rKykKICAgICAgICAgIGgueCA9IHggLyBlLCBoLnkgPSBfIC8gbiwgcC5wdXNoKGgueCwgaC55KTsKICAgIH0KICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgdC5wYXJhbWV0ZXJzKSwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgcmV0dXJuIHQucGF0aCA9IHRoaXMucGFyYW1ldGVycy5wYXRoLnRvSlNPTigpLCB0OwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYW4gaW5zdGFuY2Ugb2YgdGhpcyBjbGFzcyBmcm9tIHRoZSBnaXZlbgogICAqIEpTT04gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtUdWJlR2VvbWV0cnl9IEEgbmV3IGluc3RhbmNlLgogICAqLwogIHN0YXRpYyBmcm9tSlNPTih0KSB7CiAgICByZXR1cm4gbmV3IHJ1KAogICAgICBuZXcgX2NbdC5wYXRoLnR5cGVdKCkuZnJvbUpTT04odC5wYXRoKSwKICAgICAgdC50dWJ1bGFyU2VnbWVudHMsCiAgICAgIHQucmFkaXVzLAogICAgICB0LnJhZGlhbFNlZ21lbnRzLAogICAgICB0LmNsb3NlZAogICAgKTsKICB9Cn0KbGV0IFpwID0gY2xhc3MgZXh0ZW5kcyBIdCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyB3aXJlZnJhbWUgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0gez9CdWZmZXJHZW9tZXRyeX0gW2dlb21ldHJ5PW51bGxdIC0gVGhlIGdlb21ldHJ5LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBudWxsKSB7CiAgICBpZiAoc3VwZXIoKSwgdGhpcy50eXBlID0gIldpcmVmcmFtZUdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICBnZW9tZXRyeTogdAogICAgfSwgdCAhPT0gbnVsbCkgewogICAgICBjb25zdCBlID0gW10sIGkgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLCBuID0gbmV3IEUoKSwgcyA9IG5ldyBFKCk7CiAgICAgIGlmICh0LmluZGV4ICE9PSBudWxsKSB7CiAgICAgICAgY29uc3QgciA9IHQuYXR0cmlidXRlcy5wb3NpdGlvbiwgbyA9IHQuaW5kZXg7CiAgICAgICAgbGV0IGwgPSB0Lmdyb3VwczsKICAgICAgICBsLmxlbmd0aCA9PT0gMCAmJiAobCA9IFt7IHN0YXJ0OiAwLCBjb3VudDogby5jb3VudCwgbWF0ZXJpYWxJbmRleDogMCB9XSk7CiAgICAgICAgZm9yIChsZXQgaCA9IDAsIGMgPSBsLmxlbmd0aDsgaCA8IGM7ICsraCkgewogICAgICAgICAgY29uc3QgdSA9IGxbaF0sIGQgPSB1LnN0YXJ0LCBwID0gdS5jb3VudDsKICAgICAgICAgIGZvciAobGV0IGYgPSBkLCB5ID0gZCArIHA7IGYgPCB5OyBmICs9IDMpCiAgICAgICAgICAgIGZvciAobGV0IGcgPSAwOyBnIDwgMzsgZysrKSB7CiAgICAgICAgICAgICAgY29uc3QgbSA9IG8uZ2V0WChmICsgZyksIHYgPSBvLmdldFgoZiArIChnICsgMSkgJSAzKTsKICAgICAgICAgICAgICBuLmZyb21CdWZmZXJBdHRyaWJ1dGUociwgbSksIHMuZnJvbUJ1ZmZlckF0dHJpYnV0ZShyLCB2KSwgeW0obiwgcywgaSkgPT09ICEwICYmIChlLnB1c2gobi54LCBuLnksIG4ueiksIGUucHVzaChzLngsIHMueSwgcy56KSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgciA9IHQuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICBmb3IgKGxldCBvID0gMCwgbCA9IHIuY291bnQgLyAzOyBvIDwgbDsgbysrKQogICAgICAgICAgZm9yIChsZXQgaCA9IDA7IGggPCAzOyBoKyspIHsKICAgICAgICAgICAgY29uc3QgYyA9IDMgKiBvICsgaCwgdSA9IDMgKiBvICsgKGggKyAxKSAlIDM7CiAgICAgICAgICAgIG4uZnJvbUJ1ZmZlckF0dHJpYnV0ZShyLCBjKSwgcy5mcm9tQnVmZmVyQXR0cmlidXRlKHIsIHUpLCB5bShuLCBzLCBpKSA9PT0gITAgJiYgKGUucHVzaChuLngsIG4ueSwgbi56KSwgZS5wdXNoKHMueCwgcy55LCBzLnopKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QoZSwgMykpOwogICAgfQogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCB0LnBhcmFtZXRlcnMpLCB0aGlzOwogIH0KfTsKZnVuY3Rpb24geW0oYSwgdCwgZSkgewogIGNvbnN0IGkgPSBgJHthLnh9LCR7YS55fSwke2Euen0tJHt0Lnh9LCR7dC55fSwke3Quen1gLCBuID0gYCR7dC54fSwke3QueX0sJHt0Lnp9LSR7YS54fSwke2EueX0sJHthLnp9YDsKICByZXR1cm4gZS5oYXMoaSkgPT09ICEwIHx8IGUuaGFzKG4pID09PSAhMCA/ICExIDogKGUuYWRkKGkpLCBlLmFkZChuKSwgITApOwp9CnZhciBfbSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuZnJlZXplKHsKICBfX3Byb3RvX186IG51bGwsCiAgQm94R2VvbWV0cnk6IG1yLAogIENhcHN1bGVHZW9tZXRyeTogWmMsCiAgQ2lyY2xlR2VvbWV0cnk6IGpjLAogIENvbmVHZW9tZXRyeTogQ2EsCiAgQ3lsaW5kZXJHZW9tZXRyeTogVGEsCiAgRG9kZWNhaGVkcm9uR2VvbWV0cnk6IEpjLAogIEVkZ2VzR2VvbWV0cnk6IEJ5LAogIEV4dHJ1ZGVHZW9tZXRyeTogVm8sCiAgSWNvc2FoZWRyb25HZW9tZXRyeTogUWMsCiAgTGF0aGVHZW9tZXRyeTogdHUsCiAgT2N0YWhlZHJvbkdlb21ldHJ5OiBIbywKICBQbGFuZUdlb21ldHJ5OiBEcywKICBQb2x5aGVkcm9uR2VvbWV0cnk6IExzLAogIFJpbmdHZW9tZXRyeTogZXUsCiAgU2hhcGVHZW9tZXRyeTogR28sCiAgU3BoZXJlR2VvbWV0cnk6IFJhLAogIFRldHJhaGVkcm9uR2VvbWV0cnk6IGl1LAogIFRvcnVzR2VvbWV0cnk6IG51LAogIFRvcnVzS25vdEdlb21ldHJ5OiBzdSwKICBUdWJlR2VvbWV0cnk6IHJ1LAogIFdpcmVmcmFtZUdlb21ldHJ5OiBacAp9KTsKY2xhc3MgJHkgZXh0ZW5kcyBoaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBzaGFkb3cgbWF0ZXJpYWwuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtZXRlcnNdIC0gQW4gb2JqZWN0IHdpdGggb25lIG9yIG1vcmUgcHJvcGVydGllcwogICAqIGRlZmluaW5nIHRoZSBtYXRlcmlhbCdzIGFwcGVhcmFuY2UuIEFueSBwcm9wZXJ0eSBvZiB0aGUgbWF0ZXJpYWwKICAgKiAoaW5jbHVkaW5nIGFueSBwcm9wZXJ0eSBmcm9tIGluaGVyaXRlZCBtYXRlcmlhbHMpIGNhbiBiZSBwYXNzZWQKICAgKiBpbiBoZXJlLiBDb2xvciB2YWx1ZXMgY2FuIGJlIHBhc3NlZCBhbnkgdHlwZSBvZiB2YWx1ZSBhY2NlcHRlZAogICAqIGJ5IHtAbGluayBDb2xvciNzZXR9LgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNTaGFkb3dNYXRlcmlhbCA9ICEwLCB0aGlzLnR5cGUgPSAiU2hhZG93TWF0ZXJpYWwiLCB0aGlzLmNvbG9yID0gbmV3IGN0KDApLCB0aGlzLnRyYW5zcGFyZW50ID0gITAsIHRoaXMuZm9nID0gITAsIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmNvbG9yLmNvcHkodC5jb2xvciksIHRoaXMuZm9nID0gdC5mb2csIHRoaXM7CiAgfQp9CmNsYXNzIFh5IGV4dGVuZHMgWGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgcmF3IHNoYWRlciBtYXRlcmlhbC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIodCksIHRoaXMuaXNSYXdTaGFkZXJNYXRlcmlhbCA9ICEwLCB0aGlzLnR5cGUgPSAiUmF3U2hhZGVyTWF0ZXJpYWwiOwogIH0KfQpsZXQgaHIgPSBjbGFzcyBleHRlbmRzIGhpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IG1lc2ggc3RhbmRhcmQgbWF0ZXJpYWwuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtZXRlcnNdIC0gQW4gb2JqZWN0IHdpdGggb25lIG9yIG1vcmUgcHJvcGVydGllcwogICAqIGRlZmluaW5nIHRoZSBtYXRlcmlhbCdzIGFwcGVhcmFuY2UuIEFueSBwcm9wZXJ0eSBvZiB0aGUgbWF0ZXJpYWwKICAgKiAoaW5jbHVkaW5nIGFueSBwcm9wZXJ0eSBmcm9tIGluaGVyaXRlZCBtYXRlcmlhbHMpIGNhbiBiZSBwYXNzZWQKICAgKiBpbiBoZXJlLiBDb2xvciB2YWx1ZXMgY2FuIGJlIHBhc3NlZCBhbnkgdHlwZSBvZiB2YWx1ZSBhY2NlcHRlZAogICAqIGJ5IHtAbGluayBDb2xvciNzZXR9LgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNNZXNoU3RhbmRhcmRNYXRlcmlhbCA9ICEwLCB0aGlzLnR5cGUgPSAiTWVzaFN0YW5kYXJkTWF0ZXJpYWwiLCB0aGlzLmRlZmluZXMgPSB7IFNUQU5EQVJEOiAiIiB9LCB0aGlzLmNvbG9yID0gbmV3IGN0KDE2Nzc3MjE1KSwgdGhpcy5yb3VnaG5lc3MgPSAxLCB0aGlzLm1ldGFsbmVzcyA9IDAsIHRoaXMubWFwID0gbnVsbCwgdGhpcy5saWdodE1hcCA9IG51bGwsIHRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSAxLCB0aGlzLmFvTWFwID0gbnVsbCwgdGhpcy5hb01hcEludGVuc2l0eSA9IDEsIHRoaXMuZW1pc3NpdmUgPSBuZXcgY3QoMCksIHRoaXMuZW1pc3NpdmVJbnRlbnNpdHkgPSAxLCB0aGlzLmVtaXNzaXZlTWFwID0gbnVsbCwgdGhpcy5idW1wTWFwID0gbnVsbCwgdGhpcy5idW1wU2NhbGUgPSAxLCB0aGlzLm5vcm1hbE1hcCA9IG51bGwsIHRoaXMubm9ybWFsTWFwVHlwZSA9IElzLCB0aGlzLm5vcm1hbFNjYWxlID0gbmV3IEooMSwgMSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gbnVsbCwgdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IDEsIHRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDAsIHRoaXMucm91Z2huZXNzTWFwID0gbnVsbCwgdGhpcy5tZXRhbG5lc3NNYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5lbnZNYXAgPSBudWxsLCB0aGlzLmVudk1hcFJvdGF0aW9uID0gbmV3IGZuKCksIHRoaXMuZW52TWFwSW50ZW5zaXR5ID0gMSwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAicm91bmQiLCB0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gInJvdW5kIiwgdGhpcy5mbGF0U2hhZGluZyA9ICExLCB0aGlzLmZvZyA9ICEwLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5kZWZpbmVzID0geyBTVEFOREFSRDogIiIgfSwgdGhpcy5jb2xvci5jb3B5KHQuY29sb3IpLCB0aGlzLnJvdWdobmVzcyA9IHQucm91Z2huZXNzLCB0aGlzLm1ldGFsbmVzcyA9IHQubWV0YWxuZXNzLCB0aGlzLm1hcCA9IHQubWFwLCB0aGlzLmxpZ2h0TWFwID0gdC5saWdodE1hcCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHQubGlnaHRNYXBJbnRlbnNpdHksIHRoaXMuYW9NYXAgPSB0LmFvTWFwLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gdC5hb01hcEludGVuc2l0eSwgdGhpcy5lbWlzc2l2ZS5jb3B5KHQuZW1pc3NpdmUpLCB0aGlzLmVtaXNzaXZlTWFwID0gdC5lbWlzc2l2ZU1hcCwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IHQuZW1pc3NpdmVJbnRlbnNpdHksIHRoaXMuYnVtcE1hcCA9IHQuYnVtcE1hcCwgdGhpcy5idW1wU2NhbGUgPSB0LmJ1bXBTY2FsZSwgdGhpcy5ub3JtYWxNYXAgPSB0Lm5vcm1hbE1hcCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gdC5ub3JtYWxNYXBUeXBlLCB0aGlzLm5vcm1hbFNjYWxlLmNvcHkodC5ub3JtYWxTY2FsZSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gdC5kaXNwbGFjZW1lbnRNYXAsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSB0LmRpc3BsYWNlbWVudEJpYXMsIHRoaXMucm91Z2huZXNzTWFwID0gdC5yb3VnaG5lc3NNYXAsIHRoaXMubWV0YWxuZXNzTWFwID0gdC5tZXRhbG5lc3NNYXAsIHRoaXMuYWxwaGFNYXAgPSB0LmFscGhhTWFwLCB0aGlzLmVudk1hcCA9IHQuZW52TWFwLCB0aGlzLmVudk1hcFJvdGF0aW9uLmNvcHkodC5lbnZNYXBSb3RhdGlvbiksIHRoaXMuZW52TWFwSW50ZW5zaXR5ID0gdC5lbnZNYXBJbnRlbnNpdHksIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHQud2lyZWZyYW1lTGluZWNhcCwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHQud2lyZWZyYW1lTGluZWpvaW4sIHRoaXMuZmxhdFNoYWRpbmcgPSB0LmZsYXRTaGFkaW5nLCB0aGlzLmZvZyA9IHQuZm9nLCB0aGlzOwogIH0KfTsKY2xhc3MgWXkgZXh0ZW5kcyBociB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBtZXNoIHBoeXNpY2FsIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbWV0ZXJzXSAtIEFuIG9iamVjdCB3aXRoIG9uZSBvciBtb3JlIHByb3BlcnRpZXMKICAgKiBkZWZpbmluZyB0aGUgbWF0ZXJpYWwncyBhcHBlYXJhbmNlLiBBbnkgcHJvcGVydHkgb2YgdGhlIG1hdGVyaWFsCiAgICogKGluY2x1ZGluZyBhbnkgcHJvcGVydHkgZnJvbSBpbmhlcml0ZWQgbWF0ZXJpYWxzKSBjYW4gYmUgcGFzc2VkCiAgICogaW4gaGVyZS4gQ29sb3IgdmFsdWVzIGNhbiBiZSBwYXNzZWQgYW55IHR5cGUgb2YgdmFsdWUgYWNjZXB0ZWQKICAgKiBieSB7QGxpbmsgQ29sb3Ijc2V0fS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaFBoeXNpY2FsTWF0ZXJpYWwgPSAhMCwgdGhpcy5kZWZpbmVzID0gewogICAgICBTVEFOREFSRDogIiIsCiAgICAgIFBIWVNJQ0FMOiAiIgogICAgfSwgdGhpcy50eXBlID0gIk1lc2hQaHlzaWNhbE1hdGVyaWFsIiwgdGhpcy5hbmlzb3Ryb3B5Um90YXRpb24gPSAwLCB0aGlzLmFuaXNvdHJvcHlNYXAgPSBudWxsLCB0aGlzLmNsZWFyY29hdE1hcCA9IG51bGwsIHRoaXMuY2xlYXJjb2F0Um91Z2huZXNzID0gMCwgdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgPSBudWxsLCB0aGlzLmNsZWFyY29hdE5vcm1hbFNjYWxlID0gbmV3IEooMSwgMSksIHRoaXMuY2xlYXJjb2F0Tm9ybWFsTWFwID0gbnVsbCwgdGhpcy5pb3IgPSAxLjUsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAicmVmbGVjdGl2aXR5IiwgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBrdCgyLjUgKiAodGhpcy5pb3IgLSAxKSAvICh0aGlzLmlvciArIDEpLCAwLCAxKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5pb3IgPSAoMSArIDAuNCAqIGUpIC8gKDEgLSAwLjQgKiBlKTsKICAgICAgfQogICAgfSksIHRoaXMuaXJpZGVzY2VuY2VNYXAgPSBudWxsLCB0aGlzLmlyaWRlc2NlbmNlSU9SID0gMS4zLCB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UgPSBbMTAwLCA0MDBdLCB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwID0gbnVsbCwgdGhpcy5zaGVlbkNvbG9yID0gbmV3IGN0KDApLCB0aGlzLnNoZWVuQ29sb3JNYXAgPSBudWxsLCB0aGlzLnNoZWVuUm91Z2huZXNzID0gMSwgdGhpcy5zaGVlblJvdWdobmVzc01hcCA9IG51bGwsIHRoaXMudHJhbnNtaXNzaW9uTWFwID0gbnVsbCwgdGhpcy50aGlja25lc3MgPSAwLCB0aGlzLnRoaWNrbmVzc01hcCA9IG51bGwsIHRoaXMuYXR0ZW51YXRpb25EaXN0YW5jZSA9IDEgLyAwLCB0aGlzLmF0dGVudWF0aW9uQ29sb3IgPSBuZXcgY3QoMSwgMSwgMSksIHRoaXMuc3BlY3VsYXJJbnRlbnNpdHkgPSAxLCB0aGlzLnNwZWN1bGFySW50ZW5zaXR5TWFwID0gbnVsbCwgdGhpcy5zcGVjdWxhckNvbG9yID0gbmV3IGN0KDEsIDEsIDEpLCB0aGlzLnNwZWN1bGFyQ29sb3JNYXAgPSBudWxsLCB0aGlzLl9hbmlzb3Ryb3B5ID0gMCwgdGhpcy5fY2xlYXJjb2F0ID0gMCwgdGhpcy5fZGlzcGVyc2lvbiA9IDAsIHRoaXMuX2lyaWRlc2NlbmNlID0gMCwgdGhpcy5fc2hlZW4gPSAwLCB0aGlzLl90cmFuc21pc3Npb24gPSAwLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgLyoqCiAgICogVGhlIGFuaXNvdHJvcHkgc3RyZW5ndGguCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgYW5pc290cm9weSgpIHsKICAgIHJldHVybiB0aGlzLl9hbmlzb3Ryb3B5OwogIH0KICBzZXQgYW5pc290cm9weSh0KSB7CiAgICB0aGlzLl9hbmlzb3Ryb3B5ID4gMCAhPSB0ID4gMCAmJiB0aGlzLnZlcnNpb24rKywgdGhpcy5fYW5pc290cm9weSA9IHQ7CiAgfQogIC8qKgogICAqIFJlcHJlc2VudHMgdGhlIGludGVuc2l0eSBvZiB0aGUgY2xlYXIgY29hdCBsYXllciwgZnJvbSBgMC4wYCB0byBgMS4wYC4gVXNlCiAgICogY2xlYXIgY29hdCByZWxhdGVkIHByb3BlcnRpZXMgdG8gZW5hYmxlIG11bHRpbGF5ZXIgbWF0ZXJpYWxzIHRoYXQgaGF2ZSBhCiAgICogdGhpbiB0cmFuc2x1Y2VudCBsYXllciBvdmVyIHRoZSBiYXNlIGxheWVyLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IGNsZWFyY29hdCgpIHsKICAgIHJldHVybiB0aGlzLl9jbGVhcmNvYXQ7CiAgfQogIHNldCBjbGVhcmNvYXQodCkgewogICAgdGhpcy5fY2xlYXJjb2F0ID4gMCAhPSB0ID4gMCAmJiB0aGlzLnZlcnNpb24rKywgdGhpcy5fY2xlYXJjb2F0ID0gdDsKICB9CiAgLyoqCiAgICogVGhlIGludGVuc2l0eSBvZiB0aGUgaXJpZGVzY2VuY2UgbGF5ZXIsIHNpbXVsYXRpbmcgUkdCIGNvbG9yIHNoaWZ0IGJhc2VkIG9uIHRoZSBhbmdsZSBiZXR3ZWVuCiAgICogdGhlIHN1cmZhY2UgYW5kIHRoZSB2aWV3ZXIsIGZyb20gYDAuMGAgdG8gYDEuMGAuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgaXJpZGVzY2VuY2UoKSB7CiAgICByZXR1cm4gdGhpcy5faXJpZGVzY2VuY2U7CiAgfQogIHNldCBpcmlkZXNjZW5jZSh0KSB7CiAgICB0aGlzLl9pcmlkZXNjZW5jZSA+IDAgIT0gdCA+IDAgJiYgdGhpcy52ZXJzaW9uKyssIHRoaXMuX2lyaWRlc2NlbmNlID0gdDsKICB9CiAgLyoqCiAgICogRGVmaW5lcyB0aGUgc3RyZW5ndGggb2YgdGhlIGFuZ3VsYXIgc2VwYXJhdGlvbiBvZiBjb2xvcnMgKGNocm9tYXRpYyBhYmVycmF0aW9uKSB0cmFuc21pdHRpbmcKICAgKiB0aHJvdWdoIGEgcmVsYXRpdmVseSBjbGVhciB2b2x1bWUuIEFueSB2YWx1ZSB6ZXJvIG9yIGxhcmdlciBpcyB2YWxpZCwgdGhlIHR5cGljYWwgcmFuZ2Ugb2YKICAgKiByZWFsaXN0aWMgdmFsdWVzIGlzIGBbMCwgMV1gLiBUaGlzIHByb3BlcnR5IGNhbiBiZSBvbmx5IGJlIHVzZWQgd2l0aCB0cmFuc21pc3NpdmUgb2JqZWN0cy4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMAogICAqLwogIGdldCBkaXNwZXJzaW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2Rpc3BlcnNpb247CiAgfQogIHNldCBkaXNwZXJzaW9uKHQpIHsKICAgIHRoaXMuX2Rpc3BlcnNpb24gPiAwICE9IHQgPiAwICYmIHRoaXMudmVyc2lvbisrLCB0aGlzLl9kaXNwZXJzaW9uID0gdDsKICB9CiAgLyoqCiAgICogVGhlIGludGVuc2l0eSBvZiB0aGUgc2hlZW4gbGF5ZXIsIGZyb20gYDAuMGAgdG8gYDEuMGAuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgc2hlZW4oKSB7CiAgICByZXR1cm4gdGhpcy5fc2hlZW47CiAgfQogIHNldCBzaGVlbih0KSB7CiAgICB0aGlzLl9zaGVlbiA+IDAgIT0gdCA+IDAgJiYgdGhpcy52ZXJzaW9uKyssIHRoaXMuX3NoZWVuID0gdDsKICB9CiAgLyoqCiAgICogRGVncmVlIG9mIHRyYW5zbWlzc2lvbiAob3Igb3B0aWNhbCB0cmFuc3BhcmVuY3kpLCBmcm9tIGAwLjBgIHRvIGAxLjBgLgogICAqCiAgICogVGhpbiwgdHJhbnNwYXJlbnQgb3Igc2VtaXRyYW5zcGFyZW50LCBwbGFzdGljIG9yIGdsYXNzIG1hdGVyaWFscyByZW1haW4KICAgKiBsYXJnZWx5IHJlZmxlY3RpdmUgZXZlbiBpZiB0aGV5IGFyZSBmdWxseSB0cmFuc21pc3NpdmUuIFRoZSB0cmFuc21pc3Npb24KICAgKiBwcm9wZXJ0eSBjYW4gYmUgdXNlZCB0byBtb2RlbCB0aGVzZSBtYXRlcmlhbHMuCiAgICoKICAgKiBXaGVuIHRyYW5zbWlzc2lvbiBpcyBub24temVybywgYG9wYWNpdHlgIHNob3VsZCBiZSAgc2V0IHRvIGAxYC4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMAogICAqLwogIGdldCB0cmFuc21pc3Npb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNtaXNzaW9uOwogIH0KICBzZXQgdHJhbnNtaXNzaW9uKHQpIHsKICAgIHRoaXMuX3RyYW5zbWlzc2lvbiA+IDAgIT0gdCA+IDAgJiYgdGhpcy52ZXJzaW9uKyssIHRoaXMuX3RyYW5zbWlzc2lvbiA9IHQ7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuZGVmaW5lcyA9IHsKICAgICAgU1RBTkRBUkQ6ICIiLAogICAgICBQSFlTSUNBTDogIiIKICAgIH0sIHRoaXMuYW5pc290cm9weSA9IHQuYW5pc290cm9weSwgdGhpcy5hbmlzb3Ryb3B5Um90YXRpb24gPSB0LmFuaXNvdHJvcHlSb3RhdGlvbiwgdGhpcy5hbmlzb3Ryb3B5TWFwID0gdC5hbmlzb3Ryb3B5TWFwLCB0aGlzLmNsZWFyY29hdCA9IHQuY2xlYXJjb2F0LCB0aGlzLmNsZWFyY29hdE1hcCA9IHQuY2xlYXJjb2F0TWFwLCB0aGlzLmNsZWFyY29hdFJvdWdobmVzcyA9IHQuY2xlYXJjb2F0Um91Z2huZXNzLCB0aGlzLmNsZWFyY29hdFJvdWdobmVzc01hcCA9IHQuY2xlYXJjb2F0Um91Z2huZXNzTWFwLCB0aGlzLmNsZWFyY29hdE5vcm1hbE1hcCA9IHQuY2xlYXJjb2F0Tm9ybWFsTWFwLCB0aGlzLmNsZWFyY29hdE5vcm1hbFNjYWxlLmNvcHkodC5jbGVhcmNvYXROb3JtYWxTY2FsZSksIHRoaXMuZGlzcGVyc2lvbiA9IHQuZGlzcGVyc2lvbiwgdGhpcy5pb3IgPSB0LmlvciwgdGhpcy5pcmlkZXNjZW5jZSA9IHQuaXJpZGVzY2VuY2UsIHRoaXMuaXJpZGVzY2VuY2VNYXAgPSB0LmlyaWRlc2NlbmNlTWFwLCB0aGlzLmlyaWRlc2NlbmNlSU9SID0gdC5pcmlkZXNjZW5jZUlPUiwgdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc1JhbmdlID0gWy4uLnQuaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZV0sIHRoaXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgPSB0LmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwLCB0aGlzLnNoZWVuID0gdC5zaGVlbiwgdGhpcy5zaGVlbkNvbG9yLmNvcHkodC5zaGVlbkNvbG9yKSwgdGhpcy5zaGVlbkNvbG9yTWFwID0gdC5zaGVlbkNvbG9yTWFwLCB0aGlzLnNoZWVuUm91Z2huZXNzID0gdC5zaGVlblJvdWdobmVzcywgdGhpcy5zaGVlblJvdWdobmVzc01hcCA9IHQuc2hlZW5Sb3VnaG5lc3NNYXAsIHRoaXMudHJhbnNtaXNzaW9uID0gdC50cmFuc21pc3Npb24sIHRoaXMudHJhbnNtaXNzaW9uTWFwID0gdC50cmFuc21pc3Npb25NYXAsIHRoaXMudGhpY2tuZXNzID0gdC50aGlja25lc3MsIHRoaXMudGhpY2tuZXNzTWFwID0gdC50aGlja25lc3NNYXAsIHRoaXMuYXR0ZW51YXRpb25EaXN0YW5jZSA9IHQuYXR0ZW51YXRpb25EaXN0YW5jZSwgdGhpcy5hdHRlbnVhdGlvbkNvbG9yLmNvcHkodC5hdHRlbnVhdGlvbkNvbG9yKSwgdGhpcy5zcGVjdWxhckludGVuc2l0eSA9IHQuc3BlY3VsYXJJbnRlbnNpdHksIHRoaXMuc3BlY3VsYXJJbnRlbnNpdHlNYXAgPSB0LnNwZWN1bGFySW50ZW5zaXR5TWFwLCB0aGlzLnNwZWN1bGFyQ29sb3IuY29weSh0LnNwZWN1bGFyQ29sb3IpLCB0aGlzLnNwZWN1bGFyQ29sb3JNYXAgPSB0LnNwZWN1bGFyQ29sb3JNYXAsIHRoaXM7CiAgfQp9CmNsYXNzIFp5IGV4dGVuZHMgaGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbWVzaCBwaG9uZyBtYXRlcmlhbC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc01lc2hQaG9uZ01hdGVyaWFsID0gITAsIHRoaXMudHlwZSA9ICJNZXNoUGhvbmdNYXRlcmlhbCIsIHRoaXMuY29sb3IgPSBuZXcgY3QoMTY3NzcyMTUpLCB0aGlzLnNwZWN1bGFyID0gbmV3IGN0KDExMTg0ODEpLCB0aGlzLnNoaW5pbmVzcyA9IDMwLCB0aGlzLm1hcCA9IG51bGwsIHRoaXMubGlnaHRNYXAgPSBudWxsLCB0aGlzLmxpZ2h0TWFwSW50ZW5zaXR5ID0gMSwgdGhpcy5hb01hcCA9IG51bGwsIHRoaXMuYW9NYXBJbnRlbnNpdHkgPSAxLCB0aGlzLmVtaXNzaXZlID0gbmV3IGN0KDApLCB0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ID0gMSwgdGhpcy5lbWlzc2l2ZU1hcCA9IG51bGwsIHRoaXMuYnVtcE1hcCA9IG51bGwsIHRoaXMuYnVtcFNjYWxlID0gMSwgdGhpcy5ub3JtYWxNYXAgPSBudWxsLCB0aGlzLm5vcm1hbE1hcFR5cGUgPSBJcywgdGhpcy5ub3JtYWxTY2FsZSA9IG5ldyBKKDEsIDEpLCB0aGlzLmRpc3BsYWNlbWVudE1hcCA9IG51bGwsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSAwLCB0aGlzLnNwZWN1bGFyTWFwID0gbnVsbCwgdGhpcy5hbHBoYU1hcCA9IG51bGwsIHRoaXMuZW52TWFwID0gbnVsbCwgdGhpcy5lbnZNYXBSb3RhdGlvbiA9IG5ldyBmbigpLCB0aGlzLmNvbWJpbmUgPSB6bywgdGhpcy5yZWZsZWN0aXZpdHkgPSAxLCB0aGlzLnJlZnJhY3Rpb25SYXRpbyA9IDAuOTgsIHRoaXMud2lyZWZyYW1lID0gITEsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gMSwgdGhpcy53aXJlZnJhbWVMaW5lY2FwID0gInJvdW5kIiwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9ICJyb3VuZCIsIHRoaXMuZmxhdFNoYWRpbmcgPSAhMSwgdGhpcy5mb2cgPSAhMCwgdGhpcy5zZXRWYWx1ZXModCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuY29sb3IuY29weSh0LmNvbG9yKSwgdGhpcy5zcGVjdWxhci5jb3B5KHQuc3BlY3VsYXIpLCB0aGlzLnNoaW5pbmVzcyA9IHQuc2hpbmluZXNzLCB0aGlzLm1hcCA9IHQubWFwLCB0aGlzLmxpZ2h0TWFwID0gdC5saWdodE1hcCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHQubGlnaHRNYXBJbnRlbnNpdHksIHRoaXMuYW9NYXAgPSB0LmFvTWFwLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gdC5hb01hcEludGVuc2l0eSwgdGhpcy5lbWlzc2l2ZS5jb3B5KHQuZW1pc3NpdmUpLCB0aGlzLmVtaXNzaXZlTWFwID0gdC5lbWlzc2l2ZU1hcCwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IHQuZW1pc3NpdmVJbnRlbnNpdHksIHRoaXMuYnVtcE1hcCA9IHQuYnVtcE1hcCwgdGhpcy5idW1wU2NhbGUgPSB0LmJ1bXBTY2FsZSwgdGhpcy5ub3JtYWxNYXAgPSB0Lm5vcm1hbE1hcCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gdC5ub3JtYWxNYXBUeXBlLCB0aGlzLm5vcm1hbFNjYWxlLmNvcHkodC5ub3JtYWxTY2FsZSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gdC5kaXNwbGFjZW1lbnRNYXAsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSB0LmRpc3BsYWNlbWVudEJpYXMsIHRoaXMuc3BlY3VsYXJNYXAgPSB0LnNwZWN1bGFyTWFwLCB0aGlzLmFscGhhTWFwID0gdC5hbHBoYU1hcCwgdGhpcy5lbnZNYXAgPSB0LmVudk1hcCwgdGhpcy5lbnZNYXBSb3RhdGlvbi5jb3B5KHQuZW52TWFwUm90YXRpb24pLCB0aGlzLmNvbWJpbmUgPSB0LmNvbWJpbmUsIHRoaXMucmVmbGVjdGl2aXR5ID0gdC5yZWZsZWN0aXZpdHksIHRoaXMucmVmcmFjdGlvblJhdGlvID0gdC5yZWZyYWN0aW9uUmF0aW8sIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHQud2lyZWZyYW1lTGluZWNhcCwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHQud2lyZWZyYW1lTGluZWpvaW4sIHRoaXMuZmxhdFNoYWRpbmcgPSB0LmZsYXRTaGFkaW5nLCB0aGlzLmZvZyA9IHQuZm9nLCB0aGlzOwogIH0KfQpjbGFzcyBqeSBleHRlbmRzIGhpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IG1lc2ggdG9vbiBtYXRlcmlhbC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc01lc2hUb29uTWF0ZXJpYWwgPSAhMCwgdGhpcy5kZWZpbmVzID0geyBUT09OOiAiIiB9LCB0aGlzLnR5cGUgPSAiTWVzaFRvb25NYXRlcmlhbCIsIHRoaXMuY29sb3IgPSBuZXcgY3QoMTY3NzcyMTUpLCB0aGlzLm1hcCA9IG51bGwsIHRoaXMuZ3JhZGllbnRNYXAgPSBudWxsLCB0aGlzLmxpZ2h0TWFwID0gbnVsbCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IDEsIHRoaXMuYW9NYXAgPSBudWxsLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gMSwgdGhpcy5lbWlzc2l2ZSA9IG5ldyBjdCgwKSwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IDEsIHRoaXMuZW1pc3NpdmVNYXAgPSBudWxsLCB0aGlzLmJ1bXBNYXAgPSBudWxsLCB0aGlzLmJ1bXBTY2FsZSA9IDEsIHRoaXMubm9ybWFsTWFwID0gbnVsbCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gSXMsIHRoaXMubm9ybWFsU2NhbGUgPSBuZXcgSigxLCAxKSwgdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsLCB0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMSwgdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gMCwgdGhpcy5hbHBoYU1hcCA9IG51bGwsIHRoaXMud2lyZWZyYW1lID0gITEsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gMSwgdGhpcy53aXJlZnJhbWVMaW5lY2FwID0gInJvdW5kIiwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9ICJyb3VuZCIsIHRoaXMuZm9nID0gITAsIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmNvbG9yLmNvcHkodC5jb2xvciksIHRoaXMubWFwID0gdC5tYXAsIHRoaXMuZ3JhZGllbnRNYXAgPSB0LmdyYWRpZW50TWFwLCB0aGlzLmxpZ2h0TWFwID0gdC5saWdodE1hcCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHQubGlnaHRNYXBJbnRlbnNpdHksIHRoaXMuYW9NYXAgPSB0LmFvTWFwLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gdC5hb01hcEludGVuc2l0eSwgdGhpcy5lbWlzc2l2ZS5jb3B5KHQuZW1pc3NpdmUpLCB0aGlzLmVtaXNzaXZlTWFwID0gdC5lbWlzc2l2ZU1hcCwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IHQuZW1pc3NpdmVJbnRlbnNpdHksIHRoaXMuYnVtcE1hcCA9IHQuYnVtcE1hcCwgdGhpcy5idW1wU2NhbGUgPSB0LmJ1bXBTY2FsZSwgdGhpcy5ub3JtYWxNYXAgPSB0Lm5vcm1hbE1hcCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gdC5ub3JtYWxNYXBUeXBlLCB0aGlzLm5vcm1hbFNjYWxlLmNvcHkodC5ub3JtYWxTY2FsZSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gdC5kaXNwbGFjZW1lbnRNYXAsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSB0LmRpc3BsYWNlbWVudEJpYXMsIHRoaXMuYWxwaGFNYXAgPSB0LmFscGhhTWFwLCB0aGlzLndpcmVmcmFtZSA9IHQud2lyZWZyYW1lLCB0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IHQud2lyZWZyYW1lTGluZXdpZHRoLCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSB0LndpcmVmcmFtZUxpbmVjYXAsIHRoaXMud2lyZWZyYW1lTGluZWpvaW4gPSB0LndpcmVmcmFtZUxpbmVqb2luLCB0aGlzLmZvZyA9IHQuZm9nLCB0aGlzOwogIH0KfQpjbGFzcyBKeSBleHRlbmRzIGhpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IG1lc2ggbm9ybWFsIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbWV0ZXJzXSAtIEFuIG9iamVjdCB3aXRoIG9uZSBvciBtb3JlIHByb3BlcnRpZXMKICAgKiBkZWZpbmluZyB0aGUgbWF0ZXJpYWwncyBhcHBlYXJhbmNlLiBBbnkgcHJvcGVydHkgb2YgdGhlIG1hdGVyaWFsCiAgICogKGluY2x1ZGluZyBhbnkgcHJvcGVydHkgZnJvbSBpbmhlcml0ZWQgbWF0ZXJpYWxzKSBjYW4gYmUgcGFzc2VkCiAgICogaW4gaGVyZS4gQ29sb3IgdmFsdWVzIGNhbiBiZSBwYXNzZWQgYW55IHR5cGUgb2YgdmFsdWUgYWNjZXB0ZWQKICAgKiBieSB7QGxpbmsgQ29sb3Ijc2V0fS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaE5vcm1hbE1hdGVyaWFsID0gITAsIHRoaXMudHlwZSA9ICJNZXNoTm9ybWFsTWF0ZXJpYWwiLCB0aGlzLmJ1bXBNYXAgPSBudWxsLCB0aGlzLmJ1bXBTY2FsZSA9IDEsIHRoaXMubm9ybWFsTWFwID0gbnVsbCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gSXMsIHRoaXMubm9ybWFsU2NhbGUgPSBuZXcgSigxLCAxKSwgdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsLCB0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMSwgdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gMCwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLmZsYXRTaGFkaW5nID0gITEsIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmJ1bXBNYXAgPSB0LmJ1bXBNYXAsIHRoaXMuYnVtcFNjYWxlID0gdC5idW1wU2NhbGUsIHRoaXMubm9ybWFsTWFwID0gdC5ub3JtYWxNYXAsIHRoaXMubm9ybWFsTWFwVHlwZSA9IHQubm9ybWFsTWFwVHlwZSwgdGhpcy5ub3JtYWxTY2FsZS5jb3B5KHQubm9ybWFsU2NhbGUpLCB0aGlzLmRpc3BsYWNlbWVudE1hcCA9IHQuZGlzcGxhY2VtZW50TWFwLCB0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gdC5kaXNwbGFjZW1lbnRTY2FsZSwgdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gdC5kaXNwbGFjZW1lbnRCaWFzLCB0aGlzLndpcmVmcmFtZSA9IHQud2lyZWZyYW1lLCB0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IHQud2lyZWZyYW1lTGluZXdpZHRoLCB0aGlzLmZsYXRTaGFkaW5nID0gdC5mbGF0U2hhZGluZywgdGhpczsKICB9Cn0KY2xhc3MgS3kgZXh0ZW5kcyBoaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBtZXNoIGxhbWJlcnQgbWF0ZXJpYWwuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtZXRlcnNdIC0gQW4gb2JqZWN0IHdpdGggb25lIG9yIG1vcmUgcHJvcGVydGllcwogICAqIGRlZmluaW5nIHRoZSBtYXRlcmlhbCdzIGFwcGVhcmFuY2UuIEFueSBwcm9wZXJ0eSBvZiB0aGUgbWF0ZXJpYWwKICAgKiAoaW5jbHVkaW5nIGFueSBwcm9wZXJ0eSBmcm9tIGluaGVyaXRlZCBtYXRlcmlhbHMpIGNhbiBiZSBwYXNzZWQKICAgKiBpbiBoZXJlLiBDb2xvciB2YWx1ZXMgY2FuIGJlIHBhc3NlZCBhbnkgdHlwZSBvZiB2YWx1ZSBhY2NlcHRlZAogICAqIGJ5IHtAbGluayBDb2xvciNzZXR9LgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNNZXNoTGFtYmVydE1hdGVyaWFsID0gITAsIHRoaXMudHlwZSA9ICJNZXNoTGFtYmVydE1hdGVyaWFsIiwgdGhpcy5jb2xvciA9IG5ldyBjdCgxNjc3NzIxNSksIHRoaXMubWFwID0gbnVsbCwgdGhpcy5saWdodE1hcCA9IG51bGwsIHRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSAxLCB0aGlzLmFvTWFwID0gbnVsbCwgdGhpcy5hb01hcEludGVuc2l0eSA9IDEsIHRoaXMuZW1pc3NpdmUgPSBuZXcgY3QoMCksIHRoaXMuZW1pc3NpdmVJbnRlbnNpdHkgPSAxLCB0aGlzLmVtaXNzaXZlTWFwID0gbnVsbCwgdGhpcy5idW1wTWFwID0gbnVsbCwgdGhpcy5idW1wU2NhbGUgPSAxLCB0aGlzLm5vcm1hbE1hcCA9IG51bGwsIHRoaXMubm9ybWFsTWFwVHlwZSA9IElzLCB0aGlzLm5vcm1hbFNjYWxlID0gbmV3IEooMSwgMSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gbnVsbCwgdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IDEsIHRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDAsIHRoaXMuc3BlY3VsYXJNYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5lbnZNYXAgPSBudWxsLCB0aGlzLmVudk1hcFJvdGF0aW9uID0gbmV3IGZuKCksIHRoaXMuY29tYmluZSA9IHpvLCB0aGlzLnJlZmxlY3Rpdml0eSA9IDEsIHRoaXMucmVmcmFjdGlvblJhdGlvID0gMC45OCwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAicm91bmQiLCB0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gInJvdW5kIiwgdGhpcy5mbGF0U2hhZGluZyA9ICExLCB0aGlzLmZvZyA9ICEwLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5jb2xvci5jb3B5KHQuY29sb3IpLCB0aGlzLm1hcCA9IHQubWFwLCB0aGlzLmxpZ2h0TWFwID0gdC5saWdodE1hcCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHQubGlnaHRNYXBJbnRlbnNpdHksIHRoaXMuYW9NYXAgPSB0LmFvTWFwLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gdC5hb01hcEludGVuc2l0eSwgdGhpcy5lbWlzc2l2ZS5jb3B5KHQuZW1pc3NpdmUpLCB0aGlzLmVtaXNzaXZlTWFwID0gdC5lbWlzc2l2ZU1hcCwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IHQuZW1pc3NpdmVJbnRlbnNpdHksIHRoaXMuYnVtcE1hcCA9IHQuYnVtcE1hcCwgdGhpcy5idW1wU2NhbGUgPSB0LmJ1bXBTY2FsZSwgdGhpcy5ub3JtYWxNYXAgPSB0Lm5vcm1hbE1hcCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gdC5ub3JtYWxNYXBUeXBlLCB0aGlzLm5vcm1hbFNjYWxlLmNvcHkodC5ub3JtYWxTY2FsZSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gdC5kaXNwbGFjZW1lbnRNYXAsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSB0LmRpc3BsYWNlbWVudEJpYXMsIHRoaXMuc3BlY3VsYXJNYXAgPSB0LnNwZWN1bGFyTWFwLCB0aGlzLmFscGhhTWFwID0gdC5hbHBoYU1hcCwgdGhpcy5lbnZNYXAgPSB0LmVudk1hcCwgdGhpcy5lbnZNYXBSb3RhdGlvbi5jb3B5KHQuZW52TWFwUm90YXRpb24pLCB0aGlzLmNvbWJpbmUgPSB0LmNvbWJpbmUsIHRoaXMucmVmbGVjdGl2aXR5ID0gdC5yZWZsZWN0aXZpdHksIHRoaXMucmVmcmFjdGlvblJhdGlvID0gdC5yZWZyYWN0aW9uUmF0aW8sIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHQud2lyZWZyYW1lTGluZWNhcCwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHQud2lyZWZyYW1lTGluZWpvaW4sIHRoaXMuZmxhdFNoYWRpbmcgPSB0LmZsYXRTaGFkaW5nLCB0aGlzLmZvZyA9IHQuZm9nLCB0aGlzOwogIH0KfQpjbGFzcyBqcCBleHRlbmRzIGhpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IG1lc2ggZGVwdGggbWF0ZXJpYWwuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtZXRlcnNdIC0gQW4gb2JqZWN0IHdpdGggb25lIG9yIG1vcmUgcHJvcGVydGllcwogICAqIGRlZmluaW5nIHRoZSBtYXRlcmlhbCdzIGFwcGVhcmFuY2UuIEFueSBwcm9wZXJ0eSBvZiB0aGUgbWF0ZXJpYWwKICAgKiAoaW5jbHVkaW5nIGFueSBwcm9wZXJ0eSBmcm9tIGluaGVyaXRlZCBtYXRlcmlhbHMpIGNhbiBiZSBwYXNzZWQKICAgKiBpbiBoZXJlLiBDb2xvciB2YWx1ZXMgY2FuIGJlIHBhc3NlZCBhbnkgdHlwZSBvZiB2YWx1ZSBhY2NlcHRlZAogICAqIGJ5IHtAbGluayBDb2xvciNzZXR9LgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNNZXNoRGVwdGhNYXRlcmlhbCA9ICEwLCB0aGlzLnR5cGUgPSAiTWVzaERlcHRoTWF0ZXJpYWwiLCB0aGlzLmRlcHRoUGFja2luZyA9IGl5LCB0aGlzLm1hcCA9IG51bGwsIHRoaXMuYWxwaGFNYXAgPSBudWxsLCB0aGlzLmRpc3BsYWNlbWVudE1hcCA9IG51bGwsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSAwLCB0aGlzLndpcmVmcmFtZSA9ICExLCB0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IDEsIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLmRlcHRoUGFja2luZyA9IHQuZGVwdGhQYWNraW5nLCB0aGlzLm1hcCA9IHQubWFwLCB0aGlzLmFscGhhTWFwID0gdC5hbHBoYU1hcCwgdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSB0LmRpc3BsYWNlbWVudE1hcCwgdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IHQuZGlzcGxhY2VtZW50U2NhbGUsIHRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IHQuZGlzcGxhY2VtZW50QmlhcywgdGhpcy53aXJlZnJhbWUgPSB0LndpcmVmcmFtZSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSB0LndpcmVmcmFtZUxpbmV3aWR0aCwgdGhpczsKICB9Cn0KY2xhc3MgSnAgZXh0ZW5kcyBoaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBtZXNoIGRpc3RhbmNlIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbWV0ZXJzXSAtIEFuIG9iamVjdCB3aXRoIG9uZSBvciBtb3JlIHByb3BlcnRpZXMKICAgKiBkZWZpbmluZyB0aGUgbWF0ZXJpYWwncyBhcHBlYXJhbmNlLiBBbnkgcHJvcGVydHkgb2YgdGhlIG1hdGVyaWFsCiAgICogKGluY2x1ZGluZyBhbnkgcHJvcGVydHkgZnJvbSBpbmhlcml0ZWQgbWF0ZXJpYWxzKSBjYW4gYmUgcGFzc2VkCiAgICogaW4gaGVyZS4gQ29sb3IgdmFsdWVzIGNhbiBiZSBwYXNzZWQgYW55IHR5cGUgb2YgdmFsdWUgYWNjZXB0ZWQKICAgKiBieSB7QGxpbmsgQ29sb3Ijc2V0fS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaERpc3RhbmNlTWF0ZXJpYWwgPSAhMCwgdGhpcy50eXBlID0gIk1lc2hEaXN0YW5jZU1hdGVyaWFsIiwgdGhpcy5tYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsLCB0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMSwgdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gMCwgdGhpcy5zZXRWYWx1ZXModCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMubWFwID0gdC5tYXAsIHRoaXMuYWxwaGFNYXAgPSB0LmFscGhhTWFwLCB0aGlzLmRpc3BsYWNlbWVudE1hcCA9IHQuZGlzcGxhY2VtZW50TWFwLCB0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gdC5kaXNwbGFjZW1lbnRTY2FsZSwgdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gdC5kaXNwbGFjZW1lbnRCaWFzLCB0aGlzOwogIH0KfQpjbGFzcyBReSBleHRlbmRzIGhpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IG1lc2ggbWF0Y2FwIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbWV0ZXJzXSAtIEFuIG9iamVjdCB3aXRoIG9uZSBvciBtb3JlIHByb3BlcnRpZXMKICAgKiBkZWZpbmluZyB0aGUgbWF0ZXJpYWwncyBhcHBlYXJhbmNlLiBBbnkgcHJvcGVydHkgb2YgdGhlIG1hdGVyaWFsCiAgICogKGluY2x1ZGluZyBhbnkgcHJvcGVydHkgZnJvbSBpbmhlcml0ZWQgbWF0ZXJpYWxzKSBjYW4gYmUgcGFzc2VkCiAgICogaW4gaGVyZS4gQ29sb3IgdmFsdWVzIGNhbiBiZSBwYXNzZWQgYW55IHR5cGUgb2YgdmFsdWUgYWNjZXB0ZWQKICAgKiBieSB7QGxpbmsgQ29sb3Ijc2V0fS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaE1hdGNhcE1hdGVyaWFsID0gITAsIHRoaXMuZGVmaW5lcyA9IHsgTUFUQ0FQOiAiIiB9LCB0aGlzLnR5cGUgPSAiTWVzaE1hdGNhcE1hdGVyaWFsIiwgdGhpcy5jb2xvciA9IG5ldyBjdCgxNjc3NzIxNSksIHRoaXMubWF0Y2FwID0gbnVsbCwgdGhpcy5tYXAgPSBudWxsLCB0aGlzLmJ1bXBNYXAgPSBudWxsLCB0aGlzLmJ1bXBTY2FsZSA9IDEsIHRoaXMubm9ybWFsTWFwID0gbnVsbCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gSXMsIHRoaXMubm9ybWFsU2NhbGUgPSBuZXcgSigxLCAxKSwgdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsLCB0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMSwgdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gMCwgdGhpcy5hbHBoYU1hcCA9IG51bGwsIHRoaXMuZmxhdFNoYWRpbmcgPSAhMSwgdGhpcy5mb2cgPSAhMCwgdGhpcy5zZXRWYWx1ZXModCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuZGVmaW5lcyA9IHsgTUFUQ0FQOiAiIiB9LCB0aGlzLmNvbG9yLmNvcHkodC5jb2xvciksIHRoaXMubWF0Y2FwID0gdC5tYXRjYXAsIHRoaXMubWFwID0gdC5tYXAsIHRoaXMuYnVtcE1hcCA9IHQuYnVtcE1hcCwgdGhpcy5idW1wU2NhbGUgPSB0LmJ1bXBTY2FsZSwgdGhpcy5ub3JtYWxNYXAgPSB0Lm5vcm1hbE1hcCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gdC5ub3JtYWxNYXBUeXBlLCB0aGlzLm5vcm1hbFNjYWxlLmNvcHkodC5ub3JtYWxTY2FsZSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gdC5kaXNwbGFjZW1lbnRNYXAsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSB0LmRpc3BsYWNlbWVudEJpYXMsIHRoaXMuYWxwaGFNYXAgPSB0LmFscGhhTWFwLCB0aGlzLmZsYXRTaGFkaW5nID0gdC5mbGF0U2hhZGluZywgdGhpcy5mb2cgPSB0LmZvZywgdGhpczsKICB9Cn0KY2xhc3MgS3AgZXh0ZW5kcyBQZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBsaW5lIGRhc2hlZCBtYXRlcmlhbC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0xpbmVEYXNoZWRNYXRlcmlhbCA9ICEwLCB0aGlzLnR5cGUgPSAiTGluZURhc2hlZE1hdGVyaWFsIiwgdGhpcy5zY2FsZSA9IDEsIHRoaXMuZGFzaFNpemUgPSAzLCB0aGlzLmdhcFNpemUgPSAxLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5zY2FsZSA9IHQuc2NhbGUsIHRoaXMuZGFzaFNpemUgPSB0LmRhc2hTaXplLCB0aGlzLmdhcFNpemUgPSB0LmdhcFNpemUsIHRoaXM7CiAgfQp9CmZ1bmN0aW9uIGFyKGEsIHQpIHsKICByZXR1cm4gIWEgfHwgYS5jb25zdHJ1Y3RvciA9PT0gdCA/IGEgOiB0eXBlb2YgdC5CWVRFU19QRVJfRUxFTUVOVCA9PSAibnVtYmVyIiA/IG5ldyB0KGEpIDogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYSk7Cn0KZnVuY3Rpb24gdF8oYSkgewogIHJldHVybiBBcnJheUJ1ZmZlci5pc1ZpZXcoYSkgJiYgIShhIGluc3RhbmNlb2YgRGF0YVZpZXcpOwp9CmZ1bmN0aW9uIGVfKGEpIHsKICBmdW5jdGlvbiB0KG4sIHMpIHsKICAgIHJldHVybiBhW25dIC0gYVtzXTsKICB9CiAgY29uc3QgZSA9IGEubGVuZ3RoLCBpID0gbmV3IEFycmF5KGUpOwogIGZvciAobGV0IG4gPSAwOyBuICE9PSBlOyArK24pIGlbbl0gPSBuOwogIHJldHVybiBpLnNvcnQodCksIGk7Cn0KZnVuY3Rpb24gc3AoYSwgdCwgZSkgewogIGNvbnN0IGkgPSBhLmxlbmd0aCwgbiA9IG5ldyBhLmNvbnN0cnVjdG9yKGkpOwogIGZvciAobGV0IHMgPSAwLCByID0gMDsgciAhPT0gaTsgKytzKSB7CiAgICBjb25zdCBvID0gZVtzXSAqIHQ7CiAgICBmb3IgKGxldCBsID0gMDsgbCAhPT0gdDsgKytsKQogICAgICBuW3IrK10gPSBhW28gKyBsXTsKICB9CiAgcmV0dXJuIG47Cn0KZnVuY3Rpb24gUXAoYSwgdCwgZSwgaSkgewogIGxldCBuID0gMSwgcyA9IGFbMF07CiAgZm9yICg7IHMgIT09IHZvaWQgMCAmJiBzW2ldID09PSB2b2lkIDA7ICkKICAgIHMgPSBhW24rK107CiAgaWYgKHMgPT09IHZvaWQgMCkgcmV0dXJuOwogIGxldCByID0gc1tpXTsKICBpZiAociAhPT0gdm9pZCAwKQogICAgaWYgKEFycmF5LmlzQXJyYXkocikpCiAgICAgIGRvCiAgICAgICAgciA9IHNbaV0sIHIgIT09IHZvaWQgMCAmJiAodC5wdXNoKHMudGltZSksIGUucHVzaCguLi5yKSksIHMgPSBhW24rK107CiAgICAgIHdoaWxlIChzICE9PSB2b2lkIDApOwogICAgZWxzZSBpZiAoci50b0FycmF5ICE9PSB2b2lkIDApCiAgICAgIGRvCiAgICAgICAgciA9IHNbaV0sIHIgIT09IHZvaWQgMCAmJiAodC5wdXNoKHMudGltZSksIHIudG9BcnJheShlLCBlLmxlbmd0aCkpLCBzID0gYVtuKytdOwogICAgICB3aGlsZSAocyAhPT0gdm9pZCAwKTsKICAgIGVsc2UKICAgICAgZG8KICAgICAgICByID0gc1tpXSwgciAhPT0gdm9pZCAwICYmICh0LnB1c2gocy50aW1lKSwgZS5wdXNoKHIpKSwgcyA9IGFbbisrXTsKICAgICAgd2hpbGUgKHMgIT09IHZvaWQgMCk7Cn0KZnVuY3Rpb24gRGIoYSwgdCwgZSwgaSwgbiA9IDMwKSB7CiAgY29uc3QgcyA9IGEuY2xvbmUoKTsKICBzLm5hbWUgPSB0OwogIGNvbnN0IHIgPSBbXTsKICBmb3IgKGxldCBsID0gMDsgbCA8IHMudHJhY2tzLmxlbmd0aDsgKytsKSB7CiAgICBjb25zdCBoID0gcy50cmFja3NbbF0sIGMgPSBoLmdldFZhbHVlU2l6ZSgpLCB1ID0gW10sIGQgPSBbXTsKICAgIGZvciAobGV0IHAgPSAwOyBwIDwgaC50aW1lcy5sZW5ndGg7ICsrcCkgewogICAgICBjb25zdCBmID0gaC50aW1lc1twXSAqIG47CiAgICAgIGlmICghKGYgPCBlIHx8IGYgPj0gaSkpIHsKICAgICAgICB1LnB1c2goaC50aW1lc1twXSk7CiAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBjOyArK3kpCiAgICAgICAgICBkLnB1c2goaC52YWx1ZXNbcCAqIGMgKyB5XSk7CiAgICAgIH0KICAgIH0KICAgIHUubGVuZ3RoICE9PSAwICYmIChoLnRpbWVzID0gYXIodSwgaC50aW1lcy5jb25zdHJ1Y3RvciksIGgudmFsdWVzID0gYXIoZCwgaC52YWx1ZXMuY29uc3RydWN0b3IpLCByLnB1c2goaCkpOwogIH0KICBzLnRyYWNrcyA9IHI7CiAgbGV0IG8gPSAxIC8gMDsKICBmb3IgKGxldCBsID0gMDsgbCA8IHMudHJhY2tzLmxlbmd0aDsgKytsKQogICAgbyA+IHMudHJhY2tzW2xdLnRpbWVzWzBdICYmIChvID0gcy50cmFja3NbbF0udGltZXNbMF0pOwogIGZvciAobGV0IGwgPSAwOyBsIDwgcy50cmFja3MubGVuZ3RoOyArK2wpCiAgICBzLnRyYWNrc1tsXS5zaGlmdCgtMSAqIG8pOwogIHJldHVybiBzLnJlc2V0RHVyYXRpb24oKSwgczsKfQpmdW5jdGlvbiBGYihhLCB0ID0gMCwgZSA9IGEsIGkgPSAzMCkgewogIGkgPD0gMCAmJiAoaSA9IDMwKTsKICBjb25zdCBuID0gZS50cmFja3MubGVuZ3RoLCBzID0gdCAvIGk7CiAgZm9yIChsZXQgciA9IDA7IHIgPCBuOyArK3IpIHsKICAgIGNvbnN0IG8gPSBlLnRyYWNrc1tyXSwgbCA9IG8uVmFsdWVUeXBlTmFtZTsKICAgIGlmIChsID09PSAiYm9vbCIgfHwgbCA9PT0gInN0cmluZyIpIGNvbnRpbnVlOwogICAgY29uc3QgaCA9IGEudHJhY2tzLmZpbmQoZnVuY3Rpb24obSkgewogICAgICByZXR1cm4gbS5uYW1lID09PSBvLm5hbWUgJiYgbS5WYWx1ZVR5cGVOYW1lID09PSBsOwogICAgfSk7CiAgICBpZiAoaCA9PT0gdm9pZCAwKSBjb250aW51ZTsKICAgIGxldCBjID0gMDsKICAgIGNvbnN0IHUgPSBvLmdldFZhbHVlU2l6ZSgpOwogICAgby5jcmVhdGVJbnRlcnBvbGFudC5pc0ludGVycG9sYW50RmFjdG9yeU1ldGhvZEdMVEZDdWJpY1NwbGluZSAmJiAoYyA9IHUgLyAzKTsKICAgIGxldCBkID0gMDsKICAgIGNvbnN0IHAgPSBoLmdldFZhbHVlU2l6ZSgpOwogICAgaC5jcmVhdGVJbnRlcnBvbGFudC5pc0ludGVycG9sYW50RmFjdG9yeU1ldGhvZEdMVEZDdWJpY1NwbGluZSAmJiAoZCA9IHAgLyAzKTsKICAgIGNvbnN0IGYgPSBvLnRpbWVzLmxlbmd0aCAtIDE7CiAgICBsZXQgeTsKICAgIGlmIChzIDw9IG8udGltZXNbMF0pIHsKICAgICAgY29uc3QgbSA9IGMsIHYgPSB1IC0gYzsKICAgICAgeSA9IG8udmFsdWVzLnNsaWNlKG0sIHYpOwogICAgfSBlbHNlIGlmIChzID49IG8udGltZXNbZl0pIHsKICAgICAgY29uc3QgbSA9IGYgKiB1ICsgYywgdiA9IG0gKyB1IC0gYzsKICAgICAgeSA9IG8udmFsdWVzLnNsaWNlKG0sIHYpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgbSA9IG8uY3JlYXRlSW50ZXJwb2xhbnQoKSwgdiA9IGMsIHggPSB1IC0gYzsKICAgICAgbS5ldmFsdWF0ZShzKSwgeSA9IG0ucmVzdWx0QnVmZmVyLnNsaWNlKHYsIHgpOwogICAgfQogICAgbCA9PT0gInF1YXRlcm5pb24iICYmIG5ldyB2ZSgpLmZyb21BcnJheSh5KS5ub3JtYWxpemUoKS5jb25qdWdhdGUoKS50b0FycmF5KHkpOwogICAgY29uc3QgZyA9IGgudGltZXMubGVuZ3RoOwogICAgZm9yIChsZXQgbSA9IDA7IG0gPCBnOyArK20pIHsKICAgICAgY29uc3QgdiA9IG0gKiBwICsgZDsKICAgICAgaWYgKGwgPT09ICJxdWF0ZXJuaW9uIikKICAgICAgICB2ZS5tdWx0aXBseVF1YXRlcm5pb25zRmxhdCgKICAgICAgICAgIGgudmFsdWVzLAogICAgICAgICAgdiwKICAgICAgICAgIHksCiAgICAgICAgICAwLAogICAgICAgICAgaC52YWx1ZXMsCiAgICAgICAgICB2CiAgICAgICAgKTsKICAgICAgZWxzZSB7CiAgICAgICAgY29uc3QgeCA9IHAgLSBkICogMjsKICAgICAgICBmb3IgKGxldCBfID0gMDsgXyA8IHg7ICsrXykKICAgICAgICAgIGgudmFsdWVzW3YgKyBfXSAtPSB5W19dOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBhLmJsZW5kTW9kZSA9IERwLCBhOwp9CmNsYXNzIFViIHsKICAvKioKICAgKiBDb252ZXJ0cyBhbiBhcnJheSB0byBhIHNwZWNpZmljIHR5cGUKICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl8QXJyYXl9IGFycmF5IC0gVGhlIGFycmF5IHRvIGNvbnZlcnQuCiAgICogQHBhcmFtIHtUeXBlZEFycmF5LmNvbnN0cnVjdG9yfSB0eXBlIC0gVGhlIGNvbnN0cnVjdG9yIG9mIGEgdHlwZSBhcnJheS4KICAgKiBAcmV0dXJuIHtUeXBlZEFycmF5fSBUaGUgY29udmVydGVkIGFycmF5CiAgICovCiAgc3RhdGljIGNvbnZlcnRBcnJheSh0LCBlKSB7CiAgICByZXR1cm4gYXIodCwgZSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiBvYmplY3QgaXMgYSB0eXBlZCBhcnJheS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge2FueX0gb2JqZWN0IC0gVGhlIG9iamVjdCB0byBjaGVjay4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBnaXZlbiBvYmplY3QgaXMgYSB0eXBlZCBhcnJheS4KICAgKi8KICBzdGF0aWMgaXNUeXBlZEFycmF5KHQpIHsKICAgIHJldHVybiB0Xyh0KTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhbiBhcnJheSBieSB3aGljaCB0aW1lcyBhbmQgdmFsdWVzIGNhbiBiZSBzb3J0ZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB0aW1lcyAtIFRoZSBrZXlmcmFtZSB0aW1lIHZhbHVlcy4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgYXJyYXkuCiAgICovCiAgc3RhdGljIGdldEtleWZyYW1lT3JkZXIodCkgewogICAgcmV0dXJuIGVfKHQpOwogIH0KICAvKioKICAgKiBTb3J0cyB0aGUgZ2l2ZW4gYXJyYXkgYnkgdGhlIHByZXZpb3VzbHkgY29tcHV0ZWQgb3JkZXIgdmlhIGBnZXRLZXlmcmFtZU9yZGVyKClgLgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdmFsdWVzIC0gVGhlIHZhbHVlcyB0byBzb3J0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdHJpZGUgLSBUaGUgc3RyaWRlLgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gb3JkZXIgLSBUaGUgc29ydCBvcmRlci4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgc29ydGVkIHZhbHVlcy4KICAgKi8KICBzdGF0aWMgc29ydGVkQXJyYXkodCwgZSwgaSkgewogICAgcmV0dXJuIHNwKHQsIGUsIGkpOwogIH0KICAvKioKICAgKiBVc2VkIGZvciBwYXJzaW5nIEFPUyBrZXlmcmFtZSBmb3JtYXRzLgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0ganNvbktleXMgLSBBIGxpc3Qgb2YgSlNPTiBrZXlmcmFtZXMuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB0aW1lcyAtIFRoaXMgYXJyYXkgd2lsbCBiZSBmaWxsZWQgd2l0aCBrZXlmcmFtZSB0aW1lcyBieSB0aGlzIG1ldGhvZC4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHZhbHVlcyAtIFRoaXMgYXJyYXkgd2lsbCBiZSBmaWxsZWQgd2l0aCBrZXlmcmFtZSB2YWx1ZXMgYnkgdGhpcyBtZXRob2QuCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlUHJvcGVydHlOYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIHVzZS4KICAgKi8KICBzdGF0aWMgZmxhdHRlbkpTT04odCwgZSwgaSwgbikgewogICAgUXAodCwgZSwgaSwgbik7CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgY2xpcCwgY29udGFpbmluZyBvbmx5IHRoZSBzZWdtZW50IG9mIHRoZSBvcmlnaW5hbCBjbGlwIGJldHdlZW4gdGhlIGdpdmVuIGZyYW1lcy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge0FuaW1hdGlvbkNsaXB9IHNvdXJjZUNsaXAgLSBUaGUgdmFsdWVzIHRvIHNvcnQuCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgY2xpcC4KICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRGcmFtZSAtIFRoZSBzdGFydCBmcmFtZS4KICAgKiBAcGFyYW0ge251bWJlcn0gZW5kRnJhbWUgLSBUaGUgZW5kIGZyYW1lLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZnBzPTMwXSAtIFRoZSBGUFMuCiAgICogQHJldHVybiB7QW5pbWF0aW9uQ2xpcH0gVGhlIG5ldyBzdWIgY2xpcC4KICAgKi8KICBzdGF0aWMgc3ViY2xpcCh0LCBlLCBpLCBuLCBzID0gMzApIHsKICAgIHJldHVybiBEYih0LCBlLCBpLCBuLCBzKTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGtleWZyYW1lcyBvZiB0aGUgZ2l2ZW4gYW5pbWF0aW9uIGNsaXAgdG8gYW4gYWRkaXRpdmUgZm9ybWF0LgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7QW5pbWF0aW9uQ2xpcH0gdGFyZ2V0Q2xpcCAtIFRoZSBjbGlwIHRvIG1ha2UgYWRkaXRpdmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyZWZlcmVuY2VGcmFtZT0wXSAtIFRoZSByZWZlcmVuY2UgZnJhbWUuCiAgICogQHBhcmFtIHtBbmltYXRpb25DbGlwfSBbcmVmZXJlbmNlQ2xpcD10YXJnZXRDbGlwXSAtIFRoZSByZWZlcmVuY2UgY2xpcC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2Zwcz0zMF0gLSBUaGUgRlBTLgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkNsaXB9IFRoZSB1cGRhdGVkIGNsaXAgd2hpY2ggaXMgbm93IGFkZGl0aXZlLgogICAqLwogIHN0YXRpYyBtYWtlQ2xpcEFkZGl0aXZlKHQsIGUgPSAwLCBpID0gdCwgbiA9IDMwKSB7CiAgICByZXR1cm4gRmIodCwgZSwgaSwgbik7CiAgfQp9CmNsYXNzIFdvIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGludGVycG9sYW50LgogICAqCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBwYXJhbWV0ZXJQb3NpdGlvbnMgLSBUaGUgcGFyYW1ldGVyIHBvc2l0aW9ucyBob2xkIHRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvcnMuCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBzYW1wbGVWYWx1ZXMgLSBUaGUgc2FtcGxlIHZhbHVlcy4KICAgKiBAcGFyYW0ge251bWJlcn0gc2FtcGxlU2l6ZSAtIFRoZSBzYW1wbGUgc2l6ZQogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gW3Jlc3VsdEJ1ZmZlcl0gLSBUaGUgcmVzdWx0IGJ1ZmZlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuKSB7CiAgICB0aGlzLnBhcmFtZXRlclBvc2l0aW9ucyA9IHQsIHRoaXMuX2NhY2hlZEluZGV4ID0gMCwgdGhpcy5yZXN1bHRCdWZmZXIgPSBuICE9PSB2b2lkIDAgPyBuIDogbmV3IGUuY29uc3RydWN0b3IoaSksIHRoaXMuc2FtcGxlVmFsdWVzID0gZSwgdGhpcy52YWx1ZVNpemUgPSBpLCB0aGlzLnNldHRpbmdzID0gbnVsbCwgdGhpcy5EZWZhdWx0U2V0dGluZ3NfID0ge307CiAgfQogIC8qKgogICAqIEV2YWx1YXRlIHRoZSBpbnRlcnBvbGFudCBhdCBwb3NpdGlvbiBgdGAuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3Rvci4KICAgKiBAcmV0dXJuIHtUeXBlZEFycmF5fSBUaGUgcmVzdWx0IGJ1ZmZlci4KICAgKi8KICBldmFsdWF0ZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5wYXJhbWV0ZXJQb3NpdGlvbnM7CiAgICBsZXQgaSA9IHRoaXMuX2NhY2hlZEluZGV4LCBuID0gZVtpXSwgcyA9IGVbaSAtIDFdOwogICAgdDogewogICAgICBlOiB7CiAgICAgICAgbGV0IHI7CiAgICAgICAgaTogewogICAgICAgICAgbjogaWYgKCEodCA8IG4pKSB7CiAgICAgICAgICAgIGZvciAobGV0IG8gPSBpICsgMjsgOyApIHsKICAgICAgICAgICAgICBpZiAobiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAodCA8IHMpIGJyZWFrIG47CiAgICAgICAgICAgICAgICByZXR1cm4gaSA9IGUubGVuZ3RoLCB0aGlzLl9jYWNoZWRJbmRleCA9IGksIHRoaXMuY29weVNhbXBsZVZhbHVlXyhpIC0gMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpID09PSBvKSBicmVhazsKICAgICAgICAgICAgICBpZiAocyA9IG4sIG4gPSBlWysraV0sIHQgPCBuKQogICAgICAgICAgICAgICAgYnJlYWsgZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByID0gZS5sZW5ndGg7CiAgICAgICAgICAgIGJyZWFrIGk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoISh0ID49IHMpKSB7CiAgICAgICAgICAgIGNvbnN0IG8gPSBlWzFdOwogICAgICAgICAgICB0IDwgbyAmJiAoaSA9IDIsIHMgPSBvKTsKICAgICAgICAgICAgZm9yIChsZXQgbCA9IGkgLSAyOyA7ICkgewogICAgICAgICAgICAgIGlmIChzID09PSB2b2lkIDApCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fY2FjaGVkSW5kZXggPSAwLCB0aGlzLmNvcHlTYW1wbGVWYWx1ZV8oMCk7CiAgICAgICAgICAgICAgaWYgKGkgPT09IGwpIGJyZWFrOwogICAgICAgICAgICAgIGlmIChuID0gcywgcyA9IGVbLS1pIC0gMV0sIHQgPj0gcykKICAgICAgICAgICAgICAgIGJyZWFrIGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgciA9IGksIGkgPSAwOwogICAgICAgICAgICBicmVhayBpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWsgdDsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGkgPCByOyApIHsKICAgICAgICAgIGNvbnN0IG8gPSBpICsgciA+Pj4gMTsKICAgICAgICAgIHQgPCBlW29dID8gciA9IG8gOiBpID0gbyArIDE7CiAgICAgICAgfQogICAgICAgIGlmIChuID0gZVtpXSwgcyA9IGVbaSAtIDFdLCBzID09PSB2b2lkIDApCiAgICAgICAgICByZXR1cm4gdGhpcy5fY2FjaGVkSW5kZXggPSAwLCB0aGlzLmNvcHlTYW1wbGVWYWx1ZV8oMCk7CiAgICAgICAgaWYgKG4gPT09IHZvaWQgMCkKICAgICAgICAgIHJldHVybiBpID0gZS5sZW5ndGgsIHRoaXMuX2NhY2hlZEluZGV4ID0gaSwgdGhpcy5jb3B5U2FtcGxlVmFsdWVfKGkgLSAxKTsKICAgICAgfQogICAgICB0aGlzLl9jYWNoZWRJbmRleCA9IGksIHRoaXMuaW50ZXJ2YWxDaGFuZ2VkXyhpLCBzLCBuKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmludGVycG9sYXRlXyhpLCBzLCB0LCBuKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgaW50ZXJwb2xhdGlvbiBzZXR0aW5ncy4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gVGhlIGludGVycG9sYXRpb24gc2V0dGluZ3MuCiAgICovCiAgZ2V0U2V0dGluZ3NfKCkgewogICAgcmV0dXJuIHRoaXMuc2V0dGluZ3MgfHwgdGhpcy5EZWZhdWx0U2V0dGluZ3NfOwogIH0KICAvKioKICAgKiBDb3BpZXMgYSBzYW1wbGUgdmFsdWUgdG8gdGhlIHJlc3VsdCBidWZmZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBBbiBpbmRleCBpbnRvIHRoZSBzYW1wbGUgdmFsdWUgYnVmZmVyLgogICAqIEByZXR1cm4ge1R5cGVkQXJyYXl9IFRoZSByZXN1bHQgYnVmZmVyLgogICAqLwogIGNvcHlTYW1wbGVWYWx1ZV8odCkgewogICAgY29uc3QgZSA9IHRoaXMucmVzdWx0QnVmZmVyLCBpID0gdGhpcy5zYW1wbGVWYWx1ZXMsIG4gPSB0aGlzLnZhbHVlU2l6ZSwgcyA9IHQgKiBuOwogICAgZm9yIChsZXQgciA9IDA7IHIgIT09IG47ICsrcikKICAgICAgZVtyXSA9IGlbcyArIHJdOwogICAgcmV0dXJuIGU7CiAgfQogIC8qKgogICAqIENvcGllcyBhIHNhbXBsZSB2YWx1ZSB0byB0aGUgcmVzdWx0IGJ1ZmZlci4KICAgKgogICAqIEBhYnN0cmFjdAogICAqIEBwYXJhbSB7bnVtYmVyfSBpMSAtIEFuIGluZGV4IGludG8gdGhlIHNhbXBsZSB2YWx1ZSBidWZmZXIuCiAgICogQHBhcmFtIHtudW1iZXJ9IHQwIC0gVGhlIHByZXZpb3VzIGludGVycG9sYXRpb24gZmFjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gVGhlIGN1cnJlbnQgaW50ZXJwb2xhdGlvbiBmYWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IHQxIC0gVGhlIG5leHQgaW50ZXJwb2xhdGlvbiBmYWN0b3IuCiAgICogQHJldHVybiB7VHlwZWRBcnJheX0gVGhlIHJlc3VsdCBidWZmZXIuCiAgICovCiAgaW50ZXJwb2xhdGVfKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJjYWxsIHRvIGFic3RyYWN0IG1ldGhvZCIpOwogIH0KICAvKioKICAgKiBPcHRpb25hbCBtZXRob2QgdGhhdCBpcyBleGVjdXRlZCB3aGVuIHRoZSBpbnRlcnZhbCBoYXMgY2hhbmdlZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpMSAtIEFuIGluZGV4IGludG8gdGhlIHNhbXBsZSB2YWx1ZSBidWZmZXIuCiAgICogQHBhcmFtIHtudW1iZXJ9IHQwIC0gVGhlIHByZXZpb3VzIGludGVycG9sYXRpb24gZmFjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSB0IC0gVGhlIGN1cnJlbnQgaW50ZXJwb2xhdGlvbiBmYWN0b3IuCiAgICovCiAgaW50ZXJ2YWxDaGFuZ2VkXygpIHsKICB9Cn0KY2xhc3MgaV8gZXh0ZW5kcyBXbyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBjdWJpYyBpbnRlcnBvbGFudC4KICAgKgogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gcGFyYW1ldGVyUG9zaXRpb25zIC0gVGhlIHBhcmFtZXRlciBwb3NpdGlvbnMgaG9sZCB0aGUgaW50ZXJwb2xhdGlvbiBmYWN0b3JzLgogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gc2FtcGxlVmFsdWVzIC0gVGhlIHNhbXBsZSB2YWx1ZXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHNhbXBsZVNpemUgLSBUaGUgc2FtcGxlIHNpemUKICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IFtyZXN1bHRCdWZmZXJdIC0gVGhlIHJlc3VsdCBidWZmZXIuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbikgewogICAgc3VwZXIodCwgZSwgaSwgbiksIHRoaXMuX3dlaWdodFByZXYgPSAtMCwgdGhpcy5fb2Zmc2V0UHJldiA9IC0wLCB0aGlzLl93ZWlnaHROZXh0ID0gLTAsIHRoaXMuX29mZnNldE5leHQgPSAtMCwgdGhpcy5EZWZhdWx0U2V0dGluZ3NfID0gewogICAgICBlbmRpbmdTdGFydDogc3IsCiAgICAgIGVuZGluZ0VuZDogc3IKICAgIH07CiAgfQogIGludGVydmFsQ2hhbmdlZF8odCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMucGFyYW1ldGVyUG9zaXRpb25zOwogICAgbGV0IHMgPSB0IC0gMiwgciA9IHQgKyAxLCBvID0gbltzXSwgbCA9IG5bcl07CiAgICBpZiAobyA9PT0gdm9pZCAwKQogICAgICBzd2l0Y2ggKHRoaXMuZ2V0U2V0dGluZ3NfKCkuZW5kaW5nU3RhcnQpIHsKICAgICAgICBjYXNlIHJyOgogICAgICAgICAgcyA9IHQsIG8gPSAyICogZSAtIGk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIEFvOgogICAgICAgICAgcyA9IG4ubGVuZ3RoIC0gMiwgbyA9IGUgKyBuW3NdIC0gbltzICsgMV07CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcyA9IHQsIG8gPSBpOwogICAgICB9CiAgICBpZiAobCA9PT0gdm9pZCAwKQogICAgICBzd2l0Y2ggKHRoaXMuZ2V0U2V0dGluZ3NfKCkuZW5kaW5nRW5kKSB7CiAgICAgICAgY2FzZSBycjoKICAgICAgICAgIHIgPSB0LCBsID0gMiAqIGkgLSBlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBBbzoKICAgICAgICAgIHIgPSAxLCBsID0gaSArIG5bMV0gLSBuWzBdOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHIgPSB0IC0gMSwgbCA9IGU7CiAgICAgIH0KICAgIGNvbnN0IGggPSAoaSAtIGUpICogMC41LCBjID0gdGhpcy52YWx1ZVNpemU7CiAgICB0aGlzLl93ZWlnaHRQcmV2ID0gaCAvIChlIC0gbyksIHRoaXMuX3dlaWdodE5leHQgPSBoIC8gKGwgLSBpKSwgdGhpcy5fb2Zmc2V0UHJldiA9IHMgKiBjLCB0aGlzLl9vZmZzZXROZXh0ID0gciAqIGM7CiAgfQogIGludGVycG9sYXRlXyh0LCBlLCBpLCBuKSB7CiAgICBjb25zdCBzID0gdGhpcy5yZXN1bHRCdWZmZXIsIHIgPSB0aGlzLnNhbXBsZVZhbHVlcywgbyA9IHRoaXMudmFsdWVTaXplLCBsID0gdCAqIG8sIGggPSBsIC0gbywgYyA9IHRoaXMuX29mZnNldFByZXYsIHUgPSB0aGlzLl9vZmZzZXROZXh0LCBkID0gdGhpcy5fd2VpZ2h0UHJldiwgcCA9IHRoaXMuX3dlaWdodE5leHQsIGYgPSAoaSAtIGUpIC8gKG4gLSBlKSwgeSA9IGYgKiBmLCBnID0geSAqIGYsIG0gPSAtZCAqIGcgKyAyICogZCAqIHkgLSBkICogZiwgdiA9ICgxICsgZCkgKiBnICsgKC0xLjUgLSAyICogZCkgKiB5ICsgKC0wLjUgKyBkKSAqIGYgKyAxLCB4ID0gKC0xIC0gcCkgKiBnICsgKDEuNSArIHApICogeSArIDAuNSAqIGYsIF8gPSBwICogZyAtIHAgKiB5OwogICAgZm9yIChsZXQgUyA9IDA7IFMgIT09IG87ICsrUykKICAgICAgc1tTXSA9IG0gKiByW2MgKyBTXSArIHYgKiByW2ggKyBTXSArIHggKiByW2wgKyBTXSArIF8gKiByW3UgKyBTXTsKICAgIHJldHVybiBzOwogIH0KfQpjbGFzcyB0ZiBleHRlbmRzIFdvIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxpbmVhciBpbnRlcnBvbGFudC4KICAgKgogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gcGFyYW1ldGVyUG9zaXRpb25zIC0gVGhlIHBhcmFtZXRlciBwb3NpdGlvbnMgaG9sZCB0aGUgaW50ZXJwb2xhdGlvbiBmYWN0b3JzLgogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gc2FtcGxlVmFsdWVzIC0gVGhlIHNhbXBsZSB2YWx1ZXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHNhbXBsZVNpemUgLSBUaGUgc2FtcGxlIHNpemUKICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IFtyZXN1bHRCdWZmZXJdIC0gVGhlIHJlc3VsdCBidWZmZXIuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbikgewogICAgc3VwZXIodCwgZSwgaSwgbik7CiAgfQogIGludGVycG9sYXRlXyh0LCBlLCBpLCBuKSB7CiAgICBjb25zdCBzID0gdGhpcy5yZXN1bHRCdWZmZXIsIHIgPSB0aGlzLnNhbXBsZVZhbHVlcywgbyA9IHRoaXMudmFsdWVTaXplLCBsID0gdCAqIG8sIGggPSBsIC0gbywgYyA9IChpIC0gZSkgLyAobiAtIGUpLCB1ID0gMSAtIGM7CiAgICBmb3IgKGxldCBkID0gMDsgZCAhPT0gbzsgKytkKQogICAgICBzW2RdID0gcltoICsgZF0gKiB1ICsgcltsICsgZF0gKiBjOwogICAgcmV0dXJuIHM7CiAgfQp9CmNsYXNzIG5fIGV4dGVuZHMgV28gewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgZGlzY3JldGUgaW50ZXJwb2xhbnQuCiAgICoKICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IHBhcmFtZXRlclBvc2l0aW9ucyAtIFRoZSBwYXJhbWV0ZXIgcG9zaXRpb25zIGhvbGQgdGhlIGludGVycG9sYXRpb24gZmFjdG9ycy4KICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IHNhbXBsZVZhbHVlcyAtIFRoZSBzYW1wbGUgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzYW1wbGVTaXplIC0gVGhlIHNhbXBsZSBzaXplCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBbcmVzdWx0QnVmZmVyXSAtIFRoZSByZXN1bHQgYnVmZmVyLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4pIHsKICAgIHN1cGVyKHQsIGUsIGksIG4pOwogIH0KICBpbnRlcnBvbGF0ZV8odCkgewogICAgcmV0dXJuIHRoaXMuY29weVNhbXBsZVZhbHVlXyh0IC0gMSk7CiAgfQp9CmNsYXNzIFlpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGtleWZyYW1lIHRyYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUga2V5ZnJhbWUgdHJhY2sncyBuYW1lLgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdGltZXMgLSBBIGxpc3Qgb2Yga2V5ZnJhbWUgdGltZXMuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXJ8c3RyaW5nfGJvb2xlYW4+fSB2YWx1ZXMgLSBBIGxpc3Qgb2Yga2V5ZnJhbWUgdmFsdWVzLgogICAqIEBwYXJhbSB7KEludGVycG9sYXRlTGluZWFyfEludGVycG9sYXRlRGlzY3JldGV8SW50ZXJwb2xhdGVTbW9vdGgpfSBbaW50ZXJwb2xhdGlvbl0gLSBUaGUgaW50ZXJwb2xhdGlvbiB0eXBlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4pIHsKICAgIGlmICh0ID09PSB2b2lkIDApIHRocm93IG5ldyBFcnJvcigiVEhSRUUuS2V5ZnJhbWVUcmFjazogdHJhY2sgbmFtZSBpcyB1bmRlZmluZWQiKTsKICAgIGlmIChlID09PSB2b2lkIDAgfHwgZS5sZW5ndGggPT09IDApIHRocm93IG5ldyBFcnJvcigiVEhSRUUuS2V5ZnJhbWVUcmFjazogbm8ga2V5ZnJhbWVzIGluIHRyYWNrIG5hbWVkICIgKyB0KTsKICAgIHRoaXMubmFtZSA9IHQsIHRoaXMudGltZXMgPSBhcihlLCB0aGlzLlRpbWVCdWZmZXJUeXBlKSwgdGhpcy52YWx1ZXMgPSBhcihpLCB0aGlzLlZhbHVlQnVmZmVyVHlwZSksIHRoaXMuc2V0SW50ZXJwb2xhdGlvbihuIHx8IHRoaXMuRGVmYXVsdEludGVycG9sYXRpb24pOwogIH0KICAvKioKICAgKiBDb252ZXJ0cyB0aGUga2V5ZnJhbWUgdHJhY2sgdG8gSlNPTi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge0tleWZyYW1lVHJhY2t9IHRyYWNrIC0gVGhlIGtleWZyYW1lIHRyYWNrIHRvIHNlcmlhbGl6ZS4KICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBzZXJpYWxpemVkIGtleWZyYW1lIHRyYWNrIGFzIEpTT04uCiAgICovCiAgc3RhdGljIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gdC5jb25zdHJ1Y3RvcjsKICAgIGxldCBpOwogICAgaWYgKGUudG9KU09OICE9PSB0aGlzLnRvSlNPTikKICAgICAgaSA9IGUudG9KU09OKHQpOwogICAgZWxzZSB7CiAgICAgIGkgPSB7CiAgICAgICAgbmFtZTogdC5uYW1lLAogICAgICAgIHRpbWVzOiBhcih0LnRpbWVzLCBBcnJheSksCiAgICAgICAgdmFsdWVzOiBhcih0LnZhbHVlcywgQXJyYXkpCiAgICAgIH07CiAgICAgIGNvbnN0IG4gPSB0LmdldEludGVycG9sYXRpb24oKTsKICAgICAgbiAhPT0gdC5EZWZhdWx0SW50ZXJwb2xhdGlvbiAmJiAoaS5pbnRlcnBvbGF0aW9uID0gbik7CiAgICB9CiAgICByZXR1cm4gaS50eXBlID0gdC5WYWx1ZVR5cGVOYW1lLCBpOwogIH0KICAvKioKICAgKiBGYWN0b3J5IG1ldGhvZCBmb3IgY3JlYXRpbmcgYSBuZXcgZGlzY3JldGUgaW50ZXJwb2xhbnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBbcmVzdWx0XSAtIFRoZSByZXN1bHQgYnVmZmVyLgogICAqIEByZXR1cm4ge0Rpc2NyZXRlSW50ZXJwb2xhbnR9IFRoZSBuZXcgaW50ZXJwb2xhbnQuCiAgICovCiAgSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kRGlzY3JldGUodCkgewogICAgcmV0dXJuIG5ldyBuXyh0aGlzLnRpbWVzLCB0aGlzLnZhbHVlcywgdGhpcy5nZXRWYWx1ZVNpemUoKSwgdCk7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhIG5ldyBsaW5lYXIgaW50ZXJwb2xhbnQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBbcmVzdWx0XSAtIFRoZSByZXN1bHQgYnVmZmVyLgogICAqIEByZXR1cm4ge0xpbmVhckludGVycG9sYW50fSBUaGUgbmV3IGludGVycG9sYW50LgogICAqLwogIEludGVycG9sYW50RmFjdG9yeU1ldGhvZExpbmVhcih0KSB7CiAgICByZXR1cm4gbmV3IHRmKHRoaXMudGltZXMsIHRoaXMudmFsdWVzLCB0aGlzLmdldFZhbHVlU2l6ZSgpLCB0KTsKICB9CiAgLyoqCiAgICogRmFjdG9yeSBtZXRob2QgZm9yIGNyZWF0aW5nIGEgbmV3IHNtb290aCBpbnRlcnBvbGFudC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge1R5cGVkQXJyYXl9IFtyZXN1bHRdIC0gVGhlIHJlc3VsdCBidWZmZXIuCiAgICogQHJldHVybiB7Q3ViaWNJbnRlcnBvbGFudH0gVGhlIG5ldyBpbnRlcnBvbGFudC4KICAgKi8KICBJbnRlcnBvbGFudEZhY3RvcnlNZXRob2RTbW9vdGgodCkgewogICAgcmV0dXJuIG5ldyBpXyh0aGlzLnRpbWVzLCB0aGlzLnZhbHVlcywgdGhpcy5nZXRWYWx1ZVNpemUoKSwgdCk7CiAgfQogIC8qKgogICAqIERlZmluZXMgdGhlIGludGVycG9sYXRpb24gZmFjdG9yIG1ldGhvZCBmb3IgdGhpcyBrZXlmcmFtZSB0cmFjay4KICAgKgogICAqIEBwYXJhbSB7KEludGVycG9sYXRlTGluZWFyfEludGVycG9sYXRlRGlzY3JldGV8SW50ZXJwb2xhdGVTbW9vdGgpfSBpbnRlcnBvbGF0aW9uIC0gVGhlIGludGVycG9sYXRpb24gdHlwZS4KICAgKiBAcmV0dXJuIHtLZXlmcmFtZVRyYWNrfSBBIHJlZmVyZW5jZSB0byB0aGlzIGtleWZyYW1lIHRyYWNrLgogICAqLwogIHNldEludGVycG9sYXRpb24odCkgewogICAgbGV0IGU7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSB3bzoKICAgICAgICBlID0gdGhpcy5JbnRlcnBvbGFudEZhY3RvcnlNZXRob2REaXNjcmV0ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBmYzoKICAgICAgICBlID0gdGhpcy5JbnRlcnBvbGFudEZhY3RvcnlNZXRob2RMaW5lYXI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgYmg6CiAgICAgICAgZSA9IHRoaXMuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kU21vb3RoOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKGUgPT09IHZvaWQgMCkgewogICAgICBjb25zdCBpID0gInVuc3VwcG9ydGVkIGludGVycG9sYXRpb24gZm9yICIgKyB0aGlzLlZhbHVlVHlwZU5hbWUgKyAiIGtleWZyYW1lIHRyYWNrIG5hbWVkICIgKyB0aGlzLm5hbWU7CiAgICAgIGlmICh0aGlzLmNyZWF0ZUludGVycG9sYW50ID09PSB2b2lkIDApCiAgICAgICAgaWYgKHQgIT09IHRoaXMuRGVmYXVsdEludGVycG9sYXRpb24pCiAgICAgICAgICB0aGlzLnNldEludGVycG9sYXRpb24odGhpcy5EZWZhdWx0SW50ZXJwb2xhdGlvbik7CiAgICAgICAgZWxzZQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkpOwogICAgICByZXR1cm4gY29uc29sZS53YXJuKCJUSFJFRS5LZXlmcmFtZVRyYWNrOiIsIGkpLCB0aGlzOwogICAgfQogICAgcmV0dXJuIHRoaXMuY3JlYXRlSW50ZXJwb2xhbnQgPSBlLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGludGVycG9sYXRpb24gdHlwZS4KICAgKgogICAqIEByZXR1cm4geyhJbnRlcnBvbGF0ZUxpbmVhcnxJbnRlcnBvbGF0ZURpc2NyZXRlfEludGVycG9sYXRlU21vb3RoKX0gVGhlIGludGVycG9sYXRpb24gdHlwZS4KICAgKi8KICBnZXRJbnRlcnBvbGF0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLmNyZWF0ZUludGVycG9sYW50KSB7CiAgICAgIGNhc2UgdGhpcy5JbnRlcnBvbGFudEZhY3RvcnlNZXRob2REaXNjcmV0ZToKICAgICAgICByZXR1cm4gd287CiAgICAgIGNhc2UgdGhpcy5JbnRlcnBvbGFudEZhY3RvcnlNZXRob2RMaW5lYXI6CiAgICAgICAgcmV0dXJuIGZjOwogICAgICBjYXNlIHRoaXMuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kU21vb3RoOgogICAgICAgIHJldHVybiBiaDsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgdmFsdWUgc2l6ZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZhbHVlIHNpemUuCiAgICovCiAgZ2V0VmFsdWVTaXplKCkgewogICAgcmV0dXJuIHRoaXMudmFsdWVzLmxlbmd0aCAvIHRoaXMudGltZXMubGVuZ3RoOwogIH0KICAvKioKICAgKiBNb3ZlcyBhbGwga2V5ZnJhbWVzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIHRpbWUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdGltZU9mZnNldCAtIFRoZSBvZmZzZXQgdG8gbW92ZSB0aGUgdGltZSB2YWx1ZXMuCiAgICogQHJldHVybiB7S2V5ZnJhbWVUcmFja30gQSByZWZlcmVuY2UgdG8gdGhpcyBrZXlmcmFtZSB0cmFjay4KICAgKi8KICBzaGlmdCh0KSB7CiAgICBpZiAodCAhPT0gMCkgewogICAgICBjb25zdCBlID0gdGhpcy50aW1lczsKICAgICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSAhPT0gbjsgKytpKQogICAgICAgIGVbaV0gKz0gdDsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBTY2FsZSBhbGwga2V5ZnJhbWUgdGltZXMgYnkgYSBmYWN0b3IgKHVzZWZ1bCBmb3IgZnJhbWUgLSBzZWNvbmRzIGNvbnZlcnNpb25zKS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lU2NhbGUgLSBUaGUgdGltZSBzY2FsZS4KICAgKiBAcmV0dXJuIHtLZXlmcmFtZVRyYWNrfSBBIHJlZmVyZW5jZSB0byB0aGlzIGtleWZyYW1lIHRyYWNrLgogICAqLwogIHNjYWxlKHQpIHsKICAgIGlmICh0ICE9PSAxKSB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLnRpbWVzOwogICAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUubGVuZ3RoOyBpICE9PSBuOyArK2kpCiAgICAgICAgZVtpXSAqPSB0OwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFJlbW92ZXMga2V5ZnJhbWVzIGJlZm9yZSBhbmQgYWZ0ZXIgYW5pbWF0aW9uIHdpdGhvdXQgY2hhbmdpbmcgYW55IHZhbHVlcyB3aXRoaW4gdGhlIGRlZmluZWQgdGltZSByYW5nZS4KICAgKgogICAqIE5vdGU6IFRoZSBtZXRob2QgZG9lcyBub3Qgc2hpZnQgYXJvdW5kIGtleXMgdG8gdGhlIHN0YXJ0IG9mIHRoZSB0cmFjayB0aW1lLCBiZWNhdXNlIGZvciBpbnRlcnBvbGF0ZWQKICAgKiBrZXlzIHRoaXMgd2lsbCBjaGFuZ2UgdGhlaXIgdmFsdWVzCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRUaW1lIC0gVGhlIHN0YXJ0IHRpbWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGVuZFRpbWUgLSBUaGUgZW5kIHRpbWUuCiAgICogQHJldHVybiB7S2V5ZnJhbWVUcmFja30gQSByZWZlcmVuY2UgdG8gdGhpcyBrZXlmcmFtZSB0cmFjay4KICAgKi8KICB0cmltKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLnRpbWVzLCBuID0gaS5sZW5ndGg7CiAgICBsZXQgcyA9IDAsIHIgPSBuIC0gMTsKICAgIGZvciAoOyBzICE9PSBuICYmIGlbc10gPCB0OyApCiAgICAgICsrczsKICAgIGZvciAoOyByICE9PSAtMSAmJiBpW3JdID4gZTsgKQogICAgICAtLXI7CiAgICBpZiAoKytyLCBzICE9PSAwIHx8IHIgIT09IG4pIHsKICAgICAgcyA+PSByICYmIChyID0gTWF0aC5tYXgociwgMSksIHMgPSByIC0gMSk7CiAgICAgIGNvbnN0IG8gPSB0aGlzLmdldFZhbHVlU2l6ZSgpOwogICAgICB0aGlzLnRpbWVzID0gaS5zbGljZShzLCByKSwgdGhpcy52YWx1ZXMgPSB0aGlzLnZhbHVlcy5zbGljZShzICogbywgciAqIG8pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFBlcmZvcm1zIG1pbmltYWwgdmFsaWRhdGlvbiBvbiB0aGUga2V5ZnJhbWUgdHJhY2suIFJldHVybnMgYHRydWVgIGlmIHRoZSB2YWx1ZXMKICAgKiBhcmUgdmFsaWQuCiAgICoKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBrZXlmcmFtZXMgYXJlIHZhbGlkIG9yIG5vdC4KICAgKi8KICB2YWxpZGF0ZSgpIHsKICAgIGxldCB0ID0gITA7CiAgICBjb25zdCBlID0gdGhpcy5nZXRWYWx1ZVNpemUoKTsKICAgIGUgLSBNYXRoLmZsb29yKGUpICE9PSAwICYmIChjb25zb2xlLmVycm9yKCJUSFJFRS5LZXlmcmFtZVRyYWNrOiBJbnZhbGlkIHZhbHVlIHNpemUgaW4gdHJhY2suIiwgdGhpcyksIHQgPSAhMSk7CiAgICBjb25zdCBpID0gdGhpcy50aW1lcywgbiA9IHRoaXMudmFsdWVzLCBzID0gaS5sZW5ndGg7CiAgICBzID09PSAwICYmIChjb25zb2xlLmVycm9yKCJUSFJFRS5LZXlmcmFtZVRyYWNrOiBUcmFjayBpcyBlbXB0eS4iLCB0aGlzKSwgdCA9ICExKTsKICAgIGxldCByID0gbnVsbDsKICAgIGZvciAobGV0IG8gPSAwOyBvICE9PSBzOyBvKyspIHsKICAgICAgY29uc3QgbCA9IGlbb107CiAgICAgIGlmICh0eXBlb2YgbCA9PSAibnVtYmVyIiAmJiBpc05hTihsKSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLktleWZyYW1lVHJhY2s6IFRpbWUgaXMgbm90IGEgdmFsaWQgbnVtYmVyLiIsIHRoaXMsIG8sIGwpLCB0ID0gITE7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgaWYgKHIgIT09IG51bGwgJiYgciA+IGwpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5LZXlmcmFtZVRyYWNrOiBPdXQgb2Ygb3JkZXIga2V5cy4iLCB0aGlzLCBvLCBsLCByKSwgdCA9ICExOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHIgPSBsOwogICAgfQogICAgaWYgKG4gIT09IHZvaWQgMCAmJiB0XyhuKSkKICAgICAgZm9yIChsZXQgbyA9IDAsIGwgPSBuLmxlbmd0aDsgbyAhPT0gbDsgKytvKSB7CiAgICAgICAgY29uc3QgaCA9IG5bb107CiAgICAgICAgaWYgKGlzTmFOKGgpKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5LZXlmcmFtZVRyYWNrOiBWYWx1ZSBpcyBub3QgYSB2YWxpZCBudW1iZXIuIiwgdGhpcywgbywgaCksIHQgPSAhMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgcmV0dXJuIHQ7CiAgfQogIC8qKgogICAqIE9wdGltaXplcyB0aGlzIGtleWZyYW1lIHRyYWNrIGJ5IHJlbW92aW5nIGVxdWl2YWxlbnQgc2VxdWVudGlhbCBrZXlzICh3aGljaCBhcmUKICAgKiBjb21tb24gaW4gbW9ycGggdGFyZ2V0IHNlcXVlbmNlcykuCiAgICoKICAgKiBAcmV0dXJuIHtBbmltYXRpb25DbGlwfSBBIHJlZmVyZW5jZSB0byB0aGlzIGFuaW1hdGlvbiBjbGlwLgogICAqLwogIG9wdGltaXplKCkgewogICAgY29uc3QgdCA9IHRoaXMudGltZXMuc2xpY2UoKSwgZSA9IHRoaXMudmFsdWVzLnNsaWNlKCksIGkgPSB0aGlzLmdldFZhbHVlU2l6ZSgpLCBuID0gdGhpcy5nZXRJbnRlcnBvbGF0aW9uKCkgPT09IGJoLCBzID0gdC5sZW5ndGggLSAxOwogICAgbGV0IHIgPSAxOwogICAgZm9yIChsZXQgbyA9IDE7IG8gPCBzOyArK28pIHsKICAgICAgbGV0IGwgPSAhMTsKICAgICAgY29uc3QgaCA9IHRbb10sIGMgPSB0W28gKyAxXTsKICAgICAgaWYgKGggIT09IGMgJiYgKG8gIT09IDEgfHwgaCAhPT0gdFswXSkpCiAgICAgICAgaWYgKG4pCiAgICAgICAgICBsID0gITA7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBjb25zdCB1ID0gbyAqIGksIGQgPSB1IC0gaSwgcCA9IHUgKyBpOwogICAgICAgICAgZm9yIChsZXQgZiA9IDA7IGYgIT09IGk7ICsrZikgewogICAgICAgICAgICBjb25zdCB5ID0gZVt1ICsgZl07CiAgICAgICAgICAgIGlmICh5ICE9PSBlW2QgKyBmXSB8fCB5ICE9PSBlW3AgKyBmXSkgewogICAgICAgICAgICAgIGwgPSAhMDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgaWYgKGwpIHsKICAgICAgICBpZiAobyAhPT0gcikgewogICAgICAgICAgdFtyXSA9IHRbb107CiAgICAgICAgICBjb25zdCB1ID0gbyAqIGksIGQgPSByICogaTsKICAgICAgICAgIGZvciAobGV0IHAgPSAwOyBwICE9PSBpOyArK3ApCiAgICAgICAgICAgIGVbZCArIHBdID0gZVt1ICsgcF07CiAgICAgICAgfQogICAgICAgICsrcjsKICAgICAgfQogICAgfQogICAgaWYgKHMgPiAwKSB7CiAgICAgIHRbcl0gPSB0W3NdOwogICAgICBmb3IgKGxldCBvID0gcyAqIGksIGwgPSByICogaSwgaCA9IDA7IGggIT09IGk7ICsraCkKICAgICAgICBlW2wgKyBoXSA9IGVbbyArIGhdOwogICAgICArK3I7CiAgICB9CiAgICByZXR1cm4gciAhPT0gdC5sZW5ndGggPyAodGhpcy50aW1lcyA9IHQuc2xpY2UoMCwgciksIHRoaXMudmFsdWVzID0gZS5zbGljZSgwLCByICogaSkpIDogKHRoaXMudGltZXMgPSB0LCB0aGlzLnZhbHVlcyA9IGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IGtleWZyYW1lIHRyYWNrIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtLZXlmcmFtZVRyYWNrfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICBjb25zdCB0ID0gdGhpcy50aW1lcy5zbGljZSgpLCBlID0gdGhpcy52YWx1ZXMuc2xpY2UoKSwgaSA9IHRoaXMuY29uc3RydWN0b3IsIG4gPSBuZXcgaSh0aGlzLm5hbWUsIHQsIGUpOwogICAgcmV0dXJuIG4uY3JlYXRlSW50ZXJwb2xhbnQgPSB0aGlzLmNyZWF0ZUludGVycG9sYW50LCBuOwogIH0KfQpZaS5wcm90b3R5cGUuVmFsdWVUeXBlTmFtZSA9ICIiOwpZaS5wcm90b3R5cGUuVGltZUJ1ZmZlclR5cGUgPSBGbG9hdDMyQXJyYXk7CllpLnByb3RvdHlwZS5WYWx1ZUJ1ZmZlclR5cGUgPSBGbG9hdDMyQXJyYXk7CllpLnByb3RvdHlwZS5EZWZhdWx0SW50ZXJwb2xhdGlvbiA9IGZjOwpjbGFzcyBnciBleHRlbmRzIFlpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJvb2xlYW4ga2V5ZnJhbWUgdHJhY2suCiAgICoKICAgKiBUaGlzIGtleWZyYW1lIHRyYWNrIHR5cGUgaGFzIG5vIGBpbnRlcnBvbGF0aW9uYCBwYXJhbWV0ZXIgYmVjYXVzZSB0aGUKICAgKiBpbnRlcnBvbGF0aW9uIGlzIGFsd2F5cyBkaXNjcmV0ZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIGtleWZyYW1lIHRyYWNrJ3MgbmFtZS4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHRpbWVzIC0gQSBsaXN0IG9mIGtleWZyYW1lIHRpbWVzLgogICAqIEBwYXJhbSB7QXJyYXk8Ym9vbGVhbj59IHZhbHVlcyAtIEEgbGlzdCBvZiBrZXlmcmFtZSB2YWx1ZXMuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIodCwgZSwgaSk7CiAgfQp9CmdyLnByb3RvdHlwZS5WYWx1ZVR5cGVOYW1lID0gImJvb2wiOwpnci5wcm90b3R5cGUuVmFsdWVCdWZmZXJUeXBlID0gQXJyYXk7CmdyLnByb3RvdHlwZS5EZWZhdWx0SW50ZXJwb2xhdGlvbiA9IHdvOwpnci5wcm90b3R5cGUuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kTGluZWFyID0gdm9pZCAwOwpnci5wcm90b3R5cGUuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kU21vb3RoID0gdm9pZCAwOwpjbGFzcyBlZiBleHRlbmRzIFlpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGNvbG9yIGtleWZyYW1lIHRyYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUga2V5ZnJhbWUgdHJhY2sncyBuYW1lLgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdGltZXMgLSBBIGxpc3Qgb2Yga2V5ZnJhbWUgdGltZXMuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2YWx1ZXMgLSBBIGxpc3Qgb2Yga2V5ZnJhbWUgdmFsdWVzLgogICAqIEBwYXJhbSB7KEludGVycG9sYXRlTGluZWFyfEludGVycG9sYXRlRGlzY3JldGV8SW50ZXJwb2xhdGVTbW9vdGgpfSBbaW50ZXJwb2xhdGlvbl0gLSBUaGUgaW50ZXJwb2xhdGlvbiB0eXBlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4pIHsKICAgIHN1cGVyKHQsIGUsIGksIG4pOwogIH0KfQplZi5wcm90b3R5cGUuVmFsdWVUeXBlTmFtZSA9ICJjb2xvciI7CmNsYXNzIEZvIGV4dGVuZHMgWWkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbnVtYmVyIGtleWZyYW1lIHRyYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUga2V5ZnJhbWUgdHJhY2sncyBuYW1lLgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdGltZXMgLSBBIGxpc3Qgb2Yga2V5ZnJhbWUgdGltZXMuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2YWx1ZXMgLSBBIGxpc3Qgb2Yga2V5ZnJhbWUgdmFsdWVzLgogICAqIEBwYXJhbSB7KEludGVycG9sYXRlTGluZWFyfEludGVycG9sYXRlRGlzY3JldGV8SW50ZXJwb2xhdGVTbW9vdGgpfSBbaW50ZXJwb2xhdGlvbl0gLSBUaGUgaW50ZXJwb2xhdGlvbiB0eXBlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4pIHsKICAgIHN1cGVyKHQsIGUsIGksIG4pOwogIH0KfQpGby5wcm90b3R5cGUuVmFsdWVUeXBlTmFtZSA9ICJudW1iZXIiOwpjbGFzcyBzXyBleHRlbmRzIFdvIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IFNMRVJQIGludGVycG9sYW50LgogICAqCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBwYXJhbWV0ZXJQb3NpdGlvbnMgLSBUaGUgcGFyYW1ldGVyIHBvc2l0aW9ucyBob2xkIHRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvcnMuCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBzYW1wbGVWYWx1ZXMgLSBUaGUgc2FtcGxlIHZhbHVlcy4KICAgKiBAcGFyYW0ge251bWJlcn0gc2FtcGxlU2l6ZSAtIFRoZSBzYW1wbGUgc2l6ZQogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gW3Jlc3VsdEJ1ZmZlcl0gLSBUaGUgcmVzdWx0IGJ1ZmZlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuKSB7CiAgICBzdXBlcih0LCBlLCBpLCBuKTsKICB9CiAgaW50ZXJwb2xhdGVfKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSB0aGlzLnJlc3VsdEJ1ZmZlciwgciA9IHRoaXMuc2FtcGxlVmFsdWVzLCBvID0gdGhpcy52YWx1ZVNpemUsIGwgPSAoaSAtIGUpIC8gKG4gLSBlKTsKICAgIGxldCBoID0gdCAqIG87CiAgICBmb3IgKGxldCBjID0gaCArIG87IGggIT09IGM7IGggKz0gNCkKICAgICAgdmUuc2xlcnBGbGF0KHMsIDAsIHIsIGggLSBvLCByLCBoLCBsKTsKICAgIHJldHVybiBzOwogIH0KfQpjbGFzcyBQYSBleHRlbmRzIFlpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IFF1YXRlcm5pb24ga2V5ZnJhbWUgdHJhY2suCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBrZXlmcmFtZSB0cmFjaydzIG5hbWUuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB0aW1lcyAtIEEgbGlzdCBvZiBrZXlmcmFtZSB0aW1lcy4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHZhbHVlcyAtIEEgbGlzdCBvZiBrZXlmcmFtZSB2YWx1ZXMuCiAgICogQHBhcmFtIHsoSW50ZXJwb2xhdGVMaW5lYXJ8SW50ZXJwb2xhdGVEaXNjcmV0ZXxJbnRlcnBvbGF0ZVNtb290aCl9IFtpbnRlcnBvbGF0aW9uXSAtIFRoZSBpbnRlcnBvbGF0aW9uIHR5cGUuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbikgewogICAgc3VwZXIodCwgZSwgaSwgbik7CiAgfQogIC8qKgogICAqIE92ZXJ3cml0dGVuIHNvIHRoZSBtZXRob2QgcmV0dXJucyBRdWF0ZXJuaW9uIGJhc2VkIGludGVycG9sYW50LgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7VHlwZWRBcnJheX0gW3Jlc3VsdF0gLSBUaGUgcmVzdWx0IGJ1ZmZlci4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9uTGluZWFySW50ZXJwb2xhbnR9IFRoZSBuZXcgaW50ZXJwb2xhbnQuCiAgICovCiAgSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kTGluZWFyKHQpIHsKICAgIHJldHVybiBuZXcgc18odGhpcy50aW1lcywgdGhpcy52YWx1ZXMsIHRoaXMuZ2V0VmFsdWVTaXplKCksIHQpOwogIH0KfQpQYS5wcm90b3R5cGUuVmFsdWVUeXBlTmFtZSA9ICJxdWF0ZXJuaW9uIjsKUGEucHJvdG90eXBlLkludGVycG9sYW50RmFjdG9yeU1ldGhvZFNtb290aCA9IHZvaWQgMDsKY2xhc3MgeXIgZXh0ZW5kcyBZaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBzdHJpbmcga2V5ZnJhbWUgdHJhY2suCiAgICoKICAgKiBUaGlzIGtleWZyYW1lIHRyYWNrIHR5cGUgaGFzIG5vIGBpbnRlcnBvbGF0aW9uYCBwYXJhbWV0ZXIgYmVjYXVzZSB0aGUKICAgKiBpbnRlcnBvbGF0aW9uIGlzIGFsd2F5cyBkaXNjcmV0ZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIGtleWZyYW1lIHRyYWNrJ3MgbmFtZS4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHRpbWVzIC0gQSBsaXN0IG9mIGtleWZyYW1lIHRpbWVzLgogICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gdmFsdWVzIC0gQSBsaXN0IG9mIGtleWZyYW1lIHZhbHVlcy4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBzdXBlcih0LCBlLCBpKTsKICB9Cn0KeXIucHJvdG90eXBlLlZhbHVlVHlwZU5hbWUgPSAic3RyaW5nIjsKeXIucHJvdG90eXBlLlZhbHVlQnVmZmVyVHlwZSA9IEFycmF5Owp5ci5wcm90b3R5cGUuRGVmYXVsdEludGVycG9sYXRpb24gPSB3bzsKeXIucHJvdG90eXBlLkludGVycG9sYW50RmFjdG9yeU1ldGhvZExpbmVhciA9IHZvaWQgMDsKeXIucHJvdG90eXBlLkludGVycG9sYW50RmFjdG9yeU1ldGhvZFNtb290aCA9IHZvaWQgMDsKY2xhc3MgYmEgZXh0ZW5kcyBZaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyB2ZWN0b3Iga2V5ZnJhbWUgdHJhY2suCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBrZXlmcmFtZSB0cmFjaydzIG5hbWUuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB0aW1lcyAtIEEgbGlzdCBvZiBrZXlmcmFtZSB0aW1lcy4KICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHZhbHVlcyAtIEEgbGlzdCBvZiBrZXlmcmFtZSB2YWx1ZXMuCiAgICogQHBhcmFtIHsoSW50ZXJwb2xhdGVMaW5lYXJ8SW50ZXJwb2xhdGVEaXNjcmV0ZXxJbnRlcnBvbGF0ZVNtb290aCl9IFtpbnRlcnBvbGF0aW9uXSAtIFRoZSBpbnRlcnBvbGF0aW9uIHR5cGUuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbikgewogICAgc3VwZXIodCwgZSwgaSwgbik7CiAgfQp9CmJhLnByb3RvdHlwZS5WYWx1ZVR5cGVOYW1lID0gInZlY3RvciI7CmNsYXNzIE1hIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGFuaW1hdGlvbiBjbGlwLgogICAqCiAgICogTm90ZTogSW5zdGVhZCBvZiBpbnN0YW50aWF0aW5nIGFuIEFuaW1hdGlvbkNsaXAgZGlyZWN0bHkgd2l0aCB0aGUgY29uc3RydWN0b3IsIHlvdSBjYW4KICAgKiB1c2UgdGhlIHN0YXRpYyBpbnRlcmZhY2Ugb2YgdGhpcyBjbGFzcyBmb3IgY3JlYXRpbmcgY2xpcHMuIEluIG1vc3QgY2FzZXMgdGhvdWdoLCBhbmltYXRpb24gY2xpcHMKICAgKiB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgY3JlYXRlZCBieSBsb2FkZXJzIHdoZW4gaW1wb3J0aW5nIGFuaW1hdGVkIDNEIGFzc2V0cy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT0nJ10gLSBUaGUgY2xpcCdzIG5hbWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0tMV0gLSBUaGUgY2xpcCdzIGR1cmF0aW9uIGluIHNlY29uZHMuIElmIGEgbmVnYXRpdmUgdmFsdWUgaXMgcGFzc2VkLAogICAqIHRoZSBkdXJhdGlvbiB3aWxsIGJlIGNhbGN1bGF0ZWQgZnJvbSB0aGUgcGFzc2VkIGtleWZyYW1lcy4KICAgKiBAcGFyYW0ge0FycmF5PEtleWZyYW1lVHJhY2s+fSB0cmFja3MgLSBBbiBhcnJheSBvZiBrZXlmcmFtZSB0cmFja3MuCiAgICogQHBhcmFtIHsoTm9ybWFsQW5pbWF0aW9uQmxlbmRNb2RlfEFkZGl0aXZlQW5pbWF0aW9uQmxlbmRNb2RlKX0gW2JsZW5kTW9kZT1Ob3JtYWxBbmltYXRpb25CbGVuZE1vZGVdIC0gRGVmaW5lcyBob3cgdGhlIGFuaW1hdGlvbgogICAqIGlzIGJsZW5kZWQvY29tYmluZWQgd2hlbiB0d28gb3IgbW9yZSBhbmltYXRpb25zIGFyZSBzaW11bHRhbmVvdXNseSBwbGF5ZWQuCiAgICovCiAgY29uc3RydWN0b3IodCA9ICIiLCBlID0gLTEsIGkgPSBbXSwgbiA9IFVjKSB7CiAgICB0aGlzLm5hbWUgPSB0LCB0aGlzLnRyYWNrcyA9IGksIHRoaXMuZHVyYXRpb24gPSBlLCB0aGlzLmJsZW5kTW9kZSA9IG4sIHRoaXMudXVpZCA9IE9pKCksIHRoaXMudXNlckRhdGEgPSB7fSwgdGhpcy5kdXJhdGlvbiA8IDAgJiYgdGhpcy5yZXNldER1cmF0aW9uKCk7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhbiBhbmltYXRpb24gY2xpcCBmcm9tIHRoZSBnaXZlbiBKU09OLgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIHNlcmlhbGl6ZWQgYW5pbWF0aW9uIGNsaXAuCiAgICogQHJldHVybiB7QW5pbWF0aW9uQ2xpcH0gVGhlIG5ldyBhbmltYXRpb24gY2xpcC4KICAgKi8KICBzdGF0aWMgcGFyc2UodCkgewogICAgY29uc3QgZSA9IFtdLCBpID0gdC50cmFja3MsIG4gPSAxIC8gKHQuZnBzIHx8IDEpOwogICAgZm9yIChsZXQgciA9IDAsIG8gPSBpLmxlbmd0aDsgciAhPT0gbzsgKytyKQogICAgICBlLnB1c2goemIoaVtyXSkuc2NhbGUobikpOwogICAgY29uc3QgcyA9IG5ldyB0aGlzKHQubmFtZSwgdC5kdXJhdGlvbiwgZSwgdC5ibGVuZE1vZGUpOwogICAgcmV0dXJuIHMudXVpZCA9IHQudXVpZCwgcy51c2VyRGF0YSA9IEpTT04ucGFyc2UodC51c2VyRGF0YSB8fCAie30iKSwgczsKICB9CiAgLyoqCiAgICogU2VyaWFsaXplcyB0aGUgZ2l2ZW4gYW5pbWF0aW9uIGNsaXAgaW50byBKU09OLgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7QW5pbWF0aW9uQ2xpcH0gY2xpcCAtIFRoZSBhbmltYXRpb24gY2xpcCB0byBzZXJpYWxpemUuCiAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgSlNPTiBvYmplY3QuCiAgICovCiAgc3RhdGljIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gW10sIGkgPSB0LnRyYWNrcywgbiA9IHsKICAgICAgbmFtZTogdC5uYW1lLAogICAgICBkdXJhdGlvbjogdC5kdXJhdGlvbiwKICAgICAgdHJhY2tzOiBlLAogICAgICB1dWlkOiB0LnV1aWQsCiAgICAgIGJsZW5kTW9kZTogdC5ibGVuZE1vZGUsCiAgICAgIHVzZXJEYXRhOiBKU09OLnN0cmluZ2lmeSh0LnVzZXJEYXRhKQogICAgfTsKICAgIGZvciAobGV0IHMgPSAwLCByID0gaS5sZW5ndGg7IHMgIT09IHI7ICsrcykKICAgICAgZS5wdXNoKFlpLnRvSlNPTihpW3NdKSk7CiAgICByZXR1cm4gbjsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBhbmltYXRpb24gY2xpcCBmcm9tIHRoZSBwYXNzZWQgbW9ycGggdGFyZ2V0cyBhcnJheSBvZiBhCiAgICogZ2VvbWV0cnksIHRha2luZyBhIG5hbWUgYW5kIHRoZSBudW1iZXIgb2YgZnJhbWVzIHBlciBzZWNvbmQuCiAgICoKICAgKiBOb3RlOiBUaGUgZnBzIHBhcmFtZXRlciBpcyByZXF1aXJlZCwgYnV0IHRoZSBhbmltYXRpb24gc3BlZWQgY2FuIGJlCiAgICogb3ZlcnJpZGRlbiB2aWEge0BsaW5rIEFuaW1hdGlvbkFjdGlvbiNzZXREdXJhdGlvbn0uCiAgICoKICAgKiBAc3RhdGljCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIGNsaXAuCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBtb3JwaFRhcmdldFNlcXVlbmNlIC0gQSBzZXF1ZW5jZSBvZiBtb3JwaCB0YXJnZXRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBmcHMgLSBUaGUgRnJhbWVzLVBlci1TZWNvbmQgdmFsdWUuCiAgICogQHBhcmFtIHtib29sZWFufSBub0xvb3AgLSBXaGV0aGVyIHRoZSBjbGlwIHNob3VsZCBiZSBubyBsb29wIG9yIG5vdC4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25DbGlwfSBUaGUgbmV3IGFuaW1hdGlvbiBjbGlwLgogICAqLwogIHN0YXRpYyBDcmVhdGVGcm9tTW9ycGhUYXJnZXRTZXF1ZW5jZSh0LCBlLCBpLCBuKSB7CiAgICBjb25zdCBzID0gZS5sZW5ndGgsIHIgPSBbXTsKICAgIGZvciAobGV0IG8gPSAwOyBvIDwgczsgbysrKSB7CiAgICAgIGxldCBsID0gW10sIGggPSBbXTsKICAgICAgbC5wdXNoKAogICAgICAgIChvICsgcyAtIDEpICUgcywKICAgICAgICBvLAogICAgICAgIChvICsgMSkgJSBzCiAgICAgICksIGgucHVzaCgwLCAxLCAwKTsKICAgICAgY29uc3QgYyA9IGVfKGwpOwogICAgICBsID0gc3AobCwgMSwgYyksIGggPSBzcChoLCAxLCBjKSwgIW4gJiYgbFswXSA9PT0gMCAmJiAobC5wdXNoKHMpLCBoLnB1c2goaFswXSkpLCByLnB1c2goCiAgICAgICAgbmV3IEZvKAogICAgICAgICAgIi5tb3JwaFRhcmdldEluZmx1ZW5jZXNbIiArIGVbb10ubmFtZSArICJdIiwKICAgICAgICAgIGwsCiAgICAgICAgICBoCiAgICAgICAgKS5zY2FsZSgxIC8gaSkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBuZXcgdGhpcyh0LCAtMSwgcik7CiAgfQogIC8qKgogICAqIFNlYXJjaGVzIGZvciBhbiBhbmltYXRpb24gY2xpcCBieSBuYW1lLCB0YWtpbmcgYXMgaXRzIGZpcnN0IHBhcmFtZXRlcgogICAqIGVpdGhlciBhbiBhcnJheSBvZiBjbGlwcywgb3IgYSBtZXNoIG9yIGdlb21ldHJ5IHRoYXQgY29udGFpbnMgYW4KICAgKiBhcnJheSBuYW1lZCAiYW5pbWF0aW9ucyIgcHJvcGVydHkuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHBhcmFtIHsoQXJyYXk8QW5pbWF0aW9uQ2xpcD58T2JqZWN0M0QpfSBvYmplY3RPckNsaXBBcnJheSAtIFRoZSBhcnJheSBvciBvYmplY3QgdG8gc2VhcmNoIHRocm91Z2guCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSB0byBzZWFyY2ggZm9yLgogICAqIEByZXR1cm4gez9BbmltYXRpb25DbGlwfSBUaGUgZm91bmQgYW5pbWF0aW9uIGNsaXAuIFJldHVybnMgYG51bGxgIGlmIG5vIGNsaXAgaGFzIGJlZW4gZm91bmQuCiAgICovCiAgc3RhdGljIGZpbmRCeU5hbWUodCwgZSkgewogICAgbGV0IGkgPSB0OwogICAgaWYgKCFBcnJheS5pc0FycmF5KHQpKSB7CiAgICAgIGNvbnN0IG4gPSB0OwogICAgICBpID0gbi5nZW9tZXRyeSAmJiBuLmdlb21ldHJ5LmFuaW1hdGlvbnMgfHwgbi5hbmltYXRpb25zOwogICAgfQogICAgZm9yIChsZXQgbiA9IDA7IG4gPCBpLmxlbmd0aDsgbisrKQogICAgICBpZiAoaVtuXS5uYW1lID09PSBlKQogICAgICAgIHJldHVybiBpW25dOwogICAgcmV0dXJuIG51bGw7CiAgfQogIC8qKgogICAqIFJldHVybnMgYW4gYXJyYXkgb2YgbmV3IEFuaW1hdGlvbkNsaXBzIGNyZWF0ZWQgZnJvbSB0aGUgbW9ycGggdGFyZ2V0CiAgICogc2VxdWVuY2VzIG9mIGEgZ2VvbWV0cnksIHRyeWluZyB0byBzb3J0IG1vcnBoIHRhcmdldCBuYW1lcyBpbnRvCiAgICogYW5pbWF0aW9uLWdyb3VwLWJhc2VkIHBhdHRlcm5zIGxpa2UgIldhbGtfMDAxLCBXYWxrXzAwMiwgUnVuXzAwMSwgUnVuXzAwMi4uLiIuCiAgICoKICAgKiBTZWUge0BsaW5rIE1EMkxvYWRlciNwYXJzZX0gYXMgYW4gZXhhbXBsZSBmb3IgaG93IHRoZSBtZXRob2Qgc2hvdWxkIGJlIHVzZWQuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBtb3JwaFRhcmdldHMgLSBBIHNlcXVlbmNlIG9mIG1vcnBoIHRhcmdldHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGZwcyAtIFRoZSBGcmFtZXMtUGVyLVNlY29uZCB2YWx1ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IG5vTG9vcCAtIFdoZXRoZXIgdGhlIGNsaXAgc2hvdWxkIGJlIG5vIGxvb3Agb3Igbm90LgogICAqIEByZXR1cm4ge0FycmF5PEFuaW1hdGlvbkNsaXA+fSBBbiBhcnJheSBvZiBuZXcgYW5pbWF0aW9uIGNsaXBzLgogICAqLwogIHN0YXRpYyBDcmVhdGVDbGlwc0Zyb21Nb3JwaFRhcmdldFNlcXVlbmNlcyh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0ge30sIHMgPSAvXihbXHctXSo/KShbXGRdKykkLzsKICAgIGZvciAobGV0IG8gPSAwLCBsID0gdC5sZW5ndGg7IG8gPCBsOyBvKyspIHsKICAgICAgY29uc3QgaCA9IHRbb10sIGMgPSBoLm5hbWUubWF0Y2gocyk7CiAgICAgIGlmIChjICYmIGMubGVuZ3RoID4gMSkgewogICAgICAgIGNvbnN0IHUgPSBjWzFdOwogICAgICAgIGxldCBkID0gblt1XTsKICAgICAgICBkIHx8IChuW3VdID0gZCA9IFtdKSwgZC5wdXNoKGgpOwogICAgICB9CiAgICB9CiAgICBjb25zdCByID0gW107CiAgICBmb3IgKGNvbnN0IG8gaW4gbikKICAgICAgci5wdXNoKHRoaXMuQ3JlYXRlRnJvbU1vcnBoVGFyZ2V0U2VxdWVuY2UobywgbltvXSwgZSwgaSkpOwogICAgcmV0dXJuIHI7CiAgfQogIC8qKgogICAqIFBhcnNlcyB0aGUgYGFuaW1hdGlvbi5oaWVyYXJjaHlgIGZvcm1hdCBhbmQgcmV0dXJucyBhIG5ldyBhbmltYXRpb24gY2xpcC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAZGVwcmVjYXRlZCBzaW5jZSByMTc1LgogICAqIEBwYXJhbSB7T2JqZWN0fSBhbmltYXRpb24gLSBBIHNlcmlhbGl6ZWQgYW5pbWF0aW9uIGNsaXAgYXMgSlNPTi4KICAgKiBAcGFyYW0ge0FycmF5PEJvbmVzPn0gYm9uZXMgLSBBbiBhcnJheSBvZiBib25lcy4KICAgKiBAcmV0dXJuIHs/QW5pbWF0aW9uQ2xpcH0gVGhlIG5ldyBhbmltYXRpb24gY2xpcC4KICAgKi8KICBzdGF0aWMgcGFyc2VBbmltYXRpb24odCwgZSkgewogICAgaWYgKGNvbnNvbGUud2FybigiVEhSRUUuQW5pbWF0aW9uQ2xpcDogcGFyc2VBbmltYXRpb24oKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgd2l0aCByMTg1IiksICF0KQogICAgICByZXR1cm4gY29uc29sZS5lcnJvcigiVEhSRUUuQW5pbWF0aW9uQ2xpcDogTm8gYW5pbWF0aW9uIGluIEpTT05Mb2FkZXIgZGF0YS4iKSwgbnVsbDsKICAgIGNvbnN0IGkgPSBmdW5jdGlvbih1LCBkLCBwLCBmLCB5KSB7CiAgICAgIGlmIChwLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGNvbnN0IGcgPSBbXSwgbSA9IFtdOwogICAgICAgIFFwKHAsIGcsIG0sIGYpLCBnLmxlbmd0aCAhPT0gMCAmJiB5LnB1c2gobmV3IHUoZCwgZywgbSkpOwogICAgICB9CiAgICB9LCBuID0gW10sIHMgPSB0Lm5hbWUgfHwgImRlZmF1bHQiLCByID0gdC5mcHMgfHwgMzAsIG8gPSB0LmJsZW5kTW9kZTsKICAgIGxldCBsID0gdC5sZW5ndGggfHwgLTE7CiAgICBjb25zdCBoID0gdC5oaWVyYXJjaHkgfHwgW107CiAgICBmb3IgKGxldCB1ID0gMDsgdSA8IGgubGVuZ3RoOyB1KyspIHsKICAgICAgY29uc3QgZCA9IGhbdV0ua2V5czsKICAgICAgaWYgKCEoIWQgfHwgZC5sZW5ndGggPT09IDApKQogICAgICAgIGlmIChkWzBdLm1vcnBoVGFyZ2V0cykgewogICAgICAgICAgY29uc3QgcCA9IHt9OwogICAgICAgICAgbGV0IGY7CiAgICAgICAgICBmb3IgKGYgPSAwOyBmIDwgZC5sZW5ndGg7IGYrKykKICAgICAgICAgICAgaWYgKGRbZl0ubW9ycGhUYXJnZXRzKQogICAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgZFtmXS5tb3JwaFRhcmdldHMubGVuZ3RoOyB5KyspCiAgICAgICAgICAgICAgICBwW2RbZl0ubW9ycGhUYXJnZXRzW3ldXSA9IC0xOwogICAgICAgICAgZm9yIChjb25zdCB5IGluIHApIHsKICAgICAgICAgICAgY29uc3QgZyA9IFtdLCBtID0gW107CiAgICAgICAgICAgIGZvciAobGV0IHYgPSAwOyB2ICE9PSBkW2ZdLm1vcnBoVGFyZ2V0cy5sZW5ndGg7ICsrdikgewogICAgICAgICAgICAgIGNvbnN0IHggPSBkW2ZdOwogICAgICAgICAgICAgIGcucHVzaCh4LnRpbWUpLCBtLnB1c2goeC5tb3JwaFRhcmdldCA9PT0geSA/IDEgOiAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuLnB1c2gobmV3IEZvKCIubW9ycGhUYXJnZXRJbmZsdWVuY2VbIiArIHkgKyAiXSIsIGcsIG0pKTsKICAgICAgICAgIH0KICAgICAgICAgIGwgPSBwLmxlbmd0aCAqIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHAgPSAiLmJvbmVzWyIgKyBlW3VdLm5hbWUgKyAiXSI7CiAgICAgICAgICBpKAogICAgICAgICAgICBiYSwKICAgICAgICAgICAgcCArICIucG9zaXRpb24iLAogICAgICAgICAgICBkLAogICAgICAgICAgICAicG9zIiwKICAgICAgICAgICAgbgogICAgICAgICAgKSwgaSgKICAgICAgICAgICAgUGEsCiAgICAgICAgICAgIHAgKyAiLnF1YXRlcm5pb24iLAogICAgICAgICAgICBkLAogICAgICAgICAgICAicm90IiwKICAgICAgICAgICAgbgogICAgICAgICAgKSwgaSgKICAgICAgICAgICAgYmEsCiAgICAgICAgICAgIHAgKyAiLnNjYWxlIiwKICAgICAgICAgICAgZCwKICAgICAgICAgICAgInNjbCIsCiAgICAgICAgICAgIG4KICAgICAgICAgICk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG4ubGVuZ3RoID09PSAwID8gbnVsbCA6IG5ldyB0aGlzKHMsIGwsIG4sIG8pOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBkdXJhdGlvbiBvZiB0aGlzIGNsaXAgdG8gdGhlIGR1cmF0aW9uIG9mIGl0cyBsb25nZXN0IGtleWZyYW1lIHRyYWNrLgogICAqCiAgICogQHJldHVybiB7QW5pbWF0aW9uQ2xpcH0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gY2xpcC4KICAgKi8KICByZXNldER1cmF0aW9uKCkgewogICAgY29uc3QgdCA9IHRoaXMudHJhY2tzOwogICAgbGV0IGUgPSAwOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0Lmxlbmd0aDsgaSAhPT0gbjsgKytpKSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLnRyYWNrc1tpXTsKICAgICAgZSA9IE1hdGgubWF4KGUsIHMudGltZXNbcy50aW1lcy5sZW5ndGggLSAxXSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5kdXJhdGlvbiA9IGUsIHRoaXM7CiAgfQogIC8qKgogICAqIFRyaW1zIGFsbCB0cmFja3MgdG8gdGhlIGNsaXAncyBkdXJhdGlvbi4KICAgKgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkNsaXB9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGNsaXAuCiAgICovCiAgdHJpbSgpIHsKICAgIGZvciAobGV0IHQgPSAwOyB0IDwgdGhpcy50cmFja3MubGVuZ3RoOyB0KyspCiAgICAgIHRoaXMudHJhY2tzW3RdLnRyaW0oMCwgdGhpcy5kdXJhdGlvbik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUGVyZm9ybXMgbWluaW1hbCB2YWxpZGF0aW9uIG9uIGVhY2ggdHJhY2sgaW4gdGhlIGNsaXAuIFJldHVybnMgYHRydWVgIGlmIGFsbAogICAqIHRyYWNrcyBhcmUgdmFsaWQuCiAgICoKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBjbGlwJ3Mga2V5ZnJhbWVzIGFyZSB2YWxpZCBvciBub3QuCiAgICovCiAgdmFsaWRhdGUoKSB7CiAgICBsZXQgdCA9ICEwOwogICAgZm9yIChsZXQgZSA9IDA7IGUgPCB0aGlzLnRyYWNrcy5sZW5ndGg7IGUrKykKICAgICAgdCA9IHQgJiYgdGhpcy50cmFja3NbZV0udmFsaWRhdGUoKTsKICAgIHJldHVybiB0OwogIH0KICAvKioKICAgKiBPcHRpbWl6ZXMgZWFjaCB0cmFjayBieSByZW1vdmluZyBlcXVpdmFsZW50IHNlcXVlbnRpYWwga2V5cyAod2hpY2ggYXJlCiAgICogY29tbW9uIGluIG1vcnBoIHRhcmdldCBzZXF1ZW5jZXMpLgogICAqCiAgICogQHJldHVybiB7QW5pbWF0aW9uQ2xpcH0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gY2xpcC4KICAgKi8KICBvcHRpbWl6ZSgpIHsKICAgIGZvciAobGV0IHQgPSAwOyB0IDwgdGhpcy50cmFja3MubGVuZ3RoOyB0KyspCiAgICAgIHRoaXMudHJhY2tzW3RdLm9wdGltaXplKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBhbmltYXRpb24gY2xpcCB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7QW5pbWF0aW9uQ2xpcH0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgY29uc3QgdCA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnRyYWNrcy5sZW5ndGg7IGkrKykKICAgICAgdC5wdXNoKHRoaXMudHJhY2tzW2ldLmNsb25lKCkpOwogICAgY29uc3QgZSA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubmFtZSwgdGhpcy5kdXJhdGlvbiwgdCwgdGhpcy5ibGVuZE1vZGUpOwogICAgcmV0dXJuIGUudXNlckRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMudXNlckRhdGEpKSwgZTsKICB9CiAgLyoqCiAgICogU2VyaWFsaXplcyB0aGlzIGFuaW1hdGlvbiBjbGlwIGludG8gSlNPTi4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gVGhlIEpTT04gb2JqZWN0LgogICAqLwogIHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvSlNPTih0aGlzKTsKICB9Cn0KZnVuY3Rpb24gQmIoYSkgewogIHN3aXRjaCAoYS50b0xvd2VyQ2FzZSgpKSB7CiAgICBjYXNlICJzY2FsYXIiOgogICAgY2FzZSAiZG91YmxlIjoKICAgIGNhc2UgImZsb2F0IjoKICAgIGNhc2UgIm51bWJlciI6CiAgICBjYXNlICJpbnRlZ2VyIjoKICAgICAgcmV0dXJuIEZvOwogICAgY2FzZSAidmVjdG9yIjoKICAgIGNhc2UgInZlY3RvcjIiOgogICAgY2FzZSAidmVjdG9yMyI6CiAgICBjYXNlICJ2ZWN0b3I0IjoKICAgICAgcmV0dXJuIGJhOwogICAgY2FzZSAiY29sb3IiOgogICAgICByZXR1cm4gZWY7CiAgICBjYXNlICJxdWF0ZXJuaW9uIjoKICAgICAgcmV0dXJuIFBhOwogICAgY2FzZSAiYm9vbCI6CiAgICBjYXNlICJib29sZWFuIjoKICAgICAgcmV0dXJuIGdyOwogICAgY2FzZSAic3RyaW5nIjoKICAgICAgcmV0dXJuIHlyOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLktleWZyYW1lVHJhY2s6IFVuc3VwcG9ydGVkIHR5cGVOYW1lOiAiICsgYSk7Cn0KZnVuY3Rpb24gemIoYSkgewogIGlmIChhLnR5cGUgPT09IHZvaWQgMCkKICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuS2V5ZnJhbWVUcmFjazogdHJhY2sgdHlwZSB1bmRlZmluZWQsIGNhbiBub3QgcGFyc2UiKTsKICBjb25zdCB0ID0gQmIoYS50eXBlKTsKICBpZiAoYS50aW1lcyA9PT0gdm9pZCAwKSB7CiAgICBjb25zdCBlID0gW10sIGkgPSBbXTsKICAgIFFwKGEua2V5cywgZSwgaSwgInZhbHVlIiksIGEudGltZXMgPSBlLCBhLnZhbHVlcyA9IGk7CiAgfQogIHJldHVybiB0LnBhcnNlICE9PSB2b2lkIDAgPyB0LnBhcnNlKGEpIDogbmV3IHQoYS5uYW1lLCBhLnRpbWVzLCBhLnZhbHVlcywgYS5pbnRlcnBvbGF0aW9uKTsKfQpjb25zdCBUbiA9IHsKICAvKioKICAgKiBXaGV0aGVyIGNhY2hpbmcgaXMgZW5hYmxlZCBvciBub3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHR5cGUge2Jvb2xlYW59CiAgICogQGRlZmF1bHQgZmFsc2UKICAgKi8KICBlbmFibGVkOiAhMSwKICAvKioKICAgKiBBIGRpY3Rpb25hcnkgdGhhdCBob2xkcyBjYWNoZWQgZmlsZXMuCiAgICoKICAgKiBAc3RhdGljCiAgICogQHR5cGUge09iamVjdDxzdHJpbmcsT2JqZWN0Pn0KICAgKi8KICBmaWxlczoge30sCiAgLyoqCiAgICogQWRkcyBhIGNhY2hlIGVudHJ5IHdpdGggYSBrZXkgdG8gcmVmZXJlbmNlIHRoZSBmaWxlLiBJZiB0aGlzIGtleSBhbHJlYWR5CiAgICogaG9sZHMgYSBmaWxlLCBpdCBpcyBvdmVyd3JpdHRlbi4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIGtleSB0byByZWZlcmVuY2UgdGhlIGNhY2hlZCBmaWxlLgogICAqIEBwYXJhbSB7T2JqZWN0fSBmaWxlIC0gIFRoZSBmaWxlIHRvIGJlIGNhY2hlZC4KICAgKi8KICBhZGQ6IGZ1bmN0aW9uKGEsIHQpIHsKICAgIHRoaXMuZW5hYmxlZCAhPT0gITEgJiYgKHRoaXMuZmlsZXNbYV0gPSB0KTsKICB9LAogIC8qKgogICAqIEdldHMgdGhlIGNhY2hlZCB2YWx1ZSBmb3IgdGhlIGdpdmVuIGtleS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIGtleSB0byByZWZlcmVuY2UgdGhlIGNhY2hlZCBmaWxlLgogICAqIEByZXR1cm4ge09iamVjdHx1bmRlZmluZWR9IFRoZSBjYWNoZWQgZmlsZS4gSWYgdGhlIGtleSBkb2VzIG5vdCBleGlzdCBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC4KICAgKi8KICBnZXQ6IGZ1bmN0aW9uKGEpIHsKICAgIGlmICh0aGlzLmVuYWJsZWQgIT09ICExKQogICAgICByZXR1cm4gdGhpcy5maWxlc1thXTsKICB9LAogIC8qKgogICAqIFJlbW92ZXMgdGhlIGNhY2hlZCBmaWxlIGFzc29jaWF0ZWQgd2l0aCB0aGUgZ2l2ZW4ga2V5LgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IHRvIHJlZmVyZW5jZSB0aGUgY2FjaGVkIGZpbGUuCiAgICovCiAgcmVtb3ZlOiBmdW5jdGlvbihhKSB7CiAgICBkZWxldGUgdGhpcy5maWxlc1thXTsKICB9LAogIC8qKgogICAqIFJlbW92ZSBhbGwgdmFsdWVzIGZyb20gdGhlIGNhY2hlLgogICAqCiAgICogQHN0YXRpYwogICAqLwogIGNsZWFyOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuZmlsZXMgPSB7fTsKICB9Cn07CmNsYXNzIG5mIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxvYWRpbmcgbWFuYWdlci4KICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvbkxvYWRdIC0gRXhlY3V0ZXMgd2hlbiBhbGwgaXRlbXMgaGF2ZSBiZWVuIGxvYWRlZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbb25Qcm9ncmVzc10gLSBFeGVjdXRlcyB3aGVuIHNpbmdsZSBpdGVtcyBoYXZlIGJlZW4gbG9hZGVkLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvbkVycm9yXSAtIEV4ZWN1dGVzIHdoZW4gYW4gZXJyb3Igb2NjdXJzLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzOwogICAgbGV0IHMgPSAhMSwgciA9IDAsIG8gPSAwLCBsOwogICAgY29uc3QgaCA9IFtdOwogICAgdGhpcy5vblN0YXJ0ID0gdm9pZCAwLCB0aGlzLm9uTG9hZCA9IHQsIHRoaXMub25Qcm9ncmVzcyA9IGUsIHRoaXMub25FcnJvciA9IGksIHRoaXMuYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpLCB0aGlzLml0ZW1TdGFydCA9IGZ1bmN0aW9uKGMpIHsKICAgICAgbysrLCBzID09PSAhMSAmJiBuLm9uU3RhcnQgIT09IHZvaWQgMCAmJiBuLm9uU3RhcnQoYywgciwgbyksIHMgPSAhMDsKICAgIH0sIHRoaXMuaXRlbUVuZCA9IGZ1bmN0aW9uKGMpIHsKICAgICAgcisrLCBuLm9uUHJvZ3Jlc3MgIT09IHZvaWQgMCAmJiBuLm9uUHJvZ3Jlc3MoYywgciwgbyksIHIgPT09IG8gJiYgKHMgPSAhMSwgbi5vbkxvYWQgIT09IHZvaWQgMCAmJiBuLm9uTG9hZCgpKTsKICAgIH0sIHRoaXMuaXRlbUVycm9yID0gZnVuY3Rpb24oYykgewogICAgICBuLm9uRXJyb3IgIT09IHZvaWQgMCAmJiBuLm9uRXJyb3IoYyk7CiAgICB9LCB0aGlzLnJlc29sdmVVUkwgPSBmdW5jdGlvbihjKSB7CiAgICAgIHJldHVybiBsID8gbChjKSA6IGM7CiAgICB9LCB0aGlzLnNldFVSTE1vZGlmaWVyID0gZnVuY3Rpb24oYykgewogICAgICByZXR1cm4gbCA9IGMsIHRoaXM7CiAgICB9LCB0aGlzLmFkZEhhbmRsZXIgPSBmdW5jdGlvbihjLCB1KSB7CiAgICAgIHJldHVybiBoLnB1c2goYywgdSksIHRoaXM7CiAgICB9LCB0aGlzLnJlbW92ZUhhbmRsZXIgPSBmdW5jdGlvbihjKSB7CiAgICAgIGNvbnN0IHUgPSBoLmluZGV4T2YoYyk7CiAgICAgIHJldHVybiB1ICE9PSAtMSAmJiBoLnNwbGljZSh1LCAyKSwgdGhpczsKICAgIH0sIHRoaXMuZ2V0SGFuZGxlciA9IGZ1bmN0aW9uKGMpIHsKICAgICAgZm9yIChsZXQgdSA9IDAsIGQgPSBoLmxlbmd0aDsgdSA8IGQ7IHUgKz0gMikgewogICAgICAgIGNvbnN0IHAgPSBoW3VdLCBmID0gaFt1ICsgMV07CiAgICAgICAgaWYgKHAuZ2xvYmFsICYmIChwLmxhc3RJbmRleCA9IDApLCBwLnRlc3QoYykpCiAgICAgICAgICByZXR1cm4gZjsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0sIHRoaXMuYWJvcnQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYWJvcnRDb250cm9sbGVyLmFib3J0KCksIHRoaXMuYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpLCB0aGlzOwogICAgfTsKICB9Cn0KY29uc3Qgcl8gPSAvKiBAX19QVVJFX18gKi8gbmV3IG5mKCk7CmNsYXNzIFRpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxvYWRlci4KICAgKgogICAqIEBwYXJhbSB7TG9hZGluZ01hbmFnZXJ9IFttYW5hZ2VyXSAtIFRoZSBsb2FkaW5nIG1hbmFnZXIuCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgdGhpcy5tYW5hZ2VyID0gdCAhPT0gdm9pZCAwID8gdCA6IHJfLCB0aGlzLmNyb3NzT3JpZ2luID0gImFub255bW91cyIsIHRoaXMud2l0aENyZWRlbnRpYWxzID0gITEsIHRoaXMucGF0aCA9ICIiLCB0aGlzLnJlc291cmNlUGF0aCA9ICIiLCB0aGlzLnJlcXVlc3RIZWFkZXIgPSB7fTsKICB9CiAgLyoqCiAgICogVGhpcyBtZXRob2QgbmVlZHMgdG8gYmUgaW1wbGVtZW50ZWQgYnkgYWxsIGNvbmNyZXRlIGxvYWRlcnMuIEl0IGhvbGRzIHRoZQogICAqIGxvZ2ljIGZvciBsb2FkaW5nIGFzc2V0cyBmcm9tIHRoZSBiYWNrZW5kLgogICAqCiAgICogQGFic3RyYWN0CiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gb25Mb2FkIC0gRXhlY3V0ZWQgd2hlbiB0aGUgbG9hZGluZyBwcm9jZXNzIGhhcyBiZWVuIGZpbmlzaGVkLgogICAqIEBwYXJhbSB7b25Qcm9ncmVzc0NhbGxiYWNrfSBbb25Qcm9ncmVzc10gLSBFeGVjdXRlZCB3aGlsZSB0aGUgbG9hZGluZyBpcyBpbiBwcm9ncmVzcy4KICAgKiBAcGFyYW0ge29uRXJyb3JDYWxsYmFja30gW29uRXJyb3JdIC0gRXhlY3V0ZWQgd2hlbiBlcnJvcnMgb2NjdXIuCiAgICovCiAgbG9hZCgpIHsKICB9CiAgLyoqCiAgICogQSBhc3luYyB2ZXJzaW9uIG9mIHtAbGluayBMb2FkZXIjbG9hZH0uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIHBhdGgvVVJMIG9mIHRoZSBmaWxlIHRvIGJlIGxvYWRlZC4KICAgKiBAcGFyYW0ge29uUHJvZ3Jlc3NDYWxsYmFja30gW29uUHJvZ3Jlc3NdIC0gRXhlY3V0ZWQgd2hpbGUgdGhlIGxvYWRpbmcgaXMgaW4gcHJvZ3Jlc3MuCiAgICogQHJldHVybiB7UHJvbWlzZX0gQSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2hlbiB0aGUgYXNzZXQgaGFzIGJlZW4gbG9hZGVkLgogICAqLwogIGxvYWRBc3luYyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpczsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihuLCBzKSB7CiAgICAgIGkubG9hZCh0LCBuLCBlLCBzKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBUaGlzIG1ldGhvZCBuZWVkcyB0byBiZSBpbXBsZW1lbnRlZCBieSBhbGwgY29uY3JldGUgbG9hZGVycy4gSXQgaG9sZHMgdGhlCiAgICogbG9naWMgZm9yIHBhcnNpbmcgdGhlIGFzc2V0IGludG8gdGhyZWUuanMgZW50aXRpZXMuCiAgICoKICAgKiBAYWJzdHJhY3QKICAgKiBAcGFyYW0ge2FueX0gZGF0YSAtIFRoZSBkYXRhIHRvIHBhcnNlLgogICAqLwogIHBhcnNlKCkgewogIH0KICAvKioKICAgKiBTZXRzIHRoZSBgY3Jvc3NPcmlnaW5gIFN0cmluZyB0byBpbXBsZW1lbnQgQ09SUyBmb3IgbG9hZGluZyB0aGUgVVJMCiAgICogZnJvbSBhIGRpZmZlcmVudCBkb21haW4gdGhhdCBhbGxvd3MgQ09SUy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBjcm9zc09yaWdpbiAtIFRoZSBgY3Jvc3NPcmlnaW5gIHZhbHVlLgogICAqIEByZXR1cm4ge0xvYWRlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRDcm9zc09yaWdpbih0KSB7CiAgICByZXR1cm4gdGhpcy5jcm9zc09yaWdpbiA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFdoZXRoZXIgdGhlIFhNTEh0dHBSZXF1ZXN0IHVzZXMgY3JlZGVudGlhbHMgc3VjaCBhcyBjb29raWVzLCBhdXRob3JpemF0aW9uCiAgICogaGVhZGVycyBvciBUTFMgY2xpZW50IGNlcnRpZmljYXRlcywgc2VlIFtYTUxIdHRwUmVxdWVzdC53aXRoQ3JlZGVudGlhbHNde0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9YTUxIdHRwUmVxdWVzdC93aXRoQ3JlZGVudGlhbHN9LgogICAqCiAgICogTm90ZTogVGhpcyBzZXR0aW5nIGhhcyBubyBlZmZlY3QgaWYgeW91IGFyZSBsb2FkaW5nIGZpbGVzIGxvY2FsbHkgb3IgZnJvbSB0aGUgc2FtZSBkb21haW4uCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlIC0gVGhlIGB3aXRoQ3JlZGVudGlhbHNgIHZhbHVlLgogICAqIEByZXR1cm4ge0xvYWRlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRXaXRoQ3JlZGVudGlhbHModCkgewogICAgcmV0dXJuIHRoaXMud2l0aENyZWRlbnRpYWxzID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgYmFzZSBwYXRoIGZvciB0aGUgYXNzZXQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBiYXNlIHBhdGguCiAgICogQHJldHVybiB7TG9hZGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFBhdGgodCkgewogICAgcmV0dXJuIHRoaXMucGF0aCA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGJhc2UgcGF0aCBmb3IgZGVwZW5kZW50IHJlc291cmNlcyBsaWtlIHRleHR1cmVzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHJlc291cmNlUGF0aCAtIFRoZSByZXNvdXJjZSBwYXRoLgogICAqIEByZXR1cm4ge0xvYWRlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRSZXNvdXJjZVBhdGgodCkgewogICAgcmV0dXJuIHRoaXMucmVzb3VyY2VQYXRoID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gcmVxdWVzdCBoZWFkZXIuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdEhlYWRlciAtIEEgW3JlcXVlc3QgaGVhZGVyXXtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0dsb3NzYXJ5L1JlcXVlc3RfaGVhZGVyfQogICAqIGZvciBjb25maWd1cmluZyB0aGUgSFRUUCByZXF1ZXN0LgogICAqIEByZXR1cm4ge0xvYWRlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRSZXF1ZXN0SGVhZGVyKHQpIHsKICAgIHJldHVybiB0aGlzLnJlcXVlc3RIZWFkZXIgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgaW1wbGVtZW50ZWQgaW4gbG9hZGVycyBmb3IgYWJvcnRpbmcgb25nb2luZyByZXF1ZXN0cy4KICAgKgogICAqIEBhYnN0cmFjdAogICAqIEByZXR1cm4ge0xvYWRlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhYm9ydCgpIHsKICAgIHJldHVybiB0aGlzOwogIH0KfQpUaS5ERUZBVUxUX01BVEVSSUFMX05BTUUgPSAiX19ERUZBVUxUIjsKY29uc3Qgem4gPSB7fTsKY2xhc3MgTmIgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IodCwgZSkgewogICAgc3VwZXIodCksIHRoaXMucmVzcG9uc2UgPSBlOwogIH0KfQpjbGFzcyBzcyBleHRlbmRzIFRpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGZpbGUgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KSwgdGhpcy5taW1lVHlwZSA9ICIiLCB0aGlzLnJlc3BvbnNlVHlwZSA9ICIiLCB0aGlzLl9hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgfQogIC8qKgogICAqIFN0YXJ0cyBsb2FkaW5nIGZyb20gdGhlIGdpdmVuIFVSTCBhbmQgcGFzcyB0aGUgbG9hZGVkIHJlc3BvbnNlIHRvIHRoZSBgb25Mb2FkKClgIGNhbGxiYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuIFRoaXMgY2FuIGFsc28gYmUgYSBkYXRhIFVSSS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFueSl9IG9uTG9hZCAtIEV4ZWN1dGVkIHdoZW4gdGhlIGxvYWRpbmcgcHJvY2VzcyBoYXMgYmVlbiBmaW5pc2hlZC4KICAgKiBAcGFyYW0ge29uUHJvZ3Jlc3NDYWxsYmFja30gW29uUHJvZ3Jlc3NdIC0gRXhlY3V0ZWQgd2hpbGUgdGhlIGxvYWRpbmcgaXMgaW4gcHJvZ3Jlc3MuCiAgICogQHBhcmFtIHtvbkVycm9yQ2FsbGJhY2t9IFtvbkVycm9yXSAtIEV4ZWN1dGVkIHdoZW4gZXJyb3JzIG9jY3VyLgogICAqIEByZXR1cm4ge2FueXx1bmRlZmluZWR9IFRoZSBjYWNoZWQgcmVzb3VyY2UgaWYgYXZhaWxhYmxlLgogICAqLwogIGxvYWQodCwgZSwgaSwgbikgewogICAgdCA9PT0gdm9pZCAwICYmICh0ID0gIiIpLCB0aGlzLnBhdGggIT09IHZvaWQgMCAmJiAodCA9IHRoaXMucGF0aCArIHQpLCB0ID0gdGhpcy5tYW5hZ2VyLnJlc29sdmVVUkwodCk7CiAgICBjb25zdCBzID0gVG4uZ2V0KGBmaWxlOiR7dH1gKTsKICAgIGlmIChzICE9PSB2b2lkIDApCiAgICAgIHJldHVybiB0aGlzLm1hbmFnZXIuaXRlbVN0YXJ0KHQpLCBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBlICYmIGUocyksIHRoaXMubWFuYWdlci5pdGVtRW5kKHQpOwogICAgICB9LCAwKSwgczsKICAgIGlmICh6blt0XSAhPT0gdm9pZCAwKSB7CiAgICAgIHpuW3RdLnB1c2goewogICAgICAgIG9uTG9hZDogZSwKICAgICAgICBvblByb2dyZXNzOiBpLAogICAgICAgIG9uRXJyb3I6IG4KICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHpuW3RdID0gW10sIHpuW3RdLnB1c2goewogICAgICBvbkxvYWQ6IGUsCiAgICAgIG9uUHJvZ3Jlc3M6IGksCiAgICAgIG9uRXJyb3I6IG4KICAgIH0pOwogICAgY29uc3QgciA9IG5ldyBSZXF1ZXN0KHQsIHsKICAgICAgaGVhZGVyczogbmV3IEhlYWRlcnModGhpcy5yZXF1ZXN0SGVhZGVyKSwKICAgICAgY3JlZGVudGlhbHM6IHRoaXMud2l0aENyZWRlbnRpYWxzID8gImluY2x1ZGUiIDogInNhbWUtb3JpZ2luIiwKICAgICAgc2lnbmFsOiB0eXBlb2YgQWJvcnRTaWduYWwuYW55ID09ICJmdW5jdGlvbiIgPyBBYm9ydFNpZ25hbC5hbnkoW3RoaXMuX2Fib3J0Q29udHJvbGxlci5zaWduYWwsIHRoaXMubWFuYWdlci5hYm9ydENvbnRyb2xsZXIuc2lnbmFsXSkgOiB0aGlzLl9hYm9ydENvbnRyb2xsZXIuc2lnbmFsCiAgICB9KSwgbyA9IHRoaXMubWltZVR5cGUsIGwgPSB0aGlzLnJlc3BvbnNlVHlwZTsKICAgIGZldGNoKHIpLnRoZW4oKGgpID0+IHsKICAgICAgaWYgKGguc3RhdHVzID09PSAyMDAgfHwgaC5zdGF0dXMgPT09IDApIHsKICAgICAgICBpZiAoaC5zdGF0dXMgPT09IDAgJiYgY29uc29sZS53YXJuKCJUSFJFRS5GaWxlTG9hZGVyOiBIVFRQIFN0YXR1cyAwIHJlY2VpdmVkLiIpLCB0eXBlb2YgUmVhZGFibGVTdHJlYW0gPiAidSIgfHwgaC5ib2R5ID09PSB2b2lkIDAgfHwgaC5ib2R5LmdldFJlYWRlciA9PT0gdm9pZCAwKQogICAgICAgICAgcmV0dXJuIGg7CiAgICAgICAgY29uc3QgYyA9IHpuW3RdLCB1ID0gaC5ib2R5LmdldFJlYWRlcigpLCBkID0gaC5oZWFkZXJzLmdldCgiWC1GaWxlLVNpemUiKSB8fCBoLmhlYWRlcnMuZ2V0KCJDb250ZW50LUxlbmd0aCIpLCBwID0gZCA/IHBhcnNlSW50KGQpIDogMCwgZiA9IHAgIT09IDA7CiAgICAgICAgbGV0IHkgPSAwOwogICAgICAgIGNvbnN0IGcgPSBuZXcgUmVhZGFibGVTdHJlYW0oewogICAgICAgICAgc3RhcnQobSkgewogICAgICAgICAgICB2KCk7CiAgICAgICAgICAgIGZ1bmN0aW9uIHYoKSB7CiAgICAgICAgICAgICAgdS5yZWFkKCkudGhlbigoeyBkb25lOiB4LCB2YWx1ZTogXyB9KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoeCkKICAgICAgICAgICAgICAgICAgbS5jbG9zZSgpOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgIHkgKz0gXy5ieXRlTGVuZ3RoOwogICAgICAgICAgICAgICAgICBjb25zdCBTID0gbmV3IFByb2dyZXNzRXZlbnQoInByb2dyZXNzIiwgeyBsZW5ndGhDb21wdXRhYmxlOiBmLCBsb2FkZWQ6IHksIHRvdGFsOiBwIH0pOwogICAgICAgICAgICAgICAgICBmb3IgKGxldCB3ID0gMCwgVCA9IGMubGVuZ3RoOyB3IDwgVDsgdysrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgUiA9IGNbd107CiAgICAgICAgICAgICAgICAgICAgUi5vblByb2dyZXNzICYmIFIub25Qcm9ncmVzcyhTKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBtLmVucXVldWUoXyksIHYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LCAoeCkgPT4gewogICAgICAgICAgICAgICAgbS5lcnJvcih4KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBuZXcgUmVzcG9uc2UoZyk7CiAgICAgIH0gZWxzZQogICAgICAgIHRocm93IG5ldyBOYihgZmV0Y2ggZm9yICIke2gudXJsfSIgcmVzcG9uZGVkIHdpdGggJHtoLnN0YXR1c306ICR7aC5zdGF0dXNUZXh0fWAsIGgpOwogICAgfSkudGhlbigoaCkgPT4gewogICAgICBzd2l0Y2ggKGwpIHsKICAgICAgICBjYXNlICJhcnJheWJ1ZmZlciI6CiAgICAgICAgICByZXR1cm4gaC5hcnJheUJ1ZmZlcigpOwogICAgICAgIGNhc2UgImJsb2IiOgogICAgICAgICAgcmV0dXJuIGguYmxvYigpOwogICAgICAgIGNhc2UgImRvY3VtZW50IjoKICAgICAgICAgIHJldHVybiBoLnRleHQoKS50aGVuKChjKSA9PiBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGMsIG8pKTsKICAgICAgICBjYXNlICJqc29uIjoKICAgICAgICAgIHJldHVybiBoLmpzb24oKTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKG8gPT09ICIiKQogICAgICAgICAgICByZXR1cm4gaC50ZXh0KCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IHUgPSAvY2hhcnNldD0iPyhbXjsiXHNdKikiPy9pLmV4ZWMobyksIGQgPSB1ICYmIHVbMV0gPyB1WzFdLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDAsIHAgPSBuZXcgVGV4dERlY29kZXIoZCk7CiAgICAgICAgICAgIHJldHVybiBoLmFycmF5QnVmZmVyKCkudGhlbigoZikgPT4gcC5kZWNvZGUoZikpOwogICAgICAgICAgfQogICAgICB9CiAgICB9KS50aGVuKChoKSA9PiB7CiAgICAgIFRuLmFkZChgZmlsZToke3R9YCwgaCk7CiAgICAgIGNvbnN0IGMgPSB6blt0XTsKICAgICAgZGVsZXRlIHpuW3RdOwogICAgICBmb3IgKGxldCB1ID0gMCwgZCA9IGMubGVuZ3RoOyB1IDwgZDsgdSsrKSB7CiAgICAgICAgY29uc3QgcCA9IGNbdV07CiAgICAgICAgcC5vbkxvYWQgJiYgcC5vbkxvYWQoaCk7CiAgICAgIH0KICAgIH0pLmNhdGNoKChoKSA9PiB7CiAgICAgIGNvbnN0IGMgPSB6blt0XTsKICAgICAgaWYgKGMgPT09IHZvaWQgMCkKICAgICAgICB0aHJvdyB0aGlzLm1hbmFnZXIuaXRlbUVycm9yKHQpLCBoOwogICAgICBkZWxldGUgem5bdF07CiAgICAgIGZvciAobGV0IHUgPSAwLCBkID0gYy5sZW5ndGg7IHUgPCBkOyB1KyspIHsKICAgICAgICBjb25zdCBwID0gY1t1XTsKICAgICAgICBwLm9uRXJyb3IgJiYgcC5vbkVycm9yKGgpOwogICAgICB9CiAgICAgIHRoaXMubWFuYWdlci5pdGVtRXJyb3IodCk7CiAgICB9KS5maW5hbGx5KCgpID0+IHsKICAgICAgdGhpcy5tYW5hZ2VyLml0ZW1FbmQodCk7CiAgICB9KSwgdGhpcy5tYW5hZ2VyLml0ZW1TdGFydCh0KTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZXhwZWN0ZWQgcmVzcG9uc2UgdHlwZS4KICAgKgogICAqIEBwYXJhbSB7KCdhcnJheWJ1ZmZlcid8J2Jsb2InfCdkb2N1bWVudCd8J2pzb24nfCcnKX0gdmFsdWUgLSBUaGUgcmVzcG9uc2UgdHlwZS4KICAgKiBAcmV0dXJuIHtGaWxlTG9hZGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGZpbGUgbG9hZGVyLgogICAqLwogIHNldFJlc3BvbnNlVHlwZSh0KSB7CiAgICByZXR1cm4gdGhpcy5yZXNwb25zZVR5cGUgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBleHBlY3RlZCBtaW1lIHR5cGUgb2YgdGhlIGxvYWRlZCBmaWxlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gVGhlIG1pbWUgdHlwZS4KICAgKiBAcmV0dXJuIHtGaWxlTG9hZGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGZpbGUgbG9hZGVyLgogICAqLwogIHNldE1pbWVUeXBlKHQpIHsKICAgIHJldHVybiB0aGlzLm1pbWVUeXBlID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQWJvcnRzIG9uZ29pbmcgZmV0Y2ggcmVxdWVzdHMuCiAgICoKICAgKiBAcmV0dXJuIHtGaWxlTG9hZGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIGFib3J0KCkgewogICAgcmV0dXJuIHRoaXMuX2Fib3J0Q29udHJvbGxlci5hYm9ydCgpLCB0aGlzLl9hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCksIHRoaXM7CiAgfQp9CmNsYXNzIE9iIGV4dGVuZHMgVGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYW5pbWF0aW9uIGxvYWRlci4KICAgKgogICAqIEBwYXJhbSB7TG9hZGluZ01hbmFnZXJ9IFttYW5hZ2VyXSAtIFRoZSBsb2FkaW5nIG1hbmFnZXIuCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIodCk7CiAgfQogIC8qKgogICAqIFN0YXJ0cyBsb2FkaW5nIGZyb20gdGhlIGdpdmVuIFVSTCBhbmQgcGFzcyB0aGUgbG9hZGVkIGFuaW1hdGlvbnMgYXMgYW4gYXJyYXkKICAgKiBob2xkaW5nIGluc3RhbmNlcyBvZiB7QGxpbmsgQW5pbWF0aW9uQ2xpcH0gdG8gdGhlIGBvbkxvYWQoKWAgY2FsbGJhY2suCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIHBhdGgvVVJMIG9mIHRoZSBmaWxlIHRvIGJlIGxvYWRlZC4gVGhpcyBjYW4gYWxzbyBiZSBhIGRhdGEgVVJJLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oQXJyYXk8QW5pbWF0aW9uQ2xpcD4pfSBvbkxvYWQgLSBFeGVjdXRlZCB3aGVuIHRoZSBsb2FkaW5nIHByb2Nlc3MgaGFzIGJlZW4gZmluaXNoZWQuCiAgICogQHBhcmFtIHtvblByb2dyZXNzQ2FsbGJhY2t9IG9uUHJvZ3Jlc3MgLSBFeGVjdXRlZCB3aGlsZSB0aGUgbG9hZGluZyBpcyBpbiBwcm9ncmVzcy4KICAgKiBAcGFyYW0ge29uRXJyb3JDYWxsYmFja30gb25FcnJvciAtIEV4ZWN1dGVkIHdoZW4gZXJyb3JzIG9jY3VyLgogICAqLwogIGxvYWQodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IHRoaXMsIHIgPSBuZXcgc3ModGhpcy5tYW5hZ2VyKTsKICAgIHIuc2V0UGF0aCh0aGlzLnBhdGgpLCByLnNldFJlcXVlc3RIZWFkZXIodGhpcy5yZXF1ZXN0SGVhZGVyKSwgci5zZXRXaXRoQ3JlZGVudGlhbHModGhpcy53aXRoQ3JlZGVudGlhbHMpLCByLmxvYWQodCwgZnVuY3Rpb24obykgewogICAgICB0cnkgewogICAgICAgIGUocy5wYXJzZShKU09OLnBhcnNlKG8pKSk7CiAgICAgIH0gY2F0Y2ggKGwpIHsKICAgICAgICBuID8gbihsKSA6IGNvbnNvbGUuZXJyb3IobCksIHMubWFuYWdlci5pdGVtRXJyb3IodCk7CiAgICAgIH0KICAgIH0sIGksIG4pOwogIH0KICAvKioKICAgKiBQYXJzZXMgdGhlIGdpdmVuIEpTT04gb2JqZWN0IGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIGFuaW1hdGlvbiBjbGlwcy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIHNlcmlhbGl6ZWQgYW5pbWF0aW9uIGNsaXBzLgogICAqIEByZXR1cm4ge0FycmF5PEFuaW1hdGlvbkNsaXA+fSBUaGUgcGFyc2VkIGFuaW1hdGlvbiBjbGlwcy4KICAgKi8KICBwYXJzZSh0KSB7CiAgICBjb25zdCBlID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHQubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgbiA9IE1hLnBhcnNlKHRbaV0pOwogICAgICBlLnB1c2gobik7CiAgICB9CiAgICByZXR1cm4gZTsKICB9Cn0KY2xhc3Mga2IgZXh0ZW5kcyBUaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBjb21wcmVzc2VkIHRleHR1cmUgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzZXMgdGhlIGxvYWRlZCBjb21wcmVzc2VkIHRleHR1cmUKICAgKiB0byB0aGUgYG9uTG9hZCgpYCBjYWxsYmFjay4gVGhlIG1ldGhvZCBhbHNvIHJldHVybnMgYSBuZXcgdGV4dHVyZSBvYmplY3Qgd2hpY2ggY2FuCiAgICogZGlyZWN0bHkgYmUgdXNlZCBmb3IgbWF0ZXJpYWwgY3JlYXRpb24uIElmIHlvdSBkbyBpdCB0aGlzIHdheSwgdGhlIHRleHR1cmUKICAgKiBtYXkgcG9wIHVwIGluIHlvdXIgc2NlbmUgb25jZSB0aGUgcmVzcGVjdGl2ZSBsb2FkaW5nIHByb2Nlc3MgaXMgZmluaXNoZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIHBhdGgvVVJMIG9mIHRoZSBmaWxlIHRvIGJlIGxvYWRlZC4gVGhpcyBjYW4gYWxzbyBiZSBhIGRhdGEgVVJJLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oQ29tcHJlc3NlZFRleHR1cmUpfSBvbkxvYWQgLSBFeGVjdXRlZCB3aGVuIHRoZSBsb2FkaW5nIHByb2Nlc3MgaGFzIGJlZW4gZmluaXNoZWQuCiAgICogQHBhcmFtIHtvblByb2dyZXNzQ2FsbGJhY2t9IG9uUHJvZ3Jlc3MgLSBFeGVjdXRlZCB3aGlsZSB0aGUgbG9hZGluZyBpcyBpbiBwcm9ncmVzcy4KICAgKiBAcGFyYW0ge29uRXJyb3JDYWxsYmFja30gb25FcnJvciAtIEV4ZWN1dGVkIHdoZW4gZXJyb3JzIG9jY3VyLgogICAqIEByZXR1cm4ge0NvbXByZXNzZWRUZXh0dXJlfSBUaGUgY29tcHJlc3NlZCB0ZXh0dXJlLgogICAqLwogIGxvYWQodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IHRoaXMsIHIgPSBbXSwgbyA9IG5ldyBZYygpLCBsID0gbmV3IHNzKHRoaXMubWFuYWdlcik7CiAgICBsLnNldFBhdGgodGhpcy5wYXRoKSwgbC5zZXRSZXNwb25zZVR5cGUoImFycmF5YnVmZmVyIiksIGwuc2V0UmVxdWVzdEhlYWRlcih0aGlzLnJlcXVlc3RIZWFkZXIpLCBsLnNldFdpdGhDcmVkZW50aWFscyhzLndpdGhDcmVkZW50aWFscyk7CiAgICBsZXQgaCA9IDA7CiAgICBmdW5jdGlvbiBjKHUpIHsKICAgICAgbC5sb2FkKHRbdV0sIGZ1bmN0aW9uKGQpIHsKICAgICAgICBjb25zdCBwID0gcy5wYXJzZShkLCAhMCk7CiAgICAgICAgclt1XSA9IHsKICAgICAgICAgIHdpZHRoOiBwLndpZHRoLAogICAgICAgICAgaGVpZ2h0OiBwLmhlaWdodCwKICAgICAgICAgIGZvcm1hdDogcC5mb3JtYXQsCiAgICAgICAgICBtaXBtYXBzOiBwLm1pcG1hcHMKICAgICAgICB9LCBoICs9IDEsIGggPT09IDYgJiYgKHAubWlwbWFwQ291bnQgPT09IDEgJiYgKG8ubWluRmlsdGVyID0gQ2UpLCBvLmltYWdlID0gciwgby5mb3JtYXQgPSBwLmZvcm1hdCwgby5uZWVkc1VwZGF0ZSA9ICEwLCBlICYmIGUobykpOwogICAgICB9LCBpLCBuKTsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KHQpKQogICAgICBmb3IgKGxldCB1ID0gMCwgZCA9IHQubGVuZ3RoOyB1IDwgZDsgKyt1KQogICAgICAgIGModSk7CiAgICBlbHNlCiAgICAgIGwubG9hZCh0LCBmdW5jdGlvbih1KSB7CiAgICAgICAgY29uc3QgZCA9IHMucGFyc2UodSwgITApOwogICAgICAgIGlmIChkLmlzQ3ViZW1hcCkgewogICAgICAgICAgY29uc3QgcCA9IGQubWlwbWFwcy5sZW5ndGggLyBkLm1pcG1hcENvdW50OwogICAgICAgICAgZm9yIChsZXQgZiA9IDA7IGYgPCBwOyBmKyspIHsKICAgICAgICAgICAgcltmXSA9IHsgbWlwbWFwczogW10gfTsKICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBkLm1pcG1hcENvdW50OyB5KyspCiAgICAgICAgICAgICAgcltmXS5taXBtYXBzLnB1c2goZC5taXBtYXBzW2YgKiBkLm1pcG1hcENvdW50ICsgeV0pLCByW2ZdLmZvcm1hdCA9IGQuZm9ybWF0LCByW2ZdLndpZHRoID0gZC53aWR0aCwgcltmXS5oZWlnaHQgPSBkLmhlaWdodDsKICAgICAgICAgIH0KICAgICAgICAgIG8uaW1hZ2UgPSByOwogICAgICAgIH0gZWxzZQogICAgICAgICAgby5pbWFnZS53aWR0aCA9IGQud2lkdGgsIG8uaW1hZ2UuaGVpZ2h0ID0gZC5oZWlnaHQsIG8ubWlwbWFwcyA9IGQubWlwbWFwczsKICAgICAgICBkLm1pcG1hcENvdW50ID09PSAxICYmIChvLm1pbkZpbHRlciA9IENlKSwgby5mb3JtYXQgPSBkLmZvcm1hdCwgby5uZWVkc1VwZGF0ZSA9ICEwLCBlICYmIGUobyk7CiAgICAgIH0sIGksIG4pOwogICAgcmV0dXJuIG87CiAgfQp9CmNvbnN0IHpyID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmNsYXNzIFVvIGV4dGVuZHMgVGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgaW1hZ2UgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzZXMgdGhlIGxvYWRlZCBpbWFnZQogICAqIHRvIHRoZSBgb25Mb2FkKClgIGNhbGxiYWNrLiBUaGUgbWV0aG9kIGFsc28gcmV0dXJucyBhIG5ldyBgSW1hZ2VgIG9iamVjdCB3aGljaCBjYW4KICAgKiBkaXJlY3RseSBiZSB1c2VkIGZvciB0ZXh0dXJlIGNyZWF0aW9uLiBJZiB5b3UgZG8gaXQgdGhpcyB3YXksIHRoZSB0ZXh0dXJlCiAgICogbWF5IHBvcCB1cCBpbiB5b3VyIHNjZW5lIG9uY2UgdGhlIHJlc3BlY3RpdmUgbG9hZGluZyBwcm9jZXNzIGlzIGZpbmlzaGVkLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuIFRoaXMgY2FuIGFsc28gYmUgYSBkYXRhIFVSSS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKEltYWdlKX0gb25Mb2FkIC0gRXhlY3V0ZWQgd2hlbiB0aGUgbG9hZGluZyBwcm9jZXNzIGhhcyBiZWVuIGZpbmlzaGVkLgogICAqIEBwYXJhbSB7b25Qcm9ncmVzc0NhbGxiYWNrfSBvblByb2dyZXNzIC0gVW5zdXBwb3J0ZWQgaW4gdGhpcyBsb2FkZXIuCiAgICogQHBhcmFtIHtvbkVycm9yQ2FsbGJhY2t9IG9uRXJyb3IgLSBFeGVjdXRlZCB3aGVuIGVycm9ycyBvY2N1ci4KICAgKiBAcmV0dXJuIHtJbWFnZX0gVGhlIGltYWdlLgogICAqLwogIGxvYWQodCwgZSwgaSwgbikgewogICAgdGhpcy5wYXRoICE9PSB2b2lkIDAgJiYgKHQgPSB0aGlzLnBhdGggKyB0KSwgdCA9IHRoaXMubWFuYWdlci5yZXNvbHZlVVJMKHQpOwogICAgY29uc3QgcyA9IHRoaXMsIHIgPSBUbi5nZXQoYGltYWdlOiR7dH1gKTsKICAgIGlmIChyICE9PSB2b2lkIDApIHsKICAgICAgaWYgKHIuY29tcGxldGUgPT09ICEwKQogICAgICAgIHMubWFuYWdlci5pdGVtU3RhcnQodCksIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBlICYmIGUociksIHMubWFuYWdlci5pdGVtRW5kKHQpOwogICAgICAgIH0sIDApOwogICAgICBlbHNlIHsKICAgICAgICBsZXQgdSA9IHpyLmdldChyKTsKICAgICAgICB1ID09PSB2b2lkIDAgJiYgKHUgPSBbXSwgenIuc2V0KHIsIHUpKSwgdS5wdXNoKHsgb25Mb2FkOiBlLCBvbkVycm9yOiBuIH0pOwogICAgICB9CiAgICAgIHJldHVybiByOwogICAgfQogICAgY29uc3QgbyA9IFJvKCJpbWciKTsKICAgIGZ1bmN0aW9uIGwoKSB7CiAgICAgIGMoKSwgZSAmJiBlKHRoaXMpOwogICAgICBjb25zdCB1ID0genIuZ2V0KHRoaXMpIHx8IFtdOwogICAgICBmb3IgKGxldCBkID0gMDsgZCA8IHUubGVuZ3RoOyBkKyspIHsKICAgICAgICBjb25zdCBwID0gdVtkXTsKICAgICAgICBwLm9uTG9hZCAmJiBwLm9uTG9hZCh0aGlzKTsKICAgICAgfQogICAgICB6ci5kZWxldGUodGhpcyksIHMubWFuYWdlci5pdGVtRW5kKHQpOwogICAgfQogICAgZnVuY3Rpb24gaCh1KSB7CiAgICAgIGMoKSwgbiAmJiBuKHUpLCBUbi5yZW1vdmUoYGltYWdlOiR7dH1gKTsKICAgICAgY29uc3QgZCA9IHpyLmdldCh0aGlzKSB8fCBbXTsKICAgICAgZm9yIChsZXQgcCA9IDA7IHAgPCBkLmxlbmd0aDsgcCsrKSB7CiAgICAgICAgY29uc3QgZiA9IGRbcF07CiAgICAgICAgZi5vbkVycm9yICYmIGYub25FcnJvcih1KTsKICAgICAgfQogICAgICB6ci5kZWxldGUodGhpcyksIHMubWFuYWdlci5pdGVtRXJyb3IodCksIHMubWFuYWdlci5pdGVtRW5kKHQpOwogICAgfQogICAgZnVuY3Rpb24gYygpIHsKICAgICAgby5yZW1vdmVFdmVudExpc3RlbmVyKCJsb2FkIiwgbCwgITEpLCBvLnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgaCwgITEpOwogICAgfQogICAgcmV0dXJuIG8uYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIGwsICExKSwgby5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIGgsICExKSwgdC5zbGljZSgwLCA1KSAhPT0gImRhdGE6IiAmJiB0aGlzLmNyb3NzT3JpZ2luICE9PSB2b2lkIDAgJiYgKG8uY3Jvc3NPcmlnaW4gPSB0aGlzLmNyb3NzT3JpZ2luKSwgVG4uYWRkKGBpbWFnZToke3R9YCwgbyksIHMubWFuYWdlci5pdGVtU3RhcnQodCksIG8uc3JjID0gdCwgbzsKICB9Cn0KY2xhc3MgVmIgZXh0ZW5kcyBUaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBjdWJlIHRleHR1cmUgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzIHRoZSBmdWxseSBsb2FkZWQgY3ViZSB0ZXh0dXJlCiAgICogdG8gdGhlIGBvbkxvYWQoKWAgY2FsbGJhY2suIFRoZSBtZXRob2QgYWxzbyByZXR1cm5zIGEgbmV3IGN1YmUgdGV4dHVyZSBvYmplY3Qgd2hpY2ggY2FuCiAgICogZGlyZWN0bHkgYmUgdXNlZCBmb3IgbWF0ZXJpYWwgY3JlYXRpb24uIElmIHlvdSBkbyBpdCB0aGlzIHdheSwgdGhlIGN1YmUgdGV4dHVyZQogICAqIG1heSBwb3AgdXAgaW4geW91ciBzY2VuZSBvbmNlIHRoZSByZXNwZWN0aXZlIGxvYWRpbmcgcHJvY2VzcyBpcyBmaW5pc2hlZC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gdXJscyAtIEFycmF5IG9mIDYgVVJMcyB0byBpbWFnZXMsIG9uZSBmb3IgZWFjaCBzaWRlIG9mIHRoZQogICAqIGN1YmUgdGV4dHVyZS4gVGhlIHVybHMgc2hvdWxkIGJlIHNwZWNpZmllZCBpbiB0aGUgZm9sbG93aW5nIG9yZGVyOiBwb3MteCwKICAgKiBuZWcteCwgcG9zLXksIG5lZy15LCBwb3MteiwgbmVnLXouIEFuIGFycmF5IG9mIGRhdGEgVVJJcyBhcmUgYWxsb3dlZCBhcyB3ZWxsLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oQ3ViZVRleHR1cmUpfSBvbkxvYWQgLSBFeGVjdXRlZCB3aGVuIHRoZSBsb2FkaW5nIHByb2Nlc3MgaGFzIGJlZW4gZmluaXNoZWQuCiAgICogQHBhcmFtIHtvblByb2dyZXNzQ2FsbGJhY2t9IG9uUHJvZ3Jlc3MgLSBVbnN1cHBvcnRlZCBpbiB0aGlzIGxvYWRlci4KICAgKiBAcGFyYW0ge29uRXJyb3JDYWxsYmFja30gb25FcnJvciAtIEV4ZWN1dGVkIHdoZW4gZXJyb3JzIG9jY3VyLgogICAqIEByZXR1cm4ge0N1YmVUZXh0dXJlfSBUaGUgY3ViZSB0ZXh0dXJlLgogICAqLwogIGxvYWQodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IG5ldyBPbygpOwogICAgcy5jb2xvclNwYWNlID0gcmk7CiAgICBjb25zdCByID0gbmV3IFVvKHRoaXMubWFuYWdlcik7CiAgICByLnNldENyb3NzT3JpZ2luKHRoaXMuY3Jvc3NPcmlnaW4pLCByLnNldFBhdGgodGhpcy5wYXRoKTsKICAgIGxldCBvID0gMDsKICAgIGZ1bmN0aW9uIGwoaCkgewogICAgICByLmxvYWQodFtoXSwgZnVuY3Rpb24oYykgewogICAgICAgIHMuaW1hZ2VzW2hdID0gYywgbysrLCBvID09PSA2ICYmIChzLm5lZWRzVXBkYXRlID0gITAsIGUgJiYgZShzKSk7CiAgICAgIH0sIHZvaWQgMCwgbik7CiAgICB9CiAgICBmb3IgKGxldCBoID0gMDsgaCA8IHQubGVuZ3RoOyArK2gpCiAgICAgIGwoaCk7CiAgICByZXR1cm4gczsKICB9Cn0KY2xhc3MgSGIgZXh0ZW5kcyBUaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBkYXRhIHRleHR1cmUgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzZXMgdGhlIGxvYWRlZCBkYXRhIHRleHR1cmUKICAgKiB0byB0aGUgYG9uTG9hZCgpYCBjYWxsYmFjay4gVGhlIG1ldGhvZCBhbHNvIHJldHVybnMgYSBuZXcgdGV4dHVyZSBvYmplY3Qgd2hpY2ggY2FuCiAgICogZGlyZWN0bHkgYmUgdXNlZCBmb3IgbWF0ZXJpYWwgY3JlYXRpb24uIElmIHlvdSBkbyBpdCB0aGlzIHdheSwgdGhlIHRleHR1cmUKICAgKiBtYXkgcG9wIHVwIGluIHlvdXIgc2NlbmUgb25jZSB0aGUgcmVzcGVjdGl2ZSBsb2FkaW5nIHByb2Nlc3MgaXMgZmluaXNoZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIHBhdGgvVVJMIG9mIHRoZSBmaWxlIHRvIGJlIGxvYWRlZC4gVGhpcyBjYW4gYWxzbyBiZSBhIGRhdGEgVVJJLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oRGF0YVRleHR1cmUpfSBvbkxvYWQgLSBFeGVjdXRlZCB3aGVuIHRoZSBsb2FkaW5nIHByb2Nlc3MgaGFzIGJlZW4gZmluaXNoZWQuCiAgICogQHBhcmFtIHtvblByb2dyZXNzQ2FsbGJhY2t9IG9uUHJvZ3Jlc3MgLSBFeGVjdXRlZCB3aGlsZSB0aGUgbG9hZGluZyBpcyBpbiBwcm9ncmVzcy4KICAgKiBAcGFyYW0ge29uRXJyb3JDYWxsYmFja30gb25FcnJvciAtIEV4ZWN1dGVkIHdoZW4gZXJyb3JzIG9jY3VyLgogICAqIEByZXR1cm4ge0RhdGFUZXh0dXJlfSBUaGUgZGF0YSB0ZXh0dXJlLgogICAqLwogIGxvYWQodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IHRoaXMsIHIgPSBuZXcgQ24oKSwgbyA9IG5ldyBzcyh0aGlzLm1hbmFnZXIpOwogICAgcmV0dXJuIG8uc2V0UmVzcG9uc2VUeXBlKCJhcnJheWJ1ZmZlciIpLCBvLnNldFJlcXVlc3RIZWFkZXIodGhpcy5yZXF1ZXN0SGVhZGVyKSwgby5zZXRQYXRoKHRoaXMucGF0aCksIG8uc2V0V2l0aENyZWRlbnRpYWxzKHMud2l0aENyZWRlbnRpYWxzKSwgby5sb2FkKHQsIGZ1bmN0aW9uKGwpIHsKICAgICAgbGV0IGg7CiAgICAgIHRyeSB7CiAgICAgICAgaCA9IHMucGFyc2UobCk7CiAgICAgIH0gY2F0Y2ggKGMpIHsKICAgICAgICBpZiAobiAhPT0gdm9pZCAwKQogICAgICAgICAgbihjKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIGguaW1hZ2UgIT09IHZvaWQgMCA/IHIuaW1hZ2UgPSBoLmltYWdlIDogaC5kYXRhICE9PSB2b2lkIDAgJiYgKHIuaW1hZ2Uud2lkdGggPSBoLndpZHRoLCByLmltYWdlLmhlaWdodCA9IGguaGVpZ2h0LCByLmltYWdlLmRhdGEgPSBoLmRhdGEpLCByLndyYXBTID0gaC53cmFwUyAhPT0gdm9pZCAwID8gaC53cmFwUyA6IFNpLCByLndyYXBUID0gaC53cmFwVCAhPT0gdm9pZCAwID8gaC53cmFwVCA6IFNpLCByLm1hZ0ZpbHRlciA9IGgubWFnRmlsdGVyICE9PSB2b2lkIDAgPyBoLm1hZ0ZpbHRlciA6IENlLCByLm1pbkZpbHRlciA9IGgubWluRmlsdGVyICE9PSB2b2lkIDAgPyBoLm1pbkZpbHRlciA6IENlLCByLmFuaXNvdHJvcHkgPSBoLmFuaXNvdHJvcHkgIT09IHZvaWQgMCA/IGguYW5pc290cm9weSA6IDEsIGguY29sb3JTcGFjZSAhPT0gdm9pZCAwICYmIChyLmNvbG9yU3BhY2UgPSBoLmNvbG9yU3BhY2UpLCBoLmZsaXBZICE9PSB2b2lkIDAgJiYgKHIuZmxpcFkgPSBoLmZsaXBZKSwgaC5mb3JtYXQgIT09IHZvaWQgMCAmJiAoci5mb3JtYXQgPSBoLmZvcm1hdCksIGgudHlwZSAhPT0gdm9pZCAwICYmIChyLnR5cGUgPSBoLnR5cGUpLCBoLm1pcG1hcHMgIT09IHZvaWQgMCAmJiAoci5taXBtYXBzID0gaC5taXBtYXBzLCByLm1pbkZpbHRlciA9IEVuKSwgaC5taXBtYXBDb3VudCA9PT0gMSAmJiAoci5taW5GaWx0ZXIgPSBDZSksIGguZ2VuZXJhdGVNaXBtYXBzICE9PSB2b2lkIDAgJiYgKHIuZ2VuZXJhdGVNaXBtYXBzID0gaC5nZW5lcmF0ZU1pcG1hcHMpLCByLm5lZWRzVXBkYXRlID0gITAsIGUgJiYgZShyLCBoKTsKICAgIH0sIGksIG4pLCByOwogIH0KfQpjbGFzcyBHYiBleHRlbmRzIFRpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHRleHR1cmUgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzIHRoZSBmdWxseSBsb2FkZWQgdGV4dHVyZQogICAqIHRvIHRoZSBgb25Mb2FkKClgIGNhbGxiYWNrLiBUaGUgbWV0aG9kIGFsc28gcmV0dXJucyBhIG5ldyB0ZXh0dXJlIG9iamVjdCB3aGljaCBjYW4KICAgKiBkaXJlY3RseSBiZSB1c2VkIGZvciBtYXRlcmlhbCBjcmVhdGlvbi4gSWYgeW91IGRvIGl0IHRoaXMgd2F5LCB0aGUgdGV4dHVyZQogICAqIG1heSBwb3AgdXAgaW4geW91ciBzY2VuZSBvbmNlIHRoZSByZXNwZWN0aXZlIGxvYWRpbmcgcHJvY2VzcyBpcyBmaW5pc2hlZC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgcGF0aC9VUkwgb2YgdGhlIGZpbGUgdG8gYmUgbG9hZGVkLiBUaGlzIGNhbiBhbHNvIGJlIGEgZGF0YSBVUkkuCiAgICogQHBhcmFtIHtmdW5jdGlvbihUZXh0dXJlKX0gb25Mb2FkIC0gRXhlY3V0ZWQgd2hlbiB0aGUgbG9hZGluZyBwcm9jZXNzIGhhcyBiZWVuIGZpbmlzaGVkLgogICAqIEBwYXJhbSB7b25Qcm9ncmVzc0NhbGxiYWNrfSBvblByb2dyZXNzIC0gVW5zdXBwb3J0ZWQgaW4gdGhpcyBsb2FkZXIuCiAgICogQHBhcmFtIHtvbkVycm9yQ2FsbGJhY2t9IG9uRXJyb3IgLSBFeGVjdXRlZCB3aGVuIGVycm9ycyBvY2N1ci4KICAgKiBAcmV0dXJuIHtUZXh0dXJlfSBUaGUgdGV4dHVyZS4KICAgKi8KICBsb2FkKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSBuZXcgTmUoKSwgciA9IG5ldyBVbyh0aGlzLm1hbmFnZXIpOwogICAgcmV0dXJuIHIuc2V0Q3Jvc3NPcmlnaW4odGhpcy5jcm9zc09yaWdpbiksIHIuc2V0UGF0aCh0aGlzLnBhdGgpLCByLmxvYWQodCwgZnVuY3Rpb24obykgewogICAgICBzLmltYWdlID0gbywgcy5uZWVkc1VwZGF0ZSA9ICEwLCBlICE9PSB2b2lkIDAgJiYgZShzKTsKICAgIH0sIGksIG4pLCBzOwogIH0KfQpjbGFzcyBGcyBleHRlbmRzIGxlIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxpZ2h0LgogICAqCiAgICogQHBhcmFtIHsobnVtYmVyfENvbG9yfHN0cmluZyl9IFtjb2xvcj0weGZmZmZmZl0gLSBUaGUgbGlnaHQncyBjb2xvci4KICAgKiBAcGFyYW0ge251bWJlcn0gW2ludGVuc2l0eT0xXSAtIFRoZSBsaWdodCdzIHN0cmVuZ3RoL2ludGVuc2l0eS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlID0gMSkgewogICAgc3VwZXIoKSwgdGhpcy5pc0xpZ2h0ID0gITAsIHRoaXMudHlwZSA9ICJMaWdodCIsIHRoaXMuY29sb3IgPSBuZXcgY3QodCksIHRoaXMuaW50ZW5zaXR5ID0gZTsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICovCiAgZGlzcG9zZSgpIHsKICB9CiAgY29weSh0LCBlKSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0LCBlKSwgdGhpcy5jb2xvci5jb3B5KHQuY29sb3IpLCB0aGlzLmludGVuc2l0eSA9IHQuaW50ZW5zaXR5LCB0aGlzOwogIH0KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHN1cGVyLnRvSlNPTih0KTsKICAgIHJldHVybiBlLm9iamVjdC5jb2xvciA9IHRoaXMuY29sb3IuZ2V0SGV4KCksIGUub2JqZWN0LmludGVuc2l0eSA9IHRoaXMuaW50ZW5zaXR5LCB0aGlzLmdyb3VuZENvbG9yICE9PSB2b2lkIDAgJiYgKGUub2JqZWN0Lmdyb3VuZENvbG9yID0gdGhpcy5ncm91bmRDb2xvci5nZXRIZXgoKSksIHRoaXMuZGlzdGFuY2UgIT09IHZvaWQgMCAmJiAoZS5vYmplY3QuZGlzdGFuY2UgPSB0aGlzLmRpc3RhbmNlKSwgdGhpcy5hbmdsZSAhPT0gdm9pZCAwICYmIChlLm9iamVjdC5hbmdsZSA9IHRoaXMuYW5nbGUpLCB0aGlzLmRlY2F5ICE9PSB2b2lkIDAgJiYgKGUub2JqZWN0LmRlY2F5ID0gdGhpcy5kZWNheSksIHRoaXMucGVudW1icmEgIT09IHZvaWQgMCAmJiAoZS5vYmplY3QucGVudW1icmEgPSB0aGlzLnBlbnVtYnJhKSwgdGhpcy5zaGFkb3cgIT09IHZvaWQgMCAmJiAoZS5vYmplY3Quc2hhZG93ID0gdGhpcy5zaGFkb3cudG9KU09OKCkpLCB0aGlzLnRhcmdldCAhPT0gdm9pZCAwICYmIChlLm9iamVjdC50YXJnZXQgPSB0aGlzLnRhcmdldC51dWlkKSwgZTsKICB9Cn0KY2xhc3MgYV8gZXh0ZW5kcyBGcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBoZW1pc3BoZXJlIGxpZ2h0LgogICAqCiAgICogQHBhcmFtIHsobnVtYmVyfENvbG9yfHN0cmluZyl9IFtza3lDb2xvcj0weGZmZmZmZl0gLSBUaGUgbGlnaHQncyBza3kgY29sb3IuCiAgICogQHBhcmFtIHsobnVtYmVyfENvbG9yfHN0cmluZyl9IFtncm91bmRDb2xvcj0weGZmZmZmZl0gLSBUaGUgbGlnaHQncyBncm91bmQgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtpbnRlbnNpdHk9MV0gLSBUaGUgbGlnaHQncyBzdHJlbmd0aC9pbnRlbnNpdHkuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIodCwgaSksIHRoaXMuaXNIZW1pc3BoZXJlTGlnaHQgPSAhMCwgdGhpcy50eXBlID0gIkhlbWlzcGhlcmVMaWdodCIsIHRoaXMucG9zaXRpb24uY29weShsZS5ERUZBVUxUX1VQKSwgdGhpcy51cGRhdGVNYXRyaXgoKSwgdGhpcy5ncm91bmRDb2xvciA9IG5ldyBjdChlKTsKICB9CiAgY29weSh0LCBlKSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0LCBlKSwgdGhpcy5ncm91bmRDb2xvci5jb3B5KHQuZ3JvdW5kQ29sb3IpLCB0aGlzOwogIH0KfQpjb25zdCBZdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKSwgeG0gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgdm0gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKY2xhc3Mgc2YgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbGlnaHQgc2hhZG93LgogICAqCiAgICogQHBhcmFtIHtDYW1lcmF9IGNhbWVyYSAtIFRoZSBsaWdodCdzIHZpZXcgb2YgdGhlIHdvcmxkLgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHRoaXMuY2FtZXJhID0gdCwgdGhpcy5pbnRlbnNpdHkgPSAxLCB0aGlzLmJpYXMgPSAwLCB0aGlzLm5vcm1hbEJpYXMgPSAwLCB0aGlzLnJhZGl1cyA9IDEsIHRoaXMuYmx1clNhbXBsZXMgPSA4LCB0aGlzLm1hcFNpemUgPSBuZXcgSig1MTIsIDUxMiksIHRoaXMubWFwVHlwZSA9IHBuLCB0aGlzLm1hcCA9IG51bGwsIHRoaXMubWFwUGFzcyA9IG51bGwsIHRoaXMubWF0cml4ID0gbmV3IFZ0KCksIHRoaXMuYXV0b1VwZGF0ZSA9ICEwLCB0aGlzLm5lZWRzVXBkYXRlID0gITEsIHRoaXMuX2ZydXN0dW0gPSBuZXcgRWEoKSwgdGhpcy5fZnJhbWVFeHRlbnRzID0gbmV3IEooMSwgMSksIHRoaXMuX3ZpZXdwb3J0Q291bnQgPSAxLCB0aGlzLl92aWV3cG9ydHMgPSBbCiAgICAgIG5ldyBRdCgwLCAwLCAxLCAxKQogICAgXTsKICB9CiAgLyoqCiAgICogVXNlZCBpbnRlcm5hbGx5IGJ5IHRoZSByZW5kZXJlciB0byBnZXQgdGhlIG51bWJlciBvZiB2aWV3cG9ydHMgdGhhdCBuZWVkCiAgICogdG8gYmUgcmVuZGVyZWQgZm9yIHRoaXMgc2hhZG93LgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgdmlld3BvcnQgY291bnQuCiAgICovCiAgZ2V0Vmlld3BvcnRDb3VudCgpIHsKICAgIHJldHVybiB0aGlzLl92aWV3cG9ydENvdW50OwogIH0KICAvKioKICAgKiBHZXRzIHRoZSBzaGFkb3cgY2FtZXJhcyBmcnVzdHVtLiBVc2VkIGludGVybmFsbHkgYnkgdGhlIHJlbmRlcmVyIHRvIGN1bGwgb2JqZWN0cy4KICAgKgogICAqIEByZXR1cm4ge0ZydXN0dW19IFRoZSBzaGFkb3cgY2FtZXJhIGZydXN0dW0uCiAgICovCiAgZ2V0RnJ1c3R1bSgpIHsKICAgIHJldHVybiB0aGlzLl9mcnVzdHVtOwogIH0KICAvKioKICAgKiBVcGRhdGUgdGhlIG1hdHJpY2VzIGZvciB0aGUgY2FtZXJhIGFuZCBzaGFkb3csIHVzZWQgaW50ZXJuYWxseSBieSB0aGUgcmVuZGVyZXIuCiAgICoKICAgKiBAcGFyYW0ge0xpZ2h0fSBsaWdodCAtIFRoZSBsaWdodCBmb3Igd2hpY2ggdGhlIHNoYWRvdyBpcyBiZWluZyByZW5kZXJlZC4KICAgKi8KICB1cGRhdGVNYXRyaWNlcyh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5jYW1lcmEsIGkgPSB0aGlzLm1hdHJpeDsKICAgIHhtLnNldEZyb21NYXRyaXhQb3NpdGlvbih0Lm1hdHJpeFdvcmxkKSwgZS5wb3NpdGlvbi5jb3B5KHhtKSwgdm0uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHQudGFyZ2V0Lm1hdHJpeFdvcmxkKSwgZS5sb29rQXQodm0pLCBlLnVwZGF0ZU1hdHJpeFdvcmxkKCksIFl1Lm11bHRpcGx5TWF0cmljZXMoZS5wcm9qZWN0aW9uTWF0cml4LCBlLm1hdHJpeFdvcmxkSW52ZXJzZSksIHRoaXMuX2ZydXN0dW0uc2V0RnJvbVByb2plY3Rpb25NYXRyaXgoWXUsIGUuY29vcmRpbmF0ZVN5c3RlbSwgZS5yZXZlcnNlZERlcHRoKSwgZS5yZXZlcnNlZERlcHRoID8gaS5zZXQoCiAgICAgIDAuNSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMC41LAogICAgICAwLAogICAgICAwLjUsCiAgICAgIDAsCiAgICAgIDAuNSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSA6IGkuc2V0KAogICAgICAwLjUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAuNSwKICAgICAgMCwKICAgICAgMC41LAogICAgICAwLAogICAgICAwLjUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAuNSwKICAgICAgMC41LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCBpLm11bHRpcGx5KFl1KTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHZpZXdwb3J0IGRlZmluaXRpb24gZm9yIHRoZSBnaXZlbiB2aWV3cG9ydCBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2aWV3cG9ydEluZGV4IC0gVGhlIHZpZXdwb3J0IGluZGV4LgogICAqIEByZXR1cm4ge1ZlY3RvcjR9IFRoZSB2aWV3cG9ydC4KICAgKi8KICBnZXRWaWV3cG9ydCh0KSB7CiAgICByZXR1cm4gdGhpcy5fdmlld3BvcnRzW3RdOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBmcmFtZSBleHRlbmRzLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gVGhlIGZyYW1lIGV4dGVuZHMuCiAgICovCiAgZ2V0RnJhbWVFeHRlbnRzKCkgewogICAgcmV0dXJuIHRoaXMuX2ZyYW1lRXh0ZW50czsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMubWFwICYmIHRoaXMubWFwLmRpc3Bvc2UoKSwgdGhpcy5tYXBQYXNzICYmIHRoaXMubWFwUGFzcy5kaXNwb3NlKCk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBsaWdodCBzaGFkb3cgaW5zdGFuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7TGlnaHRTaGFkb3d9IHNvdXJjZSAtIFRoZSBsaWdodCBzaGFkb3cgdG8gY29weS4KICAgKiBAcmV0dXJuIHtMaWdodFNoYWRvd30gQSByZWZlcmVuY2UgdG8gdGhpcyBsaWdodCBzaGFkb3cgaW5zdGFuY2UuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5jYW1lcmEgPSB0LmNhbWVyYS5jbG9uZSgpLCB0aGlzLmludGVuc2l0eSA9IHQuaW50ZW5zaXR5LCB0aGlzLmJpYXMgPSB0LmJpYXMsIHRoaXMucmFkaXVzID0gdC5yYWRpdXMsIHRoaXMuYXV0b1VwZGF0ZSA9IHQuYXV0b1VwZGF0ZSwgdGhpcy5uZWVkc1VwZGF0ZSA9IHQubmVlZHNVcGRhdGUsIHRoaXMubm9ybWFsQmlhcyA9IHQubm9ybWFsQmlhcywgdGhpcy5ibHVyU2FtcGxlcyA9IHQuYmx1clNhbXBsZXMsIHRoaXMubWFwU2l6ZS5jb3B5KHQubWFwU2l6ZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgbGlnaHQgc2hhZG93IGluc3RhbmNlIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtMaWdodFNoYWRvd30gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgLyoqCiAgICogU2VyaWFsaXplcyB0aGUgbGlnaHQgc2hhZG93IGludG8gSlNPTi4KICAgKgogICAqIEByZXR1cm4ge09iamVjdH0gQSBKU09OIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNlcmlhbGl6ZWQgbGlnaHQgc2hhZG93LgogICAqIEBzZWUge0BsaW5rIE9iamVjdExvYWRlciNwYXJzZX0KICAgKi8KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0ge307CiAgICByZXR1cm4gdGhpcy5pbnRlbnNpdHkgIT09IDEgJiYgKHQuaW50ZW5zaXR5ID0gdGhpcy5pbnRlbnNpdHkpLCB0aGlzLmJpYXMgIT09IDAgJiYgKHQuYmlhcyA9IHRoaXMuYmlhcyksIHRoaXMubm9ybWFsQmlhcyAhPT0gMCAmJiAodC5ub3JtYWxCaWFzID0gdGhpcy5ub3JtYWxCaWFzKSwgdGhpcy5yYWRpdXMgIT09IDEgJiYgKHQucmFkaXVzID0gdGhpcy5yYWRpdXMpLCAodGhpcy5tYXBTaXplLnggIT09IDUxMiB8fCB0aGlzLm1hcFNpemUueSAhPT0gNTEyKSAmJiAodC5tYXBTaXplID0gdGhpcy5tYXBTaXplLnRvQXJyYXkoKSksIHQuY2FtZXJhID0gdGhpcy5jYW1lcmEudG9KU09OKCExKS5vYmplY3QsIGRlbGV0ZSB0LmNhbWVyYS5tYXRyaXgsIHQ7CiAgfQp9CmNsYXNzIFdiIGV4dGVuZHMgc2YgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc3BvdCBsaWdodCBzaGFkb3cuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcihuZXcgVmUoNTAsIDEsIDAuNSwgNTAwKSksIHRoaXMuaXNTcG90TGlnaHRTaGFkb3cgPSAhMCwgdGhpcy5mb2N1cyA9IDEsIHRoaXMuYXNwZWN0ID0gMTsKICB9CiAgdXBkYXRlTWF0cmljZXModCkgewogICAgY29uc3QgZSA9IHRoaXMuY2FtZXJhLCBpID0geWEgKiAyICogdC5hbmdsZSAqIHRoaXMuZm9jdXMsIG4gPSB0aGlzLm1hcFNpemUud2lkdGggLyB0aGlzLm1hcFNpemUuaGVpZ2h0ICogdGhpcy5hc3BlY3QsIHMgPSB0LmRpc3RhbmNlIHx8IGUuZmFyOwogICAgKGkgIT09IGUuZm92IHx8IG4gIT09IGUuYXNwZWN0IHx8IHMgIT09IGUuZmFyKSAmJiAoZS5mb3YgPSBpLCBlLmFzcGVjdCA9IG4sIGUuZmFyID0gcywgZS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCkpLCBzdXBlci51cGRhdGVNYXRyaWNlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5mb2N1cyA9IHQuZm9jdXMsIHRoaXM7CiAgfQp9CmNsYXNzIG9fIGV4dGVuZHMgRnMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc3BvdCBsaWdodC4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxDb2xvcnxzdHJpbmcpfSBbY29sb3I9MHhmZmZmZmZdIC0gVGhlIGxpZ2h0J3MgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtpbnRlbnNpdHk9MV0gLSBUaGUgbGlnaHQncyBzdHJlbmd0aC9pbnRlbnNpdHkgbWVhc3VyZWQgaW4gY2FuZGVsYSAoY2QpLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlzdGFuY2U9MF0gLSBNYXhpbXVtIHJhbmdlIG9mIHRoZSBsaWdodC4gYDBgIG1lYW5zIG5vIGxpbWl0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYW5nbGU9TWF0aC5QSS8zXSAtIE1heGltdW0gYW5nbGUgb2YgbGlnaHQgZGlzcGVyc2lvbiBmcm9tIGl0cyBkaXJlY3Rpb24gd2hvc2UgdXBwZXIgYm91bmQgaXMgYE1hdGguUEkvMmAuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtwZW51bWJyYT0wXSAtIFBlcmNlbnQgb2YgdGhlIHNwb3RsaWdodCBjb25lIHRoYXQgaXMgYXR0ZW51YXRlZCBkdWUgdG8gcGVudW1icmEuIFZhbHVlIHJhbmdlIGlzIGBbMCwxXWAuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkZWNheT0yXSAtIFRoZSBhbW91bnQgdGhlIGxpZ2h0IGRpbXMgYWxvbmcgdGhlIGRpc3RhbmNlIG9mIHRoZSBsaWdodC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpID0gMCwgbiA9IE1hdGguUEkgLyAzLCBzID0gMCwgciA9IDIpIHsKICAgIHN1cGVyKHQsIGUpLCB0aGlzLmlzU3BvdExpZ2h0ID0gITAsIHRoaXMudHlwZSA9ICJTcG90TGlnaHQiLCB0aGlzLnBvc2l0aW9uLmNvcHkobGUuREVGQVVMVF9VUCksIHRoaXMudXBkYXRlTWF0cml4KCksIHRoaXMudGFyZ2V0ID0gbmV3IGxlKCksIHRoaXMuZGlzdGFuY2UgPSBpLCB0aGlzLmFuZ2xlID0gbiwgdGhpcy5wZW51bWJyYSA9IHMsIHRoaXMuZGVjYXkgPSByLCB0aGlzLm1hcCA9IG51bGwsIHRoaXMuc2hhZG93ID0gbmV3IFdiKCk7CiAgfQogIC8qKgogICAqIFRoZSBsaWdodCdzIHBvd2VyLiBQb3dlciBpcyB0aGUgbHVtaW5vdXMgcG93ZXIgb2YgdGhlIGxpZ2h0IG1lYXN1cmVkIGluIGx1bWVucyAobG0pLgogICAqICBDaGFuZ2luZyB0aGUgcG93ZXIgd2lsbCBhbHNvIGNoYW5nZSB0aGUgbGlnaHQncyBpbnRlbnNpdHkuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCBwb3dlcigpIHsKICAgIHJldHVybiB0aGlzLmludGVuc2l0eSAqIE1hdGguUEk7CiAgfQogIHNldCBwb3dlcih0KSB7CiAgICB0aGlzLmludGVuc2l0eSA9IHQgLyBNYXRoLlBJOwogIH0KICBkaXNwb3NlKCkgewogICAgdGhpcy5zaGFkb3cuZGlzcG9zZSgpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0aGlzLmRpc3RhbmNlID0gdC5kaXN0YW5jZSwgdGhpcy5hbmdsZSA9IHQuYW5nbGUsIHRoaXMucGVudW1icmEgPSB0LnBlbnVtYnJhLCB0aGlzLmRlY2F5ID0gdC5kZWNheSwgdGhpcy50YXJnZXQgPSB0LnRhcmdldC5jbG9uZSgpLCB0aGlzLnNoYWRvdyA9IHQuc2hhZG93LmNsb25lKCksIHRoaXM7CiAgfQp9CmNvbnN0IGJtID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpLCBYYSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBadSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpOwpjbGFzcyBxYiBleHRlbmRzIHNmIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHBvaW50IGxpZ2h0IHNoYWRvdy4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKG5ldyBWZSg5MCwgMSwgMC41LCA1MDApKSwgdGhpcy5pc1BvaW50TGlnaHRTaGFkb3cgPSAhMCwgdGhpcy5fZnJhbWVFeHRlbnRzID0gbmV3IEooNCwgMiksIHRoaXMuX3ZpZXdwb3J0Q291bnQgPSA2LCB0aGlzLl92aWV3cG9ydHMgPSBbCiAgICAgIC8vIFRoZXNlIHZpZXdwb3J0cyBtYXAgYSBjdWJlLW1hcCBvbnRvIGEgMkQgdGV4dHVyZSB3aXRoIHRoZQogICAgICAvLyBmb2xsb3dpbmcgb3JpZW50YXRpb246CiAgICAgIC8vCiAgICAgIC8vICB4elhaCiAgICAgIC8vICAgeSBZCiAgICAgIC8vCiAgICAgIC8vIFggLSBQb3NpdGl2ZSB4IGRpcmVjdGlvbgogICAgICAvLyB4IC0gTmVnYXRpdmUgeCBkaXJlY3Rpb24KICAgICAgLy8gWSAtIFBvc2l0aXZlIHkgZGlyZWN0aW9uCiAgICAgIC8vIHkgLSBOZWdhdGl2ZSB5IGRpcmVjdGlvbgogICAgICAvLyBaIC0gUG9zaXRpdmUgeiBkaXJlY3Rpb24KICAgICAgLy8geiAtIE5lZ2F0aXZlIHogZGlyZWN0aW9uCiAgICAgIC8vIHBvc2l0aXZlIFgKICAgICAgbmV3IFF0KDIsIDEsIDEsIDEpLAogICAgICAvLyBuZWdhdGl2ZSBYCiAgICAgIG5ldyBRdCgwLCAxLCAxLCAxKSwKICAgICAgLy8gcG9zaXRpdmUgWgogICAgICBuZXcgUXQoMywgMSwgMSwgMSksCiAgICAgIC8vIG5lZ2F0aXZlIFoKICAgICAgbmV3IFF0KDEsIDEsIDEsIDEpLAogICAgICAvLyBwb3NpdGl2ZSBZCiAgICAgIG5ldyBRdCgzLCAwLCAxLCAxKSwKICAgICAgLy8gbmVnYXRpdmUgWQogICAgICBuZXcgUXQoMSwgMCwgMSwgMSkKICAgIF0sIHRoaXMuX2N1YmVEaXJlY3Rpb25zID0gWwogICAgICBuZXcgRSgxLCAwLCAwKSwKICAgICAgbmV3IEUoLTEsIDAsIDApLAogICAgICBuZXcgRSgwLCAwLCAxKSwKICAgICAgbmV3IEUoMCwgMCwgLTEpLAogICAgICBuZXcgRSgwLCAxLCAwKSwKICAgICAgbmV3IEUoMCwgLTEsIDApCiAgICBdLCB0aGlzLl9jdWJlVXBzID0gWwogICAgICBuZXcgRSgwLCAxLCAwKSwKICAgICAgbmV3IEUoMCwgMSwgMCksCiAgICAgIG5ldyBFKDAsIDEsIDApLAogICAgICBuZXcgRSgwLCAxLCAwKSwKICAgICAgbmV3IEUoMCwgMCwgMSksCiAgICAgIG5ldyBFKDAsIDAsIC0xKQogICAgXTsKICB9CiAgLyoqCiAgICogVXBkYXRlIHRoZSBtYXRyaWNlcyBmb3IgdGhlIGNhbWVyYSBhbmQgc2hhZG93LCB1c2VkIGludGVybmFsbHkgYnkgdGhlIHJlbmRlcmVyLgogICAqCiAgICogQHBhcmFtIHtMaWdodH0gbGlnaHQgLSBUaGUgbGlnaHQgZm9yIHdoaWNoIHRoZSBzaGFkb3cgaXMgYmVpbmcgcmVuZGVyZWQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt2aWV3cG9ydEluZGV4PTBdIC0gVGhlIHZpZXdwb3J0IGluZGV4LgogICAqLwogIHVwZGF0ZU1hdHJpY2VzKHQsIGUgPSAwKSB7CiAgICBjb25zdCBpID0gdGhpcy5jYW1lcmEsIG4gPSB0aGlzLm1hdHJpeCwgcyA9IHQuZGlzdGFuY2UgfHwgaS5mYXI7CiAgICBzICE9PSBpLmZhciAmJiAoaS5mYXIgPSBzLCBpLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKSksIFhhLnNldEZyb21NYXRyaXhQb3NpdGlvbih0Lm1hdHJpeFdvcmxkKSwgaS5wb3NpdGlvbi5jb3B5KFhhKSwgWnUuY29weShpLnBvc2l0aW9uKSwgWnUuYWRkKHRoaXMuX2N1YmVEaXJlY3Rpb25zW2VdKSwgaS51cC5jb3B5KHRoaXMuX2N1YmVVcHNbZV0pLCBpLmxvb2tBdChadSksIGkudXBkYXRlTWF0cml4V29ybGQoKSwgbi5tYWtlVHJhbnNsYXRpb24oLVhhLngsIC1YYS55LCAtWGEueiksIGJtLm11bHRpcGx5TWF0cmljZXMoaS5wcm9qZWN0aW9uTWF0cml4LCBpLm1hdHJpeFdvcmxkSW52ZXJzZSksIHRoaXMuX2ZydXN0dW0uc2V0RnJvbVByb2plY3Rpb25NYXRyaXgoYm0sIGkuY29vcmRpbmF0ZVN5c3RlbSwgaS5yZXZlcnNlZERlcHRoKTsKICB9Cn0KY2xhc3MgbF8gZXh0ZW5kcyBGcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwb2ludCBsaWdodC4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxDb2xvcnxzdHJpbmcpfSBbY29sb3I9MHhmZmZmZmZdIC0gVGhlIGxpZ2h0J3MgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtpbnRlbnNpdHk9MV0gLSBUaGUgbGlnaHQncyBzdHJlbmd0aC9pbnRlbnNpdHkgbWVhc3VyZWQgaW4gY2FuZGVsYSAoY2QpLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlzdGFuY2U9MF0gLSBNYXhpbXVtIHJhbmdlIG9mIHRoZSBsaWdodC4gYDBgIG1lYW5zIG5vIGxpbWl0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGVjYXk9Ml0gLSBUaGUgYW1vdW50IHRoZSBsaWdodCBkaW1zIGFsb25nIHRoZSBkaXN0YW5jZSBvZiB0aGUgbGlnaHQuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSA9IDAsIG4gPSAyKSB7CiAgICBzdXBlcih0LCBlKSwgdGhpcy5pc1BvaW50TGlnaHQgPSAhMCwgdGhpcy50eXBlID0gIlBvaW50TGlnaHQiLCB0aGlzLmRpc3RhbmNlID0gaSwgdGhpcy5kZWNheSA9IG4sIHRoaXMuc2hhZG93ID0gbmV3IHFiKCk7CiAgfQogIC8qKgogICAqIFRoZSBsaWdodCdzIHBvd2VyLiBQb3dlciBpcyB0aGUgbHVtaW5vdXMgcG93ZXIgb2YgdGhlIGxpZ2h0IG1lYXN1cmVkIGluIGx1bWVucyAobG0pLgogICAqIENoYW5naW5nIHRoZSBwb3dlciB3aWxsIGFsc28gY2hhbmdlIHRoZSBsaWdodCdzIGludGVuc2l0eS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgZ2V0IHBvd2VyKCkgewogICAgcmV0dXJuIHRoaXMuaW50ZW5zaXR5ICogNCAqIE1hdGguUEk7CiAgfQogIHNldCBwb3dlcih0KSB7CiAgICB0aGlzLmludGVuc2l0eSA9IHQgLyAoNCAqIE1hdGguUEkpOwogIH0KICBkaXNwb3NlKCkgewogICAgdGhpcy5zaGFkb3cuZGlzcG9zZSgpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0aGlzLmRpc3RhbmNlID0gdC5kaXN0YW5jZSwgdGhpcy5kZWNheSA9IHQuZGVjYXksIHRoaXMuc2hhZG93ID0gdC5zaGFkb3cuY2xvbmUoKSwgdGhpczsKICB9Cn0KY2xhc3MgSWEgZXh0ZW5kcyBrYyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBvcnRob2dyYXBoaWMgY2FtZXJhLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtsZWZ0PS0xXSAtIFRoZSBsZWZ0IHBsYW5lIG9mIHRoZSBjYW1lcmEncyBmcnVzdHVtLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmlnaHQ9MV0gLSBUaGUgcmlnaHQgcGxhbmUgb2YgdGhlIGNhbWVyYSdzIGZydXN0dW0uCiAgICogQHBhcmFtIHtudW1iZXJ9IFt0b3A9MV0gLSBUaGUgdG9wIHBsYW5lIG9mIHRoZSBjYW1lcmEncyBmcnVzdHVtLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYm90dG9tPS0xXSAtIFRoZSBib3R0b20gcGxhbmUgb2YgdGhlIGNhbWVyYSdzIGZydXN0dW0uCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuZWFyPTAuMV0gLSBUaGUgY2FtZXJhJ3MgbmVhciBwbGFuZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2Zhcj0yMDAwXSAtIFRoZSBjYW1lcmEncyBmYXIgcGxhbmUuCiAgICovCiAgY29uc3RydWN0b3IodCA9IC0xLCBlID0gMSwgaSA9IDEsIG4gPSAtMSwgcyA9IDAuMSwgciA9IDJlMykgewogICAgc3VwZXIoKSwgdGhpcy5pc09ydGhvZ3JhcGhpY0NhbWVyYSA9ICEwLCB0aGlzLnR5cGUgPSAiT3J0aG9ncmFwaGljQ2FtZXJhIiwgdGhpcy56b29tID0gMSwgdGhpcy52aWV3ID0gbnVsbCwgdGhpcy5sZWZ0ID0gdCwgdGhpcy5yaWdodCA9IGUsIHRoaXMudG9wID0gaSwgdGhpcy5ib3R0b20gPSBuLCB0aGlzLm5lYXIgPSBzLCB0aGlzLmZhciA9IHIsIHRoaXMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0aGlzLmxlZnQgPSB0LmxlZnQsIHRoaXMucmlnaHQgPSB0LnJpZ2h0LCB0aGlzLnRvcCA9IHQudG9wLCB0aGlzLmJvdHRvbSA9IHQuYm90dG9tLCB0aGlzLm5lYXIgPSB0Lm5lYXIsIHRoaXMuZmFyID0gdC5mYXIsIHRoaXMuem9vbSA9IHQuem9vbSwgdGhpcy52aWV3ID0gdC52aWV3ID09PSBudWxsID8gbnVsbCA6IE9iamVjdC5hc3NpZ24oe30sIHQudmlldyksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgYW4gb2Zmc2V0IGluIGEgbGFyZ2VyIGZydXN0dW0uIFRoaXMgaXMgdXNlZnVsIGZvciBtdWx0aS13aW5kb3cgb3IKICAgKiBtdWx0aS1tb25pdG9yL211bHRpLW1hY2hpbmUgc2V0dXBzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGZ1bGxXaWR0aCAtIFRoZSBmdWxsIHdpZHRoIG9mIG11bHRpdmlldyBzZXR1cC4KICAgKiBAcGFyYW0ge251bWJlcn0gZnVsbEhlaWdodCAtIFRoZSBmdWxsIGhlaWdodCBvZiBtdWx0aXZpZXcgc2V0dXAuCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgaG9yaXpvbnRhbCBvZmZzZXQgb2YgdGhlIHN1YmNhbWVyYS4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2ZXJ0aWNhbCBvZmZzZXQgb2YgdGhlIHN1YmNhbWVyYS4KICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2Ygc3ViY2FtZXJhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHN1YmNhbWVyYS4KICAgKiBAc2VlIHtAbGluayBQZXJzcGVjdGl2ZUNhbWVyYSNzZXRWaWV3T2Zmc2V0fQogICAqLwogIHNldFZpZXdPZmZzZXQodCwgZSwgaSwgbiwgcywgcikgewogICAgdGhpcy52aWV3ID09PSBudWxsICYmICh0aGlzLnZpZXcgPSB7CiAgICAgIGVuYWJsZWQ6ICEwLAogICAgICBmdWxsV2lkdGg6IDEsCiAgICAgIGZ1bGxIZWlnaHQ6IDEsCiAgICAgIG9mZnNldFg6IDAsCiAgICAgIG9mZnNldFk6IDAsCiAgICAgIHdpZHRoOiAxLAogICAgICBoZWlnaHQ6IDEKICAgIH0pLCB0aGlzLnZpZXcuZW5hYmxlZCA9ICEwLCB0aGlzLnZpZXcuZnVsbFdpZHRoID0gdCwgdGhpcy52aWV3LmZ1bGxIZWlnaHQgPSBlLCB0aGlzLnZpZXcub2Zmc2V0WCA9IGksIHRoaXMudmlldy5vZmZzZXRZID0gbiwgdGhpcy52aWV3LndpZHRoID0gcywgdGhpcy52aWV3LmhlaWdodCA9IHIsIHRoaXMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogIH0KICAvKioKICAgKiBSZW1vdmVzIHRoZSB2aWV3IG9mZnNldCBmcm9tIHRoZSBwcm9qZWN0aW9uIG1hdHJpeC4KICAgKi8KICBjbGVhclZpZXdPZmZzZXQoKSB7CiAgICB0aGlzLnZpZXcgIT09IG51bGwgJiYgKHRoaXMudmlldy5lbmFibGVkID0gITEpLCB0aGlzLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgY2FtZXJhJ3MgcHJvamVjdGlvbiBtYXRyaXguIE11c3QgYmUgY2FsbGVkIGFmdGVyIGFueSBjaGFuZ2Ugb2YKICAgKiBjYW1lcmEgcHJvcGVydGllcy4KICAgKi8KICB1cGRhdGVQcm9qZWN0aW9uTWF0cml4KCkgewogICAgY29uc3QgdCA9ICh0aGlzLnJpZ2h0IC0gdGhpcy5sZWZ0KSAvICgyICogdGhpcy56b29tKSwgZSA9ICh0aGlzLnRvcCAtIHRoaXMuYm90dG9tKSAvICgyICogdGhpcy56b29tKSwgaSA9ICh0aGlzLnJpZ2h0ICsgdGhpcy5sZWZ0KSAvIDIsIG4gPSAodGhpcy50b3AgKyB0aGlzLmJvdHRvbSkgLyAyOwogICAgbGV0IHMgPSBpIC0gdCwgciA9IGkgKyB0LCBvID0gbiArIGUsIGwgPSBuIC0gZTsKICAgIGlmICh0aGlzLnZpZXcgIT09IG51bGwgJiYgdGhpcy52aWV3LmVuYWJsZWQpIHsKICAgICAgY29uc3QgaCA9ICh0aGlzLnJpZ2h0IC0gdGhpcy5sZWZ0KSAvIHRoaXMudmlldy5mdWxsV2lkdGggLyB0aGlzLnpvb20sIGMgPSAodGhpcy50b3AgLSB0aGlzLmJvdHRvbSkgLyB0aGlzLnZpZXcuZnVsbEhlaWdodCAvIHRoaXMuem9vbTsKICAgICAgcyArPSBoICogdGhpcy52aWV3Lm9mZnNldFgsIHIgPSBzICsgaCAqIHRoaXMudmlldy53aWR0aCwgbyAtPSBjICogdGhpcy52aWV3Lm9mZnNldFksIGwgPSBvIC0gYyAqIHRoaXMudmlldy5oZWlnaHQ7CiAgICB9CiAgICB0aGlzLnByb2plY3Rpb25NYXRyaXgubWFrZU9ydGhvZ3JhcGhpYyhzLCByLCBvLCBsLCB0aGlzLm5lYXIsIHRoaXMuZmFyLCB0aGlzLmNvb3JkaW5hdGVTeXN0ZW0sIHRoaXMucmV2ZXJzZWREZXB0aCksIHRoaXMucHJvamVjdGlvbk1hdHJpeEludmVyc2UuY29weSh0aGlzLnByb2plY3Rpb25NYXRyaXgpLmludmVydCgpOwogIH0KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHN1cGVyLnRvSlNPTih0KTsKICAgIHJldHVybiBlLm9iamVjdC56b29tID0gdGhpcy56b29tLCBlLm9iamVjdC5sZWZ0ID0gdGhpcy5sZWZ0LCBlLm9iamVjdC5yaWdodCA9IHRoaXMucmlnaHQsIGUub2JqZWN0LnRvcCA9IHRoaXMudG9wLCBlLm9iamVjdC5ib3R0b20gPSB0aGlzLmJvdHRvbSwgZS5vYmplY3QubmVhciA9IHRoaXMubmVhciwgZS5vYmplY3QuZmFyID0gdGhpcy5mYXIsIHRoaXMudmlldyAhPT0gbnVsbCAmJiAoZS5vYmplY3QudmlldyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMudmlldykpLCBlOwogIH0KfQpjbGFzcyAkYiBleHRlbmRzIHNmIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGRpcmVjdGlvbmFsIGxpZ2h0IHNoYWRvdy4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKG5ldyBJYSgtNSwgNSwgNSwgLTUsIDAuNSwgNTAwKSksIHRoaXMuaXNEaXJlY3Rpb25hbExpZ2h0U2hhZG93ID0gITA7CiAgfQp9CmNsYXNzIHJmIGV4dGVuZHMgRnMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgZGlyZWN0aW9uYWwgbGlnaHQuCiAgICoKICAgKiBAcGFyYW0geyhudW1iZXJ8Q29sb3J8c3RyaW5nKX0gW2NvbG9yPTB4ZmZmZmZmXSAtIFRoZSBsaWdodCdzIGNvbG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaW50ZW5zaXR5PTFdIC0gVGhlIGxpZ2h0J3Mgc3RyZW5ndGgvaW50ZW5zaXR5LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIHN1cGVyKHQsIGUpLCB0aGlzLmlzRGlyZWN0aW9uYWxMaWdodCA9ICEwLCB0aGlzLnR5cGUgPSAiRGlyZWN0aW9uYWxMaWdodCIsIHRoaXMucG9zaXRpb24uY29weShsZS5ERUZBVUxUX1VQKSwgdGhpcy51cGRhdGVNYXRyaXgoKSwgdGhpcy50YXJnZXQgPSBuZXcgbGUoKSwgdGhpcy5zaGFkb3cgPSBuZXcgJGIoKTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuc2hhZG93LmRpc3Bvc2UoKTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy50YXJnZXQgPSB0LnRhcmdldC5jbG9uZSgpLCB0aGlzLnNoYWRvdyA9IHQuc2hhZG93LmNsb25lKCksIHRoaXM7CiAgfQp9CmNsYXNzIGFmIGV4dGVuZHMgRnMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYW1iaWVudCBsaWdodC4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxDb2xvcnxzdHJpbmcpfSBbY29sb3I9MHhmZmZmZmZdIC0gVGhlIGxpZ2h0J3MgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtpbnRlbnNpdHk9MV0gLSBUaGUgbGlnaHQncyBzdHJlbmd0aC9pbnRlbnNpdHkuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSkgewogICAgc3VwZXIodCwgZSksIHRoaXMuaXNBbWJpZW50TGlnaHQgPSAhMCwgdGhpcy50eXBlID0gIkFtYmllbnRMaWdodCI7CiAgfQp9CmNsYXNzIGhfIGV4dGVuZHMgRnMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYXJlYSBsaWdodC4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxDb2xvcnxzdHJpbmcpfSBbY29sb3I9MHhmZmZmZmZdIC0gVGhlIGxpZ2h0J3MgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtpbnRlbnNpdHk9MV0gLSBUaGUgbGlnaHQncyBzdHJlbmd0aC9pbnRlbnNpdHkuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0xMF0gLSBUaGUgd2lkdGggb2YgdGhlIGxpZ2h0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTEwXSAtIFRoZSBoZWlnaHQgb2YgdGhlIGxpZ2h0LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkgPSAxMCwgbiA9IDEwKSB7CiAgICBzdXBlcih0LCBlKSwgdGhpcy5pc1JlY3RBcmVhTGlnaHQgPSAhMCwgdGhpcy50eXBlID0gIlJlY3RBcmVhTGlnaHQiLCB0aGlzLndpZHRoID0gaSwgdGhpcy5oZWlnaHQgPSBuOwogIH0KICAvKioKICAgKiBUaGUgbGlnaHQncyBwb3dlci4gUG93ZXIgaXMgdGhlIGx1bWlub3VzIHBvd2VyIG9mIHRoZSBsaWdodCBtZWFzdXJlZCBpbiBsdW1lbnMgKGxtKS4KICAgKiBDaGFuZ2luZyB0aGUgcG93ZXIgd2lsbCBhbHNvIGNoYW5nZSB0aGUgbGlnaHQncyBpbnRlbnNpdHkuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCBwb3dlcigpIHsKICAgIHJldHVybiB0aGlzLmludGVuc2l0eSAqIHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCAqIE1hdGguUEk7CiAgfQogIHNldCBwb3dlcih0KSB7CiAgICB0aGlzLmludGVuc2l0eSA9IHQgLyAodGhpcy53aWR0aCAqIHRoaXMuaGVpZ2h0ICogTWF0aC5QSSk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMud2lkdGggPSB0LndpZHRoLCB0aGlzLmhlaWdodCA9IHQuaGVpZ2h0LCB0aGlzOwogIH0KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHN1cGVyLnRvSlNPTih0KTsKICAgIHJldHVybiBlLm9iamVjdC53aWR0aCA9IHRoaXMud2lkdGgsIGUub2JqZWN0LmhlaWdodCA9IHRoaXMuaGVpZ2h0LCBlOwogIH0KfQpjbGFzcyBjXyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBzcGhlcmljYWwgaGFybW9uaWNzLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5pc1NwaGVyaWNhbEhhcm1vbmljczMgPSAhMCwgdGhpcy5jb2VmZmljaWVudHMgPSBbXTsKICAgIGZvciAobGV0IHQgPSAwOyB0IDwgOTsgdCsrKQogICAgICB0aGlzLmNvZWZmaWNpZW50cy5wdXNoKG5ldyBFKCkpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBTSCBjb2VmZmljaWVudHMgdG8gdGhpcyBpbnN0YW5jZSBieSBjb3B5aW5nCiAgICogdGhlIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMz59IGNvZWZmaWNpZW50cyAtIFRoZSBTSCBjb2VmZmljaWVudHMuCiAgICogQHJldHVybiB7U3BoZXJpY2FsSGFybW9uaWNzM30gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmljYWwgaGFybW9uaWNzLgogICAqLwogIHNldCh0KSB7CiAgICBmb3IgKGxldCBlID0gMDsgZSA8IDk7IGUrKykKICAgICAgdGhpcy5jb2VmZmljaWVudHNbZV0uY29weSh0W2VdKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIGFsbCBTSCBjb2VmZmljaWVudHMgdG8gYDBgLgogICAqCiAgICogQHJldHVybiB7U3BoZXJpY2FsSGFybW9uaWNzM30gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmljYWwgaGFybW9uaWNzLgogICAqLwogIHplcm8oKSB7CiAgICBmb3IgKGxldCB0ID0gMDsgdCA8IDk7IHQrKykKICAgICAgdGhpcy5jb2VmZmljaWVudHNbdF0uc2V0KDAsIDAsIDApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHJhZGlhbmNlIGluIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGdpdmVuIG5vcm1hbC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gbm9ybWFsIC0gVGhlIG5vcm1hbCB2ZWN0b3IgKGFzc3VtZWQgdG8gYmUgdW5pdCBsZW5ndGgpCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgcmFkaWFuY2UuCiAgICovCiAgZ2V0QXQodCwgZSkgewogICAgY29uc3QgaSA9IHQueCwgbiA9IHQueSwgcyA9IHQueiwgciA9IHRoaXMuY29lZmZpY2llbnRzOwogICAgcmV0dXJuIGUuY29weShyWzBdKS5tdWx0aXBseVNjYWxhcigwLjI4MjA5NSksIGUuYWRkU2NhbGVkVmVjdG9yKHJbMV0sIDAuNDg4NjAzICogbiksIGUuYWRkU2NhbGVkVmVjdG9yKHJbMl0sIDAuNDg4NjAzICogcyksIGUuYWRkU2NhbGVkVmVjdG9yKHJbM10sIDAuNDg4NjAzICogaSksIGUuYWRkU2NhbGVkVmVjdG9yKHJbNF0sIDEuMDkyNTQ4ICogKGkgKiBuKSksIGUuYWRkU2NhbGVkVmVjdG9yKHJbNV0sIDEuMDkyNTQ4ICogKG4gKiBzKSksIGUuYWRkU2NhbGVkVmVjdG9yKHJbNl0sIDAuMzE1MzkyICogKDMgKiBzICogcyAtIDEpKSwgZS5hZGRTY2FsZWRWZWN0b3Iocls3XSwgMS4wOTI1NDggKiAoaSAqIHMpKSwgZS5hZGRTY2FsZWRWZWN0b3Iocls4XSwgMC41NDYyNzQgKiAoaSAqIGkgLSBuICogbikpLCBlOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBpcnJhZGlhbmNlIChyYWRpYW5jZSBjb252b2x2ZWQgd2l0aCBjb3NpbmUgbG9iZSkgaW4gdGhlCiAgICogZGlyZWN0aW9uIG9mIHRoZSBnaXZlbiBub3JtYWwuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IG5vcm1hbCAtIFRoZSBub3JtYWwgdmVjdG9yIChhc3N1bWVkIHRvIGJlIHVuaXQgbGVuZ3RoKQogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIGlycmFkaWFuY2UuCiAgICovCiAgZ2V0SXJyYWRpYW5jZUF0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0LngsIG4gPSB0LnksIHMgPSB0LnosIHIgPSB0aGlzLmNvZWZmaWNpZW50czsKICAgIHJldHVybiBlLmNvcHkoclswXSkubXVsdGlwbHlTY2FsYXIoMC44ODYyMjcpLCBlLmFkZFNjYWxlZFZlY3RvcihyWzFdLCAyICogMC41MTE2NjQgKiBuKSwgZS5hZGRTY2FsZWRWZWN0b3IoclsyXSwgMiAqIDAuNTExNjY0ICogcyksIGUuYWRkU2NhbGVkVmVjdG9yKHJbM10sIDIgKiAwLjUxMTY2NCAqIGkpLCBlLmFkZFNjYWxlZFZlY3RvcihyWzRdLCAyICogMC40MjkwNDMgKiBpICogbiksIGUuYWRkU2NhbGVkVmVjdG9yKHJbNV0sIDIgKiAwLjQyOTA0MyAqIG4gKiBzKSwgZS5hZGRTY2FsZWRWZWN0b3Iocls2XSwgMC43NDMxMjUgKiBzICogcyAtIDAuMjQ3NzA4KSwgZS5hZGRTY2FsZWRWZWN0b3Iocls3XSwgMiAqIDAuNDI5MDQzICogaSAqIHMpLCBlLmFkZFNjYWxlZFZlY3RvcihyWzhdLCAwLjQyOTA0MyAqIChpICogaSAtIG4gKiBuKSksIGU7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIFNIIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyaWNhbEhhcm1vbmljczN9IHNoIC0gVGhlIFNIIHRvIGFkZC4KICAgKiBAcmV0dXJuIHtTcGhlcmljYWxIYXJtb25pY3MzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHNwaGVyaWNhbCBoYXJtb25pY3MuCiAgICovCiAgYWRkKHQpIHsKICAgIGZvciAobGV0IGUgPSAwOyBlIDwgOTsgZSsrKQogICAgICB0aGlzLmNvZWZmaWNpZW50c1tlXS5hZGQodC5jb2VmZmljaWVudHNbZV0pOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIEEgY29udmVuaWVuY2UgbWV0aG9kIGZvciBwZXJmb3JtaW5nIHtAbGluayBTcGhlcmljYWxIYXJtb25pY3MzI2FkZH0gYW5kCiAgICoge0BsaW5rIFNwaGVyaWNhbEhhcm1vbmljczMjc2NhbGV9IGF0IG9uY2UuCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyaWNhbEhhcm1vbmljczN9IHNoIC0gVGhlIFNIIHRvIGFkZC4KICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBzY2FsZSBmYWN0b3IuCiAgICogQHJldHVybiB7U3BoZXJpY2FsSGFybW9uaWNzM30gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmljYWwgaGFybW9uaWNzLgogICAqLwogIGFkZFNjYWxlZFNIKHQsIGUpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgOTsgaSsrKQogICAgICB0aGlzLmNvZWZmaWNpZW50c1tpXS5hZGRTY2FsZWRWZWN0b3IodC5jb2VmZmljaWVudHNbaV0sIGUpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFNjYWxlcyB0aGlzIFNIIGJ5IHRoZSBnaXZlbiBzY2FsZSBmYWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBzY2FsZSBmYWN0b3IuCiAgICogQHJldHVybiB7U3BoZXJpY2FsSGFybW9uaWNzM30gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmljYWwgaGFybW9uaWNzLgogICAqLwogIHNjYWxlKHQpIHsKICAgIGZvciAobGV0IGUgPSAwOyBlIDwgOTsgZSsrKQogICAgICB0aGlzLmNvZWZmaWNpZW50c1tlXS5tdWx0aXBseVNjYWxhcih0KTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBMaW5lYXIgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIFNIIGFuZCB0aGlzIGluc3RhbmNlIGJ5IHRoZSBnaXZlbgogICAqIGFscGhhIGZhY3Rvci4KICAgKgogICAqIEBwYXJhbSB7U3BoZXJpY2FsSGFybW9uaWNzM30gc2ggLSBUaGUgU0ggdG8gaW50ZXJwb2xhdGUgd2l0aC4KICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgZmFjdG9yLgogICAqIEByZXR1cm4ge1NwaGVyaWNhbEhhcm1vbmljczN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgc3BoZXJpY2FsIGhhcm1vbmljcy4KICAgKi8KICBsZXJwKHQsIGUpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgOTsgaSsrKQogICAgICB0aGlzLmNvZWZmaWNpZW50c1tpXS5sZXJwKHQuY29lZmZpY2llbnRzW2ldLCBlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIHNwaGVyaWNhbCBoYXJtb25pY3MgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtTcGhlcmljYWxIYXJtb25pY3MzfSBzaCAtIFRoZSBzcGhlcmljYWwgaGFybW9uaWNzIHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyBzcGhlcmljYWwgaGFybW9uaWNzIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgZm9yIChsZXQgZSA9IDA7IGUgPCA5OyBlKyspCiAgICAgIGlmICghdGhpcy5jb2VmZmljaWVudHNbZV0uZXF1YWxzKHQuY29lZmZpY2llbnRzW2VdKSkKICAgICAgICByZXR1cm4gITE7CiAgICByZXR1cm4gITA7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBzcGhlcmljYWwgaGFybW9uaWNzIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyaWNhbEhhcm1vbmljczN9IHNoIC0gVGhlIHNwaGVyaWNhbCBoYXJtb25pY3MgdG8gY29weS4KICAgKiBAcmV0dXJuIHtTcGhlcmljYWxIYXJtb25pY3MzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHNwaGVyaWNhbCBoYXJtb25pY3MuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXQodC5jb2VmZmljaWVudHMpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHNwaGVyaWNhbCBoYXJtb25pY3Mgd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge1NwaGVyaWNhbEhhcm1vbmljczN9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIFNIIGNvZWZmaWNpZW50cyBvZiB0aGlzIGluc3RhbmNlIGZyb20gdGhlIGdpdmVuIGFycmF5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIEFuIGFycmF5IGhvbGRpbmcgdGhlIFNIIGNvZWZmaWNpZW50cy4KICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldD0wXSAtIFRoZSBhcnJheSBvZmZzZXQgd2hlcmUgdG8gc3RhcnQgY29weWluZy4KICAgKiBAcmV0dXJuIHtTcGhlcmljYWxIYXJtb25pY3MzfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICBjb25zdCBpID0gdGhpcy5jb2VmZmljaWVudHM7CiAgICBmb3IgKGxldCBuID0gMDsgbiA8IDk7IG4rKykKICAgICAgaVtuXS5mcm9tQXJyYXkodCwgZSArIG4gKiAzKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGFuIGFycmF5IHdpdGggdGhlIFNIIGNvZWZmaWNpZW50cywgb3IgY29waWVzIHRoZW0gaW50byB0aGUgcHJvdmlkZWQKICAgKiBhcnJheS4gVGhlIGNvZWZmaWNpZW50cyBhcmUgcmVwcmVzZW50ZWQgYXMgbnVtYmVycy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBUaGUgYXJyYXkgb2Zmc2V0IHdoZXJlIHRvIHN0YXJ0IGNvcHlpbmcuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gQW4gYXJyYXkgd2l0aCBmbGF0IFNIIGNvZWZmaWNpZW50cy4KICAgKi8KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIGNvbnN0IGkgPSB0aGlzLmNvZWZmaWNpZW50czsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgOTsgbisrKQogICAgICBpW25dLnRvQXJyYXkodCwgZSArIG4gKiAzKTsKICAgIHJldHVybiB0OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgU0ggYmFzaXMgZm9yIHRoZSBnaXZlbiBub3JtYWwgdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBub3JtYWwgLSBUaGUgbm9ybWFsLgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gc2hCYXNpcyAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgU0ggYmFzaXMuCiAgICovCiAgc3RhdGljIGdldEJhc2lzQXQodCwgZSkgewogICAgY29uc3QgaSA9IHQueCwgbiA9IHQueSwgcyA9IHQuejsKICAgIGVbMF0gPSAwLjI4MjA5NSwgZVsxXSA9IDAuNDg4NjAzICogbiwgZVsyXSA9IDAuNDg4NjAzICogcywgZVszXSA9IDAuNDg4NjAzICogaSwgZVs0XSA9IDEuMDkyNTQ4ICogaSAqIG4sIGVbNV0gPSAxLjA5MjU0OCAqIG4gKiBzLCBlWzZdID0gMC4zMTUzOTIgKiAoMyAqIHMgKiBzIC0gMSksIGVbN10gPSAxLjA5MjU0OCAqIGkgKiBzLCBlWzhdID0gMC41NDYyNzQgKiAoaSAqIGkgLSBuICogbik7CiAgfQp9CmNsYXNzIHVfIGV4dGVuZHMgRnMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbGlnaHQgcHJvYmUuCiAgICoKICAgKiBAcGFyYW0ge1NwaGVyaWNhbEhhcm1vbmljczN9IHNoIC0gVGhlIHNwaGVyaWNhbCBoYXJtb25pY3Mgd2hpY2ggcmVwcmVzZW50cyBlbmNvZGVkIGxpZ2h0aW5nIGluZm9ybWF0aW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaW50ZW5zaXR5PTFdIC0gVGhlIGxpZ2h0J3Mgc3RyZW5ndGgvaW50ZW5zaXR5LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgY18oKSwgZSA9IDEpIHsKICAgIHN1cGVyKHZvaWQgMCwgZSksIHRoaXMuaXNMaWdodFByb2JlID0gITAsIHRoaXMuc2ggPSB0OwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQpLCB0aGlzLnNoLmNvcHkodC5zaCksIHRoaXM7CiAgfQogIC8qKgogICAqIERlc2VyaWFsaXplcyB0aGUgbGlnaHQgcHJvdmUgZnJvbSB0aGUgZ2l2ZW4gSlNPTi4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIEpTT04gaG9sZGluZyB0aGUgc2VyaWFsaXplZCBsaWdodCBwcm9iZS4KICAgKiBAcmV0dXJuIHtMaWdodFByb2JlfSBBIHJlZmVyZW5jZSB0byB0aGlzIGxpZ2h0IHByb2JlLgogICAqLwogIGZyb21KU09OKHQpIHsKICAgIHJldHVybiB0aGlzLmludGVuc2l0eSA9IHQuaW50ZW5zaXR5LCB0aGlzLnNoLmZyb21BcnJheSh0LnNoKSwgdGhpczsKICB9CiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSBzdXBlci50b0pTT04odCk7CiAgICByZXR1cm4gZS5vYmplY3Quc2ggPSB0aGlzLnNoLnRvQXJyYXkoKSwgZTsKICB9Cn0KY2xhc3MgYXUgZXh0ZW5kcyBUaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBtYXRlcmlhbCBsb2FkZXIuCiAgICoKICAgKiBAcGFyYW0ge0xvYWRpbmdNYW5hZ2VyfSBbbWFuYWdlcl0gLSBUaGUgbG9hZGluZyBtYW5hZ2VyLgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKHQpLCB0aGlzLnRleHR1cmVzID0ge307CiAgfQogIC8qKgogICAqIFN0YXJ0cyBsb2FkaW5nIGZyb20gdGhlIGdpdmVuIFVSTCBhbmQgcGFzcyB0aGUgbG9hZGVkIG1hdGVyaWFsIHRvIHRoZSBgb25Mb2FkKClgIGNhbGxiYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuIFRoaXMgY2FuIGFsc28gYmUgYSBkYXRhIFVSSS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKE1hdGVyaWFsKX0gb25Mb2FkIC0gRXhlY3V0ZWQgd2hlbiB0aGUgbG9hZGluZyBwcm9jZXNzIGhhcyBiZWVuIGZpbmlzaGVkLgogICAqIEBwYXJhbSB7b25Qcm9ncmVzc0NhbGxiYWNrfSBvblByb2dyZXNzIC0gRXhlY3V0ZWQgd2hpbGUgdGhlIGxvYWRpbmcgaXMgaW4gcHJvZ3Jlc3MuCiAgICogQHBhcmFtIHtvbkVycm9yQ2FsbGJhY2t9IG9uRXJyb3IgLSBFeGVjdXRlZCB3aGVuIGVycm9ycyBvY2N1ci4KICAgKi8KICBsb2FkKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSB0aGlzLCByID0gbmV3IHNzKHMubWFuYWdlcik7CiAgICByLnNldFBhdGgocy5wYXRoKSwgci5zZXRSZXF1ZXN0SGVhZGVyKHMucmVxdWVzdEhlYWRlciksIHIuc2V0V2l0aENyZWRlbnRpYWxzKHMud2l0aENyZWRlbnRpYWxzKSwgci5sb2FkKHQsIGZ1bmN0aW9uKG8pIHsKICAgICAgdHJ5IHsKICAgICAgICBlKHMucGFyc2UoSlNPTi5wYXJzZShvKSkpOwogICAgICB9IGNhdGNoIChsKSB7CiAgICAgICAgbiA/IG4obCkgOiBjb25zb2xlLmVycm9yKGwpLCBzLm1hbmFnZXIuaXRlbUVycm9yKHQpOwogICAgICB9CiAgICB9LCBpLCBuKTsKICB9CiAgLyoqCiAgICogUGFyc2VzIHRoZSBnaXZlbiBKU09OIG9iamVjdCBhbmQgcmV0dXJucyBhIG1hdGVyaWFsLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgc2VyaWFsaXplZCBtYXRlcmlhbC4KICAgKiBAcmV0dXJuIHtNYXRlcmlhbH0gVGhlIHBhcnNlZCBtYXRlcmlhbC4KICAgKi8KICBwYXJzZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy50ZXh0dXJlczsKICAgIGZ1bmN0aW9uIGkocykgewogICAgICByZXR1cm4gZVtzXSA9PT0gdm9pZCAwICYmIGNvbnNvbGUud2FybigiVEhSRUUuTWF0ZXJpYWxMb2FkZXI6IFVuZGVmaW5lZCB0ZXh0dXJlIiwgcyksIGVbc107CiAgICB9CiAgICBjb25zdCBuID0gdGhpcy5jcmVhdGVNYXRlcmlhbEZyb21UeXBlKHQudHlwZSk7CiAgICBpZiAodC51dWlkICE9PSB2b2lkIDAgJiYgKG4udXVpZCA9IHQudXVpZCksIHQubmFtZSAhPT0gdm9pZCAwICYmIChuLm5hbWUgPSB0Lm5hbWUpLCB0LmNvbG9yICE9PSB2b2lkIDAgJiYgbi5jb2xvciAhPT0gdm9pZCAwICYmIG4uY29sb3Iuc2V0SGV4KHQuY29sb3IpLCB0LnJvdWdobmVzcyAhPT0gdm9pZCAwICYmIChuLnJvdWdobmVzcyA9IHQucm91Z2huZXNzKSwgdC5tZXRhbG5lc3MgIT09IHZvaWQgMCAmJiAobi5tZXRhbG5lc3MgPSB0Lm1ldGFsbmVzcyksIHQuc2hlZW4gIT09IHZvaWQgMCAmJiAobi5zaGVlbiA9IHQuc2hlZW4pLCB0LnNoZWVuQ29sb3IgIT09IHZvaWQgMCAmJiAobi5zaGVlbkNvbG9yID0gbmV3IGN0KCkuc2V0SGV4KHQuc2hlZW5Db2xvcikpLCB0LnNoZWVuUm91Z2huZXNzICE9PSB2b2lkIDAgJiYgKG4uc2hlZW5Sb3VnaG5lc3MgPSB0LnNoZWVuUm91Z2huZXNzKSwgdC5lbWlzc2l2ZSAhPT0gdm9pZCAwICYmIG4uZW1pc3NpdmUgIT09IHZvaWQgMCAmJiBuLmVtaXNzaXZlLnNldEhleCh0LmVtaXNzaXZlKSwgdC5zcGVjdWxhciAhPT0gdm9pZCAwICYmIG4uc3BlY3VsYXIgIT09IHZvaWQgMCAmJiBuLnNwZWN1bGFyLnNldEhleCh0LnNwZWN1bGFyKSwgdC5zcGVjdWxhckludGVuc2l0eSAhPT0gdm9pZCAwICYmIChuLnNwZWN1bGFySW50ZW5zaXR5ID0gdC5zcGVjdWxhckludGVuc2l0eSksIHQuc3BlY3VsYXJDb2xvciAhPT0gdm9pZCAwICYmIG4uc3BlY3VsYXJDb2xvciAhPT0gdm9pZCAwICYmIG4uc3BlY3VsYXJDb2xvci5zZXRIZXgodC5zcGVjdWxhckNvbG9yKSwgdC5zaGluaW5lc3MgIT09IHZvaWQgMCAmJiAobi5zaGluaW5lc3MgPSB0LnNoaW5pbmVzcyksIHQuY2xlYXJjb2F0ICE9PSB2b2lkIDAgJiYgKG4uY2xlYXJjb2F0ID0gdC5jbGVhcmNvYXQpLCB0LmNsZWFyY29hdFJvdWdobmVzcyAhPT0gdm9pZCAwICYmIChuLmNsZWFyY29hdFJvdWdobmVzcyA9IHQuY2xlYXJjb2F0Um91Z2huZXNzKSwgdC5kaXNwZXJzaW9uICE9PSB2b2lkIDAgJiYgKG4uZGlzcGVyc2lvbiA9IHQuZGlzcGVyc2lvbiksIHQuaXJpZGVzY2VuY2UgIT09IHZvaWQgMCAmJiAobi5pcmlkZXNjZW5jZSA9IHQuaXJpZGVzY2VuY2UpLCB0LmlyaWRlc2NlbmNlSU9SICE9PSB2b2lkIDAgJiYgKG4uaXJpZGVzY2VuY2VJT1IgPSB0LmlyaWRlc2NlbmNlSU9SKSwgdC5pcmlkZXNjZW5jZVRoaWNrbmVzc1JhbmdlICE9PSB2b2lkIDAgJiYgKG4uaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZSA9IHQuaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZSksIHQudHJhbnNtaXNzaW9uICE9PSB2b2lkIDAgJiYgKG4udHJhbnNtaXNzaW9uID0gdC50cmFuc21pc3Npb24pLCB0LnRoaWNrbmVzcyAhPT0gdm9pZCAwICYmIChuLnRoaWNrbmVzcyA9IHQudGhpY2tuZXNzKSwgdC5hdHRlbnVhdGlvbkRpc3RhbmNlICE9PSB2b2lkIDAgJiYgKG4uYXR0ZW51YXRpb25EaXN0YW5jZSA9IHQuYXR0ZW51YXRpb25EaXN0YW5jZSksIHQuYXR0ZW51YXRpb25Db2xvciAhPT0gdm9pZCAwICYmIG4uYXR0ZW51YXRpb25Db2xvciAhPT0gdm9pZCAwICYmIG4uYXR0ZW51YXRpb25Db2xvci5zZXRIZXgodC5hdHRlbnVhdGlvbkNvbG9yKSwgdC5hbmlzb3Ryb3B5ICE9PSB2b2lkIDAgJiYgKG4uYW5pc290cm9weSA9IHQuYW5pc290cm9weSksIHQuYW5pc290cm9weVJvdGF0aW9uICE9PSB2b2lkIDAgJiYgKG4uYW5pc290cm9weVJvdGF0aW9uID0gdC5hbmlzb3Ryb3B5Um90YXRpb24pLCB0LmZvZyAhPT0gdm9pZCAwICYmIChuLmZvZyA9IHQuZm9nKSwgdC5mbGF0U2hhZGluZyAhPT0gdm9pZCAwICYmIChuLmZsYXRTaGFkaW5nID0gdC5mbGF0U2hhZGluZyksIHQuYmxlbmRpbmcgIT09IHZvaWQgMCAmJiAobi5ibGVuZGluZyA9IHQuYmxlbmRpbmcpLCB0LmNvbWJpbmUgIT09IHZvaWQgMCAmJiAobi5jb21iaW5lID0gdC5jb21iaW5lKSwgdC5zaWRlICE9PSB2b2lkIDAgJiYgKG4uc2lkZSA9IHQuc2lkZSksIHQuc2hhZG93U2lkZSAhPT0gdm9pZCAwICYmIChuLnNoYWRvd1NpZGUgPSB0LnNoYWRvd1NpZGUpLCB0Lm9wYWNpdHkgIT09IHZvaWQgMCAmJiAobi5vcGFjaXR5ID0gdC5vcGFjaXR5KSwgdC50cmFuc3BhcmVudCAhPT0gdm9pZCAwICYmIChuLnRyYW5zcGFyZW50ID0gdC50cmFuc3BhcmVudCksIHQuYWxwaGFUZXN0ICE9PSB2b2lkIDAgJiYgKG4uYWxwaGFUZXN0ID0gdC5hbHBoYVRlc3QpLCB0LmFscGhhSGFzaCAhPT0gdm9pZCAwICYmIChuLmFscGhhSGFzaCA9IHQuYWxwaGFIYXNoKSwgdC5kZXB0aEZ1bmMgIT09IHZvaWQgMCAmJiAobi5kZXB0aEZ1bmMgPSB0LmRlcHRoRnVuYyksIHQuZGVwdGhUZXN0ICE9PSB2b2lkIDAgJiYgKG4uZGVwdGhUZXN0ID0gdC5kZXB0aFRlc3QpLCB0LmRlcHRoV3JpdGUgIT09IHZvaWQgMCAmJiAobi5kZXB0aFdyaXRlID0gdC5kZXB0aFdyaXRlKSwgdC5jb2xvcldyaXRlICE9PSB2b2lkIDAgJiYgKG4uY29sb3JXcml0ZSA9IHQuY29sb3JXcml0ZSksIHQuYmxlbmRTcmMgIT09IHZvaWQgMCAmJiAobi5ibGVuZFNyYyA9IHQuYmxlbmRTcmMpLCB0LmJsZW5kRHN0ICE9PSB2b2lkIDAgJiYgKG4uYmxlbmREc3QgPSB0LmJsZW5kRHN0KSwgdC5ibGVuZEVxdWF0aW9uICE9PSB2b2lkIDAgJiYgKG4uYmxlbmRFcXVhdGlvbiA9IHQuYmxlbmRFcXVhdGlvbiksIHQuYmxlbmRTcmNBbHBoYSAhPT0gdm9pZCAwICYmIChuLmJsZW5kU3JjQWxwaGEgPSB0LmJsZW5kU3JjQWxwaGEpLCB0LmJsZW5kRHN0QWxwaGEgIT09IHZvaWQgMCAmJiAobi5ibGVuZERzdEFscGhhID0gdC5ibGVuZERzdEFscGhhKSwgdC5ibGVuZEVxdWF0aW9uQWxwaGEgIT09IHZvaWQgMCAmJiAobi5ibGVuZEVxdWF0aW9uQWxwaGEgPSB0LmJsZW5kRXF1YXRpb25BbHBoYSksIHQuYmxlbmRDb2xvciAhPT0gdm9pZCAwICYmIG4uYmxlbmRDb2xvciAhPT0gdm9pZCAwICYmIG4uYmxlbmRDb2xvci5zZXRIZXgodC5ibGVuZENvbG9yKSwgdC5ibGVuZEFscGhhICE9PSB2b2lkIDAgJiYgKG4uYmxlbmRBbHBoYSA9IHQuYmxlbmRBbHBoYSksIHQuc3RlbmNpbFdyaXRlTWFzayAhPT0gdm9pZCAwICYmIChuLnN0ZW5jaWxXcml0ZU1hc2sgPSB0LnN0ZW5jaWxXcml0ZU1hc2spLCB0LnN0ZW5jaWxGdW5jICE9PSB2b2lkIDAgJiYgKG4uc3RlbmNpbEZ1bmMgPSB0LnN0ZW5jaWxGdW5jKSwgdC5zdGVuY2lsUmVmICE9PSB2b2lkIDAgJiYgKG4uc3RlbmNpbFJlZiA9IHQuc3RlbmNpbFJlZiksIHQuc3RlbmNpbEZ1bmNNYXNrICE9PSB2b2lkIDAgJiYgKG4uc3RlbmNpbEZ1bmNNYXNrID0gdC5zdGVuY2lsRnVuY01hc2spLCB0LnN0ZW5jaWxGYWlsICE9PSB2b2lkIDAgJiYgKG4uc3RlbmNpbEZhaWwgPSB0LnN0ZW5jaWxGYWlsKSwgdC5zdGVuY2lsWkZhaWwgIT09IHZvaWQgMCAmJiAobi5zdGVuY2lsWkZhaWwgPSB0LnN0ZW5jaWxaRmFpbCksIHQuc3RlbmNpbFpQYXNzICE9PSB2b2lkIDAgJiYgKG4uc3RlbmNpbFpQYXNzID0gdC5zdGVuY2lsWlBhc3MpLCB0LnN0ZW5jaWxXcml0ZSAhPT0gdm9pZCAwICYmIChuLnN0ZW5jaWxXcml0ZSA9IHQuc3RlbmNpbFdyaXRlKSwgdC53aXJlZnJhbWUgIT09IHZvaWQgMCAmJiAobi53aXJlZnJhbWUgPSB0LndpcmVmcmFtZSksIHQud2lyZWZyYW1lTGluZXdpZHRoICE9PSB2b2lkIDAgJiYgKG4ud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgpLCB0LndpcmVmcmFtZUxpbmVjYXAgIT09IHZvaWQgMCAmJiAobi53aXJlZnJhbWVMaW5lY2FwID0gdC53aXJlZnJhbWVMaW5lY2FwKSwgdC53aXJlZnJhbWVMaW5lam9pbiAhPT0gdm9pZCAwICYmIChuLndpcmVmcmFtZUxpbmVqb2luID0gdC53aXJlZnJhbWVMaW5lam9pbiksIHQucm90YXRpb24gIT09IHZvaWQgMCAmJiAobi5yb3RhdGlvbiA9IHQucm90YXRpb24pLCB0LmxpbmV3aWR0aCAhPT0gdm9pZCAwICYmIChuLmxpbmV3aWR0aCA9IHQubGluZXdpZHRoKSwgdC5kYXNoU2l6ZSAhPT0gdm9pZCAwICYmIChuLmRhc2hTaXplID0gdC5kYXNoU2l6ZSksIHQuZ2FwU2l6ZSAhPT0gdm9pZCAwICYmIChuLmdhcFNpemUgPSB0LmdhcFNpemUpLCB0LnNjYWxlICE9PSB2b2lkIDAgJiYgKG4uc2NhbGUgPSB0LnNjYWxlKSwgdC5wb2x5Z29uT2Zmc2V0ICE9PSB2b2lkIDAgJiYgKG4ucG9seWdvbk9mZnNldCA9IHQucG9seWdvbk9mZnNldCksIHQucG9seWdvbk9mZnNldEZhY3RvciAhPT0gdm9pZCAwICYmIChuLnBvbHlnb25PZmZzZXRGYWN0b3IgPSB0LnBvbHlnb25PZmZzZXRGYWN0b3IpLCB0LnBvbHlnb25PZmZzZXRVbml0cyAhPT0gdm9pZCAwICYmIChuLnBvbHlnb25PZmZzZXRVbml0cyA9IHQucG9seWdvbk9mZnNldFVuaXRzKSwgdC5kaXRoZXJpbmcgIT09IHZvaWQgMCAmJiAobi5kaXRoZXJpbmcgPSB0LmRpdGhlcmluZyksIHQuYWxwaGFUb0NvdmVyYWdlICE9PSB2b2lkIDAgJiYgKG4uYWxwaGFUb0NvdmVyYWdlID0gdC5hbHBoYVRvQ292ZXJhZ2UpLCB0LnByZW11bHRpcGxpZWRBbHBoYSAhPT0gdm9pZCAwICYmIChuLnByZW11bHRpcGxpZWRBbHBoYSA9IHQucHJlbXVsdGlwbGllZEFscGhhKSwgdC5mb3JjZVNpbmdsZVBhc3MgIT09IHZvaWQgMCAmJiAobi5mb3JjZVNpbmdsZVBhc3MgPSB0LmZvcmNlU2luZ2xlUGFzcyksIHQudmlzaWJsZSAhPT0gdm9pZCAwICYmIChuLnZpc2libGUgPSB0LnZpc2libGUpLCB0LnRvbmVNYXBwZWQgIT09IHZvaWQgMCAmJiAobi50b25lTWFwcGVkID0gdC50b25lTWFwcGVkKSwgdC51c2VyRGF0YSAhPT0gdm9pZCAwICYmIChuLnVzZXJEYXRhID0gdC51c2VyRGF0YSksIHQudmVydGV4Q29sb3JzICE9PSB2b2lkIDAgJiYgKHR5cGVvZiB0LnZlcnRleENvbG9ycyA9PSAibnVtYmVyIiA/IG4udmVydGV4Q29sb3JzID0gdC52ZXJ0ZXhDb2xvcnMgPiAwIDogbi52ZXJ0ZXhDb2xvcnMgPSB0LnZlcnRleENvbG9ycyksIHQudW5pZm9ybXMgIT09IHZvaWQgMCkKICAgICAgZm9yIChjb25zdCBzIGluIHQudW5pZm9ybXMpIHsKICAgICAgICBjb25zdCByID0gdC51bmlmb3Jtc1tzXTsKICAgICAgICBzd2l0Y2ggKG4udW5pZm9ybXNbc10gPSB7fSwgci50eXBlKSB7CiAgICAgICAgICBjYXNlICJ0IjoKICAgICAgICAgICAgbi51bmlmb3Jtc1tzXS52YWx1ZSA9IGkoci52YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiYyI6CiAgICAgICAgICAgIG4udW5pZm9ybXNbc10udmFsdWUgPSBuZXcgY3QoKS5zZXRIZXgoci52YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAidjIiOgogICAgICAgICAgICBuLnVuaWZvcm1zW3NdLnZhbHVlID0gbmV3IEooKS5mcm9tQXJyYXkoci52YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAidjMiOgogICAgICAgICAgICBuLnVuaWZvcm1zW3NdLnZhbHVlID0gbmV3IEUoKS5mcm9tQXJyYXkoci52YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAidjQiOgogICAgICAgICAgICBuLnVuaWZvcm1zW3NdLnZhbHVlID0gbmV3IFF0KCkuZnJvbUFycmF5KHIudmFsdWUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIm0zIjoKICAgICAgICAgICAgbi51bmlmb3Jtc1tzXS52YWx1ZSA9IG5ldyBYdCgpLmZyb21BcnJheShyLnZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJtNCI6CiAgICAgICAgICAgIG4udW5pZm9ybXNbc10udmFsdWUgPSBuZXcgVnQoKS5mcm9tQXJyYXkoci52YWx1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbi51bmlmb3Jtc1tzXS52YWx1ZSA9IHIudmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICBpZiAodC5kZWZpbmVzICE9PSB2b2lkIDAgJiYgKG4uZGVmaW5lcyA9IHQuZGVmaW5lcyksIHQudmVydGV4U2hhZGVyICE9PSB2b2lkIDAgJiYgKG4udmVydGV4U2hhZGVyID0gdC52ZXJ0ZXhTaGFkZXIpLCB0LmZyYWdtZW50U2hhZGVyICE9PSB2b2lkIDAgJiYgKG4uZnJhZ21lbnRTaGFkZXIgPSB0LmZyYWdtZW50U2hhZGVyKSwgdC5nbHNsVmVyc2lvbiAhPT0gdm9pZCAwICYmIChuLmdsc2xWZXJzaW9uID0gdC5nbHNsVmVyc2lvbiksIHQuZXh0ZW5zaW9ucyAhPT0gdm9pZCAwKQogICAgICBmb3IgKGNvbnN0IHMgaW4gdC5leHRlbnNpb25zKQogICAgICAgIG4uZXh0ZW5zaW9uc1tzXSA9IHQuZXh0ZW5zaW9uc1tzXTsKICAgIGlmICh0LmxpZ2h0cyAhPT0gdm9pZCAwICYmIChuLmxpZ2h0cyA9IHQubGlnaHRzKSwgdC5jbGlwcGluZyAhPT0gdm9pZCAwICYmIChuLmNsaXBwaW5nID0gdC5jbGlwcGluZyksIHQuc2l6ZSAhPT0gdm9pZCAwICYmIChuLnNpemUgPSB0LnNpemUpLCB0LnNpemVBdHRlbnVhdGlvbiAhPT0gdm9pZCAwICYmIChuLnNpemVBdHRlbnVhdGlvbiA9IHQuc2l6ZUF0dGVudWF0aW9uKSwgdC5tYXAgIT09IHZvaWQgMCAmJiAobi5tYXAgPSBpKHQubWFwKSksIHQubWF0Y2FwICE9PSB2b2lkIDAgJiYgKG4ubWF0Y2FwID0gaSh0Lm1hdGNhcCkpLCB0LmFscGhhTWFwICE9PSB2b2lkIDAgJiYgKG4uYWxwaGFNYXAgPSBpKHQuYWxwaGFNYXApKSwgdC5idW1wTWFwICE9PSB2b2lkIDAgJiYgKG4uYnVtcE1hcCA9IGkodC5idW1wTWFwKSksIHQuYnVtcFNjYWxlICE9PSB2b2lkIDAgJiYgKG4uYnVtcFNjYWxlID0gdC5idW1wU2NhbGUpLCB0Lm5vcm1hbE1hcCAhPT0gdm9pZCAwICYmIChuLm5vcm1hbE1hcCA9IGkodC5ub3JtYWxNYXApKSwgdC5ub3JtYWxNYXBUeXBlICE9PSB2b2lkIDAgJiYgKG4ubm9ybWFsTWFwVHlwZSA9IHQubm9ybWFsTWFwVHlwZSksIHQubm9ybWFsU2NhbGUgIT09IHZvaWQgMCkgewogICAgICBsZXQgcyA9IHQubm9ybWFsU2NhbGU7CiAgICAgIEFycmF5LmlzQXJyYXkocykgPT09ICExICYmIChzID0gW3MsIHNdKSwgbi5ub3JtYWxTY2FsZSA9IG5ldyBKKCkuZnJvbUFycmF5KHMpOwogICAgfQogICAgcmV0dXJuIHQuZGlzcGxhY2VtZW50TWFwICE9PSB2b2lkIDAgJiYgKG4uZGlzcGxhY2VtZW50TWFwID0gaSh0LmRpc3BsYWNlbWVudE1hcCkpLCB0LmRpc3BsYWNlbWVudFNjYWxlICE9PSB2b2lkIDAgJiYgKG4uZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlKSwgdC5kaXNwbGFjZW1lbnRCaWFzICE9PSB2b2lkIDAgJiYgKG4uZGlzcGxhY2VtZW50QmlhcyA9IHQuZGlzcGxhY2VtZW50QmlhcyksIHQucm91Z2huZXNzTWFwICE9PSB2b2lkIDAgJiYgKG4ucm91Z2huZXNzTWFwID0gaSh0LnJvdWdobmVzc01hcCkpLCB0Lm1ldGFsbmVzc01hcCAhPT0gdm9pZCAwICYmIChuLm1ldGFsbmVzc01hcCA9IGkodC5tZXRhbG5lc3NNYXApKSwgdC5lbWlzc2l2ZU1hcCAhPT0gdm9pZCAwICYmIChuLmVtaXNzaXZlTWFwID0gaSh0LmVtaXNzaXZlTWFwKSksIHQuZW1pc3NpdmVJbnRlbnNpdHkgIT09IHZvaWQgMCAmJiAobi5lbWlzc2l2ZUludGVuc2l0eSA9IHQuZW1pc3NpdmVJbnRlbnNpdHkpLCB0LnNwZWN1bGFyTWFwICE9PSB2b2lkIDAgJiYgKG4uc3BlY3VsYXJNYXAgPSBpKHQuc3BlY3VsYXJNYXApKSwgdC5zcGVjdWxhckludGVuc2l0eU1hcCAhPT0gdm9pZCAwICYmIChuLnNwZWN1bGFySW50ZW5zaXR5TWFwID0gaSh0LnNwZWN1bGFySW50ZW5zaXR5TWFwKSksIHQuc3BlY3VsYXJDb2xvck1hcCAhPT0gdm9pZCAwICYmIChuLnNwZWN1bGFyQ29sb3JNYXAgPSBpKHQuc3BlY3VsYXJDb2xvck1hcCkpLCB0LmVudk1hcCAhPT0gdm9pZCAwICYmIChuLmVudk1hcCA9IGkodC5lbnZNYXApKSwgdC5lbnZNYXBSb3RhdGlvbiAhPT0gdm9pZCAwICYmIG4uZW52TWFwUm90YXRpb24uZnJvbUFycmF5KHQuZW52TWFwUm90YXRpb24pLCB0LmVudk1hcEludGVuc2l0eSAhPT0gdm9pZCAwICYmIChuLmVudk1hcEludGVuc2l0eSA9IHQuZW52TWFwSW50ZW5zaXR5KSwgdC5yZWZsZWN0aXZpdHkgIT09IHZvaWQgMCAmJiAobi5yZWZsZWN0aXZpdHkgPSB0LnJlZmxlY3Rpdml0eSksIHQucmVmcmFjdGlvblJhdGlvICE9PSB2b2lkIDAgJiYgKG4ucmVmcmFjdGlvblJhdGlvID0gdC5yZWZyYWN0aW9uUmF0aW8pLCB0LmxpZ2h0TWFwICE9PSB2b2lkIDAgJiYgKG4ubGlnaHRNYXAgPSBpKHQubGlnaHRNYXApKSwgdC5saWdodE1hcEludGVuc2l0eSAhPT0gdm9pZCAwICYmIChuLmxpZ2h0TWFwSW50ZW5zaXR5ID0gdC5saWdodE1hcEludGVuc2l0eSksIHQuYW9NYXAgIT09IHZvaWQgMCAmJiAobi5hb01hcCA9IGkodC5hb01hcCkpLCB0LmFvTWFwSW50ZW5zaXR5ICE9PSB2b2lkIDAgJiYgKG4uYW9NYXBJbnRlbnNpdHkgPSB0LmFvTWFwSW50ZW5zaXR5KSwgdC5ncmFkaWVudE1hcCAhPT0gdm9pZCAwICYmIChuLmdyYWRpZW50TWFwID0gaSh0LmdyYWRpZW50TWFwKSksIHQuY2xlYXJjb2F0TWFwICE9PSB2b2lkIDAgJiYgKG4uY2xlYXJjb2F0TWFwID0gaSh0LmNsZWFyY29hdE1hcCkpLCB0LmNsZWFyY29hdFJvdWdobmVzc01hcCAhPT0gdm9pZCAwICYmIChuLmNsZWFyY29hdFJvdWdobmVzc01hcCA9IGkodC5jbGVhcmNvYXRSb3VnaG5lc3NNYXApKSwgdC5jbGVhcmNvYXROb3JtYWxNYXAgIT09IHZvaWQgMCAmJiAobi5jbGVhcmNvYXROb3JtYWxNYXAgPSBpKHQuY2xlYXJjb2F0Tm9ybWFsTWFwKSksIHQuY2xlYXJjb2F0Tm9ybWFsU2NhbGUgIT09IHZvaWQgMCAmJiAobi5jbGVhcmNvYXROb3JtYWxTY2FsZSA9IG5ldyBKKCkuZnJvbUFycmF5KHQuY2xlYXJjb2F0Tm9ybWFsU2NhbGUpKSwgdC5pcmlkZXNjZW5jZU1hcCAhPT0gdm9pZCAwICYmIChuLmlyaWRlc2NlbmNlTWFwID0gaSh0LmlyaWRlc2NlbmNlTWFwKSksIHQuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgIT09IHZvaWQgMCAmJiAobi5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCA9IGkodC5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCkpLCB0LnRyYW5zbWlzc2lvbk1hcCAhPT0gdm9pZCAwICYmIChuLnRyYW5zbWlzc2lvbk1hcCA9IGkodC50cmFuc21pc3Npb25NYXApKSwgdC50aGlja25lc3NNYXAgIT09IHZvaWQgMCAmJiAobi50aGlja25lc3NNYXAgPSBpKHQudGhpY2tuZXNzTWFwKSksIHQuYW5pc290cm9weU1hcCAhPT0gdm9pZCAwICYmIChuLmFuaXNvdHJvcHlNYXAgPSBpKHQuYW5pc290cm9weU1hcCkpLCB0LnNoZWVuQ29sb3JNYXAgIT09IHZvaWQgMCAmJiAobi5zaGVlbkNvbG9yTWFwID0gaSh0LnNoZWVuQ29sb3JNYXApKSwgdC5zaGVlblJvdWdobmVzc01hcCAhPT0gdm9pZCAwICYmIChuLnNoZWVuUm91Z2huZXNzTWFwID0gaSh0LnNoZWVuUm91Z2huZXNzTWFwKSksIG47CiAgfQogIC8qKgogICAqIFRleHR1cmVzIGFyZSBub3QgZW1iZWRkZWQgaW4gdGhlIG1hdGVyaWFsIEpTT04gc28gdGhleSBoYXZlCiAgICogdG8gYmUgaW5qZWN0ZWQgYmVmb3JlIHRoZSBsb2FkaW5nIHByb2Nlc3Mgc3RhcnRzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlIC0gQSBkaWN0aW9uYXJ5IGhvbGRpbmcgdGV4dHVyZXMgZm9yIG1hdGVyaWFsIHByb3BlcnRpZXMuCiAgICogQHJldHVybiB7TWF0ZXJpYWxMb2FkZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0ZXJpYWwgbG9hZGVyLgogICAqLwogIHNldFRleHR1cmVzKHQpIHsKICAgIHJldHVybiB0aGlzLnRleHR1cmVzID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIG1hdGVyaWFsIGZvciB0aGUgZ2l2ZW4gdHlwZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIG1hdGVyaWFsIHR5cGUuCiAgICogQHJldHVybiB7TWF0ZXJpYWx9IFRoZSBuZXcgbWF0ZXJpYWwuCiAgICovCiAgY3JlYXRlTWF0ZXJpYWxGcm9tVHlwZSh0KSB7CiAgICByZXR1cm4gYXUuY3JlYXRlTWF0ZXJpYWxGcm9tVHlwZSh0KTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIG1hdGVyaWFsIGZvciB0aGUgZ2l2ZW4gdHlwZS4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSBtYXRlcmlhbCB0eXBlLgogICAqIEByZXR1cm4ge01hdGVyaWFsfSBUaGUgbmV3IG1hdGVyaWFsLgogICAqLwogIHN0YXRpYyBjcmVhdGVNYXRlcmlhbEZyb21UeXBlKHQpIHsKICAgIGNvbnN0IGUgPSB7CiAgICAgIFNoYWRvd01hdGVyaWFsOiAkeSwKICAgICAgU3ByaXRlTWF0ZXJpYWw6IFdjLAogICAgICBSYXdTaGFkZXJNYXRlcmlhbDogWHksCiAgICAgIFNoYWRlck1hdGVyaWFsOiBYaSwKICAgICAgUG9pbnRzTWF0ZXJpYWw6IFhjLAogICAgICBNZXNoUGh5c2ljYWxNYXRlcmlhbDogWXksCiAgICAgIE1lc2hTdGFuZGFyZE1hdGVyaWFsOiBociwKICAgICAgTWVzaFBob25nTWF0ZXJpYWw6IFp5LAogICAgICBNZXNoVG9vbk1hdGVyaWFsOiBqeSwKICAgICAgTWVzaE5vcm1hbE1hdGVyaWFsOiBKeSwKICAgICAgTWVzaExhbWJlcnRNYXRlcmlhbDogS3ksCiAgICAgIE1lc2hEZXB0aE1hdGVyaWFsOiBqcCwKICAgICAgTWVzaERpc3RhbmNlTWF0ZXJpYWw6IEpwLAogICAgICBNZXNoQmFzaWNNYXRlcmlhbDogbGksCiAgICAgIE1lc2hNYXRjYXBNYXRlcmlhbDogUXksCiAgICAgIExpbmVEYXNoZWRNYXRlcmlhbDogS3AsCiAgICAgIExpbmVCYXNpY01hdGVyaWFsOiBQZSwKICAgICAgTWF0ZXJpYWw6IGhpCiAgICB9OwogICAgcmV0dXJuIG5ldyBlW3RdKCk7CiAgfQp9CmNsYXNzIHJwIHsKICAvKioKICAgKiBFeHRyYWN0cyB0aGUgYmFzZSBVUkwgZnJvbSB0aGUgZ2l2ZW4gVVJMLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtVGhlIFVSTCB0byBleHRyYWN0IHRoZSBiYXNlIFVSTCBmcm9tLgogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIGV4dHJhY3RlZCBiYXNlIFVSTC4KICAgKi8KICBzdGF0aWMgZXh0cmFjdFVybEJhc2UodCkgewogICAgY29uc3QgZSA9IHQubGFzdEluZGV4T2YoIi8iKTsKICAgIHJldHVybiBlID09PSAtMSA/ICIuLyIgOiB0LnNsaWNlKDAsIGUgKyAxKTsKICB9CiAgLyoqCiAgICogUmVzb2x2ZXMgcmVsYXRpdmUgVVJMcyBhZ2FpbnN0IHRoZSBnaXZlbiBwYXRoLiBBYnNvbHV0ZSBwYXRocywgZGF0YSB1cmxzLAogICAqIGFuZCBibG9iIFVSTHMgd2lsbCBiZSByZXR1cm5lZCBhcyBpcy4gSW52YWxpZCBVUkxzIHdpbGwgcmV0dXJuIGFuIGVtcHR5CiAgICogc3RyaW5nLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtVGhlIFVSTCB0byByZXNvbHZlLgogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gVGhlIGJhc2UgcGF0aCBmb3IgcmVsYXRpdmUgVVJMcyB0byBiZSByZXNvbHZlZCBhZ2FpbnN0LgogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIHJlc29sdmVkIFVSTC4KICAgKi8KICBzdGF0aWMgcmVzb2x2ZVVSTCh0LCBlKSB7CiAgICByZXR1cm4gdHlwZW9mIHQgIT0gInN0cmluZyIgfHwgdCA9PT0gIiIgPyAiIiA6ICgvXmh0dHBzPzpcL1wvL2kudGVzdChlKSAmJiAvXlwvLy50ZXN0KHQpICYmIChlID0gZS5yZXBsYWNlKC8oXmh0dHBzPzpcL1wvW15cL10rKS4qL2ksICIkMSIpKSwgL14oaHR0cHM/Oik/XC9cLy9pLnRlc3QodCkgfHwgL15kYXRhOi4qLC4qJC9pLnRlc3QodCkgfHwgL15ibG9iOi4qJC9pLnRlc3QodCkgPyB0IDogZSArIHQpOwogIH0KfQpsZXQgb3UgPSBjbGFzcyBleHRlbmRzIEh0IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGluc3RhbmNlZCBidWZmZXIgZ2VvbWV0cnkuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgPSAhMCwgdGhpcy50eXBlID0gIkluc3RhbmNlZEJ1ZmZlckdlb21ldHJ5IiwgdGhpcy5pbnN0YW5jZUNvdW50ID0gMSAvIDA7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuaW5zdGFuY2VDb3VudCA9IHQuaW5zdGFuY2VDb3VudCwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHN1cGVyLnRvSlNPTigpOwogICAgcmV0dXJuIHQuaW5zdGFuY2VDb3VudCA9IHRoaXMuaW5zdGFuY2VDb3VudCwgdC5pc0luc3RhbmNlZEJ1ZmZlckdlb21ldHJ5ID0gITAsIHQ7CiAgfQp9OwpjbGFzcyBkXyBleHRlbmRzIFRpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGdlb21ldHJ5IGxvYWRlci4KICAgKgogICAqIEBwYXJhbSB7TG9hZGluZ01hbmFnZXJ9IFttYW5hZ2VyXSAtIFRoZSBsb2FkaW5nIG1hbmFnZXIuCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIodCk7CiAgfQogIC8qKgogICAqIFN0YXJ0cyBsb2FkaW5nIGZyb20gdGhlIGdpdmVuIFVSTCBhbmQgcGFzcyB0aGUgbG9hZGVkIGdlb21ldHJ5IHRvIHRoZSBgb25Mb2FkKClgIGNhbGxiYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuIFRoaXMgY2FuIGFsc28gYmUgYSBkYXRhIFVSSS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKEJ1ZmZlckdlb21ldHJ5KX0gb25Mb2FkIC0gRXhlY3V0ZWQgd2hlbiB0aGUgbG9hZGluZyBwcm9jZXNzIGhhcyBiZWVuIGZpbmlzaGVkLgogICAqIEBwYXJhbSB7b25Qcm9ncmVzc0NhbGxiYWNrfSBvblByb2dyZXNzIC0gRXhlY3V0ZWQgd2hpbGUgdGhlIGxvYWRpbmcgaXMgaW4gcHJvZ3Jlc3MuCiAgICogQHBhcmFtIHtvbkVycm9yQ2FsbGJhY2t9IG9uRXJyb3IgLSBFeGVjdXRlZCB3aGVuIGVycm9ycyBvY2N1ci4KICAgKi8KICBsb2FkKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSB0aGlzLCByID0gbmV3IHNzKHMubWFuYWdlcik7CiAgICByLnNldFBhdGgocy5wYXRoKSwgci5zZXRSZXF1ZXN0SGVhZGVyKHMucmVxdWVzdEhlYWRlciksIHIuc2V0V2l0aENyZWRlbnRpYWxzKHMud2l0aENyZWRlbnRpYWxzKSwgci5sb2FkKHQsIGZ1bmN0aW9uKG8pIHsKICAgICAgdHJ5IHsKICAgICAgICBlKHMucGFyc2UoSlNPTi5wYXJzZShvKSkpOwogICAgICB9IGNhdGNoIChsKSB7CiAgICAgICAgbiA/IG4obCkgOiBjb25zb2xlLmVycm9yKGwpLCBzLm1hbmFnZXIuaXRlbUVycm9yKHQpOwogICAgICB9CiAgICB9LCBpLCBuKTsKICB9CiAgLyoqCiAgICogUGFyc2VzIHRoZSBnaXZlbiBKU09OIG9iamVjdCBhbmQgcmV0dXJucyBhIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgc2VyaWFsaXplZCBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtCdWZmZXJHZW9tZXRyeX0gVGhlIHBhcnNlZCBnZW9tZXRyeS4KICAgKi8KICBwYXJzZSh0KSB7CiAgICBjb25zdCBlID0ge30sIGkgPSB7fTsKICAgIGZ1bmN0aW9uIG4ocCwgZikgewogICAgICBpZiAoZVtmXSAhPT0gdm9pZCAwKSByZXR1cm4gZVtmXTsKICAgICAgY29uc3QgZyA9IHAuaW50ZXJsZWF2ZWRCdWZmZXJzW2ZdLCBtID0gcyhwLCBnLmJ1ZmZlciksIHYgPSByYShnLnR5cGUsIG0pLCB4ID0gbmV3IEdjKHYsIGcuc3RyaWRlKTsKICAgICAgcmV0dXJuIHgudXVpZCA9IGcudXVpZCwgZVtmXSA9IHgsIHg7CiAgICB9CiAgICBmdW5jdGlvbiBzKHAsIGYpIHsKICAgICAgaWYgKGlbZl0gIT09IHZvaWQgMCkgcmV0dXJuIGlbZl07CiAgICAgIGNvbnN0IGcgPSBwLmFycmF5QnVmZmVyc1tmXSwgbSA9IG5ldyBVaW50MzJBcnJheShnKS5idWZmZXI7CiAgICAgIHJldHVybiBpW2ZdID0gbSwgbTsKICAgIH0KICAgIGNvbnN0IHIgPSB0LmlzSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgPyBuZXcgb3UoKSA6IG5ldyBIdCgpLCBvID0gdC5kYXRhLmluZGV4OwogICAgaWYgKG8gIT09IHZvaWQgMCkgewogICAgICBjb25zdCBwID0gcmEoby50eXBlLCBvLmFycmF5KTsKICAgICAgci5zZXRJbmRleChuZXcgaWUocCwgMSkpOwogICAgfQogICAgY29uc3QgbCA9IHQuZGF0YS5hdHRyaWJ1dGVzOwogICAgZm9yIChjb25zdCBwIGluIGwpIHsKICAgICAgY29uc3QgZiA9IGxbcF07CiAgICAgIGxldCB5OwogICAgICBpZiAoZi5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlKSB7CiAgICAgICAgY29uc3QgZyA9IG4odC5kYXRhLCBmLmRhdGEpOwogICAgICAgIHkgPSBuZXcgdW4oZywgZi5pdGVtU2l6ZSwgZi5vZmZzZXQsIGYubm9ybWFsaXplZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgZyA9IHJhKGYudHlwZSwgZi5hcnJheSksIG0gPSBmLmlzSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlID8geGEgOiBpZTsKICAgICAgICB5ID0gbmV3IG0oZywgZi5pdGVtU2l6ZSwgZi5ub3JtYWxpemVkKTsKICAgICAgfQogICAgICBmLm5hbWUgIT09IHZvaWQgMCAmJiAoeS5uYW1lID0gZi5uYW1lKSwgZi51c2FnZSAhPT0gdm9pZCAwICYmIHkuc2V0VXNhZ2UoZi51c2FnZSksIHIuc2V0QXR0cmlidXRlKHAsIHkpOwogICAgfQogICAgY29uc3QgaCA9IHQuZGF0YS5tb3JwaEF0dHJpYnV0ZXM7CiAgICBpZiAoaCkKICAgICAgZm9yIChjb25zdCBwIGluIGgpIHsKICAgICAgICBjb25zdCBmID0gaFtwXSwgeSA9IFtdOwogICAgICAgIGZvciAobGV0IGcgPSAwLCBtID0gZi5sZW5ndGg7IGcgPCBtOyBnKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSBmW2ddOwogICAgICAgICAgbGV0IHg7CiAgICAgICAgICBpZiAodi5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlKSB7CiAgICAgICAgICAgIGNvbnN0IF8gPSBuKHQuZGF0YSwgdi5kYXRhKTsKICAgICAgICAgICAgeCA9IG5ldyB1bihfLCB2Lml0ZW1TaXplLCB2Lm9mZnNldCwgdi5ub3JtYWxpemVkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IF8gPSByYSh2LnR5cGUsIHYuYXJyYXkpOwogICAgICAgICAgICB4ID0gbmV3IGllKF8sIHYuaXRlbVNpemUsIHYubm9ybWFsaXplZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2Lm5hbWUgIT09IHZvaWQgMCAmJiAoeC5uYW1lID0gdi5uYW1lKSwgeS5wdXNoKHgpOwogICAgICAgIH0KICAgICAgICByLm1vcnBoQXR0cmlidXRlc1twXSA9IHk7CiAgICAgIH0KICAgIHQuZGF0YS5tb3JwaFRhcmdldHNSZWxhdGl2ZSAmJiAoci5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9ICEwKTsKICAgIGNvbnN0IHUgPSB0LmRhdGEuZ3JvdXBzIHx8IHQuZGF0YS5kcmF3Y2FsbHMgfHwgdC5kYXRhLm9mZnNldHM7CiAgICBpZiAodSAhPT0gdm9pZCAwKQogICAgICBmb3IgKGxldCBwID0gMCwgZiA9IHUubGVuZ3RoOyBwICE9PSBmOyArK3ApIHsKICAgICAgICBjb25zdCB5ID0gdVtwXTsKICAgICAgICByLmFkZEdyb3VwKHkuc3RhcnQsIHkuY291bnQsIHkubWF0ZXJpYWxJbmRleCk7CiAgICAgIH0KICAgIGNvbnN0IGQgPSB0LmRhdGEuYm91bmRpbmdTcGhlcmU7CiAgICByZXR1cm4gZCAhPT0gdm9pZCAwICYmIChyLmJvdW5kaW5nU3BoZXJlID0gbmV3IFJlKCkuZnJvbUpTT04oZCkpLCB0Lm5hbWUgJiYgKHIubmFtZSA9IHQubmFtZSksIHQudXNlckRhdGEgJiYgKHIudXNlckRhdGEgPSB0LnVzZXJEYXRhKSwgcjsKICB9Cn0KY2xhc3MgWGIgZXh0ZW5kcyBUaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBvYmplY3QgbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzIHRoZSBsb2FkZWQgM0Qgb2JqZWN0IHRvIHRoZSBgb25Mb2FkKClgIGNhbGxiYWNrLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuIFRoaXMgY2FuIGFsc28gYmUgYSBkYXRhIFVSSS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKE9iamVjdDNEKX0gb25Mb2FkIC0gRXhlY3V0ZWQgd2hlbiB0aGUgbG9hZGluZyBwcm9jZXNzIGhhcyBiZWVuIGZpbmlzaGVkLgogICAqIEBwYXJhbSB7b25Qcm9ncmVzc0NhbGxiYWNrfSBvblByb2dyZXNzIC0gRXhlY3V0ZWQgd2hpbGUgdGhlIGxvYWRpbmcgaXMgaW4gcHJvZ3Jlc3MuCiAgICogQHBhcmFtIHtvbkVycm9yQ2FsbGJhY2t9IG9uRXJyb3IgLSBFeGVjdXRlZCB3aGVuIGVycm9ycyBvY2N1ci4KICAgKi8KICBsb2FkKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSB0aGlzLCByID0gdGhpcy5wYXRoID09PSAiIiA/IHJwLmV4dHJhY3RVcmxCYXNlKHQpIDogdGhpcy5wYXRoOwogICAgdGhpcy5yZXNvdXJjZVBhdGggPSB0aGlzLnJlc291cmNlUGF0aCB8fCByOwogICAgY29uc3QgbyA9IG5ldyBzcyh0aGlzLm1hbmFnZXIpOwogICAgby5zZXRQYXRoKHRoaXMucGF0aCksIG8uc2V0UmVxdWVzdEhlYWRlcih0aGlzLnJlcXVlc3RIZWFkZXIpLCBvLnNldFdpdGhDcmVkZW50aWFscyh0aGlzLndpdGhDcmVkZW50aWFscyksIG8ubG9hZCh0LCBmdW5jdGlvbihsKSB7CiAgICAgIGxldCBoID0gbnVsbDsKICAgICAgdHJ5IHsKICAgICAgICBoID0gSlNPTi5wYXJzZShsKTsKICAgICAgfSBjYXRjaCAodSkgewogICAgICAgIG4gIT09IHZvaWQgMCAmJiBuKHUpLCBjb25zb2xlLmVycm9yKCJUSFJFRTpPYmplY3RMb2FkZXI6IENhbid0IHBhcnNlICIgKyB0ICsgIi4iLCB1Lm1lc3NhZ2UpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBjID0gaC5tZXRhZGF0YTsKICAgICAgaWYgKGMgPT09IHZvaWQgMCB8fCBjLnR5cGUgPT09IHZvaWQgMCB8fCBjLnR5cGUudG9Mb3dlckNhc2UoKSA9PT0gImdlb21ldHJ5IikgewogICAgICAgIG4gIT09IHZvaWQgMCAmJiBuKG5ldyBFcnJvcigiVEhSRUUuT2JqZWN0TG9hZGVyOiBDYW4ndCBsb2FkICIgKyB0KSksIGNvbnNvbGUuZXJyb3IoIlRIUkVFLk9iamVjdExvYWRlcjogQ2FuJ3QgbG9hZCAiICsgdCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHMucGFyc2UoaCwgZSk7CiAgICB9LCBpLCBuKTsKICB9CiAgLyoqCiAgICogQXN5bmMgdmVyc2lvbiBvZiB7QGxpbmsgT2JqZWN0TG9hZGVyI2xvYWR9LgogICAqCiAgICogQGFzeW5jCiAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBwYXRoL1VSTCBvZiB0aGUgZmlsZSB0byBiZSBsb2FkZWQuIFRoaXMgY2FuIGFsc28gYmUgYSBkYXRhIFVSSS4KICAgKiBAcGFyYW0ge29uUHJvZ3Jlc3NDYWxsYmFja30gb25Qcm9ncmVzcyAtIEV4ZWN1dGVkIHdoaWxlIHRoZSBsb2FkaW5nIGlzIGluIHByb2dyZXNzLgogICAqIEByZXR1cm4ge1Byb21pc2U8T2JqZWN0M0Q+fSBBIFByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBsb2FkZWQgM0Qgb2JqZWN0LgogICAqLwogIGFzeW5jIGxvYWRBc3luYyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcywgbiA9IHRoaXMucGF0aCA9PT0gIiIgPyBycC5leHRyYWN0VXJsQmFzZSh0KSA6IHRoaXMucGF0aDsKICAgIHRoaXMucmVzb3VyY2VQYXRoID0gdGhpcy5yZXNvdXJjZVBhdGggfHwgbjsKICAgIGNvbnN0IHMgPSBuZXcgc3ModGhpcy5tYW5hZ2VyKTsKICAgIHMuc2V0UGF0aCh0aGlzLnBhdGgpLCBzLnNldFJlcXVlc3RIZWFkZXIodGhpcy5yZXF1ZXN0SGVhZGVyKSwgcy5zZXRXaXRoQ3JlZGVudGlhbHModGhpcy53aXRoQ3JlZGVudGlhbHMpOwogICAgY29uc3QgciA9IGF3YWl0IHMubG9hZEFzeW5jKHQsIGUpLCBvID0gSlNPTi5wYXJzZShyKSwgbCA9IG8ubWV0YWRhdGE7CiAgICBpZiAobCA9PT0gdm9pZCAwIHx8IGwudHlwZSA9PT0gdm9pZCAwIHx8IGwudHlwZS50b0xvd2VyQ2FzZSgpID09PSAiZ2VvbWV0cnkiKQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLk9iamVjdExvYWRlcjogQ2FuJ3QgbG9hZCAiICsgdCk7CiAgICByZXR1cm4gYXdhaXQgaS5wYXJzZUFzeW5jKG8pOwogIH0KICAvKioKICAgKiBQYXJzZXMgdGhlIGdpdmVuIEpTT04uIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5IHtAbGluayBPYmplY3RMb2FkZXIjbG9hZH0KICAgKiBidXQgY2FuIGFsc28gYmUgdXNlZCBkaXJlY3RseSB0byBwYXJzZSBhIHByZXZpb3VzbHkgbG9hZGVkIEpTT04gc3RydWN0dXJlLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgc2VyaWFsaXplZCAzRCBvYmplY3QuCiAgICogQHBhcmFtIHtvbkxvYWR9IG9uTG9hZCAtIEV4ZWN1dGVkIHdoZW4gYWxsIHJlc291cmNlcyAoZS5nLiB0ZXh0dXJlcykgaGF2ZSBiZWVuIGZ1bGx5IGxvYWRlZC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gVGhlIHBhcnNlZCAzRCBvYmplY3QuCiAgICovCiAgcGFyc2UodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMucGFyc2VBbmltYXRpb25zKHQuYW5pbWF0aW9ucyksIG4gPSB0aGlzLnBhcnNlU2hhcGVzKHQuc2hhcGVzKSwgcyA9IHRoaXMucGFyc2VHZW9tZXRyaWVzKHQuZ2VvbWV0cmllcywgbiksIHIgPSB0aGlzLnBhcnNlSW1hZ2VzKHQuaW1hZ2VzLCBmdW5jdGlvbigpIHsKICAgICAgZSAhPT0gdm9pZCAwICYmIGUoaCk7CiAgICB9KSwgbyA9IHRoaXMucGFyc2VUZXh0dXJlcyh0LnRleHR1cmVzLCByKSwgbCA9IHRoaXMucGFyc2VNYXRlcmlhbHModC5tYXRlcmlhbHMsIG8pLCBoID0gdGhpcy5wYXJzZU9iamVjdCh0Lm9iamVjdCwgcywgbCwgbywgaSksIGMgPSB0aGlzLnBhcnNlU2tlbGV0b25zKHQuc2tlbGV0b25zLCBoKTsKICAgIGlmICh0aGlzLmJpbmRTa2VsZXRvbnMoaCwgYyksIHRoaXMuYmluZExpZ2h0VGFyZ2V0cyhoKSwgZSAhPT0gdm9pZCAwKSB7CiAgICAgIGxldCB1ID0gITE7CiAgICAgIGZvciAoY29uc3QgZCBpbiByKQogICAgICAgIGlmIChyW2RdLmRhdGEgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50KSB7CiAgICAgICAgICB1ID0gITA7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIHUgPT09ICExICYmIGUoaCk7CiAgICB9CiAgICByZXR1cm4gaDsKICB9CiAgLyoqCiAgICogQXN5bmMgdmVyc2lvbiBvZiB7QGxpbmsgT2JqZWN0TG9hZGVyI3BhcnNlfS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIHNlcmlhbGl6ZWQgM0Qgb2JqZWN0LgogICAqIEByZXR1cm4ge1Byb21pc2U8T2JqZWN0M0Q+fSBBIFByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBwYXJzZWQgM0Qgb2JqZWN0LgogICAqLwogIGFzeW5jIHBhcnNlQXN5bmModCkgewogICAgY29uc3QgZSA9IHRoaXMucGFyc2VBbmltYXRpb25zKHQuYW5pbWF0aW9ucyksIGkgPSB0aGlzLnBhcnNlU2hhcGVzKHQuc2hhcGVzKSwgbiA9IHRoaXMucGFyc2VHZW9tZXRyaWVzKHQuZ2VvbWV0cmllcywgaSksIHMgPSBhd2FpdCB0aGlzLnBhcnNlSW1hZ2VzQXN5bmModC5pbWFnZXMpLCByID0gdGhpcy5wYXJzZVRleHR1cmVzKHQudGV4dHVyZXMsIHMpLCBvID0gdGhpcy5wYXJzZU1hdGVyaWFscyh0Lm1hdGVyaWFscywgciksIGwgPSB0aGlzLnBhcnNlT2JqZWN0KHQub2JqZWN0LCBuLCBvLCByLCBlKSwgaCA9IHRoaXMucGFyc2VTa2VsZXRvbnModC5za2VsZXRvbnMsIGwpOwogICAgcmV0dXJuIHRoaXMuYmluZFNrZWxldG9ucyhsLCBoKSwgdGhpcy5iaW5kTGlnaHRUYXJnZXRzKGwpLCBsOwogIH0KICAvLyBpbnRlcm5hbHMKICBwYXJzZVNoYXBlcyh0KSB7CiAgICBjb25zdCBlID0ge307CiAgICBpZiAodCAhPT0gdm9pZCAwKQogICAgICBmb3IgKGxldCBpID0gMCwgbiA9IHQubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgY29uc3QgcyA9IG5ldyBBcygpLmZyb21KU09OKHRbaV0pOwogICAgICAgIGVbcy51dWlkXSA9IHM7CiAgICAgIH0KICAgIHJldHVybiBlOwogIH0KICBwYXJzZVNrZWxldG9ucyh0LCBlKSB7CiAgICBjb25zdCBpID0ge30sIG4gPSB7fTsKICAgIGlmIChlLnRyYXZlcnNlKGZ1bmN0aW9uKHMpIHsKICAgICAgcy5pc0JvbmUgJiYgKG5bcy51dWlkXSA9IHMpOwogICAgfSksIHQgIT09IHZvaWQgMCkKICAgICAgZm9yIChsZXQgcyA9IDAsIHIgPSB0Lmxlbmd0aDsgcyA8IHI7IHMrKykgewogICAgICAgIGNvbnN0IG8gPSBuZXcgcWMoKS5mcm9tSlNPTih0W3NdLCBuKTsKICAgICAgICBpW28udXVpZF0gPSBvOwogICAgICB9CiAgICByZXR1cm4gaTsKICB9CiAgcGFyc2VHZW9tZXRyaWVzKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB7fTsKICAgIGlmICh0ICE9PSB2b2lkIDApIHsKICAgICAgY29uc3QgbiA9IG5ldyBkXygpOwogICAgICBmb3IgKGxldCBzID0gMCwgciA9IHQubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgICAgbGV0IG87CiAgICAgICAgY29uc3QgbCA9IHRbc107CiAgICAgICAgc3dpdGNoIChsLnR5cGUpIHsKICAgICAgICAgIGNhc2UgIkJ1ZmZlckdlb21ldHJ5IjoKICAgICAgICAgIGNhc2UgIkluc3RhbmNlZEJ1ZmZlckdlb21ldHJ5IjoKICAgICAgICAgICAgbyA9IG4ucGFyc2UobCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbC50eXBlIGluIF9tID8gbyA9IF9tW2wudHlwZV0uZnJvbUpTT04obCwgZSkgOiBjb25zb2xlLndhcm4oYFRIUkVFLk9iamVjdExvYWRlcjogVW5zdXBwb3J0ZWQgZ2VvbWV0cnkgdHlwZSAiJHtsLnR5cGV9ImApOwogICAgICAgIH0KICAgICAgICBvLnV1aWQgPSBsLnV1aWQsIGwubmFtZSAhPT0gdm9pZCAwICYmIChvLm5hbWUgPSBsLm5hbWUpLCBsLnVzZXJEYXRhICE9PSB2b2lkIDAgJiYgKG8udXNlckRhdGEgPSBsLnVzZXJEYXRhKSwgaVtsLnV1aWRdID0gbzsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7CiAgfQogIHBhcnNlTWF0ZXJpYWxzKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB7fSwgbiA9IHt9OwogICAgaWYgKHQgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBzID0gbmV3IGF1KCk7CiAgICAgIHMuc2V0VGV4dHVyZXMoZSk7CiAgICAgIGZvciAobGV0IHIgPSAwLCBvID0gdC5sZW5ndGg7IHIgPCBvOyByKyspIHsKICAgICAgICBjb25zdCBsID0gdFtyXTsKICAgICAgICBpW2wudXVpZF0gPT09IHZvaWQgMCAmJiAoaVtsLnV1aWRdID0gcy5wYXJzZShsKSksIG5bbC51dWlkXSA9IGlbbC51dWlkXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG47CiAgfQogIHBhcnNlQW5pbWF0aW9ucyh0KSB7CiAgICBjb25zdCBlID0ge307CiAgICBpZiAodCAhPT0gdm9pZCAwKQogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBuID0gdFtpXSwgcyA9IE1hLnBhcnNlKG4pOwogICAgICAgIGVbcy51dWlkXSA9IHM7CiAgICAgIH0KICAgIHJldHVybiBlOwogIH0KICBwYXJzZUltYWdlcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcywgbiA9IHt9OwogICAgbGV0IHM7CiAgICBmdW5jdGlvbiByKGwpIHsKICAgICAgcmV0dXJuIGkubWFuYWdlci5pdGVtU3RhcnQobCksIHMubG9hZChsLCBmdW5jdGlvbigpIHsKICAgICAgICBpLm1hbmFnZXIuaXRlbUVuZChsKTsKICAgICAgfSwgdm9pZCAwLCBmdW5jdGlvbigpIHsKICAgICAgICBpLm1hbmFnZXIuaXRlbUVycm9yKGwpLCBpLm1hbmFnZXIuaXRlbUVuZChsKTsKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiBvKGwpIHsKICAgICAgaWYgKHR5cGVvZiBsID09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc3QgaCA9IGwsIGMgPSAvXihcL1wvKXwoW2Etel0rOihcL1wvKT8pL2kudGVzdChoKSA/IGggOiBpLnJlc291cmNlUGF0aCArIGg7CiAgICAgICAgcmV0dXJuIHIoYyk7CiAgICAgIH0gZWxzZQogICAgICAgIHJldHVybiBsLmRhdGEgPyB7CiAgICAgICAgICBkYXRhOiByYShsLnR5cGUsIGwuZGF0YSksCiAgICAgICAgICB3aWR0aDogbC53aWR0aCwKICAgICAgICAgIGhlaWdodDogbC5oZWlnaHQKICAgICAgICB9IDogbnVsbDsKICAgIH0KICAgIGlmICh0ICE9PSB2b2lkIDAgJiYgdC5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGwgPSBuZXcgbmYoZSk7CiAgICAgIHMgPSBuZXcgVW8obCksIHMuc2V0Q3Jvc3NPcmlnaW4odGhpcy5jcm9zc09yaWdpbik7CiAgICAgIGZvciAobGV0IGggPSAwLCBjID0gdC5sZW5ndGg7IGggPCBjOyBoKyspIHsKICAgICAgICBjb25zdCB1ID0gdFtoXSwgZCA9IHUudXJsOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGQpKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBmb3IgKGxldCBmID0gMCwgeSA9IGQubGVuZ3RoOyBmIDwgeTsgZisrKSB7CiAgICAgICAgICAgIGNvbnN0IGcgPSBkW2ZdLCBtID0gbyhnKTsKICAgICAgICAgICAgbSAhPT0gbnVsbCAmJiAobSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQgPyBwLnB1c2gobSkgOiBwLnB1c2gobmV3IENuKG0uZGF0YSwgbS53aWR0aCwgbS5oZWlnaHQpKSk7CiAgICAgICAgICB9CiAgICAgICAgICBuW3UudXVpZF0gPSBuZXcgTXMocCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHAgPSBvKHUudXJsKTsKICAgICAgICAgIG5bdS51dWlkXSA9IG5ldyBNcyhwKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuOwogIH0KICBhc3luYyBwYXJzZUltYWdlc0FzeW5jKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLCBpID0ge307CiAgICBsZXQgbjsKICAgIGFzeW5jIGZ1bmN0aW9uIHMocikgewogICAgICBpZiAodHlwZW9mIHIgPT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBvID0gciwgbCA9IC9eKFwvXC8pfChbYS16XSs6KFwvXC8pPykvaS50ZXN0KG8pID8gbyA6IGUucmVzb3VyY2VQYXRoICsgbzsKICAgICAgICByZXR1cm4gYXdhaXQgbi5sb2FkQXN5bmMobCk7CiAgICAgIH0gZWxzZQogICAgICAgIHJldHVybiByLmRhdGEgPyB7CiAgICAgICAgICBkYXRhOiByYShyLnR5cGUsIHIuZGF0YSksCiAgICAgICAgICB3aWR0aDogci53aWR0aCwKICAgICAgICAgIGhlaWdodDogci5oZWlnaHQKICAgICAgICB9IDogbnVsbDsKICAgIH0KICAgIGlmICh0ICE9PSB2b2lkIDAgJiYgdC5sZW5ndGggPiAwKSB7CiAgICAgIG4gPSBuZXcgVW8odGhpcy5tYW5hZ2VyKSwgbi5zZXRDcm9zc09yaWdpbih0aGlzLmNyb3NzT3JpZ2luKTsKICAgICAgZm9yIChsZXQgciA9IDAsIG8gPSB0Lmxlbmd0aDsgciA8IG87IHIrKykgewogICAgICAgIGNvbnN0IGwgPSB0W3JdLCBoID0gbC51cmw7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaCkpIHsKICAgICAgICAgIGNvbnN0IGMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IHUgPSAwLCBkID0gaC5sZW5ndGg7IHUgPCBkOyB1KyspIHsKICAgICAgICAgICAgY29uc3QgcCA9IGhbdV0sIGYgPSBhd2FpdCBzKHApOwogICAgICAgICAgICBmICE9PSBudWxsICYmIChmIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCA/IGMucHVzaChmKSA6IGMucHVzaChuZXcgQ24oZi5kYXRhLCBmLndpZHRoLCBmLmhlaWdodCkpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlbbC51dWlkXSA9IG5ldyBNcyhjKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgYyA9IGF3YWl0IHMobC51cmwpOwogICAgICAgICAgaVtsLnV1aWRdID0gbmV3IE1zKGMpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7CiAgfQogIHBhcnNlVGV4dHVyZXModCwgZSkgewogICAgZnVuY3Rpb24gaShzLCByKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcyA9PSAibnVtYmVyIiA/IHMgOiAoY29uc29sZS53YXJuKCJUSFJFRS5PYmplY3RMb2FkZXIucGFyc2VUZXh0dXJlOiBDb25zdGFudCBzaG91bGQgYmUgaW4gbnVtZXJpYyBmb3JtLiIsIHMpLCByW3NdKTsKICAgIH0KICAgIGNvbnN0IG4gPSB7fTsKICAgIGlmICh0ICE9PSB2b2lkIDApCiAgICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5sZW5ndGg7IHMgPCByOyBzKyspIHsKICAgICAgICBjb25zdCBvID0gdFtzXTsKICAgICAgICBvLmltYWdlID09PSB2b2lkIDAgJiYgY29uc29sZS53YXJuKCdUSFJFRS5PYmplY3RMb2FkZXI6IE5vICJpbWFnZSIgc3BlY2lmaWVkIGZvcicsIG8udXVpZCksIGVbby5pbWFnZV0gPT09IHZvaWQgMCAmJiBjb25zb2xlLndhcm4oIlRIUkVFLk9iamVjdExvYWRlcjogVW5kZWZpbmVkIGltYWdlIiwgby5pbWFnZSk7CiAgICAgICAgY29uc3QgbCA9IGVbby5pbWFnZV0sIGggPSBsLmRhdGE7CiAgICAgICAgbGV0IGM7CiAgICAgICAgQXJyYXkuaXNBcnJheShoKSA/IChjID0gbmV3IE9vKCksIGgubGVuZ3RoID09PSA2ICYmIChjLm5lZWRzVXBkYXRlID0gITApKSA6IChoICYmIGguZGF0YSA/IGMgPSBuZXcgQ24oKSA6IGMgPSBuZXcgTmUoKSwgaCAmJiAoYy5uZWVkc1VwZGF0ZSA9ICEwKSksIGMuc291cmNlID0gbCwgYy51dWlkID0gby51dWlkLCBvLm5hbWUgIT09IHZvaWQgMCAmJiAoYy5uYW1lID0gby5uYW1lKSwgby5tYXBwaW5nICE9PSB2b2lkIDAgJiYgKGMubWFwcGluZyA9IGkoby5tYXBwaW5nLCBZYikpLCBvLmNoYW5uZWwgIT09IHZvaWQgMCAmJiAoYy5jaGFubmVsID0gby5jaGFubmVsKSwgby5vZmZzZXQgIT09IHZvaWQgMCAmJiBjLm9mZnNldC5mcm9tQXJyYXkoby5vZmZzZXQpLCBvLnJlcGVhdCAhPT0gdm9pZCAwICYmIGMucmVwZWF0LmZyb21BcnJheShvLnJlcGVhdCksIG8uY2VudGVyICE9PSB2b2lkIDAgJiYgYy5jZW50ZXIuZnJvbUFycmF5KG8uY2VudGVyKSwgby5yb3RhdGlvbiAhPT0gdm9pZCAwICYmIChjLnJvdGF0aW9uID0gby5yb3RhdGlvbiksIG8ud3JhcCAhPT0gdm9pZCAwICYmIChjLndyYXBTID0gaShvLndyYXBbMF0sIE1tKSwgYy53cmFwVCA9IGkoby53cmFwWzFdLCBNbSkpLCBvLmZvcm1hdCAhPT0gdm9pZCAwICYmIChjLmZvcm1hdCA9IG8uZm9ybWF0KSwgby5pbnRlcm5hbEZvcm1hdCAhPT0gdm9pZCAwICYmIChjLmludGVybmFsRm9ybWF0ID0gby5pbnRlcm5hbEZvcm1hdCksIG8udHlwZSAhPT0gdm9pZCAwICYmIChjLnR5cGUgPSBvLnR5cGUpLCBvLmNvbG9yU3BhY2UgIT09IHZvaWQgMCAmJiAoYy5jb2xvclNwYWNlID0gby5jb2xvclNwYWNlKSwgby5taW5GaWx0ZXIgIT09IHZvaWQgMCAmJiAoYy5taW5GaWx0ZXIgPSBpKG8ubWluRmlsdGVyLCBTbSkpLCBvLm1hZ0ZpbHRlciAhPT0gdm9pZCAwICYmIChjLm1hZ0ZpbHRlciA9IGkoby5tYWdGaWx0ZXIsIFNtKSksIG8uYW5pc290cm9weSAhPT0gdm9pZCAwICYmIChjLmFuaXNvdHJvcHkgPSBvLmFuaXNvdHJvcHkpLCBvLmZsaXBZICE9PSB2b2lkIDAgJiYgKGMuZmxpcFkgPSBvLmZsaXBZKSwgby5nZW5lcmF0ZU1pcG1hcHMgIT09IHZvaWQgMCAmJiAoYy5nZW5lcmF0ZU1pcG1hcHMgPSBvLmdlbmVyYXRlTWlwbWFwcyksIG8ucHJlbXVsdGlwbHlBbHBoYSAhPT0gdm9pZCAwICYmIChjLnByZW11bHRpcGx5QWxwaGEgPSBvLnByZW11bHRpcGx5QWxwaGEpLCBvLnVucGFja0FsaWdubWVudCAhPT0gdm9pZCAwICYmIChjLnVucGFja0FsaWdubWVudCA9IG8udW5wYWNrQWxpZ25tZW50KSwgby5jb21wYXJlRnVuY3Rpb24gIT09IHZvaWQgMCAmJiAoYy5jb21wYXJlRnVuY3Rpb24gPSBvLmNvbXBhcmVGdW5jdGlvbiksIG8udXNlckRhdGEgIT09IHZvaWQgMCAmJiAoYy51c2VyRGF0YSA9IG8udXNlckRhdGEpLCBuW28udXVpZF0gPSBjOwogICAgICB9CiAgICByZXR1cm4gbjsKICB9CiAgcGFyc2VPYmplY3QodCwgZSwgaSwgbiwgcykgewogICAgbGV0IHI7CiAgICBmdW5jdGlvbiBvKGQpIHsKICAgICAgcmV0dXJuIGVbZF0gPT09IHZvaWQgMCAmJiBjb25zb2xlLndhcm4oIlRIUkVFLk9iamVjdExvYWRlcjogVW5kZWZpbmVkIGdlb21ldHJ5IiwgZCksIGVbZF07CiAgICB9CiAgICBmdW5jdGlvbiBsKGQpIHsKICAgICAgaWYgKGQgIT09IHZvaWQgMCkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGQpKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBmb3IgKGxldCBmID0gMCwgeSA9IGQubGVuZ3RoOyBmIDwgeTsgZisrKSB7CiAgICAgICAgICAgIGNvbnN0IGcgPSBkW2ZdOwogICAgICAgICAgICBpW2ddID09PSB2b2lkIDAgJiYgY29uc29sZS53YXJuKCJUSFJFRS5PYmplY3RMb2FkZXI6IFVuZGVmaW5lZCBtYXRlcmlhbCIsIGcpLCBwLnB1c2goaVtnXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlbZF0gPT09IHZvaWQgMCAmJiBjb25zb2xlLndhcm4oIlRIUkVFLk9iamVjdExvYWRlcjogVW5kZWZpbmVkIG1hdGVyaWFsIiwgZCksIGlbZF07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGgoZCkgewogICAgICByZXR1cm4gbltkXSA9PT0gdm9pZCAwICYmIGNvbnNvbGUud2FybigiVEhSRUUuT2JqZWN0TG9hZGVyOiBVbmRlZmluZWQgdGV4dHVyZSIsIGQpLCBuW2RdOwogICAgfQogICAgbGV0IGMsIHU7CiAgICBzd2l0Y2ggKHQudHlwZSkgewogICAgICBjYXNlICJTY2VuZSI6CiAgICAgICAgciA9IG5ldyBrbygpLCB0LmJhY2tncm91bmQgIT09IHZvaWQgMCAmJiAoTnVtYmVyLmlzSW50ZWdlcih0LmJhY2tncm91bmQpID8gci5iYWNrZ3JvdW5kID0gbmV3IGN0KHQuYmFja2dyb3VuZCkgOiByLmJhY2tncm91bmQgPSBoKHQuYmFja2dyb3VuZCkpLCB0LmVudmlyb25tZW50ICE9PSB2b2lkIDAgJiYgKHIuZW52aXJvbm1lbnQgPSBoKHQuZW52aXJvbm1lbnQpKSwgdC5mb2cgIT09IHZvaWQgMCAmJiAodC5mb2cudHlwZSA9PT0gIkZvZyIgPyByLmZvZyA9IG5ldyBIYyh0LmZvZy5jb2xvciwgdC5mb2cubmVhciwgdC5mb2cuZmFyKSA6IHQuZm9nLnR5cGUgPT09ICJGb2dFeHAyIiAmJiAoci5mb2cgPSBuZXcgVmModC5mb2cuY29sb3IsIHQuZm9nLmRlbnNpdHkpKSwgdC5mb2cubmFtZSAhPT0gIiIgJiYgKHIuZm9nLm5hbWUgPSB0LmZvZy5uYW1lKSksIHQuYmFja2dyb3VuZEJsdXJyaW5lc3MgIT09IHZvaWQgMCAmJiAoci5iYWNrZ3JvdW5kQmx1cnJpbmVzcyA9IHQuYmFja2dyb3VuZEJsdXJyaW5lc3MpLCB0LmJhY2tncm91bmRJbnRlbnNpdHkgIT09IHZvaWQgMCAmJiAoci5iYWNrZ3JvdW5kSW50ZW5zaXR5ID0gdC5iYWNrZ3JvdW5kSW50ZW5zaXR5KSwgdC5iYWNrZ3JvdW5kUm90YXRpb24gIT09IHZvaWQgMCAmJiByLmJhY2tncm91bmRSb3RhdGlvbi5mcm9tQXJyYXkodC5iYWNrZ3JvdW5kUm90YXRpb24pLCB0LmVudmlyb25tZW50SW50ZW5zaXR5ICE9PSB2b2lkIDAgJiYgKHIuZW52aXJvbm1lbnRJbnRlbnNpdHkgPSB0LmVudmlyb25tZW50SW50ZW5zaXR5KSwgdC5lbnZpcm9ubWVudFJvdGF0aW9uICE9PSB2b2lkIDAgJiYgci5lbnZpcm9ubWVudFJvdGF0aW9uLmZyb21BcnJheSh0LmVudmlyb25tZW50Um90YXRpb24pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJQZXJzcGVjdGl2ZUNhbWVyYSI6CiAgICAgICAgciA9IG5ldyBWZSh0LmZvdiwgdC5hc3BlY3QsIHQubmVhciwgdC5mYXIpLCB0LmZvY3VzICE9PSB2b2lkIDAgJiYgKHIuZm9jdXMgPSB0LmZvY3VzKSwgdC56b29tICE9PSB2b2lkIDAgJiYgKHIuem9vbSA9IHQuem9vbSksIHQuZmlsbUdhdWdlICE9PSB2b2lkIDAgJiYgKHIuZmlsbUdhdWdlID0gdC5maWxtR2F1Z2UpLCB0LmZpbG1PZmZzZXQgIT09IHZvaWQgMCAmJiAoci5maWxtT2Zmc2V0ID0gdC5maWxtT2Zmc2V0KSwgdC52aWV3ICE9PSB2b2lkIDAgJiYgKHIudmlldyA9IE9iamVjdC5hc3NpZ24oe30sIHQudmlldykpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJPcnRob2dyYXBoaWNDYW1lcmEiOgogICAgICAgIHIgPSBuZXcgSWEodC5sZWZ0LCB0LnJpZ2h0LCB0LnRvcCwgdC5ib3R0b20sIHQubmVhciwgdC5mYXIpLCB0Lnpvb20gIT09IHZvaWQgMCAmJiAoci56b29tID0gdC56b29tKSwgdC52aWV3ICE9PSB2b2lkIDAgJiYgKHIudmlldyA9IE9iamVjdC5hc3NpZ24oe30sIHQudmlldykpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJBbWJpZW50TGlnaHQiOgogICAgICAgIHIgPSBuZXcgYWYodC5jb2xvciwgdC5pbnRlbnNpdHkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJEaXJlY3Rpb25hbExpZ2h0IjoKICAgICAgICByID0gbmV3IHJmKHQuY29sb3IsIHQuaW50ZW5zaXR5KSwgci50YXJnZXQgPSB0LnRhcmdldCB8fCAiIjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiUG9pbnRMaWdodCI6CiAgICAgICAgciA9IG5ldyBsXyh0LmNvbG9yLCB0LmludGVuc2l0eSwgdC5kaXN0YW5jZSwgdC5kZWNheSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlJlY3RBcmVhTGlnaHQiOgogICAgICAgIHIgPSBuZXcgaF8odC5jb2xvciwgdC5pbnRlbnNpdHksIHQud2lkdGgsIHQuaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiU3BvdExpZ2h0IjoKICAgICAgICByID0gbmV3IG9fKHQuY29sb3IsIHQuaW50ZW5zaXR5LCB0LmRpc3RhbmNlLCB0LmFuZ2xlLCB0LnBlbnVtYnJhLCB0LmRlY2F5KSwgci50YXJnZXQgPSB0LnRhcmdldCB8fCAiIjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiSGVtaXNwaGVyZUxpZ2h0IjoKICAgICAgICByID0gbmV3IGFfKHQuY29sb3IsIHQuZ3JvdW5kQ29sb3IsIHQuaW50ZW5zaXR5KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiTGlnaHRQcm9iZSI6CiAgICAgICAgciA9IG5ldyB1XygpLmZyb21KU09OKHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJTa2lubmVkTWVzaCI6CiAgICAgICAgYyA9IG8odC5nZW9tZXRyeSksIHUgPSBsKHQubWF0ZXJpYWwpLCByID0gbmV3IFB5KGMsIHUpLCB0LmJpbmRNb2RlICE9PSB2b2lkIDAgJiYgKHIuYmluZE1vZGUgPSB0LmJpbmRNb2RlKSwgdC5iaW5kTWF0cml4ICE9PSB2b2lkIDAgJiYgci5iaW5kTWF0cml4LmZyb21BcnJheSh0LmJpbmRNYXRyaXgpLCB0LnNrZWxldG9uICE9PSB2b2lkIDAgJiYgKHIuc2tlbGV0b24gPSB0LnNrZWxldG9uKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiTWVzaCI6CiAgICAgICAgYyA9IG8odC5nZW9tZXRyeSksIHUgPSBsKHQubWF0ZXJpYWwpLCByID0gbmV3IHJlKGMsIHUpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJJbnN0YW5jZWRNZXNoIjoKICAgICAgICBjID0gbyh0Lmdlb21ldHJ5KSwgdSA9IGwodC5tYXRlcmlhbCk7CiAgICAgICAgY29uc3QgZCA9IHQuY291bnQsIHAgPSB0Lmluc3RhbmNlTWF0cml4LCBmID0gdC5pbnN0YW5jZUNvbG9yOwogICAgICAgIHIgPSBuZXcgSXkoYywgdSwgZCksIHIuaW5zdGFuY2VNYXRyaXggPSBuZXcgeGEobmV3IEZsb2F0MzJBcnJheShwLmFycmF5KSwgMTYpLCBmICE9PSB2b2lkIDAgJiYgKHIuaW5zdGFuY2VDb2xvciA9IG5ldyB4YShuZXcgRmxvYXQzMkFycmF5KGYuYXJyYXkpLCBmLml0ZW1TaXplKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkJhdGNoZWRNZXNoIjoKICAgICAgICBjID0gbyh0Lmdlb21ldHJ5KSwgdSA9IGwodC5tYXRlcmlhbCksIHIgPSBuZXcgTHkodC5tYXhJbnN0YW5jZUNvdW50LCB0Lm1heFZlcnRleENvdW50LCB0Lm1heEluZGV4Q291bnQsIHUpLCByLmdlb21ldHJ5ID0gYywgci5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkID0gdC5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkLCByLnNvcnRPYmplY3RzID0gdC5zb3J0T2JqZWN0cywgci5fZHJhd1JhbmdlcyA9IHQuZHJhd1Jhbmdlcywgci5fcmVzZXJ2ZWRSYW5nZXMgPSB0LnJlc2VydmVkUmFuZ2VzLCByLl9nZW9tZXRyeUluZm8gPSB0Lmdlb21ldHJ5SW5mby5tYXAoKHkpID0+IHsKICAgICAgICAgIGxldCBnID0gbnVsbCwgbSA9IG51bGw7CiAgICAgICAgICByZXR1cm4geS5ib3VuZGluZ0JveCAhPT0gdm9pZCAwICYmIChnID0gbmV3IHdlKCkuZnJvbUpTT04oeS5ib3VuZGluZ0JveCkpLCB5LmJvdW5kaW5nU3BoZXJlICE9PSB2b2lkIDAgJiYgKG0gPSBuZXcgUmUoKS5mcm9tSlNPTih5LmJvdW5kaW5nU3BoZXJlKSksIHsKICAgICAgICAgICAgLi4ueSwKICAgICAgICAgICAgYm91bmRpbmdCb3g6IGcsCiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBtCiAgICAgICAgICB9OwogICAgICAgIH0pLCByLl9pbnN0YW5jZUluZm8gPSB0Lmluc3RhbmNlSW5mbywgci5fYXZhaWxhYmxlSW5zdGFuY2VJZHMgPSB0Ll9hdmFpbGFibGVJbnN0YW5jZUlkcywgci5fYXZhaWxhYmxlR2VvbWV0cnlJZHMgPSB0Ll9hdmFpbGFibGVHZW9tZXRyeUlkcywgci5fbmV4dEluZGV4U3RhcnQgPSB0Lm5leHRJbmRleFN0YXJ0LCByLl9uZXh0VmVydGV4U3RhcnQgPSB0Lm5leHRWZXJ0ZXhTdGFydCwgci5fZ2VvbWV0cnlDb3VudCA9IHQuZ2VvbWV0cnlDb3VudCwgci5fbWF4SW5zdGFuY2VDb3VudCA9IHQubWF4SW5zdGFuY2VDb3VudCwgci5fbWF4VmVydGV4Q291bnQgPSB0Lm1heFZlcnRleENvdW50LCByLl9tYXhJbmRleENvdW50ID0gdC5tYXhJbmRleENvdW50LCByLl9nZW9tZXRyeUluaXRpYWxpemVkID0gdC5nZW9tZXRyeUluaXRpYWxpemVkLCByLl9tYXRyaWNlc1RleHR1cmUgPSBoKHQubWF0cmljZXNUZXh0dXJlLnV1aWQpLCByLl9pbmRpcmVjdFRleHR1cmUgPSBoKHQuaW5kaXJlY3RUZXh0dXJlLnV1aWQpLCB0LmNvbG9yc1RleHR1cmUgIT09IHZvaWQgMCAmJiAoci5fY29sb3JzVGV4dHVyZSA9IGgodC5jb2xvcnNUZXh0dXJlLnV1aWQpKSwgdC5ib3VuZGluZ1NwaGVyZSAhPT0gdm9pZCAwICYmIChyLmJvdW5kaW5nU3BoZXJlID0gbmV3IFJlKCkuZnJvbUpTT04odC5ib3VuZGluZ1NwaGVyZSkpLCB0LmJvdW5kaW5nQm94ICE9PSB2b2lkIDAgJiYgKHIuYm91bmRpbmdCb3ggPSBuZXcgd2UoKS5mcm9tSlNPTih0LmJvdW5kaW5nQm94KSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkxPRCI6CiAgICAgICAgciA9IG5ldyBSeSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJMaW5lIjoKICAgICAgICByID0gbmV3IFJzKG8odC5nZW9tZXRyeSksIGwodC5tYXRlcmlhbCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJMaW5lTG9vcCI6CiAgICAgICAgciA9IG5ldyBEeShvKHQuZ2VvbWV0cnkpLCBsKHQubWF0ZXJpYWwpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiTGluZVNlZ21lbnRzIjoKICAgICAgICByID0gbmV3IG9pKG8odC5nZW9tZXRyeSksIGwodC5tYXRlcmlhbCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJQb2ludENsb3VkIjoKICAgICAgY2FzZSAiUG9pbnRzIjoKICAgICAgICByID0gbmV3IGtwKG8odC5nZW9tZXRyeSksIGwodC5tYXRlcmlhbCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJTcHJpdGUiOgogICAgICAgIHIgPSBuZXcgbWMobCh0Lm1hdGVyaWFsKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkdyb3VwIjoKICAgICAgICByID0gbmV3IHlpKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIkJvbmUiOgogICAgICAgIHIgPSBuZXcgT3AoKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByID0gbmV3IGxlKCk7CiAgICB9CiAgICBpZiAoci51dWlkID0gdC51dWlkLCB0Lm5hbWUgIT09IHZvaWQgMCAmJiAoci5uYW1lID0gdC5uYW1lKSwgdC5tYXRyaXggIT09IHZvaWQgMCA/IChyLm1hdHJpeC5mcm9tQXJyYXkodC5tYXRyaXgpLCB0Lm1hdHJpeEF1dG9VcGRhdGUgIT09IHZvaWQgMCAmJiAoci5tYXRyaXhBdXRvVXBkYXRlID0gdC5tYXRyaXhBdXRvVXBkYXRlKSwgci5tYXRyaXhBdXRvVXBkYXRlICYmIHIubWF0cml4LmRlY29tcG9zZShyLnBvc2l0aW9uLCByLnF1YXRlcm5pb24sIHIuc2NhbGUpKSA6ICh0LnBvc2l0aW9uICE9PSB2b2lkIDAgJiYgci5wb3NpdGlvbi5mcm9tQXJyYXkodC5wb3NpdGlvbiksIHQucm90YXRpb24gIT09IHZvaWQgMCAmJiByLnJvdGF0aW9uLmZyb21BcnJheSh0LnJvdGF0aW9uKSwgdC5xdWF0ZXJuaW9uICE9PSB2b2lkIDAgJiYgci5xdWF0ZXJuaW9uLmZyb21BcnJheSh0LnF1YXRlcm5pb24pLCB0LnNjYWxlICE9PSB2b2lkIDAgJiYgci5zY2FsZS5mcm9tQXJyYXkodC5zY2FsZSkpLCB0LnVwICE9PSB2b2lkIDAgJiYgci51cC5mcm9tQXJyYXkodC51cCksIHQuY2FzdFNoYWRvdyAhPT0gdm9pZCAwICYmIChyLmNhc3RTaGFkb3cgPSB0LmNhc3RTaGFkb3cpLCB0LnJlY2VpdmVTaGFkb3cgIT09IHZvaWQgMCAmJiAoci5yZWNlaXZlU2hhZG93ID0gdC5yZWNlaXZlU2hhZG93KSwgdC5zaGFkb3cgJiYgKHQuc2hhZG93LmludGVuc2l0eSAhPT0gdm9pZCAwICYmIChyLnNoYWRvdy5pbnRlbnNpdHkgPSB0LnNoYWRvdy5pbnRlbnNpdHkpLCB0LnNoYWRvdy5iaWFzICE9PSB2b2lkIDAgJiYgKHIuc2hhZG93LmJpYXMgPSB0LnNoYWRvdy5iaWFzKSwgdC5zaGFkb3cubm9ybWFsQmlhcyAhPT0gdm9pZCAwICYmIChyLnNoYWRvdy5ub3JtYWxCaWFzID0gdC5zaGFkb3cubm9ybWFsQmlhcyksIHQuc2hhZG93LnJhZGl1cyAhPT0gdm9pZCAwICYmIChyLnNoYWRvdy5yYWRpdXMgPSB0LnNoYWRvdy5yYWRpdXMpLCB0LnNoYWRvdy5tYXBTaXplICE9PSB2b2lkIDAgJiYgci5zaGFkb3cubWFwU2l6ZS5mcm9tQXJyYXkodC5zaGFkb3cubWFwU2l6ZSksIHQuc2hhZG93LmNhbWVyYSAhPT0gdm9pZCAwICYmIChyLnNoYWRvdy5jYW1lcmEgPSB0aGlzLnBhcnNlT2JqZWN0KHQuc2hhZG93LmNhbWVyYSkpKSwgdC52aXNpYmxlICE9PSB2b2lkIDAgJiYgKHIudmlzaWJsZSA9IHQudmlzaWJsZSksIHQuZnJ1c3R1bUN1bGxlZCAhPT0gdm9pZCAwICYmIChyLmZydXN0dW1DdWxsZWQgPSB0LmZydXN0dW1DdWxsZWQpLCB0LnJlbmRlck9yZGVyICE9PSB2b2lkIDAgJiYgKHIucmVuZGVyT3JkZXIgPSB0LnJlbmRlck9yZGVyKSwgdC51c2VyRGF0YSAhPT0gdm9pZCAwICYmIChyLnVzZXJEYXRhID0gdC51c2VyRGF0YSksIHQubGF5ZXJzICE9PSB2b2lkIDAgJiYgKHIubGF5ZXJzLm1hc2sgPSB0LmxheWVycyksIHQuY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICBjb25zdCBkID0gdC5jaGlsZHJlbjsKICAgICAgZm9yIChsZXQgcCA9IDA7IHAgPCBkLmxlbmd0aDsgcCsrKQogICAgICAgIHIuYWRkKHRoaXMucGFyc2VPYmplY3QoZFtwXSwgZSwgaSwgbiwgcykpOwogICAgfQogICAgaWYgKHQuYW5pbWF0aW9ucyAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGQgPSB0LmFuaW1hdGlvbnM7CiAgICAgIGZvciAobGV0IHAgPSAwOyBwIDwgZC5sZW5ndGg7IHArKykgewogICAgICAgIGNvbnN0IGYgPSBkW3BdOwogICAgICAgIHIuYW5pbWF0aW9ucy5wdXNoKHNbZl0pOwogICAgICB9CiAgICB9CiAgICBpZiAodC50eXBlID09PSAiTE9EIikgewogICAgICB0LmF1dG9VcGRhdGUgIT09IHZvaWQgMCAmJiAoci5hdXRvVXBkYXRlID0gdC5hdXRvVXBkYXRlKTsKICAgICAgY29uc3QgZCA9IHQubGV2ZWxzOwogICAgICBmb3IgKGxldCBwID0gMDsgcCA8IGQubGVuZ3RoOyBwKyspIHsKICAgICAgICBjb25zdCBmID0gZFtwXSwgeSA9IHIuZ2V0T2JqZWN0QnlQcm9wZXJ0eSgidXVpZCIsIGYub2JqZWN0KTsKICAgICAgICB5ICE9PSB2b2lkIDAgJiYgci5hZGRMZXZlbCh5LCBmLmRpc3RhbmNlLCBmLmh5c3RlcmVzaXMpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcjsKICB9CiAgYmluZFNrZWxldG9ucyh0LCBlKSB7CiAgICBPYmplY3Qua2V5cyhlKS5sZW5ndGggIT09IDAgJiYgdC50cmF2ZXJzZShmdW5jdGlvbihpKSB7CiAgICAgIGlmIChpLmlzU2tpbm5lZE1lc2ggPT09ICEwICYmIGkuc2tlbGV0b24gIT09IHZvaWQgMCkgewogICAgICAgIGNvbnN0IG4gPSBlW2kuc2tlbGV0b25dOwogICAgICAgIG4gPT09IHZvaWQgMCA/IGNvbnNvbGUud2FybigiVEhSRUUuT2JqZWN0TG9hZGVyOiBObyBza2VsZXRvbiBmb3VuZCB3aXRoIFVVSUQ6IiwgaS5za2VsZXRvbikgOiBpLmJpbmQobiwgaS5iaW5kTWF0cml4KTsKICAgICAgfQogICAgfSk7CiAgfQogIGJpbmRMaWdodFRhcmdldHModCkgewogICAgdC50cmF2ZXJzZShmdW5jdGlvbihlKSB7CiAgICAgIGlmIChlLmlzRGlyZWN0aW9uYWxMaWdodCB8fCBlLmlzU3BvdExpZ2h0KSB7CiAgICAgICAgY29uc3QgaSA9IGUudGFyZ2V0LCBuID0gdC5nZXRPYmplY3RCeVByb3BlcnR5KCJ1dWlkIiwgaSk7CiAgICAgICAgbiAhPT0gdm9pZCAwID8gZS50YXJnZXQgPSBuIDogZS50YXJnZXQgPSBuZXcgbGUoKTsKICAgICAgfQogICAgfSk7CiAgfQp9CmNvbnN0IFliID0gewogIFVWTWFwcGluZzogQ2MsCiAgQ3ViZVJlZmxlY3Rpb25NYXBwaW5nOiBpcywKICBDdWJlUmVmcmFjdGlvbk1hcHBpbmc6IFRzLAogIEVxdWlyZWN0YW5ndWxhclJlZmxlY3Rpb25NYXBwaW5nOiB2bywKICBFcXVpcmVjdGFuZ3VsYXJSZWZyYWN0aW9uTWFwcGluZzogYm8sCiAgQ3ViZVVWUmVmbGVjdGlvbk1hcHBpbmc6IFNhCn0sIE1tID0gewogIFJlcGVhdFdyYXBwaW5nOiBNbywKICBDbGFtcFRvRWRnZVdyYXBwaW5nOiBTaSwKICBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nOiBTbwp9LCBTbSA9IHsKICBOZWFyZXN0RmlsdGVyOiBqZSwKICBOZWFyZXN0TWlwbWFwTmVhcmVzdEZpbHRlcjogU3AsCiAgTmVhcmVzdE1pcG1hcExpbmVhckZpbHRlcjogc2EsCiAgTGluZWFyRmlsdGVyOiBDZSwKICBMaW5lYXJNaXBtYXBOZWFyZXN0RmlsdGVyOiBsbywKICBMaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXI6IEVuCn0sIGp1ID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmNsYXNzIFpiIGV4dGVuZHMgVGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgaW1hZ2UgYml0bWFwIGxvYWRlci4KICAgKgogICAqIEBwYXJhbSB7TG9hZGluZ01hbmFnZXJ9IFttYW5hZ2VyXSAtIFRoZSBsb2FkaW5nIG1hbmFnZXIuCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIodCksIHRoaXMuaXNJbWFnZUJpdG1hcExvYWRlciA9ICEwLCB0eXBlb2YgY3JlYXRlSW1hZ2VCaXRtYXAgPiAidSIgJiYgY29uc29sZS53YXJuKCJUSFJFRS5JbWFnZUJpdG1hcExvYWRlcjogY3JlYXRlSW1hZ2VCaXRtYXAoKSBub3Qgc3VwcG9ydGVkLiIpLCB0eXBlb2YgZmV0Y2ggPiAidSIgJiYgY29uc29sZS53YXJuKCJUSFJFRS5JbWFnZUJpdG1hcExvYWRlcjogZmV0Y2goKSBub3Qgc3VwcG9ydGVkLiIpLCB0aGlzLm9wdGlvbnMgPSB7IHByZW11bHRpcGx5QWxwaGE6ICJub25lIiB9LCB0aGlzLl9hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIGxvYWRlciBvcHRpb25zLiBUaGUgc3RydWN0dXJlIG9mIHRoZSBvYmplY3QgbXVzdCBtYXRjaCB0aGUgYG9wdGlvbnNgIHBhcmFtZXRlciBvZgogICAqIFtjcmVhdGVJbWFnZUJpdG1hcF17QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvdy9jcmVhdGVJbWFnZUJpdG1hcH0uCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBsb2FkZXIgb3B0aW9ucyB0byBzZXQuCiAgICogQHJldHVybiB7SW1hZ2VCaXRtYXBMb2FkZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW1hZ2UgYml0bWFwIGxvYWRlci4KICAgKi8KICBzZXRPcHRpb25zKHQpIHsKICAgIHJldHVybiB0aGlzLm9wdGlvbnMgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTdGFydHMgbG9hZGluZyBmcm9tIHRoZSBnaXZlbiBVUkwgYW5kIHBhc3MgdGhlIGxvYWRlZCBpbWFnZSBiaXRtYXAgdG8gdGhlIGBvbkxvYWQoKWAgY2FsbGJhY2suCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIHBhdGgvVVJMIG9mIHRoZSBmaWxlIHRvIGJlIGxvYWRlZC4gVGhpcyBjYW4gYWxzbyBiZSBhIGRhdGEgVVJJLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oSW1hZ2VCaXRtYXApfSBvbkxvYWQgLSBFeGVjdXRlZCB3aGVuIHRoZSBsb2FkaW5nIHByb2Nlc3MgaGFzIGJlZW4gZmluaXNoZWQuCiAgICogQHBhcmFtIHtvblByb2dyZXNzQ2FsbGJhY2t9IG9uUHJvZ3Jlc3MgLSBVbnN1cHBvcnRlZCBpbiB0aGlzIGxvYWRlci4KICAgKiBAcGFyYW0ge29uRXJyb3JDYWxsYmFja30gb25FcnJvciAtIEV4ZWN1dGVkIHdoZW4gZXJyb3JzIG9jY3VyLgogICAqIEByZXR1cm4ge0ltYWdlQml0bWFwfHVuZGVmaW5lZH0gVGhlIGltYWdlIGJpdG1hcC4KICAgKi8KICBsb2FkKHQsIGUsIGksIG4pIHsKICAgIHQgPT09IHZvaWQgMCAmJiAodCA9ICIiKSwgdGhpcy5wYXRoICE9PSB2b2lkIDAgJiYgKHQgPSB0aGlzLnBhdGggKyB0KSwgdCA9IHRoaXMubWFuYWdlci5yZXNvbHZlVVJMKHQpOwogICAgY29uc3QgcyA9IHRoaXMsIHIgPSBUbi5nZXQoYGltYWdlLWJpdG1hcDoke3R9YCk7CiAgICBpZiAociAhPT0gdm9pZCAwKSB7CiAgICAgIGlmIChzLm1hbmFnZXIuaXRlbVN0YXJ0KHQpLCByLnRoZW4pIHsKICAgICAgICByLnRoZW4oKGgpID0+IHsKICAgICAgICAgIGlmIChqdS5oYXMocikgPT09ICEwKQogICAgICAgICAgICBuICYmIG4oanUuZ2V0KHIpKSwgcy5tYW5hZ2VyLml0ZW1FcnJvcih0KSwgcy5tYW5hZ2VyLml0ZW1FbmQodCk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiBlICYmIGUoaCksIHMubWFuYWdlci5pdGVtRW5kKHQpLCBoOwogICAgICAgIH0pOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICBlICYmIGUociksIHMubWFuYWdlci5pdGVtRW5kKHQpOwogICAgICB9LCAwKSwgcjsKICAgIH0KICAgIGNvbnN0IG8gPSB7fTsKICAgIG8uY3JlZGVudGlhbHMgPSB0aGlzLmNyb3NzT3JpZ2luID09PSAiYW5vbnltb3VzIiA/ICJzYW1lLW9yaWdpbiIgOiAiaW5jbHVkZSIsIG8uaGVhZGVycyA9IHRoaXMucmVxdWVzdEhlYWRlciwgby5zaWduYWwgPSB0eXBlb2YgQWJvcnRTaWduYWwuYW55ID09ICJmdW5jdGlvbiIgPyBBYm9ydFNpZ25hbC5hbnkoW3RoaXMuX2Fib3J0Q29udHJvbGxlci5zaWduYWwsIHRoaXMubWFuYWdlci5hYm9ydENvbnRyb2xsZXIuc2lnbmFsXSkgOiB0aGlzLl9hYm9ydENvbnRyb2xsZXIuc2lnbmFsOwogICAgY29uc3QgbCA9IGZldGNoKHQsIG8pLnRoZW4oZnVuY3Rpb24oaCkgewogICAgICByZXR1cm4gaC5ibG9iKCk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKGgpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUltYWdlQml0bWFwKGgsIE9iamVjdC5hc3NpZ24ocy5vcHRpb25zLCB7IGNvbG9yU3BhY2VDb252ZXJzaW9uOiAibm9uZSIgfSkpOwogICAgfSkudGhlbihmdW5jdGlvbihoKSB7CiAgICAgIHJldHVybiBUbi5hZGQoYGltYWdlLWJpdG1hcDoke3R9YCwgaCksIGUgJiYgZShoKSwgcy5tYW5hZ2VyLml0ZW1FbmQodCksIGg7CiAgICB9KS5jYXRjaChmdW5jdGlvbihoKSB7CiAgICAgIG4gJiYgbihoKSwganUuc2V0KGwsIGgpLCBUbi5yZW1vdmUoYGltYWdlLWJpdG1hcDoke3R9YCksIHMubWFuYWdlci5pdGVtRXJyb3IodCksIHMubWFuYWdlci5pdGVtRW5kKHQpOwogICAgfSk7CiAgICBUbi5hZGQoYGltYWdlLWJpdG1hcDoke3R9YCwgbCksIHMubWFuYWdlci5pdGVtU3RhcnQodCk7CiAgfQogIC8qKgogICAqIEFib3J0cyBvbmdvaW5nIGZldGNoIHJlcXVlc3RzLgogICAqCiAgICogQHJldHVybiB7SW1hZ2VCaXRtYXBMb2FkZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgYWJvcnQoKSB7CiAgICByZXR1cm4gdGhpcy5fYWJvcnRDb250cm9sbGVyLmFib3J0KCksIHRoaXMuX2Fib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKSwgdGhpczsKICB9Cn0KbGV0IFBsOwpjbGFzcyBvZiB7CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZ2xvYmFsIG5hdGl2ZSBhdWRpbyBjb250ZXh0LgogICAqCiAgICogQHJldHVybiB7QXVkaW9Db250ZXh0fSBUaGUgbmF0aXZlIGF1ZGlvIGNvbnRleHQuCiAgICovCiAgc3RhdGljIGdldENvbnRleHQoKSB7CiAgICByZXR1cm4gUGwgPT09IHZvaWQgMCAmJiAoUGwgPSBuZXcgKHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCkoKSksIFBsOwogIH0KICAvKioKICAgKiBBbGxvd3MgdG8gc2V0IHRoZSBnbG9iYWwgbmF0aXZlIGF1ZGlvIGNvbnRleHQgZnJvbSBvdXRzaWRlLgogICAqCiAgICogQHBhcmFtIHtBdWRpb0NvbnRleHR9IHZhbHVlIC0gVGhlIG5hdGl2ZSBjb250ZXh0IHRvIHNldC4KICAgKi8KICBzdGF0aWMgc2V0Q29udGV4dCh0KSB7CiAgICBQbCA9IHQ7CiAgfQp9CmNsYXNzIGpiIGV4dGVuZHMgVGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYXVkaW8gbG9hZGVyLgogICAqCiAgICogQHBhcmFtIHtMb2FkaW5nTWFuYWdlcn0gW21hbmFnZXJdIC0gVGhlIGxvYWRpbmcgbWFuYWdlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgLyoqCiAgICogU3RhcnRzIGxvYWRpbmcgZnJvbSB0aGUgZ2l2ZW4gVVJMIGFuZCBwYXNzZXMgdGhlIGxvYWRlZCBhdWRpbyBidWZmZXIKICAgKiB0byB0aGUgYG9uTG9hZCgpYCBjYWxsYmFjay4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgcGF0aC9VUkwgb2YgdGhlIGZpbGUgdG8gYmUgbG9hZGVkLiBUaGlzIGNhbiBhbHNvIGJlIGEgZGF0YSBVUkkuCiAgICogQHBhcmFtIHtmdW5jdGlvbihBdWRpb0J1ZmZlcil9IG9uTG9hZCAtIEV4ZWN1dGVkIHdoZW4gdGhlIGxvYWRpbmcgcHJvY2VzcyBoYXMgYmVlbiBmaW5pc2hlZC4KICAgKiBAcGFyYW0ge29uUHJvZ3Jlc3NDYWxsYmFja30gb25Qcm9ncmVzcyAtIEV4ZWN1dGVkIHdoaWxlIHRoZSBsb2FkaW5nIGlzIGluIHByb2dyZXNzLgogICAqIEBwYXJhbSB7b25FcnJvckNhbGxiYWNrfSBvbkVycm9yIC0gRXhlY3V0ZWQgd2hlbiBlcnJvcnMgb2NjdXIuCiAgICovCiAgbG9hZCh0LCBlLCBpLCBuKSB7CiAgICBjb25zdCBzID0gdGhpcywgciA9IG5ldyBzcyh0aGlzLm1hbmFnZXIpOwogICAgci5zZXRSZXNwb25zZVR5cGUoImFycmF5YnVmZmVyIiksIHIuc2V0UGF0aCh0aGlzLnBhdGgpLCByLnNldFJlcXVlc3RIZWFkZXIodGhpcy5yZXF1ZXN0SGVhZGVyKSwgci5zZXRXaXRoQ3JlZGVudGlhbHModGhpcy53aXRoQ3JlZGVudGlhbHMpLCByLmxvYWQodCwgZnVuY3Rpb24obCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGggPSBsLnNsaWNlKDApOwogICAgICAgIG9mLmdldENvbnRleHQoKS5kZWNvZGVBdWRpb0RhdGEoaCwgZnVuY3Rpb24odSkgewogICAgICAgICAgZSh1KTsKICAgICAgICB9KS5jYXRjaChvKTsKICAgICAgfSBjYXRjaCAoaCkgewogICAgICAgIG8oaCk7CiAgICAgIH0KICAgIH0sIGksIG4pOwogICAgZnVuY3Rpb24gbyhsKSB7CiAgICAgIG4gPyBuKGwpIDogY29uc29sZS5lcnJvcihsKSwgcy5tYW5hZ2VyLml0ZW1FcnJvcih0KTsKICAgIH0KICB9Cn0KY29uc3Qgd20gPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIEFtID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpLCBXcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKTsKY2xhc3MgSmIgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc3RlcmVvIGNhbWVyYS4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMudHlwZSA9ICJTdGVyZW9DYW1lcmEiLCB0aGlzLmFzcGVjdCA9IDEsIHRoaXMuZXllU2VwID0gMC4wNjQsIHRoaXMuY2FtZXJhTCA9IG5ldyBWZSgpLCB0aGlzLmNhbWVyYUwubGF5ZXJzLmVuYWJsZSgxKSwgdGhpcy5jYW1lcmFMLm1hdHJpeEF1dG9VcGRhdGUgPSAhMSwgdGhpcy5jYW1lcmFSID0gbmV3IFZlKCksIHRoaXMuY2FtZXJhUi5sYXllcnMuZW5hYmxlKDIpLCB0aGlzLmNhbWVyYVIubWF0cml4QXV0b1VwZGF0ZSA9ICExLCB0aGlzLl9jYWNoZSA9IHsKICAgICAgZm9jdXM6IG51bGwsCiAgICAgIGZvdjogbnVsbCwKICAgICAgYXNwZWN0OiBudWxsLAogICAgICBuZWFyOiBudWxsLAogICAgICBmYXI6IG51bGwsCiAgICAgIHpvb206IG51bGwsCiAgICAgIGV5ZVNlcDogbnVsbAogICAgfTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgc3RlcmVvIGNhbWVyYSBiYXNlZCBvbiB0aGUgZ2l2ZW4gcGVyc3BlY3RpdmUgY2FtZXJhLgogICAqCiAgICogQHBhcmFtIHtQZXJzcGVjdGl2ZUNhbWVyYX0gY2FtZXJhIC0gVGhlIHBlcnNwZWN0aXZlIGNhbWVyYS4KICAgKi8KICB1cGRhdGUodCkgewogICAgY29uc3QgZSA9IHRoaXMuX2NhY2hlOwogICAgaWYgKGUuZm9jdXMgIT09IHQuZm9jdXMgfHwgZS5mb3YgIT09IHQuZm92IHx8IGUuYXNwZWN0ICE9PSB0LmFzcGVjdCAqIHRoaXMuYXNwZWN0IHx8IGUubmVhciAhPT0gdC5uZWFyIHx8IGUuZmFyICE9PSB0LmZhciB8fCBlLnpvb20gIT09IHQuem9vbSB8fCBlLmV5ZVNlcCAhPT0gdGhpcy5leWVTZXApIHsKICAgICAgZS5mb2N1cyA9IHQuZm9jdXMsIGUuZm92ID0gdC5mb3YsIGUuYXNwZWN0ID0gdC5hc3BlY3QgKiB0aGlzLmFzcGVjdCwgZS5uZWFyID0gdC5uZWFyLCBlLmZhciA9IHQuZmFyLCBlLnpvb20gPSB0Lnpvb20sIGUuZXllU2VwID0gdGhpcy5leWVTZXAsIFdzLmNvcHkodC5wcm9qZWN0aW9uTWF0cml4KTsKICAgICAgY29uc3QgbiA9IGUuZXllU2VwIC8gMiwgcyA9IG4gKiBlLm5lYXIgLyBlLmZvY3VzLCByID0gZS5uZWFyICogTWF0aC50YW4obHIgKiBlLmZvdiAqIDAuNSkgLyBlLnpvb207CiAgICAgIGxldCBvLCBsOwogICAgICBBbS5lbGVtZW50c1sxMl0gPSAtbiwgd20uZWxlbWVudHNbMTJdID0gbiwgbyA9IC1yICogZS5hc3BlY3QgKyBzLCBsID0gciAqIGUuYXNwZWN0ICsgcywgV3MuZWxlbWVudHNbMF0gPSAyICogZS5uZWFyIC8gKGwgLSBvKSwgV3MuZWxlbWVudHNbOF0gPSAobCArIG8pIC8gKGwgLSBvKSwgdGhpcy5jYW1lcmFMLnByb2plY3Rpb25NYXRyaXguY29weShXcyksIG8gPSAtciAqIGUuYXNwZWN0IC0gcywgbCA9IHIgKiBlLmFzcGVjdCAtIHMsIFdzLmVsZW1lbnRzWzBdID0gMiAqIGUubmVhciAvIChsIC0gbyksIFdzLmVsZW1lbnRzWzhdID0gKGwgKyBvKSAvIChsIC0gbyksIHRoaXMuY2FtZXJhUi5wcm9qZWN0aW9uTWF0cml4LmNvcHkoV3MpOwogICAgfQogICAgdGhpcy5jYW1lcmFMLm1hdHJpeFdvcmxkLmNvcHkodC5tYXRyaXhXb3JsZCkubXVsdGlwbHkoQW0pLCB0aGlzLmNhbWVyYVIubWF0cml4V29ybGQuY29weSh0Lm1hdHJpeFdvcmxkKS5tdWx0aXBseSh3bSk7CiAgfQp9CmNsYXNzIHBfIGV4dGVuZHMgVmUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYXJyYXkgY2FtZXJhLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxQZXJzcGVjdGl2ZUNhbWVyYT59IFthcnJheT1bXV0gLSBBbiBhcnJheSBvZiBwZXJzcGVjdGl2ZSBzdWIgY2FtZXJhcy4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gW10pIHsKICAgIHN1cGVyKCksIHRoaXMuaXNBcnJheUNhbWVyYSA9ICEwLCB0aGlzLmlzTXVsdGlWaWV3Q2FtZXJhID0gITEsIHRoaXMuY2FtZXJhcyA9IHQ7CiAgfQp9CmNsYXNzIGxmIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGNsb2NrLgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBbYXV0b1N0YXJ0PXRydWVdIC0gV2hldGhlciB0byBhdXRvbWF0aWNhbGx5IHN0YXJ0IHRoZSBjbG9jayB3aGVuCiAgICogYGdldERlbHRhKClgIGlzIGNhbGxlZCBmb3IgdGhlIGZpcnN0IHRpbWUuCiAgICovCiAgY29uc3RydWN0b3IodCA9ICEwKSB7CiAgICB0aGlzLmF1dG9TdGFydCA9IHQsIHRoaXMuc3RhcnRUaW1lID0gMCwgdGhpcy5vbGRUaW1lID0gMCwgdGhpcy5lbGFwc2VkVGltZSA9IDAsIHRoaXMucnVubmluZyA9ICExOwogIH0KICAvKioKICAgKiBTdGFydHMgdGhlIGNsb2NrLiBXaGVuIGBhdXRvU3RhcnRgIGlzIHNldCB0byBgdHJ1ZWAsIHRoZSBtZXRob2QgaXMgYXV0b21hdGljYWxseQogICAqIGNhbGxlZCBieSB0aGUgY2xhc3MuCiAgICovCiAgc3RhcnQoKSB7CiAgICB0aGlzLnN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpLCB0aGlzLm9sZFRpbWUgPSB0aGlzLnN0YXJ0VGltZSwgdGhpcy5lbGFwc2VkVGltZSA9IDAsIHRoaXMucnVubmluZyA9ICEwOwogIH0KICAvKioKICAgKiBTdG9wcyB0aGUgY2xvY2suCiAgICovCiAgc3RvcCgpIHsKICAgIHRoaXMuZ2V0RWxhcHNlZFRpbWUoKSwgdGhpcy5ydW5uaW5nID0gITEsIHRoaXMuYXV0b1N0YXJ0ID0gITE7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGVsYXBzZWQgdGltZSBpbiBzZWNvbmRzLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZWxhcHNlZCB0aW1lLgogICAqLwogIGdldEVsYXBzZWRUaW1lKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0RGVsdGEoKSwgdGhpcy5lbGFwc2VkVGltZTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZGVsdGEgdGltZSBpbiBzZWNvbmRzLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGVsdGEgdGltZS4KICAgKi8KICBnZXREZWx0YSgpIHsKICAgIGxldCB0ID0gMDsKICAgIGlmICh0aGlzLmF1dG9TdGFydCAmJiAhdGhpcy5ydW5uaW5nKQogICAgICByZXR1cm4gdGhpcy5zdGFydCgpLCAwOwogICAgaWYgKHRoaXMucnVubmluZykgewogICAgICBjb25zdCBlID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIHQgPSAoZSAtIHRoaXMub2xkVGltZSkgLyAxZTMsIHRoaXMub2xkVGltZSA9IGUsIHRoaXMuZWxhcHNlZFRpbWUgKz0gdDsKICAgIH0KICAgIHJldHVybiB0OwogIH0KfQpjb25zdCBxcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBKdSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdmUoKSwgS2IgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgJHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgWHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKY2xhc3MgUWIgZXh0ZW5kcyBsZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBhdWRpbyBsaXN0ZW5lci4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJBdWRpb0xpc3RlbmVyIiwgdGhpcy5jb250ZXh0ID0gb2YuZ2V0Q29udGV4dCgpLCB0aGlzLmdhaW4gPSB0aGlzLmNvbnRleHQuY3JlYXRlR2FpbigpLCB0aGlzLmdhaW4uY29ubmVjdCh0aGlzLmNvbnRleHQuZGVzdGluYXRpb24pLCB0aGlzLmZpbHRlciA9IG51bGwsIHRoaXMudGltZURlbHRhID0gMCwgdGhpcy5fY2xvY2sgPSBuZXcgbGYoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgbGlzdGVuZXIncyBpbnB1dCBub2RlLgogICAqCiAgICogVGhpcyBtZXRob2QgaXMgdXNlZCBieSBvdGhlciBhdWRpbyBub2RlcyB0byBjb25uZWN0IHRvIHRoaXMgbGlzdGVuZXIuCiAgICoKICAgKiBAcmV0dXJuIHtHYWluTm9kZX0gVGhlIGlucHV0IG5vZGUuCiAgICovCiAgZ2V0SW5wdXQoKSB7CiAgICByZXR1cm4gdGhpcy5nYWluOwogIH0KICAvKioKICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IGZpbHRlciBmcm9tIHRoaXMgbGlzdGVuZXIuCiAgICoKICAgKiBAcmV0dXJuIHtBdWRpb0xpc3RlbmVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGxpc3RlbmVyLgogICAqLwogIHJlbW92ZUZpbHRlcigpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlciAhPT0gbnVsbCAmJiAodGhpcy5nYWluLmRpc2Nvbm5lY3QodGhpcy5maWx0ZXIpLCB0aGlzLmZpbHRlci5kaXNjb25uZWN0KHRoaXMuY29udGV4dC5kZXN0aW5hdGlvbiksIHRoaXMuZ2Fpbi5jb25uZWN0KHRoaXMuY29udGV4dC5kZXN0aW5hdGlvbiksIHRoaXMuZmlsdGVyID0gbnVsbCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGN1cnJlbnQgc2V0IGZpbHRlci4KICAgKgogICAqIEByZXR1cm4gez9BdWRpb05vZGV9IFRoZSBmaWx0ZXIuCiAgICovCiAgZ2V0RmlsdGVyKCkgewogICAgcmV0dXJuIHRoaXMuZmlsdGVyOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBmaWx0ZXIgdG8gdGhpcyBsaXN0ZW5lci4KICAgKgogICAqIEBwYXJhbSB7QXVkaW9Ob2RlfSB2YWx1ZSAtIFRoZSBmaWx0ZXIgdG8gc2V0LgogICAqIEByZXR1cm4ge0F1ZGlvTGlzdGVuZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbGlzdGVuZXIuCiAgICovCiAgc2V0RmlsdGVyKHQpIHsKICAgIHJldHVybiB0aGlzLmZpbHRlciAhPT0gbnVsbCA/ICh0aGlzLmdhaW4uZGlzY29ubmVjdCh0aGlzLmZpbHRlciksIHRoaXMuZmlsdGVyLmRpc2Nvbm5lY3QodGhpcy5jb250ZXh0LmRlc3RpbmF0aW9uKSkgOiB0aGlzLmdhaW4uZGlzY29ubmVjdCh0aGlzLmNvbnRleHQuZGVzdGluYXRpb24pLCB0aGlzLmZpbHRlciA9IHQsIHRoaXMuZ2Fpbi5jb25uZWN0KHRoaXMuZmlsdGVyKSwgdGhpcy5maWx0ZXIuY29ubmVjdCh0aGlzLmNvbnRleHQuZGVzdGluYXRpb24pLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBhcHBsaWNhdGlvbnMgbWFzdGVyIHZvbHVtZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG1hc3RlciB2b2x1bWUuCiAgICovCiAgZ2V0TWFzdGVyVm9sdW1lKCkgewogICAgcmV0dXJuIHRoaXMuZ2Fpbi5nYWluLnZhbHVlOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBhcHBsaWNhdGlvbnMgbWFzdGVyIHZvbHVtZS4gVGhpcyB2b2x1bWUgc2V0dGluZyBhZmZlY3RzCiAgICogYWxsIGF1ZGlvIG5vZGVzIGluIHRoZSBzY2VuZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBtYXN0ZXIgdm9sdW1lIHRvIHNldC4KICAgKiBAcmV0dXJuIHtBdWRpb0xpc3RlbmVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGxpc3RlbmVyLgogICAqLwogIHNldE1hc3RlclZvbHVtZSh0KSB7CiAgICByZXR1cm4gdGhpcy5nYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKHQsIHRoaXMuY29udGV4dC5jdXJyZW50VGltZSwgMC4wMSksIHRoaXM7CiAgfQogIHVwZGF0ZU1hdHJpeFdvcmxkKHQpIHsKICAgIHN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKHQpOwogICAgY29uc3QgZSA9IHRoaXMuY29udGV4dC5saXN0ZW5lcjsKICAgIGlmICh0aGlzLnRpbWVEZWx0YSA9IHRoaXMuX2Nsb2NrLmdldERlbHRhKCksIHRoaXMubWF0cml4V29ybGQuZGVjb21wb3NlKHFzLCBKdSwgS2IpLCAkcy5zZXQoMCwgMCwgLTEpLmFwcGx5UXVhdGVybmlvbihKdSksIFhzLnNldCgwLCAxLCAwKS5hcHBseVF1YXRlcm5pb24oSnUpLCBlLnBvc2l0aW9uWCkgewogICAgICBjb25zdCBpID0gdGhpcy5jb250ZXh0LmN1cnJlbnRUaW1lICsgdGhpcy50aW1lRGVsdGE7CiAgICAgIGUucG9zaXRpb25YLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKHFzLngsIGkpLCBlLnBvc2l0aW9uWS5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZShxcy55LCBpKSwgZS5wb3NpdGlvbloubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUocXMueiwgaSksIGUuZm9yd2FyZFgubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoJHMueCwgaSksIGUuZm9yd2FyZFkubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoJHMueSwgaSksIGUuZm9yd2FyZFoubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoJHMueiwgaSksIGUudXBYLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKFhzLngsIGkpLCBlLnVwWS5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZShYcy55LCBpKSwgZS51cFoubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoWHMueiwgaSk7CiAgICB9IGVsc2UKICAgICAgZS5zZXRQb3NpdGlvbihxcy54LCBxcy55LCBxcy56KSwgZS5zZXRPcmllbnRhdGlvbigkcy54LCAkcy55LCAkcy56LCBYcy54LCBYcy55LCBYcy56KTsKICB9Cn0KY2xhc3MgZl8gZXh0ZW5kcyBsZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBhdWRpby4KICAgKgogICAqIEBwYXJhbSB7QXVkaW9MaXN0ZW5lcn0gbGlzdGVuZXIgLSBUaGUgZ2xvYmFsIGF1ZGlvIGxpc3RlbmVyLgogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJBdWRpbyIsIHRoaXMubGlzdGVuZXIgPSB0LCB0aGlzLmNvbnRleHQgPSB0LmNvbnRleHQsIHRoaXMuZ2FpbiA9IHRoaXMuY29udGV4dC5jcmVhdGVHYWluKCksIHRoaXMuZ2Fpbi5jb25uZWN0KHQuZ2V0SW5wdXQoKSksIHRoaXMuYXV0b3BsYXkgPSAhMSwgdGhpcy5idWZmZXIgPSBudWxsLCB0aGlzLmRldHVuZSA9IDAsIHRoaXMubG9vcCA9ICExLCB0aGlzLmxvb3BTdGFydCA9IDAsIHRoaXMubG9vcEVuZCA9IDAsIHRoaXMub2Zmc2V0ID0gMCwgdGhpcy5kdXJhdGlvbiA9IHZvaWQgMCwgdGhpcy5wbGF5YmFja1JhdGUgPSAxLCB0aGlzLmlzUGxheWluZyA9ICExLCB0aGlzLmhhc1BsYXliYWNrQ29udHJvbCA9ICEwLCB0aGlzLnNvdXJjZSA9IG51bGwsIHRoaXMuc291cmNlVHlwZSA9ICJlbXB0eSIsIHRoaXMuX3N0YXJ0ZWRBdCA9IDAsIHRoaXMuX3Byb2dyZXNzID0gMCwgdGhpcy5fY29ubmVjdGVkID0gITEsIHRoaXMuZmlsdGVycyA9IFtdOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBvdXRwdXQgYXVkaW8gbm9kZS4KICAgKgogICAqIEByZXR1cm4ge0dhaW5Ob2RlfSBUaGUgb3V0cHV0IG5vZGUuCiAgICovCiAgZ2V0T3V0cHV0KCkgewogICAgcmV0dXJuIHRoaXMuZ2FpbjsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gYXVkaW8gbm9kZSBhcyB0aGUgc291cmNlIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiB7QGxpbmsgQXVkaW8jc291cmNlVHlwZX0gaXMgc2V0IHRvIGBhdWRpb05vZGVgIGFuZCB7QGxpbmsgQXVkaW8jaGFzUGxheWJhY2tDb250cm9sfSB0byBgZmFsc2VgLgogICAqCiAgICogQHBhcmFtIHtBdWRpb05vZGV9IGF1ZGlvTm9kZSAtIFRoZSBhdWRpbyBub2RlIGxpa2UgYW4gaW5zdGFuY2Ugb2YgYE9zY2lsbGF0b3JOb2RlYC4KICAgKiBAcmV0dXJuIHtBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXROb2RlU291cmNlKHQpIHsKICAgIHJldHVybiB0aGlzLmhhc1BsYXliYWNrQ29udHJvbCA9ICExLCB0aGlzLnNvdXJjZVR5cGUgPSAiYXVkaW9Ob2RlIiwgdGhpcy5zb3VyY2UgPSB0LCB0aGlzLmNvbm5lY3QoKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gbWVkaWEgZWxlbWVudCBhcyB0aGUgc291cmNlIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiB7QGxpbmsgQXVkaW8jc291cmNlVHlwZX0gaXMgc2V0IHRvIGBtZWRpYU5vZGVgIGFuZCB7QGxpbmsgQXVkaW8jaGFzUGxheWJhY2tDb250cm9sfSB0byBgZmFsc2VgLgogICAqCiAgICogQHBhcmFtIHtIVE1MTWVkaWFFbGVtZW50fSBtZWRpYUVsZW1lbnQgLSBUaGUgbWVkaWEgZWxlbWVudC4KICAgKiBAcmV0dXJuIHtBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRNZWRpYUVsZW1lbnRTb3VyY2UodCkgewogICAgcmV0dXJuIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID0gITEsIHRoaXMuc291cmNlVHlwZSA9ICJtZWRpYU5vZGUiLCB0aGlzLnNvdXJjZSA9IHRoaXMuY29udGV4dC5jcmVhdGVNZWRpYUVsZW1lbnRTb3VyY2UodCksIHRoaXMuY29ubmVjdCgpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBtZWRpYSBzdHJlYW0gYXMgdGhlIHNvdXJjZSBvZiB0aGlzIGluc3RhbmNlLgogICAqCiAgICoge0BsaW5rIEF1ZGlvI3NvdXJjZVR5cGV9IGlzIHNldCB0byBgbWVkaWFTdHJlYW1Ob2RlYCBhbmQge0BsaW5rIEF1ZGlvI2hhc1BsYXliYWNrQ29udHJvbH0gdG8gYGZhbHNlYC4KICAgKgogICAqIEBwYXJhbSB7TWVkaWFTdHJlYW19IG1lZGlhU3RyZWFtIC0gVGhlIG1lZGlhIHN0cmVhbS4KICAgKiBAcmV0dXJuIHtBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRNZWRpYVN0cmVhbVNvdXJjZSh0KSB7CiAgICByZXR1cm4gdGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPSAhMSwgdGhpcy5zb3VyY2VUeXBlID0gIm1lZGlhU3RyZWFtTm9kZSIsIHRoaXMuc291cmNlID0gdGhpcy5jb250ZXh0LmNyZWF0ZU1lZGlhU3RyZWFtU291cmNlKHQpLCB0aGlzLmNvbm5lY3QoKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gYXVkaW8gYnVmZmVyIGFzIHRoZSBzb3VyY2Ugb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIHtAbGluayBBdWRpbyNzb3VyY2VUeXBlfSBpcyBzZXQgdG8gYGJ1ZmZlcmAgYW5kIHtAbGluayBBdWRpbyNoYXNQbGF5YmFja0NvbnRyb2x9IHRvIGB0cnVlYC4KICAgKgogICAqIEBwYXJhbSB7QXVkaW9CdWZmZXJ9IGF1ZGlvQnVmZmVyIC0gVGhlIGF1ZGlvIGJ1ZmZlci4KICAgKiBAcmV0dXJuIHtBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRCdWZmZXIodCkgewogICAgcmV0dXJuIHRoaXMuYnVmZmVyID0gdCwgdGhpcy5zb3VyY2VUeXBlID0gImJ1ZmZlciIsIHRoaXMuYXV0b3BsYXkgJiYgdGhpcy5wbGF5KCksIHRoaXM7CiAgfQogIC8qKgogICAqIFN0YXJ0cyB0aGUgcGxheWJhY2sgb2YgdGhlIGF1ZGlvLgogICAqCiAgICogQ2FuIG9ubHkgYmUgdXNlZCB3aXRoIGNvbXBhdGlibGUgYXVkaW8gc291cmNlcyB0aGF0IGFsbG93IHBsYXliYWNrIGNvbnRyb2wuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW2RlbGF5PTBdIC0gVGhlIGRlbGF5LCBpbiBzZWNvbmRzLCBhdCB3aGljaCB0aGUgYXVkaW8gc2hvdWxkIHN0YXJ0IHBsYXlpbmcuCiAgICogQHJldHVybiB7QXVkaW98dW5kZWZpbmVkfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHBsYXkodCA9IDApIHsKICAgIGlmICh0aGlzLmlzUGxheWluZyA9PT0gITApIHsKICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5BdWRpbzogQXVkaW8gaXMgYWxyZWFkeSBwbGF5aW5nLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPT09ICExKSB7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuQXVkaW86IHRoaXMgQXVkaW8gaGFzIG5vIHBsYXliYWNrIGNvbnRyb2wuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX3N0YXJ0ZWRBdCA9IHRoaXMuY29udGV4dC5jdXJyZW50VGltZSArIHQ7CiAgICBjb25zdCBlID0gdGhpcy5jb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgcmV0dXJuIGUuYnVmZmVyID0gdGhpcy5idWZmZXIsIGUubG9vcCA9IHRoaXMubG9vcCwgZS5sb29wU3RhcnQgPSB0aGlzLmxvb3BTdGFydCwgZS5sb29wRW5kID0gdGhpcy5sb29wRW5kLCBlLm9uZW5kZWQgPSB0aGlzLm9uRW5kZWQuYmluZCh0aGlzKSwgZS5zdGFydCh0aGlzLl9zdGFydGVkQXQsIHRoaXMuX3Byb2dyZXNzICsgdGhpcy5vZmZzZXQsIHRoaXMuZHVyYXRpb24pLCB0aGlzLmlzUGxheWluZyA9ICEwLCB0aGlzLnNvdXJjZSA9IGUsIHRoaXMuc2V0RGV0dW5lKHRoaXMuZGV0dW5lKSwgdGhpcy5zZXRQbGF5YmFja1JhdGUodGhpcy5wbGF5YmFja1JhdGUpLCB0aGlzLmNvbm5lY3QoKTsKICB9CiAgLyoqCiAgICogUGF1c2VzIHRoZSBwbGF5YmFjayBvZiB0aGUgYXVkaW8uCiAgICoKICAgKiBDYW4gb25seSBiZSB1c2VkIHdpdGggY29tcGF0aWJsZSBhdWRpbyBzb3VyY2VzIHRoYXQgYWxsb3cgcGxheWJhY2sgY29udHJvbC4KICAgKgogICAqIEByZXR1cm4ge0F1ZGlvfHVuZGVmaW5lZH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBwYXVzZSgpIHsKICAgIGlmICh0aGlzLmhhc1BsYXliYWNrQ29udHJvbCA9PT0gITEpIHsKICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5BdWRpbzogdGhpcyBBdWRpbyBoYXMgbm8gcGxheWJhY2sgY29udHJvbC4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIHRoaXMuaXNQbGF5aW5nID09PSAhMCAmJiAodGhpcy5fcHJvZ3Jlc3MgKz0gTWF0aC5tYXgodGhpcy5jb250ZXh0LmN1cnJlbnRUaW1lIC0gdGhpcy5fc3RhcnRlZEF0LCAwKSAqIHRoaXMucGxheWJhY2tSYXRlLCB0aGlzLmxvb3AgPT09ICEwICYmICh0aGlzLl9wcm9ncmVzcyA9IHRoaXMuX3Byb2dyZXNzICUgKHRoaXMuZHVyYXRpb24gfHwgdGhpcy5idWZmZXIuZHVyYXRpb24pKSwgdGhpcy5zb3VyY2Uuc3RvcCgpLCB0aGlzLnNvdXJjZS5vbmVuZGVkID0gbnVsbCwgdGhpcy5pc1BsYXlpbmcgPSAhMSksIHRoaXM7CiAgfQogIC8qKgogICAqIFN0b3BzIHRoZSBwbGF5YmFjayBvZiB0aGUgYXVkaW8uCiAgICoKICAgKiBDYW4gb25seSBiZSB1c2VkIHdpdGggY29tcGF0aWJsZSBhdWRpbyBzb3VyY2VzIHRoYXQgYWxsb3cgcGxheWJhY2sgY29udHJvbC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGVsYXk9MF0gLSBUaGUgZGVsYXksIGluIHNlY29uZHMsIGF0IHdoaWNoIHRoZSBhdWRpbyBzaG91bGQgc3RvcCBwbGF5aW5nLgogICAqIEByZXR1cm4ge0F1ZGlvfHVuZGVmaW5lZH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzdG9wKHQgPSAwKSB7CiAgICBpZiAodGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPT09ICExKSB7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuQXVkaW86IHRoaXMgQXVkaW8gaGFzIG5vIHBsYXliYWNrIGNvbnRyb2wuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiB0aGlzLl9wcm9ncmVzcyA9IDAsIHRoaXMuc291cmNlICE9PSBudWxsICYmICh0aGlzLnNvdXJjZS5zdG9wKHRoaXMuY29udGV4dC5jdXJyZW50VGltZSArIHQpLCB0aGlzLnNvdXJjZS5vbmVuZGVkID0gbnVsbCksIHRoaXMuaXNQbGF5aW5nID0gITEsIHRoaXM7CiAgfQogIC8qKgogICAqIENvbm5lY3RzIHRvIHRoZSBhdWRpbyBzb3VyY2UuIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5IG9uCiAgICogaW5pdGlhbGlzYXRpb24gYW5kIHdoZW4gc2V0dGluZyAvIHJlbW92aW5nIGZpbHRlcnMuCiAgICoKICAgKiBAcmV0dXJuIHtBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb25uZWN0KCkgewogICAgaWYgKHRoaXMuZmlsdGVycy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuc291cmNlLmNvbm5lY3QodGhpcy5maWx0ZXJzWzBdKTsKICAgICAgZm9yIChsZXQgdCA9IDEsIGUgPSB0aGlzLmZpbHRlcnMubGVuZ3RoOyB0IDwgZTsgdCsrKQogICAgICAgIHRoaXMuZmlsdGVyc1t0IC0gMV0uY29ubmVjdCh0aGlzLmZpbHRlcnNbdF0pOwogICAgICB0aGlzLmZpbHRlcnNbdGhpcy5maWx0ZXJzLmxlbmd0aCAtIDFdLmNvbm5lY3QodGhpcy5nZXRPdXRwdXQoKSk7CiAgICB9IGVsc2UKICAgICAgdGhpcy5zb3VyY2UuY29ubmVjdCh0aGlzLmdldE91dHB1dCgpKTsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0ZWQgPSAhMCwgdGhpczsKICB9CiAgLyoqCiAgICogRGlzY29ubmVjdHMgdG8gdGhlIGF1ZGlvIHNvdXJjZS4gVGhpcyBpcyB1c2VkIGludGVybmFsbHkgb24KICAgKiBpbml0aWFsaXNhdGlvbiBhbmQgd2hlbiBzZXR0aW5nIC8gcmVtb3ZpbmcgZmlsdGVycy4KICAgKgogICAqIEByZXR1cm4ge0F1ZGlvfHVuZGVmaW5lZH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBkaXNjb25uZWN0KCkgewogICAgaWYgKHRoaXMuX2Nvbm5lY3RlZCAhPT0gITEpIHsKICAgICAgaWYgKHRoaXMuZmlsdGVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy5zb3VyY2UuZGlzY29ubmVjdCh0aGlzLmZpbHRlcnNbMF0pOwogICAgICAgIGZvciAobGV0IHQgPSAxLCBlID0gdGhpcy5maWx0ZXJzLmxlbmd0aDsgdCA8IGU7IHQrKykKICAgICAgICAgIHRoaXMuZmlsdGVyc1t0IC0gMV0uZGlzY29ubmVjdCh0aGlzLmZpbHRlcnNbdF0pOwogICAgICAgIHRoaXMuZmlsdGVyc1t0aGlzLmZpbHRlcnMubGVuZ3RoIC0gMV0uZGlzY29ubmVjdCh0aGlzLmdldE91dHB1dCgpKTsKICAgICAgfSBlbHNlCiAgICAgICAgdGhpcy5zb3VyY2UuZGlzY29ubmVjdCh0aGlzLmdldE91dHB1dCgpKTsKICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3RlZCA9ICExLCB0aGlzOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHNldCBmaWx0ZXJzLgogICAqCiAgICogQHJldHVybiB7QXJyYXk8QXVkaW9Ob2RlPn0gVGhlIGxpc3Qgb2YgZmlsdGVycy4KICAgKi8KICBnZXRGaWx0ZXJzKCkgewogICAgcmV0dXJuIHRoaXMuZmlsdGVyczsKICB9CiAgLyoqCiAgICogU2V0cyBhbiBhcnJheSBvZiBmaWx0ZXJzIGFuZCBjb25uZWN0cyB0aGVtIHdpdGggdGhlIGF1ZGlvIHNvdXJjZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8QXVkaW9Ob2RlPn0gW3ZhbHVlXSAtIEEgbGlzdCBvZiBmaWx0ZXJzLgogICAqIEByZXR1cm4ge0F1ZGlvfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldEZpbHRlcnModCkgewogICAgcmV0dXJuIHQgfHwgKHQgPSBbXSksIHRoaXMuX2Nvbm5lY3RlZCA9PT0gITAgPyAodGhpcy5kaXNjb25uZWN0KCksIHRoaXMuZmlsdGVycyA9IHQuc2xpY2UoKSwgdGhpcy5jb25uZWN0KCkpIDogdGhpcy5maWx0ZXJzID0gdC5zbGljZSgpLCB0aGlzOwogIH0KICAvKioKICAgKiBEZWZpbmVzIHRoZSBkZXR1bmluZyBvZiBvc2NpbGxhdGlvbiBpbiBjZW50cy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBkZXR1bmluZyBvZiBvc2NpbGxhdGlvbiBpbiBjZW50cy4KICAgKiBAcmV0dXJuIHtBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXREZXR1bmUodCkgewogICAgcmV0dXJuIHRoaXMuZGV0dW5lID0gdCwgdGhpcy5pc1BsYXlpbmcgPT09ICEwICYmIHRoaXMuc291cmNlLmRldHVuZSAhPT0gdm9pZCAwICYmIHRoaXMuc291cmNlLmRldHVuZS5zZXRUYXJnZXRBdFRpbWUodGhpcy5kZXR1bmUsIHRoaXMuY29udGV4dC5jdXJyZW50VGltZSwgMC4wMSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGRldHVuaW5nIG9mIG9zY2lsbGF0aW9uIGluIGNlbnRzLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGV0dW5pbmcgb2Ygb3NjaWxsYXRpb24gaW4gY2VudHMuCiAgICovCiAgZ2V0RGV0dW5lKCkgewogICAgcmV0dXJuIHRoaXMuZGV0dW5lOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBmaXJzdCBmaWx0ZXIgaW4gdGhlIGxpc3Qgb2YgZmlsdGVycy4KICAgKgogICAqIEByZXR1cm4ge0F1ZGlvTm9kZXx1bmRlZmluZWR9IFRoZSBmaXJzdCBmaWx0ZXIgaW4gdGhlIGxpc3Qgb2YgZmlsdGVycy4KICAgKi8KICBnZXRGaWx0ZXIoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRGaWx0ZXJzKClbMF07CiAgfQogIC8qKgogICAqIEFwcGxpZXMgYSBzaW5nbGUgZmlsdGVyIG5vZGUgdG8gdGhlIGF1ZGlvLgogICAqCiAgICogQHBhcmFtIHtBdWRpb05vZGV9IFtmaWx0ZXJdIC0gVGhlIGZpbHRlciB0byBzZXQuCiAgICogQHJldHVybiB7QXVkaW99IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0RmlsdGVyKHQpIHsKICAgIHJldHVybiB0aGlzLnNldEZpbHRlcnModCA/IFt0XSA6IFtdKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgcGxheWJhY2sgcmF0ZS4KICAgKgogICAqIENhbiBvbmx5IGJlIHVzZWQgd2l0aCBjb21wYXRpYmxlIGF1ZGlvIHNvdXJjZXMgdGhhdCBhbGxvdyBwbGF5YmFjayBjb250cm9sLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFt2YWx1ZV0gLSBUaGUgcGxheWJhY2sgcmF0ZSB0byBzZXQuCiAgICogQHJldHVybiB7QXVkaW98dW5kZWZpbmVkfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFBsYXliYWNrUmF0ZSh0KSB7CiAgICBpZiAodGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPT09ICExKSB7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuQXVkaW86IHRoaXMgQXVkaW8gaGFzIG5vIHBsYXliYWNrIGNvbnRyb2wuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiB0aGlzLnBsYXliYWNrUmF0ZSA9IHQsIHRoaXMuaXNQbGF5aW5nID09PSAhMCAmJiB0aGlzLnNvdXJjZS5wbGF5YmFja1JhdGUuc2V0VGFyZ2V0QXRUaW1lKHRoaXMucGxheWJhY2tSYXRlLCB0aGlzLmNvbnRleHQuY3VycmVudFRpbWUsIDAuMDEpLCB0aGlzOwogIH0KICAvKioKICAJICogUmV0dXJucyB0aGUgY3VycmVudCBwbGF5YmFjayByYXRlLgogIAogIAkgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBwbGF5YmFjayByYXRlLgogIAkgKi8KICBnZXRQbGF5YmFja1JhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5wbGF5YmFja1JhdGU7CiAgfQogIC8qKgogICAqIEF1dG9tYXRpY2FsbHkgY2FsbGVkIHdoZW4gcGxheWJhY2sgZmluaXNoZWQuCiAgICovCiAgb25FbmRlZCgpIHsKICAgIHRoaXMuaXNQbGF5aW5nID0gITEsIHRoaXMuX3Byb2dyZXNzID0gMDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgbG9vcCBmbGFnLgogICAqCiAgICogQ2FuIG9ubHkgYmUgdXNlZCB3aXRoIGNvbXBhdGlibGUgYXVkaW8gc291cmNlcyB0aGF0IGFsbG93IHBsYXliYWNrIGNvbnRyb2wuCiAgICoKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBhdWRpbyBzaG91bGQgbG9vcCBvciBub3QuCiAgICovCiAgZ2V0TG9vcCgpIHsKICAgIHJldHVybiB0aGlzLmhhc1BsYXliYWNrQ29udHJvbCA9PT0gITEgPyAoY29uc29sZS53YXJuKCJUSFJFRS5BdWRpbzogdGhpcyBBdWRpbyBoYXMgbm8gcGxheWJhY2sgY29udHJvbC4iKSwgITEpIDogdGhpcy5sb29wOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBsb29wIGZsYWcuCiAgICoKICAgKiBDYW4gb25seSBiZSB1c2VkIHdpdGggY29tcGF0aWJsZSBhdWRpbyBzb3VyY2VzIHRoYXQgYWxsb3cgcGxheWJhY2sgY29udHJvbC4KICAgKgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUgLSBXaGV0aGVyIHRoZSBhdWRpbyBzaG91bGQgbG9vcCBvciBub3QuCiAgICogQHJldHVybiB7QXVkaW98dW5kZWZpbmVkfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldExvb3AodCkgewogICAgaWYgKHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSAhMSkgewogICAgICBjb25zb2xlLndhcm4oIlRIUkVFLkF1ZGlvOiB0aGlzIEF1ZGlvIGhhcyBubyBwbGF5YmFjayBjb250cm9sLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gdGhpcy5sb29wID0gdCwgdGhpcy5pc1BsYXlpbmcgPT09ICEwICYmICh0aGlzLnNvdXJjZS5sb29wID0gdGhpcy5sb29wKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgbG9vcCBzdGFydCB2YWx1ZSB3aGljaCBkZWZpbmVzIHdoZXJlIGluIHRoZSBhdWRpbyBidWZmZXIgdGhlIHJlcGxheSBzaG91bGQKICAgKiBzdGFydCwgaW4gc2Vjb25kcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBsb29wIHN0YXJ0IHZhbHVlLgogICAqIEByZXR1cm4ge0F1ZGlvfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldExvb3BTdGFydCh0KSB7CiAgICByZXR1cm4gdGhpcy5sb29wU3RhcnQgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBsb29wIGVuZCB2YWx1ZSB3aGljaCBkZWZpbmVzIHdoZXJlIGluIHRoZSBhdWRpbyBidWZmZXIgdGhlIHJlcGxheSBzaG91bGQKICAgKiBzdG9wLCBpbiBzZWNvbmRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIGxvb3AgZW5kIHZhbHVlLgogICAqIEByZXR1cm4ge0F1ZGlvfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldExvb3BFbmQodCkgewogICAgcmV0dXJuIHRoaXMubG9vcEVuZCA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHZvbHVtZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHZvbHVtZS4KICAgKi8KICBnZXRWb2x1bWUoKSB7CiAgICByZXR1cm4gdGhpcy5nYWluLmdhaW4udmFsdWU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZvbHVtZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2b2x1bWUgdG8gc2V0LgogICAqIEByZXR1cm4ge0F1ZGlvfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFZvbHVtZSh0KSB7CiAgICByZXR1cm4gdGhpcy5nYWluLmdhaW4uc2V0VGFyZ2V0QXRUaW1lKHQsIHRoaXMuY29udGV4dC5jdXJyZW50VGltZSwgMC4wMSksIHRoaXM7CiAgfQogIGNvcHkodCwgZSkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCwgZSksIHQuc291cmNlVHlwZSAhPT0gImJ1ZmZlciIgPyAoY29uc29sZS53YXJuKCJUSFJFRS5BdWRpbzogQXVkaW8gc291cmNlIHR5cGUgY2Fubm90IGJlIGNvcGllZC4iKSwgdGhpcykgOiAodGhpcy5hdXRvcGxheSA9IHQuYXV0b3BsYXksIHRoaXMuYnVmZmVyID0gdC5idWZmZXIsIHRoaXMuZGV0dW5lID0gdC5kZXR1bmUsIHRoaXMubG9vcCA9IHQubG9vcCwgdGhpcy5sb29wU3RhcnQgPSB0Lmxvb3BTdGFydCwgdGhpcy5sb29wRW5kID0gdC5sb29wRW5kLCB0aGlzLm9mZnNldCA9IHQub2Zmc2V0LCB0aGlzLmR1cmF0aW9uID0gdC5kdXJhdGlvbiwgdGhpcy5wbGF5YmFja1JhdGUgPSB0LnBsYXliYWNrUmF0ZSwgdGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPSB0Lmhhc1BsYXliYWNrQ29udHJvbCwgdGhpcy5zb3VyY2VUeXBlID0gdC5zb3VyY2VUeXBlLCB0aGlzLmZpbHRlcnMgPSB0LmZpbHRlcnMuc2xpY2UoKSwgdGhpcyk7CiAgfQogIGNsb25lKHQpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmxpc3RlbmVyKS5jb3B5KHRoaXMsIHQpOwogIH0KfQpjb25zdCBZcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgpLCBFbSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdmUoKSwgdE0gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgWnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKY2xhc3MgZU0gZXh0ZW5kcyBmXyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIHBvc2l0aW9uYWwgYXVkaW8uCiAgICoKICAgKiBAcGFyYW0ge0F1ZGlvTGlzdGVuZXJ9IGxpc3RlbmVyIC0gVGhlIGdsb2JhbCBhdWRpbyBsaXN0ZW5lci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KSwgdGhpcy5wYW5uZXIgPSB0aGlzLmNvbnRleHQuY3JlYXRlUGFubmVyKCksIHRoaXMucGFubmVyLnBhbm5pbmdNb2RlbCA9ICJIUlRGIiwgdGhpcy5wYW5uZXIuY29ubmVjdCh0aGlzLmdhaW4pOwogIH0KICBjb25uZWN0KCkgewogICAgcmV0dXJuIHN1cGVyLmNvbm5lY3QoKSwgdGhpcy5wYW5uZXIuY29ubmVjdCh0aGlzLmdhaW4pLCB0aGlzOwogIH0KICBkaXNjb25uZWN0KCkgewogICAgcmV0dXJuIHN1cGVyLmRpc2Nvbm5lY3QoKSwgdGhpcy5wYW5uZXIuZGlzY29ubmVjdCh0aGlzLmdhaW4pLCB0aGlzOwogIH0KICBnZXRPdXRwdXQoKSB7CiAgICByZXR1cm4gdGhpcy5wYW5uZXI7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcmVmZXJlbmNlIGRpc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcmVmZXJlbmNlIGRpc3RhbmNlLgogICAqLwogIGdldFJlZkRpc3RhbmNlKCkgewogICAgcmV0dXJuIHRoaXMucGFubmVyLnJlZkRpc3RhbmNlOwogIH0KICAvKioKICAgKiBEZWZpbmVzIHRoZSByZWZlcmVuY2UgZGlzdGFuY2UgZm9yIHJlZHVjaW5nIHZvbHVtZSBhcyB0aGUgYXVkaW8gc291cmNlIG1vdmVzCiAgICogZnVydGhlciBmcm9tIHRoZSBsaXN0ZW5lciDigJMgaS5lLiB0aGUgZGlzdGFuY2UgYXQgd2hpY2ggdGhlIHZvbHVtZSByZWR1Y3Rpb24KICAgKiBzdGFydHMgdGFraW5nIGVmZmVjdC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSByZWZlcmVuY2UgZGlzdGFuY2UgdG8gc2V0LgogICAqIEByZXR1cm4ge1Bvc2l0aW9uYWxBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRSZWZEaXN0YW5jZSh0KSB7CiAgICByZXR1cm4gdGhpcy5wYW5uZXIucmVmRGlzdGFuY2UgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHJvbGxvZmYgZmFjdG9yLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcm9sbG9mZiBmYWN0b3IuCiAgICovCiAgZ2V0Um9sbG9mZkZhY3RvcigpIHsKICAgIHJldHVybiB0aGlzLnBhbm5lci5yb2xsb2ZmRmFjdG9yOwogIH0KICAvKioKICAgKiBEZWZpbmVzIGhvdyBxdWlja2x5IHRoZSB2b2x1bWUgaXMgcmVkdWNlZCBhcyB0aGUgc291cmNlIG1vdmVzIGF3YXkgZnJvbSB0aGUgbGlzdGVuZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgcm9sbG9mZiBmYWN0b3IuCiAgICogQHJldHVybiB7UG9zaXRpb25hbEF1ZGlvfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldFJvbGxvZmZGYWN0b3IodCkgewogICAgcmV0dXJuIHRoaXMucGFubmVyLnJvbGxvZmZGYWN0b3IgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGRpc3RhbmNlIG1vZGVsLgogICAqCiAgICogQHJldHVybiB7KCdsaW5lYXInfCdpbnZlcnNlJ3wnZXhwb25lbnRpYWwnKX0gVGhlIGRpc3RhbmNlIG1vZGVsLgogICAqLwogIGdldERpc3RhbmNlTW9kZWwoKSB7CiAgICByZXR1cm4gdGhpcy5wYW5uZXIuZGlzdGFuY2VNb2RlbDsKICB9CiAgLyoqCiAgICogRGVmaW5lcyB3aGljaCBhbGdvcml0aG0gdG8gdXNlIHRvIHJlZHVjZSB0aGUgdm9sdW1lIG9mIHRoZSBhdWRpbyBzb3VyY2UKICAgKiBhcyBpdCBtb3ZlcyBhd2F5IGZyb20gdGhlIGxpc3RlbmVyLgogICAqCiAgICogUmVhZCBbdGhlIHNwZWNde0BsaW5rIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJhdWRpby0xLjEvI2VudW1kZWYtZGlzdGFuY2Vtb2RlbHR5cGV9CiAgICogZm9yIG1vcmUgZGV0YWlscy4KICAgKgogICAqIEBwYXJhbSB7KCdsaW5lYXInfCdpbnZlcnNlJ3wnZXhwb25lbnRpYWwnKX0gdmFsdWUgLSBUaGUgZGlzdGFuY2UgbW9kZWwgdG8gc2V0LgogICAqIEByZXR1cm4ge1Bvc2l0aW9uYWxBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXREaXN0YW5jZU1vZGVsKHQpIHsKICAgIHJldHVybiB0aGlzLnBhbm5lci5kaXN0YW5jZU1vZGVsID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY3VycmVudCBtYXggZGlzdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBtYXggZGlzdGFuY2UuCiAgICovCiAgZ2V0TWF4RGlzdGFuY2UoKSB7CiAgICByZXR1cm4gdGhpcy5wYW5uZXIubWF4RGlzdGFuY2U7CiAgfQogIC8qKgogICAqIERlZmluZXMgdGhlIG1heGltdW0gZGlzdGFuY2UgYmV0d2VlbiB0aGUgYXVkaW8gc291cmNlIGFuZCB0aGUgbGlzdGVuZXIsCiAgICogYWZ0ZXIgd2hpY2ggdGhlIHZvbHVtZSBpcyBub3QgcmVkdWNlZCBhbnkgZnVydGhlci4KICAgKgogICAqIFRoaXMgdmFsdWUgaXMgdXNlZCBvbmx5IGJ5IHRoZSBgbGluZWFyYCBkaXN0YW5jZSBtb2RlbC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBtYXggZGlzdGFuY2UuCiAgICogQHJldHVybiB7UG9zaXRpb25hbEF1ZGlvfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHNldE1heERpc3RhbmNlKHQpIHsKICAgIHJldHVybiB0aGlzLnBhbm5lci5tYXhEaXN0YW5jZSA9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGRpcmVjdGlvbmFsIGNvbmUgaW4gd2hpY2ggdGhlIGF1ZGlvIGNhbiBiZSBsaXN0ZW5lZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25lSW5uZXJBbmdsZSAtIEFuIGFuZ2xlLCBpbiBkZWdyZWVzLCBvZiBhIGNvbmUgaW5zaWRlIG9mIHdoaWNoIHRoZXJlIHdpbGwgYmUgbm8gdm9sdW1lIHJlZHVjdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gY29uZU91dGVyQW5nbGUgLSBBbiBhbmdsZSwgaW4gZGVncmVlcywgb2YgYSBjb25lIG91dHNpZGUgb2Ygd2hpY2ggdGhlIHZvbHVtZSB3aWxsIGJlIHJlZHVjZWQgYnkgYSBjb25zdGFudCB2YWx1ZSwgZGVmaW5lZCBieSB0aGUgYGNvbmVPdXRlckdhaW5gIHBhcmFtZXRlci4KICAgKiBAcGFyYW0ge251bWJlcn0gY29uZU91dGVyR2FpbiAtIFRoZSBhbW91bnQgb2Ygdm9sdW1lIHJlZHVjdGlvbiBvdXRzaWRlIHRoZSBjb25lIGRlZmluZWQgYnkgdGhlIGBjb25lT3V0ZXJBbmdsZWAuIFdoZW4gc2V0IHRvIGAwYCwgbm8gc291bmQgY2FuIGJlIGhlYXJkLgogICAqIEByZXR1cm4ge1Bvc2l0aW9uYWxBdWRpb30gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXREaXJlY3Rpb25hbENvbmUodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMucGFubmVyLmNvbmVJbm5lckFuZ2xlID0gdCwgdGhpcy5wYW5uZXIuY29uZU91dGVyQW5nbGUgPSBlLCB0aGlzLnBhbm5lci5jb25lT3V0ZXJHYWluID0gaSwgdGhpczsKICB9CiAgdXBkYXRlTWF0cml4V29ybGQodCkgewogICAgaWYgKHN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKHQpLCB0aGlzLmhhc1BsYXliYWNrQ29udHJvbCA9PT0gITAgJiYgdGhpcy5pc1BsYXlpbmcgPT09ICExKSByZXR1cm47CiAgICB0aGlzLm1hdHJpeFdvcmxkLmRlY29tcG9zZShZcywgRW0sIHRNKSwgWnMuc2V0KDAsIDAsIDEpLmFwcGx5UXVhdGVybmlvbihFbSk7CiAgICBjb25zdCBlID0gdGhpcy5wYW5uZXI7CiAgICBpZiAoZS5wb3NpdGlvblgpIHsKICAgICAgY29uc3QgaSA9IHRoaXMuY29udGV4dC5jdXJyZW50VGltZSArIHRoaXMubGlzdGVuZXIudGltZURlbHRhOwogICAgICBlLnBvc2l0aW9uWC5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZShZcy54LCBpKSwgZS5wb3NpdGlvblkubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoWXMueSwgaSksIGUucG9zaXRpb25aLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKFlzLnosIGkpLCBlLm9yaWVudGF0aW9uWC5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZShacy54LCBpKSwgZS5vcmllbnRhdGlvblkubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoWnMueSwgaSksIGUub3JpZW50YXRpb25aLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKFpzLnosIGkpOwogICAgfSBlbHNlCiAgICAgIGUuc2V0UG9zaXRpb24oWXMueCwgWXMueSwgWXMueiksIGUuc2V0T3JpZW50YXRpb24oWnMueCwgWnMueSwgWnMueik7CiAgfQp9CmNsYXNzIGlNIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGF1ZGlvIGFuYWx5emVyLgogICAqCiAgICogQHBhcmFtIHtBdWRpb30gYXVkaW8gLSBUaGUgYXVkaW8gdG8gYW5hbHl6ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2ZmdFNpemU9MjA0OF0gLSBUaGUgd2luZG93IHNpemUgaW4gc2FtcGxlcyB0aGF0IGlzIHVzZWQgd2hlbiBwZXJmb3JtaW5nIGEgRmFzdCBGb3VyaWVyIFRyYW5zZm9ybSAoRkZUKSB0byBnZXQgZnJlcXVlbmN5IGRvbWFpbiBkYXRhLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUgPSAyMDQ4KSB7CiAgICB0aGlzLmFuYWx5c2VyID0gdC5jb250ZXh0LmNyZWF0ZUFuYWx5c2VyKCksIHRoaXMuYW5hbHlzZXIuZmZ0U2l6ZSA9IGUsIHRoaXMuZGF0YSA9IG5ldyBVaW50OEFycmF5KHRoaXMuYW5hbHlzZXIuZnJlcXVlbmN5QmluQ291bnQpLCB0LmdldE91dHB1dCgpLmNvbm5lY3QodGhpcy5hbmFseXNlcik7CiAgfQogIC8qKgogICAqIFJldHVybnMgYW4gYXJyYXkgd2l0aCBmcmVxdWVuY3kgZGF0YSBvZiB0aGUgYXVkaW8uCiAgICoKICAgKiBFYWNoIGl0ZW0gaW4gdGhlIGFycmF5IHJlcHJlc2VudHMgdGhlIGRlY2liZWwgdmFsdWUgZm9yIGEgc3BlY2lmaWMgZnJlcXVlbmN5LgogICAqIFRoZSBmcmVxdWVuY2llcyBhcmUgc3ByZWFkIGxpbmVhcmx5IGZyb20gMCB0byAxLzIgb2YgdGhlIHNhbXBsZSByYXRlLgogICAqIEZvciBleGFtcGxlLCBmb3IgNDgwMDAgc2FtcGxlIHJhdGUsIHRoZSBsYXN0IGl0ZW0gb2YgdGhlIGFycmF5IHdpbGwgcmVwcmVzZW50CiAgICogdGhlIGRlY2liZWwgdmFsdWUgZm9yIDI0MDAwIEh6LgogICAqCiAgICogQHJldHVybiB7VWludDhBcnJheX0gVGhlIGZyZXF1ZW5jeSBkYXRhLgogICAqLwogIGdldEZyZXF1ZW5jeURhdGEoKSB7CiAgICByZXR1cm4gdGhpcy5hbmFseXNlci5nZXRCeXRlRnJlcXVlbmN5RGF0YSh0aGlzLmRhdGEpLCB0aGlzLmRhdGE7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGF2ZXJhZ2Ugb2YgdGhlIGZyZXF1ZW5jaWVzIHJldHVybmVkIGJ5IHtAbGluayBBdWRpb0FuYWx5c2VyI2dldEZyZXF1ZW5jeURhdGF9LgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYXZlcmFnZSBmcmVxdWVuY3kuCiAgICovCiAgZ2V0QXZlcmFnZUZyZXF1ZW5jeSgpIHsKICAgIGxldCB0ID0gMDsKICAgIGNvbnN0IGUgPSB0aGlzLmdldEZyZXF1ZW5jeURhdGEoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZS5sZW5ndGg7IGkrKykKICAgICAgdCArPSBlW2ldOwogICAgcmV0dXJuIHQgLyBlLmxlbmd0aDsKICB9Cn0KY2xhc3MgbV8gewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgcHJvcGVydHkgbWl4ZXIuCiAgICoKICAgKiBAcGFyYW0ge1Byb3BlcnR5QmluZGluZ30gYmluZGluZyAtIFRoZSBwcm9wZXJ0eSBiaW5kaW5nLgogICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlTmFtZSAtIFRoZSBrZXlmcmFtZSB0cmFjayB0eXBlIG5hbWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlU2l6ZSAtIFRoZSBrZXlmcmFtZSB0cmFjayB2YWx1ZSBzaXplLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHRoaXMuYmluZGluZyA9IHQsIHRoaXMudmFsdWVTaXplID0gaTsKICAgIGxldCBuLCBzLCByOwogICAgc3dpdGNoIChlKSB7CiAgICAgIGNhc2UgInF1YXRlcm5pb24iOgogICAgICAgIG4gPSB0aGlzLl9zbGVycCwgcyA9IHRoaXMuX3NsZXJwQWRkaXRpdmUsIHIgPSB0aGlzLl9zZXRBZGRpdGl2ZUlkZW50aXR5UXVhdGVybmlvbiwgdGhpcy5idWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KGkgKiA2KSwgdGhpcy5fd29ya0luZGV4ID0gNTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgY2FzZSAiYm9vbCI6CiAgICAgICAgbiA9IHRoaXMuX3NlbGVjdCwgcyA9IHRoaXMuX3NlbGVjdCwgciA9IHRoaXMuX3NldEFkZGl0aXZlSWRlbnRpdHlPdGhlciwgdGhpcy5idWZmZXIgPSBuZXcgQXJyYXkoaSAqIDUpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIG4gPSB0aGlzLl9sZXJwLCBzID0gdGhpcy5fbGVycEFkZGl0aXZlLCByID0gdGhpcy5fc2V0QWRkaXRpdmVJZGVudGl0eU51bWVyaWMsIHRoaXMuYnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShpICogNSk7CiAgICB9CiAgICB0aGlzLl9taXhCdWZmZXJSZWdpb24gPSBuLCB0aGlzLl9taXhCdWZmZXJSZWdpb25BZGRpdGl2ZSA9IHMsIHRoaXMuX3NldElkZW50aXR5ID0gciwgdGhpcy5fb3JpZ0luZGV4ID0gMywgdGhpcy5fYWRkSW5kZXggPSA0LCB0aGlzLmN1bXVsYXRpdmVXZWlnaHQgPSAwLCB0aGlzLmN1bXVsYXRpdmVXZWlnaHRBZGRpdGl2ZSA9IDAsIHRoaXMudXNlQ291bnQgPSAwLCB0aGlzLnJlZmVyZW5jZUNvdW50ID0gMDsKICB9CiAgLyoqCiAgICogQWNjdW11bGF0ZXMgZGF0YSBpbiB0aGUgYGluY29taW5nYCByZWdpb24gaW50byBgYWNjdTxpPmAuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYWNjdUluZGV4IC0gVGhlIGFjY3VtdWxhdGlvbiBpbmRleC4KICAgKiBAcGFyYW0ge251bWJlcn0gd2VpZ2h0IC0gVGhlIHdlaWdodC4KICAgKi8KICBhY2N1bXVsYXRlKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmJ1ZmZlciwgbiA9IHRoaXMudmFsdWVTaXplLCBzID0gdCAqIG4gKyBuOwogICAgbGV0IHIgPSB0aGlzLmN1bXVsYXRpdmVXZWlnaHQ7CiAgICBpZiAociA9PT0gMCkgewogICAgICBmb3IgKGxldCBvID0gMDsgbyAhPT0gbjsgKytvKQogICAgICAgIGlbcyArIG9dID0gaVtvXTsKICAgICAgciA9IGU7CiAgICB9IGVsc2UgewogICAgICByICs9IGU7CiAgICAgIGNvbnN0IG8gPSBlIC8gcjsKICAgICAgdGhpcy5fbWl4QnVmZmVyUmVnaW9uKGksIHMsIDAsIG8sIG4pOwogICAgfQogICAgdGhpcy5jdW11bGF0aXZlV2VpZ2h0ID0gcjsKICB9CiAgLyoqCiAgICogQWNjdW11bGF0ZXMgZGF0YSBpbiB0aGUgYGluY29taW5nYCByZWdpb24gaW50byBgYWRkYC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB3ZWlnaHQgLSBUaGUgd2VpZ2h0LgogICAqLwogIGFjY3VtdWxhdGVBZGRpdGl2ZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5idWZmZXIsIGkgPSB0aGlzLnZhbHVlU2l6ZSwgbiA9IGkgKiB0aGlzLl9hZGRJbmRleDsKICAgIHRoaXMuY3VtdWxhdGl2ZVdlaWdodEFkZGl0aXZlID09PSAwICYmIHRoaXMuX3NldElkZW50aXR5KCksIHRoaXMuX21peEJ1ZmZlclJlZ2lvbkFkZGl0aXZlKGUsIG4sIDAsIHQsIGkpLCB0aGlzLmN1bXVsYXRpdmVXZWlnaHRBZGRpdGl2ZSArPSB0OwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBzdGF0ZSBvZiBgYWNjdTxpPmAgdG8gdGhlIGJpbmRpbmcgd2hlbiBhY2N1cyBkaWZmZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYWNjdUluZGV4IC0gVGhlIGFjY3VtdWxhdGlvbiBpbmRleC4KICAgKi8KICBhcHBseSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy52YWx1ZVNpemUsIGkgPSB0aGlzLmJ1ZmZlciwgbiA9IHQgKiBlICsgZSwgcyA9IHRoaXMuY3VtdWxhdGl2ZVdlaWdodCwgciA9IHRoaXMuY3VtdWxhdGl2ZVdlaWdodEFkZGl0aXZlLCBvID0gdGhpcy5iaW5kaW5nOwogICAgaWYgKHRoaXMuY3VtdWxhdGl2ZVdlaWdodCA9IDAsIHRoaXMuY3VtdWxhdGl2ZVdlaWdodEFkZGl0aXZlID0gMCwgcyA8IDEpIHsKICAgICAgY29uc3QgbCA9IGUgKiB0aGlzLl9vcmlnSW5kZXg7CiAgICAgIHRoaXMuX21peEJ1ZmZlclJlZ2lvbigKICAgICAgICBpLAogICAgICAgIG4sCiAgICAgICAgbCwKICAgICAgICAxIC0gcywKICAgICAgICBlCiAgICAgICk7CiAgICB9CiAgICByID4gMCAmJiB0aGlzLl9taXhCdWZmZXJSZWdpb25BZGRpdGl2ZShpLCBuLCB0aGlzLl9hZGRJbmRleCAqIGUsIDEsIGUpOwogICAgZm9yIChsZXQgbCA9IGUsIGggPSBlICsgZTsgbCAhPT0gaDsgKytsKQogICAgICBpZiAoaVtsXSAhPT0gaVtsICsgZV0pIHsKICAgICAgICBvLnNldFZhbHVlKGksIG4pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgfQogIC8qKgogICAqIFJlbWVtYmVycyB0aGUgc3RhdGUgb2YgdGhlIGJvdW5kIHByb3BlcnR5IGFuZCBjb3B5IGl0IHRvIGJvdGggYWNjdXMuCiAgICovCiAgc2F2ZU9yaWdpbmFsU3RhdGUoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5iaW5kaW5nLCBlID0gdGhpcy5idWZmZXIsIGkgPSB0aGlzLnZhbHVlU2l6ZSwgbiA9IGkgKiB0aGlzLl9vcmlnSW5kZXg7CiAgICB0LmdldFZhbHVlKGUsIG4pOwogICAgZm9yIChsZXQgcyA9IGksIHIgPSBuOyBzICE9PSByOyArK3MpCiAgICAgIGVbc10gPSBlW24gKyBzICUgaV07CiAgICB0aGlzLl9zZXRJZGVudGl0eSgpLCB0aGlzLmN1bXVsYXRpdmVXZWlnaHQgPSAwLCB0aGlzLmN1bXVsYXRpdmVXZWlnaHRBZGRpdGl2ZSA9IDA7CiAgfQogIC8qKgogICAqIEFwcGxpZXMgdGhlIHN0YXRlIHByZXZpb3VzbHkgdGFrZW4gdmlhIHtAbGluayBQcm9wZXJ0eU1peGVyI3NhdmVPcmlnaW5hbFN0YXRlfSB0byB0aGUgYmluZGluZy4KICAgKi8KICByZXN0b3JlT3JpZ2luYWxTdGF0ZSgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLnZhbHVlU2l6ZSAqIDM7CiAgICB0aGlzLmJpbmRpbmcuc2V0VmFsdWUodGhpcy5idWZmZXIsIHQpOwogIH0KICAvLyBpbnRlcm5hbHMKICBfc2V0QWRkaXRpdmVJZGVudGl0eU51bWVyaWMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5fYWRkSW5kZXggKiB0aGlzLnZhbHVlU2l6ZSwgZSA9IHQgKyB0aGlzLnZhbHVlU2l6ZTsKICAgIGZvciAobGV0IGkgPSB0OyBpIDwgZTsgaSsrKQogICAgICB0aGlzLmJ1ZmZlcltpXSA9IDA7CiAgfQogIF9zZXRBZGRpdGl2ZUlkZW50aXR5UXVhdGVybmlvbigpIHsKICAgIHRoaXMuX3NldEFkZGl0aXZlSWRlbnRpdHlOdW1lcmljKCksIHRoaXMuYnVmZmVyW3RoaXMuX2FkZEluZGV4ICogdGhpcy52YWx1ZVNpemUgKyAzXSA9IDE7CiAgfQogIF9zZXRBZGRpdGl2ZUlkZW50aXR5T3RoZXIoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5fb3JpZ0luZGV4ICogdGhpcy52YWx1ZVNpemUsIGUgPSB0aGlzLl9hZGRJbmRleCAqIHRoaXMudmFsdWVTaXplOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnZhbHVlU2l6ZTsgaSsrKQogICAgICB0aGlzLmJ1ZmZlcltlICsgaV0gPSB0aGlzLmJ1ZmZlclt0ICsgaV07CiAgfQogIC8vIG1peCBmdW5jdGlvbnMKICBfc2VsZWN0KHQsIGUsIGksIG4sIHMpIHsKICAgIGlmIChuID49IDAuNSkKICAgICAgZm9yIChsZXQgciA9IDA7IHIgIT09IHM7ICsrcikKICAgICAgICB0W2UgKyByXSA9IHRbaSArIHJdOwogIH0KICBfc2xlcnAodCwgZSwgaSwgbikgewogICAgdmUuc2xlcnBGbGF0KHQsIGUsIHQsIGUsIHQsIGksIG4pOwogIH0KICBfc2xlcnBBZGRpdGl2ZSh0LCBlLCBpLCBuLCBzKSB7CiAgICBjb25zdCByID0gdGhpcy5fd29ya0luZGV4ICogczsKICAgIHZlLm11bHRpcGx5UXVhdGVybmlvbnNGbGF0KHQsIHIsIHQsIGUsIHQsIGkpLCB2ZS5zbGVycEZsYXQodCwgZSwgdCwgZSwgdCwgciwgbik7CiAgfQogIF9sZXJwKHQsIGUsIGksIG4sIHMpIHsKICAgIGNvbnN0IHIgPSAxIC0gbjsKICAgIGZvciAobGV0IG8gPSAwOyBvICE9PSBzOyArK28pIHsKICAgICAgY29uc3QgbCA9IGUgKyBvOwogICAgICB0W2xdID0gdFtsXSAqIHIgKyB0W2kgKyBvXSAqIG47CiAgICB9CiAgfQogIF9sZXJwQWRkaXRpdmUodCwgZSwgaSwgbiwgcykgewogICAgZm9yIChsZXQgciA9IDA7IHIgIT09IHM7ICsrcikgewogICAgICBjb25zdCBvID0gZSArIHI7CiAgICAgIHRbb10gPSB0W29dICsgdFtpICsgcl0gKiBuOwogICAgfQogIH0KfQpjb25zdCBoZiA9ICJcXFtcXF1cXC46XFwvIiwgbk0gPSBuZXcgUmVnRXhwKCJbIiArIGhmICsgIl0iLCAiZyIpLCBjZiA9ICJbXiIgKyBoZiArICJdIiwgc00gPSAiW14iICsgaGYucmVwbGFjZSgiXFwuIiwgIiIpICsgIl0iLCByTSA9IC8qIEBfX1BVUkVfXyAqLyAvKCg/OldDK1tcLzpdKSopLy5zb3VyY2UucmVwbGFjZSgiV0MiLCBjZiksIGFNID0gLyogQF9fUFVSRV9fICovIC8oV0NPRCspPy8uc291cmNlLnJlcGxhY2UoIldDT0QiLCBzTSksIG9NID0gLyogQF9fUFVSRV9fICovIC8oPzpcLihXQyspKD86XFsoLispXF0pPyk/Ly5zb3VyY2UucmVwbGFjZSgiV0MiLCBjZiksIGxNID0gLyogQF9fUFVSRV9fICovIC9cLihXQyspKD86XFsoLispXF0pPy8uc291cmNlLnJlcGxhY2UoIldDIiwgY2YpLCBoTSA9IG5ldyBSZWdFeHAoCiAgIl4iICsgck0gKyBhTSArIG9NICsgbE0gKyAiJCIKKSwgY00gPSBbIm1hdGVyaWFsIiwgIm1hdGVyaWFscyIsICJib25lcyIsICJtYXAiXTsKY2xhc3MgdU0gewogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBpIHx8IHNlLnBhcnNlVHJhY2tOYW1lKGUpOwogICAgdGhpcy5fdGFyZ2V0R3JvdXAgPSB0LCB0aGlzLl9iaW5kaW5ncyA9IHQuc3Vic2NyaWJlXyhlLCBuKTsKICB9CiAgZ2V0VmFsdWUodCwgZSkgewogICAgdGhpcy5iaW5kKCk7CiAgICBjb25zdCBpID0gdGhpcy5fdGFyZ2V0R3JvdXAubkNhY2hlZE9iamVjdHNfLCBuID0gdGhpcy5fYmluZGluZ3NbaV07CiAgICBuICE9PSB2b2lkIDAgJiYgbi5nZXRWYWx1ZSh0LCBlKTsKICB9CiAgc2V0VmFsdWUodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuX2JpbmRpbmdzOwogICAgZm9yIChsZXQgbiA9IHRoaXMuX3RhcmdldEdyb3VwLm5DYWNoZWRPYmplY3RzXywgcyA9IGkubGVuZ3RoOyBuICE9PSBzOyArK24pCiAgICAgIGlbbl0uc2V0VmFsdWUodCwgZSk7CiAgfQogIGJpbmQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5fYmluZGluZ3M7CiAgICBmb3IgKGxldCBlID0gdGhpcy5fdGFyZ2V0R3JvdXAubkNhY2hlZE9iamVjdHNfLCBpID0gdC5sZW5ndGg7IGUgIT09IGk7ICsrZSkKICAgICAgdFtlXS5iaW5kKCk7CiAgfQogIHVuYmluZCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLl9iaW5kaW5nczsKICAgIGZvciAobGV0IGUgPSB0aGlzLl90YXJnZXRHcm91cC5uQ2FjaGVkT2JqZWN0c18sIGkgPSB0Lmxlbmd0aDsgZSAhPT0gaTsgKytlKQogICAgICB0W2VdLnVuYmluZCgpOwogIH0KfQpjbGFzcyBzZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwcm9wZXJ0eSBiaW5kaW5nLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IHJvb3ROb2RlIC0gVGhlIHJvb3Qgbm9kZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoLgogICAqIEBwYXJhbSB7P09iamVjdH0gW3BhcnNlZFBhdGhdIC0gVGhlIHBhcnNlZCBwYXRoLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHRoaXMucGF0aCA9IGUsIHRoaXMucGFyc2VkUGF0aCA9IGkgfHwgc2UucGFyc2VUcmFja05hbWUoZSksIHRoaXMubm9kZSA9IHNlLmZpbmROb2RlKHQsIHRoaXMucGFyc2VkUGF0aC5ub2RlTmFtZSksIHRoaXMucm9vdE5vZGUgPSB0LCB0aGlzLmdldFZhbHVlID0gdGhpcy5fZ2V0VmFsdWVfdW5ib3VuZCwgdGhpcy5zZXRWYWx1ZSA9IHRoaXMuX3NldFZhbHVlX3VuYm91bmQ7CiAgfQogIC8qKgogICAqIEZhY3RvcnkgbWV0aG9kIGZvciBjcmVhdGluZyBhIHByb3BlcnR5IGJpbmRpbmcgZnJvbSB0aGUgZ2l2ZW4gcGFyYW1ldGVycy4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAcGFyYW0ge09iamVjdH0gcm9vdCAtIFRoZSByb290IG5vZGUuCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgcGF0aC4KICAgKiBAcGFyYW0gez9PYmplY3R9IFtwYXJzZWRQYXRoXSAtIFRoZSBwYXJzZWQgcGF0aC4KICAgKiBAcmV0dXJuIHtQcm9wZXJ0eUJpbmRpbmd8Q29tcG9zaXRlfSBUaGUgY3JlYXRlZCBwcm9wZXJ0eSBiaW5kaW5nIG9yIGNvbXBvc2l0ZS4KICAgKi8KICBzdGF0aWMgY3JlYXRlKHQsIGUsIGkpIHsKICAgIHJldHVybiB0ICYmIHQuaXNBbmltYXRpb25PYmplY3RHcm91cCA/IG5ldyBzZS5Db21wb3NpdGUodCwgZSwgaSkgOiBuZXcgc2UodCwgZSwgaSk7CiAgfQogIC8qKgogICAqIFJlcGxhY2VzIHNwYWNlcyB3aXRoIHVuZGVyc2NvcmVzIGFuZCByZW1vdmVzIHVuc3VwcG9ydGVkIGNoYXJhY3RlcnMgZnJvbQogICAqIG5vZGUgbmFtZXMsIHRvIGVuc3VyZSBjb21wYXRpYmlsaXR5IHdpdGggcGFyc2VUcmFja05hbWUoKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gTm9kZSBuYW1lIHRvIGJlIHNhbml0aXplZC4KICAgKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBzYW5pdGl6ZWQgbm9kZSBuYW1lLgogICAqLwogIHN0YXRpYyBzYW5pdGl6ZU5vZGVOYW1lKHQpIHsKICAgIHJldHVybiB0LnJlcGxhY2UoL1xzL2csICJfIikucmVwbGFjZShuTSwgIiIpOwogIH0KICAvKioKICAgKiBQYXJzZXMgdGhlIGdpdmVuIHRyYWNrIG5hbWUgKGFuIG9iamVjdCBwYXRoIHRvIGFuIGFuaW1hdGVkIHByb3BlcnR5KSBhbmQKICAgKiByZXR1cm5zIGFuIG9iamVjdCB3aXRoIGluZm9ybWF0aW9uIGFib3V0IHRoZSBwYXRoLiBNYXRjaGVzIHN0cmluZ3MgaW4gdGhlIGZvbGxvd2luZyBmb3JtczoKICAgKgogICAqIC0gbm9kZU5hbWUucHJvcGVydHkKICAgKiAtIG5vZGVOYW1lLnByb3BlcnR5W2FjY2Vzc29yXQogICAqIC0gbm9kZU5hbWUubWF0ZXJpYWwucHJvcGVydHlbYWNjZXNzb3JdCiAgICogLSB1dWlkLnByb3BlcnR5W2FjY2Vzc29yXQogICAqIC0gdXVpZC5vYmplY3ROYW1lW29iamVjdEluZGV4XS5wcm9wZXJ0eU5hbWVbcHJvcGVydHlJbmRleF0KICAgKiAtIHBhcmVudE5hbWUvbm9kZU5hbWUucHJvcGVydHkKICAgKiAtIHBhcmVudE5hbWUvcGFyZW50TmFtZS9ub2RlTmFtZS5wcm9wZXJ0eVtpbmRleF0KICAgKiAtIC5ib25lW0FybWF0dXJlLkRFRl9jb2ddLnBvc2l0aW9uCiAgICogLSBzY2VuZTpoZWxpdW1fYmFsbG9vbl9tb2RlbDpoZWxpdW1fYmFsbG9vbl9tb2RlbC5wb3NpdGlvbgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7c3RyaW5nfSB0cmFja05hbWUgLSBUaGUgdHJhY2sgbmFtZSB0byBwYXJzZS4KICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBwYXJzZWQgdHJhY2sgbmFtZSBhcyBhbiBvYmplY3QuCiAgICovCiAgc3RhdGljIHBhcnNlVHJhY2tOYW1lKHQpIHsKICAgIGNvbnN0IGUgPSBoTS5leGVjKHQpOwogICAgaWYgKGUgPT09IG51bGwpCiAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvcGVydHlCaW5kaW5nOiBDYW5ub3QgcGFyc2UgdHJhY2tOYW1lOiAiICsgdCk7CiAgICBjb25zdCBpID0gewogICAgICAvLyBkaXJlY3RvcnlOYW1lOiBtYXRjaGVzWyAxIF0sIC8vICh0c2NodykgY3VycmVudGx5IHVudXNlZAogICAgICBub2RlTmFtZTogZVsyXSwKICAgICAgb2JqZWN0TmFtZTogZVszXSwKICAgICAgb2JqZWN0SW5kZXg6IGVbNF0sCiAgICAgIHByb3BlcnR5TmFtZTogZVs1XSwKICAgICAgLy8gcmVxdWlyZWQKICAgICAgcHJvcGVydHlJbmRleDogZVs2XQogICAgfSwgbiA9IGkubm9kZU5hbWUgJiYgaS5ub2RlTmFtZS5sYXN0SW5kZXhPZigiLiIpOwogICAgaWYgKG4gIT09IHZvaWQgMCAmJiBuICE9PSAtMSkgewogICAgICBjb25zdCBzID0gaS5ub2RlTmFtZS5zdWJzdHJpbmcobiArIDEpOwogICAgICBjTS5pbmRleE9mKHMpICE9PSAtMSAmJiAoaS5ub2RlTmFtZSA9IGkubm9kZU5hbWUuc3Vic3RyaW5nKDAsIG4pLCBpLm9iamVjdE5hbWUgPSBzKTsKICAgIH0KICAgIGlmIChpLnByb3BlcnR5TmFtZSA9PT0gbnVsbCB8fCBpLnByb3BlcnR5TmFtZS5sZW5ndGggPT09IDApCiAgICAgIHRocm93IG5ldyBFcnJvcigiUHJvcGVydHlCaW5kaW5nOiBjYW4gbm90IHBhcnNlIHByb3BlcnR5TmFtZSBmcm9tIHRyYWNrTmFtZTogIiArIHQpOwogICAgcmV0dXJuIGk7CiAgfQogIC8qKgogICAqIFNlYXJjaGVzIGZvciBhIG5vZGUgaW4gdGhlIGhpZXJhcmNoeSBvZiB0aGUgZ2l2ZW4gcm9vdCBvYmplY3QgYnkgdGhlIGdpdmVuCiAgICogbm9kZSBuYW1lLgogICAqCiAgICogQHN0YXRpYwogICAqIEBwYXJhbSB7T2JqZWN0fSByb290IC0gVGhlIHJvb3Qgb2JqZWN0LgogICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbm9kZU5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgbm9kZS4KICAgKiBAcmV0dXJuIHs/T2JqZWN0fSBUaGUgZm91bmQgbm9kZS4gUmV0dXJucyBgbnVsbGAgaWYgbm8gb2JqZWN0IHdhcyBmb3VuZC4KICAgKi8KICBzdGF0aWMgZmluZE5vZGUodCwgZSkgewogICAgaWYgKGUgPT09IHZvaWQgMCB8fCBlID09PSAiIiB8fCBlID09PSAiLiIgfHwgZSA9PT0gLTEgfHwgZSA9PT0gdC5uYW1lIHx8IGUgPT09IHQudXVpZCkKICAgICAgcmV0dXJuIHQ7CiAgICBpZiAodC5za2VsZXRvbikgewogICAgICBjb25zdCBpID0gdC5za2VsZXRvbi5nZXRCb25lQnlOYW1lKGUpOwogICAgICBpZiAoaSAhPT0gdm9pZCAwKQogICAgICAgIHJldHVybiBpOwogICAgfQogICAgaWYgKHQuY2hpbGRyZW4pIHsKICAgICAgY29uc3QgaSA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICBmb3IgKGxldCByID0gMDsgciA8IHMubGVuZ3RoOyByKyspIHsKICAgICAgICAgIGNvbnN0IG8gPSBzW3JdOwogICAgICAgICAgaWYgKG8ubmFtZSA9PT0gZSB8fCBvLnV1aWQgPT09IGUpCiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgICAgY29uc3QgbCA9IGkoby5jaGlsZHJlbik7CiAgICAgICAgICBpZiAobCkgcmV0dXJuIGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LCBuID0gaSh0LmNoaWxkcmVuKTsKICAgICAgaWYgKG4pCiAgICAgICAgcmV0dXJuIG47CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgLy8gdGhlc2UgYXJlIHVzZWQgdG8gImJpbmQiIGEgbm9uZXhpc3RlbnQgcHJvcGVydHkKICBfZ2V0VmFsdWVfdW5hdmFpbGFibGUoKSB7CiAgfQogIF9zZXRWYWx1ZV91bmF2YWlsYWJsZSgpIHsKICB9CiAgLy8gR2V0dGVycwogIF9nZXRWYWx1ZV9kaXJlY3QodCwgZSkgewogICAgdFtlXSA9IHRoaXMudGFyZ2V0T2JqZWN0W3RoaXMucHJvcGVydHlOYW1lXTsKICB9CiAgX2dldFZhbHVlX2FycmF5KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLnJlc29sdmVkUHJvcGVydHk7CiAgICBmb3IgKGxldCBuID0gMCwgcyA9IGkubGVuZ3RoOyBuICE9PSBzOyArK24pCiAgICAgIHRbZSsrXSA9IGlbbl07CiAgfQogIF9nZXRWYWx1ZV9hcnJheUVsZW1lbnQodCwgZSkgewogICAgdFtlXSA9IHRoaXMucmVzb2x2ZWRQcm9wZXJ0eVt0aGlzLnByb3BlcnR5SW5kZXhdOwogIH0KICBfZ2V0VmFsdWVfdG9BcnJheSh0LCBlKSB7CiAgICB0aGlzLnJlc29sdmVkUHJvcGVydHkudG9BcnJheSh0LCBlKTsKICB9CiAgLy8gRGlyZWN0CiAgX3NldFZhbHVlX2RpcmVjdCh0LCBlKSB7CiAgICB0aGlzLnRhcmdldE9iamVjdFt0aGlzLnByb3BlcnR5TmFtZV0gPSB0W2VdOwogIH0KICBfc2V0VmFsdWVfZGlyZWN0X3NldE5lZWRzVXBkYXRlKHQsIGUpIHsKICAgIHRoaXMudGFyZ2V0T2JqZWN0W3RoaXMucHJvcGVydHlOYW1lXSA9IHRbZV0sIHRoaXMudGFyZ2V0T2JqZWN0Lm5lZWRzVXBkYXRlID0gITA7CiAgfQogIF9zZXRWYWx1ZV9kaXJlY3Rfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZSh0LCBlKSB7CiAgICB0aGlzLnRhcmdldE9iamVjdFt0aGlzLnByb3BlcnR5TmFtZV0gPSB0W2VdLCB0aGlzLnRhcmdldE9iamVjdC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gITA7CiAgfQogIC8vIEVudGlyZUFycmF5CiAgX3NldFZhbHVlX2FycmF5KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLnJlc29sdmVkUHJvcGVydHk7CiAgICBmb3IgKGxldCBuID0gMCwgcyA9IGkubGVuZ3RoOyBuICE9PSBzOyArK24pCiAgICAgIGlbbl0gPSB0W2UrK107CiAgfQogIF9zZXRWYWx1ZV9hcnJheV9zZXROZWVkc1VwZGF0ZSh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5yZXNvbHZlZFByb3BlcnR5OwogICAgZm9yIChsZXQgbiA9IDAsIHMgPSBpLmxlbmd0aDsgbiAhPT0gczsgKytuKQogICAgICBpW25dID0gdFtlKytdOwogICAgdGhpcy50YXJnZXRPYmplY3QubmVlZHNVcGRhdGUgPSAhMDsKICB9CiAgX3NldFZhbHVlX2FycmF5X3NldE1hdHJpeFdvcmxkTmVlZHNVcGRhdGUodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMucmVzb2x2ZWRQcm9wZXJ0eTsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gaS5sZW5ndGg7IG4gIT09IHM7ICsrbikKICAgICAgaVtuXSA9IHRbZSsrXTsKICAgIHRoaXMudGFyZ2V0T2JqZWN0Lm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSAhMDsKICB9CiAgLy8gQXJyYXlFbGVtZW50CiAgX3NldFZhbHVlX2FycmF5RWxlbWVudCh0LCBlKSB7CiAgICB0aGlzLnJlc29sdmVkUHJvcGVydHlbdGhpcy5wcm9wZXJ0eUluZGV4XSA9IHRbZV07CiAgfQogIF9zZXRWYWx1ZV9hcnJheUVsZW1lbnRfc2V0TmVlZHNVcGRhdGUodCwgZSkgewogICAgdGhpcy5yZXNvbHZlZFByb3BlcnR5W3RoaXMucHJvcGVydHlJbmRleF0gPSB0W2VdLCB0aGlzLnRhcmdldE9iamVjdC5uZWVkc1VwZGF0ZSA9ICEwOwogIH0KICBfc2V0VmFsdWVfYXJyYXlFbGVtZW50X3NldE1hdHJpeFdvcmxkTmVlZHNVcGRhdGUodCwgZSkgewogICAgdGhpcy5yZXNvbHZlZFByb3BlcnR5W3RoaXMucHJvcGVydHlJbmRleF0gPSB0W2VdLCB0aGlzLnRhcmdldE9iamVjdC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gITA7CiAgfQogIC8vIEhhc1RvRnJvbUFycmF5CiAgX3NldFZhbHVlX2Zyb21BcnJheSh0LCBlKSB7CiAgICB0aGlzLnJlc29sdmVkUHJvcGVydHkuZnJvbUFycmF5KHQsIGUpOwogIH0KICBfc2V0VmFsdWVfZnJvbUFycmF5X3NldE5lZWRzVXBkYXRlKHQsIGUpIHsKICAgIHRoaXMucmVzb2x2ZWRQcm9wZXJ0eS5mcm9tQXJyYXkodCwgZSksIHRoaXMudGFyZ2V0T2JqZWN0Lm5lZWRzVXBkYXRlID0gITA7CiAgfQogIF9zZXRWYWx1ZV9mcm9tQXJyYXlfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZSh0LCBlKSB7CiAgICB0aGlzLnJlc29sdmVkUHJvcGVydHkuZnJvbUFycmF5KHQsIGUpLCB0aGlzLnRhcmdldE9iamVjdC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gITA7CiAgfQogIF9nZXRWYWx1ZV91bmJvdW5kKHQsIGUpIHsKICAgIHRoaXMuYmluZCgpLCB0aGlzLmdldFZhbHVlKHQsIGUpOwogIH0KICBfc2V0VmFsdWVfdW5ib3VuZCh0LCBlKSB7CiAgICB0aGlzLmJpbmQoKSwgdGhpcy5zZXRWYWx1ZSh0LCBlKTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIGdldHRlciAvIHNldHRlciBwYWlyIGZvciB0aGUgcHJvcGVydHkgdHJhY2tlZCBieSB0aGlzIGJpbmRpbmcuCiAgICovCiAgYmluZCgpIHsKICAgIGxldCB0ID0gdGhpcy5ub2RlOwogICAgY29uc3QgZSA9IHRoaXMucGFyc2VkUGF0aCwgaSA9IGUub2JqZWN0TmFtZSwgbiA9IGUucHJvcGVydHlOYW1lOwogICAgbGV0IHMgPSBlLnByb3BlcnR5SW5kZXg7CiAgICBpZiAodCB8fCAodCA9IHNlLmZpbmROb2RlKHRoaXMucm9vdE5vZGUsIGUubm9kZU5hbWUpLCB0aGlzLm5vZGUgPSB0KSwgdGhpcy5nZXRWYWx1ZSA9IHRoaXMuX2dldFZhbHVlX3VuYXZhaWxhYmxlLCB0aGlzLnNldFZhbHVlID0gdGhpcy5fc2V0VmFsdWVfdW5hdmFpbGFibGUsICF0KSB7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuUHJvcGVydHlCaW5kaW5nOiBObyB0YXJnZXQgbm9kZSBmb3VuZCBmb3IgdHJhY2s6ICIgKyB0aGlzLnBhdGggKyAiLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoaSkgewogICAgICBsZXQgaCA9IGUub2JqZWN0SW5kZXg7CiAgICAgIHN3aXRjaCAoaSkgewogICAgICAgIGNhc2UgIm1hdGVyaWFscyI6CiAgICAgICAgICBpZiAoIXQubWF0ZXJpYWwpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuUHJvcGVydHlCaW5kaW5nOiBDYW4gbm90IGJpbmQgdG8gbWF0ZXJpYWwgYXMgbm9kZSBkb2VzIG5vdCBoYXZlIGEgbWF0ZXJpYWwuIiwgdGhpcyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghdC5tYXRlcmlhbC5tYXRlcmlhbHMpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuUHJvcGVydHlCaW5kaW5nOiBDYW4gbm90IGJpbmQgdG8gbWF0ZXJpYWwubWF0ZXJpYWxzIGFzIG5vZGUubWF0ZXJpYWwgZG9lcyBub3QgaGF2ZSBhIG1hdGVyaWFscyBhcnJheS4iLCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdCA9IHQubWF0ZXJpYWwubWF0ZXJpYWxzOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiYm9uZXMiOgogICAgICAgICAgaWYgKCF0LnNrZWxldG9uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIGJvbmVzIGFzIG5vZGUgZG9lcyBub3QgaGF2ZSBhIHNrZWxldG9uLiIsIHRoaXMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0ID0gdC5za2VsZXRvbi5ib25lczsKICAgICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgdC5sZW5ndGg7IGMrKykKICAgICAgICAgICAgaWYgKHRbY10ubmFtZSA9PT0gaCkgewogICAgICAgICAgICAgIGggPSBjOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJtYXAiOgogICAgICAgICAgaWYgKCJtYXAiIGluIHQpIHsKICAgICAgICAgICAgdCA9IHQubWFwOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghdC5tYXRlcmlhbCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IENhbiBub3QgYmluZCB0byBtYXRlcmlhbCBhcyBub2RlIGRvZXMgbm90IGhhdmUgYSBtYXRlcmlhbC4iLCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0Lm1hdGVyaWFsLm1hcCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IENhbiBub3QgYmluZCB0byBtYXRlcmlhbC5tYXAgYXMgbm9kZS5tYXRlcmlhbCBkb2VzIG5vdCBoYXZlIGEgbWFwLiIsIHRoaXMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0ID0gdC5tYXRlcmlhbC5tYXA7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKHRbaV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IENhbiBub3QgYmluZCB0byBvYmplY3ROYW1lIG9mIG5vZGUgdW5kZWZpbmVkLiIsIHRoaXMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0ID0gdFtpXTsKICAgICAgfQogICAgICBpZiAoaCAhPT0gdm9pZCAwKSB7CiAgICAgICAgaWYgKHRbaF0gPT09IHZvaWQgMCkgewogICAgICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuUHJvcGVydHlCaW5kaW5nOiBUcnlpbmcgdG8gYmluZCB0byBvYmplY3RJbmRleCBvZiBvYmplY3ROYW1lLCBidXQgaXMgdW5kZWZpbmVkLiIsIHRoaXMsIHQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0ID0gdFtoXTsKICAgICAgfQogICAgfQogICAgY29uc3QgciA9IHRbbl07CiAgICBpZiAociA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGggPSBlLm5vZGVOYW1lOwogICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IFRyeWluZyB0byB1cGRhdGUgcHJvcGVydHkgZm9yIHRyYWNrOiAiICsgaCArICIuIiArIG4gKyAiIGJ1dCBpdCB3YXNuJ3QgZm91bmQuIiwgdCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBvID0gdGhpcy5WZXJzaW9uaW5nLk5vbmU7CiAgICB0aGlzLnRhcmdldE9iamVjdCA9IHQsIHQuaXNNYXRlcmlhbCA9PT0gITAgPyBvID0gdGhpcy5WZXJzaW9uaW5nLk5lZWRzVXBkYXRlIDogdC5pc09iamVjdDNEID09PSAhMCAmJiAobyA9IHRoaXMuVmVyc2lvbmluZy5NYXRyaXhXb3JsZE5lZWRzVXBkYXRlKTsKICAgIGxldCBsID0gdGhpcy5CaW5kaW5nVHlwZS5EaXJlY3Q7CiAgICBpZiAocyAhPT0gdm9pZCAwKSB7CiAgICAgIGlmIChuID09PSAibW9ycGhUYXJnZXRJbmZsdWVuY2VzIikgewogICAgICAgIGlmICghdC5nZW9tZXRyeSkgewogICAgICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuUHJvcGVydHlCaW5kaW5nOiBDYW4gbm90IGJpbmQgdG8gbW9ycGhUYXJnZXRJbmZsdWVuY2VzIGJlY2F1c2Ugbm9kZSBkb2VzIG5vdCBoYXZlIGEgZ2VvbWV0cnkuIiwgdGhpcyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICghdC5nZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIG1vcnBoVGFyZ2V0SW5mbHVlbmNlcyBiZWNhdXNlIG5vZGUgZG9lcyBub3QgaGF2ZSBhIGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy4iLCB0aGlzKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdC5tb3JwaFRhcmdldERpY3Rpb25hcnlbc10gIT09IHZvaWQgMCAmJiAocyA9IHQubW9ycGhUYXJnZXREaWN0aW9uYXJ5W3NdKTsKICAgICAgfQogICAgICBsID0gdGhpcy5CaW5kaW5nVHlwZS5BcnJheUVsZW1lbnQsIHRoaXMucmVzb2x2ZWRQcm9wZXJ0eSA9IHIsIHRoaXMucHJvcGVydHlJbmRleCA9IHM7CiAgICB9IGVsc2Ugci5mcm9tQXJyYXkgIT09IHZvaWQgMCAmJiByLnRvQXJyYXkgIT09IHZvaWQgMCA/IChsID0gdGhpcy5CaW5kaW5nVHlwZS5IYXNGcm9tVG9BcnJheSwgdGhpcy5yZXNvbHZlZFByb3BlcnR5ID0gcikgOiBBcnJheS5pc0FycmF5KHIpID8gKGwgPSB0aGlzLkJpbmRpbmdUeXBlLkVudGlyZUFycmF5LCB0aGlzLnJlc29sdmVkUHJvcGVydHkgPSByKSA6IHRoaXMucHJvcGVydHlOYW1lID0gbjsKICAgIHRoaXMuZ2V0VmFsdWUgPSB0aGlzLkdldHRlckJ5QmluZGluZ1R5cGVbbF0sIHRoaXMuc2V0VmFsdWUgPSB0aGlzLlNldHRlckJ5QmluZGluZ1R5cGVBbmRWZXJzaW9uaW5nW2xdW29dOwogIH0KICAvKioKICAgKiBVbmJpbmRzIHRoZSBwcm9wZXJ0eS4KICAgKi8KICB1bmJpbmQoKSB7CiAgICB0aGlzLm5vZGUgPSBudWxsLCB0aGlzLmdldFZhbHVlID0gdGhpcy5fZ2V0VmFsdWVfdW5ib3VuZCwgdGhpcy5zZXRWYWx1ZSA9IHRoaXMuX3NldFZhbHVlX3VuYm91bmQ7CiAgfQp9CnNlLkNvbXBvc2l0ZSA9IHVNOwpzZS5wcm90b3R5cGUuQmluZGluZ1R5cGUgPSB7CiAgRGlyZWN0OiAwLAogIEVudGlyZUFycmF5OiAxLAogIEFycmF5RWxlbWVudDogMiwKICBIYXNGcm9tVG9BcnJheTogMwp9OwpzZS5wcm90b3R5cGUuVmVyc2lvbmluZyA9IHsKICBOb25lOiAwLAogIE5lZWRzVXBkYXRlOiAxLAogIE1hdHJpeFdvcmxkTmVlZHNVcGRhdGU6IDIKfTsKc2UucHJvdG90eXBlLkdldHRlckJ5QmluZGluZ1R5cGUgPSBbCiAgc2UucHJvdG90eXBlLl9nZXRWYWx1ZV9kaXJlY3QsCiAgc2UucHJvdG90eXBlLl9nZXRWYWx1ZV9hcnJheSwKICBzZS5wcm90b3R5cGUuX2dldFZhbHVlX2FycmF5RWxlbWVudCwKICBzZS5wcm90b3R5cGUuX2dldFZhbHVlX3RvQXJyYXkKXTsKc2UucHJvdG90eXBlLlNldHRlckJ5QmluZGluZ1R5cGVBbmRWZXJzaW9uaW5nID0gWwogIFsKICAgIC8vIERpcmVjdAogICAgc2UucHJvdG90eXBlLl9zZXRWYWx1ZV9kaXJlY3QsCiAgICBzZS5wcm90b3R5cGUuX3NldFZhbHVlX2RpcmVjdF9zZXROZWVkc1VwZGF0ZSwKICAgIHNlLnByb3RvdHlwZS5fc2V0VmFsdWVfZGlyZWN0X3NldE1hdHJpeFdvcmxkTmVlZHNVcGRhdGUKICBdLAogIFsKICAgIC8vIEVudGlyZUFycmF5CiAgICBzZS5wcm90b3R5cGUuX3NldFZhbHVlX2FycmF5LAogICAgc2UucHJvdG90eXBlLl9zZXRWYWx1ZV9hcnJheV9zZXROZWVkc1VwZGF0ZSwKICAgIHNlLnByb3RvdHlwZS5fc2V0VmFsdWVfYXJyYXlfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZQogIF0sCiAgWwogICAgLy8gQXJyYXlFbGVtZW50CiAgICBzZS5wcm90b3R5cGUuX3NldFZhbHVlX2FycmF5RWxlbWVudCwKICAgIHNlLnByb3RvdHlwZS5fc2V0VmFsdWVfYXJyYXlFbGVtZW50X3NldE5lZWRzVXBkYXRlLAogICAgc2UucHJvdG90eXBlLl9zZXRWYWx1ZV9hcnJheUVsZW1lbnRfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZQogIF0sCiAgWwogICAgLy8gSGFzVG9Gcm9tQXJyYXkKICAgIHNlLnByb3RvdHlwZS5fc2V0VmFsdWVfZnJvbUFycmF5LAogICAgc2UucHJvdG90eXBlLl9zZXRWYWx1ZV9mcm9tQXJyYXlfc2V0TmVlZHNVcGRhdGUsCiAgICBzZS5wcm90b3R5cGUuX3NldFZhbHVlX2Zyb21BcnJheV9zZXRNYXRyaXhXb3JsZE5lZWRzVXBkYXRlCiAgXQpdOwpjbGFzcyBkTSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBhbmltYXRpb24gZ3JvdXAuCiAgICoKICAgKiBAcGFyYW0gey4uLk9iamVjdDNEfSBhcmd1bWVudHMgLSBBbiBhcmJpdHJhcnkgbnVtYmVyIG9mIDNEIG9iamVjdHMgdGhhdCBzaGFyZSB0aGUgc2FtZSBhbmltYXRpb24gc3RhdGUuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLmlzQW5pbWF0aW9uT2JqZWN0R3JvdXAgPSAhMCwgdGhpcy51dWlkID0gT2koKSwgdGhpcy5fb2JqZWN0cyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyksIHRoaXMubkNhY2hlZE9iamVjdHNfID0gMDsKICAgIGNvbnN0IHQgPSB7fTsKICAgIHRoaXMuX2luZGljZXNCeVVVSUQgPSB0OwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpICE9PSBuOyArK2kpCiAgICAgIHRbYXJndW1lbnRzW2ldLnV1aWRdID0gaTsKICAgIHRoaXMuX3BhdGhzID0gW10sIHRoaXMuX3BhcnNlZFBhdGhzID0gW10sIHRoaXMuX2JpbmRpbmdzID0gW10sIHRoaXMuX2JpbmRpbmdzSW5kaWNlc0J5UGF0aCA9IHt9OwogICAgY29uc3QgZSA9IHRoaXM7CiAgICB0aGlzLnN0YXRzID0gewogICAgICBvYmplY3RzOiB7CiAgICAgICAgZ2V0IHRvdGFsKCkgewogICAgICAgICAgcmV0dXJuIGUuX29iamVjdHMubGVuZ3RoOwogICAgICAgIH0sCiAgICAgICAgZ2V0IGluVXNlKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMudG90YWwgLSBlLm5DYWNoZWRPYmplY3RzXzsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldCBiaW5kaW5nc1Blck9iamVjdCgpIHsKICAgICAgICByZXR1cm4gZS5fYmluZGluZ3MubGVuZ3RoOwogICAgICB9CiAgICB9OwogIH0KICAvKioKICAgKiBBZGRzIGFuIGFyYml0cmFyeSBudW1iZXIgb2Ygb2JqZWN0cyB0byB0aGlzIGFuaW1hdGlvbiBncm91cC4KICAgKgogICAqIEBwYXJhbSB7Li4uT2JqZWN0M0R9IGFyZ3VtZW50cyAtIFRoZSAzRCBvYmplY3RzIHRvIGFkZC4KICAgKi8KICBhZGQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5fb2JqZWN0cywgZSA9IHRoaXMuX2luZGljZXNCeVVVSUQsIGkgPSB0aGlzLl9wYXRocywgbiA9IHRoaXMuX3BhcnNlZFBhdGhzLCBzID0gdGhpcy5fYmluZGluZ3MsIHIgPSBzLmxlbmd0aDsKICAgIGxldCBvLCBsID0gdC5sZW5ndGgsIGggPSB0aGlzLm5DYWNoZWRPYmplY3RzXzsKICAgIGZvciAobGV0IGMgPSAwLCB1ID0gYXJndW1lbnRzLmxlbmd0aDsgYyAhPT0gdTsgKytjKSB7CiAgICAgIGNvbnN0IGQgPSBhcmd1bWVudHNbY10sIHAgPSBkLnV1aWQ7CiAgICAgIGxldCBmID0gZVtwXTsKICAgICAgaWYgKGYgPT09IHZvaWQgMCkgewogICAgICAgIGYgPSBsKyssIGVbcF0gPSBmLCB0LnB1c2goZCk7CiAgICAgICAgZm9yIChsZXQgeSA9IDAsIGcgPSByOyB5ICE9PSBnOyArK3kpCiAgICAgICAgICBzW3ldLnB1c2gobmV3IHNlKGQsIGlbeV0sIG5beV0pKTsKICAgICAgfSBlbHNlIGlmIChmIDwgaCkgewogICAgICAgIG8gPSB0W2ZdOwogICAgICAgIGNvbnN0IHkgPSAtLWgsIGcgPSB0W3ldOwogICAgICAgIGVbZy51dWlkXSA9IGYsIHRbZl0gPSBnLCBlW3BdID0geSwgdFt5XSA9IGQ7CiAgICAgICAgZm9yIChsZXQgbSA9IDAsIHYgPSByOyBtICE9PSB2OyArK20pIHsKICAgICAgICAgIGNvbnN0IHggPSBzW21dLCBfID0geFt5XTsKICAgICAgICAgIGxldCBTID0geFtmXTsKICAgICAgICAgIHhbZl0gPSBfLCBTID09PSB2b2lkIDAgJiYgKFMgPSBuZXcgc2UoZCwgaVttXSwgblttXSkpLCB4W3ldID0gUzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB0W2ZdICE9PSBvICYmIGNvbnNvbGUuZXJyb3IoIlRIUkVFLkFuaW1hdGlvbk9iamVjdEdyb3VwOiBEaWZmZXJlbnQgb2JqZWN0cyB3aXRoIHRoZSBzYW1lIFVVSUQgZGV0ZWN0ZWQuIENsZWFuIHRoZSBjYWNoZXMgb3IgcmVjcmVhdGUgeW91ciBpbmZyYXN0cnVjdHVyZSB3aGVuIHJlbG9hZGluZyBzY2VuZXMuIik7CiAgICB9CiAgICB0aGlzLm5DYWNoZWRPYmplY3RzXyA9IGg7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYW4gYXJiaXRyYXJ5IG51bWJlciBvZiBvYmplY3RzIHRvIHRoaXMgYW5pbWF0aW9uIGdyb3VwCiAgICoKICAgKiBAcGFyYW0gey4uLk9iamVjdDNEfSBhcmd1bWVudHMgLSBUaGUgM0Qgb2JqZWN0cyB0byByZW1vdmUuCiAgICovCiAgcmVtb3ZlKCkgewogICAgY29uc3QgdCA9IHRoaXMuX29iamVjdHMsIGUgPSB0aGlzLl9pbmRpY2VzQnlVVUlELCBpID0gdGhpcy5fYmluZGluZ3MsIG4gPSBpLmxlbmd0aDsKICAgIGxldCBzID0gdGhpcy5uQ2FjaGVkT2JqZWN0c187CiAgICBmb3IgKGxldCByID0gMCwgbyA9IGFyZ3VtZW50cy5sZW5ndGg7IHIgIT09IG87ICsrcikgewogICAgICBjb25zdCBsID0gYXJndW1lbnRzW3JdLCBoID0gbC51dWlkLCBjID0gZVtoXTsKICAgICAgaWYgKGMgIT09IHZvaWQgMCAmJiBjID49IHMpIHsKICAgICAgICBjb25zdCB1ID0gcysrLCBkID0gdFt1XTsKICAgICAgICBlW2QudXVpZF0gPSBjLCB0W2NdID0gZCwgZVtoXSA9IHUsIHRbdV0gPSBsOwogICAgICAgIGZvciAobGV0IHAgPSAwLCBmID0gbjsgcCAhPT0gZjsgKytwKSB7CiAgICAgICAgICBjb25zdCB5ID0gaVtwXSwgZyA9IHlbdV0sIG0gPSB5W2NdOwogICAgICAgICAgeVtjXSA9IGcsIHlbdV0gPSBtOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdGhpcy5uQ2FjaGVkT2JqZWN0c18gPSBzOwogIH0KICAvKioKICAgKiBEZWFsbG9jYXRlcyBhbGwgbWVtb3J5IHJlc291cmNlcyBmb3IgdGhlIHBhc3NlZCAzRCBvYmplY3RzIG9mIHRoaXMgYW5pbWF0aW9uIGdyb3VwLgogICAqCiAgICogQHBhcmFtIHsuLi5PYmplY3QzRH0gYXJndW1lbnRzIC0gVGhlIDNEIG9iamVjdHMgdG8gdW5jYWNoZS4KICAgKi8KICB1bmNhY2hlKCkgewogICAgY29uc3QgdCA9IHRoaXMuX29iamVjdHMsIGUgPSB0aGlzLl9pbmRpY2VzQnlVVUlELCBpID0gdGhpcy5fYmluZGluZ3MsIG4gPSBpLmxlbmd0aDsKICAgIGxldCBzID0gdGhpcy5uQ2FjaGVkT2JqZWN0c18sIHIgPSB0Lmxlbmd0aDsKICAgIGZvciAobGV0IG8gPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgbyAhPT0gbDsgKytvKSB7CiAgICAgIGNvbnN0IGggPSBhcmd1bWVudHNbb10sIGMgPSBoLnV1aWQsIHUgPSBlW2NdOwogICAgICBpZiAodSAhPT0gdm9pZCAwKQogICAgICAgIGlmIChkZWxldGUgZVtjXSwgdSA8IHMpIHsKICAgICAgICAgIGNvbnN0IGQgPSAtLXMsIHAgPSB0W2RdLCBmID0gLS1yLCB5ID0gdFtmXTsKICAgICAgICAgIGVbcC51dWlkXSA9IHUsIHRbdV0gPSBwLCBlW3kudXVpZF0gPSBkLCB0W2RdID0geSwgdC5wb3AoKTsKICAgICAgICAgIGZvciAobGV0IGcgPSAwLCBtID0gbjsgZyAhPT0gbTsgKytnKSB7CiAgICAgICAgICAgIGNvbnN0IHYgPSBpW2ddLCB4ID0gdltkXSwgXyA9IHZbZl07CiAgICAgICAgICAgIHZbdV0gPSB4LCB2W2RdID0gXywgdi5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgZCA9IC0tciwgcCA9IHRbZF07CiAgICAgICAgICBkID4gMCAmJiAoZVtwLnV1aWRdID0gdSksIHRbdV0gPSBwLCB0LnBvcCgpOwogICAgICAgICAgZm9yIChsZXQgZiA9IDAsIHkgPSBuOyBmICE9PSB5OyArK2YpIHsKICAgICAgICAgICAgY29uc3QgZyA9IGlbZl07CiAgICAgICAgICAgIGdbdV0gPSBnW2RdLCBnLnBvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHRoaXMubkNhY2hlZE9iamVjdHNfID0gczsKICB9CiAgLy8gSW50ZXJuYWwgaW50ZXJmYWNlIHVzZWQgYnkgYmVmcmllbmRlZCBQcm9wZXJ0eUJpbmRpbmcuQ29tcG9zaXRlOgogIHN1YnNjcmliZV8odCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuX2JpbmRpbmdzSW5kaWNlc0J5UGF0aDsKICAgIGxldCBuID0gaVt0XTsKICAgIGNvbnN0IHMgPSB0aGlzLl9iaW5kaW5nczsKICAgIGlmIChuICE9PSB2b2lkIDApIHJldHVybiBzW25dOwogICAgY29uc3QgciA9IHRoaXMuX3BhdGhzLCBvID0gdGhpcy5fcGFyc2VkUGF0aHMsIGwgPSB0aGlzLl9vYmplY3RzLCBoID0gbC5sZW5ndGgsIGMgPSB0aGlzLm5DYWNoZWRPYmplY3RzXywgdSA9IG5ldyBBcnJheShoKTsKICAgIG4gPSBzLmxlbmd0aCwgaVt0XSA9IG4sIHIucHVzaCh0KSwgby5wdXNoKGUpLCBzLnB1c2godSk7CiAgICBmb3IgKGxldCBkID0gYywgcCA9IGwubGVuZ3RoOyBkICE9PSBwOyArK2QpIHsKICAgICAgY29uc3QgZiA9IGxbZF07CiAgICAgIHVbZF0gPSBuZXcgc2UoZiwgdCwgZSk7CiAgICB9CiAgICByZXR1cm4gdTsKICB9CiAgdW5zdWJzY3JpYmVfKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLl9iaW5kaW5nc0luZGljZXNCeVBhdGgsIGkgPSBlW3RdOwogICAgaWYgKGkgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBuID0gdGhpcy5fcGF0aHMsIHMgPSB0aGlzLl9wYXJzZWRQYXRocywgciA9IHRoaXMuX2JpbmRpbmdzLCBvID0gci5sZW5ndGggLSAxLCBsID0gcltvXSwgaCA9IHRbb107CiAgICAgIGVbaF0gPSBpLCByW2ldID0gbCwgci5wb3AoKSwgc1tpXSA9IHNbb10sIHMucG9wKCksIG5baV0gPSBuW29dLCBuLnBvcCgpOwogICAgfQogIH0KfQpjbGFzcyBnXyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBhbmltYXRpb24gYWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtBbmltYXRpb25NaXhlcn0gbWl4ZXIgLSBUaGUgbWl4ZXIgdGhhdCBpcyBjb250cm9sbGVkIGJ5IHRoaXMgYWN0aW9uLgogICAqIEBwYXJhbSB7QW5pbWF0aW9uQ2xpcH0gY2xpcCAtIFRoZSBhbmltYXRpb24gY2xpcCB0aGF0IGhvbGRzIHRoZSBhY3R1YWwga2V5ZnJhbWVzLgogICAqIEBwYXJhbSB7P09iamVjdDNEfSBbbG9jYWxSb290PW51bGxdIC0gVGhlIHJvb3Qgb2JqZWN0IG9uIHdoaWNoIHRoaXMgYWN0aW9uIGlzIHBlcmZvcm1lZC4KICAgKiBAcGFyYW0geyhOb3JtYWxBbmltYXRpb25CbGVuZE1vZGV8QWRkaXRpdmVBbmltYXRpb25CbGVuZE1vZGUpfSBbYmxlbmRNb2RlXSAtIFRoZSBibGVuZCBtb2RlLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkgPSBudWxsLCBuID0gZS5ibGVuZE1vZGUpIHsKICAgIHRoaXMuX21peGVyID0gdCwgdGhpcy5fY2xpcCA9IGUsIHRoaXMuX2xvY2FsUm9vdCA9IGksIHRoaXMuYmxlbmRNb2RlID0gbjsKICAgIGNvbnN0IHMgPSBlLnRyYWNrcywgciA9IHMubGVuZ3RoLCBvID0gbmV3IEFycmF5KHIpLCBsID0gewogICAgICBlbmRpbmdTdGFydDogc3IsCiAgICAgIGVuZGluZ0VuZDogc3IKICAgIH07CiAgICBmb3IgKGxldCBoID0gMDsgaCAhPT0gcjsgKytoKSB7CiAgICAgIGNvbnN0IGMgPSBzW2hdLmNyZWF0ZUludGVycG9sYW50KG51bGwpOwogICAgICBvW2hdID0gYywgYy5zZXR0aW5ncyA9IGw7CiAgICB9CiAgICB0aGlzLl9pbnRlcnBvbGFudFNldHRpbmdzID0gbCwgdGhpcy5faW50ZXJwb2xhbnRzID0gbywgdGhpcy5fcHJvcGVydHlCaW5kaW5ncyA9IG5ldyBBcnJheShyKSwgdGhpcy5fY2FjaGVJbmRleCA9IG51bGwsIHRoaXMuX2J5Q2xpcENhY2hlSW5kZXggPSBudWxsLCB0aGlzLl90aW1lU2NhbGVJbnRlcnBvbGFudCA9IG51bGwsIHRoaXMuX3dlaWdodEludGVycG9sYW50ID0gbnVsbCwgdGhpcy5sb29wID0gSXAsIHRoaXMuX2xvb3BDb3VudCA9IC0xLCB0aGlzLl9zdGFydFRpbWUgPSBudWxsLCB0aGlzLnRpbWUgPSAwLCB0aGlzLnRpbWVTY2FsZSA9IDEsIHRoaXMuX2VmZmVjdGl2ZVRpbWVTY2FsZSA9IDEsIHRoaXMud2VpZ2h0ID0gMSwgdGhpcy5fZWZmZWN0aXZlV2VpZ2h0ID0gMSwgdGhpcy5yZXBldGl0aW9ucyA9IDEgLyAwLCB0aGlzLnBhdXNlZCA9ICExLCB0aGlzLmVuYWJsZWQgPSAhMCwgdGhpcy5jbGFtcFdoZW5GaW5pc2hlZCA9ICExLCB0aGlzLnplcm9TbG9wZUF0U3RhcnQgPSAhMCwgdGhpcy56ZXJvU2xvcGVBdEVuZCA9ICEwOwogIH0KICAvKioKICAgKiBTdGFydHMgdGhlIHBsYXliYWNrIG9mIHRoZSBhbmltYXRpb24uCiAgICoKICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBwbGF5KCkgewogICAgcmV0dXJuIHRoaXMuX21peGVyLl9hY3RpdmF0ZUFjdGlvbih0aGlzKSwgdGhpczsKICB9CiAgLyoqCiAgICogU3RvcHMgdGhlIHBsYXliYWNrIG9mIHRoZSBhbmltYXRpb24uCiAgICoKICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBzdG9wKCkgewogICAgcmV0dXJuIHRoaXMuX21peGVyLl9kZWFjdGl2YXRlQWN0aW9uKHRoaXMpLCB0aGlzLnJlc2V0KCk7CiAgfQogIC8qKgogICAqIFJlc2V0cyB0aGUgcGxheWJhY2sgb2YgdGhlIGFuaW1hdGlvbi4KICAgKgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkFjdGlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqLwogIHJlc2V0KCkgewogICAgcmV0dXJuIHRoaXMucGF1c2VkID0gITEsIHRoaXMuZW5hYmxlZCA9ICEwLCB0aGlzLnRpbWUgPSAwLCB0aGlzLl9sb29wQ291bnQgPSAtMSwgdGhpcy5fc3RhcnRUaW1lID0gbnVsbCwgdGhpcy5zdG9wRmFkaW5nKCkuc3RvcFdhcnBpbmcoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGFuaW1hdGlvbiBpcyBydW5uaW5nLgogICAqCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgYW5pbWF0aW9uIGlzIHJ1bm5pbmcgb3Igbm90LgogICAqLwogIGlzUnVubmluZygpIHsKICAgIHJldHVybiB0aGlzLmVuYWJsZWQgJiYgIXRoaXMucGF1c2VkICYmIHRoaXMudGltZVNjYWxlICE9PSAwICYmIHRoaXMuX3N0YXJ0VGltZSA9PT0gbnVsbCAmJiB0aGlzLl9taXhlci5faXNBY3RpdmVBY3Rpb24odGhpcyk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIHdoZW4ge0BsaW5rIEFuaW1hdGlvbkFjdGlvbiNwbGF5fSBoYXMgYmVlbiBjYWxsZWQuCiAgICoKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBhbmltYXRpb24gaXMgc2NoZWR1bGVkIG9yIG5vdC4KICAgKi8KICBpc1NjaGVkdWxlZCgpIHsKICAgIHJldHVybiB0aGlzLl9taXhlci5faXNBY3RpdmVBY3Rpb24odGhpcyk7CiAgfQogIC8qKgogICAqIERlZmluZXMgdGhlIHRpbWUgd2hlbiB0aGUgYW5pbWF0aW9uIHNob3VsZCBzdGFydC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gVGhlIHN0YXJ0IHRpbWUgaW4gc2Vjb25kcy4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBzdGFydEF0KHQpIHsKICAgIHJldHVybiB0aGlzLl9zdGFydFRpbWUgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBDb25maWd1cmVzIHRoZSBsb29wIHNldHRpbmdzIGZvciB0aGlzIGFjdGlvbi4KICAgKgogICAqIEBwYXJhbSB7KExvb3BSZXBlYXR8TG9vcE9uY2V8TG9vcFBpbmdQb25nKX0gbW9kZSAtIFRoZSBsb29wIG1vZGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHJlcGV0aXRpb25zIC0gVGhlIG51bWJlciBvZiByZXBldGl0aW9ucy4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBzZXRMb29wKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmxvb3AgPSB0LCB0aGlzLnJlcGV0aXRpb25zID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZWZmZWN0aXZlIHdlaWdodCBvZiB0aGlzIGFjdGlvbi4KICAgKgogICAqIEFuIGFjdGlvbiBoYXMgbm8gZWZmZWN0IGFuZCB0aHVzIGFuIGVmZmVjdGl2ZSB3ZWlnaHQgb2YgemVybyB3aGVuIHRoZQogICAqIGFjdGlvbiBpcyBkaXNhYmxlZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB3ZWlnaHQgLSBUaGUgd2VpZ2h0IHRvIHNldC4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBzZXRFZmZlY3RpdmVXZWlnaHQodCkgewogICAgcmV0dXJuIHRoaXMud2VpZ2h0ID0gdCwgdGhpcy5fZWZmZWN0aXZlV2VpZ2h0ID0gdGhpcy5lbmFibGVkID8gdCA6IDAsIHRoaXMuc3RvcEZhZGluZygpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBlZmZlY3RpdmUgd2VpZ2h0IG9mIHRoaXMgYWN0aW9uLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZWZmZWN0aXZlIHdlaWdodC4KICAgKi8KICBnZXRFZmZlY3RpdmVXZWlnaHQoKSB7CiAgICByZXR1cm4gdGhpcy5fZWZmZWN0aXZlV2VpZ2h0OwogIH0KICAvKioKICAgKiBGYWRlcyB0aGUgYW5pbWF0aW9uIGluIGJ5IGluY3JlYXNpbmcgaXRzIHdlaWdodCBncmFkdWFsbHkgZnJvbSBgMGAgdG8gYDFgLAogICAqIHdpdGhpbiB0aGUgcGFzc2VkIHRpbWUgaW50ZXJ2YWwuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBUaGUgZHVyYXRpb24gb2YgdGhlIGZhZGUuCiAgICogQHJldHVybiB7QW5pbWF0aW9uQWN0aW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIGFuaW1hdGlvbiBhY3Rpb24uCiAgICovCiAgZmFkZUluKHQpIHsKICAgIHJldHVybiB0aGlzLl9zY2hlZHVsZUZhZGluZyh0LCAwLCAxKTsKICB9CiAgLyoqCiAgICogRmFkZXMgdGhlIGFuaW1hdGlvbiBvdXQgYnkgZGVjcmVhc2luZyBpdHMgd2VpZ2h0IGdyYWR1YWxseSBmcm9tIGAxYCB0byBgMGAsCiAgICogd2l0aGluIHRoZSBwYXNzZWQgdGltZSBpbnRlcnZhbC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbiBvZiB0aGUgZmFkZS4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBmYWRlT3V0KHQpIHsKICAgIHJldHVybiB0aGlzLl9zY2hlZHVsZUZhZGluZyh0LCAxLCAwKTsKICB9CiAgLyoqCiAgICogQ2F1c2VzIHRoaXMgYWN0aW9uIHRvIGZhZGUgaW4gYW5kIHRoZSBnaXZlbiBhY3Rpb24gdG8gZmFkZSBvdXQsCiAgICogd2l0aGluIHRoZSBwYXNzZWQgdGltZSBpbnRlcnZhbC4KICAgKgogICAqIEBwYXJhbSB7QW5pbWF0aW9uQWN0aW9ufSBmYWRlT3V0QWN0aW9uIC0gVGhlIGFuaW1hdGlvbiBhY3Rpb24gdG8gZmFkZSBvdXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIGR1cmF0aW9uIG9mIHRoZSBmYWRlLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3dhcnA9ZmFsc2VdIC0gV2hldGhlciB3YXJwaW5nIHNob3VsZCBiZSB1c2VkIG9yIG5vdC4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBjcm9zc0ZhZGVGcm9tKHQsIGUsIGkgPSAhMSkgewogICAgaWYgKHQuZmFkZU91dChlKSwgdGhpcy5mYWRlSW4oZSksIGkgPT09ICEwKSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLl9jbGlwLmR1cmF0aW9uLCBzID0gdC5fY2xpcC5kdXJhdGlvbiwgciA9IHMgLyBuLCBvID0gbiAvIHM7CiAgICAgIHQud2FycCgxLCByLCBlKSwgdGhpcy53YXJwKG8sIDEsIGUpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIENhdXNlcyB0aGlzIGFjdGlvbiB0byBmYWRlIG91dCBhbmQgdGhlIGdpdmVuIGFjdGlvbiB0byBmYWRlIGluLAogICAqIHdpdGhpbiB0aGUgcGFzc2VkIHRpbWUgaW50ZXJ2YWwuCiAgICoKICAgKiBAcGFyYW0ge0FuaW1hdGlvbkFjdGlvbn0gZmFkZUluQWN0aW9uIC0gVGhlIGFuaW1hdGlvbiBhY3Rpb24gdG8gZmFkZSBpbi4KICAgKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBUaGUgZHVyYXRpb24gb2YgdGhlIGZhZGUuCiAgICogQHBhcmFtIHtib29sZWFufSBbd2FycD1mYWxzZV0gLSBXaGV0aGVyIHdhcnBpbmcgc2hvdWxkIGJlIHVzZWQgb3Igbm90LgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkFjdGlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqLwogIGNyb3NzRmFkZVRvKHQsIGUsIGkgPSAhMSkgewogICAgcmV0dXJuIHQuY3Jvc3NGYWRlRnJvbSh0aGlzLCBlLCBpKTsKICB9CiAgLyoqCiAgICogU3RvcHMgYW55IGZhZGluZyB3aGljaCBpcyBhcHBsaWVkIHRvIHRoaXMgYWN0aW9uLgogICAqCiAgICogQHJldHVybiB7QW5pbWF0aW9uQWN0aW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIGFuaW1hdGlvbiBhY3Rpb24uCiAgICovCiAgc3RvcEZhZGluZygpIHsKICAgIGNvbnN0IHQgPSB0aGlzLl93ZWlnaHRJbnRlcnBvbGFudDsKICAgIHJldHVybiB0ICE9PSBudWxsICYmICh0aGlzLl93ZWlnaHRJbnRlcnBvbGFudCA9IG51bGwsIHRoaXMuX21peGVyLl90YWtlQmFja0NvbnRyb2xJbnRlcnBvbGFudCh0KSksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGVmZmVjdGl2ZSB0aW1lIHNjYWxlIG9mIHRoaXMgYWN0aW9uLgogICAqCiAgICogQW4gYWN0aW9uIGhhcyBubyBlZmZlY3QgYW5kIHRodXMgYW4gZWZmZWN0aXZlIHRpbWUgc2NhbGUgb2YgemVybyB3aGVuIHRoZQogICAqIGFjdGlvbiBpcyBwYXVzZWQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdGltZVNjYWxlIC0gVGhlIHRpbWUgc2NhbGUgdG8gc2V0LgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkFjdGlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqLwogIHNldEVmZmVjdGl2ZVRpbWVTY2FsZSh0KSB7CiAgICByZXR1cm4gdGhpcy50aW1lU2NhbGUgPSB0LCB0aGlzLl9lZmZlY3RpdmVUaW1lU2NhbGUgPSB0aGlzLnBhdXNlZCA/IDAgOiB0LCB0aGlzLnN0b3BXYXJwaW5nKCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGVmZmVjdGl2ZSB0aW1lIHNjYWxlIG9mIHRoaXMgYWN0aW9uLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZWZmZWN0aXZlIHRpbWUgc2NhbGUuCiAgICovCiAgZ2V0RWZmZWN0aXZlVGltZVNjYWxlKCkgewogICAgcmV0dXJuIHRoaXMuX2VmZmVjdGl2ZVRpbWVTY2FsZTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZHVyYXRpb24gZm9yIGEgc2luZ2xlIGxvb3Agb2YgdGhpcyBhY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBUaGUgZHVyYXRpb24gdG8gc2V0LgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkFjdGlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqLwogIHNldER1cmF0aW9uKHQpIHsKICAgIHJldHVybiB0aGlzLnRpbWVTY2FsZSA9IHRoaXMuX2NsaXAuZHVyYXRpb24gLyB0LCB0aGlzLnN0b3BXYXJwaW5nKCk7CiAgfQogIC8qKgogICAqIFN5bmNocm9uaXplcyB0aGlzIGFjdGlvbiB3aXRoIHRoZSBwYXNzZWQgb3RoZXIgYWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtBbmltYXRpb25BY3Rpb259IGFjdGlvbiAtIFRoZSBhY3Rpb24gdG8gc3luYyB3aXRoLgogICAqIEByZXR1cm4ge0FuaW1hdGlvbkFjdGlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqLwogIHN5bmNXaXRoKHQpIHsKICAgIHJldHVybiB0aGlzLnRpbWUgPSB0LnRpbWUsIHRoaXMudGltZVNjYWxlID0gdC50aW1lU2NhbGUsIHRoaXMuc3RvcFdhcnBpbmcoKTsKICB9CiAgLyoqCiAgICogRGVjZWxlcmF0ZXMgdGhpcyBhbmltYXRpb24ncyBzcGVlZCB0byBgMGAgd2l0aGluIHRoZSBwYXNzZWQgdGltZSBpbnRlcnZhbC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbi4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBoYWx0KHQpIHsKICAgIHJldHVybiB0aGlzLndhcnAodGhpcy5fZWZmZWN0aXZlVGltZVNjYWxlLCAwLCB0KTsKICB9CiAgLyoqCiAgICogQ2hhbmdlcyB0aGUgcGxheWJhY2sgc3BlZWQsIHdpdGhpbiB0aGUgcGFzc2VkIHRpbWUgaW50ZXJ2YWwsIGJ5IG1vZGlmeWluZwogICAqIHtAbGluayBBbmltYXRpb25BY3Rpb24jdGltZVNjYWxlfSBncmFkdWFsbHkgZnJvbSBgc3RhcnRUaW1lU2NhbGVgIHRvCiAgICogYGVuZFRpbWVTY2FsZWAuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRUaW1lU2NhbGUgLSBUaGUgc3RhcnQgdGltZSBzY2FsZS4KICAgKiBAcGFyYW0ge251bWJlcn0gZW5kVGltZVNjYWxlIC0gVGhlIGVuZCB0aW1lIHNjYWxlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbi4KICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICB3YXJwKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLl9taXhlciwgcyA9IG4udGltZSwgciA9IHRoaXMudGltZVNjYWxlOwogICAgbGV0IG8gPSB0aGlzLl90aW1lU2NhbGVJbnRlcnBvbGFudDsKICAgIG8gPT09IG51bGwgJiYgKG8gPSBuLl9sZW5kQ29udHJvbEludGVycG9sYW50KCksIHRoaXMuX3RpbWVTY2FsZUludGVycG9sYW50ID0gbyk7CiAgICBjb25zdCBsID0gby5wYXJhbWV0ZXJQb3NpdGlvbnMsIGggPSBvLnNhbXBsZVZhbHVlczsKICAgIHJldHVybiBsWzBdID0gcywgbFsxXSA9IHMgKyBpLCBoWzBdID0gdCAvIHIsIGhbMV0gPSBlIC8gciwgdGhpczsKICB9CiAgLyoqCiAgICogU3RvcHMgYW55IHNjaGVkdWxlZCB3YXJwaW5nIHdoaWNoIGlzIGFwcGxpZWQgdG8gdGhpcyBhY3Rpb24uCiAgICoKICAgKiBAcmV0dXJuIHtBbmltYXRpb25BY3Rpb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBzdG9wV2FycGluZygpIHsKICAgIGNvbnN0IHQgPSB0aGlzLl90aW1lU2NhbGVJbnRlcnBvbGFudDsKICAgIHJldHVybiB0ICE9PSBudWxsICYmICh0aGlzLl90aW1lU2NhbGVJbnRlcnBvbGFudCA9IG51bGwsIHRoaXMuX21peGVyLl90YWtlQmFja0NvbnRyb2xJbnRlcnBvbGFudCh0KSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGFuaW1hdGlvbiBtaXhlciBvZiB0aGlzIGFuaW1hdGlvbiBhY3Rpb24uCiAgICoKICAgKiBAcmV0dXJuIHtBbmltYXRpb25NaXhlcn0gVGhlIGFuaW1hdGlvbiBtaXhlci4KICAgKi8KICBnZXRNaXhlcigpIHsKICAgIHJldHVybiB0aGlzLl9taXhlcjsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgYW5pbWF0aW9uIGNsaXAgb2YgdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqCiAgICogQHJldHVybiB7QW5pbWF0aW9uQ2xpcH0gVGhlIGFuaW1hdGlvbiBjbGlwLgogICAqLwogIGdldENsaXAoKSB7CiAgICByZXR1cm4gdGhpcy5fY2xpcDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgcm9vdCBvYmplY3Qgb2YgdGhpcyBhbmltYXRpb24gYWN0aW9uLgogICAqCiAgICogQHJldHVybiB7T2JqZWN0M0R9IFRoZSByb290IG9iamVjdC4KICAgKi8KICBnZXRSb290KCkgewogICAgcmV0dXJuIHRoaXMuX2xvY2FsUm9vdCB8fCB0aGlzLl9taXhlci5fcm9vdDsKICB9CiAgLy8gSW50ZXJuYQogIF91cGRhdGUodCwgZSwgaSwgbikgewogICAgaWYgKCF0aGlzLmVuYWJsZWQpIHsKICAgICAgdGhpcy5fdXBkYXRlV2VpZ2h0KHQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzID0gdGhpcy5fc3RhcnRUaW1lOwogICAgaWYgKHMgIT09IG51bGwpIHsKICAgICAgY29uc3QgbCA9ICh0IC0gcykgKiBpOwogICAgICBsIDwgMCB8fCBpID09PSAwID8gZSA9IDAgOiAodGhpcy5fc3RhcnRUaW1lID0gbnVsbCwgZSA9IGkgKiBsKTsKICAgIH0KICAgIGUgKj0gdGhpcy5fdXBkYXRlVGltZVNjYWxlKHQpOwogICAgY29uc3QgciA9IHRoaXMuX3VwZGF0ZVRpbWUoZSksIG8gPSB0aGlzLl91cGRhdGVXZWlnaHQodCk7CiAgICBpZiAobyA+IDApIHsKICAgICAgY29uc3QgbCA9IHRoaXMuX2ludGVycG9sYW50cywgaCA9IHRoaXMuX3Byb3BlcnR5QmluZGluZ3M7CiAgICAgIHN3aXRjaCAodGhpcy5ibGVuZE1vZGUpIHsKICAgICAgICBjYXNlIERwOgogICAgICAgICAgZm9yIChsZXQgYyA9IDAsIHUgPSBsLmxlbmd0aDsgYyAhPT0gdTsgKytjKQogICAgICAgICAgICBsW2NdLmV2YWx1YXRlKHIpLCBoW2NdLmFjY3VtdWxhdGVBZGRpdGl2ZShvKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgVWM6CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGZvciAobGV0IGMgPSAwLCB1ID0gbC5sZW5ndGg7IGMgIT09IHU7ICsrYykKICAgICAgICAgICAgbFtjXS5ldmFsdWF0ZShyKSwgaFtjXS5hY2N1bXVsYXRlKG4sIG8pOwogICAgICB9CiAgICB9CiAgfQogIF91cGRhdGVXZWlnaHQodCkgewogICAgbGV0IGUgPSAwOwogICAgaWYgKHRoaXMuZW5hYmxlZCkgewogICAgICBlID0gdGhpcy53ZWlnaHQ7CiAgICAgIGNvbnN0IGkgPSB0aGlzLl93ZWlnaHRJbnRlcnBvbGFudDsKICAgICAgaWYgKGkgIT09IG51bGwpIHsKICAgICAgICBjb25zdCBuID0gaS5ldmFsdWF0ZSh0KVswXTsKICAgICAgICBlICo9IG4sIHQgPiBpLnBhcmFtZXRlclBvc2l0aW9uc1sxXSAmJiAodGhpcy5zdG9wRmFkaW5nKCksIG4gPT09IDAgJiYgKHRoaXMuZW5hYmxlZCA9ICExKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLl9lZmZlY3RpdmVXZWlnaHQgPSBlLCBlOwogIH0KICBfdXBkYXRlVGltZVNjYWxlKHQpIHsKICAgIGxldCBlID0gMDsKICAgIGlmICghdGhpcy5wYXVzZWQpIHsKICAgICAgZSA9IHRoaXMudGltZVNjYWxlOwogICAgICBjb25zdCBpID0gdGhpcy5fdGltZVNjYWxlSW50ZXJwb2xhbnQ7CiAgICAgIGlmIChpICE9PSBudWxsKSB7CiAgICAgICAgY29uc3QgbiA9IGkuZXZhbHVhdGUodClbMF07CiAgICAgICAgZSAqPSBuLCB0ID4gaS5wYXJhbWV0ZXJQb3NpdGlvbnNbMV0gJiYgKHRoaXMuc3RvcFdhcnBpbmcoKSwgZSA9PT0gMCA/IHRoaXMucGF1c2VkID0gITAgOiB0aGlzLnRpbWVTY2FsZSA9IGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5fZWZmZWN0aXZlVGltZVNjYWxlID0gZSwgZTsKICB9CiAgX3VwZGF0ZVRpbWUodCkgewogICAgY29uc3QgZSA9IHRoaXMuX2NsaXAuZHVyYXRpb24sIGkgPSB0aGlzLmxvb3A7CiAgICBsZXQgbiA9IHRoaXMudGltZSArIHQsIHMgPSB0aGlzLl9sb29wQ291bnQ7CiAgICBjb25zdCByID0gaSA9PT0gTHA7CiAgICBpZiAodCA9PT0gMCkKICAgICAgcmV0dXJuIHMgPT09IC0xID8gbiA6IHIgJiYgKHMgJiAxKSA9PT0gMSA/IGUgLSBuIDogbjsKICAgIGlmIChpID09PSBleSkgewogICAgICBzID09PSAtMSAmJiAodGhpcy5fbG9vcENvdW50ID0gMCwgdGhpcy5fc2V0RW5kaW5ncyghMCwgITAsICExKSk7CiAgICAgIHQ6IHsKICAgICAgICBpZiAobiA+PSBlKQogICAgICAgICAgbiA9IGU7CiAgICAgICAgZWxzZSBpZiAobiA8IDApCiAgICAgICAgICBuID0gMDsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHRoaXMudGltZSA9IG47CiAgICAgICAgICBicmVhayB0OwogICAgICAgIH0KICAgICAgICB0aGlzLmNsYW1wV2hlbkZpbmlzaGVkID8gdGhpcy5wYXVzZWQgPSAhMCA6IHRoaXMuZW5hYmxlZCA9ICExLCB0aGlzLnRpbWUgPSBuLCB0aGlzLl9taXhlci5kaXNwYXRjaEV2ZW50KHsKICAgICAgICAgIHR5cGU6ICJmaW5pc2hlZCIsCiAgICAgICAgICBhY3Rpb246IHRoaXMsCiAgICAgICAgICBkaXJlY3Rpb246IHQgPCAwID8gLTEgOiAxCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChzID09PSAtMSAmJiAodCA+PSAwID8gKHMgPSAwLCB0aGlzLl9zZXRFbmRpbmdzKCEwLCB0aGlzLnJlcGV0aXRpb25zID09PSAwLCByKSkgOiB0aGlzLl9zZXRFbmRpbmdzKHRoaXMucmVwZXRpdGlvbnMgPT09IDAsICEwLCByKSksIG4gPj0gZSB8fCBuIDwgMCkgewogICAgICAgIGNvbnN0IG8gPSBNYXRoLmZsb29yKG4gLyBlKTsKICAgICAgICBuIC09IGUgKiBvLCBzICs9IE1hdGguYWJzKG8pOwogICAgICAgIGNvbnN0IGwgPSB0aGlzLnJlcGV0aXRpb25zIC0gczsKICAgICAgICBpZiAobCA8PSAwKQogICAgICAgICAgdGhpcy5jbGFtcFdoZW5GaW5pc2hlZCA/IHRoaXMucGF1c2VkID0gITAgOiB0aGlzLmVuYWJsZWQgPSAhMSwgbiA9IHQgPiAwID8gZSA6IDAsIHRoaXMudGltZSA9IG4sIHRoaXMuX21peGVyLmRpc3BhdGNoRXZlbnQoewogICAgICAgICAgICB0eXBlOiAiZmluaXNoZWQiLAogICAgICAgICAgICBhY3Rpb246IHRoaXMsCiAgICAgICAgICAgIGRpcmVjdGlvbjogdCA+IDAgPyAxIDogLTEKICAgICAgICAgIH0pOwogICAgICAgIGVsc2UgewogICAgICAgICAgaWYgKGwgPT09IDEpIHsKICAgICAgICAgICAgY29uc3QgaCA9IHQgPCAwOwogICAgICAgICAgICB0aGlzLl9zZXRFbmRpbmdzKGgsICFoLCByKTsKICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICB0aGlzLl9zZXRFbmRpbmdzKCExLCAhMSwgcik7CiAgICAgICAgICB0aGlzLl9sb29wQ291bnQgPSBzLCB0aGlzLnRpbWUgPSBuLCB0aGlzLl9taXhlci5kaXNwYXRjaEV2ZW50KHsKICAgICAgICAgICAgdHlwZTogImxvb3AiLAogICAgICAgICAgICBhY3Rpb246IHRoaXMsCiAgICAgICAgICAgIGxvb3BEZWx0YTogbwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UKICAgICAgICB0aGlzLnRpbWUgPSBuOwogICAgICBpZiAociAmJiAocyAmIDEpID09PSAxKQogICAgICAgIHJldHVybiBlIC0gbjsKICAgIH0KICAgIHJldHVybiBuOwogIH0KICBfc2V0RW5kaW5ncyh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0gdGhpcy5faW50ZXJwb2xhbnRTZXR0aW5nczsKICAgIGkgPyAobi5lbmRpbmdTdGFydCA9IHJyLCBuLmVuZGluZ0VuZCA9IHJyKSA6ICh0ID8gbi5lbmRpbmdTdGFydCA9IHRoaXMuemVyb1Nsb3BlQXRTdGFydCA/IHJyIDogc3IgOiBuLmVuZGluZ1N0YXJ0ID0gQW8sIGUgPyBuLmVuZGluZ0VuZCA9IHRoaXMuemVyb1Nsb3BlQXRFbmQgPyByciA6IHNyIDogbi5lbmRpbmdFbmQgPSBBbyk7CiAgfQogIF9zY2hlZHVsZUZhZGluZyh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0gdGhpcy5fbWl4ZXIsIHMgPSBuLnRpbWU7CiAgICBsZXQgciA9IHRoaXMuX3dlaWdodEludGVycG9sYW50OwogICAgciA9PT0gbnVsbCAmJiAociA9IG4uX2xlbmRDb250cm9sSW50ZXJwb2xhbnQoKSwgdGhpcy5fd2VpZ2h0SW50ZXJwb2xhbnQgPSByKTsKICAgIGNvbnN0IG8gPSByLnBhcmFtZXRlclBvc2l0aW9ucywgbCA9IHIuc2FtcGxlVmFsdWVzOwogICAgcmV0dXJuIG9bMF0gPSBzLCBsWzBdID0gZSwgb1sxXSA9IHMgKyB0LCBsWzFdID0gaSwgdGhpczsKICB9Cn0KY29uc3QgcE0gPSBuZXcgRmxvYXQzMkFycmF5KDEpOwpjbGFzcyB5XyBleHRlbmRzIEVpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGFuaW1hdGlvbiBtaXhlci4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IHJvb3QgLSBUaGUgb2JqZWN0IHdob3NlIGFuaW1hdGlvbnMgc2hhbGwgYmUgcGxheWVkIGJ5IHRoaXMgbWl4ZXIuCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5fcm9vdCA9IHQsIHRoaXMuX2luaXRNZW1vcnlNYW5hZ2VyKCksIHRoaXMuX2FjY3VJbmRleCA9IDAsIHRoaXMudGltZSA9IDAsIHRoaXMudGltZVNjYWxlID0gMTsKICB9CiAgX2JpbmRBY3Rpb24odCwgZSkgewogICAgY29uc3QgaSA9IHQuX2xvY2FsUm9vdCB8fCB0aGlzLl9yb290LCBuID0gdC5fY2xpcC50cmFja3MsIHMgPSBuLmxlbmd0aCwgciA9IHQuX3Byb3BlcnR5QmluZGluZ3MsIG8gPSB0Ll9pbnRlcnBvbGFudHMsIGwgPSBpLnV1aWQsIGggPSB0aGlzLl9iaW5kaW5nc0J5Um9vdEFuZE5hbWU7CiAgICBsZXQgYyA9IGhbbF07CiAgICBjID09PSB2b2lkIDAgJiYgKGMgPSB7fSwgaFtsXSA9IGMpOwogICAgZm9yIChsZXQgdSA9IDA7IHUgIT09IHM7ICsrdSkgewogICAgICBjb25zdCBkID0gblt1XSwgcCA9IGQubmFtZTsKICAgICAgbGV0IGYgPSBjW3BdOwogICAgICBpZiAoZiAhPT0gdm9pZCAwKQogICAgICAgICsrZi5yZWZlcmVuY2VDb3VudCwgclt1XSA9IGY7CiAgICAgIGVsc2UgewogICAgICAgIGlmIChmID0gclt1XSwgZiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBmLl9jYWNoZUluZGV4ID09PSBudWxsICYmICgrK2YucmVmZXJlbmNlQ291bnQsIHRoaXMuX2FkZEluYWN0aXZlQmluZGluZyhmLCBsLCBwKSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeSA9IGUgJiYgZS5fcHJvcGVydHlCaW5kaW5nc1t1XS5iaW5kaW5nLnBhcnNlZFBhdGg7CiAgICAgICAgZiA9IG5ldyBtXygKICAgICAgICAgIHNlLmNyZWF0ZShpLCBwLCB5KSwKICAgICAgICAgIGQuVmFsdWVUeXBlTmFtZSwKICAgICAgICAgIGQuZ2V0VmFsdWVTaXplKCkKICAgICAgICApLCArK2YucmVmZXJlbmNlQ291bnQsIHRoaXMuX2FkZEluYWN0aXZlQmluZGluZyhmLCBsLCBwKSwgclt1XSA9IGY7CiAgICAgIH0KICAgICAgb1t1XS5yZXN1bHRCdWZmZXIgPSBmLmJ1ZmZlcjsKICAgIH0KICB9CiAgX2FjdGl2YXRlQWN0aW9uKHQpIHsKICAgIGlmICghdGhpcy5faXNBY3RpdmVBY3Rpb24odCkpIHsKICAgICAgaWYgKHQuX2NhY2hlSW5kZXggPT09IG51bGwpIHsKICAgICAgICBjb25zdCBpID0gKHQuX2xvY2FsUm9vdCB8fCB0aGlzLl9yb290KS51dWlkLCBuID0gdC5fY2xpcC51dWlkLCBzID0gdGhpcy5fYWN0aW9uc0J5Q2xpcFtuXTsKICAgICAgICB0aGlzLl9iaW5kQWN0aW9uKAogICAgICAgICAgdCwKICAgICAgICAgIHMgJiYgcy5rbm93bkFjdGlvbnNbMF0KICAgICAgICApLCB0aGlzLl9hZGRJbmFjdGl2ZUFjdGlvbih0LCBuLCBpKTsKICAgICAgfQogICAgICBjb25zdCBlID0gdC5fcHJvcGVydHlCaW5kaW5nczsKICAgICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSAhPT0gbjsgKytpKSB7CiAgICAgICAgY29uc3QgcyA9IGVbaV07CiAgICAgICAgcy51c2VDb3VudCsrID09PSAwICYmICh0aGlzLl9sZW5kQmluZGluZyhzKSwgcy5zYXZlT3JpZ2luYWxTdGF0ZSgpKTsKICAgICAgfQogICAgICB0aGlzLl9sZW5kQWN0aW9uKHQpOwogICAgfQogIH0KICBfZGVhY3RpdmF0ZUFjdGlvbih0KSB7CiAgICBpZiAodGhpcy5faXNBY3RpdmVBY3Rpb24odCkpIHsKICAgICAgY29uc3QgZSA9IHQuX3Byb3BlcnR5QmluZGluZ3M7CiAgICAgIGZvciAobGV0IGkgPSAwLCBuID0gZS5sZW5ndGg7IGkgIT09IG47ICsraSkgewogICAgICAgIGNvbnN0IHMgPSBlW2ldOwogICAgICAgIC0tcy51c2VDb3VudCA9PT0gMCAmJiAocy5yZXN0b3JlT3JpZ2luYWxTdGF0ZSgpLCB0aGlzLl90YWtlQmFja0JpbmRpbmcocykpOwogICAgICB9CiAgICAgIHRoaXMuX3Rha2VCYWNrQWN0aW9uKHQpOwogICAgfQogIH0KICAvLyBNZW1vcnkgbWFuYWdlcgogIF9pbml0TWVtb3J5TWFuYWdlcigpIHsKICAgIHRoaXMuX2FjdGlvbnMgPSBbXSwgdGhpcy5fbkFjdGl2ZUFjdGlvbnMgPSAwLCB0aGlzLl9hY3Rpb25zQnlDbGlwID0ge30sIHRoaXMuX2JpbmRpbmdzID0gW10sIHRoaXMuX25BY3RpdmVCaW5kaW5ncyA9IDAsIHRoaXMuX2JpbmRpbmdzQnlSb290QW5kTmFtZSA9IHt9LCB0aGlzLl9jb250cm9sSW50ZXJwb2xhbnRzID0gW10sIHRoaXMuX25BY3RpdmVDb250cm9sSW50ZXJwb2xhbnRzID0gMDsKICAgIGNvbnN0IHQgPSB0aGlzOwogICAgdGhpcy5zdGF0cyA9IHsKICAgICAgYWN0aW9uczogewogICAgICAgIGdldCB0b3RhbCgpIHsKICAgICAgICAgIHJldHVybiB0Ll9hY3Rpb25zLmxlbmd0aDsKICAgICAgICB9LAogICAgICAgIGdldCBpblVzZSgpIHsKICAgICAgICAgIHJldHVybiB0Ll9uQWN0aXZlQWN0aW9uczsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJpbmRpbmdzOiB7CiAgICAgICAgZ2V0IHRvdGFsKCkgewogICAgICAgICAgcmV0dXJuIHQuX2JpbmRpbmdzLmxlbmd0aDsKICAgICAgICB9LAogICAgICAgIGdldCBpblVzZSgpIHsKICAgICAgICAgIHJldHVybiB0Ll9uQWN0aXZlQmluZGluZ3M7CiAgICAgICAgfQogICAgICB9LAogICAgICBjb250cm9sSW50ZXJwb2xhbnRzOiB7CiAgICAgICAgZ2V0IHRvdGFsKCkgewogICAgICAgICAgcmV0dXJuIHQuX2NvbnRyb2xJbnRlcnBvbGFudHMubGVuZ3RoOwogICAgICAgIH0sCiAgICAgICAgZ2V0IGluVXNlKCkgewogICAgICAgICAgcmV0dXJuIHQuX25BY3RpdmVDb250cm9sSW50ZXJwb2xhbnRzOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CiAgLy8gTWVtb3J5IG1hbmFnZW1lbnQgZm9yIEFuaW1hdGlvbkFjdGlvbiBvYmplY3RzCiAgX2lzQWN0aXZlQWN0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0Ll9jYWNoZUluZGV4OwogICAgcmV0dXJuIGUgIT09IG51bGwgJiYgZSA8IHRoaXMuX25BY3RpdmVBY3Rpb25zOwogIH0KICBfYWRkSW5hY3RpdmVBY3Rpb24odCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuX2FjdGlvbnMsIHMgPSB0aGlzLl9hY3Rpb25zQnlDbGlwOwogICAgbGV0IHIgPSBzW2VdOwogICAgaWYgKHIgPT09IHZvaWQgMCkKICAgICAgciA9IHsKICAgICAgICBrbm93bkFjdGlvbnM6IFt0XSwKICAgICAgICBhY3Rpb25CeVJvb3Q6IHt9CiAgICAgIH0sIHQuX2J5Q2xpcENhY2hlSW5kZXggPSAwLCBzW2VdID0gcjsKICAgIGVsc2UgewogICAgICBjb25zdCBvID0gci5rbm93bkFjdGlvbnM7CiAgICAgIHQuX2J5Q2xpcENhY2hlSW5kZXggPSBvLmxlbmd0aCwgby5wdXNoKHQpOwogICAgfQogICAgdC5fY2FjaGVJbmRleCA9IG4ubGVuZ3RoLCBuLnB1c2godCksIHIuYWN0aW9uQnlSb290W2ldID0gdDsKICB9CiAgX3JlbW92ZUluYWN0aXZlQWN0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLl9hY3Rpb25zLCBpID0gZVtlLmxlbmd0aCAtIDFdLCBuID0gdC5fY2FjaGVJbmRleDsKICAgIGkuX2NhY2hlSW5kZXggPSBuLCBlW25dID0gaSwgZS5wb3AoKSwgdC5fY2FjaGVJbmRleCA9IG51bGw7CiAgICBjb25zdCBzID0gdC5fY2xpcC51dWlkLCByID0gdGhpcy5fYWN0aW9uc0J5Q2xpcCwgbyA9IHJbc10sIGwgPSBvLmtub3duQWN0aW9ucywgaCA9IGxbbC5sZW5ndGggLSAxXSwgYyA9IHQuX2J5Q2xpcENhY2hlSW5kZXg7CiAgICBoLl9ieUNsaXBDYWNoZUluZGV4ID0gYywgbFtjXSA9IGgsIGwucG9wKCksIHQuX2J5Q2xpcENhY2hlSW5kZXggPSBudWxsOwogICAgY29uc3QgdSA9IG8uYWN0aW9uQnlSb290LCBkID0gKHQuX2xvY2FsUm9vdCB8fCB0aGlzLl9yb290KS51dWlkOwogICAgZGVsZXRlIHVbZF0sIGwubGVuZ3RoID09PSAwICYmIGRlbGV0ZSByW3NdLCB0aGlzLl9yZW1vdmVJbmFjdGl2ZUJpbmRpbmdzRm9yQWN0aW9uKHQpOwogIH0KICBfcmVtb3ZlSW5hY3RpdmVCaW5kaW5nc0ZvckFjdGlvbih0KSB7CiAgICBjb25zdCBlID0gdC5fcHJvcGVydHlCaW5kaW5nczsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gZS5sZW5ndGg7IGkgIT09IG47ICsraSkgewogICAgICBjb25zdCBzID0gZVtpXTsKICAgICAgLS1zLnJlZmVyZW5jZUNvdW50ID09PSAwICYmIHRoaXMuX3JlbW92ZUluYWN0aXZlQmluZGluZyhzKTsKICAgIH0KICB9CiAgX2xlbmRBY3Rpb24odCkgewogICAgY29uc3QgZSA9IHRoaXMuX2FjdGlvbnMsIGkgPSB0Ll9jYWNoZUluZGV4LCBuID0gdGhpcy5fbkFjdGl2ZUFjdGlvbnMrKywgcyA9IGVbbl07CiAgICB0Ll9jYWNoZUluZGV4ID0gbiwgZVtuXSA9IHQsIHMuX2NhY2hlSW5kZXggPSBpLCBlW2ldID0gczsKICB9CiAgX3Rha2VCYWNrQWN0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLl9hY3Rpb25zLCBpID0gdC5fY2FjaGVJbmRleCwgbiA9IC0tdGhpcy5fbkFjdGl2ZUFjdGlvbnMsIHMgPSBlW25dOwogICAgdC5fY2FjaGVJbmRleCA9IG4sIGVbbl0gPSB0LCBzLl9jYWNoZUluZGV4ID0gaSwgZVtpXSA9IHM7CiAgfQogIC8vIE1lbW9yeSBtYW5hZ2VtZW50IGZvciBQcm9wZXJ0eU1peGVyIG9iamVjdHMKICBfYWRkSW5hY3RpdmVCaW5kaW5nKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLl9iaW5kaW5nc0J5Um9vdEFuZE5hbWUsIHMgPSB0aGlzLl9iaW5kaW5nczsKICAgIGxldCByID0gbltlXTsKICAgIHIgPT09IHZvaWQgMCAmJiAociA9IHt9LCBuW2VdID0gciksIHJbaV0gPSB0LCB0Ll9jYWNoZUluZGV4ID0gcy5sZW5ndGgsIHMucHVzaCh0KTsKICB9CiAgX3JlbW92ZUluYWN0aXZlQmluZGluZyh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5fYmluZGluZ3MsIGkgPSB0LmJpbmRpbmcsIG4gPSBpLnJvb3ROb2RlLnV1aWQsIHMgPSBpLnBhdGgsIHIgPSB0aGlzLl9iaW5kaW5nc0J5Um9vdEFuZE5hbWUsIG8gPSByW25dLCBsID0gZVtlLmxlbmd0aCAtIDFdLCBoID0gdC5fY2FjaGVJbmRleDsKICAgIGwuX2NhY2hlSW5kZXggPSBoLCBlW2hdID0gbCwgZS5wb3AoKSwgZGVsZXRlIG9bc10sIE9iamVjdC5rZXlzKG8pLmxlbmd0aCA9PT0gMCAmJiBkZWxldGUgcltuXTsKICB9CiAgX2xlbmRCaW5kaW5nKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLl9iaW5kaW5ncywgaSA9IHQuX2NhY2hlSW5kZXgsIG4gPSB0aGlzLl9uQWN0aXZlQmluZGluZ3MrKywgcyA9IGVbbl07CiAgICB0Ll9jYWNoZUluZGV4ID0gbiwgZVtuXSA9IHQsIHMuX2NhY2hlSW5kZXggPSBpLCBlW2ldID0gczsKICB9CiAgX3Rha2VCYWNrQmluZGluZyh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5fYmluZGluZ3MsIGkgPSB0Ll9jYWNoZUluZGV4LCBuID0gLS10aGlzLl9uQWN0aXZlQmluZGluZ3MsIHMgPSBlW25dOwogICAgdC5fY2FjaGVJbmRleCA9IG4sIGVbbl0gPSB0LCBzLl9jYWNoZUluZGV4ID0gaSwgZVtpXSA9IHM7CiAgfQogIC8vIE1lbW9yeSBtYW5hZ2VtZW50IG9mIEludGVycG9sYW50cyBmb3Igd2VpZ2h0IGFuZCB0aW1lIHNjYWxlCiAgX2xlbmRDb250cm9sSW50ZXJwb2xhbnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5fY29udHJvbEludGVycG9sYW50cywgZSA9IHRoaXMuX25BY3RpdmVDb250cm9sSW50ZXJwb2xhbnRzKys7CiAgICBsZXQgaSA9IHRbZV07CiAgICByZXR1cm4gaSA9PT0gdm9pZCAwICYmIChpID0gbmV3IHRmKAogICAgICBuZXcgRmxvYXQzMkFycmF5KDIpLAogICAgICBuZXcgRmxvYXQzMkFycmF5KDIpLAogICAgICAxLAogICAgICBwTQogICAgKSwgaS5fX2NhY2hlSW5kZXggPSBlLCB0W2VdID0gaSksIGk7CiAgfQogIF90YWtlQmFja0NvbnRyb2xJbnRlcnBvbGFudCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5fY29udHJvbEludGVycG9sYW50cywgaSA9IHQuX19jYWNoZUluZGV4LCBuID0gLS10aGlzLl9uQWN0aXZlQ29udHJvbEludGVycG9sYW50cywgcyA9IGVbbl07CiAgICB0Ll9fY2FjaGVJbmRleCA9IG4sIGVbbl0gPSB0LCBzLl9fY2FjaGVJbmRleCA9IGksIGVbaV0gPSBzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGFuIGluc3RhbmNlIG9mIHtAbGluayBBbmltYXRpb25BY3Rpb259IGZvciB0aGUgcGFzc2VkIGNsaXAuCiAgICoKICAgKiBJZiBhbiBhY3Rpb24gZml0dGluZyB0aGUgY2xpcCBhbmQgcm9vdCBwYXJhbWV0ZXJzIGRvZXNuJ3QgeWV0IGV4aXN0LCBpdAogICAqIHdpbGwgYmUgY3JlYXRlZCBieSB0aGlzIG1ldGhvZC4gQ2FsbGluZyB0aGlzIG1ldGhvZCBzZXZlcmFsIHRpbWVzIHdpdGggdGhlCiAgICogc2FtZSBjbGlwIGFuZCByb290IHBhcmFtZXRlcnMgYWx3YXlzIHJldHVybnMgdGhlIHNhbWUgYWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtBbmltYXRpb25DbGlwfHN0cmluZ30gY2xpcCAtIEFuIGFuaW1hdGlvbiBjbGlwIG9yIGFsdGVybmF0aXZlbHkgdGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiBjbGlwLgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IFtvcHRpb25hbFJvb3RdIC0gQW4gYWx0ZXJuYXRpdmUgcm9vdCBvYmplY3QuCiAgICogQHBhcmFtIHsoTm9ybWFsQW5pbWF0aW9uQmxlbmRNb2RlfEFkZGl0aXZlQW5pbWF0aW9uQmxlbmRNb2RlKX0gW2JsZW5kTW9kZV0gLSBUaGUgYmxlbmQgbW9kZS4KICAgKiBAcmV0dXJuIHs/QW5pbWF0aW9uQWN0aW9ufSBUaGUgYW5pbWF0aW9uIGFjdGlvbi4KICAgKi8KICBjbGlwQWN0aW9uKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBlIHx8IHRoaXMuX3Jvb3QsIHMgPSBuLnV1aWQ7CiAgICBsZXQgciA9IHR5cGVvZiB0ID09ICJzdHJpbmciID8gTWEuZmluZEJ5TmFtZShuLCB0KSA6IHQ7CiAgICBjb25zdCBvID0gciAhPT0gbnVsbCA/IHIudXVpZCA6IHQsIGwgPSB0aGlzLl9hY3Rpb25zQnlDbGlwW29dOwogICAgbGV0IGggPSBudWxsOwogICAgaWYgKGkgPT09IHZvaWQgMCAmJiAociAhPT0gbnVsbCA/IGkgPSByLmJsZW5kTW9kZSA6IGkgPSBVYyksIGwgIT09IHZvaWQgMCkgewogICAgICBjb25zdCB1ID0gbC5hY3Rpb25CeVJvb3Rbc107CiAgICAgIGlmICh1ICE9PSB2b2lkIDAgJiYgdS5ibGVuZE1vZGUgPT09IGkpCiAgICAgICAgcmV0dXJuIHU7CiAgICAgIGggPSBsLmtub3duQWN0aW9uc1swXSwgciA9PT0gbnVsbCAmJiAociA9IGguX2NsaXApOwogICAgfQogICAgaWYgKHIgPT09IG51bGwpIHJldHVybiBudWxsOwogICAgY29uc3QgYyA9IG5ldyBnXyh0aGlzLCByLCBlLCBpKTsKICAgIHJldHVybiB0aGlzLl9iaW5kQWN0aW9uKGMsIGgpLCB0aGlzLl9hZGRJbmFjdGl2ZUFjdGlvbihjLCBvLCBzKSwgYzsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhbiBleGlzdGluZyBhbmltYXRpb24gYWN0aW9uIGZvciB0aGUgcGFzc2VkIGNsaXAuCiAgICoKICAgKiBAcGFyYW0ge0FuaW1hdGlvbkNsaXB8c3RyaW5nfSBjbGlwIC0gQW4gYW5pbWF0aW9uIGNsaXAgb3IgYWx0ZXJuYXRpdmVseSB0aGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIGNsaXAuCiAgICogQHBhcmFtIHtPYmplY3QzRH0gW29wdGlvbmFsUm9vdF0gLSBBbiBhbHRlcm5hdGl2ZSByb290IG9iamVjdC4KICAgKiBAcmV0dXJuIHs/QW5pbWF0aW9uQWN0aW9ufSBUaGUgYW5pbWF0aW9uIGFjdGlvbi4gUmV0dXJucyBgbnVsbGAgaWYgbm8gYWN0aW9uIHdhcyBmb3VuZC4KICAgKi8KICBleGlzdGluZ0FjdGlvbih0LCBlKSB7CiAgICBjb25zdCBpID0gZSB8fCB0aGlzLl9yb290LCBuID0gaS51dWlkLCBzID0gdHlwZW9mIHQgPT0gInN0cmluZyIgPyBNYS5maW5kQnlOYW1lKGksIHQpIDogdCwgciA9IHMgPyBzLnV1aWQgOiB0LCBvID0gdGhpcy5fYWN0aW9uc0J5Q2xpcFtyXTsKICAgIHJldHVybiBvICE9PSB2b2lkIDAgJiYgby5hY3Rpb25CeVJvb3Rbbl0gfHwgbnVsbDsKICB9CiAgLyoqCiAgICogRGVhY3RpdmF0ZXMgYWxsIHByZXZpb3VzbHkgc2NoZWR1bGVkIGFjdGlvbnMgb24gdGhpcyBtaXhlci4KICAgKgogICAqIEByZXR1cm4ge0FuaW1hdGlvbk1peGVyfSBBIHJlZmVyZW5jZSB0byB0aGkgYW5pbWF0aW9uIG1peGVyLgogICAqLwogIHN0b3BBbGxBY3Rpb24oKSB7CiAgICBjb25zdCB0ID0gdGhpcy5fYWN0aW9ucywgZSA9IHRoaXMuX25BY3RpdmVBY3Rpb25zOwogICAgZm9yIChsZXQgaSA9IGUgLSAxOyBpID49IDA7IC0taSkKICAgICAgdFtpXS5zdG9wKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogQWR2YW5jZXMgdGhlIGdsb2JhbCBtaXhlciB0aW1lIGFuZCB1cGRhdGVzIHRoZSBhbmltYXRpb24uCiAgICoKICAgKiBUaGlzIGlzIHVzdWFsbHkgZG9uZSBpbiB0aGUgcmVuZGVyIGxvb3AgYnkgcGFzc2luZyB0aGUgZGVsdGEKICAgKiB0aW1lIGZyb20ge0BsaW5rIENsb2NrfSBvciB7QGxpbmsgVGltZXJ9LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRlbHRhVGltZSAtIFRoZSBkZWx0YSB0aW1lIGluIHNlY29uZHMuCiAgICogQHJldHVybiB7QW5pbWF0aW9uTWl4ZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaSBhbmltYXRpb24gbWl4ZXIuCiAgICovCiAgdXBkYXRlKHQpIHsKICAgIHQgKj0gdGhpcy50aW1lU2NhbGU7CiAgICBjb25zdCBlID0gdGhpcy5fYWN0aW9ucywgaSA9IHRoaXMuX25BY3RpdmVBY3Rpb25zLCBuID0gdGhpcy50aW1lICs9IHQsIHMgPSBNYXRoLnNpZ24odCksIHIgPSB0aGlzLl9hY2N1SW5kZXggXj0gMTsKICAgIGZvciAobGV0IGggPSAwOyBoICE9PSBpOyArK2gpCiAgICAgIGVbaF0uX3VwZGF0ZShuLCB0LCBzLCByKTsKICAgIGNvbnN0IG8gPSB0aGlzLl9iaW5kaW5ncywgbCA9IHRoaXMuX25BY3RpdmVCaW5kaW5nczsKICAgIGZvciAobGV0IGggPSAwOyBoICE9PSBsOyArK2gpCiAgICAgIG9baF0uYXBwbHkocik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2xvYmFsIG1peGVyIHRvIGEgc3BlY2lmaWMgdGltZSBhbmQgdXBkYXRlcyB0aGUgYW5pbWF0aW9uIGFjY29yZGluZ2x5LgogICAqCiAgICogVGhpcyBpcyB1c2VmdWwgd2hlbiB5b3UgbmVlZCB0byBqdW1wIHRvIGFuIGV4YWN0IHRpbWUgaW4gYW4gYW5pbWF0aW9uLiBUaGUKICAgKiBpbnB1dCBwYXJhbWV0ZXIgd2lsbCBiZSBzY2FsZWQgYnkge0BsaW5rIEFuaW1hdGlvbk1peGVyI3RpbWVTY2FsZX0KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gVGhlIHRpbWUgdG8gc2V0IGluIHNlY29uZHMuCiAgICogQHJldHVybiB7QW5pbWF0aW9uTWl4ZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaSBhbmltYXRpb24gbWl4ZXIuCiAgICovCiAgc2V0VGltZSh0KSB7CiAgICB0aGlzLnRpbWUgPSAwOwogICAgZm9yIChsZXQgZSA9IDA7IGUgPCB0aGlzLl9hY3Rpb25zLmxlbmd0aDsgZSsrKQogICAgICB0aGlzLl9hY3Rpb25zW2VdLnRpbWUgPSAwOwogICAgcmV0dXJuIHRoaXMudXBkYXRlKHQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoaXMgbWl4ZXIncyByb290IG9iamVjdC4KICAgKgogICAqIEByZXR1cm4ge09iamVjdDNEfSBUaGUgbWl4ZXIncyByb290IG9iamVjdC4KICAgKi8KICBnZXRSb290KCkgewogICAgcmV0dXJuIHRoaXMuX3Jvb3Q7CiAgfQogIC8qKgogICAqIERlYWxsb2NhdGVzIGFsbCBtZW1vcnkgcmVzb3VyY2VzIGZvciBhIGNsaXAuIEJlZm9yZSB1c2luZyB0aGlzIG1ldGhvZCBtYWtlCiAgICogc3VyZSB0byBjYWxsIHtAbGluayBBbmltYXRpb25BY3Rpb24jc3RvcH0gZm9yIGFsbCByZWxhdGVkIGFjdGlvbnMuCiAgICoKICAgKiBAcGFyYW0ge0FuaW1hdGlvbkNsaXB9IGNsaXAgLSBUaGUgY2xpcCB0byB1bmNhY2hlLgogICAqLwogIHVuY2FjaGVDbGlwKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLl9hY3Rpb25zLCBpID0gdC51dWlkLCBuID0gdGhpcy5fYWN0aW9uc0J5Q2xpcCwgcyA9IG5baV07CiAgICBpZiAocyAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IHIgPSBzLmtub3duQWN0aW9uczsKICAgICAgZm9yIChsZXQgbyA9IDAsIGwgPSByLmxlbmd0aDsgbyAhPT0gbDsgKytvKSB7CiAgICAgICAgY29uc3QgaCA9IHJbb107CiAgICAgICAgdGhpcy5fZGVhY3RpdmF0ZUFjdGlvbihoKTsKICAgICAgICBjb25zdCBjID0gaC5fY2FjaGVJbmRleCwgdSA9IGVbZS5sZW5ndGggLSAxXTsKICAgICAgICBoLl9jYWNoZUluZGV4ID0gbnVsbCwgaC5fYnlDbGlwQ2FjaGVJbmRleCA9IG51bGwsIHUuX2NhY2hlSW5kZXggPSBjLCBlW2NdID0gdSwgZS5wb3AoKSwgdGhpcy5fcmVtb3ZlSW5hY3RpdmVCaW5kaW5nc0ZvckFjdGlvbihoKTsKICAgICAgfQogICAgICBkZWxldGUgbltpXTsKICAgIH0KICB9CiAgLyoqCiAgICogRGVhbGxvY2F0ZXMgYWxsIG1lbW9yeSByZXNvdXJjZXMgZm9yIGEgcm9vdCBvYmplY3QuIEJlZm9yZSB1c2luZyB0aGlzCiAgICogbWV0aG9kIG1ha2Ugc3VyZSB0byBjYWxsIHtAbGluayBBbmltYXRpb25BY3Rpb24jc3RvcH0gZm9yIGFsbCByZWxhdGVkCiAgICogYWN0aW9ucyBvciBhbHRlcm5hdGl2ZWx5IHtAbGluayBBbmltYXRpb25NaXhlciNzdG9wQWxsQWN0aW9ufSB3aGVuIHRoZQogICAqIG1peGVyIG9wZXJhdGVzIG9uIGEgc2luZ2xlIHJvb3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdDNEfSByb290IC0gVGhlIHJvb3Qgb2JqZWN0IHRvIHVuY2FjaGUuCiAgICovCiAgdW5jYWNoZVJvb3QodCkgewogICAgY29uc3QgZSA9IHQudXVpZCwgaSA9IHRoaXMuX2FjdGlvbnNCeUNsaXA7CiAgICBmb3IgKGNvbnN0IHIgaW4gaSkgewogICAgICBjb25zdCBvID0gaVtyXS5hY3Rpb25CeVJvb3QsIGwgPSBvW2VdOwogICAgICBsICE9PSB2b2lkIDAgJiYgKHRoaXMuX2RlYWN0aXZhdGVBY3Rpb24obCksIHRoaXMuX3JlbW92ZUluYWN0aXZlQWN0aW9uKGwpKTsKICAgIH0KICAgIGNvbnN0IG4gPSB0aGlzLl9iaW5kaW5nc0J5Um9vdEFuZE5hbWUsIHMgPSBuW2VdOwogICAgaWYgKHMgIT09IHZvaWQgMCkKICAgICAgZm9yIChjb25zdCByIGluIHMpIHsKICAgICAgICBjb25zdCBvID0gc1tyXTsKICAgICAgICBvLnJlc3RvcmVPcmlnaW5hbFN0YXRlKCksIHRoaXMuX3JlbW92ZUluYWN0aXZlQmluZGluZyhvKTsKICAgICAgfQogIH0KICAvKioKICAgKiBEZWFsbG9jYXRlcyBhbGwgbWVtb3J5IHJlc291cmNlcyBmb3IgYW4gYWN0aW9uLiBUaGUgYWN0aW9uIGlzIGlkZW50aWZpZWQgYnkgdGhlCiAgICogZ2l2ZW4gY2xpcCBhbmQgYW4gb3B0aW9uYWwgcm9vdCBvYmplY3QuIEJlZm9yZSB1c2luZyB0aGlzIG1ldGhvZCBtYWtlCiAgICogc3VyZSB0byBjYWxsIHtAbGluayBBbmltYXRpb25BY3Rpb24jc3RvcH0gdG8gZGVhY3RpdmF0ZSB0aGUgYWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtBbmltYXRpb25DbGlwfHN0cmluZ30gY2xpcCAtIEFuIGFuaW1hdGlvbiBjbGlwIG9yIGFsdGVybmF0aXZlbHkgdGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiBjbGlwLgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IFtvcHRpb25hbFJvb3RdIC0gQW4gYWx0ZXJuYXRpdmUgcm9vdCBvYmplY3QuCiAgICovCiAgdW5jYWNoZUFjdGlvbih0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5leGlzdGluZ0FjdGlvbih0LCBlKTsKICAgIGkgIT09IG51bGwgJiYgKHRoaXMuX2RlYWN0aXZhdGVBY3Rpb24oaSksIHRoaXMuX3JlbW92ZUluYWN0aXZlQWN0aW9uKGkpKTsKICB9Cn0KY2xhc3MgZk0gZXh0ZW5kcyBCcCB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzRCByZW5kZXIgdGFyZ2V0LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0xXSAtIFRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRhcmdldC4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodD0xXSAtIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0YXJnZXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkZXB0aD0xXSAtIFRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0YXJnZXQuCiAgICogQHBhcmFtIHtSZW5kZXJUYXJnZXR+T3B0aW9uc30gW29wdGlvbnNdIC0gVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMSwgaSA9IDEsIG4gPSB7fSkgewogICAgc3VwZXIodCwgZSwgbiksIHRoaXMuaXNSZW5kZXJUYXJnZXQzRCA9ICEwLCB0aGlzLmRlcHRoID0gaSwgdGhpcy50ZXh0dXJlID0gbmV3IHpjKG51bGwsIHQsIGUsIGkpLCB0aGlzLl9zZXRUZXh0dXJlT3B0aW9ucyhuKSwgdGhpcy50ZXh0dXJlLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9ICEwOwogIH0KfQpjbGFzcyB1ZiB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyB1bmlmb3JtLgogICAqCiAgICogQHBhcmFtIHthbnl9IHZhbHVlIC0gVGhlIHVuaWZvcm0gdmFsdWUuCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgdGhpcy52YWx1ZSA9IHQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgdW5pZm9ybSB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqIElmIHRoZSB2YWx1ZSBoYXMgYSBgY2xvbmUoKWAgbWV0aG9kLCB0aGUgdmFsdWUgaXMgY2xvbmVkIGFzIHdlbGwuCiAgICoKICAgKiBAcmV0dXJuIHtVbmlmb3JtfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHVmKHRoaXMudmFsdWUuY2xvbmUgPT09IHZvaWQgMCA/IHRoaXMudmFsdWUgOiB0aGlzLnZhbHVlLmNsb25lKCkpOwogIH0KfQpsZXQgbU0gPSAwOwpjbGFzcyBnTSBleHRlbmRzIEVpIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHVuaWZvcm1zIGdyb3VwLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc1VuaWZvcm1zR3JvdXAgPSAhMCwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJpZCIsIHsgdmFsdWU6IG1NKysgfSksIHRoaXMubmFtZSA9ICIiLCB0aGlzLnVzYWdlID0gQ28sIHRoaXMudW5pZm9ybXMgPSBbXTsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gdW5pZm9ybSB0byB0aGlzIHVuaWZvcm1zIGdyb3VwLgogICAqCiAgICogQHBhcmFtIHtVbmlmb3JtfSB1bmlmb3JtIC0gVGhlIHVuaWZvcm0gdG8gYWRkLgogICAqIEByZXR1cm4ge1VuaWZvcm1zR3JvdXB9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdW5pZm9ybXMgZ3JvdXAuCiAgICovCiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnB1c2godCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgdGhlIGdpdmVuIHVuaWZvcm0gZnJvbSB0aGlzIHVuaWZvcm1zIGdyb3VwLgogICAqCiAgICogQHBhcmFtIHtVbmlmb3JtfSB1bmlmb3JtIC0gVGhlIHVuaWZvcm0gdG8gcmVtb3ZlLgogICAqIEByZXR1cm4ge1VuaWZvcm1zR3JvdXB9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdW5pZm9ybXMgZ3JvdXAuCiAgICovCiAgcmVtb3ZlKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnVuaWZvcm1zLmluZGV4T2YodCk7CiAgICByZXR1cm4gZSAhPT0gLTEgJiYgdGhpcy51bmlmb3Jtcy5zcGxpY2UoZSwgMSksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIG5hbWUgb2YgdGhpcyB1bmlmb3JtcyBncm91cC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgdG8gc2V0LgogICAqIEByZXR1cm4ge1VuaWZvcm1zR3JvdXB9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdW5pZm9ybXMgZ3JvdXAuCiAgICovCiAgc2V0TmFtZSh0KSB7CiAgICByZXR1cm4gdGhpcy5uYW1lID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdXNhZ2Ugb2YgdGhpcyB1bmlmb3JtcyBncm91cC4KICAgKgogICAqIEBwYXJhbSB7KFN0YXRpY0RyYXdVc2FnZXxEeW5hbWljRHJhd1VzYWdlfFN0cmVhbURyYXdVc2FnZXxTdGF0aWNSZWFkVXNhZ2V8RHluYW1pY1JlYWRVc2FnZXxTdHJlYW1SZWFkVXNhZ2V8U3RhdGljQ29weVVzYWdlfER5bmFtaWNDb3B5VXNhZ2V8U3RyZWFtQ29weVVzYWdlKX0gdmFsdWUgLSBUaGUgdXNhZ2UgdG8gc2V0LgogICAqIEByZXR1cm4ge1VuaWZvcm1zR3JvdXB9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdW5pZm9ybXMgZ3JvdXAuCiAgICovCiAgc2V0VXNhZ2UodCkgewogICAgcmV0dXJuIHRoaXMudXNhZ2UgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKgogICAqIEBmaXJlcyBUZXh0dXJlI2Rpc3Bvc2UKICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5kaXNwYXRjaEV2ZW50KHsgdHlwZTogImRpc3Bvc2UiIH0pOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gdW5pZm9ybXMgZ3JvdXAgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VW5pZm9ybXNHcm91cH0gc291cmNlIC0gVGhlIHVuaWZvcm1zIGdyb3VwIHRvIGNvcHkuCiAgICogQHJldHVybiB7VW5pZm9ybXNHcm91cH0gQSByZWZlcmVuY2UgdG8gdGhpcyB1bmlmb3JtcyBncm91cC4KICAgKi8KICBjb3B5KHQpIHsKICAgIHRoaXMubmFtZSA9IHQubmFtZSwgdGhpcy51c2FnZSA9IHQudXNhZ2U7CiAgICBjb25zdCBlID0gdC51bmlmb3JtczsKICAgIHRoaXMudW5pZm9ybXMubGVuZ3RoID0gMDsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gZS5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgcyA9IEFycmF5LmlzQXJyYXkoZVtpXSkgPyBlW2ldIDogW2VbaV1dOwogICAgICBmb3IgKGxldCByID0gMDsgciA8IHMubGVuZ3RoOyByKyspCiAgICAgICAgdGhpcy51bmlmb3Jtcy5wdXNoKHNbcl0uY2xvbmUoKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyB1bmlmb3JtcyBncm91cCB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7VW5pZm9ybXNHcm91cH0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9Cn0KbGV0IHZjID0gY2xhc3MgZXh0ZW5kcyBHYyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBpbnN0YW5jZWQgaW50ZXJsZWF2ZWQgYnVmZmVyLgogICAqCiAgICogQHBhcmFtIHtUeXBlZEFycmF5fSBhcnJheSAtIEEgdHlwZWQgYXJyYXkgd2l0aCBhIHNoYXJlZCBidWZmZXIgc3RvcmluZyBhdHRyaWJ1dGUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gc3RyaWRlIC0gVGhlIG51bWJlciBvZiB0eXBlZC1hcnJheSBlbGVtZW50cyBwZXIgdmVydGV4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWVzaFBlckF0dHJpYnV0ZT0xXSAtIERlZmluZXMgaG93IG9mdGVuIGEgdmFsdWUgb2YgdGhpcyBpbnRlcmxlYXZlZCBidWZmZXIgc2hvdWxkIGJlIHJlcGVhdGVkLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkgPSAxKSB7CiAgICBzdXBlcih0LCBlKSwgdGhpcy5pc0luc3RhbmNlZEludGVybGVhdmVkQnVmZmVyID0gITAsIHRoaXMubWVzaFBlckF0dHJpYnV0ZSA9IGk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMubWVzaFBlckF0dHJpYnV0ZSA9IHQubWVzaFBlckF0dHJpYnV0ZSwgdGhpczsKICB9CiAgY2xvbmUodCkgewogICAgY29uc3QgZSA9IHN1cGVyLmNsb25lKHQpOwogICAgcmV0dXJuIGUubWVzaFBlckF0dHJpYnV0ZSA9IHRoaXMubWVzaFBlckF0dHJpYnV0ZSwgZTsKICB9CiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSBzdXBlci50b0pTT04odCk7CiAgICByZXR1cm4gZS5pc0luc3RhbmNlZEludGVybGVhdmVkQnVmZmVyID0gITAsIGUubWVzaFBlckF0dHJpYnV0ZSA9IHRoaXMubWVzaFBlckF0dHJpYnV0ZSwgZTsKICB9Cn07CmNsYXNzIHlNIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IEdMIGJ1ZmZlciBhdHRyaWJ1dGUuCiAgICoKICAgKiBAcGFyYW0ge1dlYkdMQnVmZmVyfSBidWZmZXIgLSBUaGUgbmF0aXZlIFdlYkdMIGJ1ZmZlci4KICAgKiBAcGFyYW0ge251bWJlcn0gdHlwZSAtIFRoZSBuYXRpdmUgZGF0YSB0eXBlIChlLmcuIGBnbC5GTE9BVGApLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpdGVtU2l6ZSAtIFRoZSBpdGVtIHNpemUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGVsZW1lbnRTaXplIC0gVGhlIGNvcnJlc3BvbmRpbmcgc2l6ZSAoaW4gYnl0ZXMpIGZvciB0aGUgZ2l2ZW4gYHR5cGVgIHBhcmFtZXRlci4KICAgKiBAcGFyYW0ge251bWJlcn0gY291bnQgLSBUaGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHZlcnRpY2VzIGluIFZCTy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3JtYWxpemVkPWZhbHNlXSAtIFdoZXRoZXIgdGhlIGRhdGEgYXJlIG5vcm1hbGl6ZWQgb3Igbm90LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIgPSAhMSkgewogICAgdGhpcy5pc0dMQnVmZmVyQXR0cmlidXRlID0gITAsIHRoaXMubmFtZSA9ICIiLCB0aGlzLmJ1ZmZlciA9IHQsIHRoaXMudHlwZSA9IGUsIHRoaXMuaXRlbVNpemUgPSBpLCB0aGlzLmVsZW1lbnRTaXplID0gbiwgdGhpcy5jb3VudCA9IHMsIHRoaXMubm9ybWFsaXplZCA9IHIsIHRoaXMudmVyc2lvbiA9IDA7CiAgfQogIC8qKgogICAqIEZsYWcgdG8gaW5kaWNhdGUgdGhhdCB0aGlzIGF0dHJpYnV0ZSBoYXMgY2hhbmdlZCBhbmQgc2hvdWxkIGJlIHJlLXNlbnQgdG8KICAgKiB0aGUgR1BVLiBTZXQgdGhpcyB0byBgdHJ1ZWAgd2hlbiB5b3UgbW9kaWZ5IHRoZSB2YWx1ZSBvZiB0aGUgYXJyYXkuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IGZhbHNlCiAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZQogICAqLwogIHNldCBuZWVkc1VwZGF0ZSh0KSB7CiAgICB0ID09PSAhMCAmJiB0aGlzLnZlcnNpb24rKzsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gbmF0aXZlIFdlYkdMIGJ1ZmZlci4KICAgKgogICAqIEBwYXJhbSB7V2ViR0xCdWZmZXJ9IGJ1ZmZlciAtIFRoZSBidWZmZXIgdG8gc2V0LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRCdWZmZXIodCkgewogICAgcmV0dXJuIHRoaXMuYnVmZmVyID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gbmF0aXZlIGRhdGEgdHlwZSBhbmQgZWxlbWVudCBzaXplLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHR5cGUgLSBUaGUgbmF0aXZlIGRhdGEgdHlwZSAoZS5nLiBgZ2wuRkxPQVRgKS4KICAgKiBAcGFyYW0ge251bWJlcn0gZWxlbWVudFNpemUgLSBUaGUgY29ycmVzcG9uZGluZyBzaXplIChpbiBieXRlcykgZm9yIHRoZSBnaXZlbiBgdHlwZWAgcGFyYW1ldGVyLgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRUeXBlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnR5cGUgPSB0LCB0aGlzLmVsZW1lbnRTaXplID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgaXRlbSBzaXplLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGl0ZW1TaXplIC0gVGhlIGl0ZW0gc2l6ZS4KICAgKiBAcmV0dXJuIHtCdWZmZXJBdHRyaWJ1dGV9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgc2V0SXRlbVNpemUodCkgewogICAgcmV0dXJuIHRoaXMuaXRlbVNpemUgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjb3VudCAodGhlIGV4cGVjdGVkIG51bWJlciBvZiB2ZXJ0aWNlcyBpbiBWQk8pLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvdW50IC0gVGhlIGNvdW50LgogICAqIEByZXR1cm4ge0J1ZmZlckF0dHJpYnV0ZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRDb3VudCh0KSB7CiAgICByZXR1cm4gdGhpcy5jb3VudCA9IHQsIHRoaXM7CiAgfQp9CmNvbnN0IFRtID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpOwpsZXQgX18gPSBjbGFzcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyByYXljYXN0ZXIuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IG9yaWdpbiAtIFRoZSBvcmlnaW4gdmVjdG9yIHdoZXJlIHRoZSByYXkgY2FzdHMgZnJvbS4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGRpcmVjdGlvbiAtIFRoZSAobm9ybWFsaXplZCkgZGlyZWN0aW9uIHZlY3RvciB0aGF0IGdpdmVzIGRpcmVjdGlvbiB0byB0aGUgcmF5LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbmVhcj0wXSAtIEFsbCByZXN1bHRzIHJldHVybmVkIGFyZSBmdXJ0aGVyIGF3YXkgdGhhbiBuZWFyLiBOZWFyIGNhbid0IGJlIG5lZ2F0aXZlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZmFyPUluZmluaXR5XSAtIEFsbCByZXN1bHRzIHJldHVybmVkIGFyZSBjbG9zZXIgdGhhbiBmYXIuIEZhciBjYW4ndCBiZSBsb3dlciB0aGFuIG5lYXIuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSA9IDAsIG4gPSAxIC8gMCkgewogICAgdGhpcy5yYXkgPSBuZXcgQWEodCwgZSksIHRoaXMubmVhciA9IGksIHRoaXMuZmFyID0gbiwgdGhpcy5jYW1lcmEgPSBudWxsLCB0aGlzLmxheWVycyA9IG5ldyBOYygpLCB0aGlzLnBhcmFtcyA9IHsKICAgICAgTWVzaDoge30sCiAgICAgIExpbmU6IHsgdGhyZXNob2xkOiAxIH0sCiAgICAgIExPRDoge30sCiAgICAgIFBvaW50czogeyB0aHJlc2hvbGQ6IDEgfSwKICAgICAgU3ByaXRlOiB7fQogICAgfTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgcmF5IHdpdGggYSBuZXcgb3JpZ2luIGFuZCBkaXJlY3Rpb24gYnkgY29weWluZyB0aGUgdmFsdWVzIGZyb20gdGhlIGFyZ3VtZW50cy4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gb3JpZ2luIC0gVGhlIG9yaWdpbiB2ZWN0b3Igd2hlcmUgdGhlIHJheSBjYXN0cyBmcm9tLgogICAqIEBwYXJhbSB7VmVjdG9yM30gZGlyZWN0aW9uIC0gVGhlIChub3JtYWxpemVkKSBkaXJlY3Rpb24gdmVjdG9yIHRoYXQgZ2l2ZXMgZGlyZWN0aW9uIHRvIHRoZSByYXkuCiAgICovCiAgc2V0KHQsIGUpIHsKICAgIHRoaXMucmF5LnNldCh0LCBlKTsKICB9CiAgLyoqCiAgICogVXNlcyB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMgYW5kIGNhbWVyYSB0byBjb21wdXRlIGEgbmV3IG9yaWdpbiBhbmQgZGlyZWN0aW9uIGZvciB0aGUgaW50ZXJuYWwgcmF5LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBjb29yZHMgLSAyRCBjb29yZGluYXRlcyBvZiB0aGUgbW91c2UsIGluIG5vcm1hbGl6ZWQgZGV2aWNlIGNvb3JkaW5hdGVzIChOREMpLgogICAqIFggYW5kIFkgY29tcG9uZW50cyBzaG91bGQgYmUgYmV0d2VlbiBgLTFgIGFuZCBgMWAuCiAgICogQHBhcmFtIHtDYW1lcmF9IGNhbWVyYSAtIFRoZSBjYW1lcmEgZnJvbSB3aGljaCB0aGUgcmF5IHNob3VsZCBvcmlnaW5hdGUuCiAgICovCiAgc2V0RnJvbUNhbWVyYSh0LCBlKSB7CiAgICBlLmlzUGVyc3BlY3RpdmVDYW1lcmEgPyAodGhpcy5yYXkub3JpZ2luLnNldEZyb21NYXRyaXhQb3NpdGlvbihlLm1hdHJpeFdvcmxkKSwgdGhpcy5yYXkuZGlyZWN0aW9uLnNldCh0LngsIHQueSwgMC41KS51bnByb2plY3QoZSkuc3ViKHRoaXMucmF5Lm9yaWdpbikubm9ybWFsaXplKCksIHRoaXMuY2FtZXJhID0gZSkgOiBlLmlzT3J0aG9ncmFwaGljQ2FtZXJhID8gKHRoaXMucmF5Lm9yaWdpbi5zZXQodC54LCB0LnksIChlLm5lYXIgKyBlLmZhcikgLyAoZS5uZWFyIC0gZS5mYXIpKS51bnByb2plY3QoZSksIHRoaXMucmF5LmRpcmVjdGlvbi5zZXQoMCwgMCwgLTEpLnRyYW5zZm9ybURpcmVjdGlvbihlLm1hdHJpeFdvcmxkKSwgdGhpcy5jYW1lcmEgPSBlKSA6IGNvbnNvbGUuZXJyb3IoIlRIUkVFLlJheWNhc3RlcjogVW5zdXBwb3J0ZWQgY2FtZXJhIHR5cGU6ICIgKyBlLnR5cGUpOwogIH0KICAvKioKICAgKiBVc2VzIHRoZSBnaXZlbiBXZWJYUiBjb250cm9sbGVyIHRvIGNvbXB1dGUgYSBuZXcgb3JpZ2luIGFuZCBkaXJlY3Rpb24gZm9yIHRoZSBpbnRlcm5hbCByYXkuCiAgICoKICAgKiBAcGFyYW0ge1dlYlhSQ29udHJvbGxlcn0gY29udHJvbGxlciAtIFRoZSBjb250cm9sbGVyIHRvIGNvcHkgdGhlIHBvc2l0aW9uIGFuZCBkaXJlY3Rpb24gZnJvbS4KICAgKiBAcmV0dXJuIHtSYXljYXN0ZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgcmF5Y2FzdGVyLgogICAqLwogIHNldEZyb21YUkNvbnRyb2xsZXIodCkgewogICAgcmV0dXJuIFRtLmlkZW50aXR5KCkuZXh0cmFjdFJvdGF0aW9uKHQubWF0cml4V29ybGQpLCB0aGlzLnJheS5vcmlnaW4uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHQubWF0cml4V29ybGQpLCB0aGlzLnJheS5kaXJlY3Rpb24uc2V0KDAsIDAsIC0xKS5hcHBseU1hdHJpeDQoVG0pLCB0aGlzOwogIH0KICAvKioKICAgKiBUaGUgaW50ZXJzZWN0aW9uIHBvaW50IG9mIGEgcmF5Y2FzdGVyIGludGVyc2VjdGlvbiB0ZXN0LgogICAqIEB0eXBlZGVmIHtPYmplY3R9IFJheWNhc3Rlcn5JbnRlcnNlY3Rpb24KICAgKiBAcHJvcGVydHkge251bWJlcn0gZGlzdGFuY2UgLSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgcmF5J3Mgb3JpZ2luIHRvIHRoZSBpbnRlcnNlY3Rpb24gcG9pbnQuCiAgICogQHByb3BlcnR5IHtudW1iZXJ9IGRpc3RhbmNlVG9SYXkgLSAgU29tZSAzRCBvYmplY3RzIGUuZy4ge0BsaW5rIFBvaW50c30gcHJvdmlkZSB0aGUgZGlzdGFuY2Ugb2YgdGhlCiAgICogaW50ZXJzZWN0aW9uIHRvIHRoZSBuZWFyZXN0IHBvaW50IG9uIHRoZSByYXkuIEZvciBvdGhlciBvYmplY3RzIGl0IHdpbGwgYmUgYHVuZGVmaW5lZGAuCiAgICogQHByb3BlcnR5IHtWZWN0b3IzfSBwb2ludCAtIFRoZSBpbnRlcnNlY3Rpb24gcG9pbnQsIGluIHdvcmxkIGNvb3JkaW5hdGVzLgogICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBmYWNlIC0gVGhlIGZhY2UgdGhhdCBoYXMgYmVlbiBpbnRlcnNlY3RlZC4KICAgKiBAcHJvcGVydHkge251bWJlcn0gZmFjZUluZGV4IC0gVGhlIGZhY2UgaW5kZXguCiAgICogQHByb3BlcnR5IHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdCB0aGF0IGhhcyBiZWVuIGludGVyc2VjdGVkLgogICAqIEBwcm9wZXJ0eSB7VmVjdG9yMn0gdXYgLSBVLFYgY29vcmRpbmF0ZXMgYXQgcG9pbnQgb2YgaW50ZXJzZWN0aW9uLgogICAqIEBwcm9wZXJ0eSB7VmVjdG9yMn0gdXYxIC0gU2Vjb25kIHNldCBvZiBVLFYgY29vcmRpbmF0ZXMgYXQgcG9pbnQgb2YgaW50ZXJzZWN0aW9uLgogICAqIEBwcm9wZXJ0eSB7VmVjdG9yM30gdXYxIC0gSW50ZXJwb2xhdGVkIG5vcm1hbCB2ZWN0b3IgYXQgcG9pbnQgb2YgaW50ZXJzZWN0aW9uLgogICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbnN0YW5jZUlkIC0gVGhlIGluZGV4IG51bWJlciBvZiB0aGUgaW5zdGFuY2Ugd2hlcmUgdGhlIHJheQogICAqIGludGVyc2VjdHMgdGhlIHtAbGluayBJbnN0YW5jZWRNZXNofS4KICAgKi8KICAvKioKICAgKiBDaGVja3MgYWxsIGludGVyc2VjdGlvbiBiZXR3ZWVuIHRoZSByYXkgYW5kIHRoZSBvYmplY3Qgd2l0aCBvciB3aXRob3V0IHRoZQogICAqIGRlc2NlbmRhbnRzLiBJbnRlcnNlY3Rpb25zIGFyZSByZXR1cm5lZCBzb3J0ZWQgYnkgZGlzdGFuY2UsIGNsb3Nlc3QgZmlyc3QuCiAgICoKICAgKiBgUmF5Y2FzdGVyYCBkZWxlZ2F0ZXMgdG8gdGhlIGByYXljYXN0KClgIG1ldGhvZCBvZiB0aGUgcGFzc2VkIDNEIG9iamVjdCwgd2hlbgogICAqIGV2YWx1YXRpbmcgd2hldGhlciB0aGUgcmF5IGludGVyc2VjdHMgdGhlIG9iamVjdCBvciBub3QuIFRoaXMgYWxsb3dzIG1lc2hlcyB0byByZXNwb25kCiAgICogZGlmZmVyZW50bHkgdG8gcmF5IGNhc3RpbmcgdGhhbiBsaW5lcyBvciBwb2ludHMuCiAgICoKICAgKiBOb3RlIHRoYXQgZm9yIG1lc2hlcywgZmFjZXMgbXVzdCBiZSBwb2ludGVkIHRvd2FyZHMgdGhlIG9yaWdpbiBvZiB0aGUgcmF5IGluIG9yZGVyCiAgICogdG8gYmUgZGV0ZWN0ZWQ7IGludGVyc2VjdGlvbnMgb2YgdGhlIHJheSBwYXNzaW5nIHRocm91Z2ggdGhlIGJhY2sgb2YgYSBmYWNlIHdpbGwgbm90CiAgICogYmUgZGV0ZWN0ZWQuIFRvIHJheWNhc3QgYWdhaW5zdCBib3RoIGZhY2VzIG9mIGFuIG9iamVjdCwgeW91J2xsIHdhbnQgdG8gc2V0ICB7QGxpbmsgTWF0ZXJpYWwjc2lkZX0KICAgKiB0byBgVEhSRUUuRG91YmxlU2lkZWAuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgM0Qgb2JqZWN0IHRvIGNoZWNrIGZvciBpbnRlcnNlY3Rpb24gd2l0aCB0aGUgcmF5LgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JlY3Vyc2l2ZT10cnVlXSAtIElmIHNldCB0byBgdHJ1ZWAsIGl0IGFsc28gY2hlY2tzIGFsbCBkZXNjZW5kYW50cy4KICAgKiBPdGhlcndpc2UgaXQgb25seSBjaGVja3MgaW50ZXJzZWN0aW9uIHdpdGggdGhlIG9iamVjdC4KICAgKiBAcGFyYW0ge0FycmF5PFJheWNhc3Rlcn5JbnRlcnNlY3Rpb24+fSBbaW50ZXJzZWN0cz1bXV0gVGhlIHRhcmdldCBhcnJheSB0aGF0IGhvbGRzIHRoZSByZXN1bHQgb2YgdGhlIG1ldGhvZC4KICAgKiBAcmV0dXJuIHtBcnJheTxSYXljYXN0ZXJ+SW50ZXJzZWN0aW9uPn0gQW4gYXJyYXkgaG9sZGluZyB0aGUgaW50ZXJzZWN0aW9uIHBvaW50cy4KICAgKi8KICBpbnRlcnNlY3RPYmplY3QodCwgZSA9ICEwLCBpID0gW10pIHsKICAgIHJldHVybiBhcCh0LCB0aGlzLCBpLCBlKSwgaS5zb3J0KENtKSwgaTsKICB9CiAgLyoqCiAgICogQ2hlY2tzIGFsbCBpbnRlcnNlY3Rpb24gYmV0d2VlbiB0aGUgcmF5IGFuZCB0aGUgb2JqZWN0cyB3aXRoIG9yIHdpdGhvdXQKICAgKiB0aGUgZGVzY2VuZGFudHMuIEludGVyc2VjdGlvbnMgYXJlIHJldHVybmVkIHNvcnRlZCBieSBkaXN0YW5jZSwgY2xvc2VzdCBmaXJzdC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0M0Q+fSBvYmplY3RzIC0gVGhlIDNEIG9iamVjdHMgdG8gY2hlY2sgZm9yIGludGVyc2VjdGlvbiB3aXRoIHRoZSByYXkuCiAgICogQHBhcmFtIHtib29sZWFufSBbcmVjdXJzaXZlPXRydWVdIC0gSWYgc2V0IHRvIGB0cnVlYCwgaXQgYWxzbyBjaGVja3MgYWxsIGRlc2NlbmRhbnRzLgogICAqIE90aGVyd2lzZSBpdCBvbmx5IGNoZWNrcyBpbnRlcnNlY3Rpb24gd2l0aCB0aGUgb2JqZWN0LgogICAqIEBwYXJhbSB7QXJyYXk8UmF5Y2FzdGVyfkludGVyc2VjdGlvbj59IFtpbnRlcnNlY3RzPVtdXSBUaGUgdGFyZ2V0IGFycmF5IHRoYXQgaG9sZHMgdGhlIHJlc3VsdCBvZiB0aGUgbWV0aG9kLgogICAqIEByZXR1cm4ge0FycmF5PFJheWNhc3Rlcn5JbnRlcnNlY3Rpb24+fSBBbiBhcnJheSBob2xkaW5nIHRoZSBpbnRlcnNlY3Rpb24gcG9pbnRzLgogICAqLwogIGludGVyc2VjdE9iamVjdHModCwgZSA9ICEwLCBpID0gW10pIHsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gdC5sZW5ndGg7IG4gPCBzOyBuKyspCiAgICAgIGFwKHRbbl0sIHRoaXMsIGksIGUpOwogICAgcmV0dXJuIGkuc29ydChDbSksIGk7CiAgfQp9OwpmdW5jdGlvbiBDbShhLCB0KSB7CiAgcmV0dXJuIGEuZGlzdGFuY2UgLSB0LmRpc3RhbmNlOwp9CmZ1bmN0aW9uIGFwKGEsIHQsIGUsIGkpIHsKICBsZXQgbiA9ICEwOwogIGlmIChhLmxheWVycy50ZXN0KHQubGF5ZXJzKSAmJiBhLnJheWNhc3QodCwgZSkgPT09ICExICYmIChuID0gITEpLCBuID09PSAhMCAmJiBpID09PSAhMCkgewogICAgY29uc3QgcyA9IGEuY2hpbGRyZW47CiAgICBmb3IgKGxldCByID0gMCwgbyA9IHMubGVuZ3RoOyByIDwgbzsgcisrKQogICAgICBhcChzW3JdLCB0LCBlLCAhMCk7CiAgfQp9CmxldCBfTSA9IGNsYXNzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHRpbWVyLgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fcHJldmlvdXNUaW1lID0gMCwgdGhpcy5fY3VycmVudFRpbWUgPSAwLCB0aGlzLl9zdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKSwgdGhpcy5fZGVsdGEgPSAwLCB0aGlzLl9lbGFwc2VkID0gMCwgdGhpcy5fdGltZXNjYWxlID0gMSwgdGhpcy5fZG9jdW1lbnQgPSBudWxsLCB0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIgPSBudWxsOwogIH0KICAvKioKICAgKiBDb25uZWN0IHRoZSB0aW1lciB0byB0aGUgZ2l2ZW4gZG9jdW1lbnQuQ2FsbGluZyB0aGlzIG1ldGhvZCBpcyBub3QgbWFuZGF0b3J5IHRvCiAgICogdXNlIHRoZSB0aW1lciBidXQgZW5hYmxlcyB0aGUgdXNhZ2Ugb2YgdGhlIFBhZ2UgVmlzaWJpbGl0eSBBUEkgdG8gYXZvaWQgbGFyZ2UgdGltZQogICAqIGRlbHRhIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7RG9jdW1lbnR9IGRvY3VtZW50IC0gVGhlIGRvY3VtZW50LgogICAqLwogIGNvbm5lY3QodCkgewogICAgdGhpcy5fZG9jdW1lbnQgPSB0LCB0LmhpZGRlbiAhPT0gdm9pZCAwICYmICh0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIgPSB4TS5iaW5kKHRoaXMpLCB0LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCB0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIsICExKSk7CiAgfQogIC8qKgogICAqIERpc2Nvbm5lY3RzIHRoZSB0aW1lciBmcm9tIHRoZSBET00gYW5kIGFsc28gZGlzYWJsZXMgdGhlIHVzYWdlIG9mIHRoZSBQYWdlIFZpc2liaWxpdHkgQVBJLgogICAqLwogIGRpc2Nvbm5lY3QoKSB7CiAgICB0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIgIT09IG51bGwgJiYgKHRoaXMuX2RvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCB0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIpLCB0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIgPSBudWxsKSwgdGhpcy5fZG9jdW1lbnQgPSBudWxsOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSB0aW1lIGRlbHRhIGluIHNlY29uZHMuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB0aW1lIGRlbHRhIGluIHNlY29uZC4KICAgKi8KICBnZXREZWx0YSgpIHsKICAgIHJldHVybiB0aGlzLl9kZWx0YSAvIDFlMzsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZWxhcHNlZCB0aW1lIGluIHNlY29uZHMuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBlbGFwc2VkIHRpbWUgaW4gc2Vjb25kLgogICAqLwogIGdldEVsYXBzZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fZWxhcHNlZCAvIDFlMzsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgdGltZXNjYWxlLgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgdGltZXNjYWxlLgogICAqLwogIGdldFRpbWVzY2FsZSgpIHsKICAgIHJldHVybiB0aGlzLl90aW1lc2NhbGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIHRpbWVzY2FsZSB3aGljaCBzY2FsZSB0aGUgdGltZSBkZWx0YSBjb21wdXRhdGlvbgogICAqIGluIGB1cGRhdGUoKWAuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdGltZXNjYWxlIC0gVGhlIHRpbWVzY2FsZSB0byBzZXQuCiAgICogQHJldHVybiB7VGltZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdGltZXIuCiAgICovCiAgc2V0VGltZXNjYWxlKHQpIHsKICAgIHJldHVybiB0aGlzLl90aW1lc2NhbGUgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBSZXNldHMgdGhlIHRpbWUgY29tcHV0YXRpb24gZm9yIHRoZSBjdXJyZW50IHNpbXVsYXRpb24gc3RlcC4KICAgKgogICAqIEByZXR1cm4ge1RpbWVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHRpbWVyLgogICAqLwogIHJlc2V0KCkgewogICAgcmV0dXJuIHRoaXMuX2N1cnJlbnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCkgLSB0aGlzLl9zdGFydFRpbWUsIHRoaXM7CiAgfQogIC8qKgogICAqIENhbiBiZSB1c2VkIHRvIGZyZWUgYWxsIGludGVybmFsIHJlc291cmNlcy4gVXN1YWxseSBjYWxsZWQgd2hlbgogICAqIHRoZSB0aW1lciBpbnN0YW5jZSBpc24ndCByZXF1aXJlZCBhbnltb3JlLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc2Nvbm5lY3QoKTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgaW50ZXJuYWwgc3RhdGUgb2YgdGhlIHRpbWVyLiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkCiAgICogb25jZSBwZXIgc2ltdWxhdGlvbiBzdGVwIGFuZCBiZWZvcmUgeW91IHBlcmZvcm0gcXVlcmllcyBhZ2FpbnN0IHRoZSB0aW1lcgogICAqIChlLmcuIHZpYSBgZ2V0RGVsdGEoKWApLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHRpbWVzdGFtcCAtIFRoZSBjdXJyZW50IHRpbWUgaW4gbWlsbGlzZWNvbmRzLiBDYW4gYmUgb2J0YWluZWQKICAgKiBmcm9tIHRoZSBgcmVxdWVzdEFuaW1hdGlvbkZyYW1lYCBjYWxsYmFjayBhcmd1bWVudC4gSWYgbm90IHByb3ZpZGVkLCB0aGUgY3VycmVudAogICAqIHRpbWUgd2lsbCBiZSBkZXRlcm1pbmVkIHdpdGggYHBlcmZvcm1hbmNlLm5vd2AuCiAgICogQHJldHVybiB7VGltZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdGltZXIuCiAgICovCiAgdXBkYXRlKHQpIHsKICAgIHJldHVybiB0aGlzLl9wYWdlVmlzaWJpbGl0eUhhbmRsZXIgIT09IG51bGwgJiYgdGhpcy5fZG9jdW1lbnQuaGlkZGVuID09PSAhMCA/IHRoaXMuX2RlbHRhID0gMCA6ICh0aGlzLl9wcmV2aW91c1RpbWUgPSB0aGlzLl9jdXJyZW50VGltZSwgdGhpcy5fY3VycmVudFRpbWUgPSAodCAhPT0gdm9pZCAwID8gdCA6IHBlcmZvcm1hbmNlLm5vdygpKSAtIHRoaXMuX3N0YXJ0VGltZSwgdGhpcy5fZGVsdGEgPSAodGhpcy5fY3VycmVudFRpbWUgLSB0aGlzLl9wcmV2aW91c1RpbWUpICogdGhpcy5fdGltZXNjYWxlLCB0aGlzLl9lbGFwc2VkICs9IHRoaXMuX2RlbHRhKSwgdGhpczsKICB9Cn07CmZ1bmN0aW9uIHhNKCkgewogIHRoaXMuX2RvY3VtZW50LmhpZGRlbiA9PT0gITEgJiYgdGhpcy5yZXNldCgpOwp9CmNsYXNzIG9wIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHNwaGVyaWNhbC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzPTFdIC0gVGhlIHJhZGl1cywgb3IgdGhlIEV1Y2xpZGVhbiBkaXN0YW5jZSAoc3RyYWlnaHQtbGluZSBkaXN0YW5jZSkgZnJvbSB0aGUgcG9pbnQgdG8gdGhlIG9yaWdpbi4KICAgKiBAcGFyYW0ge251bWJlcn0gW3BoaT0wXSAtIFRoZSBwb2xhciBhbmdsZSBpbiByYWRpYW5zIGZyb20gdGhlIHkgKHVwKSBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbdGhldGE9MF0gLSBUaGUgZXF1YXRvci9hemltdXRoYWwgYW5nbGUgaW4gcmFkaWFucyBhcm91bmQgdGhlIHkgKHVwKSBheGlzLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMCwgaSA9IDApIHsKICAgIHRoaXMucmFkaXVzID0gdCwgdGhpcy5waGkgPSBlLCB0aGlzLnRoZXRhID0gaTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgc3BoZXJpY2FsIGNvbXBvbmVudHMgYnkgY29weWluZyB0aGUgZ2l2ZW4gdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHBoaSAtIFRoZSBwb2xhciBhbmdsZS4KICAgKiBAcGFyYW0ge251bWJlcn0gdGhldGEgLSBUaGUgYXppbXV0aGFsIGFuZ2xlLgogICAqIEByZXR1cm4ge1NwaGVyaWNhbH0gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmljYWwuCiAgICovCiAgc2V0KHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnJhZGl1cyA9IHQsIHRoaXMucGhpID0gZSwgdGhpcy50aGV0YSA9IGksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBzcGhlcmljYWwgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7U3BoZXJpY2FsfSBvdGhlciAtIFRoZSBzcGhlcmljYWwgdG8gY29weS4KICAgKiBAcmV0dXJuIHtTcGhlcmljYWx9IEEgcmVmZXJlbmNlIHRvIHRoaXMgc3BoZXJpY2FsLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMucmFkaXVzID0gdC5yYWRpdXMsIHRoaXMucGhpID0gdC5waGksIHRoaXMudGhldGEgPSB0LnRoZXRhLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXN0cmljdHMgdGhlIHBvbGFyIGFuZ2xlIFtwYWdlOi5waGkgcGhpXSB0byBiZSBiZXR3ZWVuIGAwLjAwMDAwMWAgYW5kIHBpIC0KICAgKiBgMC4wMDAwMDFgLgogICAqCiAgICogQHJldHVybiB7U3BoZXJpY2FsfSBBIHJlZmVyZW5jZSB0byB0aGlzIHNwaGVyaWNhbC4KICAgKi8KICBtYWtlU2FmZSgpIHsKICAgIHJldHVybiB0aGlzLnBoaSA9IGt0KHRoaXMucGhpLCAxZS02LCBNYXRoLlBJIC0gMWUtNiksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHNwaGVyaWNhbCBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIHZlY3RvciB3aGljaCBpcyBhc3N1bWVkIHRvIGhvbGQKICAgKiBDYXJ0ZXNpYW4gY29vcmRpbmF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIHNldC4KICAgKiBAcmV0dXJuIHtTcGhlcmljYWx9IEEgcmVmZXJlbmNlIHRvIHRoaXMgc3BoZXJpY2FsLgogICAqLwogIHNldEZyb21WZWN0b3IzKHQpIHsKICAgIHJldHVybiB0aGlzLnNldEZyb21DYXJ0ZXNpYW5Db29yZHModC54LCB0LnksIHQueik7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHNwaGVyaWNhbCBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIENhcnRlc2lhbiBjb29yZGluYXRlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB6IHZhbHVlLgogICAqIEByZXR1cm4ge1NwaGVyaWNhbH0gQSByZWZlcmVuY2UgdG8gdGhpcyBzcGhlcmljYWwuCiAgICovCiAgc2V0RnJvbUNhcnRlc2lhbkNvb3Jkcyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5yYWRpdXMgPSBNYXRoLnNxcnQodCAqIHQgKyBlICogZSArIGkgKiBpKSwgdGhpcy5yYWRpdXMgPT09IDAgPyAodGhpcy50aGV0YSA9IDAsIHRoaXMucGhpID0gMCkgOiAodGhpcy50aGV0YSA9IE1hdGguYXRhbjIodCwgaSksIHRoaXMucGhpID0gTWF0aC5hY29zKGt0KGUgLyB0aGlzLnJhZGl1cywgLTEsIDEpKSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgc3BoZXJpY2FsIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtTcGhlcmljYWx9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQp9CmNsYXNzIHZNIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGN5bGluZHJpY2FsLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyYWRpdXM9MV0gLSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgb3JpZ2luIHRvIGEgcG9pbnQgaW4gdGhlIHgteiBwbGFuZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW3RoZXRhPTBdIC0gQSBjb3VudGVyY2xvY2t3aXNlIGFuZ2xlIGluIHRoZSB4LXogcGxhbmUgbWVhc3VyZWQgaW4gcmFkaWFucyBmcm9tIHRoZSBwb3NpdGl2ZSB6LWF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIGhlaWdodCBhYm92ZSB0aGUgeC16IHBsYW5lLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxLCBlID0gMCwgaSA9IDApIHsKICAgIHRoaXMucmFkaXVzID0gdCwgdGhpcy50aGV0YSA9IGUsIHRoaXMueSA9IGk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGN5bGluZHJpY2FsIGNvbXBvbmVudHMgYnkgY29weWluZyB0aGUgZ2l2ZW4gdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHRoZXRhIC0gVGhlIHRoZXRhIGFuZ2xlLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIGhlaWdodCB2YWx1ZS4KICAgKiBAcmV0dXJuIHtDeWxpbmRyaWNhbH0gQSByZWZlcmVuY2UgdG8gdGhpcyBjeWxpbmRyaWNhbC4KICAgKi8KICBzZXQodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMucmFkaXVzID0gdCwgdGhpcy50aGV0YSA9IGUsIHRoaXMueSA9IGksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBjeWxpbmRyaWNhbCB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtDeWxpbmRyaWNhbH0gb3RoZXIgLSBUaGUgY3lsaW5kcmljYWwgdG8gY29weS4KICAgKiBAcmV0dXJuIHtDeWxpbmRyaWNhbH0gQSByZWZlcmVuY2UgdG8gdGhpcyBjeWxpbmRyaWNhbC4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLnJhZGl1cyA9IHQucmFkaXVzLCB0aGlzLnRoZXRhID0gdC50aGV0YSwgdGhpcy55ID0gdC55LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjeWxpbmRyaWNhbCBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIHZlY3RvciB3aGljaCBpcyBhc3N1bWVkIHRvIGhvbGQKICAgKiBDYXJ0ZXNpYW4gY29vcmRpbmF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIHNldC4KICAgKiBAcmV0dXJuIHtDeWxpbmRyaWNhbH0gQSByZWZlcmVuY2UgdG8gdGhpcyBjeWxpbmRyaWNhbC4KICAgKi8KICBzZXRGcm9tVmVjdG9yMyh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tQ2FydGVzaWFuQ29vcmRzKHQueCwgdC55LCB0LnopOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjeWxpbmRyaWNhbCBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIENhcnRlc2lhbiBjb29yZGluYXRlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeCB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB4IHZhbHVlLgogICAqIEByZXR1cm4ge0N5bGluZHJpY2FsfSBBIHJlZmVyZW5jZSB0byB0aGlzIGN5bGluZHJpY2FsLgogICAqLwogIHNldEZyb21DYXJ0ZXNpYW5Db29yZHModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMucmFkaXVzID0gTWF0aC5zcXJ0KHQgKiB0ICsgaSAqIGkpLCB0aGlzLnRoZXRhID0gTWF0aC5hdGFuMih0LCBpKSwgdGhpcy55ID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyBjeWxpbmRyaWNhbCB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHJldHVybiB7Q3lsaW5kcmljYWx9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQp9CmNsYXNzIGRmIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IDJ4MiBtYXRyaXguIFRoZSBhcmd1bWVudHMgYXJlIHN1cHBvc2VkIHRvIGJlCiAgICogaW4gcm93LW1ham9yIG9yZGVyLiBJZiBubyBhcmd1bWVudHMgYXJlIHByb3ZpZGVkLCB0aGUgY29uc3RydWN0b3IKICAgKiBpbml0aWFsaXplcyB0aGUgbWF0cml4IGFzIGFuIGlkZW50aXR5IG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjExXSAtIDEtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xMl0gLSAxLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjFdIC0gMi0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIyXSAtIDItMiBtYXRyaXggZWxlbWVudC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuKSB7CiAgICBkZi5wcm90b3R5cGUuaXNNYXRyaXgyID0gITAsIHRoaXMuZWxlbWVudHMgPSBbCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgIF0sIHQgIT09IHZvaWQgMCAmJiB0aGlzLnNldCh0LCBlLCBpLCBuKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIG1hdHJpeCB0byB0aGUgMngyIGlkZW50aXR5IG1hdHJpeC4KICAgKgogICAqIEByZXR1cm4ge01hdHJpeDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGlkZW50aXR5KCkgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBlbGVtZW50cyBvZiB0aGUgbWF0cml4IGZyb20gdGhlIGdpdmVuIGFycmF5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge01hdHJpeDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGZyb21BcnJheSh0LCBlID0gMCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspCiAgICAgIHRoaXMuZWxlbWVudHNbaV0gPSB0W2kgKyBlXTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBlbGVtZW50cyBvZiB0aGUgbWF0cml4LlRoZSBhcmd1bWVudHMgYXJlIHN1cHBvc2VkIHRvIGJlCiAgICogaW4gcm93LW1ham9yIG9yZGVyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG4xMSAtIDEtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gbjEyIC0gMS0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBuMjEgLSAyLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IG4yMiAtIDItMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcmV0dXJuIHtNYXRyaXgyfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzZXQodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gc1swXSA9IHQsIHNbMl0gPSBlLCBzWzFdID0gaSwgc1szXSA9IG4sIHRoaXM7CiAgfQp9CmNvbnN0IFJtID0gLyogQF9fUFVSRV9fICovIG5ldyBKKCk7CmNsYXNzIGJNIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJvdW5kaW5nIGJveC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gW21pbj0oSW5maW5pdHksSW5maW5pdHkpXSAtIEEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgbG93ZXIgYm91bmRhcnkgb2YgdGhlIGJveC4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IFttYXg9KC1JbmZpbml0eSwtSW5maW5pdHkpXSAtIEEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgdXBwZXIgYm91bmRhcnkgb2YgdGhlIGJveC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbmV3IEooMSAvIDAsIDEgLyAwKSwgZSA9IG5ldyBKKC0xIC8gMCwgLTEgLyAwKSkgewogICAgdGhpcy5pc0JveDIgPSAhMCwgdGhpcy5taW4gPSB0LCB0aGlzLm1heCA9IGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGxvd2VyIGFuZCB1cHBlciBib3VuZGFyaWVzIG9mIHRoaXMgYm94LgogICAqIFBsZWFzZSBub3RlIHRoYXQgdGhpcyBtZXRob2Qgb25seSBjb3BpZXMgdGhlIHZhbHVlcyBmcm9tIHRoZSBnaXZlbiBvYmplY3RzLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBtaW4gLSBUaGUgbG93ZXIgYm91bmRhcnkgb2YgdGhlIGJveC4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG1heCAtIFRoZSB1cHBlciBib3VuZGFyeSBvZiB0aGUgYm94LgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHNldCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5taW4uY29weSh0KSwgdGhpcy5tYXguY29weShlKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdXBwZXIgYW5kIGxvd2VyIGJvdW5kcyBvZiB0aGlzIGJveCBzbyBpdCBlbmNsb3NlcyB0aGUgcG9zaXRpb24gZGF0YQogICAqIGluIHRoZSBnaXZlbiBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8VmVjdG9yMj59IHBvaW50cyAtIEFuIGFycmF5IGhvbGRpbmcgMkQgcG9zaXRpb24gZGF0YSBhcyBpbnN0YW5jZXMgb2Yge0BsaW5rIFZlY3RvcjJ9LgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHNldEZyb21Qb2ludHModCkgewogICAgdGhpcy5tYWtlRW1wdHkoKTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5sZW5ndGg7IGUgPCBpOyBlKyspCiAgICAgIHRoaXMuZXhwYW5kQnlQb2ludCh0W2VdKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBDZW50ZXJzIHRoaXMgYm94IG9uIHRoZSBnaXZlbiBjZW50ZXIgdmVjdG9yIGFuZCBzZXRzIHRoaXMgYm94J3Mgd2lkdGgsIGhlaWdodCBhbmQKICAgKiBkZXB0aCB0byB0aGUgZ2l2ZW4gc2l6ZSB2YWx1ZXMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IGNlbnRlciAtIFRoZSBjZW50ZXIgb2YgdGhlIGJveC4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHNpemUgLSBUaGUgeCBhbmQgeSBkaW1lbnNpb25zIG9mIHRoZSBib3guCiAgICogQHJldHVybiB7Qm94Mn0gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgc2V0RnJvbUNlbnRlckFuZFNpemUodCwgZSkgewogICAgY29uc3QgaSA9IFJtLmNvcHkoZSkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgIHJldHVybiB0aGlzLm1pbi5jb3B5KHQpLnN1YihpKSwgdGhpcy5tYXguY29weSh0KS5hZGQoaSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgYm94IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtCb3gyfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KHRoaXMpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gYm94IHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0JveDJ9IGJveCAtIFRoZSBib3ggdG8gY29weS4KICAgKiBAcmV0dXJuIHtCb3gyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi5jb3B5KHQubWluKSwgdGhpcy5tYXguY29weSh0Lm1heCksIHRoaXM7CiAgfQogIC8qKgogICAqIE1ha2VzIHRoaXMgYm94IGVtcHR5IHdoaWNoIG1lYW5zIGluIGVuY2xvc2VzIGEgemVybyBzcGFjZSBpbiAyRC4KICAgKgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIG1ha2VFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLm1pbi54ID0gdGhpcy5taW4ueSA9IDEgLyAwLCB0aGlzLm1heC54ID0gdGhpcy5tYXgueSA9IC0xIC8gMCwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIHRoaXMgYm94IGluY2x1ZGVzIHplcm8gcG9pbnRzIHdpdGhpbiBpdHMgYm91bmRzLgogICAqIE5vdGUgdGhhdCBhIGJveCB3aXRoIGVxdWFsIGxvd2VyIGFuZCB1cHBlciBib3VuZHMgc3RpbGwgaW5jbHVkZXMgb25lCiAgICogcG9pbnQsIHRoZSBvbmUgYm90aCBib3VuZHMgc2hhcmUuCiAgICoKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgYm94IGlzIGVtcHR5IG9yIG5vdC4KICAgKi8KICBpc0VtcHR5KCkgewogICAgcmV0dXJuIHRoaXMubWF4LnggPCB0aGlzLm1pbi54IHx8IHRoaXMubWF4LnkgPCB0aGlzLm1pbi55OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjZW50ZXIgcG9pbnQgb2YgdGhpcyBib3guCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IFRoZSBjZW50ZXIgcG9pbnQuCiAgICovCiAgZ2V0Q2VudGVyKHQpIHsKICAgIHJldHVybiB0aGlzLmlzRW1wdHkoKSA/IHQuc2V0KDAsIDApIDogdC5hZGRWZWN0b3JzKHRoaXMubWluLCB0aGlzLm1heCkubXVsdGlwbHlTY2FsYXIoMC41KTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgZGltZW5zaW9ucyBvZiB0aGlzIGJveC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yMn0gVGhlIHNpemUuCiAgICovCiAgZ2V0U2l6ZSh0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0LnNldCgwLCAwKSA6IHQuc3ViVmVjdG9ycyh0aGlzLm1heCwgdGhpcy5taW4pOwogIH0KICAvKioKICAgKiBFeHBhbmRzIHRoZSBib3VuZGFyaWVzIG9mIHRoaXMgYm94IHRvIGluY2x1ZGUgdGhlIGdpdmVuIHBvaW50LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBwb2ludCAtIFRoZSBwb2ludCB0aGF0IHNob3VsZCBiZSBpbmNsdWRlZCBieSB0aGUgYm91bmRpbmcgYm94LgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGV4cGFuZEJ5UG9pbnQodCkgewogICAgcmV0dXJuIHRoaXMubWluLm1pbih0KSwgdGhpcy5tYXgubWF4KHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBFeHBhbmRzIHRoaXMgYm94IGVxdWlsYXRlcmFsbHkgYnkgdGhlIGdpdmVuIHZlY3Rvci4gVGhlIHdpZHRoIG9mIHRoaXMKICAgKiBib3ggd2lsbCBiZSBleHBhbmRlZCBieSB0aGUgeCBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBpbiBib3RoCiAgICogZGlyZWN0aW9ucy4gVGhlIGhlaWdodCBvZiB0aGlzIGJveCB3aWxsIGJlIGV4cGFuZGVkIGJ5IHRoZSB5IGNvbXBvbmVudCBvZgogICAqIHRoZSB2ZWN0b3IgaW4gYm90aCBkaXJlY3Rpb25zLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2ZWN0b3IgLSBUaGUgdmVjdG9yIHRoYXQgc2hvdWxkIGV4cGFuZCB0aGUgYm91bmRpbmcgYm94LgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGV4cGFuZEJ5VmVjdG9yKHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi5zdWIodCksIHRoaXMubWF4LmFkZCh0KSwgdGhpczsKICB9CiAgLyoqCiAgICogRXhwYW5kcyBlYWNoIGRpbWVuc2lvbiBvZiB0aGUgYm94IGJ5IHRoZSBnaXZlbiBzY2FsYXIuIElmIG5lZ2F0aXZlLCB0aGUKICAgKiBkaW1lbnNpb25zIG9mIHRoZSBib3ggd2lsbCBiZSBjb250cmFjdGVkLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxhciAtIFRoZSBzY2FsYXIgdmFsdWUgdGhhdCBzaG91bGQgZXhwYW5kIHRoZSBib3VuZGluZyBib3guCiAgICogQHJldHVybiB7Qm94Mn0gQSByZWZlcmVuY2UgdG8gdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgZXhwYW5kQnlTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubWluLmFkZFNjYWxhcigtdCksIHRoaXMubWF4LmFkZFNjYWxhcih0KSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHBvaW50IGxpZXMgd2l0aGluIG9yIG9uIHRoZSBib3VuZGFyaWVzIG9mIHRoaXMgYm94LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBwb2ludCAtIFRoZSBwb2ludCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGJvdW5kaW5nIGJveCBjb250YWlucyB0aGUgZ2l2ZW4gcG9pbnQgb3Igbm90LgogICAqLwogIGNvbnRhaW5zUG9pbnQodCkgewogICAgcmV0dXJuIHQueCA+PSB0aGlzLm1pbi54ICYmIHQueCA8PSB0aGlzLm1heC54ICYmIHQueSA+PSB0aGlzLm1pbi55ICYmIHQueSA8PSB0aGlzLm1heC55OwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGJvdW5kaW5nIGJveCBpbmNsdWRlcyB0aGUgZW50aXJldHkgb2YgdGhlIGdpdmVuIGJvdW5kaW5nIGJveC4KICAgKiBJZiB0aGlzIGJveCBhbmQgdGhlIGdpdmVuIG9uZSBhcmUgaWRlbnRpY2FsLCB0aGlzIGZ1bmN0aW9uIGFsc28gcmV0dXJucyBgdHJ1ZWAuCiAgICoKICAgKiBAcGFyYW0ge0JveDJ9IGJveCAtIFRoZSBib3VuZGluZyBib3ggdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBib3VuZGluZyBib3ggY29udGFpbnMgdGhlIGdpdmVuIGJvdW5kaW5nIGJveCBvciBub3QuCiAgICovCiAgY29udGFpbnNCb3godCkgewogICAgcmV0dXJuIHRoaXMubWluLnggPD0gdC5taW4ueCAmJiB0Lm1heC54IDw9IHRoaXMubWF4LnggJiYgdGhpcy5taW4ueSA8PSB0Lm1pbi55ICYmIHQubWF4LnkgPD0gdGhpcy5tYXgueTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHBvaW50IGFzIGEgcHJvcG9ydGlvbiBvZiB0aGlzIGJveCdzIHdpZHRoIGFuZCBoZWlnaHQuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHBvaW50IC0gQSBwb2ludCBpbiAyRCBzcGFjZS4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcG9pbnQgYXMgYSBwcm9wb3J0aW9uIG9mIHRoaXMgYm94J3Mgd2lkdGggYW5kIGhlaWdodC4KICAgKi8KICBnZXRQYXJhbWV0ZXIodCwgZSkgewogICAgcmV0dXJuIGUuc2V0KAogICAgICAodC54IC0gdGhpcy5taW4ueCkgLyAodGhpcy5tYXgueCAtIHRoaXMubWluLngpLAogICAgICAodC55IC0gdGhpcy5taW4ueSkgLyAodGhpcy5tYXgueSAtIHRoaXMubWluLnkpCiAgICApOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gYm91bmRpbmcgYm94IGludGVyc2VjdHMgd2l0aCB0aGlzIGJvdW5kaW5nIGJveC4KICAgKgogICAqIEBwYXJhbSB7Qm94Mn0gYm94IC0gVGhlIGJvdW5kaW5nIGJveCB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGdpdmVuIGJvdW5kaW5nIGJveCBpbnRlcnNlY3RzIHdpdGggdGhpcyBib3VuZGluZyBib3guCiAgICovCiAgaW50ZXJzZWN0c0JveCh0KSB7CiAgICByZXR1cm4gdC5tYXgueCA+PSB0aGlzLm1pbi54ICYmIHQubWluLnggPD0gdGhpcy5tYXgueCAmJiB0Lm1heC55ID49IHRoaXMubWluLnkgJiYgdC5taW4ueSA8PSB0aGlzLm1heC55OwogIH0KICAvKioKICAgKiBDbGFtcHMgdGhlIGdpdmVuIHBvaW50IHdpdGhpbiB0aGUgYm91bmRzIG9mIHRoaXMgYm94LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBwb2ludCAtIFRoZSBwb2ludCB0byBjbGFtcC4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IFRoZSBjbGFtcGVkIHBvaW50LgogICAqLwogIGNsYW1wUG9pbnQodCwgZSkgewogICAgcmV0dXJuIGUuY29weSh0KS5jbGFtcCh0aGlzLm1pbiwgdGhpcy5tYXgpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBldWNsaWRlYW4gZGlzdGFuY2UgZnJvbSBhbnkgZWRnZSBvZiB0aGlzIGJveCB0byB0aGUgc3BlY2lmaWVkIHBvaW50LiBJZgogICAqIHRoZSBnaXZlbiBwb2ludCBsaWVzIGluc2lkZSBvZiB0aGlzIGJveCwgdGhlIGRpc3RhbmNlIHdpbGwgYmUgYDBgLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBwb2ludCAtIFRoZSBwb2ludCB0byBjb21wdXRlIHRoZSBkaXN0YW5jZSB0by4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBldWNsaWRlYW4gZGlzdGFuY2UuCiAgICovCiAgZGlzdGFuY2VUb1BvaW50KHQpIHsKICAgIHJldHVybiB0aGlzLmNsYW1wUG9pbnQodCwgUm0pLmRpc3RhbmNlVG8odCk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhpcyBib3VuZGluZyBib3ggYW5kIHRoZSBnaXZlbiBvbmUsIHNldHRpbmcgdGhlIHVwcGVyCiAgICogYm91bmQgb2YgdGhpcyBib3ggdG8gdGhlIGxlc3NlciBvZiB0aGUgdHdvIGJveGVzJyB1cHBlciBib3VuZHMgYW5kIHRoZQogICAqIGxvd2VyIGJvdW5kIG9mIHRoaXMgYm94IHRvIHRoZSBncmVhdGVyIG9mIHRoZSB0d28gYm94ZXMnIGxvd2VyIGJvdW5kcy4gSWYKICAgKiB0aGVyZSdzIG5vIG92ZXJsYXAsIG1ha2VzIHRoaXMgYm94IGVtcHR5LgogICAqCiAgICogQHBhcmFtIHtCb3gyfSBib3ggLSBUaGUgYm91bmRpbmcgYm94IHRvIGludGVyc2VjdCB3aXRoLgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIGludGVyc2VjdCh0KSB7CiAgICByZXR1cm4gdGhpcy5taW4ubWF4KHQubWluKSwgdGhpcy5tYXgubWluKHQubWF4KSwgdGhpcy5pc0VtcHR5KCkgJiYgdGhpcy5tYWtlRW1wdHkoKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHVuaW9uIG9mIHRoaXMgYm94IGFuZCBhbm90aGVyIGFuZCB0aGUgZ2l2ZW4gb25lLCBzZXR0aW5nIHRoZSB1cHBlcgogICAqIGJvdW5kIG9mIHRoaXMgYm94IHRvIHRoZSBncmVhdGVyIG9mIHRoZSB0d28gYm94ZXMnIHVwcGVyIGJvdW5kcyBhbmQgdGhlCiAgICogbG93ZXIgYm91bmQgb2YgdGhpcyBib3ggdG8gdGhlIGxlc3NlciBvZiB0aGUgdHdvIGJveGVzJyBsb3dlciBib3VuZHMuCiAgICoKICAgKiBAcGFyYW0ge0JveDJ9IGJveCAtIFRoZSBib3VuZGluZyBib3ggdGhhdCB3aWxsIGJlIHVuaW9uZWQgd2l0aCB0aGlzIGluc3RhbmNlLgogICAqIEByZXR1cm4ge0JveDJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYm91bmRpbmcgYm94LgogICAqLwogIHVuaW9uKHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi5taW4odC5taW4pLCB0aGlzLm1heC5tYXgodC5tYXgpLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiBvZmZzZXQgdG8gYm90aCB0aGUgdXBwZXIgYW5kIGxvd2VyIGJvdW5kcyBvZiB0aGlzIGJvdW5kaW5nIGJveCwKICAgKiBlZmZlY3RpdmVseSBtb3ZpbmcgaXQgaW4gMkQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG9mZnNldCAtIFRoZSBvZmZzZXQgdGhhdCBzaG91bGQgYmUgdXNlZCB0byB0cmFuc2xhdGUgdGhlIGJvdW5kaW5nIGJveC4KICAgKiBAcmV0dXJuIHtCb3gyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGJvdW5kaW5nIGJveC4KICAgKi8KICB0cmFuc2xhdGUodCkgewogICAgcmV0dXJuIHRoaXMubWluLmFkZCh0KSwgdGhpcy5tYXguYWRkKHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGJvdW5kaW5nIGJveCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge0JveDJ9IGJveCAtIFRoZSBib3ggdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIGJvdW5kaW5nIGJveCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0Lm1pbi5lcXVhbHModGhpcy5taW4pICYmIHQubWF4LmVxdWFscyh0aGlzLm1heCk7CiAgfQp9CmNvbnN0IFBtID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIElsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIE5yID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIE9yID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIEt1ID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIE1NID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIFNNID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmxldCB4XyA9IGNsYXNzIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxpbmUgc2VnbWVudC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gW3N0YXJ0PSgwLDAsMCldIC0gU3RhcnQgb2YgdGhlIGxpbmUgc2VnbWVudC4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFtlbmQ9KDAsMCwwKV0gLSBFbmQgb2YgdGhlIGxpbmUgc2VnbWVudC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gbmV3IEUoKSwgZSA9IG5ldyBFKCkpIHsKICAgIHRoaXMuc3RhcnQgPSB0LCB0aGlzLmVuZCA9IGU7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHN0YXJ0IGFuZCBlbmQgdmFsdWVzIGJ5IGNvcHlpbmcgdGhlIGdpdmVuIHZlY3RvcnMuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHN0YXJ0IC0gVGhlIHN0YXJ0IHBvaW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gZW5kIC0gVGhlIGVuZCBwb2ludC4KICAgKiBAcmV0dXJuIHtMaW5lM30gQSByZWZlcmVuY2UgdG8gdGhpcyBsaW5lIHNlZ21lbnQuCiAgICovCiAgc2V0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnN0YXJ0LmNvcHkodCksIHRoaXMuZW5kLmNvcHkoZSksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBsaW5lIHNlZ21lbnQgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7TGluZTN9IGxpbmUgLSBUaGUgbGluZSBzZWdtZW50IHRvIGNvcHkuCiAgICogQHJldHVybiB7TGluZTN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbGluZSBzZWdtZW50LgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuc3RhcnQuY29weSh0LnN0YXJ0KSwgdGhpcy5lbmQuY29weSh0LmVuZCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGNlbnRlciBvZiB0aGUgbGluZSBzZWdtZW50LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY2VudGVyIHBvaW50LgogICAqLwogIGdldENlbnRlcih0KSB7CiAgICByZXR1cm4gdC5hZGRWZWN0b3JzKHRoaXMuc3RhcnQsIHRoaXMuZW5kKS5tdWx0aXBseVNjYWxhcigwLjUpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBkZWx0YSB2ZWN0b3Igb2YgdGhlIGxpbmUgc2VnbWVudCdzIHN0YXJ0IGFuZCBlbmQgcG9pbnQuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSBkZWx0YSB2ZWN0b3IuCiAgICovCiAgZGVsdGEodCkgewogICAgcmV0dXJuIHQuc3ViVmVjdG9ycyh0aGlzLmVuZCwgdGhpcy5zdGFydCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHNxdWFyZWQgRXVjbGlkZWFuIGRpc3RhbmNlIGJldHdlZW4gdGhlIGxpbmUnIHN0YXJ0IGFuZCBlbmQgcG9pbnQuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBzcXVhcmVkIEV1Y2xpZGVhbiBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZVNxKCkgewogICAgcmV0dXJuIHRoaXMuc3RhcnQuZGlzdGFuY2VUb1NxdWFyZWQodGhpcy5lbmQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBFdWNsaWRlYW4gZGlzdGFuY2UgYmV0d2VlbiB0aGUgbGluZScgc3RhcnQgYW5kIGVuZCBwb2ludC4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIEV1Y2xpZGVhbiBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZSgpIHsKICAgIHJldHVybiB0aGlzLnN0YXJ0LmRpc3RhbmNlVG8odGhpcy5lbmQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgdmVjdG9yIGF0IGEgY2VydGFpbiBwb3NpdGlvbiBhbG9uZyB0aGUgbGluZSBzZWdtZW50LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBBIHZhbHVlIGJldHdlZW4gYFswLDFdYCB0byByZXByZXNlbnQgYSBwb3NpdGlvbiBhbG9uZyB0aGUgbGluZSBzZWdtZW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gdGFyZ2V0IC0gVGhlIHRhcmdldCB2ZWN0b3IgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHJldHVybiB7VmVjdG9yM30gVGhlIGRlbHRhIHZlY3Rvci4KICAgKi8KICBhdCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5kZWx0YShlKS5tdWx0aXBseVNjYWxhcih0KS5hZGQodGhpcy5zdGFydCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBwb2ludCBwYXJhbWV0ZXIgYmFzZWQgb24gdGhlIGNsb3Nlc3QgcG9pbnQgYXMgcHJvamVjdGVkIG9uIHRoZSBsaW5lIHNlZ21lbnQuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBvaW50IC0gVGhlIHBvaW50IGZvciB3aGljaCB0byByZXR1cm4gYSBwb2ludCBwYXJhbWV0ZXIuCiAgICogQHBhcmFtIHtib29sZWFufSBjbGFtcFRvTGluZSAtIFdoZXRoZXIgdG8gY2xhbXAgdGhlIHJlc3VsdCB0byB0aGUgcmFuZ2UgYFswLDFdYCBvciBub3QuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcG9pbnQgcGFyYW1ldGVyLgogICAqLwogIGNsb3Nlc3RQb2ludFRvUG9pbnRQYXJhbWV0ZXIodCwgZSkgewogICAgUG0uc3ViVmVjdG9ycyh0LCB0aGlzLnN0YXJ0KSwgSWwuc3ViVmVjdG9ycyh0aGlzLmVuZCwgdGhpcy5zdGFydCk7CiAgICBjb25zdCBpID0gSWwuZG90KElsKTsKICAgIGxldCBzID0gSWwuZG90KFBtKSAvIGk7CiAgICByZXR1cm4gZSAmJiAocyA9IGt0KHMsIDAsIDEpKSwgczsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY2xvc2VzdCBwb2ludCBvbiB0aGUgbGluZSBmb3IgYSBnaXZlbiBwb2ludC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9pbnQgLSBUaGUgcG9pbnQgdG8gY29tcHV0ZSB0aGUgY2xvc2VzdCBwb2ludCBvbiB0aGUgbGluZSBmb3IuCiAgICogQHBhcmFtIHtib29sZWFufSBjbGFtcFRvTGluZSAtIFdoZXRoZXIgdG8gY2xhbXAgdGhlIHJlc3VsdCB0byB0aGUgcmFuZ2UgYFswLDFdYCBvciBub3QuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGF0IGlzIHVzZWQgdG8gc3RvcmUgdGhlIG1ldGhvZCdzIHJlc3VsdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY2xvc2VzdCBwb2ludCBvbiB0aGUgbGluZS4KICAgKi8KICBjbG9zZXN0UG9pbnRUb1BvaW50KHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmNsb3Nlc3RQb2ludFRvUG9pbnRQYXJhbWV0ZXIodCwgZSk7CiAgICByZXR1cm4gdGhpcy5kZWx0YShpKS5tdWx0aXBseVNjYWxhcihuKS5hZGQodGhpcy5zdGFydCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGNsb3Nlc3Qgc3F1YXJlZCBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgbGluZSBzZWdtZW50IGFuZCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtMaW5lM30gbGluZSAtIFRoZSBsaW5lIHNlZ21lbnQgdG8gY29tcHV0ZSB0aGUgY2xvc2VzdCBzcXVhcmVkIGRpc3RhbmNlIHRvLgogICAqIEBwYXJhbSB7VmVjdG9yM30gW2MxXSAtIFRoZSBjbG9zZXN0IHBvaW50IG9uIHRoaXMgbGluZSBzZWdtZW50LgogICAqIEBwYXJhbSB7VmVjdG9yM30gW2MyXSAtIFRoZSBjbG9zZXN0IHBvaW50IG9uIHRoZSBnaXZlbiBsaW5lIHNlZ21lbnQuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgc3F1YXJlZCBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgbGluZSBzZWdtZW50IGFuZCB0aGUgZ2l2ZW4gb25lLgogICAqLwogIGRpc3RhbmNlU3FUb0xpbmUzKHQsIGUgPSBNTSwgaSA9IFNNKSB7CiAgICBjb25zdCBuID0gMTAwMDAwMDAwMDAwMDAwMDFlLTMyOwogICAgbGV0IHMsIHI7CiAgICBjb25zdCBvID0gdGhpcy5zdGFydCwgbCA9IHQuc3RhcnQsIGggPSB0aGlzLmVuZCwgYyA9IHQuZW5kOwogICAgTnIuc3ViVmVjdG9ycyhoLCBvKSwgT3Iuc3ViVmVjdG9ycyhjLCBsKSwgS3Uuc3ViVmVjdG9ycyhvLCBsKTsKICAgIGNvbnN0IHUgPSBOci5kb3QoTnIpLCBkID0gT3IuZG90KE9yKSwgcCA9IE9yLmRvdChLdSk7CiAgICBpZiAodSA8PSBuICYmIGQgPD0gbikKICAgICAgcmV0dXJuIGUuY29weShvKSwgaS5jb3B5KGwpLCBlLnN1YihpKSwgZS5kb3QoZSk7CiAgICBpZiAodSA8PSBuKQogICAgICBzID0gMCwgciA9IHAgLyBkLCByID0ga3QociwgMCwgMSk7CiAgICBlbHNlIHsKICAgICAgY29uc3QgZiA9IE5yLmRvdChLdSk7CiAgICAgIGlmIChkIDw9IG4pCiAgICAgICAgciA9IDAsIHMgPSBrdCgtZiAvIHUsIDAsIDEpOwogICAgICBlbHNlIHsKICAgICAgICBjb25zdCB5ID0gTnIuZG90KE9yKSwgZyA9IHUgKiBkIC0geSAqIHk7CiAgICAgICAgZyAhPT0gMCA/IHMgPSBrdCgoeSAqIHAgLSBmICogZCkgLyBnLCAwLCAxKSA6IHMgPSAwLCByID0gKHkgKiBzICsgcCkgLyBkLCByIDwgMCA/IChyID0gMCwgcyA9IGt0KC1mIC8gdSwgMCwgMSkpIDogciA+IDEgJiYgKHIgPSAxLCBzID0ga3QoKHkgLSBmKSAvIHUsIDAsIDEpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGUuY29weShvKS5hZGQoTnIubXVsdGlwbHlTY2FsYXIocykpLCBpLmNvcHkobCkuYWRkKE9yLm11bHRpcGx5U2NhbGFyKHIpKSwgZS5zdWIoaSksIGUuZG90KGUpOwogIH0KICAvKioKICAgKiBBcHBsaWVzIGEgNHg0IHRyYW5zZm9ybWF0aW9uIG1hdHJpeCB0byB0aGlzIGxpbmUgc2VnbWVudC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtMaW5lM30gQSByZWZlcmVuY2UgdG8gdGhpcyBsaW5lIHNlZ21lbnQuCiAgICovCiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIHJldHVybiB0aGlzLnN0YXJ0LmFwcGx5TWF0cml4NCh0KSwgdGhpcy5lbmQuYXBwbHlNYXRyaXg0KHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGxpbmUgc2VnbWVudCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge0xpbmUzfSBsaW5lIC0gVGhlIGxpbmUgc2VnbWVudCB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgbGluZSBzZWdtZW50IGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuc3RhcnQuZXF1YWxzKHRoaXMuc3RhcnQpICYmIHQuZW5kLmVxdWFscyh0aGlzLmVuZCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgbGluZSBzZWdtZW50IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtMaW5lM30gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9Cn07CmNvbnN0IEltID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmNsYXNzIHdNIGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc3BvdCBsaWdodCBoZWxwZXIuCiAgICoKICAgKiBAcGFyYW0ge0hlbWlzcGhlcmVMaWdodH0gbGlnaHQgLSBUaGUgbGlnaHQgdG8gYmUgdmlzdWFsaXplZC4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IFtjb2xvcl0gLSBUaGUgaGVscGVyJ3MgY29sb3IuIElmIG5vdCBzZXQsIHRoZSBoZWxwZXIgd2lsbCB0YWtlCiAgICogdGhlIGNvbG9yIG9mIHRoZSBsaWdodC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlKSB7CiAgICBzdXBlcigpLCB0aGlzLmxpZ2h0ID0gdCwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gITEsIHRoaXMuY29sb3IgPSBlLCB0aGlzLnR5cGUgPSAiU3BvdExpZ2h0SGVscGVyIjsKICAgIGNvbnN0IGkgPSBuZXcgSHQoKSwgbiA9IFsKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgLTEsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIC0xLAogICAgICAxCiAgICBdOwogICAgZm9yIChsZXQgciA9IDAsIG8gPSAxLCBsID0gMzI7IHIgPCBsOyByKyssIG8rKykgewogICAgICBjb25zdCBoID0gciAvIGwgKiBNYXRoLlBJICogMiwgYyA9IG8gLyBsICogTWF0aC5QSSAqIDI7CiAgICAgIG4ucHVzaCgKICAgICAgICBNYXRoLmNvcyhoKSwKICAgICAgICBNYXRoLnNpbihoKSwKICAgICAgICAxLAogICAgICAgIE1hdGguY29zKGMpLAogICAgICAgIE1hdGguc2luKGMpLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIGkuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChuLCAzKSk7CiAgICBjb25zdCBzID0gbmV3IFBlKHsgZm9nOiAhMSwgdG9uZU1hcHBlZDogITEgfSk7CiAgICB0aGlzLmNvbmUgPSBuZXcgb2koaSwgcyksIHRoaXMuYWRkKHRoaXMuY29uZSksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmNvbmUuZ2VvbWV0cnkuZGlzcG9zZSgpLCB0aGlzLmNvbmUubWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSBoZWxwZXIgdG8gbWF0Y2ggdGhlIHBvc2l0aW9uIGFuZCBkaXJlY3Rpb24gb2YgdGhlCiAgICogbGlnaHQgYmVpbmcgdmlzdWFsaXplZC4KICAgKi8KICB1cGRhdGUoKSB7CiAgICB0aGlzLmxpZ2h0LnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHRoaXMubGlnaHQudGFyZ2V0LnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHRoaXMucGFyZW50ID8gKHRoaXMucGFyZW50LnVwZGF0ZVdvcmxkTWF0cml4KCEwKSwgdGhpcy5tYXRyaXguY29weSh0aGlzLnBhcmVudC5tYXRyaXhXb3JsZCkuaW52ZXJ0KCkubXVsdGlwbHkodGhpcy5saWdodC5tYXRyaXhXb3JsZCkpIDogdGhpcy5tYXRyaXguY29weSh0aGlzLmxpZ2h0Lm1hdHJpeFdvcmxkKSwgdGhpcy5tYXRyaXhXb3JsZC5jb3B5KHRoaXMubGlnaHQubWF0cml4V29ybGQpOwogICAgY29uc3QgdCA9IHRoaXMubGlnaHQuZGlzdGFuY2UgPyB0aGlzLmxpZ2h0LmRpc3RhbmNlIDogMWUzLCBlID0gdCAqIE1hdGgudGFuKHRoaXMubGlnaHQuYW5nbGUpOwogICAgdGhpcy5jb25lLnNjYWxlLnNldChlLCBlLCB0KSwgSW0uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubGlnaHQudGFyZ2V0Lm1hdHJpeFdvcmxkKSwgdGhpcy5jb25lLmxvb2tBdChJbSksIHRoaXMuY29sb3IgIT09IHZvaWQgMCA/IHRoaXMuY29uZS5tYXRlcmlhbC5jb2xvci5zZXQodGhpcy5jb2xvcikgOiB0aGlzLmNvbmUubWF0ZXJpYWwuY29sb3IuY29weSh0aGlzLmxpZ2h0LmNvbG9yKTsKICB9Cn0KY29uc3QgdXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgTGwgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZ0KCksIFF1ID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpOwpjbGFzcyBBTSBleHRlbmRzIG9pIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHNrZWxldG9uIGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtICBVc3VhbGx5IGFuIGluc3RhbmNlIG9mIHtAbGluayBTa2lubmVkTWVzaH0uIEhvd2V2ZXIsIGFueSAzRCBvYmplY3QKICAgKiBjYW4gYmUgdXNlZCBpZiBpdCByZXByZXNlbnRzIGEgaGllcmFyY2h5IG9mIGJvbmVzIChzZWUge0BsaW5rIEJvbmV9KS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBjb25zdCBlID0gdl8odCksIGkgPSBuZXcgSHQoKSwgbiA9IFtdLCBzID0gW107CiAgICBmb3IgKGxldCBoID0gMDsgaCA8IGUubGVuZ3RoOyBoKyspIHsKICAgICAgY29uc3QgYyA9IGVbaF07CiAgICAgIGMucGFyZW50ICYmIGMucGFyZW50LmlzQm9uZSAmJiAobi5wdXNoKDAsIDAsIDApLCBuLnB1c2goMCwgMCwgMCksIHMucHVzaCgwLCAwLCAwKSwgcy5wdXNoKDAsIDAsIDApKTsKICAgIH0KICAgIGkuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChuLCAzKSksIGkuc2V0QXR0cmlidXRlKCJjb2xvciIsIG5ldyB3dChzLCAzKSk7CiAgICBjb25zdCByID0gbmV3IFBlKHsgdmVydGV4Q29sb3JzOiAhMCwgZGVwdGhUZXN0OiAhMSwgZGVwdGhXcml0ZTogITEsIHRvbmVNYXBwZWQ6ICExLCB0cmFuc3BhcmVudDogITAgfSk7CiAgICBzdXBlcihpLCByKSwgdGhpcy5pc1NrZWxldG9uSGVscGVyID0gITAsIHRoaXMudHlwZSA9ICJTa2VsZXRvbkhlbHBlciIsIHRoaXMucm9vdCA9IHQsIHRoaXMuYm9uZXMgPSBlLCB0aGlzLm1hdHJpeCA9IHQubWF0cml4V29ybGQsIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9ICExOwogICAgY29uc3QgbyA9IG5ldyBjdCgyNTUpLCBsID0gbmV3IGN0KDY1MjgwKTsKICAgIHRoaXMuc2V0Q29sb3JzKG8sIGwpOwogIH0KICB1cGRhdGVNYXRyaXhXb3JsZCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5ib25lcywgaSA9IHRoaXMuZ2VvbWV0cnksIG4gPSBpLmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKTsKICAgIFF1LmNvcHkodGhpcy5yb290Lm1hdHJpeFdvcmxkKS5pbnZlcnQoKTsKICAgIGZvciAobGV0IHMgPSAwLCByID0gMDsgcyA8IGUubGVuZ3RoOyBzKyspIHsKICAgICAgY29uc3QgbyA9IGVbc107CiAgICAgIG8ucGFyZW50ICYmIG8ucGFyZW50LmlzQm9uZSAmJiAoTGwubXVsdGlwbHlNYXRyaWNlcyhRdSwgby5tYXRyaXhXb3JsZCksIHVzLnNldEZyb21NYXRyaXhQb3NpdGlvbihMbCksIG4uc2V0WFlaKHIsIHVzLngsIHVzLnksIHVzLnopLCBMbC5tdWx0aXBseU1hdHJpY2VzKFF1LCBvLnBhcmVudC5tYXRyaXhXb3JsZCksIHVzLnNldEZyb21NYXRyaXhQb3NpdGlvbihMbCksIG4uc2V0WFlaKHIgKyAxLCB1cy54LCB1cy55LCB1cy56KSwgciArPSAyKTsKICAgIH0KICAgIGkuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpLm5lZWRzVXBkYXRlID0gITAsIHN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKHQpOwogIH0KICAvKioKICAgKiBEZWZpbmVzIHRoZSBjb2xvcnMgb2YgdGhlIGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yMSAtIFRoZSBmaXJzdCBsaW5lIGNvbG9yIGZvciBlYWNoIGJvbmUuCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IyIC0gVGhlIHNlY29uZCBsaW5lIGNvbG9yIGZvciBlYWNoIGJvbmUuCiAgICogQHJldHVybiB7U2tlbGV0b25IZWxwZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaGVscGVyLgogICAqLwogIHNldENvbG9ycyh0LCBlKSB7CiAgICBjb25zdCBuID0gdGhpcy5nZW9tZXRyeS5nZXRBdHRyaWJ1dGUoImNvbG9yIik7CiAgICBmb3IgKGxldCBzID0gMDsgcyA8IG4uY291bnQ7IHMgKz0gMikKICAgICAgbi5zZXRYWVoocywgdC5yLCB0LmcsIHQuYiksIG4uc2V0WFlaKHMgKyAxLCBlLnIsIGUuZywgZS5iKTsKICAgIHJldHVybiBuLm5lZWRzVXBkYXRlID0gITAsIHRoaXM7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmdlb21ldHJ5LmRpc3Bvc2UoKSwgdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgfQp9CmZ1bmN0aW9uIHZfKGEpIHsKICBjb25zdCB0ID0gW107CiAgYS5pc0JvbmUgPT09ICEwICYmIHQucHVzaChhKTsKICBmb3IgKGxldCBlID0gMDsgZSA8IGEuY2hpbGRyZW4ubGVuZ3RoOyBlKyspCiAgICB0LnB1c2goLi4udl8oYS5jaGlsZHJlbltlXSkpOwogIHJldHVybiB0Owp9CmNsYXNzIEVNIGV4dGVuZHMgcmUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgcG9pbnQgbGlnaHQgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtQb2ludExpZ2h0fSBsaWdodCAtIFRoZSBsaWdodCB0byBiZSB2aXN1YWxpemVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BoZXJlU2l6ZT0xXSAtIFRoZSBzaXplIG9mIHRoZSBzcGhlcmUgaGVscGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfENvbG9yfHN0cmluZ30gW2NvbG9yXSAtIFRoZSBoZWxwZXIncyBjb2xvci4gSWYgbm90IHNldCwgdGhlIGhlbHBlciB3aWxsIHRha2UKICAgKiB0aGUgY29sb3Igb2YgdGhlIGxpZ2h0LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBuZXcgUmEoZSwgNCwgMiksIHMgPSBuZXcgbGkoeyB3aXJlZnJhbWU6ICEwLCBmb2c6ICExLCB0b25lTWFwcGVkOiAhMSB9KTsKICAgIHN1cGVyKG4sIHMpLCB0aGlzLmxpZ2h0ID0gdCwgdGhpcy5jb2xvciA9IGksIHRoaXMudHlwZSA9ICJQb2ludExpZ2h0SGVscGVyIiwgdGhpcy5tYXRyaXggPSB0aGlzLmxpZ2h0Lm1hdHJpeFdvcmxkLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSAhMSwgdGhpcy51cGRhdGUoKTsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpLCB0aGlzLm1hdGVyaWFsLmRpc3Bvc2UoKTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgaGVscGVyIHRvIG1hdGNoIHRoZSBwb3NpdGlvbiBvZiB0aGUKICAgKiBsaWdodCBiZWluZyB2aXN1YWxpemVkLgogICAqLwogIHVwZGF0ZSgpIHsKICAgIHRoaXMubGlnaHQudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdGhpcy5jb2xvciAhPT0gdm9pZCAwID8gdGhpcy5tYXRlcmlhbC5jb2xvci5zZXQodGhpcy5jb2xvcikgOiB0aGlzLm1hdGVyaWFsLmNvbG9yLmNvcHkodGhpcy5saWdodC5jb2xvcik7CiAgfQp9CmNvbnN0IFRNID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIExtID0gLyogQF9fUFVSRV9fICovIG5ldyBjdCgpLCBEbSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgY3QoKTsKY2xhc3MgQ00gZXh0ZW5kcyBsZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBoZW1pc3BoZXJlIGxpZ2h0IGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7SGVtaXNwaGVyZUxpZ2h0fSBsaWdodCAtIFRoZSBsaWdodCB0byBiZSB2aXN1YWxpemVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xXSAtIFRoZSBzaXplIG9mIHRoZSBtZXNoIHVzZWQgdG8gdmlzdWFsaXplIHRoZSBsaWdodC4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IFtjb2xvcl0gLSBUaGUgaGVscGVyJ3MgY29sb3IuIElmIG5vdCBzZXQsIHRoZSBoZWxwZXIgd2lsbCB0YWtlCiAgICogdGhlIGNvbG9yIG9mIHRoZSBsaWdodC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBzdXBlcigpLCB0aGlzLmxpZ2h0ID0gdCwgdGhpcy5tYXRyaXggPSB0Lm1hdHJpeFdvcmxkLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSAhMSwgdGhpcy5jb2xvciA9IGksIHRoaXMudHlwZSA9ICJIZW1pc3BoZXJlTGlnaHRIZWxwZXIiOwogICAgY29uc3QgbiA9IG5ldyBIbyhlKTsKICAgIG4ucm90YXRlWShNYXRoLlBJICogMC41KSwgdGhpcy5tYXRlcmlhbCA9IG5ldyBsaSh7IHdpcmVmcmFtZTogITAsIGZvZzogITEsIHRvbmVNYXBwZWQ6ICExIH0pLCB0aGlzLmNvbG9yID09PSB2b2lkIDAgJiYgKHRoaXMubWF0ZXJpYWwudmVydGV4Q29sb3JzID0gITApOwogICAgY29uc3QgcyA9IG4uZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpLCByID0gbmV3IEZsb2F0MzJBcnJheShzLmNvdW50ICogMyk7CiAgICBuLnNldEF0dHJpYnV0ZSgiY29sb3IiLCBuZXcgaWUociwgMykpLCB0aGlzLmFkZChuZXcgcmUobiwgdGhpcy5tYXRlcmlhbCkpLCB0aGlzLnVwZGF0ZSgpOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5jaGlsZHJlblswXS5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMuY2hpbGRyZW5bMF0ubWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSBoZWxwZXIgdG8gbWF0Y2ggdGhlIHBvc2l0aW9uIGFuZCBkaXJlY3Rpb24gb2YgdGhlCiAgICogbGlnaHQgYmVpbmcgdmlzdWFsaXplZC4KICAgKi8KICB1cGRhdGUoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5jaGlsZHJlblswXTsKICAgIGlmICh0aGlzLmNvbG9yICE9PSB2b2lkIDApCiAgICAgIHRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0KHRoaXMuY29sb3IpOwogICAgZWxzZSB7CiAgICAgIGNvbnN0IGUgPSB0Lmdlb21ldHJ5LmdldEF0dHJpYnV0ZSgiY29sb3IiKTsKICAgICAgTG0uY29weSh0aGlzLmxpZ2h0LmNvbG9yKSwgRG0uY29weSh0aGlzLmxpZ2h0Lmdyb3VuZENvbG9yKTsKICAgICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmNvdW50OyBpIDwgbjsgaSsrKSB7CiAgICAgICAgY29uc3QgcyA9IGkgPCBuIC8gMiA/IExtIDogRG07CiAgICAgICAgZS5zZXRYWVooaSwgcy5yLCBzLmcsIHMuYik7CiAgICAgIH0KICAgICAgZS5uZWVkc1VwZGF0ZSA9ICEwOwogICAgfQogICAgdGhpcy5saWdodC51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0Lmxvb2tBdChUTS5zZXRGcm9tTWF0cml4UG9zaXRpb24odGhpcy5saWdodC5tYXRyaXhXb3JsZCkubmVnYXRlKCkpOwogIH0KfQpsZXQgUk0gPSBjbGFzcyBleHRlbmRzIG9pIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGdyaWQgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzaXplPTEwXSAtIFRoZSBzaXplIG9mIHRoZSBncmlkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZGl2aXNpb25zPTEwXSAtIFRoZSBudW1iZXIgb2YgZGl2aXNpb25zIGFjcm9zcyB0aGUgZ3JpZC4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IFtjb2xvcjE9MHg0NDQ0NDRdIC0gVGhlIGNvbG9yIG9mIHRoZSBjZW50ZXIgbGluZS4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IFtjb2xvcjI9MHg4ODg4ODhdIC0gVGhlIGNvbG9yIG9mIHRoZSBsaW5lcyBvZiB0aGUgZ3JpZC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMTAsIGUgPSAxMCwgaSA9IDQ0NzM5MjQsIG4gPSA4OTQ3ODQ4KSB7CiAgICBpID0gbmV3IGN0KGkpLCBuID0gbmV3IGN0KG4pOwogICAgY29uc3QgcyA9IGUgLyAyLCByID0gdCAvIGUsIG8gPSB0IC8gMiwgbCA9IFtdLCBoID0gW107CiAgICBmb3IgKGxldCBkID0gMCwgcCA9IDAsIGYgPSAtbzsgZCA8PSBlOyBkKyssIGYgKz0gcikgewogICAgICBsLnB1c2goLW8sIDAsIGYsIG8sIDAsIGYpLCBsLnB1c2goZiwgMCwgLW8sIGYsIDAsIG8pOwogICAgICBjb25zdCB5ID0gZCA9PT0gcyA/IGkgOiBuOwogICAgICB5LnRvQXJyYXkoaCwgcCksIHAgKz0gMywgeS50b0FycmF5KGgsIHApLCBwICs9IDMsIHkudG9BcnJheShoLCBwKSwgcCArPSAzLCB5LnRvQXJyYXkoaCwgcCksIHAgKz0gMzsKICAgIH0KICAgIGNvbnN0IGMgPSBuZXcgSHQoKTsKICAgIGMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChsLCAzKSksIGMuc2V0QXR0cmlidXRlKCJjb2xvciIsIG5ldyB3dChoLCAzKSk7CiAgICBjb25zdCB1ID0gbmV3IFBlKHsgdmVydGV4Q29sb3JzOiAhMCwgdG9uZU1hcHBlZDogITEgfSk7CiAgICBzdXBlcihjLCB1KSwgdGhpcy50eXBlID0gIkdyaWRIZWxwZXIiOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KfTsKY2xhc3MgUE0gZXh0ZW5kcyBvaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwb2xhciBncmlkIGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcmFkaXVzPTEwXSAtIFRoZSByYWRpdXMgb2YgdGhlIHBvbGFyIGdyaWQuIFRoaXMgY2FuIGJlIGFueSBwb3NpdGl2ZSBudW1iZXIuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzZWN0b3JzPTE2XSAtIFRoZSBudW1iZXIgb2Ygc2VjdG9ycyB0aGUgZ3JpZCB3aWxsIGJlIGRpdmlkZWQgaW50by4gVGhpcyBjYW4gYmUgYW55IHBvc2l0aXZlIGludGVnZXIuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtyaW5ncz0xNl0gLSBUaGUgbnVtYmVyIG9mIHJpbmdzLiBUaGlzIGNhbiBiZSBhbnkgcG9zaXRpdmUgaW50ZWdlci4KICAgKiBAcGFyYW0ge251bWJlcn0gW2RpdmlzaW9ucz02NF0gLSBUaGUgbnVtYmVyIG9mIGxpbmUgc2VnbWVudHMgdXNlZCBmb3IgZWFjaCBjaXJjbGUuIFRoaXMgY2FuIGJlIGFueSBwb3NpdGl2ZSBpbnRlZ2VyLgogICAqIEBwYXJhbSB7bnVtYmVyfENvbG9yfHN0cmluZ30gW2NvbG9yMT0weDQ0NDQ0NF0gLSBUaGUgZmlyc3QgY29sb3IgdXNlZCBmb3IgZ3JpZCBlbGVtZW50cy4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IFtjb2xvcjI9MHg4ODg4ODhdIC0gIFRoZSBzZWNvbmQgY29sb3IgdXNlZCBmb3IgZ3JpZCBlbGVtZW50cy4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMTAsIGUgPSAxNiwgaSA9IDgsIG4gPSA2NCwgcyA9IDQ0NzM5MjQsIHIgPSA4OTQ3ODQ4KSB7CiAgICBzID0gbmV3IGN0KHMpLCByID0gbmV3IGN0KHIpOwogICAgY29uc3QgbyA9IFtdLCBsID0gW107CiAgICBpZiAoZSA+IDEpCiAgICAgIGZvciAobGV0IHUgPSAwOyB1IDwgZTsgdSsrKSB7CiAgICAgICAgY29uc3QgZCA9IHUgLyBlICogKE1hdGguUEkgKiAyKSwgcCA9IE1hdGguc2luKGQpICogdCwgZiA9IE1hdGguY29zKGQpICogdDsKICAgICAgICBvLnB1c2goMCwgMCwgMCksIG8ucHVzaChwLCAwLCBmKTsKICAgICAgICBjb25zdCB5ID0gdSAmIDEgPyBzIDogcjsKICAgICAgICBsLnB1c2goeS5yLCB5LmcsIHkuYiksIGwucHVzaCh5LnIsIHkuZywgeS5iKTsKICAgICAgfQogICAgZm9yIChsZXQgdSA9IDA7IHUgPCBpOyB1KyspIHsKICAgICAgY29uc3QgZCA9IHUgJiAxID8gcyA6IHIsIHAgPSB0IC0gdCAvIGkgKiB1OwogICAgICBmb3IgKGxldCBmID0gMDsgZiA8IG47IGYrKykgewogICAgICAgIGxldCB5ID0gZiAvIG4gKiAoTWF0aC5QSSAqIDIpLCBnID0gTWF0aC5zaW4oeSkgKiBwLCBtID0gTWF0aC5jb3MoeSkgKiBwOwogICAgICAgIG8ucHVzaChnLCAwLCBtKSwgbC5wdXNoKGQuciwgZC5nLCBkLmIpLCB5ID0gKGYgKyAxKSAvIG4gKiAoTWF0aC5QSSAqIDIpLCBnID0gTWF0aC5zaW4oeSkgKiBwLCBtID0gTWF0aC5jb3MoeSkgKiBwLCBvLnB1c2goZywgMCwgbSksIGwucHVzaChkLnIsIGQuZywgZC5iKTsKICAgICAgfQogICAgfQogICAgY29uc3QgaCA9IG5ldyBIdCgpOwogICAgaC5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KG8sIDMpKSwgaC5zZXRBdHRyaWJ1dGUoImNvbG9yIiwgbmV3IHd0KGwsIDMpKTsKICAgIGNvbnN0IGMgPSBuZXcgUGUoeyB2ZXJ0ZXhDb2xvcnM6ICEwLCB0b25lTWFwcGVkOiAhMSB9KTsKICAgIHN1cGVyKGgsIGMpLCB0aGlzLnR5cGUgPSAiUG9sYXJHcmlkSGVscGVyIjsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpLCB0aGlzLm1hdGVyaWFsLmRpc3Bvc2UoKTsKICB9Cn0KY29uc3QgRm0gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgRGwgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSwgVW0gPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKY2xhc3MgSU0gZXh0ZW5kcyBsZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBkaXJlY3Rpb25hbCBsaWdodCBoZWxwZXIuCiAgICoKICAgKiBAcGFyYW0ge0RpcmVjdGlvbmFsTGlnaHR9IGxpZ2h0IC0gVGhlIGxpZ2h0IHRvIGJlIHZpc3VhbGl6ZWQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzaXplPTFdIC0gVGhlIGRpbWVuc2lvbnMgb2YgdGhlIHBsYW5lLgogICAqIEBwYXJhbSB7bnVtYmVyfENvbG9yfHN0cmluZ30gW2NvbG9yXSAtIFRoZSBoZWxwZXIncyBjb2xvci4gSWYgbm90IHNldCwgdGhlIGhlbHBlciB3aWxsIHRha2UKICAgKiB0aGUgY29sb3Igb2YgdGhlIGxpZ2h0LgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHN1cGVyKCksIHRoaXMubGlnaHQgPSB0LCB0aGlzLm1hdHJpeCA9IHQubWF0cml4V29ybGQsIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9ICExLCB0aGlzLmNvbG9yID0gaSwgdGhpcy50eXBlID0gIkRpcmVjdGlvbmFsTGlnaHRIZWxwZXIiLCBlID09PSB2b2lkIDAgJiYgKGUgPSAxKTsKICAgIGxldCBuID0gbmV3IEh0KCk7CiAgICBuLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QoWwogICAgICAtZSwKICAgICAgZSwKICAgICAgMCwKICAgICAgZSwKICAgICAgZSwKICAgICAgMCwKICAgICAgZSwKICAgICAgLWUsCiAgICAgIDAsCiAgICAgIC1lLAogICAgICAtZSwKICAgICAgMCwKICAgICAgLWUsCiAgICAgIGUsCiAgICAgIDAKICAgIF0sIDMpKTsKICAgIGNvbnN0IHMgPSBuZXcgUGUoeyBmb2c6ICExLCB0b25lTWFwcGVkOiAhMSB9KTsKICAgIHRoaXMubGlnaHRQbGFuZSA9IG5ldyBScyhuLCBzKSwgdGhpcy5hZGQodGhpcy5saWdodFBsYW5lKSwgbiA9IG5ldyBIdCgpLCBuLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QoWzAsIDAsIDAsIDAsIDAsIDFdLCAzKSksIHRoaXMudGFyZ2V0TGluZSA9IG5ldyBScyhuLCBzKSwgdGhpcy5hZGQodGhpcy50YXJnZXRMaW5lKSwgdGhpcy51cGRhdGUoKTsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMubGlnaHRQbGFuZS5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMubGlnaHRQbGFuZS5tYXRlcmlhbC5kaXNwb3NlKCksIHRoaXMudGFyZ2V0TGluZS5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMudGFyZ2V0TGluZS5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIGhlbHBlciB0byBtYXRjaCB0aGUgcG9zaXRpb24gYW5kIGRpcmVjdGlvbiBvZiB0aGUKICAgKiBsaWdodCBiZWluZyB2aXN1YWxpemVkLgogICAqLwogIHVwZGF0ZSgpIHsKICAgIHRoaXMubGlnaHQudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdGhpcy5saWdodC50YXJnZXQudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgRm0uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubGlnaHQubWF0cml4V29ybGQpLCBEbC5zZXRGcm9tTWF0cml4UG9zaXRpb24odGhpcy5saWdodC50YXJnZXQubWF0cml4V29ybGQpLCBVbS5zdWJWZWN0b3JzKERsLCBGbSksIHRoaXMubGlnaHRQbGFuZS5sb29rQXQoRGwpLCB0aGlzLmNvbG9yICE9PSB2b2lkIDAgPyAodGhpcy5saWdodFBsYW5lLm1hdGVyaWFsLmNvbG9yLnNldCh0aGlzLmNvbG9yKSwgdGhpcy50YXJnZXRMaW5lLm1hdGVyaWFsLmNvbG9yLnNldCh0aGlzLmNvbG9yKSkgOiAodGhpcy5saWdodFBsYW5lLm1hdGVyaWFsLmNvbG9yLmNvcHkodGhpcy5saWdodC5jb2xvciksIHRoaXMudGFyZ2V0TGluZS5tYXRlcmlhbC5jb2xvci5jb3B5KHRoaXMubGlnaHQuY29sb3IpKSwgdGhpcy50YXJnZXRMaW5lLmxvb2tBdChEbCksIHRoaXMudGFyZ2V0TGluZS5zY2FsZS56ID0gVW0ubGVuZ3RoKCk7CiAgfQp9CmNvbnN0IEZsID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCksIEVlID0gLyogQF9fUFVSRV9fICovIG5ldyBrYygpOwpjbGFzcyBMTSBleHRlbmRzIG9pIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGFycm93IGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7Q2FtZXJhfSBjYW1lcmEgLSBUaGUgY2FtZXJhIHRvIHZpc3VhbGl6ZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBjb25zdCBlID0gbmV3IEh0KCksIGkgPSBuZXcgUGUoeyBjb2xvcjogMTY3NzcyMTUsIHZlcnRleENvbG9yczogITAsIHRvbmVNYXBwZWQ6ICExIH0pLCBuID0gW10sIHMgPSBbXSwgciA9IHt9OwogICAgbygibjEiLCAibjIiKSwgbygibjIiLCAibjQiKSwgbygibjQiLCAibjMiKSwgbygibjMiLCAibjEiKSwgbygiZjEiLCAiZjIiKSwgbygiZjIiLCAiZjQiKSwgbygiZjQiLCAiZjMiKSwgbygiZjMiLCAiZjEiKSwgbygibjEiLCAiZjEiKSwgbygibjIiLCAiZjIiKSwgbygibjMiLCAiZjMiKSwgbygibjQiLCAiZjQiKSwgbygicCIsICJuMSIpLCBvKCJwIiwgIm4yIiksIG8oInAiLCAibjMiKSwgbygicCIsICJuNCIpLCBvKCJ1MSIsICJ1MiIpLCBvKCJ1MiIsICJ1MyIpLCBvKCJ1MyIsICJ1MSIpLCBvKCJjIiwgInQiKSwgbygicCIsICJjIiksIG8oImNuMSIsICJjbjIiKSwgbygiY24zIiwgImNuNCIpLCBvKCJjZjEiLCAiY2YyIiksIG8oImNmMyIsICJjZjQiKTsKICAgIGZ1bmN0aW9uIG8oZiwgeSkgewogICAgICBsKGYpLCBsKHkpOwogICAgfQogICAgZnVuY3Rpb24gbChmKSB7CiAgICAgIG4ucHVzaCgwLCAwLCAwKSwgcy5wdXNoKDAsIDAsIDApLCByW2ZdID09PSB2b2lkIDAgJiYgKHJbZl0gPSBbXSksIHJbZl0ucHVzaChuLmxlbmd0aCAvIDMgLSAxKTsKICAgIH0KICAgIGUuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChuLCAzKSksIGUuc2V0QXR0cmlidXRlKCJjb2xvciIsIG5ldyB3dChzLCAzKSksIHN1cGVyKGUsIGkpLCB0aGlzLnR5cGUgPSAiQ2FtZXJhSGVscGVyIiwgdGhpcy5jYW1lcmEgPSB0LCB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4ICYmIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKSwgdGhpcy5tYXRyaXggPSB0Lm1hdHJpeFdvcmxkLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSAhMSwgdGhpcy5wb2ludE1hcCA9IHIsIHRoaXMudXBkYXRlKCk7CiAgICBjb25zdCBoID0gbmV3IGN0KDE2NzU1MjAwKSwgYyA9IG5ldyBjdCgxNjcxMTY4MCksIHUgPSBuZXcgY3QoNDM3NzUpLCBkID0gbmV3IGN0KDE2Nzc3MjE1KSwgcCA9IG5ldyBjdCgzMzU1NDQzKTsKICAgIHRoaXMuc2V0Q29sb3JzKGgsIGMsIHUsIGQsIHApOwogIH0KICAvKioKICAgKiBEZWZpbmVzIHRoZSBjb2xvcnMgb2YgdGhlIGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGZydXN0dW0gLSBUaGUgZnJ1c3R1bSBsaW5lIGNvbG9yLgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbmUgLSBUaGUgY29uZSBsaW5lIGNvbG9yLgogICAqIEBwYXJhbSB7Q29sb3J9IHVwIC0gVGhlIHVwIGxpbmUgY29sb3IuCiAgICogQHBhcmFtIHtDb2xvcn0gdGFyZ2V0IC0gVGhlIHRhcmdldCBsaW5lIGNvbG9yLgogICAqIEBwYXJhbSB7Q29sb3J9IGNyb3NzIC0gVGhlIGNyb3NzIGxpbmUgY29sb3IuCiAgICogQHJldHVybiB7Q2FtZXJhSGVscGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIGhlbHBlci4KICAgKi8KICBzZXRDb2xvcnModCwgZSwgaSwgbiwgcykgewogICAgY29uc3QgbyA9IHRoaXMuZ2VvbWV0cnkuZ2V0QXR0cmlidXRlKCJjb2xvciIpOwogICAgcmV0dXJuIG8uc2V0WFlaKDAsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWigxLCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooMiwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDMsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWig0LCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooNSwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDYsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWig3LCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooOCwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDksIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWigxMCwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDExLCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooMTIsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWigxMywgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDE0LCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooMTUsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWigxNiwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDE3LCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooMTgsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWigxOSwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDIwLCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooMjEsIHQuciwgdC5nLCB0LmIpLCBvLnNldFhZWigyMiwgdC5yLCB0LmcsIHQuYiksIG8uc2V0WFlaKDIzLCB0LnIsIHQuZywgdC5iKSwgby5zZXRYWVooMjQsIGUuciwgZS5nLCBlLmIpLCBvLnNldFhZWigyNSwgZS5yLCBlLmcsIGUuYiksIG8uc2V0WFlaKDI2LCBlLnIsIGUuZywgZS5iKSwgby5zZXRYWVooMjcsIGUuciwgZS5nLCBlLmIpLCBvLnNldFhZWigyOCwgZS5yLCBlLmcsIGUuYiksIG8uc2V0WFlaKDI5LCBlLnIsIGUuZywgZS5iKSwgby5zZXRYWVooMzAsIGUuciwgZS5nLCBlLmIpLCBvLnNldFhZWigzMSwgZS5yLCBlLmcsIGUuYiksIG8uc2V0WFlaKDMyLCBpLnIsIGkuZywgaS5iKSwgby5zZXRYWVooMzMsIGkuciwgaS5nLCBpLmIpLCBvLnNldFhZWigzNCwgaS5yLCBpLmcsIGkuYiksIG8uc2V0WFlaKDM1LCBpLnIsIGkuZywgaS5iKSwgby5zZXRYWVooMzYsIGkuciwgaS5nLCBpLmIpLCBvLnNldFhZWigzNywgaS5yLCBpLmcsIGkuYiksIG8uc2V0WFlaKDM4LCBuLnIsIG4uZywgbi5iKSwgby5zZXRYWVooMzksIG4uciwgbi5nLCBuLmIpLCBvLnNldFhZWig0MCwgcy5yLCBzLmcsIHMuYiksIG8uc2V0WFlaKDQxLCBzLnIsIHMuZywgcy5iKSwgby5zZXRYWVooNDIsIHMuciwgcy5nLCBzLmIpLCBvLnNldFhZWig0Mywgcy5yLCBzLmcsIHMuYiksIG8uc2V0WFlaKDQ0LCBzLnIsIHMuZywgcy5iKSwgby5zZXRYWVooNDUsIHMuciwgcy5nLCBzLmIpLCBvLnNldFhZWig0Niwgcy5yLCBzLmcsIHMuYiksIG8uc2V0WFlaKDQ3LCBzLnIsIHMuZywgcy5iKSwgby5zZXRYWVooNDgsIHMuciwgcy5nLCBzLmIpLCBvLnNldFhZWig0OSwgcy5yLCBzLmcsIHMuYiksIG8ubmVlZHNVcGRhdGUgPSAhMCwgdGhpczsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgaGVscGVyIGJhc2VkIG9uIHRoZSBwcm9qZWN0aW9uIG1hdHJpeCBvZiB0aGUgY2FtZXJhLgogICAqLwogIHVwZGF0ZSgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmdlb21ldHJ5LCBlID0gdGhpcy5wb2ludE1hcCwgaSA9IDEsIG4gPSAxOwogICAgbGV0IHMsIHI7CiAgICBpZiAoRWUucHJvamVjdGlvbk1hdHJpeEludmVyc2UuY29weSh0aGlzLmNhbWVyYS5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZSksIHRoaXMuY2FtZXJhLnJldmVyc2VkRGVwdGggPT09ICEwKQogICAgICBzID0gMSwgciA9IDA7CiAgICBlbHNlIGlmICh0aGlzLmNhbWVyYS5jb29yZGluYXRlU3lzdGVtID09PSBOaSkKICAgICAgcyA9IC0xLCByID0gMTsKICAgIGVsc2UgaWYgKHRoaXMuY2FtZXJhLmNvb3JkaW5hdGVTeXN0ZW0gPT09IGdhKQogICAgICBzID0gMCwgciA9IDE7CiAgICBlbHNlCiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuQ2FtZXJhSGVscGVyLnVwZGF0ZSgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAiICsgdGhpcy5jYW1lcmEuY29vcmRpbmF0ZVN5c3RlbSk7CiAgICBUZSgiYyIsIGUsIHQsIEVlLCAwLCAwLCBzKSwgVGUoInQiLCBlLCB0LCBFZSwgMCwgMCwgciksIFRlKCJuMSIsIGUsIHQsIEVlLCAtaSwgLW4sIHMpLCBUZSgibjIiLCBlLCB0LCBFZSwgaSwgLW4sIHMpLCBUZSgibjMiLCBlLCB0LCBFZSwgLWksIG4sIHMpLCBUZSgibjQiLCBlLCB0LCBFZSwgaSwgbiwgcyksIFRlKCJmMSIsIGUsIHQsIEVlLCAtaSwgLW4sIHIpLCBUZSgiZjIiLCBlLCB0LCBFZSwgaSwgLW4sIHIpLCBUZSgiZjMiLCBlLCB0LCBFZSwgLWksIG4sIHIpLCBUZSgiZjQiLCBlLCB0LCBFZSwgaSwgbiwgciksIFRlKCJ1MSIsIGUsIHQsIEVlLCBpICogMC43LCBuICogMS4xLCBzKSwgVGUoInUyIiwgZSwgdCwgRWUsIC1pICogMC43LCBuICogMS4xLCBzKSwgVGUoInUzIiwgZSwgdCwgRWUsIDAsIG4gKiAyLCBzKSwgVGUoImNmMSIsIGUsIHQsIEVlLCAtaSwgMCwgciksIFRlKCJjZjIiLCBlLCB0LCBFZSwgaSwgMCwgciksIFRlKCJjZjMiLCBlLCB0LCBFZSwgMCwgLW4sIHIpLCBUZSgiY2Y0IiwgZSwgdCwgRWUsIDAsIG4sIHIpLCBUZSgiY24xIiwgZSwgdCwgRWUsIC1pLCAwLCBzKSwgVGUoImNuMiIsIGUsIHQsIEVlLCBpLCAwLCBzKSwgVGUoImNuMyIsIGUsIHQsIEVlLCAwLCAtbiwgcyksIFRlKCJjbjQiLCBlLCB0LCBFZSwgMCwgbiwgcyksIHQuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpLm5lZWRzVXBkYXRlID0gITA7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmdlb21ldHJ5LmRpc3Bvc2UoKSwgdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgfQp9CmZ1bmN0aW9uIFRlKGEsIHQsIGUsIGksIG4sIHMsIHIpIHsKICBGbC5zZXQobiwgcywgcikudW5wcm9qZWN0KGkpOwogIGNvbnN0IG8gPSB0W2FdOwogIGlmIChvICE9PSB2b2lkIDApIHsKICAgIGNvbnN0IGwgPSBlLmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKTsKICAgIGZvciAobGV0IGggPSAwLCBjID0gby5sZW5ndGg7IGggPCBjOyBoKyspCiAgICAgIGwuc2V0WFlaKG9baF0sIEZsLngsIEZsLnksIEZsLnopOwogIH0KfQpjb25zdCBVbCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgd2UoKTsKbGV0IERNID0gY2xhc3MgZXh0ZW5kcyBvaSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBib3ggaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtPYmplY3QzRH0gW29iamVjdF0gLSBUaGUgM0Qgb2JqZWN0IHRvIHNob3cgdGhlIHdvcmxkLWF4aXMtYWxpZ25lZCBib3VuZGluZyBib3guCiAgICogQHBhcmFtIHtudW1iZXJ8Q29sb3J8c3RyaW5nfSBbY29sb3I9MHhmZmZmMDBdIC0gVGhlIGJveCdzIGNvbG9yLgogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUgPSAxNjc3Njk2MCkgewogICAgY29uc3QgaSA9IG5ldyBVaW50MTZBcnJheShbMCwgMSwgMSwgMiwgMiwgMywgMywgMCwgNCwgNSwgNSwgNiwgNiwgNywgNywgNCwgMCwgNCwgMSwgNSwgMiwgNiwgMywgN10pLCBuID0gbmV3IEZsb2F0MzJBcnJheSg4ICogMyksIHMgPSBuZXcgSHQoKTsKICAgIHMuc2V0SW5kZXgobmV3IGllKGksIDEpKSwgcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IGllKG4sIDMpKSwgc3VwZXIocywgbmV3IFBlKHsgY29sb3I6IGUsIHRvbmVNYXBwZWQ6ICExIH0pKSwgdGhpcy5vYmplY3QgPSB0LCB0aGlzLnR5cGUgPSAiQm94SGVscGVyIiwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gITEsIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIGhlbHBlcidzIGdlb21ldHJ5IHRvIG1hdGNoIHRoZSBkaW1lbnNpb25zIG9mIHRoZSBvYmplY3QsCiAgICogaW5jbHVkaW5nIGFueSBjaGlsZHJlbi4KICAgKi8KICB1cGRhdGUoKSB7CiAgICBpZiAodGhpcy5vYmplY3QgIT09IHZvaWQgMCAmJiBVbC5zZXRGcm9tT2JqZWN0KHRoaXMub2JqZWN0KSwgVWwuaXNFbXB0eSgpKSByZXR1cm47CiAgICBjb25zdCB0ID0gVWwubWluLCBlID0gVWwubWF4LCBpID0gdGhpcy5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBuID0gaS5hcnJheTsKICAgIG5bMF0gPSBlLngsIG5bMV0gPSBlLnksIG5bMl0gPSBlLnosIG5bM10gPSB0LngsIG5bNF0gPSBlLnksIG5bNV0gPSBlLnosIG5bNl0gPSB0LngsIG5bN10gPSB0LnksIG5bOF0gPSBlLnosIG5bOV0gPSBlLngsIG5bMTBdID0gdC55LCBuWzExXSA9IGUueiwgblsxMl0gPSBlLngsIG5bMTNdID0gZS55LCBuWzE0XSA9IHQueiwgblsxNV0gPSB0LngsIG5bMTZdID0gZS55LCBuWzE3XSA9IHQueiwgblsxOF0gPSB0LngsIG5bMTldID0gdC55LCBuWzIwXSA9IHQueiwgblsyMV0gPSBlLngsIG5bMjJdID0gdC55LCBuWzIzXSA9IHQueiwgaS5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzLmdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSB3aXJlZnJhbWUgYm94IGZvciB0aGUgcGFzc2VkIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QgdG8gY3JlYXRlIHRoZSBoZWxwZXIgZm9yLgogICAqIEByZXR1cm4ge0JveEhlbHBlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBzZXRGcm9tT2JqZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLm9iamVjdCA9IHQsIHRoaXMudXBkYXRlKCksIHRoaXM7CiAgfQogIGNvcHkodCwgZSkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCwgZSksIHRoaXMub2JqZWN0ID0gdC5vYmplY3QsIHRoaXM7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmdlb21ldHJ5LmRpc3Bvc2UoKSwgdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgfQp9OwpjbGFzcyBGTSBleHRlbmRzIG9pIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGJveDMgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtCb3gzfSBib3ggLSBUaGUgYm94IHRvIHZpc3VhbGl6ZS4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IFtjb2xvcj0weGZmZmYwMF0gLSBUaGUgYm94J3MgY29sb3IuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSA9IDE2Nzc2OTYwKSB7CiAgICBjb25zdCBpID0gbmV3IFVpbnQxNkFycmF5KFswLCAxLCAxLCAyLCAyLCAzLCAzLCAwLCA0LCA1LCA1LCA2LCA2LCA3LCA3LCA0LCAwLCA0LCAxLCA1LCAyLCA2LCAzLCA3XSksIG4gPSBbMSwgMSwgMSwgLTEsIDEsIDEsIC0xLCAtMSwgMSwgMSwgLTEsIDEsIDEsIDEsIC0xLCAtMSwgMSwgLTEsIC0xLCAtMSwgLTEsIDEsIC0xLCAtMV0sIHMgPSBuZXcgSHQoKTsKICAgIHMuc2V0SW5kZXgobmV3IGllKGksIDEpKSwgcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IHd0KG4sIDMpKSwgc3VwZXIocywgbmV3IFBlKHsgY29sb3I6IGUsIHRvbmVNYXBwZWQ6ICExIH0pKSwgdGhpcy5ib3ggPSB0LCB0aGlzLnR5cGUgPSAiQm94M0hlbHBlciIsIHRoaXMuZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgfQogIHVwZGF0ZU1hdHJpeFdvcmxkKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmJveDsKICAgIGUuaXNFbXB0eSgpIHx8IChlLmdldENlbnRlcih0aGlzLnBvc2l0aW9uKSwgZS5nZXRTaXplKHRoaXMuc2NhbGUpLCB0aGlzLnNjYWxlLm11bHRpcGx5U2NhbGFyKDAuNSksIHN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKHQpKTsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpLCB0aGlzLm1hdGVyaWFsLmRpc3Bvc2UoKTsKICB9Cn0KY2xhc3MgVU0gZXh0ZW5kcyBScyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBwbGFuZSBoZWxwZXIuCiAgICoKICAgKiBAcGFyYW0ge1BsYW5lfSBwbGFuZSAtIFRoZSBwbGFuZSB0byBiZSB2aXN1YWxpemVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xXSAtIFRoZSBzaWRlIGxlbmd0aCBvZiBwbGFuZSBoZWxwZXIuCiAgICogQHBhcmFtIHtudW1iZXJ8Q29sb3J8c3RyaW5nfSBbaGV4PTB4ZmZmZjAwXSAtIFRoZSBoZWxwZXIncyBjb2xvci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlID0gMSwgaSA9IDE2Nzc2OTYwKSB7CiAgICBjb25zdCBuID0gaSwgcyA9IFsxLCAtMSwgMCwgLTEsIDEsIDAsIC0xLCAtMSwgMCwgMSwgMSwgMCwgLTEsIDEsIDAsIC0xLCAtMSwgMCwgMSwgLTEsIDAsIDEsIDEsIDBdLCByID0gbmV3IEh0KCk7CiAgICByLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QocywgMykpLCByLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCBzdXBlcihyLCBuZXcgUGUoeyBjb2xvcjogbiwgdG9uZU1hcHBlZDogITEgfSkpLCB0aGlzLnR5cGUgPSAiUGxhbmVIZWxwZXIiLCB0aGlzLnBsYW5lID0gdCwgdGhpcy5zaXplID0gZTsKICAgIGNvbnN0IG8gPSBbMSwgMSwgMCwgLTEsIDEsIDAsIC0xLCAtMSwgMCwgMSwgMSwgMCwgLTEsIC0xLCAwLCAxLCAtMSwgMF0sIGwgPSBuZXcgSHQoKTsKICAgIGwuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3dChvLCAzKSksIGwuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCksIHRoaXMuYWRkKG5ldyByZShsLCBuZXcgbGkoeyBjb2xvcjogbiwgb3BhY2l0eTogMC4yLCB0cmFuc3BhcmVudDogITAsIGRlcHRoV3JpdGU6ICExLCB0b25lTWFwcGVkOiAhMSB9KSkpOwogIH0KICB1cGRhdGVNYXRyaXhXb3JsZCh0KSB7CiAgICB0aGlzLnBvc2l0aW9uLnNldCgwLCAwLCAwKSwgdGhpcy5zY2FsZS5zZXQoMC41ICogdGhpcy5zaXplLCAwLjUgKiB0aGlzLnNpemUsIDEpLCB0aGlzLmxvb2tBdCh0aGlzLnBsYW5lLm5vcm1hbCksIHRoaXMudHJhbnNsYXRlWigtdGhpcy5wbGFuZS5jb25zdGFudCksIHN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKHQpOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSBoZWxwZXIgdG8gbWF0Y2ggdGhlIHBvc2l0aW9uIGFuZCBkaXJlY3Rpb24gb2YgdGhlCiAgICogbGlnaHQgYmVpbmcgdmlzdWFsaXplZC4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpLCB0aGlzLmNoaWxkcmVuWzBdLmdlb21ldHJ5LmRpc3Bvc2UoKSwgdGhpcy5jaGlsZHJlblswXS5tYXRlcmlhbC5kaXNwb3NlKCk7CiAgfQp9CmNvbnN0IEJtID0gLyogQF9fUFVSRV9fICovIG5ldyBFKCk7CmxldCBCbCwgdGQ7CmNsYXNzIEJNIGV4dGVuZHMgbGUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgYXJyb3cgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbZGlyPSgwLCAwLCAxKV0gLSBUaGUgKG5vcm1hbGl6ZWQpIGRpcmVjdGlvbiB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBbb3JpZ2luPSgwLCAwLCAwKV0gLSBQb2ludCBhdCB3aGljaCB0aGUgYXJyb3cgc3RhcnRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbGVuZ3RoPTFdIC0gTGVuZ3RoIG9mIHRoZSBhcnJvdyBpbiB3b3JsZCB1bml0cy4KICAgKiBAcGFyYW0geyhudW1iZXJ8Q29sb3J8c3RyaW5nKX0gW2NvbG9yPTB4ZmZmZjAwXSAtIENvbG9yIG9mIHRoZSBhcnJvdy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlYWRMZW5ndGg9bGVuZ3RoKjAuMl0gLSBUaGUgbGVuZ3RoIG9mIHRoZSBoZWFkIG9mIHRoZSBhcnJvdy4KICAgKiBAcGFyYW0ge251bWJlcn0gW2hlYWRXaWR0aD1oZWFkTGVuZ3RoKjAuMl0gLSBUaGUgd2lkdGggb2YgdGhlIGhlYWQgb2YgdGhlIGFycm93LgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgRSgwLCAwLCAxKSwgZSA9IG5ldyBFKDAsIDAsIDApLCBpID0gMSwgbiA9IDE2Nzc2OTYwLCBzID0gaSAqIDAuMiwgciA9IHMgKiAwLjIpIHsKICAgIHN1cGVyKCksIHRoaXMudHlwZSA9ICJBcnJvd0hlbHBlciIsIEJsID09PSB2b2lkIDAgJiYgKEJsID0gbmV3IEh0KCksIEJsLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QoWzAsIDAsIDAsIDAsIDEsIDBdLCAzKSksIHRkID0gbmV3IENhKDAuNSwgMSwgNSwgMSksIHRkLnRyYW5zbGF0ZSgwLCAtMC41LCAwKSksIHRoaXMucG9zaXRpb24uY29weShlKSwgdGhpcy5saW5lID0gbmV3IFJzKEJsLCBuZXcgUGUoeyBjb2xvcjogbiwgdG9uZU1hcHBlZDogITEgfSkpLCB0aGlzLmxpbmUubWF0cml4QXV0b1VwZGF0ZSA9ICExLCB0aGlzLmFkZCh0aGlzLmxpbmUpLCB0aGlzLmNvbmUgPSBuZXcgcmUodGQsIG5ldyBsaSh7IGNvbG9yOiBuLCB0b25lTWFwcGVkOiAhMSB9KSksIHRoaXMuY29uZS5tYXRyaXhBdXRvVXBkYXRlID0gITEsIHRoaXMuYWRkKHRoaXMuY29uZSksIHRoaXMuc2V0RGlyZWN0aW9uKHQpLCB0aGlzLnNldExlbmd0aChpLCBzLCByKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZGlyZWN0aW9uIG9mIHRoZSBoZWxwZXIuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGRpciAtIFRoZSBub3JtYWxpemVkIGRpcmVjdGlvbiB2ZWN0b3IuCiAgICovCiAgc2V0RGlyZWN0aW9uKHQpIHsKICAgIGlmICh0LnkgPiAwLjk5OTk5KQogICAgICB0aGlzLnF1YXRlcm5pb24uc2V0KDAsIDAsIDAsIDEpOwogICAgZWxzZSBpZiAodC55IDwgLTAuOTk5OTkpCiAgICAgIHRoaXMucXVhdGVybmlvbi5zZXQoMSwgMCwgMCwgMCk7CiAgICBlbHNlIHsKICAgICAgQm0uc2V0KHQueiwgMCwgLXQueCkubm9ybWFsaXplKCk7CiAgICAgIGNvbnN0IGUgPSBNYXRoLmFjb3ModC55KTsKICAgICAgdGhpcy5xdWF0ZXJuaW9uLnNldEZyb21BeGlzQW5nbGUoQm0sIGUpOwogICAgfQogIH0KICAvKioKICAgKiBTZXRzIHRoZSBsZW5ndGggb2YgdGhlIGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBMZW5ndGggb2YgdGhlIGFycm93IGluIHdvcmxkIHVuaXRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVhZExlbmd0aD1sZW5ndGgqMC4yXSAtIFRoZSBsZW5ndGggb2YgdGhlIGhlYWQgb2YgdGhlIGFycm93LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVhZFdpZHRoPWhlYWRMZW5ndGgqMC4yXSAtIFRoZSB3aWR0aCBvZiB0aGUgaGVhZCBvZiB0aGUgYXJyb3cuCiAgICovCiAgc2V0TGVuZ3RoKHQsIGUgPSB0ICogMC4yLCBpID0gZSAqIDAuMikgewogICAgdGhpcy5saW5lLnNjYWxlLnNldCgxLCBNYXRoLm1heCgxZS00LCB0IC0gZSksIDEpLCB0aGlzLmxpbmUudXBkYXRlTWF0cml4KCksIHRoaXMuY29uZS5zY2FsZS5zZXQoaSwgZSwgaSksIHRoaXMuY29uZS5wb3NpdGlvbi55ID0gdCwgdGhpcy5jb25lLnVwZGF0ZU1hdHJpeCgpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjb2xvciBvZiB0aGUgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ8Q29sb3J8c3RyaW5nfSBjb2xvciAtIFRoZSBjb2xvciB0byBzZXQuCiAgICovCiAgc2V0Q29sb3IodCkgewogICAgdGhpcy5saW5lLm1hdGVyaWFsLmNvbG9yLnNldCh0KSwgdGhpcy5jb25lLm1hdGVyaWFsLmNvbG9yLnNldCh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0LCAhMSksIHRoaXMubGluZS5jb3B5KHQubGluZSksIHRoaXMuY29uZS5jb3B5KHQuY29uZSksIHRoaXM7CiAgfQogIC8qKgogICAqIEZyZWVzIHRoZSBHUFUtcmVsYXRlZCByZXNvdXJjZXMgYWxsb2NhdGVkIGJ5IHRoaXMgaW5zdGFuY2UuIENhbGwgdGhpcwogICAqIG1ldGhvZCB3aGVuZXZlciB0aGlzIGluc3RhbmNlIGlzIG5vIGxvbmdlciB1c2VkIGluIHlvdXIgYXBwLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmxpbmUuZ2VvbWV0cnkuZGlzcG9zZSgpLCB0aGlzLmxpbmUubWF0ZXJpYWwuZGlzcG9zZSgpLCB0aGlzLmNvbmUuZ2VvbWV0cnkuZGlzcG9zZSgpLCB0aGlzLmNvbmUubWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KfQpsZXQgek0gPSBjbGFzcyBleHRlbmRzIG9pIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGF4ZXMgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzaXplPTFdIC0gU2l6ZSBvZiB0aGUgbGluZXMgcmVwcmVzZW50aW5nIHRoZSBheGVzLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSAxKSB7CiAgICBjb25zdCBlID0gWwogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICB0LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICB0LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICB0CiAgICBdLCBpID0gWwogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLjYsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAuNiwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMC42LAogICAgICAxCiAgICBdLCBuID0gbmV3IEh0KCk7CiAgICBuLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QoZSwgMykpLCBuLnNldEF0dHJpYnV0ZSgiY29sb3IiLCBuZXcgd3QoaSwgMykpOwogICAgY29uc3QgcyA9IG5ldyBQZSh7IHZlcnRleENvbG9yczogITAsIHRvbmVNYXBwZWQ6ICExIH0pOwogICAgc3VwZXIobiwgcyksIHRoaXMudHlwZSA9ICJBeGVzSGVscGVyIjsKICB9CiAgLyoqCiAgICogRGVmaW5lcyB0aGUgY29sb3JzIG9mIHRoZSBheGVzIGhlbHBlci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfENvbG9yfHN0cmluZ30geEF4aXNDb2xvciAtIFRoZSBjb2xvciBmb3IgdGhlIHggYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcnxDb2xvcnxzdHJpbmd9IHlBeGlzQ29sb3IgLSBUaGUgY29sb3IgZm9yIHRoZSB5IGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ8Q29sb3J8c3RyaW5nfSB6QXhpc0NvbG9yIC0gVGhlIGNvbG9yIGZvciB0aGUgeiBheGlzLgogICAqIEByZXR1cm4ge0F4ZXNIZWxwZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgYXhlcyBoZWxwZXIuCiAgICovCiAgc2V0Q29sb3JzKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBuZXcgY3QoKSwgcyA9IHRoaXMuZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvci5hcnJheTsKICAgIHJldHVybiBuLnNldCh0KSwgbi50b0FycmF5KHMsIDApLCBuLnRvQXJyYXkocywgMyksIG4uc2V0KGUpLCBuLnRvQXJyYXkocywgNiksIG4udG9BcnJheShzLCA5KSwgbi5zZXQoaSksIG4udG9BcnJheShzLCAxMiksIG4udG9BcnJheShzLCAxNSksIHRoaXMuZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvci5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KfTsKY2xhc3MgYl8gewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgc2hhcGUgcGF0aC4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMudHlwZSA9ICJTaGFwZVBhdGgiLCB0aGlzLmNvbG9yID0gbmV3IGN0KCksIHRoaXMuc3ViUGF0aHMgPSBbXSwgdGhpcy5jdXJyZW50UGF0aCA9IG51bGw7CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgcGF0aCBhbmQgbW92ZXMgaXQgY3VycmVudCBwb2ludCB0byB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZS4KICAgKiBAcmV0dXJuIHtTaGFwZVBhdGh9IEEgcmVmZXJlbmNlIHRvIHRoaXMgc2hhcGUgcGF0aC4KICAgKi8KICBtb3ZlVG8odCwgZSkgewogICAgcmV0dXJuIHRoaXMuY3VycmVudFBhdGggPSBuZXcgeGMoKSwgdGhpcy5zdWJQYXRocy5wdXNoKHRoaXMuY3VycmVudFBhdGgpLCB0aGlzLmN1cnJlbnRQYXRoLm1vdmVUbyh0LCBlKSwgdGhpczsKICB9CiAgLyoqCiAgICogQWRkcyBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgTGluZUN1cnZlfSB0byB0aGUgcGF0aCBieSBjb25uZWN0aW5nCiAgICogdGhlIGN1cnJlbnQgcG9pbnQgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBlbmQgcG9pbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBlbmQgcG9pbnQuCiAgICogQHJldHVybiB7U2hhcGVQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHNoYXBlIHBhdGguCiAgICovCiAgbGluZVRvKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmN1cnJlbnRQYXRoLmxpbmVUbyh0LCBlKSwgdGhpczsKICB9CiAgLyoqCiAgICogQWRkcyBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgUXVhZHJhdGljQmV6aWVyQ3VydmV9IHRvIHRoZSBwYXRoIGJ5IGNvbm5lY3RpbmcKICAgKiB0aGUgY3VycmVudCBwb2ludCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYUNQeCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNvbnRyb2wgcG9pbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFDUHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhWCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gYVkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBlbmQgcG9pbnQuCiAgICogQHJldHVybiB7U2hhcGVQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHNoYXBlIHBhdGguCiAgICovCiAgcXVhZHJhdGljQ3VydmVUbyh0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50UGF0aC5xdWFkcmF0aWNDdXJ2ZVRvKHQsIGUsIGksIG4pLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGluc3RhbmNlIG9mIHtAbGluayBDdWJpY0JlemllckN1cnZlfSB0byB0aGUgcGF0aCBieSBjb25uZWN0aW5nCiAgICogdGhlIGN1cnJlbnQgcG9pbnQgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFDUDF4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgZmlyc3QgY29udHJvbCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gYUNQMXkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBmaXJzdCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhQ1AyeCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHNlY29uZCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhQ1AyeSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHNlY29uZCBjb250cm9sIHBvaW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBhWCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGVuZCBwb2ludC4KICAgKiBAcGFyYW0ge251bWJlcn0gYVkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBlbmQgcG9pbnQuCiAgICogQHJldHVybiB7U2hhcGVQYXRofSBBIHJlZmVyZW5jZSB0byB0aGlzIHNoYXBlIHBhdGguCiAgICovCiAgYmV6aWVyQ3VydmVUbyh0LCBlLCBpLCBuLCBzLCByKSB7CiAgICByZXR1cm4gdGhpcy5jdXJyZW50UGF0aC5iZXppZXJDdXJ2ZVRvKHQsIGUsIGksIG4sIHMsIHIpLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIGFuIGluc3RhbmNlIG9mIHtAbGluayBTcGxpbmVDdXJ2ZX0gdG8gdGhlIHBhdGggYnkgY29ubmVjdGluZwogICAqIHRoZSBjdXJyZW50IHBvaW50IHdpdGggdGhlIGdpdmVuIGxpc3Qgb2YgcG9pbnRzLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxWZWN0b3IyPn0gcHRzIC0gQW4gYXJyYXkgb2YgcG9pbnRzIGluIDJEIHNwYWNlLgogICAqIEByZXR1cm4ge1NoYXBlUGF0aH0gQSByZWZlcmVuY2UgdG8gdGhpcyBzaGFwZSBwYXRoLgogICAqLwogIHNwbGluZVRocnUodCkgewogICAgcmV0dXJuIHRoaXMuY3VycmVudFBhdGguc3BsaW5lVGhydSh0KSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIHBhdGhzIGludG8gYW4gYXJyYXkgb2Ygc2hhcGVzLgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBpc0NDVyAtIEJ5IGRlZmF1bHQgc29saWQgc2hhcGVzIGFyZSAgZGVmaW5lZCBjbG9ja3dpc2UgKENXKSBhbmQgaG9sZXMgYXJlIGRlZmluZWQgY291bnRlcmNsb2Nrd2lzZSAoQ0NXKS4KICAgKiBJZiB0aGlzIGZsYWcgaXMgc2V0IHRvIGB0cnVlYCwgdGhlbiB0aG9zZSBhcmUgZmxpcHBlZC4KICAgKiBAcmV0dXJuIHtBcnJheTxTaGFwZT59IEFuIGFycmF5IG9mIHNoYXBlcy4KICAgKi8KICB0b1NoYXBlcyh0KSB7CiAgICBmdW5jdGlvbiBlKG0pIHsKICAgICAgY29uc3QgdiA9IFtdOwogICAgICBmb3IgKGxldCB4ID0gMCwgXyA9IG0ubGVuZ3RoOyB4IDwgXzsgeCsrKSB7CiAgICAgICAgY29uc3QgUyA9IG1beF0sIHcgPSBuZXcgQXMoKTsKICAgICAgICB3LmN1cnZlcyA9IFMuY3VydmVzLCB2LnB1c2godyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHY7CiAgICB9CiAgICBmdW5jdGlvbiBpKG0sIHYpIHsKICAgICAgY29uc3QgeCA9IHYubGVuZ3RoOwogICAgICBsZXQgXyA9ICExOwogICAgICBmb3IgKGxldCBTID0geCAtIDEsIHcgPSAwOyB3IDwgeDsgUyA9IHcrKykgewogICAgICAgIGxldCBUID0gdltTXSwgUiA9IHZbd10sIGIgPSBSLnggLSBULngsIE0gPSBSLnkgLSBULnk7CiAgICAgICAgaWYgKE1hdGguYWJzKE0pID4gTnVtYmVyLkVQU0lMT04pIHsKICAgICAgICAgIGlmIChNIDwgMCAmJiAoVCA9IHZbd10sIGIgPSAtYiwgUiA9IHZbU10sIE0gPSAtTSksIG0ueSA8IFQueSB8fCBtLnkgPiBSLnkpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKG0ueSA9PT0gVC55KSB7CiAgICAgICAgICAgIGlmIChtLnggPT09IFQueCkgcmV0dXJuICEwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgTCA9IE0gKiAobS54IC0gVC54KSAtIGIgKiAobS55IC0gVC55KTsKICAgICAgICAgICAgaWYgKEwgPT09IDApIHJldHVybiAhMDsKICAgICAgICAgICAgaWYgKEwgPCAwKSBjb250aW51ZTsKICAgICAgICAgICAgXyA9ICFfOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobS55ICE9PSBULnkpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKFIueCA8PSBtLnggJiYgbS54IDw9IFQueCB8fCBULnggPD0gbS54ICYmIG0ueCA8PSBSLngpIHJldHVybiAhMDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIF87CiAgICB9CiAgICBjb25zdCBuID0gZG4uaXNDbG9ja1dpc2UsIHMgPSB0aGlzLnN1YlBhdGhzOwogICAgaWYgKHMubGVuZ3RoID09PSAwKSByZXR1cm4gW107CiAgICBsZXQgciwgbywgbDsKICAgIGNvbnN0IGggPSBbXTsKICAgIGlmIChzLmxlbmd0aCA9PT0gMSkKICAgICAgcmV0dXJuIG8gPSBzWzBdLCBsID0gbmV3IEFzKCksIGwuY3VydmVzID0gby5jdXJ2ZXMsIGgucHVzaChsKSwgaDsKICAgIGxldCBjID0gIW4oc1swXS5nZXRQb2ludHMoKSk7CiAgICBjID0gdCA/ICFjIDogYzsKICAgIGNvbnN0IHUgPSBbXSwgZCA9IFtdOwogICAgbGV0IHAgPSBbXSwgZiA9IDAsIHk7CiAgICBkW2ZdID0gdm9pZCAwLCBwW2ZdID0gW107CiAgICBmb3IgKGxldCBtID0gMCwgdiA9IHMubGVuZ3RoOyBtIDwgdjsgbSsrKQogICAgICBvID0gc1ttXSwgeSA9IG8uZ2V0UG9pbnRzKCksIHIgPSBuKHkpLCByID0gdCA/ICFyIDogciwgciA/ICghYyAmJiBkW2ZdICYmIGYrKywgZFtmXSA9IHsgczogbmV3IEFzKCksIHA6IHkgfSwgZFtmXS5zLmN1cnZlcyA9IG8uY3VydmVzLCBjICYmIGYrKywgcFtmXSA9IFtdKSA6IHBbZl0ucHVzaCh7IGg6IG8sIHA6IHlbMF0gfSk7CiAgICBpZiAoIWRbMF0pIHJldHVybiBlKHMpOwogICAgaWYgKGQubGVuZ3RoID4gMSkgewogICAgICBsZXQgbSA9ICExLCB2ID0gMDsKICAgICAgZm9yIChsZXQgeCA9IDAsIF8gPSBkLmxlbmd0aDsgeCA8IF87IHgrKykKICAgICAgICB1W3hdID0gW107CiAgICAgIGZvciAobGV0IHggPSAwLCBfID0gZC5sZW5ndGg7IHggPCBfOyB4KyspIHsKICAgICAgICBjb25zdCBTID0gcFt4XTsKICAgICAgICBmb3IgKGxldCB3ID0gMDsgdyA8IFMubGVuZ3RoOyB3KyspIHsKICAgICAgICAgIGNvbnN0IFQgPSBTW3ddOwogICAgICAgICAgbGV0IFIgPSAhMDsKICAgICAgICAgIGZvciAobGV0IGIgPSAwOyBiIDwgZC5sZW5ndGg7IGIrKykKICAgICAgICAgICAgaShULnAsIGRbYl0ucCkgJiYgKHggIT09IGIgJiYgdisrLCBSID8gKFIgPSAhMSwgdVtiXS5wdXNoKFQpKSA6IG0gPSAhMCk7CiAgICAgICAgICBSICYmIHVbeF0ucHVzaChUKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdiA+IDAgJiYgbSA9PT0gITEgJiYgKHAgPSB1KTsKICAgIH0KICAgIGxldCBnOwogICAgZm9yIChsZXQgbSA9IDAsIHYgPSBkLmxlbmd0aDsgbSA8IHY7IG0rKykgewogICAgICBsID0gZFttXS5zLCBoLnB1c2gobCksIGcgPSBwW21dOwogICAgICBmb3IgKGxldCB4ID0gMCwgXyA9IGcubGVuZ3RoOyB4IDwgXzsgeCsrKQogICAgICAgIGwuaG9sZXMucHVzaChnW3hdLmgpOwogICAgfQogICAgcmV0dXJuIGg7CiAgfQp9CmxldCBOTSA9IGNsYXNzIGV4dGVuZHMgRWkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY29udHJvbHMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgb2JqZWN0IHRoYXQgaXMgbWFuYWdlZCBieSB0aGUgY29udHJvbHMuCiAgICogQHBhcmFtIHs/SFRNTERPTUVsZW1lbnR9IGRvbUVsZW1lbnQgLSBUaGUgSFRNTCBlbGVtZW50IHVzZWQgZm9yIGV2ZW50IGxpc3RlbmVycy4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlID0gbnVsbCkgewogICAgc3VwZXIoKSwgdGhpcy5vYmplY3QgPSB0LCB0aGlzLmRvbUVsZW1lbnQgPSBlLCB0aGlzLmVuYWJsZWQgPSAhMCwgdGhpcy5zdGF0ZSA9IC0xLCB0aGlzLmtleXMgPSB7fSwgdGhpcy5tb3VzZUJ1dHRvbnMgPSB7IExFRlQ6IG51bGwsIE1JRERMRTogbnVsbCwgUklHSFQ6IG51bGwgfSwgdGhpcy50b3VjaGVzID0geyBPTkU6IG51bGwsIFRXTzogbnVsbCB9OwogIH0KICAvKioKICAgKiBDb25uZWN0cyB0aGUgY29udHJvbHMgdG8gdGhlIERPTS4gVGhpcyBtZXRob2QgaGFzIHNvIGNhbGxlZCAic2lkZSBlZmZlY3RzIiBzaW5jZQogICAqIGl0IGFkZHMgdGhlIG1vZHVsZSdzIGV2ZW50IGxpc3RlbmVycyB0byB0aGUgRE9NLgogICAqCiAgICogQHBhcmFtIHtIVE1MRE9NRWxlbWVudH0gZWxlbWVudCAtIFRoZSBET00gZWxlbWVudCB0byBjb25uZWN0IHRvLgogICAqLwogIGNvbm5lY3QodCkgewogICAgaWYgKHQgPT09IHZvaWQgMCkgewogICAgICBjb25zb2xlLndhcm4oIlRIUkVFLkNvbnRyb2xzOiBjb25uZWN0KCkgbm93IHJlcXVpcmVzIGFuIGVsZW1lbnQuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuZG9tRWxlbWVudCAhPT0gbnVsbCAmJiB0aGlzLmRpc2Nvbm5lY3QoKSwgdGhpcy5kb21FbGVtZW50ID0gdDsKICB9CiAgLyoqCiAgICogRGlzY29ubmVjdHMgdGhlIGNvbnRyb2xzIGZyb20gdGhlIERPTS4KICAgKi8KICBkaXNjb25uZWN0KCkgewogIH0KICAvKioKICAgKiBDYWxsIHRoaXMgbWV0aG9kIGlmIHlvdSBubyBsb25nZXIgd2FudCB1c2UgdG8gdGhlIGNvbnRyb2xzLiBJdCBmcmVlcyBhbGwgaW50ZXJuYWwKICAgKiByZXNvdXJjZXMgYW5kIHJlbW92ZXMgYWxsIGV2ZW50IGxpc3RlbmVycy4KICAgKi8KICBkaXNwb3NlKCkgewogIH0KICAvKioKICAgKiBDb250cm9scyBzaG91bGQgaW1wbGVtZW50IHRoaXMgbWV0aG9kIGlmIHRoZXkgaGF2ZSB0byB1cGRhdGUgdGhlaXIgaW50ZXJuYWwgc3RhdGUKICAgKiBwZXIgc2ltdWxhdGlvbiBzdGVwLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFtkZWx0YV0gLSBUaGUgdGltZSBkZWx0YSBpbiBzZWNvbmRzLgogICAqLwogIHVwZGF0ZSgpIHsKICB9Cn07CmZ1bmN0aW9uIE9NKGEsIHQpIHsKICBjb25zdCBlID0gYS5pbWFnZSAmJiBhLmltYWdlLndpZHRoID8gYS5pbWFnZS53aWR0aCAvIGEuaW1hZ2UuaGVpZ2h0IDogMTsKICByZXR1cm4gZSA+IHQgPyAoYS5yZXBlYXQueCA9IDEsIGEucmVwZWF0LnkgPSBlIC8gdCwgYS5vZmZzZXQueCA9IDAsIGEub2Zmc2V0LnkgPSAoMSAtIGEucmVwZWF0LnkpIC8gMikgOiAoYS5yZXBlYXQueCA9IHQgLyBlLCBhLnJlcGVhdC55ID0gMSwgYS5vZmZzZXQueCA9ICgxIC0gYS5yZXBlYXQueCkgLyAyLCBhLm9mZnNldC55ID0gMCksIGE7Cn0KZnVuY3Rpb24ga00oYSwgdCkgewogIGNvbnN0IGUgPSBhLmltYWdlICYmIGEuaW1hZ2Uud2lkdGggPyBhLmltYWdlLndpZHRoIC8gYS5pbWFnZS5oZWlnaHQgOiAxOwogIHJldHVybiBlID4gdCA/IChhLnJlcGVhdC54ID0gdCAvIGUsIGEucmVwZWF0LnkgPSAxLCBhLm9mZnNldC54ID0gKDEgLSBhLnJlcGVhdC54KSAvIDIsIGEub2Zmc2V0LnkgPSAwKSA6IChhLnJlcGVhdC54ID0gMSwgYS5yZXBlYXQueSA9IGUgLyB0LCBhLm9mZnNldC54ID0gMCwgYS5vZmZzZXQueSA9ICgxIC0gYS5yZXBlYXQueSkgLyAyKSwgYTsKfQpmdW5jdGlvbiBWTShhKSB7CiAgcmV0dXJuIGEucmVwZWF0LnggPSAxLCBhLnJlcGVhdC55ID0gMSwgYS5vZmZzZXQueCA9IDAsIGEub2Zmc2V0LnkgPSAwLCBhOwp9CmZ1bmN0aW9uIGxwKGEsIHQsIGUsIGkpIHsKICBjb25zdCBuID0gSE0oaSk7CiAgc3dpdGNoIChlKSB7CiAgICBjYXNlIENwOgogICAgICByZXR1cm4gYSAqIHQ7CiAgICBjYXNlIExjOgogICAgICByZXR1cm4gYSAqIHQgLyBuLmNvbXBvbmVudHMgKiBuLmJ5dGVMZW5ndGg7CiAgICBjYXNlIE5vOgogICAgICByZXR1cm4gYSAqIHQgLyBuLmNvbXBvbmVudHMgKiBuLmJ5dGVMZW5ndGg7CiAgICBjYXNlIFBwOgogICAgICByZXR1cm4gYSAqIHQgKiAyIC8gbi5jb21wb25lbnRzICogbi5ieXRlTGVuZ3RoOwogICAgY2FzZSBEYzoKICAgICAgcmV0dXJuIGEgKiB0ICogMiAvIG4uY29tcG9uZW50cyAqIG4uYnl0ZUxlbmd0aDsKICAgIGNhc2UgUnA6CiAgICAgIHJldHVybiBhICogdCAqIDMgLyBuLmNvbXBvbmVudHMgKiBuLmJ5dGVMZW5ndGg7CiAgICBjYXNlIGdpOgogICAgICByZXR1cm4gYSAqIHQgKiA0IC8gbi5jb21wb25lbnRzICogbi5ieXRlTGVuZ3RoOwogICAgY2FzZSBGYzoKICAgICAgcmV0dXJuIGEgKiB0ICogNCAvIG4uY29tcG9uZW50cyAqIG4uYnl0ZUxlbmd0aDsKICAgIGNhc2UgaG86CiAgICBjYXNlIGNvOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDMpIC8gNCkgKiBNYXRoLmZsb29yKCh0ICsgMykgLyA0KSAqIDg7CiAgICBjYXNlIHVvOgogICAgY2FzZSBwbzoKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKGEgKyAzKSAvIDQpICogTWF0aC5mbG9vcigodCArIDMpIC8gNCkgKiAxNjsKICAgIGNhc2UgVmg6CiAgICBjYXNlIEdoOgogICAgICByZXR1cm4gTWF0aC5tYXgoYSwgMTYpICogTWF0aC5tYXgodCwgOCkgLyA0OwogICAgY2FzZSBraDoKICAgIGNhc2UgSGg6CiAgICAgIHJldHVybiBNYXRoLm1heChhLCA4KSAqIE1hdGgubWF4KHQsIDgpIC8gMjsKICAgIGNhc2UgV2g6CiAgICBjYXNlIHFoOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDMpIC8gNCkgKiBNYXRoLmZsb29yKCh0ICsgMykgLyA0KSAqIDg7CiAgICBjYXNlICRoOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDMpIC8gNCkgKiBNYXRoLmZsb29yKCh0ICsgMykgLyA0KSAqIDE2OwogICAgY2FzZSBYaDoKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKGEgKyAzKSAvIDQpICogTWF0aC5mbG9vcigodCArIDMpIC8gNCkgKiAxNjsKICAgIGNhc2UgWWg6CiAgICAgIHJldHVybiBNYXRoLmZsb29yKChhICsgNCkgLyA1KSAqIE1hdGguZmxvb3IoKHQgKyAzKSAvIDQpICogMTY7CiAgICBjYXNlIFpoOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDQpIC8gNSkgKiBNYXRoLmZsb29yKCh0ICsgNCkgLyA1KSAqIDE2OwogICAgY2FzZSBqaDoKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKGEgKyA1KSAvIDYpICogTWF0aC5mbG9vcigodCArIDQpIC8gNSkgKiAxNjsKICAgIGNhc2UgSmg6CiAgICAgIHJldHVybiBNYXRoLmZsb29yKChhICsgNSkgLyA2KSAqIE1hdGguZmxvb3IoKHQgKyA1KSAvIDYpICogMTY7CiAgICBjYXNlIEtoOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDcpIC8gOCkgKiBNYXRoLmZsb29yKCh0ICsgNCkgLyA1KSAqIDE2OwogICAgY2FzZSBRaDoKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKGEgKyA3KSAvIDgpICogTWF0aC5mbG9vcigodCArIDUpIC8gNikgKiAxNjsKICAgIGNhc2UgdGM6CiAgICAgIHJldHVybiBNYXRoLmZsb29yKChhICsgNykgLyA4KSAqIE1hdGguZmxvb3IoKHQgKyA3KSAvIDgpICogMTY7CiAgICBjYXNlIGVjOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDkpIC8gMTApICogTWF0aC5mbG9vcigodCArIDQpIC8gNSkgKiAxNjsKICAgIGNhc2UgaWM6CiAgICAgIHJldHVybiBNYXRoLmZsb29yKChhICsgOSkgLyAxMCkgKiBNYXRoLmZsb29yKCh0ICsgNSkgLyA2KSAqIDE2OwogICAgY2FzZSBuYzoKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKGEgKyA5KSAvIDEwKSAqIE1hdGguZmxvb3IoKHQgKyA3KSAvIDgpICogMTY7CiAgICBjYXNlIHNjOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDkpIC8gMTApICogTWF0aC5mbG9vcigodCArIDkpIC8gMTApICogMTY7CiAgICBjYXNlIHJjOgogICAgICByZXR1cm4gTWF0aC5mbG9vcigoYSArIDExKSAvIDEyKSAqIE1hdGguZmxvb3IoKHQgKyA5KSAvIDEwKSAqIDE2OwogICAgY2FzZSBhYzoKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKGEgKyAxMSkgLyAxMikgKiBNYXRoLmZsb29yKCh0ICsgMTEpIC8gMTIpICogMTY7CiAgICBjYXNlIG9jOgogICAgY2FzZSBsYzoKICAgIGNhc2UgaGM6CiAgICAgIHJldHVybiBNYXRoLmNlaWwoYSAvIDQpICogTWF0aC5jZWlsKHQgLyA0KSAqIDE2OwogICAgY2FzZSBjYzoKICAgIGNhc2UgdWM6CiAgICAgIHJldHVybiBNYXRoLmNlaWwoYSAvIDQpICogTWF0aC5jZWlsKHQgLyA0KSAqIDg7CiAgICBjYXNlIGRjOgogICAgY2FzZSBwYzoKICAgICAgcmV0dXJuIE1hdGguY2VpbChhIC8gNCkgKiBNYXRoLmNlaWwodCAvIDQpICogMTY7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBVbmFibGUgdG8gZGV0ZXJtaW5lIHRleHR1cmUgYnl0ZSBsZW5ndGggZm9yICR7ZX0gZm9ybWF0LmAKICApOwp9CmZ1bmN0aW9uIEhNKGEpIHsKICBzd2l0Y2ggKGEpIHsKICAgIGNhc2UgcG46CiAgICBjYXNlIHdwOgogICAgICByZXR1cm4geyBieXRlTGVuZ3RoOiAxLCBjb21wb25lbnRzOiAxIH07CiAgICBjYXNlIGRhOgogICAgY2FzZSBBcDoKICAgIGNhc2Ugd2E6CiAgICAgIHJldHVybiB7IGJ5dGVMZW5ndGg6IDIsIGNvbXBvbmVudHM6IDEgfTsKICAgIGNhc2UgUGM6CiAgICBjYXNlIEljOgogICAgICByZXR1cm4geyBieXRlTGVuZ3RoOiAyLCBjb21wb25lbnRzOiA0IH07CiAgICBjYXNlIG5zOgogICAgY2FzZSBSYzoKICAgIGNhc2Ugd2k6CiAgICAgIHJldHVybiB7IGJ5dGVMZW5ndGg6IDQsIGNvbXBvbmVudHM6IDEgfTsKICAgIGNhc2UgRXA6CiAgICBjYXNlIFRwOgogICAgICByZXR1cm4geyBieXRlTGVuZ3RoOiA0LCBjb21wb25lbnRzOiAzIH07CiAgfQogIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0ZXh0dXJlIHR5cGUgJHthfS5gKTsKfQpjbGFzcyBHTSB7CiAgLyoqCiAgICogU2NhbGVzIHRoZSB0ZXh0dXJlIGFzIGxhcmdlIGFzIHBvc3NpYmxlIHdpdGhpbiBpdHMgc3VyZmFjZSB3aXRob3V0IGNyb3BwaW5nCiAgICogb3Igc3RyZXRjaGluZyB0aGUgdGV4dHVyZS4gVGhlIG1ldGhvZCBwcmVzZXJ2ZXMgdGhlIG9yaWdpbmFsIGFzcGVjdCByYXRpbyBvZgogICAqIHRoZSB0ZXh0dXJlLiBBa2luIHRvIENTUyBgb2JqZWN0LWZpdDogY29udGFpbmAKICAgKgogICAqIEBwYXJhbSB7VGV4dHVyZX0gdGV4dHVyZSAtIFRoZSB0ZXh0dXJlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhc3BlY3QgLSBUaGUgdGV4dHVyZSdzIGFzcGVjdCByYXRpby4KICAgKiBAcmV0dXJuIHtUZXh0dXJlfSBUaGUgdXBkYXRlZCB0ZXh0dXJlLgogICAqLwogIHN0YXRpYyBjb250YWluKHQsIGUpIHsKICAgIHJldHVybiBPTSh0LCBlKTsKICB9CiAgLyoqCiAgICogU2NhbGVzIHRoZSB0ZXh0dXJlIHRvIHRoZSBzbWFsbGVzdCBwb3NzaWJsZSBzaXplIHRvIGZpbGwgdGhlIHN1cmZhY2UsIGxlYXZpbmcKICAgKiBubyBlbXB0eSBzcGFjZS4gVGhlIG1ldGhvZCBwcmVzZXJ2ZXMgdGhlIG9yaWdpbmFsIGFzcGVjdCByYXRpbyBvZiB0aGUgdGV4dHVyZS4KICAgKiBBa2luIHRvIENTUyBgb2JqZWN0LWZpdDogY292ZXJgLgogICAqCiAgICogQHBhcmFtIHtUZXh0dXJlfSB0ZXh0dXJlIC0gVGhlIHRleHR1cmUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFzcGVjdCAtIFRoZSB0ZXh0dXJlJ3MgYXNwZWN0IHJhdGlvLgogICAqIEByZXR1cm4ge1RleHR1cmV9IFRoZSB1cGRhdGVkIHRleHR1cmUuCiAgICovCiAgc3RhdGljIGNvdmVyKHQsIGUpIHsKICAgIHJldHVybiBrTSh0LCBlKTsKICB9CiAgLyoqCiAgICogQ29uZmlndXJlcyB0aGUgdGV4dHVyZSB0byB0aGUgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbi4gQWtpbiB0byBDU1MgYG9iamVjdC1maXQ6IGZpbGxgLgogICAqCiAgICogQHBhcmFtIHtUZXh0dXJlfSB0ZXh0dXJlIC0gVGhlIHRleHR1cmUuCiAgICogQHJldHVybiB7VGV4dHVyZX0gVGhlIHVwZGF0ZWQgdGV4dHVyZS4KICAgKi8KICBzdGF0aWMgZmlsbCh0KSB7CiAgICByZXR1cm4gVk0odCk7CiAgfQogIC8qKgogICAqIERldGVybWluZXMgaG93IG1hbnkgYnl0ZXMgbXVzdCBiZSB1c2VkIHRvIHJlcHJlc2VudCB0aGUgdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdGV4dHVyZS4KICAgKiBAcGFyYW0ge251bWJlcn0gZm9ybWF0IC0gVGhlIHRleHR1cmUncyBmb3JtYXQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHR5cGUgLSBUaGUgdGV4dHVyZSdzIHR5cGUuCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYnl0ZSBsZW5ndGguCiAgICovCiAgc3RhdGljIGdldEJ5dGVMZW5ndGgodCwgZSwgaSwgbikgewogICAgcmV0dXJuIGxwKHQsIGUsIGksIG4pOwogIH0KfQp0eXBlb2YgX19USFJFRV9ERVZUT09MU19fIDwgInUiICYmIF9fVEhSRUVfREVWVE9PTFNfXy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgicmVnaXN0ZXIiLCB7IGRldGFpbDogewogIHJldmlzaW9uOiBUYwp9IH0pKTsKdHlwZW9mIHdpbmRvdyA8ICJ1IiAmJiAod2luZG93Ll9fVEhSRUVfXyA/IGNvbnNvbGUud2FybigiV0FSTklORzogTXVsdGlwbGUgaW5zdGFuY2VzIG9mIFRocmVlLmpzIGJlaW5nIGltcG9ydGVkLiIpIDogd2luZG93Ll9fVEhSRUVfXyA9IFRjKTsKLyoqCiAqIEBsaWNlbnNlCiAqIENvcHlyaWdodCAyMDEwLTIwMjUgVGhyZWUuanMgQXV0aG9ycwogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUCiAqLwpmdW5jdGlvbiBNXygpIHsKICBsZXQgYSA9IG51bGwsIHQgPSAhMSwgZSA9IG51bGwsIGkgPSBudWxsOwogIGZ1bmN0aW9uIG4ocywgcikgewogICAgZShzLCByKSwgaSA9IGEucmVxdWVzdEFuaW1hdGlvbkZyYW1lKG4pOwogIH0KICByZXR1cm4gewogICAgc3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgICB0ICE9PSAhMCAmJiBlICE9PSBudWxsICYmIChpID0gYS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUobiksIHQgPSAhMCk7CiAgICB9LAogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIGEuY2FuY2VsQW5pbWF0aW9uRnJhbWUoaSksIHQgPSAhMTsKICAgIH0sCiAgICBzZXRBbmltYXRpb25Mb29wOiBmdW5jdGlvbihzKSB7CiAgICAgIGUgPSBzOwogICAgfSwKICAgIHNldENvbnRleHQ6IGZ1bmN0aW9uKHMpIHsKICAgICAgYSA9IHM7CiAgICB9CiAgfTsKfQpmdW5jdGlvbiBXTShhKSB7CiAgY29uc3QgdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIGZ1bmN0aW9uIGUobywgbCkgewogICAgY29uc3QgaCA9IG8uYXJyYXksIGMgPSBvLnVzYWdlLCB1ID0gaC5ieXRlTGVuZ3RoLCBkID0gYS5jcmVhdGVCdWZmZXIoKTsKICAgIGEuYmluZEJ1ZmZlcihsLCBkKSwgYS5idWZmZXJEYXRhKGwsIGgsIGMpLCBvLm9uVXBsb2FkQ2FsbGJhY2soKTsKICAgIGxldCBwOwogICAgaWYgKGggaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpCiAgICAgIHAgPSBhLkZMT0FUOwogICAgZWxzZSBpZiAodHlwZW9mIEZsb2F0MTZBcnJheSA8ICJ1IiAmJiBoIGluc3RhbmNlb2YgRmxvYXQxNkFycmF5KQogICAgICBwID0gYS5IQUxGX0ZMT0FUOwogICAgZWxzZSBpZiAoaCBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KQogICAgICBvLmlzRmxvYXQxNkJ1ZmZlckF0dHJpYnV0ZSA/IHAgPSBhLkhBTEZfRkxPQVQgOiBwID0gYS5VTlNJR05FRF9TSE9SVDsKICAgIGVsc2UgaWYgKGggaW5zdGFuY2VvZiBJbnQxNkFycmF5KQogICAgICBwID0gYS5TSE9SVDsKICAgIGVsc2UgaWYgKGggaW5zdGFuY2VvZiBVaW50MzJBcnJheSkKICAgICAgcCA9IGEuVU5TSUdORURfSU5UOwogICAgZWxzZSBpZiAoaCBpbnN0YW5jZW9mIEludDMyQXJyYXkpCiAgICAgIHAgPSBhLklOVDsKICAgIGVsc2UgaWYgKGggaW5zdGFuY2VvZiBJbnQ4QXJyYXkpCiAgICAgIHAgPSBhLkJZVEU7CiAgICBlbHNlIGlmIChoIGluc3RhbmNlb2YgVWludDhBcnJheSkKICAgICAgcCA9IGEuVU5TSUdORURfQllURTsKICAgIGVsc2UgaWYgKGggaW5zdGFuY2VvZiBVaW50OENsYW1wZWRBcnJheSkKICAgICAgcCA9IGEuVU5TSUdORURfQllURTsKICAgIGVsc2UKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5XZWJHTEF0dHJpYnV0ZXM6IFVuc3VwcG9ydGVkIGJ1ZmZlciBkYXRhIGZvcm1hdDogIiArIGgpOwogICAgcmV0dXJuIHsKICAgICAgYnVmZmVyOiBkLAogICAgICB0eXBlOiBwLAogICAgICBieXRlc1BlckVsZW1lbnQ6IGguQllURVNfUEVSX0VMRU1FTlQsCiAgICAgIHZlcnNpb246IG8udmVyc2lvbiwKICAgICAgc2l6ZTogdQogICAgfTsKICB9CiAgZnVuY3Rpb24gaShvLCBsLCBoKSB7CiAgICBjb25zdCBjID0gbC5hcnJheSwgdSA9IGwudXBkYXRlUmFuZ2VzOwogICAgaWYgKGEuYmluZEJ1ZmZlcihoLCBvKSwgdS5sZW5ndGggPT09IDApCiAgICAgIGEuYnVmZmVyU3ViRGF0YShoLCAwLCBjKTsKICAgIGVsc2UgewogICAgICB1LnNvcnQoKHAsIGYpID0+IHAuc3RhcnQgLSBmLnN0YXJ0KTsKICAgICAgbGV0IGQgPSAwOwogICAgICBmb3IgKGxldCBwID0gMTsgcCA8IHUubGVuZ3RoOyBwKyspIHsKICAgICAgICBjb25zdCBmID0gdVtkXSwgeSA9IHVbcF07CiAgICAgICAgeS5zdGFydCA8PSBmLnN0YXJ0ICsgZi5jb3VudCArIDEgPyBmLmNvdW50ID0gTWF0aC5tYXgoCiAgICAgICAgICBmLmNvdW50LAogICAgICAgICAgeS5zdGFydCArIHkuY291bnQgLSBmLnN0YXJ0CiAgICAgICAgKSA6ICgrK2QsIHVbZF0gPSB5KTsKICAgICAgfQogICAgICB1Lmxlbmd0aCA9IGQgKyAxOwogICAgICBmb3IgKGxldCBwID0gMCwgZiA9IHUubGVuZ3RoOyBwIDwgZjsgcCsrKSB7CiAgICAgICAgY29uc3QgeSA9IHVbcF07CiAgICAgICAgYS5idWZmZXJTdWJEYXRhKAogICAgICAgICAgaCwKICAgICAgICAgIHkuc3RhcnQgKiBjLkJZVEVTX1BFUl9FTEVNRU5ULAogICAgICAgICAgYywKICAgICAgICAgIHkuc3RhcnQsCiAgICAgICAgICB5LmNvdW50CiAgICAgICAgKTsKICAgICAgfQogICAgICBsLmNsZWFyVXBkYXRlUmFuZ2VzKCk7CiAgICB9CiAgICBsLm9uVXBsb2FkQ2FsbGJhY2soKTsKICB9CiAgZnVuY3Rpb24gbihvKSB7CiAgICByZXR1cm4gby5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlICYmIChvID0gby5kYXRhKSwgdC5nZXQobyk7CiAgfQogIGZ1bmN0aW9uIHMobykgewogICAgby5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlICYmIChvID0gby5kYXRhKTsKICAgIGNvbnN0IGwgPSB0LmdldChvKTsKICAgIGwgJiYgKGEuZGVsZXRlQnVmZmVyKGwuYnVmZmVyKSwgdC5kZWxldGUobykpOwogIH0KICBmdW5jdGlvbiByKG8sIGwpIHsKICAgIGlmIChvLmlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUgJiYgKG8gPSBvLmRhdGEpLCBvLmlzR0xCdWZmZXJBdHRyaWJ1dGUpIHsKICAgICAgY29uc3QgYyA9IHQuZ2V0KG8pOwogICAgICAoIWMgfHwgYy52ZXJzaW9uIDwgby52ZXJzaW9uKSAmJiB0LnNldChvLCB7CiAgICAgICAgYnVmZmVyOiBvLmJ1ZmZlciwKICAgICAgICB0eXBlOiBvLnR5cGUsCiAgICAgICAgYnl0ZXNQZXJFbGVtZW50OiBvLmVsZW1lbnRTaXplLAogICAgICAgIHZlcnNpb246IG8udmVyc2lvbgogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaCA9IHQuZ2V0KG8pOwogICAgaWYgKGggPT09IHZvaWQgMCkKICAgICAgdC5zZXQobywgZShvLCBsKSk7CiAgICBlbHNlIGlmIChoLnZlcnNpb24gPCBvLnZlcnNpb24pIHsKICAgICAgaWYgKGguc2l6ZSAhPT0gby5hcnJheS5ieXRlTGVuZ3RoKQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuV2ViR0xBdHRyaWJ1dGVzOiBUaGUgc2l6ZSBvZiB0aGUgYnVmZmVyIGF0dHJpYnV0ZSdzIGFycmF5IGJ1ZmZlciBkb2VzIG5vdCBtYXRjaCB0aGUgb3JpZ2luYWwgc2l6ZS4gUmVzaXppbmcgYnVmZmVyIGF0dHJpYnV0ZXMgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgaShoLmJ1ZmZlciwgbywgbCksIGgudmVyc2lvbiA9IG8udmVyc2lvbjsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIGdldDogbiwKICAgIHJlbW92ZTogcywKICAgIHVwZGF0ZTogcgogIH07Cn0KdmFyIHFNID0gYCNpZmRlZiBVU0VfQUxQSEFIQVNICglpZiAoIGRpZmZ1c2VDb2xvci5hIDwgZ2V0QWxwaGFIYXNoVGhyZXNob2xkKCB2UG9zaXRpb24gKSApIGRpc2NhcmQ7CiNlbmRpZmAsICRNID0gYCNpZmRlZiBVU0VfQUxQSEFIQVNICgljb25zdCBmbG9hdCBBTFBIQV9IQVNIX1NDQUxFID0gMC4wNTsKCWZsb2F0IGhhc2gyRCggdmVjMiB2YWx1ZSApIHsKCQlyZXR1cm4gZnJhY3QoIDEuMGU0ICogc2luKCAxNy4wICogdmFsdWUueCArIDAuMSAqIHZhbHVlLnkgKSAqICggMC4xICsgYWJzKCBzaW4oIDEzLjAgKiB2YWx1ZS55ICsgdmFsdWUueCApICkgKSApOwoJfQoJZmxvYXQgaGFzaDNEKCB2ZWMzIHZhbHVlICkgewoJCXJldHVybiBoYXNoMkQoIHZlYzIoIGhhc2gyRCggdmFsdWUueHkgKSwgdmFsdWUueiApICk7Cgl9CglmbG9hdCBnZXRBbHBoYUhhc2hUaHJlc2hvbGQoIHZlYzMgcG9zaXRpb24gKSB7CgkJZmxvYXQgbWF4RGVyaXYgPSBtYXgoCgkJCWxlbmd0aCggZEZkeCggcG9zaXRpb24ueHl6ICkgKSwKCQkJbGVuZ3RoKCBkRmR5KCBwb3NpdGlvbi54eXogKSApCgkJKTsKCQlmbG9hdCBwaXhTY2FsZSA9IDEuMCAvICggQUxQSEFfSEFTSF9TQ0FMRSAqIG1heERlcml2ICk7CgkJdmVjMiBwaXhTY2FsZXMgPSB2ZWMyKAoJCQlleHAyKCBmbG9vciggbG9nMiggcGl4U2NhbGUgKSApICksCgkJCWV4cDIoIGNlaWwoIGxvZzIoIHBpeFNjYWxlICkgKSApCgkJKTsKCQl2ZWMyIGFscGhhID0gdmVjMigKCQkJaGFzaDNEKCBmbG9vciggcGl4U2NhbGVzLnggKiBwb3NpdGlvbi54eXogKSApLAoJCQloYXNoM0QoIGZsb29yKCBwaXhTY2FsZXMueSAqIHBvc2l0aW9uLnh5eiApICkKCQkpOwoJCWZsb2F0IGxlcnBGYWN0b3IgPSBmcmFjdCggbG9nMiggcGl4U2NhbGUgKSApOwoJCWZsb2F0IHggPSAoIDEuMCAtIGxlcnBGYWN0b3IgKSAqIGFscGhhLnggKyBsZXJwRmFjdG9yICogYWxwaGEueTsKCQlmbG9hdCBhID0gbWluKCBsZXJwRmFjdG9yLCAxLjAgLSBsZXJwRmFjdG9yICk7CgkJdmVjMyBjYXNlcyA9IHZlYzMoCgkJCXggKiB4IC8gKCAyLjAgKiBhICogKCAxLjAgLSBhICkgKSwKCQkJKCB4IC0gMC41ICogYSApIC8gKCAxLjAgLSBhICksCgkJCTEuMCAtICggKCAxLjAgLSB4ICkgKiAoIDEuMCAtIHggKSAvICggMi4wICogYSAqICggMS4wIC0gYSApICkgKQoJCSk7CgkJZmxvYXQgdGhyZXNob2xkID0gKCB4IDwgKCAxLjAgLSBhICkgKQoJCQk/ICggKCB4IDwgYSApID8gY2FzZXMueCA6IGNhc2VzLnkgKQoJCQk6IGNhc2VzLno7CgkJcmV0dXJuIGNsYW1wKCB0aHJlc2hvbGQgLCAxLjBlLTYsIDEuMCApOwoJfQojZW5kaWZgLCBYTSA9IGAjaWZkZWYgVVNFX0FMUEhBTUFQCglkaWZmdXNlQ29sb3IuYSAqPSB0ZXh0dXJlMkQoIGFscGhhTWFwLCB2QWxwaGFNYXBVdiApLmc7CiNlbmRpZmAsIFlNID0gYCNpZmRlZiBVU0VfQUxQSEFNQVAKCXVuaWZvcm0gc2FtcGxlcjJEIGFscGhhTWFwOwojZW5kaWZgLCBaTSA9IGAjaWZkZWYgVVNFX0FMUEhBVEVTVAoJI2lmZGVmIEFMUEhBX1RPX0NPVkVSQUdFCglkaWZmdXNlQ29sb3IuYSA9IHNtb290aHN0ZXAoIGFscGhhVGVzdCwgYWxwaGFUZXN0ICsgZndpZHRoKCBkaWZmdXNlQ29sb3IuYSApLCBkaWZmdXNlQ29sb3IuYSApOwoJaWYgKCBkaWZmdXNlQ29sb3IuYSA9PSAwLjAgKSBkaXNjYXJkOwoJI2Vsc2UKCWlmICggZGlmZnVzZUNvbG9yLmEgPCBhbHBoYVRlc3QgKSBkaXNjYXJkOwoJI2VuZGlmCiNlbmRpZmAsIGpNID0gYCNpZmRlZiBVU0VfQUxQSEFURVNUCgl1bmlmb3JtIGZsb2F0IGFscGhhVGVzdDsKI2VuZGlmYCwgSk0gPSBgI2lmZGVmIFVTRV9BT01BUAoJZmxvYXQgYW1iaWVudE9jY2x1c2lvbiA9ICggdGV4dHVyZTJEKCBhb01hcCwgdkFvTWFwVXYgKS5yIC0gMS4wICkgKiBhb01hcEludGVuc2l0eSArIDEuMDsKCXJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSAqPSBhbWJpZW50T2NjbHVzaW9uOwoJI2lmIGRlZmluZWQoIFVTRV9DTEVBUkNPQVQgKSAKCQljbGVhcmNvYXRTcGVjdWxhckluZGlyZWN0ICo9IGFtYmllbnRPY2NsdXNpb247CgkjZW5kaWYKCSNpZiBkZWZpbmVkKCBVU0VfU0hFRU4gKSAKCQlzaGVlblNwZWN1bGFySW5kaXJlY3QgKj0gYW1iaWVudE9jY2x1c2lvbjsKCSNlbmRpZgoJI2lmIGRlZmluZWQoIFVTRV9FTlZNQVAgKSAmJiBkZWZpbmVkKCBTVEFOREFSRCApCgkJZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyICkgKTsKCQlyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdFNwZWN1bGFyICo9IGNvbXB1dGVTcGVjdWxhck9jY2x1c2lvbiggZG90TlYsIGFtYmllbnRPY2NsdXNpb24sIG1hdGVyaWFsLnJvdWdobmVzcyApOwoJI2VuZGlmCiNlbmRpZmAsIEtNID0gYCNpZmRlZiBVU0VfQU9NQVAKCXVuaWZvcm0gc2FtcGxlcjJEIGFvTWFwOwoJdW5pZm9ybSBmbG9hdCBhb01hcEludGVuc2l0eTsKI2VuZGlmYCwgUU0gPSBgI2lmZGVmIFVTRV9CQVRDSElORwoJI2lmICEgZGVmaW5lZCggR0xfQU5HTEVfbXVsdGlfZHJhdyApCgkjZGVmaW5lIGdsX0RyYXdJRCBfZ2xfRHJhd0lECgl1bmlmb3JtIGludCBfZ2xfRHJhd0lEOwoJI2VuZGlmCgl1bmlmb3JtIGhpZ2hwIHNhbXBsZXIyRCBiYXRjaGluZ1RleHR1cmU7Cgl1bmlmb3JtIGhpZ2hwIHVzYW1wbGVyMkQgYmF0Y2hpbmdJZFRleHR1cmU7CgltYXQ0IGdldEJhdGNoaW5nTWF0cml4KCBjb25zdCBpbiBmbG9hdCBpICkgewoJCWludCBzaXplID0gdGV4dHVyZVNpemUoIGJhdGNoaW5nVGV4dHVyZSwgMCApLng7CgkJaW50IGogPSBpbnQoIGkgKSAqIDQ7CgkJaW50IHggPSBqICUgc2l6ZTsKCQlpbnQgeSA9IGogLyBzaXplOwoJCXZlYzQgdjEgPSB0ZXhlbEZldGNoKCBiYXRjaGluZ1RleHR1cmUsIGl2ZWMyKCB4LCB5ICksIDAgKTsKCQl2ZWM0IHYyID0gdGV4ZWxGZXRjaCggYmF0Y2hpbmdUZXh0dXJlLCBpdmVjMiggeCArIDEsIHkgKSwgMCApOwoJCXZlYzQgdjMgPSB0ZXhlbEZldGNoKCBiYXRjaGluZ1RleHR1cmUsIGl2ZWMyKCB4ICsgMiwgeSApLCAwICk7CgkJdmVjNCB2NCA9IHRleGVsRmV0Y2goIGJhdGNoaW5nVGV4dHVyZSwgaXZlYzIoIHggKyAzLCB5ICksIDAgKTsKCQlyZXR1cm4gbWF0NCggdjEsIHYyLCB2MywgdjQgKTsKCX0KCWZsb2F0IGdldEluZGlyZWN0SW5kZXgoIGNvbnN0IGluIGludCBpICkgewoJCWludCBzaXplID0gdGV4dHVyZVNpemUoIGJhdGNoaW5nSWRUZXh0dXJlLCAwICkueDsKCQlpbnQgeCA9IGkgJSBzaXplOwoJCWludCB5ID0gaSAvIHNpemU7CgkJcmV0dXJuIGZsb2F0KCB0ZXhlbEZldGNoKCBiYXRjaGluZ0lkVGV4dHVyZSwgaXZlYzIoIHgsIHkgKSwgMCApLnIgKTsKCX0KI2VuZGlmCiNpZmRlZiBVU0VfQkFUQ0hJTkdfQ09MT1IKCXVuaWZvcm0gc2FtcGxlcjJEIGJhdGNoaW5nQ29sb3JUZXh0dXJlOwoJdmVjMyBnZXRCYXRjaGluZ0NvbG9yKCBjb25zdCBpbiBmbG9hdCBpICkgewoJCWludCBzaXplID0gdGV4dHVyZVNpemUoIGJhdGNoaW5nQ29sb3JUZXh0dXJlLCAwICkueDsKCQlpbnQgaiA9IGludCggaSApOwoJCWludCB4ID0gaiAlIHNpemU7CgkJaW50IHkgPSBqIC8gc2l6ZTsKCQlyZXR1cm4gdGV4ZWxGZXRjaCggYmF0Y2hpbmdDb2xvclRleHR1cmUsIGl2ZWMyKCB4LCB5ICksIDAgKS5yZ2I7Cgl9CiNlbmRpZmAsIHRTID0gYCNpZmRlZiBVU0VfQkFUQ0hJTkcKCW1hdDQgYmF0Y2hpbmdNYXRyaXggPSBnZXRCYXRjaGluZ01hdHJpeCggZ2V0SW5kaXJlY3RJbmRleCggZ2xfRHJhd0lEICkgKTsKI2VuZGlmYCwgZVMgPSBgdmVjMyB0cmFuc2Zvcm1lZCA9IHZlYzMoIHBvc2l0aW9uICk7CiNpZmRlZiBVU0VfQUxQSEFIQVNICgl2UG9zaXRpb24gPSB2ZWMzKCBwb3NpdGlvbiApOwojZW5kaWZgLCBpUyA9IGB2ZWMzIG9iamVjdE5vcm1hbCA9IHZlYzMoIG5vcm1hbCApOwojaWZkZWYgVVNFX1RBTkdFTlQKCXZlYzMgb2JqZWN0VGFuZ2VudCA9IHZlYzMoIHRhbmdlbnQueHl6ICk7CiNlbmRpZmAsIG5TID0gYGZsb2F0IEdfQmxpbm5QaG9uZ19JbXBsaWNpdCggKSB7CglyZXR1cm4gMC4yNTsKfQpmbG9hdCBEX0JsaW5uUGhvbmcoIGNvbnN0IGluIGZsb2F0IHNoaW5pbmVzcywgY29uc3QgaW4gZmxvYXQgZG90TkggKSB7CglyZXR1cm4gUkVDSVBST0NBTF9QSSAqICggc2hpbmluZXNzICogMC41ICsgMS4wICkgKiBwb3coIGRvdE5ILCBzaGluaW5lc3MgKTsKfQp2ZWMzIEJSREZfQmxpbm5QaG9uZyggY29uc3QgaW4gdmVjMyBsaWdodERpciwgY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgY29uc3QgaW4gdmVjMyBzcGVjdWxhckNvbG9yLCBjb25zdCBpbiBmbG9hdCBzaGluaW5lc3MgKSB7Cgl2ZWMzIGhhbGZEaXIgPSBub3JtYWxpemUoIGxpZ2h0RGlyICsgdmlld0RpciApOwoJZmxvYXQgZG90TkggPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGhhbGZEaXIgKSApOwoJZmxvYXQgZG90VkggPSBzYXR1cmF0ZSggZG90KCB2aWV3RGlyLCBoYWxmRGlyICkgKTsKCXZlYzMgRiA9IEZfU2NobGljayggc3BlY3VsYXJDb2xvciwgMS4wLCBkb3RWSCApOwoJZmxvYXQgRyA9IEdfQmxpbm5QaG9uZ19JbXBsaWNpdCggKTsKCWZsb2F0IEQgPSBEX0JsaW5uUGhvbmcoIHNoaW5pbmVzcywgZG90TkggKTsKCXJldHVybiBGICogKCBHICogRCApOwp9IC8vIHZhbGlkYXRlZGAsIHNTID0gYCNpZmRlZiBVU0VfSVJJREVTQ0VOQ0UKCWNvbnN0IG1hdDMgWFlaX1RPX1JFQzcwOSA9IG1hdDMoCgkJIDMuMjQwNDU0MiwgLTAuOTY5MjY2MCwgIDAuMDU1NjQzNCwKCQktMS41MzcxMzg1LCAgMS44NzYwMTA4LCAtMC4yMDQwMjU5LAoJCS0wLjQ5ODUzMTQsICAwLjA0MTU1NjAsICAxLjA1NzIyNTIKCSk7Cgl2ZWMzIEZyZXNuZWwwVG9Jb3IoIHZlYzMgZnJlc25lbDAgKSB7CgkJdmVjMyBzcXJ0RjAgPSBzcXJ0KCBmcmVzbmVsMCApOwoJCXJldHVybiAoIHZlYzMoIDEuMCApICsgc3FydEYwICkgLyAoIHZlYzMoIDEuMCApIC0gc3FydEYwICk7Cgl9Cgl2ZWMzIElvclRvRnJlc25lbDAoIHZlYzMgdHJhbnNtaXR0ZWRJb3IsIGZsb2F0IGluY2lkZW50SW9yICkgewoJCXJldHVybiBwb3cyKCAoIHRyYW5zbWl0dGVkSW9yIC0gdmVjMyggaW5jaWRlbnRJb3IgKSApIC8gKCB0cmFuc21pdHRlZElvciArIHZlYzMoIGluY2lkZW50SW9yICkgKSApOwoJfQoJZmxvYXQgSW9yVG9GcmVzbmVsMCggZmxvYXQgdHJhbnNtaXR0ZWRJb3IsIGZsb2F0IGluY2lkZW50SW9yICkgewoJCXJldHVybiBwb3cyKCAoIHRyYW5zbWl0dGVkSW9yIC0gaW5jaWRlbnRJb3IgKSAvICggdHJhbnNtaXR0ZWRJb3IgKyBpbmNpZGVudElvciApKTsKCX0KCXZlYzMgZXZhbFNlbnNpdGl2aXR5KCBmbG9hdCBPUEQsIHZlYzMgc2hpZnQgKSB7CgkJZmxvYXQgcGhhc2UgPSAyLjAgKiBQSSAqIE9QRCAqIDEuMGUtOTsKCQl2ZWMzIHZhbCA9IHZlYzMoIDUuNDg1NmUtMTMsIDQuNDIwMWUtMTMsIDUuMjQ4MWUtMTMgKTsKCQl2ZWMzIHBvcyA9IHZlYzMoIDEuNjgxMGUrMDYsIDEuNzk1M2UrMDYsIDIuMjA4NGUrMDYgKTsKCQl2ZWMzIHZhciA9IHZlYzMoIDQuMzI3OGUrMDksIDkuMzA0NmUrMDksIDYuNjEyMWUrMDkgKTsKCQl2ZWMzIHh5eiA9IHZhbCAqIHNxcnQoIDIuMCAqIFBJICogdmFyICkgKiBjb3MoIHBvcyAqIHBoYXNlICsgc2hpZnQgKSAqIGV4cCggLSBwb3cyKCBwaGFzZSApICogdmFyICk7CgkJeHl6LnggKz0gOS43NDcwZS0xNCAqIHNxcnQoIDIuMCAqIFBJICogNC41MjgyZSswOSApICogY29zKCAyLjIzOTllKzA2ICogcGhhc2UgKyBzaGlmdFsgMCBdICkgKiBleHAoIC0gNC41MjgyZSswOSAqIHBvdzIoIHBoYXNlICkgKTsKCQl4eXogLz0gMS4wNjg1ZS03OwoJCXZlYzMgcmdiID0gWFlaX1RPX1JFQzcwOSAqIHh5ejsKCQlyZXR1cm4gcmdiOwoJfQoJdmVjMyBldmFsSXJpZGVzY2VuY2UoIGZsb2F0IG91dHNpZGVJT1IsIGZsb2F0IGV0YTIsIGZsb2F0IGNvc1RoZXRhMSwgZmxvYXQgdGhpbkZpbG1UaGlja25lc3MsIHZlYzMgYmFzZUYwICkgewoJCXZlYzMgSTsKCQlmbG9hdCBpcmlkZXNjZW5jZUlPUiA9IG1peCggb3V0c2lkZUlPUiwgZXRhMiwgc21vb3Roc3RlcCggMC4wLCAwLjAzLCB0aGluRmlsbVRoaWNrbmVzcyApICk7CgkJZmxvYXQgc2luVGhldGEyU3EgPSBwb3cyKCBvdXRzaWRlSU9SIC8gaXJpZGVzY2VuY2VJT1IgKSAqICggMS4wIC0gcG93MiggY29zVGhldGExICkgKTsKCQlmbG9hdCBjb3NUaGV0YTJTcSA9IDEuMCAtIHNpblRoZXRhMlNxOwoJCWlmICggY29zVGhldGEyU3EgPCAwLjAgKSB7CgkJCXJldHVybiB2ZWMzKCAxLjAgKTsKCQl9CgkJZmxvYXQgY29zVGhldGEyID0gc3FydCggY29zVGhldGEyU3EgKTsKCQlmbG9hdCBSMCA9IElvclRvRnJlc25lbDAoIGlyaWRlc2NlbmNlSU9SLCBvdXRzaWRlSU9SICk7CgkJZmxvYXQgUjEyID0gRl9TY2hsaWNrKCBSMCwgMS4wLCBjb3NUaGV0YTEgKTsKCQlmbG9hdCBUMTIxID0gMS4wIC0gUjEyOwoJCWZsb2F0IHBoaTEyID0gMC4wOwoJCWlmICggaXJpZGVzY2VuY2VJT1IgPCBvdXRzaWRlSU9SICkgcGhpMTIgPSBQSTsKCQlmbG9hdCBwaGkyMSA9IFBJIC0gcGhpMTI7CgkJdmVjMyBiYXNlSU9SID0gRnJlc25lbDBUb0lvciggY2xhbXAoIGJhc2VGMCwgMC4wLCAwLjk5OTkgKSApOwkJdmVjMyBSMSA9IElvclRvRnJlc25lbDAoIGJhc2VJT1IsIGlyaWRlc2NlbmNlSU9SICk7CgkJdmVjMyBSMjMgPSBGX1NjaGxpY2soIFIxLCAxLjAsIGNvc1RoZXRhMiApOwoJCXZlYzMgcGhpMjMgPSB2ZWMzKCAwLjAgKTsKCQlpZiAoIGJhc2VJT1JbIDAgXSA8IGlyaWRlc2NlbmNlSU9SICkgcGhpMjNbIDAgXSA9IFBJOwoJCWlmICggYmFzZUlPUlsgMSBdIDwgaXJpZGVzY2VuY2VJT1IgKSBwaGkyM1sgMSBdID0gUEk7CgkJaWYgKCBiYXNlSU9SWyAyIF0gPCBpcmlkZXNjZW5jZUlPUiApIHBoaTIzWyAyIF0gPSBQSTsKCQlmbG9hdCBPUEQgPSAyLjAgKiBpcmlkZXNjZW5jZUlPUiAqIHRoaW5GaWxtVGhpY2tuZXNzICogY29zVGhldGEyOwoJCXZlYzMgcGhpID0gdmVjMyggcGhpMjEgKSArIHBoaTIzOwoJCXZlYzMgUjEyMyA9IGNsYW1wKCBSMTIgKiBSMjMsIDFlLTUsIDAuOTk5OSApOwoJCXZlYzMgcjEyMyA9IHNxcnQoIFIxMjMgKTsKCQl2ZWMzIFJzID0gcG93MiggVDEyMSApICogUjIzIC8gKCB2ZWMzKCAxLjAgKSAtIFIxMjMgKTsKCQl2ZWMzIEMwID0gUjEyICsgUnM7CgkJSSA9IEMwOwoJCXZlYzMgQ20gPSBScyAtIFQxMjE7CgkJZm9yICggaW50IG0gPSAxOyBtIDw9IDI7ICsrIG0gKSB7CgkJCUNtICo9IHIxMjM7CgkJCXZlYzMgU20gPSAyLjAgKiBldmFsU2Vuc2l0aXZpdHkoIGZsb2F0KCBtICkgKiBPUEQsIGZsb2F0KCBtICkgKiBwaGkgKTsKCQkJSSArPSBDbSAqIFNtOwoJCX0KCQlyZXR1cm4gbWF4KCBJLCB2ZWMzKCAwLjAgKSApOwoJfQojZW5kaWZgLCByUyA9IGAjaWZkZWYgVVNFX0JVTVBNQVAKCXVuaWZvcm0gc2FtcGxlcjJEIGJ1bXBNYXA7Cgl1bmlmb3JtIGZsb2F0IGJ1bXBTY2FsZTsKCXZlYzIgZEhkeHlfZndkKCkgewoJCXZlYzIgZFNUZHggPSBkRmR4KCB2QnVtcE1hcFV2ICk7CgkJdmVjMiBkU1RkeSA9IGRGZHkoIHZCdW1wTWFwVXYgKTsKCQlmbG9hdCBIbGwgPSBidW1wU2NhbGUgKiB0ZXh0dXJlMkQoIGJ1bXBNYXAsIHZCdW1wTWFwVXYgKS54OwoJCWZsb2F0IGRCeCA9IGJ1bXBTY2FsZSAqIHRleHR1cmUyRCggYnVtcE1hcCwgdkJ1bXBNYXBVdiArIGRTVGR4ICkueCAtIEhsbDsKCQlmbG9hdCBkQnkgPSBidW1wU2NhbGUgKiB0ZXh0dXJlMkQoIGJ1bXBNYXAsIHZCdW1wTWFwVXYgKyBkU1RkeSApLnggLSBIbGw7CgkJcmV0dXJuIHZlYzIoIGRCeCwgZEJ5ICk7Cgl9Cgl2ZWMzIHBlcnR1cmJOb3JtYWxBcmIoIHZlYzMgc3VyZl9wb3MsIHZlYzMgc3VyZl9ub3JtLCB2ZWMyIGRIZHh5LCBmbG9hdCBmYWNlRGlyZWN0aW9uICkgewoJCXZlYzMgdlNpZ21hWCA9IG5vcm1hbGl6ZSggZEZkeCggc3VyZl9wb3MueHl6ICkgKTsKCQl2ZWMzIHZTaWdtYVkgPSBub3JtYWxpemUoIGRGZHkoIHN1cmZfcG9zLnh5eiApICk7CgkJdmVjMyB2TiA9IHN1cmZfbm9ybTsKCQl2ZWMzIFIxID0gY3Jvc3MoIHZTaWdtYVksIHZOICk7CgkJdmVjMyBSMiA9IGNyb3NzKCB2TiwgdlNpZ21hWCApOwoJCWZsb2F0IGZEZXQgPSBkb3QoIHZTaWdtYVgsIFIxICkgKiBmYWNlRGlyZWN0aW9uOwoJCXZlYzMgdkdyYWQgPSBzaWduKCBmRGV0ICkgKiAoIGRIZHh5LnggKiBSMSArIGRIZHh5LnkgKiBSMiApOwoJCXJldHVybiBub3JtYWxpemUoIGFicyggZkRldCApICogc3VyZl9ub3JtIC0gdkdyYWQgKTsKCX0KI2VuZGlmYCwgYVMgPSBgI2lmIE5VTV9DTElQUElOR19QTEFORVMgPiAwCgl2ZWM0IHBsYW5lOwoJI2lmZGVmIEFMUEhBX1RPX0NPVkVSQUdFCgkJZmxvYXQgZGlzdGFuY2VUb1BsYW5lLCBkaXN0YW5jZUdyYWRpZW50OwoJCWZsb2F0IGNsaXBPcGFjaXR5ID0gMS4wOwoJCSNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnQKCQlmb3IgKCBpbnQgaSA9IDA7IGkgPCBVTklPTl9DTElQUElOR19QTEFORVM7IGkgKysgKSB7CgkJCXBsYW5lID0gY2xpcHBpbmdQbGFuZXNbIGkgXTsKCQkJZGlzdGFuY2VUb1BsYW5lID0gLSBkb3QoIHZDbGlwUG9zaXRpb24sIHBsYW5lLnh5eiApICsgcGxhbmUudzsKCQkJZGlzdGFuY2VHcmFkaWVudCA9IGZ3aWR0aCggZGlzdGFuY2VUb1BsYW5lICkgLyAyLjA7CgkJCWNsaXBPcGFjaXR5ICo9IHNtb290aHN0ZXAoIC0gZGlzdGFuY2VHcmFkaWVudCwgZGlzdGFuY2VHcmFkaWVudCwgZGlzdGFuY2VUb1BsYW5lICk7CgkJCWlmICggY2xpcE9wYWNpdHkgPT0gMC4wICkgZGlzY2FyZDsKCQl9CgkJI3ByYWdtYSB1bnJvbGxfbG9vcF9lbmQKCQkjaWYgVU5JT05fQ0xJUFBJTkdfUExBTkVTIDwgTlVNX0NMSVBQSU5HX1BMQU5FUwoJCQlmbG9hdCB1bmlvbkNsaXBPcGFjaXR5ID0gMS4wOwoJCQkjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0CgkJCWZvciAoIGludCBpID0gVU5JT05fQ0xJUFBJTkdfUExBTkVTOyBpIDwgTlVNX0NMSVBQSU5HX1BMQU5FUzsgaSArKyApIHsKCQkJCXBsYW5lID0gY2xpcHBpbmdQbGFuZXNbIGkgXTsKCQkJCWRpc3RhbmNlVG9QbGFuZSA9IC0gZG90KCB2Q2xpcFBvc2l0aW9uLCBwbGFuZS54eXogKSArIHBsYW5lLnc7CgkJCQlkaXN0YW5jZUdyYWRpZW50ID0gZndpZHRoKCBkaXN0YW5jZVRvUGxhbmUgKSAvIDIuMDsKCQkJCXVuaW9uQ2xpcE9wYWNpdHkgKj0gMS4wIC0gc21vb3Roc3RlcCggLSBkaXN0YW5jZUdyYWRpZW50LCBkaXN0YW5jZUdyYWRpZW50LCBkaXN0YW5jZVRvUGxhbmUgKTsKCQkJfQoJCQkjcHJhZ21hIHVucm9sbF9sb29wX2VuZAoJCQljbGlwT3BhY2l0eSAqPSAxLjAgLSB1bmlvbkNsaXBPcGFjaXR5OwoJCSNlbmRpZgoJCWRpZmZ1c2VDb2xvci5hICo9IGNsaXBPcGFjaXR5OwoJCWlmICggZGlmZnVzZUNvbG9yLmEgPT0gMC4wICkgZGlzY2FyZDsKCSNlbHNlCgkJI3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydAoJCWZvciAoIGludCBpID0gMDsgaSA8IFVOSU9OX0NMSVBQSU5HX1BMQU5FUzsgaSArKyApIHsKCQkJcGxhbmUgPSBjbGlwcGluZ1BsYW5lc1sgaSBdOwoJCQlpZiAoIGRvdCggdkNsaXBQb3NpdGlvbiwgcGxhbmUueHl6ICkgPiBwbGFuZS53ICkgZGlzY2FyZDsKCQl9CgkJI3ByYWdtYSB1bnJvbGxfbG9vcF9lbmQKCQkjaWYgVU5JT05fQ0xJUFBJTkdfUExBTkVTIDwgTlVNX0NMSVBQSU5HX1BMQU5FUwoJCQlib29sIGNsaXBwZWQgPSB0cnVlOwoJCQkjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0CgkJCWZvciAoIGludCBpID0gVU5JT05fQ0xJUFBJTkdfUExBTkVTOyBpIDwgTlVNX0NMSVBQSU5HX1BMQU5FUzsgaSArKyApIHsKCQkJCXBsYW5lID0gY2xpcHBpbmdQbGFuZXNbIGkgXTsKCQkJCWNsaXBwZWQgPSAoIGRvdCggdkNsaXBQb3NpdGlvbiwgcGxhbmUueHl6ICkgPiBwbGFuZS53ICkgJiYgY2xpcHBlZDsKCQkJfQoJCQkjcHJhZ21hIHVucm9sbF9sb29wX2VuZAoJCQlpZiAoIGNsaXBwZWQgKSBkaXNjYXJkOwoJCSNlbmRpZgoJI2VuZGlmCiNlbmRpZmAsIG9TID0gYCNpZiBOVU1fQ0xJUFBJTkdfUExBTkVTID4gMAoJdmFyeWluZyB2ZWMzIHZDbGlwUG9zaXRpb247Cgl1bmlmb3JtIHZlYzQgY2xpcHBpbmdQbGFuZXNbIE5VTV9DTElQUElOR19QTEFORVMgXTsKI2VuZGlmYCwgbFMgPSBgI2lmIE5VTV9DTElQUElOR19QTEFORVMgPiAwCgl2YXJ5aW5nIHZlYzMgdkNsaXBQb3NpdGlvbjsKI2VuZGlmYCwgaFMgPSBgI2lmIE5VTV9DTElQUElOR19QTEFORVMgPiAwCgl2Q2xpcFBvc2l0aW9uID0gLSBtdlBvc2l0aW9uLnh5ejsKI2VuZGlmYCwgY1MgPSBgI2lmIGRlZmluZWQoIFVTRV9DT0xPUl9BTFBIQSApCglkaWZmdXNlQ29sb3IgKj0gdkNvbG9yOwojZWxpZiBkZWZpbmVkKCBVU0VfQ09MT1IgKQoJZGlmZnVzZUNvbG9yLnJnYiAqPSB2Q29sb3I7CiNlbmRpZmAsIHVTID0gYCNpZiBkZWZpbmVkKCBVU0VfQ09MT1JfQUxQSEEgKQoJdmFyeWluZyB2ZWM0IHZDb2xvcjsKI2VsaWYgZGVmaW5lZCggVVNFX0NPTE9SICkKCXZhcnlpbmcgdmVjMyB2Q29sb3I7CiNlbmRpZmAsIGRTID0gYCNpZiBkZWZpbmVkKCBVU0VfQ09MT1JfQUxQSEEgKQoJdmFyeWluZyB2ZWM0IHZDb2xvcjsKI2VsaWYgZGVmaW5lZCggVVNFX0NPTE9SICkgfHwgZGVmaW5lZCggVVNFX0lOU1RBTkNJTkdfQ09MT1IgKSB8fCBkZWZpbmVkKCBVU0VfQkFUQ0hJTkdfQ09MT1IgKQoJdmFyeWluZyB2ZWMzIHZDb2xvcjsKI2VuZGlmYCwgcFMgPSBgI2lmIGRlZmluZWQoIFVTRV9DT0xPUl9BTFBIQSApCgl2Q29sb3IgPSB2ZWM0KCAxLjAgKTsKI2VsaWYgZGVmaW5lZCggVVNFX0NPTE9SICkgfHwgZGVmaW5lZCggVVNFX0lOU1RBTkNJTkdfQ09MT1IgKSB8fCBkZWZpbmVkKCBVU0VfQkFUQ0hJTkdfQ09MT1IgKQoJdkNvbG9yID0gdmVjMyggMS4wICk7CiNlbmRpZgojaWZkZWYgVVNFX0NPTE9SCgl2Q29sb3IgKj0gY29sb3I7CiNlbmRpZgojaWZkZWYgVVNFX0lOU1RBTkNJTkdfQ09MT1IKCXZDb2xvci54eXogKj0gaW5zdGFuY2VDb2xvci54eXo7CiNlbmRpZgojaWZkZWYgVVNFX0JBVENISU5HX0NPTE9SCgl2ZWMzIGJhdGNoaW5nQ29sb3IgPSBnZXRCYXRjaGluZ0NvbG9yKCBnZXRJbmRpcmVjdEluZGV4KCBnbF9EcmF3SUQgKSApOwoJdkNvbG9yLnh5eiAqPSBiYXRjaGluZ0NvbG9yLnh5ejsKI2VuZGlmYCwgZlMgPSBgI2RlZmluZSBQSSAzLjE0MTU5MjY1MzU4OTc5MwojZGVmaW5lIFBJMiA2LjI4MzE4NTMwNzE3OTU4NgojZGVmaW5lIFBJX0hBTEYgMS41NzA3OTYzMjY3OTQ4OTY2CiNkZWZpbmUgUkVDSVBST0NBTF9QSSAwLjMxODMwOTg4NjE4Mzc5MDcKI2RlZmluZSBSRUNJUFJPQ0FMX1BJMiAwLjE1OTE1NDk0MzA5MTg5NTM1CiNkZWZpbmUgRVBTSUxPTiAxZS02CiNpZm5kZWYgc2F0dXJhdGUKI2RlZmluZSBzYXR1cmF0ZSggYSApIGNsYW1wKCBhLCAwLjAsIDEuMCApCiNlbmRpZgojZGVmaW5lIHdoaXRlQ29tcGxlbWVudCggYSApICggMS4wIC0gc2F0dXJhdGUoIGEgKSApCmZsb2F0IHBvdzIoIGNvbnN0IGluIGZsb2F0IHggKSB7IHJldHVybiB4Kng7IH0KdmVjMyBwb3cyKCBjb25zdCBpbiB2ZWMzIHggKSB7IHJldHVybiB4Kng7IH0KZmxvYXQgcG93MyggY29uc3QgaW4gZmxvYXQgeCApIHsgcmV0dXJuIHgqeCp4OyB9CmZsb2F0IHBvdzQoIGNvbnN0IGluIGZsb2F0IHggKSB7IGZsb2F0IHgyID0geCp4OyByZXR1cm4geDIqeDI7IH0KZmxvYXQgbWF4MyggY29uc3QgaW4gdmVjMyB2ICkgeyByZXR1cm4gbWF4KCBtYXgoIHYueCwgdi55ICksIHYueiApOyB9CmZsb2F0IGF2ZXJhZ2UoIGNvbnN0IGluIHZlYzMgdiApIHsgcmV0dXJuIGRvdCggdiwgdmVjMyggMC4zMzMzMzMzICkgKTsgfQpoaWdocCBmbG9hdCByYW5kKCBjb25zdCBpbiB2ZWMyIHV2ICkgewoJY29uc3QgaGlnaHAgZmxvYXQgYSA9IDEyLjk4OTgsIGIgPSA3OC4yMzMsIGMgPSA0Mzc1OC41NDUzOwoJaGlnaHAgZmxvYXQgZHQgPSBkb3QoIHV2Lnh5LCB2ZWMyKCBhLGIgKSApLCBzbiA9IG1vZCggZHQsIFBJICk7CglyZXR1cm4gZnJhY3QoIHNpbiggc24gKSAqIGMgKTsKfQojaWZkZWYgSElHSF9QUkVDSVNJT04KCWZsb2F0IHByZWNpc2lvblNhZmVMZW5ndGgoIHZlYzMgdiApIHsgcmV0dXJuIGxlbmd0aCggdiApOyB9CiNlbHNlCglmbG9hdCBwcmVjaXNpb25TYWZlTGVuZ3RoKCB2ZWMzIHYgKSB7CgkJZmxvYXQgbWF4Q29tcG9uZW50ID0gbWF4MyggYWJzKCB2ICkgKTsKCQlyZXR1cm4gbGVuZ3RoKCB2IC8gbWF4Q29tcG9uZW50ICkgKiBtYXhDb21wb25lbnQ7Cgl9CiNlbmRpZgpzdHJ1Y3QgSW5jaWRlbnRMaWdodCB7Cgl2ZWMzIGNvbG9yOwoJdmVjMyBkaXJlY3Rpb247Cglib29sIHZpc2libGU7Cn07CnN0cnVjdCBSZWZsZWN0ZWRMaWdodCB7Cgl2ZWMzIGRpcmVjdERpZmZ1c2U7Cgl2ZWMzIGRpcmVjdFNwZWN1bGFyOwoJdmVjMyBpbmRpcmVjdERpZmZ1c2U7Cgl2ZWMzIGluZGlyZWN0U3BlY3VsYXI7Cn07CiNpZmRlZiBVU0VfQUxQSEFIQVNICgl2YXJ5aW5nIHZlYzMgdlBvc2l0aW9uOwojZW5kaWYKdmVjMyB0cmFuc2Zvcm1EaXJlY3Rpb24oIGluIHZlYzMgZGlyLCBpbiBtYXQ0IG1hdHJpeCApIHsKCXJldHVybiBub3JtYWxpemUoICggbWF0cml4ICogdmVjNCggZGlyLCAwLjAgKSApLnh5eiApOwp9CnZlYzMgaW52ZXJzZVRyYW5zZm9ybURpcmVjdGlvbiggaW4gdmVjMyBkaXIsIGluIG1hdDQgbWF0cml4ICkgewoJcmV0dXJuIG5vcm1hbGl6ZSggKCB2ZWM0KCBkaXIsIDAuMCApICogbWF0cml4ICkueHl6ICk7Cn0KbWF0MyB0cmFuc3Bvc2VNYXQzKCBjb25zdCBpbiBtYXQzIG0gKSB7CgltYXQzIHRtcDsKCXRtcFsgMCBdID0gdmVjMyggbVsgMCBdLngsIG1bIDEgXS54LCBtWyAyIF0ueCApOwoJdG1wWyAxIF0gPSB2ZWMzKCBtWyAwIF0ueSwgbVsgMSBdLnksIG1bIDIgXS55ICk7Cgl0bXBbIDIgXSA9IHZlYzMoIG1bIDAgXS56LCBtWyAxIF0ueiwgbVsgMiBdLnogKTsKCXJldHVybiB0bXA7Cn0KYm9vbCBpc1BlcnNwZWN0aXZlTWF0cml4KCBtYXQ0IG0gKSB7CglyZXR1cm4gbVsgMiBdWyAzIF0gPT0gLSAxLjA7Cn0KdmVjMiBlcXVpcmVjdFV2KCBpbiB2ZWMzIGRpciApIHsKCWZsb2F0IHUgPSBhdGFuKCBkaXIueiwgZGlyLnggKSAqIFJFQ0lQUk9DQUxfUEkyICsgMC41OwoJZmxvYXQgdiA9IGFzaW4oIGNsYW1wKCBkaXIueSwgLSAxLjAsIDEuMCApICkgKiBSRUNJUFJPQ0FMX1BJICsgMC41OwoJcmV0dXJuIHZlYzIoIHUsIHYgKTsKfQp2ZWMzIEJSREZfTGFtYmVydCggY29uc3QgaW4gdmVjMyBkaWZmdXNlQ29sb3IgKSB7CglyZXR1cm4gUkVDSVBST0NBTF9QSSAqIGRpZmZ1c2VDb2xvcjsKfQp2ZWMzIEZfU2NobGljayggY29uc3QgaW4gdmVjMyBmMCwgY29uc3QgaW4gZmxvYXQgZjkwLCBjb25zdCBpbiBmbG9hdCBkb3RWSCApIHsKCWZsb2F0IGZyZXNuZWwgPSBleHAyKCAoIC0gNS41NTQ3MyAqIGRvdFZIIC0gNi45ODMxNiApICogZG90VkggKTsKCXJldHVybiBmMCAqICggMS4wIC0gZnJlc25lbCApICsgKCBmOTAgKiBmcmVzbmVsICk7Cn0KZmxvYXQgRl9TY2hsaWNrKCBjb25zdCBpbiBmbG9hdCBmMCwgY29uc3QgaW4gZmxvYXQgZjkwLCBjb25zdCBpbiBmbG9hdCBkb3RWSCApIHsKCWZsb2F0IGZyZXNuZWwgPSBleHAyKCAoIC0gNS41NTQ3MyAqIGRvdFZIIC0gNi45ODMxNiApICogZG90VkggKTsKCXJldHVybiBmMCAqICggMS4wIC0gZnJlc25lbCApICsgKCBmOTAgKiBmcmVzbmVsICk7Cn0gLy8gdmFsaWRhdGVkYCwgbVMgPSBgI2lmZGVmIEVOVk1BUF9UWVBFX0NVQkVfVVYKCSNkZWZpbmUgY3ViZVVWX21pbk1pcExldmVsIDQuMAoJI2RlZmluZSBjdWJlVVZfbWluVGlsZVNpemUgMTYuMAoJZmxvYXQgZ2V0RmFjZSggdmVjMyBkaXJlY3Rpb24gKSB7CgkJdmVjMyBhYnNEaXJlY3Rpb24gPSBhYnMoIGRpcmVjdGlvbiApOwoJCWZsb2F0IGZhY2UgPSAtIDEuMDsKCQlpZiAoIGFic0RpcmVjdGlvbi54ID4gYWJzRGlyZWN0aW9uLnogKSB7CgkJCWlmICggYWJzRGlyZWN0aW9uLnggPiBhYnNEaXJlY3Rpb24ueSApCgkJCQlmYWNlID0gZGlyZWN0aW9uLnggPiAwLjAgPyAwLjAgOiAzLjA7CgkJCWVsc2UKCQkJCWZhY2UgPSBkaXJlY3Rpb24ueSA+IDAuMCA/IDEuMCA6IDQuMDsKCQl9IGVsc2UgewoJCQlpZiAoIGFic0RpcmVjdGlvbi56ID4gYWJzRGlyZWN0aW9uLnkgKQoJCQkJZmFjZSA9IGRpcmVjdGlvbi56ID4gMC4wID8gMi4wIDogNS4wOwoJCQllbHNlCgkJCQlmYWNlID0gZGlyZWN0aW9uLnkgPiAwLjAgPyAxLjAgOiA0LjA7CgkJfQoJCXJldHVybiBmYWNlOwoJfQoJdmVjMiBnZXRVViggdmVjMyBkaXJlY3Rpb24sIGZsb2F0IGZhY2UgKSB7CgkJdmVjMiB1djsKCQlpZiAoIGZhY2UgPT0gMC4wICkgewoJCQl1diA9IHZlYzIoIGRpcmVjdGlvbi56LCBkaXJlY3Rpb24ueSApIC8gYWJzKCBkaXJlY3Rpb24ueCApOwoJCX0gZWxzZSBpZiAoIGZhY2UgPT0gMS4wICkgewoJCQl1diA9IHZlYzIoIC0gZGlyZWN0aW9uLngsIC0gZGlyZWN0aW9uLnogKSAvIGFicyggZGlyZWN0aW9uLnkgKTsKCQl9IGVsc2UgaWYgKCBmYWNlID09IDIuMCApIHsKCQkJdXYgPSB2ZWMyKCAtIGRpcmVjdGlvbi54LCBkaXJlY3Rpb24ueSApIC8gYWJzKCBkaXJlY3Rpb24ueiApOwoJCX0gZWxzZSBpZiAoIGZhY2UgPT0gMy4wICkgewoJCQl1diA9IHZlYzIoIC0gZGlyZWN0aW9uLnosIGRpcmVjdGlvbi55ICkgLyBhYnMoIGRpcmVjdGlvbi54ICk7CgkJfSBlbHNlIGlmICggZmFjZSA9PSA0LjAgKSB7CgkJCXV2ID0gdmVjMiggLSBkaXJlY3Rpb24ueCwgZGlyZWN0aW9uLnogKSAvIGFicyggZGlyZWN0aW9uLnkgKTsKCQl9IGVsc2UgewoJCQl1diA9IHZlYzIoIGRpcmVjdGlvbi54LCBkaXJlY3Rpb24ueSApIC8gYWJzKCBkaXJlY3Rpb24ueiApOwoJCX0KCQlyZXR1cm4gMC41ICogKCB1diArIDEuMCApOwoJfQoJdmVjMyBiaWxpbmVhckN1YmVVViggc2FtcGxlcjJEIGVudk1hcCwgdmVjMyBkaXJlY3Rpb24sIGZsb2F0IG1pcEludCApIHsKCQlmbG9hdCBmYWNlID0gZ2V0RmFjZSggZGlyZWN0aW9uICk7CgkJZmxvYXQgZmlsdGVySW50ID0gbWF4KCBjdWJlVVZfbWluTWlwTGV2ZWwgLSBtaXBJbnQsIDAuMCApOwoJCW1pcEludCA9IG1heCggbWlwSW50LCBjdWJlVVZfbWluTWlwTGV2ZWwgKTsKCQlmbG9hdCBmYWNlU2l6ZSA9IGV4cDIoIG1pcEludCApOwoJCWhpZ2hwIHZlYzIgdXYgPSBnZXRVViggZGlyZWN0aW9uLCBmYWNlICkgKiAoIGZhY2VTaXplIC0gMi4wICkgKyAxLjA7CgkJaWYgKCBmYWNlID4gMi4wICkgewoJCQl1di55ICs9IGZhY2VTaXplOwoJCQlmYWNlIC09IDMuMDsKCQl9CgkJdXYueCArPSBmYWNlICogZmFjZVNpemU7CgkJdXYueCArPSBmaWx0ZXJJbnQgKiAzLjAgKiBjdWJlVVZfbWluVGlsZVNpemU7CgkJdXYueSArPSA0LjAgKiAoIGV4cDIoIENVQkVVVl9NQVhfTUlQICkgLSBmYWNlU2l6ZSApOwoJCXV2LnggKj0gQ1VCRVVWX1RFWEVMX1dJRFRIOwoJCXV2LnkgKj0gQ1VCRVVWX1RFWEVMX0hFSUdIVDsKCQkjaWZkZWYgdGV4dHVyZTJER3JhZEVYVAoJCQlyZXR1cm4gdGV4dHVyZTJER3JhZEVYVCggZW52TWFwLCB1diwgdmVjMiggMC4wICksIHZlYzIoIDAuMCApICkucmdiOwoJCSNlbHNlCgkJCXJldHVybiB0ZXh0dXJlMkQoIGVudk1hcCwgdXYgKS5yZ2I7CgkJI2VuZGlmCgl9CgkjZGVmaW5lIGN1YmVVVl9yMCAxLjAKCSNkZWZpbmUgY3ViZVVWX20wIC0gMi4wCgkjZGVmaW5lIGN1YmVVVl9yMSAwLjgKCSNkZWZpbmUgY3ViZVVWX20xIC0gMS4wCgkjZGVmaW5lIGN1YmVVVl9yNCAwLjQKCSNkZWZpbmUgY3ViZVVWX200IDIuMAoJI2RlZmluZSBjdWJlVVZfcjUgMC4zMDUKCSNkZWZpbmUgY3ViZVVWX201IDMuMAoJI2RlZmluZSBjdWJlVVZfcjYgMC4yMQoJI2RlZmluZSBjdWJlVVZfbTYgNC4wCglmbG9hdCByb3VnaG5lc3NUb01pcCggZmxvYXQgcm91Z2huZXNzICkgewoJCWZsb2F0IG1pcCA9IDAuMDsKCQlpZiAoIHJvdWdobmVzcyA+PSBjdWJlVVZfcjEgKSB7CgkJCW1pcCA9ICggY3ViZVVWX3IwIC0gcm91Z2huZXNzICkgKiAoIGN1YmVVVl9tMSAtIGN1YmVVVl9tMCApIC8gKCBjdWJlVVZfcjAgLSBjdWJlVVZfcjEgKSArIGN1YmVVVl9tMDsKCQl9IGVsc2UgaWYgKCByb3VnaG5lc3MgPj0gY3ViZVVWX3I0ICkgewoJCQltaXAgPSAoIGN1YmVVVl9yMSAtIHJvdWdobmVzcyApICogKCBjdWJlVVZfbTQgLSBjdWJlVVZfbTEgKSAvICggY3ViZVVWX3IxIC0gY3ViZVVWX3I0ICkgKyBjdWJlVVZfbTE7CgkJfSBlbHNlIGlmICggcm91Z2huZXNzID49IGN1YmVVVl9yNSApIHsKCQkJbWlwID0gKCBjdWJlVVZfcjQgLSByb3VnaG5lc3MgKSAqICggY3ViZVVWX201IC0gY3ViZVVWX200ICkgLyAoIGN1YmVVVl9yNCAtIGN1YmVVVl9yNSApICsgY3ViZVVWX200OwoJCX0gZWxzZSBpZiAoIHJvdWdobmVzcyA+PSBjdWJlVVZfcjYgKSB7CgkJCW1pcCA9ICggY3ViZVVWX3I1IC0gcm91Z2huZXNzICkgKiAoIGN1YmVVVl9tNiAtIGN1YmVVVl9tNSApIC8gKCBjdWJlVVZfcjUgLSBjdWJlVVZfcjYgKSArIGN1YmVVVl9tNTsKCQl9IGVsc2UgewoJCQltaXAgPSAtIDIuMCAqIGxvZzIoIDEuMTYgKiByb3VnaG5lc3MgKTsJCX0KCQlyZXR1cm4gbWlwOwoJfQoJdmVjNCB0ZXh0dXJlQ3ViZVVWKCBzYW1wbGVyMkQgZW52TWFwLCB2ZWMzIHNhbXBsZURpciwgZmxvYXQgcm91Z2huZXNzICkgewoJCWZsb2F0IG1pcCA9IGNsYW1wKCByb3VnaG5lc3NUb01pcCggcm91Z2huZXNzICksIGN1YmVVVl9tMCwgQ1VCRVVWX01BWF9NSVAgKTsKCQlmbG9hdCBtaXBGID0gZnJhY3QoIG1pcCApOwoJCWZsb2F0IG1pcEludCA9IGZsb29yKCBtaXAgKTsKCQl2ZWMzIGNvbG9yMCA9IGJpbGluZWFyQ3ViZVVWKCBlbnZNYXAsIHNhbXBsZURpciwgbWlwSW50ICk7CgkJaWYgKCBtaXBGID09IDAuMCApIHsKCQkJcmV0dXJuIHZlYzQoIGNvbG9yMCwgMS4wICk7CgkJfSBlbHNlIHsKCQkJdmVjMyBjb2xvcjEgPSBiaWxpbmVhckN1YmVVViggZW52TWFwLCBzYW1wbGVEaXIsIG1pcEludCArIDEuMCApOwoJCQlyZXR1cm4gdmVjNCggbWl4KCBjb2xvcjAsIGNvbG9yMSwgbWlwRiApLCAxLjAgKTsKCQl9Cgl9CiNlbmRpZmAsIGdTID0gYHZlYzMgdHJhbnNmb3JtZWROb3JtYWwgPSBvYmplY3ROb3JtYWw7CiNpZmRlZiBVU0VfVEFOR0VOVAoJdmVjMyB0cmFuc2Zvcm1lZFRhbmdlbnQgPSBvYmplY3RUYW5nZW50OwojZW5kaWYKI2lmZGVmIFVTRV9CQVRDSElORwoJbWF0MyBibSA9IG1hdDMoIGJhdGNoaW5nTWF0cml4ICk7Cgl0cmFuc2Zvcm1lZE5vcm1hbCAvPSB2ZWMzKCBkb3QoIGJtWyAwIF0sIGJtWyAwIF0gKSwgZG90KCBibVsgMSBdLCBibVsgMSBdICksIGRvdCggYm1bIDIgXSwgYm1bIDIgXSApICk7Cgl0cmFuc2Zvcm1lZE5vcm1hbCA9IGJtICogdHJhbnNmb3JtZWROb3JtYWw7CgkjaWZkZWYgVVNFX1RBTkdFTlQKCQl0cmFuc2Zvcm1lZFRhbmdlbnQgPSBibSAqIHRyYW5zZm9ybWVkVGFuZ2VudDsKCSNlbmRpZgojZW5kaWYKI2lmZGVmIFVTRV9JTlNUQU5DSU5HCgltYXQzIGltID0gbWF0MyggaW5zdGFuY2VNYXRyaXggKTsKCXRyYW5zZm9ybWVkTm9ybWFsIC89IHZlYzMoIGRvdCggaW1bIDAgXSwgaW1bIDAgXSApLCBkb3QoIGltWyAxIF0sIGltWyAxIF0gKSwgZG90KCBpbVsgMiBdLCBpbVsgMiBdICkgKTsKCXRyYW5zZm9ybWVkTm9ybWFsID0gaW0gKiB0cmFuc2Zvcm1lZE5vcm1hbDsKCSNpZmRlZiBVU0VfVEFOR0VOVAoJCXRyYW5zZm9ybWVkVGFuZ2VudCA9IGltICogdHJhbnNmb3JtZWRUYW5nZW50OwoJI2VuZGlmCiNlbmRpZgp0cmFuc2Zvcm1lZE5vcm1hbCA9IG5vcm1hbE1hdHJpeCAqIHRyYW5zZm9ybWVkTm9ybWFsOwojaWZkZWYgRkxJUF9TSURFRAoJdHJhbnNmb3JtZWROb3JtYWwgPSAtIHRyYW5zZm9ybWVkTm9ybWFsOwojZW5kaWYKI2lmZGVmIFVTRV9UQU5HRU5UCgl0cmFuc2Zvcm1lZFRhbmdlbnQgPSAoIG1vZGVsVmlld01hdHJpeCAqIHZlYzQoIHRyYW5zZm9ybWVkVGFuZ2VudCwgMC4wICkgKS54eXo7CgkjaWZkZWYgRkxJUF9TSURFRAoJCXRyYW5zZm9ybWVkVGFuZ2VudCA9IC0gdHJhbnNmb3JtZWRUYW5nZW50OwoJI2VuZGlmCiNlbmRpZmAsIHlTID0gYCNpZmRlZiBVU0VfRElTUExBQ0VNRU5UTUFQCgl1bmlmb3JtIHNhbXBsZXIyRCBkaXNwbGFjZW1lbnRNYXA7Cgl1bmlmb3JtIGZsb2F0IGRpc3BsYWNlbWVudFNjYWxlOwoJdW5pZm9ybSBmbG9hdCBkaXNwbGFjZW1lbnRCaWFzOwojZW5kaWZgLCBfUyA9IGAjaWZkZWYgVVNFX0RJU1BMQUNFTUVOVE1BUAoJdHJhbnNmb3JtZWQgKz0gbm9ybWFsaXplKCBvYmplY3ROb3JtYWwgKSAqICggdGV4dHVyZTJEKCBkaXNwbGFjZW1lbnRNYXAsIHZEaXNwbGFjZW1lbnRNYXBVdiApLnggKiBkaXNwbGFjZW1lbnRTY2FsZSArIGRpc3BsYWNlbWVudEJpYXMgKTsKI2VuZGlmYCwgeFMgPSBgI2lmZGVmIFVTRV9FTUlTU0lWRU1BUAoJdmVjNCBlbWlzc2l2ZUNvbG9yID0gdGV4dHVyZTJEKCBlbWlzc2l2ZU1hcCwgdkVtaXNzaXZlTWFwVXYgKTsKCSNpZmRlZiBERUNPREVfVklERU9fVEVYVFVSRV9FTUlTU0lWRQoJCWVtaXNzaXZlQ29sb3IgPSBzUkdCVHJhbnNmZXJFT1RGKCBlbWlzc2l2ZUNvbG9yICk7CgkjZW5kaWYKCXRvdGFsRW1pc3NpdmVSYWRpYW5jZSAqPSBlbWlzc2l2ZUNvbG9yLnJnYjsKI2VuZGlmYCwgdlMgPSBgI2lmZGVmIFVTRV9FTUlTU0lWRU1BUAoJdW5pZm9ybSBzYW1wbGVyMkQgZW1pc3NpdmVNYXA7CiNlbmRpZmAsIGJTID0gImdsX0ZyYWdDb2xvciA9IGxpbmVhclRvT3V0cHV0VGV4ZWwoIGdsX0ZyYWdDb2xvciApOyIsIE1TID0gYHZlYzQgTGluZWFyVHJhbnNmZXJPRVRGKCBpbiB2ZWM0IHZhbHVlICkgewoJcmV0dXJuIHZhbHVlOwp9CnZlYzQgc1JHQlRyYW5zZmVyRU9URiggaW4gdmVjNCB2YWx1ZSApIHsKCXJldHVybiB2ZWM0KCBtaXgoIHBvdyggdmFsdWUucmdiICogMC45NDc4NjcyOTg2ICsgdmVjMyggMC4wNTIxMzI3MDE0ICksIHZlYzMoIDIuNCApICksIHZhbHVlLnJnYiAqIDAuMDc3Mzk5MzgwOCwgdmVjMyggbGVzc1RoYW5FcXVhbCggdmFsdWUucmdiLCB2ZWMzKCAwLjA0MDQ1ICkgKSApICksIHZhbHVlLmEgKTsKfQp2ZWM0IHNSR0JUcmFuc2Zlck9FVEYoIGluIHZlYzQgdmFsdWUgKSB7CglyZXR1cm4gdmVjNCggbWl4KCBwb3coIHZhbHVlLnJnYiwgdmVjMyggMC40MTY2NiApICkgKiAxLjA1NSAtIHZlYzMoIDAuMDU1ICksIHZhbHVlLnJnYiAqIDEyLjkyLCB2ZWMzKCBsZXNzVGhhbkVxdWFsKCB2YWx1ZS5yZ2IsIHZlYzMoIDAuMDAzMTMwOCApICkgKSApLCB2YWx1ZS5hICk7Cn1gLCBTUyA9IGAjaWZkZWYgVVNFX0VOVk1BUAoJI2lmZGVmIEVOVl9XT1JMRFBPUwoJCXZlYzMgY2FtZXJhVG9GcmFnOwoJCWlmICggaXNPcnRob2dyYXBoaWMgKSB7CgkJCWNhbWVyYVRvRnJhZyA9IG5vcm1hbGl6ZSggdmVjMyggLSB2aWV3TWF0cml4WyAwIF1bIDIgXSwgLSB2aWV3TWF0cml4WyAxIF1bIDIgXSwgLSB2aWV3TWF0cml4WyAyIF1bIDIgXSApICk7CgkJfSBlbHNlIHsKCQkJY2FtZXJhVG9GcmFnID0gbm9ybWFsaXplKCB2V29ybGRQb3NpdGlvbiAtIGNhbWVyYVBvc2l0aW9uICk7CgkJfQoJCXZlYzMgd29ybGROb3JtYWwgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCBub3JtYWwsIHZpZXdNYXRyaXggKTsKCQkjaWZkZWYgRU5WTUFQX01PREVfUkVGTEVDVElPTgoJCQl2ZWMzIHJlZmxlY3RWZWMgPSByZWZsZWN0KCBjYW1lcmFUb0ZyYWcsIHdvcmxkTm9ybWFsICk7CgkJI2Vsc2UKCQkJdmVjMyByZWZsZWN0VmVjID0gcmVmcmFjdCggY2FtZXJhVG9GcmFnLCB3b3JsZE5vcm1hbCwgcmVmcmFjdGlvblJhdGlvICk7CgkJI2VuZGlmCgkjZWxzZQoJCXZlYzMgcmVmbGVjdFZlYyA9IHZSZWZsZWN0OwoJI2VuZGlmCgkjaWZkZWYgRU5WTUFQX1RZUEVfQ1VCRQoJCXZlYzQgZW52Q29sb3IgPSB0ZXh0dXJlQ3ViZSggZW52TWFwLCBlbnZNYXBSb3RhdGlvbiAqIHZlYzMoIGZsaXBFbnZNYXAgKiByZWZsZWN0VmVjLngsIHJlZmxlY3RWZWMueXogKSApOwoJI2Vsc2UKCQl2ZWM0IGVudkNvbG9yID0gdmVjNCggMC4wICk7CgkjZW5kaWYKCSNpZmRlZiBFTlZNQVBfQkxFTkRJTkdfTVVMVElQTFkKCQlvdXRnb2luZ0xpZ2h0ID0gbWl4KCBvdXRnb2luZ0xpZ2h0LCBvdXRnb2luZ0xpZ2h0ICogZW52Q29sb3IueHl6LCBzcGVjdWxhclN0cmVuZ3RoICogcmVmbGVjdGl2aXR5ICk7CgkjZWxpZiBkZWZpbmVkKCBFTlZNQVBfQkxFTkRJTkdfTUlYICkKCQlvdXRnb2luZ0xpZ2h0ID0gbWl4KCBvdXRnb2luZ0xpZ2h0LCBlbnZDb2xvci54eXosIHNwZWN1bGFyU3RyZW5ndGggKiByZWZsZWN0aXZpdHkgKTsKCSNlbGlmIGRlZmluZWQoIEVOVk1BUF9CTEVORElOR19BREQgKQoJCW91dGdvaW5nTGlnaHQgKz0gZW52Q29sb3IueHl6ICogc3BlY3VsYXJTdHJlbmd0aCAqIHJlZmxlY3Rpdml0eTsKCSNlbmRpZgojZW5kaWZgLCB3UyA9IGAjaWZkZWYgVVNFX0VOVk1BUAoJdW5pZm9ybSBmbG9hdCBlbnZNYXBJbnRlbnNpdHk7Cgl1bmlmb3JtIGZsb2F0IGZsaXBFbnZNYXA7Cgl1bmlmb3JtIG1hdDMgZW52TWFwUm90YXRpb247CgkjaWZkZWYgRU5WTUFQX1RZUEVfQ1VCRQoJCXVuaWZvcm0gc2FtcGxlckN1YmUgZW52TWFwOwoJI2Vsc2UKCQl1bmlmb3JtIHNhbXBsZXIyRCBlbnZNYXA7CgkjZW5kaWYKCQojZW5kaWZgLCBBUyA9IGAjaWZkZWYgVVNFX0VOVk1BUAoJdW5pZm9ybSBmbG9hdCByZWZsZWN0aXZpdHk7CgkjaWYgZGVmaW5lZCggVVNFX0JVTVBNQVAgKSB8fCBkZWZpbmVkKCBVU0VfTk9STUFMTUFQICkgfHwgZGVmaW5lZCggUEhPTkcgKSB8fCBkZWZpbmVkKCBMQU1CRVJUICkKCQkjZGVmaW5lIEVOVl9XT1JMRFBPUwoJI2VuZGlmCgkjaWZkZWYgRU5WX1dPUkxEUE9TCgkJdmFyeWluZyB2ZWMzIHZXb3JsZFBvc2l0aW9uOwoJCXVuaWZvcm0gZmxvYXQgcmVmcmFjdGlvblJhdGlvOwoJI2Vsc2UKCQl2YXJ5aW5nIHZlYzMgdlJlZmxlY3Q7CgkjZW5kaWYKI2VuZGlmYCwgRVMgPSBgI2lmZGVmIFVTRV9FTlZNQVAKCSNpZiBkZWZpbmVkKCBVU0VfQlVNUE1BUCApIHx8IGRlZmluZWQoIFVTRV9OT1JNQUxNQVAgKSB8fCBkZWZpbmVkKCBQSE9ORyApIHx8IGRlZmluZWQoIExBTUJFUlQgKQoJCSNkZWZpbmUgRU5WX1dPUkxEUE9TCgkjZW5kaWYKCSNpZmRlZiBFTlZfV09STERQT1MKCQkKCQl2YXJ5aW5nIHZlYzMgdldvcmxkUG9zaXRpb247CgkjZWxzZQoJCXZhcnlpbmcgdmVjMyB2UmVmbGVjdDsKCQl1bmlmb3JtIGZsb2F0IHJlZnJhY3Rpb25SYXRpbzsKCSNlbmRpZgojZW5kaWZgLCBUUyA9IGAjaWZkZWYgVVNFX0VOVk1BUAoJI2lmZGVmIEVOVl9XT1JMRFBPUwoJCXZXb3JsZFBvc2l0aW9uID0gd29ybGRQb3NpdGlvbi54eXo7CgkjZWxzZQoJCXZlYzMgY2FtZXJhVG9WZXJ0ZXg7CgkJaWYgKCBpc09ydGhvZ3JhcGhpYyApIHsKCQkJY2FtZXJhVG9WZXJ0ZXggPSBub3JtYWxpemUoIHZlYzMoIC0gdmlld01hdHJpeFsgMCBdWyAyIF0sIC0gdmlld01hdHJpeFsgMSBdWyAyIF0sIC0gdmlld01hdHJpeFsgMiBdWyAyIF0gKSApOwoJCX0gZWxzZSB7CgkJCWNhbWVyYVRvVmVydGV4ID0gbm9ybWFsaXplKCB3b3JsZFBvc2l0aW9uLnh5eiAtIGNhbWVyYVBvc2l0aW9uICk7CgkJfQoJCXZlYzMgd29ybGROb3JtYWwgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCB0cmFuc2Zvcm1lZE5vcm1hbCwgdmlld01hdHJpeCApOwoJCSNpZmRlZiBFTlZNQVBfTU9ERV9SRUZMRUNUSU9OCgkJCXZSZWZsZWN0ID0gcmVmbGVjdCggY2FtZXJhVG9WZXJ0ZXgsIHdvcmxkTm9ybWFsICk7CgkJI2Vsc2UKCQkJdlJlZmxlY3QgPSByZWZyYWN0KCBjYW1lcmFUb1ZlcnRleCwgd29ybGROb3JtYWwsIHJlZnJhY3Rpb25SYXRpbyApOwoJCSNlbmRpZgoJI2VuZGlmCiNlbmRpZmAsIENTID0gYCNpZmRlZiBVU0VfRk9HCgl2Rm9nRGVwdGggPSAtIG12UG9zaXRpb24uejsKI2VuZGlmYCwgUlMgPSBgI2lmZGVmIFVTRV9GT0cKCXZhcnlpbmcgZmxvYXQgdkZvZ0RlcHRoOwojZW5kaWZgLCBQUyA9IGAjaWZkZWYgVVNFX0ZPRwoJI2lmZGVmIEZPR19FWFAyCgkJZmxvYXQgZm9nRmFjdG9yID0gMS4wIC0gZXhwKCAtIGZvZ0RlbnNpdHkgKiBmb2dEZW5zaXR5ICogdkZvZ0RlcHRoICogdkZvZ0RlcHRoICk7CgkjZWxzZQoJCWZsb2F0IGZvZ0ZhY3RvciA9IHNtb290aHN0ZXAoIGZvZ05lYXIsIGZvZ0ZhciwgdkZvZ0RlcHRoICk7CgkjZW5kaWYKCWdsX0ZyYWdDb2xvci5yZ2IgPSBtaXgoIGdsX0ZyYWdDb2xvci5yZ2IsIGZvZ0NvbG9yLCBmb2dGYWN0b3IgKTsKI2VuZGlmYCwgSVMgPSBgI2lmZGVmIFVTRV9GT0cKCXVuaWZvcm0gdmVjMyBmb2dDb2xvcjsKCXZhcnlpbmcgZmxvYXQgdkZvZ0RlcHRoOwoJI2lmZGVmIEZPR19FWFAyCgkJdW5pZm9ybSBmbG9hdCBmb2dEZW5zaXR5OwoJI2Vsc2UKCQl1bmlmb3JtIGZsb2F0IGZvZ05lYXI7CgkJdW5pZm9ybSBmbG9hdCBmb2dGYXI7CgkjZW5kaWYKI2VuZGlmYCwgTFMgPSBgI2lmZGVmIFVTRV9HUkFESUVOVE1BUAoJdW5pZm9ybSBzYW1wbGVyMkQgZ3JhZGllbnRNYXA7CiNlbmRpZgp2ZWMzIGdldEdyYWRpZW50SXJyYWRpYW5jZSggdmVjMyBub3JtYWwsIHZlYzMgbGlnaHREaXJlY3Rpb24gKSB7CglmbG9hdCBkb3ROTCA9IGRvdCggbm9ybWFsLCBsaWdodERpcmVjdGlvbiApOwoJdmVjMiBjb29yZCA9IHZlYzIoIGRvdE5MICogMC41ICsgMC41LCAwLjAgKTsKCSNpZmRlZiBVU0VfR1JBRElFTlRNQVAKCQlyZXR1cm4gdmVjMyggdGV4dHVyZTJEKCBncmFkaWVudE1hcCwgY29vcmQgKS5yICk7CgkjZWxzZQoJCXZlYzIgZncgPSBmd2lkdGgoIGNvb3JkICkgKiAwLjU7CgkJcmV0dXJuIG1peCggdmVjMyggMC43ICksIHZlYzMoIDEuMCApLCBzbW9vdGhzdGVwKCAwLjcgLSBmdy54LCAwLjcgKyBmdy54LCBjb29yZC54ICkgKTsKCSNlbmRpZgp9YCwgRFMgPSBgI2lmZGVmIFVTRV9MSUdIVE1BUAoJdW5pZm9ybSBzYW1wbGVyMkQgbGlnaHRNYXA7Cgl1bmlmb3JtIGZsb2F0IGxpZ2h0TWFwSW50ZW5zaXR5OwojZW5kaWZgLCBGUyA9IGBMYW1iZXJ0TWF0ZXJpYWwgbWF0ZXJpYWw7Cm1hdGVyaWFsLmRpZmZ1c2VDb2xvciA9IGRpZmZ1c2VDb2xvci5yZ2I7Cm1hdGVyaWFsLnNwZWN1bGFyU3RyZW5ndGggPSBzcGVjdWxhclN0cmVuZ3RoO2AsIFVTID0gYHZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwpzdHJ1Y3QgTGFtYmVydE1hdGVyaWFsIHsKCXZlYzMgZGlmZnVzZUNvbG9yOwoJZmxvYXQgc3BlY3VsYXJTdHJlbmd0aDsKfTsKdm9pZCBSRV9EaXJlY3RfTGFtYmVydCggY29uc3QgaW4gSW5jaWRlbnRMaWdodCBkaXJlY3RMaWdodCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gTGFtYmVydE1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHsKCWZsb2F0IGRvdE5MID0gc2F0dXJhdGUoIGRvdCggZ2VvbWV0cnlOb3JtYWwsIGRpcmVjdExpZ2h0LmRpcmVjdGlvbiApICk7Cgl2ZWMzIGlycmFkaWFuY2UgPSBkb3ROTCAqIGRpcmVjdExpZ2h0LmNvbG9yOwoJcmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArPSBpcnJhZGlhbmNlICogQlJERl9MYW1iZXJ0KCBtYXRlcmlhbC5kaWZmdXNlQ29sb3IgKTsKfQp2b2lkIFJFX0luZGlyZWN0RGlmZnVzZV9MYW1iZXJ0KCBjb25zdCBpbiB2ZWMzIGlycmFkaWFuY2UsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeU5vcm1hbCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVZpZXdEaXIsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGNvbnN0IGluIExhbWJlcnRNYXRlcmlhbCBtYXRlcmlhbCwgaW5vdXQgUmVmbGVjdGVkTGlnaHQgcmVmbGVjdGVkTGlnaHQgKSB7CglyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gaXJyYWRpYW5jZSAqIEJSREZfTGFtYmVydCggbWF0ZXJpYWwuZGlmZnVzZUNvbG9yICk7Cn0KI2RlZmluZSBSRV9EaXJlY3QJCQkJUkVfRGlyZWN0X0xhbWJlcnQKI2RlZmluZSBSRV9JbmRpcmVjdERpZmZ1c2UJCVJFX0luZGlyZWN0RGlmZnVzZV9MYW1iZXJ0YCwgQlMgPSBgdW5pZm9ybSBib29sIHJlY2VpdmVTaGFkb3c7CnVuaWZvcm0gdmVjMyBhbWJpZW50TGlnaHRDb2xvcjsKI2lmIGRlZmluZWQoIFVTRV9MSUdIVF9QUk9CRVMgKQoJdW5pZm9ybSB2ZWMzIGxpZ2h0UHJvYmVbIDkgXTsKI2VuZGlmCnZlYzMgc2hHZXRJcnJhZGlhbmNlQXQoIGluIHZlYzMgbm9ybWFsLCBpbiB2ZWMzIHNoQ29lZmZpY2llbnRzWyA5IF0gKSB7CglmbG9hdCB4ID0gbm9ybWFsLngsIHkgPSBub3JtYWwueSwgeiA9IG5vcm1hbC56OwoJdmVjMyByZXN1bHQgPSBzaENvZWZmaWNpZW50c1sgMCBdICogMC44ODYyMjc7CglyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDEgXSAqIDIuMCAqIDAuNTExNjY0ICogeTsKCXJlc3VsdCArPSBzaENvZWZmaWNpZW50c1sgMiBdICogMi4wICogMC41MTE2NjQgKiB6OwoJcmVzdWx0ICs9IHNoQ29lZmZpY2llbnRzWyAzIF0gKiAyLjAgKiAwLjUxMTY2NCAqIHg7CglyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDQgXSAqIDIuMCAqIDAuNDI5MDQzICogeCAqIHk7CglyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDUgXSAqIDIuMCAqIDAuNDI5MDQzICogeSAqIHo7CglyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDYgXSAqICggMC43NDMxMjUgKiB6ICogeiAtIDAuMjQ3NzA4ICk7CglyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDcgXSAqIDIuMCAqIDAuNDI5MDQzICogeCAqIHo7CglyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDggXSAqIDAuNDI5MDQzICogKCB4ICogeCAtIHkgKiB5ICk7CglyZXR1cm4gcmVzdWx0Owp9CnZlYzMgZ2V0TGlnaHRQcm9iZUlycmFkaWFuY2UoIGNvbnN0IGluIHZlYzMgbGlnaHRQcm9iZVsgOSBdLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCApIHsKCXZlYzMgd29ybGROb3JtYWwgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCBub3JtYWwsIHZpZXdNYXRyaXggKTsKCXZlYzMgaXJyYWRpYW5jZSA9IHNoR2V0SXJyYWRpYW5jZUF0KCB3b3JsZE5vcm1hbCwgbGlnaHRQcm9iZSApOwoJcmV0dXJuIGlycmFkaWFuY2U7Cn0KdmVjMyBnZXRBbWJpZW50TGlnaHRJcnJhZGlhbmNlKCBjb25zdCBpbiB2ZWMzIGFtYmllbnRMaWdodENvbG9yICkgewoJdmVjMyBpcnJhZGlhbmNlID0gYW1iaWVudExpZ2h0Q29sb3I7CglyZXR1cm4gaXJyYWRpYW5jZTsKfQpmbG9hdCBnZXREaXN0YW5jZUF0dGVudWF0aW9uKCBjb25zdCBpbiBmbG9hdCBsaWdodERpc3RhbmNlLCBjb25zdCBpbiBmbG9hdCBjdXRvZmZEaXN0YW5jZSwgY29uc3QgaW4gZmxvYXQgZGVjYXlFeHBvbmVudCApIHsKCWZsb2F0IGRpc3RhbmNlRmFsbG9mZiA9IDEuMCAvIG1heCggcG93KCBsaWdodERpc3RhbmNlLCBkZWNheUV4cG9uZW50ICksIDAuMDEgKTsKCWlmICggY3V0b2ZmRGlzdGFuY2UgPiAwLjAgKSB7CgkJZGlzdGFuY2VGYWxsb2ZmICo9IHBvdzIoIHNhdHVyYXRlKCAxLjAgLSBwb3c0KCBsaWdodERpc3RhbmNlIC8gY3V0b2ZmRGlzdGFuY2UgKSApICk7Cgl9CglyZXR1cm4gZGlzdGFuY2VGYWxsb2ZmOwp9CmZsb2F0IGdldFNwb3RBdHRlbnVhdGlvbiggY29uc3QgaW4gZmxvYXQgY29uZUNvc2luZSwgY29uc3QgaW4gZmxvYXQgcGVudW1icmFDb3NpbmUsIGNvbnN0IGluIGZsb2F0IGFuZ2xlQ29zaW5lICkgewoJcmV0dXJuIHNtb290aHN0ZXAoIGNvbmVDb3NpbmUsIHBlbnVtYnJhQ29zaW5lLCBhbmdsZUNvc2luZSApOwp9CiNpZiBOVU1fRElSX0xJR0hUUyA+IDAKCXN0cnVjdCBEaXJlY3Rpb25hbExpZ2h0IHsKCQl2ZWMzIGRpcmVjdGlvbjsKCQl2ZWMzIGNvbG9yOwoJfTsKCXVuaWZvcm0gRGlyZWN0aW9uYWxMaWdodCBkaXJlY3Rpb25hbExpZ2h0c1sgTlVNX0RJUl9MSUdIVFMgXTsKCXZvaWQgZ2V0RGlyZWN0aW9uYWxMaWdodEluZm8oIGNvbnN0IGluIERpcmVjdGlvbmFsTGlnaHQgZGlyZWN0aW9uYWxMaWdodCwgb3V0IEluY2lkZW50TGlnaHQgbGlnaHQgKSB7CgkJbGlnaHQuY29sb3IgPSBkaXJlY3Rpb25hbExpZ2h0LmNvbG9yOwoJCWxpZ2h0LmRpcmVjdGlvbiA9IGRpcmVjdGlvbmFsTGlnaHQuZGlyZWN0aW9uOwoJCWxpZ2h0LnZpc2libGUgPSB0cnVlOwoJfQojZW5kaWYKI2lmIE5VTV9QT0lOVF9MSUdIVFMgPiAwCglzdHJ1Y3QgUG9pbnRMaWdodCB7CgkJdmVjMyBwb3NpdGlvbjsKCQl2ZWMzIGNvbG9yOwoJCWZsb2F0IGRpc3RhbmNlOwoJCWZsb2F0IGRlY2F5OwoJfTsKCXVuaWZvcm0gUG9pbnRMaWdodCBwb2ludExpZ2h0c1sgTlVNX1BPSU5UX0xJR0hUUyBdOwoJdm9pZCBnZXRQb2ludExpZ2h0SW5mbyggY29uc3QgaW4gUG9pbnRMaWdodCBwb2ludExpZ2h0LCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIG91dCBJbmNpZGVudExpZ2h0IGxpZ2h0ICkgewoJCXZlYzMgbFZlY3RvciA9IHBvaW50TGlnaHQucG9zaXRpb24gLSBnZW9tZXRyeVBvc2l0aW9uOwoJCWxpZ2h0LmRpcmVjdGlvbiA9IG5vcm1hbGl6ZSggbFZlY3RvciApOwoJCWZsb2F0IGxpZ2h0RGlzdGFuY2UgPSBsZW5ndGgoIGxWZWN0b3IgKTsKCQlsaWdodC5jb2xvciA9IHBvaW50TGlnaHQuY29sb3I7CgkJbGlnaHQuY29sb3IgKj0gZ2V0RGlzdGFuY2VBdHRlbnVhdGlvbiggbGlnaHREaXN0YW5jZSwgcG9pbnRMaWdodC5kaXN0YW5jZSwgcG9pbnRMaWdodC5kZWNheSApOwoJCWxpZ2h0LnZpc2libGUgPSAoIGxpZ2h0LmNvbG9yICE9IHZlYzMoIDAuMCApICk7Cgl9CiNlbmRpZgojaWYgTlVNX1NQT1RfTElHSFRTID4gMAoJc3RydWN0IFNwb3RMaWdodCB7CgkJdmVjMyBwb3NpdGlvbjsKCQl2ZWMzIGRpcmVjdGlvbjsKCQl2ZWMzIGNvbG9yOwoJCWZsb2F0IGRpc3RhbmNlOwoJCWZsb2F0IGRlY2F5OwoJCWZsb2F0IGNvbmVDb3M7CgkJZmxvYXQgcGVudW1icmFDb3M7Cgl9OwoJdW5pZm9ybSBTcG90TGlnaHQgc3BvdExpZ2h0c1sgTlVNX1NQT1RfTElHSFRTIF07Cgl2b2lkIGdldFNwb3RMaWdodEluZm8oIGNvbnN0IGluIFNwb3RMaWdodCBzcG90TGlnaHQsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgb3V0IEluY2lkZW50TGlnaHQgbGlnaHQgKSB7CgkJdmVjMyBsVmVjdG9yID0gc3BvdExpZ2h0LnBvc2l0aW9uIC0gZ2VvbWV0cnlQb3NpdGlvbjsKCQlsaWdodC5kaXJlY3Rpb24gPSBub3JtYWxpemUoIGxWZWN0b3IgKTsKCQlmbG9hdCBhbmdsZUNvcyA9IGRvdCggbGlnaHQuZGlyZWN0aW9uLCBzcG90TGlnaHQuZGlyZWN0aW9uICk7CgkJZmxvYXQgc3BvdEF0dGVudWF0aW9uID0gZ2V0U3BvdEF0dGVudWF0aW9uKCBzcG90TGlnaHQuY29uZUNvcywgc3BvdExpZ2h0LnBlbnVtYnJhQ29zLCBhbmdsZUNvcyApOwoJCWlmICggc3BvdEF0dGVudWF0aW9uID4gMC4wICkgewoJCQlmbG9hdCBsaWdodERpc3RhbmNlID0gbGVuZ3RoKCBsVmVjdG9yICk7CgkJCWxpZ2h0LmNvbG9yID0gc3BvdExpZ2h0LmNvbG9yICogc3BvdEF0dGVudWF0aW9uOwoJCQlsaWdodC5jb2xvciAqPSBnZXREaXN0YW5jZUF0dGVudWF0aW9uKCBsaWdodERpc3RhbmNlLCBzcG90TGlnaHQuZGlzdGFuY2UsIHNwb3RMaWdodC5kZWNheSApOwoJCQlsaWdodC52aXNpYmxlID0gKCBsaWdodC5jb2xvciAhPSB2ZWMzKCAwLjAgKSApOwoJCX0gZWxzZSB7CgkJCWxpZ2h0LmNvbG9yID0gdmVjMyggMC4wICk7CgkJCWxpZ2h0LnZpc2libGUgPSBmYWxzZTsKCQl9Cgl9CiNlbmRpZgojaWYgTlVNX1JFQ1RfQVJFQV9MSUdIVFMgPiAwCglzdHJ1Y3QgUmVjdEFyZWFMaWdodCB7CgkJdmVjMyBjb2xvcjsKCQl2ZWMzIHBvc2l0aW9uOwoJCXZlYzMgaGFsZldpZHRoOwoJCXZlYzMgaGFsZkhlaWdodDsKCX07Cgl1bmlmb3JtIHNhbXBsZXIyRCBsdGNfMTsJdW5pZm9ybSBzYW1wbGVyMkQgbHRjXzI7Cgl1bmlmb3JtIFJlY3RBcmVhTGlnaHQgcmVjdEFyZWFMaWdodHNbIE5VTV9SRUNUX0FSRUFfTElHSFRTIF07CiNlbmRpZgojaWYgTlVNX0hFTUlfTElHSFRTID4gMAoJc3RydWN0IEhlbWlzcGhlcmVMaWdodCB7CgkJdmVjMyBkaXJlY3Rpb247CgkJdmVjMyBza3lDb2xvcjsKCQl2ZWMzIGdyb3VuZENvbG9yOwoJfTsKCXVuaWZvcm0gSGVtaXNwaGVyZUxpZ2h0IGhlbWlzcGhlcmVMaWdodHNbIE5VTV9IRU1JX0xJR0hUUyBdOwoJdmVjMyBnZXRIZW1pc3BoZXJlTGlnaHRJcnJhZGlhbmNlKCBjb25zdCBpbiBIZW1pc3BoZXJlTGlnaHQgaGVtaUxpZ2h0LCBjb25zdCBpbiB2ZWMzIG5vcm1hbCApIHsKCQlmbG9hdCBkb3ROTCA9IGRvdCggbm9ybWFsLCBoZW1pTGlnaHQuZGlyZWN0aW9uICk7CgkJZmxvYXQgaGVtaURpZmZ1c2VXZWlnaHQgPSAwLjUgKiBkb3ROTCArIDAuNTsKCQl2ZWMzIGlycmFkaWFuY2UgPSBtaXgoIGhlbWlMaWdodC5ncm91bmRDb2xvciwgaGVtaUxpZ2h0LnNreUNvbG9yLCBoZW1pRGlmZnVzZVdlaWdodCApOwoJCXJldHVybiBpcnJhZGlhbmNlOwoJfQojZW5kaWZgLCB6UyA9IGAjaWZkZWYgVVNFX0VOVk1BUAoJdmVjMyBnZXRJQkxJcnJhZGlhbmNlKCBjb25zdCBpbiB2ZWMzIG5vcm1hbCApIHsKCQkjaWZkZWYgRU5WTUFQX1RZUEVfQ1VCRV9VVgoJCQl2ZWMzIHdvcmxkTm9ybWFsID0gaW52ZXJzZVRyYW5zZm9ybURpcmVjdGlvbiggbm9ybWFsLCB2aWV3TWF0cml4ICk7CgkJCXZlYzQgZW52TWFwQ29sb3IgPSB0ZXh0dXJlQ3ViZVVWKCBlbnZNYXAsIGVudk1hcFJvdGF0aW9uICogd29ybGROb3JtYWwsIDEuMCApOwoJCQlyZXR1cm4gUEkgKiBlbnZNYXBDb2xvci5yZ2IgKiBlbnZNYXBJbnRlbnNpdHk7CgkJI2Vsc2UKCQkJcmV0dXJuIHZlYzMoIDAuMCApOwoJCSNlbmRpZgoJfQoJdmVjMyBnZXRJQkxSYWRpYW5jZSggY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzICkgewoJCSNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFX1VWCgkJCXZlYzMgcmVmbGVjdFZlYyA9IHJlZmxlY3QoIC0gdmlld0Rpciwgbm9ybWFsICk7CgkJCXJlZmxlY3RWZWMgPSBub3JtYWxpemUoIG1peCggcmVmbGVjdFZlYywgbm9ybWFsLCByb3VnaG5lc3MgKiByb3VnaG5lc3MpICk7CgkJCXJlZmxlY3RWZWMgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCByZWZsZWN0VmVjLCB2aWV3TWF0cml4ICk7CgkJCXZlYzQgZW52TWFwQ29sb3IgPSB0ZXh0dXJlQ3ViZVVWKCBlbnZNYXAsIGVudk1hcFJvdGF0aW9uICogcmVmbGVjdFZlYywgcm91Z2huZXNzICk7CgkJCXJldHVybiBlbnZNYXBDb2xvci5yZ2IgKiBlbnZNYXBJbnRlbnNpdHk7CgkJI2Vsc2UKCQkJcmV0dXJuIHZlYzMoIDAuMCApOwoJCSNlbmRpZgoJfQoJI2lmZGVmIFVTRV9BTklTT1RST1BZCgkJdmVjMyBnZXRJQkxBbmlzb3Ryb3B5UmFkaWFuY2UoIGNvbnN0IGluIHZlYzMgdmlld0RpciwgY29uc3QgaW4gdmVjMyBub3JtYWwsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcywgY29uc3QgaW4gdmVjMyBiaXRhbmdlbnQsIGNvbnN0IGluIGZsb2F0IGFuaXNvdHJvcHkgKSB7CgkJCSNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFX1VWCgkJCQl2ZWMzIGJlbnROb3JtYWwgPSBjcm9zcyggYml0YW5nZW50LCB2aWV3RGlyICk7CgkJCQliZW50Tm9ybWFsID0gbm9ybWFsaXplKCBjcm9zcyggYmVudE5vcm1hbCwgYml0YW5nZW50ICkgKTsKCQkJCWJlbnROb3JtYWwgPSBub3JtYWxpemUoIG1peCggYmVudE5vcm1hbCwgbm9ybWFsLCBwb3cyKCBwb3cyKCAxLjAgLSBhbmlzb3Ryb3B5ICogKCAxLjAgLSByb3VnaG5lc3MgKSApICkgKSApOwoJCQkJcmV0dXJuIGdldElCTFJhZGlhbmNlKCB2aWV3RGlyLCBiZW50Tm9ybWFsLCByb3VnaG5lc3MgKTsKCQkJI2Vsc2UKCQkJCXJldHVybiB2ZWMzKCAwLjAgKTsKCQkJI2VuZGlmCgkJfQoJI2VuZGlmCiNlbmRpZmAsIE5TID0gYFRvb25NYXRlcmlhbCBtYXRlcmlhbDsKbWF0ZXJpYWwuZGlmZnVzZUNvbG9yID0gZGlmZnVzZUNvbG9yLnJnYjtgLCBPUyA9IGB2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjsKc3RydWN0IFRvb25NYXRlcmlhbCB7Cgl2ZWMzIGRpZmZ1c2VDb2xvcjsKfTsKdm9pZCBSRV9EaXJlY3RfVG9vbiggY29uc3QgaW4gSW5jaWRlbnRMaWdodCBkaXJlY3RMaWdodCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gVG9vbk1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHsKCXZlYzMgaXJyYWRpYW5jZSA9IGdldEdyYWRpZW50SXJyYWRpYW5jZSggZ2VvbWV0cnlOb3JtYWwsIGRpcmVjdExpZ2h0LmRpcmVjdGlvbiApICogZGlyZWN0TGlnaHQuY29sb3I7CglyZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApOwp9CnZvaWQgUkVfSW5kaXJlY3REaWZmdXNlX1Rvb24oIGNvbnN0IGluIHZlYzMgaXJyYWRpYW5jZSwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gVG9vbk1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHsKCXJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSArPSBpcnJhZGlhbmNlICogQlJERl9MYW1iZXJ0KCBtYXRlcmlhbC5kaWZmdXNlQ29sb3IgKTsKfQojZGVmaW5lIFJFX0RpcmVjdAkJCQlSRV9EaXJlY3RfVG9vbgojZGVmaW5lIFJFX0luZGlyZWN0RGlmZnVzZQkJUkVfSW5kaXJlY3REaWZmdXNlX1Rvb25gLCBrUyA9IGBCbGlublBob25nTWF0ZXJpYWwgbWF0ZXJpYWw7Cm1hdGVyaWFsLmRpZmZ1c2VDb2xvciA9IGRpZmZ1c2VDb2xvci5yZ2I7Cm1hdGVyaWFsLnNwZWN1bGFyQ29sb3IgPSBzcGVjdWxhcjsKbWF0ZXJpYWwuc3BlY3VsYXJTaGluaW5lc3MgPSBzaGluaW5lc3M7Cm1hdGVyaWFsLnNwZWN1bGFyU3RyZW5ndGggPSBzcGVjdWxhclN0cmVuZ3RoO2AsIFZTID0gYHZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwpzdHJ1Y3QgQmxpbm5QaG9uZ01hdGVyaWFsIHsKCXZlYzMgZGlmZnVzZUNvbG9yOwoJdmVjMyBzcGVjdWxhckNvbG9yOwoJZmxvYXQgc3BlY3VsYXJTaGluaW5lc3M7CglmbG9hdCBzcGVjdWxhclN0cmVuZ3RoOwp9Owp2b2lkIFJFX0RpcmVjdF9CbGlublBob25nKCBjb25zdCBpbiBJbmNpZGVudExpZ2h0IGRpcmVjdExpZ2h0LCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlOb3JtYWwsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlWaWV3RGlyLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBjb25zdCBpbiBCbGlublBob25nTWF0ZXJpYWwgbWF0ZXJpYWwsIGlub3V0IFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ICkgewoJZmxvYXQgZG90TkwgPSBzYXR1cmF0ZSggZG90KCBnZW9tZXRyeU5vcm1hbCwgZGlyZWN0TGlnaHQuZGlyZWN0aW9uICkgKTsKCXZlYzMgaXJyYWRpYW5jZSA9IGRvdE5MICogZGlyZWN0TGlnaHQuY29sb3I7CglyZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApOwoJcmVmbGVjdGVkTGlnaHQuZGlyZWN0U3BlY3VsYXIgKz0gaXJyYWRpYW5jZSAqIEJSREZfQmxpbm5QaG9uZyggZGlyZWN0TGlnaHQuZGlyZWN0aW9uLCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Tm9ybWFsLCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yLCBtYXRlcmlhbC5zcGVjdWxhclNoaW5pbmVzcyApICogbWF0ZXJpYWwuc3BlY3VsYXJTdHJlbmd0aDsKfQp2b2lkIFJFX0luZGlyZWN0RGlmZnVzZV9CbGlublBob25nKCBjb25zdCBpbiB2ZWMzIGlycmFkaWFuY2UsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeU5vcm1hbCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVZpZXdEaXIsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGNvbnN0IGluIEJsaW5uUGhvbmdNYXRlcmlhbCBtYXRlcmlhbCwgaW5vdXQgUmVmbGVjdGVkTGlnaHQgcmVmbGVjdGVkTGlnaHQgKSB7CglyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gaXJyYWRpYW5jZSAqIEJSREZfTGFtYmVydCggbWF0ZXJpYWwuZGlmZnVzZUNvbG9yICk7Cn0KI2RlZmluZSBSRV9EaXJlY3QJCQkJUkVfRGlyZWN0X0JsaW5uUGhvbmcKI2RlZmluZSBSRV9JbmRpcmVjdERpZmZ1c2UJCVJFX0luZGlyZWN0RGlmZnVzZV9CbGlublBob25nYCwgSFMgPSBgUGh5c2ljYWxNYXRlcmlhbCBtYXRlcmlhbDsKbWF0ZXJpYWwuZGlmZnVzZUNvbG9yID0gZGlmZnVzZUNvbG9yLnJnYiAqICggMS4wIC0gbWV0YWxuZXNzRmFjdG9yICk7CnZlYzMgZHh5ID0gbWF4KCBhYnMoIGRGZHgoIG5vblBlcnR1cmJlZE5vcm1hbCApICksIGFicyggZEZkeSggbm9uUGVydHVyYmVkTm9ybWFsICkgKSApOwpmbG9hdCBnZW9tZXRyeVJvdWdobmVzcyA9IG1heCggbWF4KCBkeHkueCwgZHh5LnkgKSwgZHh5LnogKTsKbWF0ZXJpYWwucm91Z2huZXNzID0gbWF4KCByb3VnaG5lc3NGYWN0b3IsIDAuMDUyNSApO21hdGVyaWFsLnJvdWdobmVzcyArPSBnZW9tZXRyeVJvdWdobmVzczsKbWF0ZXJpYWwucm91Z2huZXNzID0gbWluKCBtYXRlcmlhbC5yb3VnaG5lc3MsIDEuMCApOwojaWZkZWYgSU9SCgltYXRlcmlhbC5pb3IgPSBpb3I7CgkjaWZkZWYgVVNFX1NQRUNVTEFSCgkJZmxvYXQgc3BlY3VsYXJJbnRlbnNpdHlGYWN0b3IgPSBzcGVjdWxhckludGVuc2l0eTsKCQl2ZWMzIHNwZWN1bGFyQ29sb3JGYWN0b3IgPSBzcGVjdWxhckNvbG9yOwoJCSNpZmRlZiBVU0VfU1BFQ1VMQVJfQ09MT1JNQVAKCQkJc3BlY3VsYXJDb2xvckZhY3RvciAqPSB0ZXh0dXJlMkQoIHNwZWN1bGFyQ29sb3JNYXAsIHZTcGVjdWxhckNvbG9yTWFwVXYgKS5yZ2I7CgkJI2VuZGlmCgkJI2lmZGVmIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVAKCQkJc3BlY3VsYXJJbnRlbnNpdHlGYWN0b3IgKj0gdGV4dHVyZTJEKCBzcGVjdWxhckludGVuc2l0eU1hcCwgdlNwZWN1bGFySW50ZW5zaXR5TWFwVXYgKS5hOwoJCSNlbmRpZgoJCW1hdGVyaWFsLnNwZWN1bGFyRjkwID0gbWl4KCBzcGVjdWxhckludGVuc2l0eUZhY3RvciwgMS4wLCBtZXRhbG5lc3NGYWN0b3IgKTsKCSNlbHNlCgkJZmxvYXQgc3BlY3VsYXJJbnRlbnNpdHlGYWN0b3IgPSAxLjA7CgkJdmVjMyBzcGVjdWxhckNvbG9yRmFjdG9yID0gdmVjMyggMS4wICk7CgkJbWF0ZXJpYWwuc3BlY3VsYXJGOTAgPSAxLjA7CgkjZW5kaWYKCW1hdGVyaWFsLnNwZWN1bGFyQ29sb3IgPSBtaXgoIG1pbiggcG93MiggKCBtYXRlcmlhbC5pb3IgLSAxLjAgKSAvICggbWF0ZXJpYWwuaW9yICsgMS4wICkgKSAqIHNwZWN1bGFyQ29sb3JGYWN0b3IsIHZlYzMoIDEuMCApICkgKiBzcGVjdWxhckludGVuc2l0eUZhY3RvciwgZGlmZnVzZUNvbG9yLnJnYiwgbWV0YWxuZXNzRmFjdG9yICk7CiNlbHNlCgltYXRlcmlhbC5zcGVjdWxhckNvbG9yID0gbWl4KCB2ZWMzKCAwLjA0ICksIGRpZmZ1c2VDb2xvci5yZ2IsIG1ldGFsbmVzc0ZhY3RvciApOwoJbWF0ZXJpYWwuc3BlY3VsYXJGOTAgPSAxLjA7CiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVAoJbWF0ZXJpYWwuY2xlYXJjb2F0ID0gY2xlYXJjb2F0OwoJbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzID0gY2xlYXJjb2F0Um91Z2huZXNzOwoJbWF0ZXJpYWwuY2xlYXJjb2F0RjAgPSB2ZWMzKCAwLjA0ICk7CgltYXRlcmlhbC5jbGVhcmNvYXRGOTAgPSAxLjA7CgkjaWZkZWYgVVNFX0NMRUFSQ09BVE1BUAoJCW1hdGVyaWFsLmNsZWFyY29hdCAqPSB0ZXh0dXJlMkQoIGNsZWFyY29hdE1hcCwgdkNsZWFyY29hdE1hcFV2ICkueDsKCSNlbmRpZgoJI2lmZGVmIFVTRV9DTEVBUkNPQVRfUk9VR0hORVNTTUFQCgkJbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzICo9IHRleHR1cmUyRCggY2xlYXJjb2F0Um91Z2huZXNzTWFwLCB2Q2xlYXJjb2F0Um91Z2huZXNzTWFwVXYgKS55OwoJI2VuZGlmCgltYXRlcmlhbC5jbGVhcmNvYXQgPSBzYXR1cmF0ZSggbWF0ZXJpYWwuY2xlYXJjb2F0ICk7CW1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyA9IG1heCggbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzLCAwLjA1MjUgKTsKCW1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyArPSBnZW9tZXRyeVJvdWdobmVzczsKCW1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyA9IG1pbiggbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzLCAxLjAgKTsKI2VuZGlmCiNpZmRlZiBVU0VfRElTUEVSU0lPTgoJbWF0ZXJpYWwuZGlzcGVyc2lvbiA9IGRpc3BlcnNpb247CiNlbmRpZgojaWZkZWYgVVNFX0lSSURFU0NFTkNFCgltYXRlcmlhbC5pcmlkZXNjZW5jZSA9IGlyaWRlc2NlbmNlOwoJbWF0ZXJpYWwuaXJpZGVzY2VuY2VJT1IgPSBpcmlkZXNjZW5jZUlPUjsKCSNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VNQVAKCQltYXRlcmlhbC5pcmlkZXNjZW5jZSAqPSB0ZXh0dXJlMkQoIGlyaWRlc2NlbmNlTWFwLCB2SXJpZGVzY2VuY2VNYXBVdiApLnI7CgkjZW5kaWYKCSNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQCgkJbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3MgPSAoaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtIC0gaXJpZGVzY2VuY2VUaGlja25lc3NNaW5pbXVtKSAqIHRleHR1cmUyRCggaXJpZGVzY2VuY2VUaGlja25lc3NNYXAsIHZJcmlkZXNjZW5jZVRoaWNrbmVzc01hcFV2ICkuZyArIGlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bTsKCSNlbHNlCgkJbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3MgPSBpcmlkZXNjZW5jZVRoaWNrbmVzc01heGltdW07CgkjZW5kaWYKI2VuZGlmCiNpZmRlZiBVU0VfU0hFRU4KCW1hdGVyaWFsLnNoZWVuQ29sb3IgPSBzaGVlbkNvbG9yOwoJI2lmZGVmIFVTRV9TSEVFTl9DT0xPUk1BUAoJCW1hdGVyaWFsLnNoZWVuQ29sb3IgKj0gdGV4dHVyZTJEKCBzaGVlbkNvbG9yTWFwLCB2U2hlZW5Db2xvck1hcFV2ICkucmdiOwoJI2VuZGlmCgltYXRlcmlhbC5zaGVlblJvdWdobmVzcyA9IGNsYW1wKCBzaGVlblJvdWdobmVzcywgMC4wNywgMS4wICk7CgkjaWZkZWYgVVNFX1NIRUVOX1JPVUdITkVTU01BUAoJCW1hdGVyaWFsLnNoZWVuUm91Z2huZXNzICo9IHRleHR1cmUyRCggc2hlZW5Sb3VnaG5lc3NNYXAsIHZTaGVlblJvdWdobmVzc01hcFV2ICkuYTsKCSNlbmRpZgojZW5kaWYKI2lmZGVmIFVTRV9BTklTT1RST1BZCgkjaWZkZWYgVVNFX0FOSVNPVFJPUFlNQVAKCQltYXQyIGFuaXNvdHJvcHlNYXQgPSBtYXQyKCBhbmlzb3Ryb3B5VmVjdG9yLngsIGFuaXNvdHJvcHlWZWN0b3IueSwgLSBhbmlzb3Ryb3B5VmVjdG9yLnksIGFuaXNvdHJvcHlWZWN0b3IueCApOwoJCXZlYzMgYW5pc290cm9weVBvbGFyID0gdGV4dHVyZTJEKCBhbmlzb3Ryb3B5TWFwLCB2QW5pc290cm9weU1hcFV2ICkucmdiOwoJCXZlYzIgYW5pc290cm9weVYgPSBhbmlzb3Ryb3B5TWF0ICogbm9ybWFsaXplKCAyLjAgKiBhbmlzb3Ryb3B5UG9sYXIucmcgLSB2ZWMyKCAxLjAgKSApICogYW5pc290cm9weVBvbGFyLmI7CgkjZWxzZQoJCXZlYzIgYW5pc290cm9weVYgPSBhbmlzb3Ryb3B5VmVjdG9yOwoJI2VuZGlmCgltYXRlcmlhbC5hbmlzb3Ryb3B5ID0gbGVuZ3RoKCBhbmlzb3Ryb3B5ViApOwoJaWYoIG1hdGVyaWFsLmFuaXNvdHJvcHkgPT0gMC4wICkgewoJCWFuaXNvdHJvcHlWID0gdmVjMiggMS4wLCAwLjAgKTsKCX0gZWxzZSB7CgkJYW5pc290cm9weVYgLz0gbWF0ZXJpYWwuYW5pc290cm9weTsKCQltYXRlcmlhbC5hbmlzb3Ryb3B5ID0gc2F0dXJhdGUoIG1hdGVyaWFsLmFuaXNvdHJvcHkgKTsKCX0KCW1hdGVyaWFsLmFscGhhVCA9IG1peCggcG93MiggbWF0ZXJpYWwucm91Z2huZXNzICksIDEuMCwgcG93MiggbWF0ZXJpYWwuYW5pc290cm9weSApICk7CgltYXRlcmlhbC5hbmlzb3Ryb3B5VCA9IHRiblsgMCBdICogYW5pc290cm9weVYueCArIHRiblsgMSBdICogYW5pc290cm9weVYueTsKCW1hdGVyaWFsLmFuaXNvdHJvcHlCID0gdGJuWyAxIF0gKiBhbmlzb3Ryb3B5Vi54IC0gdGJuWyAwIF0gKiBhbmlzb3Ryb3B5Vi55OwojZW5kaWZgLCBHUyA9IGBzdHJ1Y3QgUGh5c2ljYWxNYXRlcmlhbCB7Cgl2ZWMzIGRpZmZ1c2VDb2xvcjsKCWZsb2F0IHJvdWdobmVzczsKCXZlYzMgc3BlY3VsYXJDb2xvcjsKCWZsb2F0IHNwZWN1bGFyRjkwOwoJZmxvYXQgZGlzcGVyc2lvbjsKCSNpZmRlZiBVU0VfQ0xFQVJDT0FUCgkJZmxvYXQgY2xlYXJjb2F0OwoJCWZsb2F0IGNsZWFyY29hdFJvdWdobmVzczsKCQl2ZWMzIGNsZWFyY29hdEYwOwoJCWZsb2F0IGNsZWFyY29hdEY5MDsKCSNlbmRpZgoJI2lmZGVmIFVTRV9JUklERVNDRU5DRQoJCWZsb2F0IGlyaWRlc2NlbmNlOwoJCWZsb2F0IGlyaWRlc2NlbmNlSU9SOwoJCWZsb2F0IGlyaWRlc2NlbmNlVGhpY2tuZXNzOwoJCXZlYzMgaXJpZGVzY2VuY2VGcmVzbmVsOwoJCXZlYzMgaXJpZGVzY2VuY2VGMDsKCSNlbmRpZgoJI2lmZGVmIFVTRV9TSEVFTgoJCXZlYzMgc2hlZW5Db2xvcjsKCQlmbG9hdCBzaGVlblJvdWdobmVzczsKCSNlbmRpZgoJI2lmZGVmIElPUgoJCWZsb2F0IGlvcjsKCSNlbmRpZgoJI2lmZGVmIFVTRV9UUkFOU01JU1NJT04KCQlmbG9hdCB0cmFuc21pc3Npb247CgkJZmxvYXQgdHJhbnNtaXNzaW9uQWxwaGE7CgkJZmxvYXQgdGhpY2tuZXNzOwoJCWZsb2F0IGF0dGVudWF0aW9uRGlzdGFuY2U7CgkJdmVjMyBhdHRlbnVhdGlvbkNvbG9yOwoJI2VuZGlmCgkjaWZkZWYgVVNFX0FOSVNPVFJPUFkKCQlmbG9hdCBhbmlzb3Ryb3B5OwoJCWZsb2F0IGFscGhhVDsKCQl2ZWMzIGFuaXNvdHJvcHlUOwoJCXZlYzMgYW5pc290cm9weUI7CgkjZW5kaWYKfTsKdmVjMyBjbGVhcmNvYXRTcGVjdWxhckRpcmVjdCA9IHZlYzMoIDAuMCApOwp2ZWMzIGNsZWFyY29hdFNwZWN1bGFySW5kaXJlY3QgPSB2ZWMzKCAwLjAgKTsKdmVjMyBzaGVlblNwZWN1bGFyRGlyZWN0ID0gdmVjMyggMC4wICk7CnZlYzMgc2hlZW5TcGVjdWxhckluZGlyZWN0ID0gdmVjMygwLjAgKTsKdmVjMyBTY2hsaWNrX3RvX0YwKCBjb25zdCBpbiB2ZWMzIGYsIGNvbnN0IGluIGZsb2F0IGY5MCwgY29uc3QgaW4gZmxvYXQgZG90VkggKSB7CiAgICBmbG9hdCB4ID0gY2xhbXAoIDEuMCAtIGRvdFZILCAwLjAsIDEuMCApOwogICAgZmxvYXQgeDIgPSB4ICogeDsKICAgIGZsb2F0IHg1ID0gY2xhbXAoIHggKiB4MiAqIHgyLCAwLjAsIDAuOTk5OSApOwogICAgcmV0dXJuICggZiAtIHZlYzMoIGY5MCApICogeDUgKSAvICggMS4wIC0geDUgKTsKfQpmbG9hdCBWX0dHWF9TbWl0aENvcnJlbGF0ZWQoIGNvbnN0IGluIGZsb2F0IGFscGhhLCBjb25zdCBpbiBmbG9hdCBkb3ROTCwgY29uc3QgaW4gZmxvYXQgZG90TlYgKSB7CglmbG9hdCBhMiA9IHBvdzIoIGFscGhhICk7CglmbG9hdCBndiA9IGRvdE5MICogc3FydCggYTIgKyAoIDEuMCAtIGEyICkgKiBwb3cyKCBkb3ROViApICk7CglmbG9hdCBnbCA9IGRvdE5WICogc3FydCggYTIgKyAoIDEuMCAtIGEyICkgKiBwb3cyKCBkb3ROTCApICk7CglyZXR1cm4gMC41IC8gbWF4KCBndiArIGdsLCBFUFNJTE9OICk7Cn0KZmxvYXQgRF9HR1goIGNvbnN0IGluIGZsb2F0IGFscGhhLCBjb25zdCBpbiBmbG9hdCBkb3ROSCApIHsKCWZsb2F0IGEyID0gcG93MiggYWxwaGEgKTsKCWZsb2F0IGRlbm9tID0gcG93MiggZG90TkggKSAqICggYTIgLSAxLjAgKSArIDEuMDsKCXJldHVybiBSRUNJUFJPQ0FMX1BJICogYTIgLyBwb3cyKCBkZW5vbSApOwp9CiNpZmRlZiBVU0VfQU5JU09UUk9QWQoJZmxvYXQgVl9HR1hfU21pdGhDb3JyZWxhdGVkX0FuaXNvdHJvcGljKCBjb25zdCBpbiBmbG9hdCBhbHBoYVQsIGNvbnN0IGluIGZsb2F0IGFscGhhQiwgY29uc3QgaW4gZmxvYXQgZG90VFYsIGNvbnN0IGluIGZsb2F0IGRvdEJWLCBjb25zdCBpbiBmbG9hdCBkb3RUTCwgY29uc3QgaW4gZmxvYXQgZG90QkwsIGNvbnN0IGluIGZsb2F0IGRvdE5WLCBjb25zdCBpbiBmbG9hdCBkb3ROTCApIHsKCQlmbG9hdCBndiA9IGRvdE5MICogbGVuZ3RoKCB2ZWMzKCBhbHBoYVQgKiBkb3RUViwgYWxwaGFCICogZG90QlYsIGRvdE5WICkgKTsKCQlmbG9hdCBnbCA9IGRvdE5WICogbGVuZ3RoKCB2ZWMzKCBhbHBoYVQgKiBkb3RUTCwgYWxwaGFCICogZG90QkwsIGRvdE5MICkgKTsKCQlmbG9hdCB2ID0gMC41IC8gKCBndiArIGdsICk7CgkJcmV0dXJuIHNhdHVyYXRlKHYpOwoJfQoJZmxvYXQgRF9HR1hfQW5pc290cm9waWMoIGNvbnN0IGluIGZsb2F0IGFscGhhVCwgY29uc3QgaW4gZmxvYXQgYWxwaGFCLCBjb25zdCBpbiBmbG9hdCBkb3ROSCwgY29uc3QgaW4gZmxvYXQgZG90VEgsIGNvbnN0IGluIGZsb2F0IGRvdEJIICkgewoJCWZsb2F0IGEyID0gYWxwaGFUICogYWxwaGFCOwoJCWhpZ2hwIHZlYzMgdiA9IHZlYzMoIGFscGhhQiAqIGRvdFRILCBhbHBoYVQgKiBkb3RCSCwgYTIgKiBkb3ROSCApOwoJCWhpZ2hwIGZsb2F0IHYyID0gZG90KCB2LCB2ICk7CgkJZmxvYXQgdzIgPSBhMiAvIHYyOwoJCXJldHVybiBSRUNJUFJPQ0FMX1BJICogYTIgKiBwb3cyICggdzIgKTsKCX0KI2VuZGlmCiNpZmRlZiBVU0VfQ0xFQVJDT0FUCgl2ZWMzIEJSREZfR0dYX0NsZWFyY29hdCggY29uc3QgaW4gdmVjMyBsaWdodERpciwgY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgY29uc3QgaW4gUGh5c2ljYWxNYXRlcmlhbCBtYXRlcmlhbCkgewoJCXZlYzMgZjAgPSBtYXRlcmlhbC5jbGVhcmNvYXRGMDsKCQlmbG9hdCBmOTAgPSBtYXRlcmlhbC5jbGVhcmNvYXRGOTA7CgkJZmxvYXQgcm91Z2huZXNzID0gbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzOwoJCWZsb2F0IGFscGhhID0gcG93Miggcm91Z2huZXNzICk7CgkJdmVjMyBoYWxmRGlyID0gbm9ybWFsaXplKCBsaWdodERpciArIHZpZXdEaXIgKTsKCQlmbG9hdCBkb3ROTCA9IHNhdHVyYXRlKCBkb3QoIG5vcm1hbCwgbGlnaHREaXIgKSApOwoJCWZsb2F0IGRvdE5WID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCB2aWV3RGlyICkgKTsKCQlmbG9hdCBkb3ROSCA9IHNhdHVyYXRlKCBkb3QoIG5vcm1hbCwgaGFsZkRpciApICk7CgkJZmxvYXQgZG90VkggPSBzYXR1cmF0ZSggZG90KCB2aWV3RGlyLCBoYWxmRGlyICkgKTsKCQl2ZWMzIEYgPSBGX1NjaGxpY2soIGYwLCBmOTAsIGRvdFZIICk7CgkJZmxvYXQgViA9IFZfR0dYX1NtaXRoQ29ycmVsYXRlZCggYWxwaGEsIGRvdE5MLCBkb3ROViApOwoJCWZsb2F0IEQgPSBEX0dHWCggYWxwaGEsIGRvdE5IICk7CgkJcmV0dXJuIEYgKiAoIFYgKiBEICk7Cgl9CiNlbmRpZgp2ZWMzIEJSREZfR0dYKCBjb25zdCBpbiB2ZWMzIGxpZ2h0RGlyLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiBQaHlzaWNhbE1hdGVyaWFsIG1hdGVyaWFsICkgewoJdmVjMyBmMCA9IG1hdGVyaWFsLnNwZWN1bGFyQ29sb3I7CglmbG9hdCBmOTAgPSBtYXRlcmlhbC5zcGVjdWxhckY5MDsKCWZsb2F0IHJvdWdobmVzcyA9IG1hdGVyaWFsLnJvdWdobmVzczsKCWZsb2F0IGFscGhhID0gcG93Miggcm91Z2huZXNzICk7Cgl2ZWMzIGhhbGZEaXIgPSBub3JtYWxpemUoIGxpZ2h0RGlyICsgdmlld0RpciApOwoJZmxvYXQgZG90TkwgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGxpZ2h0RGlyICkgKTsKCWZsb2F0IGRvdE5WID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCB2aWV3RGlyICkgKTsKCWZsb2F0IGRvdE5IID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCBoYWxmRGlyICkgKTsKCWZsb2F0IGRvdFZIID0gc2F0dXJhdGUoIGRvdCggdmlld0RpciwgaGFsZkRpciApICk7Cgl2ZWMzIEYgPSBGX1NjaGxpY2soIGYwLCBmOTAsIGRvdFZIICk7CgkjaWZkZWYgVVNFX0lSSURFU0NFTkNFCgkJRiA9IG1peCggRiwgbWF0ZXJpYWwuaXJpZGVzY2VuY2VGcmVzbmVsLCBtYXRlcmlhbC5pcmlkZXNjZW5jZSApOwoJI2VuZGlmCgkjaWZkZWYgVVNFX0FOSVNPVFJPUFkKCQlmbG9hdCBkb3RUTCA9IGRvdCggbWF0ZXJpYWwuYW5pc290cm9weVQsIGxpZ2h0RGlyICk7CgkJZmxvYXQgZG90VFYgPSBkb3QoIG1hdGVyaWFsLmFuaXNvdHJvcHlULCB2aWV3RGlyICk7CgkJZmxvYXQgZG90VEggPSBkb3QoIG1hdGVyaWFsLmFuaXNvdHJvcHlULCBoYWxmRGlyICk7CgkJZmxvYXQgZG90QkwgPSBkb3QoIG1hdGVyaWFsLmFuaXNvdHJvcHlCLCBsaWdodERpciApOwoJCWZsb2F0IGRvdEJWID0gZG90KCBtYXRlcmlhbC5hbmlzb3Ryb3B5Qiwgdmlld0RpciApOwoJCWZsb2F0IGRvdEJIID0gZG90KCBtYXRlcmlhbC5hbmlzb3Ryb3B5QiwgaGFsZkRpciApOwoJCWZsb2F0IFYgPSBWX0dHWF9TbWl0aENvcnJlbGF0ZWRfQW5pc290cm9waWMoIG1hdGVyaWFsLmFscGhhVCwgYWxwaGEsIGRvdFRWLCBkb3RCViwgZG90VEwsIGRvdEJMLCBkb3ROViwgZG90TkwgKTsKCQlmbG9hdCBEID0gRF9HR1hfQW5pc290cm9waWMoIG1hdGVyaWFsLmFscGhhVCwgYWxwaGEsIGRvdE5ILCBkb3RUSCwgZG90QkggKTsKCSNlbHNlCgkJZmxvYXQgViA9IFZfR0dYX1NtaXRoQ29ycmVsYXRlZCggYWxwaGEsIGRvdE5MLCBkb3ROViApOwoJCWZsb2F0IEQgPSBEX0dHWCggYWxwaGEsIGRvdE5IICk7CgkjZW5kaWYKCXJldHVybiBGICogKCBWICogRCApOwp9CnZlYzIgTFRDX1V2KCBjb25zdCBpbiB2ZWMzIE4sIGNvbnN0IGluIHZlYzMgViwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzICkgewoJY29uc3QgZmxvYXQgTFVUX1NJWkUgPSA2NC4wOwoJY29uc3QgZmxvYXQgTFVUX1NDQUxFID0gKCBMVVRfU0laRSAtIDEuMCApIC8gTFVUX1NJWkU7Cgljb25zdCBmbG9hdCBMVVRfQklBUyA9IDAuNSAvIExVVF9TSVpFOwoJZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBOLCBWICkgKTsKCXZlYzIgdXYgPSB2ZWMyKCByb3VnaG5lc3MsIHNxcnQoIDEuMCAtIGRvdE5WICkgKTsKCXV2ID0gdXYgKiBMVVRfU0NBTEUgKyBMVVRfQklBUzsKCXJldHVybiB1djsKfQpmbG9hdCBMVENfQ2xpcHBlZFNwaGVyZUZvcm1GYWN0b3IoIGNvbnN0IGluIHZlYzMgZiApIHsKCWZsb2F0IGwgPSBsZW5ndGgoIGYgKTsKCXJldHVybiBtYXgoICggbCAqIGwgKyBmLnogKSAvICggbCArIDEuMCApLCAwLjAgKTsKfQp2ZWMzIExUQ19FZGdlVmVjdG9yRm9ybUZhY3RvciggY29uc3QgaW4gdmVjMyB2MSwgY29uc3QgaW4gdmVjMyB2MiApIHsKCWZsb2F0IHggPSBkb3QoIHYxLCB2MiApOwoJZmxvYXQgeSA9IGFicyggeCApOwoJZmxvYXQgYSA9IDAuODU0Mzk4NSArICggMC40OTY1MTU1ICsgMC4wMTQ1MjA2ICogeSApICogeTsKCWZsb2F0IGIgPSAzLjQxNzU5NDAgKyAoIDQuMTYxNjcyNCArIHkgKSAqIHk7CglmbG9hdCB2ID0gYSAvIGI7CglmbG9hdCB0aGV0YV9zaW50aGV0YSA9ICggeCA+IDAuMCApID8gdiA6IDAuNSAqIGludmVyc2VzcXJ0KCBtYXgoIDEuMCAtIHggKiB4LCAxZS03ICkgKSAtIHY7CglyZXR1cm4gY3Jvc3MoIHYxLCB2MiApICogdGhldGFfc2ludGhldGE7Cn0KdmVjMyBMVENfRXZhbHVhdGUoIGNvbnN0IGluIHZlYzMgTiwgY29uc3QgaW4gdmVjMyBWLCBjb25zdCBpbiB2ZWMzIFAsIGNvbnN0IGluIG1hdDMgbUludiwgY29uc3QgaW4gdmVjMyByZWN0Q29vcmRzWyA0IF0gKSB7Cgl2ZWMzIHYxID0gcmVjdENvb3Jkc1sgMSBdIC0gcmVjdENvb3Jkc1sgMCBdOwoJdmVjMyB2MiA9IHJlY3RDb29yZHNbIDMgXSAtIHJlY3RDb29yZHNbIDAgXTsKCXZlYzMgbGlnaHROb3JtYWwgPSBjcm9zcyggdjEsIHYyICk7CglpZiggZG90KCBsaWdodE5vcm1hbCwgUCAtIHJlY3RDb29yZHNbIDAgXSApIDwgMC4wICkgcmV0dXJuIHZlYzMoIDAuMCApOwoJdmVjMyBUMSwgVDI7CglUMSA9IG5vcm1hbGl6ZSggViAtIE4gKiBkb3QoIFYsIE4gKSApOwoJVDIgPSAtIGNyb3NzKCBOLCBUMSApOwoJbWF0MyBtYXQgPSBtSW52ICogdHJhbnNwb3NlTWF0MyggbWF0MyggVDEsIFQyLCBOICkgKTsKCXZlYzMgY29vcmRzWyA0IF07Cgljb29yZHNbIDAgXSA9IG1hdCAqICggcmVjdENvb3Jkc1sgMCBdIC0gUCApOwoJY29vcmRzWyAxIF0gPSBtYXQgKiAoIHJlY3RDb29yZHNbIDEgXSAtIFAgKTsKCWNvb3Jkc1sgMiBdID0gbWF0ICogKCByZWN0Q29vcmRzWyAyIF0gLSBQICk7Cgljb29yZHNbIDMgXSA9IG1hdCAqICggcmVjdENvb3Jkc1sgMyBdIC0gUCApOwoJY29vcmRzWyAwIF0gPSBub3JtYWxpemUoIGNvb3Jkc1sgMCBdICk7Cgljb29yZHNbIDEgXSA9IG5vcm1hbGl6ZSggY29vcmRzWyAxIF0gKTsKCWNvb3Jkc1sgMiBdID0gbm9ybWFsaXplKCBjb29yZHNbIDIgXSApOwoJY29vcmRzWyAzIF0gPSBub3JtYWxpemUoIGNvb3Jkc1sgMyBdICk7Cgl2ZWMzIHZlY3RvckZvcm1GYWN0b3IgPSB2ZWMzKCAwLjAgKTsKCXZlY3RvckZvcm1GYWN0b3IgKz0gTFRDX0VkZ2VWZWN0b3JGb3JtRmFjdG9yKCBjb29yZHNbIDAgXSwgY29vcmRzWyAxIF0gKTsKCXZlY3RvckZvcm1GYWN0b3IgKz0gTFRDX0VkZ2VWZWN0b3JGb3JtRmFjdG9yKCBjb29yZHNbIDEgXSwgY29vcmRzWyAyIF0gKTsKCXZlY3RvckZvcm1GYWN0b3IgKz0gTFRDX0VkZ2VWZWN0b3JGb3JtRmFjdG9yKCBjb29yZHNbIDIgXSwgY29vcmRzWyAzIF0gKTsKCXZlY3RvckZvcm1GYWN0b3IgKz0gTFRDX0VkZ2VWZWN0b3JGb3JtRmFjdG9yKCBjb29yZHNbIDMgXSwgY29vcmRzWyAwIF0gKTsKCWZsb2F0IHJlc3VsdCA9IExUQ19DbGlwcGVkU3BoZXJlRm9ybUZhY3RvciggdmVjdG9yRm9ybUZhY3RvciApOwoJcmV0dXJuIHZlYzMoIHJlc3VsdCApOwp9CiNpZiBkZWZpbmVkKCBVU0VfU0hFRU4gKQpmbG9hdCBEX0NoYXJsaWUoIGZsb2F0IHJvdWdobmVzcywgZmxvYXQgZG90TkggKSB7CglmbG9hdCBhbHBoYSA9IHBvdzIoIHJvdWdobmVzcyApOwoJZmxvYXQgaW52QWxwaGEgPSAxLjAgLyBhbHBoYTsKCWZsb2F0IGNvczJoID0gZG90TkggKiBkb3ROSDsKCWZsb2F0IHNpbjJoID0gbWF4KCAxLjAgLSBjb3MyaCwgMC4wMDc4MTI1ICk7CglyZXR1cm4gKCAyLjAgKyBpbnZBbHBoYSApICogcG93KCBzaW4yaCwgaW52QWxwaGEgKiAwLjUgKSAvICggMi4wICogUEkgKTsKfQpmbG9hdCBWX05ldWJlbHQoIGZsb2F0IGRvdE5WLCBmbG9hdCBkb3ROTCApIHsKCXJldHVybiBzYXR1cmF0ZSggMS4wIC8gKCA0LjAgKiAoIGRvdE5MICsgZG90TlYgLSBkb3ROTCAqIGRvdE5WICkgKSApOwp9CnZlYzMgQlJERl9TaGVlbiggY29uc3QgaW4gdmVjMyBsaWdodERpciwgY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgdmVjMyBzaGVlbkNvbG9yLCBjb25zdCBpbiBmbG9hdCBzaGVlblJvdWdobmVzcyApIHsKCXZlYzMgaGFsZkRpciA9IG5vcm1hbGl6ZSggbGlnaHREaXIgKyB2aWV3RGlyICk7CglmbG9hdCBkb3ROTCA9IHNhdHVyYXRlKCBkb3QoIG5vcm1hbCwgbGlnaHREaXIgKSApOwoJZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIHZpZXdEaXIgKSApOwoJZmxvYXQgZG90TkggPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGhhbGZEaXIgKSApOwoJZmxvYXQgRCA9IERfQ2hhcmxpZSggc2hlZW5Sb3VnaG5lc3MsIGRvdE5IICk7CglmbG9hdCBWID0gVl9OZXViZWx0KCBkb3ROViwgZG90TkwgKTsKCXJldHVybiBzaGVlbkNvbG9yICogKCBEICogViApOwp9CiNlbmRpZgpmbG9hdCBJQkxTaGVlbkJSREYoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcyApIHsKCWZsb2F0IGRvdE5WID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCB2aWV3RGlyICkgKTsKCWZsb2F0IHIyID0gcm91Z2huZXNzICogcm91Z2huZXNzOwoJZmxvYXQgYSA9IHJvdWdobmVzcyA8IDAuMjUgPyAtMzM5LjIgKiByMiArIDE2MS40ICogcm91Z2huZXNzIC0gMjUuOSA6IC04LjQ4ICogcjIgKyAxNC4zICogcm91Z2huZXNzIC0gOS45NTsKCWZsb2F0IGIgPSByb3VnaG5lc3MgPCAwLjI1ID8gNDQuMCAqIHIyIC0gMjMuNyAqIHJvdWdobmVzcyArIDMuMjYgOiAxLjk3ICogcjIgLSAzLjI3ICogcm91Z2huZXNzICsgMC43MjsKCWZsb2F0IERHID0gZXhwKCBhICogZG90TlYgKyBiICkgKyAoIHJvdWdobmVzcyA8IDAuMjUgPyAwLjAgOiAwLjEgKiAoIHJvdWdobmVzcyAtIDAuMjUgKSApOwoJcmV0dXJuIHNhdHVyYXRlKCBERyAqIFJFQ0lQUk9DQUxfUEkgKTsKfQp2ZWMyIERGR0FwcHJveCggY29uc3QgaW4gdmVjMyBub3JtYWwsIGNvbnN0IGluIHZlYzMgdmlld0RpciwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzICkgewoJZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIHZpZXdEaXIgKSApOwoJY29uc3QgdmVjNCBjMCA9IHZlYzQoIC0gMSwgLSAwLjAyNzUsIC0gMC41NzIsIDAuMDIyICk7Cgljb25zdCB2ZWM0IGMxID0gdmVjNCggMSwgMC4wNDI1LCAxLjA0LCAtIDAuMDQgKTsKCXZlYzQgciA9IHJvdWdobmVzcyAqIGMwICsgYzE7CglmbG9hdCBhMDA0ID0gbWluKCByLnggKiByLngsIGV4cDIoIC0gOS4yOCAqIGRvdE5WICkgKSAqIHIueCArIHIueTsKCXZlYzIgZmFiID0gdmVjMiggLSAxLjA0LCAxLjA0ICkgKiBhMDA0ICsgci56dzsKCXJldHVybiBmYWI7Cn0KdmVjMyBFbnZpcm9ubWVudEJSREYoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc3BlY3VsYXJGOTAsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcyApIHsKCXZlYzIgZmFiID0gREZHQXBwcm94KCBub3JtYWwsIHZpZXdEaXIsIHJvdWdobmVzcyApOwoJcmV0dXJuIHNwZWN1bGFyQ29sb3IgKiBmYWIueCArIHNwZWN1bGFyRjkwICogZmFiLnk7Cn0KI2lmZGVmIFVTRV9JUklERVNDRU5DRQp2b2lkIGNvbXB1dGVNdWx0aXNjYXR0ZXJpbmdJcmlkZXNjZW5jZSggY29uc3QgaW4gdmVjMyBub3JtYWwsIGNvbnN0IGluIHZlYzMgdmlld0RpciwgY29uc3QgaW4gdmVjMyBzcGVjdWxhckNvbG9yLCBjb25zdCBpbiBmbG9hdCBzcGVjdWxhckY5MCwgY29uc3QgaW4gZmxvYXQgaXJpZGVzY2VuY2UsIGNvbnN0IGluIHZlYzMgaXJpZGVzY2VuY2VGMCwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzLCBpbm91dCB2ZWMzIHNpbmdsZVNjYXR0ZXIsIGlub3V0IHZlYzMgbXVsdGlTY2F0dGVyICkgewojZWxzZQp2b2lkIGNvbXB1dGVNdWx0aXNjYXR0ZXJpbmcoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc3BlY3VsYXJGOTAsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcywgaW5vdXQgdmVjMyBzaW5nbGVTY2F0dGVyLCBpbm91dCB2ZWMzIG11bHRpU2NhdHRlciApIHsKI2VuZGlmCgl2ZWMyIGZhYiA9IERGR0FwcHJveCggbm9ybWFsLCB2aWV3RGlyLCByb3VnaG5lc3MgKTsKCSNpZmRlZiBVU0VfSVJJREVTQ0VOQ0UKCQl2ZWMzIEZyID0gbWl4KCBzcGVjdWxhckNvbG9yLCBpcmlkZXNjZW5jZUYwLCBpcmlkZXNjZW5jZSApOwoJI2Vsc2UKCQl2ZWMzIEZyID0gc3BlY3VsYXJDb2xvcjsKCSNlbmRpZgoJdmVjMyBGc3NFc3MgPSBGciAqIGZhYi54ICsgc3BlY3VsYXJGOTAgKiBmYWIueTsKCWZsb2F0IEVzcyA9IGZhYi54ICsgZmFiLnk7CglmbG9hdCBFbXMgPSAxLjAgLSBFc3M7Cgl2ZWMzIEZhdmcgPSBGciArICggMS4wIC0gRnIgKSAqIDAuMDQ3NjE5Owl2ZWMzIEZtcyA9IEZzc0VzcyAqIEZhdmcgLyAoIDEuMCAtIEVtcyAqIEZhdmcgKTsKCXNpbmdsZVNjYXR0ZXIgKz0gRnNzRXNzOwoJbXVsdGlTY2F0dGVyICs9IEZtcyAqIEVtczsKfQojaWYgTlVNX1JFQ1RfQVJFQV9MSUdIVFMgPiAwCgl2b2lkIFJFX0RpcmVjdF9SZWN0QXJlYV9QaHlzaWNhbCggY29uc3QgaW4gUmVjdEFyZWFMaWdodCByZWN0QXJlYUxpZ2h0LCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlOb3JtYWwsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlWaWV3RGlyLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBjb25zdCBpbiBQaHlzaWNhbE1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHsKCQl2ZWMzIG5vcm1hbCA9IGdlb21ldHJ5Tm9ybWFsOwoJCXZlYzMgdmlld0RpciA9IGdlb21ldHJ5Vmlld0RpcjsKCQl2ZWMzIHBvc2l0aW9uID0gZ2VvbWV0cnlQb3NpdGlvbjsKCQl2ZWMzIGxpZ2h0UG9zID0gcmVjdEFyZWFMaWdodC5wb3NpdGlvbjsKCQl2ZWMzIGhhbGZXaWR0aCA9IHJlY3RBcmVhTGlnaHQuaGFsZldpZHRoOwoJCXZlYzMgaGFsZkhlaWdodCA9IHJlY3RBcmVhTGlnaHQuaGFsZkhlaWdodDsKCQl2ZWMzIGxpZ2h0Q29sb3IgPSByZWN0QXJlYUxpZ2h0LmNvbG9yOwoJCWZsb2F0IHJvdWdobmVzcyA9IG1hdGVyaWFsLnJvdWdobmVzczsKCQl2ZWMzIHJlY3RDb29yZHNbIDQgXTsKCQlyZWN0Q29vcmRzWyAwIF0gPSBsaWdodFBvcyArIGhhbGZXaWR0aCAtIGhhbGZIZWlnaHQ7CQlyZWN0Q29vcmRzWyAxIF0gPSBsaWdodFBvcyAtIGhhbGZXaWR0aCAtIGhhbGZIZWlnaHQ7CgkJcmVjdENvb3Jkc1sgMiBdID0gbGlnaHRQb3MgLSBoYWxmV2lkdGggKyBoYWxmSGVpZ2h0OwoJCXJlY3RDb29yZHNbIDMgXSA9IGxpZ2h0UG9zICsgaGFsZldpZHRoICsgaGFsZkhlaWdodDsKCQl2ZWMyIHV2ID0gTFRDX1V2KCBub3JtYWwsIHZpZXdEaXIsIHJvdWdobmVzcyApOwoJCXZlYzQgdDEgPSB0ZXh0dXJlMkQoIGx0Y18xLCB1diApOwoJCXZlYzQgdDIgPSB0ZXh0dXJlMkQoIGx0Y18yLCB1diApOwoJCW1hdDMgbUludiA9IG1hdDMoCgkJCXZlYzMoIHQxLngsIDAsIHQxLnkgKSwKCQkJdmVjMyggICAgMCwgMSwgICAgMCApLAoJCQl2ZWMzKCB0MS56LCAwLCB0MS53ICkKCQkpOwoJCXZlYzMgZnJlc25lbCA9ICggbWF0ZXJpYWwuc3BlY3VsYXJDb2xvciAqIHQyLnggKyAoIHZlYzMoIDEuMCApIC0gbWF0ZXJpYWwuc3BlY3VsYXJDb2xvciApICogdDIueSApOwoJCXJlZmxlY3RlZExpZ2h0LmRpcmVjdFNwZWN1bGFyICs9IGxpZ2h0Q29sb3IgKiBmcmVzbmVsICogTFRDX0V2YWx1YXRlKCBub3JtYWwsIHZpZXdEaXIsIHBvc2l0aW9uLCBtSW52LCByZWN0Q29vcmRzICk7CgkJcmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArPSBsaWdodENvbG9yICogbWF0ZXJpYWwuZGlmZnVzZUNvbG9yICogTFRDX0V2YWx1YXRlKCBub3JtYWwsIHZpZXdEaXIsIHBvc2l0aW9uLCBtYXQzKCAxLjAgKSwgcmVjdENvb3JkcyApOwoJfQojZW5kaWYKdm9pZCBSRV9EaXJlY3RfUGh5c2ljYWwoIGNvbnN0IGluIEluY2lkZW50TGlnaHQgZGlyZWN0TGlnaHQsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeU5vcm1hbCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVZpZXdEaXIsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGNvbnN0IGluIFBoeXNpY2FsTWF0ZXJpYWwgbWF0ZXJpYWwsIGlub3V0IFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ICkgewoJZmxvYXQgZG90TkwgPSBzYXR1cmF0ZSggZG90KCBnZW9tZXRyeU5vcm1hbCwgZGlyZWN0TGlnaHQuZGlyZWN0aW9uICkgKTsKCXZlYzMgaXJyYWRpYW5jZSA9IGRvdE5MICogZGlyZWN0TGlnaHQuY29sb3I7CgkjaWZkZWYgVVNFX0NMRUFSQ09BVAoJCWZsb2F0IGRvdE5MY2MgPSBzYXR1cmF0ZSggZG90KCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgZGlyZWN0TGlnaHQuZGlyZWN0aW9uICkgKTsKCQl2ZWMzIGNjSXJyYWRpYW5jZSA9IGRvdE5MY2MgKiBkaXJlY3RMaWdodC5jb2xvcjsKCQljbGVhcmNvYXRTcGVjdWxhckRpcmVjdCArPSBjY0lycmFkaWFuY2UgKiBCUkRGX0dHWF9DbGVhcmNvYXQoIGRpcmVjdExpZ2h0LmRpcmVjdGlvbiwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgbWF0ZXJpYWwgKTsKCSNlbmRpZgoJI2lmZGVmIFVTRV9TSEVFTgoJCXNoZWVuU3BlY3VsYXJEaXJlY3QgKz0gaXJyYWRpYW5jZSAqIEJSREZfU2hlZW4oIGRpcmVjdExpZ2h0LmRpcmVjdGlvbiwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeU5vcm1hbCwgbWF0ZXJpYWwuc2hlZW5Db2xvciwgbWF0ZXJpYWwuc2hlZW5Sb3VnaG5lc3MgKTsKCSNlbmRpZgoJcmVmbGVjdGVkTGlnaHQuZGlyZWN0U3BlY3VsYXIgKz0gaXJyYWRpYW5jZSAqIEJSREZfR0dYKCBkaXJlY3RMaWdodC5kaXJlY3Rpb24sIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlOb3JtYWwsIG1hdGVyaWFsICk7CglyZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApOwp9CnZvaWQgUkVfSW5kaXJlY3REaWZmdXNlX1BoeXNpY2FsKCBjb25zdCBpbiB2ZWMzIGlycmFkaWFuY2UsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeU5vcm1hbCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVZpZXdEaXIsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGNvbnN0IGluIFBoeXNpY2FsTWF0ZXJpYWwgbWF0ZXJpYWwsIGlub3V0IFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ICkgewoJcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApOwp9CnZvaWQgUkVfSW5kaXJlY3RTcGVjdWxhcl9QaHlzaWNhbCggY29uc3QgaW4gdmVjMyByYWRpYW5jZSwgY29uc3QgaW4gdmVjMyBpcnJhZGlhbmNlLCBjb25zdCBpbiB2ZWMzIGNsZWFyY29hdFJhZGlhbmNlLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlOb3JtYWwsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlWaWV3RGlyLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBjb25zdCBpbiBQaHlzaWNhbE1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCkgewoJI2lmZGVmIFVTRV9DTEVBUkNPQVQKCQljbGVhcmNvYXRTcGVjdWxhckluZGlyZWN0ICs9IGNsZWFyY29hdFJhZGlhbmNlICogRW52aXJvbm1lbnRCUkRGKCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBtYXRlcmlhbC5jbGVhcmNvYXRGMCwgbWF0ZXJpYWwuY2xlYXJjb2F0RjkwLCBtYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3MgKTsKCSNlbmRpZgoJI2lmZGVmIFVTRV9TSEVFTgoJCXNoZWVuU3BlY3VsYXJJbmRpcmVjdCArPSBpcnJhZGlhbmNlICogbWF0ZXJpYWwuc2hlZW5Db2xvciAqIElCTFNoZWVuQlJERiggZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgbWF0ZXJpYWwuc2hlZW5Sb3VnaG5lc3MgKTsKCSNlbmRpZgoJdmVjMyBzaW5nbGVTY2F0dGVyaW5nID0gdmVjMyggMC4wICk7Cgl2ZWMzIG11bHRpU2NhdHRlcmluZyA9IHZlYzMoIDAuMCApOwoJdmVjMyBjb3NpbmVXZWlnaHRlZElycmFkaWFuY2UgPSBpcnJhZGlhbmNlICogUkVDSVBST0NBTF9QSTsKCSNpZmRlZiBVU0VfSVJJREVTQ0VOQ0UKCQljb21wdXRlTXVsdGlzY2F0dGVyaW5nSXJpZGVzY2VuY2UoIGdlb21ldHJ5Tm9ybWFsLCBnZW9tZXRyeVZpZXdEaXIsIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3IsIG1hdGVyaWFsLnNwZWN1bGFyRjkwLCBtYXRlcmlhbC5pcmlkZXNjZW5jZSwgbWF0ZXJpYWwuaXJpZGVzY2VuY2VGcmVzbmVsLCBtYXRlcmlhbC5yb3VnaG5lc3MsIHNpbmdsZVNjYXR0ZXJpbmcsIG11bHRpU2NhdHRlcmluZyApOwoJI2Vsc2UKCQljb21wdXRlTXVsdGlzY2F0dGVyaW5nKCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yLCBtYXRlcmlhbC5zcGVjdWxhckY5MCwgbWF0ZXJpYWwucm91Z2huZXNzLCBzaW5nbGVTY2F0dGVyaW5nLCBtdWx0aVNjYXR0ZXJpbmcgKTsKCSNlbmRpZgoJdmVjMyB0b3RhbFNjYXR0ZXJpbmcgPSBzaW5nbGVTY2F0dGVyaW5nICsgbXVsdGlTY2F0dGVyaW5nOwoJdmVjMyBkaWZmdXNlID0gbWF0ZXJpYWwuZGlmZnVzZUNvbG9yICogKCAxLjAgLSBtYXgoIG1heCggdG90YWxTY2F0dGVyaW5nLnIsIHRvdGFsU2NhdHRlcmluZy5nICksIHRvdGFsU2NhdHRlcmluZy5iICkgKTsKCXJlZmxlY3RlZExpZ2h0LmluZGlyZWN0U3BlY3VsYXIgKz0gcmFkaWFuY2UgKiBzaW5nbGVTY2F0dGVyaW5nOwoJcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3RTcGVjdWxhciArPSBtdWx0aVNjYXR0ZXJpbmcgKiBjb3NpbmVXZWlnaHRlZElycmFkaWFuY2U7CglyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gZGlmZnVzZSAqIGNvc2luZVdlaWdodGVkSXJyYWRpYW5jZTsKfQojZGVmaW5lIFJFX0RpcmVjdAkJCQlSRV9EaXJlY3RfUGh5c2ljYWwKI2RlZmluZSBSRV9EaXJlY3RfUmVjdEFyZWEJCVJFX0RpcmVjdF9SZWN0QXJlYV9QaHlzaWNhbAojZGVmaW5lIFJFX0luZGlyZWN0RGlmZnVzZQkJUkVfSW5kaXJlY3REaWZmdXNlX1BoeXNpY2FsCiNkZWZpbmUgUkVfSW5kaXJlY3RTcGVjdWxhcgkJUkVfSW5kaXJlY3RTcGVjdWxhcl9QaHlzaWNhbApmbG9hdCBjb21wdXRlU3BlY3VsYXJPY2NsdXNpb24oIGNvbnN0IGluIGZsb2F0IGRvdE5WLCBjb25zdCBpbiBmbG9hdCBhbWJpZW50T2NjbHVzaW9uLCBjb25zdCBpbiBmbG9hdCByb3VnaG5lc3MgKSB7CglyZXR1cm4gc2F0dXJhdGUoIHBvdyggZG90TlYgKyBhbWJpZW50T2NjbHVzaW9uLCBleHAyKCAtIDE2LjAgKiByb3VnaG5lc3MgLSAxLjAgKSApIC0gMS4wICsgYW1iaWVudE9jY2x1c2lvbiApOwp9YCwgV1MgPSBgCnZlYzMgZ2VvbWV0cnlQb3NpdGlvbiA9IC0gdlZpZXdQb3NpdGlvbjsKdmVjMyBnZW9tZXRyeU5vcm1hbCA9IG5vcm1hbDsKdmVjMyBnZW9tZXRyeVZpZXdEaXIgPSAoIGlzT3J0aG9ncmFwaGljICkgPyB2ZWMzKCAwLCAwLCAxICkgOiBub3JtYWxpemUoIHZWaWV3UG9zaXRpb24gKTsKdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCA9IHZlYzMoIDAuMCApOwojaWZkZWYgVVNFX0NMRUFSQ09BVAoJZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwgPSBjbGVhcmNvYXROb3JtYWw7CiNlbmRpZgojaWZkZWYgVVNFX0lSSURFU0NFTkNFCglmbG9hdCBkb3ROVmkgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGdlb21ldHJ5Vmlld0RpciApICk7CglpZiAoIG1hdGVyaWFsLmlyaWRlc2NlbmNlVGhpY2tuZXNzID09IDAuMCApIHsKCQltYXRlcmlhbC5pcmlkZXNjZW5jZSA9IDAuMDsKCX0gZWxzZSB7CgkJbWF0ZXJpYWwuaXJpZGVzY2VuY2UgPSBzYXR1cmF0ZSggbWF0ZXJpYWwuaXJpZGVzY2VuY2UgKTsKCX0KCWlmICggbWF0ZXJpYWwuaXJpZGVzY2VuY2UgPiAwLjAgKSB7CgkJbWF0ZXJpYWwuaXJpZGVzY2VuY2VGcmVzbmVsID0gZXZhbElyaWRlc2NlbmNlKCAxLjAsIG1hdGVyaWFsLmlyaWRlc2NlbmNlSU9SLCBkb3ROVmksIG1hdGVyaWFsLmlyaWRlc2NlbmNlVGhpY2tuZXNzLCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yICk7CgkJbWF0ZXJpYWwuaXJpZGVzY2VuY2VGMCA9IFNjaGxpY2tfdG9fRjAoIG1hdGVyaWFsLmlyaWRlc2NlbmNlRnJlc25lbCwgMS4wLCBkb3ROVmkgKTsKCX0KI2VuZGlmCkluY2lkZW50TGlnaHQgZGlyZWN0TGlnaHQ7CiNpZiAoIE5VTV9QT0lOVF9MSUdIVFMgPiAwICkgJiYgZGVmaW5lZCggUkVfRGlyZWN0ICkKCVBvaW50TGlnaHQgcG9pbnRMaWdodDsKCSNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQICkgJiYgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MgPiAwCglQb2ludExpZ2h0U2hhZG93IHBvaW50TGlnaHRTaGFkb3c7CgkjZW5kaWYKCSNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnQKCWZvciAoIGludCBpID0gMDsgaSA8IE5VTV9QT0lOVF9MSUdIVFM7IGkgKysgKSB7CgkJcG9pbnRMaWdodCA9IHBvaW50TGlnaHRzWyBpIF07CgkJZ2V0UG9pbnRMaWdodEluZm8oIHBvaW50TGlnaHQsIGdlb21ldHJ5UG9zaXRpb24sIGRpcmVjdExpZ2h0ICk7CgkJI2lmIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiAoIFVOUk9MTEVEX0xPT1BfSU5ERVggPCBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyApCgkJcG9pbnRMaWdodFNoYWRvdyA9IHBvaW50TGlnaHRTaGFkb3dzWyBpIF07CgkJZGlyZWN0TGlnaHQuY29sb3IgKj0gKCBkaXJlY3RMaWdodC52aXNpYmxlICYmIHJlY2VpdmVTaGFkb3cgKSA/IGdldFBvaW50U2hhZG93KCBwb2ludFNoYWRvd01hcFsgaSBdLCBwb2ludExpZ2h0U2hhZG93LnNoYWRvd01hcFNpemUsIHBvaW50TGlnaHRTaGFkb3cuc2hhZG93SW50ZW5zaXR5LCBwb2ludExpZ2h0U2hhZG93LnNoYWRvd0JpYXMsIHBvaW50TGlnaHRTaGFkb3cuc2hhZG93UmFkaXVzLCB2UG9pbnRTaGFkb3dDb29yZFsgaSBdLCBwb2ludExpZ2h0U2hhZG93LnNoYWRvd0NhbWVyYU5lYXIsIHBvaW50TGlnaHRTaGFkb3cuc2hhZG93Q2FtZXJhRmFyICkgOiAxLjA7CgkJI2VuZGlmCgkJUkVfRGlyZWN0KCBkaXJlY3RMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLCByZWZsZWN0ZWRMaWdodCApOwoJfQoJI3ByYWdtYSB1bnJvbGxfbG9vcF9lbmQKI2VuZGlmCiNpZiAoIE5VTV9TUE9UX0xJR0hUUyA+IDAgKSAmJiBkZWZpbmVkKCBSRV9EaXJlY3QgKQoJU3BvdExpZ2h0IHNwb3RMaWdodDsKCXZlYzQgc3BvdENvbG9yOwoJdmVjMyBzcG90TGlnaHRDb29yZDsKCWJvb2wgaW5TcG90TGlnaHRNYXA7CgkjaWYgZGVmaW5lZCggVVNFX1NIQURPV01BUCApICYmIE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgPiAwCglTcG90TGlnaHRTaGFkb3cgc3BvdExpZ2h0U2hhZG93OwoJI2VuZGlmCgkjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0Cglmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fU1BPVF9MSUdIVFM7IGkgKysgKSB7CgkJc3BvdExpZ2h0ID0gc3BvdExpZ2h0c1sgaSBdOwoJCWdldFNwb3RMaWdodEluZm8oIHNwb3RMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZGlyZWN0TGlnaHQgKTsKCQkjaWYgKCBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfU0hBRE9XU19XSVRIX01BUFMgKQoJCSNkZWZpbmUgU1BPVF9MSUdIVF9NQVBfSU5ERVggVU5ST0xMRURfTE9PUF9JTkRFWAoJCSNlbGlmICggVU5ST0xMRURfTE9PUF9JTkRFWCA8IE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgKQoJCSNkZWZpbmUgU1BPVF9MSUdIVF9NQVBfSU5ERVggTlVNX1NQT1RfTElHSFRfTUFQUwoJCSNlbHNlCgkJI2RlZmluZSBTUE9UX0xJR0hUX01BUF9JTkRFWCAoIFVOUk9MTEVEX0xPT1BfSU5ERVggLSBOVU1fU1BPVF9MSUdIVF9TSEFET1dTICsgTlVNX1NQT1RfTElHSFRfU0hBRE9XU19XSVRIX01BUFMgKQoJCSNlbmRpZgoJCSNpZiAoIFNQT1RfTElHSFRfTUFQX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfTUFQUyApCgkJCXNwb3RMaWdodENvb3JkID0gdlNwb3RMaWdodENvb3JkWyBpIF0ueHl6IC8gdlNwb3RMaWdodENvb3JkWyBpIF0udzsKCQkJaW5TcG90TGlnaHRNYXAgPSBhbGwoIGxlc3NUaGFuKCBhYnMoIHNwb3RMaWdodENvb3JkICogMi4gLSAxLiApLCB2ZWMzKCAxLjAgKSApICk7CgkJCXNwb3RDb2xvciA9IHRleHR1cmUyRCggc3BvdExpZ2h0TWFwWyBTUE9UX0xJR0hUX01BUF9JTkRFWCBdLCBzcG90TGlnaHRDb29yZC54eSApOwoJCQlkaXJlY3RMaWdodC5jb2xvciA9IGluU3BvdExpZ2h0TWFwID8gZGlyZWN0TGlnaHQuY29sb3IgKiBzcG90Q29sb3IucmdiIDogZGlyZWN0TGlnaHQuY29sb3I7CgkJI2VuZGlmCgkJI3VuZGVmIFNQT1RfTElHSFRfTUFQX0lOREVYCgkJI2lmIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiAoIFVOUk9MTEVEX0xPT1BfSU5ERVggPCBOVU1fU1BPVF9MSUdIVF9TSEFET1dTICkKCQlzcG90TGlnaHRTaGFkb3cgPSBzcG90TGlnaHRTaGFkb3dzWyBpIF07CgkJZGlyZWN0TGlnaHQuY29sb3IgKj0gKCBkaXJlY3RMaWdodC52aXNpYmxlICYmIHJlY2VpdmVTaGFkb3cgKSA/IGdldFNoYWRvdyggc3BvdFNoYWRvd01hcFsgaSBdLCBzcG90TGlnaHRTaGFkb3cuc2hhZG93TWFwU2l6ZSwgc3BvdExpZ2h0U2hhZG93LnNoYWRvd0ludGVuc2l0eSwgc3BvdExpZ2h0U2hhZG93LnNoYWRvd0JpYXMsIHNwb3RMaWdodFNoYWRvdy5zaGFkb3dSYWRpdXMsIHZTcG90TGlnaHRDb29yZFsgaSBdICkgOiAxLjA7CgkJI2VuZGlmCgkJUkVfRGlyZWN0KCBkaXJlY3RMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLCByZWZsZWN0ZWRMaWdodCApOwoJfQoJI3ByYWdtYSB1bnJvbGxfbG9vcF9lbmQKI2VuZGlmCiNpZiAoIE5VTV9ESVJfTElHSFRTID4gMCApICYmIGRlZmluZWQoIFJFX0RpcmVjdCApCglEaXJlY3Rpb25hbExpZ2h0IGRpcmVjdGlvbmFsTGlnaHQ7CgkjaWYgZGVmaW5lZCggVVNFX1NIQURPV01BUCApICYmIE5VTV9ESVJfTElHSFRfU0hBRE9XUyA+IDAKCURpcmVjdGlvbmFsTGlnaHRTaGFkb3cgZGlyZWN0aW9uYWxMaWdodFNoYWRvdzsKCSNlbmRpZgoJI3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydAoJZm9yICggaW50IGkgPSAwOyBpIDwgTlVNX0RJUl9MSUdIVFM7IGkgKysgKSB7CgkJZGlyZWN0aW9uYWxMaWdodCA9IGRpcmVjdGlvbmFsTGlnaHRzWyBpIF07CgkJZ2V0RGlyZWN0aW9uYWxMaWdodEluZm8oIGRpcmVjdGlvbmFsTGlnaHQsIGRpcmVjdExpZ2h0ICk7CgkJI2lmIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiAoIFVOUk9MTEVEX0xPT1BfSU5ERVggPCBOVU1fRElSX0xJR0hUX1NIQURPV1MgKQoJCWRpcmVjdGlvbmFsTGlnaHRTaGFkb3cgPSBkaXJlY3Rpb25hbExpZ2h0U2hhZG93c1sgaSBdOwoJCWRpcmVjdExpZ2h0LmNvbG9yICo9ICggZGlyZWN0TGlnaHQudmlzaWJsZSAmJiByZWNlaXZlU2hhZG93ICkgPyBnZXRTaGFkb3coIGRpcmVjdGlvbmFsU2hhZG93TWFwWyBpIF0sIGRpcmVjdGlvbmFsTGlnaHRTaGFkb3cuc2hhZG93TWFwU2l6ZSwgZGlyZWN0aW9uYWxMaWdodFNoYWRvdy5zaGFkb3dJbnRlbnNpdHksIGRpcmVjdGlvbmFsTGlnaHRTaGFkb3cuc2hhZG93QmlhcywgZGlyZWN0aW9uYWxMaWdodFNoYWRvdy5zaGFkb3dSYWRpdXMsIHZEaXJlY3Rpb25hbFNoYWRvd0Nvb3JkWyBpIF0gKSA6IDEuMDsKCQkjZW5kaWYKCQlSRV9EaXJlY3QoIGRpcmVjdExpZ2h0LCBnZW9tZXRyeVBvc2l0aW9uLCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgbWF0ZXJpYWwsIHJlZmxlY3RlZExpZ2h0ICk7Cgl9CgkjcHJhZ21hIHVucm9sbF9sb29wX2VuZAojZW5kaWYKI2lmICggTlVNX1JFQ1RfQVJFQV9MSUdIVFMgPiAwICkgJiYgZGVmaW5lZCggUkVfRGlyZWN0X1JlY3RBcmVhICkKCVJlY3RBcmVhTGlnaHQgcmVjdEFyZWFMaWdodDsKCSNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnQKCWZvciAoIGludCBpID0gMDsgaSA8IE5VTV9SRUNUX0FSRUFfTElHSFRTOyBpICsrICkgewoJCXJlY3RBcmVhTGlnaHQgPSByZWN0QXJlYUxpZ2h0c1sgaSBdOwoJCVJFX0RpcmVjdF9SZWN0QXJlYSggcmVjdEFyZWFMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLCByZWZsZWN0ZWRMaWdodCApOwoJfQoJI3ByYWdtYSB1bnJvbGxfbG9vcF9lbmQKI2VuZGlmCiNpZiBkZWZpbmVkKCBSRV9JbmRpcmVjdERpZmZ1c2UgKQoJdmVjMyBpYmxJcnJhZGlhbmNlID0gdmVjMyggMC4wICk7Cgl2ZWMzIGlycmFkaWFuY2UgPSBnZXRBbWJpZW50TGlnaHRJcnJhZGlhbmNlKCBhbWJpZW50TGlnaHRDb2xvciApOwoJI2lmIGRlZmluZWQoIFVTRV9MSUdIVF9QUk9CRVMgKQoJCWlycmFkaWFuY2UgKz0gZ2V0TGlnaHRQcm9iZUlycmFkaWFuY2UoIGxpZ2h0UHJvYmUsIGdlb21ldHJ5Tm9ybWFsICk7CgkjZW5kaWYKCSNpZiAoIE5VTV9IRU1JX0xJR0hUUyA+IDAgKQoJCSNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnQKCQlmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fSEVNSV9MSUdIVFM7IGkgKysgKSB7CgkJCWlycmFkaWFuY2UgKz0gZ2V0SGVtaXNwaGVyZUxpZ2h0SXJyYWRpYW5jZSggaGVtaXNwaGVyZUxpZ2h0c1sgaSBdLCBnZW9tZXRyeU5vcm1hbCApOwoJCX0KCQkjcHJhZ21hIHVucm9sbF9sb29wX2VuZAoJI2VuZGlmCiNlbmRpZgojaWYgZGVmaW5lZCggUkVfSW5kaXJlY3RTcGVjdWxhciApCgl2ZWMzIHJhZGlhbmNlID0gdmVjMyggMC4wICk7Cgl2ZWMzIGNsZWFyY29hdFJhZGlhbmNlID0gdmVjMyggMC4wICk7CiNlbmRpZmAsIHFTID0gYCNpZiBkZWZpbmVkKCBSRV9JbmRpcmVjdERpZmZ1c2UgKQoJI2lmZGVmIFVTRV9MSUdIVE1BUAoJCXZlYzQgbGlnaHRNYXBUZXhlbCA9IHRleHR1cmUyRCggbGlnaHRNYXAsIHZMaWdodE1hcFV2ICk7CgkJdmVjMyBsaWdodE1hcElycmFkaWFuY2UgPSBsaWdodE1hcFRleGVsLnJnYiAqIGxpZ2h0TWFwSW50ZW5zaXR5OwoJCWlycmFkaWFuY2UgKz0gbGlnaHRNYXBJcnJhZGlhbmNlOwoJI2VuZGlmCgkjaWYgZGVmaW5lZCggVVNFX0VOVk1BUCApICYmIGRlZmluZWQoIFNUQU5EQVJEICkgJiYgZGVmaW5lZCggRU5WTUFQX1RZUEVfQ1VCRV9VViApCgkJaWJsSXJyYWRpYW5jZSArPSBnZXRJQkxJcnJhZGlhbmNlKCBnZW9tZXRyeU5vcm1hbCApOwoJI2VuZGlmCiNlbmRpZgojaWYgZGVmaW5lZCggVVNFX0VOVk1BUCApICYmIGRlZmluZWQoIFJFX0luZGlyZWN0U3BlY3VsYXIgKQoJI2lmZGVmIFVTRV9BTklTT1RST1BZCgkJcmFkaWFuY2UgKz0gZ2V0SUJMQW5pc290cm9weVJhZGlhbmNlKCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Tm9ybWFsLCBtYXRlcmlhbC5yb3VnaG5lc3MsIG1hdGVyaWFsLmFuaXNvdHJvcHlCLCBtYXRlcmlhbC5hbmlzb3Ryb3B5ICk7CgkjZWxzZQoJCXJhZGlhbmNlICs9IGdldElCTFJhZGlhbmNlKCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Tm9ybWFsLCBtYXRlcmlhbC5yb3VnaG5lc3MgKTsKCSNlbmRpZgoJI2lmZGVmIFVTRV9DTEVBUkNPQVQKCQljbGVhcmNvYXRSYWRpYW5jZSArPSBnZXRJQkxSYWRpYW5jZSggZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzICk7CgkjZW5kaWYKI2VuZGlmYCwgJFMgPSBgI2lmIGRlZmluZWQoIFJFX0luZGlyZWN0RGlmZnVzZSApCglSRV9JbmRpcmVjdERpZmZ1c2UoIGlycmFkaWFuY2UsIGdlb21ldHJ5UG9zaXRpb24sIGdlb21ldHJ5Tm9ybWFsLCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBtYXRlcmlhbCwgcmVmbGVjdGVkTGlnaHQgKTsKI2VuZGlmCiNpZiBkZWZpbmVkKCBSRV9JbmRpcmVjdFNwZWN1bGFyICkKCVJFX0luZGlyZWN0U3BlY3VsYXIoIHJhZGlhbmNlLCBpYmxJcnJhZGlhbmNlLCBjbGVhcmNvYXRSYWRpYW5jZSwgZ2VvbWV0cnlQb3NpdGlvbiwgZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLCByZWZsZWN0ZWRMaWdodCApOwojZW5kaWZgLCBYUyA9IGAjaWYgZGVmaW5lZCggVVNFX0xPR0FSSVRITUlDX0RFUFRIX0JVRkZFUiApCglnbF9GcmFnRGVwdGggPSB2SXNQZXJzcGVjdGl2ZSA9PSAwLjAgPyBnbF9GcmFnQ29vcmQueiA6IGxvZzIoIHZGcmFnRGVwdGggKSAqIGxvZ0RlcHRoQnVmRkMgKiAwLjU7CiNlbmRpZmAsIFlTID0gYCNpZiBkZWZpbmVkKCBVU0VfTE9HQVJJVEhNSUNfREVQVEhfQlVGRkVSICkKCXVuaWZvcm0gZmxvYXQgbG9nRGVwdGhCdWZGQzsKCXZhcnlpbmcgZmxvYXQgdkZyYWdEZXB0aDsKCXZhcnlpbmcgZmxvYXQgdklzUGVyc3BlY3RpdmU7CiNlbmRpZmAsIFpTID0gYCNpZmRlZiBVU0VfTE9HQVJJVEhNSUNfREVQVEhfQlVGRkVSCgl2YXJ5aW5nIGZsb2F0IHZGcmFnRGVwdGg7Cgl2YXJ5aW5nIGZsb2F0IHZJc1BlcnNwZWN0aXZlOwojZW5kaWZgLCBqUyA9IGAjaWZkZWYgVVNFX0xPR0FSSVRITUlDX0RFUFRIX0JVRkZFUgoJdkZyYWdEZXB0aCA9IDEuMCArIGdsX1Bvc2l0aW9uLnc7Cgl2SXNQZXJzcGVjdGl2ZSA9IGZsb2F0KCBpc1BlcnNwZWN0aXZlTWF0cml4KCBwcm9qZWN0aW9uTWF0cml4ICkgKTsKI2VuZGlmYCwgSlMgPSBgI2lmZGVmIFVTRV9NQVAKCXZlYzQgc2FtcGxlZERpZmZ1c2VDb2xvciA9IHRleHR1cmUyRCggbWFwLCB2TWFwVXYgKTsKCSNpZmRlZiBERUNPREVfVklERU9fVEVYVFVSRQoJCXNhbXBsZWREaWZmdXNlQ29sb3IgPSBzUkdCVHJhbnNmZXJFT1RGKCBzYW1wbGVkRGlmZnVzZUNvbG9yICk7CgkjZW5kaWYKCWRpZmZ1c2VDb2xvciAqPSBzYW1wbGVkRGlmZnVzZUNvbG9yOwojZW5kaWZgLCBLUyA9IGAjaWZkZWYgVVNFX01BUAoJdW5pZm9ybSBzYW1wbGVyMkQgbWFwOwojZW5kaWZgLCBRUyA9IGAjaWYgZGVmaW5lZCggVVNFX01BUCApIHx8IGRlZmluZWQoIFVTRV9BTFBIQU1BUCApCgkjaWYgZGVmaW5lZCggVVNFX1BPSU5UU19VViApCgkJdmVjMiB1diA9IHZVdjsKCSNlbHNlCgkJdmVjMiB1diA9ICggdXZUcmFuc2Zvcm0gKiB2ZWMzKCBnbF9Qb2ludENvb3JkLngsIDEuMCAtIGdsX1BvaW50Q29vcmQueSwgMSApICkueHk7CgkjZW5kaWYKI2VuZGlmCiNpZmRlZiBVU0VfTUFQCglkaWZmdXNlQ29sb3IgKj0gdGV4dHVyZTJEKCBtYXAsIHV2ICk7CiNlbmRpZgojaWZkZWYgVVNFX0FMUEhBTUFQCglkaWZmdXNlQ29sb3IuYSAqPSB0ZXh0dXJlMkQoIGFscGhhTWFwLCB1diApLmc7CiNlbmRpZmAsIHQxID0gYCNpZiBkZWZpbmVkKCBVU0VfUE9JTlRTX1VWICkKCXZhcnlpbmcgdmVjMiB2VXY7CiNlbHNlCgkjaWYgZGVmaW5lZCggVVNFX01BUCApIHx8IGRlZmluZWQoIFVTRV9BTFBIQU1BUCApCgkJdW5pZm9ybSBtYXQzIHV2VHJhbnNmb3JtOwoJI2VuZGlmCiNlbmRpZgojaWZkZWYgVVNFX01BUAoJdW5pZm9ybSBzYW1wbGVyMkQgbWFwOwojZW5kaWYKI2lmZGVmIFVTRV9BTFBIQU1BUAoJdW5pZm9ybSBzYW1wbGVyMkQgYWxwaGFNYXA7CiNlbmRpZmAsIGUxID0gYGZsb2F0IG1ldGFsbmVzc0ZhY3RvciA9IG1ldGFsbmVzczsKI2lmZGVmIFVTRV9NRVRBTE5FU1NNQVAKCXZlYzQgdGV4ZWxNZXRhbG5lc3MgPSB0ZXh0dXJlMkQoIG1ldGFsbmVzc01hcCwgdk1ldGFsbmVzc01hcFV2ICk7CgltZXRhbG5lc3NGYWN0b3IgKj0gdGV4ZWxNZXRhbG5lc3MuYjsKI2VuZGlmYCwgaTEgPSBgI2lmZGVmIFVTRV9NRVRBTE5FU1NNQVAKCXVuaWZvcm0gc2FtcGxlcjJEIG1ldGFsbmVzc01hcDsKI2VuZGlmYCwgbjEgPSBgI2lmZGVmIFVTRV9JTlNUQU5DSU5HX01PUlBICglmbG9hdCBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIE1PUlBIVEFSR0VUU19DT1VOVCBdOwoJZmxvYXQgbW9ycGhUYXJnZXRCYXNlSW5mbHVlbmNlID0gdGV4ZWxGZXRjaCggbW9ycGhUZXh0dXJlLCBpdmVjMiggMCwgZ2xfSW5zdGFuY2VJRCApLCAwICkucjsKCWZvciAoIGludCBpID0gMDsgaSA8IE1PUlBIVEFSR0VUU19DT1VOVDsgaSArKyApIHsKCQltb3JwaFRhcmdldEluZmx1ZW5jZXNbaV0gPSAgdGV4ZWxGZXRjaCggbW9ycGhUZXh0dXJlLCBpdmVjMiggaSArIDEsIGdsX0luc3RhbmNlSUQgKSwgMCApLnI7Cgl9CiNlbmRpZmAsIHMxID0gYCNpZiBkZWZpbmVkKCBVU0VfTU9SUEhDT0xPUlMgKQoJdkNvbG9yICo9IG1vcnBoVGFyZ2V0QmFzZUluZmx1ZW5jZTsKCWZvciAoIGludCBpID0gMDsgaSA8IE1PUlBIVEFSR0VUU19DT1VOVDsgaSArKyApIHsKCQkjaWYgZGVmaW5lZCggVVNFX0NPTE9SX0FMUEhBICkKCQkJaWYgKCBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXSAhPSAwLjAgKSB2Q29sb3IgKz0gZ2V0TW9ycGgoIGdsX1ZlcnRleElELCBpLCAyICkgKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXTsKCQkjZWxpZiBkZWZpbmVkKCBVU0VfQ09MT1IgKQoJCQlpZiAoIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgaSBdICE9IDAuMCApIHZDb2xvciArPSBnZXRNb3JwaCggZ2xfVmVydGV4SUQsIGksIDIgKS5yZ2IgKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXTsKCQkjZW5kaWYKCX0KI2VuZGlmYCwgcjEgPSBgI2lmZGVmIFVTRV9NT1JQSE5PUk1BTFMKCW9iamVjdE5vcm1hbCAqPSBtb3JwaFRhcmdldEJhc2VJbmZsdWVuY2U7Cglmb3IgKCBpbnQgaSA9IDA7IGkgPCBNT1JQSFRBUkdFVFNfQ09VTlQ7IGkgKysgKSB7CgkJaWYgKCBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXSAhPSAwLjAgKSBvYmplY3ROb3JtYWwgKz0gZ2V0TW9ycGgoIGdsX1ZlcnRleElELCBpLCAxICkueHl6ICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyBpIF07Cgl9CiNlbmRpZmAsIGExID0gYCNpZmRlZiBVU0VfTU9SUEhUQVJHRVRTCgkjaWZuZGVmIFVTRV9JTlNUQU5DSU5HX01PUlBICgkJdW5pZm9ybSBmbG9hdCBtb3JwaFRhcmdldEJhc2VJbmZsdWVuY2U7CgkJdW5pZm9ybSBmbG9hdCBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIE1PUlBIVEFSR0VUU19DT1VOVCBdOwoJI2VuZGlmCgl1bmlmb3JtIHNhbXBsZXIyREFycmF5IG1vcnBoVGFyZ2V0c1RleHR1cmU7Cgl1bmlmb3JtIGl2ZWMyIG1vcnBoVGFyZ2V0c1RleHR1cmVTaXplOwoJdmVjNCBnZXRNb3JwaCggY29uc3QgaW4gaW50IHZlcnRleEluZGV4LCBjb25zdCBpbiBpbnQgbW9ycGhUYXJnZXRJbmRleCwgY29uc3QgaW4gaW50IG9mZnNldCApIHsKCQlpbnQgdGV4ZWxJbmRleCA9IHZlcnRleEluZGV4ICogTU9SUEhUQVJHRVRTX1RFWFRVUkVfU1RSSURFICsgb2Zmc2V0OwoJCWludCB5ID0gdGV4ZWxJbmRleCAvIG1vcnBoVGFyZ2V0c1RleHR1cmVTaXplLng7CgkJaW50IHggPSB0ZXhlbEluZGV4IC0geSAqIG1vcnBoVGFyZ2V0c1RleHR1cmVTaXplLng7CgkJaXZlYzMgbW9ycGhVViA9IGl2ZWMzKCB4LCB5LCBtb3JwaFRhcmdldEluZGV4ICk7CgkJcmV0dXJuIHRleGVsRmV0Y2goIG1vcnBoVGFyZ2V0c1RleHR1cmUsIG1vcnBoVVYsIDAgKTsKCX0KI2VuZGlmYCwgbzEgPSBgI2lmZGVmIFVTRV9NT1JQSFRBUkdFVFMKCXRyYW5zZm9ybWVkICo9IG1vcnBoVGFyZ2V0QmFzZUluZmx1ZW5jZTsKCWZvciAoIGludCBpID0gMDsgaSA8IE1PUlBIVEFSR0VUU19DT1VOVDsgaSArKyApIHsKCQlpZiAoIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgaSBdICE9IDAuMCApIHRyYW5zZm9ybWVkICs9IGdldE1vcnBoKCBnbF9WZXJ0ZXhJRCwgaSwgMCApLnh5eiAqIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgaSBdOwoJfQojZW5kaWZgLCBsMSA9IGBmbG9hdCBmYWNlRGlyZWN0aW9uID0gZ2xfRnJvbnRGYWNpbmcgPyAxLjAgOiAtIDEuMDsKI2lmZGVmIEZMQVRfU0hBREVECgl2ZWMzIGZkeCA9IGRGZHgoIHZWaWV3UG9zaXRpb24gKTsKCXZlYzMgZmR5ID0gZEZkeSggdlZpZXdQb3NpdGlvbiApOwoJdmVjMyBub3JtYWwgPSBub3JtYWxpemUoIGNyb3NzKCBmZHgsIGZkeSApICk7CiNlbHNlCgl2ZWMzIG5vcm1hbCA9IG5vcm1hbGl6ZSggdk5vcm1hbCApOwoJI2lmZGVmIERPVUJMRV9TSURFRAoJCW5vcm1hbCAqPSBmYWNlRGlyZWN0aW9uOwoJI2VuZGlmCiNlbmRpZgojaWYgZGVmaW5lZCggVVNFX05PUk1BTE1BUF9UQU5HRU5UU1BBQ0UgKSB8fCBkZWZpbmVkKCBVU0VfQ0xFQVJDT0FUX05PUk1BTE1BUCApIHx8IGRlZmluZWQoIFVTRV9BTklTT1RST1BZICkKCSNpZmRlZiBVU0VfVEFOR0VOVAoJCW1hdDMgdGJuID0gbWF0Myggbm9ybWFsaXplKCB2VGFuZ2VudCApLCBub3JtYWxpemUoIHZCaXRhbmdlbnQgKSwgbm9ybWFsICk7CgkjZWxzZQoJCW1hdDMgdGJuID0gZ2V0VGFuZ2VudEZyYW1lKCAtIHZWaWV3UG9zaXRpb24sIG5vcm1hbCwKCQkjaWYgZGVmaW5lZCggVVNFX05PUk1BTE1BUCApCgkJCXZOb3JtYWxNYXBVdgoJCSNlbGlmIGRlZmluZWQoIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQICkKCQkJdkNsZWFyY29hdE5vcm1hbE1hcFV2CgkJI2Vsc2UKCQkJdlV2CgkJI2VuZGlmCgkJKTsKCSNlbmRpZgoJI2lmIGRlZmluZWQoIERPVUJMRV9TSURFRCApICYmICEgZGVmaW5lZCggRkxBVF9TSEFERUQgKQoJCXRiblswXSAqPSBmYWNlRGlyZWN0aW9uOwoJCXRiblsxXSAqPSBmYWNlRGlyZWN0aW9uOwoJI2VuZGlmCiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVAKCSNpZmRlZiBVU0VfVEFOR0VOVAoJCW1hdDMgdGJuMiA9IG1hdDMoIG5vcm1hbGl6ZSggdlRhbmdlbnQgKSwgbm9ybWFsaXplKCB2Qml0YW5nZW50ICksIG5vcm1hbCApOwoJI2Vsc2UKCQltYXQzIHRibjIgPSBnZXRUYW5nZW50RnJhbWUoIC0gdlZpZXdQb3NpdGlvbiwgbm9ybWFsLCB2Q2xlYXJjb2F0Tm9ybWFsTWFwVXYgKTsKCSNlbmRpZgoJI2lmIGRlZmluZWQoIERPVUJMRV9TSURFRCApICYmICEgZGVmaW5lZCggRkxBVF9TSEFERUQgKQoJCXRibjJbMF0gKj0gZmFjZURpcmVjdGlvbjsKCQl0Ym4yWzFdICo9IGZhY2VEaXJlY3Rpb247CgkjZW5kaWYKI2VuZGlmCnZlYzMgbm9uUGVydHVyYmVkTm9ybWFsID0gbm9ybWFsO2AsIGgxID0gYCNpZmRlZiBVU0VfTk9STUFMTUFQX09CSkVDVFNQQUNFCglub3JtYWwgPSB0ZXh0dXJlMkQoIG5vcm1hbE1hcCwgdk5vcm1hbE1hcFV2ICkueHl6ICogMi4wIC0gMS4wOwoJI2lmZGVmIEZMSVBfU0lERUQKCQlub3JtYWwgPSAtIG5vcm1hbDsKCSNlbmRpZgoJI2lmZGVmIERPVUJMRV9TSURFRAoJCW5vcm1hbCA9IG5vcm1hbCAqIGZhY2VEaXJlY3Rpb247CgkjZW5kaWYKCW5vcm1hbCA9IG5vcm1hbGl6ZSggbm9ybWFsTWF0cml4ICogbm9ybWFsICk7CiNlbGlmIGRlZmluZWQoIFVTRV9OT1JNQUxNQVBfVEFOR0VOVFNQQUNFICkKCXZlYzMgbWFwTiA9IHRleHR1cmUyRCggbm9ybWFsTWFwLCB2Tm9ybWFsTWFwVXYgKS54eXogKiAyLjAgLSAxLjA7CgltYXBOLnh5ICo9IG5vcm1hbFNjYWxlOwoJbm9ybWFsID0gbm9ybWFsaXplKCB0Ym4gKiBtYXBOICk7CiNlbGlmIGRlZmluZWQoIFVTRV9CVU1QTUFQICkKCW5vcm1hbCA9IHBlcnR1cmJOb3JtYWxBcmIoIC0gdlZpZXdQb3NpdGlvbiwgbm9ybWFsLCBkSGR4eV9md2QoKSwgZmFjZURpcmVjdGlvbiApOwojZW5kaWZgLCBjMSA9IGAjaWZuZGVmIEZMQVRfU0hBREVECgl2YXJ5aW5nIHZlYzMgdk5vcm1hbDsKCSNpZmRlZiBVU0VfVEFOR0VOVAoJCXZhcnlpbmcgdmVjMyB2VGFuZ2VudDsKCQl2YXJ5aW5nIHZlYzMgdkJpdGFuZ2VudDsKCSNlbmRpZgojZW5kaWZgLCB1MSA9IGAjaWZuZGVmIEZMQVRfU0hBREVECgl2YXJ5aW5nIHZlYzMgdk5vcm1hbDsKCSNpZmRlZiBVU0VfVEFOR0VOVAoJCXZhcnlpbmcgdmVjMyB2VGFuZ2VudDsKCQl2YXJ5aW5nIHZlYzMgdkJpdGFuZ2VudDsKCSNlbmRpZgojZW5kaWZgLCBkMSA9IGAjaWZuZGVmIEZMQVRfU0hBREVECgl2Tm9ybWFsID0gbm9ybWFsaXplKCB0cmFuc2Zvcm1lZE5vcm1hbCApOwoJI2lmZGVmIFVTRV9UQU5HRU5UCgkJdlRhbmdlbnQgPSBub3JtYWxpemUoIHRyYW5zZm9ybWVkVGFuZ2VudCApOwoJCXZCaXRhbmdlbnQgPSBub3JtYWxpemUoIGNyb3NzKCB2Tm9ybWFsLCB2VGFuZ2VudCApICogdGFuZ2VudC53ICk7CgkjZW5kaWYKI2VuZGlmYCwgcDEgPSBgI2lmZGVmIFVTRV9OT1JNQUxNQVAKCXVuaWZvcm0gc2FtcGxlcjJEIG5vcm1hbE1hcDsKCXVuaWZvcm0gdmVjMiBub3JtYWxTY2FsZTsKI2VuZGlmCiNpZmRlZiBVU0VfTk9STUFMTUFQX09CSkVDVFNQQUNFCgl1bmlmb3JtIG1hdDMgbm9ybWFsTWF0cml4OwojZW5kaWYKI2lmICEgZGVmaW5lZCAoIFVTRV9UQU5HRU5UICkgJiYgKCBkZWZpbmVkICggVVNFX05PUk1BTE1BUF9UQU5HRU5UU1BBQ0UgKSB8fCBkZWZpbmVkICggVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVAgKSB8fCBkZWZpbmVkKCBVU0VfQU5JU09UUk9QWSApICkKCW1hdDMgZ2V0VGFuZ2VudEZyYW1lKCB2ZWMzIGV5ZV9wb3MsIHZlYzMgc3VyZl9ub3JtLCB2ZWMyIHV2ICkgewoJCXZlYzMgcTAgPSBkRmR4KCBleWVfcG9zLnh5eiApOwoJCXZlYzMgcTEgPSBkRmR5KCBleWVfcG9zLnh5eiApOwoJCXZlYzIgc3QwID0gZEZkeCggdXYuc3QgKTsKCQl2ZWMyIHN0MSA9IGRGZHkoIHV2LnN0ICk7CgkJdmVjMyBOID0gc3VyZl9ub3JtOwoJCXZlYzMgcTFwZXJwID0gY3Jvc3MoIHExLCBOICk7CgkJdmVjMyBxMHBlcnAgPSBjcm9zcyggTiwgcTAgKTsKCQl2ZWMzIFQgPSBxMXBlcnAgKiBzdDAueCArIHEwcGVycCAqIHN0MS54OwoJCXZlYzMgQiA9IHExcGVycCAqIHN0MC55ICsgcTBwZXJwICogc3QxLnk7CgkJZmxvYXQgZGV0ID0gbWF4KCBkb3QoIFQsIFQgKSwgZG90KCBCLCBCICkgKTsKCQlmbG9hdCBzY2FsZSA9ICggZGV0ID09IDAuMCApID8gMC4wIDogaW52ZXJzZXNxcnQoIGRldCApOwoJCXJldHVybiBtYXQzKCBUICogc2NhbGUsIEIgKiBzY2FsZSwgTiApOwoJfQojZW5kaWZgLCBmMSA9IGAjaWZkZWYgVVNFX0NMRUFSQ09BVAoJdmVjMyBjbGVhcmNvYXROb3JtYWwgPSBub25QZXJ0dXJiZWROb3JtYWw7CiNlbmRpZmAsIG0xID0gYCNpZmRlZiBVU0VfQ0xFQVJDT0FUX05PUk1BTE1BUAoJdmVjMyBjbGVhcmNvYXRNYXBOID0gdGV4dHVyZTJEKCBjbGVhcmNvYXROb3JtYWxNYXAsIHZDbGVhcmNvYXROb3JtYWxNYXBVdiApLnh5eiAqIDIuMCAtIDEuMDsKCWNsZWFyY29hdE1hcE4ueHkgKj0gY2xlYXJjb2F0Tm9ybWFsU2NhbGU7CgljbGVhcmNvYXROb3JtYWwgPSBub3JtYWxpemUoIHRibjIgKiBjbGVhcmNvYXRNYXBOICk7CiNlbmRpZmAsIGcxID0gYCNpZmRlZiBVU0VfQ0xFQVJDT0FUTUFQCgl1bmlmb3JtIHNhbXBsZXIyRCBjbGVhcmNvYXRNYXA7CiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVAKCXVuaWZvcm0gc2FtcGxlcjJEIGNsZWFyY29hdE5vcm1hbE1hcDsKCXVuaWZvcm0gdmVjMiBjbGVhcmNvYXROb3JtYWxTY2FsZTsKI2VuZGlmCiNpZmRlZiBVU0VfQ0xFQVJDT0FUX1JPVUdITkVTU01BUAoJdW5pZm9ybSBzYW1wbGVyMkQgY2xlYXJjb2F0Um91Z2huZXNzTWFwOwojZW5kaWZgLCB5MSA9IGAjaWZkZWYgVVNFX0lSSURFU0NFTkNFTUFQCgl1bmlmb3JtIHNhbXBsZXIyRCBpcmlkZXNjZW5jZU1hcDsKI2VuZGlmCiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQCgl1bmlmb3JtIHNhbXBsZXIyRCBpcmlkZXNjZW5jZVRoaWNrbmVzc01hcDsKI2VuZGlmYCwgXzEgPSBgI2lmZGVmIE9QQVFVRQpkaWZmdXNlQ29sb3IuYSA9IDEuMDsKI2VuZGlmCiNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OCmRpZmZ1c2VDb2xvci5hICo9IG1hdGVyaWFsLnRyYW5zbWlzc2lvbkFscGhhOwojZW5kaWYKZ2xfRnJhZ0NvbG9yID0gdmVjNCggb3V0Z29pbmdMaWdodCwgZGlmZnVzZUNvbG9yLmEgKTtgLCB4MSA9IGB2ZWMzIHBhY2tOb3JtYWxUb1JHQiggY29uc3QgaW4gdmVjMyBub3JtYWwgKSB7CglyZXR1cm4gbm9ybWFsaXplKCBub3JtYWwgKSAqIDAuNSArIDAuNTsKfQp2ZWMzIHVucGFja1JHQlRvTm9ybWFsKCBjb25zdCBpbiB2ZWMzIHJnYiApIHsKCXJldHVybiAyLjAgKiByZ2IueHl6IC0gMS4wOwp9CmNvbnN0IGZsb2F0IFBhY2tVcHNjYWxlID0gMjU2LiAvIDI1NS47Y29uc3QgZmxvYXQgVW5wYWNrRG93bnNjYWxlID0gMjU1LiAvIDI1Ni47Y29uc3QgZmxvYXQgU2hpZnRSaWdodDggPSAxLiAvIDI1Ni47CmNvbnN0IGZsb2F0IEludjI1NSA9IDEuIC8gMjU1LjsKY29uc3QgdmVjNCBQYWNrRmFjdG9ycyA9IHZlYzQoIDEuMCwgMjU2LjAsIDI1Ni4wICogMjU2LjAsIDI1Ni4wICogMjU2LjAgKiAyNTYuMCApOwpjb25zdCB2ZWMyIFVucGFja0ZhY3RvcnMyID0gdmVjMiggVW5wYWNrRG93bnNjYWxlLCAxLjAgLyBQYWNrRmFjdG9ycy5nICk7CmNvbnN0IHZlYzMgVW5wYWNrRmFjdG9yczMgPSB2ZWMzKCBVbnBhY2tEb3duc2NhbGUgLyBQYWNrRmFjdG9ycy5yZywgMS4wIC8gUGFja0ZhY3RvcnMuYiApOwpjb25zdCB2ZWM0IFVucGFja0ZhY3RvcnM0ID0gdmVjNCggVW5wYWNrRG93bnNjYWxlIC8gUGFja0ZhY3RvcnMucmdiLCAxLjAgLyBQYWNrRmFjdG9ycy5hICk7CnZlYzQgcGFja0RlcHRoVG9SR0JBKCBjb25zdCBpbiBmbG9hdCB2ICkgewoJaWYoIHYgPD0gMC4wICkKCQlyZXR1cm4gdmVjNCggMC4sIDAuLCAwLiwgMC4gKTsKCWlmKCB2ID49IDEuMCApCgkJcmV0dXJuIHZlYzQoIDEuLCAxLiwgMS4sIDEuICk7CglmbG9hdCB2dWY7CglmbG9hdCBhZiA9IG1vZGYoIHYgKiBQYWNrRmFjdG9ycy5hLCB2dWYgKTsKCWZsb2F0IGJmID0gbW9kZiggdnVmICogU2hpZnRSaWdodDgsIHZ1ZiApOwoJZmxvYXQgZ2YgPSBtb2RmKCB2dWYgKiBTaGlmdFJpZ2h0OCwgdnVmICk7CglyZXR1cm4gdmVjNCggdnVmICogSW52MjU1LCBnZiAqIFBhY2tVcHNjYWxlLCBiZiAqIFBhY2tVcHNjYWxlLCBhZiApOwp9CnZlYzMgcGFja0RlcHRoVG9SR0IoIGNvbnN0IGluIGZsb2F0IHYgKSB7CglpZiggdiA8PSAwLjAgKQoJCXJldHVybiB2ZWMzKCAwLiwgMC4sIDAuICk7CglpZiggdiA+PSAxLjAgKQoJCXJldHVybiB2ZWMzKCAxLiwgMS4sIDEuICk7CglmbG9hdCB2dWY7CglmbG9hdCBiZiA9IG1vZGYoIHYgKiBQYWNrRmFjdG9ycy5iLCB2dWYgKTsKCWZsb2F0IGdmID0gbW9kZiggdnVmICogU2hpZnRSaWdodDgsIHZ1ZiApOwoJcmV0dXJuIHZlYzMoIHZ1ZiAqIEludjI1NSwgZ2YgKiBQYWNrVXBzY2FsZSwgYmYgKTsKfQp2ZWMyIHBhY2tEZXB0aFRvUkcoIGNvbnN0IGluIGZsb2F0IHYgKSB7CglpZiggdiA8PSAwLjAgKQoJCXJldHVybiB2ZWMyKCAwLiwgMC4gKTsKCWlmKCB2ID49IDEuMCApCgkJcmV0dXJuIHZlYzIoIDEuLCAxLiApOwoJZmxvYXQgdnVmOwoJZmxvYXQgZ2YgPSBtb2RmKCB2ICogMjU2LiwgdnVmICk7CglyZXR1cm4gdmVjMiggdnVmICogSW52MjU1LCBnZiApOwp9CmZsb2F0IHVucGFja1JHQkFUb0RlcHRoKCBjb25zdCBpbiB2ZWM0IHYgKSB7CglyZXR1cm4gZG90KCB2LCBVbnBhY2tGYWN0b3JzNCApOwp9CmZsb2F0IHVucGFja1JHQlRvRGVwdGgoIGNvbnN0IGluIHZlYzMgdiApIHsKCXJldHVybiBkb3QoIHYsIFVucGFja0ZhY3RvcnMzICk7Cn0KZmxvYXQgdW5wYWNrUkdUb0RlcHRoKCBjb25zdCBpbiB2ZWMyIHYgKSB7CglyZXR1cm4gdi5yICogVW5wYWNrRmFjdG9yczIuciArIHYuZyAqIFVucGFja0ZhY3RvcnMyLmc7Cn0KdmVjNCBwYWNrMkhhbGZUb1JHQkEoIGNvbnN0IGluIHZlYzIgdiApIHsKCXZlYzQgciA9IHZlYzQoIHYueCwgZnJhY3QoIHYueCAqIDI1NS4wICksIHYueSwgZnJhY3QoIHYueSAqIDI1NS4wICkgKTsKCXJldHVybiB2ZWM0KCByLnggLSByLnkgLyAyNTUuMCwgci55LCByLnogLSByLncgLyAyNTUuMCwgci53ICk7Cn0KdmVjMiB1bnBhY2tSR0JBVG8ySGFsZiggY29uc3QgaW4gdmVjNCB2ICkgewoJcmV0dXJuIHZlYzIoIHYueCArICggdi55IC8gMjU1LjAgKSwgdi56ICsgKCB2LncgLyAyNTUuMCApICk7Cn0KZmxvYXQgdmlld1pUb09ydGhvZ3JhcGhpY0RlcHRoKCBjb25zdCBpbiBmbG9hdCB2aWV3WiwgY29uc3QgaW4gZmxvYXQgbmVhciwgY29uc3QgaW4gZmxvYXQgZmFyICkgewoJcmV0dXJuICggdmlld1ogKyBuZWFyICkgLyAoIG5lYXIgLSBmYXIgKTsKfQpmbG9hdCBvcnRob2dyYXBoaWNEZXB0aFRvVmlld1ooIGNvbnN0IGluIGZsb2F0IGRlcHRoLCBjb25zdCBpbiBmbG9hdCBuZWFyLCBjb25zdCBpbiBmbG9hdCBmYXIgKSB7CglyZXR1cm4gZGVwdGggKiAoIG5lYXIgLSBmYXIgKSAtIG5lYXI7Cn0KZmxvYXQgdmlld1pUb1BlcnNwZWN0aXZlRGVwdGgoIGNvbnN0IGluIGZsb2F0IHZpZXdaLCBjb25zdCBpbiBmbG9hdCBuZWFyLCBjb25zdCBpbiBmbG9hdCBmYXIgKSB7CglyZXR1cm4gKCAoIG5lYXIgKyB2aWV3WiApICogZmFyICkgLyAoICggZmFyIC0gbmVhciApICogdmlld1ogKTsKfQpmbG9hdCBwZXJzcGVjdGl2ZURlcHRoVG9WaWV3WiggY29uc3QgaW4gZmxvYXQgZGVwdGgsIGNvbnN0IGluIGZsb2F0IG5lYXIsIGNvbnN0IGluIGZsb2F0IGZhciApIHsKCXJldHVybiAoIG5lYXIgKiBmYXIgKSAvICggKCBmYXIgLSBuZWFyICkgKiBkZXB0aCAtIGZhciApOwp9YCwgdjEgPSBgI2lmZGVmIFBSRU1VTFRJUExJRURfQUxQSEEKCWdsX0ZyYWdDb2xvci5yZ2IgKj0gZ2xfRnJhZ0NvbG9yLmE7CiNlbmRpZmAsIGIxID0gYHZlYzQgbXZQb3NpdGlvbiA9IHZlYzQoIHRyYW5zZm9ybWVkLCAxLjAgKTsKI2lmZGVmIFVTRV9CQVRDSElORwoJbXZQb3NpdGlvbiA9IGJhdGNoaW5nTWF0cml4ICogbXZQb3NpdGlvbjsKI2VuZGlmCiNpZmRlZiBVU0VfSU5TVEFOQ0lORwoJbXZQb3NpdGlvbiA9IGluc3RhbmNlTWF0cml4ICogbXZQb3NpdGlvbjsKI2VuZGlmCm12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiBtdlBvc2l0aW9uOwpnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uO2AsIE0xID0gYCNpZmRlZiBESVRIRVJJTkcKCWdsX0ZyYWdDb2xvci5yZ2IgPSBkaXRoZXJpbmcoIGdsX0ZyYWdDb2xvci5yZ2IgKTsKI2VuZGlmYCwgUzEgPSBgI2lmZGVmIERJVEhFUklORwoJdmVjMyBkaXRoZXJpbmcoIHZlYzMgY29sb3IgKSB7CgkJZmxvYXQgZ3JpZF9wb3NpdGlvbiA9IHJhbmQoIGdsX0ZyYWdDb29yZC54eSApOwoJCXZlYzMgZGl0aGVyX3NoaWZ0X1JHQiA9IHZlYzMoIDAuMjUgLyAyNTUuMCwgLTAuMjUgLyAyNTUuMCwgMC4yNSAvIDI1NS4wICk7CgkJZGl0aGVyX3NoaWZ0X1JHQiA9IG1peCggMi4wICogZGl0aGVyX3NoaWZ0X1JHQiwgLTIuMCAqIGRpdGhlcl9zaGlmdF9SR0IsIGdyaWRfcG9zaXRpb24gKTsKCQlyZXR1cm4gY29sb3IgKyBkaXRoZXJfc2hpZnRfUkdCOwoJfQojZW5kaWZgLCB3MSA9IGBmbG9hdCByb3VnaG5lc3NGYWN0b3IgPSByb3VnaG5lc3M7CiNpZmRlZiBVU0VfUk9VR0hORVNTTUFQCgl2ZWM0IHRleGVsUm91Z2huZXNzID0gdGV4dHVyZTJEKCByb3VnaG5lc3NNYXAsIHZSb3VnaG5lc3NNYXBVdiApOwoJcm91Z2huZXNzRmFjdG9yICo9IHRleGVsUm91Z2huZXNzLmc7CiNlbmRpZmAsIEExID0gYCNpZmRlZiBVU0VfUk9VR0hORVNTTUFQCgl1bmlmb3JtIHNhbXBsZXIyRCByb3VnaG5lc3NNYXA7CiNlbmRpZmAsIEUxID0gYCNpZiBOVU1fU1BPVF9MSUdIVF9DT09SRFMgPiAwCgl2YXJ5aW5nIHZlYzQgdlNwb3RMaWdodENvb3JkWyBOVU1fU1BPVF9MSUdIVF9DT09SRFMgXTsKI2VuZGlmCiNpZiBOVU1fU1BPVF9MSUdIVF9NQVBTID4gMAoJdW5pZm9ybSBzYW1wbGVyMkQgc3BvdExpZ2h0TWFwWyBOVU1fU1BPVF9MSUdIVF9NQVBTIF07CiNlbmRpZgojaWZkZWYgVVNFX1NIQURPV01BUAoJI2lmIE5VTV9ESVJfTElHSFRfU0hBRE9XUyA+IDAKCQl1bmlmb3JtIHNhbXBsZXIyRCBkaXJlY3Rpb25hbFNoYWRvd01hcFsgTlVNX0RJUl9MSUdIVF9TSEFET1dTIF07CgkJdmFyeWluZyB2ZWM0IHZEaXJlY3Rpb25hbFNoYWRvd0Nvb3JkWyBOVU1fRElSX0xJR0hUX1NIQURPV1MgXTsKCQlzdHJ1Y3QgRGlyZWN0aW9uYWxMaWdodFNoYWRvdyB7CgkJCWZsb2F0IHNoYWRvd0ludGVuc2l0eTsKCQkJZmxvYXQgc2hhZG93QmlhczsKCQkJZmxvYXQgc2hhZG93Tm9ybWFsQmlhczsKCQkJZmxvYXQgc2hhZG93UmFkaXVzOwoJCQl2ZWMyIHNoYWRvd01hcFNpemU7CgkJfTsKCQl1bmlmb3JtIERpcmVjdGlvbmFsTGlnaHRTaGFkb3cgZGlyZWN0aW9uYWxMaWdodFNoYWRvd3NbIE5VTV9ESVJfTElHSFRfU0hBRE9XUyBdOwoJI2VuZGlmCgkjaWYgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyA+IDAKCQl1bmlmb3JtIHNhbXBsZXIyRCBzcG90U2hhZG93TWFwWyBOVU1fU1BPVF9MSUdIVF9TSEFET1dTIF07CgkJc3RydWN0IFNwb3RMaWdodFNoYWRvdyB7CgkJCWZsb2F0IHNoYWRvd0ludGVuc2l0eTsKCQkJZmxvYXQgc2hhZG93QmlhczsKCQkJZmxvYXQgc2hhZG93Tm9ybWFsQmlhczsKCQkJZmxvYXQgc2hhZG93UmFkaXVzOwoJCQl2ZWMyIHNoYWRvd01hcFNpemU7CgkJfTsKCQl1bmlmb3JtIFNwb3RMaWdodFNoYWRvdyBzcG90TGlnaHRTaGFkb3dzWyBOVU1fU1BPVF9MSUdIVF9TSEFET1dTIF07CgkjZW5kaWYKCSNpZiBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDAKCQl1bmlmb3JtIHNhbXBsZXIyRCBwb2ludFNoYWRvd01hcFsgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MgXTsKCQl2YXJ5aW5nIHZlYzQgdlBvaW50U2hhZG93Q29vcmRbIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTIF07CgkJc3RydWN0IFBvaW50TGlnaHRTaGFkb3cgewoJCQlmbG9hdCBzaGFkb3dJbnRlbnNpdHk7CgkJCWZsb2F0IHNoYWRvd0JpYXM7CgkJCWZsb2F0IHNoYWRvd05vcm1hbEJpYXM7CgkJCWZsb2F0IHNoYWRvd1JhZGl1czsKCQkJdmVjMiBzaGFkb3dNYXBTaXplOwoJCQlmbG9hdCBzaGFkb3dDYW1lcmFOZWFyOwoJCQlmbG9hdCBzaGFkb3dDYW1lcmFGYXI7CgkJfTsKCQl1bmlmb3JtIFBvaW50TGlnaHRTaGFkb3cgcG9pbnRMaWdodFNoYWRvd3NbIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTIF07CgkjZW5kaWYKCWZsb2F0IHRleHR1cmUyRENvbXBhcmUoIHNhbXBsZXIyRCBkZXB0aHMsIHZlYzIgdXYsIGZsb2F0IGNvbXBhcmUgKSB7CgkJZmxvYXQgZGVwdGggPSB1bnBhY2tSR0JBVG9EZXB0aCggdGV4dHVyZTJEKCBkZXB0aHMsIHV2ICkgKTsKCQkjaWZkZWYgVVNFX1JFVkVSU0VEX0RFUFRIX0JVRkZFUgoJCQlyZXR1cm4gc3RlcCggZGVwdGgsIGNvbXBhcmUgKTsKCQkjZWxzZQoJCQlyZXR1cm4gc3RlcCggY29tcGFyZSwgZGVwdGggKTsKCQkjZW5kaWYKCX0KCXZlYzIgdGV4dHVyZTJERGlzdHJpYnV0aW9uKCBzYW1wbGVyMkQgc2hhZG93LCB2ZWMyIHV2ICkgewoJCXJldHVybiB1bnBhY2tSR0JBVG8ySGFsZiggdGV4dHVyZTJEKCBzaGFkb3csIHV2ICkgKTsKCX0KCWZsb2F0IFZTTVNoYWRvdyggc2FtcGxlcjJEIHNoYWRvdywgdmVjMiB1diwgZmxvYXQgY29tcGFyZSApIHsKCQlmbG9hdCBvY2NsdXNpb24gPSAxLjA7CgkJdmVjMiBkaXN0cmlidXRpb24gPSB0ZXh0dXJlMkREaXN0cmlidXRpb24oIHNoYWRvdywgdXYgKTsKCQkjaWZkZWYgVVNFX1JFVkVSU0VEX0RFUFRIX0JVRkZFUgoJCQlmbG9hdCBoYXJkX3NoYWRvdyA9IHN0ZXAoIGRpc3RyaWJ1dGlvbi54LCBjb21wYXJlICk7CgkJI2Vsc2UKCQkJZmxvYXQgaGFyZF9zaGFkb3cgPSBzdGVwKCBjb21wYXJlLCBkaXN0cmlidXRpb24ueCApOwoJCSNlbmRpZgoJCWlmICggaGFyZF9zaGFkb3cgIT0gMS4wICkgewoJCQlmbG9hdCBkaXN0YW5jZSA9IGNvbXBhcmUgLSBkaXN0cmlidXRpb24ueDsKCQkJZmxvYXQgdmFyaWFuY2UgPSBtYXgoIDAuMDAwMDAsIGRpc3RyaWJ1dGlvbi55ICogZGlzdHJpYnV0aW9uLnkgKTsKCQkJZmxvYXQgc29mdG5lc3NfcHJvYmFiaWxpdHkgPSB2YXJpYW5jZSAvICh2YXJpYW5jZSArIGRpc3RhbmNlICogZGlzdGFuY2UgKTsJCQlzb2Z0bmVzc19wcm9iYWJpbGl0eSA9IGNsYW1wKCAoIHNvZnRuZXNzX3Byb2JhYmlsaXR5IC0gMC4zICkgLyAoIDAuOTUgLSAwLjMgKSwgMC4wLCAxLjAgKTsJCQlvY2NsdXNpb24gPSBjbGFtcCggbWF4KCBoYXJkX3NoYWRvdywgc29mdG5lc3NfcHJvYmFiaWxpdHkgKSwgMC4wLCAxLjAgKTsKCQl9CgkJcmV0dXJuIG9jY2x1c2lvbjsKCX0KCWZsb2F0IGdldFNoYWRvdyggc2FtcGxlcjJEIHNoYWRvd01hcCwgdmVjMiBzaGFkb3dNYXBTaXplLCBmbG9hdCBzaGFkb3dJbnRlbnNpdHksIGZsb2F0IHNoYWRvd0JpYXMsIGZsb2F0IHNoYWRvd1JhZGl1cywgdmVjNCBzaGFkb3dDb29yZCApIHsKCQlmbG9hdCBzaGFkb3cgPSAxLjA7CgkJc2hhZG93Q29vcmQueHl6IC89IHNoYWRvd0Nvb3JkLnc7CgkJc2hhZG93Q29vcmQueiArPSBzaGFkb3dCaWFzOwoJCWJvb2wgaW5GcnVzdHVtID0gc2hhZG93Q29vcmQueCA+PSAwLjAgJiYgc2hhZG93Q29vcmQueCA8PSAxLjAgJiYgc2hhZG93Q29vcmQueSA+PSAwLjAgJiYgc2hhZG93Q29vcmQueSA8PSAxLjA7CgkJYm9vbCBmcnVzdHVtVGVzdCA9IGluRnJ1c3R1bSAmJiBzaGFkb3dDb29yZC56IDw9IDEuMDsKCQlpZiAoIGZydXN0dW1UZXN0ICkgewoJCSNpZiBkZWZpbmVkKCBTSEFET1dNQVBfVFlQRV9QQ0YgKQoJCQl2ZWMyIHRleGVsU2l6ZSA9IHZlYzIoIDEuMCApIC8gc2hhZG93TWFwU2l6ZTsKCQkJZmxvYXQgZHgwID0gLSB0ZXhlbFNpemUueCAqIHNoYWRvd1JhZGl1czsKCQkJZmxvYXQgZHkwID0gLSB0ZXhlbFNpemUueSAqIHNoYWRvd1JhZGl1czsKCQkJZmxvYXQgZHgxID0gKyB0ZXhlbFNpemUueCAqIHNoYWRvd1JhZGl1czsKCQkJZmxvYXQgZHkxID0gKyB0ZXhlbFNpemUueSAqIHNoYWRvd1JhZGl1czsKCQkJZmxvYXQgZHgyID0gZHgwIC8gMi4wOwoJCQlmbG9hdCBkeTIgPSBkeTAgLyAyLjA7CgkJCWZsb2F0IGR4MyA9IGR4MSAvIDIuMDsKCQkJZmxvYXQgZHkzID0gZHkxIC8gMi4wOwoJCQlzaGFkb3cgPSAoCgkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgwLCBkeTAgKSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCAwLjAsIGR5MCApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MSwgZHkwICksIHNoYWRvd0Nvb3JkLnogKSArCgkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgyLCBkeTIgKSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCAwLjAsIGR5MiApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MywgZHkyICksIHNoYWRvd0Nvb3JkLnogKSArCgkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgwLCAwLjAgKSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDIsIDAuMCApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDMsIDAuMCApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MSwgMC4wICksIHNoYWRvd0Nvb3JkLnogKSArCgkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgyLCBkeTMgKSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCAwLjAsIGR5MyApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MywgZHkzICksIHNoYWRvd0Nvb3JkLnogKSArCgkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgwLCBkeTEgKSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCAwLjAsIGR5MSApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MSwgZHkxICksIHNoYWRvd0Nvb3JkLnogKQoJCQkpICogKCAxLjAgLyAxNy4wICk7CgkJI2VsaWYgZGVmaW5lZCggU0hBRE9XTUFQX1RZUEVfUENGX1NPRlQgKQoJCQl2ZWMyIHRleGVsU2l6ZSA9IHZlYzIoIDEuMCApIC8gc2hhZG93TWFwU2l6ZTsKCQkJZmxvYXQgZHggPSB0ZXhlbFNpemUueDsKCQkJZmxvYXQgZHkgPSB0ZXhlbFNpemUueTsKCQkJdmVjMiB1diA9IHNoYWRvd0Nvb3JkLnh5OwoJCQl2ZWMyIGYgPSBmcmFjdCggdXYgKiBzaGFkb3dNYXBTaXplICsgMC41ICk7CgkJCXV2IC09IGYgKiB0ZXhlbFNpemU7CgkJCXNoYWRvdyA9ICgKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYsIHNoYWRvd0Nvb3JkLnogKSArCgkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggZHgsIDAuMCApLCBzaGFkb3dDb29yZC56ICkgKwoJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIDAuMCwgZHkgKSwgc2hhZG93Q29vcmQueiApICsKCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB0ZXhlbFNpemUsIHNoYWRvd0Nvb3JkLnogKSArCgkJCQltaXgoIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAtZHgsIDAuMCApLCBzaGFkb3dDb29yZC56ICksCgkJCQkJIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAyLjAgKiBkeCwgMC4wICksIHNoYWRvd0Nvb3JkLnogKSwKCQkJCQkgZi54ICkgKwoJCQkJbWl4KCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggLWR4LCBkeSApLCBzaGFkb3dDb29yZC56ICksCgkJCQkJIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAyLjAgKiBkeCwgZHkgKSwgc2hhZG93Q29vcmQueiApLAoJCQkJCSBmLnggKSArCgkJCQltaXgoIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAwLjAsIC1keSApLCBzaGFkb3dDb29yZC56ICksCgkJCQkJIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAwLjAsIDIuMCAqIGR5ICksIHNoYWRvd0Nvb3JkLnogKSwKCQkJCQkgZi55ICkgKwoJCQkJbWl4KCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggZHgsIC1keSApLCBzaGFkb3dDb29yZC56ICksCgkJCQkJIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCBkeCwgMi4wICogZHkgKSwgc2hhZG93Q29vcmQueiApLAoJCQkJCSBmLnkgKSArCgkJCQltaXgoIG1peCggdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIC1keCwgLWR5ICksIHNoYWRvd0Nvb3JkLnogKSwKCQkJCQkJICB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggMi4wICogZHgsIC1keSApLCBzaGFkb3dDb29yZC56ICksCgkJCQkJCSAgZi54ICksCgkJCQkJIG1peCggdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIC1keCwgMi4wICogZHkgKSwgc2hhZG93Q29vcmQueiApLAoJCQkJCQkgIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAyLjAgKiBkeCwgMi4wICogZHkgKSwgc2hhZG93Q29vcmQueiApLAoJCQkJCQkgIGYueCApLAoJCQkJCSBmLnkgKQoJCQkpICogKCAxLjAgLyA5LjAgKTsKCQkjZWxpZiBkZWZpbmVkKCBTSEFET1dNQVBfVFlQRV9WU00gKQoJCQlzaGFkb3cgPSBWU01TaGFkb3coIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHksIHNoYWRvd0Nvb3JkLnogKTsKCQkjZWxzZQoJCQlzaGFkb3cgPSB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5LCBzaGFkb3dDb29yZC56ICk7CgkJI2VuZGlmCgkJfQoJCXJldHVybiBtaXgoIDEuMCwgc2hhZG93LCBzaGFkb3dJbnRlbnNpdHkgKTsKCX0KCXZlYzIgY3ViZVRvVVYoIHZlYzMgdiwgZmxvYXQgdGV4ZWxTaXplWSApIHsKCQl2ZWMzIGFic1YgPSBhYnMoIHYgKTsKCQlmbG9hdCBzY2FsZVRvQ3ViZSA9IDEuMCAvIG1heCggYWJzVi54LCBtYXgoIGFic1YueSwgYWJzVi56ICkgKTsKCQlhYnNWICo9IHNjYWxlVG9DdWJlOwoJCXYgKj0gc2NhbGVUb0N1YmUgKiAoIDEuMCAtIDIuMCAqIHRleGVsU2l6ZVkgKTsKCQl2ZWMyIHBsYW5hciA9IHYueHk7CgkJZmxvYXQgYWxtb3N0QVRleGVsID0gMS41ICogdGV4ZWxTaXplWTsKCQlmbG9hdCBhbG1vc3RPbmUgPSAxLjAgLSBhbG1vc3RBVGV4ZWw7CgkJaWYgKCBhYnNWLnogPj0gYWxtb3N0T25lICkgewoJCQlpZiAoIHYueiA+IDAuMCApCgkJCQlwbGFuYXIueCA9IDQuMCAtIHYueDsKCQl9IGVsc2UgaWYgKCBhYnNWLnggPj0gYWxtb3N0T25lICkgewoJCQlmbG9hdCBzaWduWCA9IHNpZ24oIHYueCApOwoJCQlwbGFuYXIueCA9IHYueiAqIHNpZ25YICsgMi4wICogc2lnblg7CgkJfSBlbHNlIGlmICggYWJzVi55ID49IGFsbW9zdE9uZSApIHsKCQkJZmxvYXQgc2lnblkgPSBzaWduKCB2LnkgKTsKCQkJcGxhbmFyLnggPSB2LnggKyAyLjAgKiBzaWduWSArIDIuMDsKCQkJcGxhbmFyLnkgPSB2LnogKiBzaWduWSAtIDIuMDsKCQl9CgkJcmV0dXJuIHZlYzIoIDAuMTI1LCAwLjI1ICkgKiBwbGFuYXIgKyB2ZWMyKCAwLjM3NSwgMC43NSApOwoJfQoJZmxvYXQgZ2V0UG9pbnRTaGFkb3coIHNhbXBsZXIyRCBzaGFkb3dNYXAsIHZlYzIgc2hhZG93TWFwU2l6ZSwgZmxvYXQgc2hhZG93SW50ZW5zaXR5LCBmbG9hdCBzaGFkb3dCaWFzLCBmbG9hdCBzaGFkb3dSYWRpdXMsIHZlYzQgc2hhZG93Q29vcmQsIGZsb2F0IHNoYWRvd0NhbWVyYU5lYXIsIGZsb2F0IHNoYWRvd0NhbWVyYUZhciApIHsKCQlmbG9hdCBzaGFkb3cgPSAxLjA7CgkJdmVjMyBsaWdodFRvUG9zaXRpb24gPSBzaGFkb3dDb29yZC54eXo7CgkJCgkJZmxvYXQgbGlnaHRUb1Bvc2l0aW9uTGVuZ3RoID0gbGVuZ3RoKCBsaWdodFRvUG9zaXRpb24gKTsKCQlpZiAoIGxpZ2h0VG9Qb3NpdGlvbkxlbmd0aCAtIHNoYWRvd0NhbWVyYUZhciA8PSAwLjAgJiYgbGlnaHRUb1Bvc2l0aW9uTGVuZ3RoIC0gc2hhZG93Q2FtZXJhTmVhciA+PSAwLjAgKSB7CgkJCWZsb2F0IGRwID0gKCBsaWdodFRvUG9zaXRpb25MZW5ndGggLSBzaGFkb3dDYW1lcmFOZWFyICkgLyAoIHNoYWRvd0NhbWVyYUZhciAtIHNoYWRvd0NhbWVyYU5lYXIgKTsJCQlkcCArPSBzaGFkb3dCaWFzOwoJCQl2ZWMzIGJkM0QgPSBub3JtYWxpemUoIGxpZ2h0VG9Qb3NpdGlvbiApOwoJCQl2ZWMyIHRleGVsU2l6ZSA9IHZlYzIoIDEuMCApIC8gKCBzaGFkb3dNYXBTaXplICogdmVjMiggNC4wLCAyLjAgKSApOwoJCQkjaWYgZGVmaW5lZCggU0hBRE9XTUFQX1RZUEVfUENGICkgfHwgZGVmaW5lZCggU0hBRE9XTUFQX1RZUEVfUENGX1NPRlQgKSB8fCBkZWZpbmVkKCBTSEFET1dNQVBfVFlQRV9WU00gKQoJCQkJdmVjMiBvZmZzZXQgPSB2ZWMyKCAtIDEsIDEgKSAqIHNoYWRvd1JhZGl1cyAqIHRleGVsU2l6ZS55OwoJCQkJc2hhZG93ID0gKAoJCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueHl5LCB0ZXhlbFNpemUueSApLCBkcCApICsKCQkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNEICsgb2Zmc2V0Lnl5eSwgdGV4ZWxTaXplLnkgKSwgZHAgKSArCgkJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBjdWJlVG9VViggYmQzRCArIG9mZnNldC54eXgsIHRleGVsU2l6ZS55ICksIGRwICkgKwoJCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueXl4LCB0ZXhlbFNpemUueSApLCBkcCApICsKCQkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNELCB0ZXhlbFNpemUueSApLCBkcCApICsKCQkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNEICsgb2Zmc2V0Lnh4eSwgdGV4ZWxTaXplLnkgKSwgZHAgKSArCgkJCQkJdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBjdWJlVG9VViggYmQzRCArIG9mZnNldC55eHksIHRleGVsU2l6ZS55ICksIGRwICkgKwoJCQkJCXRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueHh4LCB0ZXhlbFNpemUueSApLCBkcCApICsKCQkJCQl0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNEICsgb2Zmc2V0Lnl4eCwgdGV4ZWxTaXplLnkgKSwgZHAgKQoJCQkJKSAqICggMS4wIC8gOS4wICk7CgkJCSNlbHNlCgkJCQlzaGFkb3cgPSB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNELCB0ZXhlbFNpemUueSApLCBkcCApOwoJCQkjZW5kaWYKCQl9CgkJcmV0dXJuIG1peCggMS4wLCBzaGFkb3csIHNoYWRvd0ludGVuc2l0eSApOwoJfQojZW5kaWZgLCBUMSA9IGAjaWYgTlVNX1NQT1RfTElHSFRfQ09PUkRTID4gMAoJdW5pZm9ybSBtYXQ0IHNwb3RMaWdodE1hdHJpeFsgTlVNX1NQT1RfTElHSFRfQ09PUkRTIF07Cgl2YXJ5aW5nIHZlYzQgdlNwb3RMaWdodENvb3JkWyBOVU1fU1BPVF9MSUdIVF9DT09SRFMgXTsKI2VuZGlmCiNpZmRlZiBVU0VfU0hBRE9XTUFQCgkjaWYgTlVNX0RJUl9MSUdIVF9TSEFET1dTID4gMAoJCXVuaWZvcm0gbWF0NCBkaXJlY3Rpb25hbFNoYWRvd01hdHJpeFsgTlVNX0RJUl9MSUdIVF9TSEFET1dTIF07CgkJdmFyeWluZyB2ZWM0IHZEaXJlY3Rpb25hbFNoYWRvd0Nvb3JkWyBOVU1fRElSX0xJR0hUX1NIQURPV1MgXTsKCQlzdHJ1Y3QgRGlyZWN0aW9uYWxMaWdodFNoYWRvdyB7CgkJCWZsb2F0IHNoYWRvd0ludGVuc2l0eTsKCQkJZmxvYXQgc2hhZG93QmlhczsKCQkJZmxvYXQgc2hhZG93Tm9ybWFsQmlhczsKCQkJZmxvYXQgc2hhZG93UmFkaXVzOwoJCQl2ZWMyIHNoYWRvd01hcFNpemU7CgkJfTsKCQl1bmlmb3JtIERpcmVjdGlvbmFsTGlnaHRTaGFkb3cgZGlyZWN0aW9uYWxMaWdodFNoYWRvd3NbIE5VTV9ESVJfTElHSFRfU0hBRE9XUyBdOwoJI2VuZGlmCgkjaWYgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyA+IDAKCQlzdHJ1Y3QgU3BvdExpZ2h0U2hhZG93IHsKCQkJZmxvYXQgc2hhZG93SW50ZW5zaXR5OwoJCQlmbG9hdCBzaGFkb3dCaWFzOwoJCQlmbG9hdCBzaGFkb3dOb3JtYWxCaWFzOwoJCQlmbG9hdCBzaGFkb3dSYWRpdXM7CgkJCXZlYzIgc2hhZG93TWFwU2l6ZTsKCQl9OwoJCXVuaWZvcm0gU3BvdExpZ2h0U2hhZG93IHNwb3RMaWdodFNoYWRvd3NbIE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgXTsKCSNlbmRpZgoJI2lmIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTID4gMAoJCXVuaWZvcm0gbWF0NCBwb2ludFNoYWRvd01hdHJpeFsgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MgXTsKCQl2YXJ5aW5nIHZlYzQgdlBvaW50U2hhZG93Q29vcmRbIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTIF07CgkJc3RydWN0IFBvaW50TGlnaHRTaGFkb3cgewoJCQlmbG9hdCBzaGFkb3dJbnRlbnNpdHk7CgkJCWZsb2F0IHNoYWRvd0JpYXM7CgkJCWZsb2F0IHNoYWRvd05vcm1hbEJpYXM7CgkJCWZsb2F0IHNoYWRvd1JhZGl1czsKCQkJdmVjMiBzaGFkb3dNYXBTaXplOwoJCQlmbG9hdCBzaGFkb3dDYW1lcmFOZWFyOwoJCQlmbG9hdCBzaGFkb3dDYW1lcmFGYXI7CgkJfTsKCQl1bmlmb3JtIFBvaW50TGlnaHRTaGFkb3cgcG9pbnRMaWdodFNoYWRvd3NbIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTIF07CgkjZW5kaWYKI2VuZGlmYCwgQzEgPSBgI2lmICggZGVmaW5lZCggVVNFX1NIQURPV01BUCApICYmICggTlVNX0RJUl9MSUdIVF9TSEFET1dTID4gMCB8fCBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDAgKSApIHx8ICggTlVNX1NQT1RfTElHSFRfQ09PUkRTID4gMCApCgl2ZWMzIHNoYWRvd1dvcmxkTm9ybWFsID0gaW52ZXJzZVRyYW5zZm9ybURpcmVjdGlvbiggdHJhbnNmb3JtZWROb3JtYWwsIHZpZXdNYXRyaXggKTsKCXZlYzQgc2hhZG93V29ybGRQb3NpdGlvbjsKI2VuZGlmCiNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQICkKCSNpZiBOVU1fRElSX0xJR0hUX1NIQURPV1MgPiAwCgkJI3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydAoJCWZvciAoIGludCBpID0gMDsgaSA8IE5VTV9ESVJfTElHSFRfU0hBRE9XUzsgaSArKyApIHsKCQkJc2hhZG93V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24gKyB2ZWM0KCBzaGFkb3dXb3JsZE5vcm1hbCAqIGRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzWyBpIF0uc2hhZG93Tm9ybWFsQmlhcywgMCApOwoJCQl2RGlyZWN0aW9uYWxTaGFkb3dDb29yZFsgaSBdID0gZGlyZWN0aW9uYWxTaGFkb3dNYXRyaXhbIGkgXSAqIHNoYWRvd1dvcmxkUG9zaXRpb247CgkJfQoJCSNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kCgkjZW5kaWYKCSNpZiBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDAKCQkjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0CgkJZm9yICggaW50IGkgPSAwOyBpIDwgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1M7IGkgKysgKSB7CgkJCXNoYWRvd1dvcmxkUG9zaXRpb24gPSB3b3JsZFBvc2l0aW9uICsgdmVjNCggc2hhZG93V29ybGROb3JtYWwgKiBwb2ludExpZ2h0U2hhZG93c1sgaSBdLnNoYWRvd05vcm1hbEJpYXMsIDAgKTsKCQkJdlBvaW50U2hhZG93Q29vcmRbIGkgXSA9IHBvaW50U2hhZG93TWF0cml4WyBpIF0gKiBzaGFkb3dXb3JsZFBvc2l0aW9uOwoJCX0KCQkjcHJhZ21hIHVucm9sbF9sb29wX2VuZAoJI2VuZGlmCiNlbmRpZgojaWYgTlVNX1NQT1RfTElHSFRfQ09PUkRTID4gMAoJI3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydAoJZm9yICggaW50IGkgPSAwOyBpIDwgTlVNX1NQT1RfTElHSFRfQ09PUkRTOyBpICsrICkgewoJCXNoYWRvd1dvcmxkUG9zaXRpb24gPSB3b3JsZFBvc2l0aW9uOwoJCSNpZiAoIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyApCgkJCXNoYWRvd1dvcmxkUG9zaXRpb24ueHl6ICs9IHNoYWRvd1dvcmxkTm9ybWFsICogc3BvdExpZ2h0U2hhZG93c1sgaSBdLnNoYWRvd05vcm1hbEJpYXM7CgkJI2VuZGlmCgkJdlNwb3RMaWdodENvb3JkWyBpIF0gPSBzcG90TGlnaHRNYXRyaXhbIGkgXSAqIHNoYWRvd1dvcmxkUG9zaXRpb247Cgl9CgkjcHJhZ21hIHVucm9sbF9sb29wX2VuZAojZW5kaWZgLCBSMSA9IGBmbG9hdCBnZXRTaGFkb3dNYXNrKCkgewoJZmxvYXQgc2hhZG93ID0gMS4wOwoJI2lmZGVmIFVTRV9TSEFET1dNQVAKCSNpZiBOVU1fRElSX0xJR0hUX1NIQURPV1MgPiAwCglEaXJlY3Rpb25hbExpZ2h0U2hhZG93IGRpcmVjdGlvbmFsTGlnaHQ7CgkjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0Cglmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fRElSX0xJR0hUX1NIQURPV1M7IGkgKysgKSB7CgkJZGlyZWN0aW9uYWxMaWdodCA9IGRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzWyBpIF07CgkJc2hhZG93ICo9IHJlY2VpdmVTaGFkb3cgPyBnZXRTaGFkb3coIGRpcmVjdGlvbmFsU2hhZG93TWFwWyBpIF0sIGRpcmVjdGlvbmFsTGlnaHQuc2hhZG93TWFwU2l6ZSwgZGlyZWN0aW9uYWxMaWdodC5zaGFkb3dJbnRlbnNpdHksIGRpcmVjdGlvbmFsTGlnaHQuc2hhZG93QmlhcywgZGlyZWN0aW9uYWxMaWdodC5zaGFkb3dSYWRpdXMsIHZEaXJlY3Rpb25hbFNoYWRvd0Nvb3JkWyBpIF0gKSA6IDEuMDsKCX0KCSNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kCgkjZW5kaWYKCSNpZiBOVU1fU1BPVF9MSUdIVF9TSEFET1dTID4gMAoJU3BvdExpZ2h0U2hhZG93IHNwb3RMaWdodDsKCSNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnQKCWZvciAoIGludCBpID0gMDsgaSA8IE5VTV9TUE9UX0xJR0hUX1NIQURPV1M7IGkgKysgKSB7CgkJc3BvdExpZ2h0ID0gc3BvdExpZ2h0U2hhZG93c1sgaSBdOwoJCXNoYWRvdyAqPSByZWNlaXZlU2hhZG93ID8gZ2V0U2hhZG93KCBzcG90U2hhZG93TWFwWyBpIF0sIHNwb3RMaWdodC5zaGFkb3dNYXBTaXplLCBzcG90TGlnaHQuc2hhZG93SW50ZW5zaXR5LCBzcG90TGlnaHQuc2hhZG93Qmlhcywgc3BvdExpZ2h0LnNoYWRvd1JhZGl1cywgdlNwb3RMaWdodENvb3JkWyBpIF0gKSA6IDEuMDsKCX0KCSNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kCgkjZW5kaWYKCSNpZiBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDAKCVBvaW50TGlnaHRTaGFkb3cgcG9pbnRMaWdodDsKCSNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnQKCWZvciAoIGludCBpID0gMDsgaSA8IE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTOyBpICsrICkgewoJCXBvaW50TGlnaHQgPSBwb2ludExpZ2h0U2hhZG93c1sgaSBdOwoJCXNoYWRvdyAqPSByZWNlaXZlU2hhZG93ID8gZ2V0UG9pbnRTaGFkb3coIHBvaW50U2hhZG93TWFwWyBpIF0sIHBvaW50TGlnaHQuc2hhZG93TWFwU2l6ZSwgcG9pbnRMaWdodC5zaGFkb3dJbnRlbnNpdHksIHBvaW50TGlnaHQuc2hhZG93QmlhcywgcG9pbnRMaWdodC5zaGFkb3dSYWRpdXMsIHZQb2ludFNoYWRvd0Nvb3JkWyBpIF0sIHBvaW50TGlnaHQuc2hhZG93Q2FtZXJhTmVhciwgcG9pbnRMaWdodC5zaGFkb3dDYW1lcmFGYXIgKSA6IDEuMDsKCX0KCSNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kCgkjZW5kaWYKCSNlbmRpZgoJcmV0dXJuIHNoYWRvdzsKfWAsIFAxID0gYCNpZmRlZiBVU0VfU0tJTk5JTkcKCW1hdDQgYm9uZU1hdFggPSBnZXRCb25lTWF0cml4KCBza2luSW5kZXgueCApOwoJbWF0NCBib25lTWF0WSA9IGdldEJvbmVNYXRyaXgoIHNraW5JbmRleC55ICk7CgltYXQ0IGJvbmVNYXRaID0gZ2V0Qm9uZU1hdHJpeCggc2tpbkluZGV4LnogKTsKCW1hdDQgYm9uZU1hdFcgPSBnZXRCb25lTWF0cml4KCBza2luSW5kZXgudyApOwojZW5kaWZgLCBJMSA9IGAjaWZkZWYgVVNFX1NLSU5OSU5HCgl1bmlmb3JtIG1hdDQgYmluZE1hdHJpeDsKCXVuaWZvcm0gbWF0NCBiaW5kTWF0cml4SW52ZXJzZTsKCXVuaWZvcm0gaGlnaHAgc2FtcGxlcjJEIGJvbmVUZXh0dXJlOwoJbWF0NCBnZXRCb25lTWF0cml4KCBjb25zdCBpbiBmbG9hdCBpICkgewoJCWludCBzaXplID0gdGV4dHVyZVNpemUoIGJvbmVUZXh0dXJlLCAwICkueDsKCQlpbnQgaiA9IGludCggaSApICogNDsKCQlpbnQgeCA9IGogJSBzaXplOwoJCWludCB5ID0gaiAvIHNpemU7CgkJdmVjNCB2MSA9IHRleGVsRmV0Y2goIGJvbmVUZXh0dXJlLCBpdmVjMiggeCwgeSApLCAwICk7CgkJdmVjNCB2MiA9IHRleGVsRmV0Y2goIGJvbmVUZXh0dXJlLCBpdmVjMiggeCArIDEsIHkgKSwgMCApOwoJCXZlYzQgdjMgPSB0ZXhlbEZldGNoKCBib25lVGV4dHVyZSwgaXZlYzIoIHggKyAyLCB5ICksIDAgKTsKCQl2ZWM0IHY0ID0gdGV4ZWxGZXRjaCggYm9uZVRleHR1cmUsIGl2ZWMyKCB4ICsgMywgeSApLCAwICk7CgkJcmV0dXJuIG1hdDQoIHYxLCB2MiwgdjMsIHY0ICk7Cgl9CiNlbmRpZmAsIEwxID0gYCNpZmRlZiBVU0VfU0tJTk5JTkcKCXZlYzQgc2tpblZlcnRleCA9IGJpbmRNYXRyaXggKiB2ZWM0KCB0cmFuc2Zvcm1lZCwgMS4wICk7Cgl2ZWM0IHNraW5uZWQgPSB2ZWM0KCAwLjAgKTsKCXNraW5uZWQgKz0gYm9uZU1hdFggKiBza2luVmVydGV4ICogc2tpbldlaWdodC54OwoJc2tpbm5lZCArPSBib25lTWF0WSAqIHNraW5WZXJ0ZXggKiBza2luV2VpZ2h0Lnk7Cglza2lubmVkICs9IGJvbmVNYXRaICogc2tpblZlcnRleCAqIHNraW5XZWlnaHQuejsKCXNraW5uZWQgKz0gYm9uZU1hdFcgKiBza2luVmVydGV4ICogc2tpbldlaWdodC53OwoJdHJhbnNmb3JtZWQgPSAoIGJpbmRNYXRyaXhJbnZlcnNlICogc2tpbm5lZCApLnh5ejsKI2VuZGlmYCwgRDEgPSBgI2lmZGVmIFVTRV9TS0lOTklORwoJbWF0NCBza2luTWF0cml4ID0gbWF0NCggMC4wICk7Cglza2luTWF0cml4ICs9IHNraW5XZWlnaHQueCAqIGJvbmVNYXRYOwoJc2tpbk1hdHJpeCArPSBza2luV2VpZ2h0LnkgKiBib25lTWF0WTsKCXNraW5NYXRyaXggKz0gc2tpbldlaWdodC56ICogYm9uZU1hdFo7Cglza2luTWF0cml4ICs9IHNraW5XZWlnaHQudyAqIGJvbmVNYXRXOwoJc2tpbk1hdHJpeCA9IGJpbmRNYXRyaXhJbnZlcnNlICogc2tpbk1hdHJpeCAqIGJpbmRNYXRyaXg7CglvYmplY3ROb3JtYWwgPSB2ZWM0KCBza2luTWF0cml4ICogdmVjNCggb2JqZWN0Tm9ybWFsLCAwLjAgKSApLnh5ejsKCSNpZmRlZiBVU0VfVEFOR0VOVAoJCW9iamVjdFRhbmdlbnQgPSB2ZWM0KCBza2luTWF0cml4ICogdmVjNCggb2JqZWN0VGFuZ2VudCwgMC4wICkgKS54eXo7CgkjZW5kaWYKI2VuZGlmYCwgRjEgPSBgZmxvYXQgc3BlY3VsYXJTdHJlbmd0aDsKI2lmZGVmIFVTRV9TUEVDVUxBUk1BUAoJdmVjNCB0ZXhlbFNwZWN1bGFyID0gdGV4dHVyZTJEKCBzcGVjdWxhck1hcCwgdlNwZWN1bGFyTWFwVXYgKTsKCXNwZWN1bGFyU3RyZW5ndGggPSB0ZXhlbFNwZWN1bGFyLnI7CiNlbHNlCglzcGVjdWxhclN0cmVuZ3RoID0gMS4wOwojZW5kaWZgLCBVMSA9IGAjaWZkZWYgVVNFX1NQRUNVTEFSTUFQCgl1bmlmb3JtIHNhbXBsZXIyRCBzcGVjdWxhck1hcDsKI2VuZGlmYCwgQjEgPSBgI2lmIGRlZmluZWQoIFRPTkVfTUFQUElORyApCglnbF9GcmFnQ29sb3IucmdiID0gdG9uZU1hcHBpbmcoIGdsX0ZyYWdDb2xvci5yZ2IgKTsKI2VuZGlmYCwgejEgPSBgI2lmbmRlZiBzYXR1cmF0ZQojZGVmaW5lIHNhdHVyYXRlKCBhICkgY2xhbXAoIGEsIDAuMCwgMS4wICkKI2VuZGlmCnVuaWZvcm0gZmxvYXQgdG9uZU1hcHBpbmdFeHBvc3VyZTsKdmVjMyBMaW5lYXJUb25lTWFwcGluZyggdmVjMyBjb2xvciApIHsKCXJldHVybiBzYXR1cmF0ZSggdG9uZU1hcHBpbmdFeHBvc3VyZSAqIGNvbG9yICk7Cn0KdmVjMyBSZWluaGFyZFRvbmVNYXBwaW5nKCB2ZWMzIGNvbG9yICkgewoJY29sb3IgKj0gdG9uZU1hcHBpbmdFeHBvc3VyZTsKCXJldHVybiBzYXR1cmF0ZSggY29sb3IgLyAoIHZlYzMoIDEuMCApICsgY29sb3IgKSApOwp9CnZlYzMgQ2luZW9uVG9uZU1hcHBpbmcoIHZlYzMgY29sb3IgKSB7Cgljb2xvciAqPSB0b25lTWFwcGluZ0V4cG9zdXJlOwoJY29sb3IgPSBtYXgoIHZlYzMoIDAuMCApLCBjb2xvciAtIDAuMDA0ICk7CglyZXR1cm4gcG93KCAoIGNvbG9yICogKCA2LjIgKiBjb2xvciArIDAuNSApICkgLyAoIGNvbG9yICogKCA2LjIgKiBjb2xvciArIDEuNyApICsgMC4wNiApLCB2ZWMzKCAyLjIgKSApOwp9CnZlYzMgUlJUQW5kT0RURml0KCB2ZWMzIHYgKSB7Cgl2ZWMzIGEgPSB2ICogKCB2ICsgMC4wMjQ1Nzg2ICkgLSAwLjAwMDA5MDUzNzsKCXZlYzMgYiA9IHYgKiAoIDAuOTgzNzI5ICogdiArIDAuNDMyOTUxMCApICsgMC4yMzgwODE7CglyZXR1cm4gYSAvIGI7Cn0KdmVjMyBBQ0VTRmlsbWljVG9uZU1hcHBpbmcoIHZlYzMgY29sb3IgKSB7Cgljb25zdCBtYXQzIEFDRVNJbnB1dE1hdCA9IG1hdDMoCgkJdmVjMyggMC41OTcxOSwgMC4wNzYwMCwgMC4wMjg0MCApLAkJdmVjMyggMC4zNTQ1OCwgMC45MDgzNCwgMC4xMzM4MyApLAoJCXZlYzMoIDAuMDQ4MjMsIDAuMDE1NjYsIDAuODM3NzcgKQoJKTsKCWNvbnN0IG1hdDMgQUNFU091dHB1dE1hdCA9IG1hdDMoCgkJdmVjMyggIDEuNjA0NzUsIC0wLjEwMjA4LCAtMC4wMDMyNyApLAkJdmVjMyggLTAuNTMxMDgsICAxLjEwODEzLCAtMC4wNzI3NiApLAoJCXZlYzMoIC0wLjA3MzY3LCAtMC4wMDYwNSwgIDEuMDc2MDIgKQoJKTsKCWNvbG9yICo9IHRvbmVNYXBwaW5nRXhwb3N1cmUgLyAwLjY7Cgljb2xvciA9IEFDRVNJbnB1dE1hdCAqIGNvbG9yOwoJY29sb3IgPSBSUlRBbmRPRFRGaXQoIGNvbG9yICk7Cgljb2xvciA9IEFDRVNPdXRwdXRNYXQgKiBjb2xvcjsKCXJldHVybiBzYXR1cmF0ZSggY29sb3IgKTsKfQpjb25zdCBtYXQzIExJTkVBUl9SRUMyMDIwX1RPX0xJTkVBUl9TUkdCID0gbWF0MygKCXZlYzMoIDEuNjYwNSwgLSAwLjEyNDYsIC0gMC4wMTgyICksCgl2ZWMzKCAtIDAuNTg3NiwgMS4xMzI5LCAtIDAuMTAwNiApLAoJdmVjMyggLSAwLjA3MjgsIC0gMC4wMDgzLCAxLjExODcgKQopOwpjb25zdCBtYXQzIExJTkVBUl9TUkdCX1RPX0xJTkVBUl9SRUMyMDIwID0gbWF0MygKCXZlYzMoIDAuNjI3NCwgMC4wNjkxLCAwLjAxNjQgKSwKCXZlYzMoIDAuMzI5MywgMC45MTk1LCAwLjA4ODAgKSwKCXZlYzMoIDAuMDQzMywgMC4wMTEzLCAwLjg5NTYgKQopOwp2ZWMzIGFneERlZmF1bHRDb250cmFzdEFwcHJveCggdmVjMyB4ICkgewoJdmVjMyB4MiA9IHggKiB4OwoJdmVjMyB4NCA9IHgyICogeDI7CglyZXR1cm4gKyAxNS41ICogeDQgKiB4MgoJCS0gNDAuMTQgKiB4NCAqIHgKCQkrIDMxLjk2ICogeDQKCQktIDYuODY4ICogeDIgKiB4CgkJKyAwLjQyOTggKiB4MgoJCSsgMC4xMTkxICogeAoJCS0gMC4wMDIzMjsKfQp2ZWMzIEFnWFRvbmVNYXBwaW5nKCB2ZWMzIGNvbG9yICkgewoJY29uc3QgbWF0MyBBZ1hJbnNldE1hdHJpeCA9IG1hdDMoCgkJdmVjMyggMC44NTY2MjcxNTMzMTU5ODMsIDAuMTM3MzE4OTcyOTI5ODQ3LCAwLjExMTg5ODIxMjk5OTk1ICksCgkJdmVjMyggMC4wOTUxMjEyNDA1MzgxNTg4LCAwLjc2MTI0MTk5MDYwMjU5MSwgMC4wNzY3OTk0MTg2MDMxOTAzICksCgkJdmVjMyggMC4wNDgyNTE2MDYxNDU4NTgzLCAwLjEwMTQzOTAzNjQ2NzU2MiwgMC44MTEzMDIzNjgzOTY4NTkgKQoJKTsKCWNvbnN0IG1hdDMgQWdYT3V0c2V0TWF0cml4ID0gbWF0MygKCQl2ZWMzKCAxLjEyNzEwMDU4MTgxNDQzNjgsIC0gMC4xNDEzMjk3NjM0OTg0MzgzLCAtIDAuMTQxMzI5NzYzNDk4NDM4MjYgKSwKCQl2ZWMzKCAtIDAuMTEwNjA2NjQzMDk2NjAzMjMsIDEuMTU3ODIzNzAyMjE2MjcyLCAtIDAuMTEwNjA2NjQzMDk2NjAyOTQgKSwKCQl2ZWMzKCAtIDAuMDE2NDkzOTM4NzE3ODM0NTczLCAtIDAuMDE2NDkzOTM4NzE3ODM0MjU3LCAxLjI1MTkzNjQwNjU5NTA0MDUgKQoJKTsKCWNvbnN0IGZsb2F0IEFneE1pbkV2ID0gLSAxMi40NzM5MzsJY29uc3QgZmxvYXQgQWd4TWF4RXYgPSA0LjAyNjA2OTsKCWNvbG9yICo9IHRvbmVNYXBwaW5nRXhwb3N1cmU7Cgljb2xvciA9IExJTkVBUl9TUkdCX1RPX0xJTkVBUl9SRUMyMDIwICogY29sb3I7Cgljb2xvciA9IEFnWEluc2V0TWF0cml4ICogY29sb3I7Cgljb2xvciA9IG1heCggY29sb3IsIDFlLTEwICk7CWNvbG9yID0gbG9nMiggY29sb3IgKTsKCWNvbG9yID0gKCBjb2xvciAtIEFneE1pbkV2ICkgLyAoIEFneE1heEV2IC0gQWd4TWluRXYgKTsKCWNvbG9yID0gY2xhbXAoIGNvbG9yLCAwLjAsIDEuMCApOwoJY29sb3IgPSBhZ3hEZWZhdWx0Q29udHJhc3RBcHByb3goIGNvbG9yICk7Cgljb2xvciA9IEFnWE91dHNldE1hdHJpeCAqIGNvbG9yOwoJY29sb3IgPSBwb3coIG1heCggdmVjMyggMC4wICksIGNvbG9yICksIHZlYzMoIDIuMiApICk7Cgljb2xvciA9IExJTkVBUl9SRUMyMDIwX1RPX0xJTkVBUl9TUkdCICogY29sb3I7Cgljb2xvciA9IGNsYW1wKCBjb2xvciwgMC4wLCAxLjAgKTsKCXJldHVybiBjb2xvcjsKfQp2ZWMzIE5ldXRyYWxUb25lTWFwcGluZyggdmVjMyBjb2xvciApIHsKCWNvbnN0IGZsb2F0IFN0YXJ0Q29tcHJlc3Npb24gPSAwLjggLSAwLjA0OwoJY29uc3QgZmxvYXQgRGVzYXR1cmF0aW9uID0gMC4xNTsKCWNvbG9yICo9IHRvbmVNYXBwaW5nRXhwb3N1cmU7CglmbG9hdCB4ID0gbWluKCBjb2xvci5yLCBtaW4oIGNvbG9yLmcsIGNvbG9yLmIgKSApOwoJZmxvYXQgb2Zmc2V0ID0geCA8IDAuMDggPyB4IC0gNi4yNSAqIHggKiB4IDogMC4wNDsKCWNvbG9yIC09IG9mZnNldDsKCWZsb2F0IHBlYWsgPSBtYXgoIGNvbG9yLnIsIG1heCggY29sb3IuZywgY29sb3IuYiApICk7CglpZiAoIHBlYWsgPCBTdGFydENvbXByZXNzaW9uICkgcmV0dXJuIGNvbG9yOwoJZmxvYXQgZCA9IDEuIC0gU3RhcnRDb21wcmVzc2lvbjsKCWZsb2F0IG5ld1BlYWsgPSAxLiAtIGQgKiBkIC8gKCBwZWFrICsgZCAtIFN0YXJ0Q29tcHJlc3Npb24gKTsKCWNvbG9yICo9IG5ld1BlYWsgLyBwZWFrOwoJZmxvYXQgZyA9IDEuIC0gMS4gLyAoIERlc2F0dXJhdGlvbiAqICggcGVhayAtIG5ld1BlYWsgKSArIDEuICk7CglyZXR1cm4gbWl4KCBjb2xvciwgdmVjMyggbmV3UGVhayApLCBnICk7Cn0KdmVjMyBDdXN0b21Ub25lTWFwcGluZyggdmVjMyBjb2xvciApIHsgcmV0dXJuIGNvbG9yOyB9YCwgTjEgPSBgI2lmZGVmIFVTRV9UUkFOU01JU1NJT04KCW1hdGVyaWFsLnRyYW5zbWlzc2lvbiA9IHRyYW5zbWlzc2lvbjsKCW1hdGVyaWFsLnRyYW5zbWlzc2lvbkFscGhhID0gMS4wOwoJbWF0ZXJpYWwudGhpY2tuZXNzID0gdGhpY2tuZXNzOwoJbWF0ZXJpYWwuYXR0ZW51YXRpb25EaXN0YW5jZSA9IGF0dGVudWF0aW9uRGlzdGFuY2U7CgltYXRlcmlhbC5hdHRlbnVhdGlvbkNvbG9yID0gYXR0ZW51YXRpb25Db2xvcjsKCSNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OTUFQCgkJbWF0ZXJpYWwudHJhbnNtaXNzaW9uICo9IHRleHR1cmUyRCggdHJhbnNtaXNzaW9uTWFwLCB2VHJhbnNtaXNzaW9uTWFwVXYgKS5yOwoJI2VuZGlmCgkjaWZkZWYgVVNFX1RISUNLTkVTU01BUAoJCW1hdGVyaWFsLnRoaWNrbmVzcyAqPSB0ZXh0dXJlMkQoIHRoaWNrbmVzc01hcCwgdlRoaWNrbmVzc01hcFV2ICkuZzsKCSNlbmRpZgoJdmVjMyBwb3MgPSB2V29ybGRQb3NpdGlvbjsKCXZlYzMgdiA9IG5vcm1hbGl6ZSggY2FtZXJhUG9zaXRpb24gLSBwb3MgKTsKCXZlYzMgbiA9IGludmVyc2VUcmFuc2Zvcm1EaXJlY3Rpb24oIG5vcm1hbCwgdmlld01hdHJpeCApOwoJdmVjNCB0cmFuc21pdHRlZCA9IGdldElCTFZvbHVtZVJlZnJhY3Rpb24oCgkJbiwgdiwgbWF0ZXJpYWwucm91Z2huZXNzLCBtYXRlcmlhbC5kaWZmdXNlQ29sb3IsIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3IsIG1hdGVyaWFsLnNwZWN1bGFyRjkwLAoJCXBvcywgbW9kZWxNYXRyaXgsIHZpZXdNYXRyaXgsIHByb2plY3Rpb25NYXRyaXgsIG1hdGVyaWFsLmRpc3BlcnNpb24sIG1hdGVyaWFsLmlvciwgbWF0ZXJpYWwudGhpY2tuZXNzLAoJCW1hdGVyaWFsLmF0dGVudWF0aW9uQ29sb3IsIG1hdGVyaWFsLmF0dGVudWF0aW9uRGlzdGFuY2UgKTsKCW1hdGVyaWFsLnRyYW5zbWlzc2lvbkFscGhhID0gbWl4KCBtYXRlcmlhbC50cmFuc21pc3Npb25BbHBoYSwgdHJhbnNtaXR0ZWQuYSwgbWF0ZXJpYWwudHJhbnNtaXNzaW9uICk7Cgl0b3RhbERpZmZ1c2UgPSBtaXgoIHRvdGFsRGlmZnVzZSwgdHJhbnNtaXR0ZWQucmdiLCBtYXRlcmlhbC50cmFuc21pc3Npb24gKTsKI2VuZGlmYCwgTzEgPSBgI2lmZGVmIFVTRV9UUkFOU01JU1NJT04KCXVuaWZvcm0gZmxvYXQgdHJhbnNtaXNzaW9uOwoJdW5pZm9ybSBmbG9hdCB0aGlja25lc3M7Cgl1bmlmb3JtIGZsb2F0IGF0dGVudWF0aW9uRGlzdGFuY2U7Cgl1bmlmb3JtIHZlYzMgYXR0ZW51YXRpb25Db2xvcjsKCSNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OTUFQCgkJdW5pZm9ybSBzYW1wbGVyMkQgdHJhbnNtaXNzaW9uTWFwOwoJI2VuZGlmCgkjaWZkZWYgVVNFX1RISUNLTkVTU01BUAoJCXVuaWZvcm0gc2FtcGxlcjJEIHRoaWNrbmVzc01hcDsKCSNlbmRpZgoJdW5pZm9ybSB2ZWMyIHRyYW5zbWlzc2lvblNhbXBsZXJTaXplOwoJdW5pZm9ybSBzYW1wbGVyMkQgdHJhbnNtaXNzaW9uU2FtcGxlck1hcDsKCXVuaWZvcm0gbWF0NCBtb2RlbE1hdHJpeDsKCXVuaWZvcm0gbWF0NCBwcm9qZWN0aW9uTWF0cml4OwoJdmFyeWluZyB2ZWMzIHZXb3JsZFBvc2l0aW9uOwoJZmxvYXQgdzAoIGZsb2F0IGEgKSB7CgkJcmV0dXJuICggMS4wIC8gNi4wICkgKiAoIGEgKiAoIGEgKiAoIC0gYSArIDMuMCApIC0gMy4wICkgKyAxLjAgKTsKCX0KCWZsb2F0IHcxKCBmbG9hdCBhICkgewoJCXJldHVybiAoIDEuMCAvIDYuMCApICogKCBhICogIGEgKiAoIDMuMCAqIGEgLSA2LjAgKSArIDQuMCApOwoJfQoJZmxvYXQgdzIoIGZsb2F0IGEgKXsKCQlyZXR1cm4gKCAxLjAgLyA2LjAgKSAqICggYSAqICggYSAqICggLSAzLjAgKiBhICsgMy4wICkgKyAzLjAgKSArIDEuMCApOwoJfQoJZmxvYXQgdzMoIGZsb2F0IGEgKSB7CgkJcmV0dXJuICggMS4wIC8gNi4wICkgKiAoIGEgKiBhICogYSApOwoJfQoJZmxvYXQgZzAoIGZsb2F0IGEgKSB7CgkJcmV0dXJuIHcwKCBhICkgKyB3MSggYSApOwoJfQoJZmxvYXQgZzEoIGZsb2F0IGEgKSB7CgkJcmV0dXJuIHcyKCBhICkgKyB3MyggYSApOwoJfQoJZmxvYXQgaDAoIGZsb2F0IGEgKSB7CgkJcmV0dXJuIC0gMS4wICsgdzEoIGEgKSAvICggdzAoIGEgKSArIHcxKCBhICkgKTsKCX0KCWZsb2F0IGgxKCBmbG9hdCBhICkgewoJCXJldHVybiAxLjAgKyB3MyggYSApIC8gKCB3MiggYSApICsgdzMoIGEgKSApOwoJfQoJdmVjNCBiaWN1YmljKCBzYW1wbGVyMkQgdGV4LCB2ZWMyIHV2LCB2ZWM0IHRleGVsU2l6ZSwgZmxvYXQgbG9kICkgewoJCXV2ID0gdXYgKiB0ZXhlbFNpemUuencgKyAwLjU7CgkJdmVjMiBpdXYgPSBmbG9vciggdXYgKTsKCQl2ZWMyIGZ1diA9IGZyYWN0KCB1diApOwoJCWZsb2F0IGcweCA9IGcwKCBmdXYueCApOwoJCWZsb2F0IGcxeCA9IGcxKCBmdXYueCApOwoJCWZsb2F0IGgweCA9IGgwKCBmdXYueCApOwoJCWZsb2F0IGgxeCA9IGgxKCBmdXYueCApOwoJCWZsb2F0IGgweSA9IGgwKCBmdXYueSApOwoJCWZsb2F0IGgxeSA9IGgxKCBmdXYueSApOwoJCXZlYzIgcDAgPSAoIHZlYzIoIGl1di54ICsgaDB4LCBpdXYueSArIGgweSApIC0gMC41ICkgKiB0ZXhlbFNpemUueHk7CgkJdmVjMiBwMSA9ICggdmVjMiggaXV2LnggKyBoMXgsIGl1di55ICsgaDB5ICkgLSAwLjUgKSAqIHRleGVsU2l6ZS54eTsKCQl2ZWMyIHAyID0gKCB2ZWMyKCBpdXYueCArIGgweCwgaXV2LnkgKyBoMXkgKSAtIDAuNSApICogdGV4ZWxTaXplLnh5OwoJCXZlYzIgcDMgPSAoIHZlYzIoIGl1di54ICsgaDF4LCBpdXYueSArIGgxeSApIC0gMC41ICkgKiB0ZXhlbFNpemUueHk7CgkJcmV0dXJuIGcwKCBmdXYueSApICogKCBnMHggKiB0ZXh0dXJlTG9kKCB0ZXgsIHAwLCBsb2QgKSArIGcxeCAqIHRleHR1cmVMb2QoIHRleCwgcDEsIGxvZCApICkgKwoJCQlnMSggZnV2LnkgKSAqICggZzB4ICogdGV4dHVyZUxvZCggdGV4LCBwMiwgbG9kICkgKyBnMXggKiB0ZXh0dXJlTG9kKCB0ZXgsIHAzLCBsb2QgKSApOwoJfQoJdmVjNCB0ZXh0dXJlQmljdWJpYyggc2FtcGxlcjJEIHNhbXBsZXIsIHZlYzIgdXYsIGZsb2F0IGxvZCApIHsKCQl2ZWMyIGZMb2RTaXplID0gdmVjMiggdGV4dHVyZVNpemUoIHNhbXBsZXIsIGludCggbG9kICkgKSApOwoJCXZlYzIgY0xvZFNpemUgPSB2ZWMyKCB0ZXh0dXJlU2l6ZSggc2FtcGxlciwgaW50KCBsb2QgKyAxLjAgKSApICk7CgkJdmVjMiBmTG9kU2l6ZUludiA9IDEuMCAvIGZMb2RTaXplOwoJCXZlYzIgY0xvZFNpemVJbnYgPSAxLjAgLyBjTG9kU2l6ZTsKCQl2ZWM0IGZTYW1wbGUgPSBiaWN1YmljKCBzYW1wbGVyLCB1diwgdmVjNCggZkxvZFNpemVJbnYsIGZMb2RTaXplICksIGZsb29yKCBsb2QgKSApOwoJCXZlYzQgY1NhbXBsZSA9IGJpY3ViaWMoIHNhbXBsZXIsIHV2LCB2ZWM0KCBjTG9kU2l6ZUludiwgY0xvZFNpemUgKSwgY2VpbCggbG9kICkgKTsKCQlyZXR1cm4gbWl4KCBmU2FtcGxlLCBjU2FtcGxlLCBmcmFjdCggbG9kICkgKTsKCX0KCXZlYzMgZ2V0Vm9sdW1lVHJhbnNtaXNzaW9uUmF5KCBjb25zdCBpbiB2ZWMzIG4sIGNvbnN0IGluIHZlYzMgdiwgY29uc3QgaW4gZmxvYXQgdGhpY2tuZXNzLCBjb25zdCBpbiBmbG9hdCBpb3IsIGNvbnN0IGluIG1hdDQgbW9kZWxNYXRyaXggKSB7CgkJdmVjMyByZWZyYWN0aW9uVmVjdG9yID0gcmVmcmFjdCggLSB2LCBub3JtYWxpemUoIG4gKSwgMS4wIC8gaW9yICk7CgkJdmVjMyBtb2RlbFNjYWxlOwoJCW1vZGVsU2NhbGUueCA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDAgXS54eXogKSApOwoJCW1vZGVsU2NhbGUueSA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDEgXS54eXogKSApOwoJCW1vZGVsU2NhbGUueiA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDIgXS54eXogKSApOwoJCXJldHVybiBub3JtYWxpemUoIHJlZnJhY3Rpb25WZWN0b3IgKSAqIHRoaWNrbmVzcyAqIG1vZGVsU2NhbGU7Cgl9CglmbG9hdCBhcHBseUlvclRvUm91Z2huZXNzKCBjb25zdCBpbiBmbG9hdCByb3VnaG5lc3MsIGNvbnN0IGluIGZsb2F0IGlvciApIHsKCQlyZXR1cm4gcm91Z2huZXNzICogY2xhbXAoIGlvciAqIDIuMCAtIDIuMCwgMC4wLCAxLjAgKTsKCX0KCXZlYzQgZ2V0VHJhbnNtaXNzaW9uU2FtcGxlKCBjb25zdCBpbiB2ZWMyIGZyYWdDb29yZCwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzLCBjb25zdCBpbiBmbG9hdCBpb3IgKSB7CgkJZmxvYXQgbG9kID0gbG9nMiggdHJhbnNtaXNzaW9uU2FtcGxlclNpemUueCApICogYXBwbHlJb3JUb1JvdWdobmVzcyggcm91Z2huZXNzLCBpb3IgKTsKCQlyZXR1cm4gdGV4dHVyZUJpY3ViaWMoIHRyYW5zbWlzc2lvblNhbXBsZXJNYXAsIGZyYWdDb29yZC54eSwgbG9kICk7Cgl9Cgl2ZWMzIHZvbHVtZUF0dGVudWF0aW9uKCBjb25zdCBpbiBmbG9hdCB0cmFuc21pc3Npb25EaXN0YW5jZSwgY29uc3QgaW4gdmVjMyBhdHRlbnVhdGlvbkNvbG9yLCBjb25zdCBpbiBmbG9hdCBhdHRlbnVhdGlvbkRpc3RhbmNlICkgewoJCWlmICggaXNpbmYoIGF0dGVudWF0aW9uRGlzdGFuY2UgKSApIHsKCQkJcmV0dXJuIHZlYzMoIDEuMCApOwoJCX0gZWxzZSB7CgkJCXZlYzMgYXR0ZW51YXRpb25Db2VmZmljaWVudCA9IC1sb2coIGF0dGVudWF0aW9uQ29sb3IgKSAvIGF0dGVudWF0aW9uRGlzdGFuY2U7CgkJCXZlYzMgdHJhbnNtaXR0YW5jZSA9IGV4cCggLSBhdHRlbnVhdGlvbkNvZWZmaWNpZW50ICogdHJhbnNtaXNzaW9uRGlzdGFuY2UgKTsJCQlyZXR1cm4gdHJhbnNtaXR0YW5jZTsKCQl9Cgl9Cgl2ZWM0IGdldElCTFZvbHVtZVJlZnJhY3Rpb24oIGNvbnN0IGluIHZlYzMgbiwgY29uc3QgaW4gdmVjMyB2LCBjb25zdCBpbiBmbG9hdCByb3VnaG5lc3MsIGNvbnN0IGluIHZlYzMgZGlmZnVzZUNvbG9yLAoJCWNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc3BlY3VsYXJGOTAsIGNvbnN0IGluIHZlYzMgcG9zaXRpb24sIGNvbnN0IGluIG1hdDQgbW9kZWxNYXRyaXgsCgkJY29uc3QgaW4gbWF0NCB2aWV3TWF0cml4LCBjb25zdCBpbiBtYXQ0IHByb2pNYXRyaXgsIGNvbnN0IGluIGZsb2F0IGRpc3BlcnNpb24sIGNvbnN0IGluIGZsb2F0IGlvciwgY29uc3QgaW4gZmxvYXQgdGhpY2tuZXNzLAoJCWNvbnN0IGluIHZlYzMgYXR0ZW51YXRpb25Db2xvciwgY29uc3QgaW4gZmxvYXQgYXR0ZW51YXRpb25EaXN0YW5jZSApIHsKCQl2ZWM0IHRyYW5zbWl0dGVkTGlnaHQ7CgkJdmVjMyB0cmFuc21pdHRhbmNlOwoJCSNpZmRlZiBVU0VfRElTUEVSU0lPTgoJCQlmbG9hdCBoYWxmU3ByZWFkID0gKCBpb3IgLSAxLjAgKSAqIDAuMDI1ICogZGlzcGVyc2lvbjsKCQkJdmVjMyBpb3JzID0gdmVjMyggaW9yIC0gaGFsZlNwcmVhZCwgaW9yLCBpb3IgKyBoYWxmU3ByZWFkICk7CgkJCWZvciAoIGludCBpID0gMDsgaSA8IDM7IGkgKysgKSB7CgkJCQl2ZWMzIHRyYW5zbWlzc2lvblJheSA9IGdldFZvbHVtZVRyYW5zbWlzc2lvblJheSggbiwgdiwgdGhpY2tuZXNzLCBpb3JzWyBpIF0sIG1vZGVsTWF0cml4ICk7CgkJCQl2ZWMzIHJlZnJhY3RlZFJheUV4aXQgPSBwb3NpdGlvbiArIHRyYW5zbWlzc2lvblJheTsKCQkJCXZlYzQgbmRjUG9zID0gcHJvak1hdHJpeCAqIHZpZXdNYXRyaXggKiB2ZWM0KCByZWZyYWN0ZWRSYXlFeGl0LCAxLjAgKTsKCQkJCXZlYzIgcmVmcmFjdGlvbkNvb3JkcyA9IG5kY1Bvcy54eSAvIG5kY1Bvcy53OwoJCQkJcmVmcmFjdGlvbkNvb3JkcyArPSAxLjA7CgkJCQlyZWZyYWN0aW9uQ29vcmRzIC89IDIuMDsKCQkJCXZlYzQgdHJhbnNtaXNzaW9uU2FtcGxlID0gZ2V0VHJhbnNtaXNzaW9uU2FtcGxlKCByZWZyYWN0aW9uQ29vcmRzLCByb3VnaG5lc3MsIGlvcnNbIGkgXSApOwoJCQkJdHJhbnNtaXR0ZWRMaWdodFsgaSBdID0gdHJhbnNtaXNzaW9uU2FtcGxlWyBpIF07CgkJCQl0cmFuc21pdHRlZExpZ2h0LmEgKz0gdHJhbnNtaXNzaW9uU2FtcGxlLmE7CgkJCQl0cmFuc21pdHRhbmNlWyBpIF0gPSBkaWZmdXNlQ29sb3JbIGkgXSAqIHZvbHVtZUF0dGVudWF0aW9uKCBsZW5ndGgoIHRyYW5zbWlzc2lvblJheSApLCBhdHRlbnVhdGlvbkNvbG9yLCBhdHRlbnVhdGlvbkRpc3RhbmNlIClbIGkgXTsKCQkJfQoJCQl0cmFuc21pdHRlZExpZ2h0LmEgLz0gMy4wOwoJCSNlbHNlCgkJCXZlYzMgdHJhbnNtaXNzaW9uUmF5ID0gZ2V0Vm9sdW1lVHJhbnNtaXNzaW9uUmF5KCBuLCB2LCB0aGlja25lc3MsIGlvciwgbW9kZWxNYXRyaXggKTsKCQkJdmVjMyByZWZyYWN0ZWRSYXlFeGl0ID0gcG9zaXRpb24gKyB0cmFuc21pc3Npb25SYXk7CgkJCXZlYzQgbmRjUG9zID0gcHJvak1hdHJpeCAqIHZpZXdNYXRyaXggKiB2ZWM0KCByZWZyYWN0ZWRSYXlFeGl0LCAxLjAgKTsKCQkJdmVjMiByZWZyYWN0aW9uQ29vcmRzID0gbmRjUG9zLnh5IC8gbmRjUG9zLnc7CgkJCXJlZnJhY3Rpb25Db29yZHMgKz0gMS4wOwoJCQlyZWZyYWN0aW9uQ29vcmRzIC89IDIuMDsKCQkJdHJhbnNtaXR0ZWRMaWdodCA9IGdldFRyYW5zbWlzc2lvblNhbXBsZSggcmVmcmFjdGlvbkNvb3Jkcywgcm91Z2huZXNzLCBpb3IgKTsKCQkJdHJhbnNtaXR0YW5jZSA9IGRpZmZ1c2VDb2xvciAqIHZvbHVtZUF0dGVudWF0aW9uKCBsZW5ndGgoIHRyYW5zbWlzc2lvblJheSApLCBhdHRlbnVhdGlvbkNvbG9yLCBhdHRlbnVhdGlvbkRpc3RhbmNlICk7CgkJI2VuZGlmCgkJdmVjMyBhdHRlbnVhdGVkQ29sb3IgPSB0cmFuc21pdHRhbmNlICogdHJhbnNtaXR0ZWRMaWdodC5yZ2I7CgkJdmVjMyBGID0gRW52aXJvbm1lbnRCUkRGKCBuLCB2LCBzcGVjdWxhckNvbG9yLCBzcGVjdWxhckY5MCwgcm91Z2huZXNzICk7CgkJZmxvYXQgdHJhbnNtaXR0YW5jZUZhY3RvciA9ICggdHJhbnNtaXR0YW5jZS5yICsgdHJhbnNtaXR0YW5jZS5nICsgdHJhbnNtaXR0YW5jZS5iICkgLyAzLjA7CgkJcmV0dXJuIHZlYzQoICggMS4wIC0gRiApICogYXR0ZW51YXRlZENvbG9yLCAxLjAgLSAoIDEuMCAtIHRyYW5zbWl0dGVkTGlnaHQuYSApICogdHJhbnNtaXR0YW5jZUZhY3RvciApOwoJfQojZW5kaWZgLCBrMSA9IGAjaWYgZGVmaW5lZCggVVNFX1VWICkgfHwgZGVmaW5lZCggVVNFX0FOSVNPVFJPUFkgKQoJdmFyeWluZyB2ZWMyIHZVdjsKI2VuZGlmCiNpZmRlZiBVU0VfTUFQCgl2YXJ5aW5nIHZlYzIgdk1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9BTFBIQU1BUAoJdmFyeWluZyB2ZWMyIHZBbHBoYU1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9MSUdIVE1BUAoJdmFyeWluZyB2ZWMyIHZMaWdodE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9BT01BUAoJdmFyeWluZyB2ZWMyIHZBb01hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9CVU1QTUFQCgl2YXJ5aW5nIHZlYzIgdkJ1bXBNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfTk9STUFMTUFQCgl2YXJ5aW5nIHZlYzIgdk5vcm1hbE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9FTUlTU0lWRU1BUAoJdmFyeWluZyB2ZWMyIHZFbWlzc2l2ZU1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9NRVRBTE5FU1NNQVAKCXZhcnlpbmcgdmVjMiB2TWV0YWxuZXNzTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1JPVUdITkVTU01BUAoJdmFyeWluZyB2ZWMyIHZSb3VnaG5lc3NNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfQU5JU09UUk9QWU1BUAoJdmFyeWluZyB2ZWMyIHZBbmlzb3Ryb3B5TWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVE1BUAoJdmFyeWluZyB2ZWMyIHZDbGVhcmNvYXRNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfQ0xFQVJDT0FUX05PUk1BTE1BUAoJdmFyeWluZyB2ZWMyIHZDbGVhcmNvYXROb3JtYWxNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfQ0xFQVJDT0FUX1JPVUdITkVTU01BUAoJdmFyeWluZyB2ZWMyIHZDbGVhcmNvYXRSb3VnaG5lc3NNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VNQVAKCXZhcnlpbmcgdmVjMiB2SXJpZGVzY2VuY2VNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQCgl2YXJ5aW5nIHZlYzIgdklyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1NIRUVOX0NPTE9STUFQCgl2YXJ5aW5nIHZlYzIgdlNoZWVuQ29sb3JNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfU0hFRU5fUk9VR0hORVNTTUFQCgl2YXJ5aW5nIHZlYzIgdlNoZWVuUm91Z2huZXNzTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1NQRUNVTEFSTUFQCgl2YXJ5aW5nIHZlYzIgdlNwZWN1bGFyTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1NQRUNVTEFSX0NPTE9STUFQCgl2YXJ5aW5nIHZlYzIgdlNwZWN1bGFyQ29sb3JNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfU1BFQ1VMQVJfSU5URU5TSVRZTUFQCgl2YXJ5aW5nIHZlYzIgdlNwZWN1bGFySW50ZW5zaXR5TWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1RSQU5TTUlTU0lPTk1BUAoJdW5pZm9ybSBtYXQzIHRyYW5zbWlzc2lvbk1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2VHJhbnNtaXNzaW9uTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1RISUNLTkVTU01BUAoJdW5pZm9ybSBtYXQzIHRoaWNrbmVzc01hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2VGhpY2tuZXNzTWFwVXY7CiNlbmRpZmAsIFYxID0gYCNpZiBkZWZpbmVkKCBVU0VfVVYgKSB8fCBkZWZpbmVkKCBVU0VfQU5JU09UUk9QWSApCgl2YXJ5aW5nIHZlYzIgdlV2OwojZW5kaWYKI2lmZGVmIFVTRV9NQVAKCXVuaWZvcm0gbWF0MyBtYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdk1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9BTFBIQU1BUAoJdW5pZm9ybSBtYXQzIGFscGhhTWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZBbHBoYU1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9MSUdIVE1BUAoJdW5pZm9ybSBtYXQzIGxpZ2h0TWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZMaWdodE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9BT01BUAoJdW5pZm9ybSBtYXQzIGFvTWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZBb01hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9CVU1QTUFQCgl1bmlmb3JtIG1hdDMgYnVtcE1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2QnVtcE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9OT1JNQUxNQVAKCXVuaWZvcm0gbWF0MyBub3JtYWxNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdk5vcm1hbE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9ESVNQTEFDRU1FTlRNQVAKCXVuaWZvcm0gbWF0MyBkaXNwbGFjZW1lbnRNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdkRpc3BsYWNlbWVudE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9FTUlTU0lWRU1BUAoJdW5pZm9ybSBtYXQzIGVtaXNzaXZlTWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZFbWlzc2l2ZU1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9NRVRBTE5FU1NNQVAKCXVuaWZvcm0gbWF0MyBtZXRhbG5lc3NNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdk1ldGFsbmVzc01hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9ST1VHSE5FU1NNQVAKCXVuaWZvcm0gbWF0MyByb3VnaG5lc3NNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdlJvdWdobmVzc01hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9BTklTT1RST1BZTUFQCgl1bmlmb3JtIG1hdDMgYW5pc290cm9weU1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2QW5pc290cm9weU1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9DTEVBUkNPQVRNQVAKCXVuaWZvcm0gbWF0MyBjbGVhcmNvYXRNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdkNsZWFyY29hdE1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQCgl1bmlmb3JtIG1hdDMgY2xlYXJjb2F0Tm9ybWFsTWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZDbGVhcmNvYXROb3JtYWxNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfQ0xFQVJDT0FUX1JPVUdITkVTU01BUAoJdW5pZm9ybSBtYXQzIGNsZWFyY29hdFJvdWdobmVzc01hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2Q2xlYXJjb2F0Um91Z2huZXNzTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1NIRUVOX0NPTE9STUFQCgl1bmlmb3JtIG1hdDMgc2hlZW5Db2xvck1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2U2hlZW5Db2xvck1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVAKCXVuaWZvcm0gbWF0MyBzaGVlblJvdWdobmVzc01hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2U2hlZW5Sb3VnaG5lc3NNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VNQVAKCXVuaWZvcm0gbWF0MyBpcmlkZXNjZW5jZU1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2SXJpZGVzY2VuY2VNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQCgl1bmlmb3JtIG1hdDMgaXJpZGVzY2VuY2VUaGlja25lc3NNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdklyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1NQRUNVTEFSTUFQCgl1bmlmb3JtIG1hdDMgc3BlY3VsYXJNYXBUcmFuc2Zvcm07Cgl2YXJ5aW5nIHZlYzIgdlNwZWN1bGFyTWFwVXY7CiNlbmRpZgojaWZkZWYgVVNFX1NQRUNVTEFSX0NPTE9STUFQCgl1bmlmb3JtIG1hdDMgc3BlY3VsYXJDb2xvck1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2U3BlY3VsYXJDb2xvck1hcFV2OwojZW5kaWYKI2lmZGVmIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVAKCXVuaWZvcm0gbWF0MyBzcGVjdWxhckludGVuc2l0eU1hcFRyYW5zZm9ybTsKCXZhcnlpbmcgdmVjMiB2U3BlY3VsYXJJbnRlbnNpdHlNYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OTUFQCgl1bmlmb3JtIG1hdDMgdHJhbnNtaXNzaW9uTWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZUcmFuc21pc3Npb25NYXBVdjsKI2VuZGlmCiNpZmRlZiBVU0VfVEhJQ0tORVNTTUFQCgl1bmlmb3JtIG1hdDMgdGhpY2tuZXNzTWFwVHJhbnNmb3JtOwoJdmFyeWluZyB2ZWMyIHZUaGlja25lc3NNYXBVdjsKI2VuZGlmYCwgSDEgPSBgI2lmIGRlZmluZWQoIFVTRV9VViApIHx8IGRlZmluZWQoIFVTRV9BTklTT1RST1BZICkKCXZVdiA9IHZlYzMoIHV2LCAxICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX01BUAoJdk1hcFV2ID0gKCBtYXBUcmFuc2Zvcm0gKiB2ZWMzKCBNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9BTFBIQU1BUAoJdkFscGhhTWFwVXYgPSAoIGFscGhhTWFwVHJhbnNmb3JtICogdmVjMyggQUxQSEFNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9MSUdIVE1BUAoJdkxpZ2h0TWFwVXYgPSAoIGxpZ2h0TWFwVHJhbnNmb3JtICogdmVjMyggTElHSFRNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9BT01BUAoJdkFvTWFwVXYgPSAoIGFvTWFwVHJhbnNmb3JtICogdmVjMyggQU9NQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9CVU1QTUFQCgl2QnVtcE1hcFV2ID0gKCBidW1wTWFwVHJhbnNmb3JtICogdmVjMyggQlVNUE1BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX05PUk1BTE1BUAoJdk5vcm1hbE1hcFV2ID0gKCBub3JtYWxNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBOT1JNQUxNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9ESVNQTEFDRU1FTlRNQVAKCXZEaXNwbGFjZW1lbnRNYXBVdiA9ICggZGlzcGxhY2VtZW50TWFwVHJhbnNmb3JtICogdmVjMyggRElTUExBQ0VNRU5UTUFQX1VWLCAxICkgKS54eTsKI2VuZGlmCiNpZmRlZiBVU0VfRU1JU1NJVkVNQVAKCXZFbWlzc2l2ZU1hcFV2ID0gKCBlbWlzc2l2ZU1hcFRyYW5zZm9ybSAqIHZlYzMoIEVNSVNTSVZFTUFQX1VWLCAxICkgKS54eTsKI2VuZGlmCiNpZmRlZiBVU0VfTUVUQUxORVNTTUFQCgl2TWV0YWxuZXNzTWFwVXYgPSAoIG1ldGFsbmVzc01hcFRyYW5zZm9ybSAqIHZlYzMoIE1FVEFMTkVTU01BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX1JPVUdITkVTU01BUAoJdlJvdWdobmVzc01hcFV2ID0gKCByb3VnaG5lc3NNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBST1VHSE5FU1NNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9BTklTT1RST1BZTUFQCgl2QW5pc290cm9weU1hcFV2ID0gKCBhbmlzb3Ryb3B5TWFwVHJhbnNmb3JtICogdmVjMyggQU5JU09UUk9QWU1BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVE1BUAoJdkNsZWFyY29hdE1hcFV2ID0gKCBjbGVhcmNvYXRNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBDTEVBUkNPQVRNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQCgl2Q2xlYXJjb2F0Tm9ybWFsTWFwVXYgPSAoIGNsZWFyY29hdE5vcm1hbE1hcFRyYW5zZm9ybSAqIHZlYzMoIENMRUFSQ09BVF9OT1JNQUxNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9DTEVBUkNPQVRfUk9VR0hORVNTTUFQCgl2Q2xlYXJjb2F0Um91Z2huZXNzTWFwVXYgPSAoIGNsZWFyY29hdFJvdWdobmVzc01hcFRyYW5zZm9ybSAqIHZlYzMoIENMRUFSQ09BVF9ST1VHSE5FU1NNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9JUklERVNDRU5DRU1BUAoJdklyaWRlc2NlbmNlTWFwVXYgPSAoIGlyaWRlc2NlbmNlTWFwVHJhbnNmb3JtICogdmVjMyggSVJJREVTQ0VOQ0VNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9JUklERVNDRU5DRV9USElDS05FU1NNQVAKCXZJcmlkZXNjZW5jZVRoaWNrbmVzc01hcFV2ID0gKCBpcmlkZXNjZW5jZVRoaWNrbmVzc01hcFRyYW5zZm9ybSAqIHZlYzMoIElSSURFU0NFTkNFX1RISUNLTkVTU01BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX1NIRUVOX0NPTE9STUFQCgl2U2hlZW5Db2xvck1hcFV2ID0gKCBzaGVlbkNvbG9yTWFwVHJhbnNmb3JtICogdmVjMyggU0hFRU5fQ09MT1JNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVAKCXZTaGVlblJvdWdobmVzc01hcFV2ID0gKCBzaGVlblJvdWdobmVzc01hcFRyYW5zZm9ybSAqIHZlYzMoIFNIRUVOX1JPVUdITkVTU01BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX1NQRUNVTEFSTUFQCgl2U3BlY3VsYXJNYXBVdiA9ICggc3BlY3VsYXJNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBTUEVDVUxBUk1BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX1NQRUNVTEFSX0NPTE9STUFQCgl2U3BlY3VsYXJDb2xvck1hcFV2ID0gKCBzcGVjdWxhckNvbG9yTWFwVHJhbnNmb3JtICogdmVjMyggU1BFQ1VMQVJfQ09MT1JNQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVAKCXZTcGVjdWxhckludGVuc2l0eU1hcFV2ID0gKCBzcGVjdWxhckludGVuc2l0eU1hcFRyYW5zZm9ybSAqIHZlYzMoIFNQRUNVTEFSX0lOVEVOU0lUWU1BUF9VViwgMSApICkueHk7CiNlbmRpZgojaWZkZWYgVVNFX1RSQU5TTUlTU0lPTk1BUAoJdlRyYW5zbWlzc2lvbk1hcFV2ID0gKCB0cmFuc21pc3Npb25NYXBUcmFuc2Zvcm0gKiB2ZWMzKCBUUkFOU01JU1NJT05NQVBfVVYsIDEgKSApLnh5OwojZW5kaWYKI2lmZGVmIFVTRV9USElDS05FU1NNQVAKCXZUaGlja25lc3NNYXBVdiA9ICggdGhpY2tuZXNzTWFwVHJhbnNmb3JtICogdmVjMyggVEhJQ0tORVNTTUFQX1VWLCAxICkgKS54eTsKI2VuZGlmYCwgRzEgPSBgI2lmIGRlZmluZWQoIFVTRV9FTlZNQVAgKSB8fCBkZWZpbmVkKCBESVNUQU5DRSApIHx8IGRlZmluZWQgKCBVU0VfU0hBRE9XTUFQICkgfHwgZGVmaW5lZCAoIFVTRV9UUkFOU01JU1NJT04gKSB8fCBOVU1fU1BPVF9MSUdIVF9DT09SRFMgPiAwCgl2ZWM0IHdvcmxkUG9zaXRpb24gPSB2ZWM0KCB0cmFuc2Zvcm1lZCwgMS4wICk7CgkjaWZkZWYgVVNFX0JBVENISU5HCgkJd29ybGRQb3NpdGlvbiA9IGJhdGNoaW5nTWF0cml4ICogd29ybGRQb3NpdGlvbjsKCSNlbmRpZgoJI2lmZGVmIFVTRV9JTlNUQU5DSU5HCgkJd29ybGRQb3NpdGlvbiA9IGluc3RhbmNlTWF0cml4ICogd29ybGRQb3NpdGlvbjsKCSNlbmRpZgoJd29ybGRQb3NpdGlvbiA9IG1vZGVsTWF0cml4ICogd29ybGRQb3NpdGlvbjsKI2VuZGlmYDsKY29uc3QgVzEgPSBgdmFyeWluZyB2ZWMyIHZVdjsKdW5pZm9ybSBtYXQzIHV2VHJhbnNmb3JtOwp2b2lkIG1haW4oKSB7Cgl2VXYgPSAoIHV2VHJhbnNmb3JtICogdmVjMyggdXYsIDEgKSApLnh5OwoJZ2xfUG9zaXRpb24gPSB2ZWM0KCBwb3NpdGlvbi54eSwgMS4wLCAxLjAgKTsKfWAsIHExID0gYHVuaWZvcm0gc2FtcGxlcjJEIHQyRDsKdW5pZm9ybSBmbG9hdCBiYWNrZ3JvdW5kSW50ZW5zaXR5Owp2YXJ5aW5nIHZlYzIgdlV2Owp2b2lkIG1haW4oKSB7Cgl2ZWM0IHRleENvbG9yID0gdGV4dHVyZTJEKCB0MkQsIHZVdiApOwoJI2lmZGVmIERFQ09ERV9WSURFT19URVhUVVJFCgkJdGV4Q29sb3IgPSB2ZWM0KCBtaXgoIHBvdyggdGV4Q29sb3IucmdiICogMC45NDc4NjcyOTg2ICsgdmVjMyggMC4wNTIxMzI3MDE0ICksIHZlYzMoIDIuNCApICksIHRleENvbG9yLnJnYiAqIDAuMDc3Mzk5MzgwOCwgdmVjMyggbGVzc1RoYW5FcXVhbCggdGV4Q29sb3IucmdiLCB2ZWMzKCAwLjA0MDQ1ICkgKSApICksIHRleENvbG9yLncgKTsKCSNlbmRpZgoJdGV4Q29sb3IucmdiICo9IGJhY2tncm91bmRJbnRlbnNpdHk7CglnbF9GcmFnQ29sb3IgPSB0ZXhDb2xvcjsKCSNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50Pgp9YCwgJDEgPSBgdmFyeWluZyB2ZWMzIHZXb3JsZERpcmVjdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4Kdm9pZCBtYWluKCkgewoJdldvcmxkRGlyZWN0aW9uID0gdHJhbnNmb3JtRGlyZWN0aW9uKCBwb3NpdGlvbiwgbW9kZWxNYXRyaXggKTsKCSNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CgkjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+CglnbF9Qb3NpdGlvbi56ID0gZ2xfUG9zaXRpb24udzsKfWAsIFgxID0gYCNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFCgl1bmlmb3JtIHNhbXBsZXJDdWJlIGVudk1hcDsKI2VsaWYgZGVmaW5lZCggRU5WTUFQX1RZUEVfQ1VCRV9VViApCgl1bmlmb3JtIHNhbXBsZXIyRCBlbnZNYXA7CiNlbmRpZgp1bmlmb3JtIGZsb2F0IGZsaXBFbnZNYXA7CnVuaWZvcm0gZmxvYXQgYmFja2dyb3VuZEJsdXJyaW5lc3M7CnVuaWZvcm0gZmxvYXQgYmFja2dyb3VuZEludGVuc2l0eTsKdW5pZm9ybSBtYXQzIGJhY2tncm91bmRSb3RhdGlvbjsKdmFyeWluZyB2ZWMzIHZXb3JsZERpcmVjdGlvbjsKI2luY2x1ZGUgPGN1YmVfdXZfcmVmbGVjdGlvbl9mcmFnbWVudD4Kdm9pZCBtYWluKCkgewoJI2lmZGVmIEVOVk1BUF9UWVBFX0NVQkUKCQl2ZWM0IHRleENvbG9yID0gdGV4dHVyZUN1YmUoIGVudk1hcCwgYmFja2dyb3VuZFJvdGF0aW9uICogdmVjMyggZmxpcEVudk1hcCAqIHZXb3JsZERpcmVjdGlvbi54LCB2V29ybGREaXJlY3Rpb24ueXogKSApOwoJI2VsaWYgZGVmaW5lZCggRU5WTUFQX1RZUEVfQ1VCRV9VViApCgkJdmVjNCB0ZXhDb2xvciA9IHRleHR1cmVDdWJlVVYoIGVudk1hcCwgYmFja2dyb3VuZFJvdGF0aW9uICogdldvcmxkRGlyZWN0aW9uLCBiYWNrZ3JvdW5kQmx1cnJpbmVzcyApOwoJI2Vsc2UKCQl2ZWM0IHRleENvbG9yID0gdmVjNCggMC4wLCAwLjAsIDAuMCwgMS4wICk7CgkjZW5kaWYKCXRleENvbG9yLnJnYiAqPSBiYWNrZ3JvdW5kSW50ZW5zaXR5OwoJZ2xfRnJhZ0NvbG9yID0gdGV4Q29sb3I7CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KfWAsIFkxID0gYHZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247CiNpbmNsdWRlIDxjb21tb24+CnZvaWQgbWFpbigpIHsKCXZXb3JsZERpcmVjdGlvbiA9IHRyYW5zZm9ybURpcmVjdGlvbiggcG9zaXRpb24sIG1vZGVsTWF0cml4ICk7CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPHByb2plY3RfdmVydGV4PgoJZ2xfUG9zaXRpb24ueiA9IGdsX1Bvc2l0aW9uLnc7Cn1gLCBaMSA9IGB1bmlmb3JtIHNhbXBsZXJDdWJlIHRDdWJlOwp1bmlmb3JtIGZsb2F0IHRGbGlwOwp1bmlmb3JtIGZsb2F0IG9wYWNpdHk7CnZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247CnZvaWQgbWFpbigpIHsKCXZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlQ3ViZSggdEN1YmUsIHZlYzMoIHRGbGlwICogdldvcmxkRGlyZWN0aW9uLngsIHZXb3JsZERpcmVjdGlvbi55eiApICk7CglnbF9GcmFnQ29sb3IgPSB0ZXhDb2xvcjsKCWdsX0ZyYWdDb2xvci5hICo9IG9wYWNpdHk7CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KfWAsIGoxID0gYCNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxiYXRjaGluZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Pgp2YXJ5aW5nIHZlYzIgdkhpZ2hQcmVjaXNpb25aVzsKdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBoaW5zdGFuY2VfdmVydGV4PgoJI2lmZGVmIFVTRV9ESVNQTEFDRU1FTlRNQVAKCQkjaW5jbHVkZSA8YmVnaW5ub3JtYWxfdmVydGV4PgoJCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2VuZGlmCgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCXZIaWdoUHJlY2lzaW9uWlcgPSBnbF9Qb3NpdGlvbi56dzsKfWAsIEoxID0gYCNpZiBERVBUSF9QQUNLSU5HID09IDMyMDAKCXVuaWZvcm0gZmxvYXQgb3BhY2l0eTsKI2VuZGlmCiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxwYWNraW5nPgojaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+CnZhcnlpbmcgdmVjMiB2SGlnaFByZWNpc2lvblpXOwp2b2lkIG1haW4oKSB7Cgl2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIDEuMCApOwoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCSNpZiBERVBUSF9QQUNLSU5HID09IDMyMDAKCQlkaWZmdXNlQ29sb3IuYSA9IG9wYWNpdHk7CgkjZW5kaWYKCSNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD4KCSNpZmRlZiBVU0VfUkVWRVJTRURfREVQVEhfQlVGRkVSCgkJZmxvYXQgZnJhZ0Nvb3JkWiA9IHZIaWdoUHJlY2lzaW9uWldbIDAgXSAvIHZIaWdoUHJlY2lzaW9uWldbIDEgXTsKCSNlbHNlCgkJZmxvYXQgZnJhZ0Nvb3JkWiA9IDAuNSAqIHZIaWdoUHJlY2lzaW9uWldbIDAgXSAvIHZIaWdoUHJlY2lzaW9uWldbIDEgXSArIDAuNTsKCSNlbmRpZgoJI2lmIERFUFRIX1BBQ0tJTkcgPT0gMzIwMAoJCWdsX0ZyYWdDb2xvciA9IHZlYzQoIHZlYzMoIDEuMCAtIGZyYWdDb29yZFogKSwgb3BhY2l0eSApOwoJI2VsaWYgREVQVEhfUEFDS0lORyA9PSAzMjAxCgkJZ2xfRnJhZ0NvbG9yID0gcGFja0RlcHRoVG9SR0JBKCBmcmFnQ29vcmRaICk7CgkjZWxpZiBERVBUSF9QQUNLSU5HID09IDMyMDIKCQlnbF9GcmFnQ29sb3IgPSB2ZWM0KCBwYWNrRGVwdGhUb1JHQiggZnJhZ0Nvb3JkWiApLCAxLjAgKTsKCSNlbGlmIERFUFRIX1BBQ0tJTkcgPT0gMzIwMwoJCWdsX0ZyYWdDb2xvciA9IHZlYzQoIHBhY2tEZXB0aFRvUkcoIGZyYWdDb29yZFogKSwgMC4wLCAxLjAgKTsKCSNlbmRpZgp9YCwgSzEgPSBgI2RlZmluZSBESVNUQU5DRQp2YXJ5aW5nIHZlYzMgdldvcmxkUG9zaXRpb247CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxiYXRjaGluZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBoaW5zdGFuY2VfdmVydGV4PgoJI2lmZGVmIFVTRV9ESVNQTEFDRU1FTlRNQVAKCQkjaW5jbHVkZSA8YmVnaW5ub3JtYWxfdmVydGV4PgoJCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2VuZGlmCgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDx3b3JsZHBvc192ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCXZXb3JsZFBvc2l0aW9uID0gd29ybGRQb3NpdGlvbi54eXo7Cn1gLCBRMSA9IGAjZGVmaW5lIERJU1RBTkNFCnVuaWZvcm0gdmVjMyByZWZlcmVuY2VQb3NpdGlvbjsKdW5pZm9ybSBmbG9hdCBuZWFyRGlzdGFuY2U7CnVuaWZvcm0gZmxvYXQgZmFyRGlzdGFuY2U7CnZhcnlpbmcgdmVjMyB2V29ybGRQb3NpdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPHBhY2tpbmc+CiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Pgp2b2lkIG1haW4gKCkgewoJdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCAxLjAgKTsKCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhbWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYWhhc2hfZnJhZ21lbnQ+CglmbG9hdCBkaXN0ID0gbGVuZ3RoKCB2V29ybGRQb3NpdGlvbiAtIHJlZmVyZW5jZVBvc2l0aW9uICk7CglkaXN0ID0gKCBkaXN0IC0gbmVhckRpc3RhbmNlICkgLyAoIGZhckRpc3RhbmNlIC0gbmVhckRpc3RhbmNlICk7CglkaXN0ID0gc2F0dXJhdGUoIGRpc3QgKTsKCWdsX0ZyYWdDb2xvciA9IHBhY2tEZXB0aFRvUkdCQSggZGlzdCApOwp9YCwgdHcgPSBgdmFyeWluZyB2ZWMzIHZXb3JsZERpcmVjdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4Kdm9pZCBtYWluKCkgewoJdldvcmxkRGlyZWN0aW9uID0gdHJhbnNmb3JtRGlyZWN0aW9uKCBwb3NpdGlvbiwgbW9kZWxNYXRyaXggKTsKCSNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CgkjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+Cn1gLCBldyA9IGB1bmlmb3JtIHNhbXBsZXIyRCB0RXF1aXJlY3Q7CnZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247CiNpbmNsdWRlIDxjb21tb24+CnZvaWQgbWFpbigpIHsKCXZlYzMgZGlyZWN0aW9uID0gbm9ybWFsaXplKCB2V29ybGREaXJlY3Rpb24gKTsKCXZlYzIgc2FtcGxlVVYgPSBlcXVpcmVjdFV2KCBkaXJlY3Rpb24gKTsKCWdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCggdEVxdWlyZWN0LCBzYW1wbGVVViApOwoJI2luY2x1ZGUgPHRvbmVtYXBwaW5nX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+Cn1gLCBpdyA9IGB1bmlmb3JtIGZsb2F0IHNjYWxlOwphdHRyaWJ1dGUgZmxvYXQgbGluZURpc3RhbmNlOwp2YXJ5aW5nIGZsb2F0IHZMaW5lRGlzdGFuY2U7CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNvbG9yX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJdkxpbmVEaXN0YW5jZSA9IHNjYWxlICogbGluZURpc3RhbmNlOwoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhpbnN0YW5jZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCSNpbmNsdWRlIDxmb2dfdmVydGV4Pgp9YCwgbncgPSBgdW5pZm9ybSB2ZWMzIGRpZmZ1c2U7CnVuaWZvcm0gZmxvYXQgb3BhY2l0eTsKdW5pZm9ybSBmbG9hdCBkYXNoU2l6ZTsKdW5pZm9ybSBmbG9hdCB0b3RhbFNpemU7CnZhcnlpbmcgZmxvYXQgdkxpbmVEaXN0YW5jZTsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudD4Kdm9pZCBtYWluKCkgewoJdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PgoJaWYgKCBtb2QoIHZMaW5lRGlzdGFuY2UsIHRvdGFsU2l6ZSApID4gZGFzaFNpemUgKSB7CgkJZGlzY2FyZDsKCX0KCXZlYzMgb3V0Z29pbmdMaWdodCA9IHZlYzMoIDAuMCApOwoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PgoJI2luY2x1ZGUgPG1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD4KCW91dGdvaW5nTGlnaHQgPSBkaWZmdXNlQ29sb3IucmdiOwoJI2luY2x1ZGUgPG9wYXF1ZV9mcmFnbWVudD4KCSNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGZvZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50Pgp9YCwgc3cgPSBgI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxlbnZtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhpbnN0YW5jZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2lmIGRlZmluZWQgKCBVU0VfRU5WTUFQICkgfHwgZGVmaW5lZCAoIFVTRV9TS0lOTklORyApCgkJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCQkjaW5jbHVkZSA8bW9ycGhub3JtYWxfdmVydGV4PgoJCSNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+CgkJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJCSNpbmNsdWRlIDxkZWZhdWx0bm9ybWFsX3ZlcnRleD4KCSNlbmRpZgoJI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaHRhcmdldF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PgoJI2luY2x1ZGUgPHByb2plY3RfdmVydGV4PgoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD4KCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PgoJI2luY2x1ZGUgPHdvcmxkcG9zX3ZlcnRleD4KCSNpbmNsdWRlIDxlbnZtYXBfdmVydGV4PgoJI2luY2x1ZGUgPGZvZ192ZXJ0ZXg+Cn1gLCBydyA9IGB1bmlmb3JtIHZlYzMgZGlmZnVzZTsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5OwojaWZuZGVmIEZMQVRfU0hBREVECgl2YXJ5aW5nIHZlYzMgdk5vcm1hbDsKI2VuZGlmCiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxkaXRoZXJpbmdfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFvbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsaWdodG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHNwZWN1bGFybWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+CnZvaWQgbWFpbigpIHsKCXZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApOwoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD4KCSNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD4KCSNpbmNsdWRlIDxzcGVjdWxhcm1hcF9mcmFnbWVudD4KCVJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ID0gUmVmbGVjdGVkTGlnaHQoIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApICk7CgkjaWZkZWYgVVNFX0xJR0hUTUFQCgkJdmVjNCBsaWdodE1hcFRleGVsID0gdGV4dHVyZTJEKCBsaWdodE1hcCwgdkxpZ2h0TWFwVXYgKTsKCQlyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gbGlnaHRNYXBUZXhlbC5yZ2IgKiBsaWdodE1hcEludGVuc2l0eSAqIFJFQ0lQUk9DQUxfUEk7CgkjZWxzZQoJCXJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSArPSB2ZWMzKCAxLjAgKTsKCSNlbmRpZgoJI2luY2x1ZGUgPGFvbWFwX2ZyYWdtZW50PgoJcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICo9IGRpZmZ1c2VDb2xvci5yZ2I7Cgl2ZWMzIG91dGdvaW5nTGlnaHQgPSByZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2U7CgkjaW5jbHVkZSA8ZW52bWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPG9wYXF1ZV9mcmFnbWVudD4KCSNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGZvZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGRpdGhlcmluZ19mcmFnbWVudD4KfWAsIGF3ID0gYCNkZWZpbmUgTEFNQkVSVAp2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxlbnZtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhpbnN0YW5jZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCXZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6OwoJI2luY2x1ZGUgPHdvcmxkcG9zX3ZlcnRleD4KCSNpbmNsdWRlIDxlbnZtYXBfdmVydGV4PgoJI2luY2x1ZGUgPHNoYWRvd21hcF92ZXJ0ZXg+CgkjaW5jbHVkZSA8Zm9nX3ZlcnRleD4KfWAsIG93ID0gYCNkZWZpbmUgTEFNQkVSVAp1bmlmb3JtIHZlYzMgZGlmZnVzZTsKdW5pZm9ybSB2ZWMzIGVtaXNzaXZlOwp1bmlmb3JtIGZsb2F0IG9wYWNpdHk7CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxwYWNraW5nPgojaW5jbHVkZSA8ZGl0aGVyaW5nX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhb21hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bGlnaHRtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGVtaXNzaXZlbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxlbnZtYXBfY29tbW9uX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxlbnZtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YnNkZnM+CiNpbmNsdWRlIDxsaWdodHNfcGFyc19iZWdpbj4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bGlnaHRzX2xhbWJlcnRfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHNoYWRvd21hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YnVtcG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bm9ybWFsbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxzcGVjdWxhcm1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Pgp2b2lkIG1haW4oKSB7Cgl2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfZnJhZ21lbnQ+CglSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCA9IFJlZmxlY3RlZExpZ2h0KCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSApOwoJdmVjMyB0b3RhbEVtaXNzaXZlUmFkaWFuY2UgPSBlbWlzc2l2ZTsKCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD4KCSNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD4KCSNpbmNsdWRlIDxzcGVjdWxhcm1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfYmVnaW4+CgkjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X21hcHM+CgkjaW5jbHVkZSA8ZW1pc3NpdmVtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bGlnaHRzX2xhbWJlcnRfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2JlZ2luPgoJI2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9lbmQ+CgkjaW5jbHVkZSA8YW9tYXBfZnJhZ21lbnQ+Cgl2ZWMzIG91dGdvaW5nTGlnaHQgPSByZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICsgcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICsgdG90YWxFbWlzc2l2ZVJhZGlhbmNlOwoJI2luY2x1ZGUgPGVudm1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KCSNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD4KCSNpbmNsdWRlIDxkaXRoZXJpbmdfZnJhZ21lbnQ+Cn1gLCBsdyA9IGAjZGVmaW5lIE1BVENBUAp2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhpbnN0YW5jZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCSNpbmNsdWRlIDxmb2dfdmVydGV4PgoJdlZpZXdQb3NpdGlvbiA9IC0gbXZQb3NpdGlvbi54eXo7Cn1gLCBodyA9IGAjZGVmaW5lIE1BVENBUAp1bmlmb3JtIHZlYzMgZGlmZnVzZTsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5Owp1bmlmb3JtIHNhbXBsZXIyRCBtYXRjYXA7CnZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwojaW5jbHVkZSA8Y29tbW9uPgojaW5jbHVkZSA8ZGl0aGVyaW5nX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YnVtcG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bm9ybWFsbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+CnZvaWQgbWFpbigpIHsKCXZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApOwoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD4KCSNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD4KCSNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfYmVnaW4+CgkjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X21hcHM+Cgl2ZWMzIHZpZXdEaXIgPSBub3JtYWxpemUoIHZWaWV3UG9zaXRpb24gKTsKCXZlYzMgeCA9IG5vcm1hbGl6ZSggdmVjMyggdmlld0Rpci56LCAwLjAsIC0gdmlld0Rpci54ICkgKTsKCXZlYzMgeSA9IGNyb3NzKCB2aWV3RGlyLCB4ICk7Cgl2ZWMyIHV2ID0gdmVjMiggZG90KCB4LCBub3JtYWwgKSwgZG90KCB5LCBub3JtYWwgKSApICogMC40OTUgKyAwLjU7CgkjaWZkZWYgVVNFX01BVENBUAoJCXZlYzQgbWF0Y2FwQ29sb3IgPSB0ZXh0dXJlMkQoIG1hdGNhcCwgdXYgKTsKCSNlbHNlCgkJdmVjNCBtYXRjYXBDb2xvciA9IHZlYzQoIHZlYzMoIG1peCggMC4yLCAwLjgsIHV2LnkgKSApLCAxLjAgKTsKCSNlbmRpZgoJdmVjMyBvdXRnb2luZ0xpZ2h0ID0gZGlmZnVzZUNvbG9yLnJnYiAqIG1hdGNhcENvbG9yLnJnYjsKCSNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KCSNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD4KCSNpbmNsdWRlIDxkaXRoZXJpbmdfZnJhZ21lbnQ+Cn1gLCBjdyA9IGAjZGVmaW5lIE5PUk1BTAojaWYgZGVmaW5lZCggRkxBVF9TSEFERUQgKSB8fCBkZWZpbmVkKCBVU0VfQlVNUE1BUCApIHx8IGRlZmluZWQoIFVTRV9OT1JNQUxNQVBfVEFOR0VOVFNQQUNFICkKCXZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwojZW5kaWYKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxub3JtYWxfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPHNraW5uaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc192ZXJ0ZXg+CnZvaWQgbWFpbigpIHsKCSNpbmNsdWRlIDx1dl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaGluc3RhbmNlX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KI2lmIGRlZmluZWQoIEZMQVRfU0hBREVEICkgfHwgZGVmaW5lZCggVVNFX0JVTVBNQVAgKSB8fCBkZWZpbmVkKCBVU0VfTk9STUFMTUFQX1RBTkdFTlRTUEFDRSApCgl2Vmlld1Bvc2l0aW9uID0gLSBtdlBvc2l0aW9uLnh5ejsKI2VuZGlmCn1gLCB1dyA9IGAjZGVmaW5lIE5PUk1BTAp1bmlmb3JtIGZsb2F0IG9wYWNpdHk7CiNpZiBkZWZpbmVkKCBGTEFUX1NIQURFRCApIHx8IGRlZmluZWQoIFVTRV9CVU1QTUFQICkgfHwgZGVmaW5lZCggVVNFX05PUk1BTE1BUF9UQU5HRU5UU1BBQ0UgKQoJdmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247CiNlbmRpZgojaW5jbHVkZSA8cGFja2luZz4KI2luY2x1ZGUgPHV2X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxub3JtYWxfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGJ1bXBtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Pgp2b2lkIG1haW4oKSB7Cgl2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIDAuMCwgMC4wLCAwLjAsIG9wYWNpdHkgKTsKCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X2JlZ2luPgoJI2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9tYXBzPgoJZ2xfRnJhZ0NvbG9yID0gdmVjNCggcGFja05vcm1hbFRvUkdCKCBub3JtYWwgKSwgZGlmZnVzZUNvbG9yLmEgKTsKCSNpZmRlZiBPUEFRVUUKCQlnbF9GcmFnQ29sb3IuYSA9IDEuMDsKCSNlbmRpZgp9YCwgZHcgPSBgI2RlZmluZSBQSE9ORwp2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxlbnZtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaGluc3RhbmNlX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCXZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6OwoJI2luY2x1ZGUgPHdvcmxkcG9zX3ZlcnRleD4KCSNpbmNsdWRlIDxlbnZtYXBfdmVydGV4PgoJI2luY2x1ZGUgPHNoYWRvd21hcF92ZXJ0ZXg+CgkjaW5jbHVkZSA8Zm9nX3ZlcnRleD4KfWAsIHB3ID0gYCNkZWZpbmUgUEhPTkcKdW5pZm9ybSB2ZWMzIGRpZmZ1c2U7CnVuaWZvcm0gdmVjMyBlbWlzc2l2ZTsKdW5pZm9ybSB2ZWMzIHNwZWN1bGFyOwp1bmlmb3JtIGZsb2F0IHNoaW5pbmVzczsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5OwojaW5jbHVkZSA8Y29tbW9uPgojaW5jbHVkZSA8cGFja2luZz4KI2luY2x1ZGUgPGRpdGhlcmluZ19wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y29sb3JfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHV2X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYXRlc3RfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhaGFzaF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YW9tYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxpZ2h0bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxlbWlzc2l2ZW1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGJzZGZzPgojaW5jbHVkZSA8bGlnaHRzX3BhcnNfYmVnaW4+CiNpbmNsdWRlIDxub3JtYWxfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxpZ2h0c19waG9uZ19wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxidW1wbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxub3JtYWxtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHNwZWN1bGFybWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+CnZvaWQgbWFpbigpIHsKCXZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApOwoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCVJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ID0gUmVmbGVjdGVkTGlnaHQoIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApICk7Cgl2ZWMzIHRvdGFsRW1pc3NpdmVSYWRpYW5jZSA9IGVtaXNzaXZlOwoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PgoJI2luY2x1ZGUgPG1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYXRlc3RfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFoYXNoX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHNwZWN1bGFybWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9iZWdpbj4KCSNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfbWFwcz4KCSNpbmNsdWRlIDxlbWlzc2l2ZW1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxsaWdodHNfcGhvbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2JlZ2luPgoJI2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9lbmQ+CgkjaW5jbHVkZSA8YW9tYXBfZnJhZ21lbnQ+Cgl2ZWMzIG91dGdvaW5nTGlnaHQgPSByZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICsgcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICsgcmVmbGVjdGVkTGlnaHQuZGlyZWN0U3BlY3VsYXIgKyByZWZsZWN0ZWRMaWdodC5pbmRpcmVjdFNwZWN1bGFyICsgdG90YWxFbWlzc2l2ZVJhZGlhbmNlOwoJI2luY2x1ZGUgPGVudm1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KCSNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD4KCSNpbmNsdWRlIDxkaXRoZXJpbmdfZnJhZ21lbnQ+Cn1gLCBmdyA9IGAjZGVmaW5lIFNUQU5EQVJECnZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwojaWZkZWYgVVNFX1RSQU5TTUlTU0lPTgoJdmFyeWluZyB2ZWMzIHZXb3JsZFBvc2l0aW9uOwojZW5kaWYKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhpbnN0YW5jZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCXZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6OwoJI2luY2x1ZGUgPHdvcmxkcG9zX3ZlcnRleD4KCSNpbmNsdWRlIDxzaGFkb3dtYXBfdmVydGV4PgoJI2luY2x1ZGUgPGZvZ192ZXJ0ZXg+CiNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OCgl2V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24ueHl6OwojZW5kaWYKfWAsIG13ID0gYCNkZWZpbmUgU1RBTkRBUkQKI2lmZGVmIFBIWVNJQ0FMCgkjZGVmaW5lIElPUgoJI2RlZmluZSBVU0VfU1BFQ1VMQVIKI2VuZGlmCnVuaWZvcm0gdmVjMyBkaWZmdXNlOwp1bmlmb3JtIHZlYzMgZW1pc3NpdmU7CnVuaWZvcm0gZmxvYXQgcm91Z2huZXNzOwp1bmlmb3JtIGZsb2F0IG1ldGFsbmVzczsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5OwojaWZkZWYgSU9SCgl1bmlmb3JtIGZsb2F0IGlvcjsKI2VuZGlmCiNpZmRlZiBVU0VfU1BFQ1VMQVIKCXVuaWZvcm0gZmxvYXQgc3BlY3VsYXJJbnRlbnNpdHk7Cgl1bmlmb3JtIHZlYzMgc3BlY3VsYXJDb2xvcjsKCSNpZmRlZiBVU0VfU1BFQ1VMQVJfQ09MT1JNQVAKCQl1bmlmb3JtIHNhbXBsZXIyRCBzcGVjdWxhckNvbG9yTWFwOwoJI2VuZGlmCgkjaWZkZWYgVVNFX1NQRUNVTEFSX0lOVEVOU0lUWU1BUAoJCXVuaWZvcm0gc2FtcGxlcjJEIHNwZWN1bGFySW50ZW5zaXR5TWFwOwoJI2VuZGlmCiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVAoJdW5pZm9ybSBmbG9hdCBjbGVhcmNvYXQ7Cgl1bmlmb3JtIGZsb2F0IGNsZWFyY29hdFJvdWdobmVzczsKI2VuZGlmCiNpZmRlZiBVU0VfRElTUEVSU0lPTgoJdW5pZm9ybSBmbG9hdCBkaXNwZXJzaW9uOwojZW5kaWYKI2lmZGVmIFVTRV9JUklERVNDRU5DRQoJdW5pZm9ybSBmbG9hdCBpcmlkZXNjZW5jZTsKCXVuaWZvcm0gZmxvYXQgaXJpZGVzY2VuY2VJT1I7Cgl1bmlmb3JtIGZsb2F0IGlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bTsKCXVuaWZvcm0gZmxvYXQgaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtOwojZW5kaWYKI2lmZGVmIFVTRV9TSEVFTgoJdW5pZm9ybSB2ZWMzIHNoZWVuQ29sb3I7Cgl1bmlmb3JtIGZsb2F0IHNoZWVuUm91Z2huZXNzOwoJI2lmZGVmIFVTRV9TSEVFTl9DT0xPUk1BUAoJCXVuaWZvcm0gc2FtcGxlcjJEIHNoZWVuQ29sb3JNYXA7CgkjZW5kaWYKCSNpZmRlZiBVU0VfU0hFRU5fUk9VR0hORVNTTUFQCgkJdW5pZm9ybSBzYW1wbGVyMkQgc2hlZW5Sb3VnaG5lc3NNYXA7CgkjZW5kaWYKI2VuZGlmCiNpZmRlZiBVU0VfQU5JU09UUk9QWQoJdW5pZm9ybSB2ZWMyIGFuaXNvdHJvcHlWZWN0b3I7CgkjaWZkZWYgVVNFX0FOSVNPVFJPUFlNQVAKCQl1bmlmb3JtIHNhbXBsZXIyRCBhbmlzb3Ryb3B5TWFwOwoJI2VuZGlmCiNlbmRpZgp2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPHBhY2tpbmc+CiNpbmNsdWRlIDxkaXRoZXJpbmdfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFvbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsaWdodG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW1pc3NpdmVtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGlyaWRlc2NlbmNlX2ZyYWdtZW50PgojaW5jbHVkZSA8Y3ViZV91dl9yZWZsZWN0aW9uX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxpZ2h0c19wYXJzX2JlZ2luPgojaW5jbHVkZSA8bm9ybWFsX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsaWdodHNfcGh5c2ljYWxfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHRyYW5zbWlzc2lvbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxidW1wbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxub3JtYWxtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNsZWFyY29hdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8aXJpZGVzY2VuY2VfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHJvdWdobmVzc21hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWV0YWxuZXNzbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+CnZvaWQgbWFpbigpIHsKCXZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApOwoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCVJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ID0gUmVmbGVjdGVkTGlnaHQoIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApICk7Cgl2ZWMzIHRvdGFsRW1pc3NpdmVSYWRpYW5jZSA9IGVtaXNzaXZlOwoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PgoJI2luY2x1ZGUgPG1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYXRlc3RfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFoYXNoX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHJvdWdobmVzc21hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxtZXRhbG5lc3NtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X2JlZ2luPgoJI2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGNsZWFyY29hdF9ub3JtYWxfZnJhZ21lbnRfYmVnaW4+CgkjaW5jbHVkZSA8Y2xlYXJjb2F0X25vcm1hbF9mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGVtaXNzaXZlbWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGxpZ2h0c19waHlzaWNhbF9mcmFnbWVudD4KCSNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfYmVnaW4+CgkjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X21hcHM+CgkjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2VuZD4KCSNpbmNsdWRlIDxhb21hcF9mcmFnbWVudD4KCXZlYzMgdG90YWxEaWZmdXNlID0gcmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArIHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZTsKCXZlYzMgdG90YWxTcGVjdWxhciA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdFNwZWN1bGFyICsgcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3RTcGVjdWxhcjsKCSNpbmNsdWRlIDx0cmFuc21pc3Npb25fZnJhZ21lbnQ+Cgl2ZWMzIG91dGdvaW5nTGlnaHQgPSB0b3RhbERpZmZ1c2UgKyB0b3RhbFNwZWN1bGFyICsgdG90YWxFbWlzc2l2ZVJhZGlhbmNlOwoJI2lmZGVmIFVTRV9TSEVFTgoJCWZsb2F0IHNoZWVuRW5lcmd5Q29tcCA9IDEuMCAtIDAuMTU3ICogbWF4MyggbWF0ZXJpYWwuc2hlZW5Db2xvciApOwoJCW91dGdvaW5nTGlnaHQgPSBvdXRnb2luZ0xpZ2h0ICogc2hlZW5FbmVyZ3lDb21wICsgc2hlZW5TcGVjdWxhckRpcmVjdCArIHNoZWVuU3BlY3VsYXJJbmRpcmVjdDsKCSNlbmRpZgoJI2lmZGVmIFVTRV9DTEVBUkNPQVQKCQlmbG9hdCBkb3ROVmNjID0gc2F0dXJhdGUoIGRvdCggZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGdlb21ldHJ5Vmlld0RpciApICk7CgkJdmVjMyBGY2MgPSBGX1NjaGxpY2soIG1hdGVyaWFsLmNsZWFyY29hdEYwLCBtYXRlcmlhbC5jbGVhcmNvYXRGOTAsIGRvdE5WY2MgKTsKCQlvdXRnb2luZ0xpZ2h0ID0gb3V0Z29pbmdMaWdodCAqICggMS4wIC0gbWF0ZXJpYWwuY2xlYXJjb2F0ICogRmNjICkgKyAoIGNsZWFyY29hdFNwZWN1bGFyRGlyZWN0ICsgY2xlYXJjb2F0U3BlY3VsYXJJbmRpcmVjdCApICogbWF0ZXJpYWwuY2xlYXJjb2F0OwoJI2VuZGlmCgkjaW5jbHVkZSA8b3BhcXVlX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHRvbmVtYXBwaW5nX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Zm9nX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHByZW11bHRpcGxpZWRfYWxwaGFfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8ZGl0aGVyaW5nX2ZyYWdtZW50Pgp9YCwgZ3cgPSBgI2RlZmluZSBUT09OCnZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwojaW5jbHVkZSA8Y29tbW9uPgojaW5jbHVkZSA8YmF0Y2hpbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNvbG9yX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bm9ybWFsX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPHNoYWRvd21hcF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Pgp2b2lkIG1haW4oKSB7CgkjaW5jbHVkZSA8dXZfdmVydGV4PgoJI2luY2x1ZGUgPGNvbG9yX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaGluc3RhbmNlX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaGNvbG9yX3ZlcnRleD4KCSNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBobm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbm5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGVmYXVsdG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8bm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5uaW5nX3ZlcnRleD4KCSNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfdmVydGV4PgoJI2luY2x1ZGUgPHByb2plY3RfdmVydGV4PgoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD4KCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PgoJdlZpZXdQb3NpdGlvbiA9IC0gbXZQb3NpdGlvbi54eXo7CgkjaW5jbHVkZSA8d29ybGRwb3NfdmVydGV4PgoJI2luY2x1ZGUgPHNoYWRvd21hcF92ZXJ0ZXg+CgkjaW5jbHVkZSA8Zm9nX3ZlcnRleD4KfWAsIHl3ID0gYCNkZWZpbmUgVE9PTgp1bmlmb3JtIHZlYzMgZGlmZnVzZTsKdW5pZm9ybSB2ZWMzIGVtaXNzaXZlOwp1bmlmb3JtIGZsb2F0IG9wYWNpdHk7CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxwYWNraW5nPgojaW5jbHVkZSA8ZGl0aGVyaW5nX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhb21hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bGlnaHRtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGVtaXNzaXZlbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxncmFkaWVudG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxic2Rmcz4KI2luY2x1ZGUgPGxpZ2h0c19wYXJzX2JlZ2luPgojaW5jbHVkZSA8bm9ybWFsX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsaWdodHNfdG9vbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxidW1wbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxub3JtYWxtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudD4Kdm9pZCBtYWluKCkgewoJdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PgoJUmVmbGVjdGVkTGlnaHQgcmVmbGVjdGVkTGlnaHQgPSBSZWZsZWN0ZWRMaWdodCggdmVjMyggMC4wICksIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICkgKTsKCXZlYzMgdG90YWxFbWlzc2l2ZVJhZGlhbmNlID0gZW1pc3NpdmU7CgkjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGNvbG9yX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhbWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYWhhc2hfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X2JlZ2luPgoJI2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGVtaXNzaXZlbWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGxpZ2h0c190b29uX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9iZWdpbj4KCSNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfbWFwcz4KCSNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfZW5kPgoJI2luY2x1ZGUgPGFvbWFwX2ZyYWdtZW50PgoJdmVjMyBvdXRnb2luZ0xpZ2h0ID0gcmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArIHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSArIHRvdGFsRW1pc3NpdmVSYWRpYW5jZTsKCSNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KCSNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD4KCSNpbmNsdWRlIDxkaXRoZXJpbmdfZnJhZ21lbnQ+Cn1gLCBfdyA9IGB1bmlmb3JtIGZsb2F0IHNpemU7CnVuaWZvcm0gZmxvYXQgc2NhbGU7CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc192ZXJ0ZXg+CiNpZmRlZiBVU0VfUE9JTlRTX1VWCgl2YXJ5aW5nIHZlYzIgdlV2OwoJdW5pZm9ybSBtYXQzIHV2VHJhbnNmb3JtOwojZW5kaWYKdm9pZCBtYWluKCkgewoJI2lmZGVmIFVTRV9QT0lOVFNfVVYKCQl2VXYgPSAoIHV2VHJhbnNmb3JtICogdmVjMyggdXYsIDEgKSApLnh5OwoJI2VuZGlmCgkjaW5jbHVkZSA8Y29sb3JfdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBoaW5zdGFuY2VfdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBoY29sb3JfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaHRhcmdldF92ZXJ0ZXg+CgkjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+CglnbF9Qb2ludFNpemUgPSBzaXplOwoJI2lmZGVmIFVTRV9TSVpFQVRURU5VQVRJT04KCQlib29sIGlzUGVyc3BlY3RpdmUgPSBpc1BlcnNwZWN0aXZlTWF0cml4KCBwcm9qZWN0aW9uTWF0cml4ICk7CgkJaWYgKCBpc1BlcnNwZWN0aXZlICkgZ2xfUG9pbnRTaXplICo9ICggc2NhbGUgLyAtIG12UG9zaXRpb24ueiApOwoJI2VuZGlmCgkjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PgoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc192ZXJ0ZXg+CgkjaW5jbHVkZSA8d29ybGRwb3NfdmVydGV4PgoJI2luY2x1ZGUgPGZvZ192ZXJ0ZXg+Cn1gLCB4dyA9IGB1bmlmb3JtIHZlYzMgZGlmZnVzZTsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5OwojaW5jbHVkZSA8Y29tbW9uPgojaW5jbHVkZSA8Y29sb3JfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG1hcF9wYXJ0aWNsZV9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Pgp2b2lkIG1haW4oKSB7Cgl2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTsKCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfZnJhZ21lbnQ+Cgl2ZWMzIG91dGdvaW5nTGlnaHQgPSB2ZWMzKCAwLjAgKTsKCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD4KCSNpbmNsdWRlIDxtYXBfcGFydGljbGVfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD4KCW91dGdvaW5nTGlnaHQgPSBkaWZmdXNlQ29sb3IucmdiOwoJI2luY2x1ZGUgPG9wYXF1ZV9mcmFnbWVudD4KCSNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGZvZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50Pgp9YCwgdncgPSBgI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfdmVydGV4Pgp2b2lkIG1haW4oKSB7CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaGluc3RhbmNlX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2luX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaHRhcmdldF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PgoJI2luY2x1ZGUgPHByb2plY3RfdmVydGV4PgoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD4KCSNpbmNsdWRlIDx3b3JsZHBvc192ZXJ0ZXg+CgkjaW5jbHVkZSA8c2hhZG93bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxmb2dfdmVydGV4Pgp9YCwgYncgPSBgdW5pZm9ybSB2ZWMzIGNvbG9yOwp1bmlmb3JtIGZsb2F0IG9wYWNpdHk7CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDxwYWNraW5nPgojaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxic2Rmcz4KI2luY2x1ZGUgPGxpZ2h0c19wYXJzX2JlZ2luPgojaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHNoYWRvd21hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8c2hhZG93bWFza19wYXJzX2ZyYWdtZW50Pgp2b2lkIG1haW4oKSB7CgkjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+CglnbF9GcmFnQ29sb3IgPSB2ZWM0KCBjb2xvciwgb3BhY2l0eSAqICggMS4wIC0gZ2V0U2hhZG93TWFzaygpICkgKTsKCSNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGZvZ19mcmFnbWVudD4KfWAsIE13ID0gYHVuaWZvcm0gZmxvYXQgcm90YXRpb247CnVuaWZvcm0gdmVjMiBjZW50ZXI7CiNpbmNsdWRlIDxjb21tb24+CiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Pgp2b2lkIG1haW4oKSB7CgkjaW5jbHVkZSA8dXZfdmVydGV4PgoJdmVjNCBtdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4WyAzIF07Cgl2ZWMyIHNjYWxlID0gdmVjMiggbGVuZ3RoKCBtb2RlbE1hdHJpeFsgMCBdLnh5eiApLCBsZW5ndGgoIG1vZGVsTWF0cml4WyAxIF0ueHl6ICkgKTsKCSNpZm5kZWYgVVNFX1NJWkVBVFRFTlVBVElPTgoJCWJvb2wgaXNQZXJzcGVjdGl2ZSA9IGlzUGVyc3BlY3RpdmVNYXRyaXgoIHByb2plY3Rpb25NYXRyaXggKTsKCQlpZiAoIGlzUGVyc3BlY3RpdmUgKSBzY2FsZSAqPSAtIG12UG9zaXRpb24uejsKCSNlbmRpZgoJdmVjMiBhbGlnbmVkUG9zaXRpb24gPSAoIHBvc2l0aW9uLnh5IC0gKCBjZW50ZXIgLSB2ZWMyKCAwLjUgKSApICkgKiBzY2FsZTsKCXZlYzIgcm90YXRlZFBvc2l0aW9uOwoJcm90YXRlZFBvc2l0aW9uLnggPSBjb3MoIHJvdGF0aW9uICkgKiBhbGlnbmVkUG9zaXRpb24ueCAtIHNpbiggcm90YXRpb24gKSAqIGFsaWduZWRQb3NpdGlvbi55OwoJcm90YXRlZFBvc2l0aW9uLnkgPSBzaW4oIHJvdGF0aW9uICkgKiBhbGlnbmVkUG9zaXRpb24ueCArIGNvcyggcm90YXRpb24gKSAqIGFsaWduZWRQb3NpdGlvbi55OwoJbXZQb3NpdGlvbi54eSArPSByb3RhdGVkUG9zaXRpb247CglnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uOwoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD4KCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PgoJI2luY2x1ZGUgPGZvZ192ZXJ0ZXg+Cn1gLCBTdyA9IGB1bmlmb3JtIHZlYzMgZGlmZnVzZTsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5OwojaW5jbHVkZSA8Y29tbW9uPgojaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudD4Kdm9pZCBtYWluKCkgewoJdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PgoJdmVjMyBvdXRnb2luZ0xpZ2h0ID0gdmVjMyggMC4wICk7CgkjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhbWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYWhhc2hfZnJhZ21lbnQ+CglvdXRnb2luZ0xpZ2h0ID0gZGlmZnVzZUNvbG9yLnJnYjsKCSNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD4KCSNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+Cn1gLCBadCA9IHsKICBhbHBoYWhhc2hfZnJhZ21lbnQ6IHFNLAogIGFscGhhaGFzaF9wYXJzX2ZyYWdtZW50OiAkTSwKICBhbHBoYW1hcF9mcmFnbWVudDogWE0sCiAgYWxwaGFtYXBfcGFyc19mcmFnbWVudDogWU0sCiAgYWxwaGF0ZXN0X2ZyYWdtZW50OiBaTSwKICBhbHBoYXRlc3RfcGFyc19mcmFnbWVudDogak0sCiAgYW9tYXBfZnJhZ21lbnQ6IEpNLAogIGFvbWFwX3BhcnNfZnJhZ21lbnQ6IEtNLAogIGJhdGNoaW5nX3BhcnNfdmVydGV4OiBRTSwKICBiYXRjaGluZ192ZXJ0ZXg6IHRTLAogIGJlZ2luX3ZlcnRleDogZVMsCiAgYmVnaW5ub3JtYWxfdmVydGV4OiBpUywKICBic2RmczogblMsCiAgaXJpZGVzY2VuY2VfZnJhZ21lbnQ6IHNTLAogIGJ1bXBtYXBfcGFyc19mcmFnbWVudDogclMsCiAgY2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50OiBhUywKICBjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudDogb1MsCiAgY2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4OiBsUywKICBjbGlwcGluZ19wbGFuZXNfdmVydGV4OiBoUywKICBjb2xvcl9mcmFnbWVudDogY1MsCiAgY29sb3JfcGFyc19mcmFnbWVudDogdVMsCiAgY29sb3JfcGFyc192ZXJ0ZXg6IGRTLAogIGNvbG9yX3ZlcnRleDogcFMsCiAgY29tbW9uOiBmUywKICBjdWJlX3V2X3JlZmxlY3Rpb25fZnJhZ21lbnQ6IG1TLAogIGRlZmF1bHRub3JtYWxfdmVydGV4OiBnUywKICBkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg6IHlTLAogIGRpc3BsYWNlbWVudG1hcF92ZXJ0ZXg6IF9TLAogIGVtaXNzaXZlbWFwX2ZyYWdtZW50OiB4UywKICBlbWlzc2l2ZW1hcF9wYXJzX2ZyYWdtZW50OiB2UywKICBjb2xvcnNwYWNlX2ZyYWdtZW50OiBiUywKICBjb2xvcnNwYWNlX3BhcnNfZnJhZ21lbnQ6IE1TLAogIGVudm1hcF9mcmFnbWVudDogU1MsCiAgZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50OiB3UywKICBlbnZtYXBfcGFyc19mcmFnbWVudDogQVMsCiAgZW52bWFwX3BhcnNfdmVydGV4OiBFUywKICBlbnZtYXBfcGh5c2ljYWxfcGFyc19mcmFnbWVudDogelMsCiAgZW52bWFwX3ZlcnRleDogVFMsCiAgZm9nX3ZlcnRleDogQ1MsCiAgZm9nX3BhcnNfdmVydGV4OiBSUywKICBmb2dfZnJhZ21lbnQ6IFBTLAogIGZvZ19wYXJzX2ZyYWdtZW50OiBJUywKICBncmFkaWVudG1hcF9wYXJzX2ZyYWdtZW50OiBMUywKICBsaWdodG1hcF9wYXJzX2ZyYWdtZW50OiBEUywKICBsaWdodHNfbGFtYmVydF9mcmFnbWVudDogRlMsCiAgbGlnaHRzX2xhbWJlcnRfcGFyc19mcmFnbWVudDogVVMsCiAgbGlnaHRzX3BhcnNfYmVnaW46IEJTLAogIGxpZ2h0c190b29uX2ZyYWdtZW50OiBOUywKICBsaWdodHNfdG9vbl9wYXJzX2ZyYWdtZW50OiBPUywKICBsaWdodHNfcGhvbmdfZnJhZ21lbnQ6IGtTLAogIGxpZ2h0c19waG9uZ19wYXJzX2ZyYWdtZW50OiBWUywKICBsaWdodHNfcGh5c2ljYWxfZnJhZ21lbnQ6IEhTLAogIGxpZ2h0c19waHlzaWNhbF9wYXJzX2ZyYWdtZW50OiBHUywKICBsaWdodHNfZnJhZ21lbnRfYmVnaW46IFdTLAogIGxpZ2h0c19mcmFnbWVudF9tYXBzOiBxUywKICBsaWdodHNfZnJhZ21lbnRfZW5kOiAkUywKICBsb2dkZXB0aGJ1Zl9mcmFnbWVudDogWFMsCiAgbG9nZGVwdGhidWZfcGFyc19mcmFnbWVudDogWVMsCiAgbG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg6IFpTLAogIGxvZ2RlcHRoYnVmX3ZlcnRleDogalMsCiAgbWFwX2ZyYWdtZW50OiBKUywKICBtYXBfcGFyc19mcmFnbWVudDogS1MsCiAgbWFwX3BhcnRpY2xlX2ZyYWdtZW50OiBRUywKICBtYXBfcGFydGljbGVfcGFyc19mcmFnbWVudDogdDEsCiAgbWV0YWxuZXNzbWFwX2ZyYWdtZW50OiBlMSwKICBtZXRhbG5lc3NtYXBfcGFyc19mcmFnbWVudDogaTEsCiAgbW9ycGhpbnN0YW5jZV92ZXJ0ZXg6IG4xLAogIG1vcnBoY29sb3JfdmVydGV4OiBzMSwKICBtb3JwaG5vcm1hbF92ZXJ0ZXg6IHIxLAogIG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4OiBhMSwKICBtb3JwaHRhcmdldF92ZXJ0ZXg6IG8xLAogIG5vcm1hbF9mcmFnbWVudF9iZWdpbjogbDEsCiAgbm9ybWFsX2ZyYWdtZW50X21hcHM6IGgxLAogIG5vcm1hbF9wYXJzX2ZyYWdtZW50OiBjMSwKICBub3JtYWxfcGFyc192ZXJ0ZXg6IHUxLAogIG5vcm1hbF92ZXJ0ZXg6IGQxLAogIG5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50OiBwMSwKICBjbGVhcmNvYXRfbm9ybWFsX2ZyYWdtZW50X2JlZ2luOiBmMSwKICBjbGVhcmNvYXRfbm9ybWFsX2ZyYWdtZW50X21hcHM6IG0xLAogIGNsZWFyY29hdF9wYXJzX2ZyYWdtZW50OiBnMSwKICBpcmlkZXNjZW5jZV9wYXJzX2ZyYWdtZW50OiB5MSwKICBvcGFxdWVfZnJhZ21lbnQ6IF8xLAogIHBhY2tpbmc6IHgxLAogIHByZW11bHRpcGxpZWRfYWxwaGFfZnJhZ21lbnQ6IHYxLAogIHByb2plY3RfdmVydGV4OiBiMSwKICBkaXRoZXJpbmdfZnJhZ21lbnQ6IE0xLAogIGRpdGhlcmluZ19wYXJzX2ZyYWdtZW50OiBTMSwKICByb3VnaG5lc3NtYXBfZnJhZ21lbnQ6IHcxLAogIHJvdWdobmVzc21hcF9wYXJzX2ZyYWdtZW50OiBBMSwKICBzaGFkb3dtYXBfcGFyc19mcmFnbWVudDogRTEsCiAgc2hhZG93bWFwX3BhcnNfdmVydGV4OiBUMSwKICBzaGFkb3dtYXBfdmVydGV4OiBDMSwKICBzaGFkb3dtYXNrX3BhcnNfZnJhZ21lbnQ6IFIxLAogIHNraW5iYXNlX3ZlcnRleDogUDEsCiAgc2tpbm5pbmdfcGFyc192ZXJ0ZXg6IEkxLAogIHNraW5uaW5nX3ZlcnRleDogTDEsCiAgc2tpbm5vcm1hbF92ZXJ0ZXg6IEQxLAogIHNwZWN1bGFybWFwX2ZyYWdtZW50OiBGMSwKICBzcGVjdWxhcm1hcF9wYXJzX2ZyYWdtZW50OiBVMSwKICB0b25lbWFwcGluZ19mcmFnbWVudDogQjEsCiAgdG9uZW1hcHBpbmdfcGFyc19mcmFnbWVudDogejEsCiAgdHJhbnNtaXNzaW9uX2ZyYWdtZW50OiBOMSwKICB0cmFuc21pc3Npb25fcGFyc19mcmFnbWVudDogTzEsCiAgdXZfcGFyc19mcmFnbWVudDogazEsCiAgdXZfcGFyc192ZXJ0ZXg6IFYxLAogIHV2X3ZlcnRleDogSDEsCiAgd29ybGRwb3NfdmVydGV4OiBHMSwKICBiYWNrZ3JvdW5kX3ZlcnQ6IFcxLAogIGJhY2tncm91bmRfZnJhZzogcTEsCiAgYmFja2dyb3VuZEN1YmVfdmVydDogJDEsCiAgYmFja2dyb3VuZEN1YmVfZnJhZzogWDEsCiAgY3ViZV92ZXJ0OiBZMSwKICBjdWJlX2ZyYWc6IFoxLAogIGRlcHRoX3ZlcnQ6IGoxLAogIGRlcHRoX2ZyYWc6IEoxLAogIGRpc3RhbmNlUkdCQV92ZXJ0OiBLMSwKICBkaXN0YW5jZVJHQkFfZnJhZzogUTEsCiAgZXF1aXJlY3RfdmVydDogdHcsCiAgZXF1aXJlY3RfZnJhZzogZXcsCiAgbGluZWRhc2hlZF92ZXJ0OiBpdywKICBsaW5lZGFzaGVkX2ZyYWc6IG53LAogIG1lc2hiYXNpY192ZXJ0OiBzdywKICBtZXNoYmFzaWNfZnJhZzogcncsCiAgbWVzaGxhbWJlcnRfdmVydDogYXcsCiAgbWVzaGxhbWJlcnRfZnJhZzogb3csCiAgbWVzaG1hdGNhcF92ZXJ0OiBsdywKICBtZXNobWF0Y2FwX2ZyYWc6IGh3LAogIG1lc2hub3JtYWxfdmVydDogY3csCiAgbWVzaG5vcm1hbF9mcmFnOiB1dywKICBtZXNocGhvbmdfdmVydDogZHcsCiAgbWVzaHBob25nX2ZyYWc6IHB3LAogIG1lc2hwaHlzaWNhbF92ZXJ0OiBmdywKICBtZXNocGh5c2ljYWxfZnJhZzogbXcsCiAgbWVzaHRvb25fdmVydDogZ3csCiAgbWVzaHRvb25fZnJhZzogeXcsCiAgcG9pbnRzX3ZlcnQ6IF93LAogIHBvaW50c19mcmFnOiB4dywKICBzaGFkb3dfdmVydDogdncsCiAgc2hhZG93X2ZyYWc6IGJ3LAogIHNwcml0ZV92ZXJ0OiBNdywKICBzcHJpdGVfZnJhZzogU3cKfSwgYnQgPSB7CiAgY29tbW9uOiB7CiAgICBkaWZmdXNlOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGN0KDE2Nzc3MjE1KSB9LAogICAgb3BhY2l0eTogeyB2YWx1ZTogMSB9LAogICAgbWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBtYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9LAogICAgYWxwaGFNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGFscGhhTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfSwKICAgIGFscGhhVGVzdDogeyB2YWx1ZTogMCB9CiAgfSwKICBzcGVjdWxhcm1hcDogewogICAgc3BlY3VsYXJNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIHNwZWN1bGFyTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfQogIH0sCiAgZW52bWFwOiB7CiAgICBlbnZNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGVudk1hcFJvdGF0aW9uOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfSwKICAgIGZsaXBFbnZNYXA6IHsgdmFsdWU6IC0xIH0sCiAgICByZWZsZWN0aXZpdHk6IHsgdmFsdWU6IDEgfSwKICAgIC8vIGJhc2ljLCBsYW1iZXJ0LCBwaG9uZwogICAgaW9yOiB7IHZhbHVlOiAxLjUgfSwKICAgIC8vIHBoeXNpY2FsCiAgICByZWZyYWN0aW9uUmF0aW86IHsgdmFsdWU6IDAuOTggfQogICAgLy8gYmFzaWMsIGxhbWJlcnQsIHBob25nCiAgfSwKICBhb21hcDogewogICAgYW9NYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGFvTWFwSW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0sCiAgICBhb01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0KICB9LAogIGxpZ2h0bWFwOiB7CiAgICBsaWdodE1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgbGlnaHRNYXBJbnRlbnNpdHk6IHsgdmFsdWU6IDEgfSwKICAgIGxpZ2h0TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfQogIH0sCiAgYnVtcG1hcDogewogICAgYnVtcE1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgYnVtcE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICBidW1wU2NhbGU6IHsgdmFsdWU6IDEgfQogIH0sCiAgbm9ybWFsbWFwOiB7CiAgICBub3JtYWxNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIG5vcm1hbE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICBub3JtYWxTY2FsZTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBKKDEsIDEpIH0KICB9LAogIGRpc3BsYWNlbWVudG1hcDogewogICAgZGlzcGxhY2VtZW50TWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBkaXNwbGFjZW1lbnRNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9LAogICAgZGlzcGxhY2VtZW50U2NhbGU6IHsgdmFsdWU6IDEgfSwKICAgIGRpc3BsYWNlbWVudEJpYXM6IHsgdmFsdWU6IDAgfQogIH0sCiAgZW1pc3NpdmVtYXA6IHsKICAgIGVtaXNzaXZlTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBlbWlzc2l2ZU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0KICB9LAogIG1ldGFsbmVzc21hcDogewogICAgbWV0YWxuZXNzTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBtZXRhbG5lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9CiAgfSwKICByb3VnaG5lc3NtYXA6IHsKICAgIHJvdWdobmVzc01hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgcm91Z2huZXNzTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfQogIH0sCiAgZ3JhZGllbnRtYXA6IHsKICAgIGdyYWRpZW50TWFwOiB7IHZhbHVlOiBudWxsIH0KICB9LAogIGZvZzogewogICAgZm9nRGVuc2l0eTogeyB2YWx1ZTogMjVlLTUgfSwKICAgIGZvZ05lYXI6IHsgdmFsdWU6IDEgfSwKICAgIGZvZ0ZhcjogeyB2YWx1ZTogMmUzIH0sCiAgICBmb2dDb2xvcjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBjdCgxNjc3NzIxNSkgfQogIH0sCiAgbGlnaHRzOiB7CiAgICBhbWJpZW50TGlnaHRDb2xvcjogeyB2YWx1ZTogW10gfSwKICAgIGxpZ2h0UHJvYmU6IHsgdmFsdWU6IFtdIH0sCiAgICBkaXJlY3Rpb25hbExpZ2h0czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgZGlyZWN0aW9uOiB7fSwKICAgICAgY29sb3I6IHt9CiAgICB9IH0sCiAgICBkaXJlY3Rpb25hbExpZ2h0U2hhZG93czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgc2hhZG93SW50ZW5zaXR5OiAxLAogICAgICBzaGFkb3dCaWFzOiB7fSwKICAgICAgc2hhZG93Tm9ybWFsQmlhczoge30sCiAgICAgIHNoYWRvd1JhZGl1czoge30sCiAgICAgIHNoYWRvd01hcFNpemU6IHt9CiAgICB9IH0sCiAgICBkaXJlY3Rpb25hbFNoYWRvd01hcDogeyB2YWx1ZTogW10gfSwKICAgIGRpcmVjdGlvbmFsU2hhZG93TWF0cml4OiB7IHZhbHVlOiBbXSB9LAogICAgc3BvdExpZ2h0czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgY29sb3I6IHt9LAogICAgICBwb3NpdGlvbjoge30sCiAgICAgIGRpcmVjdGlvbjoge30sCiAgICAgIGRpc3RhbmNlOiB7fSwKICAgICAgY29uZUNvczoge30sCiAgICAgIHBlbnVtYnJhQ29zOiB7fSwKICAgICAgZGVjYXk6IHt9CiAgICB9IH0sCiAgICBzcG90TGlnaHRTaGFkb3dzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewogICAgICBzaGFkb3dJbnRlbnNpdHk6IDEsCiAgICAgIHNoYWRvd0JpYXM6IHt9LAogICAgICBzaGFkb3dOb3JtYWxCaWFzOiB7fSwKICAgICAgc2hhZG93UmFkaXVzOiB7fSwKICAgICAgc2hhZG93TWFwU2l6ZToge30KICAgIH0gfSwKICAgIHNwb3RMaWdodE1hcDogeyB2YWx1ZTogW10gfSwKICAgIHNwb3RTaGFkb3dNYXA6IHsgdmFsdWU6IFtdIH0sCiAgICBzcG90TGlnaHRNYXRyaXg6IHsgdmFsdWU6IFtdIH0sCiAgICBwb2ludExpZ2h0czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgY29sb3I6IHt9LAogICAgICBwb3NpdGlvbjoge30sCiAgICAgIGRlY2F5OiB7fSwKICAgICAgZGlzdGFuY2U6IHt9CiAgICB9IH0sCiAgICBwb2ludExpZ2h0U2hhZG93czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgc2hhZG93SW50ZW5zaXR5OiAxLAogICAgICBzaGFkb3dCaWFzOiB7fSwKICAgICAgc2hhZG93Tm9ybWFsQmlhczoge30sCiAgICAgIHNoYWRvd1JhZGl1czoge30sCiAgICAgIHNoYWRvd01hcFNpemU6IHt9LAogICAgICBzaGFkb3dDYW1lcmFOZWFyOiB7fSwKICAgICAgc2hhZG93Q2FtZXJhRmFyOiB7fQogICAgfSB9LAogICAgcG9pbnRTaGFkb3dNYXA6IHsgdmFsdWU6IFtdIH0sCiAgICBwb2ludFNoYWRvd01hdHJpeDogeyB2YWx1ZTogW10gfSwKICAgIGhlbWlzcGhlcmVMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIGRpcmVjdGlvbjoge30sCiAgICAgIHNreUNvbG9yOiB7fSwKICAgICAgZ3JvdW5kQ29sb3I6IHt9CiAgICB9IH0sCiAgICAvLyBUT0RPIChhYmVsbmF0aW9uKTogUmVjdEFyZWFMaWdodCBCUkRGIGRhdGEgbmVlZHMgdG8gYmUgbW92ZWQgZnJvbSBleGFtcGxlIHRvIG1haW4gc3JjCiAgICByZWN0QXJlYUxpZ2h0czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgY29sb3I6IHt9LAogICAgICBwb3NpdGlvbjoge30sCiAgICAgIHdpZHRoOiB7fSwKICAgICAgaGVpZ2h0OiB7fQogICAgfSB9LAogICAgbHRjXzE6IHsgdmFsdWU6IG51bGwgfSwKICAgIGx0Y18yOiB7IHZhbHVlOiBudWxsIH0KICB9LAogIHBvaW50czogewogICAgZGlmZnVzZTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBjdCgxNjc3NzIxNSkgfSwKICAgIG9wYWNpdHk6IHsgdmFsdWU6IDEgfSwKICAgIHNpemU6IHsgdmFsdWU6IDEgfSwKICAgIHNjYWxlOiB7IHZhbHVlOiAxIH0sCiAgICBtYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGFscGhhTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBhbHBoYU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICBhbHBoYVRlc3Q6IHsgdmFsdWU6IDAgfSwKICAgIHV2VHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfQogIH0sCiAgc3ByaXRlOiB7CiAgICBkaWZmdXNlOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGN0KDE2Nzc3MjE1KSB9LAogICAgb3BhY2l0eTogeyB2YWx1ZTogMSB9LAogICAgY2VudGVyOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IEooMC41LCAwLjUpIH0sCiAgICByb3RhdGlvbjogeyB2YWx1ZTogMCB9LAogICAgbWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBtYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9LAogICAgYWxwaGFNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGFscGhhTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfSwKICAgIGFscGhhVGVzdDogeyB2YWx1ZTogMCB9CiAgfQp9LCBmaSA9IHsKICBiYXNpYzogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmNvbW1vbiwKICAgICAgYnQuc3BlY3VsYXJtYXAsCiAgICAgIGJ0LmVudm1hcCwKICAgICAgYnQuYW9tYXAsCiAgICAgIGJ0LmxpZ2h0bWFwLAogICAgICBidC5mb2cKICAgIF0pLAogICAgdmVydGV4U2hhZGVyOiBadC5tZXNoYmFzaWNfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5tZXNoYmFzaWNfZnJhZwogIH0sCiAgbGFtYmVydDogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmNvbW1vbiwKICAgICAgYnQuc3BlY3VsYXJtYXAsCiAgICAgIGJ0LmVudm1hcCwKICAgICAgYnQuYW9tYXAsCiAgICAgIGJ0LmxpZ2h0bWFwLAogICAgICBidC5lbWlzc2l2ZW1hcCwKICAgICAgYnQuYnVtcG1hcCwKICAgICAgYnQubm9ybWFsbWFwLAogICAgICBidC5kaXNwbGFjZW1lbnRtYXAsCiAgICAgIGJ0LmZvZywKICAgICAgYnQubGlnaHRzLAogICAgICB7CiAgICAgICAgZW1pc3NpdmU6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgY3QoMCkgfQogICAgICB9CiAgICBdKSwKICAgIHZlcnRleFNoYWRlcjogWnQubWVzaGxhbWJlcnRfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5tZXNobGFtYmVydF9mcmFnCiAgfSwKICBwaG9uZzogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmNvbW1vbiwKICAgICAgYnQuc3BlY3VsYXJtYXAsCiAgICAgIGJ0LmVudm1hcCwKICAgICAgYnQuYW9tYXAsCiAgICAgIGJ0LmxpZ2h0bWFwLAogICAgICBidC5lbWlzc2l2ZW1hcCwKICAgICAgYnQuYnVtcG1hcCwKICAgICAgYnQubm9ybWFsbWFwLAogICAgICBidC5kaXNwbGFjZW1lbnRtYXAsCiAgICAgIGJ0LmZvZywKICAgICAgYnQubGlnaHRzLAogICAgICB7CiAgICAgICAgZW1pc3NpdmU6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgY3QoMCkgfSwKICAgICAgICBzcGVjdWxhcjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBjdCgxMTE4NDgxKSB9LAogICAgICAgIHNoaW5pbmVzczogeyB2YWx1ZTogMzAgfQogICAgICB9CiAgICBdKSwKICAgIHZlcnRleFNoYWRlcjogWnQubWVzaHBob25nX3ZlcnQsCiAgICBmcmFnbWVudFNoYWRlcjogWnQubWVzaHBob25nX2ZyYWcKICB9LAogIHN0YW5kYXJkOiB7CiAgICB1bmlmb3JtczogLyogQF9fUFVSRV9fICovIHBpKFsKICAgICAgYnQuY29tbW9uLAogICAgICBidC5lbnZtYXAsCiAgICAgIGJ0LmFvbWFwLAogICAgICBidC5saWdodG1hcCwKICAgICAgYnQuZW1pc3NpdmVtYXAsCiAgICAgIGJ0LmJ1bXBtYXAsCiAgICAgIGJ0Lm5vcm1hbG1hcCwKICAgICAgYnQuZGlzcGxhY2VtZW50bWFwLAogICAgICBidC5yb3VnaG5lc3NtYXAsCiAgICAgIGJ0Lm1ldGFsbmVzc21hcCwKICAgICAgYnQuZm9nLAogICAgICBidC5saWdodHMsCiAgICAgIHsKICAgICAgICBlbWlzc2l2ZTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBjdCgwKSB9LAogICAgICAgIHJvdWdobmVzczogeyB2YWx1ZTogMSB9LAogICAgICAgIG1ldGFsbmVzczogeyB2YWx1ZTogMCB9LAogICAgICAgIGVudk1hcEludGVuc2l0eTogeyB2YWx1ZTogMSB9CiAgICAgIH0KICAgIF0pLAogICAgdmVydGV4U2hhZGVyOiBadC5tZXNocGh5c2ljYWxfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5tZXNocGh5c2ljYWxfZnJhZwogIH0sCiAgdG9vbjogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmNvbW1vbiwKICAgICAgYnQuYW9tYXAsCiAgICAgIGJ0LmxpZ2h0bWFwLAogICAgICBidC5lbWlzc2l2ZW1hcCwKICAgICAgYnQuYnVtcG1hcCwKICAgICAgYnQubm9ybWFsbWFwLAogICAgICBidC5kaXNwbGFjZW1lbnRtYXAsCiAgICAgIGJ0LmdyYWRpZW50bWFwLAogICAgICBidC5mb2csCiAgICAgIGJ0LmxpZ2h0cywKICAgICAgewogICAgICAgIGVtaXNzaXZlOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGN0KDApIH0KICAgICAgfQogICAgXSksCiAgICB2ZXJ0ZXhTaGFkZXI6IFp0Lm1lc2h0b29uX3ZlcnQsCiAgICBmcmFnbWVudFNoYWRlcjogWnQubWVzaHRvb25fZnJhZwogIH0sCiAgbWF0Y2FwOiB7CiAgICB1bmlmb3JtczogLyogQF9fUFVSRV9fICovIHBpKFsKICAgICAgYnQuY29tbW9uLAogICAgICBidC5idW1wbWFwLAogICAgICBidC5ub3JtYWxtYXAsCiAgICAgIGJ0LmRpc3BsYWNlbWVudG1hcCwKICAgICAgYnQuZm9nLAogICAgICB7CiAgICAgICAgbWF0Y2FwOiB7IHZhbHVlOiBudWxsIH0KICAgICAgfQogICAgXSksCiAgICB2ZXJ0ZXhTaGFkZXI6IFp0Lm1lc2htYXRjYXBfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5tZXNobWF0Y2FwX2ZyYWcKICB9LAogIHBvaW50czogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LnBvaW50cywKICAgICAgYnQuZm9nCiAgICBdKSwKICAgIHZlcnRleFNoYWRlcjogWnQucG9pbnRzX3ZlcnQsCiAgICBmcmFnbWVudFNoYWRlcjogWnQucG9pbnRzX2ZyYWcKICB9LAogIGRhc2hlZDogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmNvbW1vbiwKICAgICAgYnQuZm9nLAogICAgICB7CiAgICAgICAgc2NhbGU6IHsgdmFsdWU6IDEgfSwKICAgICAgICBkYXNoU2l6ZTogeyB2YWx1ZTogMSB9LAogICAgICAgIHRvdGFsU2l6ZTogeyB2YWx1ZTogMiB9CiAgICAgIH0KICAgIF0pLAogICAgdmVydGV4U2hhZGVyOiBadC5saW5lZGFzaGVkX3ZlcnQsCiAgICBmcmFnbWVudFNoYWRlcjogWnQubGluZWRhc2hlZF9mcmFnCiAgfSwKICBkZXB0aDogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmNvbW1vbiwKICAgICAgYnQuZGlzcGxhY2VtZW50bWFwCiAgICBdKSwKICAgIHZlcnRleFNoYWRlcjogWnQuZGVwdGhfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5kZXB0aF9mcmFnCiAgfSwKICBub3JtYWw6IHsKICAgIHVuaWZvcm1zOiAvKiBAX19QVVJFX18gKi8gcGkoWwogICAgICBidC5jb21tb24sCiAgICAgIGJ0LmJ1bXBtYXAsCiAgICAgIGJ0Lm5vcm1hbG1hcCwKICAgICAgYnQuZGlzcGxhY2VtZW50bWFwLAogICAgICB7CiAgICAgICAgb3BhY2l0eTogeyB2YWx1ZTogMSB9CiAgICAgIH0KICAgIF0pLAogICAgdmVydGV4U2hhZGVyOiBadC5tZXNobm9ybWFsX3ZlcnQsCiAgICBmcmFnbWVudFNoYWRlcjogWnQubWVzaG5vcm1hbF9mcmFnCiAgfSwKICBzcHJpdGU6IHsKICAgIHVuaWZvcm1zOiAvKiBAX19QVVJFX18gKi8gcGkoWwogICAgICBidC5zcHJpdGUsCiAgICAgIGJ0LmZvZwogICAgXSksCiAgICB2ZXJ0ZXhTaGFkZXI6IFp0LnNwcml0ZV92ZXJ0LAogICAgZnJhZ21lbnRTaGFkZXI6IFp0LnNwcml0ZV9mcmFnCiAgfSwKICBiYWNrZ3JvdW5kOiB7CiAgICB1bmlmb3JtczogewogICAgICB1dlRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICAgIHQyRDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBiYWNrZ3JvdW5kSW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0KICAgIH0sCiAgICB2ZXJ0ZXhTaGFkZXI6IFp0LmJhY2tncm91bmRfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5iYWNrZ3JvdW5kX2ZyYWcKICB9LAogIGJhY2tncm91bmRDdWJlOiB7CiAgICB1bmlmb3JtczogewogICAgICBlbnZNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgZmxpcEVudk1hcDogeyB2YWx1ZTogLTEgfSwKICAgICAgYmFja2dyb3VuZEJsdXJyaW5lc3M6IHsgdmFsdWU6IDAgfSwKICAgICAgYmFja2dyb3VuZEludGVuc2l0eTogeyB2YWx1ZTogMSB9LAogICAgICBiYWNrZ3JvdW5kUm90YXRpb246IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9CiAgICB9LAogICAgdmVydGV4U2hhZGVyOiBadC5iYWNrZ3JvdW5kQ3ViZV92ZXJ0LAogICAgZnJhZ21lbnRTaGFkZXI6IFp0LmJhY2tncm91bmRDdWJlX2ZyYWcKICB9LAogIGN1YmU6IHsKICAgIHVuaWZvcm1zOiB7CiAgICAgIHRDdWJlOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHRGbGlwOiB7IHZhbHVlOiAtMSB9LAogICAgICBvcGFjaXR5OiB7IHZhbHVlOiAxIH0KICAgIH0sCiAgICB2ZXJ0ZXhTaGFkZXI6IFp0LmN1YmVfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5jdWJlX2ZyYWcKICB9LAogIGVxdWlyZWN0OiB7CiAgICB1bmlmb3JtczogewogICAgICB0RXF1aXJlY3Q6IHsgdmFsdWU6IG51bGwgfQogICAgfSwKICAgIHZlcnRleFNoYWRlcjogWnQuZXF1aXJlY3RfdmVydCwKICAgIGZyYWdtZW50U2hhZGVyOiBadC5lcXVpcmVjdF9mcmFnCiAgfSwKICBkaXN0YW5jZVJHQkE6IHsKICAgIHVuaWZvcm1zOiAvKiBAX19QVVJFX18gKi8gcGkoWwogICAgICBidC5jb21tb24sCiAgICAgIGJ0LmRpc3BsYWNlbWVudG1hcCwKICAgICAgewogICAgICAgIHJlZmVyZW5jZVBvc2l0aW9uOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IEUoKSB9LAogICAgICAgIG5lYXJEaXN0YW5jZTogeyB2YWx1ZTogMSB9LAogICAgICAgIGZhckRpc3RhbmNlOiB7IHZhbHVlOiAxZTMgfQogICAgICB9CiAgICBdKSwKICAgIHZlcnRleFNoYWRlcjogWnQuZGlzdGFuY2VSR0JBX3ZlcnQsCiAgICBmcmFnbWVudFNoYWRlcjogWnQuZGlzdGFuY2VSR0JBX2ZyYWcKICB9LAogIHNoYWRvdzogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBwaShbCiAgICAgIGJ0LmxpZ2h0cywKICAgICAgYnQuZm9nLAogICAgICB7CiAgICAgICAgY29sb3I6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgY3QoMCkgfSwKICAgICAgICBvcGFjaXR5OiB7IHZhbHVlOiAxIH0KICAgICAgfQogICAgXSksCiAgICB2ZXJ0ZXhTaGFkZXI6IFp0LnNoYWRvd192ZXJ0LAogICAgZnJhZ21lbnRTaGFkZXI6IFp0LnNoYWRvd19mcmFnCiAgfQp9OwpmaS5waHlzaWNhbCA9IHsKICB1bmlmb3JtczogLyogQF9fUFVSRV9fICovIHBpKFsKICAgIGZpLnN0YW5kYXJkLnVuaWZvcm1zLAogICAgewogICAgICBjbGVhcmNvYXQ6IHsgdmFsdWU6IDAgfSwKICAgICAgY2xlYXJjb2F0TWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIGNsZWFyY29hdE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICAgIGNsZWFyY29hdE5vcm1hbE1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBjbGVhcmNvYXROb3JtYWxNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9LAogICAgICBjbGVhcmNvYXROb3JtYWxTY2FsZTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBKKDEsIDEpIH0sCiAgICAgIGNsZWFyY29hdFJvdWdobmVzczogeyB2YWx1ZTogMCB9LAogICAgICBjbGVhcmNvYXRSb3VnaG5lc3NNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgY2xlYXJjb2F0Um91Z2huZXNzTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfSwKICAgICAgZGlzcGVyc2lvbjogeyB2YWx1ZTogMCB9LAogICAgICBpcmlkZXNjZW5jZTogeyB2YWx1ZTogMCB9LAogICAgICBpcmlkZXNjZW5jZU1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBpcmlkZXNjZW5jZU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICAgIGlyaWRlc2NlbmNlSU9SOiB7IHZhbHVlOiAxLjMgfSwKICAgICAgaXJpZGVzY2VuY2VUaGlja25lc3NNaW5pbXVtOiB7IHZhbHVlOiAxMDAgfSwKICAgICAgaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtOiB7IHZhbHVlOiA0MDAgfSwKICAgICAgaXJpZGVzY2VuY2VUaGlja25lc3NNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgaXJpZGVzY2VuY2VUaGlja25lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9LAogICAgICBzaGVlbjogeyB2YWx1ZTogMCB9LAogICAgICBzaGVlbkNvbG9yOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGN0KDApIH0sCiAgICAgIHNoZWVuQ29sb3JNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgc2hlZW5Db2xvck1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICAgIHNoZWVuUm91Z2huZXNzOiB7IHZhbHVlOiAxIH0sCiAgICAgIHNoZWVuUm91Z2huZXNzTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHNoZWVuUm91Z2huZXNzTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfSwKICAgICAgdHJhbnNtaXNzaW9uOiB7IHZhbHVlOiAwIH0sCiAgICAgIHRyYW5zbWlzc2lvbk1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICB0cmFuc21pc3Npb25NYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgWHQoKSB9LAogICAgICB0cmFuc21pc3Npb25TYW1wbGVyU2l6ZTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBKKCkgfSwKICAgICAgdHJhbnNtaXNzaW9uU2FtcGxlck1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICB0aGlja25lc3M6IHsgdmFsdWU6IDAgfSwKICAgICAgdGhpY2tuZXNzTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHRoaWNrbmVzc01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICAgIGF0dGVudWF0aW9uRGlzdGFuY2U6IHsgdmFsdWU6IDAgfSwKICAgICAgYXR0ZW51YXRpb25Db2xvcjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBjdCgwKSB9LAogICAgICBzcGVjdWxhckNvbG9yOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGN0KDEsIDEsIDEpIH0sCiAgICAgIHNwZWN1bGFyQ29sb3JNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgc3BlY3VsYXJDb2xvck1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBYdCgpIH0sCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0sCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5TWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfSwKICAgICAgYW5pc290cm9weVZlY3RvcjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBKKCkgfSwKICAgICAgYW5pc290cm9weU1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBhbmlzb3Ryb3B5TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IFh0KCkgfQogICAgfQogIF0pLAogIHZlcnRleFNoYWRlcjogWnQubWVzaHBoeXNpY2FsX3ZlcnQsCiAgZnJhZ21lbnRTaGFkZXI6IFp0Lm1lc2hwaHlzaWNhbF9mcmFnCn07CmNvbnN0IHpsID0geyByOiAwLCBiOiAwLCBnOiAwIH0sIGpzID0gLyogQF9fUFVSRV9fICovIG5ldyBmbigpLCB3dyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVnQoKTsKZnVuY3Rpb24gQXcoYSwgdCwgZSwgaSwgbiwgcywgcikgewogIGNvbnN0IG8gPSBuZXcgY3QoMCk7CiAgbGV0IGwgPSBzID09PSAhMCA/IDAgOiAxLCBoLCBjLCB1ID0gbnVsbCwgZCA9IDAsIHAgPSBudWxsOwogIGZ1bmN0aW9uIGYoeCkgewogICAgbGV0IF8gPSB4LmlzU2NlbmUgPT09ICEwID8geC5iYWNrZ3JvdW5kIDogbnVsbDsKICAgIHJldHVybiBfICYmIF8uaXNUZXh0dXJlICYmIChfID0gKHguYmFja2dyb3VuZEJsdXJyaW5lc3MgPiAwID8gZSA6IHQpLmdldChfKSksIF87CiAgfQogIGZ1bmN0aW9uIHkoeCkgewogICAgbGV0IF8gPSAhMTsKICAgIGNvbnN0IFMgPSBmKHgpOwogICAgUyA9PT0gbnVsbCA/IG0obywgbCkgOiBTICYmIFMuaXNDb2xvciAmJiAobShTLCAxKSwgXyA9ICEwKTsKICAgIGNvbnN0IHcgPSBhLnhyLmdldEVudmlyb25tZW50QmxlbmRNb2RlKCk7CiAgICB3ID09PSAiYWRkaXRpdmUiID8gaS5idWZmZXJzLmNvbG9yLnNldENsZWFyKDAsIDAsIDAsIDEsIHIpIDogdyA9PT0gImFscGhhLWJsZW5kIiAmJiBpLmJ1ZmZlcnMuY29sb3Iuc2V0Q2xlYXIoMCwgMCwgMCwgMCwgciksIChhLmF1dG9DbGVhciB8fCBfKSAmJiAoaS5idWZmZXJzLmRlcHRoLnNldFRlc3QoITApLCBpLmJ1ZmZlcnMuZGVwdGguc2V0TWFzayghMCksIGkuYnVmZmVycy5jb2xvci5zZXRNYXNrKCEwKSwgYS5jbGVhcihhLmF1dG9DbGVhckNvbG9yLCBhLmF1dG9DbGVhckRlcHRoLCBhLmF1dG9DbGVhclN0ZW5jaWwpKTsKICB9CiAgZnVuY3Rpb24gZyh4LCBfKSB7CiAgICBjb25zdCBTID0gZihfKTsKICAgIFMgJiYgKFMuaXNDdWJlVGV4dHVyZSB8fCBTLm1hcHBpbmcgPT09IFNhKSA/IChjID09PSB2b2lkIDAgJiYgKGMgPSBuZXcgcmUoCiAgICAgIG5ldyBtcigxLCAxLCAxKSwKICAgICAgbmV3IFhpKHsKICAgICAgICBuYW1lOiAiQmFja2dyb3VuZEN1YmVNYXRlcmlhbCIsCiAgICAgICAgdW5pZm9ybXM6IF9hKGZpLmJhY2tncm91bmRDdWJlLnVuaWZvcm1zKSwKICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGZpLmJhY2tncm91bmRDdWJlLnZlcnRleFNoYWRlciwKICAgICAgICBmcmFnbWVudFNoYWRlcjogZmkuYmFja2dyb3VuZEN1YmUuZnJhZ21lbnRTaGFkZXIsCiAgICAgICAgc2lkZTogSGUsCiAgICAgICAgZGVwdGhUZXN0OiAhMSwKICAgICAgICBkZXB0aFdyaXRlOiAhMSwKICAgICAgICBmb2c6ICExLAogICAgICAgIGFsbG93T3ZlcnJpZGU6ICExCiAgICAgIH0pCiAgICApLCBjLmdlb21ldHJ5LmRlbGV0ZUF0dHJpYnV0ZSgibm9ybWFsIiksIGMuZ2VvbWV0cnkuZGVsZXRlQXR0cmlidXRlKCJ1diIpLCBjLm9uQmVmb3JlUmVuZGVyID0gZnVuY3Rpb24odywgVCwgUikgewogICAgICB0aGlzLm1hdHJpeFdvcmxkLmNvcHlQb3NpdGlvbihSLm1hdHJpeFdvcmxkKTsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjLm1hdGVyaWFsLCAiZW52TWFwIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmVudk1hcC52YWx1ZTsKICAgICAgfQogICAgfSksIG4udXBkYXRlKGMpKSwganMuY29weShfLmJhY2tncm91bmRSb3RhdGlvbiksIGpzLnggKj0gLTEsIGpzLnkgKj0gLTEsIGpzLnogKj0gLTEsIFMuaXNDdWJlVGV4dHVyZSAmJiBTLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9PT0gITEgJiYgKGpzLnkgKj0gLTEsIGpzLnogKj0gLTEpLCBjLm1hdGVyaWFsLnVuaWZvcm1zLmVudk1hcC52YWx1ZSA9IFMsIGMubWF0ZXJpYWwudW5pZm9ybXMuZmxpcEVudk1hcC52YWx1ZSA9IFMuaXNDdWJlVGV4dHVyZSAmJiBTLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9PT0gITEgPyAtMSA6IDEsIGMubWF0ZXJpYWwudW5pZm9ybXMuYmFja2dyb3VuZEJsdXJyaW5lc3MudmFsdWUgPSBfLmJhY2tncm91bmRCbHVycmluZXNzLCBjLm1hdGVyaWFsLnVuaWZvcm1zLmJhY2tncm91bmRJbnRlbnNpdHkudmFsdWUgPSBfLmJhY2tncm91bmRJbnRlbnNpdHksIGMubWF0ZXJpYWwudW5pZm9ybXMuYmFja2dyb3VuZFJvdGF0aW9uLnZhbHVlLnNldEZyb21NYXRyaXg0KHd3Lm1ha2VSb3RhdGlvbkZyb21FdWxlcihqcykpLCBjLm1hdGVyaWFsLnRvbmVNYXBwZWQgPSBlZS5nZXRUcmFuc2ZlcihTLmNvbG9yU3BhY2UpICE9PSBjZSwgKHUgIT09IFMgfHwgZCAhPT0gUy52ZXJzaW9uIHx8IHAgIT09IGEudG9uZU1hcHBpbmcpICYmIChjLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITAsIHUgPSBTLCBkID0gUy52ZXJzaW9uLCBwID0gYS50b25lTWFwcGluZyksIGMubGF5ZXJzLmVuYWJsZUFsbCgpLCB4LnVuc2hpZnQoYywgYy5nZW9tZXRyeSwgYy5tYXRlcmlhbCwgMCwgMCwgbnVsbCkpIDogUyAmJiBTLmlzVGV4dHVyZSAmJiAoaCA9PT0gdm9pZCAwICYmIChoID0gbmV3IHJlKAogICAgICBuZXcgRHMoMiwgMiksCiAgICAgIG5ldyBYaSh7CiAgICAgICAgbmFtZTogIkJhY2tncm91bmRNYXRlcmlhbCIsCiAgICAgICAgdW5pZm9ybXM6IF9hKGZpLmJhY2tncm91bmQudW5pZm9ybXMpLAogICAgICAgIHZlcnRleFNoYWRlcjogZmkuYmFja2dyb3VuZC52ZXJ0ZXhTaGFkZXIsCiAgICAgICAgZnJhZ21lbnRTaGFkZXI6IGZpLmJhY2tncm91bmQuZnJhZ21lbnRTaGFkZXIsCiAgICAgICAgc2lkZTogJGksCiAgICAgICAgZGVwdGhUZXN0OiAhMSwKICAgICAgICBkZXB0aFdyaXRlOiAhMSwKICAgICAgICBmb2c6ICExLAogICAgICAgIGFsbG93T3ZlcnJpZGU6ICExCiAgICAgIH0pCiAgICApLCBoLmdlb21ldHJ5LmRlbGV0ZUF0dHJpYnV0ZSgibm9ybWFsIiksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShoLm1hdGVyaWFsLCAibWFwIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnQyRC52YWx1ZTsKICAgICAgfQogICAgfSksIG4udXBkYXRlKGgpKSwgaC5tYXRlcmlhbC51bmlmb3Jtcy50MkQudmFsdWUgPSBTLCBoLm1hdGVyaWFsLnVuaWZvcm1zLmJhY2tncm91bmRJbnRlbnNpdHkudmFsdWUgPSBfLmJhY2tncm91bmRJbnRlbnNpdHksIGgubWF0ZXJpYWwudG9uZU1hcHBlZCA9IGVlLmdldFRyYW5zZmVyKFMuY29sb3JTcGFjZSkgIT09IGNlLCBTLm1hdHJpeEF1dG9VcGRhdGUgPT09ICEwICYmIFMudXBkYXRlTWF0cml4KCksIGgubWF0ZXJpYWwudW5pZm9ybXMudXZUcmFuc2Zvcm0udmFsdWUuY29weShTLm1hdHJpeCksICh1ICE9PSBTIHx8IGQgIT09IFMudmVyc2lvbiB8fCBwICE9PSBhLnRvbmVNYXBwaW5nKSAmJiAoaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9ICEwLCB1ID0gUywgZCA9IFMudmVyc2lvbiwgcCA9IGEudG9uZU1hcHBpbmcpLCBoLmxheWVycy5lbmFibGVBbGwoKSwgeC51bnNoaWZ0KGgsIGguZ2VvbWV0cnksIGgubWF0ZXJpYWwsIDAsIDAsIG51bGwpKTsKICB9CiAgZnVuY3Rpb24gbSh4LCBfKSB7CiAgICB4LmdldFJHQih6bCwgd3koYSkpLCBpLmJ1ZmZlcnMuY29sb3Iuc2V0Q2xlYXIoemwuciwgemwuZywgemwuYiwgXywgcik7CiAgfQogIGZ1bmN0aW9uIHYoKSB7CiAgICBjICE9PSB2b2lkIDAgJiYgKGMuZ2VvbWV0cnkuZGlzcG9zZSgpLCBjLm1hdGVyaWFsLmRpc3Bvc2UoKSwgYyA9IHZvaWQgMCksIGggIT09IHZvaWQgMCAmJiAoaC5nZW9tZXRyeS5kaXNwb3NlKCksIGgubWF0ZXJpYWwuZGlzcG9zZSgpLCBoID0gdm9pZCAwKTsKICB9CiAgcmV0dXJuIHsKICAgIGdldENsZWFyQ29sb3I6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbzsKICAgIH0sCiAgICBzZXRDbGVhckNvbG9yOiBmdW5jdGlvbih4LCBfID0gMSkgewogICAgICBvLnNldCh4KSwgbCA9IF8sIG0obywgbCk7CiAgICB9LAogICAgZ2V0Q2xlYXJBbHBoYTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBsOwogICAgfSwKICAgIHNldENsZWFyQWxwaGE6IGZ1bmN0aW9uKHgpIHsKICAgICAgbCA9IHgsIG0obywgbCk7CiAgICB9LAogICAgcmVuZGVyOiB5LAogICAgYWRkVG9SZW5kZXJMaXN0OiBnLAogICAgZGlzcG9zZTogdgogIH07Cn0KZnVuY3Rpb24gRXcoYSwgdCkgewogIGNvbnN0IGUgPSBhLmdldFBhcmFtZXRlcihhLk1BWF9WRVJURVhfQVRUUklCUyksIGkgPSB7fSwgbiA9IGQobnVsbCk7CiAgbGV0IHMgPSBuLCByID0gITE7CiAgZnVuY3Rpb24gbyhNLCBMLCBVLCBPLCBWKSB7CiAgICBsZXQgVyA9ICExOwogICAgY29uc3QgRyA9IHUoTywgVSwgTCk7CiAgICBzICE9PSBHICYmIChzID0gRywgaChzLm9iamVjdCkpLCBXID0gcChNLCBPLCBVLCBWKSwgVyAmJiBmKE0sIE8sIFUsIFYpLCBWICE9PSBudWxsICYmIHQudXBkYXRlKFYsIGEuRUxFTUVOVF9BUlJBWV9CVUZGRVIpLCAoVyB8fCByKSAmJiAociA9ICExLCBfKE0sIEwsIFUsIE8pLCBWICE9PSBudWxsICYmIGEuYmluZEJ1ZmZlcihhLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0LmdldChWKS5idWZmZXIpKTsKICB9CiAgZnVuY3Rpb24gbCgpIHsKICAgIHJldHVybiBhLmNyZWF0ZVZlcnRleEFycmF5KCk7CiAgfQogIGZ1bmN0aW9uIGgoTSkgewogICAgcmV0dXJuIGEuYmluZFZlcnRleEFycmF5KE0pOwogIH0KICBmdW5jdGlvbiBjKE0pIHsKICAgIHJldHVybiBhLmRlbGV0ZVZlcnRleEFycmF5KE0pOwogIH0KICBmdW5jdGlvbiB1KE0sIEwsIFUpIHsKICAgIGNvbnN0IE8gPSBVLndpcmVmcmFtZSA9PT0gITA7CiAgICBsZXQgViA9IGlbTS5pZF07CiAgICBWID09PSB2b2lkIDAgJiYgKFYgPSB7fSwgaVtNLmlkXSA9IFYpOwogICAgbGV0IFcgPSBWW0wuaWRdOwogICAgVyA9PT0gdm9pZCAwICYmIChXID0ge30sIFZbTC5pZF0gPSBXKTsKICAgIGxldCBHID0gV1tPXTsKICAgIHJldHVybiBHID09PSB2b2lkIDAgJiYgKEcgPSBkKGwoKSksIFdbT10gPSBHKSwgRzsKICB9CiAgZnVuY3Rpb24gZChNKSB7CiAgICBjb25zdCBMID0gW10sIFUgPSBbXSwgTyA9IFtdOwogICAgZm9yIChsZXQgViA9IDA7IFYgPCBlOyBWKyspCiAgICAgIExbVl0gPSAwLCBVW1ZdID0gMCwgT1tWXSA9IDA7CiAgICByZXR1cm4gewogICAgICAvLyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSBvbiBub24tVkFPIHN1cHBvcnQgYnJvd3NlcgogICAgICBnZW9tZXRyeTogbnVsbCwKICAgICAgcHJvZ3JhbTogbnVsbCwKICAgICAgd2lyZWZyYW1lOiAhMSwKICAgICAgbmV3QXR0cmlidXRlczogTCwKICAgICAgZW5hYmxlZEF0dHJpYnV0ZXM6IFUsCiAgICAgIGF0dHJpYnV0ZURpdmlzb3JzOiBPLAogICAgICBvYmplY3Q6IE0sCiAgICAgIGF0dHJpYnV0ZXM6IHt9LAogICAgICBpbmRleDogbnVsbAogICAgfTsKICB9CiAgZnVuY3Rpb24gcChNLCBMLCBVLCBPKSB7CiAgICBjb25zdCBWID0gcy5hdHRyaWJ1dGVzLCBXID0gTC5hdHRyaWJ1dGVzOwogICAgbGV0IEcgPSAwOwogICAgY29uc3QgZXQgPSBVLmdldEF0dHJpYnV0ZXMoKTsKICAgIGZvciAoY29uc3QgSCBpbiBldCkKICAgICAgaWYgKGV0W0hdLmxvY2F0aW9uID49IDApIHsKICAgICAgICBjb25zdCBwdCA9IFZbSF07CiAgICAgICAgbGV0IE10ID0gV1tIXTsKICAgICAgICBpZiAoTXQgPT09IHZvaWQgMCAmJiAoSCA9PT0gImluc3RhbmNlTWF0cml4IiAmJiBNLmluc3RhbmNlTWF0cml4ICYmIChNdCA9IE0uaW5zdGFuY2VNYXRyaXgpLCBIID09PSAiaW5zdGFuY2VDb2xvciIgJiYgTS5pbnN0YW5jZUNvbG9yICYmIChNdCA9IE0uaW5zdGFuY2VDb2xvcikpLCBwdCA9PT0gdm9pZCAwIHx8IHB0LmF0dHJpYnV0ZSAhPT0gTXQgfHwgTXQgJiYgcHQuZGF0YSAhPT0gTXQuZGF0YSkgcmV0dXJuICEwOwogICAgICAgIEcrKzsKICAgICAgfQogICAgcmV0dXJuIHMuYXR0cmlidXRlc051bSAhPT0gRyB8fCBzLmluZGV4ICE9PSBPOwogIH0KICBmdW5jdGlvbiBmKE0sIEwsIFUsIE8pIHsKICAgIGNvbnN0IFYgPSB7fSwgVyA9IEwuYXR0cmlidXRlczsKICAgIGxldCBHID0gMDsKICAgIGNvbnN0IGV0ID0gVS5nZXRBdHRyaWJ1dGVzKCk7CiAgICBmb3IgKGNvbnN0IEggaW4gZXQpCiAgICAgIGlmIChldFtIXS5sb2NhdGlvbiA+PSAwKSB7CiAgICAgICAgbGV0IHB0ID0gV1tIXTsKICAgICAgICBwdCA9PT0gdm9pZCAwICYmIChIID09PSAiaW5zdGFuY2VNYXRyaXgiICYmIE0uaW5zdGFuY2VNYXRyaXggJiYgKHB0ID0gTS5pbnN0YW5jZU1hdHJpeCksIEggPT09ICJpbnN0YW5jZUNvbG9yIiAmJiBNLmluc3RhbmNlQ29sb3IgJiYgKHB0ID0gTS5pbnN0YW5jZUNvbG9yKSk7CiAgICAgICAgY29uc3QgTXQgPSB7fTsKICAgICAgICBNdC5hdHRyaWJ1dGUgPSBwdCwgcHQgJiYgcHQuZGF0YSAmJiAoTXQuZGF0YSA9IHB0LmRhdGEpLCBWW0hdID0gTXQsIEcrKzsKICAgICAgfQogICAgcy5hdHRyaWJ1dGVzID0gViwgcy5hdHRyaWJ1dGVzTnVtID0gRywgcy5pbmRleCA9IE87CiAgfQogIGZ1bmN0aW9uIHkoKSB7CiAgICBjb25zdCBNID0gcy5uZXdBdHRyaWJ1dGVzOwogICAgZm9yIChsZXQgTCA9IDAsIFUgPSBNLmxlbmd0aDsgTCA8IFU7IEwrKykKICAgICAgTVtMXSA9IDA7CiAgfQogIGZ1bmN0aW9uIGcoTSkgewogICAgbShNLCAwKTsKICB9CiAgZnVuY3Rpb24gbShNLCBMKSB7CiAgICBjb25zdCBVID0gcy5uZXdBdHRyaWJ1dGVzLCBPID0gcy5lbmFibGVkQXR0cmlidXRlcywgViA9IHMuYXR0cmlidXRlRGl2aXNvcnM7CiAgICBVW01dID0gMSwgT1tNXSA9PT0gMCAmJiAoYS5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShNKSwgT1tNXSA9IDEpLCBWW01dICE9PSBMICYmIChhLnZlcnRleEF0dHJpYkRpdmlzb3IoTSwgTCksIFZbTV0gPSBMKTsKICB9CiAgZnVuY3Rpb24gdigpIHsKICAgIGNvbnN0IE0gPSBzLm5ld0F0dHJpYnV0ZXMsIEwgPSBzLmVuYWJsZWRBdHRyaWJ1dGVzOwogICAgZm9yIChsZXQgVSA9IDAsIE8gPSBMLmxlbmd0aDsgVSA8IE87IFUrKykKICAgICAgTFtVXSAhPT0gTVtVXSAmJiAoYS5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoVSksIExbVV0gPSAwKTsKICB9CiAgZnVuY3Rpb24geChNLCBMLCBVLCBPLCBWLCBXLCBHKSB7CiAgICBHID09PSAhMCA/IGEudmVydGV4QXR0cmliSVBvaW50ZXIoTSwgTCwgVSwgViwgVykgOiBhLnZlcnRleEF0dHJpYlBvaW50ZXIoTSwgTCwgVSwgTywgViwgVyk7CiAgfQogIGZ1bmN0aW9uIF8oTSwgTCwgVSwgTykgewogICAgeSgpOwogICAgY29uc3QgViA9IE8uYXR0cmlidXRlcywgVyA9IFUuZ2V0QXR0cmlidXRlcygpLCBHID0gTC5kZWZhdWx0QXR0cmlidXRlVmFsdWVzOwogICAgZm9yIChjb25zdCBldCBpbiBXKSB7CiAgICAgIGNvbnN0IEggPSBXW2V0XTsKICAgICAgaWYgKEgubG9jYXRpb24gPj0gMCkgewogICAgICAgIGxldCBhdCA9IFZbZXRdOwogICAgICAgIGlmIChhdCA9PT0gdm9pZCAwICYmIChldCA9PT0gImluc3RhbmNlTWF0cml4IiAmJiBNLmluc3RhbmNlTWF0cml4ICYmIChhdCA9IE0uaW5zdGFuY2VNYXRyaXgpLCBldCA9PT0gImluc3RhbmNlQ29sb3IiICYmIE0uaW5zdGFuY2VDb2xvciAmJiAoYXQgPSBNLmluc3RhbmNlQ29sb3IpKSwgYXQgIT09IHZvaWQgMCkgewogICAgICAgICAgY29uc3QgcHQgPSBhdC5ub3JtYWxpemVkLCBNdCA9IGF0Lml0ZW1TaXplLCBMdCA9IHQuZ2V0KGF0KTsKICAgICAgICAgIGlmIChMdCA9PT0gdm9pZCAwKSBjb250aW51ZTsKICAgICAgICAgIGNvbnN0IGp0ID0gTHQuYnVmZmVyLCBuZSA9IEx0LnR5cGUsIEp0ID0gTHQuYnl0ZXNQZXJFbGVtZW50LCBZID0gbmUgPT09IGEuSU5UIHx8IG5lID09PSBhLlVOU0lHTkVEX0lOVCB8fCBhdC5ncHVUeXBlID09PSBSYzsKICAgICAgICAgIGlmIChhdC5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlKSB7CiAgICAgICAgICAgIGNvbnN0IHN0ID0gYXQuZGF0YSwgRXQgPSBzdC5zdHJpZGUsIFV0ID0gYXQub2Zmc2V0OwogICAgICAgICAgICBpZiAoc3QuaXNJbnN0YW5jZWRJbnRlcmxlYXZlZEJ1ZmZlcikgewogICAgICAgICAgICAgIGZvciAobGV0IFB0ID0gMDsgUHQgPCBILmxvY2F0aW9uU2l6ZTsgUHQrKykKICAgICAgICAgICAgICAgIG0oSC5sb2NhdGlvbiArIFB0LCBzdC5tZXNoUGVyQXR0cmlidXRlKTsKICAgICAgICAgICAgICBNLmlzSW5zdGFuY2VkTWVzaCAhPT0gITAgJiYgTy5fbWF4SW5zdGFuY2VDb3VudCA9PT0gdm9pZCAwICYmIChPLl9tYXhJbnN0YW5jZUNvdW50ID0gc3QubWVzaFBlckF0dHJpYnV0ZSAqIHN0LmNvdW50KTsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgZm9yIChsZXQgUHQgPSAwOyBQdCA8IEgubG9jYXRpb25TaXplOyBQdCsrKQogICAgICAgICAgICAgICAgZyhILmxvY2F0aW9uICsgUHQpOwogICAgICAgICAgICBhLmJpbmRCdWZmZXIoYS5BUlJBWV9CVUZGRVIsIGp0KTsKICAgICAgICAgICAgZm9yIChsZXQgUHQgPSAwOyBQdCA8IEgubG9jYXRpb25TaXplOyBQdCsrKQogICAgICAgICAgICAgIHgoCiAgICAgICAgICAgICAgICBILmxvY2F0aW9uICsgUHQsCiAgICAgICAgICAgICAgICBNdCAvIEgubG9jYXRpb25TaXplLAogICAgICAgICAgICAgICAgbmUsCiAgICAgICAgICAgICAgICBwdCwKICAgICAgICAgICAgICAgIEV0ICogSnQsCiAgICAgICAgICAgICAgICAoVXQgKyBNdCAvIEgubG9jYXRpb25TaXplICogUHQpICogSnQsCiAgICAgICAgICAgICAgICBZCiAgICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChhdC5pc0luc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZSkgewogICAgICAgICAgICAgIGZvciAobGV0IHN0ID0gMDsgc3QgPCBILmxvY2F0aW9uU2l6ZTsgc3QrKykKICAgICAgICAgICAgICAgIG0oSC5sb2NhdGlvbiArIHN0LCBhdC5tZXNoUGVyQXR0cmlidXRlKTsKICAgICAgICAgICAgICBNLmlzSW5zdGFuY2VkTWVzaCAhPT0gITAgJiYgTy5fbWF4SW5zdGFuY2VDb3VudCA9PT0gdm9pZCAwICYmIChPLl9tYXhJbnN0YW5jZUNvdW50ID0gYXQubWVzaFBlckF0dHJpYnV0ZSAqIGF0LmNvdW50KTsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgZm9yIChsZXQgc3QgPSAwOyBzdCA8IEgubG9jYXRpb25TaXplOyBzdCsrKQogICAgICAgICAgICAgICAgZyhILmxvY2F0aW9uICsgc3QpOwogICAgICAgICAgICBhLmJpbmRCdWZmZXIoYS5BUlJBWV9CVUZGRVIsIGp0KTsKICAgICAgICAgICAgZm9yIChsZXQgc3QgPSAwOyBzdCA8IEgubG9jYXRpb25TaXplOyBzdCsrKQogICAgICAgICAgICAgIHgoCiAgICAgICAgICAgICAgICBILmxvY2F0aW9uICsgc3QsCiAgICAgICAgICAgICAgICBNdCAvIEgubG9jYXRpb25TaXplLAogICAgICAgICAgICAgICAgbmUsCiAgICAgICAgICAgICAgICBwdCwKICAgICAgICAgICAgICAgIE10ICogSnQsCiAgICAgICAgICAgICAgICBNdCAvIEgubG9jYXRpb25TaXplICogc3QgKiBKdCwKICAgICAgICAgICAgICAgIFkKICAgICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoRyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBjb25zdCBwdCA9IEdbZXRdOwogICAgICAgICAgaWYgKHB0ICE9PSB2b2lkIDApCiAgICAgICAgICAgIHN3aXRjaCAocHQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgYS52ZXJ0ZXhBdHRyaWIyZnYoSC5sb2NhdGlvbiwgcHQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgYS52ZXJ0ZXhBdHRyaWIzZnYoSC5sb2NhdGlvbiwgcHQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgYS52ZXJ0ZXhBdHRyaWI0ZnYoSC5sb2NhdGlvbiwgcHQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGEudmVydGV4QXR0cmliMWZ2KEgubG9jYXRpb24sIHB0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdigpOwogIH0KICBmdW5jdGlvbiBTKCkgewogICAgUigpOwogICAgZm9yIChjb25zdCBNIGluIGkpIHsKICAgICAgY29uc3QgTCA9IGlbTV07CiAgICAgIGZvciAoY29uc3QgVSBpbiBMKSB7CiAgICAgICAgY29uc3QgTyA9IExbVV07CiAgICAgICAgZm9yIChjb25zdCBWIGluIE8pCiAgICAgICAgICBjKE9bVl0ub2JqZWN0KSwgZGVsZXRlIE9bVl07CiAgICAgICAgZGVsZXRlIExbVV07CiAgICAgIH0KICAgICAgZGVsZXRlIGlbTV07CiAgICB9CiAgfQogIGZ1bmN0aW9uIHcoTSkgewogICAgaWYgKGlbTS5pZF0gPT09IHZvaWQgMCkgcmV0dXJuOwogICAgY29uc3QgTCA9IGlbTS5pZF07CiAgICBmb3IgKGNvbnN0IFUgaW4gTCkgewogICAgICBjb25zdCBPID0gTFtVXTsKICAgICAgZm9yIChjb25zdCBWIGluIE8pCiAgICAgICAgYyhPW1ZdLm9iamVjdCksIGRlbGV0ZSBPW1ZdOwogICAgICBkZWxldGUgTFtVXTsKICAgIH0KICAgIGRlbGV0ZSBpW00uaWRdOwogIH0KICBmdW5jdGlvbiBUKE0pIHsKICAgIGZvciAoY29uc3QgTCBpbiBpKSB7CiAgICAgIGNvbnN0IFUgPSBpW0xdOwogICAgICBpZiAoVVtNLmlkXSA9PT0gdm9pZCAwKSBjb250aW51ZTsKICAgICAgY29uc3QgTyA9IFVbTS5pZF07CiAgICAgIGZvciAoY29uc3QgViBpbiBPKQogICAgICAgIGMoT1tWXS5vYmplY3QpLCBkZWxldGUgT1tWXTsKICAgICAgZGVsZXRlIFVbTS5pZF07CiAgICB9CiAgfQogIGZ1bmN0aW9uIFIoKSB7CiAgICBiKCksIHIgPSAhMCwgcyAhPT0gbiAmJiAocyA9IG4sIGgocy5vYmplY3QpKTsKICB9CiAgZnVuY3Rpb24gYigpIHsKICAgIG4uZ2VvbWV0cnkgPSBudWxsLCBuLnByb2dyYW0gPSBudWxsLCBuLndpcmVmcmFtZSA9ICExOwogIH0KICByZXR1cm4gewogICAgc2V0dXA6IG8sCiAgICByZXNldDogUiwKICAgIHJlc2V0RGVmYXVsdFN0YXRlOiBiLAogICAgZGlzcG9zZTogUywKICAgIHJlbGVhc2VTdGF0ZXNPZkdlb21ldHJ5OiB3LAogICAgcmVsZWFzZVN0YXRlc09mUHJvZ3JhbTogVCwKICAgIGluaXRBdHRyaWJ1dGVzOiB5LAogICAgZW5hYmxlQXR0cmlidXRlOiBnLAogICAgZGlzYWJsZVVudXNlZEF0dHJpYnV0ZXM6IHYKICB9Owp9CmZ1bmN0aW9uIFR3KGEsIHQsIGUpIHsKICBsZXQgaTsKICBmdW5jdGlvbiBuKGgpIHsKICAgIGkgPSBoOwogIH0KICBmdW5jdGlvbiBzKGgsIGMpIHsKICAgIGEuZHJhd0FycmF5cyhpLCBoLCBjKSwgZS51cGRhdGUoYywgaSwgMSk7CiAgfQogIGZ1bmN0aW9uIHIoaCwgYywgdSkgewogICAgdSAhPT0gMCAmJiAoYS5kcmF3QXJyYXlzSW5zdGFuY2VkKGksIGgsIGMsIHUpLCBlLnVwZGF0ZShjLCBpLCB1KSk7CiAgfQogIGZ1bmN0aW9uIG8oaCwgYywgdSkgewogICAgaWYgKHUgPT09IDApIHJldHVybjsKICAgIHQuZ2V0KCJXRUJHTF9tdWx0aV9kcmF3IikubXVsdGlEcmF3QXJyYXlzV0VCR0woaSwgaCwgMCwgYywgMCwgdSk7CiAgICBsZXQgcCA9IDA7CiAgICBmb3IgKGxldCBmID0gMDsgZiA8IHU7IGYrKykKICAgICAgcCArPSBjW2ZdOwogICAgZS51cGRhdGUocCwgaSwgMSk7CiAgfQogIGZ1bmN0aW9uIGwoaCwgYywgdSwgZCkgewogICAgaWYgKHUgPT09IDApIHJldHVybjsKICAgIGNvbnN0IHAgPSB0LmdldCgiV0VCR0xfbXVsdGlfZHJhdyIpOwogICAgaWYgKHAgPT09IG51bGwpCiAgICAgIGZvciAobGV0IGYgPSAwOyBmIDwgaC5sZW5ndGg7IGYrKykKICAgICAgICByKGhbZl0sIGNbZl0sIGRbZl0pOwogICAgZWxzZSB7CiAgICAgIHAubXVsdGlEcmF3QXJyYXlzSW5zdGFuY2VkV0VCR0woaSwgaCwgMCwgYywgMCwgZCwgMCwgdSk7CiAgICAgIGxldCBmID0gMDsKICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB1OyB5KyspCiAgICAgICAgZiArPSBjW3ldICogZFt5XTsKICAgICAgZS51cGRhdGUoZiwgaSwgMSk7CiAgICB9CiAgfQogIHRoaXMuc2V0TW9kZSA9IG4sIHRoaXMucmVuZGVyID0gcywgdGhpcy5yZW5kZXJJbnN0YW5jZXMgPSByLCB0aGlzLnJlbmRlck11bHRpRHJhdyA9IG8sIHRoaXMucmVuZGVyTXVsdGlEcmF3SW5zdGFuY2VzID0gbDsKfQpmdW5jdGlvbiBDdyhhLCB0LCBlLCBpKSB7CiAgbGV0IG47CiAgZnVuY3Rpb24gcygpIHsKICAgIGlmIChuICE9PSB2b2lkIDApIHJldHVybiBuOwogICAgaWYgKHQuaGFzKCJFWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiKSA9PT0gITApIHsKICAgICAgY29uc3QgVCA9IHQuZ2V0KCJFWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiKTsKICAgICAgbiA9IGEuZ2V0UGFyYW1ldGVyKFQuTUFYX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUKTsKICAgIH0gZWxzZQogICAgICBuID0gMDsKICAgIHJldHVybiBuOwogIH0KICBmdW5jdGlvbiByKFQpIHsKICAgIHJldHVybiAhKFQgIT09IGdpICYmIGkuY29udmVydChUKSAhPT0gYS5nZXRQYXJhbWV0ZXIoYS5JTVBMRU1FTlRBVElPTl9DT0xPUl9SRUFEX0ZPUk1BVCkpOwogIH0KICBmdW5jdGlvbiBvKFQpIHsKICAgIGNvbnN0IFIgPSBUID09PSB3YSAmJiAodC5oYXMoIkVYVF9jb2xvcl9idWZmZXJfaGFsZl9mbG9hdCIpIHx8IHQuaGFzKCJFWFRfY29sb3JfYnVmZmVyX2Zsb2F0IikpOwogICAgcmV0dXJuICEoVCAhPT0gcG4gJiYgaS5jb252ZXJ0KFQpICE9PSBhLmdldFBhcmFtZXRlcihhLklNUExFTUVOVEFUSU9OX0NPTE9SX1JFQURfVFlQRSkgJiYgLy8gRWRnZSBhbmQgQ2hyb21lIE1hYyA8IDUyICgjOTUxMykKICAgIFQgIT09IHdpICYmICFSKTsKICB9CiAgZnVuY3Rpb24gbChUKSB7CiAgICBpZiAoVCA9PT0gImhpZ2hwIikgewogICAgICBpZiAoYS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoYS5WRVJURVhfU0hBREVSLCBhLkhJR0hfRkxPQVQpLnByZWNpc2lvbiA+IDAgJiYgYS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoYS5GUkFHTUVOVF9TSEFERVIsIGEuSElHSF9GTE9BVCkucHJlY2lzaW9uID4gMCkKICAgICAgICByZXR1cm4gImhpZ2hwIjsKICAgICAgVCA9ICJtZWRpdW1wIjsKICAgIH0KICAgIHJldHVybiBUID09PSAibWVkaXVtcCIgJiYgYS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoYS5WRVJURVhfU0hBREVSLCBhLk1FRElVTV9GTE9BVCkucHJlY2lzaW9uID4gMCAmJiBhLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChhLkZSQUdNRU5UX1NIQURFUiwgYS5NRURJVU1fRkxPQVQpLnByZWNpc2lvbiA+IDAgPyAibWVkaXVtcCIgOiAibG93cCI7CiAgfQogIGxldCBoID0gZS5wcmVjaXNpb24gIT09IHZvaWQgMCA/IGUucHJlY2lzaW9uIDogImhpZ2hwIjsKICBjb25zdCBjID0gbChoKTsKICBjICE9PSBoICYmIChjb25zb2xlLndhcm4oIlRIUkVFLldlYkdMUmVuZGVyZXI6IiwgaCwgIm5vdCBzdXBwb3J0ZWQsIHVzaW5nIiwgYywgImluc3RlYWQuIiksIGggPSBjKTsKICBjb25zdCB1ID0gZS5sb2dhcml0aG1pY0RlcHRoQnVmZmVyID09PSAhMCwgZCA9IGUucmV2ZXJzZWREZXB0aEJ1ZmZlciA9PT0gITAgJiYgdC5oYXMoIkVYVF9jbGlwX2NvbnRyb2wiKSwgcCA9IGEuZ2V0UGFyYW1ldGVyKGEuTUFYX1RFWFRVUkVfSU1BR0VfVU5JVFMpLCBmID0gYS5nZXRQYXJhbWV0ZXIoYS5NQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFMpLCB5ID0gYS5nZXRQYXJhbWV0ZXIoYS5NQVhfVEVYVFVSRV9TSVpFKSwgZyA9IGEuZ2V0UGFyYW1ldGVyKGEuTUFYX0NVQkVfTUFQX1RFWFRVUkVfU0laRSksIG0gPSBhLmdldFBhcmFtZXRlcihhLk1BWF9WRVJURVhfQVRUUklCUyksIHYgPSBhLmdldFBhcmFtZXRlcihhLk1BWF9WRVJURVhfVU5JRk9STV9WRUNUT1JTKSwgeCA9IGEuZ2V0UGFyYW1ldGVyKGEuTUFYX1ZBUllJTkdfVkVDVE9SUyksIF8gPSBhLmdldFBhcmFtZXRlcihhLk1BWF9GUkFHTUVOVF9VTklGT1JNX1ZFQ1RPUlMpLCBTID0gZiA+IDAsIHcgPSBhLmdldFBhcmFtZXRlcihhLk1BWF9TQU1QTEVTKTsKICByZXR1cm4gewogICAgaXNXZWJHTDI6ICEwLAogICAgLy8ga2VlcGluZyB0aGlzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgZ2V0TWF4QW5pc290cm9weTogcywKICAgIGdldE1heFByZWNpc2lvbjogbCwKICAgIHRleHR1cmVGb3JtYXRSZWFkYWJsZTogciwKICAgIHRleHR1cmVUeXBlUmVhZGFibGU6IG8sCiAgICBwcmVjaXNpb246IGgsCiAgICBsb2dhcml0aG1pY0RlcHRoQnVmZmVyOiB1LAogICAgcmV2ZXJzZWREZXB0aEJ1ZmZlcjogZCwKICAgIG1heFRleHR1cmVzOiBwLAogICAgbWF4VmVydGV4VGV4dHVyZXM6IGYsCiAgICBtYXhUZXh0dXJlU2l6ZTogeSwKICAgIG1heEN1YmVtYXBTaXplOiBnLAogICAgbWF4QXR0cmlidXRlczogbSwKICAgIG1heFZlcnRleFVuaWZvcm1zOiB2LAogICAgbWF4VmFyeWluZ3M6IHgsCiAgICBtYXhGcmFnbWVudFVuaWZvcm1zOiBfLAogICAgdmVydGV4VGV4dHVyZXM6IFMsCiAgICBtYXhTYW1wbGVzOiB3CiAgfTsKfQpmdW5jdGlvbiBSdyhhKSB7CiAgY29uc3QgdCA9IHRoaXM7CiAgbGV0IGUgPSBudWxsLCBpID0gMCwgbiA9ICExLCBzID0gITE7CiAgY29uc3QgciA9IG5ldyBxbigpLCBvID0gbmV3IFh0KCksIGwgPSB7IHZhbHVlOiBudWxsLCBuZWVkc1VwZGF0ZTogITEgfTsKICB0aGlzLnVuaWZvcm0gPSBsLCB0aGlzLm51bVBsYW5lcyA9IDAsIHRoaXMubnVtSW50ZXJzZWN0aW9uID0gMCwgdGhpcy5pbml0ID0gZnVuY3Rpb24odSwgZCkgewogICAgY29uc3QgcCA9IHUubGVuZ3RoICE9PSAwIHx8IGQgfHwgLy8gZW5hYmxlIHN0YXRlIG9mIHByZXZpb3VzIGZyYW1lIC0gdGhlIGNsaXBwaW5nIGNvZGUgaGFzIHRvCiAgICAvLyBydW4gYW5vdGhlciBmcmFtZSBpbiBvcmRlciB0byByZXNldCB0aGUgc3RhdGU6CiAgICBpICE9PSAwIHx8IG47CiAgICByZXR1cm4gbiA9IGQsIGkgPSB1Lmxlbmd0aCwgcDsKICB9LCB0aGlzLmJlZ2luU2hhZG93cyA9IGZ1bmN0aW9uKCkgewogICAgcyA9ICEwLCBjKG51bGwpOwogIH0sIHRoaXMuZW5kU2hhZG93cyA9IGZ1bmN0aW9uKCkgewogICAgcyA9ICExOwogIH0sIHRoaXMuc2V0R2xvYmFsU3RhdGUgPSBmdW5jdGlvbih1LCBkKSB7CiAgICBlID0gYyh1LCBkLCAwKTsKICB9LCB0aGlzLnNldFN0YXRlID0gZnVuY3Rpb24odSwgZCwgcCkgewogICAgY29uc3QgZiA9IHUuY2xpcHBpbmdQbGFuZXMsIHkgPSB1LmNsaXBJbnRlcnNlY3Rpb24sIGcgPSB1LmNsaXBTaGFkb3dzLCBtID0gYS5nZXQodSk7CiAgICBpZiAoIW4gfHwgZiA9PT0gbnVsbCB8fCBmLmxlbmd0aCA9PT0gMCB8fCBzICYmICFnKQogICAgICBzID8gYyhudWxsKSA6IGgoKTsKICAgIGVsc2UgewogICAgICBjb25zdCB2ID0gcyA/IDAgOiBpLCB4ID0gdiAqIDQ7CiAgICAgIGxldCBfID0gbS5jbGlwcGluZ1N0YXRlIHx8IG51bGw7CiAgICAgIGwudmFsdWUgPSBfLCBfID0gYyhmLCBkLCB4LCBwKTsKICAgICAgZm9yIChsZXQgUyA9IDA7IFMgIT09IHg7ICsrUykKICAgICAgICBfW1NdID0gZVtTXTsKICAgICAgbS5jbGlwcGluZ1N0YXRlID0gXywgdGhpcy5udW1JbnRlcnNlY3Rpb24gPSB5ID8gdGhpcy5udW1QbGFuZXMgOiAwLCB0aGlzLm51bVBsYW5lcyArPSB2OwogICAgfQogIH07CiAgZnVuY3Rpb24gaCgpIHsKICAgIGwudmFsdWUgIT09IGUgJiYgKGwudmFsdWUgPSBlLCBsLm5lZWRzVXBkYXRlID0gaSA+IDApLCB0Lm51bVBsYW5lcyA9IGksIHQubnVtSW50ZXJzZWN0aW9uID0gMDsKICB9CiAgZnVuY3Rpb24gYyh1LCBkLCBwLCBmKSB7CiAgICBjb25zdCB5ID0gdSAhPT0gbnVsbCA/IHUubGVuZ3RoIDogMDsKICAgIGxldCBnID0gbnVsbDsKICAgIGlmICh5ICE9PSAwKSB7CiAgICAgIGlmIChnID0gbC52YWx1ZSwgZiAhPT0gITAgfHwgZyA9PT0gbnVsbCkgewogICAgICAgIGNvbnN0IG0gPSBwICsgeSAqIDQsIHYgPSBkLm1hdHJpeFdvcmxkSW52ZXJzZTsKICAgICAgICBvLmdldE5vcm1hbE1hdHJpeCh2KSwgKGcgPT09IG51bGwgfHwgZy5sZW5ndGggPCBtKSAmJiAoZyA9IG5ldyBGbG9hdDMyQXJyYXkobSkpOwogICAgICAgIGZvciAobGV0IHggPSAwLCBfID0gcDsgeCAhPT0geTsgKyt4LCBfICs9IDQpCiAgICAgICAgICByLmNvcHkodVt4XSkuYXBwbHlNYXRyaXg0KHYsIG8pLCByLm5vcm1hbC50b0FycmF5KGcsIF8pLCBnW18gKyAzXSA9IHIuY29uc3RhbnQ7CiAgICAgIH0KICAgICAgbC52YWx1ZSA9IGcsIGwubmVlZHNVcGRhdGUgPSAhMDsKICAgIH0KICAgIHJldHVybiB0Lm51bVBsYW5lcyA9IHksIHQubnVtSW50ZXJzZWN0aW9uID0gMCwgZzsKICB9Cn0KZnVuY3Rpb24gUHcoYSkgewogIGxldCB0ID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgZnVuY3Rpb24gZShyLCBvKSB7CiAgICByZXR1cm4gbyA9PT0gdm8gPyByLm1hcHBpbmcgPSBpcyA6IG8gPT09IGJvICYmIChyLm1hcHBpbmcgPSBUcyksIHI7CiAgfQogIGZ1bmN0aW9uIGkocikgewogICAgaWYgKHIgJiYgci5pc1RleHR1cmUpIHsKICAgICAgY29uc3QgbyA9IHIubWFwcGluZzsKICAgICAgaWYgKG8gPT09IHZvIHx8IG8gPT09IGJvKQogICAgICAgIGlmICh0LmhhcyhyKSkgewogICAgICAgICAgY29uc3QgbCA9IHQuZ2V0KHIpLnRleHR1cmU7CiAgICAgICAgICByZXR1cm4gZShsLCByLm1hcHBpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBsID0gci5pbWFnZTsKICAgICAgICAgIGlmIChsICYmIGwuaGVpZ2h0ID4gMCkgewogICAgICAgICAgICBjb25zdCBoID0gbmV3IEV5KGwuaGVpZ2h0KTsKICAgICAgICAgICAgcmV0dXJuIGguZnJvbUVxdWlyZWN0YW5ndWxhclRleHR1cmUoYSwgciksIHQuc2V0KHIsIGgpLCByLmFkZEV2ZW50TGlzdGVuZXIoImRpc3Bvc2UiLCBuKSwgZShoLnRleHR1cmUsIHIubWFwcGluZyk7CiAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHI7CiAgfQogIGZ1bmN0aW9uIG4ocikgewogICAgY29uc3QgbyA9IHIudGFyZ2V0OwogICAgby5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgbik7CiAgICBjb25zdCBsID0gdC5nZXQobyk7CiAgICBsICE9PSB2b2lkIDAgJiYgKHQuZGVsZXRlKG8pLCBsLmRpc3Bvc2UoKSk7CiAgfQogIGZ1bmN0aW9uIHMoKSB7CiAgICB0ID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgfQogIHJldHVybiB7CiAgICBnZXQ6IGksCiAgICBkaXNwb3NlOiBzCiAgfTsKfQpjb25zdCBhYSA9IDQsIHptID0gWzAuMTI1LCAwLjIxNSwgMC4zNSwgMC40NDYsIDAuNTI2LCAwLjU4Ml0sIG5yID0gMjAsIGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBJYSgpLCBObSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgY3QoKTsKbGV0IGlkID0gbnVsbCwgbmQgPSAwLCBzZCA9IDAsIHJkID0gITE7CmNvbnN0IGlyID0gKDEgKyBNYXRoLnNxcnQoNSkpIC8gMiwga3IgPSAxIC8gaXIsIE9tID0gWwogIC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgtaXIsIGtyLCAwKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoaXIsIGtyLCAwKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoLWtyLCAwLCBpciksCiAgLyogQF9fUFVSRV9fICovIG5ldyBFKGtyLCAwLCBpciksCiAgLyogQF9fUFVSRV9fICovIG5ldyBFKDAsIGlyLCAta3IpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgwLCBpciwga3IpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgtMSwgMSwgLTEpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgRSgxLCAxLCAtMSksCiAgLyogQF9fUFVSRV9fICovIG5ldyBFKC0xLCAxLCAxKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IEUoMSwgMSwgMSkKXSwgSXcgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKY2xhc3MgaHAgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgUE1SRU0gZ2VuZXJhdG9yLgogICAqCiAgICogQHBhcmFtIHtXZWJHTFJlbmRlcmVyfSByZW5kZXJlciAtIFRoZSByZW5kZXJlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICB0aGlzLl9yZW5kZXJlciA9IHQsIHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ID0gbnVsbCwgdGhpcy5fbG9kTWF4ID0gMCwgdGhpcy5fY3ViZVNpemUgPSAwLCB0aGlzLl9sb2RQbGFuZXMgPSBbXSwgdGhpcy5fc2l6ZUxvZHMgPSBbXSwgdGhpcy5fc2lnbWFzID0gW10sIHRoaXMuX2JsdXJNYXRlcmlhbCA9IG51bGwsIHRoaXMuX2N1YmVtYXBNYXRlcmlhbCA9IG51bGwsIHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgPSBudWxsLCB0aGlzLl9jb21waWxlTWF0ZXJpYWwodGhpcy5fYmx1ck1hdGVyaWFsKTsKICB9CiAgLyoqCiAgICogR2VuZXJhdGVzIGEgUE1SRU0gZnJvbSBhIHN1cHBsaWVkIFNjZW5lLCB3aGljaCBjYW4gYmUgZmFzdGVyIHRoYW4gdXNpbmcgYW4KICAgKiBpbWFnZSBpZiBuZXR3b3JraW5nIGJhbmR3aWR0aCBpcyBsb3cuIE9wdGlvbmFsIHNpZ21hIHNwZWNpZmllcyBhIGJsdXIgcmFkaXVzCiAgICogaW4gcmFkaWFucyB0byBiZSBhcHBsaWVkIHRvIHRoZSBzY2VuZSBiZWZvcmUgUE1SRU0gZ2VuZXJhdGlvbi4gT3B0aW9uYWwgbmVhcgogICAqIGFuZCBmYXIgcGxhbmVzIGVuc3VyZSB0aGUgc2NlbmUgaXMgcmVuZGVyZWQgaW4gaXRzIGVudGlyZXR5LgogICAqCiAgICogQHBhcmFtIHtTY2VuZX0gc2NlbmUgLSBUaGUgc2NlbmUgdG8gYmUgY2FwdHVyZWQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzaWdtYT0wXSAtIFRoZSBibHVyIHJhZGl1cyBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbmVhcj0wLjFdIC0gVGhlIG5lYXIgcGxhbmUgZGlzdGFuY2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtmYXI9MTAwXSAtIFRoZSBmYXIgcGxhbmUgZGlzdGFuY2UuCiAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zPXt9XSAtIFRoZSBjb25maWd1cmF0aW9uIG9wdGlvbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLnNpemU9MjU2XSAtIFRoZSB0ZXh0dXJlIHNpemUgb2YgdGhlIFBNUkVNLgogICAqIEBwYXJhbSB7VmVjdG9yM30gW29wdGlvbnMucmVuZGVyVGFyZ2V0PW9yaWdpbl0gLSBUaGUgcG9zaXRpb24gb2YgdGhlIGludGVybmFsIGN1YmUgY2FtZXJhIHRoYXQgcmVuZGVycyB0aGUgc2NlbmUuCiAgICogQHJldHVybiB7V2ViR0xSZW5kZXJUYXJnZXR9IFRoZSByZXN1bHRpbmcgUE1SRU0uCiAgICovCiAgZnJvbVNjZW5lKHQsIGUgPSAwLCBpID0gMC4xLCBuID0gMTAwLCBzID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgc2l6ZTogciA9IDI1NiwKICAgICAgcG9zaXRpb246IG8gPSBJdwogICAgfSA9IHM7CiAgICBpZCA9IHRoaXMuX3JlbmRlcmVyLmdldFJlbmRlclRhcmdldCgpLCBuZCA9IHRoaXMuX3JlbmRlcmVyLmdldEFjdGl2ZUN1YmVGYWNlKCksIHNkID0gdGhpcy5fcmVuZGVyZXIuZ2V0QWN0aXZlTWlwbWFwTGV2ZWwoKSwgcmQgPSB0aGlzLl9yZW5kZXJlci54ci5lbmFibGVkLCB0aGlzLl9yZW5kZXJlci54ci5lbmFibGVkID0gITEsIHRoaXMuX3NldFNpemUocik7CiAgICBjb25zdCBsID0gdGhpcy5fYWxsb2NhdGVUYXJnZXRzKCk7CiAgICByZXR1cm4gbC5kZXB0aEJ1ZmZlciA9ICEwLCB0aGlzLl9zY2VuZVRvQ3ViZVVWKHQsIGksIG4sIGwsIG8pLCBlID4gMCAmJiB0aGlzLl9ibHVyKGwsIDAsIDAsIGUpLCB0aGlzLl9hcHBseVBNUkVNKGwpLCB0aGlzLl9jbGVhbnVwKGwpLCBsOwogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgYSBQTVJFTSBmcm9tIGFuIGVxdWlyZWN0YW5ndWxhciB0ZXh0dXJlLCB3aGljaCBjYW4gYmUgZWl0aGVyIExEUgogICAqIG9yIEhEUi4gVGhlIGlkZWFsIGlucHV0IGltYWdlIHNpemUgaXMgMWsgKDEwMjQgeCA1MTIpLAogICAqIGFzIHRoaXMgbWF0Y2hlcyBiZXN0IHdpdGggdGhlIDI1NiB4IDI1NiBjdWJlbWFwIG91dHB1dC4KICAgKgogICAqIEBwYXJhbSB7VGV4dHVyZX0gZXF1aXJlY3Rhbmd1bGFyIC0gVGhlIGVxdWlyZWN0YW5ndWxhciB0ZXh0dXJlIHRvIGJlIGNvbnZlcnRlZC4KICAgKiBAcGFyYW0gez9XZWJHTFJlbmRlclRhcmdldH0gW3JlbmRlclRhcmdldD1udWxsXSAtIFRoZSByZW5kZXIgdGFyZ2V0IHRvIHVzZS4KICAgKiBAcmV0dXJuIHtXZWJHTFJlbmRlclRhcmdldH0gVGhlIHJlc3VsdGluZyBQTVJFTS4KICAgKi8KICBmcm9tRXF1aXJlY3Rhbmd1bGFyKHQsIGUgPSBudWxsKSB7CiAgICByZXR1cm4gdGhpcy5fZnJvbVRleHR1cmUodCwgZSk7CiAgfQogIC8qKgogICAqIEdlbmVyYXRlcyBhIFBNUkVNIGZyb20gYW4gY3ViZW1hcCB0ZXh0dXJlLCB3aGljaCBjYW4gYmUgZWl0aGVyIExEUgogICAqIG9yIEhEUi4gVGhlIGlkZWFsIGlucHV0IGN1YmUgc2l6ZSBpcyAyNTYgeCAyNTYsCiAgICogYXMgdGhpcyBtYXRjaGVzIGJlc3Qgd2l0aCB0aGUgMjU2IHggMjU2IGN1YmVtYXAgb3V0cHV0LgogICAqCiAgICogQHBhcmFtIHtUZXh0dXJlfSBjdWJlbWFwIC0gVGhlIGN1YmVtYXAgdGV4dHVyZSB0byBiZSBjb252ZXJ0ZWQuCiAgICogQHBhcmFtIHs/V2ViR0xSZW5kZXJUYXJnZXR9IFtyZW5kZXJUYXJnZXQ9bnVsbF0gLSBUaGUgcmVuZGVyIHRhcmdldCB0byB1c2UuCiAgICogQHJldHVybiB7V2ViR0xSZW5kZXJUYXJnZXR9IFRoZSByZXN1bHRpbmcgUE1SRU0uCiAgICovCiAgZnJvbUN1YmVtYXAodCwgZSA9IG51bGwpIHsKICAgIHJldHVybiB0aGlzLl9mcm9tVGV4dHVyZSh0LCBlKTsKICB9CiAgLyoqCiAgICogUHJlLWNvbXBpbGVzIHRoZSBjdWJlbWFwIHNoYWRlci4gWW91IGNhbiBnZXQgZmFzdGVyIHN0YXJ0LXVwIGJ5IGludm9raW5nIHRoaXMgbWV0aG9kIGR1cmluZwogICAqIHlvdXIgdGV4dHVyZSdzIG5ldHdvcmsgZmV0Y2ggZm9yIGluY3JlYXNlZCBjb25jdXJyZW5jeS4KICAgKi8KICBjb21waWxlQ3ViZW1hcFNoYWRlcigpIHsKICAgIHRoaXMuX2N1YmVtYXBNYXRlcmlhbCA9PT0gbnVsbCAmJiAodGhpcy5fY3ViZW1hcE1hdGVyaWFsID0gSG0oKSwgdGhpcy5fY29tcGlsZU1hdGVyaWFsKHRoaXMuX2N1YmVtYXBNYXRlcmlhbCkpOwogIH0KICAvKioKICAgKiBQcmUtY29tcGlsZXMgdGhlIGVxdWlyZWN0YW5ndWxhciBzaGFkZXIuIFlvdSBjYW4gZ2V0IGZhc3RlciBzdGFydC11cCBieSBpbnZva2luZyB0aGlzIG1ldGhvZCBkdXJpbmcKICAgKiB5b3VyIHRleHR1cmUncyBuZXR3b3JrIGZldGNoIGZvciBpbmNyZWFzZWQgY29uY3VycmVuY3kuCiAgICovCiAgY29tcGlsZUVxdWlyZWN0YW5ndWxhclNoYWRlcigpIHsKICAgIHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgPT09IG51bGwgJiYgKHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgPSBWbSgpLCB0aGlzLl9jb21waWxlTWF0ZXJpYWwodGhpcy5fZXF1aXJlY3RNYXRlcmlhbCkpOwogIH0KICAvKioKICAgKiBEaXNwb3NlcyBvZiB0aGUgUE1SRU1HZW5lcmF0b3IncyBpbnRlcm5hbCBtZW1vcnkuIE5vdGUgdGhhdCBQTVJFTUdlbmVyYXRvciBpcyBhIHN0YXRpYyBjbGFzcywKICAgKiBzbyB5b3Ugc2hvdWxkIG5vdCBuZWVkIG1vcmUgdGhhbiBvbmUgUE1SRU1HZW5lcmF0b3Igb2JqZWN0LiBJZiB5b3UgZG8sIGNhbGxpbmcgZGlzcG9zZSgpIG9uCiAgICogb25lIG9mIHRoZW0gd2lsbCBjYXVzZSBhbnkgb3RoZXJzIHRvIGFsc28gYmVjb21lIHVudXNhYmxlLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLl9kaXNwb3NlKCksIHRoaXMuX2N1YmVtYXBNYXRlcmlhbCAhPT0gbnVsbCAmJiB0aGlzLl9jdWJlbWFwTWF0ZXJpYWwuZGlzcG9zZSgpLCB0aGlzLl9lcXVpcmVjdE1hdGVyaWFsICE9PSBudWxsICYmIHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KICAvLyBwcml2YXRlIGludGVyZmFjZQogIF9zZXRTaXplKHQpIHsKICAgIHRoaXMuX2xvZE1heCA9IE1hdGguZmxvb3IoTWF0aC5sb2cyKHQpKSwgdGhpcy5fY3ViZVNpemUgPSBNYXRoLnBvdygyLCB0aGlzLl9sb2RNYXgpOwogIH0KICBfZGlzcG9zZSgpIHsKICAgIHRoaXMuX2JsdXJNYXRlcmlhbCAhPT0gbnVsbCAmJiB0aGlzLl9ibHVyTWF0ZXJpYWwuZGlzcG9zZSgpLCB0aGlzLl9waW5nUG9uZ1JlbmRlclRhcmdldCAhPT0gbnVsbCAmJiB0aGlzLl9waW5nUG9uZ1JlbmRlclRhcmdldC5kaXNwb3NlKCk7CiAgICBmb3IgKGxldCB0ID0gMDsgdCA8IHRoaXMuX2xvZFBsYW5lcy5sZW5ndGg7IHQrKykKICAgICAgdGhpcy5fbG9kUGxhbmVzW3RdLmRpc3Bvc2UoKTsKICB9CiAgX2NsZWFudXAodCkgewogICAgdGhpcy5fcmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KGlkLCBuZCwgc2QpLCB0aGlzLl9yZW5kZXJlci54ci5lbmFibGVkID0gcmQsIHQuc2Npc3NvclRlc3QgPSAhMSwgTmwodCwgMCwgMCwgdC53aWR0aCwgdC5oZWlnaHQpOwogIH0KICBfZnJvbVRleHR1cmUodCwgZSkgewogICAgdC5tYXBwaW5nID09PSBpcyB8fCB0Lm1hcHBpbmcgPT09IFRzID8gdGhpcy5fc2V0U2l6ZSh0LmltYWdlLmxlbmd0aCA9PT0gMCA/IDE2IDogdC5pbWFnZVswXS53aWR0aCB8fCB0LmltYWdlWzBdLmltYWdlLndpZHRoKSA6IHRoaXMuX3NldFNpemUodC5pbWFnZS53aWR0aCAvIDQpLCBpZCA9IHRoaXMuX3JlbmRlcmVyLmdldFJlbmRlclRhcmdldCgpLCBuZCA9IHRoaXMuX3JlbmRlcmVyLmdldEFjdGl2ZUN1YmVGYWNlKCksIHNkID0gdGhpcy5fcmVuZGVyZXIuZ2V0QWN0aXZlTWlwbWFwTGV2ZWwoKSwgcmQgPSB0aGlzLl9yZW5kZXJlci54ci5lbmFibGVkLCB0aGlzLl9yZW5kZXJlci54ci5lbmFibGVkID0gITE7CiAgICBjb25zdCBpID0gZSB8fCB0aGlzLl9hbGxvY2F0ZVRhcmdldHMoKTsKICAgIHJldHVybiB0aGlzLl90ZXh0dXJlVG9DdWJlVVYodCwgaSksIHRoaXMuX2FwcGx5UE1SRU0oaSksIHRoaXMuX2NsZWFudXAoaSksIGk7CiAgfQogIF9hbGxvY2F0ZVRhcmdldHMoKSB7CiAgICBjb25zdCB0ID0gMyAqIE1hdGgubWF4KHRoaXMuX2N1YmVTaXplLCAxMTIpLCBlID0gNCAqIHRoaXMuX2N1YmVTaXplLCBpID0gewogICAgICBtYWdGaWx0ZXI6IENlLAogICAgICBtaW5GaWx0ZXI6IENlLAogICAgICBnZW5lcmF0ZU1pcG1hcHM6ICExLAogICAgICB0eXBlOiB3YSwKICAgICAgZm9ybWF0OiBnaSwKICAgICAgY29sb3JTcGFjZTogQ3MsCiAgICAgIGRlcHRoQnVmZmVyOiAhMQogICAgfSwgbiA9IGttKHQsIGUsIGkpOwogICAgaWYgKHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ID09PSBudWxsIHx8IHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0LndpZHRoICE9PSB0IHx8IHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0LmhlaWdodCAhPT0gZSkgewogICAgICB0aGlzLl9waW5nUG9uZ1JlbmRlclRhcmdldCAhPT0gbnVsbCAmJiB0aGlzLl9kaXNwb3NlKCksIHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ID0ga20odCwgZSwgaSk7CiAgICAgIGNvbnN0IHsgX2xvZE1heDogcyB9ID0gdGhpczsKICAgICAgKHsgc2l6ZUxvZHM6IHRoaXMuX3NpemVMb2RzLCBsb2RQbGFuZXM6IHRoaXMuX2xvZFBsYW5lcywgc2lnbWFzOiB0aGlzLl9zaWdtYXMgfSA9IEx3KHMpKSwgdGhpcy5fYmx1ck1hdGVyaWFsID0gRHcocywgdCwgZSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9CiAgX2NvbXBpbGVNYXRlcmlhbCh0KSB7CiAgICBjb25zdCBlID0gbmV3IHJlKHRoaXMuX2xvZFBsYW5lc1swXSwgdCk7CiAgICB0aGlzLl9yZW5kZXJlci5jb21waWxlKGUsIGVkKTsKICB9CiAgX3NjZW5lVG9DdWJlVVYodCwgZSwgaSwgbiwgcykgewogICAgY29uc3QgbCA9IG5ldyBWZSg5MCwgMSwgZSwgaSksIGggPSBbMSwgLTEsIDEsIDEsIDEsIDFdLCBjID0gWzEsIDEsIDEsIC0xLCAtMSwgLTFdLCB1ID0gdGhpcy5fcmVuZGVyZXIsIGQgPSB1LmF1dG9DbGVhciwgcCA9IHUudG9uZU1hcHBpbmc7CiAgICB1LmdldENsZWFyQ29sb3IoTm0pLCB1LnRvbmVNYXBwaW5nID0gWm4sIHUuYXV0b0NsZWFyID0gITEsIHUuc3RhdGUuYnVmZmVycy5kZXB0aC5nZXRSZXZlcnNlZCgpICYmICh1LnNldFJlbmRlclRhcmdldChuKSwgdS5jbGVhckRlcHRoKCksIHUuc2V0UmVuZGVyVGFyZ2V0KG51bGwpKTsKICAgIGNvbnN0IHkgPSBuZXcgbGkoewogICAgICBuYW1lOiAiUE1SRU0uQmFja2dyb3VuZCIsCiAgICAgIHNpZGU6IEhlLAogICAgICBkZXB0aFdyaXRlOiAhMSwKICAgICAgZGVwdGhUZXN0OiAhMQogICAgfSksIGcgPSBuZXcgcmUobmV3IG1yKCksIHkpOwogICAgbGV0IG0gPSAhMTsKICAgIGNvbnN0IHYgPSB0LmJhY2tncm91bmQ7CiAgICB2ID8gdi5pc0NvbG9yICYmICh5LmNvbG9yLmNvcHkodiksIHQuYmFja2dyb3VuZCA9IG51bGwsIG0gPSAhMCkgOiAoeS5jb2xvci5jb3B5KE5tKSwgbSA9ICEwKTsKICAgIGZvciAobGV0IHggPSAwOyB4IDwgNjsgeCsrKSB7CiAgICAgIGNvbnN0IF8gPSB4ICUgMzsKICAgICAgXyA9PT0gMCA/IChsLnVwLnNldCgwLCBoW3hdLCAwKSwgbC5wb3NpdGlvbi5zZXQocy54LCBzLnksIHMueiksIGwubG9va0F0KHMueCArIGNbeF0sIHMueSwgcy56KSkgOiBfID09PSAxID8gKGwudXAuc2V0KDAsIDAsIGhbeF0pLCBsLnBvc2l0aW9uLnNldChzLngsIHMueSwgcy56KSwgbC5sb29rQXQocy54LCBzLnkgKyBjW3hdLCBzLnopKSA6IChsLnVwLnNldCgwLCBoW3hdLCAwKSwgbC5wb3NpdGlvbi5zZXQocy54LCBzLnksIHMueiksIGwubG9va0F0KHMueCwgcy55LCBzLnogKyBjW3hdKSk7CiAgICAgIGNvbnN0IFMgPSB0aGlzLl9jdWJlU2l6ZTsKICAgICAgTmwobiwgXyAqIFMsIHggPiAyID8gUyA6IDAsIFMsIFMpLCB1LnNldFJlbmRlclRhcmdldChuKSwgbSAmJiB1LnJlbmRlcihnLCBsKSwgdS5yZW5kZXIodCwgbCk7CiAgICB9CiAgICBnLmdlb21ldHJ5LmRpc3Bvc2UoKSwgZy5tYXRlcmlhbC5kaXNwb3NlKCksIHUudG9uZU1hcHBpbmcgPSBwLCB1LmF1dG9DbGVhciA9IGQsIHQuYmFja2dyb3VuZCA9IHY7CiAgfQogIF90ZXh0dXJlVG9DdWJlVVYodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuX3JlbmRlcmVyLCBuID0gdC5tYXBwaW5nID09PSBpcyB8fCB0Lm1hcHBpbmcgPT09IFRzOwogICAgbiA/ICh0aGlzLl9jdWJlbWFwTWF0ZXJpYWwgPT09IG51bGwgJiYgKHRoaXMuX2N1YmVtYXBNYXRlcmlhbCA9IEhtKCkpLCB0aGlzLl9jdWJlbWFwTWF0ZXJpYWwudW5pZm9ybXMuZmxpcEVudk1hcC52YWx1ZSA9IHQuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID09PSAhMSA/IC0xIDogMSkgOiB0aGlzLl9lcXVpcmVjdE1hdGVyaWFsID09PSBudWxsICYmICh0aGlzLl9lcXVpcmVjdE1hdGVyaWFsID0gVm0oKSk7CiAgICBjb25zdCBzID0gbiA/IHRoaXMuX2N1YmVtYXBNYXRlcmlhbCA6IHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwsIHIgPSBuZXcgcmUodGhpcy5fbG9kUGxhbmVzWzBdLCBzKSwgbyA9IHMudW5pZm9ybXM7CiAgICBvLmVudk1hcC52YWx1ZSA9IHQ7CiAgICBjb25zdCBsID0gdGhpcy5fY3ViZVNpemU7CiAgICBObChlLCAwLCAwLCAzICogbCwgMiAqIGwpLCBpLnNldFJlbmRlclRhcmdldChlKSwgaS5yZW5kZXIociwgZWQpOwogIH0KICBfYXBwbHlQTVJFTSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5fcmVuZGVyZXIsIGkgPSBlLmF1dG9DbGVhcjsKICAgIGUuYXV0b0NsZWFyID0gITE7CiAgICBjb25zdCBuID0gdGhpcy5fbG9kUGxhbmVzLmxlbmd0aDsKICAgIGZvciAobGV0IHMgPSAxOyBzIDwgbjsgcysrKSB7CiAgICAgIGNvbnN0IHIgPSBNYXRoLnNxcnQodGhpcy5fc2lnbWFzW3NdICogdGhpcy5fc2lnbWFzW3NdIC0gdGhpcy5fc2lnbWFzW3MgLSAxXSAqIHRoaXMuX3NpZ21hc1tzIC0gMV0pLCBvID0gT21bKG4gLSBzIC0gMSkgJSBPbS5sZW5ndGhdOwogICAgICB0aGlzLl9ibHVyKHQsIHMgLSAxLCBzLCByLCBvKTsKICAgIH0KICAgIGUuYXV0b0NsZWFyID0gaTsKICB9CiAgLyoqCiAgICogVGhpcyBpcyBhIHR3by1wYXNzIEdhdXNzaWFuIGJsdXIgZm9yIGEgY3ViZW1hcC4gTm9ybWFsbHkgdGhpcyBpcyBkb25lCiAgICogdmVydGljYWxseSBhbmQgaG9yaXpvbnRhbGx5LCBidXQgdGhpcyBicmVha3MgZG93biBvbiBhIGN1YmUuIEhlcmUgd2UgYXBwbHkKICAgKiB0aGUgYmx1ciBsYXRpdHVkaW5hbGx5IChhcm91bmQgdGhlIHBvbGVzKSwgYW5kIHRoZW4gbG9uZ2l0dWRpbmFsbHkgKHRvd2FyZHMKICAgKiB0aGUgcG9sZXMpIHRvIGFwcHJveGltYXRlIHRoZSBvcnRob2dvbmFsbHktc2VwYXJhYmxlIGJsdXIuIEl0IGlzIGxlYXN0CiAgICogYWNjdXJhdGUgYXQgdGhlIHBvbGVzLCBidXQgc3RpbGwgZG9lcyBhIGRlY2VudCBqb2IuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7V2ViR0xSZW5kZXJUYXJnZXR9IGN1YmVVVlJlbmRlclRhcmdldAogICAqIEBwYXJhbSB7bnVtYmVyfSBsb2RJbgogICAqIEBwYXJhbSB7bnVtYmVyfSBsb2RPdXQKICAgKiBAcGFyYW0ge251bWJlcn0gc2lnbWEKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IFtwb2xlQXhpc10KICAgKi8KICBfYmx1cih0LCBlLCBpLCBuLCBzKSB7CiAgICBjb25zdCByID0gdGhpcy5fcGluZ1BvbmdSZW5kZXJUYXJnZXQ7CiAgICB0aGlzLl9oYWxmQmx1cigKICAgICAgdCwKICAgICAgciwKICAgICAgZSwKICAgICAgaSwKICAgICAgbiwKICAgICAgImxhdGl0dWRpbmFsIiwKICAgICAgcwogICAgKSwgdGhpcy5faGFsZkJsdXIoCiAgICAgIHIsCiAgICAgIHQsCiAgICAgIGksCiAgICAgIGksCiAgICAgIG4sCiAgICAgICJsb25naXR1ZGluYWwiLAogICAgICBzCiAgICApOwogIH0KICBfaGFsZkJsdXIodCwgZSwgaSwgbiwgcywgciwgbykgewogICAgY29uc3QgbCA9IHRoaXMuX3JlbmRlcmVyLCBoID0gdGhpcy5fYmx1ck1hdGVyaWFsOwogICAgciAhPT0gImxhdGl0dWRpbmFsIiAmJiByICE9PSAibG9uZ2l0dWRpbmFsIiAmJiBjb25zb2xlLmVycm9yKAogICAgICAiYmx1ciBkaXJlY3Rpb24gbXVzdCBiZSBlaXRoZXIgbGF0aXR1ZGluYWwgb3IgbG9uZ2l0dWRpbmFsISIKICAgICk7CiAgICBjb25zdCBjID0gMywgdSA9IG5ldyByZSh0aGlzLl9sb2RQbGFuZXNbbl0sIGgpLCBkID0gaC51bmlmb3JtcywgcCA9IHRoaXMuX3NpemVMb2RzW2ldIC0gMSwgZiA9IGlzRmluaXRlKHMpID8gTWF0aC5QSSAvICgyICogcCkgOiAyICogTWF0aC5QSSAvICgyICogbnIgLSAxKSwgeSA9IHMgLyBmLCBnID0gaXNGaW5pdGUocykgPyAxICsgTWF0aC5mbG9vcihjICogeSkgOiBucjsKICAgIGcgPiBuciAmJiBjb25zb2xlLndhcm4oYHNpZ21hUmFkaWFucywgJHtzfSwgaXMgdG9vIGxhcmdlIGFuZCB3aWxsIGNsaXAsIGFzIGl0IHJlcXVlc3RlZCAke2d9IHNhbXBsZXMgd2hlbiB0aGUgbWF4aW11bSBpcyBzZXQgdG8gJHtucn1gKTsKICAgIGNvbnN0IG0gPSBbXTsKICAgIGxldCB2ID0gMDsKICAgIGZvciAobGV0IFQgPSAwOyBUIDwgbnI7ICsrVCkgewogICAgICBjb25zdCBSID0gVCAvIHksIGIgPSBNYXRoLmV4cCgtUiAqIFIgLyAyKTsKICAgICAgbS5wdXNoKGIpLCBUID09PSAwID8gdiArPSBiIDogVCA8IGcgJiYgKHYgKz0gMiAqIGIpOwogICAgfQogICAgZm9yIChsZXQgVCA9IDA7IFQgPCBtLmxlbmd0aDsgVCsrKQogICAgICBtW1RdID0gbVtUXSAvIHY7CiAgICBkLmVudk1hcC52YWx1ZSA9IHQudGV4dHVyZSwgZC5zYW1wbGVzLnZhbHVlID0gZywgZC53ZWlnaHRzLnZhbHVlID0gbSwgZC5sYXRpdHVkaW5hbC52YWx1ZSA9IHIgPT09ICJsYXRpdHVkaW5hbCIsIG8gJiYgKGQucG9sZUF4aXMudmFsdWUgPSBvKTsKICAgIGNvbnN0IHsgX2xvZE1heDogeCB9ID0gdGhpczsKICAgIGQuZFRoZXRhLnZhbHVlID0gZiwgZC5taXBJbnQudmFsdWUgPSB4IC0gaTsKICAgIGNvbnN0IF8gPSB0aGlzLl9zaXplTG9kc1tuXSwgUyA9IDMgKiBfICogKG4gPiB4IC0gYWEgPyBuIC0geCArIGFhIDogMCksIHcgPSA0ICogKHRoaXMuX2N1YmVTaXplIC0gXyk7CiAgICBObChlLCBTLCB3LCAzICogXywgMiAqIF8pLCBsLnNldFJlbmRlclRhcmdldChlKSwgbC5yZW5kZXIodSwgZWQpOwogIH0KfQpmdW5jdGlvbiBMdyhhKSB7CiAgY29uc3QgdCA9IFtdLCBlID0gW10sIGkgPSBbXTsKICBsZXQgbiA9IGE7CiAgY29uc3QgcyA9IGEgLSBhYSArIDEgKyB6bS5sZW5ndGg7CiAgZm9yIChsZXQgciA9IDA7IHIgPCBzOyByKyspIHsKICAgIGNvbnN0IG8gPSBNYXRoLnBvdygyLCBuKTsKICAgIGUucHVzaChvKTsKICAgIGxldCBsID0gMSAvIG87CiAgICByID4gYSAtIGFhID8gbCA9IHptW3IgLSBhICsgYWEgLSAxXSA6IHIgPT09IDAgJiYgKGwgPSAwKSwgaS5wdXNoKGwpOwogICAgY29uc3QgaCA9IDEgLyAobyAtIDIpLCBjID0gLWgsIHUgPSAxICsgaCwgZCA9IFtjLCBjLCB1LCBjLCB1LCB1LCBjLCBjLCB1LCB1LCBjLCB1XSwgcCA9IDYsIGYgPSA2LCB5ID0gMywgZyA9IDIsIG0gPSAxLCB2ID0gbmV3IEZsb2F0MzJBcnJheSh5ICogZiAqIHApLCB4ID0gbmV3IEZsb2F0MzJBcnJheShnICogZiAqIHApLCBfID0gbmV3IEZsb2F0MzJBcnJheShtICogZiAqIHApOwogICAgZm9yIChsZXQgdyA9IDA7IHcgPCBwOyB3KyspIHsKICAgICAgY29uc3QgVCA9IHcgJSAzICogMiAvIDMgLSAxLCBSID0gdyA+IDIgPyAwIDogLTEsIGIgPSBbCiAgICAgICAgVCwKICAgICAgICBSLAogICAgICAgIDAsCiAgICAgICAgVCArIDIgLyAzLAogICAgICAgIFIsCiAgICAgICAgMCwKICAgICAgICBUICsgMiAvIDMsCiAgICAgICAgUiArIDEsCiAgICAgICAgMCwKICAgICAgICBULAogICAgICAgIFIsCiAgICAgICAgMCwKICAgICAgICBUICsgMiAvIDMsCiAgICAgICAgUiArIDEsCiAgICAgICAgMCwKICAgICAgICBULAogICAgICAgIFIgKyAxLAogICAgICAgIDAKICAgICAgXTsKICAgICAgdi5zZXQoYiwgeSAqIGYgKiB3KSwgeC5zZXQoZCwgZyAqIGYgKiB3KTsKICAgICAgY29uc3QgTSA9IFt3LCB3LCB3LCB3LCB3LCB3XTsKICAgICAgXy5zZXQoTSwgbSAqIGYgKiB3KTsKICAgIH0KICAgIGNvbnN0IFMgPSBuZXcgSHQoKTsKICAgIFMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyBpZSh2LCB5KSksIFMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyBpZSh4LCBnKSksIFMuc2V0QXR0cmlidXRlKCJmYWNlSW5kZXgiLCBuZXcgaWUoXywgbSkpLCB0LnB1c2goUyksIG4gPiBhYSAmJiBuLS07CiAgfQogIHJldHVybiB7IGxvZFBsYW5lczogdCwgc2l6ZUxvZHM6IGUsIHNpZ21hczogaSB9Owp9CmZ1bmN0aW9uIGttKGEsIHQsIGUpIHsKICBjb25zdCBpID0gbmV3IFJuKGEsIHQsIGUpOwogIHJldHVybiBpLnRleHR1cmUubWFwcGluZyA9IFNhLCBpLnRleHR1cmUubmFtZSA9ICJQTVJFTS5jdWJlVXYiLCBpLnNjaXNzb3JUZXN0ID0gITAsIGk7Cn0KZnVuY3Rpb24gTmwoYSwgdCwgZSwgaSwgbikgewogIGEudmlld3BvcnQuc2V0KHQsIGUsIGksIG4pLCBhLnNjaXNzb3Iuc2V0KHQsIGUsIGksIG4pOwp9CmZ1bmN0aW9uIER3KGEsIHQsIGUpIHsKICBjb25zdCBpID0gbmV3IEZsb2F0MzJBcnJheShuciksIG4gPSBuZXcgRSgwLCAxLCAwKTsKICByZXR1cm4gbmV3IFhpKHsKICAgIG5hbWU6ICJTcGhlcmljYWxHYXVzc2lhbkJsdXIiLAogICAgZGVmaW5lczogewogICAgICBuOiBuciwKICAgICAgQ1VCRVVWX1RFWEVMX1dJRFRIOiAxIC8gdCwKICAgICAgQ1VCRVVWX1RFWEVMX0hFSUdIVDogMSAvIGUsCiAgICAgIENVQkVVVl9NQVhfTUlQOiBgJHthfS4wYAogICAgfSwKICAgIHVuaWZvcm1zOiB7CiAgICAgIGVudk1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBzYW1wbGVzOiB7IHZhbHVlOiAxIH0sCiAgICAgIHdlaWdodHM6IHsgdmFsdWU6IGkgfSwKICAgICAgbGF0aXR1ZGluYWw6IHsgdmFsdWU6ICExIH0sCiAgICAgIGRUaGV0YTogeyB2YWx1ZTogMCB9LAogICAgICBtaXBJbnQ6IHsgdmFsdWU6IDAgfSwKICAgICAgcG9sZUF4aXM6IHsgdmFsdWU6IG4gfQogICAgfSwKICAgIHZlcnRleFNoYWRlcjogcGYoKSwKICAgIGZyYWdtZW50U2hhZGVyOiAoCiAgICAgIC8qIGdsc2wgKi8KICAgICAgYAoKCQkJcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CgkJCXByZWNpc2lvbiBtZWRpdW1wIGludDsKCgkJCXZhcnlpbmcgdmVjMyB2T3V0cHV0RGlyZWN0aW9uOwoKCQkJdW5pZm9ybSBzYW1wbGVyMkQgZW52TWFwOwoJCQl1bmlmb3JtIGludCBzYW1wbGVzOwoJCQl1bmlmb3JtIGZsb2F0IHdlaWdodHNbIG4gXTsKCQkJdW5pZm9ybSBib29sIGxhdGl0dWRpbmFsOwoJCQl1bmlmb3JtIGZsb2F0IGRUaGV0YTsKCQkJdW5pZm9ybSBmbG9hdCBtaXBJbnQ7CgkJCXVuaWZvcm0gdmVjMyBwb2xlQXhpczsKCgkJCSNkZWZpbmUgRU5WTUFQX1RZUEVfQ1VCRV9VVgoJCQkjaW5jbHVkZSA8Y3ViZV91dl9yZWZsZWN0aW9uX2ZyYWdtZW50PgoKCQkJdmVjMyBnZXRTYW1wbGUoIGZsb2F0IHRoZXRhLCB2ZWMzIGF4aXMgKSB7CgoJCQkJZmxvYXQgY29zVGhldGEgPSBjb3MoIHRoZXRhICk7CgkJCQkvLyBSb2RyaWd1ZXMnIGF4aXMtYW5nbGUgcm90YXRpb24KCQkJCXZlYzMgc2FtcGxlRGlyZWN0aW9uID0gdk91dHB1dERpcmVjdGlvbiAqIGNvc1RoZXRhCgkJCQkJKyBjcm9zcyggYXhpcywgdk91dHB1dERpcmVjdGlvbiApICogc2luKCB0aGV0YSApCgkJCQkJKyBheGlzICogZG90KCBheGlzLCB2T3V0cHV0RGlyZWN0aW9uICkgKiAoIDEuMCAtIGNvc1RoZXRhICk7CgoJCQkJcmV0dXJuIGJpbGluZWFyQ3ViZVVWKCBlbnZNYXAsIHNhbXBsZURpcmVjdGlvbiwgbWlwSW50ICk7CgoJCQl9CgoJCQl2b2lkIG1haW4oKSB7CgoJCQkJdmVjMyBheGlzID0gbGF0aXR1ZGluYWwgPyBwb2xlQXhpcyA6IGNyb3NzKCBwb2xlQXhpcywgdk91dHB1dERpcmVjdGlvbiApOwoKCQkJCWlmICggYWxsKCBlcXVhbCggYXhpcywgdmVjMyggMC4wICkgKSApICkgewoKCQkJCQlheGlzID0gdmVjMyggdk91dHB1dERpcmVjdGlvbi56LCAwLjAsIC0gdk91dHB1dERpcmVjdGlvbi54ICk7CgoJCQkJfQoKCQkJCWF4aXMgPSBub3JtYWxpemUoIGF4aXMgKTsKCgkJCQlnbF9GcmFnQ29sb3IgPSB2ZWM0KCAwLjAsIDAuMCwgMC4wLCAxLjAgKTsKCQkJCWdsX0ZyYWdDb2xvci5yZ2IgKz0gd2VpZ2h0c1sgMCBdICogZ2V0U2FtcGxlKCAwLjAsIGF4aXMgKTsKCgkJCQlmb3IgKCBpbnQgaSA9IDE7IGkgPCBuOyBpKysgKSB7CgoJCQkJCWlmICggaSA+PSBzYW1wbGVzICkgewoKCQkJCQkJYnJlYWs7CgoJCQkJCX0KCgkJCQkJZmxvYXQgdGhldGEgPSBkVGhldGEgKiBmbG9hdCggaSApOwoJCQkJCWdsX0ZyYWdDb2xvci5yZ2IgKz0gd2VpZ2h0c1sgaSBdICogZ2V0U2FtcGxlKCAtMS4wICogdGhldGEsIGF4aXMgKTsKCQkJCQlnbF9GcmFnQ29sb3IucmdiICs9IHdlaWdodHNbIGkgXSAqIGdldFNhbXBsZSggdGhldGEsIGF4aXMgKTsKCgkJCQl9CgoJCQl9CgkJYAogICAgKSwKICAgIGJsZW5kaW5nOiBZbiwKICAgIGRlcHRoVGVzdDogITEsCiAgICBkZXB0aFdyaXRlOiAhMQogIH0pOwp9CmZ1bmN0aW9uIFZtKCkgewogIHJldHVybiBuZXcgWGkoewogICAgbmFtZTogIkVxdWlyZWN0YW5ndWxhclRvQ3ViZVVWIiwKICAgIHVuaWZvcm1zOiB7CiAgICAgIGVudk1hcDogeyB2YWx1ZTogbnVsbCB9CiAgICB9LAogICAgdmVydGV4U2hhZGVyOiBwZigpLAogICAgZnJhZ21lbnRTaGFkZXI6ICgKICAgICAgLyogZ2xzbCAqLwogICAgICBgCgoJCQlwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsKCQkJcHJlY2lzaW9uIG1lZGl1bXAgaW50OwoKCQkJdmFyeWluZyB2ZWMzIHZPdXRwdXREaXJlY3Rpb247CgoJCQl1bmlmb3JtIHNhbXBsZXIyRCBlbnZNYXA7CgoJCQkjaW5jbHVkZSA8Y29tbW9uPgoKCQkJdm9pZCBtYWluKCkgewoKCQkJCXZlYzMgb3V0cHV0RGlyZWN0aW9uID0gbm9ybWFsaXplKCB2T3V0cHV0RGlyZWN0aW9uICk7CgkJCQl2ZWMyIHV2ID0gZXF1aXJlY3RVdiggb3V0cHV0RGlyZWN0aW9uICk7CgoJCQkJZ2xfRnJhZ0NvbG9yID0gdmVjNCggdGV4dHVyZTJEICggZW52TWFwLCB1diApLnJnYiwgMS4wICk7CgoJCQl9CgkJYAogICAgKSwKICAgIGJsZW5kaW5nOiBZbiwKICAgIGRlcHRoVGVzdDogITEsCiAgICBkZXB0aFdyaXRlOiAhMQogIH0pOwp9CmZ1bmN0aW9uIEhtKCkgewogIHJldHVybiBuZXcgWGkoewogICAgbmFtZTogIkN1YmVtYXBUb0N1YmVVViIsCiAgICB1bmlmb3JtczogewogICAgICBlbnZNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgZmxpcEVudk1hcDogeyB2YWx1ZTogLTEgfQogICAgfSwKICAgIHZlcnRleFNoYWRlcjogcGYoKSwKICAgIGZyYWdtZW50U2hhZGVyOiAoCiAgICAgIC8qIGdsc2wgKi8KICAgICAgYAoKCQkJcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CgkJCXByZWNpc2lvbiBtZWRpdW1wIGludDsKCgkJCXVuaWZvcm0gZmxvYXQgZmxpcEVudk1hcDsKCgkJCXZhcnlpbmcgdmVjMyB2T3V0cHV0RGlyZWN0aW9uOwoKCQkJdW5pZm9ybSBzYW1wbGVyQ3ViZSBlbnZNYXA7CgoJCQl2b2lkIG1haW4oKSB7CgoJCQkJZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZUN1YmUoIGVudk1hcCwgdmVjMyggZmxpcEVudk1hcCAqIHZPdXRwdXREaXJlY3Rpb24ueCwgdk91dHB1dERpcmVjdGlvbi55eiApICk7CgoJCQl9CgkJYAogICAgKSwKICAgIGJsZW5kaW5nOiBZbiwKICAgIGRlcHRoVGVzdDogITEsCiAgICBkZXB0aFdyaXRlOiAhMQogIH0pOwp9CmZ1bmN0aW9uIHBmKCkgewogIHJldHVybiAoCiAgICAvKiBnbHNsICovCiAgICBgCgoJCXByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OwoJCXByZWNpc2lvbiBtZWRpdW1wIGludDsKCgkJYXR0cmlidXRlIGZsb2F0IGZhY2VJbmRleDsKCgkJdmFyeWluZyB2ZWMzIHZPdXRwdXREaXJlY3Rpb247CgoJCS8vIFJIIGNvb3JkaW5hdGUgc3lzdGVtOyBQTVJFTSBmYWNlLWluZGV4aW5nIGNvbnZlbnRpb24KCQl2ZWMzIGdldERpcmVjdGlvbiggdmVjMiB1diwgZmxvYXQgZmFjZSApIHsKCgkJCXV2ID0gMi4wICogdXYgLSAxLjA7CgoJCQl2ZWMzIGRpcmVjdGlvbiA9IHZlYzMoIHV2LCAxLjAgKTsKCgkJCWlmICggZmFjZSA9PSAwLjAgKSB7CgoJCQkJZGlyZWN0aW9uID0gZGlyZWN0aW9uLnp5eDsgLy8gKCAxLCB2LCB1ICkgcG9zIHgKCgkJCX0gZWxzZSBpZiAoIGZhY2UgPT0gMS4wICkgewoKCQkJCWRpcmVjdGlvbiA9IGRpcmVjdGlvbi54enk7CgkJCQlkaXJlY3Rpb24ueHogKj0gLTEuMDsgLy8gKCAtdSwgMSwgLXYgKSBwb3MgeQoKCQkJfSBlbHNlIGlmICggZmFjZSA9PSAyLjAgKSB7CgoJCQkJZGlyZWN0aW9uLnggKj0gLTEuMDsgLy8gKCAtdSwgdiwgMSApIHBvcyB6CgoJCQl9IGVsc2UgaWYgKCBmYWNlID09IDMuMCApIHsKCgkJCQlkaXJlY3Rpb24gPSBkaXJlY3Rpb24uenl4OwoJCQkJZGlyZWN0aW9uLnh6ICo9IC0xLjA7IC8vICggLTEsIHYsIC11ICkgbmVnIHgKCgkJCX0gZWxzZSBpZiAoIGZhY2UgPT0gNC4wICkgewoKCQkJCWRpcmVjdGlvbiA9IGRpcmVjdGlvbi54enk7CgkJCQlkaXJlY3Rpb24ueHkgKj0gLTEuMDsgLy8gKCAtdSwgLTEsIHYgKSBuZWcgeQoKCQkJfSBlbHNlIGlmICggZmFjZSA9PSA1LjAgKSB7CgoJCQkJZGlyZWN0aW9uLnogKj0gLTEuMDsgLy8gKCB1LCB2LCAtMSApIG5lZyB6CgoJCQl9CgoJCQlyZXR1cm4gZGlyZWN0aW9uOwoKCQl9CgoJCXZvaWQgbWFpbigpIHsKCgkJCXZPdXRwdXREaXJlY3Rpb24gPSBnZXREaXJlY3Rpb24oIHV2LCBmYWNlSW5kZXggKTsKCQkJZ2xfUG9zaXRpb24gPSB2ZWM0KCBwb3NpdGlvbiwgMS4wICk7CgoJCX0KCWAKICApOwp9CmZ1bmN0aW9uIEZ3KGEpIHsKICBsZXQgdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpLCBlID0gbnVsbDsKICBmdW5jdGlvbiBpKG8pIHsKICAgIGlmIChvICYmIG8uaXNUZXh0dXJlKSB7CiAgICAgIGNvbnN0IGwgPSBvLm1hcHBpbmcsIGggPSBsID09PSB2byB8fCBsID09PSBibywgYyA9IGwgPT09IGlzIHx8IGwgPT09IFRzOwogICAgICBpZiAoaCB8fCBjKSB7CiAgICAgICAgbGV0IHUgPSB0LmdldChvKTsKICAgICAgICBjb25zdCBkID0gdSAhPT0gdm9pZCAwID8gdS50ZXh0dXJlLnBtcmVtVmVyc2lvbiA6IDA7CiAgICAgICAgaWYgKG8uaXNSZW5kZXJUYXJnZXRUZXh0dXJlICYmIG8ucG1yZW1WZXJzaW9uICE9PSBkKQogICAgICAgICAgcmV0dXJuIGUgPT09IG51bGwgJiYgKGUgPSBuZXcgaHAoYSkpLCB1ID0gaCA/IGUuZnJvbUVxdWlyZWN0YW5ndWxhcihvLCB1KSA6IGUuZnJvbUN1YmVtYXAobywgdSksIHUudGV4dHVyZS5wbXJlbVZlcnNpb24gPSBvLnBtcmVtVmVyc2lvbiwgdC5zZXQobywgdSksIHUudGV4dHVyZTsKICAgICAgICBpZiAodSAhPT0gdm9pZCAwKQogICAgICAgICAgcmV0dXJuIHUudGV4dHVyZTsKICAgICAgICB7CiAgICAgICAgICBjb25zdCBwID0gby5pbWFnZTsKICAgICAgICAgIHJldHVybiBoICYmIHAgJiYgcC5oZWlnaHQgPiAwIHx8IGMgJiYgcCAmJiBuKHApID8gKGUgPT09IG51bGwgJiYgKGUgPSBuZXcgaHAoYSkpLCB1ID0gaCA/IGUuZnJvbUVxdWlyZWN0YW5ndWxhcihvKSA6IGUuZnJvbUN1YmVtYXAobyksIHUudGV4dHVyZS5wbXJlbVZlcnNpb24gPSBvLnBtcmVtVmVyc2lvbiwgdC5zZXQobywgdSksIG8uYWRkRXZlbnRMaXN0ZW5lcigiZGlzcG9zZSIsIHMpLCB1LnRleHR1cmUpIDogbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvOwogIH0KICBmdW5jdGlvbiBuKG8pIHsKICAgIGxldCBsID0gMDsKICAgIGNvbnN0IGggPSA2OwogICAgZm9yIChsZXQgYyA9IDA7IGMgPCBoOyBjKyspCiAgICAgIG9bY10gIT09IHZvaWQgMCAmJiBsKys7CiAgICByZXR1cm4gbCA9PT0gaDsKICB9CiAgZnVuY3Rpb24gcyhvKSB7CiAgICBjb25zdCBsID0gby50YXJnZXQ7CiAgICBsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImRpc3Bvc2UiLCBzKTsKICAgIGNvbnN0IGggPSB0LmdldChsKTsKICAgIGggIT09IHZvaWQgMCAmJiAodC5kZWxldGUobCksIGguZGlzcG9zZSgpKTsKICB9CiAgZnVuY3Rpb24gcigpIHsKICAgIHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwgZSAhPT0gbnVsbCAmJiAoZS5kaXNwb3NlKCksIGUgPSBudWxsKTsKICB9CiAgcmV0dXJuIHsKICAgIGdldDogaSwKICAgIGRpc3Bvc2U6IHIKICB9Owp9CmZ1bmN0aW9uIFV3KGEpIHsKICBjb25zdCB0ID0ge307CiAgZnVuY3Rpb24gZShpKSB7CiAgICBpZiAodFtpXSAhPT0gdm9pZCAwKQogICAgICByZXR1cm4gdFtpXTsKICAgIGxldCBuOwogICAgc3dpdGNoIChpKSB7CiAgICAgIGNhc2UgIldFQkdMX2RlcHRoX3RleHR1cmUiOgogICAgICAgIG4gPSBhLmdldEV4dGVuc2lvbigiV0VCR0xfZGVwdGhfdGV4dHVyZSIpIHx8IGEuZ2V0RXh0ZW5zaW9uKCJNT1pfV0VCR0xfZGVwdGhfdGV4dHVyZSIpIHx8IGEuZ2V0RXh0ZW5zaW9uKCJXRUJLSVRfV0VCR0xfZGVwdGhfdGV4dHVyZSIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJFWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiOgogICAgICAgIG4gPSBhLmdldEV4dGVuc2lvbigiRVhUX3RleHR1cmVfZmlsdGVyX2FuaXNvdHJvcGljIikgfHwgYS5nZXRFeHRlbnNpb24oIk1PWl9FWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiKSB8fCBhLmdldEV4dGVuc2lvbigiV0VCS0lUX0VYVF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYyIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YyI6CiAgICAgICAgbiA9IGEuZ2V0RXh0ZW5zaW9uKCJXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YyIpIHx8IGEuZ2V0RXh0ZW5zaW9uKCJNT1pfV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX3MzdGMiKSB8fCBhLmdldEV4dGVuc2lvbigiV0VCS0lUX1dFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9zM3RjIik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIldFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0YyI6CiAgICAgICAgbiA9IGEuZ2V0RXh0ZW5zaW9uKCJXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfcHZydGMiKSB8fCBhLmdldEV4dGVuc2lvbigiV0VCS0lUX1dFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0YyIpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIG4gPSBhLmdldEV4dGVuc2lvbihpKTsKICAgIH0KICAgIHJldHVybiB0W2ldID0gbiwgbjsKICB9CiAgcmV0dXJuIHsKICAgIGhhczogZnVuY3Rpb24oaSkgewogICAgICByZXR1cm4gZShpKSAhPT0gbnVsbDsKICAgIH0sCiAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgZSgiRVhUX2NvbG9yX2J1ZmZlcl9mbG9hdCIpLCBlKCJXRUJHTF9jbGlwX2N1bGxfZGlzdGFuY2UiKSwgZSgiT0VTX3RleHR1cmVfZmxvYXRfbGluZWFyIiksIGUoIkVYVF9jb2xvcl9idWZmZXJfaGFsZl9mbG9hdCIpLCBlKCJXRUJHTF9tdWx0aXNhbXBsZWRfcmVuZGVyX3RvX3RleHR1cmUiKSwgZSgiV0VCR0xfcmVuZGVyX3NoYXJlZF9leHBvbmVudCIpOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24oaSkgewogICAgICBjb25zdCBuID0gZShpKTsKICAgICAgcmV0dXJuIG4gPT09IG51bGwgJiYgUG8oIlRIUkVFLldlYkdMUmVuZGVyZXI6ICIgKyBpICsgIiBleHRlbnNpb24gbm90IHN1cHBvcnRlZC4iKSwgbjsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIEJ3KGEsIHQsIGUsIGkpIHsKICBjb25zdCBuID0ge30sIHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBmdW5jdGlvbiByKHUpIHsKICAgIGNvbnN0IGQgPSB1LnRhcmdldDsKICAgIGQuaW5kZXggIT09IG51bGwgJiYgdC5yZW1vdmUoZC5pbmRleCk7CiAgICBmb3IgKGNvbnN0IGYgaW4gZC5hdHRyaWJ1dGVzKQogICAgICB0LnJlbW92ZShkLmF0dHJpYnV0ZXNbZl0pOwogICAgZC5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgciksIGRlbGV0ZSBuW2QuaWRdOwogICAgY29uc3QgcCA9IHMuZ2V0KGQpOwogICAgcCAmJiAodC5yZW1vdmUocCksIHMuZGVsZXRlKGQpKSwgaS5yZWxlYXNlU3RhdGVzT2ZHZW9tZXRyeShkKSwgZC5pc0luc3RhbmNlZEJ1ZmZlckdlb21ldHJ5ID09PSAhMCAmJiBkZWxldGUgZC5fbWF4SW5zdGFuY2VDb3VudCwgZS5tZW1vcnkuZ2VvbWV0cmllcy0tOwogIH0KICBmdW5jdGlvbiBvKHUsIGQpIHsKICAgIHJldHVybiBuW2QuaWRdID09PSAhMCB8fCAoZC5hZGRFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgciksIG5bZC5pZF0gPSAhMCwgZS5tZW1vcnkuZ2VvbWV0cmllcysrKSwgZDsKICB9CiAgZnVuY3Rpb24gbCh1KSB7CiAgICBjb25zdCBkID0gdS5hdHRyaWJ1dGVzOwogICAgZm9yIChjb25zdCBwIGluIGQpCiAgICAgIHQudXBkYXRlKGRbcF0sIGEuQVJSQVlfQlVGRkVSKTsKICB9CiAgZnVuY3Rpb24gaCh1KSB7CiAgICBjb25zdCBkID0gW10sIHAgPSB1LmluZGV4LCBmID0gdS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgbGV0IHkgPSAwOwogICAgaWYgKHAgIT09IG51bGwpIHsKICAgICAgY29uc3QgdiA9IHAuYXJyYXk7CiAgICAgIHkgPSBwLnZlcnNpb247CiAgICAgIGZvciAobGV0IHggPSAwLCBfID0gdi5sZW5ndGg7IHggPCBfOyB4ICs9IDMpIHsKICAgICAgICBjb25zdCBTID0gdlt4ICsgMF0sIHcgPSB2W3ggKyAxXSwgVCA9IHZbeCArIDJdOwogICAgICAgIGQucHVzaChTLCB3LCB3LCBULCBULCBTKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChmICE9PSB2b2lkIDApIHsKICAgICAgY29uc3QgdiA9IGYuYXJyYXk7CiAgICAgIHkgPSBmLnZlcnNpb247CiAgICAgIGZvciAobGV0IHggPSAwLCBfID0gdi5sZW5ndGggLyAzIC0gMTsgeCA8IF87IHggKz0gMykgewogICAgICAgIGNvbnN0IFMgPSB4ICsgMCwgdyA9IHggKyAxLCBUID0geCArIDI7CiAgICAgICAgZC5wdXNoKFMsIHcsIHcsIFQsIFQsIFMpOwogICAgICB9CiAgICB9IGVsc2UKICAgICAgcmV0dXJuOwogICAgY29uc3QgZyA9IG5ldyAoeXkoZCkgPyBOcCA6IHpwKShkLCAxKTsKICAgIGcudmVyc2lvbiA9IHk7CiAgICBjb25zdCBtID0gcy5nZXQodSk7CiAgICBtICYmIHQucmVtb3ZlKG0pLCBzLnNldCh1LCBnKTsKICB9CiAgZnVuY3Rpb24gYyh1KSB7CiAgICBjb25zdCBkID0gcy5nZXQodSk7CiAgICBpZiAoZCkgewogICAgICBjb25zdCBwID0gdS5pbmRleDsKICAgICAgcCAhPT0gbnVsbCAmJiBkLnZlcnNpb24gPCBwLnZlcnNpb24gJiYgaCh1KTsKICAgIH0gZWxzZQogICAgICBoKHUpOwogICAgcmV0dXJuIHMuZ2V0KHUpOwogIH0KICByZXR1cm4gewogICAgZ2V0OiBvLAogICAgdXBkYXRlOiBsLAogICAgZ2V0V2lyZWZyYW1lQXR0cmlidXRlOiBjCiAgfTsKfQpmdW5jdGlvbiB6dyhhLCB0LCBlKSB7CiAgbGV0IGk7CiAgZnVuY3Rpb24gbihkKSB7CiAgICBpID0gZDsKICB9CiAgbGV0IHMsIHI7CiAgZnVuY3Rpb24gbyhkKSB7CiAgICBzID0gZC50eXBlLCByID0gZC5ieXRlc1BlckVsZW1lbnQ7CiAgfQogIGZ1bmN0aW9uIGwoZCwgcCkgewogICAgYS5kcmF3RWxlbWVudHMoaSwgcCwgcywgZCAqIHIpLCBlLnVwZGF0ZShwLCBpLCAxKTsKICB9CiAgZnVuY3Rpb24gaChkLCBwLCBmKSB7CiAgICBmICE9PSAwICYmIChhLmRyYXdFbGVtZW50c0luc3RhbmNlZChpLCBwLCBzLCBkICogciwgZiksIGUudXBkYXRlKHAsIGksIGYpKTsKICB9CiAgZnVuY3Rpb24gYyhkLCBwLCBmKSB7CiAgICBpZiAoZiA9PT0gMCkgcmV0dXJuOwogICAgdC5nZXQoIldFQkdMX211bHRpX2RyYXciKS5tdWx0aURyYXdFbGVtZW50c1dFQkdMKGksIHAsIDAsIHMsIGQsIDAsIGYpOwogICAgbGV0IGcgPSAwOwogICAgZm9yIChsZXQgbSA9IDA7IG0gPCBmOyBtKyspCiAgICAgIGcgKz0gcFttXTsKICAgIGUudXBkYXRlKGcsIGksIDEpOwogIH0KICBmdW5jdGlvbiB1KGQsIHAsIGYsIHkpIHsKICAgIGlmIChmID09PSAwKSByZXR1cm47CiAgICBjb25zdCBnID0gdC5nZXQoIldFQkdMX211bHRpX2RyYXciKTsKICAgIGlmIChnID09PSBudWxsKQogICAgICBmb3IgKGxldCBtID0gMDsgbSA8IGQubGVuZ3RoOyBtKyspCiAgICAgICAgaChkW21dIC8gciwgcFttXSwgeVttXSk7CiAgICBlbHNlIHsKICAgICAgZy5tdWx0aURyYXdFbGVtZW50c0luc3RhbmNlZFdFQkdMKGksIHAsIDAsIHMsIGQsIDAsIHksIDAsIGYpOwogICAgICBsZXQgbSA9IDA7CiAgICAgIGZvciAobGV0IHYgPSAwOyB2IDwgZjsgdisrKQogICAgICAgIG0gKz0gcFt2XSAqIHlbdl07CiAgICAgIGUudXBkYXRlKG0sIGksIDEpOwogICAgfQogIH0KICB0aGlzLnNldE1vZGUgPSBuLCB0aGlzLnNldEluZGV4ID0gbywgdGhpcy5yZW5kZXIgPSBsLCB0aGlzLnJlbmRlckluc3RhbmNlcyA9IGgsIHRoaXMucmVuZGVyTXVsdGlEcmF3ID0gYywgdGhpcy5yZW5kZXJNdWx0aURyYXdJbnN0YW5jZXMgPSB1Owp9CmZ1bmN0aW9uIE53KGEpIHsKICBjb25zdCB0ID0gewogICAgZ2VvbWV0cmllczogMCwKICAgIHRleHR1cmVzOiAwCiAgfSwgZSA9IHsKICAgIGZyYW1lOiAwLAogICAgY2FsbHM6IDAsCiAgICB0cmlhbmdsZXM6IDAsCiAgICBwb2ludHM6IDAsCiAgICBsaW5lczogMAogIH07CiAgZnVuY3Rpb24gaShzLCByLCBvKSB7CiAgICBzd2l0Y2ggKGUuY2FsbHMrKywgcikgewogICAgICBjYXNlIGEuVFJJQU5HTEVTOgogICAgICAgIGUudHJpYW5nbGVzICs9IG8gKiAocyAvIDMpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIGEuTElORVM6CiAgICAgICAgZS5saW5lcyArPSBvICogKHMgLyAyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBhLkxJTkVfU1RSSVA6CiAgICAgICAgZS5saW5lcyArPSBvICogKHMgLSAxKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBhLkxJTkVfTE9PUDoKICAgICAgICBlLmxpbmVzICs9IG8gKiBzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIGEuUE9JTlRTOgogICAgICAgIGUucG9pbnRzICs9IG8gKiBzOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMSW5mbzogVW5rbm93biBkcmF3IG1vZGU6Iiwgcik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIGZ1bmN0aW9uIG4oKSB7CiAgICBlLmNhbGxzID0gMCwgZS50cmlhbmdsZXMgPSAwLCBlLnBvaW50cyA9IDAsIGUubGluZXMgPSAwOwogIH0KICByZXR1cm4gewogICAgbWVtb3J5OiB0LAogICAgcmVuZGVyOiBlLAogICAgcHJvZ3JhbXM6IG51bGwsCiAgICBhdXRvUmVzZXQ6ICEwLAogICAgcmVzZXQ6IG4sCiAgICB1cGRhdGU6IGkKICB9Owp9CmZ1bmN0aW9uIE93KGEsIHQsIGUpIHsKICBjb25zdCBpID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCksIG4gPSBuZXcgUXQoKTsKICBmdW5jdGlvbiBzKHIsIG8sIGwpIHsKICAgIGNvbnN0IGggPSByLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcywgYyA9IG8ubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uIHx8IG8ubW9ycGhBdHRyaWJ1dGVzLm5vcm1hbCB8fCBvLm1vcnBoQXR0cmlidXRlcy5jb2xvciwgdSA9IGMgIT09IHZvaWQgMCA/IGMubGVuZ3RoIDogMDsKICAgIGxldCBkID0gaS5nZXQobyk7CiAgICBpZiAoZCA9PT0gdm9pZCAwIHx8IGQuY291bnQgIT09IHUpIHsKICAgICAgbGV0IGIgPSBmdW5jdGlvbigpIHsKICAgICAgICBULmRpc3Bvc2UoKSwgaS5kZWxldGUobyksIG8ucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZGlzcG9zZSIsIGIpOwogICAgICB9OwogICAgICBkICE9PSB2b2lkIDAgJiYgZC50ZXh0dXJlLmRpc3Bvc2UoKTsKICAgICAgY29uc3QgcCA9IG8ubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uICE9PSB2b2lkIDAsIGYgPSBvLm1vcnBoQXR0cmlidXRlcy5ub3JtYWwgIT09IHZvaWQgMCwgeSA9IG8ubW9ycGhBdHRyaWJ1dGVzLmNvbG9yICE9PSB2b2lkIDAsIGcgPSBvLm1vcnBoQXR0cmlidXRlcy5wb3NpdGlvbiB8fCBbXSwgbSA9IG8ubW9ycGhBdHRyaWJ1dGVzLm5vcm1hbCB8fCBbXSwgdiA9IG8ubW9ycGhBdHRyaWJ1dGVzLmNvbG9yIHx8IFtdOwogICAgICBsZXQgeCA9IDA7CiAgICAgIHAgPT09ICEwICYmICh4ID0gMSksIGYgPT09ICEwICYmICh4ID0gMiksIHkgPT09ICEwICYmICh4ID0gMyk7CiAgICAgIGxldCBfID0gby5hdHRyaWJ1dGVzLnBvc2l0aW9uLmNvdW50ICogeCwgUyA9IDE7CiAgICAgIF8gPiB0Lm1heFRleHR1cmVTaXplICYmIChTID0gTWF0aC5jZWlsKF8gLyB0Lm1heFRleHR1cmVTaXplKSwgXyA9IHQubWF4VGV4dHVyZVNpemUpOwogICAgICBjb25zdCB3ID0gbmV3IEZsb2F0MzJBcnJheShfICogUyAqIDQgKiB1KSwgVCA9IG5ldyBCYyh3LCBfLCBTLCB1KTsKICAgICAgVC50eXBlID0gd2ksIFQubmVlZHNVcGRhdGUgPSAhMDsKICAgICAgY29uc3QgUiA9IHggKiA0OwogICAgICBmb3IgKGxldCBNID0gMDsgTSA8IHU7IE0rKykgewogICAgICAgIGNvbnN0IEwgPSBnW01dLCBVID0gbVtNXSwgTyA9IHZbTV0sIFYgPSBfICogUyAqIDQgKiBNOwogICAgICAgIGZvciAobGV0IFcgPSAwOyBXIDwgTC5jb3VudDsgVysrKSB7CiAgICAgICAgICBjb25zdCBHID0gVyAqIFI7CiAgICAgICAgICBwID09PSAhMCAmJiAobi5mcm9tQnVmZmVyQXR0cmlidXRlKEwsIFcpLCB3W1YgKyBHICsgMF0gPSBuLngsIHdbViArIEcgKyAxXSA9IG4ueSwgd1tWICsgRyArIDJdID0gbi56LCB3W1YgKyBHICsgM10gPSAwKSwgZiA9PT0gITAgJiYgKG4uZnJvbUJ1ZmZlckF0dHJpYnV0ZShVLCBXKSwgd1tWICsgRyArIDRdID0gbi54LCB3W1YgKyBHICsgNV0gPSBuLnksIHdbViArIEcgKyA2XSA9IG4ueiwgd1tWICsgRyArIDddID0gMCksIHkgPT09ICEwICYmIChuLmZyb21CdWZmZXJBdHRyaWJ1dGUoTywgVyksIHdbViArIEcgKyA4XSA9IG4ueCwgd1tWICsgRyArIDldID0gbi55LCB3W1YgKyBHICsgMTBdID0gbi56LCB3W1YgKyBHICsgMTFdID0gTy5pdGVtU2l6ZSA9PT0gNCA/IG4udyA6IDEpOwogICAgICAgIH0KICAgICAgfQogICAgICBkID0gewogICAgICAgIGNvdW50OiB1LAogICAgICAgIHRleHR1cmU6IFQsCiAgICAgICAgc2l6ZTogbmV3IEooXywgUykKICAgICAgfSwgaS5zZXQobywgZCksIG8uYWRkRXZlbnRMaXN0ZW5lcigiZGlzcG9zZSIsIGIpOwogICAgfQogICAgaWYgKHIuaXNJbnN0YW5jZWRNZXNoID09PSAhMCAmJiByLm1vcnBoVGV4dHVyZSAhPT0gbnVsbCkKICAgICAgbC5nZXRVbmlmb3JtcygpLnNldFZhbHVlKGEsICJtb3JwaFRleHR1cmUiLCByLm1vcnBoVGV4dHVyZSwgZSk7CiAgICBlbHNlIHsKICAgICAgbGV0IHAgPSAwOwogICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGgubGVuZ3RoOyB5KyspCiAgICAgICAgcCArPSBoW3ldOwogICAgICBjb25zdCBmID0gby5tb3JwaFRhcmdldHNSZWxhdGl2ZSA/IDEgOiAxIC0gcDsKICAgICAgbC5nZXRVbmlmb3JtcygpLnNldFZhbHVlKGEsICJtb3JwaFRhcmdldEJhc2VJbmZsdWVuY2UiLCBmKSwgbC5nZXRVbmlmb3JtcygpLnNldFZhbHVlKGEsICJtb3JwaFRhcmdldEluZmx1ZW5jZXMiLCBoKTsKICAgIH0KICAgIGwuZ2V0VW5pZm9ybXMoKS5zZXRWYWx1ZShhLCAibW9ycGhUYXJnZXRzVGV4dHVyZSIsIGQudGV4dHVyZSwgZSksIGwuZ2V0VW5pZm9ybXMoKS5zZXRWYWx1ZShhLCAibW9ycGhUYXJnZXRzVGV4dHVyZVNpemUiLCBkLnNpemUpOwogIH0KICByZXR1cm4gewogICAgdXBkYXRlOiBzCiAgfTsKfQpmdW5jdGlvbiBrdyhhLCB0LCBlLCBpKSB7CiAgbGV0IG4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBmdW5jdGlvbiBzKGwpIHsKICAgIGNvbnN0IGggPSBpLnJlbmRlci5mcmFtZSwgYyA9IGwuZ2VvbWV0cnksIHUgPSB0LmdldChsLCBjKTsKICAgIGlmIChuLmdldCh1KSAhPT0gaCAmJiAodC51cGRhdGUodSksIG4uc2V0KHUsIGgpKSwgbC5pc0luc3RhbmNlZE1lc2ggJiYgKGwuaGFzRXZlbnRMaXN0ZW5lcigiZGlzcG9zZSIsIG8pID09PSAhMSAmJiBsLmFkZEV2ZW50TGlzdGVuZXIoImRpc3Bvc2UiLCBvKSwgbi5nZXQobCkgIT09IGggJiYgKGUudXBkYXRlKGwuaW5zdGFuY2VNYXRyaXgsIGEuQVJSQVlfQlVGRkVSKSwgbC5pbnN0YW5jZUNvbG9yICE9PSBudWxsICYmIGUudXBkYXRlKGwuaW5zdGFuY2VDb2xvciwgYS5BUlJBWV9CVUZGRVIpLCBuLnNldChsLCBoKSkpLCBsLmlzU2tpbm5lZE1lc2gpIHsKICAgICAgY29uc3QgZCA9IGwuc2tlbGV0b247CiAgICAgIG4uZ2V0KGQpICE9PSBoICYmIChkLnVwZGF0ZSgpLCBuLnNldChkLCBoKSk7CiAgICB9CiAgICByZXR1cm4gdTsKICB9CiAgZnVuY3Rpb24gcigpIHsKICAgIG4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICB9CiAgZnVuY3Rpb24gbyhsKSB7CiAgICBjb25zdCBoID0gbC50YXJnZXQ7CiAgICBoLnJlbW92ZUV2ZW50TGlzdGVuZXIoImRpc3Bvc2UiLCBvKSwgZS5yZW1vdmUoaC5pbnN0YW5jZU1hdHJpeCksIGguaW5zdGFuY2VDb2xvciAhPT0gbnVsbCAmJiBlLnJlbW92ZShoLmluc3RhbmNlQ29sb3IpOwogIH0KICByZXR1cm4gewogICAgdXBkYXRlOiBzLAogICAgZGlzcG9zZTogcgogIH07Cn0KY29uc3QgU18gPSAvKiBAX19QVVJFX18gKi8gbmV3IE5lKCksIEdtID0gLyogQF9fUFVSRV9fICovIG5ldyBWcCgxLCAxKSwgd18gPSAvKiBAX19QVVJFX18gKi8gbmV3IEJjKCksIEFfID0gLyogQF9fUFVSRV9fICovIG5ldyB6YygpLCBFXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgT28oKSwgV20gPSBbXSwgcW0gPSBbXSwgJG0gPSBuZXcgRmxvYXQzMkFycmF5KDE2KSwgWG0gPSBuZXcgRmxvYXQzMkFycmF5KDkpLCBZbSA9IG5ldyBGbG9hdDMyQXJyYXkoNCk7CmZ1bmN0aW9uIExhKGEsIHQsIGUpIHsKICBjb25zdCBpID0gYVswXTsKICBpZiAoaSA8PSAwIHx8IGkgPiAwKSByZXR1cm4gYTsKICBjb25zdCBuID0gdCAqIGU7CiAgbGV0IHMgPSBXbVtuXTsKICBpZiAocyA9PT0gdm9pZCAwICYmIChzID0gbmV3IEZsb2F0MzJBcnJheShuKSwgV21bbl0gPSBzKSwgdCAhPT0gMCkgewogICAgaS50b0FycmF5KHMsIDApOwogICAgZm9yIChsZXQgciA9IDEsIG8gPSAwOyByICE9PSB0OyArK3IpCiAgICAgIG8gKz0gZSwgYVtyXS50b0FycmF5KHMsIG8pOwogIH0KICByZXR1cm4gczsKfQpmdW5jdGlvbiBCZShhLCB0KSB7CiAgaWYgKGEubGVuZ3RoICE9PSB0Lmxlbmd0aCkgcmV0dXJuICExOwogIGZvciAobGV0IGUgPSAwLCBpID0gYS5sZW5ndGg7IGUgPCBpOyBlKyspCiAgICBpZiAoYVtlXSAhPT0gdFtlXSkgcmV0dXJuICExOwogIHJldHVybiAhMDsKfQpmdW5jdGlvbiB6ZShhLCB0KSB7CiAgZm9yIChsZXQgZSA9IDAsIGkgPSB0Lmxlbmd0aDsgZSA8IGk7IGUrKykKICAgIGFbZV0gPSB0W2VdOwp9CmZ1bmN0aW9uIGx1KGEsIHQpIHsKICBsZXQgZSA9IHFtW3RdOwogIGUgPT09IHZvaWQgMCAmJiAoZSA9IG5ldyBJbnQzMkFycmF5KHQpLCBxbVt0XSA9IGUpOwogIGZvciAobGV0IGkgPSAwOyBpICE9PSB0OyArK2kpCiAgICBlW2ldID0gYS5hbGxvY2F0ZVRleHR1cmVVbml0KCk7CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gVncoYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGVbMF0gIT09IHQgJiYgKGEudW5pZm9ybTFmKHRoaXMuYWRkciwgdCksIGVbMF0gPSB0KTsKfQpmdW5jdGlvbiBIdyhhLCB0KSB7CiAgY29uc3QgZSA9IHRoaXMuY2FjaGU7CiAgaWYgKHQueCAhPT0gdm9pZCAwKQogICAgKGVbMF0gIT09IHQueCB8fCBlWzFdICE9PSB0LnkpICYmIChhLnVuaWZvcm0yZih0aGlzLmFkZHIsIHQueCwgdC55KSwgZVswXSA9IHQueCwgZVsxXSA9IHQueSk7CiAgZWxzZSB7CiAgICBpZiAoQmUoZSwgdCkpIHJldHVybjsKICAgIGEudW5pZm9ybTJmdih0aGlzLmFkZHIsIHQpLCB6ZShlLCB0KTsKICB9Cn0KZnVuY3Rpb24gR3coYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGlmICh0LnggIT09IHZvaWQgMCkKICAgIChlWzBdICE9PSB0LnggfHwgZVsxXSAhPT0gdC55IHx8IGVbMl0gIT09IHQueikgJiYgKGEudW5pZm9ybTNmKHRoaXMuYWRkciwgdC54LCB0LnksIHQueiksIGVbMF0gPSB0LngsIGVbMV0gPSB0LnksIGVbMl0gPSB0LnopOwogIGVsc2UgaWYgKHQuciAhPT0gdm9pZCAwKQogICAgKGVbMF0gIT09IHQuciB8fCBlWzFdICE9PSB0LmcgfHwgZVsyXSAhPT0gdC5iKSAmJiAoYS51bmlmb3JtM2YodGhpcy5hZGRyLCB0LnIsIHQuZywgdC5iKSwgZVswXSA9IHQuciwgZVsxXSA9IHQuZywgZVsyXSA9IHQuYik7CiAgZWxzZSB7CiAgICBpZiAoQmUoZSwgdCkpIHJldHVybjsKICAgIGEudW5pZm9ybTNmdih0aGlzLmFkZHIsIHQpLCB6ZShlLCB0KTsKICB9Cn0KZnVuY3Rpb24gV3coYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGlmICh0LnggIT09IHZvaWQgMCkKICAgIChlWzBdICE9PSB0LnggfHwgZVsxXSAhPT0gdC55IHx8IGVbMl0gIT09IHQueiB8fCBlWzNdICE9PSB0LncpICYmIChhLnVuaWZvcm00Zih0aGlzLmFkZHIsIHQueCwgdC55LCB0LnosIHQudyksIGVbMF0gPSB0LngsIGVbMV0gPSB0LnksIGVbMl0gPSB0LnosIGVbM10gPSB0LncpOwogIGVsc2UgewogICAgaWYgKEJlKGUsIHQpKSByZXR1cm47CiAgICBhLnVuaWZvcm00ZnYodGhpcy5hZGRyLCB0KSwgemUoZSwgdCk7CiAgfQp9CmZ1bmN0aW9uIHF3KGEsIHQpIHsKICBjb25zdCBlID0gdGhpcy5jYWNoZSwgaSA9IHQuZWxlbWVudHM7CiAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgaWYgKEJlKGUsIHQpKSByZXR1cm47CiAgICBhLnVuaWZvcm1NYXRyaXgyZnYodGhpcy5hZGRyLCAhMSwgdCksIHplKGUsIHQpOwogIH0gZWxzZSB7CiAgICBpZiAoQmUoZSwgaSkpIHJldHVybjsKICAgIFltLnNldChpKSwgYS51bmlmb3JtTWF0cml4MmZ2KHRoaXMuYWRkciwgITEsIFltKSwgemUoZSwgaSk7CiAgfQp9CmZ1bmN0aW9uICR3KGEsIHQpIHsKICBjb25zdCBlID0gdGhpcy5jYWNoZSwgaSA9IHQuZWxlbWVudHM7CiAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgaWYgKEJlKGUsIHQpKSByZXR1cm47CiAgICBhLnVuaWZvcm1NYXRyaXgzZnYodGhpcy5hZGRyLCAhMSwgdCksIHplKGUsIHQpOwogIH0gZWxzZSB7CiAgICBpZiAoQmUoZSwgaSkpIHJldHVybjsKICAgIFhtLnNldChpKSwgYS51bmlmb3JtTWF0cml4M2Z2KHRoaXMuYWRkciwgITEsIFhtKSwgemUoZSwgaSk7CiAgfQp9CmZ1bmN0aW9uIFh3KGEsIHQpIHsKICBjb25zdCBlID0gdGhpcy5jYWNoZSwgaSA9IHQuZWxlbWVudHM7CiAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgaWYgKEJlKGUsIHQpKSByZXR1cm47CiAgICBhLnVuaWZvcm1NYXRyaXg0ZnYodGhpcy5hZGRyLCAhMSwgdCksIHplKGUsIHQpOwogIH0gZWxzZSB7CiAgICBpZiAoQmUoZSwgaSkpIHJldHVybjsKICAgICRtLnNldChpKSwgYS51bmlmb3JtTWF0cml4NGZ2KHRoaXMuYWRkciwgITEsICRtKSwgemUoZSwgaSk7CiAgfQp9CmZ1bmN0aW9uIFl3KGEsIHQpIHsKICBjb25zdCBlID0gdGhpcy5jYWNoZTsKICBlWzBdICE9PSB0ICYmIChhLnVuaWZvcm0xaSh0aGlzLmFkZHIsIHQpLCBlWzBdID0gdCk7Cn0KZnVuY3Rpb24gWncoYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGlmICh0LnggIT09IHZvaWQgMCkKICAgIChlWzBdICE9PSB0LnggfHwgZVsxXSAhPT0gdC55KSAmJiAoYS51bmlmb3JtMmkodGhpcy5hZGRyLCB0LngsIHQueSksIGVbMF0gPSB0LngsIGVbMV0gPSB0LnkpOwogIGVsc2UgewogICAgaWYgKEJlKGUsIHQpKSByZXR1cm47CiAgICBhLnVuaWZvcm0yaXYodGhpcy5hZGRyLCB0KSwgemUoZSwgdCk7CiAgfQp9CmZ1bmN0aW9uIGp3KGEsIHQpIHsKICBjb25zdCBlID0gdGhpcy5jYWNoZTsKICBpZiAodC54ICE9PSB2b2lkIDApCiAgICAoZVswXSAhPT0gdC54IHx8IGVbMV0gIT09IHQueSB8fCBlWzJdICE9PSB0LnopICYmIChhLnVuaWZvcm0zaSh0aGlzLmFkZHIsIHQueCwgdC55LCB0LnopLCBlWzBdID0gdC54LCBlWzFdID0gdC55LCBlWzJdID0gdC56KTsKICBlbHNlIHsKICAgIGlmIChCZShlLCB0KSkgcmV0dXJuOwogICAgYS51bmlmb3JtM2l2KHRoaXMuYWRkciwgdCksIHplKGUsIHQpOwogIH0KfQpmdW5jdGlvbiBKdyhhLCB0KSB7CiAgY29uc3QgZSA9IHRoaXMuY2FjaGU7CiAgaWYgKHQueCAhPT0gdm9pZCAwKQogICAgKGVbMF0gIT09IHQueCB8fCBlWzFdICE9PSB0LnkgfHwgZVsyXSAhPT0gdC56IHx8IGVbM10gIT09IHQudykgJiYgKGEudW5pZm9ybTRpKHRoaXMuYWRkciwgdC54LCB0LnksIHQueiwgdC53KSwgZVswXSA9IHQueCwgZVsxXSA9IHQueSwgZVsyXSA9IHQueiwgZVszXSA9IHQudyk7CiAgZWxzZSB7CiAgICBpZiAoQmUoZSwgdCkpIHJldHVybjsKICAgIGEudW5pZm9ybTRpdih0aGlzLmFkZHIsIHQpLCB6ZShlLCB0KTsKICB9Cn0KZnVuY3Rpb24gS3coYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGVbMF0gIT09IHQgJiYgKGEudW5pZm9ybTF1aSh0aGlzLmFkZHIsIHQpLCBlWzBdID0gdCk7Cn0KZnVuY3Rpb24gUXcoYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGlmICh0LnggIT09IHZvaWQgMCkKICAgIChlWzBdICE9PSB0LnggfHwgZVsxXSAhPT0gdC55KSAmJiAoYS51bmlmb3JtMnVpKHRoaXMuYWRkciwgdC54LCB0LnkpLCBlWzBdID0gdC54LCBlWzFdID0gdC55KTsKICBlbHNlIHsKICAgIGlmIChCZShlLCB0KSkgcmV0dXJuOwogICAgYS51bmlmb3JtMnVpdih0aGlzLmFkZHIsIHQpLCB6ZShlLCB0KTsKICB9Cn0KZnVuY3Rpb24gdEEoYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGlmICh0LnggIT09IHZvaWQgMCkKICAgIChlWzBdICE9PSB0LnggfHwgZVsxXSAhPT0gdC55IHx8IGVbMl0gIT09IHQueikgJiYgKGEudW5pZm9ybTN1aSh0aGlzLmFkZHIsIHQueCwgdC55LCB0LnopLCBlWzBdID0gdC54LCBlWzFdID0gdC55LCBlWzJdID0gdC56KTsKICBlbHNlIHsKICAgIGlmIChCZShlLCB0KSkgcmV0dXJuOwogICAgYS51bmlmb3JtM3Vpdih0aGlzLmFkZHIsIHQpLCB6ZShlLCB0KTsKICB9Cn0KZnVuY3Rpb24gZUEoYSwgdCkgewogIGNvbnN0IGUgPSB0aGlzLmNhY2hlOwogIGlmICh0LnggIT09IHZvaWQgMCkKICAgIChlWzBdICE9PSB0LnggfHwgZVsxXSAhPT0gdC55IHx8IGVbMl0gIT09IHQueiB8fCBlWzNdICE9PSB0LncpICYmIChhLnVuaWZvcm00dWkodGhpcy5hZGRyLCB0LngsIHQueSwgdC56LCB0LncpLCBlWzBdID0gdC54LCBlWzFdID0gdC55LCBlWzJdID0gdC56LCBlWzNdID0gdC53KTsKICBlbHNlIHsKICAgIGlmIChCZShlLCB0KSkgcmV0dXJuOwogICAgYS51bmlmb3JtNHVpdih0aGlzLmFkZHIsIHQpLCB6ZShlLCB0KTsKICB9Cn0KZnVuY3Rpb24gaUEoYSwgdCwgZSkgewogIGNvbnN0IGkgPSB0aGlzLmNhY2hlLCBuID0gZS5hbGxvY2F0ZVRleHR1cmVVbml0KCk7CiAgaVswXSAhPT0gbiAmJiAoYS51bmlmb3JtMWkodGhpcy5hZGRyLCBuKSwgaVswXSA9IG4pOwogIGxldCBzOwogIHRoaXMudHlwZSA9PT0gYS5TQU1QTEVSXzJEX1NIQURPVyA/IChHbS5jb21wYXJlRnVuY3Rpb24gPSBGcCwgcyA9IEdtKSA6IHMgPSBTXywgZS5zZXRUZXh0dXJlMkQodCB8fCBzLCBuKTsKfQpmdW5jdGlvbiBuQShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IHRoaXMuY2FjaGUsIG4gPSBlLmFsbG9jYXRlVGV4dHVyZVVuaXQoKTsKICBpWzBdICE9PSBuICYmIChhLnVuaWZvcm0xaSh0aGlzLmFkZHIsIG4pLCBpWzBdID0gbiksIGUuc2V0VGV4dHVyZTNEKHQgfHwgQV8sIG4pOwp9CmZ1bmN0aW9uIHNBKGEsIHQsIGUpIHsKICBjb25zdCBpID0gdGhpcy5jYWNoZSwgbiA9IGUuYWxsb2NhdGVUZXh0dXJlVW5pdCgpOwogIGlbMF0gIT09IG4gJiYgKGEudW5pZm9ybTFpKHRoaXMuYWRkciwgbiksIGlbMF0gPSBuKSwgZS5zZXRUZXh0dXJlQ3ViZSh0IHx8IEVfLCBuKTsKfQpmdW5jdGlvbiByQShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IHRoaXMuY2FjaGUsIG4gPSBlLmFsbG9jYXRlVGV4dHVyZVVuaXQoKTsKICBpWzBdICE9PSBuICYmIChhLnVuaWZvcm0xaSh0aGlzLmFkZHIsIG4pLCBpWzBdID0gbiksIGUuc2V0VGV4dHVyZTJEQXJyYXkodCB8fCB3Xywgbik7Cn0KZnVuY3Rpb24gYUEoYSkgewogIHN3aXRjaCAoYSkgewogICAgY2FzZSA1MTI2OgogICAgICByZXR1cm4gVnc7CiAgICBjYXNlIDM1NjY0OgogICAgICByZXR1cm4gSHc7CiAgICBjYXNlIDM1NjY1OgogICAgICByZXR1cm4gR3c7CiAgICBjYXNlIDM1NjY2OgogICAgICByZXR1cm4gV3c7CiAgICBjYXNlIDM1Njc0OgogICAgICByZXR1cm4gcXc7CiAgICBjYXNlIDM1Njc1OgogICAgICByZXR1cm4gJHc7CiAgICBjYXNlIDM1Njc2OgogICAgICByZXR1cm4gWHc7CiAgICBjYXNlIDUxMjQ6CiAgICBjYXNlIDM1NjcwOgogICAgICByZXR1cm4gWXc7CiAgICBjYXNlIDM1NjY3OgogICAgY2FzZSAzNTY3MToKICAgICAgcmV0dXJuIFp3OwogICAgY2FzZSAzNTY2ODoKICAgIGNhc2UgMzU2NzI6CiAgICAgIHJldHVybiBqdzsKICAgIGNhc2UgMzU2Njk6CiAgICBjYXNlIDM1NjczOgogICAgICByZXR1cm4gSnc7CiAgICBjYXNlIDUxMjU6CiAgICAgIHJldHVybiBLdzsKICAgIGNhc2UgMzYyOTQ6CiAgICAgIHJldHVybiBRdzsKICAgIGNhc2UgMzYyOTU6CiAgICAgIHJldHVybiB0QTsKICAgIGNhc2UgMzYyOTY6CiAgICAgIHJldHVybiBlQTsKICAgIGNhc2UgMzU2Nzg6CiAgICBjYXNlIDM2MTk4OgogICAgY2FzZSAzNjI5ODoKICAgIGNhc2UgMzYzMDY6CiAgICBjYXNlIDM1NjgyOgogICAgICByZXR1cm4gaUE7CiAgICBjYXNlIDM1Njc5OgogICAgY2FzZSAzNjI5OToKICAgIGNhc2UgMzYzMDc6CiAgICAgIHJldHVybiBuQTsKICAgIGNhc2UgMzU2ODA6CiAgICBjYXNlIDM2MzAwOgogICAgY2FzZSAzNjMwODoKICAgIGNhc2UgMzYyOTM6CiAgICAgIHJldHVybiBzQTsKICAgIGNhc2UgMzYyODk6CiAgICBjYXNlIDM2MzAzOgogICAgY2FzZSAzNjMxMToKICAgIGNhc2UgMzYyOTI6CiAgICAgIHJldHVybiByQTsKICB9Cn0KZnVuY3Rpb24gb0EoYSwgdCkgewogIGEudW5pZm9ybTFmdih0aGlzLmFkZHIsIHQpOwp9CmZ1bmN0aW9uIGxBKGEsIHQpIHsKICBjb25zdCBlID0gTGEodCwgdGhpcy5zaXplLCAyKTsKICBhLnVuaWZvcm0yZnYodGhpcy5hZGRyLCBlKTsKfQpmdW5jdGlvbiBoQShhLCB0KSB7CiAgY29uc3QgZSA9IExhKHQsIHRoaXMuc2l6ZSwgMyk7CiAgYS51bmlmb3JtM2Z2KHRoaXMuYWRkciwgZSk7Cn0KZnVuY3Rpb24gY0EoYSwgdCkgewogIGNvbnN0IGUgPSBMYSh0LCB0aGlzLnNpemUsIDQpOwogIGEudW5pZm9ybTRmdih0aGlzLmFkZHIsIGUpOwp9CmZ1bmN0aW9uIHVBKGEsIHQpIHsKICBjb25zdCBlID0gTGEodCwgdGhpcy5zaXplLCA0KTsKICBhLnVuaWZvcm1NYXRyaXgyZnYodGhpcy5hZGRyLCAhMSwgZSk7Cn0KZnVuY3Rpb24gZEEoYSwgdCkgewogIGNvbnN0IGUgPSBMYSh0LCB0aGlzLnNpemUsIDkpOwogIGEudW5pZm9ybU1hdHJpeDNmdih0aGlzLmFkZHIsICExLCBlKTsKfQpmdW5jdGlvbiBwQShhLCB0KSB7CiAgY29uc3QgZSA9IExhKHQsIHRoaXMuc2l6ZSwgMTYpOwogIGEudW5pZm9ybU1hdHJpeDRmdih0aGlzLmFkZHIsICExLCBlKTsKfQpmdW5jdGlvbiBmQShhLCB0KSB7CiAgYS51bmlmb3JtMWl2KHRoaXMuYWRkciwgdCk7Cn0KZnVuY3Rpb24gbUEoYSwgdCkgewogIGEudW5pZm9ybTJpdih0aGlzLmFkZHIsIHQpOwp9CmZ1bmN0aW9uIGdBKGEsIHQpIHsKICBhLnVuaWZvcm0zaXYodGhpcy5hZGRyLCB0KTsKfQpmdW5jdGlvbiB5QShhLCB0KSB7CiAgYS51bmlmb3JtNGl2KHRoaXMuYWRkciwgdCk7Cn0KZnVuY3Rpb24gX0EoYSwgdCkgewogIGEudW5pZm9ybTF1aXYodGhpcy5hZGRyLCB0KTsKfQpmdW5jdGlvbiB4QShhLCB0KSB7CiAgYS51bmlmb3JtMnVpdih0aGlzLmFkZHIsIHQpOwp9CmZ1bmN0aW9uIHZBKGEsIHQpIHsKICBhLnVuaWZvcm0zdWl2KHRoaXMuYWRkciwgdCk7Cn0KZnVuY3Rpb24gYkEoYSwgdCkgewogIGEudW5pZm9ybTR1aXYodGhpcy5hZGRyLCB0KTsKfQpmdW5jdGlvbiBNQShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IHRoaXMuY2FjaGUsIG4gPSB0Lmxlbmd0aCwgcyA9IGx1KGUsIG4pOwogIEJlKGksIHMpIHx8IChhLnVuaWZvcm0xaXYodGhpcy5hZGRyLCBzKSwgemUoaSwgcykpOwogIGZvciAobGV0IHIgPSAwOyByICE9PSBuOyArK3IpCiAgICBlLnNldFRleHR1cmUyRCh0W3JdIHx8IFNfLCBzW3JdKTsKfQpmdW5jdGlvbiBTQShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IHRoaXMuY2FjaGUsIG4gPSB0Lmxlbmd0aCwgcyA9IGx1KGUsIG4pOwogIEJlKGksIHMpIHx8IChhLnVuaWZvcm0xaXYodGhpcy5hZGRyLCBzKSwgemUoaSwgcykpOwogIGZvciAobGV0IHIgPSAwOyByICE9PSBuOyArK3IpCiAgICBlLnNldFRleHR1cmUzRCh0W3JdIHx8IEFfLCBzW3JdKTsKfQpmdW5jdGlvbiB3QShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IHRoaXMuY2FjaGUsIG4gPSB0Lmxlbmd0aCwgcyA9IGx1KGUsIG4pOwogIEJlKGksIHMpIHx8IChhLnVuaWZvcm0xaXYodGhpcy5hZGRyLCBzKSwgemUoaSwgcykpOwogIGZvciAobGV0IHIgPSAwOyByICE9PSBuOyArK3IpCiAgICBlLnNldFRleHR1cmVDdWJlKHRbcl0gfHwgRV8sIHNbcl0pOwp9CmZ1bmN0aW9uIEFBKGEsIHQsIGUpIHsKICBjb25zdCBpID0gdGhpcy5jYWNoZSwgbiA9IHQubGVuZ3RoLCBzID0gbHUoZSwgbik7CiAgQmUoaSwgcykgfHwgKGEudW5pZm9ybTFpdih0aGlzLmFkZHIsIHMpLCB6ZShpLCBzKSk7CiAgZm9yIChsZXQgciA9IDA7IHIgIT09IG47ICsrcikKICAgIGUuc2V0VGV4dHVyZTJEQXJyYXkodFtyXSB8fCB3Xywgc1tyXSk7Cn0KZnVuY3Rpb24gRUEoYSkgewogIHN3aXRjaCAoYSkgewogICAgY2FzZSA1MTI2OgogICAgICByZXR1cm4gb0E7CiAgICBjYXNlIDM1NjY0OgogICAgICByZXR1cm4gbEE7CiAgICBjYXNlIDM1NjY1OgogICAgICByZXR1cm4gaEE7CiAgICBjYXNlIDM1NjY2OgogICAgICByZXR1cm4gY0E7CiAgICBjYXNlIDM1Njc0OgogICAgICByZXR1cm4gdUE7CiAgICBjYXNlIDM1Njc1OgogICAgICByZXR1cm4gZEE7CiAgICBjYXNlIDM1Njc2OgogICAgICByZXR1cm4gcEE7CiAgICBjYXNlIDUxMjQ6CiAgICBjYXNlIDM1NjcwOgogICAgICByZXR1cm4gZkE7CiAgICBjYXNlIDM1NjY3OgogICAgY2FzZSAzNTY3MToKICAgICAgcmV0dXJuIG1BOwogICAgY2FzZSAzNTY2ODoKICAgIGNhc2UgMzU2NzI6CiAgICAgIHJldHVybiBnQTsKICAgIGNhc2UgMzU2Njk6CiAgICBjYXNlIDM1NjczOgogICAgICByZXR1cm4geUE7CiAgICBjYXNlIDUxMjU6CiAgICAgIHJldHVybiBfQTsKICAgIGNhc2UgMzYyOTQ6CiAgICAgIHJldHVybiB4QTsKICAgIGNhc2UgMzYyOTU6CiAgICAgIHJldHVybiB2QTsKICAgIGNhc2UgMzYyOTY6CiAgICAgIHJldHVybiBiQTsKICAgIGNhc2UgMzU2Nzg6CiAgICBjYXNlIDM2MTk4OgogICAgY2FzZSAzNjI5ODoKICAgIGNhc2UgMzYzMDY6CiAgICBjYXNlIDM1NjgyOgogICAgICByZXR1cm4gTUE7CiAgICBjYXNlIDM1Njc5OgogICAgY2FzZSAzNjI5OToKICAgIGNhc2UgMzYzMDc6CiAgICAgIHJldHVybiBTQTsKICAgIGNhc2UgMzU2ODA6CiAgICBjYXNlIDM2MzAwOgogICAgY2FzZSAzNjMwODoKICAgIGNhc2UgMzYyOTM6CiAgICAgIHJldHVybiB3QTsKICAgIGNhc2UgMzYyODk6CiAgICBjYXNlIDM2MzAzOgogICAgY2FzZSAzNjMxMToKICAgIGNhc2UgMzYyOTI6CiAgICAgIHJldHVybiBBQTsKICB9Cn0KY2xhc3MgVEEgewogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHRoaXMuaWQgPSB0LCB0aGlzLmFkZHIgPSBpLCB0aGlzLmNhY2hlID0gW10sIHRoaXMudHlwZSA9IGUudHlwZSwgdGhpcy5zZXRWYWx1ZSA9IGFBKGUudHlwZSk7CiAgfQp9CmNsYXNzIENBIHsKICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICB0aGlzLmlkID0gdCwgdGhpcy5hZGRyID0gaSwgdGhpcy5jYWNoZSA9IFtdLCB0aGlzLnR5cGUgPSBlLnR5cGUsIHRoaXMuc2l6ZSA9IGUuc2l6ZSwgdGhpcy5zZXRWYWx1ZSA9IEVBKGUudHlwZSk7CiAgfQp9CmNsYXNzIFJBIHsKICBjb25zdHJ1Y3Rvcih0KSB7CiAgICB0aGlzLmlkID0gdCwgdGhpcy5zZXEgPSBbXSwgdGhpcy5tYXAgPSB7fTsKICB9CiAgc2V0VmFsdWUodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuc2VxOwogICAgZm9yIChsZXQgcyA9IDAsIHIgPSBuLmxlbmd0aDsgcyAhPT0gcjsgKytzKSB7CiAgICAgIGNvbnN0IG8gPSBuW3NdOwogICAgICBvLnNldFZhbHVlKHQsIGVbby5pZF0sIGkpOwogICAgfQogIH0KfQpjb25zdCBhZCA9IC8oXHcrKShcXSk/KFxbfFwuKT8vZzsKZnVuY3Rpb24gWm0oYSwgdCkgewogIGEuc2VxLnB1c2godCksIGEubWFwW3QuaWRdID0gdDsKfQpmdW5jdGlvbiBQQShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IGEubmFtZSwgbiA9IGkubGVuZ3RoOwogIGZvciAoYWQubGFzdEluZGV4ID0gMDsgOyApIHsKICAgIGNvbnN0IHMgPSBhZC5leGVjKGkpLCByID0gYWQubGFzdEluZGV4OwogICAgbGV0IG8gPSBzWzFdOwogICAgY29uc3QgbCA9IHNbMl0gPT09ICJdIiwgaCA9IHNbM107CiAgICBpZiAobCAmJiAobyA9IG8gfCAwKSwgaCA9PT0gdm9pZCAwIHx8IGggPT09ICJbIiAmJiByICsgMiA9PT0gbikgewogICAgICBabShlLCBoID09PSB2b2lkIDAgPyBuZXcgVEEobywgYSwgdCkgOiBuZXcgQ0EobywgYSwgdCkpOwogICAgICBicmVhazsKICAgIH0gZWxzZSB7CiAgICAgIGxldCB1ID0gZS5tYXBbb107CiAgICAgIHUgPT09IHZvaWQgMCAmJiAodSA9IG5ldyBSQShvKSwgWm0oZSwgdSkpLCBlID0gdTsKICAgIH0KICB9Cn0KY2xhc3MgQ2ggewogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIHRoaXMuc2VxID0gW10sIHRoaXMubWFwID0ge307CiAgICBjb25zdCBpID0gdC5nZXRQcm9ncmFtUGFyYW1ldGVyKGUsIHQuQUNUSVZFX1VOSUZPUk1TKTsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgaTsgKytuKSB7CiAgICAgIGNvbnN0IHMgPSB0LmdldEFjdGl2ZVVuaWZvcm0oZSwgbiksIHIgPSB0LmdldFVuaWZvcm1Mb2NhdGlvbihlLCBzLm5hbWUpOwogICAgICBQQShzLCByLCB0aGlzKTsKICAgIH0KICB9CiAgc2V0VmFsdWUodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IHRoaXMubWFwW2VdOwogICAgcyAhPT0gdm9pZCAwICYmIHMuc2V0VmFsdWUodCwgaSwgbik7CiAgfQogIHNldE9wdGlvbmFsKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBlW2ldOwogICAgbiAhPT0gdm9pZCAwICYmIHRoaXMuc2V0VmFsdWUodCwgaSwgbik7CiAgfQogIHN0YXRpYyB1cGxvYWQodCwgZSwgaSwgbikgewogICAgZm9yIChsZXQgcyA9IDAsIHIgPSBlLmxlbmd0aDsgcyAhPT0gcjsgKytzKSB7CiAgICAgIGNvbnN0IG8gPSBlW3NdLCBsID0gaVtvLmlkXTsKICAgICAgbC5uZWVkc1VwZGF0ZSAhPT0gITEgJiYgby5zZXRWYWx1ZSh0LCBsLnZhbHVlLCBuKTsKICAgIH0KICB9CiAgc3RhdGljIHNlcVdpdGhWYWx1ZSh0LCBlKSB7CiAgICBjb25zdCBpID0gW107CiAgICBmb3IgKGxldCBuID0gMCwgcyA9IHQubGVuZ3RoOyBuICE9PSBzOyArK24pIHsKICAgICAgY29uc3QgciA9IHRbbl07CiAgICAgIHIuaWQgaW4gZSAmJiBpLnB1c2gocik7CiAgICB9CiAgICByZXR1cm4gaTsKICB9Cn0KZnVuY3Rpb24gam0oYSwgdCwgZSkgewogIGNvbnN0IGkgPSBhLmNyZWF0ZVNoYWRlcih0KTsKICByZXR1cm4gYS5zaGFkZXJTb3VyY2UoaSwgZSksIGEuY29tcGlsZVNoYWRlcihpKSwgaTsKfQpjb25zdCBJQSA9IDM3Mjk3OwpsZXQgTEEgPSAwOwpmdW5jdGlvbiBEQShhLCB0KSB7CiAgY29uc3QgZSA9IGEuc3BsaXQoYApgKSwgaSA9IFtdLCBuID0gTWF0aC5tYXgodCAtIDYsIDApLCBzID0gTWF0aC5taW4odCArIDYsIGUubGVuZ3RoKTsKICBmb3IgKGxldCByID0gbjsgciA8IHM7IHIrKykgewogICAgY29uc3QgbyA9IHIgKyAxOwogICAgaS5wdXNoKGAke28gPT09IHQgPyAiPiIgOiAiICJ9ICR7b306ICR7ZVtyXX1gKTsKICB9CiAgcmV0dXJuIGkuam9pbihgCmApOwp9CmNvbnN0IEptID0gLyogQF9fUFVSRV9fICovIG5ldyBYdCgpOwpmdW5jdGlvbiBGQShhKSB7CiAgZWUuX2dldE1hdHJpeChKbSwgZWUud29ya2luZ0NvbG9yU3BhY2UsIGEpOwogIGNvbnN0IHQgPSBgbWF0MyggJHtKbS5lbGVtZW50cy5tYXAoKGUpID0+IGUudG9GaXhlZCg0KSl9IClgOwogIHN3aXRjaCAoZWUuZ2V0VHJhbnNmZXIoYSkpIHsKICAgIGNhc2UgRW86CiAgICAgIHJldHVybiBbdCwgIkxpbmVhclRyYW5zZmVyT0VURiJdOwogICAgY2FzZSBjZToKICAgICAgcmV0dXJuIFt0LCAic1JHQlRyYW5zZmVyT0VURiJdOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xQcm9ncmFtOiBVbnN1cHBvcnRlZCBjb2xvciBzcGFjZTogIiwgYSksIFt0LCAiTGluZWFyVHJhbnNmZXJPRVRGIl07CiAgfQp9CmZ1bmN0aW9uIEttKGEsIHQsIGUpIHsKICBjb25zdCBpID0gYS5nZXRTaGFkZXJQYXJhbWV0ZXIodCwgYS5DT01QSUxFX1NUQVRVUyksIHMgPSAoYS5nZXRTaGFkZXJJbmZvTG9nKHQpIHx8ICIiKS50cmltKCk7CiAgaWYgKGkgJiYgcyA9PT0gIiIpIHJldHVybiAiIjsKICBjb25zdCByID0gL0VSUk9SOiAwOihcZCspLy5leGVjKHMpOwogIGlmIChyKSB7CiAgICBjb25zdCBvID0gcGFyc2VJbnQoclsxXSk7CiAgICByZXR1cm4gZS50b1VwcGVyQ2FzZSgpICsgYAoKYCArIHMgKyBgCgpgICsgREEoYS5nZXRTaGFkZXJTb3VyY2UodCksIG8pOwogIH0gZWxzZQogICAgcmV0dXJuIHM7Cn0KZnVuY3Rpb24gVUEoYSwgdCkgewogIGNvbnN0IGUgPSBGQSh0KTsKICByZXR1cm4gWwogICAgYHZlYzQgJHthfSggdmVjNCB2YWx1ZSApIHtgLAogICAgYAlyZXR1cm4gJHtlWzFdfSggdmVjNCggdmFsdWUucmdiICogJHtlWzBdfSwgdmFsdWUuYSApICk7YCwKICAgICJ9IgogIF0uam9pbihgCmApOwp9CmZ1bmN0aW9uIEJBKGEsIHQpIHsKICBsZXQgZTsKICBzd2l0Y2ggKHQpIHsKICAgIGNhc2UgWDA6CiAgICAgIGUgPSAiTGluZWFyIjsKICAgICAgYnJlYWs7CiAgICBjYXNlIFkwOgogICAgICBlID0gIlJlaW5oYXJkIjsKICAgICAgYnJlYWs7CiAgICBjYXNlIFowOgogICAgICBlID0gIkNpbmVvbiI7CiAgICAgIGJyZWFrOwogICAgY2FzZSBqMDoKICAgICAgZSA9ICJBQ0VTRmlsbWljIjsKICAgICAgYnJlYWs7CiAgICBjYXNlIEswOgogICAgICBlID0gIkFnWCI7CiAgICAgIGJyZWFrOwogICAgY2FzZSBRMDoKICAgICAgZSA9ICJOZXV0cmFsIjsKICAgICAgYnJlYWs7CiAgICBjYXNlIEowOgogICAgICBlID0gIkN1c3RvbSI7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5XZWJHTFByb2dyYW06IFVuc3VwcG9ydGVkIHRvbmVNYXBwaW5nOiIsIHQpLCBlID0gIkxpbmVhciI7CiAgfQogIHJldHVybiAidmVjMyAiICsgYSArICIoIHZlYzMgY29sb3IgKSB7IHJldHVybiAiICsgZSArICJUb25lTWFwcGluZyggY29sb3IgKTsgfSI7Cn0KY29uc3QgT2wgPSAvKiBAX19QVVJFX18gKi8gbmV3IEUoKTsKZnVuY3Rpb24gekEoKSB7CiAgZWUuZ2V0THVtaW5hbmNlQ29lZmZpY2llbnRzKE9sKTsKICBjb25zdCBhID0gT2wueC50b0ZpeGVkKDQpLCB0ID0gT2wueS50b0ZpeGVkKDQpLCBlID0gT2wuei50b0ZpeGVkKDQpOwogIHJldHVybiBbCiAgICAiZmxvYXQgbHVtaW5hbmNlKCBjb25zdCBpbiB2ZWMzIHJnYiApIHsiLAogICAgYAljb25zdCB2ZWMzIHdlaWdodHMgPSB2ZWMzKCAke2F9LCAke3R9LCAke2V9ICk7YCwKICAgICIJcmV0dXJuIGRvdCggd2VpZ2h0cywgcmdiICk7IiwKICAgICJ9IgogIF0uam9pbihgCmApOwp9CmZ1bmN0aW9uIE5BKGEpIHsKICByZXR1cm4gWwogICAgYS5leHRlbnNpb25DbGlwQ3VsbERpc3RhbmNlID8gIiNleHRlbnNpb24gR0xfQU5HTEVfY2xpcF9jdWxsX2Rpc3RhbmNlIDogcmVxdWlyZSIgOiAiIiwKICAgIGEuZXh0ZW5zaW9uTXVsdGlEcmF3ID8gIiNleHRlbnNpb24gR0xfQU5HTEVfbXVsdGlfZHJhdyA6IHJlcXVpcmUiIDogIiIKICBdLmZpbHRlcihybykuam9pbihgCmApOwp9CmZ1bmN0aW9uIE9BKGEpIHsKICBjb25zdCB0ID0gW107CiAgZm9yIChjb25zdCBlIGluIGEpIHsKICAgIGNvbnN0IGkgPSBhW2VdOwogICAgaSAhPT0gITEgJiYgdC5wdXNoKCIjZGVmaW5lICIgKyBlICsgIiAiICsgaSk7CiAgfQogIHJldHVybiB0LmpvaW4oYApgKTsKfQpmdW5jdGlvbiBrQShhLCB0KSB7CiAgY29uc3QgZSA9IHt9LCBpID0gYS5nZXRQcm9ncmFtUGFyYW1ldGVyKHQsIGEuQUNUSVZFX0FUVFJJQlVURVMpOwogIGZvciAobGV0IG4gPSAwOyBuIDwgaTsgbisrKSB7CiAgICBjb25zdCBzID0gYS5nZXRBY3RpdmVBdHRyaWIodCwgbiksIHIgPSBzLm5hbWU7CiAgICBsZXQgbyA9IDE7CiAgICBzLnR5cGUgPT09IGEuRkxPQVRfTUFUMiAmJiAobyA9IDIpLCBzLnR5cGUgPT09IGEuRkxPQVRfTUFUMyAmJiAobyA9IDMpLCBzLnR5cGUgPT09IGEuRkxPQVRfTUFUNCAmJiAobyA9IDQpLCBlW3JdID0gewogICAgICB0eXBlOiBzLnR5cGUsCiAgICAgIGxvY2F0aW9uOiBhLmdldEF0dHJpYkxvY2F0aW9uKHQsIHIpLAogICAgICBsb2NhdGlvblNpemU6IG8KICAgIH07CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIHJvKGEpIHsKICByZXR1cm4gYSAhPT0gIiI7Cn0KZnVuY3Rpb24gUW0oYSwgdCkgewogIGNvbnN0IGUgPSB0Lm51bVNwb3RMaWdodFNoYWRvd3MgKyB0Lm51bVNwb3RMaWdodE1hcHMgLSB0Lm51bVNwb3RMaWdodFNoYWRvd3NXaXRoTWFwczsKICByZXR1cm4gYS5yZXBsYWNlKC9OVU1fRElSX0xJR0hUUy9nLCB0Lm51bURpckxpZ2h0cykucmVwbGFjZSgvTlVNX1NQT1RfTElHSFRTL2csIHQubnVtU3BvdExpZ2h0cykucmVwbGFjZSgvTlVNX1NQT1RfTElHSFRfTUFQUy9nLCB0Lm51bVNwb3RMaWdodE1hcHMpLnJlcGxhY2UoL05VTV9TUE9UX0xJR0hUX0NPT1JEUy9nLCBlKS5yZXBsYWNlKC9OVU1fUkVDVF9BUkVBX0xJR0hUUy9nLCB0Lm51bVJlY3RBcmVhTGlnaHRzKS5yZXBsYWNlKC9OVU1fUE9JTlRfTElHSFRTL2csIHQubnVtUG9pbnRMaWdodHMpLnJlcGxhY2UoL05VTV9IRU1JX0xJR0hUUy9nLCB0Lm51bUhlbWlMaWdodHMpLnJlcGxhY2UoL05VTV9ESVJfTElHSFRfU0hBRE9XUy9nLCB0Lm51bURpckxpZ2h0U2hhZG93cykucmVwbGFjZSgvTlVNX1NQT1RfTElHSFRfU0hBRE9XU19XSVRIX01BUFMvZywgdC5udW1TcG90TGlnaHRTaGFkb3dzV2l0aE1hcHMpLnJlcGxhY2UoL05VTV9TUE9UX0xJR0hUX1NIQURPV1MvZywgdC5udW1TcG90TGlnaHRTaGFkb3dzKS5yZXBsYWNlKC9OVU1fUE9JTlRfTElHSFRfU0hBRE9XUy9nLCB0Lm51bVBvaW50TGlnaHRTaGFkb3dzKTsKfQpmdW5jdGlvbiB0ZyhhLCB0KSB7CiAgcmV0dXJuIGEucmVwbGFjZSgvTlVNX0NMSVBQSU5HX1BMQU5FUy9nLCB0Lm51bUNsaXBwaW5nUGxhbmVzKS5yZXBsYWNlKC9VTklPTl9DTElQUElOR19QTEFORVMvZywgdC5udW1DbGlwcGluZ1BsYW5lcyAtIHQubnVtQ2xpcEludGVyc2VjdGlvbik7Cn0KY29uc3QgVkEgPSAvXlsgXHRdKiNpbmNsdWRlICs8KFtcd1xkLi9dKyk+L2dtOwpmdW5jdGlvbiBjcChhKSB7CiAgcmV0dXJuIGEucmVwbGFjZShWQSwgR0EpOwp9CmNvbnN0IEhBID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKZnVuY3Rpb24gR0EoYSwgdCkgewogIGxldCBlID0gWnRbdF07CiAgaWYgKGUgPT09IHZvaWQgMCkgewogICAgY29uc3QgaSA9IEhBLmdldCh0KTsKICAgIGlmIChpICE9PSB2b2lkIDApCiAgICAgIGUgPSBadFtpXSwgY29uc29sZS53YXJuKCdUSFJFRS5XZWJHTFJlbmRlcmVyOiBTaGFkZXIgY2h1bmsgIiVzIiBoYXMgYmVlbiBkZXByZWNhdGVkLiBVc2UgIiVzIiBpbnN0ZWFkLicsIHQsIGkpOwogICAgZWxzZQogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBub3QgcmVzb2x2ZSAjaW5jbHVkZSA8IiArIHQgKyAiPiIpOwogIH0KICByZXR1cm4gY3AoZSk7Cn0KY29uc3QgV0EgPSAvI3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxzK2ZvclxzKlwoXHMqaW50XHMraVxzKj1ccyooXGQrKVxzKjtccyppXHMqPFxzKihcZCspXHMqO1xzKmlccypcK1wrXHMqXClccyp7KFtcc1xTXSs/KX1ccysjcHJhZ21hIHVucm9sbF9sb29wX2VuZC9nOwpmdW5jdGlvbiBlZyhhKSB7CiAgcmV0dXJuIGEucmVwbGFjZShXQSwgcUEpOwp9CmZ1bmN0aW9uIHFBKGEsIHQsIGUsIGkpIHsKICBsZXQgbiA9ICIiOwogIGZvciAobGV0IHMgPSBwYXJzZUludCh0KTsgcyA8IHBhcnNlSW50KGUpOyBzKyspCiAgICBuICs9IGkucmVwbGFjZSgvXFtccyppXHMqXF0vZywgIlsgIiArIHMgKyAiIF0iKS5yZXBsYWNlKC9VTlJPTExFRF9MT09QX0lOREVYL2csIHMpOwogIHJldHVybiBuOwp9CmZ1bmN0aW9uIGlnKGEpIHsKICBsZXQgdCA9IGBwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gZmxvYXQ7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gaW50OwoJcHJlY2lzaW9uICR7YS5wcmVjaXNpb259IHNhbXBsZXIyRDsKCXByZWNpc2lvbiAke2EucHJlY2lzaW9ufSBzYW1wbGVyQ3ViZTsKCXByZWNpc2lvbiAke2EucHJlY2lzaW9ufSBzYW1wbGVyM0Q7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gc2FtcGxlcjJEQXJyYXk7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gc2FtcGxlcjJEU2hhZG93OwoJcHJlY2lzaW9uICR7YS5wcmVjaXNpb259IHNhbXBsZXJDdWJlU2hhZG93OwoJcHJlY2lzaW9uICR7YS5wcmVjaXNpb259IHNhbXBsZXIyREFycmF5U2hhZG93OwoJcHJlY2lzaW9uICR7YS5wcmVjaXNpb259IGlzYW1wbGVyMkQ7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gaXNhbXBsZXIzRDsKCXByZWNpc2lvbiAke2EucHJlY2lzaW9ufSBpc2FtcGxlckN1YmU7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gaXNhbXBsZXIyREFycmF5OwoJcHJlY2lzaW9uICR7YS5wcmVjaXNpb259IHVzYW1wbGVyMkQ7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gdXNhbXBsZXIzRDsKCXByZWNpc2lvbiAke2EucHJlY2lzaW9ufSB1c2FtcGxlckN1YmU7CglwcmVjaXNpb24gJHthLnByZWNpc2lvbn0gdXNhbXBsZXIyREFycmF5OwoJYDsKICByZXR1cm4gYS5wcmVjaXNpb24gPT09ICJoaWdocCIgPyB0ICs9IGAKI2RlZmluZSBISUdIX1BSRUNJU0lPTmAgOiBhLnByZWNpc2lvbiA9PT0gIm1lZGl1bXAiID8gdCArPSBgCiNkZWZpbmUgTUVESVVNX1BSRUNJU0lPTmAgOiBhLnByZWNpc2lvbiA9PT0gImxvd3AiICYmICh0ICs9IGAKI2RlZmluZSBMT1dfUFJFQ0lTSU9OYCksIHQ7Cn0KZnVuY3Rpb24gJEEoYSkgewogIGxldCB0ID0gIlNIQURPV01BUF9UWVBFX0JBU0lDIjsKICByZXR1cm4gYS5zaGFkb3dNYXBUeXBlID09PSBNcCA/IHQgPSAiU0hBRE9XTUFQX1RZUEVfUENGIiA6IGEuc2hhZG93TWFwVHlwZSA9PT0gRTAgPyB0ID0gIlNIQURPV01BUF9UWVBFX1BDRl9TT0ZUIiA6IGEuc2hhZG93TWFwVHlwZSA9PT0gU24gJiYgKHQgPSAiU0hBRE9XTUFQX1RZUEVfVlNNIiksIHQ7Cn0KZnVuY3Rpb24gWEEoYSkgewogIGxldCB0ID0gIkVOVk1BUF9UWVBFX0NVQkUiOwogIGlmIChhLmVudk1hcCkKICAgIHN3aXRjaCAoYS5lbnZNYXBNb2RlKSB7CiAgICAgIGNhc2UgaXM6CiAgICAgIGNhc2UgVHM6CiAgICAgICAgdCA9ICJFTlZNQVBfVFlQRV9DVUJFIjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBTYToKICAgICAgICB0ID0gIkVOVk1BUF9UWVBFX0NVQkVfVVYiOwogICAgICAgIGJyZWFrOwogICAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIFlBKGEpIHsKICBsZXQgdCA9ICJFTlZNQVBfTU9ERV9SRUZMRUNUSU9OIjsKICBpZiAoYS5lbnZNYXApCiAgICBzd2l0Y2ggKGEuZW52TWFwTW9kZSkgewogICAgICBjYXNlIFRzOgogICAgICAgIHQgPSAiRU5WTUFQX01PREVfUkVGUkFDVElPTiI7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gWkEoYSkgewogIGxldCB0ID0gIkVOVk1BUF9CTEVORElOR19OT05FIjsKICBpZiAoYS5lbnZNYXApCiAgICBzd2l0Y2ggKGEuY29tYmluZSkgewogICAgICBjYXNlIHpvOgogICAgICAgIHQgPSAiRU5WTUFQX0JMRU5ESU5HX01VTFRJUExZIjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBxMDoKICAgICAgICB0ID0gIkVOVk1BUF9CTEVORElOR19NSVgiOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICQwOgogICAgICAgIHQgPSAiRU5WTUFQX0JMRU5ESU5HX0FERCI7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gakEoYSkgewogIGNvbnN0IHQgPSBhLmVudk1hcEN1YmVVVkhlaWdodDsKICBpZiAodCA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgY29uc3QgZSA9IE1hdGgubG9nMih0KSAtIDIsIGkgPSAxIC8gdDsKICByZXR1cm4geyB0ZXhlbFdpZHRoOiAxIC8gKDMgKiBNYXRoLm1heChNYXRoLnBvdygyLCBlKSwgNyAqIDE2KSksIHRleGVsSGVpZ2h0OiBpLCBtYXhNaXA6IGUgfTsKfQpmdW5jdGlvbiBKQShhLCB0LCBlLCBpKSB7CiAgY29uc3QgbiA9IGEuZ2V0Q29udGV4dCgpLCBzID0gZS5kZWZpbmVzOwogIGxldCByID0gZS52ZXJ0ZXhTaGFkZXIsIG8gPSBlLmZyYWdtZW50U2hhZGVyOwogIGNvbnN0IGwgPSAkQShlKSwgaCA9IFhBKGUpLCBjID0gWUEoZSksIHUgPSBaQShlKSwgZCA9IGpBKGUpLCBwID0gTkEoZSksIGYgPSBPQShzKSwgeSA9IG4uY3JlYXRlUHJvZ3JhbSgpOwogIGxldCBnLCBtLCB2ID0gZS5nbHNsVmVyc2lvbiA/ICIjdmVyc2lvbiAiICsgZS5nbHNsVmVyc2lvbiArIGAKYCA6ICIiOwogIGUuaXNSYXdTaGFkZXJNYXRlcmlhbCA/IChnID0gWwogICAgIiNkZWZpbmUgU0hBREVSX1RZUEUgIiArIGUuc2hhZGVyVHlwZSwKICAgICIjZGVmaW5lIFNIQURFUl9OQU1FICIgKyBlLnNoYWRlck5hbWUsCiAgICBmCiAgXS5maWx0ZXIocm8pLmpvaW4oYApgKSwgZy5sZW5ndGggPiAwICYmIChnICs9IGAKYCksIG0gPSBbCiAgICAiI2RlZmluZSBTSEFERVJfVFlQRSAiICsgZS5zaGFkZXJUeXBlLAogICAgIiNkZWZpbmUgU0hBREVSX05BTUUgIiArIGUuc2hhZGVyTmFtZSwKICAgIGYKICBdLmZpbHRlcihybykuam9pbihgCmApLCBtLmxlbmd0aCA+IDAgJiYgKG0gKz0gYApgKSkgOiAoZyA9IFsKICAgIGlnKGUpLAogICAgIiNkZWZpbmUgU0hBREVSX1RZUEUgIiArIGUuc2hhZGVyVHlwZSwKICAgICIjZGVmaW5lIFNIQURFUl9OQU1FICIgKyBlLnNoYWRlck5hbWUsCiAgICBmLAogICAgZS5leHRlbnNpb25DbGlwQ3VsbERpc3RhbmNlID8gIiNkZWZpbmUgVVNFX0NMSVBfRElTVEFOQ0UiIDogIiIsCiAgICBlLmJhdGNoaW5nID8gIiNkZWZpbmUgVVNFX0JBVENISU5HIiA6ICIiLAogICAgZS5iYXRjaGluZ0NvbG9yID8gIiNkZWZpbmUgVVNFX0JBVENISU5HX0NPTE9SIiA6ICIiLAogICAgZS5pbnN0YW5jaW5nID8gIiNkZWZpbmUgVVNFX0lOU1RBTkNJTkciIDogIiIsCiAgICBlLmluc3RhbmNpbmdDb2xvciA/ICIjZGVmaW5lIFVTRV9JTlNUQU5DSU5HX0NPTE9SIiA6ICIiLAogICAgZS5pbnN0YW5jaW5nTW9ycGggPyAiI2RlZmluZSBVU0VfSU5TVEFOQ0lOR19NT1JQSCIgOiAiIiwKICAgIGUudXNlRm9nICYmIGUuZm9nID8gIiNkZWZpbmUgVVNFX0ZPRyIgOiAiIiwKICAgIGUudXNlRm9nICYmIGUuZm9nRXhwMiA/ICIjZGVmaW5lIEZPR19FWFAyIiA6ICIiLAogICAgZS5tYXAgPyAiI2RlZmluZSBVU0VfTUFQIiA6ICIiLAogICAgZS5lbnZNYXAgPyAiI2RlZmluZSBVU0VfRU5WTUFQIiA6ICIiLAogICAgZS5lbnZNYXAgPyAiI2RlZmluZSAiICsgYyA6ICIiLAogICAgZS5saWdodE1hcCA/ICIjZGVmaW5lIFVTRV9MSUdIVE1BUCIgOiAiIiwKICAgIGUuYW9NYXAgPyAiI2RlZmluZSBVU0VfQU9NQVAiIDogIiIsCiAgICBlLmJ1bXBNYXAgPyAiI2RlZmluZSBVU0VfQlVNUE1BUCIgOiAiIiwKICAgIGUubm9ybWFsTWFwID8gIiNkZWZpbmUgVVNFX05PUk1BTE1BUCIgOiAiIiwKICAgIGUubm9ybWFsTWFwT2JqZWN0U3BhY2UgPyAiI2RlZmluZSBVU0VfTk9STUFMTUFQX09CSkVDVFNQQUNFIiA6ICIiLAogICAgZS5ub3JtYWxNYXBUYW5nZW50U3BhY2UgPyAiI2RlZmluZSBVU0VfTk9STUFMTUFQX1RBTkdFTlRTUEFDRSIgOiAiIiwKICAgIGUuZGlzcGxhY2VtZW50TWFwID8gIiNkZWZpbmUgVVNFX0RJU1BMQUNFTUVOVE1BUCIgOiAiIiwKICAgIGUuZW1pc3NpdmVNYXAgPyAiI2RlZmluZSBVU0VfRU1JU1NJVkVNQVAiIDogIiIsCiAgICBlLmFuaXNvdHJvcHkgPyAiI2RlZmluZSBVU0VfQU5JU09UUk9QWSIgOiAiIiwKICAgIGUuYW5pc290cm9weU1hcCA/ICIjZGVmaW5lIFVTRV9BTklTT1RST1BZTUFQIiA6ICIiLAogICAgZS5jbGVhcmNvYXRNYXAgPyAiI2RlZmluZSBVU0VfQ0xFQVJDT0FUTUFQIiA6ICIiLAogICAgZS5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgPyAiI2RlZmluZSBVU0VfQ0xFQVJDT0FUX1JPVUdITkVTU01BUCIgOiAiIiwKICAgIGUuY2xlYXJjb2F0Tm9ybWFsTWFwID8gIiNkZWZpbmUgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVAiIDogIiIsCiAgICBlLmlyaWRlc2NlbmNlTWFwID8gIiNkZWZpbmUgVVNFX0lSSURFU0NFTkNFTUFQIiA6ICIiLAogICAgZS5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCA/ICIjZGVmaW5lIFVTRV9JUklERVNDRU5DRV9USElDS05FU1NNQVAiIDogIiIsCiAgICBlLnNwZWN1bGFyTWFwID8gIiNkZWZpbmUgVVNFX1NQRUNVTEFSTUFQIiA6ICIiLAogICAgZS5zcGVjdWxhckNvbG9yTWFwID8gIiNkZWZpbmUgVVNFX1NQRUNVTEFSX0NPTE9STUFQIiA6ICIiLAogICAgZS5zcGVjdWxhckludGVuc2l0eU1hcCA/ICIjZGVmaW5lIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVAiIDogIiIsCiAgICBlLnJvdWdobmVzc01hcCA/ICIjZGVmaW5lIFVTRV9ST1VHSE5FU1NNQVAiIDogIiIsCiAgICBlLm1ldGFsbmVzc01hcCA/ICIjZGVmaW5lIFVTRV9NRVRBTE5FU1NNQVAiIDogIiIsCiAgICBlLmFscGhhTWFwID8gIiNkZWZpbmUgVVNFX0FMUEhBTUFQIiA6ICIiLAogICAgZS5hbHBoYUhhc2ggPyAiI2RlZmluZSBVU0VfQUxQSEFIQVNIIiA6ICIiLAogICAgZS50cmFuc21pc3Npb24gPyAiI2RlZmluZSBVU0VfVFJBTlNNSVNTSU9OIiA6ICIiLAogICAgZS50cmFuc21pc3Npb25NYXAgPyAiI2RlZmluZSBVU0VfVFJBTlNNSVNTSU9OTUFQIiA6ICIiLAogICAgZS50aGlja25lc3NNYXAgPyAiI2RlZmluZSBVU0VfVEhJQ0tORVNTTUFQIiA6ICIiLAogICAgZS5zaGVlbkNvbG9yTWFwID8gIiNkZWZpbmUgVVNFX1NIRUVOX0NPTE9STUFQIiA6ICIiLAogICAgZS5zaGVlblJvdWdobmVzc01hcCA/ICIjZGVmaW5lIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVAiIDogIiIsCiAgICAvLwogICAgZS5tYXBVdiA/ICIjZGVmaW5lIE1BUF9VViAiICsgZS5tYXBVdiA6ICIiLAogICAgZS5hbHBoYU1hcFV2ID8gIiNkZWZpbmUgQUxQSEFNQVBfVVYgIiArIGUuYWxwaGFNYXBVdiA6ICIiLAogICAgZS5saWdodE1hcFV2ID8gIiNkZWZpbmUgTElHSFRNQVBfVVYgIiArIGUubGlnaHRNYXBVdiA6ICIiLAogICAgZS5hb01hcFV2ID8gIiNkZWZpbmUgQU9NQVBfVVYgIiArIGUuYW9NYXBVdiA6ICIiLAogICAgZS5lbWlzc2l2ZU1hcFV2ID8gIiNkZWZpbmUgRU1JU1NJVkVNQVBfVVYgIiArIGUuZW1pc3NpdmVNYXBVdiA6ICIiLAogICAgZS5idW1wTWFwVXYgPyAiI2RlZmluZSBCVU1QTUFQX1VWICIgKyBlLmJ1bXBNYXBVdiA6ICIiLAogICAgZS5ub3JtYWxNYXBVdiA/ICIjZGVmaW5lIE5PUk1BTE1BUF9VViAiICsgZS5ub3JtYWxNYXBVdiA6ICIiLAogICAgZS5kaXNwbGFjZW1lbnRNYXBVdiA/ICIjZGVmaW5lIERJU1BMQUNFTUVOVE1BUF9VViAiICsgZS5kaXNwbGFjZW1lbnRNYXBVdiA6ICIiLAogICAgZS5tZXRhbG5lc3NNYXBVdiA/ICIjZGVmaW5lIE1FVEFMTkVTU01BUF9VViAiICsgZS5tZXRhbG5lc3NNYXBVdiA6ICIiLAogICAgZS5yb3VnaG5lc3NNYXBVdiA/ICIjZGVmaW5lIFJPVUdITkVTU01BUF9VViAiICsgZS5yb3VnaG5lc3NNYXBVdiA6ICIiLAogICAgZS5hbmlzb3Ryb3B5TWFwVXYgPyAiI2RlZmluZSBBTklTT1RST1BZTUFQX1VWICIgKyBlLmFuaXNvdHJvcHlNYXBVdiA6ICIiLAogICAgZS5jbGVhcmNvYXRNYXBVdiA/ICIjZGVmaW5lIENMRUFSQ09BVE1BUF9VViAiICsgZS5jbGVhcmNvYXRNYXBVdiA6ICIiLAogICAgZS5jbGVhcmNvYXROb3JtYWxNYXBVdiA/ICIjZGVmaW5lIENMRUFSQ09BVF9OT1JNQUxNQVBfVVYgIiArIGUuY2xlYXJjb2F0Tm9ybWFsTWFwVXYgOiAiIiwKICAgIGUuY2xlYXJjb2F0Um91Z2huZXNzTWFwVXYgPyAiI2RlZmluZSBDTEVBUkNPQVRfUk9VR0hORVNTTUFQX1VWICIgKyBlLmNsZWFyY29hdFJvdWdobmVzc01hcFV2IDogIiIsCiAgICBlLmlyaWRlc2NlbmNlTWFwVXYgPyAiI2RlZmluZSBJUklERVNDRU5DRU1BUF9VViAiICsgZS5pcmlkZXNjZW5jZU1hcFV2IDogIiIsCiAgICBlLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVXYgPyAiI2RlZmluZSBJUklERVNDRU5DRV9USElDS05FU1NNQVBfVVYgIiArIGUuaXJpZGVzY2VuY2VUaGlja25lc3NNYXBVdiA6ICIiLAogICAgZS5zaGVlbkNvbG9yTWFwVXYgPyAiI2RlZmluZSBTSEVFTl9DT0xPUk1BUF9VViAiICsgZS5zaGVlbkNvbG9yTWFwVXYgOiAiIiwKICAgIGUuc2hlZW5Sb3VnaG5lc3NNYXBVdiA/ICIjZGVmaW5lIFNIRUVOX1JPVUdITkVTU01BUF9VViAiICsgZS5zaGVlblJvdWdobmVzc01hcFV2IDogIiIsCiAgICBlLnNwZWN1bGFyTWFwVXYgPyAiI2RlZmluZSBTUEVDVUxBUk1BUF9VViAiICsgZS5zcGVjdWxhck1hcFV2IDogIiIsCiAgICBlLnNwZWN1bGFyQ29sb3JNYXBVdiA/ICIjZGVmaW5lIFNQRUNVTEFSX0NPTE9STUFQX1VWICIgKyBlLnNwZWN1bGFyQ29sb3JNYXBVdiA6ICIiLAogICAgZS5zcGVjdWxhckludGVuc2l0eU1hcFV2ID8gIiNkZWZpbmUgU1BFQ1VMQVJfSU5URU5TSVRZTUFQX1VWICIgKyBlLnNwZWN1bGFySW50ZW5zaXR5TWFwVXYgOiAiIiwKICAgIGUudHJhbnNtaXNzaW9uTWFwVXYgPyAiI2RlZmluZSBUUkFOU01JU1NJT05NQVBfVVYgIiArIGUudHJhbnNtaXNzaW9uTWFwVXYgOiAiIiwKICAgIGUudGhpY2tuZXNzTWFwVXYgPyAiI2RlZmluZSBUSElDS05FU1NNQVBfVVYgIiArIGUudGhpY2tuZXNzTWFwVXYgOiAiIiwKICAgIC8vCiAgICBlLnZlcnRleFRhbmdlbnRzICYmIGUuZmxhdFNoYWRpbmcgPT09ICExID8gIiNkZWZpbmUgVVNFX1RBTkdFTlQiIDogIiIsCiAgICBlLnZlcnRleENvbG9ycyA/ICIjZGVmaW5lIFVTRV9DT0xPUiIgOiAiIiwKICAgIGUudmVydGV4QWxwaGFzID8gIiNkZWZpbmUgVVNFX0NPTE9SX0FMUEhBIiA6ICIiLAogICAgZS52ZXJ0ZXhVdjFzID8gIiNkZWZpbmUgVVNFX1VWMSIgOiAiIiwKICAgIGUudmVydGV4VXYycyA/ICIjZGVmaW5lIFVTRV9VVjIiIDogIiIsCiAgICBlLnZlcnRleFV2M3MgPyAiI2RlZmluZSBVU0VfVVYzIiA6ICIiLAogICAgZS5wb2ludHNVdnMgPyAiI2RlZmluZSBVU0VfUE9JTlRTX1VWIiA6ICIiLAogICAgZS5mbGF0U2hhZGluZyA/ICIjZGVmaW5lIEZMQVRfU0hBREVEIiA6ICIiLAogICAgZS5za2lubmluZyA/ICIjZGVmaW5lIFVTRV9TS0lOTklORyIgOiAiIiwKICAgIGUubW9ycGhUYXJnZXRzID8gIiNkZWZpbmUgVVNFX01PUlBIVEFSR0VUUyIgOiAiIiwKICAgIGUubW9ycGhOb3JtYWxzICYmIGUuZmxhdFNoYWRpbmcgPT09ICExID8gIiNkZWZpbmUgVVNFX01PUlBITk9STUFMUyIgOiAiIiwKICAgIGUubW9ycGhDb2xvcnMgPyAiI2RlZmluZSBVU0VfTU9SUEhDT0xPUlMiIDogIiIsCiAgICBlLm1vcnBoVGFyZ2V0c0NvdW50ID4gMCA/ICIjZGVmaW5lIE1PUlBIVEFSR0VUU19URVhUVVJFX1NUUklERSAiICsgZS5tb3JwaFRleHR1cmVTdHJpZGUgOiAiIiwKICAgIGUubW9ycGhUYXJnZXRzQ291bnQgPiAwID8gIiNkZWZpbmUgTU9SUEhUQVJHRVRTX0NPVU5UICIgKyBlLm1vcnBoVGFyZ2V0c0NvdW50IDogIiIsCiAgICBlLmRvdWJsZVNpZGVkID8gIiNkZWZpbmUgRE9VQkxFX1NJREVEIiA6ICIiLAogICAgZS5mbGlwU2lkZWQgPyAiI2RlZmluZSBGTElQX1NJREVEIiA6ICIiLAogICAgZS5zaGFkb3dNYXBFbmFibGVkID8gIiNkZWZpbmUgVVNFX1NIQURPV01BUCIgOiAiIiwKICAgIGUuc2hhZG93TWFwRW5hYmxlZCA/ICIjZGVmaW5lICIgKyBsIDogIiIsCiAgICBlLnNpemVBdHRlbnVhdGlvbiA/ICIjZGVmaW5lIFVTRV9TSVpFQVRURU5VQVRJT04iIDogIiIsCiAgICBlLm51bUxpZ2h0UHJvYmVzID4gMCA/ICIjZGVmaW5lIFVTRV9MSUdIVF9QUk9CRVMiIDogIiIsCiAgICBlLmxvZ2FyaXRobWljRGVwdGhCdWZmZXIgPyAiI2RlZmluZSBVU0VfTE9HQVJJVEhNSUNfREVQVEhfQlVGRkVSIiA6ICIiLAogICAgZS5yZXZlcnNlZERlcHRoQnVmZmVyID8gIiNkZWZpbmUgVVNFX1JFVkVSU0VEX0RFUFRIX0JVRkZFUiIgOiAiIiwKICAgICJ1bmlmb3JtIG1hdDQgbW9kZWxNYXRyaXg7IiwKICAgICJ1bmlmb3JtIG1hdDQgbW9kZWxWaWV3TWF0cml4OyIsCiAgICAidW5pZm9ybSBtYXQ0IHByb2plY3Rpb25NYXRyaXg7IiwKICAgICJ1bmlmb3JtIG1hdDQgdmlld01hdHJpeDsiLAogICAgInVuaWZvcm0gbWF0MyBub3JtYWxNYXRyaXg7IiwKICAgICJ1bmlmb3JtIHZlYzMgY2FtZXJhUG9zaXRpb247IiwKICAgICJ1bmlmb3JtIGJvb2wgaXNPcnRob2dyYXBoaWM7IiwKICAgICIjaWZkZWYgVVNFX0lOU1RBTkNJTkciLAogICAgIglhdHRyaWJ1dGUgbWF0NCBpbnN0YW5jZU1hdHJpeDsiLAogICAgIiNlbmRpZiIsCiAgICAiI2lmZGVmIFVTRV9JTlNUQU5DSU5HX0NPTE9SIiwKICAgICIJYXR0cmlidXRlIHZlYzMgaW5zdGFuY2VDb2xvcjsiLAogICAgIiNlbmRpZiIsCiAgICAiI2lmZGVmIFVTRV9JTlNUQU5DSU5HX01PUlBIIiwKICAgICIJdW5pZm9ybSBzYW1wbGVyMkQgbW9ycGhUZXh0dXJlOyIsCiAgICAiI2VuZGlmIiwKICAgICJhdHRyaWJ1dGUgdmVjMyBwb3NpdGlvbjsiLAogICAgImF0dHJpYnV0ZSB2ZWMzIG5vcm1hbDsiLAogICAgImF0dHJpYnV0ZSB2ZWMyIHV2OyIsCiAgICAiI2lmZGVmIFVTRV9VVjEiLAogICAgIglhdHRyaWJ1dGUgdmVjMiB1djE7IiwKICAgICIjZW5kaWYiLAogICAgIiNpZmRlZiBVU0VfVVYyIiwKICAgICIJYXR0cmlidXRlIHZlYzIgdXYyOyIsCiAgICAiI2VuZGlmIiwKICAgICIjaWZkZWYgVVNFX1VWMyIsCiAgICAiCWF0dHJpYnV0ZSB2ZWMyIHV2MzsiLAogICAgIiNlbmRpZiIsCiAgICAiI2lmZGVmIFVTRV9UQU5HRU5UIiwKICAgICIJYXR0cmlidXRlIHZlYzQgdGFuZ2VudDsiLAogICAgIiNlbmRpZiIsCiAgICAiI2lmIGRlZmluZWQoIFVTRV9DT0xPUl9BTFBIQSApIiwKICAgICIJYXR0cmlidXRlIHZlYzQgY29sb3I7IiwKICAgICIjZWxpZiBkZWZpbmVkKCBVU0VfQ09MT1IgKSIsCiAgICAiCWF0dHJpYnV0ZSB2ZWMzIGNvbG9yOyIsCiAgICAiI2VuZGlmIiwKICAgICIjaWZkZWYgVVNFX1NLSU5OSU5HIiwKICAgICIJYXR0cmlidXRlIHZlYzQgc2tpbkluZGV4OyIsCiAgICAiCWF0dHJpYnV0ZSB2ZWM0IHNraW5XZWlnaHQ7IiwKICAgICIjZW5kaWYiLAogICAgYApgCiAgXS5maWx0ZXIocm8pLmpvaW4oYApgKSwgbSA9IFsKICAgIGlnKGUpLAogICAgIiNkZWZpbmUgU0hBREVSX1RZUEUgIiArIGUuc2hhZGVyVHlwZSwKICAgICIjZGVmaW5lIFNIQURFUl9OQU1FICIgKyBlLnNoYWRlck5hbWUsCiAgICBmLAogICAgZS51c2VGb2cgJiYgZS5mb2cgPyAiI2RlZmluZSBVU0VfRk9HIiA6ICIiLAogICAgZS51c2VGb2cgJiYgZS5mb2dFeHAyID8gIiNkZWZpbmUgRk9HX0VYUDIiIDogIiIsCiAgICBlLmFscGhhVG9Db3ZlcmFnZSA/ICIjZGVmaW5lIEFMUEhBX1RPX0NPVkVSQUdFIiA6ICIiLAogICAgZS5tYXAgPyAiI2RlZmluZSBVU0VfTUFQIiA6ICIiLAogICAgZS5tYXRjYXAgPyAiI2RlZmluZSBVU0VfTUFUQ0FQIiA6ICIiLAogICAgZS5lbnZNYXAgPyAiI2RlZmluZSBVU0VfRU5WTUFQIiA6ICIiLAogICAgZS5lbnZNYXAgPyAiI2RlZmluZSAiICsgaCA6ICIiLAogICAgZS5lbnZNYXAgPyAiI2RlZmluZSAiICsgYyA6ICIiLAogICAgZS5lbnZNYXAgPyAiI2RlZmluZSAiICsgdSA6ICIiLAogICAgZCA/ICIjZGVmaW5lIENVQkVVVl9URVhFTF9XSURUSCAiICsgZC50ZXhlbFdpZHRoIDogIiIsCiAgICBkID8gIiNkZWZpbmUgQ1VCRVVWX1RFWEVMX0hFSUdIVCAiICsgZC50ZXhlbEhlaWdodCA6ICIiLAogICAgZCA/ICIjZGVmaW5lIENVQkVVVl9NQVhfTUlQICIgKyBkLm1heE1pcCArICIuMCIgOiAiIiwKICAgIGUubGlnaHRNYXAgPyAiI2RlZmluZSBVU0VfTElHSFRNQVAiIDogIiIsCiAgICBlLmFvTWFwID8gIiNkZWZpbmUgVVNFX0FPTUFQIiA6ICIiLAogICAgZS5idW1wTWFwID8gIiNkZWZpbmUgVVNFX0JVTVBNQVAiIDogIiIsCiAgICBlLm5vcm1hbE1hcCA/ICIjZGVmaW5lIFVTRV9OT1JNQUxNQVAiIDogIiIsCiAgICBlLm5vcm1hbE1hcE9iamVjdFNwYWNlID8gIiNkZWZpbmUgVVNFX05PUk1BTE1BUF9PQkpFQ1RTUEFDRSIgOiAiIiwKICAgIGUubm9ybWFsTWFwVGFuZ2VudFNwYWNlID8gIiNkZWZpbmUgVVNFX05PUk1BTE1BUF9UQU5HRU5UU1BBQ0UiIDogIiIsCiAgICBlLmVtaXNzaXZlTWFwID8gIiNkZWZpbmUgVVNFX0VNSVNTSVZFTUFQIiA6ICIiLAogICAgZS5hbmlzb3Ryb3B5ID8gIiNkZWZpbmUgVVNFX0FOSVNPVFJPUFkiIDogIiIsCiAgICBlLmFuaXNvdHJvcHlNYXAgPyAiI2RlZmluZSBVU0VfQU5JU09UUk9QWU1BUCIgOiAiIiwKICAgIGUuY2xlYXJjb2F0ID8gIiNkZWZpbmUgVVNFX0NMRUFSQ09BVCIgOiAiIiwKICAgIGUuY2xlYXJjb2F0TWFwID8gIiNkZWZpbmUgVVNFX0NMRUFSQ09BVE1BUCIgOiAiIiwKICAgIGUuY2xlYXJjb2F0Um91Z2huZXNzTWFwID8gIiNkZWZpbmUgVVNFX0NMRUFSQ09BVF9ST1VHSE5FU1NNQVAiIDogIiIsCiAgICBlLmNsZWFyY29hdE5vcm1hbE1hcCA/ICIjZGVmaW5lIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQIiA6ICIiLAogICAgZS5kaXNwZXJzaW9uID8gIiNkZWZpbmUgVVNFX0RJU1BFUlNJT04iIDogIiIsCiAgICBlLmlyaWRlc2NlbmNlID8gIiNkZWZpbmUgVVNFX0lSSURFU0NFTkNFIiA6ICIiLAogICAgZS5pcmlkZXNjZW5jZU1hcCA/ICIjZGVmaW5lIFVTRV9JUklERVNDRU5DRU1BUCIgOiAiIiwKICAgIGUuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgPyAiI2RlZmluZSBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQIiA6ICIiLAogICAgZS5zcGVjdWxhck1hcCA/ICIjZGVmaW5lIFVTRV9TUEVDVUxBUk1BUCIgOiAiIiwKICAgIGUuc3BlY3VsYXJDb2xvck1hcCA/ICIjZGVmaW5lIFVTRV9TUEVDVUxBUl9DT0xPUk1BUCIgOiAiIiwKICAgIGUuc3BlY3VsYXJJbnRlbnNpdHlNYXAgPyAiI2RlZmluZSBVU0VfU1BFQ1VMQVJfSU5URU5TSVRZTUFQIiA6ICIiLAogICAgZS5yb3VnaG5lc3NNYXAgPyAiI2RlZmluZSBVU0VfUk9VR0hORVNTTUFQIiA6ICIiLAogICAgZS5tZXRhbG5lc3NNYXAgPyAiI2RlZmluZSBVU0VfTUVUQUxORVNTTUFQIiA6ICIiLAogICAgZS5hbHBoYU1hcCA/ICIjZGVmaW5lIFVTRV9BTFBIQU1BUCIgOiAiIiwKICAgIGUuYWxwaGFUZXN0ID8gIiNkZWZpbmUgVVNFX0FMUEhBVEVTVCIgOiAiIiwKICAgIGUuYWxwaGFIYXNoID8gIiNkZWZpbmUgVVNFX0FMUEhBSEFTSCIgOiAiIiwKICAgIGUuc2hlZW4gPyAiI2RlZmluZSBVU0VfU0hFRU4iIDogIiIsCiAgICBlLnNoZWVuQ29sb3JNYXAgPyAiI2RlZmluZSBVU0VfU0hFRU5fQ09MT1JNQVAiIDogIiIsCiAgICBlLnNoZWVuUm91Z2huZXNzTWFwID8gIiNkZWZpbmUgVVNFX1NIRUVOX1JPVUdITkVTU01BUCIgOiAiIiwKICAgIGUudHJhbnNtaXNzaW9uID8gIiNkZWZpbmUgVVNFX1RSQU5TTUlTU0lPTiIgOiAiIiwKICAgIGUudHJhbnNtaXNzaW9uTWFwID8gIiNkZWZpbmUgVVNFX1RSQU5TTUlTU0lPTk1BUCIgOiAiIiwKICAgIGUudGhpY2tuZXNzTWFwID8gIiNkZWZpbmUgVVNFX1RISUNLTkVTU01BUCIgOiAiIiwKICAgIGUudmVydGV4VGFuZ2VudHMgJiYgZS5mbGF0U2hhZGluZyA9PT0gITEgPyAiI2RlZmluZSBVU0VfVEFOR0VOVCIgOiAiIiwKICAgIGUudmVydGV4Q29sb3JzIHx8IGUuaW5zdGFuY2luZ0NvbG9yIHx8IGUuYmF0Y2hpbmdDb2xvciA/ICIjZGVmaW5lIFVTRV9DT0xPUiIgOiAiIiwKICAgIGUudmVydGV4QWxwaGFzID8gIiNkZWZpbmUgVVNFX0NPTE9SX0FMUEhBIiA6ICIiLAogICAgZS52ZXJ0ZXhVdjFzID8gIiNkZWZpbmUgVVNFX1VWMSIgOiAiIiwKICAgIGUudmVydGV4VXYycyA/ICIjZGVmaW5lIFVTRV9VVjIiIDogIiIsCiAgICBlLnZlcnRleFV2M3MgPyAiI2RlZmluZSBVU0VfVVYzIiA6ICIiLAogICAgZS5wb2ludHNVdnMgPyAiI2RlZmluZSBVU0VfUE9JTlRTX1VWIiA6ICIiLAogICAgZS5ncmFkaWVudE1hcCA/ICIjZGVmaW5lIFVTRV9HUkFESUVOVE1BUCIgOiAiIiwKICAgIGUuZmxhdFNoYWRpbmcgPyAiI2RlZmluZSBGTEFUX1NIQURFRCIgOiAiIiwKICAgIGUuZG91YmxlU2lkZWQgPyAiI2RlZmluZSBET1VCTEVfU0lERUQiIDogIiIsCiAgICBlLmZsaXBTaWRlZCA/ICIjZGVmaW5lIEZMSVBfU0lERUQiIDogIiIsCiAgICBlLnNoYWRvd01hcEVuYWJsZWQgPyAiI2RlZmluZSBVU0VfU0hBRE9XTUFQIiA6ICIiLAogICAgZS5zaGFkb3dNYXBFbmFibGVkID8gIiNkZWZpbmUgIiArIGwgOiAiIiwKICAgIGUucHJlbXVsdGlwbGllZEFscGhhID8gIiNkZWZpbmUgUFJFTVVMVElQTElFRF9BTFBIQSIgOiAiIiwKICAgIGUubnVtTGlnaHRQcm9iZXMgPiAwID8gIiNkZWZpbmUgVVNFX0xJR0hUX1BST0JFUyIgOiAiIiwKICAgIGUuZGVjb2RlVmlkZW9UZXh0dXJlID8gIiNkZWZpbmUgREVDT0RFX1ZJREVPX1RFWFRVUkUiIDogIiIsCiAgICBlLmRlY29kZVZpZGVvVGV4dHVyZUVtaXNzaXZlID8gIiNkZWZpbmUgREVDT0RFX1ZJREVPX1RFWFRVUkVfRU1JU1NJVkUiIDogIiIsCiAgICBlLmxvZ2FyaXRobWljRGVwdGhCdWZmZXIgPyAiI2RlZmluZSBVU0VfTE9HQVJJVEhNSUNfREVQVEhfQlVGRkVSIiA6ICIiLAogICAgZS5yZXZlcnNlZERlcHRoQnVmZmVyID8gIiNkZWZpbmUgVVNFX1JFVkVSU0VEX0RFUFRIX0JVRkZFUiIgOiAiIiwKICAgICJ1bmlmb3JtIG1hdDQgdmlld01hdHJpeDsiLAogICAgInVuaWZvcm0gdmVjMyBjYW1lcmFQb3NpdGlvbjsiLAogICAgInVuaWZvcm0gYm9vbCBpc09ydGhvZ3JhcGhpYzsiLAogICAgZS50b25lTWFwcGluZyAhPT0gWm4gPyAiI2RlZmluZSBUT05FX01BUFBJTkciIDogIiIsCiAgICBlLnRvbmVNYXBwaW5nICE9PSBabiA/IFp0LnRvbmVtYXBwaW5nX3BhcnNfZnJhZ21lbnQgOiAiIiwKICAgIC8vIHRoaXMgY29kZSBpcyByZXF1aXJlZCBoZXJlIGJlY2F1c2UgaXQgaXMgdXNlZCBieSB0aGUgdG9uZU1hcHBpbmcoKSBmdW5jdGlvbiBkZWZpbmVkIGJlbG93CiAgICBlLnRvbmVNYXBwaW5nICE9PSBabiA/IEJBKCJ0b25lTWFwcGluZyIsIGUudG9uZU1hcHBpbmcpIDogIiIsCiAgICBlLmRpdGhlcmluZyA/ICIjZGVmaW5lIERJVEhFUklORyIgOiAiIiwKICAgIGUub3BhcXVlID8gIiNkZWZpbmUgT1BBUVVFIiA6ICIiLAogICAgWnQuY29sb3JzcGFjZV9wYXJzX2ZyYWdtZW50LAogICAgLy8gdGhpcyBjb2RlIGlzIHJlcXVpcmVkIGhlcmUgYmVjYXVzZSBpdCBpcyB1c2VkIGJ5IHRoZSB2YXJpb3VzIGVuY29kaW5nL2RlY29kaW5nIGZ1bmN0aW9uIGRlZmluZWQgYmVsb3cKICAgIFVBKCJsaW5lYXJUb091dHB1dFRleGVsIiwgZS5vdXRwdXRDb2xvclNwYWNlKSwKICAgIHpBKCksCiAgICBlLnVzZURlcHRoUGFja2luZyA/ICIjZGVmaW5lIERFUFRIX1BBQ0tJTkcgIiArIGUuZGVwdGhQYWNraW5nIDogIiIsCiAgICBgCmAKICBdLmZpbHRlcihybykuam9pbihgCmApKSwgciA9IGNwKHIpLCByID0gUW0ociwgZSksIHIgPSB0ZyhyLCBlKSwgbyA9IGNwKG8pLCBvID0gUW0obywgZSksIG8gPSB0ZyhvLCBlKSwgciA9IGVnKHIpLCBvID0gZWcobyksIGUuaXNSYXdTaGFkZXJNYXRlcmlhbCAhPT0gITAgJiYgKHYgPSBgI3ZlcnNpb24gMzAwIGVzCmAsIGcgPSBbCiAgICBwLAogICAgIiNkZWZpbmUgYXR0cmlidXRlIGluIiwKICAgICIjZGVmaW5lIHZhcnlpbmcgb3V0IiwKICAgICIjZGVmaW5lIHRleHR1cmUyRCB0ZXh0dXJlIgogIF0uam9pbihgCmApICsgYApgICsgZywgbSA9IFsKICAgICIjZGVmaW5lIHZhcnlpbmcgaW4iLAogICAgZS5nbHNsVmVyc2lvbiA9PT0gUWQgPyAiIiA6ICJsYXlvdXQobG9jYXRpb24gPSAwKSBvdXQgaGlnaHAgdmVjNCBwY19mcmFnQ29sb3I7IiwKICAgIGUuZ2xzbFZlcnNpb24gPT09IFFkID8gIiIgOiAiI2RlZmluZSBnbF9GcmFnQ29sb3IgcGNfZnJhZ0NvbG9yIiwKICAgICIjZGVmaW5lIGdsX0ZyYWdEZXB0aEVYVCBnbF9GcmFnRGVwdGgiLAogICAgIiNkZWZpbmUgdGV4dHVyZTJEIHRleHR1cmUiLAogICAgIiNkZWZpbmUgdGV4dHVyZUN1YmUgdGV4dHVyZSIsCiAgICAiI2RlZmluZSB0ZXh0dXJlMkRQcm9qIHRleHR1cmVQcm9qIiwKICAgICIjZGVmaW5lIHRleHR1cmUyRExvZEVYVCB0ZXh0dXJlTG9kIiwKICAgICIjZGVmaW5lIHRleHR1cmUyRFByb2pMb2RFWFQgdGV4dHVyZVByb2pMb2QiLAogICAgIiNkZWZpbmUgdGV4dHVyZUN1YmVMb2RFWFQgdGV4dHVyZUxvZCIsCiAgICAiI2RlZmluZSB0ZXh0dXJlMkRHcmFkRVhUIHRleHR1cmVHcmFkIiwKICAgICIjZGVmaW5lIHRleHR1cmUyRFByb2pHcmFkRVhUIHRleHR1cmVQcm9qR3JhZCIsCiAgICAiI2RlZmluZSB0ZXh0dXJlQ3ViZUdyYWRFWFQgdGV4dHVyZUdyYWQiCiAgXS5qb2luKGAKYCkgKyBgCmAgKyBtKTsKICBjb25zdCB4ID0gdiArIGcgKyByLCBfID0gdiArIG0gKyBvLCBTID0gam0obiwgbi5WRVJURVhfU0hBREVSLCB4KSwgdyA9IGptKG4sIG4uRlJBR01FTlRfU0hBREVSLCBfKTsKICBuLmF0dGFjaFNoYWRlcih5LCBTKSwgbi5hdHRhY2hTaGFkZXIoeSwgdyksIGUuaW5kZXgwQXR0cmlidXRlTmFtZSAhPT0gdm9pZCAwID8gbi5iaW5kQXR0cmliTG9jYXRpb24oeSwgMCwgZS5pbmRleDBBdHRyaWJ1dGVOYW1lKSA6IGUubW9ycGhUYXJnZXRzID09PSAhMCAmJiBuLmJpbmRBdHRyaWJMb2NhdGlvbih5LCAwLCAicG9zaXRpb24iKSwgbi5saW5rUHJvZ3JhbSh5KTsKICBmdW5jdGlvbiBUKEwpIHsKICAgIGlmIChhLmRlYnVnLmNoZWNrU2hhZGVyRXJyb3JzKSB7CiAgICAgIGNvbnN0IFUgPSBuLmdldFByb2dyYW1JbmZvTG9nKHkpIHx8ICIiLCBPID0gbi5nZXRTaGFkZXJJbmZvTG9nKFMpIHx8ICIiLCBWID0gbi5nZXRTaGFkZXJJbmZvTG9nKHcpIHx8ICIiLCBXID0gVS50cmltKCksIEcgPSBPLnRyaW0oKSwgZXQgPSBWLnRyaW0oKTsKICAgICAgbGV0IEggPSAhMCwgYXQgPSAhMDsKICAgICAgaWYgKG4uZ2V0UHJvZ3JhbVBhcmFtZXRlcih5LCBuLkxJTktfU1RBVFVTKSA9PT0gITEpCiAgICAgICAgaWYgKEggPSAhMSwgdHlwZW9mIGEuZGVidWcub25TaGFkZXJFcnJvciA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgYS5kZWJ1Zy5vblNoYWRlckVycm9yKG4sIHksIFMsIHcpOwogICAgICAgIGVsc2UgewogICAgICAgICAgY29uc3QgcHQgPSBLbShuLCBTLCAidmVydGV4IiksIE10ID0gS20obiwgdywgImZyYWdtZW50Iik7CiAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICAiVEhSRUUuV2ViR0xQcm9ncmFtOiBTaGFkZXIgRXJyb3IgIiArIG4uZ2V0RXJyb3IoKSArICIgLSBWQUxJREFURV9TVEFUVVMgIiArIG4uZ2V0UHJvZ3JhbVBhcmFtZXRlcih5LCBuLlZBTElEQVRFX1NUQVRVUykgKyBgCgpNYXRlcmlhbCBOYW1lOiBgICsgTC5uYW1lICsgYApNYXRlcmlhbCBUeXBlOiBgICsgTC50eXBlICsgYAoKUHJvZ3JhbSBJbmZvIExvZzogYCArIFcgKyBgCmAgKyBwdCArIGAKYCArIE10CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgZWxzZSBXICE9PSAiIiA/IGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xQcm9ncmFtOiBQcm9ncmFtIEluZm8gTG9nOiIsIFcpIDogKEcgPT09ICIiIHx8IGV0ID09PSAiIikgJiYgKGF0ID0gITEpOwogICAgICBhdCAmJiAoTC5kaWFnbm9zdGljcyA9IHsKICAgICAgICBydW5uYWJsZTogSCwKICAgICAgICBwcm9ncmFtTG9nOiBXLAogICAgICAgIHZlcnRleFNoYWRlcjogewogICAgICAgICAgbG9nOiBHLAogICAgICAgICAgcHJlZml4OiBnCiAgICAgICAgfSwKICAgICAgICBmcmFnbWVudFNoYWRlcjogewogICAgICAgICAgbG9nOiBldCwKICAgICAgICAgIHByZWZpeDogbQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBuLmRlbGV0ZVNoYWRlcihTKSwgbi5kZWxldGVTaGFkZXIodyksIFIgPSBuZXcgQ2gobiwgeSksIGIgPSBrQShuLCB5KTsKICB9CiAgbGV0IFI7CiAgdGhpcy5nZXRVbmlmb3JtcyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIFIgPT09IHZvaWQgMCAmJiBUKHRoaXMpLCBSOwogIH07CiAgbGV0IGI7CiAgdGhpcy5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYiA9PT0gdm9pZCAwICYmIFQodGhpcyksIGI7CiAgfTsKICBsZXQgTSA9IGUucmVuZGVyZXJFeHRlbnNpb25QYXJhbGxlbFNoYWRlckNvbXBpbGUgPT09ICExOwogIHJldHVybiB0aGlzLmlzUmVhZHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBNID09PSAhMSAmJiAoTSA9IG4uZ2V0UHJvZ3JhbVBhcmFtZXRlcih5LCBJQSkpLCBNOwogIH0sIHRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgaS5yZWxlYXNlU3RhdGVzT2ZQcm9ncmFtKHRoaXMpLCBuLmRlbGV0ZVByb2dyYW0oeSksIHRoaXMucHJvZ3JhbSA9IHZvaWQgMDsKICB9LCB0aGlzLnR5cGUgPSBlLnNoYWRlclR5cGUsIHRoaXMubmFtZSA9IGUuc2hhZGVyTmFtZSwgdGhpcy5pZCA9IExBKyssIHRoaXMuY2FjaGVLZXkgPSB0LCB0aGlzLnVzZWRUaW1lcyA9IDEsIHRoaXMucHJvZ3JhbSA9IHksIHRoaXMudmVydGV4U2hhZGVyID0gUywgdGhpcy5mcmFnbWVudFNoYWRlciA9IHcsIHRoaXM7Cn0KbGV0IEtBID0gMDsKY2xhc3MgUUEgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5zaGFkZXJDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksIHRoaXMubWF0ZXJpYWxDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgfQogIHVwZGF0ZSh0KSB7CiAgICBjb25zdCBlID0gdC52ZXJ0ZXhTaGFkZXIsIGkgPSB0LmZyYWdtZW50U2hhZGVyLCBuID0gdGhpcy5fZ2V0U2hhZGVyU3RhZ2UoZSksIHMgPSB0aGlzLl9nZXRTaGFkZXJTdGFnZShpKSwgciA9IHRoaXMuX2dldFNoYWRlckNhY2hlRm9yTWF0ZXJpYWwodCk7CiAgICByZXR1cm4gci5oYXMobikgPT09ICExICYmIChyLmFkZChuKSwgbi51c2VkVGltZXMrKyksIHIuaGFzKHMpID09PSAhMSAmJiAoci5hZGQocyksIHMudXNlZFRpbWVzKyspLCB0aGlzOwogIH0KICByZW1vdmUodCkgewogICAgY29uc3QgZSA9IHRoaXMubWF0ZXJpYWxDYWNoZS5nZXQodCk7CiAgICBmb3IgKGNvbnN0IGkgb2YgZSkKICAgICAgaS51c2VkVGltZXMtLSwgaS51c2VkVGltZXMgPT09IDAgJiYgdGhpcy5zaGFkZXJDYWNoZS5kZWxldGUoaS5jb2RlKTsKICAgIHJldHVybiB0aGlzLm1hdGVyaWFsQ2FjaGUuZGVsZXRlKHQpLCB0aGlzOwogIH0KICBnZXRWZXJ0ZXhTaGFkZXJJRCh0KSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0U2hhZGVyU3RhZ2UodC52ZXJ0ZXhTaGFkZXIpLmlkOwogIH0KICBnZXRGcmFnbWVudFNoYWRlcklEKHQpIHsKICAgIHJldHVybiB0aGlzLl9nZXRTaGFkZXJTdGFnZSh0LmZyYWdtZW50U2hhZGVyKS5pZDsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuc2hhZGVyQ2FjaGUuY2xlYXIoKSwgdGhpcy5tYXRlcmlhbENhY2hlLmNsZWFyKCk7CiAgfQogIF9nZXRTaGFkZXJDYWNoZUZvck1hdGVyaWFsKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLm1hdGVyaWFsQ2FjaGU7CiAgICBsZXQgaSA9IGUuZ2V0KHQpOwogICAgcmV0dXJuIGkgPT09IHZvaWQgMCAmJiAoaSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksIGUuc2V0KHQsIGkpKSwgaTsKICB9CiAgX2dldFNoYWRlclN0YWdlKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnNoYWRlckNhY2hlOwogICAgbGV0IGkgPSBlLmdldCh0KTsKICAgIHJldHVybiBpID09PSB2b2lkIDAgJiYgKGkgPSBuZXcgdEUodCksIGUuc2V0KHQsIGkpKSwgaTsKICB9Cn0KY2xhc3MgdEUgewogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHRoaXMuaWQgPSBLQSsrLCB0aGlzLmNvZGUgPSB0LCB0aGlzLnVzZWRUaW1lcyA9IDA7CiAgfQp9CmZ1bmN0aW9uIGVFKGEsIHQsIGUsIGksIG4sIHMsIHIpIHsKICBjb25zdCBvID0gbmV3IE5jKCksIGwgPSBuZXcgUUEoKSwgaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksIGMgPSBbXSwgdSA9IG4ubG9nYXJpdGhtaWNEZXB0aEJ1ZmZlciwgZCA9IG4udmVydGV4VGV4dHVyZXM7CiAgbGV0IHAgPSBuLnByZWNpc2lvbjsKICBjb25zdCBmID0gewogICAgTWVzaERlcHRoTWF0ZXJpYWw6ICJkZXB0aCIsCiAgICBNZXNoRGlzdGFuY2VNYXRlcmlhbDogImRpc3RhbmNlUkdCQSIsCiAgICBNZXNoTm9ybWFsTWF0ZXJpYWw6ICJub3JtYWwiLAogICAgTWVzaEJhc2ljTWF0ZXJpYWw6ICJiYXNpYyIsCiAgICBNZXNoTGFtYmVydE1hdGVyaWFsOiAibGFtYmVydCIsCiAgICBNZXNoUGhvbmdNYXRlcmlhbDogInBob25nIiwKICAgIE1lc2hUb29uTWF0ZXJpYWw6ICJ0b29uIiwKICAgIE1lc2hTdGFuZGFyZE1hdGVyaWFsOiAicGh5c2ljYWwiLAogICAgTWVzaFBoeXNpY2FsTWF0ZXJpYWw6ICJwaHlzaWNhbCIsCiAgICBNZXNoTWF0Y2FwTWF0ZXJpYWw6ICJtYXRjYXAiLAogICAgTGluZUJhc2ljTWF0ZXJpYWw6ICJiYXNpYyIsCiAgICBMaW5lRGFzaGVkTWF0ZXJpYWw6ICJkYXNoZWQiLAogICAgUG9pbnRzTWF0ZXJpYWw6ICJwb2ludHMiLAogICAgU2hhZG93TWF0ZXJpYWw6ICJzaGFkb3ciLAogICAgU3ByaXRlTWF0ZXJpYWw6ICJzcHJpdGUiCiAgfTsKICBmdW5jdGlvbiB5KGIpIHsKICAgIHJldHVybiBoLmFkZChiKSwgYiA9PT0gMCA/ICJ1diIgOiBgdXYke2J9YDsKICB9CiAgZnVuY3Rpb24gZyhiLCBNLCBMLCBVLCBPKSB7CiAgICBjb25zdCBWID0gVS5mb2csIFcgPSBPLmdlb21ldHJ5LCBHID0gYi5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID8gVS5lbnZpcm9ubWVudCA6IG51bGwsIGV0ID0gKGIuaXNNZXNoU3RhbmRhcmRNYXRlcmlhbCA/IGUgOiB0KS5nZXQoYi5lbnZNYXAgfHwgRyksIEggPSBldCAmJiBldC5tYXBwaW5nID09PSBTYSA/IGV0LmltYWdlLmhlaWdodCA6IG51bGwsIGF0ID0gZltiLnR5cGVdOwogICAgYi5wcmVjaXNpb24gIT09IG51bGwgJiYgKHAgPSBuLmdldE1heFByZWNpc2lvbihiLnByZWNpc2lvbiksIHAgIT09IGIucHJlY2lzaW9uICYmIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xQcm9ncmFtLmdldFBhcmFtZXRlcnM6IiwgYi5wcmVjaXNpb24sICJub3Qgc3VwcG9ydGVkLCB1c2luZyIsIHAsICJpbnN0ZWFkLiIpKTsKICAgIGNvbnN0IHB0ID0gVy5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24gfHwgVy5tb3JwaEF0dHJpYnV0ZXMubm9ybWFsIHx8IFcubW9ycGhBdHRyaWJ1dGVzLmNvbG9yLCBNdCA9IHB0ICE9PSB2b2lkIDAgPyBwdC5sZW5ndGggOiAwOwogICAgbGV0IEx0ID0gMDsKICAgIFcubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uICE9PSB2b2lkIDAgJiYgKEx0ID0gMSksIFcubW9ycGhBdHRyaWJ1dGVzLm5vcm1hbCAhPT0gdm9pZCAwICYmIChMdCA9IDIpLCBXLm1vcnBoQXR0cmlidXRlcy5jb2xvciAhPT0gdm9pZCAwICYmIChMdCA9IDMpOwogICAgbGV0IGp0LCBuZSwgSnQsIFk7CiAgICBpZiAoYXQpIHsKICAgICAgY29uc3Qgb2UgPSBmaVthdF07CiAgICAgIGp0ID0gb2UudmVydGV4U2hhZGVyLCBuZSA9IG9lLmZyYWdtZW50U2hhZGVyOwogICAgfSBlbHNlCiAgICAgIGp0ID0gYi52ZXJ0ZXhTaGFkZXIsIG5lID0gYi5mcmFnbWVudFNoYWRlciwgbC51cGRhdGUoYiksIEp0ID0gbC5nZXRWZXJ0ZXhTaGFkZXJJRChiKSwgWSA9IGwuZ2V0RnJhZ21lbnRTaGFkZXJJRChiKTsKICAgIGNvbnN0IHN0ID0gYS5nZXRSZW5kZXJUYXJnZXQoKSwgRXQgPSBhLnN0YXRlLmJ1ZmZlcnMuZGVwdGguZ2V0UmV2ZXJzZWQoKSwgVXQgPSBPLmlzSW5zdGFuY2VkTWVzaCA9PT0gITAsIFB0ID0gTy5pc0JhdGNoZWRNZXNoID09PSAhMCwgS3QgPSAhIWIubWFwLCBoZSA9ICEhYi5tYXRjYXAsIEQgPSAhIWV0LCBvdCA9ICEhYi5hb01hcCwgaXQgPSAhIWIubGlnaHRNYXAsIFEgPSAhIWIuYnVtcE1hcCwgSyA9ICEhYi5ub3JtYWxNYXAsIHl0ID0gISFiLmRpc3BsYWNlbWVudE1hcCwgdXQgPSAhIWIuZW1pc3NpdmVNYXAsIHh0ID0gISFiLm1ldGFsbmVzc01hcCwgV3QgPSAhIWIucm91Z2huZXNzTWFwLCBOdCA9IGIuYW5pc290cm9weSA+IDAsIFAgPSBiLmNsZWFyY29hdCA+IDAsIEEgPSBiLmRpc3BlcnNpb24gPiAwLCBOID0gYi5pcmlkZXNjZW5jZSA+IDAsIFggPSBiLnNoZWVuID4gMCwgcnQgPSBiLnRyYW5zbWlzc2lvbiA+IDAsIFogPSBOdCAmJiAhIWIuYW5pc290cm9weU1hcCwgSXQgPSBQICYmICEhYi5jbGVhcmNvYXRNYXAsIEkgPSBQICYmICEhYi5jbGVhcmNvYXROb3JtYWxNYXAsIGx0ID0gUCAmJiAhIWIuY2xlYXJjb2F0Um91Z2huZXNzTWFwLCBndCA9IE4gJiYgISFiLmlyaWRlc2NlbmNlTWFwLCBqID0gTiAmJiAhIWIuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAsIG10ID0gWCAmJiAhIWIuc2hlZW5Db2xvck1hcCwgQXQgPSBYICYmICEhYi5zaGVlblJvdWdobmVzc01hcCwgVHQgPSAhIWIuc3BlY3VsYXJNYXAsIHZ0ID0gISFiLnNwZWN1bGFyQ29sb3JNYXAsICR0ID0gISFiLnNwZWN1bGFySW50ZW5zaXR5TWFwLCBGID0gcnQgJiYgISFiLnRyYW5zbWlzc2lvbk1hcCwgaHQgPSBydCAmJiAhIWIudGhpY2tuZXNzTWFwLCBfdCA9ICEhYi5ncmFkaWVudE1hcCwgUnQgPSAhIWIuYWxwaGFNYXAsIGR0ID0gYi5hbHBoYVRlc3QgPiAwLCBudCA9ICEhYi5hbHBoYUhhc2gsIEZ0ID0gISFiLmV4dGVuc2lvbnM7CiAgICBsZXQgcXQgPSBabjsKICAgIGIudG9uZU1hcHBlZCAmJiAoc3QgPT09IG51bGwgfHwgc3QuaXNYUlJlbmRlclRhcmdldCA9PT0gITApICYmIChxdCA9IGEudG9uZU1hcHBpbmcpOwogICAgY29uc3QgZ2UgPSB7CiAgICAgIHNoYWRlcklEOiBhdCwKICAgICAgc2hhZGVyVHlwZTogYi50eXBlLAogICAgICBzaGFkZXJOYW1lOiBiLm5hbWUsCiAgICAgIHZlcnRleFNoYWRlcjoganQsCiAgICAgIGZyYWdtZW50U2hhZGVyOiBuZSwKICAgICAgZGVmaW5lczogYi5kZWZpbmVzLAogICAgICBjdXN0b21WZXJ0ZXhTaGFkZXJJRDogSnQsCiAgICAgIGN1c3RvbUZyYWdtZW50U2hhZGVySUQ6IFksCiAgICAgIGlzUmF3U2hhZGVyTWF0ZXJpYWw6IGIuaXNSYXdTaGFkZXJNYXRlcmlhbCA9PT0gITAsCiAgICAgIGdsc2xWZXJzaW9uOiBiLmdsc2xWZXJzaW9uLAogICAgICBwcmVjaXNpb246IHAsCiAgICAgIGJhdGNoaW5nOiBQdCwKICAgICAgYmF0Y2hpbmdDb2xvcjogUHQgJiYgTy5fY29sb3JzVGV4dHVyZSAhPT0gbnVsbCwKICAgICAgaW5zdGFuY2luZzogVXQsCiAgICAgIGluc3RhbmNpbmdDb2xvcjogVXQgJiYgTy5pbnN0YW5jZUNvbG9yICE9PSBudWxsLAogICAgICBpbnN0YW5jaW5nTW9ycGg6IFV0ICYmIE8ubW9ycGhUZXh0dXJlICE9PSBudWxsLAogICAgICBzdXBwb3J0c1ZlcnRleFRleHR1cmVzOiBkLAogICAgICBvdXRwdXRDb2xvclNwYWNlOiBzdCA9PT0gbnVsbCA/IGEub3V0cHV0Q29sb3JTcGFjZSA6IHN0LmlzWFJSZW5kZXJUYXJnZXQgPT09ICEwID8gc3QudGV4dHVyZS5jb2xvclNwYWNlIDogQ3MsCiAgICAgIGFscGhhVG9Db3ZlcmFnZTogISFiLmFscGhhVG9Db3ZlcmFnZSwKICAgICAgbWFwOiBLdCwKICAgICAgbWF0Y2FwOiBoZSwKICAgICAgZW52TWFwOiBELAogICAgICBlbnZNYXBNb2RlOiBEICYmIGV0Lm1hcHBpbmcsCiAgICAgIGVudk1hcEN1YmVVVkhlaWdodDogSCwKICAgICAgYW9NYXA6IG90LAogICAgICBsaWdodE1hcDogaXQsCiAgICAgIGJ1bXBNYXA6IFEsCiAgICAgIG5vcm1hbE1hcDogSywKICAgICAgZGlzcGxhY2VtZW50TWFwOiBkICYmIHl0LAogICAgICBlbWlzc2l2ZU1hcDogdXQsCiAgICAgIG5vcm1hbE1hcE9iamVjdFNwYWNlOiBLICYmIGIubm9ybWFsTWFwVHlwZSA9PT0gc3ksCiAgICAgIG5vcm1hbE1hcFRhbmdlbnRTcGFjZTogSyAmJiBiLm5vcm1hbE1hcFR5cGUgPT09IElzLAogICAgICBtZXRhbG5lc3NNYXA6IHh0LAogICAgICByb3VnaG5lc3NNYXA6IFd0LAogICAgICBhbmlzb3Ryb3B5OiBOdCwKICAgICAgYW5pc290cm9weU1hcDogWiwKICAgICAgY2xlYXJjb2F0OiBQLAogICAgICBjbGVhcmNvYXRNYXA6IEl0LAogICAgICBjbGVhcmNvYXROb3JtYWxNYXA6IEksCiAgICAgIGNsZWFyY29hdFJvdWdobmVzc01hcDogbHQsCiAgICAgIGRpc3BlcnNpb246IEEsCiAgICAgIGlyaWRlc2NlbmNlOiBOLAogICAgICBpcmlkZXNjZW5jZU1hcDogZ3QsCiAgICAgIGlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwOiBqLAogICAgICBzaGVlbjogWCwKICAgICAgc2hlZW5Db2xvck1hcDogbXQsCiAgICAgIHNoZWVuUm91Z2huZXNzTWFwOiBBdCwKICAgICAgc3BlY3VsYXJNYXA6IFR0LAogICAgICBzcGVjdWxhckNvbG9yTWFwOiB2dCwKICAgICAgc3BlY3VsYXJJbnRlbnNpdHlNYXA6ICR0LAogICAgICB0cmFuc21pc3Npb246IHJ0LAogICAgICB0cmFuc21pc3Npb25NYXA6IEYsCiAgICAgIHRoaWNrbmVzc01hcDogaHQsCiAgICAgIGdyYWRpZW50TWFwOiBfdCwKICAgICAgb3BhcXVlOiBiLnRyYW5zcGFyZW50ID09PSAhMSAmJiBiLmJsZW5kaW5nID09PSB3cyAmJiBiLmFscGhhVG9Db3ZlcmFnZSA9PT0gITEsCiAgICAgIGFscGhhTWFwOiBSdCwKICAgICAgYWxwaGFUZXN0OiBkdCwKICAgICAgYWxwaGFIYXNoOiBudCwKICAgICAgY29tYmluZTogYi5jb21iaW5lLAogICAgICAvLwogICAgICBtYXBVdjogS3QgJiYgeShiLm1hcC5jaGFubmVsKSwKICAgICAgYW9NYXBVdjogb3QgJiYgeShiLmFvTWFwLmNoYW5uZWwpLAogICAgICBsaWdodE1hcFV2OiBpdCAmJiB5KGIubGlnaHRNYXAuY2hhbm5lbCksCiAgICAgIGJ1bXBNYXBVdjogUSAmJiB5KGIuYnVtcE1hcC5jaGFubmVsKSwKICAgICAgbm9ybWFsTWFwVXY6IEsgJiYgeShiLm5vcm1hbE1hcC5jaGFubmVsKSwKICAgICAgZGlzcGxhY2VtZW50TWFwVXY6IHl0ICYmIHkoYi5kaXNwbGFjZW1lbnRNYXAuY2hhbm5lbCksCiAgICAgIGVtaXNzaXZlTWFwVXY6IHV0ICYmIHkoYi5lbWlzc2l2ZU1hcC5jaGFubmVsKSwKICAgICAgbWV0YWxuZXNzTWFwVXY6IHh0ICYmIHkoYi5tZXRhbG5lc3NNYXAuY2hhbm5lbCksCiAgICAgIHJvdWdobmVzc01hcFV2OiBXdCAmJiB5KGIucm91Z2huZXNzTWFwLmNoYW5uZWwpLAogICAgICBhbmlzb3Ryb3B5TWFwVXY6IFogJiYgeShiLmFuaXNvdHJvcHlNYXAuY2hhbm5lbCksCiAgICAgIGNsZWFyY29hdE1hcFV2OiBJdCAmJiB5KGIuY2xlYXJjb2F0TWFwLmNoYW5uZWwpLAogICAgICBjbGVhcmNvYXROb3JtYWxNYXBVdjogSSAmJiB5KGIuY2xlYXJjb2F0Tm9ybWFsTWFwLmNoYW5uZWwpLAogICAgICBjbGVhcmNvYXRSb3VnaG5lc3NNYXBVdjogbHQgJiYgeShiLmNsZWFyY29hdFJvdWdobmVzc01hcC5jaGFubmVsKSwKICAgICAgaXJpZGVzY2VuY2VNYXBVdjogZ3QgJiYgeShiLmlyaWRlc2NlbmNlTWFwLmNoYW5uZWwpLAogICAgICBpcmlkZXNjZW5jZVRoaWNrbmVzc01hcFV2OiBqICYmIHkoYi5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcC5jaGFubmVsKSwKICAgICAgc2hlZW5Db2xvck1hcFV2OiBtdCAmJiB5KGIuc2hlZW5Db2xvck1hcC5jaGFubmVsKSwKICAgICAgc2hlZW5Sb3VnaG5lc3NNYXBVdjogQXQgJiYgeShiLnNoZWVuUm91Z2huZXNzTWFwLmNoYW5uZWwpLAogICAgICBzcGVjdWxhck1hcFV2OiBUdCAmJiB5KGIuc3BlY3VsYXJNYXAuY2hhbm5lbCksCiAgICAgIHNwZWN1bGFyQ29sb3JNYXBVdjogdnQgJiYgeShiLnNwZWN1bGFyQ29sb3JNYXAuY2hhbm5lbCksCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5TWFwVXY6ICR0ICYmIHkoYi5zcGVjdWxhckludGVuc2l0eU1hcC5jaGFubmVsKSwKICAgICAgdHJhbnNtaXNzaW9uTWFwVXY6IEYgJiYgeShiLnRyYW5zbWlzc2lvbk1hcC5jaGFubmVsKSwKICAgICAgdGhpY2tuZXNzTWFwVXY6IGh0ICYmIHkoYi50aGlja25lc3NNYXAuY2hhbm5lbCksCiAgICAgIGFscGhhTWFwVXY6IFJ0ICYmIHkoYi5hbHBoYU1hcC5jaGFubmVsKSwKICAgICAgLy8KICAgICAgdmVydGV4VGFuZ2VudHM6ICEhVy5hdHRyaWJ1dGVzLnRhbmdlbnQgJiYgKEsgfHwgTnQpLAogICAgICB2ZXJ0ZXhDb2xvcnM6IGIudmVydGV4Q29sb3JzLAogICAgICB2ZXJ0ZXhBbHBoYXM6IGIudmVydGV4Q29sb3JzID09PSAhMCAmJiAhIVcuYXR0cmlidXRlcy5jb2xvciAmJiBXLmF0dHJpYnV0ZXMuY29sb3IuaXRlbVNpemUgPT09IDQsCiAgICAgIHBvaW50c1V2czogTy5pc1BvaW50cyA9PT0gITAgJiYgISFXLmF0dHJpYnV0ZXMudXYgJiYgKEt0IHx8IFJ0KSwKICAgICAgZm9nOiAhIVYsCiAgICAgIHVzZUZvZzogYi5mb2cgPT09ICEwLAogICAgICBmb2dFeHAyOiAhIVYgJiYgVi5pc0ZvZ0V4cDIsCiAgICAgIGZsYXRTaGFkaW5nOiBiLmZsYXRTaGFkaW5nID09PSAhMCAmJiBiLndpcmVmcmFtZSA9PT0gITEsCiAgICAgIHNpemVBdHRlbnVhdGlvbjogYi5zaXplQXR0ZW51YXRpb24gPT09ICEwLAogICAgICBsb2dhcml0aG1pY0RlcHRoQnVmZmVyOiB1LAogICAgICByZXZlcnNlZERlcHRoQnVmZmVyOiBFdCwKICAgICAgc2tpbm5pbmc6IE8uaXNTa2lubmVkTWVzaCA9PT0gITAsCiAgICAgIG1vcnBoVGFyZ2V0czogVy5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24gIT09IHZvaWQgMCwKICAgICAgbW9ycGhOb3JtYWxzOiBXLm1vcnBoQXR0cmlidXRlcy5ub3JtYWwgIT09IHZvaWQgMCwKICAgICAgbW9ycGhDb2xvcnM6IFcubW9ycGhBdHRyaWJ1dGVzLmNvbG9yICE9PSB2b2lkIDAsCiAgICAgIG1vcnBoVGFyZ2V0c0NvdW50OiBNdCwKICAgICAgbW9ycGhUZXh0dXJlU3RyaWRlOiBMdCwKICAgICAgbnVtRGlyTGlnaHRzOiBNLmRpcmVjdGlvbmFsLmxlbmd0aCwKICAgICAgbnVtUG9pbnRMaWdodHM6IE0ucG9pbnQubGVuZ3RoLAogICAgICBudW1TcG90TGlnaHRzOiBNLnNwb3QubGVuZ3RoLAogICAgICBudW1TcG90TGlnaHRNYXBzOiBNLnNwb3RMaWdodE1hcC5sZW5ndGgsCiAgICAgIG51bVJlY3RBcmVhTGlnaHRzOiBNLnJlY3RBcmVhLmxlbmd0aCwKICAgICAgbnVtSGVtaUxpZ2h0czogTS5oZW1pLmxlbmd0aCwKICAgICAgbnVtRGlyTGlnaHRTaGFkb3dzOiBNLmRpcmVjdGlvbmFsU2hhZG93TWFwLmxlbmd0aCwKICAgICAgbnVtUG9pbnRMaWdodFNoYWRvd3M6IE0ucG9pbnRTaGFkb3dNYXAubGVuZ3RoLAogICAgICBudW1TcG90TGlnaHRTaGFkb3dzOiBNLnNwb3RTaGFkb3dNYXAubGVuZ3RoLAogICAgICBudW1TcG90TGlnaHRTaGFkb3dzV2l0aE1hcHM6IE0ubnVtU3BvdExpZ2h0U2hhZG93c1dpdGhNYXBzLAogICAgICBudW1MaWdodFByb2JlczogTS5udW1MaWdodFByb2JlcywKICAgICAgbnVtQ2xpcHBpbmdQbGFuZXM6IHIubnVtUGxhbmVzLAogICAgICBudW1DbGlwSW50ZXJzZWN0aW9uOiByLm51bUludGVyc2VjdGlvbiwKICAgICAgZGl0aGVyaW5nOiBiLmRpdGhlcmluZywKICAgICAgc2hhZG93TWFwRW5hYmxlZDogYS5zaGFkb3dNYXAuZW5hYmxlZCAmJiBMLmxlbmd0aCA+IDAsCiAgICAgIHNoYWRvd01hcFR5cGU6IGEuc2hhZG93TWFwLnR5cGUsCiAgICAgIHRvbmVNYXBwaW5nOiBxdCwKICAgICAgZGVjb2RlVmlkZW9UZXh0dXJlOiBLdCAmJiBiLm1hcC5pc1ZpZGVvVGV4dHVyZSA9PT0gITAgJiYgZWUuZ2V0VHJhbnNmZXIoYi5tYXAuY29sb3JTcGFjZSkgPT09IGNlLAogICAgICBkZWNvZGVWaWRlb1RleHR1cmVFbWlzc2l2ZTogdXQgJiYgYi5lbWlzc2l2ZU1hcC5pc1ZpZGVvVGV4dHVyZSA9PT0gITAgJiYgZWUuZ2V0VHJhbnNmZXIoYi5lbWlzc2l2ZU1hcC5jb2xvclNwYWNlKSA9PT0gY2UsCiAgICAgIHByZW11bHRpcGxpZWRBbHBoYTogYi5wcmVtdWx0aXBsaWVkQWxwaGEsCiAgICAgIGRvdWJsZVNpZGVkOiBiLnNpZGUgPT09IE1pLAogICAgICBmbGlwU2lkZWQ6IGIuc2lkZSA9PT0gSGUsCiAgICAgIHVzZURlcHRoUGFja2luZzogYi5kZXB0aFBhY2tpbmcgPj0gMCwKICAgICAgZGVwdGhQYWNraW5nOiBiLmRlcHRoUGFja2luZyB8fCAwLAogICAgICBpbmRleDBBdHRyaWJ1dGVOYW1lOiBiLmluZGV4MEF0dHJpYnV0ZU5hbWUsCiAgICAgIGV4dGVuc2lvbkNsaXBDdWxsRGlzdGFuY2U6IEZ0ICYmIGIuZXh0ZW5zaW9ucy5jbGlwQ3VsbERpc3RhbmNlID09PSAhMCAmJiBpLmhhcygiV0VCR0xfY2xpcF9jdWxsX2Rpc3RhbmNlIiksCiAgICAgIGV4dGVuc2lvbk11bHRpRHJhdzogKEZ0ICYmIGIuZXh0ZW5zaW9ucy5tdWx0aURyYXcgPT09ICEwIHx8IFB0KSAmJiBpLmhhcygiV0VCR0xfbXVsdGlfZHJhdyIpLAogICAgICByZW5kZXJlckV4dGVuc2lvblBhcmFsbGVsU2hhZGVyQ29tcGlsZTogaS5oYXMoIktIUl9wYXJhbGxlbF9zaGFkZXJfY29tcGlsZSIpLAogICAgICBjdXN0b21Qcm9ncmFtQ2FjaGVLZXk6IGIuY3VzdG9tUHJvZ3JhbUNhY2hlS2V5KCkKICAgIH07CiAgICByZXR1cm4gZ2UudmVydGV4VXYxcyA9IGguaGFzKDEpLCBnZS52ZXJ0ZXhVdjJzID0gaC5oYXMoMiksIGdlLnZlcnRleFV2M3MgPSBoLmhhcygzKSwgaC5jbGVhcigpLCBnZTsKICB9CiAgZnVuY3Rpb24gbShiKSB7CiAgICBjb25zdCBNID0gW107CiAgICBpZiAoYi5zaGFkZXJJRCA/IE0ucHVzaChiLnNoYWRlcklEKSA6IChNLnB1c2goYi5jdXN0b21WZXJ0ZXhTaGFkZXJJRCksIE0ucHVzaChiLmN1c3RvbUZyYWdtZW50U2hhZGVySUQpKSwgYi5kZWZpbmVzICE9PSB2b2lkIDApCiAgICAgIGZvciAoY29uc3QgTCBpbiBiLmRlZmluZXMpCiAgICAgICAgTS5wdXNoKEwpLCBNLnB1c2goYi5kZWZpbmVzW0xdKTsKICAgIHJldHVybiBiLmlzUmF3U2hhZGVyTWF0ZXJpYWwgPT09ICExICYmICh2KE0sIGIpLCB4KE0sIGIpLCBNLnB1c2goYS5vdXRwdXRDb2xvclNwYWNlKSksIE0ucHVzaChiLmN1c3RvbVByb2dyYW1DYWNoZUtleSksIE0uam9pbigpOwogIH0KICBmdW5jdGlvbiB2KGIsIE0pIHsKICAgIGIucHVzaChNLnByZWNpc2lvbiksIGIucHVzaChNLm91dHB1dENvbG9yU3BhY2UpLCBiLnB1c2goTS5lbnZNYXBNb2RlKSwgYi5wdXNoKE0uZW52TWFwQ3ViZVVWSGVpZ2h0KSwgYi5wdXNoKE0ubWFwVXYpLCBiLnB1c2goTS5hbHBoYU1hcFV2KSwgYi5wdXNoKE0ubGlnaHRNYXBVdiksIGIucHVzaChNLmFvTWFwVXYpLCBiLnB1c2goTS5idW1wTWFwVXYpLCBiLnB1c2goTS5ub3JtYWxNYXBVdiksIGIucHVzaChNLmRpc3BsYWNlbWVudE1hcFV2KSwgYi5wdXNoKE0uZW1pc3NpdmVNYXBVdiksIGIucHVzaChNLm1ldGFsbmVzc01hcFV2KSwgYi5wdXNoKE0ucm91Z2huZXNzTWFwVXYpLCBiLnB1c2goTS5hbmlzb3Ryb3B5TWFwVXYpLCBiLnB1c2goTS5jbGVhcmNvYXRNYXBVdiksIGIucHVzaChNLmNsZWFyY29hdE5vcm1hbE1hcFV2KSwgYi5wdXNoKE0uY2xlYXJjb2F0Um91Z2huZXNzTWFwVXYpLCBiLnB1c2goTS5pcmlkZXNjZW5jZU1hcFV2KSwgYi5wdXNoKE0uaXJpZGVzY2VuY2VUaGlja25lc3NNYXBVdiksIGIucHVzaChNLnNoZWVuQ29sb3JNYXBVdiksIGIucHVzaChNLnNoZWVuUm91Z2huZXNzTWFwVXYpLCBiLnB1c2goTS5zcGVjdWxhck1hcFV2KSwgYi5wdXNoKE0uc3BlY3VsYXJDb2xvck1hcFV2KSwgYi5wdXNoKE0uc3BlY3VsYXJJbnRlbnNpdHlNYXBVdiksIGIucHVzaChNLnRyYW5zbWlzc2lvbk1hcFV2KSwgYi5wdXNoKE0udGhpY2tuZXNzTWFwVXYpLCBiLnB1c2goTS5jb21iaW5lKSwgYi5wdXNoKE0uZm9nRXhwMiksIGIucHVzaChNLnNpemVBdHRlbnVhdGlvbiksIGIucHVzaChNLm1vcnBoVGFyZ2V0c0NvdW50KSwgYi5wdXNoKE0ubW9ycGhBdHRyaWJ1dGVDb3VudCksIGIucHVzaChNLm51bURpckxpZ2h0cyksIGIucHVzaChNLm51bVBvaW50TGlnaHRzKSwgYi5wdXNoKE0ubnVtU3BvdExpZ2h0cyksIGIucHVzaChNLm51bVNwb3RMaWdodE1hcHMpLCBiLnB1c2goTS5udW1IZW1pTGlnaHRzKSwgYi5wdXNoKE0ubnVtUmVjdEFyZWFMaWdodHMpLCBiLnB1c2goTS5udW1EaXJMaWdodFNoYWRvd3MpLCBiLnB1c2goTS5udW1Qb2ludExpZ2h0U2hhZG93cyksIGIucHVzaChNLm51bVNwb3RMaWdodFNoYWRvd3MpLCBiLnB1c2goTS5udW1TcG90TGlnaHRTaGFkb3dzV2l0aE1hcHMpLCBiLnB1c2goTS5udW1MaWdodFByb2JlcyksIGIucHVzaChNLnNoYWRvd01hcFR5cGUpLCBiLnB1c2goTS50b25lTWFwcGluZyksIGIucHVzaChNLm51bUNsaXBwaW5nUGxhbmVzKSwgYi5wdXNoKE0ubnVtQ2xpcEludGVyc2VjdGlvbiksIGIucHVzaChNLmRlcHRoUGFja2luZyk7CiAgfQogIGZ1bmN0aW9uIHgoYiwgTSkgewogICAgby5kaXNhYmxlQWxsKCksIE0uc3VwcG9ydHNWZXJ0ZXhUZXh0dXJlcyAmJiBvLmVuYWJsZSgwKSwgTS5pbnN0YW5jaW5nICYmIG8uZW5hYmxlKDEpLCBNLmluc3RhbmNpbmdDb2xvciAmJiBvLmVuYWJsZSgyKSwgTS5pbnN0YW5jaW5nTW9ycGggJiYgby5lbmFibGUoMyksIE0ubWF0Y2FwICYmIG8uZW5hYmxlKDQpLCBNLmVudk1hcCAmJiBvLmVuYWJsZSg1KSwgTS5ub3JtYWxNYXBPYmplY3RTcGFjZSAmJiBvLmVuYWJsZSg2KSwgTS5ub3JtYWxNYXBUYW5nZW50U3BhY2UgJiYgby5lbmFibGUoNyksIE0uY2xlYXJjb2F0ICYmIG8uZW5hYmxlKDgpLCBNLmlyaWRlc2NlbmNlICYmIG8uZW5hYmxlKDkpLCBNLmFscGhhVGVzdCAmJiBvLmVuYWJsZSgxMCksIE0udmVydGV4Q29sb3JzICYmIG8uZW5hYmxlKDExKSwgTS52ZXJ0ZXhBbHBoYXMgJiYgby5lbmFibGUoMTIpLCBNLnZlcnRleFV2MXMgJiYgby5lbmFibGUoMTMpLCBNLnZlcnRleFV2MnMgJiYgby5lbmFibGUoMTQpLCBNLnZlcnRleFV2M3MgJiYgby5lbmFibGUoMTUpLCBNLnZlcnRleFRhbmdlbnRzICYmIG8uZW5hYmxlKDE2KSwgTS5hbmlzb3Ryb3B5ICYmIG8uZW5hYmxlKDE3KSwgTS5hbHBoYUhhc2ggJiYgby5lbmFibGUoMTgpLCBNLmJhdGNoaW5nICYmIG8uZW5hYmxlKDE5KSwgTS5kaXNwZXJzaW9uICYmIG8uZW5hYmxlKDIwKSwgTS5iYXRjaGluZ0NvbG9yICYmIG8uZW5hYmxlKDIxKSwgTS5ncmFkaWVudE1hcCAmJiBvLmVuYWJsZSgyMiksIGIucHVzaChvLm1hc2spLCBvLmRpc2FibGVBbGwoKSwgTS5mb2cgJiYgby5lbmFibGUoMCksIE0udXNlRm9nICYmIG8uZW5hYmxlKDEpLCBNLmZsYXRTaGFkaW5nICYmIG8uZW5hYmxlKDIpLCBNLmxvZ2FyaXRobWljRGVwdGhCdWZmZXIgJiYgby5lbmFibGUoMyksIE0ucmV2ZXJzZWREZXB0aEJ1ZmZlciAmJiBvLmVuYWJsZSg0KSwgTS5za2lubmluZyAmJiBvLmVuYWJsZSg1KSwgTS5tb3JwaFRhcmdldHMgJiYgby5lbmFibGUoNiksIE0ubW9ycGhOb3JtYWxzICYmIG8uZW5hYmxlKDcpLCBNLm1vcnBoQ29sb3JzICYmIG8uZW5hYmxlKDgpLCBNLnByZW11bHRpcGxpZWRBbHBoYSAmJiBvLmVuYWJsZSg5KSwgTS5zaGFkb3dNYXBFbmFibGVkICYmIG8uZW5hYmxlKDEwKSwgTS5kb3VibGVTaWRlZCAmJiBvLmVuYWJsZSgxMSksIE0uZmxpcFNpZGVkICYmIG8uZW5hYmxlKDEyKSwgTS51c2VEZXB0aFBhY2tpbmcgJiYgby5lbmFibGUoMTMpLCBNLmRpdGhlcmluZyAmJiBvLmVuYWJsZSgxNCksIE0udHJhbnNtaXNzaW9uICYmIG8uZW5hYmxlKDE1KSwgTS5zaGVlbiAmJiBvLmVuYWJsZSgxNiksIE0ub3BhcXVlICYmIG8uZW5hYmxlKDE3KSwgTS5wb2ludHNVdnMgJiYgby5lbmFibGUoMTgpLCBNLmRlY29kZVZpZGVvVGV4dHVyZSAmJiBvLmVuYWJsZSgxOSksIE0uZGVjb2RlVmlkZW9UZXh0dXJlRW1pc3NpdmUgJiYgby5lbmFibGUoMjApLCBNLmFscGhhVG9Db3ZlcmFnZSAmJiBvLmVuYWJsZSgyMSksIGIucHVzaChvLm1hc2spOwogIH0KICBmdW5jdGlvbiBfKGIpIHsKICAgIGNvbnN0IE0gPSBmW2IudHlwZV07CiAgICBsZXQgTDsKICAgIGlmIChNKSB7CiAgICAgIGNvbnN0IFUgPSBmaVtNXTsKICAgICAgTCA9IE9jLmNsb25lKFUudW5pZm9ybXMpOwogICAgfSBlbHNlCiAgICAgIEwgPSBiLnVuaWZvcm1zOwogICAgcmV0dXJuIEw7CiAgfQogIGZ1bmN0aW9uIFMoYiwgTSkgewogICAgbGV0IEw7CiAgICBmb3IgKGxldCBVID0gMCwgTyA9IGMubGVuZ3RoOyBVIDwgTzsgVSsrKSB7CiAgICAgIGNvbnN0IFYgPSBjW1VdOwogICAgICBpZiAoVi5jYWNoZUtleSA9PT0gTSkgewogICAgICAgIEwgPSBWLCArK0wudXNlZFRpbWVzOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gTCA9PT0gdm9pZCAwICYmIChMID0gbmV3IEpBKGEsIE0sIGIsIHMpLCBjLnB1c2goTCkpLCBMOwogIH0KICBmdW5jdGlvbiB3KGIpIHsKICAgIGlmICgtLWIudXNlZFRpbWVzID09PSAwKSB7CiAgICAgIGNvbnN0IE0gPSBjLmluZGV4T2YoYik7CiAgICAgIGNbTV0gPSBjW2MubGVuZ3RoIC0gMV0sIGMucG9wKCksIGIuZGVzdHJveSgpOwogICAgfQogIH0KICBmdW5jdGlvbiBUKGIpIHsKICAgIGwucmVtb3ZlKGIpOwogIH0KICBmdW5jdGlvbiBSKCkgewogICAgbC5kaXNwb3NlKCk7CiAgfQogIHJldHVybiB7CiAgICBnZXRQYXJhbWV0ZXJzOiBnLAogICAgZ2V0UHJvZ3JhbUNhY2hlS2V5OiBtLAogICAgZ2V0VW5pZm9ybXM6IF8sCiAgICBhY3F1aXJlUHJvZ3JhbTogUywKICAgIHJlbGVhc2VQcm9ncmFtOiB3LAogICAgcmVsZWFzZVNoYWRlckNhY2hlOiBULAogICAgLy8gRXhwb3NlZCBmb3IgcmVzb3VyY2UgbW9uaXRvcmluZyAmIGVycm9yIGZlZWRiYWNrIHZpYSByZW5kZXJlci5pbmZvOgogICAgcHJvZ3JhbXM6IGMsCiAgICBkaXNwb3NlOiBSCiAgfTsKfQpmdW5jdGlvbiBpRSgpIHsKICBsZXQgYSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIGZ1bmN0aW9uIHQocikgewogICAgcmV0dXJuIGEuaGFzKHIpOwogIH0KICBmdW5jdGlvbiBlKHIpIHsKICAgIGxldCBvID0gYS5nZXQocik7CiAgICByZXR1cm4gbyA9PT0gdm9pZCAwICYmIChvID0ge30sIGEuc2V0KHIsIG8pKSwgbzsKICB9CiAgZnVuY3Rpb24gaShyKSB7CiAgICBhLmRlbGV0ZShyKTsKICB9CiAgZnVuY3Rpb24gbihyLCBvLCBsKSB7CiAgICBhLmdldChyKVtvXSA9IGw7CiAgfQogIGZ1bmN0aW9uIHMoKSB7CiAgICBhID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgfQogIHJldHVybiB7CiAgICBoYXM6IHQsCiAgICBnZXQ6IGUsCiAgICByZW1vdmU6IGksCiAgICB1cGRhdGU6IG4sCiAgICBkaXNwb3NlOiBzCiAgfTsKfQpmdW5jdGlvbiBuRShhLCB0KSB7CiAgcmV0dXJuIGEuZ3JvdXBPcmRlciAhPT0gdC5ncm91cE9yZGVyID8gYS5ncm91cE9yZGVyIC0gdC5ncm91cE9yZGVyIDogYS5yZW5kZXJPcmRlciAhPT0gdC5yZW5kZXJPcmRlciA/IGEucmVuZGVyT3JkZXIgLSB0LnJlbmRlck9yZGVyIDogYS5tYXRlcmlhbC5pZCAhPT0gdC5tYXRlcmlhbC5pZCA/IGEubWF0ZXJpYWwuaWQgLSB0Lm1hdGVyaWFsLmlkIDogYS56ICE9PSB0LnogPyBhLnogLSB0LnogOiBhLmlkIC0gdC5pZDsKfQpmdW5jdGlvbiBuZyhhLCB0KSB7CiAgcmV0dXJuIGEuZ3JvdXBPcmRlciAhPT0gdC5ncm91cE9yZGVyID8gYS5ncm91cE9yZGVyIC0gdC5ncm91cE9yZGVyIDogYS5yZW5kZXJPcmRlciAhPT0gdC5yZW5kZXJPcmRlciA/IGEucmVuZGVyT3JkZXIgLSB0LnJlbmRlck9yZGVyIDogYS56ICE9PSB0LnogPyB0LnogLSBhLnogOiBhLmlkIC0gdC5pZDsKfQpmdW5jdGlvbiBzZygpIHsKICBjb25zdCBhID0gW107CiAgbGV0IHQgPSAwOwogIGNvbnN0IGUgPSBbXSwgaSA9IFtdLCBuID0gW107CiAgZnVuY3Rpb24gcygpIHsKICAgIHQgPSAwLCBlLmxlbmd0aCA9IDAsIGkubGVuZ3RoID0gMCwgbi5sZW5ndGggPSAwOwogIH0KICBmdW5jdGlvbiByKHUsIGQsIHAsIGYsIHksIGcpIHsKICAgIGxldCBtID0gYVt0XTsKICAgIHJldHVybiBtID09PSB2b2lkIDAgPyAobSA9IHsKICAgICAgaWQ6IHUuaWQsCiAgICAgIG9iamVjdDogdSwKICAgICAgZ2VvbWV0cnk6IGQsCiAgICAgIG1hdGVyaWFsOiBwLAogICAgICBncm91cE9yZGVyOiBmLAogICAgICByZW5kZXJPcmRlcjogdS5yZW5kZXJPcmRlciwKICAgICAgejogeSwKICAgICAgZ3JvdXA6IGcKICAgIH0sIGFbdF0gPSBtKSA6IChtLmlkID0gdS5pZCwgbS5vYmplY3QgPSB1LCBtLmdlb21ldHJ5ID0gZCwgbS5tYXRlcmlhbCA9IHAsIG0uZ3JvdXBPcmRlciA9IGYsIG0ucmVuZGVyT3JkZXIgPSB1LnJlbmRlck9yZGVyLCBtLnogPSB5LCBtLmdyb3VwID0gZyksIHQrKywgbTsKICB9CiAgZnVuY3Rpb24gbyh1LCBkLCBwLCBmLCB5LCBnKSB7CiAgICBjb25zdCBtID0gcih1LCBkLCBwLCBmLCB5LCBnKTsKICAgIHAudHJhbnNtaXNzaW9uID4gMCA/IGkucHVzaChtKSA6IHAudHJhbnNwYXJlbnQgPT09ICEwID8gbi5wdXNoKG0pIDogZS5wdXNoKG0pOwogIH0KICBmdW5jdGlvbiBsKHUsIGQsIHAsIGYsIHksIGcpIHsKICAgIGNvbnN0IG0gPSByKHUsIGQsIHAsIGYsIHksIGcpOwogICAgcC50cmFuc21pc3Npb24gPiAwID8gaS51bnNoaWZ0KG0pIDogcC50cmFuc3BhcmVudCA9PT0gITAgPyBuLnVuc2hpZnQobSkgOiBlLnVuc2hpZnQobSk7CiAgfQogIGZ1bmN0aW9uIGgodSwgZCkgewogICAgZS5sZW5ndGggPiAxICYmIGUuc29ydCh1IHx8IG5FKSwgaS5sZW5ndGggPiAxICYmIGkuc29ydChkIHx8IG5nKSwgbi5sZW5ndGggPiAxICYmIG4uc29ydChkIHx8IG5nKTsKICB9CiAgZnVuY3Rpb24gYygpIHsKICAgIGZvciAobGV0IHUgPSB0LCBkID0gYS5sZW5ndGg7IHUgPCBkOyB1KyspIHsKICAgICAgY29uc3QgcCA9IGFbdV07CiAgICAgIGlmIChwLmlkID09PSBudWxsKSBicmVhazsKICAgICAgcC5pZCA9IG51bGwsIHAub2JqZWN0ID0gbnVsbCwgcC5nZW9tZXRyeSA9IG51bGwsIHAubWF0ZXJpYWwgPSBudWxsLCBwLmdyb3VwID0gbnVsbDsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIG9wYXF1ZTogZSwKICAgIHRyYW5zbWlzc2l2ZTogaSwKICAgIHRyYW5zcGFyZW50OiBuLAogICAgaW5pdDogcywKICAgIHB1c2g6IG8sCiAgICB1bnNoaWZ0OiBsLAogICAgZmluaXNoOiBjLAogICAgc29ydDogaAogIH07Cn0KZnVuY3Rpb24gc0UoKSB7CiAgbGV0IGEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBmdW5jdGlvbiB0KGksIG4pIHsKICAgIGNvbnN0IHMgPSBhLmdldChpKTsKICAgIGxldCByOwogICAgcmV0dXJuIHMgPT09IHZvaWQgMCA/IChyID0gbmV3IHNnKCksIGEuc2V0KGksIFtyXSkpIDogbiA+PSBzLmxlbmd0aCA/IChyID0gbmV3IHNnKCksIHMucHVzaChyKSkgOiByID0gc1tuXSwgcjsKICB9CiAgZnVuY3Rpb24gZSgpIHsKICAgIGEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICB9CiAgcmV0dXJuIHsKICAgIGdldDogdCwKICAgIGRpc3Bvc2U6IGUKICB9Owp9CmZ1bmN0aW9uIHJFKCkgewogIGNvbnN0IGEgPSB7fTsKICByZXR1cm4gewogICAgZ2V0OiBmdW5jdGlvbih0KSB7CiAgICAgIGlmIChhW3QuaWRdICE9PSB2b2lkIDApCiAgICAgICAgcmV0dXJuIGFbdC5pZF07CiAgICAgIGxldCBlOwogICAgICBzd2l0Y2ggKHQudHlwZSkgewogICAgICAgIGNhc2UgIkRpcmVjdGlvbmFsTGlnaHQiOgogICAgICAgICAgZSA9IHsKICAgICAgICAgICAgZGlyZWN0aW9uOiBuZXcgRSgpLAogICAgICAgICAgICBjb2xvcjogbmV3IGN0KCkKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJTcG90TGlnaHQiOgogICAgICAgICAgZSA9IHsKICAgICAgICAgICAgcG9zaXRpb246IG5ldyBFKCksCiAgICAgICAgICAgIGRpcmVjdGlvbjogbmV3IEUoKSwKICAgICAgICAgICAgY29sb3I6IG5ldyBjdCgpLAogICAgICAgICAgICBkaXN0YW5jZTogMCwKICAgICAgICAgICAgY29uZUNvczogMCwKICAgICAgICAgICAgcGVudW1icmFDb3M6IDAsCiAgICAgICAgICAgIGRlY2F5OiAwCiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiUG9pbnRMaWdodCI6CiAgICAgICAgICBlID0gewogICAgICAgICAgICBwb3NpdGlvbjogbmV3IEUoKSwKICAgICAgICAgICAgY29sb3I6IG5ldyBjdCgpLAogICAgICAgICAgICBkaXN0YW5jZTogMCwKICAgICAgICAgICAgZGVjYXk6IDAKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJIZW1pc3BoZXJlTGlnaHQiOgogICAgICAgICAgZSA9IHsKICAgICAgICAgICAgZGlyZWN0aW9uOiBuZXcgRSgpLAogICAgICAgICAgICBza3lDb2xvcjogbmV3IGN0KCksCiAgICAgICAgICAgIGdyb3VuZENvbG9yOiBuZXcgY3QoKQogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlJlY3RBcmVhTGlnaHQiOgogICAgICAgICAgZSA9IHsKICAgICAgICAgICAgY29sb3I6IG5ldyBjdCgpLAogICAgICAgICAgICBwb3NpdGlvbjogbmV3IEUoKSwKICAgICAgICAgICAgaGFsZldpZHRoOiBuZXcgRSgpLAogICAgICAgICAgICBoYWxmSGVpZ2h0OiBuZXcgRSgpCiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIGFbdC5pZF0gPSBlLCBlOwogICAgfQogIH07Cn0KZnVuY3Rpb24gYUUoKSB7CiAgY29uc3QgYSA9IHt9OwogIHJldHVybiB7CiAgICBnZXQ6IGZ1bmN0aW9uKHQpIHsKICAgICAgaWYgKGFbdC5pZF0gIT09IHZvaWQgMCkKICAgICAgICByZXR1cm4gYVt0LmlkXTsKICAgICAgbGV0IGU7CiAgICAgIHN3aXRjaCAodC50eXBlKSB7CiAgICAgICAgY2FzZSAiRGlyZWN0aW9uYWxMaWdodCI6CiAgICAgICAgICBlID0gewogICAgICAgICAgICBzaGFkb3dJbnRlbnNpdHk6IDEsCiAgICAgICAgICAgIHNoYWRvd0JpYXM6IDAsCiAgICAgICAgICAgIHNoYWRvd05vcm1hbEJpYXM6IDAsCiAgICAgICAgICAgIHNoYWRvd1JhZGl1czogMSwKICAgICAgICAgICAgc2hhZG93TWFwU2l6ZTogbmV3IEooKQogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlNwb3RMaWdodCI6CiAgICAgICAgICBlID0gewogICAgICAgICAgICBzaGFkb3dJbnRlbnNpdHk6IDEsCiAgICAgICAgICAgIHNoYWRvd0JpYXM6IDAsCiAgICAgICAgICAgIHNoYWRvd05vcm1hbEJpYXM6IDAsCiAgICAgICAgICAgIHNoYWRvd1JhZGl1czogMSwKICAgICAgICAgICAgc2hhZG93TWFwU2l6ZTogbmV3IEooKQogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlBvaW50TGlnaHQiOgogICAgICAgICAgZSA9IHsKICAgICAgICAgICAgc2hhZG93SW50ZW5zaXR5OiAxLAogICAgICAgICAgICBzaGFkb3dCaWFzOiAwLAogICAgICAgICAgICBzaGFkb3dOb3JtYWxCaWFzOiAwLAogICAgICAgICAgICBzaGFkb3dSYWRpdXM6IDEsCiAgICAgICAgICAgIHNoYWRvd01hcFNpemU6IG5ldyBKKCksCiAgICAgICAgICAgIHNoYWRvd0NhbWVyYU5lYXI6IDEsCiAgICAgICAgICAgIHNoYWRvd0NhbWVyYUZhcjogMWUzCiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIGFbdC5pZF0gPSBlLCBlOwogICAgfQogIH07Cn0KbGV0IG9FID0gMDsKZnVuY3Rpb24gbEUoYSwgdCkgewogIHJldHVybiAodC5jYXN0U2hhZG93ID8gMiA6IDApIC0gKGEuY2FzdFNoYWRvdyA/IDIgOiAwKSArICh0Lm1hcCA/IDEgOiAwKSAtIChhLm1hcCA/IDEgOiAwKTsKfQpmdW5jdGlvbiBoRShhKSB7CiAgY29uc3QgdCA9IG5ldyByRSgpLCBlID0gYUUoKSwgaSA9IHsKICAgIHZlcnNpb246IDAsCiAgICBoYXNoOiB7CiAgICAgIGRpcmVjdGlvbmFsTGVuZ3RoOiAtMSwKICAgICAgcG9pbnRMZW5ndGg6IC0xLAogICAgICBzcG90TGVuZ3RoOiAtMSwKICAgICAgcmVjdEFyZWFMZW5ndGg6IC0xLAogICAgICBoZW1pTGVuZ3RoOiAtMSwKICAgICAgbnVtRGlyZWN0aW9uYWxTaGFkb3dzOiAtMSwKICAgICAgbnVtUG9pbnRTaGFkb3dzOiAtMSwKICAgICAgbnVtU3BvdFNoYWRvd3M6IC0xLAogICAgICBudW1TcG90TWFwczogLTEsCiAgICAgIG51bUxpZ2h0UHJvYmVzOiAtMQogICAgfSwKICAgIGFtYmllbnQ6IFswLCAwLCAwXSwKICAgIHByb2JlOiBbXSwKICAgIGRpcmVjdGlvbmFsOiBbXSwKICAgIGRpcmVjdGlvbmFsU2hhZG93OiBbXSwKICAgIGRpcmVjdGlvbmFsU2hhZG93TWFwOiBbXSwKICAgIGRpcmVjdGlvbmFsU2hhZG93TWF0cml4OiBbXSwKICAgIHNwb3Q6IFtdLAogICAgc3BvdExpZ2h0TWFwOiBbXSwKICAgIHNwb3RTaGFkb3c6IFtdLAogICAgc3BvdFNoYWRvd01hcDogW10sCiAgICBzcG90TGlnaHRNYXRyaXg6IFtdLAogICAgcmVjdEFyZWE6IFtdLAogICAgcmVjdEFyZWFMVEMxOiBudWxsLAogICAgcmVjdEFyZWFMVEMyOiBudWxsLAogICAgcG9pbnQ6IFtdLAogICAgcG9pbnRTaGFkb3c6IFtdLAogICAgcG9pbnRTaGFkb3dNYXA6IFtdLAogICAgcG9pbnRTaGFkb3dNYXRyaXg6IFtdLAogICAgaGVtaTogW10sCiAgICBudW1TcG90TGlnaHRTaGFkb3dzV2l0aE1hcHM6IDAsCiAgICBudW1MaWdodFByb2JlczogMAogIH07CiAgZm9yIChsZXQgaCA9IDA7IGggPCA5OyBoKyspIGkucHJvYmUucHVzaChuZXcgRSgpKTsKICBjb25zdCBuID0gbmV3IEUoKSwgcyA9IG5ldyBWdCgpLCByID0gbmV3IFZ0KCk7CiAgZnVuY3Rpb24gbyhoKSB7CiAgICBsZXQgYyA9IDAsIHUgPSAwLCBkID0gMDsKICAgIGZvciAobGV0IGIgPSAwOyBiIDwgOTsgYisrKSBpLnByb2JlW2JdLnNldCgwLCAwLCAwKTsKICAgIGxldCBwID0gMCwgZiA9IDAsIHkgPSAwLCBnID0gMCwgbSA9IDAsIHYgPSAwLCB4ID0gMCwgXyA9IDAsIFMgPSAwLCB3ID0gMCwgVCA9IDA7CiAgICBoLnNvcnQobEUpOwogICAgZm9yIChsZXQgYiA9IDAsIE0gPSBoLmxlbmd0aDsgYiA8IE07IGIrKykgewogICAgICBjb25zdCBMID0gaFtiXSwgVSA9IEwuY29sb3IsIE8gPSBMLmludGVuc2l0eSwgViA9IEwuZGlzdGFuY2UsIFcgPSBMLnNoYWRvdyAmJiBMLnNoYWRvdy5tYXAgPyBMLnNoYWRvdy5tYXAudGV4dHVyZSA6IG51bGw7CiAgICAgIGlmIChMLmlzQW1iaWVudExpZ2h0KQogICAgICAgIGMgKz0gVS5yICogTywgdSArPSBVLmcgKiBPLCBkICs9IFUuYiAqIE87CiAgICAgIGVsc2UgaWYgKEwuaXNMaWdodFByb2JlKSB7CiAgICAgICAgZm9yIChsZXQgRyA9IDA7IEcgPCA5OyBHKyspCiAgICAgICAgICBpLnByb2JlW0ddLmFkZFNjYWxlZFZlY3RvcihMLnNoLmNvZWZmaWNpZW50c1tHXSwgTyk7CiAgICAgICAgVCsrOwogICAgICB9IGVsc2UgaWYgKEwuaXNEaXJlY3Rpb25hbExpZ2h0KSB7CiAgICAgICAgY29uc3QgRyA9IHQuZ2V0KEwpOwogICAgICAgIGlmIChHLmNvbG9yLmNvcHkoTC5jb2xvcikubXVsdGlwbHlTY2FsYXIoTC5pbnRlbnNpdHkpLCBMLmNhc3RTaGFkb3cpIHsKICAgICAgICAgIGNvbnN0IGV0ID0gTC5zaGFkb3csIEggPSBlLmdldChMKTsKICAgICAgICAgIEguc2hhZG93SW50ZW5zaXR5ID0gZXQuaW50ZW5zaXR5LCBILnNoYWRvd0JpYXMgPSBldC5iaWFzLCBILnNoYWRvd05vcm1hbEJpYXMgPSBldC5ub3JtYWxCaWFzLCBILnNoYWRvd1JhZGl1cyA9IGV0LnJhZGl1cywgSC5zaGFkb3dNYXBTaXplID0gZXQubWFwU2l6ZSwgaS5kaXJlY3Rpb25hbFNoYWRvd1twXSA9IEgsIGkuZGlyZWN0aW9uYWxTaGFkb3dNYXBbcF0gPSBXLCBpLmRpcmVjdGlvbmFsU2hhZG93TWF0cml4W3BdID0gTC5zaGFkb3cubWF0cml4LCB2Kys7CiAgICAgICAgfQogICAgICAgIGkuZGlyZWN0aW9uYWxbcF0gPSBHLCBwKys7CiAgICAgIH0gZWxzZSBpZiAoTC5pc1Nwb3RMaWdodCkgewogICAgICAgIGNvbnN0IEcgPSB0LmdldChMKTsKICAgICAgICBHLnBvc2l0aW9uLnNldEZyb21NYXRyaXhQb3NpdGlvbihMLm1hdHJpeFdvcmxkKSwgRy5jb2xvci5jb3B5KFUpLm11bHRpcGx5U2NhbGFyKE8pLCBHLmRpc3RhbmNlID0gViwgRy5jb25lQ29zID0gTWF0aC5jb3MoTC5hbmdsZSksIEcucGVudW1icmFDb3MgPSBNYXRoLmNvcyhMLmFuZ2xlICogKDEgLSBMLnBlbnVtYnJhKSksIEcuZGVjYXkgPSBMLmRlY2F5LCBpLnNwb3RbeV0gPSBHOwogICAgICAgIGNvbnN0IGV0ID0gTC5zaGFkb3c7CiAgICAgICAgaWYgKEwubWFwICYmIChpLnNwb3RMaWdodE1hcFtTXSA9IEwubWFwLCBTKyssIGV0LnVwZGF0ZU1hdHJpY2VzKEwpLCBMLmNhc3RTaGFkb3cgJiYgdysrKSwgaS5zcG90TGlnaHRNYXRyaXhbeV0gPSBldC5tYXRyaXgsIEwuY2FzdFNoYWRvdykgewogICAgICAgICAgY29uc3QgSCA9IGUuZ2V0KEwpOwogICAgICAgICAgSC5zaGFkb3dJbnRlbnNpdHkgPSBldC5pbnRlbnNpdHksIEguc2hhZG93QmlhcyA9IGV0LmJpYXMsIEguc2hhZG93Tm9ybWFsQmlhcyA9IGV0Lm5vcm1hbEJpYXMsIEguc2hhZG93UmFkaXVzID0gZXQucmFkaXVzLCBILnNoYWRvd01hcFNpemUgPSBldC5tYXBTaXplLCBpLnNwb3RTaGFkb3dbeV0gPSBILCBpLnNwb3RTaGFkb3dNYXBbeV0gPSBXLCBfKys7CiAgICAgICAgfQogICAgICAgIHkrKzsKICAgICAgfSBlbHNlIGlmIChMLmlzUmVjdEFyZWFMaWdodCkgewogICAgICAgIGNvbnN0IEcgPSB0LmdldChMKTsKICAgICAgICBHLmNvbG9yLmNvcHkoVSkubXVsdGlwbHlTY2FsYXIoTyksIEcuaGFsZldpZHRoLnNldChMLndpZHRoICogMC41LCAwLCAwKSwgRy5oYWxmSGVpZ2h0LnNldCgwLCBMLmhlaWdodCAqIDAuNSwgMCksIGkucmVjdEFyZWFbZ10gPSBHLCBnKys7CiAgICAgIH0gZWxzZSBpZiAoTC5pc1BvaW50TGlnaHQpIHsKICAgICAgICBjb25zdCBHID0gdC5nZXQoTCk7CiAgICAgICAgaWYgKEcuY29sb3IuY29weShMLmNvbG9yKS5tdWx0aXBseVNjYWxhcihMLmludGVuc2l0eSksIEcuZGlzdGFuY2UgPSBMLmRpc3RhbmNlLCBHLmRlY2F5ID0gTC5kZWNheSwgTC5jYXN0U2hhZG93KSB7CiAgICAgICAgICBjb25zdCBldCA9IEwuc2hhZG93LCBIID0gZS5nZXQoTCk7CiAgICAgICAgICBILnNoYWRvd0ludGVuc2l0eSA9IGV0LmludGVuc2l0eSwgSC5zaGFkb3dCaWFzID0gZXQuYmlhcywgSC5zaGFkb3dOb3JtYWxCaWFzID0gZXQubm9ybWFsQmlhcywgSC5zaGFkb3dSYWRpdXMgPSBldC5yYWRpdXMsIEguc2hhZG93TWFwU2l6ZSA9IGV0Lm1hcFNpemUsIEguc2hhZG93Q2FtZXJhTmVhciA9IGV0LmNhbWVyYS5uZWFyLCBILnNoYWRvd0NhbWVyYUZhciA9IGV0LmNhbWVyYS5mYXIsIGkucG9pbnRTaGFkb3dbZl0gPSBILCBpLnBvaW50U2hhZG93TWFwW2ZdID0gVywgaS5wb2ludFNoYWRvd01hdHJpeFtmXSA9IEwuc2hhZG93Lm1hdHJpeCwgeCsrOwogICAgICAgIH0KICAgICAgICBpLnBvaW50W2ZdID0gRywgZisrOwogICAgICB9IGVsc2UgaWYgKEwuaXNIZW1pc3BoZXJlTGlnaHQpIHsKICAgICAgICBjb25zdCBHID0gdC5nZXQoTCk7CiAgICAgICAgRy5za3lDb2xvci5jb3B5KEwuY29sb3IpLm11bHRpcGx5U2NhbGFyKE8pLCBHLmdyb3VuZENvbG9yLmNvcHkoTC5ncm91bmRDb2xvcikubXVsdGlwbHlTY2FsYXIoTyksIGkuaGVtaVttXSA9IEcsIG0rKzsKICAgICAgfQogICAgfQogICAgZyA+IDAgJiYgKGEuaGFzKCJPRVNfdGV4dHVyZV9mbG9hdF9saW5lYXIiKSA9PT0gITAgPyAoaS5yZWN0QXJlYUxUQzEgPSBidC5MVENfRkxPQVRfMSwgaS5yZWN0QXJlYUxUQzIgPSBidC5MVENfRkxPQVRfMikgOiAoaS5yZWN0QXJlYUxUQzEgPSBidC5MVENfSEFMRl8xLCBpLnJlY3RBcmVhTFRDMiA9IGJ0LkxUQ19IQUxGXzIpKSwgaS5hbWJpZW50WzBdID0gYywgaS5hbWJpZW50WzFdID0gdSwgaS5hbWJpZW50WzJdID0gZDsKICAgIGNvbnN0IFIgPSBpLmhhc2g7CiAgICAoUi5kaXJlY3Rpb25hbExlbmd0aCAhPT0gcCB8fCBSLnBvaW50TGVuZ3RoICE9PSBmIHx8IFIuc3BvdExlbmd0aCAhPT0geSB8fCBSLnJlY3RBcmVhTGVuZ3RoICE9PSBnIHx8IFIuaGVtaUxlbmd0aCAhPT0gbSB8fCBSLm51bURpcmVjdGlvbmFsU2hhZG93cyAhPT0gdiB8fCBSLm51bVBvaW50U2hhZG93cyAhPT0geCB8fCBSLm51bVNwb3RTaGFkb3dzICE9PSBfIHx8IFIubnVtU3BvdE1hcHMgIT09IFMgfHwgUi5udW1MaWdodFByb2JlcyAhPT0gVCkgJiYgKGkuZGlyZWN0aW9uYWwubGVuZ3RoID0gcCwgaS5zcG90Lmxlbmd0aCA9IHksIGkucmVjdEFyZWEubGVuZ3RoID0gZywgaS5wb2ludC5sZW5ndGggPSBmLCBpLmhlbWkubGVuZ3RoID0gbSwgaS5kaXJlY3Rpb25hbFNoYWRvdy5sZW5ndGggPSB2LCBpLmRpcmVjdGlvbmFsU2hhZG93TWFwLmxlbmd0aCA9IHYsIGkucG9pbnRTaGFkb3cubGVuZ3RoID0geCwgaS5wb2ludFNoYWRvd01hcC5sZW5ndGggPSB4LCBpLnNwb3RTaGFkb3cubGVuZ3RoID0gXywgaS5zcG90U2hhZG93TWFwLmxlbmd0aCA9IF8sIGkuZGlyZWN0aW9uYWxTaGFkb3dNYXRyaXgubGVuZ3RoID0gdiwgaS5wb2ludFNoYWRvd01hdHJpeC5sZW5ndGggPSB4LCBpLnNwb3RMaWdodE1hdHJpeC5sZW5ndGggPSBfICsgUyAtIHcsIGkuc3BvdExpZ2h0TWFwLmxlbmd0aCA9IFMsIGkubnVtU3BvdExpZ2h0U2hhZG93c1dpdGhNYXBzID0gdywgaS5udW1MaWdodFByb2JlcyA9IFQsIFIuZGlyZWN0aW9uYWxMZW5ndGggPSBwLCBSLnBvaW50TGVuZ3RoID0gZiwgUi5zcG90TGVuZ3RoID0geSwgUi5yZWN0QXJlYUxlbmd0aCA9IGcsIFIuaGVtaUxlbmd0aCA9IG0sIFIubnVtRGlyZWN0aW9uYWxTaGFkb3dzID0gdiwgUi5udW1Qb2ludFNoYWRvd3MgPSB4LCBSLm51bVNwb3RTaGFkb3dzID0gXywgUi5udW1TcG90TWFwcyA9IFMsIFIubnVtTGlnaHRQcm9iZXMgPSBULCBpLnZlcnNpb24gPSBvRSsrKTsKICB9CiAgZnVuY3Rpb24gbChoLCBjKSB7CiAgICBsZXQgdSA9IDAsIGQgPSAwLCBwID0gMCwgZiA9IDAsIHkgPSAwOwogICAgY29uc3QgZyA9IGMubWF0cml4V29ybGRJbnZlcnNlOwogICAgZm9yIChsZXQgbSA9IDAsIHYgPSBoLmxlbmd0aDsgbSA8IHY7IG0rKykgewogICAgICBjb25zdCB4ID0gaFttXTsKICAgICAgaWYgKHguaXNEaXJlY3Rpb25hbExpZ2h0KSB7CiAgICAgICAgY29uc3QgXyA9IGkuZGlyZWN0aW9uYWxbdV07CiAgICAgICAgXy5kaXJlY3Rpb24uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHgubWF0cml4V29ybGQpLCBuLnNldEZyb21NYXRyaXhQb3NpdGlvbih4LnRhcmdldC5tYXRyaXhXb3JsZCksIF8uZGlyZWN0aW9uLnN1YihuKSwgXy5kaXJlY3Rpb24udHJhbnNmb3JtRGlyZWN0aW9uKGcpLCB1Kys7CiAgICAgIH0gZWxzZSBpZiAoeC5pc1Nwb3RMaWdodCkgewogICAgICAgIGNvbnN0IF8gPSBpLnNwb3RbcF07CiAgICAgICAgXy5wb3NpdGlvbi5zZXRGcm9tTWF0cml4UG9zaXRpb24oeC5tYXRyaXhXb3JsZCksIF8ucG9zaXRpb24uYXBwbHlNYXRyaXg0KGcpLCBfLmRpcmVjdGlvbi5zZXRGcm9tTWF0cml4UG9zaXRpb24oeC5tYXRyaXhXb3JsZCksIG4uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHgudGFyZ2V0Lm1hdHJpeFdvcmxkKSwgXy5kaXJlY3Rpb24uc3ViKG4pLCBfLmRpcmVjdGlvbi50cmFuc2Zvcm1EaXJlY3Rpb24oZyksIHArKzsKICAgICAgfSBlbHNlIGlmICh4LmlzUmVjdEFyZWFMaWdodCkgewogICAgICAgIGNvbnN0IF8gPSBpLnJlY3RBcmVhW2ZdOwogICAgICAgIF8ucG9zaXRpb24uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHgubWF0cml4V29ybGQpLCBfLnBvc2l0aW9uLmFwcGx5TWF0cml4NChnKSwgci5pZGVudGl0eSgpLCBzLmNvcHkoeC5tYXRyaXhXb3JsZCksIHMucHJlbXVsdGlwbHkoZyksIHIuZXh0cmFjdFJvdGF0aW9uKHMpLCBfLmhhbGZXaWR0aC5zZXQoeC53aWR0aCAqIDAuNSwgMCwgMCksIF8uaGFsZkhlaWdodC5zZXQoMCwgeC5oZWlnaHQgKiAwLjUsIDApLCBfLmhhbGZXaWR0aC5hcHBseU1hdHJpeDQociksIF8uaGFsZkhlaWdodC5hcHBseU1hdHJpeDQociksIGYrKzsKICAgICAgfSBlbHNlIGlmICh4LmlzUG9pbnRMaWdodCkgewogICAgICAgIGNvbnN0IF8gPSBpLnBvaW50W2RdOwogICAgICAgIF8ucG9zaXRpb24uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHgubWF0cml4V29ybGQpLCBfLnBvc2l0aW9uLmFwcGx5TWF0cml4NChnKSwgZCsrOwogICAgICB9IGVsc2UgaWYgKHguaXNIZW1pc3BoZXJlTGlnaHQpIHsKICAgICAgICBjb25zdCBfID0gaS5oZW1pW3ldOwogICAgICAgIF8uZGlyZWN0aW9uLnNldEZyb21NYXRyaXhQb3NpdGlvbih4Lm1hdHJpeFdvcmxkKSwgXy5kaXJlY3Rpb24udHJhbnNmb3JtRGlyZWN0aW9uKGcpLCB5Kys7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHNldHVwOiBvLAogICAgc2V0dXBWaWV3OiBsLAogICAgc3RhdGU6IGkKICB9Owp9CmZ1bmN0aW9uIHJnKGEpIHsKICBjb25zdCB0ID0gbmV3IGhFKGEpLCBlID0gW10sIGkgPSBbXTsKICBmdW5jdGlvbiBuKGMpIHsKICAgIGguY2FtZXJhID0gYywgZS5sZW5ndGggPSAwLCBpLmxlbmd0aCA9IDA7CiAgfQogIGZ1bmN0aW9uIHMoYykgewogICAgZS5wdXNoKGMpOwogIH0KICBmdW5jdGlvbiByKGMpIHsKICAgIGkucHVzaChjKTsKICB9CiAgZnVuY3Rpb24gbygpIHsKICAgIHQuc2V0dXAoZSk7CiAgfQogIGZ1bmN0aW9uIGwoYykgewogICAgdC5zZXR1cFZpZXcoZSwgYyk7CiAgfQogIGNvbnN0IGggPSB7CiAgICBsaWdodHNBcnJheTogZSwKICAgIHNoYWRvd3NBcnJheTogaSwKICAgIGNhbWVyYTogbnVsbCwKICAgIGxpZ2h0czogdCwKICAgIHRyYW5zbWlzc2lvblJlbmRlclRhcmdldDoge30KICB9OwogIHJldHVybiB7CiAgICBpbml0OiBuLAogICAgc3RhdGU6IGgsCiAgICBzZXR1cExpZ2h0czogbywKICAgIHNldHVwTGlnaHRzVmlldzogbCwKICAgIHB1c2hMaWdodDogcywKICAgIHB1c2hTaGFkb3c6IHIKICB9Owp9CmZ1bmN0aW9uIGNFKGEpIHsKICBsZXQgdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIGZ1bmN0aW9uIGUobiwgcyA9IDApIHsKICAgIGNvbnN0IHIgPSB0LmdldChuKTsKICAgIGxldCBvOwogICAgcmV0dXJuIHIgPT09IHZvaWQgMCA/IChvID0gbmV3IHJnKGEpLCB0LnNldChuLCBbb10pKSA6IHMgPj0gci5sZW5ndGggPyAobyA9IG5ldyByZyhhKSwgci5wdXNoKG8pKSA6IG8gPSByW3NdLCBvOwogIH0KICBmdW5jdGlvbiBpKCkgewogICAgdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIH0KICByZXR1cm4gewogICAgZ2V0OiBlLAogICAgZGlzcG9zZTogaQogIH07Cn0KY29uc3QgdUUgPSBgdm9pZCBtYWluKCkgewoJZ2xfUG9zaXRpb24gPSB2ZWM0KCBwb3NpdGlvbiwgMS4wICk7Cn1gLCBkRSA9IGB1bmlmb3JtIHNhbXBsZXIyRCBzaGFkb3dfcGFzczsKdW5pZm9ybSB2ZWMyIHJlc29sdXRpb247CnVuaWZvcm0gZmxvYXQgcmFkaXVzOwojaW5jbHVkZSA8cGFja2luZz4Kdm9pZCBtYWluKCkgewoJY29uc3QgZmxvYXQgc2FtcGxlcyA9IGZsb2F0KCBWU01fU0FNUExFUyApOwoJZmxvYXQgbWVhbiA9IDAuMDsKCWZsb2F0IHNxdWFyZWRfbWVhbiA9IDAuMDsKCWZsb2F0IHV2U3RyaWRlID0gc2FtcGxlcyA8PSAxLjAgPyAwLjAgOiAyLjAgLyAoIHNhbXBsZXMgLSAxLjAgKTsKCWZsb2F0IHV2U3RhcnQgPSBzYW1wbGVzIDw9IDEuMCA/IDAuMCA6IC0gMS4wOwoJZm9yICggZmxvYXQgaSA9IDAuMDsgaSA8IHNhbXBsZXM7IGkgKysgKSB7CgkJZmxvYXQgdXZPZmZzZXQgPSB1dlN0YXJ0ICsgaSAqIHV2U3RyaWRlOwoJCSNpZmRlZiBIT1JJWk9OVEFMX1BBU1MKCQkJdmVjMiBkaXN0cmlidXRpb24gPSB1bnBhY2tSR0JBVG8ySGFsZiggdGV4dHVyZTJEKCBzaGFkb3dfcGFzcywgKCBnbF9GcmFnQ29vcmQueHkgKyB2ZWMyKCB1dk9mZnNldCwgMC4wICkgKiByYWRpdXMgKSAvIHJlc29sdXRpb24gKSApOwoJCQltZWFuICs9IGRpc3RyaWJ1dGlvbi54OwoJCQlzcXVhcmVkX21lYW4gKz0gZGlzdHJpYnV0aW9uLnkgKiBkaXN0cmlidXRpb24ueSArIGRpc3RyaWJ1dGlvbi54ICogZGlzdHJpYnV0aW9uLng7CgkJI2Vsc2UKCQkJZmxvYXQgZGVwdGggPSB1bnBhY2tSR0JBVG9EZXB0aCggdGV4dHVyZTJEKCBzaGFkb3dfcGFzcywgKCBnbF9GcmFnQ29vcmQueHkgKyB2ZWMyKCAwLjAsIHV2T2Zmc2V0ICkgKiByYWRpdXMgKSAvIHJlc29sdXRpb24gKSApOwoJCQltZWFuICs9IGRlcHRoOwoJCQlzcXVhcmVkX21lYW4gKz0gZGVwdGggKiBkZXB0aDsKCQkjZW5kaWYKCX0KCW1lYW4gPSBtZWFuIC8gc2FtcGxlczsKCXNxdWFyZWRfbWVhbiA9IHNxdWFyZWRfbWVhbiAvIHNhbXBsZXM7CglmbG9hdCBzdGRfZGV2ID0gc3FydCggc3F1YXJlZF9tZWFuIC0gbWVhbiAqIG1lYW4gKTsKCWdsX0ZyYWdDb2xvciA9IHBhY2sySGFsZlRvUkdCQSggdmVjMiggbWVhbiwgc3RkX2RldiApICk7Cn1gOwpmdW5jdGlvbiBwRShhLCB0LCBlKSB7CiAgbGV0IGkgPSBuZXcgRWEoKTsKICBjb25zdCBuID0gbmV3IEooKSwgcyA9IG5ldyBKKCksIHIgPSBuZXcgUXQoKSwgbyA9IG5ldyBqcCh7IGRlcHRoUGFja2luZzogbnkgfSksIGwgPSBuZXcgSnAoKSwgaCA9IHt9LCBjID0gZS5tYXhUZXh0dXJlU2l6ZSwgdSA9IHsgWyRpXTogSGUsIFtIZV06ICRpLCBbTWldOiBNaSB9LCBkID0gbmV3IFhpKHsKICAgIGRlZmluZXM6IHsKICAgICAgVlNNX1NBTVBMRVM6IDgKICAgIH0sCiAgICB1bmlmb3JtczogewogICAgICBzaGFkb3dfcGFzczogeyB2YWx1ZTogbnVsbCB9LAogICAgICByZXNvbHV0aW9uOiB7IHZhbHVlOiBuZXcgSigpIH0sCiAgICAgIHJhZGl1czogeyB2YWx1ZTogNCB9CiAgICB9LAogICAgdmVydGV4U2hhZGVyOiB1RSwKICAgIGZyYWdtZW50U2hhZGVyOiBkRQogIH0pLCBwID0gZC5jbG9uZSgpOwogIHAuZGVmaW5lcy5IT1JJWk9OVEFMX1BBU1MgPSAxOwogIGNvbnN0IGYgPSBuZXcgSHQoKTsKICBmLnNldEF0dHJpYnV0ZSgKICAgICJwb3NpdGlvbiIsCiAgICBuZXcgaWUoCiAgICAgIG5ldyBGbG9hdDMyQXJyYXkoWy0xLCAtMSwgMC41LCAzLCAtMSwgMC41LCAtMSwgMywgMC41XSksCiAgICAgIDMKICAgICkKICApOwogIGNvbnN0IHkgPSBuZXcgcmUoZiwgZCksIGcgPSB0aGlzOwogIHRoaXMuZW5hYmxlZCA9ICExLCB0aGlzLmF1dG9VcGRhdGUgPSAhMCwgdGhpcy5uZWVkc1VwZGF0ZSA9ICExLCB0aGlzLnR5cGUgPSBNcDsKICBsZXQgbSA9IHRoaXMudHlwZTsKICB0aGlzLnJlbmRlciA9IGZ1bmN0aW9uKHcsIFQsIFIpIHsKICAgIGlmIChnLmVuYWJsZWQgPT09ICExIHx8IGcuYXV0b1VwZGF0ZSA9PT0gITEgJiYgZy5uZWVkc1VwZGF0ZSA9PT0gITEgfHwgdy5sZW5ndGggPT09IDApIHJldHVybjsKICAgIGNvbnN0IGIgPSBhLmdldFJlbmRlclRhcmdldCgpLCBNID0gYS5nZXRBY3RpdmVDdWJlRmFjZSgpLCBMID0gYS5nZXRBY3RpdmVNaXBtYXBMZXZlbCgpLCBVID0gYS5zdGF0ZTsKICAgIFUuc2V0QmxlbmRpbmcoWW4pLCBVLmJ1ZmZlcnMuZGVwdGguZ2V0UmV2ZXJzZWQoKSA9PT0gITAgPyBVLmJ1ZmZlcnMuY29sb3Iuc2V0Q2xlYXIoMCwgMCwgMCwgMCkgOiBVLmJ1ZmZlcnMuY29sb3Iuc2V0Q2xlYXIoMSwgMSwgMSwgMSksIFUuYnVmZmVycy5kZXB0aC5zZXRUZXN0KCEwKSwgVS5zZXRTY2lzc29yVGVzdCghMSk7CiAgICBjb25zdCBPID0gbSAhPT0gU24gJiYgdGhpcy50eXBlID09PSBTbiwgViA9IG0gPT09IFNuICYmIHRoaXMudHlwZSAhPT0gU247CiAgICBmb3IgKGxldCBXID0gMCwgRyA9IHcubGVuZ3RoOyBXIDwgRzsgVysrKSB7CiAgICAgIGNvbnN0IGV0ID0gd1tXXSwgSCA9IGV0LnNoYWRvdzsKICAgICAgaWYgKEggPT09IHZvaWQgMCkgewogICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xTaGFkb3dNYXA6IiwgZXQsICJoYXMgbm8gc2hhZG93LiIpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChILmF1dG9VcGRhdGUgPT09ICExICYmIEgubmVlZHNVcGRhdGUgPT09ICExKSBjb250aW51ZTsKICAgICAgbi5jb3B5KEgubWFwU2l6ZSk7CiAgICAgIGNvbnN0IGF0ID0gSC5nZXRGcmFtZUV4dGVudHMoKTsKICAgICAgaWYgKG4ubXVsdGlwbHkoYXQpLCBzLmNvcHkoSC5tYXBTaXplKSwgKG4ueCA+IGMgfHwgbi55ID4gYykgJiYgKG4ueCA+IGMgJiYgKHMueCA9IE1hdGguZmxvb3IoYyAvIGF0LngpLCBuLnggPSBzLnggKiBhdC54LCBILm1hcFNpemUueCA9IHMueCksIG4ueSA+IGMgJiYgKHMueSA9IE1hdGguZmxvb3IoYyAvIGF0LnkpLCBuLnkgPSBzLnkgKiBhdC55LCBILm1hcFNpemUueSA9IHMueSkpLCBILm1hcCA9PT0gbnVsbCB8fCBPID09PSAhMCB8fCBWID09PSAhMCkgewogICAgICAgIGNvbnN0IE10ID0gdGhpcy50eXBlICE9PSBTbiA/IHsgbWluRmlsdGVyOiBqZSwgbWFnRmlsdGVyOiBqZSB9IDoge307CiAgICAgICAgSC5tYXAgIT09IG51bGwgJiYgSC5tYXAuZGlzcG9zZSgpLCBILm1hcCA9IG5ldyBSbihuLngsIG4ueSwgTXQpLCBILm1hcC50ZXh0dXJlLm5hbWUgPSBldC5uYW1lICsgIi5zaGFkb3dNYXAiLCBILmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICAgIH0KICAgICAgYS5zZXRSZW5kZXJUYXJnZXQoSC5tYXApLCBhLmNsZWFyKCk7CiAgICAgIGNvbnN0IHB0ID0gSC5nZXRWaWV3cG9ydENvdW50KCk7CiAgICAgIGZvciAobGV0IE10ID0gMDsgTXQgPCBwdDsgTXQrKykgewogICAgICAgIGNvbnN0IEx0ID0gSC5nZXRWaWV3cG9ydChNdCk7CiAgICAgICAgci5zZXQoCiAgICAgICAgICBzLnggKiBMdC54LAogICAgICAgICAgcy55ICogTHQueSwKICAgICAgICAgIHMueCAqIEx0LnosCiAgICAgICAgICBzLnkgKiBMdC53CiAgICAgICAgKSwgVS52aWV3cG9ydChyKSwgSC51cGRhdGVNYXRyaWNlcyhldCwgTXQpLCBpID0gSC5nZXRGcnVzdHVtKCksIF8oVCwgUiwgSC5jYW1lcmEsIGV0LCB0aGlzLnR5cGUpOwogICAgICB9CiAgICAgIEguaXNQb2ludExpZ2h0U2hhZG93ICE9PSAhMCAmJiB0aGlzLnR5cGUgPT09IFNuICYmIHYoSCwgUiksIEgubmVlZHNVcGRhdGUgPSAhMTsKICAgIH0KICAgIG0gPSB0aGlzLnR5cGUsIGcubmVlZHNVcGRhdGUgPSAhMSwgYS5zZXRSZW5kZXJUYXJnZXQoYiwgTSwgTCk7CiAgfTsKICBmdW5jdGlvbiB2KHcsIFQpIHsKICAgIGNvbnN0IFIgPSB0LnVwZGF0ZSh5KTsKICAgIGQuZGVmaW5lcy5WU01fU0FNUExFUyAhPT0gdy5ibHVyU2FtcGxlcyAmJiAoZC5kZWZpbmVzLlZTTV9TQU1QTEVTID0gdy5ibHVyU2FtcGxlcywgcC5kZWZpbmVzLlZTTV9TQU1QTEVTID0gdy5ibHVyU2FtcGxlcywgZC5uZWVkc1VwZGF0ZSA9ICEwLCBwLm5lZWRzVXBkYXRlID0gITApLCB3Lm1hcFBhc3MgPT09IG51bGwgJiYgKHcubWFwUGFzcyA9IG5ldyBSbihuLngsIG4ueSkpLCBkLnVuaWZvcm1zLnNoYWRvd19wYXNzLnZhbHVlID0gdy5tYXAudGV4dHVyZSwgZC51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlID0gdy5tYXBTaXplLCBkLnVuaWZvcm1zLnJhZGl1cy52YWx1ZSA9IHcucmFkaXVzLCBhLnNldFJlbmRlclRhcmdldCh3Lm1hcFBhc3MpLCBhLmNsZWFyKCksIGEucmVuZGVyQnVmZmVyRGlyZWN0KFQsIG51bGwsIFIsIGQsIHksIG51bGwpLCBwLnVuaWZvcm1zLnNoYWRvd19wYXNzLnZhbHVlID0gdy5tYXBQYXNzLnRleHR1cmUsIHAudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZSA9IHcubWFwU2l6ZSwgcC51bmlmb3Jtcy5yYWRpdXMudmFsdWUgPSB3LnJhZGl1cywgYS5zZXRSZW5kZXJUYXJnZXQody5tYXApLCBhLmNsZWFyKCksIGEucmVuZGVyQnVmZmVyRGlyZWN0KFQsIG51bGwsIFIsIHAsIHksIG51bGwpOwogIH0KICBmdW5jdGlvbiB4KHcsIFQsIFIsIGIpIHsKICAgIGxldCBNID0gbnVsbDsKICAgIGNvbnN0IEwgPSBSLmlzUG9pbnRMaWdodCA9PT0gITAgPyB3LmN1c3RvbURpc3RhbmNlTWF0ZXJpYWwgOiB3LmN1c3RvbURlcHRoTWF0ZXJpYWw7CiAgICBpZiAoTCAhPT0gdm9pZCAwKQogICAgICBNID0gTDsKICAgIGVsc2UgaWYgKE0gPSBSLmlzUG9pbnRMaWdodCA9PT0gITAgPyBsIDogbywgYS5sb2NhbENsaXBwaW5nRW5hYmxlZCAmJiBULmNsaXBTaGFkb3dzID09PSAhMCAmJiBBcnJheS5pc0FycmF5KFQuY2xpcHBpbmdQbGFuZXMpICYmIFQuY2xpcHBpbmdQbGFuZXMubGVuZ3RoICE9PSAwIHx8IFQuZGlzcGxhY2VtZW50TWFwICYmIFQuZGlzcGxhY2VtZW50U2NhbGUgIT09IDAgfHwgVC5hbHBoYU1hcCAmJiBULmFscGhhVGVzdCA+IDAgfHwgVC5tYXAgJiYgVC5hbHBoYVRlc3QgPiAwIHx8IFQuYWxwaGFUb0NvdmVyYWdlID09PSAhMCkgewogICAgICBjb25zdCBVID0gTS51dWlkLCBPID0gVC51dWlkOwogICAgICBsZXQgViA9IGhbVV07CiAgICAgIFYgPT09IHZvaWQgMCAmJiAoViA9IHt9LCBoW1VdID0gVik7CiAgICAgIGxldCBXID0gVltPXTsKICAgICAgVyA9PT0gdm9pZCAwICYmIChXID0gTS5jbG9uZSgpLCBWW09dID0gVywgVC5hZGRFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgUykpLCBNID0gVzsKICAgIH0KICAgIGlmIChNLnZpc2libGUgPSBULnZpc2libGUsIE0ud2lyZWZyYW1lID0gVC53aXJlZnJhbWUsIGIgPT09IFNuID8gTS5zaWRlID0gVC5zaGFkb3dTaWRlICE9PSBudWxsID8gVC5zaGFkb3dTaWRlIDogVC5zaWRlIDogTS5zaWRlID0gVC5zaGFkb3dTaWRlICE9PSBudWxsID8gVC5zaGFkb3dTaWRlIDogdVtULnNpZGVdLCBNLmFscGhhTWFwID0gVC5hbHBoYU1hcCwgTS5hbHBoYVRlc3QgPSBULmFscGhhVG9Db3ZlcmFnZSA9PT0gITAgPyAwLjUgOiBULmFscGhhVGVzdCwgTS5tYXAgPSBULm1hcCwgTS5jbGlwU2hhZG93cyA9IFQuY2xpcFNoYWRvd3MsIE0uY2xpcHBpbmdQbGFuZXMgPSBULmNsaXBwaW5nUGxhbmVzLCBNLmNsaXBJbnRlcnNlY3Rpb24gPSBULmNsaXBJbnRlcnNlY3Rpb24sIE0uZGlzcGxhY2VtZW50TWFwID0gVC5kaXNwbGFjZW1lbnRNYXAsIE0uZGlzcGxhY2VtZW50U2NhbGUgPSBULmRpc3BsYWNlbWVudFNjYWxlLCBNLmRpc3BsYWNlbWVudEJpYXMgPSBULmRpc3BsYWNlbWVudEJpYXMsIE0ud2lyZWZyYW1lTGluZXdpZHRoID0gVC53aXJlZnJhbWVMaW5ld2lkdGgsIE0ubGluZXdpZHRoID0gVC5saW5ld2lkdGgsIFIuaXNQb2ludExpZ2h0ID09PSAhMCAmJiBNLmlzTWVzaERpc3RhbmNlTWF0ZXJpYWwgPT09ICEwKSB7CiAgICAgIGNvbnN0IFUgPSBhLnByb3BlcnRpZXMuZ2V0KE0pOwogICAgICBVLmxpZ2h0ID0gUjsKICAgIH0KICAgIHJldHVybiBNOwogIH0KICBmdW5jdGlvbiBfKHcsIFQsIFIsIGIsIE0pIHsKICAgIGlmICh3LnZpc2libGUgPT09ICExKSByZXR1cm47CiAgICBpZiAody5sYXllcnMudGVzdChULmxheWVycykgJiYgKHcuaXNNZXNoIHx8IHcuaXNMaW5lIHx8IHcuaXNQb2ludHMpICYmICh3LmNhc3RTaGFkb3cgfHwgdy5yZWNlaXZlU2hhZG93ICYmIE0gPT09IFNuKSAmJiAoIXcuZnJ1c3R1bUN1bGxlZCB8fCBpLmludGVyc2VjdHNPYmplY3QodykpKSB7CiAgICAgIHcubW9kZWxWaWV3TWF0cml4Lm11bHRpcGx5TWF0cmljZXMoUi5tYXRyaXhXb3JsZEludmVyc2UsIHcubWF0cml4V29ybGQpOwogICAgICBjb25zdCBPID0gdC51cGRhdGUodyksIFYgPSB3Lm1hdGVyaWFsOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShWKSkgewogICAgICAgIGNvbnN0IFcgPSBPLmdyb3VwczsKICAgICAgICBmb3IgKGxldCBHID0gMCwgZXQgPSBXLmxlbmd0aDsgRyA8IGV0OyBHKyspIHsKICAgICAgICAgIGNvbnN0IEggPSBXW0ddLCBhdCA9IFZbSC5tYXRlcmlhbEluZGV4XTsKICAgICAgICAgIGlmIChhdCAmJiBhdC52aXNpYmxlKSB7CiAgICAgICAgICAgIGNvbnN0IHB0ID0geCh3LCBhdCwgYiwgTSk7CiAgICAgICAgICAgIHcub25CZWZvcmVTaGFkb3coYSwgdywgVCwgUiwgTywgcHQsIEgpLCBhLnJlbmRlckJ1ZmZlckRpcmVjdChSLCBudWxsLCBPLCBwdCwgdywgSCksIHcub25BZnRlclNoYWRvdyhhLCB3LCBULCBSLCBPLCBwdCwgSCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKFYudmlzaWJsZSkgewogICAgICAgIGNvbnN0IFcgPSB4KHcsIFYsIGIsIE0pOwogICAgICAgIHcub25CZWZvcmVTaGFkb3coYSwgdywgVCwgUiwgTywgVywgbnVsbCksIGEucmVuZGVyQnVmZmVyRGlyZWN0KFIsIG51bGwsIE8sIFcsIHcsIG51bGwpLCB3Lm9uQWZ0ZXJTaGFkb3coYSwgdywgVCwgUiwgTywgVywgbnVsbCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IFUgPSB3LmNoaWxkcmVuOwogICAgZm9yIChsZXQgTyA9IDAsIFYgPSBVLmxlbmd0aDsgTyA8IFY7IE8rKykKICAgICAgXyhVW09dLCBULCBSLCBiLCBNKTsKICB9CiAgZnVuY3Rpb24gUyh3KSB7CiAgICB3LnRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgUyk7CiAgICBmb3IgKGNvbnN0IFIgaW4gaCkgewogICAgICBjb25zdCBiID0gaFtSXSwgTSA9IHcudGFyZ2V0LnV1aWQ7CiAgICAgIE0gaW4gYiAmJiAoYltNXS5kaXNwb3NlKCksIGRlbGV0ZSBiW01dKTsKICAgIH0KICB9Cn0KY29uc3QgZkUgPSB7CiAgW0RoXTogRmgsCiAgW1VoXTogTmgsCiAgW0JoXTogT2gsCiAgW3ByXTogemgsCiAgW0ZoXTogRGgsCiAgW05oXTogVWgsCiAgW09oXTogQmgsCiAgW3poXTogcHIKfTsKZnVuY3Rpb24gbUUoYSwgdCkgewogIGZ1bmN0aW9uIGUoKSB7CiAgICBsZXQgRiA9ICExOwogICAgY29uc3QgaHQgPSBuZXcgUXQoKTsKICAgIGxldCBfdCA9IG51bGw7CiAgICBjb25zdCBSdCA9IG5ldyBRdCgwLCAwLCAwLCAwKTsKICAgIHJldHVybiB7CiAgICAgIHNldE1hc2s6IGZ1bmN0aW9uKGR0KSB7CiAgICAgICAgX3QgIT09IGR0ICYmICFGICYmIChhLmNvbG9yTWFzayhkdCwgZHQsIGR0LCBkdCksIF90ID0gZHQpOwogICAgICB9LAogICAgICBzZXRMb2NrZWQ6IGZ1bmN0aW9uKGR0KSB7CiAgICAgICAgRiA9IGR0OwogICAgICB9LAogICAgICBzZXRDbGVhcjogZnVuY3Rpb24oZHQsIG50LCBGdCwgcXQsIGdlKSB7CiAgICAgICAgZ2UgPT09ICEwICYmIChkdCAqPSBxdCwgbnQgKj0gcXQsIEZ0ICo9IHF0KSwgaHQuc2V0KGR0LCBudCwgRnQsIHF0KSwgUnQuZXF1YWxzKGh0KSA9PT0gITEgJiYgKGEuY2xlYXJDb2xvcihkdCwgbnQsIEZ0LCBxdCksIFJ0LmNvcHkoaHQpKTsKICAgICAgfSwKICAgICAgcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIEYgPSAhMSwgX3QgPSBudWxsLCBSdC5zZXQoLTEsIDAsIDAsIDApOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBpKCkgewogICAgbGV0IEYgPSAhMSwgaHQgPSAhMSwgX3QgPSBudWxsLCBSdCA9IG51bGwsIGR0ID0gbnVsbDsKICAgIHJldHVybiB7CiAgICAgIHNldFJldmVyc2VkOiBmdW5jdGlvbihudCkgewogICAgICAgIGlmIChodCAhPT0gbnQpIHsKICAgICAgICAgIGNvbnN0IEZ0ID0gdC5nZXQoIkVYVF9jbGlwX2NvbnRyb2wiKTsKICAgICAgICAgIG50ID8gRnQuY2xpcENvbnRyb2xFWFQoRnQuTE9XRVJfTEVGVF9FWFQsIEZ0LlpFUk9fVE9fT05FX0VYVCkgOiBGdC5jbGlwQ29udHJvbEVYVChGdC5MT1dFUl9MRUZUX0VYVCwgRnQuTkVHQVRJVkVfT05FX1RPX09ORV9FWFQpLCBodCA9IG50OwogICAgICAgICAgY29uc3QgcXQgPSBkdDsKICAgICAgICAgIGR0ID0gbnVsbCwgdGhpcy5zZXRDbGVhcihxdCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRSZXZlcnNlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGh0OwogICAgICB9LAogICAgICBzZXRUZXN0OiBmdW5jdGlvbihudCkgewogICAgICAgIG50ID8gc3QoYS5ERVBUSF9URVNUKSA6IEV0KGEuREVQVEhfVEVTVCk7CiAgICAgIH0sCiAgICAgIHNldE1hc2s6IGZ1bmN0aW9uKG50KSB7CiAgICAgICAgX3QgIT09IG50ICYmICFGICYmIChhLmRlcHRoTWFzayhudCksIF90ID0gbnQpOwogICAgICB9LAogICAgICBzZXRGdW5jOiBmdW5jdGlvbihudCkgewogICAgICAgIGlmIChodCAmJiAobnQgPSBmRVtudF0pLCBSdCAhPT0gbnQpIHsKICAgICAgICAgIHN3aXRjaCAobnQpIHsKICAgICAgICAgICAgY2FzZSBEaDoKICAgICAgICAgICAgICBhLmRlcHRoRnVuYyhhLk5FVkVSKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBGaDoKICAgICAgICAgICAgICBhLmRlcHRoRnVuYyhhLkFMV0FZUyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVWg6CiAgICAgICAgICAgICAgYS5kZXB0aEZ1bmMoYS5MRVNTKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBwcjoKICAgICAgICAgICAgICBhLmRlcHRoRnVuYyhhLkxFUVVBTCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQmg6CiAgICAgICAgICAgICAgYS5kZXB0aEZ1bmMoYS5FUVVBTCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2Ugemg6CiAgICAgICAgICAgICAgYS5kZXB0aEZ1bmMoYS5HRVFVQUwpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIE5oOgogICAgICAgICAgICAgIGEuZGVwdGhGdW5jKGEuR1JFQVRFUik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgT2g6CiAgICAgICAgICAgICAgYS5kZXB0aEZ1bmMoYS5OT1RFUVVBTCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgYS5kZXB0aEZ1bmMoYS5MRVFVQUwpOwogICAgICAgICAgfQogICAgICAgICAgUnQgPSBudDsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldExvY2tlZDogZnVuY3Rpb24obnQpIHsKICAgICAgICBGID0gbnQ7CiAgICAgIH0sCiAgICAgIHNldENsZWFyOiBmdW5jdGlvbihudCkgewogICAgICAgIGR0ICE9PSBudCAmJiAoaHQgJiYgKG50ID0gMSAtIG50KSwgYS5jbGVhckRlcHRoKG50KSwgZHQgPSBudCk7CiAgICAgIH0sCiAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBGID0gITEsIF90ID0gbnVsbCwgUnQgPSBudWxsLCBkdCA9IG51bGwsIGh0ID0gITE7CiAgICAgIH0KICAgIH07CiAgfQogIGZ1bmN0aW9uIG4oKSB7CiAgICBsZXQgRiA9ICExLCBodCA9IG51bGwsIF90ID0gbnVsbCwgUnQgPSBudWxsLCBkdCA9IG51bGwsIG50ID0gbnVsbCwgRnQgPSBudWxsLCBxdCA9IG51bGwsIGdlID0gbnVsbDsKICAgIHJldHVybiB7CiAgICAgIHNldFRlc3Q6IGZ1bmN0aW9uKG9lKSB7CiAgICAgICAgRiB8fCAob2UgPyBzdChhLlNURU5DSUxfVEVTVCkgOiBFdChhLlNURU5DSUxfVEVTVCkpOwogICAgICB9LAogICAgICBzZXRNYXNrOiBmdW5jdGlvbihvZSkgewogICAgICAgIGh0ICE9PSBvZSAmJiAhRiAmJiAoYS5zdGVuY2lsTWFzayhvZSksIGh0ID0gb2UpOwogICAgICB9LAogICAgICBzZXRGdW5jOiBmdW5jdGlvbihvZSwgSW4sIGduKSB7CiAgICAgICAgKF90ICE9PSBvZSB8fCBSdCAhPT0gSW4gfHwgZHQgIT09IGduKSAmJiAoYS5zdGVuY2lsRnVuYyhvZSwgSW4sIGduKSwgX3QgPSBvZSwgUnQgPSBJbiwgZHQgPSBnbik7CiAgICAgIH0sCiAgICAgIHNldE9wOiBmdW5jdGlvbihvZSwgSW4sIGduKSB7CiAgICAgICAgKG50ICE9PSBvZSB8fCBGdCAhPT0gSW4gfHwgcXQgIT09IGduKSAmJiAoYS5zdGVuY2lsT3Aob2UsIEluLCBnbiksIG50ID0gb2UsIEZ0ID0gSW4sIHF0ID0gZ24pOwogICAgICB9LAogICAgICBzZXRMb2NrZWQ6IGZ1bmN0aW9uKG9lKSB7CiAgICAgICAgRiA9IG9lOwogICAgICB9LAogICAgICBzZXRDbGVhcjogZnVuY3Rpb24ob2UpIHsKICAgICAgICBnZSAhPT0gb2UgJiYgKGEuY2xlYXJTdGVuY2lsKG9lKSwgZ2UgPSBvZSk7CiAgICAgIH0sCiAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBGID0gITEsIGh0ID0gbnVsbCwgX3QgPSBudWxsLCBSdCA9IG51bGwsIGR0ID0gbnVsbCwgbnQgPSBudWxsLCBGdCA9IG51bGwsIHF0ID0gbnVsbCwgZ2UgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0KICBjb25zdCBzID0gbmV3IGUoKSwgciA9IG5ldyBpKCksIG8gPSBuZXcgbigpLCBsID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCksIGggPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBsZXQgYyA9IHt9LCB1ID0ge30sIGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwgcCA9IFtdLCBmID0gbnVsbCwgeSA9ICExLCBnID0gbnVsbCwgbSA9IG51bGwsIHYgPSBudWxsLCB4ID0gbnVsbCwgXyA9IG51bGwsIFMgPSBudWxsLCB3ID0gbnVsbCwgVCA9IG5ldyBjdCgwLCAwLCAwKSwgUiA9IDAsIGIgPSAhMSwgTSA9IG51bGwsIEwgPSBudWxsLCBVID0gbnVsbCwgTyA9IG51bGwsIFYgPSBudWxsOwogIGNvbnN0IFcgPSBhLmdldFBhcmFtZXRlcihhLk1BWF9DT01CSU5FRF9URVhUVVJFX0lNQUdFX1VOSVRTKTsKICBsZXQgRyA9ICExLCBldCA9IDA7CiAgY29uc3QgSCA9IGEuZ2V0UGFyYW1ldGVyKGEuVkVSU0lPTik7CiAgSC5pbmRleE9mKCJXZWJHTCIpICE9PSAtMSA/IChldCA9IHBhcnNlRmxvYXQoL15XZWJHTCAoXGQpLy5leGVjKEgpWzFdKSwgRyA9IGV0ID49IDEpIDogSC5pbmRleE9mKCJPcGVuR0wgRVMiKSAhPT0gLTEgJiYgKGV0ID0gcGFyc2VGbG9hdCgvXk9wZW5HTCBFUyAoXGQpLy5leGVjKEgpWzFdKSwgRyA9IGV0ID49IDIpOwogIGxldCBhdCA9IG51bGwsIHB0ID0ge307CiAgY29uc3QgTXQgPSBhLmdldFBhcmFtZXRlcihhLlNDSVNTT1JfQk9YKSwgTHQgPSBhLmdldFBhcmFtZXRlcihhLlZJRVdQT1JUKSwganQgPSBuZXcgUXQoKS5mcm9tQXJyYXkoTXQpLCBuZSA9IG5ldyBRdCgpLmZyb21BcnJheShMdCk7CiAgZnVuY3Rpb24gSnQoRiwgaHQsIF90LCBSdCkgewogICAgY29uc3QgZHQgPSBuZXcgVWludDhBcnJheSg0KSwgbnQgPSBhLmNyZWF0ZVRleHR1cmUoKTsKICAgIGEuYmluZFRleHR1cmUoRiwgbnQpLCBhLnRleFBhcmFtZXRlcmkoRiwgYS5URVhUVVJFX01JTl9GSUxURVIsIGEuTkVBUkVTVCksIGEudGV4UGFyYW1ldGVyaShGLCBhLlRFWFRVUkVfTUFHX0ZJTFRFUiwgYS5ORUFSRVNUKTsKICAgIGZvciAobGV0IEZ0ID0gMDsgRnQgPCBfdDsgRnQrKykKICAgICAgRiA9PT0gYS5URVhUVVJFXzNEIHx8IEYgPT09IGEuVEVYVFVSRV8yRF9BUlJBWSA/IGEudGV4SW1hZ2UzRChodCwgMCwgYS5SR0JBLCAxLCAxLCBSdCwgMCwgYS5SR0JBLCBhLlVOU0lHTkVEX0JZVEUsIGR0KSA6IGEudGV4SW1hZ2UyRChodCArIEZ0LCAwLCBhLlJHQkEsIDEsIDEsIDAsIGEuUkdCQSwgYS5VTlNJR05FRF9CWVRFLCBkdCk7CiAgICByZXR1cm4gbnQ7CiAgfQogIGNvbnN0IFkgPSB7fTsKICBZW2EuVEVYVFVSRV8yRF0gPSBKdChhLlRFWFRVUkVfMkQsIGEuVEVYVFVSRV8yRCwgMSksIFlbYS5URVhUVVJFX0NVQkVfTUFQXSA9IEp0KGEuVEVYVFVSRV9DVUJFX01BUCwgYS5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1gsIDYpLCBZW2EuVEVYVFVSRV8yRF9BUlJBWV0gPSBKdChhLlRFWFRVUkVfMkRfQVJSQVksIGEuVEVYVFVSRV8yRF9BUlJBWSwgMSwgMSksIFlbYS5URVhUVVJFXzNEXSA9IEp0KGEuVEVYVFVSRV8zRCwgYS5URVhUVVJFXzNELCAxLCAxKSwgcy5zZXRDbGVhcigwLCAwLCAwLCAxKSwgci5zZXRDbGVhcigxKSwgby5zZXRDbGVhcigwKSwgc3QoYS5ERVBUSF9URVNUKSwgci5zZXRGdW5jKHByKSwgUSghMSksIEsoWWQpLCBzdChhLkNVTExfRkFDRSksIG90KFluKTsKICBmdW5jdGlvbiBzdChGKSB7CiAgICBjW0ZdICE9PSAhMCAmJiAoYS5lbmFibGUoRiksIGNbRl0gPSAhMCk7CiAgfQogIGZ1bmN0aW9uIEV0KEYpIHsKICAgIGNbRl0gIT09ICExICYmIChhLmRpc2FibGUoRiksIGNbRl0gPSAhMSk7CiAgfQogIGZ1bmN0aW9uIFV0KEYsIGh0KSB7CiAgICByZXR1cm4gdVtGXSAhPT0gaHQgPyAoYS5iaW5kRnJhbWVidWZmZXIoRiwgaHQpLCB1W0ZdID0gaHQsIEYgPT09IGEuRFJBV19GUkFNRUJVRkZFUiAmJiAodVthLkZSQU1FQlVGRkVSXSA9IGh0KSwgRiA9PT0gYS5GUkFNRUJVRkZFUiAmJiAodVthLkRSQVdfRlJBTUVCVUZGRVJdID0gaHQpLCAhMCkgOiAhMTsKICB9CiAgZnVuY3Rpb24gUHQoRiwgaHQpIHsKICAgIGxldCBfdCA9IHAsIFJ0ID0gITE7CiAgICBpZiAoRikgewogICAgICBfdCA9IGQuZ2V0KGh0KSwgX3QgPT09IHZvaWQgMCAmJiAoX3QgPSBbXSwgZC5zZXQoaHQsIF90KSk7CiAgICAgIGNvbnN0IGR0ID0gRi50ZXh0dXJlczsKICAgICAgaWYgKF90Lmxlbmd0aCAhPT0gZHQubGVuZ3RoIHx8IF90WzBdICE9PSBhLkNPTE9SX0FUVEFDSE1FTlQwKSB7CiAgICAgICAgZm9yIChsZXQgbnQgPSAwLCBGdCA9IGR0Lmxlbmd0aDsgbnQgPCBGdDsgbnQrKykKICAgICAgICAgIF90W250XSA9IGEuQ09MT1JfQVRUQUNITUVOVDAgKyBudDsKICAgICAgICBfdC5sZW5ndGggPSBkdC5sZW5ndGgsIFJ0ID0gITA7CiAgICAgIH0KICAgIH0gZWxzZQogICAgICBfdFswXSAhPT0gYS5CQUNLICYmIChfdFswXSA9IGEuQkFDSywgUnQgPSAhMCk7CiAgICBSdCAmJiBhLmRyYXdCdWZmZXJzKF90KTsKICB9CiAgZnVuY3Rpb24gS3QoRikgewogICAgcmV0dXJuIGYgIT09IEYgPyAoYS51c2VQcm9ncmFtKEYpLCBmID0gRiwgITApIDogITE7CiAgfQogIGNvbnN0IGhlID0gewogICAgW3ZzXTogYS5GVU5DX0FERCwKICAgIFtDMF06IGEuRlVOQ19TVUJUUkFDVCwKICAgIFtSMF06IGEuRlVOQ19SRVZFUlNFX1NVQlRSQUNUCiAgfTsKICBoZVtQMF0gPSBhLk1JTiwgaGVbSTBdID0gYS5NQVg7CiAgY29uc3QgRCA9IHsKICAgIFtMMF06IGEuWkVSTywKICAgIFtEMF06IGEuT05FLAogICAgW0YwXTogYS5TUkNfQ09MT1IsCiAgICBbSWhdOiBhLlNSQ19BTFBIQSwKICAgIFtrMF06IGEuU1JDX0FMUEhBX1NBVFVSQVRFLAogICAgW04wXTogYS5EU1RfQ09MT1IsCiAgICBbQjBdOiBhLkRTVF9BTFBIQSwKICAgIFtVMF06IGEuT05FX01JTlVTX1NSQ19DT0xPUiwKICAgIFtMaF06IGEuT05FX01JTlVTX1NSQ19BTFBIQSwKICAgIFtPMF06IGEuT05FX01JTlVTX0RTVF9DT0xPUiwKICAgIFt6MF06IGEuT05FX01JTlVTX0RTVF9BTFBIQSwKICAgIFtWMF06IGEuQ09OU1RBTlRfQ09MT1IsCiAgICBbSDBdOiBhLk9ORV9NSU5VU19DT05TVEFOVF9DT0xPUiwKICAgIFtHMF06IGEuQ09OU1RBTlRfQUxQSEEsCiAgICBbVzBdOiBhLk9ORV9NSU5VU19DT05TVEFOVF9BTFBIQQogIH07CiAgZnVuY3Rpb24gb3QoRiwgaHQsIF90LCBSdCwgZHQsIG50LCBGdCwgcXQsIGdlLCBvZSkgewogICAgaWYgKEYgPT09IFluKSB7CiAgICAgIHkgPT09ICEwICYmIChFdChhLkJMRU5EKSwgeSA9ICExKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHkgPT09ICExICYmIChzdChhLkJMRU5EKSwgeSA9ICEwKSwgRiAhPT0gVDApIHsKICAgICAgaWYgKEYgIT09IGcgfHwgb2UgIT09IGIpIHsKICAgICAgICBpZiAoKG0gIT09IHZzIHx8IF8gIT09IHZzKSAmJiAoYS5ibGVuZEVxdWF0aW9uKGEuRlVOQ19BREQpLCBtID0gdnMsIF8gPSB2cyksIG9lKQogICAgICAgICAgc3dpdGNoIChGKSB7CiAgICAgICAgICAgIGNhc2Ugd3M6CiAgICAgICAgICAgICAgYS5ibGVuZEZ1bmNTZXBhcmF0ZShhLk9ORSwgYS5PTkVfTUlOVVNfU1JDX0FMUEhBLCBhLk9ORSwgYS5PTkVfTUlOVVNfU1JDX0FMUEhBKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBaZDoKICAgICAgICAgICAgICBhLmJsZW5kRnVuYyhhLk9ORSwgYS5PTkUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIGpkOgogICAgICAgICAgICAgIGEuYmxlbmRGdW5jU2VwYXJhdGUoYS5aRVJPLCBhLk9ORV9NSU5VU19TUkNfQ09MT1IsIGEuWkVSTywgYS5PTkUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEpkOgogICAgICAgICAgICAgIGEuYmxlbmRGdW5jU2VwYXJhdGUoYS5EU1RfQ09MT1IsIGEuT05FX01JTlVTX1NSQ19BTFBIQSwgYS5aRVJPLCBhLk9ORSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xTdGF0ZTogSW52YWxpZCBibGVuZGluZzogIiwgRik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgc3dpdGNoIChGKSB7CiAgICAgICAgICAgIGNhc2Ugd3M6CiAgICAgICAgICAgICAgYS5ibGVuZEZ1bmNTZXBhcmF0ZShhLlNSQ19BTFBIQSwgYS5PTkVfTUlOVVNfU1JDX0FMUEhBLCBhLk9ORSwgYS5PTkVfTUlOVVNfU1JDX0FMUEhBKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBaZDoKICAgICAgICAgICAgICBhLmJsZW5kRnVuY1NlcGFyYXRlKGEuU1JDX0FMUEhBLCBhLk9ORSwgYS5PTkUsIGEuT05FKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBqZDoKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFN0YXRlOiBTdWJ0cmFjdGl2ZUJsZW5kaW5nIHJlcXVpcmVzIG1hdGVyaWFsLnByZW11bHRpcGxpZWRBbHBoYSA9IHRydWUiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBKZDoKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFN0YXRlOiBNdWx0aXBseUJsZW5kaW5nIHJlcXVpcmVzIG1hdGVyaWFsLnByZW11bHRpcGxpZWRBbHBoYSA9IHRydWUiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFN0YXRlOiBJbnZhbGlkIGJsZW5kaW5nOiAiLCBGKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB2ID0gbnVsbCwgeCA9IG51bGwsIFMgPSBudWxsLCB3ID0gbnVsbCwgVC5zZXQoMCwgMCwgMCksIFIgPSAwLCBnID0gRiwgYiA9IG9lOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGR0ID0gZHQgfHwgaHQsIG50ID0gbnQgfHwgX3QsIEZ0ID0gRnQgfHwgUnQsIChodCAhPT0gbSB8fCBkdCAhPT0gXykgJiYgKGEuYmxlbmRFcXVhdGlvblNlcGFyYXRlKGhlW2h0XSwgaGVbZHRdKSwgbSA9IGh0LCBfID0gZHQpLCAoX3QgIT09IHYgfHwgUnQgIT09IHggfHwgbnQgIT09IFMgfHwgRnQgIT09IHcpICYmIChhLmJsZW5kRnVuY1NlcGFyYXRlKERbX3RdLCBEW1J0XSwgRFtudF0sIERbRnRdKSwgdiA9IF90LCB4ID0gUnQsIFMgPSBudCwgdyA9IEZ0KSwgKHF0LmVxdWFscyhUKSA9PT0gITEgfHwgZ2UgIT09IFIpICYmIChhLmJsZW5kQ29sb3IocXQuciwgcXQuZywgcXQuYiwgZ2UpLCBULmNvcHkocXQpLCBSID0gZ2UpLCBnID0gRiwgYiA9ICExOwogIH0KICBmdW5jdGlvbiBpdChGLCBodCkgewogICAgRi5zaWRlID09PSBNaSA/IEV0KGEuQ1VMTF9GQUNFKSA6IHN0KGEuQ1VMTF9GQUNFKTsKICAgIGxldCBfdCA9IEYuc2lkZSA9PT0gSGU7CiAgICBodCAmJiAoX3QgPSAhX3QpLCBRKF90KSwgRi5ibGVuZGluZyA9PT0gd3MgJiYgRi50cmFuc3BhcmVudCA9PT0gITEgPyBvdChZbikgOiBvdChGLmJsZW5kaW5nLCBGLmJsZW5kRXF1YXRpb24sIEYuYmxlbmRTcmMsIEYuYmxlbmREc3QsIEYuYmxlbmRFcXVhdGlvbkFscGhhLCBGLmJsZW5kU3JjQWxwaGEsIEYuYmxlbmREc3RBbHBoYSwgRi5ibGVuZENvbG9yLCBGLmJsZW5kQWxwaGEsIEYucHJlbXVsdGlwbGllZEFscGhhKSwgci5zZXRGdW5jKEYuZGVwdGhGdW5jKSwgci5zZXRUZXN0KEYuZGVwdGhUZXN0KSwgci5zZXRNYXNrKEYuZGVwdGhXcml0ZSksIHMuc2V0TWFzayhGLmNvbG9yV3JpdGUpOwogICAgY29uc3QgUnQgPSBGLnN0ZW5jaWxXcml0ZTsKICAgIG8uc2V0VGVzdChSdCksIFJ0ICYmIChvLnNldE1hc2soRi5zdGVuY2lsV3JpdGVNYXNrKSwgby5zZXRGdW5jKEYuc3RlbmNpbEZ1bmMsIEYuc3RlbmNpbFJlZiwgRi5zdGVuY2lsRnVuY01hc2spLCBvLnNldE9wKEYuc3RlbmNpbEZhaWwsIEYuc3RlbmNpbFpGYWlsLCBGLnN0ZW5jaWxaUGFzcykpLCB1dChGLnBvbHlnb25PZmZzZXQsIEYucG9seWdvbk9mZnNldEZhY3RvciwgRi5wb2x5Z29uT2Zmc2V0VW5pdHMpLCBGLmFscGhhVG9Db3ZlcmFnZSA9PT0gITAgPyBzdChhLlNBTVBMRV9BTFBIQV9UT19DT1ZFUkFHRSkgOiBFdChhLlNBTVBMRV9BTFBIQV9UT19DT1ZFUkFHRSk7CiAgfQogIGZ1bmN0aW9uIFEoRikgewogICAgTSAhPT0gRiAmJiAoRiA/IGEuZnJvbnRGYWNlKGEuQ1cpIDogYS5mcm9udEZhY2UoYS5DQ1cpLCBNID0gRik7CiAgfQogIGZ1bmN0aW9uIEsoRikgewogICAgRiAhPT0gdzAgPyAoc3QoYS5DVUxMX0ZBQ0UpLCBGICE9PSBMICYmIChGID09PSBZZCA/IGEuY3VsbEZhY2UoYS5CQUNLKSA6IEYgPT09IEEwID8gYS5jdWxsRmFjZShhLkZST05UKSA6IGEuY3VsbEZhY2UoYS5GUk9OVF9BTkRfQkFDSykpKSA6IEV0KGEuQ1VMTF9GQUNFKSwgTCA9IEY7CiAgfQogIGZ1bmN0aW9uIHl0KEYpIHsKICAgIEYgIT09IFUgJiYgKEcgJiYgYS5saW5lV2lkdGgoRiksIFUgPSBGKTsKICB9CiAgZnVuY3Rpb24gdXQoRiwgaHQsIF90KSB7CiAgICBGID8gKHN0KGEuUE9MWUdPTl9PRkZTRVRfRklMTCksIChPICE9PSBodCB8fCBWICE9PSBfdCkgJiYgKGEucG9seWdvbk9mZnNldChodCwgX3QpLCBPID0gaHQsIFYgPSBfdCkpIDogRXQoYS5QT0xZR09OX09GRlNFVF9GSUxMKTsKICB9CiAgZnVuY3Rpb24geHQoRikgewogICAgRiA/IHN0KGEuU0NJU1NPUl9URVNUKSA6IEV0KGEuU0NJU1NPUl9URVNUKTsKICB9CiAgZnVuY3Rpb24gV3QoRikgewogICAgRiA9PT0gdm9pZCAwICYmIChGID0gYS5URVhUVVJFMCArIFcgLSAxKSwgYXQgIT09IEYgJiYgKGEuYWN0aXZlVGV4dHVyZShGKSwgYXQgPSBGKTsKICB9CiAgZnVuY3Rpb24gTnQoRiwgaHQsIF90KSB7CiAgICBfdCA9PT0gdm9pZCAwICYmIChhdCA9PT0gbnVsbCA/IF90ID0gYS5URVhUVVJFMCArIFcgLSAxIDogX3QgPSBhdCk7CiAgICBsZXQgUnQgPSBwdFtfdF07CiAgICBSdCA9PT0gdm9pZCAwICYmIChSdCA9IHsgdHlwZTogdm9pZCAwLCB0ZXh0dXJlOiB2b2lkIDAgfSwgcHRbX3RdID0gUnQpLCAoUnQudHlwZSAhPT0gRiB8fCBSdC50ZXh0dXJlICE9PSBodCkgJiYgKGF0ICE9PSBfdCAmJiAoYS5hY3RpdmVUZXh0dXJlKF90KSwgYXQgPSBfdCksIGEuYmluZFRleHR1cmUoRiwgaHQgfHwgWVtGXSksIFJ0LnR5cGUgPSBGLCBSdC50ZXh0dXJlID0gaHQpOwogIH0KICBmdW5jdGlvbiBQKCkgewogICAgY29uc3QgRiA9IHB0W2F0XTsKICAgIEYgIT09IHZvaWQgMCAmJiBGLnR5cGUgIT09IHZvaWQgMCAmJiAoYS5iaW5kVGV4dHVyZShGLnR5cGUsIG51bGwpLCBGLnR5cGUgPSB2b2lkIDAsIEYudGV4dHVyZSA9IHZvaWQgMCk7CiAgfQogIGZ1bmN0aW9uIEEoKSB7CiAgICB0cnkgewogICAgICBhLmNvbXByZXNzZWRUZXhJbWFnZTJEKC4uLmFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChGKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMU3RhdGU6IiwgRik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIE4oKSB7CiAgICB0cnkgewogICAgICBhLmNvbXByZXNzZWRUZXhJbWFnZTNEKC4uLmFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChGKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMU3RhdGU6IiwgRik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIFgoKSB7CiAgICB0cnkgewogICAgICBhLnRleFN1YkltYWdlMkQoLi4uYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKEYpIHsKICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xTdGF0ZToiLCBGKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcnQoKSB7CiAgICB0cnkgewogICAgICBhLnRleFN1YkltYWdlM0QoLi4uYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKEYpIHsKICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xTdGF0ZToiLCBGKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gWigpIHsKICAgIHRyeSB7CiAgICAgIGEuY29tcHJlc3NlZFRleFN1YkltYWdlMkQoLi4uYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKEYpIHsKICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xTdGF0ZToiLCBGKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gSXQoKSB7CiAgICB0cnkgewogICAgICBhLmNvbXByZXNzZWRUZXhTdWJJbWFnZTNEKC4uLmFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChGKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMU3RhdGU6IiwgRik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEkoKSB7CiAgICB0cnkgewogICAgICBhLnRleFN0b3JhZ2UyRCguLi5hcmd1bWVudHMpOwogICAgfSBjYXRjaCAoRikgewogICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFN0YXRlOiIsIEYpOwogICAgfQogIH0KICBmdW5jdGlvbiBsdCgpIHsKICAgIHRyeSB7CiAgICAgIGEudGV4U3RvcmFnZTNEKC4uLmFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChGKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMU3RhdGU6IiwgRik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGd0KCkgewogICAgdHJ5IHsKICAgICAgYS50ZXhJbWFnZTJEKC4uLmFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChGKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMU3RhdGU6IiwgRik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGooKSB7CiAgICB0cnkgewogICAgICBhLnRleEltYWdlM0QoLi4uYXJndW1lbnRzKTsKICAgIH0gY2F0Y2ggKEYpIHsKICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xTdGF0ZToiLCBGKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gbXQoRikgewogICAganQuZXF1YWxzKEYpID09PSAhMSAmJiAoYS5zY2lzc29yKEYueCwgRi55LCBGLnosIEYudyksIGp0LmNvcHkoRikpOwogIH0KICBmdW5jdGlvbiBBdChGKSB7CiAgICBuZS5lcXVhbHMoRikgPT09ICExICYmIChhLnZpZXdwb3J0KEYueCwgRi55LCBGLnosIEYudyksIG5lLmNvcHkoRikpOwogIH0KICBmdW5jdGlvbiBUdChGLCBodCkgewogICAgbGV0IF90ID0gaC5nZXQoaHQpOwogICAgX3QgPT09IHZvaWQgMCAmJiAoX3QgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwgaC5zZXQoaHQsIF90KSk7CiAgICBsZXQgUnQgPSBfdC5nZXQoRik7CiAgICBSdCA9PT0gdm9pZCAwICYmIChSdCA9IGEuZ2V0VW5pZm9ybUJsb2NrSW5kZXgoaHQsIEYubmFtZSksIF90LnNldChGLCBSdCkpOwogIH0KICBmdW5jdGlvbiB2dChGLCBodCkgewogICAgY29uc3QgUnQgPSBoLmdldChodCkuZ2V0KEYpOwogICAgbC5nZXQoaHQpICE9PSBSdCAmJiAoYS51bmlmb3JtQmxvY2tCaW5kaW5nKGh0LCBSdCwgRi5fX2JpbmRpbmdQb2ludEluZGV4KSwgbC5zZXQoaHQsIFJ0KSk7CiAgfQogIGZ1bmN0aW9uICR0KCkgewogICAgYS5kaXNhYmxlKGEuQkxFTkQpLCBhLmRpc2FibGUoYS5DVUxMX0ZBQ0UpLCBhLmRpc2FibGUoYS5ERVBUSF9URVNUKSwgYS5kaXNhYmxlKGEuUE9MWUdPTl9PRkZTRVRfRklMTCksIGEuZGlzYWJsZShhLlNDSVNTT1JfVEVTVCksIGEuZGlzYWJsZShhLlNURU5DSUxfVEVTVCksIGEuZGlzYWJsZShhLlNBTVBMRV9BTFBIQV9UT19DT1ZFUkFHRSksIGEuYmxlbmRFcXVhdGlvbihhLkZVTkNfQUREKSwgYS5ibGVuZEZ1bmMoYS5PTkUsIGEuWkVSTyksIGEuYmxlbmRGdW5jU2VwYXJhdGUoYS5PTkUsIGEuWkVSTywgYS5PTkUsIGEuWkVSTyksIGEuYmxlbmRDb2xvcigwLCAwLCAwLCAwKSwgYS5jb2xvck1hc2soITAsICEwLCAhMCwgITApLCBhLmNsZWFyQ29sb3IoMCwgMCwgMCwgMCksIGEuZGVwdGhNYXNrKCEwKSwgYS5kZXB0aEZ1bmMoYS5MRVNTKSwgci5zZXRSZXZlcnNlZCghMSksIGEuY2xlYXJEZXB0aCgxKSwgYS5zdGVuY2lsTWFzayg0Mjk0OTY3Mjk1KSwgYS5zdGVuY2lsRnVuYyhhLkFMV0FZUywgMCwgNDI5NDk2NzI5NSksIGEuc3RlbmNpbE9wKGEuS0VFUCwgYS5LRUVQLCBhLktFRVApLCBhLmNsZWFyU3RlbmNpbCgwKSwgYS5jdWxsRmFjZShhLkJBQ0spLCBhLmZyb250RmFjZShhLkNDVyksIGEucG9seWdvbk9mZnNldCgwLCAwKSwgYS5hY3RpdmVUZXh0dXJlKGEuVEVYVFVSRTApLCBhLmJpbmRGcmFtZWJ1ZmZlcihhLkZSQU1FQlVGRkVSLCBudWxsKSwgYS5iaW5kRnJhbWVidWZmZXIoYS5EUkFXX0ZSQU1FQlVGRkVSLCBudWxsKSwgYS5iaW5kRnJhbWVidWZmZXIoYS5SRUFEX0ZSQU1FQlVGRkVSLCBudWxsKSwgYS51c2VQcm9ncmFtKG51bGwpLCBhLmxpbmVXaWR0aCgxKSwgYS5zY2lzc29yKDAsIDAsIGEuY2FudmFzLndpZHRoLCBhLmNhbnZhcy5oZWlnaHQpLCBhLnZpZXdwb3J0KDAsIDAsIGEuY2FudmFzLndpZHRoLCBhLmNhbnZhcy5oZWlnaHQpLCBjID0ge30sIGF0ID0gbnVsbCwgcHQgPSB7fSwgdSA9IHt9LCBkID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCksIHAgPSBbXSwgZiA9IG51bGwsIHkgPSAhMSwgZyA9IG51bGwsIG0gPSBudWxsLCB2ID0gbnVsbCwgeCA9IG51bGwsIF8gPSBudWxsLCBTID0gbnVsbCwgdyA9IG51bGwsIFQgPSBuZXcgY3QoMCwgMCwgMCksIFIgPSAwLCBiID0gITEsIE0gPSBudWxsLCBMID0gbnVsbCwgVSA9IG51bGwsIE8gPSBudWxsLCBWID0gbnVsbCwganQuc2V0KDAsIDAsIGEuY2FudmFzLndpZHRoLCBhLmNhbnZhcy5oZWlnaHQpLCBuZS5zZXQoMCwgMCwgYS5jYW52YXMud2lkdGgsIGEuY2FudmFzLmhlaWdodCksIHMucmVzZXQoKSwgci5yZXNldCgpLCBvLnJlc2V0KCk7CiAgfQogIHJldHVybiB7CiAgICBidWZmZXJzOiB7CiAgICAgIGNvbG9yOiBzLAogICAgICBkZXB0aDogciwKICAgICAgc3RlbmNpbDogbwogICAgfSwKICAgIGVuYWJsZTogc3QsCiAgICBkaXNhYmxlOiBFdCwKICAgIGJpbmRGcmFtZWJ1ZmZlcjogVXQsCiAgICBkcmF3QnVmZmVyczogUHQsCiAgICB1c2VQcm9ncmFtOiBLdCwKICAgIHNldEJsZW5kaW5nOiBvdCwKICAgIHNldE1hdGVyaWFsOiBpdCwKICAgIHNldEZsaXBTaWRlZDogUSwKICAgIHNldEN1bGxGYWNlOiBLLAogICAgc2V0TGluZVdpZHRoOiB5dCwKICAgIHNldFBvbHlnb25PZmZzZXQ6IHV0LAogICAgc2V0U2Npc3NvclRlc3Q6IHh0LAogICAgYWN0aXZlVGV4dHVyZTogV3QsCiAgICBiaW5kVGV4dHVyZTogTnQsCiAgICB1bmJpbmRUZXh0dXJlOiBQLAogICAgY29tcHJlc3NlZFRleEltYWdlMkQ6IEEsCiAgICBjb21wcmVzc2VkVGV4SW1hZ2UzRDogTiwKICAgIHRleEltYWdlMkQ6IGd0LAogICAgdGV4SW1hZ2UzRDogaiwKICAgIHVwZGF0ZVVCT01hcHBpbmc6IFR0LAogICAgdW5pZm9ybUJsb2NrQmluZGluZzogdnQsCiAgICB0ZXhTdG9yYWdlMkQ6IEksCiAgICB0ZXhTdG9yYWdlM0Q6IGx0LAogICAgdGV4U3ViSW1hZ2UyRDogWCwKICAgIHRleFN1YkltYWdlM0Q6IHJ0LAogICAgY29tcHJlc3NlZFRleFN1YkltYWdlMkQ6IFosCiAgICBjb21wcmVzc2VkVGV4U3ViSW1hZ2UzRDogSXQsCiAgICBzY2lzc29yOiBtdCwKICAgIHZpZXdwb3J0OiBBdCwKICAgIHJlc2V0OiAkdAogIH07Cn0KZnVuY3Rpb24gZ0UoYSwgdCwgZSwgaSwgbiwgcywgcikgewogIGNvbnN0IG8gPSB0LmhhcygiV0VCR0xfbXVsdGlzYW1wbGVkX3JlbmRlcl90b190ZXh0dXJlIikgPyB0LmdldCgiV0VCR0xfbXVsdGlzYW1wbGVkX3JlbmRlcl90b190ZXh0dXJlIikgOiBudWxsLCBsID0gdHlwZW9mIG5hdmlnYXRvciA+ICJ1IiA/ICExIDogL09jdWx1c0Jyb3dzZXIvZy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpLCBoID0gbmV3IEooKSwgYyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIGxldCB1OwogIGNvbnN0IGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBsZXQgcCA9ICExOwogIHRyeSB7CiAgICBwID0gdHlwZW9mIE9mZnNjcmVlbkNhbnZhcyA8ICJ1IiAmJiBuZXcgT2Zmc2NyZWVuQ2FudmFzKDEsIDEpLmdldENvbnRleHQoIjJkIikgIT09IG51bGw7CiAgfSBjYXRjaCB7CiAgfQogIGZ1bmN0aW9uIGYoUCwgQSkgewogICAgcmV0dXJuIHAgPyAoCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wYXQvY29tcGF0CiAgICAgIG5ldyBPZmZzY3JlZW5DYW52YXMoUCwgQSkKICAgICkgOiBSbygiY2FudmFzIik7CiAgfQogIGZ1bmN0aW9uIHkoUCwgQSwgTikgewogICAgbGV0IFggPSAxOwogICAgY29uc3QgcnQgPSBOdChQKTsKICAgIGlmICgocnQud2lkdGggPiBOIHx8IHJ0LmhlaWdodCA+IE4pICYmIChYID0gTiAvIE1hdGgubWF4KHJ0LndpZHRoLCBydC5oZWlnaHQpKSwgWCA8IDEpCiAgICAgIGlmICh0eXBlb2YgSFRNTEltYWdlRWxlbWVudCA8ICJ1IiAmJiBQIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCB8fCB0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgPCAidSIgJiYgUCBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50IHx8IHR5cGVvZiBJbWFnZUJpdG1hcCA8ICJ1IiAmJiBQIGluc3RhbmNlb2YgSW1hZ2VCaXRtYXAgfHwgdHlwZW9mIFZpZGVvRnJhbWUgPCAidSIgJiYgUCBpbnN0YW5jZW9mIFZpZGVvRnJhbWUpIHsKICAgICAgICBjb25zdCBaID0gTWF0aC5mbG9vcihYICogcnQud2lkdGgpLCBJdCA9IE1hdGguZmxvb3IoWCAqIHJ0LmhlaWdodCk7CiAgICAgICAgdSA9PT0gdm9pZCAwICYmICh1ID0gZihaLCBJdCkpOwogICAgICAgIGNvbnN0IEkgPSBBID8gZihaLCBJdCkgOiB1OwogICAgICAgIHJldHVybiBJLndpZHRoID0gWiwgSS5oZWlnaHQgPSBJdCwgSS5nZXRDb250ZXh0KCIyZCIpLmRyYXdJbWFnZShQLCAwLCAwLCBaLCBJdCksIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xSZW5kZXJlcjogVGV4dHVyZSBoYXMgYmVlbiByZXNpemVkIGZyb20gKCIgKyBydC53aWR0aCArICJ4IiArIHJ0LmhlaWdodCArICIpIHRvICgiICsgWiArICJ4IiArIEl0ICsgIikuIiksIEk7CiAgICAgIH0gZWxzZQogICAgICAgIHJldHVybiAiZGF0YSIgaW4gUCAmJiBjb25zb2xlLndhcm4oIlRIUkVFLldlYkdMUmVuZGVyZXI6IEltYWdlIGluIERhdGFUZXh0dXJlIGlzIHRvbyBiaWcgKCIgKyBydC53aWR0aCArICJ4IiArIHJ0LmhlaWdodCArICIpLiIpLCBQOwogICAgcmV0dXJuIFA7CiAgfQogIGZ1bmN0aW9uIGcoUCkgewogICAgcmV0dXJuIFAuZ2VuZXJhdGVNaXBtYXBzOwogIH0KICBmdW5jdGlvbiBtKFApIHsKICAgIGEuZ2VuZXJhdGVNaXBtYXAoUCk7CiAgfQogIGZ1bmN0aW9uIHYoUCkgewogICAgcmV0dXJuIFAuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQgPyBhLlRFWFRVUkVfQ1VCRV9NQVAgOiBQLmlzV2ViR0wzRFJlbmRlclRhcmdldCA/IGEuVEVYVFVSRV8zRCA6IFAuaXNXZWJHTEFycmF5UmVuZGVyVGFyZ2V0IHx8IFAuaXNDb21wcmVzc2VkQXJyYXlUZXh0dXJlID8gYS5URVhUVVJFXzJEX0FSUkFZIDogYS5URVhUVVJFXzJEOwogIH0KICBmdW5jdGlvbiB4KFAsIEEsIE4sIFgsIHJ0ID0gITEpIHsKICAgIGlmIChQICE9PSBudWxsKSB7CiAgICAgIGlmIChhW1BdICE9PSB2b2lkIDApIHJldHVybiBhW1BdOwogICAgICBjb25zb2xlLndhcm4oIlRIUkVFLldlYkdMUmVuZGVyZXI6IEF0dGVtcHQgdG8gdXNlIG5vbi1leGlzdGluZyBXZWJHTCBpbnRlcm5hbCBmb3JtYXQgJyIgKyBQICsgIiciKTsKICAgIH0KICAgIGxldCBaID0gQTsKICAgIGlmIChBID09PSBhLlJFRCAmJiAoTiA9PT0gYS5GTE9BVCAmJiAoWiA9IGEuUjMyRiksIE4gPT09IGEuSEFMRl9GTE9BVCAmJiAoWiA9IGEuUjE2RiksIE4gPT09IGEuVU5TSUdORURfQllURSAmJiAoWiA9IGEuUjgpKSwgQSA9PT0gYS5SRURfSU5URUdFUiAmJiAoTiA9PT0gYS5VTlNJR05FRF9CWVRFICYmIChaID0gYS5SOFVJKSwgTiA9PT0gYS5VTlNJR05FRF9TSE9SVCAmJiAoWiA9IGEuUjE2VUkpLCBOID09PSBhLlVOU0lHTkVEX0lOVCAmJiAoWiA9IGEuUjMyVUkpLCBOID09PSBhLkJZVEUgJiYgKFogPSBhLlI4SSksIE4gPT09IGEuU0hPUlQgJiYgKFogPSBhLlIxNkkpLCBOID09PSBhLklOVCAmJiAoWiA9IGEuUjMySSkpLCBBID09PSBhLlJHICYmIChOID09PSBhLkZMT0FUICYmIChaID0gYS5SRzMyRiksIE4gPT09IGEuSEFMRl9GTE9BVCAmJiAoWiA9IGEuUkcxNkYpLCBOID09PSBhLlVOU0lHTkVEX0JZVEUgJiYgKFogPSBhLlJHOCkpLCBBID09PSBhLlJHX0lOVEVHRVIgJiYgKE4gPT09IGEuVU5TSUdORURfQllURSAmJiAoWiA9IGEuUkc4VUkpLCBOID09PSBhLlVOU0lHTkVEX1NIT1JUICYmIChaID0gYS5SRzE2VUkpLCBOID09PSBhLlVOU0lHTkVEX0lOVCAmJiAoWiA9IGEuUkczMlVJKSwgTiA9PT0gYS5CWVRFICYmIChaID0gYS5SRzhJKSwgTiA9PT0gYS5TSE9SVCAmJiAoWiA9IGEuUkcxNkkpLCBOID09PSBhLklOVCAmJiAoWiA9IGEuUkczMkkpKSwgQSA9PT0gYS5SR0JfSU5URUdFUiAmJiAoTiA9PT0gYS5VTlNJR05FRF9CWVRFICYmIChaID0gYS5SR0I4VUkpLCBOID09PSBhLlVOU0lHTkVEX1NIT1JUICYmIChaID0gYS5SR0IxNlVJKSwgTiA9PT0gYS5VTlNJR05FRF9JTlQgJiYgKFogPSBhLlJHQjMyVUkpLCBOID09PSBhLkJZVEUgJiYgKFogPSBhLlJHQjhJKSwgTiA9PT0gYS5TSE9SVCAmJiAoWiA9IGEuUkdCMTZJKSwgTiA9PT0gYS5JTlQgJiYgKFogPSBhLlJHQjMySSkpLCBBID09PSBhLlJHQkFfSU5URUdFUiAmJiAoTiA9PT0gYS5VTlNJR05FRF9CWVRFICYmIChaID0gYS5SR0JBOFVJKSwgTiA9PT0gYS5VTlNJR05FRF9TSE9SVCAmJiAoWiA9IGEuUkdCQTE2VUkpLCBOID09PSBhLlVOU0lHTkVEX0lOVCAmJiAoWiA9IGEuUkdCQTMyVUkpLCBOID09PSBhLkJZVEUgJiYgKFogPSBhLlJHQkE4SSksIE4gPT09IGEuU0hPUlQgJiYgKFogPSBhLlJHQkExNkkpLCBOID09PSBhLklOVCAmJiAoWiA9IGEuUkdCQTMySSkpLCBBID09PSBhLlJHQiAmJiAoTiA9PT0gYS5VTlNJR05FRF9JTlRfNV85XzlfOV9SRVYgJiYgKFogPSBhLlJHQjlfRTUpLCBOID09PSBhLlVOU0lHTkVEX0lOVF8xMEZfMTFGXzExRl9SRVYgJiYgKFogPSBhLlIxMUZfRzExRl9CMTBGKSksIEEgPT09IGEuUkdCQSkgewogICAgICBjb25zdCBJdCA9IHJ0ID8gRW8gOiBlZS5nZXRUcmFuc2ZlcihYKTsKICAgICAgTiA9PT0gYS5GTE9BVCAmJiAoWiA9IGEuUkdCQTMyRiksIE4gPT09IGEuSEFMRl9GTE9BVCAmJiAoWiA9IGEuUkdCQTE2RiksIE4gPT09IGEuVU5TSUdORURfQllURSAmJiAoWiA9IEl0ID09PSBjZSA/IGEuU1JHQjhfQUxQSEE4IDogYS5SR0JBOCksIE4gPT09IGEuVU5TSUdORURfU0hPUlRfNF80XzRfNCAmJiAoWiA9IGEuUkdCQTQpLCBOID09PSBhLlVOU0lHTkVEX1NIT1JUXzVfNV81XzEgJiYgKFogPSBhLlJHQjVfQTEpOwogICAgfQogICAgcmV0dXJuIChaID09PSBhLlIxNkYgfHwgWiA9PT0gYS5SMzJGIHx8IFogPT09IGEuUkcxNkYgfHwgWiA9PT0gYS5SRzMyRiB8fCBaID09PSBhLlJHQkExNkYgfHwgWiA9PT0gYS5SR0JBMzJGKSAmJiB0LmdldCgiRVhUX2NvbG9yX2J1ZmZlcl9mbG9hdCIpLCBaOwogIH0KICBmdW5jdGlvbiBfKFAsIEEpIHsKICAgIGxldCBOOwogICAgcmV0dXJuIFAgPyBBID09PSBudWxsIHx8IEEgPT09IG5zIHx8IEEgPT09IHBhID8gTiA9IGEuREVQVEgyNF9TVEVOQ0lMOCA6IEEgPT09IHdpID8gTiA9IGEuREVQVEgzMkZfU1RFTkNJTDggOiBBID09PSBkYSAmJiAoTiA9IGEuREVQVEgyNF9TVEVOQ0lMOCwgY29uc29sZS53YXJuKCJEZXB0aFRleHR1cmU6IDE2IGJpdCBkZXB0aCBhdHRhY2htZW50IGlzIG5vdCBzdXBwb3J0ZWQgd2l0aCBzdGVuY2lsLiBVc2luZyAyNC1iaXQgYXR0YWNobWVudC4iKSkgOiBBID09PSBudWxsIHx8IEEgPT09IG5zIHx8IEEgPT09IHBhID8gTiA9IGEuREVQVEhfQ09NUE9ORU5UMjQgOiBBID09PSB3aSA/IE4gPSBhLkRFUFRIX0NPTVBPTkVOVDMyRiA6IEEgPT09IGRhICYmIChOID0gYS5ERVBUSF9DT01QT05FTlQxNiksIE47CiAgfQogIGZ1bmN0aW9uIFMoUCwgQSkgewogICAgcmV0dXJuIGcoUCkgPT09ICEwIHx8IFAuaXNGcmFtZWJ1ZmZlclRleHR1cmUgJiYgUC5taW5GaWx0ZXIgIT09IGplICYmIFAubWluRmlsdGVyICE9PSBDZSA/IE1hdGgubG9nMihNYXRoLm1heChBLndpZHRoLCBBLmhlaWdodCkpICsgMSA6IFAubWlwbWFwcyAhPT0gdm9pZCAwICYmIFAubWlwbWFwcy5sZW5ndGggPiAwID8gUC5taXBtYXBzLmxlbmd0aCA6IFAuaXNDb21wcmVzc2VkVGV4dHVyZSAmJiBBcnJheS5pc0FycmF5KFAuaW1hZ2UpID8gQS5taXBtYXBzLmxlbmd0aCA6IDE7CiAgfQogIGZ1bmN0aW9uIHcoUCkgewogICAgY29uc3QgQSA9IFAudGFyZ2V0OwogICAgQS5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgdyksIFIoQSksIEEuaXNWaWRlb1RleHR1cmUgJiYgYy5kZWxldGUoQSk7CiAgfQogIGZ1bmN0aW9uIFQoUCkgewogICAgY29uc3QgQSA9IFAudGFyZ2V0OwogICAgQS5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgVCksIE0oQSk7CiAgfQogIGZ1bmN0aW9uIFIoUCkgewogICAgY29uc3QgQSA9IGkuZ2V0KFApOwogICAgaWYgKEEuX193ZWJnbEluaXQgPT09IHZvaWQgMCkgcmV0dXJuOwogICAgY29uc3QgTiA9IFAuc291cmNlLCBYID0gZC5nZXQoTik7CiAgICBpZiAoWCkgewogICAgICBjb25zdCBydCA9IFhbQS5fX2NhY2hlS2V5XTsKICAgICAgcnQudXNlZFRpbWVzLS0sIHJ0LnVzZWRUaW1lcyA9PT0gMCAmJiBiKFApLCBPYmplY3Qua2V5cyhYKS5sZW5ndGggPT09IDAgJiYgZC5kZWxldGUoTik7CiAgICB9CiAgICBpLnJlbW92ZShQKTsKICB9CiAgZnVuY3Rpb24gYihQKSB7CiAgICBjb25zdCBBID0gaS5nZXQoUCk7CiAgICBhLmRlbGV0ZVRleHR1cmUoQS5fX3dlYmdsVGV4dHVyZSk7CiAgICBjb25zdCBOID0gUC5zb3VyY2UsIFggPSBkLmdldChOKTsKICAgIGRlbGV0ZSBYW0EuX19jYWNoZUtleV0sIHIubWVtb3J5LnRleHR1cmVzLS07CiAgfQogIGZ1bmN0aW9uIE0oUCkgewogICAgY29uc3QgQSA9IGkuZ2V0KFApOwogICAgaWYgKFAuZGVwdGhUZXh0dXJlICYmIChQLmRlcHRoVGV4dHVyZS5kaXNwb3NlKCksIGkucmVtb3ZlKFAuZGVwdGhUZXh0dXJlKSksIFAuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQpCiAgICAgIGZvciAobGV0IFggPSAwOyBYIDwgNjsgWCsrKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoQS5fX3dlYmdsRnJhbWVidWZmZXJbWF0pKQogICAgICAgICAgZm9yIChsZXQgcnQgPSAwOyBydCA8IEEuX193ZWJnbEZyYW1lYnVmZmVyW1hdLmxlbmd0aDsgcnQrKykgYS5kZWxldGVGcmFtZWJ1ZmZlcihBLl9fd2ViZ2xGcmFtZWJ1ZmZlcltYXVtydF0pOwogICAgICAgIGVsc2UKICAgICAgICAgIGEuZGVsZXRlRnJhbWVidWZmZXIoQS5fX3dlYmdsRnJhbWVidWZmZXJbWF0pOwogICAgICAgIEEuX193ZWJnbERlcHRoYnVmZmVyICYmIGEuZGVsZXRlUmVuZGVyYnVmZmVyKEEuX193ZWJnbERlcHRoYnVmZmVyW1hdKTsKICAgICAgfQogICAgZWxzZSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KEEuX193ZWJnbEZyYW1lYnVmZmVyKSkKICAgICAgICBmb3IgKGxldCBYID0gMDsgWCA8IEEuX193ZWJnbEZyYW1lYnVmZmVyLmxlbmd0aDsgWCsrKSBhLmRlbGV0ZUZyYW1lYnVmZmVyKEEuX193ZWJnbEZyYW1lYnVmZmVyW1hdKTsKICAgICAgZWxzZQogICAgICAgIGEuZGVsZXRlRnJhbWVidWZmZXIoQS5fX3dlYmdsRnJhbWVidWZmZXIpOwogICAgICBpZiAoQS5fX3dlYmdsRGVwdGhidWZmZXIgJiYgYS5kZWxldGVSZW5kZXJidWZmZXIoQS5fX3dlYmdsRGVwdGhidWZmZXIpLCBBLl9fd2ViZ2xNdWx0aXNhbXBsZWRGcmFtZWJ1ZmZlciAmJiBhLmRlbGV0ZUZyYW1lYnVmZmVyKEEuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyKSwgQS5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXIpCiAgICAgICAgZm9yIChsZXQgWCA9IDA7IFggPCBBLl9fd2ViZ2xDb2xvclJlbmRlcmJ1ZmZlci5sZW5ndGg7IFgrKykKICAgICAgICAgIEEuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyW1hdICYmIGEuZGVsZXRlUmVuZGVyYnVmZmVyKEEuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyW1hdKTsKICAgICAgQS5fX3dlYmdsRGVwdGhSZW5kZXJidWZmZXIgJiYgYS5kZWxldGVSZW5kZXJidWZmZXIoQS5fX3dlYmdsRGVwdGhSZW5kZXJidWZmZXIpOwogICAgfQogICAgY29uc3QgTiA9IFAudGV4dHVyZXM7CiAgICBmb3IgKGxldCBYID0gMCwgcnQgPSBOLmxlbmd0aDsgWCA8IHJ0OyBYKyspIHsKICAgICAgY29uc3QgWiA9IGkuZ2V0KE5bWF0pOwogICAgICBaLl9fd2ViZ2xUZXh0dXJlICYmIChhLmRlbGV0ZVRleHR1cmUoWi5fX3dlYmdsVGV4dHVyZSksIHIubWVtb3J5LnRleHR1cmVzLS0pLCBpLnJlbW92ZShOW1hdKTsKICAgIH0KICAgIGkucmVtb3ZlKFApOwogIH0KICBsZXQgTCA9IDA7CiAgZnVuY3Rpb24gVSgpIHsKICAgIEwgPSAwOwogIH0KICBmdW5jdGlvbiBPKCkgewogICAgY29uc3QgUCA9IEw7CiAgICByZXR1cm4gUCA+PSBuLm1heFRleHR1cmVzICYmIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xUZXh0dXJlczogVHJ5aW5nIHRvIHVzZSAiICsgUCArICIgdGV4dHVyZSB1bml0cyB3aGlsZSB0aGlzIEdQVSBzdXBwb3J0cyBvbmx5ICIgKyBuLm1heFRleHR1cmVzKSwgTCArPSAxLCBQOwogIH0KICBmdW5jdGlvbiBWKFApIHsKICAgIGNvbnN0IEEgPSBbXTsKICAgIHJldHVybiBBLnB1c2goUC53cmFwUyksIEEucHVzaChQLndyYXBUKSwgQS5wdXNoKFAud3JhcFIgfHwgMCksIEEucHVzaChQLm1hZ0ZpbHRlciksIEEucHVzaChQLm1pbkZpbHRlciksIEEucHVzaChQLmFuaXNvdHJvcHkpLCBBLnB1c2goUC5pbnRlcm5hbEZvcm1hdCksIEEucHVzaChQLmZvcm1hdCksIEEucHVzaChQLnR5cGUpLCBBLnB1c2goUC5nZW5lcmF0ZU1pcG1hcHMpLCBBLnB1c2goUC5wcmVtdWx0aXBseUFscGhhKSwgQS5wdXNoKFAuZmxpcFkpLCBBLnB1c2goUC51bnBhY2tBbGlnbm1lbnQpLCBBLnB1c2goUC5jb2xvclNwYWNlKSwgQS5qb2luKCk7CiAgfQogIGZ1bmN0aW9uIFcoUCwgQSkgewogICAgY29uc3QgTiA9IGkuZ2V0KFApOwogICAgaWYgKFAuaXNWaWRlb1RleHR1cmUgJiYgeHQoUCksIFAuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID09PSAhMSAmJiBQLmlzRXh0ZXJuYWxUZXh0dXJlICE9PSAhMCAmJiBQLnZlcnNpb24gPiAwICYmIE4uX192ZXJzaW9uICE9PSBQLnZlcnNpb24pIHsKICAgICAgY29uc3QgWCA9IFAuaW1hZ2U7CiAgICAgIGlmIChYID09PSBudWxsKQogICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xSZW5kZXJlcjogVGV4dHVyZSBtYXJrZWQgZm9yIHVwZGF0ZSBidXQgbm8gaW1hZ2UgZGF0YSBmb3VuZC4iKTsKICAgICAgZWxzZSBpZiAoWC5jb21wbGV0ZSA9PT0gITEpCiAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5XZWJHTFJlbmRlcmVyOiBUZXh0dXJlIG1hcmtlZCBmb3IgdXBkYXRlIGJ1dCBpbWFnZSBpcyBpbmNvbXBsZXRlIik7CiAgICAgIGVsc2UgewogICAgICAgIFkoTiwgUCwgQSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgUC5pc0V4dGVybmFsVGV4dHVyZSAmJiAoTi5fX3dlYmdsVGV4dHVyZSA9IFAuc291cmNlVGV4dHVyZSA/IFAuc291cmNlVGV4dHVyZSA6IG51bGwpOwogICAgZS5iaW5kVGV4dHVyZShhLlRFWFRVUkVfMkQsIE4uX193ZWJnbFRleHR1cmUsIGEuVEVYVFVSRTAgKyBBKTsKICB9CiAgZnVuY3Rpb24gRyhQLCBBKSB7CiAgICBjb25zdCBOID0gaS5nZXQoUCk7CiAgICBpZiAoUC5pc1JlbmRlclRhcmdldFRleHR1cmUgPT09ICExICYmIFAudmVyc2lvbiA+IDAgJiYgTi5fX3ZlcnNpb24gIT09IFAudmVyc2lvbikgewogICAgICBZKE4sIFAsIEEpOwogICAgICByZXR1cm47CiAgICB9CiAgICBlLmJpbmRUZXh0dXJlKGEuVEVYVFVSRV8yRF9BUlJBWSwgTi5fX3dlYmdsVGV4dHVyZSwgYS5URVhUVVJFMCArIEEpOwogIH0KICBmdW5jdGlvbiBldChQLCBBKSB7CiAgICBjb25zdCBOID0gaS5nZXQoUCk7CiAgICBpZiAoUC5pc1JlbmRlclRhcmdldFRleHR1cmUgPT09ICExICYmIFAudmVyc2lvbiA+IDAgJiYgTi5fX3ZlcnNpb24gIT09IFAudmVyc2lvbikgewogICAgICBZKE4sIFAsIEEpOwogICAgICByZXR1cm47CiAgICB9CiAgICBlLmJpbmRUZXh0dXJlKGEuVEVYVFVSRV8zRCwgTi5fX3dlYmdsVGV4dHVyZSwgYS5URVhUVVJFMCArIEEpOwogIH0KICBmdW5jdGlvbiBIKFAsIEEpIHsKICAgIGNvbnN0IE4gPSBpLmdldChQKTsKICAgIGlmIChQLnZlcnNpb24gPiAwICYmIE4uX192ZXJzaW9uICE9PSBQLnZlcnNpb24pIHsKICAgICAgc3QoTiwgUCwgQSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGUuYmluZFRleHR1cmUoYS5URVhUVVJFX0NVQkVfTUFQLCBOLl9fd2ViZ2xUZXh0dXJlLCBhLlRFWFRVUkUwICsgQSk7CiAgfQogIGNvbnN0IGF0ID0gewogICAgW01vXTogYS5SRVBFQVQsCiAgICBbU2ldOiBhLkNMQU1QX1RPX0VER0UsCiAgICBbU29dOiBhLk1JUlJPUkVEX1JFUEVBVAogIH0sIHB0ID0gewogICAgW2plXTogYS5ORUFSRVNULAogICAgW1NwXTogYS5ORUFSRVNUX01JUE1BUF9ORUFSRVNULAogICAgW3NhXTogYS5ORUFSRVNUX01JUE1BUF9MSU5FQVIsCiAgICBbQ2VdOiBhLkxJTkVBUiwKICAgIFtsb106IGEuTElORUFSX01JUE1BUF9ORUFSRVNULAogICAgW0VuXTogYS5MSU5FQVJfTUlQTUFQX0xJTkVBUgogIH0sIE10ID0gewogICAgW2F5XTogYS5ORVZFUiwKICAgIFtkeV06IGEuQUxXQVlTLAogICAgW295XTogYS5MRVNTLAogICAgW0ZwXTogYS5MRVFVQUwsCiAgICBbbHldOiBhLkVRVUFMLAogICAgW3V5XTogYS5HRVFVQUwsCiAgICBbaHldOiBhLkdSRUFURVIsCiAgICBbY3ldOiBhLk5PVEVRVUFMCiAgfTsKICBmdW5jdGlvbiBMdChQLCBBKSB7CiAgICBpZiAoQS50eXBlID09PSB3aSAmJiB0LmhhcygiT0VTX3RleHR1cmVfZmxvYXRfbGluZWFyIikgPT09ICExICYmIChBLm1hZ0ZpbHRlciA9PT0gQ2UgfHwgQS5tYWdGaWx0ZXIgPT09IGxvIHx8IEEubWFnRmlsdGVyID09PSBzYSB8fCBBLm1hZ0ZpbHRlciA9PT0gRW4gfHwgQS5taW5GaWx0ZXIgPT09IENlIHx8IEEubWluRmlsdGVyID09PSBsbyB8fCBBLm1pbkZpbHRlciA9PT0gc2EgfHwgQS5taW5GaWx0ZXIgPT09IEVuKSAmJiBjb25zb2xlLndhcm4oIlRIUkVFLldlYkdMUmVuZGVyZXI6IFVuYWJsZSB0byB1c2UgbGluZWFyIGZpbHRlcmluZyB3aXRoIGZsb2F0aW5nIHBvaW50IHRleHR1cmVzLiBPRVNfdGV4dHVyZV9mbG9hdF9saW5lYXIgbm90IHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZS4iKSwgYS50ZXhQYXJhbWV0ZXJpKFAsIGEuVEVYVFVSRV9XUkFQX1MsIGF0W0Eud3JhcFNdKSwgYS50ZXhQYXJhbWV0ZXJpKFAsIGEuVEVYVFVSRV9XUkFQX1QsIGF0W0Eud3JhcFRdKSwgKFAgPT09IGEuVEVYVFVSRV8zRCB8fCBQID09PSBhLlRFWFRVUkVfMkRfQVJSQVkpICYmIGEudGV4UGFyYW1ldGVyaShQLCBhLlRFWFRVUkVfV1JBUF9SLCBhdFtBLndyYXBSXSksIGEudGV4UGFyYW1ldGVyaShQLCBhLlRFWFRVUkVfTUFHX0ZJTFRFUiwgcHRbQS5tYWdGaWx0ZXJdKSwgYS50ZXhQYXJhbWV0ZXJpKFAsIGEuVEVYVFVSRV9NSU5fRklMVEVSLCBwdFtBLm1pbkZpbHRlcl0pLCBBLmNvbXBhcmVGdW5jdGlvbiAmJiAoYS50ZXhQYXJhbWV0ZXJpKFAsIGEuVEVYVFVSRV9DT01QQVJFX01PREUsIGEuQ09NUEFSRV9SRUZfVE9fVEVYVFVSRSksIGEudGV4UGFyYW1ldGVyaShQLCBhLlRFWFRVUkVfQ09NUEFSRV9GVU5DLCBNdFtBLmNvbXBhcmVGdW5jdGlvbl0pKSwgdC5oYXMoIkVYVF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYyIpID09PSAhMCkgewogICAgICBpZiAoQS5tYWdGaWx0ZXIgPT09IGplIHx8IEEubWluRmlsdGVyICE9PSBzYSAmJiBBLm1pbkZpbHRlciAhPT0gRW4gfHwgQS50eXBlID09PSB3aSAmJiB0LmhhcygiT0VTX3RleHR1cmVfZmxvYXRfbGluZWFyIikgPT09ICExKSByZXR1cm47CiAgICAgIGlmIChBLmFuaXNvdHJvcHkgPiAxIHx8IGkuZ2V0KEEpLl9fY3VycmVudEFuaXNvdHJvcHkpIHsKICAgICAgICBjb25zdCBOID0gdC5nZXQoIkVYVF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYyIpOwogICAgICAgIGEudGV4UGFyYW1ldGVyZihQLCBOLlRFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhULCBNYXRoLm1pbihBLmFuaXNvdHJvcHksIG4uZ2V0TWF4QW5pc290cm9weSgpKSksIGkuZ2V0KEEpLl9fY3VycmVudEFuaXNvdHJvcHkgPSBBLmFuaXNvdHJvcHk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24ganQoUCwgQSkgewogICAgbGV0IE4gPSAhMTsKICAgIFAuX193ZWJnbEluaXQgPT09IHZvaWQgMCAmJiAoUC5fX3dlYmdsSW5pdCA9ICEwLCBBLmFkZEV2ZW50TGlzdGVuZXIoImRpc3Bvc2UiLCB3KSk7CiAgICBjb25zdCBYID0gQS5zb3VyY2U7CiAgICBsZXQgcnQgPSBkLmdldChYKTsKICAgIHJ0ID09PSB2b2lkIDAgJiYgKHJ0ID0ge30sIGQuc2V0KFgsIHJ0KSk7CiAgICBjb25zdCBaID0gVihBKTsKICAgIGlmIChaICE9PSBQLl9fY2FjaGVLZXkpIHsKICAgICAgcnRbWl0gPT09IHZvaWQgMCAmJiAocnRbWl0gPSB7CiAgICAgICAgdGV4dHVyZTogYS5jcmVhdGVUZXh0dXJlKCksCiAgICAgICAgdXNlZFRpbWVzOiAwCiAgICAgIH0sIHIubWVtb3J5LnRleHR1cmVzKyssIE4gPSAhMCksIHJ0W1pdLnVzZWRUaW1lcysrOwogICAgICBjb25zdCBJdCA9IHJ0W1AuX19jYWNoZUtleV07CiAgICAgIEl0ICE9PSB2b2lkIDAgJiYgKHJ0W1AuX19jYWNoZUtleV0udXNlZFRpbWVzLS0sIEl0LnVzZWRUaW1lcyA9PT0gMCAmJiBiKEEpKSwgUC5fX2NhY2hlS2V5ID0gWiwgUC5fX3dlYmdsVGV4dHVyZSA9IHJ0W1pdLnRleHR1cmU7CiAgICB9CiAgICByZXR1cm4gTjsKICB9CiAgZnVuY3Rpb24gbmUoUCwgQSwgTikgewogICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5mbG9vcihQIC8gTikgLyBBKTsKICB9CiAgZnVuY3Rpb24gSnQoUCwgQSwgTiwgWCkgewogICAgY29uc3QgWiA9IFAudXBkYXRlUmFuZ2VzOwogICAgaWYgKFoubGVuZ3RoID09PSAwKQogICAgICBlLnRleFN1YkltYWdlMkQoYS5URVhUVVJFXzJELCAwLCAwLCAwLCBBLndpZHRoLCBBLmhlaWdodCwgTiwgWCwgQS5kYXRhKTsKICAgIGVsc2UgewogICAgICBaLnNvcnQoKGosIG10KSA9PiBqLnN0YXJ0IC0gbXQuc3RhcnQpOwogICAgICBsZXQgSXQgPSAwOwogICAgICBmb3IgKGxldCBqID0gMTsgaiA8IFoubGVuZ3RoOyBqKyspIHsKICAgICAgICBjb25zdCBtdCA9IFpbSXRdLCBBdCA9IFpbal0sIFR0ID0gbXQuc3RhcnQgKyBtdC5jb3VudCwgdnQgPSBuZShBdC5zdGFydCwgQS53aWR0aCwgNCksICR0ID0gbmUobXQuc3RhcnQsIEEud2lkdGgsIDQpOwogICAgICAgIEF0LnN0YXJ0IDw9IFR0ICsgMSAmJiB2dCA9PT0gJHQgJiYgbmUoQXQuc3RhcnQgKyBBdC5jb3VudCAtIDEsIEEud2lkdGgsIDQpID09PSB2dCA/IG10LmNvdW50ID0gTWF0aC5tYXgoCiAgICAgICAgICBtdC5jb3VudCwKICAgICAgICAgIEF0LnN0YXJ0ICsgQXQuY291bnQgLSBtdC5zdGFydAogICAgICAgICkgOiAoKytJdCwgWltJdF0gPSBBdCk7CiAgICAgIH0KICAgICAgWi5sZW5ndGggPSBJdCArIDE7CiAgICAgIGNvbnN0IEkgPSBhLmdldFBhcmFtZXRlcihhLlVOUEFDS19ST1dfTEVOR1RIKSwgbHQgPSBhLmdldFBhcmFtZXRlcihhLlVOUEFDS19TS0lQX1BJWEVMUyksIGd0ID0gYS5nZXRQYXJhbWV0ZXIoYS5VTlBBQ0tfU0tJUF9ST1dTKTsKICAgICAgYS5waXhlbFN0b3JlaShhLlVOUEFDS19ST1dfTEVOR1RILCBBLndpZHRoKTsKICAgICAgZm9yIChsZXQgaiA9IDAsIG10ID0gWi5sZW5ndGg7IGogPCBtdDsgaisrKSB7CiAgICAgICAgY29uc3QgQXQgPSBaW2pdLCBUdCA9IE1hdGguZmxvb3IoQXQuc3RhcnQgLyA0KSwgdnQgPSBNYXRoLmNlaWwoQXQuY291bnQgLyA0KSwgJHQgPSBUdCAlIEEud2lkdGgsIEYgPSBNYXRoLmZsb29yKFR0IC8gQS53aWR0aCksIGh0ID0gdnQsIF90ID0gMTsKICAgICAgICBhLnBpeGVsU3RvcmVpKGEuVU5QQUNLX1NLSVBfUElYRUxTLCAkdCksIGEucGl4ZWxTdG9yZWkoYS5VTlBBQ0tfU0tJUF9ST1dTLCBGKSwgZS50ZXhTdWJJbWFnZTJEKGEuVEVYVFVSRV8yRCwgMCwgJHQsIEYsIGh0LCBfdCwgTiwgWCwgQS5kYXRhKTsKICAgICAgfQogICAgICBQLmNsZWFyVXBkYXRlUmFuZ2VzKCksIGEucGl4ZWxTdG9yZWkoYS5VTlBBQ0tfUk9XX0xFTkdUSCwgSSksIGEucGl4ZWxTdG9yZWkoYS5VTlBBQ0tfU0tJUF9QSVhFTFMsIGx0KSwgYS5waXhlbFN0b3JlaShhLlVOUEFDS19TS0lQX1JPV1MsIGd0KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gWShQLCBBLCBOKSB7CiAgICBsZXQgWCA9IGEuVEVYVFVSRV8yRDsKICAgIChBLmlzRGF0YUFycmF5VGV4dHVyZSB8fCBBLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSkgJiYgKFggPSBhLlRFWFRVUkVfMkRfQVJSQVkpLCBBLmlzRGF0YTNEVGV4dHVyZSAmJiAoWCA9IGEuVEVYVFVSRV8zRCk7CiAgICBjb25zdCBydCA9IGp0KFAsIEEpLCBaID0gQS5zb3VyY2U7CiAgICBlLmJpbmRUZXh0dXJlKFgsIFAuX193ZWJnbFRleHR1cmUsIGEuVEVYVFVSRTAgKyBOKTsKICAgIGNvbnN0IEl0ID0gaS5nZXQoWik7CiAgICBpZiAoWi52ZXJzaW9uICE9PSBJdC5fX3ZlcnNpb24gfHwgcnQgPT09ICEwKSB7CiAgICAgIGUuYWN0aXZlVGV4dHVyZShhLlRFWFRVUkUwICsgTik7CiAgICAgIGNvbnN0IEkgPSBlZS5nZXRQcmltYXJpZXMoZWUud29ya2luZ0NvbG9yU3BhY2UpLCBsdCA9IEEuY29sb3JTcGFjZSA9PT0gJG4gPyBudWxsIDogZWUuZ2V0UHJpbWFyaWVzKEEuY29sb3JTcGFjZSksIGd0ID0gQS5jb2xvclNwYWNlID09PSAkbiB8fCBJID09PSBsdCA/IGEuTk9ORSA6IGEuQlJPV1NFUl9ERUZBVUxUX1dFQkdMOwogICAgICBhLnBpeGVsU3RvcmVpKGEuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgQS5mbGlwWSksIGEucGl4ZWxTdG9yZWkoYS5VTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0wsIEEucHJlbXVsdGlwbHlBbHBoYSksIGEucGl4ZWxTdG9yZWkoYS5VTlBBQ0tfQUxJR05NRU5ULCBBLnVucGFja0FsaWdubWVudCksIGEucGl4ZWxTdG9yZWkoYS5VTlBBQ0tfQ09MT1JTUEFDRV9DT05WRVJTSU9OX1dFQkdMLCBndCk7CiAgICAgIGxldCBqID0geShBLmltYWdlLCAhMSwgbi5tYXhUZXh0dXJlU2l6ZSk7CiAgICAgIGogPSBXdChBLCBqKTsKICAgICAgY29uc3QgbXQgPSBzLmNvbnZlcnQoQS5mb3JtYXQsIEEuY29sb3JTcGFjZSksIEF0ID0gcy5jb252ZXJ0KEEudHlwZSk7CiAgICAgIGxldCBUdCA9IHgoQS5pbnRlcm5hbEZvcm1hdCwgbXQsIEF0LCBBLmNvbG9yU3BhY2UsIEEuaXNWaWRlb1RleHR1cmUpOwogICAgICBMdChYLCBBKTsKICAgICAgbGV0IHZ0OwogICAgICBjb25zdCAkdCA9IEEubWlwbWFwcywgRiA9IEEuaXNWaWRlb1RleHR1cmUgIT09ICEwLCBodCA9IEl0Ll9fdmVyc2lvbiA9PT0gdm9pZCAwIHx8IHJ0ID09PSAhMCwgX3QgPSBaLmRhdGFSZWFkeSwgUnQgPSBTKEEsIGopOwogICAgICBpZiAoQS5pc0RlcHRoVGV4dHVyZSkKICAgICAgICBUdCA9IF8oQS5mb3JtYXQgPT09IG1hLCBBLnR5cGUpLCBodCAmJiAoRiA/IGUudGV4U3RvcmFnZTJEKGEuVEVYVFVSRV8yRCwgMSwgVHQsIGoud2lkdGgsIGouaGVpZ2h0KSA6IGUudGV4SW1hZ2UyRChhLlRFWFRVUkVfMkQsIDAsIFR0LCBqLndpZHRoLCBqLmhlaWdodCwgMCwgbXQsIEF0LCBudWxsKSk7CiAgICAgIGVsc2UgaWYgKEEuaXNEYXRhVGV4dHVyZSkKICAgICAgICBpZiAoJHQubGVuZ3RoID4gMCkgewogICAgICAgICAgRiAmJiBodCAmJiBlLnRleFN0b3JhZ2UyRChhLlRFWFRVUkVfMkQsIFJ0LCBUdCwgJHRbMF0ud2lkdGgsICR0WzBdLmhlaWdodCk7CiAgICAgICAgICBmb3IgKGxldCBkdCA9IDAsIG50ID0gJHQubGVuZ3RoOyBkdCA8IG50OyBkdCsrKQogICAgICAgICAgICB2dCA9ICR0W2R0XSwgRiA/IF90ICYmIGUudGV4U3ViSW1hZ2UyRChhLlRFWFRVUkVfMkQsIGR0LCAwLCAwLCB2dC53aWR0aCwgdnQuaGVpZ2h0LCBtdCwgQXQsIHZ0LmRhdGEpIDogZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV8yRCwgZHQsIFR0LCB2dC53aWR0aCwgdnQuaGVpZ2h0LCAwLCBtdCwgQXQsIHZ0LmRhdGEpOwogICAgICAgICAgQS5nZW5lcmF0ZU1pcG1hcHMgPSAhMTsKICAgICAgICB9IGVsc2UKICAgICAgICAgIEYgPyAoaHQgJiYgZS50ZXhTdG9yYWdlMkQoYS5URVhUVVJFXzJELCBSdCwgVHQsIGoud2lkdGgsIGouaGVpZ2h0KSwgX3QgJiYgSnQoQSwgaiwgbXQsIEF0KSkgOiBlLnRleEltYWdlMkQoYS5URVhUVVJFXzJELCAwLCBUdCwgai53aWR0aCwgai5oZWlnaHQsIDAsIG10LCBBdCwgai5kYXRhKTsKICAgICAgZWxzZSBpZiAoQS5pc0NvbXByZXNzZWRUZXh0dXJlKQogICAgICAgIGlmIChBLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSkgewogICAgICAgICAgRiAmJiBodCAmJiBlLnRleFN0b3JhZ2UzRChhLlRFWFRVUkVfMkRfQVJSQVksIFJ0LCBUdCwgJHRbMF0ud2lkdGgsICR0WzBdLmhlaWdodCwgai5kZXB0aCk7CiAgICAgICAgICBmb3IgKGxldCBkdCA9IDAsIG50ID0gJHQubGVuZ3RoOyBkdCA8IG50OyBkdCsrKQogICAgICAgICAgICBpZiAodnQgPSAkdFtkdF0sIEEuZm9ybWF0ICE9PSBnaSkKICAgICAgICAgICAgICBpZiAobXQgIT09IG51bGwpCiAgICAgICAgICAgICAgICBpZiAoRikgewogICAgICAgICAgICAgICAgICBpZiAoX3QpCiAgICAgICAgICAgICAgICAgICAgaWYgKEEubGF5ZXJVcGRhdGVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBGdCA9IGxwKHZ0LndpZHRoLCB2dC5oZWlnaHQsIEEuZm9ybWF0LCBBLnR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBxdCBvZiBBLmxheWVyVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBnZSA9IHZ0LmRhdGEuc3ViYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgcXQgKiBGdCAvIHZ0LmRhdGEuQllURVNfUEVSX0VMRU1FTlQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgKHF0ICsgMSkgKiBGdCAvIHZ0LmRhdGEuQllURVNfUEVSX0VMRU1FTlQKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgZS5jb21wcmVzc2VkVGV4U3ViSW1hZ2UzRChhLlRFWFRVUkVfMkRfQVJSQVksIGR0LCAwLCAwLCBxdCwgdnQud2lkdGgsIHZ0LmhlaWdodCwgMSwgbXQsIGdlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIEEuY2xlYXJMYXllclVwZGF0ZXMoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgICAgICAgIGUuY29tcHJlc3NlZFRleFN1YkltYWdlM0QoYS5URVhUVVJFXzJEX0FSUkFZLCBkdCwgMCwgMCwgMCwgdnQud2lkdGgsIHZ0LmhlaWdodCwgai5kZXB0aCwgbXQsIHZ0LmRhdGEpOwogICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgIGUuY29tcHJlc3NlZFRleEltYWdlM0QoYS5URVhUVVJFXzJEX0FSUkFZLCBkdCwgVHQsIHZ0LndpZHRoLCB2dC5oZWlnaHQsIGouZGVwdGgsIDAsIHZ0LmRhdGEsIDAsIDApOwogICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xSZW5kZXJlcjogQXR0ZW1wdCB0byBsb2FkIHVuc3VwcG9ydGVkIGNvbXByZXNzZWQgdGV4dHVyZSBmb3JtYXQgaW4gLnVwbG9hZFRleHR1cmUoKSIpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgRiA/IF90ICYmIGUudGV4U3ViSW1hZ2UzRChhLlRFWFRVUkVfMkRfQVJSQVksIGR0LCAwLCAwLCAwLCB2dC53aWR0aCwgdnQuaGVpZ2h0LCBqLmRlcHRoLCBtdCwgQXQsIHZ0LmRhdGEpIDogZS50ZXhJbWFnZTNEKGEuVEVYVFVSRV8yRF9BUlJBWSwgZHQsIFR0LCB2dC53aWR0aCwgdnQuaGVpZ2h0LCBqLmRlcHRoLCAwLCBtdCwgQXQsIHZ0LmRhdGEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBGICYmIGh0ICYmIGUudGV4U3RvcmFnZTJEKGEuVEVYVFVSRV8yRCwgUnQsIFR0LCAkdFswXS53aWR0aCwgJHRbMF0uaGVpZ2h0KTsKICAgICAgICAgIGZvciAobGV0IGR0ID0gMCwgbnQgPSAkdC5sZW5ndGg7IGR0IDwgbnQ7IGR0KyspCiAgICAgICAgICAgIHZ0ID0gJHRbZHRdLCBBLmZvcm1hdCAhPT0gZ2kgPyBtdCAhPT0gbnVsbCA/IEYgPyBfdCAmJiBlLmNvbXByZXNzZWRUZXhTdWJJbWFnZTJEKGEuVEVYVFVSRV8yRCwgZHQsIDAsIDAsIHZ0LndpZHRoLCB2dC5oZWlnaHQsIG10LCB2dC5kYXRhKSA6IGUuY29tcHJlc3NlZFRleEltYWdlMkQoYS5URVhUVVJFXzJELCBkdCwgVHQsIHZ0LndpZHRoLCB2dC5oZWlnaHQsIDAsIHZ0LmRhdGEpIDogY29uc29sZS53YXJuKCJUSFJFRS5XZWJHTFJlbmRlcmVyOiBBdHRlbXB0IHRvIGxvYWQgdW5zdXBwb3J0ZWQgY29tcHJlc3NlZCB0ZXh0dXJlIGZvcm1hdCBpbiAudXBsb2FkVGV4dHVyZSgpIikgOiBGID8gX3QgJiYgZS50ZXhTdWJJbWFnZTJEKGEuVEVYVFVSRV8yRCwgZHQsIDAsIDAsIHZ0LndpZHRoLCB2dC5oZWlnaHQsIG10LCBBdCwgdnQuZGF0YSkgOiBlLnRleEltYWdlMkQoYS5URVhUVVJFXzJELCBkdCwgVHQsIHZ0LndpZHRoLCB2dC5oZWlnaHQsIDAsIG10LCBBdCwgdnQuZGF0YSk7CiAgICAgICAgfQogICAgICBlbHNlIGlmIChBLmlzRGF0YUFycmF5VGV4dHVyZSkKICAgICAgICBpZiAoRikgewogICAgICAgICAgaWYgKGh0ICYmIGUudGV4U3RvcmFnZTNEKGEuVEVYVFVSRV8yRF9BUlJBWSwgUnQsIFR0LCBqLndpZHRoLCBqLmhlaWdodCwgai5kZXB0aCksIF90KQogICAgICAgICAgICBpZiAoQS5sYXllclVwZGF0ZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICBjb25zdCBkdCA9IGxwKGoud2lkdGgsIGouaGVpZ2h0LCBBLmZvcm1hdCwgQS50eXBlKTsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IG50IG9mIEEubGF5ZXJVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBGdCA9IGouZGF0YS5zdWJhcnJheSgKICAgICAgICAgICAgICAgICAgbnQgKiBkdCAvIGouZGF0YS5CWVRFU19QRVJfRUxFTUVOVCwKICAgICAgICAgICAgICAgICAgKG50ICsgMSkgKiBkdCAvIGouZGF0YS5CWVRFU19QRVJfRUxFTUVOVAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGUudGV4U3ViSW1hZ2UzRChhLlRFWFRVUkVfMkRfQVJSQVksIDAsIDAsIDAsIG50LCBqLndpZHRoLCBqLmhlaWdodCwgMSwgbXQsIEF0LCBGdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIEEuY2xlYXJMYXllclVwZGF0ZXMoKTsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgZS50ZXhTdWJJbWFnZTNEKGEuVEVYVFVSRV8yRF9BUlJBWSwgMCwgMCwgMCwgMCwgai53aWR0aCwgai5oZWlnaHQsIGouZGVwdGgsIG10LCBBdCwgai5kYXRhKTsKICAgICAgICB9IGVsc2UKICAgICAgICAgIGUudGV4SW1hZ2UzRChhLlRFWFRVUkVfMkRfQVJSQVksIDAsIFR0LCBqLndpZHRoLCBqLmhlaWdodCwgai5kZXB0aCwgMCwgbXQsIEF0LCBqLmRhdGEpOwogICAgICBlbHNlIGlmIChBLmlzRGF0YTNEVGV4dHVyZSkKICAgICAgICBGID8gKGh0ICYmIGUudGV4U3RvcmFnZTNEKGEuVEVYVFVSRV8zRCwgUnQsIFR0LCBqLndpZHRoLCBqLmhlaWdodCwgai5kZXB0aCksIF90ICYmIGUudGV4U3ViSW1hZ2UzRChhLlRFWFRVUkVfM0QsIDAsIDAsIDAsIDAsIGoud2lkdGgsIGouaGVpZ2h0LCBqLmRlcHRoLCBtdCwgQXQsIGouZGF0YSkpIDogZS50ZXhJbWFnZTNEKGEuVEVYVFVSRV8zRCwgMCwgVHQsIGoud2lkdGgsIGouaGVpZ2h0LCBqLmRlcHRoLCAwLCBtdCwgQXQsIGouZGF0YSk7CiAgICAgIGVsc2UgaWYgKEEuaXNGcmFtZWJ1ZmZlclRleHR1cmUpIHsKICAgICAgICBpZiAoaHQpCiAgICAgICAgICBpZiAoRikKICAgICAgICAgICAgZS50ZXhTdG9yYWdlMkQoYS5URVhUVVJFXzJELCBSdCwgVHQsIGoud2lkdGgsIGouaGVpZ2h0KTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBsZXQgZHQgPSBqLndpZHRoLCBudCA9IGouaGVpZ2h0OwogICAgICAgICAgICBmb3IgKGxldCBGdCA9IDA7IEZ0IDwgUnQ7IEZ0KyspCiAgICAgICAgICAgICAgZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV8yRCwgRnQsIFR0LCBkdCwgbnQsIDAsIG10LCBBdCwgbnVsbCksIGR0ID4+PSAxLCBudCA+Pj0gMTsKICAgICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgkdC5sZW5ndGggPiAwKSB7CiAgICAgICAgaWYgKEYgJiYgaHQpIHsKICAgICAgICAgIGNvbnN0IGR0ID0gTnQoJHRbMF0pOwogICAgICAgICAgZS50ZXhTdG9yYWdlMkQoYS5URVhUVVJFXzJELCBSdCwgVHQsIGR0LndpZHRoLCBkdC5oZWlnaHQpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBkdCA9IDAsIG50ID0gJHQubGVuZ3RoOyBkdCA8IG50OyBkdCsrKQogICAgICAgICAgdnQgPSAkdFtkdF0sIEYgPyBfdCAmJiBlLnRleFN1YkltYWdlMkQoYS5URVhUVVJFXzJELCBkdCwgMCwgMCwgbXQsIEF0LCB2dCkgOiBlLnRleEltYWdlMkQoYS5URVhUVVJFXzJELCBkdCwgVHQsIG10LCBBdCwgdnQpOwogICAgICAgIEEuZ2VuZXJhdGVNaXBtYXBzID0gITE7CiAgICAgIH0gZWxzZSBpZiAoRikgewogICAgICAgIGlmIChodCkgewogICAgICAgICAgY29uc3QgZHQgPSBOdChqKTsKICAgICAgICAgIGUudGV4U3RvcmFnZTJEKGEuVEVYVFVSRV8yRCwgUnQsIFR0LCBkdC53aWR0aCwgZHQuaGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgX3QgJiYgZS50ZXhTdWJJbWFnZTJEKGEuVEVYVFVSRV8yRCwgMCwgMCwgMCwgbXQsIEF0LCBqKTsKICAgICAgfSBlbHNlCiAgICAgICAgZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV8yRCwgMCwgVHQsIG10LCBBdCwgaik7CiAgICAgIGcoQSkgJiYgbShYKSwgSXQuX192ZXJzaW9uID0gWi52ZXJzaW9uLCBBLm9uVXBkYXRlICYmIEEub25VcGRhdGUoQSk7CiAgICB9CiAgICBQLl9fdmVyc2lvbiA9IEEudmVyc2lvbjsKICB9CiAgZnVuY3Rpb24gc3QoUCwgQSwgTikgewogICAgaWYgKEEuaW1hZ2UubGVuZ3RoICE9PSA2KSByZXR1cm47CiAgICBjb25zdCBYID0ganQoUCwgQSksIHJ0ID0gQS5zb3VyY2U7CiAgICBlLmJpbmRUZXh0dXJlKGEuVEVYVFVSRV9DVUJFX01BUCwgUC5fX3dlYmdsVGV4dHVyZSwgYS5URVhUVVJFMCArIE4pOwogICAgY29uc3QgWiA9IGkuZ2V0KHJ0KTsKICAgIGlmIChydC52ZXJzaW9uICE9PSBaLl9fdmVyc2lvbiB8fCBYID09PSAhMCkgewogICAgICBlLmFjdGl2ZVRleHR1cmUoYS5URVhUVVJFMCArIE4pOwogICAgICBjb25zdCBJdCA9IGVlLmdldFByaW1hcmllcyhlZS53b3JraW5nQ29sb3JTcGFjZSksIEkgPSBBLmNvbG9yU3BhY2UgPT09ICRuID8gbnVsbCA6IGVlLmdldFByaW1hcmllcyhBLmNvbG9yU3BhY2UpLCBsdCA9IEEuY29sb3JTcGFjZSA9PT0gJG4gfHwgSXQgPT09IEkgPyBhLk5PTkUgOiBhLkJST1dTRVJfREVGQVVMVF9XRUJHTDsKICAgICAgYS5waXhlbFN0b3JlaShhLlVOUEFDS19GTElQX1lfV0VCR0wsIEEuZmxpcFkpLCBhLnBpeGVsU3RvcmVpKGEuVU5QQUNLX1BSRU1VTFRJUExZX0FMUEhBX1dFQkdMLCBBLnByZW11bHRpcGx5QWxwaGEpLCBhLnBpeGVsU3RvcmVpKGEuVU5QQUNLX0FMSUdOTUVOVCwgQS51bnBhY2tBbGlnbm1lbnQpLCBhLnBpeGVsU3RvcmVpKGEuVU5QQUNLX0NPTE9SU1BBQ0VfQ09OVkVSU0lPTl9XRUJHTCwgbHQpOwogICAgICBjb25zdCBndCA9IEEuaXNDb21wcmVzc2VkVGV4dHVyZSB8fCBBLmltYWdlWzBdLmlzQ29tcHJlc3NlZFRleHR1cmUsIGogPSBBLmltYWdlWzBdICYmIEEuaW1hZ2VbMF0uaXNEYXRhVGV4dHVyZSwgbXQgPSBbXTsKICAgICAgZm9yIChsZXQgbnQgPSAwOyBudCA8IDY7IG50KyspCiAgICAgICAgIWd0ICYmICFqID8gbXRbbnRdID0geShBLmltYWdlW250XSwgITAsIG4ubWF4Q3ViZW1hcFNpemUpIDogbXRbbnRdID0gaiA/IEEuaW1hZ2VbbnRdLmltYWdlIDogQS5pbWFnZVtudF0sIG10W250XSA9IFd0KEEsIG10W250XSk7CiAgICAgIGNvbnN0IEF0ID0gbXRbMF0sIFR0ID0gcy5jb252ZXJ0KEEuZm9ybWF0LCBBLmNvbG9yU3BhY2UpLCB2dCA9IHMuY29udmVydChBLnR5cGUpLCAkdCA9IHgoQS5pbnRlcm5hbEZvcm1hdCwgVHQsIHZ0LCBBLmNvbG9yU3BhY2UpLCBGID0gQS5pc1ZpZGVvVGV4dHVyZSAhPT0gITAsIGh0ID0gWi5fX3ZlcnNpb24gPT09IHZvaWQgMCB8fCBYID09PSAhMCwgX3QgPSBydC5kYXRhUmVhZHk7CiAgICAgIGxldCBSdCA9IFMoQSwgQXQpOwogICAgICBMdChhLlRFWFRVUkVfQ1VCRV9NQVAsIEEpOwogICAgICBsZXQgZHQ7CiAgICAgIGlmIChndCkgewogICAgICAgIEYgJiYgaHQgJiYgZS50ZXhTdG9yYWdlMkQoYS5URVhUVVJFX0NVQkVfTUFQLCBSdCwgJHQsIEF0LndpZHRoLCBBdC5oZWlnaHQpOwogICAgICAgIGZvciAobGV0IG50ID0gMDsgbnQgPCA2OyBudCsrKSB7CiAgICAgICAgICBkdCA9IG10W250XS5taXBtYXBzOwogICAgICAgICAgZm9yIChsZXQgRnQgPSAwOyBGdCA8IGR0Lmxlbmd0aDsgRnQrKykgewogICAgICAgICAgICBjb25zdCBxdCA9IGR0W0Z0XTsKICAgICAgICAgICAgQS5mb3JtYXQgIT09IGdpID8gVHQgIT09IG51bGwgPyBGID8gX3QgJiYgZS5jb21wcmVzc2VkVGV4U3ViSW1hZ2UyRChhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIG50LCBGdCwgMCwgMCwgcXQud2lkdGgsIHF0LmhlaWdodCwgVHQsIHF0LmRhdGEpIDogZS5jb21wcmVzc2VkVGV4SW1hZ2UyRChhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIG50LCBGdCwgJHQsIHF0LndpZHRoLCBxdC5oZWlnaHQsIDAsIHF0LmRhdGEpIDogY29uc29sZS53YXJuKCJUSFJFRS5XZWJHTFJlbmRlcmVyOiBBdHRlbXB0IHRvIGxvYWQgdW5zdXBwb3J0ZWQgY29tcHJlc3NlZCB0ZXh0dXJlIGZvcm1hdCBpbiAuc2V0VGV4dHVyZUN1YmUoKSIpIDogRiA/IF90ICYmIGUudGV4U3ViSW1hZ2UyRChhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIG50LCBGdCwgMCwgMCwgcXQud2lkdGgsIHF0LmhlaWdodCwgVHQsIHZ0LCBxdC5kYXRhKSA6IGUudGV4SW1hZ2UyRChhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIG50LCBGdCwgJHQsIHF0LndpZHRoLCBxdC5oZWlnaHQsIDAsIFR0LCB2dCwgcXQuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkdCA9IEEubWlwbWFwcywgRiAmJiBodCkgewogICAgICAgICAgZHQubGVuZ3RoID4gMCAmJiBSdCsrOwogICAgICAgICAgY29uc3QgbnQgPSBOdChtdFswXSk7CiAgICAgICAgICBlLnRleFN0b3JhZ2UyRChhLlRFWFRVUkVfQ1VCRV9NQVAsIFJ0LCAkdCwgbnQud2lkdGgsIG50LmhlaWdodCk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IG50ID0gMDsgbnQgPCA2OyBudCsrKQogICAgICAgICAgaWYgKGopIHsKICAgICAgICAgICAgRiA/IF90ICYmIGUudGV4U3ViSW1hZ2UyRChhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIG50LCAwLCAwLCAwLCBtdFtudF0ud2lkdGgsIG10W250XS5oZWlnaHQsIFR0LCB2dCwgbXRbbnRdLmRhdGEpIDogZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgbnQsIDAsICR0LCBtdFtudF0ud2lkdGgsIG10W250XS5oZWlnaHQsIDAsIFR0LCB2dCwgbXRbbnRdLmRhdGEpOwogICAgICAgICAgICBmb3IgKGxldCBGdCA9IDA7IEZ0IDwgZHQubGVuZ3RoOyBGdCsrKSB7CiAgICAgICAgICAgICAgY29uc3QgZ2UgPSBkdFtGdF0uaW1hZ2VbbnRdLmltYWdlOwogICAgICAgICAgICAgIEYgPyBfdCAmJiBlLnRleFN1YkltYWdlMkQoYS5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBudCwgRnQgKyAxLCAwLCAwLCBnZS53aWR0aCwgZ2UuaGVpZ2h0LCBUdCwgdnQsIGdlLmRhdGEpIDogZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgbnQsIEZ0ICsgMSwgJHQsIGdlLndpZHRoLCBnZS5oZWlnaHQsIDAsIFR0LCB2dCwgZ2UuZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEYgPyBfdCAmJiBlLnRleFN1YkltYWdlMkQoYS5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBudCwgMCwgMCwgMCwgVHQsIHZ0LCBtdFtudF0pIDogZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgbnQsIDAsICR0LCBUdCwgdnQsIG10W250XSk7CiAgICAgICAgICAgIGZvciAobGV0IEZ0ID0gMDsgRnQgPCBkdC5sZW5ndGg7IEZ0KyspIHsKICAgICAgICAgICAgICBjb25zdCBxdCA9IGR0W0Z0XTsKICAgICAgICAgICAgICBGID8gX3QgJiYgZS50ZXhTdWJJbWFnZTJEKGEuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgbnQsIEZ0ICsgMSwgMCwgMCwgVHQsIHZ0LCBxdC5pbWFnZVtudF0pIDogZS50ZXhJbWFnZTJEKGEuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgbnQsIEZ0ICsgMSwgJHQsIFR0LCB2dCwgcXQuaW1hZ2VbbnRdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgIGcoQSkgJiYgbShhLlRFWFRVUkVfQ1VCRV9NQVApLCBaLl9fdmVyc2lvbiA9IHJ0LnZlcnNpb24sIEEub25VcGRhdGUgJiYgQS5vblVwZGF0ZShBKTsKICAgIH0KICAgIFAuX192ZXJzaW9uID0gQS52ZXJzaW9uOwogIH0KICBmdW5jdGlvbiBFdChQLCBBLCBOLCBYLCBydCwgWikgewogICAgY29uc3QgSXQgPSBzLmNvbnZlcnQoTi5mb3JtYXQsIE4uY29sb3JTcGFjZSksIEkgPSBzLmNvbnZlcnQoTi50eXBlKSwgbHQgPSB4KE4uaW50ZXJuYWxGb3JtYXQsIEl0LCBJLCBOLmNvbG9yU3BhY2UpLCBndCA9IGkuZ2V0KEEpLCBqID0gaS5nZXQoTik7CiAgICBpZiAoai5fX3JlbmRlclRhcmdldCA9IEEsICFndC5fX2hhc0V4dGVybmFsVGV4dHVyZXMpIHsKICAgICAgY29uc3QgbXQgPSBNYXRoLm1heCgxLCBBLndpZHRoID4+IFopLCBBdCA9IE1hdGgubWF4KDEsIEEuaGVpZ2h0ID4+IFopOwogICAgICBydCA9PT0gYS5URVhUVVJFXzNEIHx8IHJ0ID09PSBhLlRFWFRVUkVfMkRfQVJSQVkgPyBlLnRleEltYWdlM0QocnQsIFosIGx0LCBtdCwgQXQsIEEuZGVwdGgsIDAsIEl0LCBJLCBudWxsKSA6IGUudGV4SW1hZ2UyRChydCwgWiwgbHQsIG10LCBBdCwgMCwgSXQsIEksIG51bGwpOwogICAgfQogICAgZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgUCksIHV0KEEpID8gby5mcmFtZWJ1ZmZlclRleHR1cmUyRE11bHRpc2FtcGxlRVhUKGEuRlJBTUVCVUZGRVIsIFgsIHJ0LCBqLl9fd2ViZ2xUZXh0dXJlLCAwLCB5dChBKSkgOiAocnQgPT09IGEuVEVYVFVSRV8yRCB8fCBydCA+PSBhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCAmJiBydCA8PSBhLlRFWFRVUkVfQ1VCRV9NQVBfTkVHQVRJVkVfWikgJiYgYS5mcmFtZWJ1ZmZlclRleHR1cmUyRChhLkZSQU1FQlVGRkVSLCBYLCBydCwgai5fX3dlYmdsVGV4dHVyZSwgWiksIGUuYmluZEZyYW1lYnVmZmVyKGEuRlJBTUVCVUZGRVIsIG51bGwpOwogIH0KICBmdW5jdGlvbiBVdChQLCBBLCBOKSB7CiAgICBpZiAoYS5iaW5kUmVuZGVyYnVmZmVyKGEuUkVOREVSQlVGRkVSLCBQKSwgQS5kZXB0aEJ1ZmZlcikgewogICAgICBjb25zdCBYID0gQS5kZXB0aFRleHR1cmUsIHJ0ID0gWCAmJiBYLmlzRGVwdGhUZXh0dXJlID8gWC50eXBlIDogbnVsbCwgWiA9IF8oQS5zdGVuY2lsQnVmZmVyLCBydCksIEl0ID0gQS5zdGVuY2lsQnVmZmVyID8gYS5ERVBUSF9TVEVOQ0lMX0FUVEFDSE1FTlQgOiBhLkRFUFRIX0FUVEFDSE1FTlQsIEkgPSB5dChBKTsKICAgICAgdXQoQSkgPyBvLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZUVYVChhLlJFTkRFUkJVRkZFUiwgSSwgWiwgQS53aWR0aCwgQS5oZWlnaHQpIDogTiA/IGEucmVuZGVyYnVmZmVyU3RvcmFnZU11bHRpc2FtcGxlKGEuUkVOREVSQlVGRkVSLCBJLCBaLCBBLndpZHRoLCBBLmhlaWdodCkgOiBhLnJlbmRlcmJ1ZmZlclN0b3JhZ2UoYS5SRU5ERVJCVUZGRVIsIFosIEEud2lkdGgsIEEuaGVpZ2h0KSwgYS5mcmFtZWJ1ZmZlclJlbmRlcmJ1ZmZlcihhLkZSQU1FQlVGRkVSLCBJdCwgYS5SRU5ERVJCVUZGRVIsIFApOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgWCA9IEEudGV4dHVyZXM7CiAgICAgIGZvciAobGV0IHJ0ID0gMDsgcnQgPCBYLmxlbmd0aDsgcnQrKykgewogICAgICAgIGNvbnN0IFogPSBYW3J0XSwgSXQgPSBzLmNvbnZlcnQoWi5mb3JtYXQsIFouY29sb3JTcGFjZSksIEkgPSBzLmNvbnZlcnQoWi50eXBlKSwgbHQgPSB4KFouaW50ZXJuYWxGb3JtYXQsIEl0LCBJLCBaLmNvbG9yU3BhY2UpLCBndCA9IHl0KEEpOwogICAgICAgIE4gJiYgdXQoQSkgPT09ICExID8gYS5yZW5kZXJidWZmZXJTdG9yYWdlTXVsdGlzYW1wbGUoYS5SRU5ERVJCVUZGRVIsIGd0LCBsdCwgQS53aWR0aCwgQS5oZWlnaHQpIDogdXQoQSkgPyBvLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZUVYVChhLlJFTkRFUkJVRkZFUiwgZ3QsIGx0LCBBLndpZHRoLCBBLmhlaWdodCkgOiBhLnJlbmRlcmJ1ZmZlclN0b3JhZ2UoYS5SRU5ERVJCVUZGRVIsIGx0LCBBLndpZHRoLCBBLmhlaWdodCk7CiAgICAgIH0KICAgIH0KICAgIGEuYmluZFJlbmRlcmJ1ZmZlcihhLlJFTkRFUkJVRkZFUiwgbnVsbCk7CiAgfQogIGZ1bmN0aW9uIFB0KFAsIEEpIHsKICAgIGlmIChBICYmIEEuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQpIHRocm93IG5ldyBFcnJvcigiRGVwdGggVGV4dHVyZSB3aXRoIGN1YmUgcmVuZGVyIHRhcmdldHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgaWYgKGUuYmluZEZyYW1lYnVmZmVyKGEuRlJBTUVCVUZGRVIsIFApLCAhKEEuZGVwdGhUZXh0dXJlICYmIEEuZGVwdGhUZXh0dXJlLmlzRGVwdGhUZXh0dXJlKSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCJyZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgVEhSRUUuRGVwdGhUZXh0dXJlIik7CiAgICBjb25zdCBYID0gaS5nZXQoQS5kZXB0aFRleHR1cmUpOwogICAgWC5fX3JlbmRlclRhcmdldCA9IEEsICghWC5fX3dlYmdsVGV4dHVyZSB8fCBBLmRlcHRoVGV4dHVyZS5pbWFnZS53aWR0aCAhPT0gQS53aWR0aCB8fCBBLmRlcHRoVGV4dHVyZS5pbWFnZS5oZWlnaHQgIT09IEEuaGVpZ2h0KSAmJiAoQS5kZXB0aFRleHR1cmUuaW1hZ2Uud2lkdGggPSBBLndpZHRoLCBBLmRlcHRoVGV4dHVyZS5pbWFnZS5oZWlnaHQgPSBBLmhlaWdodCwgQS5kZXB0aFRleHR1cmUubmVlZHNVcGRhdGUgPSAhMCksIFcoQS5kZXB0aFRleHR1cmUsIDApOwogICAgY29uc3QgcnQgPSBYLl9fd2ViZ2xUZXh0dXJlLCBaID0geXQoQSk7CiAgICBpZiAoQS5kZXB0aFRleHR1cmUuZm9ybWF0ID09PSBmYSkKICAgICAgdXQoQSkgPyBvLmZyYW1lYnVmZmVyVGV4dHVyZTJETXVsdGlzYW1wbGVFWFQoYS5GUkFNRUJVRkZFUiwgYS5ERVBUSF9BVFRBQ0hNRU5ULCBhLlRFWFRVUkVfMkQsIHJ0LCAwLCBaKSA6IGEuZnJhbWVidWZmZXJUZXh0dXJlMkQoYS5GUkFNRUJVRkZFUiwgYS5ERVBUSF9BVFRBQ0hNRU5ULCBhLlRFWFRVUkVfMkQsIHJ0LCAwKTsKICAgIGVsc2UgaWYgKEEuZGVwdGhUZXh0dXJlLmZvcm1hdCA9PT0gbWEpCiAgICAgIHV0KEEpID8gby5mcmFtZWJ1ZmZlclRleHR1cmUyRE11bHRpc2FtcGxlRVhUKGEuRlJBTUVCVUZGRVIsIGEuREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5ULCBhLlRFWFRVUkVfMkQsIHJ0LCAwLCBaKSA6IGEuZnJhbWVidWZmZXJUZXh0dXJlMkQoYS5GUkFNRUJVRkZFUiwgYS5ERVBUSF9TVEVOQ0lMX0FUVEFDSE1FTlQsIGEuVEVYVFVSRV8yRCwgcnQsIDApOwogICAgZWxzZQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZGVwdGhUZXh0dXJlIGZvcm1hdCIpOwogIH0KICBmdW5jdGlvbiBLdChQKSB7CiAgICBjb25zdCBBID0gaS5nZXQoUCksIE4gPSBQLmlzV2ViR0xDdWJlUmVuZGVyVGFyZ2V0ID09PSAhMDsKICAgIGlmIChBLl9fYm91bmREZXB0aFRleHR1cmUgIT09IFAuZGVwdGhUZXh0dXJlKSB7CiAgICAgIGNvbnN0IFggPSBQLmRlcHRoVGV4dHVyZTsKICAgICAgaWYgKEEuX19kZXB0aERpc3Bvc2VDYWxsYmFjayAmJiBBLl9fZGVwdGhEaXNwb3NlQ2FsbGJhY2soKSwgWCkgewogICAgICAgIGNvbnN0IHJ0ID0gKCkgPT4gewogICAgICAgICAgZGVsZXRlIEEuX19ib3VuZERlcHRoVGV4dHVyZSwgZGVsZXRlIEEuX19kZXB0aERpc3Bvc2VDYWxsYmFjaywgWC5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgcnQpOwogICAgICAgIH07CiAgICAgICAgWC5hZGRFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgcnQpLCBBLl9fZGVwdGhEaXNwb3NlQ2FsbGJhY2sgPSBydDsKICAgICAgfQogICAgICBBLl9fYm91bmREZXB0aFRleHR1cmUgPSBYOwogICAgfQogICAgaWYgKFAuZGVwdGhUZXh0dXJlICYmICFBLl9fYXV0b0FsbG9jYXRlRGVwdGhCdWZmZXIpIHsKICAgICAgaWYgKE4pIHRocm93IG5ldyBFcnJvcigidGFyZ2V0LmRlcHRoVGV4dHVyZSBub3Qgc3VwcG9ydGVkIGluIEN1YmUgcmVuZGVyIHRhcmdldHMiKTsKICAgICAgY29uc3QgWCA9IFAudGV4dHVyZS5taXBtYXBzOwogICAgICBYICYmIFgubGVuZ3RoID4gMCA/IFB0KEEuX193ZWJnbEZyYW1lYnVmZmVyWzBdLCBQKSA6IFB0KEEuX193ZWJnbEZyYW1lYnVmZmVyLCBQKTsKICAgIH0gZWxzZSBpZiAoTikgewogICAgICBBLl9fd2ViZ2xEZXB0aGJ1ZmZlciA9IFtdOwogICAgICBmb3IgKGxldCBYID0gMDsgWCA8IDY7IFgrKykKICAgICAgICBpZiAoZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgQS5fX3dlYmdsRnJhbWVidWZmZXJbWF0pLCBBLl9fd2ViZ2xEZXB0aGJ1ZmZlcltYXSA9PT0gdm9pZCAwKQogICAgICAgICAgQS5fX3dlYmdsRGVwdGhidWZmZXJbWF0gPSBhLmNyZWF0ZVJlbmRlcmJ1ZmZlcigpLCBVdChBLl9fd2ViZ2xEZXB0aGJ1ZmZlcltYXSwgUCwgITEpOwogICAgICAgIGVsc2UgewogICAgICAgICAgY29uc3QgcnQgPSBQLnN0ZW5jaWxCdWZmZXIgPyBhLkRFUFRIX1NURU5DSUxfQVRUQUNITUVOVCA6IGEuREVQVEhfQVRUQUNITUVOVCwgWiA9IEEuX193ZWJnbERlcHRoYnVmZmVyW1hdOwogICAgICAgICAgYS5iaW5kUmVuZGVyYnVmZmVyKGEuUkVOREVSQlVGRkVSLCBaKSwgYS5mcmFtZWJ1ZmZlclJlbmRlcmJ1ZmZlcihhLkZSQU1FQlVGRkVSLCBydCwgYS5SRU5ERVJCVUZGRVIsIFopOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IFggPSBQLnRleHR1cmUubWlwbWFwczsKICAgICAgaWYgKFggJiYgWC5sZW5ndGggPiAwID8gZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgQS5fX3dlYmdsRnJhbWVidWZmZXJbMF0pIDogZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgQS5fX3dlYmdsRnJhbWVidWZmZXIpLCBBLl9fd2ViZ2xEZXB0aGJ1ZmZlciA9PT0gdm9pZCAwKQogICAgICAgIEEuX193ZWJnbERlcHRoYnVmZmVyID0gYS5jcmVhdGVSZW5kZXJidWZmZXIoKSwgVXQoQS5fX3dlYmdsRGVwdGhidWZmZXIsIFAsICExKTsKICAgICAgZWxzZSB7CiAgICAgICAgY29uc3QgcnQgPSBQLnN0ZW5jaWxCdWZmZXIgPyBhLkRFUFRIX1NURU5DSUxfQVRUQUNITUVOVCA6IGEuREVQVEhfQVRUQUNITUVOVCwgWiA9IEEuX193ZWJnbERlcHRoYnVmZmVyOwogICAgICAgIGEuYmluZFJlbmRlcmJ1ZmZlcihhLlJFTkRFUkJVRkZFUiwgWiksIGEuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoYS5GUkFNRUJVRkZFUiwgcnQsIGEuUkVOREVSQlVGRkVSLCBaKTsKICAgICAgfQogICAgfQogICAgZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgbnVsbCk7CiAgfQogIGZ1bmN0aW9uIGhlKFAsIEEsIE4pIHsKICAgIGNvbnN0IFggPSBpLmdldChQKTsKICAgIEEgIT09IHZvaWQgMCAmJiBFdChYLl9fd2ViZ2xGcmFtZWJ1ZmZlciwgUCwgUC50ZXh0dXJlLCBhLkNPTE9SX0FUVEFDSE1FTlQwLCBhLlRFWFRVUkVfMkQsIDApLCBOICE9PSB2b2lkIDAgJiYgS3QoUCk7CiAgfQogIGZ1bmN0aW9uIEQoUCkgewogICAgY29uc3QgQSA9IFAudGV4dHVyZSwgTiA9IGkuZ2V0KFApLCBYID0gaS5nZXQoQSk7CiAgICBQLmFkZEV2ZW50TGlzdGVuZXIoImRpc3Bvc2UiLCBUKTsKICAgIGNvbnN0IHJ0ID0gUC50ZXh0dXJlcywgWiA9IFAuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQgPT09ICEwLCBJdCA9IHJ0Lmxlbmd0aCA+IDE7CiAgICBpZiAoSXQgfHwgKFguX193ZWJnbFRleHR1cmUgPT09IHZvaWQgMCAmJiAoWC5fX3dlYmdsVGV4dHVyZSA9IGEuY3JlYXRlVGV4dHVyZSgpKSwgWC5fX3ZlcnNpb24gPSBBLnZlcnNpb24sIHIubWVtb3J5LnRleHR1cmVzKyspLCBaKSB7CiAgICAgIE4uX193ZWJnbEZyYW1lYnVmZmVyID0gW107CiAgICAgIGZvciAobGV0IEkgPSAwOyBJIDwgNjsgSSsrKQogICAgICAgIGlmIChBLm1pcG1hcHMgJiYgQS5taXBtYXBzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIE4uX193ZWJnbEZyYW1lYnVmZmVyW0ldID0gW107CiAgICAgICAgICBmb3IgKGxldCBsdCA9IDA7IGx0IDwgQS5taXBtYXBzLmxlbmd0aDsgbHQrKykKICAgICAgICAgICAgTi5fX3dlYmdsRnJhbWVidWZmZXJbSV1bbHRdID0gYS5jcmVhdGVGcmFtZWJ1ZmZlcigpOwogICAgICAgIH0gZWxzZQogICAgICAgICAgTi5fX3dlYmdsRnJhbWVidWZmZXJbSV0gPSBhLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CiAgICB9IGVsc2UgewogICAgICBpZiAoQS5taXBtYXBzICYmIEEubWlwbWFwcy5sZW5ndGggPiAwKSB7CiAgICAgICAgTi5fX3dlYmdsRnJhbWVidWZmZXIgPSBbXTsKICAgICAgICBmb3IgKGxldCBJID0gMDsgSSA8IEEubWlwbWFwcy5sZW5ndGg7IEkrKykKICAgICAgICAgIE4uX193ZWJnbEZyYW1lYnVmZmVyW0ldID0gYS5jcmVhdGVGcmFtZWJ1ZmZlcigpOwogICAgICB9IGVsc2UKICAgICAgICBOLl9fd2ViZ2xGcmFtZWJ1ZmZlciA9IGEuY3JlYXRlRnJhbWVidWZmZXIoKTsKICAgICAgaWYgKEl0KQogICAgICAgIGZvciAobGV0IEkgPSAwLCBsdCA9IHJ0Lmxlbmd0aDsgSSA8IGx0OyBJKyspIHsKICAgICAgICAgIGNvbnN0IGd0ID0gaS5nZXQocnRbSV0pOwogICAgICAgICAgZ3QuX193ZWJnbFRleHR1cmUgPT09IHZvaWQgMCAmJiAoZ3QuX193ZWJnbFRleHR1cmUgPSBhLmNyZWF0ZVRleHR1cmUoKSwgci5tZW1vcnkudGV4dHVyZXMrKyk7CiAgICAgICAgfQogICAgICBpZiAoUC5zYW1wbGVzID4gMCAmJiB1dChQKSA9PT0gITEpIHsKICAgICAgICBOLl9fd2ViZ2xNdWx0aXNhbXBsZWRGcmFtZWJ1ZmZlciA9IGEuY3JlYXRlRnJhbWVidWZmZXIoKSwgTi5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXIgPSBbXSwgZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgTi5fX3dlYmdsTXVsdGlzYW1wbGVkRnJhbWVidWZmZXIpOwogICAgICAgIGZvciAobGV0IEkgPSAwOyBJIDwgcnQubGVuZ3RoOyBJKyspIHsKICAgICAgICAgIGNvbnN0IGx0ID0gcnRbSV07CiAgICAgICAgICBOLl9fd2ViZ2xDb2xvclJlbmRlcmJ1ZmZlcltJXSA9IGEuY3JlYXRlUmVuZGVyYnVmZmVyKCksIGEuYmluZFJlbmRlcmJ1ZmZlcihhLlJFTkRFUkJVRkZFUiwgTi5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXJbSV0pOwogICAgICAgICAgY29uc3QgZ3QgPSBzLmNvbnZlcnQobHQuZm9ybWF0LCBsdC5jb2xvclNwYWNlKSwgaiA9IHMuY29udmVydChsdC50eXBlKSwgbXQgPSB4KGx0LmludGVybmFsRm9ybWF0LCBndCwgaiwgbHQuY29sb3JTcGFjZSwgUC5pc1hSUmVuZGVyVGFyZ2V0ID09PSAhMCksIEF0ID0geXQoUCk7CiAgICAgICAgICBhLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZShhLlJFTkRFUkJVRkZFUiwgQXQsIG10LCBQLndpZHRoLCBQLmhlaWdodCksIGEuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoYS5GUkFNRUJVRkZFUiwgYS5DT0xPUl9BVFRBQ0hNRU5UMCArIEksIGEuUkVOREVSQlVGRkVSLCBOLl9fd2ViZ2xDb2xvclJlbmRlcmJ1ZmZlcltJXSk7CiAgICAgICAgfQogICAgICAgIGEuYmluZFJlbmRlcmJ1ZmZlcihhLlJFTkRFUkJVRkZFUiwgbnVsbCksIFAuZGVwdGhCdWZmZXIgJiYgKE4uX193ZWJnbERlcHRoUmVuZGVyYnVmZmVyID0gYS5jcmVhdGVSZW5kZXJidWZmZXIoKSwgVXQoTi5fX3dlYmdsRGVwdGhSZW5kZXJidWZmZXIsIFAsICEwKSksIGUuYmluZEZyYW1lYnVmZmVyKGEuRlJBTUVCVUZGRVIsIG51bGwpOwogICAgICB9CiAgICB9CiAgICBpZiAoWikgewogICAgICBlLmJpbmRUZXh0dXJlKGEuVEVYVFVSRV9DVUJFX01BUCwgWC5fX3dlYmdsVGV4dHVyZSksIEx0KGEuVEVYVFVSRV9DVUJFX01BUCwgQSk7CiAgICAgIGZvciAobGV0IEkgPSAwOyBJIDwgNjsgSSsrKQogICAgICAgIGlmIChBLm1pcG1hcHMgJiYgQS5taXBtYXBzLmxlbmd0aCA+IDApCiAgICAgICAgICBmb3IgKGxldCBsdCA9IDA7IGx0IDwgQS5taXBtYXBzLmxlbmd0aDsgbHQrKykKICAgICAgICAgICAgRXQoTi5fX3dlYmdsRnJhbWVidWZmZXJbSV1bbHRdLCBQLCBBLCBhLkNPTE9SX0FUVEFDSE1FTlQwLCBhLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIEksIGx0KTsKICAgICAgICBlbHNlCiAgICAgICAgICBFdChOLl9fd2ViZ2xGcmFtZWJ1ZmZlcltJXSwgUCwgQSwgYS5DT0xPUl9BVFRBQ0hNRU5UMCwgYS5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBJLCAwKTsKICAgICAgZyhBKSAmJiBtKGEuVEVYVFVSRV9DVUJFX01BUCksIGUudW5iaW5kVGV4dHVyZSgpOwogICAgfSBlbHNlIGlmIChJdCkgewogICAgICBmb3IgKGxldCBJID0gMCwgbHQgPSBydC5sZW5ndGg7IEkgPCBsdDsgSSsrKSB7CiAgICAgICAgY29uc3QgZ3QgPSBydFtJXSwgaiA9IGkuZ2V0KGd0KTsKICAgICAgICBsZXQgbXQgPSBhLlRFWFRVUkVfMkQ7CiAgICAgICAgKFAuaXNXZWJHTDNEUmVuZGVyVGFyZ2V0IHx8IFAuaXNXZWJHTEFycmF5UmVuZGVyVGFyZ2V0KSAmJiAobXQgPSBQLmlzV2ViR0wzRFJlbmRlclRhcmdldCA/IGEuVEVYVFVSRV8zRCA6IGEuVEVYVFVSRV8yRF9BUlJBWSksIGUuYmluZFRleHR1cmUobXQsIGouX193ZWJnbFRleHR1cmUpLCBMdChtdCwgZ3QpLCBFdChOLl9fd2ViZ2xGcmFtZWJ1ZmZlciwgUCwgZ3QsIGEuQ09MT1JfQVRUQUNITUVOVDAgKyBJLCBtdCwgMCksIGcoZ3QpICYmIG0obXQpOwogICAgICB9CiAgICAgIGUudW5iaW5kVGV4dHVyZSgpOwogICAgfSBlbHNlIHsKICAgICAgbGV0IEkgPSBhLlRFWFRVUkVfMkQ7CiAgICAgIGlmICgoUC5pc1dlYkdMM0RSZW5kZXJUYXJnZXQgfHwgUC5pc1dlYkdMQXJyYXlSZW5kZXJUYXJnZXQpICYmIChJID0gUC5pc1dlYkdMM0RSZW5kZXJUYXJnZXQgPyBhLlRFWFRVUkVfM0QgOiBhLlRFWFRVUkVfMkRfQVJSQVkpLCBlLmJpbmRUZXh0dXJlKEksIFguX193ZWJnbFRleHR1cmUpLCBMdChJLCBBKSwgQS5taXBtYXBzICYmIEEubWlwbWFwcy5sZW5ndGggPiAwKQogICAgICAgIGZvciAobGV0IGx0ID0gMDsgbHQgPCBBLm1pcG1hcHMubGVuZ3RoOyBsdCsrKQogICAgICAgICAgRXQoTi5fX3dlYmdsRnJhbWVidWZmZXJbbHRdLCBQLCBBLCBhLkNPTE9SX0FUVEFDSE1FTlQwLCBJLCBsdCk7CiAgICAgIGVsc2UKICAgICAgICBFdChOLl9fd2ViZ2xGcmFtZWJ1ZmZlciwgUCwgQSwgYS5DT0xPUl9BVFRBQ0hNRU5UMCwgSSwgMCk7CiAgICAgIGcoQSkgJiYgbShJKSwgZS51bmJpbmRUZXh0dXJlKCk7CiAgICB9CiAgICBQLmRlcHRoQnVmZmVyICYmIEt0KFApOwogIH0KICBmdW5jdGlvbiBvdChQKSB7CiAgICBjb25zdCBBID0gUC50ZXh0dXJlczsKICAgIGZvciAobGV0IE4gPSAwLCBYID0gQS5sZW5ndGg7IE4gPCBYOyBOKyspIHsKICAgICAgY29uc3QgcnQgPSBBW05dOwogICAgICBpZiAoZyhydCkpIHsKICAgICAgICBjb25zdCBaID0gdihQKSwgSXQgPSBpLmdldChydCkuX193ZWJnbFRleHR1cmU7CiAgICAgICAgZS5iaW5kVGV4dHVyZShaLCBJdCksIG0oWiksIGUudW5iaW5kVGV4dHVyZSgpOwogICAgICB9CiAgICB9CiAgfQogIGNvbnN0IGl0ID0gW10sIFEgPSBbXTsKICBmdW5jdGlvbiBLKFApIHsKICAgIGlmIChQLnNhbXBsZXMgPiAwKSB7CiAgICAgIGlmICh1dChQKSA9PT0gITEpIHsKICAgICAgICBjb25zdCBBID0gUC50ZXh0dXJlcywgTiA9IFAud2lkdGgsIFggPSBQLmhlaWdodDsKICAgICAgICBsZXQgcnQgPSBhLkNPTE9SX0JVRkZFUl9CSVQ7CiAgICAgICAgY29uc3QgWiA9IFAuc3RlbmNpbEJ1ZmZlciA/IGEuREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5UIDogYS5ERVBUSF9BVFRBQ0hNRU5ULCBJdCA9IGkuZ2V0KFApLCBJID0gQS5sZW5ndGggPiAxOwogICAgICAgIGlmIChJKQogICAgICAgICAgZm9yIChsZXQgZ3QgPSAwOyBndCA8IEEubGVuZ3RoOyBndCsrKQogICAgICAgICAgICBlLmJpbmRGcmFtZWJ1ZmZlcihhLkZSQU1FQlVGRkVSLCBJdC5fX3dlYmdsTXVsdGlzYW1wbGVkRnJhbWVidWZmZXIpLCBhLmZyYW1lYnVmZmVyUmVuZGVyYnVmZmVyKGEuRlJBTUVCVUZGRVIsIGEuQ09MT1JfQVRUQUNITUVOVDAgKyBndCwgYS5SRU5ERVJCVUZGRVIsIG51bGwpLCBlLmJpbmRGcmFtZWJ1ZmZlcihhLkZSQU1FQlVGRkVSLCBJdC5fX3dlYmdsRnJhbWVidWZmZXIpLCBhLmZyYW1lYnVmZmVyVGV4dHVyZTJEKGEuRFJBV19GUkFNRUJVRkZFUiwgYS5DT0xPUl9BVFRBQ0hNRU5UMCArIGd0LCBhLlRFWFRVUkVfMkQsIG51bGwsIDApOwogICAgICAgIGUuYmluZEZyYW1lYnVmZmVyKGEuUkVBRF9GUkFNRUJVRkZFUiwgSXQuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyKTsKICAgICAgICBjb25zdCBsdCA9IFAudGV4dHVyZS5taXBtYXBzOwogICAgICAgIGx0ICYmIGx0Lmxlbmd0aCA+IDAgPyBlLmJpbmRGcmFtZWJ1ZmZlcihhLkRSQVdfRlJBTUVCVUZGRVIsIEl0Ll9fd2ViZ2xGcmFtZWJ1ZmZlclswXSkgOiBlLmJpbmRGcmFtZWJ1ZmZlcihhLkRSQVdfRlJBTUVCVUZGRVIsIEl0Ll9fd2ViZ2xGcmFtZWJ1ZmZlcik7CiAgICAgICAgZm9yIChsZXQgZ3QgPSAwOyBndCA8IEEubGVuZ3RoOyBndCsrKSB7CiAgICAgICAgICBpZiAoUC5yZXNvbHZlRGVwdGhCdWZmZXIgJiYgKFAuZGVwdGhCdWZmZXIgJiYgKHJ0IHw9IGEuREVQVEhfQlVGRkVSX0JJVCksIFAuc3RlbmNpbEJ1ZmZlciAmJiBQLnJlc29sdmVTdGVuY2lsQnVmZmVyICYmIChydCB8PSBhLlNURU5DSUxfQlVGRkVSX0JJVCkpLCBJKSB7CiAgICAgICAgICAgIGEuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoYS5SRUFEX0ZSQU1FQlVGRkVSLCBhLkNPTE9SX0FUVEFDSE1FTlQwLCBhLlJFTkRFUkJVRkZFUiwgSXQuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyW2d0XSk7CiAgICAgICAgICAgIGNvbnN0IGogPSBpLmdldChBW2d0XSkuX193ZWJnbFRleHR1cmU7CiAgICAgICAgICAgIGEuZnJhbWVidWZmZXJUZXh0dXJlMkQoYS5EUkFXX0ZSQU1FQlVGRkVSLCBhLkNPTE9SX0FUVEFDSE1FTlQwLCBhLlRFWFRVUkVfMkQsIGosIDApOwogICAgICAgICAgfQogICAgICAgICAgYS5ibGl0RnJhbWVidWZmZXIoMCwgMCwgTiwgWCwgMCwgMCwgTiwgWCwgcnQsIGEuTkVBUkVTVCksIGwgPT09ICEwICYmIChpdC5sZW5ndGggPSAwLCBRLmxlbmd0aCA9IDAsIGl0LnB1c2goYS5DT0xPUl9BVFRBQ0hNRU5UMCArIGd0KSwgUC5kZXB0aEJ1ZmZlciAmJiBQLnJlc29sdmVEZXB0aEJ1ZmZlciA9PT0gITEgJiYgKGl0LnB1c2goWiksIFEucHVzaChaKSwgYS5pbnZhbGlkYXRlRnJhbWVidWZmZXIoYS5EUkFXX0ZSQU1FQlVGRkVSLCBRKSksIGEuaW52YWxpZGF0ZUZyYW1lYnVmZmVyKGEuUkVBRF9GUkFNRUJVRkZFUiwgaXQpKTsKICAgICAgICB9CiAgICAgICAgaWYgKGUuYmluZEZyYW1lYnVmZmVyKGEuUkVBRF9GUkFNRUJVRkZFUiwgbnVsbCksIGUuYmluZEZyYW1lYnVmZmVyKGEuRFJBV19GUkFNRUJVRkZFUiwgbnVsbCksIEkpCiAgICAgICAgICBmb3IgKGxldCBndCA9IDA7IGd0IDwgQS5sZW5ndGg7IGd0KyspIHsKICAgICAgICAgICAgZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgSXQuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyKSwgYS5mcmFtZWJ1ZmZlclJlbmRlcmJ1ZmZlcihhLkZSQU1FQlVGRkVSLCBhLkNPTE9SX0FUVEFDSE1FTlQwICsgZ3QsIGEuUkVOREVSQlVGRkVSLCBJdC5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXJbZ3RdKTsKICAgICAgICAgICAgY29uc3QgaiA9IGkuZ2V0KEFbZ3RdKS5fX3dlYmdsVGV4dHVyZTsKICAgICAgICAgICAgZS5iaW5kRnJhbWVidWZmZXIoYS5GUkFNRUJVRkZFUiwgSXQuX193ZWJnbEZyYW1lYnVmZmVyKSwgYS5mcmFtZWJ1ZmZlclRleHR1cmUyRChhLkRSQVdfRlJBTUVCVUZGRVIsIGEuQ09MT1JfQVRUQUNITUVOVDAgKyBndCwgYS5URVhUVVJFXzJELCBqLCAwKTsKICAgICAgICAgIH0KICAgICAgICBlLmJpbmRGcmFtZWJ1ZmZlcihhLkRSQVdfRlJBTUVCVUZGRVIsIEl0Ll9fd2ViZ2xNdWx0aXNhbXBsZWRGcmFtZWJ1ZmZlcik7CiAgICAgIH0gZWxzZSBpZiAoUC5kZXB0aEJ1ZmZlciAmJiBQLnJlc29sdmVEZXB0aEJ1ZmZlciA9PT0gITEgJiYgbCkgewogICAgICAgIGNvbnN0IEEgPSBQLnN0ZW5jaWxCdWZmZXIgPyBhLkRFUFRIX1NURU5DSUxfQVRUQUNITUVOVCA6IGEuREVQVEhfQVRUQUNITUVOVDsKICAgICAgICBhLmludmFsaWRhdGVGcmFtZWJ1ZmZlcihhLkRSQVdfRlJBTUVCVUZGRVIsIFtBXSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24geXQoUCkgewogICAgcmV0dXJuIE1hdGgubWluKG4ubWF4U2FtcGxlcywgUC5zYW1wbGVzKTsKICB9CiAgZnVuY3Rpb24gdXQoUCkgewogICAgY29uc3QgQSA9IGkuZ2V0KFApOwogICAgcmV0dXJuIFAuc2FtcGxlcyA+IDAgJiYgdC5oYXMoIldFQkdMX211bHRpc2FtcGxlZF9yZW5kZXJfdG9fdGV4dHVyZSIpID09PSAhMCAmJiBBLl9fdXNlUmVuZGVyVG9UZXh0dXJlICE9PSAhMTsKICB9CiAgZnVuY3Rpb24geHQoUCkgewogICAgY29uc3QgQSA9IHIucmVuZGVyLmZyYW1lOwogICAgYy5nZXQoUCkgIT09IEEgJiYgKGMuc2V0KFAsIEEpLCBQLnVwZGF0ZSgpKTsKICB9CiAgZnVuY3Rpb24gV3QoUCwgQSkgewogICAgY29uc3QgTiA9IFAuY29sb3JTcGFjZSwgWCA9IFAuZm9ybWF0LCBydCA9IFAudHlwZTsKICAgIHJldHVybiBQLmlzQ29tcHJlc3NlZFRleHR1cmUgPT09ICEwIHx8IFAuaXNWaWRlb1RleHR1cmUgPT09ICEwIHx8IE4gIT09IENzICYmIE4gIT09ICRuICYmIChlZS5nZXRUcmFuc2ZlcihOKSA9PT0gY2UgPyAoWCAhPT0gZ2kgfHwgcnQgIT09IHBuKSAmJiBjb25zb2xlLndhcm4oIlRIUkVFLldlYkdMVGV4dHVyZXM6IHNSR0IgZW5jb2RlZCB0ZXh0dXJlcyBoYXZlIHRvIHVzZSBSR0JBRm9ybWF0IGFuZCBVbnNpZ25lZEJ5dGVUeXBlLiIpIDogY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xUZXh0dXJlczogVW5zdXBwb3J0ZWQgdGV4dHVyZSBjb2xvciBzcGFjZToiLCBOKSksIEE7CiAgfQogIGZ1bmN0aW9uIE50KFApIHsKICAgIHJldHVybiB0eXBlb2YgSFRNTEltYWdlRWxlbWVudCA8ICJ1IiAmJiBQIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCA/IChoLndpZHRoID0gUC5uYXR1cmFsV2lkdGggfHwgUC53aWR0aCwgaC5oZWlnaHQgPSBQLm5hdHVyYWxIZWlnaHQgfHwgUC5oZWlnaHQpIDogdHlwZW9mIFZpZGVvRnJhbWUgPCAidSIgJiYgUCBpbnN0YW5jZW9mIFZpZGVvRnJhbWUgPyAoaC53aWR0aCA9IFAuZGlzcGxheVdpZHRoLCBoLmhlaWdodCA9IFAuZGlzcGxheUhlaWdodCkgOiAoaC53aWR0aCA9IFAud2lkdGgsIGguaGVpZ2h0ID0gUC5oZWlnaHQpLCBoOwogIH0KICB0aGlzLmFsbG9jYXRlVGV4dHVyZVVuaXQgPSBPLCB0aGlzLnJlc2V0VGV4dHVyZVVuaXRzID0gVSwgdGhpcy5zZXRUZXh0dXJlMkQgPSBXLCB0aGlzLnNldFRleHR1cmUyREFycmF5ID0gRywgdGhpcy5zZXRUZXh0dXJlM0QgPSBldCwgdGhpcy5zZXRUZXh0dXJlQ3ViZSA9IEgsIHRoaXMucmViaW5kVGV4dHVyZXMgPSBoZSwgdGhpcy5zZXR1cFJlbmRlclRhcmdldCA9IEQsIHRoaXMudXBkYXRlUmVuZGVyVGFyZ2V0TWlwbWFwID0gb3QsIHRoaXMudXBkYXRlTXVsdGlzYW1wbGVSZW5kZXJUYXJnZXQgPSBLLCB0aGlzLnNldHVwRGVwdGhSZW5kZXJidWZmZXIgPSBLdCwgdGhpcy5zZXR1cEZyYW1lQnVmZmVyVGV4dHVyZSA9IEV0LCB0aGlzLnVzZU11bHRpc2FtcGxlZFJUVCA9IHV0Owp9CmZ1bmN0aW9uIFRfKGEsIHQpIHsKICBmdW5jdGlvbiBlKGksIG4gPSAkbikgewogICAgbGV0IHM7CiAgICBjb25zdCByID0gZWUuZ2V0VHJhbnNmZXIobik7CiAgICBpZiAoaSA9PT0gcG4pIHJldHVybiBhLlVOU0lHTkVEX0JZVEU7CiAgICBpZiAoaSA9PT0gUGMpIHJldHVybiBhLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQ7CiAgICBpZiAoaSA9PT0gSWMpIHJldHVybiBhLlVOU0lHTkVEX1NIT1JUXzVfNV81XzE7CiAgICBpZiAoaSA9PT0gRXApIHJldHVybiBhLlVOU0lHTkVEX0lOVF81XzlfOV85X1JFVjsKICAgIGlmIChpID09PSBUcCkgcmV0dXJuIGEuVU5TSUdORURfSU5UXzEwRl8xMUZfMTFGX1JFVjsKICAgIGlmIChpID09PSB3cCkgcmV0dXJuIGEuQllURTsKICAgIGlmIChpID09PSBBcCkgcmV0dXJuIGEuU0hPUlQ7CiAgICBpZiAoaSA9PT0gZGEpIHJldHVybiBhLlVOU0lHTkVEX1NIT1JUOwogICAgaWYgKGkgPT09IFJjKSByZXR1cm4gYS5JTlQ7CiAgICBpZiAoaSA9PT0gbnMpIHJldHVybiBhLlVOU0lHTkVEX0lOVDsKICAgIGlmIChpID09PSB3aSkgcmV0dXJuIGEuRkxPQVQ7CiAgICBpZiAoaSA9PT0gd2EpIHJldHVybiBhLkhBTEZfRkxPQVQ7CiAgICBpZiAoaSA9PT0gQ3ApIHJldHVybiBhLkFMUEhBOwogICAgaWYgKGkgPT09IFJwKSByZXR1cm4gYS5SR0I7CiAgICBpZiAoaSA9PT0gZ2kpIHJldHVybiBhLlJHQkE7CiAgICBpZiAoaSA9PT0gZmEpIHJldHVybiBhLkRFUFRIX0NPTVBPTkVOVDsKICAgIGlmIChpID09PSBtYSkgcmV0dXJuIGEuREVQVEhfU1RFTkNJTDsKICAgIGlmIChpID09PSBMYykgcmV0dXJuIGEuUkVEOwogICAgaWYgKGkgPT09IE5vKSByZXR1cm4gYS5SRURfSU5URUdFUjsKICAgIGlmIChpID09PSBQcCkgcmV0dXJuIGEuUkc7CiAgICBpZiAoaSA9PT0gRGMpIHJldHVybiBhLlJHX0lOVEVHRVI7CiAgICBpZiAoaSA9PT0gRmMpIHJldHVybiBhLlJHQkFfSU5URUdFUjsKICAgIGlmIChpID09PSBobyB8fCBpID09PSBjbyB8fCBpID09PSB1byB8fCBpID09PSBwbykKICAgICAgaWYgKHIgPT09IGNlKQogICAgICAgIGlmIChzID0gdC5nZXQoIldFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9zM3RjX3NyZ2IiKSwgcyAhPT0gbnVsbCkgewogICAgICAgICAgaWYgKGkgPT09IGhvKSByZXR1cm4gcy5DT01QUkVTU0VEX1NSR0JfUzNUQ19EWFQxX0VYVDsKICAgICAgICAgIGlmIChpID09PSBjbykgcmV0dXJuIHMuQ09NUFJFU1NFRF9TUkdCX0FMUEhBX1MzVENfRFhUMV9FWFQ7CiAgICAgICAgICBpZiAoaSA9PT0gdW8pIHJldHVybiBzLkNPTVBSRVNTRURfU1JHQl9BTFBIQV9TM1RDX0RYVDNfRVhUOwogICAgICAgICAgaWYgKGkgPT09IHBvKSByZXR1cm4gcy5DT01QUkVTU0VEX1NSR0JfQUxQSEFfUzNUQ19EWFQ1X0VYVDsKICAgICAgICB9IGVsc2UKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICBlbHNlIGlmIChzID0gdC5nZXQoIldFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9zM3RjIiksIHMgIT09IG51bGwpIHsKICAgICAgICBpZiAoaSA9PT0gaG8pIHJldHVybiBzLkNPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ7CiAgICAgICAgaWYgKGkgPT09IGNvKSByZXR1cm4gcy5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQxX0VYVDsKICAgICAgICBpZiAoaSA9PT0gdW8pIHJldHVybiBzLkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDNfRVhUOwogICAgICAgIGlmIChpID09PSBwbykgcmV0dXJuIHMuQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQ7CiAgICAgIH0gZWxzZQogICAgICAgIHJldHVybiBudWxsOwogICAgaWYgKGkgPT09IGtoIHx8IGkgPT09IFZoIHx8IGkgPT09IEhoIHx8IGkgPT09IEdoKQogICAgICBpZiAocyA9IHQuZ2V0KCJXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfcHZydGMiKSwgcyAhPT0gbnVsbCkgewogICAgICAgIGlmIChpID09PSBraCkgcmV0dXJuIHMuQ09NUFJFU1NFRF9SR0JfUFZSVENfNEJQUFYxX0lNRzsKICAgICAgICBpZiAoaSA9PT0gVmgpIHJldHVybiBzLkNPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUc7CiAgICAgICAgaWYgKGkgPT09IEhoKSByZXR1cm4gcy5DT01QUkVTU0VEX1JHQkFfUFZSVENfNEJQUFYxX0lNRzsKICAgICAgICBpZiAoaSA9PT0gR2gpIHJldHVybiBzLkNPTVBSRVNTRURfUkdCQV9QVlJUQ18yQlBQVjFfSU1HOwogICAgICB9IGVsc2UKICAgICAgICByZXR1cm4gbnVsbDsKICAgIGlmIChpID09PSBXaCB8fCBpID09PSBxaCB8fCBpID09PSAkaCkKICAgICAgaWYgKHMgPSB0LmdldCgiV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX2V0YyIpLCBzICE9PSBudWxsKSB7CiAgICAgICAgaWYgKGkgPT09IFdoIHx8IGkgPT09IHFoKSByZXR1cm4gciA9PT0gY2UgPyBzLkNPTVBSRVNTRURfU1JHQjhfRVRDMiA6IHMuQ09NUFJFU1NFRF9SR0I4X0VUQzI7CiAgICAgICAgaWYgKGkgPT09ICRoKSByZXR1cm4gciA9PT0gY2UgPyBzLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0VUQzJfRUFDIDogcy5DT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDOwogICAgICB9IGVsc2UKICAgICAgICByZXR1cm4gbnVsbDsKICAgIGlmIChpID09PSBYaCB8fCBpID09PSBZaCB8fCBpID09PSBaaCB8fCBpID09PSBqaCB8fCBpID09PSBKaCB8fCBpID09PSBLaCB8fCBpID09PSBRaCB8fCBpID09PSB0YyB8fCBpID09PSBlYyB8fCBpID09PSBpYyB8fCBpID09PSBuYyB8fCBpID09PSBzYyB8fCBpID09PSByYyB8fCBpID09PSBhYykKICAgICAgaWYgKHMgPSB0LmdldCgiV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX2FzdGMiKSwgcyAhPT0gbnVsbCkgewogICAgICAgIGlmIChpID09PSBYaCkgcmV0dXJuIHIgPT09IGNlID8gcy5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzR4NF9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzR4NF9LSFI7CiAgICAgICAgaWYgKGkgPT09IFloKSByZXR1cm4gciA9PT0gY2UgPyBzLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfNXg0X0tIUiA6IHMuQ09NUFJFU1NFRF9SR0JBX0FTVENfNXg0X0tIUjsKICAgICAgICBpZiAoaSA9PT0gWmgpIHJldHVybiByID09PSBjZSA/IHMuQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ181eDVfS0hSIDogcy5DT01QUkVTU0VEX1JHQkFfQVNUQ181eDVfS0hSOwogICAgICAgIGlmIChpID09PSBqaCkgcmV0dXJuIHIgPT09IGNlID8gcy5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzZ4NV9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzZ4NV9LSFI7CiAgICAgICAgaWYgKGkgPT09IEpoKSByZXR1cm4gciA9PT0gY2UgPyBzLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfNng2X0tIUiA6IHMuQ09NUFJFU1NFRF9SR0JBX0FTVENfNng2X0tIUjsKICAgICAgICBpZiAoaSA9PT0gS2gpIHJldHVybiByID09PSBjZSA/IHMuQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ184eDVfS0hSIDogcy5DT01QUkVTU0VEX1JHQkFfQVNUQ184eDVfS0hSOwogICAgICAgIGlmIChpID09PSBRaCkgcmV0dXJuIHIgPT09IGNlID8gcy5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzh4Nl9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzh4Nl9LSFI7CiAgICAgICAgaWYgKGkgPT09IHRjKSByZXR1cm4gciA9PT0gY2UgPyBzLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfOHg4X0tIUiA6IHMuQ09NUFJFU1NFRF9SR0JBX0FTVENfOHg4X0tIUjsKICAgICAgICBpZiAoaSA9PT0gZWMpIHJldHVybiByID09PSBjZSA/IHMuQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ18xMHg1X0tIUiA6IHMuQ09NUFJFU1NFRF9SR0JBX0FTVENfMTB4NV9LSFI7CiAgICAgICAgaWYgKGkgPT09IGljKSByZXR1cm4gciA9PT0gY2UgPyBzLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfMTB4Nl9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzEweDZfS0hSOwogICAgICAgIGlmIChpID09PSBuYykgcmV0dXJuIHIgPT09IGNlID8gcy5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzEweDhfS0hSIDogcy5DT01QUkVTU0VEX1JHQkFfQVNUQ18xMHg4X0tIUjsKICAgICAgICBpZiAoaSA9PT0gc2MpIHJldHVybiByID09PSBjZSA/IHMuQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ18xMHgxMF9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzEweDEwX0tIUjsKICAgICAgICBpZiAoaSA9PT0gcmMpIHJldHVybiByID09PSBjZSA/IHMuQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ18xMngxMF9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzEyeDEwX0tIUjsKICAgICAgICBpZiAoaSA9PT0gYWMpIHJldHVybiByID09PSBjZSA/IHMuQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ18xMngxMl9LSFIgOiBzLkNPTVBSRVNTRURfUkdCQV9BU1RDXzEyeDEyX0tIUjsKICAgICAgfSBlbHNlCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICBpZiAoaSA9PT0gb2MgfHwgaSA9PT0gbGMgfHwgaSA9PT0gaGMpCiAgICAgIGlmIChzID0gdC5nZXQoIkVYVF90ZXh0dXJlX2NvbXByZXNzaW9uX2JwdGMiKSwgcyAhPT0gbnVsbCkgewogICAgICAgIGlmIChpID09PSBvYykgcmV0dXJuIHIgPT09IGNlID8gcy5DT01QUkVTU0VEX1NSR0JfQUxQSEFfQlBUQ19VTk9STV9FWFQgOiBzLkNPTVBSRVNTRURfUkdCQV9CUFRDX1VOT1JNX0VYVDsKICAgICAgICBpZiAoaSA9PT0gbGMpIHJldHVybiBzLkNPTVBSRVNTRURfUkdCX0JQVENfU0lHTkVEX0ZMT0FUX0VYVDsKICAgICAgICBpZiAoaSA9PT0gaGMpIHJldHVybiBzLkNPTVBSRVNTRURfUkdCX0JQVENfVU5TSUdORURfRkxPQVRfRVhUOwogICAgICB9IGVsc2UKICAgICAgICByZXR1cm4gbnVsbDsKICAgIGlmIChpID09PSBjYyB8fCBpID09PSB1YyB8fCBpID09PSBkYyB8fCBpID09PSBwYykKICAgICAgaWYgKHMgPSB0LmdldCgiRVhUX3RleHR1cmVfY29tcHJlc3Npb25fcmd0YyIpLCBzICE9PSBudWxsKSB7CiAgICAgICAgaWYgKGkgPT09IGNjKSByZXR1cm4gcy5DT01QUkVTU0VEX1JFRF9SR1RDMV9FWFQ7CiAgICAgICAgaWYgKGkgPT09IHVjKSByZXR1cm4gcy5DT01QUkVTU0VEX1NJR05FRF9SRURfUkdUQzFfRVhUOwogICAgICAgIGlmIChpID09PSBkYykgcmV0dXJuIHMuQ09NUFJFU1NFRF9SRURfR1JFRU5fUkdUQzJfRVhUOwogICAgICAgIGlmIChpID09PSBwYykgcmV0dXJuIHMuQ09NUFJFU1NFRF9TSUdORURfUkVEX0dSRUVOX1JHVEMyX0VYVDsKICAgICAgfSBlbHNlCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gaSA9PT0gcGEgPyBhLlVOU0lHTkVEX0lOVF8yNF84IDogYVtpXSAhPT0gdm9pZCAwID8gYVtpXSA6IG51bGw7CiAgfQogIHJldHVybiB7IGNvbnZlcnQ6IGUgfTsKfQpjb25zdCB5RSA9IGAKdm9pZCBtYWluKCkgewoKCWdsX1Bvc2l0aW9uID0gdmVjNCggcG9zaXRpb24sIDEuMCApOwoKfWAsIF9FID0gYAp1bmlmb3JtIHNhbXBsZXIyREFycmF5IGRlcHRoQ29sb3I7CnVuaWZvcm0gZmxvYXQgZGVwdGhXaWR0aDsKdW5pZm9ybSBmbG9hdCBkZXB0aEhlaWdodDsKCnZvaWQgbWFpbigpIHsKCgl2ZWMyIGNvb3JkID0gdmVjMiggZ2xfRnJhZ0Nvb3JkLnggLyBkZXB0aFdpZHRoLCBnbF9GcmFnQ29vcmQueSAvIGRlcHRoSGVpZ2h0ICk7CgoJaWYgKCBjb29yZC54ID49IDEuMCApIHsKCgkJZ2xfRnJhZ0RlcHRoID0gdGV4dHVyZSggZGVwdGhDb2xvciwgdmVjMyggY29vcmQueCAtIDEuMCwgY29vcmQueSwgMSApICkucjsKCgl9IGVsc2UgewoKCQlnbF9GcmFnRGVwdGggPSB0ZXh0dXJlKCBkZXB0aENvbG9yLCB2ZWMzKCBjb29yZC54LCBjb29yZC55LCAwICkgKS5yOwoKCX0KCn1gOwpjbGFzcyB4RSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBkZXB0aCBzZW5zaW5nIG1vZHVsZS4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMudGV4dHVyZSA9IG51bGwsIHRoaXMubWVzaCA9IG51bGwsIHRoaXMuZGVwdGhOZWFyID0gMCwgdGhpcy5kZXB0aEZhciA9IDA7CiAgfQogIC8qKgogICAqIEluaXRzIHRoZSBkZXB0aCBzZW5zaW5nIG1vZHVsZQogICAqCiAgICogQHBhcmFtIHtYUldlYkdMRGVwdGhJbmZvcm1hdGlvbn0gZGVwdGhEYXRhIC0gVGhlIFhSIGRlcHRoIGRhdGEuCiAgICogQHBhcmFtIHtYUlJlbmRlclN0YXRlfSByZW5kZXJTdGF0ZSAtIFRoZSBYUiByZW5kZXIgc3RhdGUuCiAgICovCiAgaW5pdCh0LCBlKSB7CiAgICBpZiAodGhpcy50ZXh0dXJlID09PSBudWxsKSB7CiAgICAgIGNvbnN0IGkgPSBuZXcgSHAodC50ZXh0dXJlKTsKICAgICAgKHQuZGVwdGhOZWFyICE9PSBlLmRlcHRoTmVhciB8fCB0LmRlcHRoRmFyICE9PSBlLmRlcHRoRmFyKSAmJiAodGhpcy5kZXB0aE5lYXIgPSB0LmRlcHRoTmVhciwgdGhpcy5kZXB0aEZhciA9IHQuZGVwdGhGYXIpLCB0aGlzLnRleHR1cmUgPSBpOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgcGxhbmUgbWVzaCB0aGF0IHZpc3VhbGl6ZXMgdGhlIGRlcHRoIHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5Q2FtZXJhfSBjYW1lcmFYUiAtIFRoZSBYUiBjYW1lcmEuCiAgICogQHJldHVybiB7P01lc2h9IFRoZSBwbGFuZSBtZXNoLgogICAqLwogIGdldE1lc2godCkgewogICAgaWYgKHRoaXMudGV4dHVyZSAhPT0gbnVsbCAmJiB0aGlzLm1lc2ggPT09IG51bGwpIHsKICAgICAgY29uc3QgZSA9IHQuY2FtZXJhc1swXS52aWV3cG9ydCwgaSA9IG5ldyBYaSh7CiAgICAgICAgdmVydGV4U2hhZGVyOiB5RSwKICAgICAgICBmcmFnbWVudFNoYWRlcjogX0UsCiAgICAgICAgdW5pZm9ybXM6IHsKICAgICAgICAgIGRlcHRoQ29sb3I6IHsgdmFsdWU6IHRoaXMudGV4dHVyZSB9LAogICAgICAgICAgZGVwdGhXaWR0aDogeyB2YWx1ZTogZS56IH0sCiAgICAgICAgICBkZXB0aEhlaWdodDogeyB2YWx1ZTogZS53IH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLm1lc2ggPSBuZXcgcmUobmV3IERzKDIwLCAyMCksIGkpOwogICAgfQogICAgcmV0dXJuIHRoaXMubWVzaDsKICB9CiAgLyoqCiAgICogUmVzZXRzIHRoZSBtb2R1bGUKICAgKi8KICByZXNldCgpIHsKICAgIHRoaXMudGV4dHVyZSA9IG51bGwsIHRoaXMubWVzaCA9IG51bGw7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSB0ZXh0dXJlIHJlcHJlc2VudGluZyB0aGUgZGVwdGggb2YgdGhlIHVzZXIncyBlbnZpcm9ubWVudC4KICAgKgogICAqIEByZXR1cm4gez9FeHRlcm5hbFRleHR1cmV9IFRoZSBkZXB0aCB0ZXh0dXJlLgogICAqLwogIGdldERlcHRoVGV4dHVyZSgpIHsKICAgIHJldHVybiB0aGlzLnRleHR1cmU7CiAgfQp9CmNsYXNzIHZFIGV4dGVuZHMgRWkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgV2ViR0wgcmVuZGVyZXIuCiAgICoKICAgKiBAcGFyYW0ge1dlYkdMUmVuZGVyZXJ9IHJlbmRlcmVyIC0gVGhlIHJlbmRlcmVyLgogICAqIEBwYXJhbSB7V2ViR0wyUmVuZGVyaW5nQ29udGV4dH0gZ2wgLSBUaGUgcmVuZGVyaW5nIGNvbnRleHQuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSkgewogICAgc3VwZXIoKTsKICAgIGNvbnN0IGkgPSB0aGlzOwogICAgbGV0IG4gPSBudWxsLCBzID0gMSwgciA9IG51bGwsIG8gPSAibG9jYWwtZmxvb3IiLCBsID0gMSwgaCA9IG51bGwsIGMgPSBudWxsLCB1ID0gbnVsbCwgZCA9IG51bGwsIHAgPSBudWxsLCBmID0gbnVsbDsKICAgIGNvbnN0IHkgPSB0eXBlb2YgWFJXZWJHTEJpbmRpbmcgPCAidSIsIGcgPSBuZXcgeEUoKSwgbSA9IHt9LCB2ID0gZS5nZXRDb250ZXh0QXR0cmlidXRlcygpOwogICAgbGV0IHggPSBudWxsLCBfID0gbnVsbDsKICAgIGNvbnN0IFMgPSBbXSwgdyA9IFtdLCBUID0gbmV3IEooKTsKICAgIGxldCBSID0gbnVsbDsKICAgIGNvbnN0IGIgPSBuZXcgVmUoKTsKICAgIGIudmlld3BvcnQgPSBuZXcgUXQoKTsKICAgIGNvbnN0IE0gPSBuZXcgVmUoKTsKICAgIE0udmlld3BvcnQgPSBuZXcgUXQoKTsKICAgIGNvbnN0IEwgPSBbYiwgTV0sIFUgPSBuZXcgcF8oKTsKICAgIGxldCBPID0gbnVsbCwgViA9IG51bGw7CiAgICB0aGlzLmNhbWVyYUF1dG9VcGRhdGUgPSAhMCwgdGhpcy5lbmFibGVkID0gITEsIHRoaXMuaXNQcmVzZW50aW5nID0gITEsIHRoaXMuZ2V0Q29udHJvbGxlciA9IGZ1bmN0aW9uKFkpIHsKICAgICAgbGV0IHN0ID0gU1tZXTsKICAgICAgcmV0dXJuIHN0ID09PSB2b2lkIDAgJiYgKHN0ID0gbmV3IFRoKCksIFNbWV0gPSBzdCksIHN0LmdldFRhcmdldFJheVNwYWNlKCk7CiAgICB9LCB0aGlzLmdldENvbnRyb2xsZXJHcmlwID0gZnVuY3Rpb24oWSkgewogICAgICBsZXQgc3QgPSBTW1ldOwogICAgICByZXR1cm4gc3QgPT09IHZvaWQgMCAmJiAoc3QgPSBuZXcgVGgoKSwgU1tZXSA9IHN0KSwgc3QuZ2V0R3JpcFNwYWNlKCk7CiAgICB9LCB0aGlzLmdldEhhbmQgPSBmdW5jdGlvbihZKSB7CiAgICAgIGxldCBzdCA9IFNbWV07CiAgICAgIHJldHVybiBzdCA9PT0gdm9pZCAwICYmIChzdCA9IG5ldyBUaCgpLCBTW1ldID0gc3QpLCBzdC5nZXRIYW5kU3BhY2UoKTsKICAgIH07CiAgICBmdW5jdGlvbiBXKFkpIHsKICAgICAgY29uc3Qgc3QgPSB3LmluZGV4T2YoWS5pbnB1dFNvdXJjZSk7CiAgICAgIGlmIChzdCA9PT0gLTEpCiAgICAgICAgcmV0dXJuOwogICAgICBjb25zdCBFdCA9IFNbc3RdOwogICAgICBFdCAhPT0gdm9pZCAwICYmIChFdC51cGRhdGUoWS5pbnB1dFNvdXJjZSwgWS5mcmFtZSwgaCB8fCByKSwgRXQuZGlzcGF0Y2hFdmVudCh7IHR5cGU6IFkudHlwZSwgZGF0YTogWS5pbnB1dFNvdXJjZSB9KSk7CiAgICB9CiAgICBmdW5jdGlvbiBHKCkgewogICAgICBuLnJlbW92ZUV2ZW50TGlzdGVuZXIoInNlbGVjdCIsIFcpLCBuLnJlbW92ZUV2ZW50TGlzdGVuZXIoInNlbGVjdHN0YXJ0IiwgVyksIG4ucmVtb3ZlRXZlbnRMaXN0ZW5lcigic2VsZWN0ZW5kIiwgVyksIG4ucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3F1ZWV6ZSIsIFcpLCBuLnJlbW92ZUV2ZW50TGlzdGVuZXIoInNxdWVlemVzdGFydCIsIFcpLCBuLnJlbW92ZUV2ZW50TGlzdGVuZXIoInNxdWVlemVlbmQiLCBXKSwgbi5yZW1vdmVFdmVudExpc3RlbmVyKCJlbmQiLCBHKSwgbi5yZW1vdmVFdmVudExpc3RlbmVyKCJpbnB1dHNvdXJjZXNjaGFuZ2UiLCBldCk7CiAgICAgIGZvciAobGV0IFkgPSAwOyBZIDwgUy5sZW5ndGg7IFkrKykgewogICAgICAgIGNvbnN0IHN0ID0gd1tZXTsKICAgICAgICBzdCAhPT0gbnVsbCAmJiAod1tZXSA9IG51bGwsIFNbWV0uZGlzY29ubmVjdChzdCkpOwogICAgICB9CiAgICAgIE8gPSBudWxsLCBWID0gbnVsbCwgZy5yZXNldCgpOwogICAgICBmb3IgKGNvbnN0IFkgaW4gbSkKICAgICAgICBkZWxldGUgbVtZXTsKICAgICAgdC5zZXRSZW5kZXJUYXJnZXQoeCksIHAgPSBudWxsLCBkID0gbnVsbCwgdSA9IG51bGwsIG4gPSBudWxsLCBfID0gbnVsbCwgSnQuc3RvcCgpLCBpLmlzUHJlc2VudGluZyA9ICExLCB0LnNldFBpeGVsUmF0aW8oUiksIHQuc2V0U2l6ZShULndpZHRoLCBULmhlaWdodCwgITEpLCBpLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAic2Vzc2lvbmVuZCIgfSk7CiAgICB9CiAgICB0aGlzLnNldEZyYW1lYnVmZmVyU2NhbGVGYWN0b3IgPSBmdW5jdGlvbihZKSB7CiAgICAgIHMgPSBZLCBpLmlzUHJlc2VudGluZyA9PT0gITAgJiYgY29uc29sZS53YXJuKCJUSFJFRS5XZWJYUk1hbmFnZXI6IENhbm5vdCBjaGFuZ2UgZnJhbWVidWZmZXIgc2NhbGUgd2hpbGUgcHJlc2VudGluZy4iKTsKICAgIH0sIHRoaXMuc2V0UmVmZXJlbmNlU3BhY2VUeXBlID0gZnVuY3Rpb24oWSkgewogICAgICBvID0gWSwgaS5pc1ByZXNlbnRpbmcgPT09ICEwICYmIGNvbnNvbGUud2FybigiVEhSRUUuV2ViWFJNYW5hZ2VyOiBDYW5ub3QgY2hhbmdlIHJlZmVyZW5jZSBzcGFjZSB0eXBlIHdoaWxlIHByZXNlbnRpbmcuIik7CiAgICB9LCB0aGlzLmdldFJlZmVyZW5jZVNwYWNlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBoIHx8IHI7CiAgICB9LCB0aGlzLnNldFJlZmVyZW5jZVNwYWNlID0gZnVuY3Rpb24oWSkgewogICAgICBoID0gWTsKICAgIH0sIHRoaXMuZ2V0QmFzZUxheWVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBkICE9PSBudWxsID8gZCA6IHA7CiAgICB9LCB0aGlzLmdldEJpbmRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHUgPT09IG51bGwgJiYgeSAmJiAodSA9IG5ldyBYUldlYkdMQmluZGluZyhuLCBlKSksIHU7CiAgICB9LCB0aGlzLmdldEZyYW1lID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmOwogICAgfSwgdGhpcy5nZXRTZXNzaW9uID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuOwogICAgfSwgdGhpcy5zZXRTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24oWSkgewogICAgICBpZiAobiA9IFksIG4gIT09IG51bGwpIHsKICAgICAgICBpZiAoeCA9IHQuZ2V0UmVuZGVyVGFyZ2V0KCksIG4uYWRkRXZlbnRMaXN0ZW5lcigic2VsZWN0IiwgVyksIG4uYWRkRXZlbnRMaXN0ZW5lcigic2VsZWN0c3RhcnQiLCBXKSwgbi5hZGRFdmVudExpc3RlbmVyKCJzZWxlY3RlbmQiLCBXKSwgbi5hZGRFdmVudExpc3RlbmVyKCJzcXVlZXplIiwgVyksIG4uYWRkRXZlbnRMaXN0ZW5lcigic3F1ZWV6ZXN0YXJ0IiwgVyksIG4uYWRkRXZlbnRMaXN0ZW5lcigic3F1ZWV6ZWVuZCIsIFcpLCBuLmFkZEV2ZW50TGlzdGVuZXIoImVuZCIsIEcpLCBuLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0c291cmNlc2NoYW5nZSIsIGV0KSwgdi54ckNvbXBhdGlibGUgIT09ICEwICYmIGF3YWl0IGUubWFrZVhSQ29tcGF0aWJsZSgpLCBSID0gdC5nZXRQaXhlbFJhdGlvKCksIHQuZ2V0U2l6ZShUKSwgeSAmJiAiY3JlYXRlUHJvamVjdGlvbkxheWVyIiBpbiBYUldlYkdMQmluZGluZy5wcm90b3R5cGUpIHsKICAgICAgICAgIGxldCBFdCA9IG51bGwsIFV0ID0gbnVsbCwgUHQgPSBudWxsOwogICAgICAgICAgdi5kZXB0aCAmJiAoUHQgPSB2LnN0ZW5jaWwgPyBlLkRFUFRIMjRfU1RFTkNJTDggOiBlLkRFUFRIX0NPTVBPTkVOVDI0LCBFdCA9IHYuc3RlbmNpbCA/IG1hIDogZmEsIFV0ID0gdi5zdGVuY2lsID8gcGEgOiBucyk7CiAgICAgICAgICBjb25zdCBLdCA9IHsKICAgICAgICAgICAgY29sb3JGb3JtYXQ6IGUuUkdCQTgsCiAgICAgICAgICAgIGRlcHRoRm9ybWF0OiBQdCwKICAgICAgICAgICAgc2NhbGVGYWN0b3I6IHMKICAgICAgICAgIH07CiAgICAgICAgICB1ID0gdGhpcy5nZXRCaW5kaW5nKCksIGQgPSB1LmNyZWF0ZVByb2plY3Rpb25MYXllcihLdCksIG4udXBkYXRlUmVuZGVyU3RhdGUoeyBsYXllcnM6IFtkXSB9KSwgdC5zZXRQaXhlbFJhdGlvKDEpLCB0LnNldFNpemUoZC50ZXh0dXJlV2lkdGgsIGQudGV4dHVyZUhlaWdodCwgITEpLCBfID0gbmV3IFJuKAogICAgICAgICAgICBkLnRleHR1cmVXaWR0aCwKICAgICAgICAgICAgZC50ZXh0dXJlSGVpZ2h0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9ybWF0OiBnaSwKICAgICAgICAgICAgICB0eXBlOiBwbiwKICAgICAgICAgICAgICBkZXB0aFRleHR1cmU6IG5ldyBWcChkLnRleHR1cmVXaWR0aCwgZC50ZXh0dXJlSGVpZ2h0LCBVdCwgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCwgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCwgRXQpLAogICAgICAgICAgICAgIHN0ZW5jaWxCdWZmZXI6IHYuc3RlbmNpbCwKICAgICAgICAgICAgICBjb2xvclNwYWNlOiB0Lm91dHB1dENvbG9yU3BhY2UsCiAgICAgICAgICAgICAgc2FtcGxlczogdi5hbnRpYWxpYXMgPyA0IDogMCwKICAgICAgICAgICAgICByZXNvbHZlRGVwdGhCdWZmZXI6IGQuaWdub3JlRGVwdGhWYWx1ZXMgPT09ICExLAogICAgICAgICAgICAgIHJlc29sdmVTdGVuY2lsQnVmZmVyOiBkLmlnbm9yZURlcHRoVmFsdWVzID09PSAhMQogICAgICAgICAgICB9CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBFdCA9IHsKICAgICAgICAgICAgYW50aWFsaWFzOiB2LmFudGlhbGlhcywKICAgICAgICAgICAgYWxwaGE6ICEwLAogICAgICAgICAgICBkZXB0aDogdi5kZXB0aCwKICAgICAgICAgICAgc3RlbmNpbDogdi5zdGVuY2lsLAogICAgICAgICAgICBmcmFtZWJ1ZmZlclNjYWxlRmFjdG9yOiBzCiAgICAgICAgICB9OwogICAgICAgICAgcCA9IG5ldyBYUldlYkdMTGF5ZXIobiwgZSwgRXQpLCBuLnVwZGF0ZVJlbmRlclN0YXRlKHsgYmFzZUxheWVyOiBwIH0pLCB0LnNldFBpeGVsUmF0aW8oMSksIHQuc2V0U2l6ZShwLmZyYW1lYnVmZmVyV2lkdGgsIHAuZnJhbWVidWZmZXJIZWlnaHQsICExKSwgXyA9IG5ldyBSbigKICAgICAgICAgICAgcC5mcmFtZWJ1ZmZlcldpZHRoLAogICAgICAgICAgICBwLmZyYW1lYnVmZmVySGVpZ2h0LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9ybWF0OiBnaSwKICAgICAgICAgICAgICB0eXBlOiBwbiwKICAgICAgICAgICAgICBjb2xvclNwYWNlOiB0Lm91dHB1dENvbG9yU3BhY2UsCiAgICAgICAgICAgICAgc3RlbmNpbEJ1ZmZlcjogdi5zdGVuY2lsLAogICAgICAgICAgICAgIHJlc29sdmVEZXB0aEJ1ZmZlcjogcC5pZ25vcmVEZXB0aFZhbHVlcyA9PT0gITEsCiAgICAgICAgICAgICAgcmVzb2x2ZVN0ZW5jaWxCdWZmZXI6IHAuaWdub3JlRGVwdGhWYWx1ZXMgPT09ICExCiAgICAgICAgICAgIH0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIF8uaXNYUlJlbmRlclRhcmdldCA9ICEwLCB0aGlzLnNldEZvdmVhdGlvbihsKSwgaCA9IG51bGwsIHIgPSBhd2FpdCBuLnJlcXVlc3RSZWZlcmVuY2VTcGFjZShvKSwgSnQuc2V0Q29udGV4dChuKSwgSnQuc3RhcnQoKSwgaS5pc1ByZXNlbnRpbmcgPSAhMCwgaS5kaXNwYXRjaEV2ZW50KHsgdHlwZTogInNlc3Npb25zdGFydCIgfSk7CiAgICAgIH0KICAgIH0sIHRoaXMuZ2V0RW52aXJvbm1lbnRCbGVuZE1vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKG4gIT09IG51bGwpCiAgICAgICAgcmV0dXJuIG4uZW52aXJvbm1lbnRCbGVuZE1vZGU7CiAgICB9LCB0aGlzLmdldERlcHRoVGV4dHVyZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZy5nZXREZXB0aFRleHR1cmUoKTsKICAgIH07CiAgICBmdW5jdGlvbiBldChZKSB7CiAgICAgIGZvciAobGV0IHN0ID0gMDsgc3QgPCBZLnJlbW92ZWQubGVuZ3RoOyBzdCsrKSB7CiAgICAgICAgY29uc3QgRXQgPSBZLnJlbW92ZWRbc3RdLCBVdCA9IHcuaW5kZXhPZihFdCk7CiAgICAgICAgVXQgPj0gMCAmJiAod1tVdF0gPSBudWxsLCBTW1V0XS5kaXNjb25uZWN0KEV0KSk7CiAgICAgIH0KICAgICAgZm9yIChsZXQgc3QgPSAwOyBzdCA8IFkuYWRkZWQubGVuZ3RoOyBzdCsrKSB7CiAgICAgICAgY29uc3QgRXQgPSBZLmFkZGVkW3N0XTsKICAgICAgICBsZXQgVXQgPSB3LmluZGV4T2YoRXQpOwogICAgICAgIGlmIChVdCA9PT0gLTEpIHsKICAgICAgICAgIGZvciAobGV0IEt0ID0gMDsgS3QgPCBTLmxlbmd0aDsgS3QrKykKICAgICAgICAgICAgaWYgKEt0ID49IHcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdy5wdXNoKEV0KSwgVXQgPSBLdDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIGlmICh3W0t0XSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHdbS3RdID0gRXQsIFV0ID0gS3Q7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIGlmIChVdCA9PT0gLTEpIGJyZWFrOwogICAgICAgIH0KICAgICAgICBjb25zdCBQdCA9IFNbVXRdOwogICAgICAgIFB0ICYmIFB0LmNvbm5lY3QoRXQpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBIID0gbmV3IEUoKSwgYXQgPSBuZXcgRSgpOwogICAgZnVuY3Rpb24gcHQoWSwgc3QsIEV0KSB7CiAgICAgIEguc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHN0Lm1hdHJpeFdvcmxkKSwgYXQuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKEV0Lm1hdHJpeFdvcmxkKTsKICAgICAgY29uc3QgVXQgPSBILmRpc3RhbmNlVG8oYXQpLCBQdCA9IHN0LnByb2plY3Rpb25NYXRyaXguZWxlbWVudHMsIEt0ID0gRXQucHJvamVjdGlvbk1hdHJpeC5lbGVtZW50cywgaGUgPSBQdFsxNF0gLyAoUHRbMTBdIC0gMSksIEQgPSBQdFsxNF0gLyAoUHRbMTBdICsgMSksIG90ID0gKFB0WzldICsgMSkgLyBQdFs1XSwgaXQgPSAoUHRbOV0gLSAxKSAvIFB0WzVdLCBRID0gKFB0WzhdIC0gMSkgLyBQdFswXSwgSyA9IChLdFs4XSArIDEpIC8gS3RbMF0sIHl0ID0gaGUgKiBRLCB1dCA9IGhlICogSywgeHQgPSBVdCAvICgtUSArIEspLCBXdCA9IHh0ICogLVE7CiAgICAgIGlmIChzdC5tYXRyaXhXb3JsZC5kZWNvbXBvc2UoWS5wb3NpdGlvbiwgWS5xdWF0ZXJuaW9uLCBZLnNjYWxlKSwgWS50cmFuc2xhdGVYKFd0KSwgWS50cmFuc2xhdGVaKHh0KSwgWS5tYXRyaXhXb3JsZC5jb21wb3NlKFkucG9zaXRpb24sIFkucXVhdGVybmlvbiwgWS5zY2FsZSksIFkubWF0cml4V29ybGRJbnZlcnNlLmNvcHkoWS5tYXRyaXhXb3JsZCkuaW52ZXJ0KCksIFB0WzEwXSA9PT0gLTEpCiAgICAgICAgWS5wcm9qZWN0aW9uTWF0cml4LmNvcHkoc3QucHJvamVjdGlvbk1hdHJpeCksIFkucHJvamVjdGlvbk1hdHJpeEludmVyc2UuY29weShzdC5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZSk7CiAgICAgIGVsc2UgewogICAgICAgIGNvbnN0IE50ID0gaGUgKyB4dCwgUCA9IEQgKyB4dCwgQSA9IHl0IC0gV3QsIE4gPSB1dCArIChVdCAtIFd0KSwgWCA9IG90ICogRCAvIFAgKiBOdCwgcnQgPSBpdCAqIEQgLyBQICogTnQ7CiAgICAgICAgWS5wcm9qZWN0aW9uTWF0cml4Lm1ha2VQZXJzcGVjdGl2ZShBLCBOLCBYLCBydCwgTnQsIFApLCBZLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlLmNvcHkoWS5wcm9qZWN0aW9uTWF0cml4KS5pbnZlcnQoKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gTXQoWSwgc3QpIHsKICAgICAgc3QgPT09IG51bGwgPyBZLm1hdHJpeFdvcmxkLmNvcHkoWS5tYXRyaXgpIDogWS5tYXRyaXhXb3JsZC5tdWx0aXBseU1hdHJpY2VzKHN0Lm1hdHJpeFdvcmxkLCBZLm1hdHJpeCksIFkubWF0cml4V29ybGRJbnZlcnNlLmNvcHkoWS5tYXRyaXhXb3JsZCkuaW52ZXJ0KCk7CiAgICB9CiAgICB0aGlzLnVwZGF0ZUNhbWVyYSA9IGZ1bmN0aW9uKFkpIHsKICAgICAgaWYgKG4gPT09IG51bGwpIHJldHVybjsKICAgICAgbGV0IHN0ID0gWS5uZWFyLCBFdCA9IFkuZmFyOwogICAgICBnLnRleHR1cmUgIT09IG51bGwgJiYgKGcuZGVwdGhOZWFyID4gMCAmJiAoc3QgPSBnLmRlcHRoTmVhciksIGcuZGVwdGhGYXIgPiAwICYmIChFdCA9IGcuZGVwdGhGYXIpKSwgVS5uZWFyID0gTS5uZWFyID0gYi5uZWFyID0gc3QsIFUuZmFyID0gTS5mYXIgPSBiLmZhciA9IEV0LCAoTyAhPT0gVS5uZWFyIHx8IFYgIT09IFUuZmFyKSAmJiAobi51cGRhdGVSZW5kZXJTdGF0ZSh7CiAgICAgICAgZGVwdGhOZWFyOiBVLm5lYXIsCiAgICAgICAgZGVwdGhGYXI6IFUuZmFyCiAgICAgIH0pLCBPID0gVS5uZWFyLCBWID0gVS5mYXIpLCBVLmxheWVycy5tYXNrID0gWS5sYXllcnMubWFzayB8IDYsIGIubGF5ZXJzLm1hc2sgPSBVLmxheWVycy5tYXNrICYgMywgTS5sYXllcnMubWFzayA9IFUubGF5ZXJzLm1hc2sgJiA1OwogICAgICBjb25zdCBVdCA9IFkucGFyZW50LCBQdCA9IFUuY2FtZXJhczsKICAgICAgTXQoVSwgVXQpOwogICAgICBmb3IgKGxldCBLdCA9IDA7IEt0IDwgUHQubGVuZ3RoOyBLdCsrKQogICAgICAgIE10KFB0W0t0XSwgVXQpOwogICAgICBQdC5sZW5ndGggPT09IDIgPyBwdChVLCBiLCBNKSA6IFUucHJvamVjdGlvbk1hdHJpeC5jb3B5KGIucHJvamVjdGlvbk1hdHJpeCksIEx0KFksIFUsIFV0KTsKICAgIH07CiAgICBmdW5jdGlvbiBMdChZLCBzdCwgRXQpIHsKICAgICAgRXQgPT09IG51bGwgPyBZLm1hdHJpeC5jb3B5KHN0Lm1hdHJpeFdvcmxkKSA6IChZLm1hdHJpeC5jb3B5KEV0Lm1hdHJpeFdvcmxkKSwgWS5tYXRyaXguaW52ZXJ0KCksIFkubWF0cml4Lm11bHRpcGx5KHN0Lm1hdHJpeFdvcmxkKSksIFkubWF0cml4LmRlY29tcG9zZShZLnBvc2l0aW9uLCBZLnF1YXRlcm5pb24sIFkuc2NhbGUpLCBZLnVwZGF0ZU1hdHJpeFdvcmxkKCEwKSwgWS5wcm9qZWN0aW9uTWF0cml4LmNvcHkoc3QucHJvamVjdGlvbk1hdHJpeCksIFkucHJvamVjdGlvbk1hdHJpeEludmVyc2UuY29weShzdC5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZSksIFkuaXNQZXJzcGVjdGl2ZUNhbWVyYSAmJiAoWS5mb3YgPSB5YSAqIDIgKiBNYXRoLmF0YW4oMSAvIFkucHJvamVjdGlvbk1hdHJpeC5lbGVtZW50c1s1XSksIFkuem9vbSA9IDEpOwogICAgfQogICAgdGhpcy5nZXRDYW1lcmEgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFU7CiAgICB9LCB0aGlzLmdldEZvdmVhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShkID09PSBudWxsICYmIHAgPT09IG51bGwpKQogICAgICAgIHJldHVybiBsOwogICAgfSwgdGhpcy5zZXRGb3ZlYXRpb24gPSBmdW5jdGlvbihZKSB7CiAgICAgIGwgPSBZLCBkICE9PSBudWxsICYmIChkLmZpeGVkRm92ZWF0aW9uID0gWSksIHAgIT09IG51bGwgJiYgcC5maXhlZEZvdmVhdGlvbiAhPT0gdm9pZCAwICYmIChwLmZpeGVkRm92ZWF0aW9uID0gWSk7CiAgICB9LCB0aGlzLmhhc0RlcHRoU2Vuc2luZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZy50ZXh0dXJlICE9PSBudWxsOwogICAgfSwgdGhpcy5nZXREZXB0aFNlbnNpbmdNZXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBnLmdldE1lc2goVSk7CiAgICB9LCB0aGlzLmdldENhbWVyYVRleHR1cmUgPSBmdW5jdGlvbihZKSB7CiAgICAgIHJldHVybiBtW1ldOwogICAgfTsKICAgIGxldCBqdCA9IG51bGw7CiAgICBmdW5jdGlvbiBuZShZLCBzdCkgewogICAgICBpZiAoYyA9IHN0LmdldFZpZXdlclBvc2UoaCB8fCByKSwgZiA9IHN0LCBjICE9PSBudWxsKSB7CiAgICAgICAgY29uc3QgRXQgPSBjLnZpZXdzOwogICAgICAgIHAgIT09IG51bGwgJiYgKHQuc2V0UmVuZGVyVGFyZ2V0RnJhbWVidWZmZXIoXywgcC5mcmFtZWJ1ZmZlciksIHQuc2V0UmVuZGVyVGFyZ2V0KF8pKTsKICAgICAgICBsZXQgVXQgPSAhMTsKICAgICAgICBFdC5sZW5ndGggIT09IFUuY2FtZXJhcy5sZW5ndGggJiYgKFUuY2FtZXJhcy5sZW5ndGggPSAwLCBVdCA9ICEwKTsKICAgICAgICBmb3IgKGxldCBEID0gMDsgRCA8IEV0Lmxlbmd0aDsgRCsrKSB7CiAgICAgICAgICBjb25zdCBvdCA9IEV0W0RdOwogICAgICAgICAgbGV0IGl0ID0gbnVsbDsKICAgICAgICAgIGlmIChwICE9PSBudWxsKQogICAgICAgICAgICBpdCA9IHAuZ2V0Vmlld3BvcnQob3QpOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IEsgPSB1LmdldFZpZXdTdWJJbWFnZShkLCBvdCk7CiAgICAgICAgICAgIGl0ID0gSy52aWV3cG9ydCwgRCA9PT0gMCAmJiAodC5zZXRSZW5kZXJUYXJnZXRUZXh0dXJlcygKICAgICAgICAgICAgICBfLAogICAgICAgICAgICAgIEsuY29sb3JUZXh0dXJlLAogICAgICAgICAgICAgIEsuZGVwdGhTdGVuY2lsVGV4dHVyZQogICAgICAgICAgICApLCB0LnNldFJlbmRlclRhcmdldChfKSk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgUSA9IExbRF07CiAgICAgICAgICBRID09PSB2b2lkIDAgJiYgKFEgPSBuZXcgVmUoKSwgUS5sYXllcnMuZW5hYmxlKEQpLCBRLnZpZXdwb3J0ID0gbmV3IFF0KCksIExbRF0gPSBRKSwgUS5tYXRyaXguZnJvbUFycmF5KG90LnRyYW5zZm9ybS5tYXRyaXgpLCBRLm1hdHJpeC5kZWNvbXBvc2UoUS5wb3NpdGlvbiwgUS5xdWF0ZXJuaW9uLCBRLnNjYWxlKSwgUS5wcm9qZWN0aW9uTWF0cml4LmZyb21BcnJheShvdC5wcm9qZWN0aW9uTWF0cml4KSwgUS5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZS5jb3B5KFEucHJvamVjdGlvbk1hdHJpeCkuaW52ZXJ0KCksIFEudmlld3BvcnQuc2V0KGl0LngsIGl0LnksIGl0LndpZHRoLCBpdC5oZWlnaHQpLCBEID09PSAwICYmIChVLm1hdHJpeC5jb3B5KFEubWF0cml4KSwgVS5tYXRyaXguZGVjb21wb3NlKFUucG9zaXRpb24sIFUucXVhdGVybmlvbiwgVS5zY2FsZSkpLCBVdCA9PT0gITAgJiYgVS5jYW1lcmFzLnB1c2goUSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IFB0ID0gbi5lbmFibGVkRmVhdHVyZXM7CiAgICAgICAgaWYgKFB0ICYmIFB0LmluY2x1ZGVzKCJkZXB0aC1zZW5zaW5nIikgJiYgbi5kZXB0aFVzYWdlID09ICJncHUtb3B0aW1pemVkIiAmJiB5KSB7CiAgICAgICAgICB1ID0gaS5nZXRCaW5kaW5nKCk7CiAgICAgICAgICBjb25zdCBEID0gdS5nZXREZXB0aEluZm9ybWF0aW9uKEV0WzBdKTsKICAgICAgICAgIEQgJiYgRC5pc1ZhbGlkICYmIEQudGV4dHVyZSAmJiBnLmluaXQoRCwgbi5yZW5kZXJTdGF0ZSk7CiAgICAgICAgfQogICAgICAgIGlmIChQdCAmJiBQdC5pbmNsdWRlcygiY2FtZXJhLWFjY2VzcyIpICYmIHkpIHsKICAgICAgICAgIHQuc3RhdGUudW5iaW5kVGV4dHVyZSgpLCB1ID0gaS5nZXRCaW5kaW5nKCk7CiAgICAgICAgICBmb3IgKGxldCBEID0gMDsgRCA8IEV0Lmxlbmd0aDsgRCsrKSB7CiAgICAgICAgICAgIGNvbnN0IG90ID0gRXRbRF0uY2FtZXJhOwogICAgICAgICAgICBpZiAob3QpIHsKICAgICAgICAgICAgICBsZXQgaXQgPSBtW290XTsKICAgICAgICAgICAgICBpdCB8fCAoaXQgPSBuZXcgSHAoKSwgbVtvdF0gPSBpdCk7CiAgICAgICAgICAgICAgY29uc3QgUSA9IHUuZ2V0Q2FtZXJhSW1hZ2Uob3QpOwogICAgICAgICAgICAgIGl0LnNvdXJjZVRleHR1cmUgPSBROwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAobGV0IEV0ID0gMDsgRXQgPCBTLmxlbmd0aDsgRXQrKykgewogICAgICAgIGNvbnN0IFV0ID0gd1tFdF0sIFB0ID0gU1tFdF07CiAgICAgICAgVXQgIT09IG51bGwgJiYgUHQgIT09IHZvaWQgMCAmJiBQdC51cGRhdGUoVXQsIHN0LCBoIHx8IHIpOwogICAgICB9CiAgICAgIGp0ICYmIGp0KFksIHN0KSwgc3QuZGV0ZWN0ZWRQbGFuZXMgJiYgaS5kaXNwYXRjaEV2ZW50KHsgdHlwZTogInBsYW5lc2RldGVjdGVkIiwgZGF0YTogc3QgfSksIGYgPSBudWxsOwogICAgfQogICAgY29uc3QgSnQgPSBuZXcgTV8oKTsKICAgIEp0LnNldEFuaW1hdGlvbkxvb3AobmUpLCB0aGlzLnNldEFuaW1hdGlvbkxvb3AgPSBmdW5jdGlvbihZKSB7CiAgICAgIGp0ID0gWTsKICAgIH0sIHRoaXMuZGlzcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgfTsKICB9Cn0KY29uc3QgSnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IGZuKCksIGJFID0gLyogQF9fUFVSRV9fICovIG5ldyBWdCgpOwpmdW5jdGlvbiBNRShhLCB0KSB7CiAgZnVuY3Rpb24gZShnLCBtKSB7CiAgICBnLm1hdHJpeEF1dG9VcGRhdGUgPT09ICEwICYmIGcudXBkYXRlTWF0cml4KCksIG0udmFsdWUuY29weShnLm1hdHJpeCk7CiAgfQogIGZ1bmN0aW9uIGkoZywgbSkgewogICAgbS5jb2xvci5nZXRSR0IoZy5mb2dDb2xvci52YWx1ZSwgd3koYSkpLCBtLmlzRm9nID8gKGcuZm9nTmVhci52YWx1ZSA9IG0ubmVhciwgZy5mb2dGYXIudmFsdWUgPSBtLmZhcikgOiBtLmlzRm9nRXhwMiAmJiAoZy5mb2dEZW5zaXR5LnZhbHVlID0gbS5kZW5zaXR5KTsKICB9CiAgZnVuY3Rpb24gbihnLCBtLCB2LCB4LCBfKSB7CiAgICBtLmlzTWVzaEJhc2ljTWF0ZXJpYWwgfHwgbS5pc01lc2hMYW1iZXJ0TWF0ZXJpYWwgPyBzKGcsIG0pIDogbS5pc01lc2hUb29uTWF0ZXJpYWwgPyAocyhnLCBtKSwgdShnLCBtKSkgOiBtLmlzTWVzaFBob25nTWF0ZXJpYWwgPyAocyhnLCBtKSwgYyhnLCBtKSkgOiBtLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgPyAocyhnLCBtKSwgZChnLCBtKSwgbS5pc01lc2hQaHlzaWNhbE1hdGVyaWFsICYmIHAoZywgbSwgXykpIDogbS5pc01lc2hNYXRjYXBNYXRlcmlhbCA/IChzKGcsIG0pLCBmKGcsIG0pKSA6IG0uaXNNZXNoRGVwdGhNYXRlcmlhbCA/IHMoZywgbSkgOiBtLmlzTWVzaERpc3RhbmNlTWF0ZXJpYWwgPyAocyhnLCBtKSwgeShnLCBtKSkgOiBtLmlzTWVzaE5vcm1hbE1hdGVyaWFsID8gcyhnLCBtKSA6IG0uaXNMaW5lQmFzaWNNYXRlcmlhbCA/IChyKGcsIG0pLCBtLmlzTGluZURhc2hlZE1hdGVyaWFsICYmIG8oZywgbSkpIDogbS5pc1BvaW50c01hdGVyaWFsID8gbChnLCBtLCB2LCB4KSA6IG0uaXNTcHJpdGVNYXRlcmlhbCA/IGgoZywgbSkgOiBtLmlzU2hhZG93TWF0ZXJpYWwgPyAoZy5jb2xvci52YWx1ZS5jb3B5KG0uY29sb3IpLCBnLm9wYWNpdHkudmFsdWUgPSBtLm9wYWNpdHkpIDogbS5pc1NoYWRlck1hdGVyaWFsICYmIChtLnVuaWZvcm1zTmVlZFVwZGF0ZSA9ICExKTsKICB9CiAgZnVuY3Rpb24gcyhnLCBtKSB7CiAgICBnLm9wYWNpdHkudmFsdWUgPSBtLm9wYWNpdHksIG0uY29sb3IgJiYgZy5kaWZmdXNlLnZhbHVlLmNvcHkobS5jb2xvciksIG0uZW1pc3NpdmUgJiYgZy5lbWlzc2l2ZS52YWx1ZS5jb3B5KG0uZW1pc3NpdmUpLm11bHRpcGx5U2NhbGFyKG0uZW1pc3NpdmVJbnRlbnNpdHkpLCBtLm1hcCAmJiAoZy5tYXAudmFsdWUgPSBtLm1hcCwgZShtLm1hcCwgZy5tYXBUcmFuc2Zvcm0pKSwgbS5hbHBoYU1hcCAmJiAoZy5hbHBoYU1hcC52YWx1ZSA9IG0uYWxwaGFNYXAsIGUobS5hbHBoYU1hcCwgZy5hbHBoYU1hcFRyYW5zZm9ybSkpLCBtLmJ1bXBNYXAgJiYgKGcuYnVtcE1hcC52YWx1ZSA9IG0uYnVtcE1hcCwgZShtLmJ1bXBNYXAsIGcuYnVtcE1hcFRyYW5zZm9ybSksIGcuYnVtcFNjYWxlLnZhbHVlID0gbS5idW1wU2NhbGUsIG0uc2lkZSA9PT0gSGUgJiYgKGcuYnVtcFNjYWxlLnZhbHVlICo9IC0xKSksIG0ubm9ybWFsTWFwICYmIChnLm5vcm1hbE1hcC52YWx1ZSA9IG0ubm9ybWFsTWFwLCBlKG0ubm9ybWFsTWFwLCBnLm5vcm1hbE1hcFRyYW5zZm9ybSksIGcubm9ybWFsU2NhbGUudmFsdWUuY29weShtLm5vcm1hbFNjYWxlKSwgbS5zaWRlID09PSBIZSAmJiBnLm5vcm1hbFNjYWxlLnZhbHVlLm5lZ2F0ZSgpKSwgbS5kaXNwbGFjZW1lbnRNYXAgJiYgKGcuZGlzcGxhY2VtZW50TWFwLnZhbHVlID0gbS5kaXNwbGFjZW1lbnRNYXAsIGUobS5kaXNwbGFjZW1lbnRNYXAsIGcuZGlzcGxhY2VtZW50TWFwVHJhbnNmb3JtKSwgZy5kaXNwbGFjZW1lbnRTY2FsZS52YWx1ZSA9IG0uZGlzcGxhY2VtZW50U2NhbGUsIGcuZGlzcGxhY2VtZW50Qmlhcy52YWx1ZSA9IG0uZGlzcGxhY2VtZW50QmlhcyksIG0uZW1pc3NpdmVNYXAgJiYgKGcuZW1pc3NpdmVNYXAudmFsdWUgPSBtLmVtaXNzaXZlTWFwLCBlKG0uZW1pc3NpdmVNYXAsIGcuZW1pc3NpdmVNYXBUcmFuc2Zvcm0pKSwgbS5zcGVjdWxhck1hcCAmJiAoZy5zcGVjdWxhck1hcC52YWx1ZSA9IG0uc3BlY3VsYXJNYXAsIGUobS5zcGVjdWxhck1hcCwgZy5zcGVjdWxhck1hcFRyYW5zZm9ybSkpLCBtLmFscGhhVGVzdCA+IDAgJiYgKGcuYWxwaGFUZXN0LnZhbHVlID0gbS5hbHBoYVRlc3QpOwogICAgY29uc3QgdiA9IHQuZ2V0KG0pLCB4ID0gdi5lbnZNYXAsIF8gPSB2LmVudk1hcFJvdGF0aW9uOwogICAgeCAmJiAoZy5lbnZNYXAudmFsdWUgPSB4LCBKcy5jb3B5KF8pLCBKcy54ICo9IC0xLCBKcy55ICo9IC0xLCBKcy56ICo9IC0xLCB4LmlzQ3ViZVRleHR1cmUgJiYgeC5pc1JlbmRlclRhcmdldFRleHR1cmUgPT09ICExICYmIChKcy55ICo9IC0xLCBKcy56ICo9IC0xKSwgZy5lbnZNYXBSb3RhdGlvbi52YWx1ZS5zZXRGcm9tTWF0cml4NChiRS5tYWtlUm90YXRpb25Gcm9tRXVsZXIoSnMpKSwgZy5mbGlwRW52TWFwLnZhbHVlID0geC5pc0N1YmVUZXh0dXJlICYmIHguaXNSZW5kZXJUYXJnZXRUZXh0dXJlID09PSAhMSA/IC0xIDogMSwgZy5yZWZsZWN0aXZpdHkudmFsdWUgPSBtLnJlZmxlY3Rpdml0eSwgZy5pb3IudmFsdWUgPSBtLmlvciwgZy5yZWZyYWN0aW9uUmF0aW8udmFsdWUgPSBtLnJlZnJhY3Rpb25SYXRpbyksIG0ubGlnaHRNYXAgJiYgKGcubGlnaHRNYXAudmFsdWUgPSBtLmxpZ2h0TWFwLCBnLmxpZ2h0TWFwSW50ZW5zaXR5LnZhbHVlID0gbS5saWdodE1hcEludGVuc2l0eSwgZShtLmxpZ2h0TWFwLCBnLmxpZ2h0TWFwVHJhbnNmb3JtKSksIG0uYW9NYXAgJiYgKGcuYW9NYXAudmFsdWUgPSBtLmFvTWFwLCBnLmFvTWFwSW50ZW5zaXR5LnZhbHVlID0gbS5hb01hcEludGVuc2l0eSwgZShtLmFvTWFwLCBnLmFvTWFwVHJhbnNmb3JtKSk7CiAgfQogIGZ1bmN0aW9uIHIoZywgbSkgewogICAgZy5kaWZmdXNlLnZhbHVlLmNvcHkobS5jb2xvciksIGcub3BhY2l0eS52YWx1ZSA9IG0ub3BhY2l0eSwgbS5tYXAgJiYgKGcubWFwLnZhbHVlID0gbS5tYXAsIGUobS5tYXAsIGcubWFwVHJhbnNmb3JtKSk7CiAgfQogIGZ1bmN0aW9uIG8oZywgbSkgewogICAgZy5kYXNoU2l6ZS52YWx1ZSA9IG0uZGFzaFNpemUsIGcudG90YWxTaXplLnZhbHVlID0gbS5kYXNoU2l6ZSArIG0uZ2FwU2l6ZSwgZy5zY2FsZS52YWx1ZSA9IG0uc2NhbGU7CiAgfQogIGZ1bmN0aW9uIGwoZywgbSwgdiwgeCkgewogICAgZy5kaWZmdXNlLnZhbHVlLmNvcHkobS5jb2xvciksIGcub3BhY2l0eS52YWx1ZSA9IG0ub3BhY2l0eSwgZy5zaXplLnZhbHVlID0gbS5zaXplICogdiwgZy5zY2FsZS52YWx1ZSA9IHggKiAwLjUsIG0ubWFwICYmIChnLm1hcC52YWx1ZSA9IG0ubWFwLCBlKG0ubWFwLCBnLnV2VHJhbnNmb3JtKSksIG0uYWxwaGFNYXAgJiYgKGcuYWxwaGFNYXAudmFsdWUgPSBtLmFscGhhTWFwLCBlKG0uYWxwaGFNYXAsIGcuYWxwaGFNYXBUcmFuc2Zvcm0pKSwgbS5hbHBoYVRlc3QgPiAwICYmIChnLmFscGhhVGVzdC52YWx1ZSA9IG0uYWxwaGFUZXN0KTsKICB9CiAgZnVuY3Rpb24gaChnLCBtKSB7CiAgICBnLmRpZmZ1c2UudmFsdWUuY29weShtLmNvbG9yKSwgZy5vcGFjaXR5LnZhbHVlID0gbS5vcGFjaXR5LCBnLnJvdGF0aW9uLnZhbHVlID0gbS5yb3RhdGlvbiwgbS5tYXAgJiYgKGcubWFwLnZhbHVlID0gbS5tYXAsIGUobS5tYXAsIGcubWFwVHJhbnNmb3JtKSksIG0uYWxwaGFNYXAgJiYgKGcuYWxwaGFNYXAudmFsdWUgPSBtLmFscGhhTWFwLCBlKG0uYWxwaGFNYXAsIGcuYWxwaGFNYXBUcmFuc2Zvcm0pKSwgbS5hbHBoYVRlc3QgPiAwICYmIChnLmFscGhhVGVzdC52YWx1ZSA9IG0uYWxwaGFUZXN0KTsKICB9CiAgZnVuY3Rpb24gYyhnLCBtKSB7CiAgICBnLnNwZWN1bGFyLnZhbHVlLmNvcHkobS5zcGVjdWxhciksIGcuc2hpbmluZXNzLnZhbHVlID0gTWF0aC5tYXgobS5zaGluaW5lc3MsIDFlLTQpOwogIH0KICBmdW5jdGlvbiB1KGcsIG0pIHsKICAgIG0uZ3JhZGllbnRNYXAgJiYgKGcuZ3JhZGllbnRNYXAudmFsdWUgPSBtLmdyYWRpZW50TWFwKTsKICB9CiAgZnVuY3Rpb24gZChnLCBtKSB7CiAgICBnLm1ldGFsbmVzcy52YWx1ZSA9IG0ubWV0YWxuZXNzLCBtLm1ldGFsbmVzc01hcCAmJiAoZy5tZXRhbG5lc3NNYXAudmFsdWUgPSBtLm1ldGFsbmVzc01hcCwgZShtLm1ldGFsbmVzc01hcCwgZy5tZXRhbG5lc3NNYXBUcmFuc2Zvcm0pKSwgZy5yb3VnaG5lc3MudmFsdWUgPSBtLnJvdWdobmVzcywgbS5yb3VnaG5lc3NNYXAgJiYgKGcucm91Z2huZXNzTWFwLnZhbHVlID0gbS5yb3VnaG5lc3NNYXAsIGUobS5yb3VnaG5lc3NNYXAsIGcucm91Z2huZXNzTWFwVHJhbnNmb3JtKSksIG0uZW52TWFwICYmIChnLmVudk1hcEludGVuc2l0eS52YWx1ZSA9IG0uZW52TWFwSW50ZW5zaXR5KTsKICB9CiAgZnVuY3Rpb24gcChnLCBtLCB2KSB7CiAgICBnLmlvci52YWx1ZSA9IG0uaW9yLCBtLnNoZWVuID4gMCAmJiAoZy5zaGVlbkNvbG9yLnZhbHVlLmNvcHkobS5zaGVlbkNvbG9yKS5tdWx0aXBseVNjYWxhcihtLnNoZWVuKSwgZy5zaGVlblJvdWdobmVzcy52YWx1ZSA9IG0uc2hlZW5Sb3VnaG5lc3MsIG0uc2hlZW5Db2xvck1hcCAmJiAoZy5zaGVlbkNvbG9yTWFwLnZhbHVlID0gbS5zaGVlbkNvbG9yTWFwLCBlKG0uc2hlZW5Db2xvck1hcCwgZy5zaGVlbkNvbG9yTWFwVHJhbnNmb3JtKSksIG0uc2hlZW5Sb3VnaG5lc3NNYXAgJiYgKGcuc2hlZW5Sb3VnaG5lc3NNYXAudmFsdWUgPSBtLnNoZWVuUm91Z2huZXNzTWFwLCBlKG0uc2hlZW5Sb3VnaG5lc3NNYXAsIGcuc2hlZW5Sb3VnaG5lc3NNYXBUcmFuc2Zvcm0pKSksIG0uY2xlYXJjb2F0ID4gMCAmJiAoZy5jbGVhcmNvYXQudmFsdWUgPSBtLmNsZWFyY29hdCwgZy5jbGVhcmNvYXRSb3VnaG5lc3MudmFsdWUgPSBtLmNsZWFyY29hdFJvdWdobmVzcywgbS5jbGVhcmNvYXRNYXAgJiYgKGcuY2xlYXJjb2F0TWFwLnZhbHVlID0gbS5jbGVhcmNvYXRNYXAsIGUobS5jbGVhcmNvYXRNYXAsIGcuY2xlYXJjb2F0TWFwVHJhbnNmb3JtKSksIG0uY2xlYXJjb2F0Um91Z2huZXNzTWFwICYmIChnLmNsZWFyY29hdFJvdWdobmVzc01hcC52YWx1ZSA9IG0uY2xlYXJjb2F0Um91Z2huZXNzTWFwLCBlKG0uY2xlYXJjb2F0Um91Z2huZXNzTWFwLCBnLmNsZWFyY29hdFJvdWdobmVzc01hcFRyYW5zZm9ybSkpLCBtLmNsZWFyY29hdE5vcm1hbE1hcCAmJiAoZy5jbGVhcmNvYXROb3JtYWxNYXAudmFsdWUgPSBtLmNsZWFyY29hdE5vcm1hbE1hcCwgZShtLmNsZWFyY29hdE5vcm1hbE1hcCwgZy5jbGVhcmNvYXROb3JtYWxNYXBUcmFuc2Zvcm0pLCBnLmNsZWFyY29hdE5vcm1hbFNjYWxlLnZhbHVlLmNvcHkobS5jbGVhcmNvYXROb3JtYWxTY2FsZSksIG0uc2lkZSA9PT0gSGUgJiYgZy5jbGVhcmNvYXROb3JtYWxTY2FsZS52YWx1ZS5uZWdhdGUoKSkpLCBtLmRpc3BlcnNpb24gPiAwICYmIChnLmRpc3BlcnNpb24udmFsdWUgPSBtLmRpc3BlcnNpb24pLCBtLmlyaWRlc2NlbmNlID4gMCAmJiAoZy5pcmlkZXNjZW5jZS52YWx1ZSA9IG0uaXJpZGVzY2VuY2UsIGcuaXJpZGVzY2VuY2VJT1IudmFsdWUgPSBtLmlyaWRlc2NlbmNlSU9SLCBnLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bS52YWx1ZSA9IG0uaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZVswXSwgZy5pcmlkZXNjZW5jZVRoaWNrbmVzc01heGltdW0udmFsdWUgPSBtLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2VbMV0sIG0uaXJpZGVzY2VuY2VNYXAgJiYgKGcuaXJpZGVzY2VuY2VNYXAudmFsdWUgPSBtLmlyaWRlc2NlbmNlTWFwLCBlKG0uaXJpZGVzY2VuY2VNYXAsIGcuaXJpZGVzY2VuY2VNYXBUcmFuc2Zvcm0pKSwgbS5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCAmJiAoZy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcC52YWx1ZSA9IG0uaXJpZGVzY2VuY2VUaGlja25lc3NNYXAsIGUobS5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCwgZy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcFRyYW5zZm9ybSkpKSwgbS50cmFuc21pc3Npb24gPiAwICYmIChnLnRyYW5zbWlzc2lvbi52YWx1ZSA9IG0udHJhbnNtaXNzaW9uLCBnLnRyYW5zbWlzc2lvblNhbXBsZXJNYXAudmFsdWUgPSB2LnRleHR1cmUsIGcudHJhbnNtaXNzaW9uU2FtcGxlclNpemUudmFsdWUuc2V0KHYud2lkdGgsIHYuaGVpZ2h0KSwgbS50cmFuc21pc3Npb25NYXAgJiYgKGcudHJhbnNtaXNzaW9uTWFwLnZhbHVlID0gbS50cmFuc21pc3Npb25NYXAsIGUobS50cmFuc21pc3Npb25NYXAsIGcudHJhbnNtaXNzaW9uTWFwVHJhbnNmb3JtKSksIGcudGhpY2tuZXNzLnZhbHVlID0gbS50aGlja25lc3MsIG0udGhpY2tuZXNzTWFwICYmIChnLnRoaWNrbmVzc01hcC52YWx1ZSA9IG0udGhpY2tuZXNzTWFwLCBlKG0udGhpY2tuZXNzTWFwLCBnLnRoaWNrbmVzc01hcFRyYW5zZm9ybSkpLCBnLmF0dGVudWF0aW9uRGlzdGFuY2UudmFsdWUgPSBtLmF0dGVudWF0aW9uRGlzdGFuY2UsIGcuYXR0ZW51YXRpb25Db2xvci52YWx1ZS5jb3B5KG0uYXR0ZW51YXRpb25Db2xvcikpLCBtLmFuaXNvdHJvcHkgPiAwICYmIChnLmFuaXNvdHJvcHlWZWN0b3IudmFsdWUuc2V0KG0uYW5pc290cm9weSAqIE1hdGguY29zKG0uYW5pc290cm9weVJvdGF0aW9uKSwgbS5hbmlzb3Ryb3B5ICogTWF0aC5zaW4obS5hbmlzb3Ryb3B5Um90YXRpb24pKSwgbS5hbmlzb3Ryb3B5TWFwICYmIChnLmFuaXNvdHJvcHlNYXAudmFsdWUgPSBtLmFuaXNvdHJvcHlNYXAsIGUobS5hbmlzb3Ryb3B5TWFwLCBnLmFuaXNvdHJvcHlNYXBUcmFuc2Zvcm0pKSksIGcuc3BlY3VsYXJJbnRlbnNpdHkudmFsdWUgPSBtLnNwZWN1bGFySW50ZW5zaXR5LCBnLnNwZWN1bGFyQ29sb3IudmFsdWUuY29weShtLnNwZWN1bGFyQ29sb3IpLCBtLnNwZWN1bGFyQ29sb3JNYXAgJiYgKGcuc3BlY3VsYXJDb2xvck1hcC52YWx1ZSA9IG0uc3BlY3VsYXJDb2xvck1hcCwgZShtLnNwZWN1bGFyQ29sb3JNYXAsIGcuc3BlY3VsYXJDb2xvck1hcFRyYW5zZm9ybSkpLCBtLnNwZWN1bGFySW50ZW5zaXR5TWFwICYmIChnLnNwZWN1bGFySW50ZW5zaXR5TWFwLnZhbHVlID0gbS5zcGVjdWxhckludGVuc2l0eU1hcCwgZShtLnNwZWN1bGFySW50ZW5zaXR5TWFwLCBnLnNwZWN1bGFySW50ZW5zaXR5TWFwVHJhbnNmb3JtKSk7CiAgfQogIGZ1bmN0aW9uIGYoZywgbSkgewogICAgbS5tYXRjYXAgJiYgKGcubWF0Y2FwLnZhbHVlID0gbS5tYXRjYXApOwogIH0KICBmdW5jdGlvbiB5KGcsIG0pIHsKICAgIGNvbnN0IHYgPSB0LmdldChtKS5saWdodDsKICAgIGcucmVmZXJlbmNlUG9zaXRpb24udmFsdWUuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHYubWF0cml4V29ybGQpLCBnLm5lYXJEaXN0YW5jZS52YWx1ZSA9IHYuc2hhZG93LmNhbWVyYS5uZWFyLCBnLmZhckRpc3RhbmNlLnZhbHVlID0gdi5zaGFkb3cuY2FtZXJhLmZhcjsKICB9CiAgcmV0dXJuIHsKICAgIHJlZnJlc2hGb2dVbmlmb3JtczogaSwKICAgIHJlZnJlc2hNYXRlcmlhbFVuaWZvcm1zOiBuCiAgfTsKfQpmdW5jdGlvbiBTRShhLCB0LCBlLCBpKSB7CiAgbGV0IG4gPSB7fSwgcyA9IHt9LCByID0gW107CiAgY29uc3QgbyA9IGEuZ2V0UGFyYW1ldGVyKGEuTUFYX1VOSUZPUk1fQlVGRkVSX0JJTkRJTkdTKTsKICBmdW5jdGlvbiBsKHYsIHgpIHsKICAgIGNvbnN0IF8gPSB4LnByb2dyYW07CiAgICBpLnVuaWZvcm1CbG9ja0JpbmRpbmcodiwgXyk7CiAgfQogIGZ1bmN0aW9uIGgodiwgeCkgewogICAgbGV0IF8gPSBuW3YuaWRdOwogICAgXyA9PT0gdm9pZCAwICYmIChmKHYpLCBfID0gYyh2KSwgblt2LmlkXSA9IF8sIHYuYWRkRXZlbnRMaXN0ZW5lcigiZGlzcG9zZSIsIGcpKTsKICAgIGNvbnN0IFMgPSB4LnByb2dyYW07CiAgICBpLnVwZGF0ZVVCT01hcHBpbmcodiwgUyk7CiAgICBjb25zdCB3ID0gdC5yZW5kZXIuZnJhbWU7CiAgICBzW3YuaWRdICE9PSB3ICYmIChkKHYpLCBzW3YuaWRdID0gdyk7CiAgfQogIGZ1bmN0aW9uIGModikgewogICAgY29uc3QgeCA9IHUoKTsKICAgIHYuX19iaW5kaW5nUG9pbnRJbmRleCA9IHg7CiAgICBjb25zdCBfID0gYS5jcmVhdGVCdWZmZXIoKSwgUyA9IHYuX19zaXplLCB3ID0gdi51c2FnZTsKICAgIHJldHVybiBhLmJpbmRCdWZmZXIoYS5VTklGT1JNX0JVRkZFUiwgXyksIGEuYnVmZmVyRGF0YShhLlVOSUZPUk1fQlVGRkVSLCBTLCB3KSwgYS5iaW5kQnVmZmVyKGEuVU5JRk9STV9CVUZGRVIsIG51bGwpLCBhLmJpbmRCdWZmZXJCYXNlKGEuVU5JRk9STV9CVUZGRVIsIHgsIF8pLCBfOwogIH0KICBmdW5jdGlvbiB1KCkgewogICAgZm9yIChsZXQgdiA9IDA7IHYgPCBvOyB2KyspCiAgICAgIGlmIChyLmluZGV4T2YodikgPT09IC0xKQogICAgICAgIHJldHVybiByLnB1c2godiksIHY7CiAgICByZXR1cm4gY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xSZW5kZXJlcjogTWF4aW11bSBudW1iZXIgb2Ygc2ltdWx0YW5lb3VzbHkgdXNhYmxlIHVuaWZvcm1zIGdyb3VwcyByZWFjaGVkLiIpLCAwOwogIH0KICBmdW5jdGlvbiBkKHYpIHsKICAgIGNvbnN0IHggPSBuW3YuaWRdLCBfID0gdi51bmlmb3JtcywgUyA9IHYuX19jYWNoZTsKICAgIGEuYmluZEJ1ZmZlcihhLlVOSUZPUk1fQlVGRkVSLCB4KTsKICAgIGZvciAobGV0IHcgPSAwLCBUID0gXy5sZW5ndGg7IHcgPCBUOyB3KyspIHsKICAgICAgY29uc3QgUiA9IEFycmF5LmlzQXJyYXkoX1t3XSkgPyBfW3ddIDogW19bd11dOwogICAgICBmb3IgKGxldCBiID0gMCwgTSA9IFIubGVuZ3RoOyBiIDwgTTsgYisrKSB7CiAgICAgICAgY29uc3QgTCA9IFJbYl07CiAgICAgICAgaWYgKHAoTCwgdywgYiwgUykgPT09ICEwKSB7CiAgICAgICAgICBjb25zdCBVID0gTC5fX29mZnNldCwgTyA9IEFycmF5LmlzQXJyYXkoTC52YWx1ZSkgPyBMLnZhbHVlIDogW0wudmFsdWVdOwogICAgICAgICAgbGV0IFYgPSAwOwogICAgICAgICAgZm9yIChsZXQgVyA9IDA7IFcgPCBPLmxlbmd0aDsgVysrKSB7CiAgICAgICAgICAgIGNvbnN0IEcgPSBPW1ddLCBldCA9IHkoRyk7CiAgICAgICAgICAgIHR5cGVvZiBHID09ICJudW1iZXIiIHx8IHR5cGVvZiBHID09ICJib29sZWFuIiA/IChMLl9fZGF0YVswXSA9IEcsIGEuYnVmZmVyU3ViRGF0YShhLlVOSUZPUk1fQlVGRkVSLCBVICsgViwgTC5fX2RhdGEpKSA6IEcuaXNNYXRyaXgzID8gKEwuX19kYXRhWzBdID0gRy5lbGVtZW50c1swXSwgTC5fX2RhdGFbMV0gPSBHLmVsZW1lbnRzWzFdLCBMLl9fZGF0YVsyXSA9IEcuZWxlbWVudHNbMl0sIEwuX19kYXRhWzNdID0gMCwgTC5fX2RhdGFbNF0gPSBHLmVsZW1lbnRzWzNdLCBMLl9fZGF0YVs1XSA9IEcuZWxlbWVudHNbNF0sIEwuX19kYXRhWzZdID0gRy5lbGVtZW50c1s1XSwgTC5fX2RhdGFbN10gPSAwLCBMLl9fZGF0YVs4XSA9IEcuZWxlbWVudHNbNl0sIEwuX19kYXRhWzldID0gRy5lbGVtZW50c1s3XSwgTC5fX2RhdGFbMTBdID0gRy5lbGVtZW50c1s4XSwgTC5fX2RhdGFbMTFdID0gMCkgOiAoRy50b0FycmF5KEwuX19kYXRhLCBWKSwgViArPSBldC5zdG9yYWdlIC8gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKTsKICAgICAgICAgIH0KICAgICAgICAgIGEuYnVmZmVyU3ViRGF0YShhLlVOSUZPUk1fQlVGRkVSLCBVLCBMLl9fZGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBhLmJpbmRCdWZmZXIoYS5VTklGT1JNX0JVRkZFUiwgbnVsbCk7CiAgfQogIGZ1bmN0aW9uIHAodiwgeCwgXywgUykgewogICAgY29uc3QgdyA9IHYudmFsdWUsIFQgPSB4ICsgIl8iICsgXzsKICAgIGlmIChTW1RdID09PSB2b2lkIDApCiAgICAgIHJldHVybiB0eXBlb2YgdyA9PSAibnVtYmVyIiB8fCB0eXBlb2YgdyA9PSAiYm9vbGVhbiIgPyBTW1RdID0gdyA6IFNbVF0gPSB3LmNsb25lKCksICEwOwogICAgewogICAgICBjb25zdCBSID0gU1tUXTsKICAgICAgaWYgKHR5cGVvZiB3ID09ICJudW1iZXIiIHx8IHR5cGVvZiB3ID09ICJib29sZWFuIikgewogICAgICAgIGlmIChSICE9PSB3KQogICAgICAgICAgcmV0dXJuIFNbVF0gPSB3LCAhMDsKICAgICAgfSBlbHNlIGlmIChSLmVxdWFscyh3KSA9PT0gITEpCiAgICAgICAgcmV0dXJuIFIuY29weSh3KSwgITA7CiAgICB9CiAgICByZXR1cm4gITE7CiAgfQogIGZ1bmN0aW9uIGYodikgewogICAgY29uc3QgeCA9IHYudW5pZm9ybXM7CiAgICBsZXQgXyA9IDA7CiAgICBjb25zdCBTID0gMTY7CiAgICBmb3IgKGxldCBUID0gMCwgUiA9IHgubGVuZ3RoOyBUIDwgUjsgVCsrKSB7CiAgICAgIGNvbnN0IGIgPSBBcnJheS5pc0FycmF5KHhbVF0pID8geFtUXSA6IFt4W1RdXTsKICAgICAgZm9yIChsZXQgTSA9IDAsIEwgPSBiLmxlbmd0aDsgTSA8IEw7IE0rKykgewogICAgICAgIGNvbnN0IFUgPSBiW01dLCBPID0gQXJyYXkuaXNBcnJheShVLnZhbHVlKSA/IFUudmFsdWUgOiBbVS52YWx1ZV07CiAgICAgICAgZm9yIChsZXQgViA9IDAsIFcgPSBPLmxlbmd0aDsgViA8IFc7IFYrKykgewogICAgICAgICAgY29uc3QgRyA9IE9bVl0sIGV0ID0geShHKSwgSCA9IF8gJSBTLCBhdCA9IEggJSBldC5ib3VuZGFyeSwgcHQgPSBIICsgYXQ7CiAgICAgICAgICBfICs9IGF0LCBwdCAhPT0gMCAmJiBTIC0gcHQgPCBldC5zdG9yYWdlICYmIChfICs9IFMgLSBwdCksIFUuX19kYXRhID0gbmV3IEZsb2F0MzJBcnJheShldC5zdG9yYWdlIC8gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKSwgVS5fX29mZnNldCA9IF8sIF8gKz0gZXQuc3RvcmFnZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHcgPSBfICUgUzsKICAgIHJldHVybiB3ID4gMCAmJiAoXyArPSBTIC0gdyksIHYuX19zaXplID0gXywgdi5fX2NhY2hlID0ge30sIHRoaXM7CiAgfQogIGZ1bmN0aW9uIHkodikgewogICAgY29uc3QgeCA9IHsKICAgICAgYm91bmRhcnk6IDAsCiAgICAgIC8vIGJ5dGVzCiAgICAgIHN0b3JhZ2U6IDAKICAgICAgLy8gYnl0ZXMKICAgIH07CiAgICByZXR1cm4gdHlwZW9mIHYgPT0gIm51bWJlciIgfHwgdHlwZW9mIHYgPT0gImJvb2xlYW4iID8gKHguYm91bmRhcnkgPSA0LCB4LnN0b3JhZ2UgPSA0KSA6IHYuaXNWZWN0b3IyID8gKHguYm91bmRhcnkgPSA4LCB4LnN0b3JhZ2UgPSA4KSA6IHYuaXNWZWN0b3IzIHx8IHYuaXNDb2xvciA/ICh4LmJvdW5kYXJ5ID0gMTYsIHguc3RvcmFnZSA9IDEyKSA6IHYuaXNWZWN0b3I0ID8gKHguYm91bmRhcnkgPSAxNiwgeC5zdG9yYWdlID0gMTYpIDogdi5pc01hdHJpeDMgPyAoeC5ib3VuZGFyeSA9IDQ4LCB4LnN0b3JhZ2UgPSA0OCkgOiB2LmlzTWF0cml4NCA/ICh4LmJvdW5kYXJ5ID0gNjQsIHguc3RvcmFnZSA9IDY0KSA6IHYuaXNUZXh0dXJlID8gY29uc29sZS53YXJuKCJUSFJFRS5XZWJHTFJlbmRlcmVyOiBUZXh0dXJlIHNhbXBsZXJzIGNhbiBub3QgYmUgcGFydCBvZiBhbiB1bmlmb3JtcyBncm91cC4iKSA6IGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xSZW5kZXJlcjogVW5zdXBwb3J0ZWQgdW5pZm9ybSB2YWx1ZSB0eXBlLiIsIHYpLCB4OwogIH0KICBmdW5jdGlvbiBnKHYpIHsKICAgIGNvbnN0IHggPSB2LnRhcmdldDsKICAgIHgucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZGlzcG9zZSIsIGcpOwogICAgY29uc3QgXyA9IHIuaW5kZXhPZih4Ll9fYmluZGluZ1BvaW50SW5kZXgpOwogICAgci5zcGxpY2UoXywgMSksIGEuZGVsZXRlQnVmZmVyKG5beC5pZF0pLCBkZWxldGUgblt4LmlkXSwgZGVsZXRlIHNbeC5pZF07CiAgfQogIGZ1bmN0aW9uIG0oKSB7CiAgICBmb3IgKGNvbnN0IHYgaW4gbikKICAgICAgYS5kZWxldGVCdWZmZXIoblt2XSk7CiAgICByID0gW10sIG4gPSB7fSwgcyA9IHt9OwogIH0KICByZXR1cm4gewogICAgYmluZDogbCwKICAgIHVwZGF0ZTogaCwKICAgIGRpc3Bvc2U6IG0KICB9Owp9CmNsYXNzIENfIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IFdlYkdMIHJlbmRlcmVyLgogICAqCiAgICogQHBhcmFtIHtXZWJHTFJlbmRlcmVyfk9wdGlvbnN9IFtwYXJhbWV0ZXJzXSAtIFRoZSBjb25maWd1cmF0aW9uIHBhcmFtZXRlci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgY2FudmFzOiBlID0gX3koKSwKICAgICAgY29udGV4dDogaSA9IG51bGwsCiAgICAgIGRlcHRoOiBuID0gITAsCiAgICAgIHN0ZW5jaWw6IHMgPSAhMSwKICAgICAgYWxwaGE6IHIgPSAhMSwKICAgICAgYW50aWFsaWFzOiBvID0gITEsCiAgICAgIHByZW11bHRpcGxpZWRBbHBoYTogbCA9ICEwLAogICAgICBwcmVzZXJ2ZURyYXdpbmdCdWZmZXI6IGggPSAhMSwKICAgICAgcG93ZXJQcmVmZXJlbmNlOiBjID0gImRlZmF1bHQiLAogICAgICBmYWlsSWZNYWpvclBlcmZvcm1hbmNlQ2F2ZWF0OiB1ID0gITEsCiAgICAgIHJldmVyc2VkRGVwdGhCdWZmZXI6IGQgPSAhMQogICAgfSA9IHQ7CiAgICB0aGlzLmlzV2ViR0xSZW5kZXJlciA9ICEwOwogICAgbGV0IHA7CiAgICBpZiAoaSAhPT0gbnVsbCkgewogICAgICBpZiAodHlwZW9mIFdlYkdMUmVuZGVyaW5nQ29udGV4dCA8ICJ1IiAmJiBpIGluc3RhbmNlb2YgV2ViR0xSZW5kZXJpbmdDb250ZXh0KQogICAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuV2ViR0xSZW5kZXJlcjogV2ViR0wgMSBpcyBub3Qgc3VwcG9ydGVkIHNpbmNlIHIxNjMuIik7CiAgICAgIHAgPSBpLmdldENvbnRleHRBdHRyaWJ1dGVzKCkuYWxwaGE7CiAgICB9IGVsc2UKICAgICAgcCA9IHI7CiAgICBjb25zdCBmID0gbmV3IFVpbnQzMkFycmF5KDQpLCB5ID0gbmV3IEludDMyQXJyYXkoNCk7CiAgICBsZXQgZyA9IG51bGwsIG0gPSBudWxsOwogICAgY29uc3QgdiA9IFtdLCB4ID0gW107CiAgICB0aGlzLmRvbUVsZW1lbnQgPSBlLCB0aGlzLmRlYnVnID0gewogICAgICAvKioKICAgICAgICogRW5hYmxlcyBlcnJvciBjaGVja2luZyBhbmQgcmVwb3J0aW5nIHdoZW4gc2hhZGVyIHByb2dyYW1zIGFyZSBiZWluZyBjb21waWxlZC4KICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAqLwogICAgICBjaGVja1NoYWRlckVycm9yczogITAsCiAgICAgIC8qKgogICAgICAgKiBDYWxsYmFjayBmb3IgY3VzdG9tIGVycm9yIHJlcG9ydGluZy4KICAgICAgICogQHR5cGUgez9GdW5jdGlvbn0KICAgICAgICovCiAgICAgIG9uU2hhZGVyRXJyb3I6IG51bGwKICAgIH0sIHRoaXMuYXV0b0NsZWFyID0gITAsIHRoaXMuYXV0b0NsZWFyQ29sb3IgPSAhMCwgdGhpcy5hdXRvQ2xlYXJEZXB0aCA9ICEwLCB0aGlzLmF1dG9DbGVhclN0ZW5jaWwgPSAhMCwgdGhpcy5zb3J0T2JqZWN0cyA9ICEwLCB0aGlzLmNsaXBwaW5nUGxhbmVzID0gW10sIHRoaXMubG9jYWxDbGlwcGluZ0VuYWJsZWQgPSAhMSwgdGhpcy50b25lTWFwcGluZyA9IFpuLCB0aGlzLnRvbmVNYXBwaW5nRXhwb3N1cmUgPSAxLCB0aGlzLnRyYW5zbWlzc2lvblJlc29sdXRpb25TY2FsZSA9IDE7CiAgICBjb25zdCBfID0gdGhpczsKICAgIGxldCBTID0gITE7CiAgICB0aGlzLl9vdXRwdXRDb2xvclNwYWNlID0gcmk7CiAgICBsZXQgdyA9IDAsIFQgPSAwLCBSID0gbnVsbCwgYiA9IC0xLCBNID0gbnVsbDsKICAgIGNvbnN0IEwgPSBuZXcgUXQoKSwgVSA9IG5ldyBRdCgpOwogICAgbGV0IE8gPSBudWxsOwogICAgY29uc3QgViA9IG5ldyBjdCgwKTsKICAgIGxldCBXID0gMCwgRyA9IGUud2lkdGgsIGV0ID0gZS5oZWlnaHQsIEggPSAxLCBhdCA9IG51bGwsIHB0ID0gbnVsbDsKICAgIGNvbnN0IE10ID0gbmV3IFF0KDAsIDAsIEcsIGV0KSwgTHQgPSBuZXcgUXQoMCwgMCwgRywgZXQpOwogICAgbGV0IGp0ID0gITE7CiAgICBjb25zdCBuZSA9IG5ldyBFYSgpOwogICAgbGV0IEp0ID0gITEsIFkgPSAhMTsKICAgIGNvbnN0IHN0ID0gbmV3IFZ0KCksIEV0ID0gbmV3IEUoKSwgVXQgPSBuZXcgUXQoKSwgUHQgPSB7IGJhY2tncm91bmQ6IG51bGwsIGZvZzogbnVsbCwgZW52aXJvbm1lbnQ6IG51bGwsIG92ZXJyaWRlTWF0ZXJpYWw6IG51bGwsIGlzU2NlbmU6ICEwIH07CiAgICBsZXQgS3QgPSAhMTsKICAgIGZ1bmN0aW9uIGhlKCkgewogICAgICByZXR1cm4gUiA9PT0gbnVsbCA/IEggOiAxOwogICAgfQogICAgbGV0IEQgPSBpOwogICAgZnVuY3Rpb24gb3QoQywgQikgewogICAgICByZXR1cm4gZS5nZXRDb250ZXh0KEMsIEIpOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3QgQyA9IHsKICAgICAgICBhbHBoYTogITAsCiAgICAgICAgZGVwdGg6IG4sCiAgICAgICAgc3RlbmNpbDogcywKICAgICAgICBhbnRpYWxpYXM6IG8sCiAgICAgICAgcHJlbXVsdGlwbGllZEFscGhhOiBsLAogICAgICAgIHByZXNlcnZlRHJhd2luZ0J1ZmZlcjogaCwKICAgICAgICBwb3dlclByZWZlcmVuY2U6IGMsCiAgICAgICAgZmFpbElmTWFqb3JQZXJmb3JtYW5jZUNhdmVhdDogdQogICAgICB9OwogICAgICBpZiAoInNldEF0dHJpYnV0ZSIgaW4gZSAmJiBlLnNldEF0dHJpYnV0ZSgiZGF0YS1lbmdpbmUiLCBgdGhyZWUuanMgciR7VGN9YCksIGUuYWRkRXZlbnRMaXN0ZW5lcigid2ViZ2xjb250ZXh0bG9zdCIsIF90LCAhMSksIGUuYWRkRXZlbnRMaXN0ZW5lcigid2ViZ2xjb250ZXh0cmVzdG9yZWQiLCBSdCwgITEpLCBlLmFkZEV2ZW50TGlzdGVuZXIoIndlYmdsY29udGV4dGNyZWF0aW9uZXJyb3IiLCBkdCwgITEpLCBEID09PSBudWxsKSB7CiAgICAgICAgY29uc3QgQiA9ICJ3ZWJnbDIiOwogICAgICAgIGlmIChEID0gb3QoQiwgQyksIEQgPT09IG51bGwpCiAgICAgICAgICB0aHJvdyBvdChCKSA/IG5ldyBFcnJvcigiRXJyb3IgY3JlYXRpbmcgV2ViR0wgY29udGV4dCB3aXRoIHlvdXIgc2VsZWN0ZWQgYXR0cmlidXRlcy4iKSA6IG5ldyBFcnJvcigiRXJyb3IgY3JlYXRpbmcgV2ViR0wgY29udGV4dC4iKTsKICAgICAgfQogICAgfSBjYXRjaCAoQykgewogICAgICB0aHJvdyBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFJlbmRlcmVyOiAiICsgQy5tZXNzYWdlKSwgQzsKICAgIH0KICAgIGxldCBpdCwgUSwgSywgeXQsIHV0LCB4dCwgV3QsIE50LCBQLCBBLCBOLCBYLCBydCwgWiwgSXQsIEksIGx0LCBndCwgaiwgbXQsIEF0LCBUdCwgdnQsICR0OwogICAgZnVuY3Rpb24gRigpIHsKICAgICAgaXQgPSBuZXcgVXcoRCksIGl0LmluaXQoKSwgVHQgPSBuZXcgVF8oRCwgaXQpLCBRID0gbmV3IEN3KEQsIGl0LCB0LCBUdCksIEsgPSBuZXcgbUUoRCwgaXQpLCBRLnJldmVyc2VkRGVwdGhCdWZmZXIgJiYgZCAmJiBLLmJ1ZmZlcnMuZGVwdGguc2V0UmV2ZXJzZWQoITApLCB5dCA9IG5ldyBOdyhEKSwgdXQgPSBuZXcgaUUoKSwgeHQgPSBuZXcgZ0UoRCwgaXQsIEssIHV0LCBRLCBUdCwgeXQpLCBXdCA9IG5ldyBQdyhfKSwgTnQgPSBuZXcgRncoXyksIFAgPSBuZXcgV00oRCksIHZ0ID0gbmV3IEV3KEQsIFApLCBBID0gbmV3IEJ3KEQsIFAsIHl0LCB2dCksIE4gPSBuZXcga3coRCwgQSwgUCwgeXQpLCBqID0gbmV3IE93KEQsIFEsIHh0KSwgSSA9IG5ldyBSdyh1dCksIFggPSBuZXcgZUUoXywgV3QsIE50LCBpdCwgUSwgdnQsIEkpLCBydCA9IG5ldyBNRShfLCB1dCksIFogPSBuZXcgc0UoKSwgSXQgPSBuZXcgY0UoaXQpLCBndCA9IG5ldyBBdyhfLCBXdCwgTnQsIEssIE4sIHAsIGwpLCBsdCA9IG5ldyBwRShfLCBOLCBRKSwgJHQgPSBuZXcgU0UoRCwgeXQsIFEsIEspLCBtdCA9IG5ldyBUdyhELCBpdCwgeXQpLCBBdCA9IG5ldyB6dyhELCBpdCwgeXQpLCB5dC5wcm9ncmFtcyA9IFgucHJvZ3JhbXMsIF8uY2FwYWJpbGl0aWVzID0gUSwgXy5leHRlbnNpb25zID0gaXQsIF8ucHJvcGVydGllcyA9IHV0LCBfLnJlbmRlckxpc3RzID0gWiwgXy5zaGFkb3dNYXAgPSBsdCwgXy5zdGF0ZSA9IEssIF8uaW5mbyA9IHl0OwogICAgfQogICAgRigpOwogICAgY29uc3QgaHQgPSBuZXcgdkUoXywgRCk7CiAgICB0aGlzLnhyID0gaHQsIHRoaXMuZ2V0Q29udGV4dCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gRDsKICAgIH0sIHRoaXMuZ2V0Q29udGV4dEF0dHJpYnV0ZXMgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEQuZ2V0Q29udGV4dEF0dHJpYnV0ZXMoKTsKICAgIH0sIHRoaXMuZm9yY2VDb250ZXh0TG9zcyA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBDID0gaXQuZ2V0KCJXRUJHTF9sb3NlX2NvbnRleHQiKTsKICAgICAgQyAmJiBDLmxvc2VDb250ZXh0KCk7CiAgICB9LCB0aGlzLmZvcmNlQ29udGV4dFJlc3RvcmUgPSBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgQyA9IGl0LmdldCgiV0VCR0xfbG9zZV9jb250ZXh0Iik7CiAgICAgIEMgJiYgQy5yZXN0b3JlQ29udGV4dCgpOwogICAgfSwgdGhpcy5nZXRQaXhlbFJhdGlvID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBIOwogICAgfSwgdGhpcy5zZXRQaXhlbFJhdGlvID0gZnVuY3Rpb24oQykgewogICAgICBDICE9PSB2b2lkIDAgJiYgKEggPSBDLCB0aGlzLnNldFNpemUoRywgZXQsICExKSk7CiAgICB9LCB0aGlzLmdldFNpemUgPSBmdW5jdGlvbihDKSB7CiAgICAgIHJldHVybiBDLnNldChHLCBldCk7CiAgICB9LCB0aGlzLnNldFNpemUgPSBmdW5jdGlvbihDLCBCLCBxID0gITApIHsKICAgICAgaWYgKGh0LmlzUHJlc2VudGluZykgewogICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuV2ViR0xSZW5kZXJlcjogQ2FuJ3QgY2hhbmdlIHNpemUgd2hpbGUgVlIgZGV2aWNlIGlzIHByZXNlbnRpbmcuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIEcgPSBDLCBldCA9IEIsIGUud2lkdGggPSBNYXRoLmZsb29yKEMgKiBIKSwgZS5oZWlnaHQgPSBNYXRoLmZsb29yKEIgKiBIKSwgcSA9PT0gITAgJiYgKGUuc3R5bGUud2lkdGggPSBDICsgInB4IiwgZS5zdHlsZS5oZWlnaHQgPSBCICsgInB4IiksIHRoaXMuc2V0Vmlld3BvcnQoMCwgMCwgQywgQik7CiAgICB9LCB0aGlzLmdldERyYXdpbmdCdWZmZXJTaXplID0gZnVuY3Rpb24oQykgewogICAgICByZXR1cm4gQy5zZXQoRyAqIEgsIGV0ICogSCkuZmxvb3IoKTsKICAgIH0sIHRoaXMuc2V0RHJhd2luZ0J1ZmZlclNpemUgPSBmdW5jdGlvbihDLCBCLCBxKSB7CiAgICAgIEcgPSBDLCBldCA9IEIsIEggPSBxLCBlLndpZHRoID0gTWF0aC5mbG9vcihDICogcSksIGUuaGVpZ2h0ID0gTWF0aC5mbG9vcihCICogcSksIHRoaXMuc2V0Vmlld3BvcnQoMCwgMCwgQywgQik7CiAgICB9LCB0aGlzLmdldEN1cnJlbnRWaWV3cG9ydCA9IGZ1bmN0aW9uKEMpIHsKICAgICAgcmV0dXJuIEMuY29weShMKTsKICAgIH0sIHRoaXMuZ2V0Vmlld3BvcnQgPSBmdW5jdGlvbihDKSB7CiAgICAgIHJldHVybiBDLmNvcHkoTXQpOwogICAgfSwgdGhpcy5zZXRWaWV3cG9ydCA9IGZ1bmN0aW9uKEMsIEIsIHEsICQpIHsKICAgICAgQy5pc1ZlY3RvcjQgPyBNdC5zZXQoQy54LCBDLnksIEMueiwgQy53KSA6IE10LnNldChDLCBCLCBxLCAkKSwgSy52aWV3cG9ydChMLmNvcHkoTXQpLm11bHRpcGx5U2NhbGFyKEgpLnJvdW5kKCkpOwogICAgfSwgdGhpcy5nZXRTY2lzc29yID0gZnVuY3Rpb24oQykgewogICAgICByZXR1cm4gQy5jb3B5KEx0KTsKICAgIH0sIHRoaXMuc2V0U2Npc3NvciA9IGZ1bmN0aW9uKEMsIEIsIHEsICQpIHsKICAgICAgQy5pc1ZlY3RvcjQgPyBMdC5zZXQoQy54LCBDLnksIEMueiwgQy53KSA6IEx0LnNldChDLCBCLCBxLCAkKSwgSy5zY2lzc29yKFUuY29weShMdCkubXVsdGlwbHlTY2FsYXIoSCkucm91bmQoKSk7CiAgICB9LCB0aGlzLmdldFNjaXNzb3JUZXN0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBqdDsKICAgIH0sIHRoaXMuc2V0U2Npc3NvclRlc3QgPSBmdW5jdGlvbihDKSB7CiAgICAgIEsuc2V0U2Npc3NvclRlc3QoanQgPSBDKTsKICAgIH0sIHRoaXMuc2V0T3BhcXVlU29ydCA9IGZ1bmN0aW9uKEMpIHsKICAgICAgYXQgPSBDOwogICAgfSwgdGhpcy5zZXRUcmFuc3BhcmVudFNvcnQgPSBmdW5jdGlvbihDKSB7CiAgICAgIHB0ID0gQzsKICAgIH0sIHRoaXMuZ2V0Q2xlYXJDb2xvciA9IGZ1bmN0aW9uKEMpIHsKICAgICAgcmV0dXJuIEMuY29weShndC5nZXRDbGVhckNvbG9yKCkpOwogICAgfSwgdGhpcy5zZXRDbGVhckNvbG9yID0gZnVuY3Rpb24oKSB7CiAgICAgIGd0LnNldENsZWFyQ29sb3IoLi4uYXJndW1lbnRzKTsKICAgIH0sIHRoaXMuZ2V0Q2xlYXJBbHBoYSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZ3QuZ2V0Q2xlYXJBbHBoYSgpOwogICAgfSwgdGhpcy5zZXRDbGVhckFscGhhID0gZnVuY3Rpb24oKSB7CiAgICAgIGd0LnNldENsZWFyQWxwaGEoLi4uYXJndW1lbnRzKTsKICAgIH0sIHRoaXMuY2xlYXIgPSBmdW5jdGlvbihDID0gITAsIEIgPSAhMCwgcSA9ICEwKSB7CiAgICAgIGxldCAkID0gMDsKICAgICAgaWYgKEMpIHsKICAgICAgICBsZXQgeiA9ICExOwogICAgICAgIGlmIChSICE9PSBudWxsKSB7CiAgICAgICAgICBjb25zdCBmdCA9IFIudGV4dHVyZS5mb3JtYXQ7CiAgICAgICAgICB6ID0gZnQgPT09IEZjIHx8IGZ0ID09PSBEYyB8fCBmdCA9PT0gTm87CiAgICAgICAgfQogICAgICAgIGlmICh6KSB7CiAgICAgICAgICBjb25zdCBmdCA9IFIudGV4dHVyZS50eXBlLCBTdCA9IGZ0ID09PSBwbiB8fCBmdCA9PT0gbnMgfHwgZnQgPT09IGRhIHx8IGZ0ID09PSBwYSB8fCBmdCA9PT0gUGMgfHwgZnQgPT09IEljLCBEdCA9IGd0LmdldENsZWFyQ29sb3IoKSwgQ3QgPSBndC5nZXRDbGVhckFscGhhKCksIE90ID0gRHQuciwgR3QgPSBEdC5nLCBCdCA9IER0LmI7CiAgICAgICAgICBTdCA/IChmWzBdID0gT3QsIGZbMV0gPSBHdCwgZlsyXSA9IEJ0LCBmWzNdID0gQ3QsIEQuY2xlYXJCdWZmZXJ1aXYoRC5DT0xPUiwgMCwgZikpIDogKHlbMF0gPSBPdCwgeVsxXSA9IEd0LCB5WzJdID0gQnQsIHlbM10gPSBDdCwgRC5jbGVhckJ1ZmZlcml2KEQuQ09MT1IsIDAsIHkpKTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICQgfD0gRC5DT0xPUl9CVUZGRVJfQklUOwogICAgICB9CiAgICAgIEIgJiYgKCQgfD0gRC5ERVBUSF9CVUZGRVJfQklUKSwgcSAmJiAoJCB8PSBELlNURU5DSUxfQlVGRkVSX0JJVCwgdGhpcy5zdGF0ZS5idWZmZXJzLnN0ZW5jaWwuc2V0TWFzayg0Mjk0OTY3Mjk1KSksIEQuY2xlYXIoJCk7CiAgICB9LCB0aGlzLmNsZWFyQ29sb3IgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jbGVhcighMCwgITEsICExKTsKICAgIH0sIHRoaXMuY2xlYXJEZXB0aCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNsZWFyKCExLCAhMCwgITEpOwogICAgfSwgdGhpcy5jbGVhclN0ZW5jaWwgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jbGVhcighMSwgITEsICEwKTsKICAgIH0sIHRoaXMuZGlzcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgICBlLnJlbW92ZUV2ZW50TGlzdGVuZXIoIndlYmdsY29udGV4dGxvc3QiLCBfdCwgITEpLCBlLnJlbW92ZUV2ZW50TGlzdGVuZXIoIndlYmdsY29udGV4dHJlc3RvcmVkIiwgUnQsICExKSwgZS5yZW1vdmVFdmVudExpc3RlbmVyKCJ3ZWJnbGNvbnRleHRjcmVhdGlvbmVycm9yIiwgZHQsICExKSwgZ3QuZGlzcG9zZSgpLCBaLmRpc3Bvc2UoKSwgSXQuZGlzcG9zZSgpLCB1dC5kaXNwb3NlKCksIFd0LmRpc3Bvc2UoKSwgTnQuZGlzcG9zZSgpLCBOLmRpc3Bvc2UoKSwgdnQuZGlzcG9zZSgpLCAkdC5kaXNwb3NlKCksIFguZGlzcG9zZSgpLCBodC5kaXNwb3NlKCksIGh0LnJlbW92ZUV2ZW50TGlzdGVuZXIoInNlc3Npb25zdGFydCIsIGduKSwgaHQucmVtb3ZlRXZlbnRMaXN0ZW5lcigic2Vzc2lvbmVuZCIsIHdmKSwgQnMuc3RvcCgpOwogICAgfTsKICAgIGZ1bmN0aW9uIF90KEMpIHsKICAgICAgQy5wcmV2ZW50RGVmYXVsdCgpLCBjb25zb2xlLmxvZygiVEhSRUUuV2ViR0xSZW5kZXJlcjogQ29udGV4dCBMb3N0LiIpLCBTID0gITA7CiAgICB9CiAgICBmdW5jdGlvbiBSdCgpIHsKICAgICAgY29uc29sZS5sb2coIlRIUkVFLldlYkdMUmVuZGVyZXI6IENvbnRleHQgUmVzdG9yZWQuIiksIFMgPSAhMTsKICAgICAgY29uc3QgQyA9IHl0LmF1dG9SZXNldCwgQiA9IGx0LmVuYWJsZWQsIHEgPSBsdC5hdXRvVXBkYXRlLCAkID0gbHQubmVlZHNVcGRhdGUsIHogPSBsdC50eXBlOwogICAgICBGKCksIHl0LmF1dG9SZXNldCA9IEMsIGx0LmVuYWJsZWQgPSBCLCBsdC5hdXRvVXBkYXRlID0gcSwgbHQubmVlZHNVcGRhdGUgPSAkLCBsdC50eXBlID0gejsKICAgIH0KICAgIGZ1bmN0aW9uIGR0KEMpIHsKICAgICAgY29uc29sZS5lcnJvcigiVEhSRUUuV2ViR0xSZW5kZXJlcjogQSBXZWJHTCBjb250ZXh0IGNvdWxkIG5vdCBiZSBjcmVhdGVkLiBSZWFzb246ICIsIEMuc3RhdHVzTWVzc2FnZSk7CiAgICB9CiAgICBmdW5jdGlvbiBudChDKSB7CiAgICAgIGNvbnN0IEIgPSBDLnRhcmdldDsKICAgICAgQi5yZW1vdmVFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgbnQpLCBGdChCKTsKICAgIH0KICAgIGZ1bmN0aW9uIEZ0KEMpIHsKICAgICAgcXQoQyksIHV0LnJlbW92ZShDKTsKICAgIH0KICAgIGZ1bmN0aW9uIHF0KEMpIHsKICAgICAgY29uc3QgQiA9IHV0LmdldChDKS5wcm9ncmFtczsKICAgICAgQiAhPT0gdm9pZCAwICYmIChCLmZvckVhY2goZnVuY3Rpb24ocSkgewogICAgICAgIFgucmVsZWFzZVByb2dyYW0ocSk7CiAgICAgIH0pLCBDLmlzU2hhZGVyTWF0ZXJpYWwgJiYgWC5yZWxlYXNlU2hhZGVyQ2FjaGUoQykpOwogICAgfQogICAgdGhpcy5yZW5kZXJCdWZmZXJEaXJlY3QgPSBmdW5jdGlvbihDLCBCLCBxLCAkLCB6LCBmdCkgewogICAgICBCID09PSBudWxsICYmIChCID0gUHQpOwogICAgICBjb25zdCBTdCA9IHouaXNNZXNoICYmIHoubWF0cml4V29ybGQuZGV0ZXJtaW5hbnQoKSA8IDAsIER0ID0gbHgoQywgQiwgcSwgJCwgeik7CiAgICAgIEsuc2V0TWF0ZXJpYWwoJCwgU3QpOwogICAgICBsZXQgQ3QgPSBxLmluZGV4LCBPdCA9IDE7CiAgICAgIGlmICgkLndpcmVmcmFtZSA9PT0gITApIHsKICAgICAgICBpZiAoQ3QgPSBBLmdldFdpcmVmcmFtZUF0dHJpYnV0ZShxKSwgQ3QgPT09IHZvaWQgMCkgcmV0dXJuOwogICAgICAgIE90ID0gMjsKICAgICAgfQogICAgICBjb25zdCBHdCA9IHEuZHJhd1JhbmdlLCBCdCA9IHEuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgbGV0IHRlID0gR3Quc3RhcnQgKiBPdCwgcGUgPSAoR3Quc3RhcnQgKyBHdC5jb3VudCkgKiBPdDsKICAgICAgZnQgIT09IG51bGwgJiYgKHRlID0gTWF0aC5tYXgodGUsIGZ0LnN0YXJ0ICogT3QpLCBwZSA9IE1hdGgubWluKHBlLCAoZnQuc3RhcnQgKyBmdC5jb3VudCkgKiBPdCkpLCBDdCAhPT0gbnVsbCA/ICh0ZSA9IE1hdGgubWF4KHRlLCAwKSwgcGUgPSBNYXRoLm1pbihwZSwgQ3QuY291bnQpKSA6IEJ0ICE9IG51bGwgJiYgKHRlID0gTWF0aC5tYXgodGUsIDApLCBwZSA9IE1hdGgubWluKHBlLCBCdC5jb3VudCkpOwogICAgICBjb25zdCBBZSA9IHBlIC0gdGU7CiAgICAgIGlmIChBZSA8IDAgfHwgQWUgPT09IDEgLyAwKSByZXR1cm47CiAgICAgIHZ0LnNldHVwKHosICQsIER0LCBxLCBDdCk7CiAgICAgIGxldCBfZSwgZmUgPSBtdDsKICAgICAgaWYgKEN0ICE9PSBudWxsICYmIChfZSA9IFAuZ2V0KEN0KSwgZmUgPSBBdCwgZmUuc2V0SW5kZXgoX2UpKSwgei5pc01lc2gpCiAgICAgICAgJC53aXJlZnJhbWUgPT09ICEwID8gKEsuc2V0TGluZVdpZHRoKCQud2lyZWZyYW1lTGluZXdpZHRoICogaGUoKSksIGZlLnNldE1vZGUoRC5MSU5FUykpIDogZmUuc2V0TW9kZShELlRSSUFOR0xFUyk7CiAgICAgIGVsc2UgaWYgKHouaXNMaW5lKSB7CiAgICAgICAgbGV0IHp0ID0gJC5saW5ld2lkdGg7CiAgICAgICAgenQgPT09IHZvaWQgMCAmJiAoenQgPSAxKSwgSy5zZXRMaW5lV2lkdGgoenQgKiBoZSgpKSwgei5pc0xpbmVTZWdtZW50cyA/IGZlLnNldE1vZGUoRC5MSU5FUykgOiB6LmlzTGluZUxvb3AgPyBmZS5zZXRNb2RlKEQuTElORV9MT09QKSA6IGZlLnNldE1vZGUoRC5MSU5FX1NUUklQKTsKICAgICAgfSBlbHNlIHouaXNQb2ludHMgPyBmZS5zZXRNb2RlKEQuUE9JTlRTKSA6IHouaXNTcHJpdGUgJiYgZmUuc2V0TW9kZShELlRSSUFOR0xFUyk7CiAgICAgIGlmICh6LmlzQmF0Y2hlZE1lc2gpCiAgICAgICAgaWYgKHouX211bHRpRHJhd0luc3RhbmNlcyAhPT0gbnVsbCkKICAgICAgICAgIFBvKCJUSFJFRS5XZWJHTFJlbmRlcmVyOiByZW5kZXJNdWx0aURyYXdJbnN0YW5jZXMgaGFzIGJlZW4gZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHIxODQuIEFwcGVuZCB0byByZW5kZXJNdWx0aURyYXcgYXJndW1lbnRzIGFuZCB1c2UgaW5kaXJlY3Rpb24uIiksIGZlLnJlbmRlck11bHRpRHJhd0luc3RhbmNlcyh6Ll9tdWx0aURyYXdTdGFydHMsIHouX211bHRpRHJhd0NvdW50cywgei5fbXVsdGlEcmF3Q291bnQsIHouX211bHRpRHJhd0luc3RhbmNlcyk7CiAgICAgICAgZWxzZSBpZiAoaXQuZ2V0KCJXRUJHTF9tdWx0aV9kcmF3IikpCiAgICAgICAgICBmZS5yZW5kZXJNdWx0aURyYXcoei5fbXVsdGlEcmF3U3RhcnRzLCB6Ll9tdWx0aURyYXdDb3VudHMsIHouX211bHRpRHJhd0NvdW50KTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIGNvbnN0IHp0ID0gei5fbXVsdGlEcmF3U3RhcnRzLCBiZSA9IHouX211bHRpRHJhd0NvdW50cywgYWUgPSB6Ll9tdWx0aURyYXdDb3VudCwgQ2kgPSBDdCA/IFAuZ2V0KEN0KS5ieXRlc1BlckVsZW1lbnQgOiAxLCB4ciA9IHV0LmdldCgkKS5jdXJyZW50UHJvZ3JhbS5nZXRVbmlmb3JtcygpOwogICAgICAgICAgZm9yIChsZXQgUmkgPSAwOyBSaSA8IGFlOyBSaSsrKQogICAgICAgICAgICB4ci5zZXRWYWx1ZShELCAiX2dsX0RyYXdJRCIsIFJpKSwgZmUucmVuZGVyKHp0W1JpXSAvIENpLCBiZVtSaV0pOwogICAgICAgIH0KICAgICAgZWxzZSBpZiAoei5pc0luc3RhbmNlZE1lc2gpCiAgICAgICAgZmUucmVuZGVySW5zdGFuY2VzKHRlLCBBZSwgei5jb3VudCk7CiAgICAgIGVsc2UgaWYgKHEuaXNJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHp0ID0gcS5fbWF4SW5zdGFuY2VDb3VudCAhPT0gdm9pZCAwID8gcS5fbWF4SW5zdGFuY2VDb3VudCA6IDEgLyAwLCBiZSA9IE1hdGgubWluKHEuaW5zdGFuY2VDb3VudCwgenQpOwogICAgICAgIGZlLnJlbmRlckluc3RhbmNlcyh0ZSwgQWUsIGJlKTsKICAgICAgfSBlbHNlCiAgICAgICAgZmUucmVuZGVyKHRlLCBBZSk7CiAgICB9OwogICAgZnVuY3Rpb24gZ2UoQywgQiwgcSkgewogICAgICBDLnRyYW5zcGFyZW50ID09PSAhMCAmJiBDLnNpZGUgPT09IE1pICYmIEMuZm9yY2VTaW5nbGVQYXNzID09PSAhMSA/IChDLnNpZGUgPSBIZSwgQy5uZWVkc1VwZGF0ZSA9ICEwLCBZbyhDLCBCLCBxKSwgQy5zaWRlID0gJGksIEMubmVlZHNVcGRhdGUgPSAhMCwgWW8oQywgQiwgcSksIEMuc2lkZSA9IE1pKSA6IFlvKEMsIEIsIHEpOwogICAgfQogICAgdGhpcy5jb21waWxlID0gZnVuY3Rpb24oQywgQiwgcSA9IG51bGwpIHsKICAgICAgcSA9PT0gbnVsbCAmJiAocSA9IEMpLCBtID0gSXQuZ2V0KHEpLCBtLmluaXQoQiksIHgucHVzaChtKSwgcS50cmF2ZXJzZVZpc2libGUoZnVuY3Rpb24oeikgewogICAgICAgIHouaXNMaWdodCAmJiB6LmxheWVycy50ZXN0KEIubGF5ZXJzKSAmJiAobS5wdXNoTGlnaHQoeiksIHouY2FzdFNoYWRvdyAmJiBtLnB1c2hTaGFkb3coeikpOwogICAgICB9KSwgQyAhPT0gcSAmJiBDLnRyYXZlcnNlVmlzaWJsZShmdW5jdGlvbih6KSB7CiAgICAgICAgei5pc0xpZ2h0ICYmIHoubGF5ZXJzLnRlc3QoQi5sYXllcnMpICYmIChtLnB1c2hMaWdodCh6KSwgei5jYXN0U2hhZG93ICYmIG0ucHVzaFNoYWRvdyh6KSk7CiAgICAgIH0pLCBtLnNldHVwTGlnaHRzKCk7CiAgICAgIGNvbnN0ICQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICByZXR1cm4gQy50cmF2ZXJzZShmdW5jdGlvbih6KSB7CiAgICAgICAgaWYgKCEoei5pc01lc2ggfHwgei5pc1BvaW50cyB8fCB6LmlzTGluZSB8fCB6LmlzU3ByaXRlKSkKICAgICAgICAgIHJldHVybjsKICAgICAgICBjb25zdCBmdCA9IHoubWF0ZXJpYWw7CiAgICAgICAgaWYgKGZ0KQogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZnQpKQogICAgICAgICAgICBmb3IgKGxldCBTdCA9IDA7IFN0IDwgZnQubGVuZ3RoOyBTdCsrKSB7CiAgICAgICAgICAgICAgY29uc3QgRHQgPSBmdFtTdF07CiAgICAgICAgICAgICAgZ2UoRHQsIHEsIHopLCAkLmFkZChEdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIGVsc2UKICAgICAgICAgICAgZ2UoZnQsIHEsIHopLCAkLmFkZChmdCk7CiAgICAgIH0pLCBtID0geC5wb3AoKSwgJDsKICAgIH0sIHRoaXMuY29tcGlsZUFzeW5jID0gZnVuY3Rpb24oQywgQiwgcSA9IG51bGwpIHsKICAgICAgY29uc3QgJCA9IHRoaXMuY29tcGlsZShDLCBCLCBxKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCh6KSA9PiB7CiAgICAgICAgZnVuY3Rpb24gZnQoKSB7CiAgICAgICAgICBpZiAoJC5mb3JFYWNoKGZ1bmN0aW9uKFN0KSB7CiAgICAgICAgICAgIHV0LmdldChTdCkuY3VycmVudFByb2dyYW0uaXNSZWFkeSgpICYmICQuZGVsZXRlKFN0KTsKICAgICAgICAgIH0pLCAkLnNpemUgPT09IDApIHsKICAgICAgICAgICAgeihDKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgc2V0VGltZW91dChmdCwgMTApOwogICAgICAgIH0KICAgICAgICBpdC5nZXQoIktIUl9wYXJhbGxlbF9zaGFkZXJfY29tcGlsZSIpICE9PSBudWxsID8gZnQoKSA6IHNldFRpbWVvdXQoZnQsIDEwKTsKICAgICAgfSk7CiAgICB9OwogICAgbGV0IG9lID0gbnVsbDsKICAgIGZ1bmN0aW9uIEluKEMpIHsKICAgICAgb2UgJiYgb2UoQyk7CiAgICB9CiAgICBmdW5jdGlvbiBnbigpIHsKICAgICAgQnMuc3RvcCgpOwogICAgfQogICAgZnVuY3Rpb24gd2YoKSB7CiAgICAgIEJzLnN0YXJ0KCk7CiAgICB9CiAgICBjb25zdCBCcyA9IG5ldyBNXygpOwogICAgQnMuc2V0QW5pbWF0aW9uTG9vcChJbiksIHR5cGVvZiBzZWxmIDwgInUiICYmIEJzLnNldENvbnRleHQoc2VsZiksIHRoaXMuc2V0QW5pbWF0aW9uTG9vcCA9IGZ1bmN0aW9uKEMpIHsKICAgICAgb2UgPSBDLCBodC5zZXRBbmltYXRpb25Mb29wKEMpLCBDID09PSBudWxsID8gQnMuc3RvcCgpIDogQnMuc3RhcnQoKTsKICAgIH0sIGh0LmFkZEV2ZW50TGlzdGVuZXIoInNlc3Npb25zdGFydCIsIGduKSwgaHQuYWRkRXZlbnRMaXN0ZW5lcigic2Vzc2lvbmVuZCIsIHdmKSwgdGhpcy5yZW5kZXIgPSBmdW5jdGlvbihDLCBCKSB7CiAgICAgIGlmIChCICE9PSB2b2lkIDAgJiYgQi5pc0NhbWVyYSAhPT0gITApIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFJlbmRlcmVyLnJlbmRlcjogY2FtZXJhIGlzIG5vdCBhbiBpbnN0YW5jZSBvZiBUSFJFRS5DYW1lcmEuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChTID09PSAhMCkgcmV0dXJuOwogICAgICBpZiAoQy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09ICEwICYmIEMudXBkYXRlTWF0cml4V29ybGQoKSwgQi5wYXJlbnQgPT09IG51bGwgJiYgQi5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09ICEwICYmIEIudXBkYXRlTWF0cml4V29ybGQoKSwgaHQuZW5hYmxlZCA9PT0gITAgJiYgaHQuaXNQcmVzZW50aW5nID09PSAhMCAmJiAoaHQuY2FtZXJhQXV0b1VwZGF0ZSA9PT0gITAgJiYgaHQudXBkYXRlQ2FtZXJhKEIpLCBCID0gaHQuZ2V0Q2FtZXJhKCkpLCBDLmlzU2NlbmUgPT09ICEwICYmIEMub25CZWZvcmVSZW5kZXIoXywgQywgQiwgUiksIG0gPSBJdC5nZXQoQywgeC5sZW5ndGgpLCBtLmluaXQoQiksIHgucHVzaChtKSwgc3QubXVsdGlwbHlNYXRyaWNlcyhCLnByb2plY3Rpb25NYXRyaXgsIEIubWF0cml4V29ybGRJbnZlcnNlKSwgbmUuc2V0RnJvbVByb2plY3Rpb25NYXRyaXgoc3QsIE5pLCBCLnJldmVyc2VkRGVwdGgpLCBZID0gdGhpcy5sb2NhbENsaXBwaW5nRW5hYmxlZCwgSnQgPSBJLmluaXQodGhpcy5jbGlwcGluZ1BsYW5lcywgWSksIGcgPSBaLmdldChDLCB2Lmxlbmd0aCksIGcuaW5pdCgpLCB2LnB1c2goZyksIGh0LmVuYWJsZWQgPT09ICEwICYmIGh0LmlzUHJlc2VudGluZyA9PT0gITApIHsKICAgICAgICBjb25zdCBmdCA9IF8ueHIuZ2V0RGVwdGhTZW5zaW5nTWVzaCgpOwogICAgICAgIGZ0ICE9PSBudWxsICYmIG11KGZ0LCBCLCAtMSAvIDAsIF8uc29ydE9iamVjdHMpOwogICAgICB9CiAgICAgIG11KEMsIEIsIDAsIF8uc29ydE9iamVjdHMpLCBnLmZpbmlzaCgpLCBfLnNvcnRPYmplY3RzID09PSAhMCAmJiBnLnNvcnQoYXQsIHB0KSwgS3QgPSBodC5lbmFibGVkID09PSAhMSB8fCBodC5pc1ByZXNlbnRpbmcgPT09ICExIHx8IGh0Lmhhc0RlcHRoU2Vuc2luZygpID09PSAhMSwgS3QgJiYgZ3QuYWRkVG9SZW5kZXJMaXN0KGcsIEMpLCB0aGlzLmluZm8ucmVuZGVyLmZyYW1lKyssIEp0ID09PSAhMCAmJiBJLmJlZ2luU2hhZG93cygpOwogICAgICBjb25zdCBxID0gbS5zdGF0ZS5zaGFkb3dzQXJyYXk7CiAgICAgIGx0LnJlbmRlcihxLCBDLCBCKSwgSnQgPT09ICEwICYmIEkuZW5kU2hhZG93cygpLCB0aGlzLmluZm8uYXV0b1Jlc2V0ID09PSAhMCAmJiB0aGlzLmluZm8ucmVzZXQoKTsKICAgICAgY29uc3QgJCA9IGcub3BhcXVlLCB6ID0gZy50cmFuc21pc3NpdmU7CiAgICAgIGlmIChtLnNldHVwTGlnaHRzKCksIEIuaXNBcnJheUNhbWVyYSkgewogICAgICAgIGNvbnN0IGZ0ID0gQi5jYW1lcmFzOwogICAgICAgIGlmICh6Lmxlbmd0aCA+IDApCiAgICAgICAgICBmb3IgKGxldCBTdCA9IDAsIER0ID0gZnQubGVuZ3RoOyBTdCA8IER0OyBTdCsrKSB7CiAgICAgICAgICAgIGNvbnN0IEN0ID0gZnRbU3RdOwogICAgICAgICAgICBFZigkLCB6LCBDLCBDdCk7CiAgICAgICAgICB9CiAgICAgICAgS3QgJiYgZ3QucmVuZGVyKEMpOwogICAgICAgIGZvciAobGV0IFN0ID0gMCwgRHQgPSBmdC5sZW5ndGg7IFN0IDwgRHQ7IFN0KyspIHsKICAgICAgICAgIGNvbnN0IEN0ID0gZnRbU3RdOwogICAgICAgICAgQWYoZywgQywgQ3QsIEN0LnZpZXdwb3J0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZQogICAgICAgIHoubGVuZ3RoID4gMCAmJiBFZigkLCB6LCBDLCBCKSwgS3QgJiYgZ3QucmVuZGVyKEMpLCBBZihnLCBDLCBCKTsKICAgICAgUiAhPT0gbnVsbCAmJiBUID09PSAwICYmICh4dC51cGRhdGVNdWx0aXNhbXBsZVJlbmRlclRhcmdldChSKSwgeHQudXBkYXRlUmVuZGVyVGFyZ2V0TWlwbWFwKFIpKSwgQy5pc1NjZW5lID09PSAhMCAmJiBDLm9uQWZ0ZXJSZW5kZXIoXywgQywgQiksIHZ0LnJlc2V0RGVmYXVsdFN0YXRlKCksIGIgPSAtMSwgTSA9IG51bGwsIHgucG9wKCksIHgubGVuZ3RoID4gMCA/IChtID0geFt4Lmxlbmd0aCAtIDFdLCBKdCA9PT0gITAgJiYgSS5zZXRHbG9iYWxTdGF0ZShfLmNsaXBwaW5nUGxhbmVzLCBtLnN0YXRlLmNhbWVyYSkpIDogbSA9IG51bGwsIHYucG9wKCksIHYubGVuZ3RoID4gMCA/IGcgPSB2W3YubGVuZ3RoIC0gMV0gOiBnID0gbnVsbDsKICAgIH07CiAgICBmdW5jdGlvbiBtdShDLCBCLCBxLCAkKSB7CiAgICAgIGlmIChDLnZpc2libGUgPT09ICExKSByZXR1cm47CiAgICAgIGlmIChDLmxheWVycy50ZXN0KEIubGF5ZXJzKSkgewogICAgICAgIGlmIChDLmlzR3JvdXApCiAgICAgICAgICBxID0gQy5yZW5kZXJPcmRlcjsKICAgICAgICBlbHNlIGlmIChDLmlzTE9EKQogICAgICAgICAgQy5hdXRvVXBkYXRlID09PSAhMCAmJiBDLnVwZGF0ZShCKTsKICAgICAgICBlbHNlIGlmIChDLmlzTGlnaHQpCiAgICAgICAgICBtLnB1c2hMaWdodChDKSwgQy5jYXN0U2hhZG93ICYmIG0ucHVzaFNoYWRvdyhDKTsKICAgICAgICBlbHNlIGlmIChDLmlzU3ByaXRlKSB7CiAgICAgICAgICBpZiAoIUMuZnJ1c3R1bUN1bGxlZCB8fCBuZS5pbnRlcnNlY3RzU3ByaXRlKEMpKSB7CiAgICAgICAgICAgICQgJiYgVXQuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKEMubWF0cml4V29ybGQpLmFwcGx5TWF0cml4NChzdCk7CiAgICAgICAgICAgIGNvbnN0IFN0ID0gTi51cGRhdGUoQyksIER0ID0gQy5tYXRlcmlhbDsKICAgICAgICAgICAgRHQudmlzaWJsZSAmJiBnLnB1c2goQywgU3QsIER0LCBxLCBVdC56LCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKChDLmlzTWVzaCB8fCBDLmlzTGluZSB8fCBDLmlzUG9pbnRzKSAmJiAoIUMuZnJ1c3R1bUN1bGxlZCB8fCBuZS5pbnRlcnNlY3RzT2JqZWN0KEMpKSkgewogICAgICAgICAgY29uc3QgU3QgPSBOLnVwZGF0ZShDKSwgRHQgPSBDLm1hdGVyaWFsOwogICAgICAgICAgaWYgKCQgJiYgKEMuYm91bmRpbmdTcGhlcmUgIT09IHZvaWQgMCA/IChDLmJvdW5kaW5nU3BoZXJlID09PSBudWxsICYmIEMuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCksIFV0LmNvcHkoQy5ib3VuZGluZ1NwaGVyZS5jZW50ZXIpKSA6IChTdC5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiBTdC5jb21wdXRlQm91bmRpbmdTcGhlcmUoKSwgVXQuY29weShTdC5ib3VuZGluZ1NwaGVyZS5jZW50ZXIpKSwgVXQuYXBwbHlNYXRyaXg0KEMubWF0cml4V29ybGQpLmFwcGx5TWF0cml4NChzdCkpLCBBcnJheS5pc0FycmF5KER0KSkgewogICAgICAgICAgICBjb25zdCBDdCA9IFN0Lmdyb3VwczsKICAgICAgICAgICAgZm9yIChsZXQgT3QgPSAwLCBHdCA9IEN0Lmxlbmd0aDsgT3QgPCBHdDsgT3QrKykgewogICAgICAgICAgICAgIGNvbnN0IEJ0ID0gQ3RbT3RdLCB0ZSA9IER0W0J0Lm1hdGVyaWFsSW5kZXhdOwogICAgICAgICAgICAgIHRlICYmIHRlLnZpc2libGUgJiYgZy5wdXNoKEMsIFN0LCB0ZSwgcSwgVXQueiwgQnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgRHQudmlzaWJsZSAmJiBnLnB1c2goQywgU3QsIER0LCBxLCBVdC56LCBudWxsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgZnQgPSBDLmNoaWxkcmVuOwogICAgICBmb3IgKGxldCBTdCA9IDAsIER0ID0gZnQubGVuZ3RoOyBTdCA8IER0OyBTdCsrKQogICAgICAgIG11KGZ0W1N0XSwgQiwgcSwgJCk7CiAgICB9CiAgICBmdW5jdGlvbiBBZihDLCBCLCBxLCAkKSB7CiAgICAgIGNvbnN0IHogPSBDLm9wYXF1ZSwgZnQgPSBDLnRyYW5zbWlzc2l2ZSwgU3QgPSBDLnRyYW5zcGFyZW50OwogICAgICBtLnNldHVwTGlnaHRzVmlldyhxKSwgSnQgPT09ICEwICYmIEkuc2V0R2xvYmFsU3RhdGUoXy5jbGlwcGluZ1BsYW5lcywgcSksICQgJiYgSy52aWV3cG9ydChMLmNvcHkoJCkpLCB6Lmxlbmd0aCA+IDAgJiYgWG8oeiwgQiwgcSksIGZ0Lmxlbmd0aCA+IDAgJiYgWG8oZnQsIEIsIHEpLCBTdC5sZW5ndGggPiAwICYmIFhvKFN0LCBCLCBxKSwgSy5idWZmZXJzLmRlcHRoLnNldFRlc3QoITApLCBLLmJ1ZmZlcnMuZGVwdGguc2V0TWFzayghMCksIEsuYnVmZmVycy5jb2xvci5zZXRNYXNrKCEwKSwgSy5zZXRQb2x5Z29uT2Zmc2V0KCExKTsKICAgIH0KICAgIGZ1bmN0aW9uIEVmKEMsIEIsIHEsICQpIHsKICAgICAgaWYgKChxLmlzU2NlbmUgPT09ICEwID8gcS5vdmVycmlkZU1hdGVyaWFsIDogbnVsbCkgIT09IG51bGwpCiAgICAgICAgcmV0dXJuOwogICAgICBtLnN0YXRlLnRyYW5zbWlzc2lvblJlbmRlclRhcmdldFskLmlkXSA9PT0gdm9pZCAwICYmIChtLnN0YXRlLnRyYW5zbWlzc2lvblJlbmRlclRhcmdldFskLmlkXSA9IG5ldyBSbigxLCAxLCB7CiAgICAgICAgZ2VuZXJhdGVNaXBtYXBzOiAhMCwKICAgICAgICB0eXBlOiBpdC5oYXMoIkVYVF9jb2xvcl9idWZmZXJfaGFsZl9mbG9hdCIpIHx8IGl0LmhhcygiRVhUX2NvbG9yX2J1ZmZlcl9mbG9hdCIpID8gd2EgOiBwbiwKICAgICAgICBtaW5GaWx0ZXI6IEVuLAogICAgICAgIHNhbXBsZXM6IDQsCiAgICAgICAgc3RlbmNpbEJ1ZmZlcjogcywKICAgICAgICByZXNvbHZlRGVwdGhCdWZmZXI6ICExLAogICAgICAgIHJlc29sdmVTdGVuY2lsQnVmZmVyOiAhMSwKICAgICAgICBjb2xvclNwYWNlOiBlZS53b3JraW5nQ29sb3JTcGFjZQogICAgICB9KSk7CiAgICAgIGNvbnN0IGZ0ID0gbS5zdGF0ZS50cmFuc21pc3Npb25SZW5kZXJUYXJnZXRbJC5pZF0sIFN0ID0gJC52aWV3cG9ydCB8fCBMOwogICAgICBmdC5zZXRTaXplKFN0LnogKiBfLnRyYW5zbWlzc2lvblJlc29sdXRpb25TY2FsZSwgU3QudyAqIF8udHJhbnNtaXNzaW9uUmVzb2x1dGlvblNjYWxlKTsKICAgICAgY29uc3QgRHQgPSBfLmdldFJlbmRlclRhcmdldCgpLCBDdCA9IF8uZ2V0QWN0aXZlQ3ViZUZhY2UoKSwgT3QgPSBfLmdldEFjdGl2ZU1pcG1hcExldmVsKCk7CiAgICAgIF8uc2V0UmVuZGVyVGFyZ2V0KGZ0KSwgXy5nZXRDbGVhckNvbG9yKFYpLCBXID0gXy5nZXRDbGVhckFscGhhKCksIFcgPCAxICYmIF8uc2V0Q2xlYXJDb2xvcigxNjc3NzIxNSwgMC41KSwgXy5jbGVhcigpLCBLdCAmJiBndC5yZW5kZXIocSk7CiAgICAgIGNvbnN0IEd0ID0gXy50b25lTWFwcGluZzsKICAgICAgXy50b25lTWFwcGluZyA9IFpuOwogICAgICBjb25zdCBCdCA9ICQudmlld3BvcnQ7CiAgICAgIGlmICgkLnZpZXdwb3J0ICE9PSB2b2lkIDAgJiYgKCQudmlld3BvcnQgPSB2b2lkIDApLCBtLnNldHVwTGlnaHRzVmlldygkKSwgSnQgPT09ICEwICYmIEkuc2V0R2xvYmFsU3RhdGUoXy5jbGlwcGluZ1BsYW5lcywgJCksIFhvKEMsIHEsICQpLCB4dC51cGRhdGVNdWx0aXNhbXBsZVJlbmRlclRhcmdldChmdCksIHh0LnVwZGF0ZVJlbmRlclRhcmdldE1pcG1hcChmdCksIGl0LmhhcygiV0VCR0xfbXVsdGlzYW1wbGVkX3JlbmRlcl90b190ZXh0dXJlIikgPT09ICExKSB7CiAgICAgICAgbGV0IHRlID0gITE7CiAgICAgICAgZm9yIChsZXQgcGUgPSAwLCBBZSA9IEIubGVuZ3RoOyBwZSA8IEFlOyBwZSsrKSB7CiAgICAgICAgICBjb25zdCBfZSA9IEJbcGVdLCBmZSA9IF9lLm9iamVjdCwgenQgPSBfZS5nZW9tZXRyeSwgYmUgPSBfZS5tYXRlcmlhbCwgYWUgPSBfZS5ncm91cDsKICAgICAgICAgIGlmIChiZS5zaWRlID09PSBNaSAmJiBmZS5sYXllcnMudGVzdCgkLmxheWVycykpIHsKICAgICAgICAgICAgY29uc3QgQ2kgPSBiZS5zaWRlOwogICAgICAgICAgICBiZS5zaWRlID0gSGUsIGJlLm5lZWRzVXBkYXRlID0gITAsIFRmKGZlLCBxLCAkLCB6dCwgYmUsIGFlKSwgYmUuc2lkZSA9IENpLCBiZS5uZWVkc1VwZGF0ZSA9ICEwLCB0ZSA9ICEwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZSA9PT0gITAgJiYgKHh0LnVwZGF0ZU11bHRpc2FtcGxlUmVuZGVyVGFyZ2V0KGZ0KSwgeHQudXBkYXRlUmVuZGVyVGFyZ2V0TWlwbWFwKGZ0KSk7CiAgICAgIH0KICAgICAgXy5zZXRSZW5kZXJUYXJnZXQoRHQsIEN0LCBPdCksIF8uc2V0Q2xlYXJDb2xvcihWLCBXKSwgQnQgIT09IHZvaWQgMCAmJiAoJC52aWV3cG9ydCA9IEJ0KSwgXy50b25lTWFwcGluZyA9IEd0OwogICAgfQogICAgZnVuY3Rpb24gWG8oQywgQiwgcSkgewogICAgICBjb25zdCAkID0gQi5pc1NjZW5lID09PSAhMCA/IEIub3ZlcnJpZGVNYXRlcmlhbCA6IG51bGw7CiAgICAgIGZvciAobGV0IHogPSAwLCBmdCA9IEMubGVuZ3RoOyB6IDwgZnQ7IHorKykgewogICAgICAgIGNvbnN0IFN0ID0gQ1t6XSwgRHQgPSBTdC5vYmplY3QsIEN0ID0gU3QuZ2VvbWV0cnksIE90ID0gU3QuZ3JvdXA7CiAgICAgICAgbGV0IEd0ID0gU3QubWF0ZXJpYWw7CiAgICAgICAgR3QuYWxsb3dPdmVycmlkZSA9PT0gITAgJiYgJCAhPT0gbnVsbCAmJiAoR3QgPSAkKSwgRHQubGF5ZXJzLnRlc3QocS5sYXllcnMpICYmIFRmKER0LCBCLCBxLCBDdCwgR3QsIE90KTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gVGYoQywgQiwgcSwgJCwgeiwgZnQpIHsKICAgICAgQy5vbkJlZm9yZVJlbmRlcihfLCBCLCBxLCAkLCB6LCBmdCksIEMubW9kZWxWaWV3TWF0cml4Lm11bHRpcGx5TWF0cmljZXMocS5tYXRyaXhXb3JsZEludmVyc2UsIEMubWF0cml4V29ybGQpLCBDLm5vcm1hbE1hdHJpeC5nZXROb3JtYWxNYXRyaXgoQy5tb2RlbFZpZXdNYXRyaXgpLCB6Lm9uQmVmb3JlUmVuZGVyKF8sIEIsIHEsICQsIEMsIGZ0KSwgei50cmFuc3BhcmVudCA9PT0gITAgJiYgei5zaWRlID09PSBNaSAmJiB6LmZvcmNlU2luZ2xlUGFzcyA9PT0gITEgPyAoei5zaWRlID0gSGUsIHoubmVlZHNVcGRhdGUgPSAhMCwgXy5yZW5kZXJCdWZmZXJEaXJlY3QocSwgQiwgJCwgeiwgQywgZnQpLCB6LnNpZGUgPSAkaSwgei5uZWVkc1VwZGF0ZSA9ICEwLCBfLnJlbmRlckJ1ZmZlckRpcmVjdChxLCBCLCAkLCB6LCBDLCBmdCksIHouc2lkZSA9IE1pKSA6IF8ucmVuZGVyQnVmZmVyRGlyZWN0KHEsIEIsICQsIHosIEMsIGZ0KSwgQy5vbkFmdGVyUmVuZGVyKF8sIEIsIHEsICQsIHosIGZ0KTsKICAgIH0KICAgIGZ1bmN0aW9uIFlvKEMsIEIsIHEpIHsKICAgICAgQi5pc1NjZW5lICE9PSAhMCAmJiAoQiA9IFB0KTsKICAgICAgY29uc3QgJCA9IHV0LmdldChDKSwgeiA9IG0uc3RhdGUubGlnaHRzLCBmdCA9IG0uc3RhdGUuc2hhZG93c0FycmF5LCBTdCA9IHouc3RhdGUudmVyc2lvbiwgRHQgPSBYLmdldFBhcmFtZXRlcnMoQywgei5zdGF0ZSwgZnQsIEIsIHEpLCBDdCA9IFguZ2V0UHJvZ3JhbUNhY2hlS2V5KER0KTsKICAgICAgbGV0IE90ID0gJC5wcm9ncmFtczsKICAgICAgJC5lbnZpcm9ubWVudCA9IEMuaXNNZXNoU3RhbmRhcmRNYXRlcmlhbCA/IEIuZW52aXJvbm1lbnQgOiBudWxsLCAkLmZvZyA9IEIuZm9nLCAkLmVudk1hcCA9IChDLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgPyBOdCA6IFd0KS5nZXQoQy5lbnZNYXAgfHwgJC5lbnZpcm9ubWVudCksICQuZW52TWFwUm90YXRpb24gPSAkLmVudmlyb25tZW50ICE9PSBudWxsICYmIEMuZW52TWFwID09PSBudWxsID8gQi5lbnZpcm9ubWVudFJvdGF0aW9uIDogQy5lbnZNYXBSb3RhdGlvbiwgT3QgPT09IHZvaWQgMCAmJiAoQy5hZGRFdmVudExpc3RlbmVyKCJkaXNwb3NlIiwgbnQpLCBPdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksICQucHJvZ3JhbXMgPSBPdCk7CiAgICAgIGxldCBHdCA9IE90LmdldChDdCk7CiAgICAgIGlmIChHdCAhPT0gdm9pZCAwKSB7CiAgICAgICAgaWYgKCQuY3VycmVudFByb2dyYW0gPT09IEd0ICYmICQubGlnaHRzU3RhdGVWZXJzaW9uID09PSBTdCkKICAgICAgICAgIHJldHVybiBSZihDLCBEdCksIEd0OwogICAgICB9IGVsc2UKICAgICAgICBEdC51bmlmb3JtcyA9IFguZ2V0VW5pZm9ybXMoQyksIEMub25CZWZvcmVDb21waWxlKER0LCBfKSwgR3QgPSBYLmFjcXVpcmVQcm9ncmFtKER0LCBDdCksIE90LnNldChDdCwgR3QpLCAkLnVuaWZvcm1zID0gRHQudW5pZm9ybXM7CiAgICAgIGNvbnN0IEJ0ID0gJC51bmlmb3JtczsKICAgICAgcmV0dXJuICghQy5pc1NoYWRlck1hdGVyaWFsICYmICFDLmlzUmF3U2hhZGVyTWF0ZXJpYWwgfHwgQy5jbGlwcGluZyA9PT0gITApICYmIChCdC5jbGlwcGluZ1BsYW5lcyA9IEkudW5pZm9ybSksIFJmKEMsIER0KSwgJC5uZWVkc0xpZ2h0cyA9IGN4KEMpLCAkLmxpZ2h0c1N0YXRlVmVyc2lvbiA9IFN0LCAkLm5lZWRzTGlnaHRzICYmIChCdC5hbWJpZW50TGlnaHRDb2xvci52YWx1ZSA9IHouc3RhdGUuYW1iaWVudCwgQnQubGlnaHRQcm9iZS52YWx1ZSA9IHouc3RhdGUucHJvYmUsIEJ0LmRpcmVjdGlvbmFsTGlnaHRzLnZhbHVlID0gei5zdGF0ZS5kaXJlY3Rpb25hbCwgQnQuZGlyZWN0aW9uYWxMaWdodFNoYWRvd3MudmFsdWUgPSB6LnN0YXRlLmRpcmVjdGlvbmFsU2hhZG93LCBCdC5zcG90TGlnaHRzLnZhbHVlID0gei5zdGF0ZS5zcG90LCBCdC5zcG90TGlnaHRTaGFkb3dzLnZhbHVlID0gei5zdGF0ZS5zcG90U2hhZG93LCBCdC5yZWN0QXJlYUxpZ2h0cy52YWx1ZSA9IHouc3RhdGUucmVjdEFyZWEsIEJ0Lmx0Y18xLnZhbHVlID0gei5zdGF0ZS5yZWN0QXJlYUxUQzEsIEJ0Lmx0Y18yLnZhbHVlID0gei5zdGF0ZS5yZWN0QXJlYUxUQzIsIEJ0LnBvaW50TGlnaHRzLnZhbHVlID0gei5zdGF0ZS5wb2ludCwgQnQucG9pbnRMaWdodFNoYWRvd3MudmFsdWUgPSB6LnN0YXRlLnBvaW50U2hhZG93LCBCdC5oZW1pc3BoZXJlTGlnaHRzLnZhbHVlID0gei5zdGF0ZS5oZW1pLCBCdC5kaXJlY3Rpb25hbFNoYWRvd01hcC52YWx1ZSA9IHouc3RhdGUuZGlyZWN0aW9uYWxTaGFkb3dNYXAsIEJ0LmRpcmVjdGlvbmFsU2hhZG93TWF0cml4LnZhbHVlID0gei5zdGF0ZS5kaXJlY3Rpb25hbFNoYWRvd01hdHJpeCwgQnQuc3BvdFNoYWRvd01hcC52YWx1ZSA9IHouc3RhdGUuc3BvdFNoYWRvd01hcCwgQnQuc3BvdExpZ2h0TWF0cml4LnZhbHVlID0gei5zdGF0ZS5zcG90TGlnaHRNYXRyaXgsIEJ0LnNwb3RMaWdodE1hcC52YWx1ZSA9IHouc3RhdGUuc3BvdExpZ2h0TWFwLCBCdC5wb2ludFNoYWRvd01hcC52YWx1ZSA9IHouc3RhdGUucG9pbnRTaGFkb3dNYXAsIEJ0LnBvaW50U2hhZG93TWF0cml4LnZhbHVlID0gei5zdGF0ZS5wb2ludFNoYWRvd01hdHJpeCksICQuY3VycmVudFByb2dyYW0gPSBHdCwgJC51bmlmb3Jtc0xpc3QgPSBudWxsLCBHdDsKICAgIH0KICAgIGZ1bmN0aW9uIENmKEMpIHsKICAgICAgaWYgKEMudW5pZm9ybXNMaXN0ID09PSBudWxsKSB7CiAgICAgICAgY29uc3QgQiA9IEMuY3VycmVudFByb2dyYW0uZ2V0VW5pZm9ybXMoKTsKICAgICAgICBDLnVuaWZvcm1zTGlzdCA9IENoLnNlcVdpdGhWYWx1ZShCLnNlcSwgQy51bmlmb3Jtcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIEMudW5pZm9ybXNMaXN0OwogICAgfQogICAgZnVuY3Rpb24gUmYoQywgQikgewogICAgICBjb25zdCBxID0gdXQuZ2V0KEMpOwogICAgICBxLm91dHB1dENvbG9yU3BhY2UgPSBCLm91dHB1dENvbG9yU3BhY2UsIHEuYmF0Y2hpbmcgPSBCLmJhdGNoaW5nLCBxLmJhdGNoaW5nQ29sb3IgPSBCLmJhdGNoaW5nQ29sb3IsIHEuaW5zdGFuY2luZyA9IEIuaW5zdGFuY2luZywgcS5pbnN0YW5jaW5nQ29sb3IgPSBCLmluc3RhbmNpbmdDb2xvciwgcS5pbnN0YW5jaW5nTW9ycGggPSBCLmluc3RhbmNpbmdNb3JwaCwgcS5za2lubmluZyA9IEIuc2tpbm5pbmcsIHEubW9ycGhUYXJnZXRzID0gQi5tb3JwaFRhcmdldHMsIHEubW9ycGhOb3JtYWxzID0gQi5tb3JwaE5vcm1hbHMsIHEubW9ycGhDb2xvcnMgPSBCLm1vcnBoQ29sb3JzLCBxLm1vcnBoVGFyZ2V0c0NvdW50ID0gQi5tb3JwaFRhcmdldHNDb3VudCwgcS5udW1DbGlwcGluZ1BsYW5lcyA9IEIubnVtQ2xpcHBpbmdQbGFuZXMsIHEubnVtSW50ZXJzZWN0aW9uID0gQi5udW1DbGlwSW50ZXJzZWN0aW9uLCBxLnZlcnRleEFscGhhcyA9IEIudmVydGV4QWxwaGFzLCBxLnZlcnRleFRhbmdlbnRzID0gQi52ZXJ0ZXhUYW5nZW50cywgcS50b25lTWFwcGluZyA9IEIudG9uZU1hcHBpbmc7CiAgICB9CiAgICBmdW5jdGlvbiBseChDLCBCLCBxLCAkLCB6KSB7CiAgICAgIEIuaXNTY2VuZSAhPT0gITAgJiYgKEIgPSBQdCksIHh0LnJlc2V0VGV4dHVyZVVuaXRzKCk7CiAgICAgIGNvbnN0IGZ0ID0gQi5mb2csIFN0ID0gJC5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID8gQi5lbnZpcm9ubWVudCA6IG51bGwsIER0ID0gUiA9PT0gbnVsbCA/IF8ub3V0cHV0Q29sb3JTcGFjZSA6IFIuaXNYUlJlbmRlclRhcmdldCA9PT0gITAgPyBSLnRleHR1cmUuY29sb3JTcGFjZSA6IENzLCBDdCA9ICgkLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgPyBOdCA6IFd0KS5nZXQoJC5lbnZNYXAgfHwgU3QpLCBPdCA9ICQudmVydGV4Q29sb3JzID09PSAhMCAmJiAhIXEuYXR0cmlidXRlcy5jb2xvciAmJiBxLmF0dHJpYnV0ZXMuY29sb3IuaXRlbVNpemUgPT09IDQsIEd0ID0gISFxLmF0dHJpYnV0ZXMudGFuZ2VudCAmJiAoISEkLm5vcm1hbE1hcCB8fCAkLmFuaXNvdHJvcHkgPiAwKSwgQnQgPSAhIXEubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uLCB0ZSA9ICEhcS5tb3JwaEF0dHJpYnV0ZXMubm9ybWFsLCBwZSA9ICEhcS5tb3JwaEF0dHJpYnV0ZXMuY29sb3I7CiAgICAgIGxldCBBZSA9IFpuOwogICAgICAkLnRvbmVNYXBwZWQgJiYgKFIgPT09IG51bGwgfHwgUi5pc1hSUmVuZGVyVGFyZ2V0ID09PSAhMCkgJiYgKEFlID0gXy50b25lTWFwcGluZyk7CiAgICAgIGNvbnN0IF9lID0gcS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24gfHwgcS5tb3JwaEF0dHJpYnV0ZXMubm9ybWFsIHx8IHEubW9ycGhBdHRyaWJ1dGVzLmNvbG9yLCBmZSA9IF9lICE9PSB2b2lkIDAgPyBfZS5sZW5ndGggOiAwLCB6dCA9IHV0LmdldCgkKSwgYmUgPSBtLnN0YXRlLmxpZ2h0czsKICAgICAgaWYgKEp0ID09PSAhMCAmJiAoWSA9PT0gITAgfHwgQyAhPT0gTSkpIHsKICAgICAgICBjb25zdCBjaSA9IEMgPT09IE0gJiYgJC5pZCA9PT0gYjsKICAgICAgICBJLnNldFN0YXRlKCQsIEMsIGNpKTsKICAgICAgfQogICAgICBsZXQgYWUgPSAhMTsKICAgICAgJC52ZXJzaW9uID09PSB6dC5fX3ZlcnNpb24gPyAoenQubmVlZHNMaWdodHMgJiYgenQubGlnaHRzU3RhdGVWZXJzaW9uICE9PSBiZS5zdGF0ZS52ZXJzaW9uIHx8IHp0Lm91dHB1dENvbG9yU3BhY2UgIT09IER0IHx8IHouaXNCYXRjaGVkTWVzaCAmJiB6dC5iYXRjaGluZyA9PT0gITEgfHwgIXouaXNCYXRjaGVkTWVzaCAmJiB6dC5iYXRjaGluZyA9PT0gITAgfHwgei5pc0JhdGNoZWRNZXNoICYmIHp0LmJhdGNoaW5nQ29sb3IgPT09ICEwICYmIHouY29sb3JUZXh0dXJlID09PSBudWxsIHx8IHouaXNCYXRjaGVkTWVzaCAmJiB6dC5iYXRjaGluZ0NvbG9yID09PSAhMSAmJiB6LmNvbG9yVGV4dHVyZSAhPT0gbnVsbCB8fCB6LmlzSW5zdGFuY2VkTWVzaCAmJiB6dC5pbnN0YW5jaW5nID09PSAhMSB8fCAhei5pc0luc3RhbmNlZE1lc2ggJiYgenQuaW5zdGFuY2luZyA9PT0gITAgfHwgei5pc1NraW5uZWRNZXNoICYmIHp0LnNraW5uaW5nID09PSAhMSB8fCAhei5pc1NraW5uZWRNZXNoICYmIHp0LnNraW5uaW5nID09PSAhMCB8fCB6LmlzSW5zdGFuY2VkTWVzaCAmJiB6dC5pbnN0YW5jaW5nQ29sb3IgPT09ICEwICYmIHouaW5zdGFuY2VDb2xvciA9PT0gbnVsbCB8fCB6LmlzSW5zdGFuY2VkTWVzaCAmJiB6dC5pbnN0YW5jaW5nQ29sb3IgPT09ICExICYmIHouaW5zdGFuY2VDb2xvciAhPT0gbnVsbCB8fCB6LmlzSW5zdGFuY2VkTWVzaCAmJiB6dC5pbnN0YW5jaW5nTW9ycGggPT09ICEwICYmIHoubW9ycGhUZXh0dXJlID09PSBudWxsIHx8IHouaXNJbnN0YW5jZWRNZXNoICYmIHp0Lmluc3RhbmNpbmdNb3JwaCA9PT0gITEgJiYgei5tb3JwaFRleHR1cmUgIT09IG51bGwgfHwgenQuZW52TWFwICE9PSBDdCB8fCAkLmZvZyA9PT0gITAgJiYgenQuZm9nICE9PSBmdCB8fCB6dC5udW1DbGlwcGluZ1BsYW5lcyAhPT0gdm9pZCAwICYmICh6dC5udW1DbGlwcGluZ1BsYW5lcyAhPT0gSS5udW1QbGFuZXMgfHwgenQubnVtSW50ZXJzZWN0aW9uICE9PSBJLm51bUludGVyc2VjdGlvbikgfHwgenQudmVydGV4QWxwaGFzICE9PSBPdCB8fCB6dC52ZXJ0ZXhUYW5nZW50cyAhPT0gR3QgfHwgenQubW9ycGhUYXJnZXRzICE9PSBCdCB8fCB6dC5tb3JwaE5vcm1hbHMgIT09IHRlIHx8IHp0Lm1vcnBoQ29sb3JzICE9PSBwZSB8fCB6dC50b25lTWFwcGluZyAhPT0gQWUgfHwgenQubW9ycGhUYXJnZXRzQ291bnQgIT09IGZlKSAmJiAoYWUgPSAhMCkgOiAoYWUgPSAhMCwgenQuX192ZXJzaW9uID0gJC52ZXJzaW9uKTsKICAgICAgbGV0IENpID0genQuY3VycmVudFByb2dyYW07CiAgICAgIGFlID09PSAhMCAmJiAoQ2kgPSBZbygkLCBCLCB6KSk7CiAgICAgIGxldCB4ciA9ICExLCBSaSA9ICExLCBVYSA9ICExOwogICAgICBjb25zdCBNZSA9IENpLmdldFVuaWZvcm1zKCksIGtpID0genQudW5pZm9ybXM7CiAgICAgIGlmIChLLnVzZVByb2dyYW0oQ2kucHJvZ3JhbSkgJiYgKHhyID0gITAsIFJpID0gITAsIFVhID0gITApLCAkLmlkICE9PSBiICYmIChiID0gJC5pZCwgUmkgPSAhMCksIHhyIHx8IE0gIT09IEMpIHsKICAgICAgICBLLmJ1ZmZlcnMuZGVwdGguZ2V0UmV2ZXJzZWQoKSAmJiBDLnJldmVyc2VkRGVwdGggIT09ICEwICYmIChDLl9yZXZlcnNlZERlcHRoID0gITAsIEMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpKSwgTWUuc2V0VmFsdWUoRCwgInByb2plY3Rpb25NYXRyaXgiLCBDLnByb2plY3Rpb25NYXRyaXgpLCBNZS5zZXRWYWx1ZShELCAidmlld01hdHJpeCIsIEMubWF0cml4V29ybGRJbnZlcnNlKTsKICAgICAgICBjb25zdCB4aSA9IE1lLm1hcC5jYW1lcmFQb3NpdGlvbjsKICAgICAgICB4aSAhPT0gdm9pZCAwICYmIHhpLnNldFZhbHVlKEQsIEV0LnNldEZyb21NYXRyaXhQb3NpdGlvbihDLm1hdHJpeFdvcmxkKSksIFEubG9nYXJpdGhtaWNEZXB0aEJ1ZmZlciAmJiBNZS5zZXRWYWx1ZSgKICAgICAgICAgIEQsCiAgICAgICAgICAibG9nRGVwdGhCdWZGQyIsCiAgICAgICAgICAyIC8gKE1hdGgubG9nKEMuZmFyICsgMSkgLyBNYXRoLkxOMikKICAgICAgICApLCAoJC5pc01lc2hQaG9uZ01hdGVyaWFsIHx8ICQuaXNNZXNoVG9vbk1hdGVyaWFsIHx8ICQuaXNNZXNoTGFtYmVydE1hdGVyaWFsIHx8ICQuaXNNZXNoQmFzaWNNYXRlcmlhbCB8fCAkLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgfHwgJC5pc1NoYWRlck1hdGVyaWFsKSAmJiBNZS5zZXRWYWx1ZShELCAiaXNPcnRob2dyYXBoaWMiLCBDLmlzT3J0aG9ncmFwaGljQ2FtZXJhID09PSAhMCksIE0gIT09IEMgJiYgKE0gPSBDLCBSaSA9ICEwLCBVYSA9ICEwKTsKICAgICAgfQogICAgICBpZiAoei5pc1NraW5uZWRNZXNoKSB7CiAgICAgICAgTWUuc2V0T3B0aW9uYWwoRCwgeiwgImJpbmRNYXRyaXgiKSwgTWUuc2V0T3B0aW9uYWwoRCwgeiwgImJpbmRNYXRyaXhJbnZlcnNlIik7CiAgICAgICAgY29uc3QgY2kgPSB6LnNrZWxldG9uOwogICAgICAgIGNpICYmIChjaS5ib25lVGV4dHVyZSA9PT0gbnVsbCAmJiBjaS5jb21wdXRlQm9uZVRleHR1cmUoKSwgTWUuc2V0VmFsdWUoRCwgImJvbmVUZXh0dXJlIiwgY2kuYm9uZVRleHR1cmUsIHh0KSk7CiAgICAgIH0KICAgICAgei5pc0JhdGNoZWRNZXNoICYmIChNZS5zZXRPcHRpb25hbChELCB6LCAiYmF0Y2hpbmdUZXh0dXJlIiksIE1lLnNldFZhbHVlKEQsICJiYXRjaGluZ1RleHR1cmUiLCB6Ll9tYXRyaWNlc1RleHR1cmUsIHh0KSwgTWUuc2V0T3B0aW9uYWwoRCwgeiwgImJhdGNoaW5nSWRUZXh0dXJlIiksIE1lLnNldFZhbHVlKEQsICJiYXRjaGluZ0lkVGV4dHVyZSIsIHouX2luZGlyZWN0VGV4dHVyZSwgeHQpLCBNZS5zZXRPcHRpb25hbChELCB6LCAiYmF0Y2hpbmdDb2xvclRleHR1cmUiKSwgei5fY29sb3JzVGV4dHVyZSAhPT0gbnVsbCAmJiBNZS5zZXRWYWx1ZShELCAiYmF0Y2hpbmdDb2xvclRleHR1cmUiLCB6Ll9jb2xvcnNUZXh0dXJlLCB4dCkpOwogICAgICBjb25zdCBWaSA9IHEubW9ycGhBdHRyaWJ1dGVzOwogICAgICBpZiAoKFZpLnBvc2l0aW9uICE9PSB2b2lkIDAgfHwgVmkubm9ybWFsICE9PSB2b2lkIDAgfHwgVmkuY29sb3IgIT09IHZvaWQgMCkgJiYgai51cGRhdGUoeiwgcSwgQ2kpLCAoUmkgfHwgenQucmVjZWl2ZVNoYWRvdyAhPT0gei5yZWNlaXZlU2hhZG93KSAmJiAoenQucmVjZWl2ZVNoYWRvdyA9IHoucmVjZWl2ZVNoYWRvdywgTWUuc2V0VmFsdWUoRCwgInJlY2VpdmVTaGFkb3ciLCB6LnJlY2VpdmVTaGFkb3cpKSwgJC5pc01lc2hHb3VyYXVkTWF0ZXJpYWwgJiYgJC5lbnZNYXAgIT09IG51bGwgJiYgKGtpLmVudk1hcC52YWx1ZSA9IEN0LCBraS5mbGlwRW52TWFwLnZhbHVlID0gQ3QuaXNDdWJlVGV4dHVyZSAmJiBDdC5pc1JlbmRlclRhcmdldFRleHR1cmUgPT09ICExID8gLTEgOiAxKSwgJC5pc01lc2hTdGFuZGFyZE1hdGVyaWFsICYmICQuZW52TWFwID09PSBudWxsICYmIEIuZW52aXJvbm1lbnQgIT09IG51bGwgJiYgKGtpLmVudk1hcEludGVuc2l0eS52YWx1ZSA9IEIuZW52aXJvbm1lbnRJbnRlbnNpdHkpLCBSaSAmJiAoTWUuc2V0VmFsdWUoRCwgInRvbmVNYXBwaW5nRXhwb3N1cmUiLCBfLnRvbmVNYXBwaW5nRXhwb3N1cmUpLCB6dC5uZWVkc0xpZ2h0cyAmJiBoeChraSwgVWEpLCBmdCAmJiAkLmZvZyA9PT0gITAgJiYgcnQucmVmcmVzaEZvZ1VuaWZvcm1zKGtpLCBmdCksIHJ0LnJlZnJlc2hNYXRlcmlhbFVuaWZvcm1zKGtpLCAkLCBILCBldCwgbS5zdGF0ZS50cmFuc21pc3Npb25SZW5kZXJUYXJnZXRbQy5pZF0pLCBDaC51cGxvYWQoRCwgQ2YoenQpLCBraSwgeHQpKSwgJC5pc1NoYWRlck1hdGVyaWFsICYmICQudW5pZm9ybXNOZWVkVXBkYXRlID09PSAhMCAmJiAoQ2gudXBsb2FkKEQsIENmKHp0KSwga2ksIHh0KSwgJC51bmlmb3Jtc05lZWRVcGRhdGUgPSAhMSksICQuaXNTcHJpdGVNYXRlcmlhbCAmJiBNZS5zZXRWYWx1ZShELCAiY2VudGVyIiwgei5jZW50ZXIpLCBNZS5zZXRWYWx1ZShELCAibW9kZWxWaWV3TWF0cml4Iiwgei5tb2RlbFZpZXdNYXRyaXgpLCBNZS5zZXRWYWx1ZShELCAibm9ybWFsTWF0cml4Iiwgei5ub3JtYWxNYXRyaXgpLCBNZS5zZXRWYWx1ZShELCAibW9kZWxNYXRyaXgiLCB6Lm1hdHJpeFdvcmxkKSwgJC5pc1NoYWRlck1hdGVyaWFsIHx8ICQuaXNSYXdTaGFkZXJNYXRlcmlhbCkgewogICAgICAgIGNvbnN0IGNpID0gJC51bmlmb3Jtc0dyb3VwczsKICAgICAgICBmb3IgKGxldCB4aSA9IDAsIGd1ID0gY2kubGVuZ3RoOyB4aSA8IGd1OyB4aSsrKSB7CiAgICAgICAgICBjb25zdCB6cyA9IGNpW3hpXTsKICAgICAgICAgICR0LnVwZGF0ZSh6cywgQ2kpLCAkdC5iaW5kKHpzLCBDaSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBDaTsKICAgIH0KICAgIGZ1bmN0aW9uIGh4KEMsIEIpIHsKICAgICAgQy5hbWJpZW50TGlnaHRDb2xvci5uZWVkc1VwZGF0ZSA9IEIsIEMubGlnaHRQcm9iZS5uZWVkc1VwZGF0ZSA9IEIsIEMuZGlyZWN0aW9uYWxMaWdodHMubmVlZHNVcGRhdGUgPSBCLCBDLmRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzLm5lZWRzVXBkYXRlID0gQiwgQy5wb2ludExpZ2h0cy5uZWVkc1VwZGF0ZSA9IEIsIEMucG9pbnRMaWdodFNoYWRvd3MubmVlZHNVcGRhdGUgPSBCLCBDLnNwb3RMaWdodHMubmVlZHNVcGRhdGUgPSBCLCBDLnNwb3RMaWdodFNoYWRvd3MubmVlZHNVcGRhdGUgPSBCLCBDLnJlY3RBcmVhTGlnaHRzLm5lZWRzVXBkYXRlID0gQiwgQy5oZW1pc3BoZXJlTGlnaHRzLm5lZWRzVXBkYXRlID0gQjsKICAgIH0KICAgIGZ1bmN0aW9uIGN4KEMpIHsKICAgICAgcmV0dXJuIEMuaXNNZXNoTGFtYmVydE1hdGVyaWFsIHx8IEMuaXNNZXNoVG9vbk1hdGVyaWFsIHx8IEMuaXNNZXNoUGhvbmdNYXRlcmlhbCB8fCBDLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgfHwgQy5pc1NoYWRvd01hdGVyaWFsIHx8IEMuaXNTaGFkZXJNYXRlcmlhbCAmJiBDLmxpZ2h0cyA9PT0gITA7CiAgICB9CiAgICB0aGlzLmdldEFjdGl2ZUN1YmVGYWNlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB3OwogICAgfSwgdGhpcy5nZXRBY3RpdmVNaXBtYXBMZXZlbCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVDsKICAgIH0sIHRoaXMuZ2V0UmVuZGVyVGFyZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBSOwogICAgfSwgdGhpcy5zZXRSZW5kZXJUYXJnZXRUZXh0dXJlcyA9IGZ1bmN0aW9uKEMsIEIsIHEpIHsKICAgICAgY29uc3QgJCA9IHV0LmdldChDKTsKICAgICAgJC5fX2F1dG9BbGxvY2F0ZURlcHRoQnVmZmVyID0gQy5yZXNvbHZlRGVwdGhCdWZmZXIgPT09ICExLCAkLl9fYXV0b0FsbG9jYXRlRGVwdGhCdWZmZXIgPT09ICExICYmICgkLl9fdXNlUmVuZGVyVG9UZXh0dXJlID0gITEpLCB1dC5nZXQoQy50ZXh0dXJlKS5fX3dlYmdsVGV4dHVyZSA9IEIsIHV0LmdldChDLmRlcHRoVGV4dHVyZSkuX193ZWJnbFRleHR1cmUgPSAkLl9fYXV0b0FsbG9jYXRlRGVwdGhCdWZmZXIgPyB2b2lkIDAgOiBxLCAkLl9faGFzRXh0ZXJuYWxUZXh0dXJlcyA9ICEwOwogICAgfSwgdGhpcy5zZXRSZW5kZXJUYXJnZXRGcmFtZWJ1ZmZlciA9IGZ1bmN0aW9uKEMsIEIpIHsKICAgICAgY29uc3QgcSA9IHV0LmdldChDKTsKICAgICAgcS5fX3dlYmdsRnJhbWVidWZmZXIgPSBCLCBxLl9fdXNlRGVmYXVsdEZyYW1lYnVmZmVyID0gQiA9PT0gdm9pZCAwOwogICAgfTsKICAgIGNvbnN0IHV4ID0gRC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwogICAgdGhpcy5zZXRSZW5kZXJUYXJnZXQgPSBmdW5jdGlvbihDLCBCID0gMCwgcSA9IDApIHsKICAgICAgUiA9IEMsIHcgPSBCLCBUID0gcTsKICAgICAgbGV0ICQgPSAhMCwgeiA9IG51bGwsIGZ0ID0gITEsIFN0ID0gITE7CiAgICAgIGlmIChDKSB7CiAgICAgICAgY29uc3QgQ3QgPSB1dC5nZXQoQyk7CiAgICAgICAgaWYgKEN0Ll9fdXNlRGVmYXVsdEZyYW1lYnVmZmVyICE9PSB2b2lkIDApCiAgICAgICAgICBLLmJpbmRGcmFtZWJ1ZmZlcihELkZSQU1FQlVGRkVSLCBudWxsKSwgJCA9ICExOwogICAgICAgIGVsc2UgaWYgKEN0Ll9fd2ViZ2xGcmFtZWJ1ZmZlciA9PT0gdm9pZCAwKQogICAgICAgICAgeHQuc2V0dXBSZW5kZXJUYXJnZXQoQyk7CiAgICAgICAgZWxzZSBpZiAoQ3QuX19oYXNFeHRlcm5hbFRleHR1cmVzKQogICAgICAgICAgeHQucmViaW5kVGV4dHVyZXMoQywgdXQuZ2V0KEMudGV4dHVyZSkuX193ZWJnbFRleHR1cmUsIHV0LmdldChDLmRlcHRoVGV4dHVyZSkuX193ZWJnbFRleHR1cmUpOwogICAgICAgIGVsc2UgaWYgKEMuZGVwdGhCdWZmZXIpIHsKICAgICAgICAgIGNvbnN0IEJ0ID0gQy5kZXB0aFRleHR1cmU7CiAgICAgICAgICBpZiAoQ3QuX19ib3VuZERlcHRoVGV4dHVyZSAhPT0gQnQpIHsKICAgICAgICAgICAgaWYgKEJ0ICE9PSBudWxsICYmIHV0LmhhcyhCdCkgJiYgKEMud2lkdGggIT09IEJ0LmltYWdlLndpZHRoIHx8IEMuaGVpZ2h0ICE9PSBCdC5pbWFnZS5oZWlnaHQpKQogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViR0xSZW5kZXJUYXJnZXQ6IEF0dGFjaGVkIERlcHRoVGV4dHVyZSBpcyBpbml0aWFsaXplZCB0byB0aGUgaW5jb3JyZWN0IHNpemUuIik7CiAgICAgICAgICAgIHh0LnNldHVwRGVwdGhSZW5kZXJidWZmZXIoQyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IE90ID0gQy50ZXh0dXJlOwogICAgICAgIChPdC5pc0RhdGEzRFRleHR1cmUgfHwgT3QuaXNEYXRhQXJyYXlUZXh0dXJlIHx8IE90LmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSkgJiYgKFN0ID0gITApOwogICAgICAgIGNvbnN0IEd0ID0gdXQuZ2V0KEMpLl9fd2ViZ2xGcmFtZWJ1ZmZlcjsKICAgICAgICBDLmlzV2ViR0xDdWJlUmVuZGVyVGFyZ2V0ID8gKEFycmF5LmlzQXJyYXkoR3RbQl0pID8geiA9IEd0W0JdW3FdIDogeiA9IEd0W0JdLCBmdCA9ICEwKSA6IEMuc2FtcGxlcyA+IDAgJiYgeHQudXNlTXVsdGlzYW1wbGVkUlRUKEMpID09PSAhMSA/IHogPSB1dC5nZXQoQykuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyIDogQXJyYXkuaXNBcnJheShHdCkgPyB6ID0gR3RbcV0gOiB6ID0gR3QsIEwuY29weShDLnZpZXdwb3J0KSwgVS5jb3B5KEMuc2Npc3NvciksIE8gPSBDLnNjaXNzb3JUZXN0OwogICAgICB9IGVsc2UKICAgICAgICBMLmNvcHkoTXQpLm11bHRpcGx5U2NhbGFyKEgpLmZsb29yKCksIFUuY29weShMdCkubXVsdGlwbHlTY2FsYXIoSCkuZmxvb3IoKSwgTyA9IGp0OwogICAgICBpZiAocSAhPT0gMCAmJiAoeiA9IHV4KSwgSy5iaW5kRnJhbWVidWZmZXIoRC5GUkFNRUJVRkZFUiwgeikgJiYgJCAmJiBLLmRyYXdCdWZmZXJzKEMsIHopLCBLLnZpZXdwb3J0KEwpLCBLLnNjaXNzb3IoVSksIEsuc2V0U2Npc3NvclRlc3QoTyksIGZ0KSB7CiAgICAgICAgY29uc3QgQ3QgPSB1dC5nZXQoQy50ZXh0dXJlKTsKICAgICAgICBELmZyYW1lYnVmZmVyVGV4dHVyZTJEKEQuRlJBTUVCVUZGRVIsIEQuQ09MT1JfQVRUQUNITUVOVDAsIEQuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgQiwgQ3QuX193ZWJnbFRleHR1cmUsIHEpOwogICAgICB9IGVsc2UgaWYgKFN0KSB7CiAgICAgICAgY29uc3QgQ3QgPSBCOwogICAgICAgIGZvciAobGV0IE90ID0gMDsgT3QgPCBDLnRleHR1cmVzLmxlbmd0aDsgT3QrKykgewogICAgICAgICAgY29uc3QgR3QgPSB1dC5nZXQoQy50ZXh0dXJlc1tPdF0pOwogICAgICAgICAgRC5mcmFtZWJ1ZmZlclRleHR1cmVMYXllcihELkZSQU1FQlVGRkVSLCBELkNPTE9SX0FUVEFDSE1FTlQwICsgT3QsIEd0Ll9fd2ViZ2xUZXh0dXJlLCBxLCBDdCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKEMgIT09IG51bGwgJiYgcSAhPT0gMCkgewogICAgICAgIGNvbnN0IEN0ID0gdXQuZ2V0KEMudGV4dHVyZSk7CiAgICAgICAgRC5mcmFtZWJ1ZmZlclRleHR1cmUyRChELkZSQU1FQlVGRkVSLCBELkNPTE9SX0FUVEFDSE1FTlQwLCBELlRFWFRVUkVfMkQsIEN0Ll9fd2ViZ2xUZXh0dXJlLCBxKTsKICAgICAgfQogICAgICBiID0gLTE7CiAgICB9LCB0aGlzLnJlYWRSZW5kZXJUYXJnZXRQaXhlbHMgPSBmdW5jdGlvbihDLCBCLCBxLCAkLCB6LCBmdCwgU3QsIER0ID0gMCkgewogICAgICBpZiAoIShDICYmIEMuaXNXZWJHTFJlbmRlclRhcmdldCkpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFJlbmRlcmVyLnJlYWRSZW5kZXJUYXJnZXRQaXhlbHM6IHJlbmRlclRhcmdldCBpcyBub3QgVEhSRUUuV2ViR0xSZW5kZXJUYXJnZXQuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGxldCBDdCA9IHV0LmdldChDKS5fX3dlYmdsRnJhbWVidWZmZXI7CiAgICAgIGlmIChDLmlzV2ViR0xDdWJlUmVuZGVyVGFyZ2V0ICYmIFN0ICE9PSB2b2lkIDAgJiYgKEN0ID0gQ3RbU3RdKSwgQ3QpIHsKICAgICAgICBLLmJpbmRGcmFtZWJ1ZmZlcihELkZSQU1FQlVGRkVSLCBDdCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IE90ID0gQy50ZXh0dXJlc1tEdF0sIEd0ID0gT3QuZm9ybWF0LCBCdCA9IE90LnR5cGU7CiAgICAgICAgICBpZiAoIVEudGV4dHVyZUZvcm1hdFJlYWRhYmxlKEd0KSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5XZWJHTFJlbmRlcmVyLnJlYWRSZW5kZXJUYXJnZXRQaXhlbHM6IHJlbmRlclRhcmdldCBpcyBub3QgaW4gUkdCQSBvciBpbXBsZW1lbnRhdGlvbiBkZWZpbmVkIGZvcm1hdC4iKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFRLnRleHR1cmVUeXBlUmVhZGFibGUoQnQpKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLldlYkdMUmVuZGVyZXIucmVhZFJlbmRlclRhcmdldFBpeGVsczogcmVuZGVyVGFyZ2V0IGlzIG5vdCBpbiBVbnNpZ25lZEJ5dGVUeXBlIG9yIGltcGxlbWVudGF0aW9uIGRlZmluZWQgdHlwZS4iKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgQiA+PSAwICYmIEIgPD0gQy53aWR0aCAtICQgJiYgcSA+PSAwICYmIHEgPD0gQy5oZWlnaHQgLSB6ICYmIChDLnRleHR1cmVzLmxlbmd0aCA+IDEgJiYgRC5yZWFkQnVmZmVyKEQuQ09MT1JfQVRUQUNITUVOVDAgKyBEdCksIEQucmVhZFBpeGVscyhCLCBxLCAkLCB6LCBUdC5jb252ZXJ0KEd0KSwgVHQuY29udmVydChCdCksIGZ0KSk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGNvbnN0IE90ID0gUiAhPT0gbnVsbCA/IHV0LmdldChSKS5fX3dlYmdsRnJhbWVidWZmZXIgOiBudWxsOwogICAgICAgICAgSy5iaW5kRnJhbWVidWZmZXIoRC5GUkFNRUJVRkZFUiwgT3QpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgdGhpcy5yZWFkUmVuZGVyVGFyZ2V0UGl4ZWxzQXN5bmMgPSBhc3luYyBmdW5jdGlvbihDLCBCLCBxLCAkLCB6LCBmdCwgU3QsIER0ID0gMCkgewogICAgICBpZiAoIShDICYmIEMuaXNXZWJHTFJlbmRlclRhcmdldCkpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5XZWJHTFJlbmRlcmVyLnJlYWRSZW5kZXJUYXJnZXRQaXhlbHM6IHJlbmRlclRhcmdldCBpcyBub3QgVEhSRUUuV2ViR0xSZW5kZXJUYXJnZXQuIik7CiAgICAgIGxldCBDdCA9IHV0LmdldChDKS5fX3dlYmdsRnJhbWVidWZmZXI7CiAgICAgIGlmIChDLmlzV2ViR0xDdWJlUmVuZGVyVGFyZ2V0ICYmIFN0ICE9PSB2b2lkIDAgJiYgKEN0ID0gQ3RbU3RdKSwgQ3QpCiAgICAgICAgaWYgKEIgPj0gMCAmJiBCIDw9IEMud2lkdGggLSAkICYmIHEgPj0gMCAmJiBxIDw9IEMuaGVpZ2h0IC0geikgewogICAgICAgICAgSy5iaW5kRnJhbWVidWZmZXIoRC5GUkFNRUJVRkZFUiwgQ3QpOwogICAgICAgICAgY29uc3QgT3QgPSBDLnRleHR1cmVzW0R0XSwgR3QgPSBPdC5mb3JtYXQsIEJ0ID0gT3QudHlwZTsKICAgICAgICAgIGlmICghUS50ZXh0dXJlRm9ybWF0UmVhZGFibGUoR3QpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLldlYkdMUmVuZGVyZXIucmVhZFJlbmRlclRhcmdldFBpeGVsc0FzeW5jOiByZW5kZXJUYXJnZXQgaXMgbm90IGluIFJHQkEgb3IgaW1wbGVtZW50YXRpb24gZGVmaW5lZCBmb3JtYXQuIik7CiAgICAgICAgICBpZiAoIVEudGV4dHVyZVR5cGVSZWFkYWJsZShCdCkpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuV2ViR0xSZW5kZXJlci5yZWFkUmVuZGVyVGFyZ2V0UGl4ZWxzQXN5bmM6IHJlbmRlclRhcmdldCBpcyBub3QgaW4gVW5zaWduZWRCeXRlVHlwZSBvciBpbXBsZW1lbnRhdGlvbiBkZWZpbmVkIHR5cGUuIik7CiAgICAgICAgICBjb25zdCB0ZSA9IEQuY3JlYXRlQnVmZmVyKCk7CiAgICAgICAgICBELmJpbmRCdWZmZXIoRC5QSVhFTF9QQUNLX0JVRkZFUiwgdGUpLCBELmJ1ZmZlckRhdGEoRC5QSVhFTF9QQUNLX0JVRkZFUiwgZnQuYnl0ZUxlbmd0aCwgRC5TVFJFQU1fUkVBRCksIEMudGV4dHVyZXMubGVuZ3RoID4gMSAmJiBELnJlYWRCdWZmZXIoRC5DT0xPUl9BVFRBQ0hNRU5UMCArIER0KSwgRC5yZWFkUGl4ZWxzKEIsIHEsICQsIHosIFR0LmNvbnZlcnQoR3QpLCBUdC5jb252ZXJ0KEJ0KSwgMCk7CiAgICAgICAgICBjb25zdCBwZSA9IFIgIT09IG51bGwgPyB1dC5nZXQoUikuX193ZWJnbEZyYW1lYnVmZmVyIDogbnVsbDsKICAgICAgICAgIEsuYmluZEZyYW1lYnVmZmVyKEQuRlJBTUVCVUZGRVIsIHBlKTsKICAgICAgICAgIGNvbnN0IEFlID0gRC5mZW5jZVN5bmMoRC5TWU5DX0dQVV9DT01NQU5EU19DT01QTEVURSwgMCk7CiAgICAgICAgICByZXR1cm4gRC5mbHVzaCgpLCBhd2FpdCBwdihELCBBZSwgNCksIEQuYmluZEJ1ZmZlcihELlBJWEVMX1BBQ0tfQlVGRkVSLCB0ZSksIEQuZ2V0QnVmZmVyU3ViRGF0YShELlBJWEVMX1BBQ0tfQlVGRkVSLCAwLCBmdCksIEQuZGVsZXRlQnVmZmVyKHRlKSwgRC5kZWxldGVTeW5jKEFlKSwgZnQ7CiAgICAgICAgfSBlbHNlCiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLldlYkdMUmVuZGVyZXIucmVhZFJlbmRlclRhcmdldFBpeGVsc0FzeW5jOiByZXF1ZXN0ZWQgcmVhZCBib3VuZHMgYXJlIG91dCBvZiByYW5nZS4iKTsKICAgIH0sIHRoaXMuY29weUZyYW1lYnVmZmVyVG9UZXh0dXJlID0gZnVuY3Rpb24oQywgQiA9IG51bGwsIHEgPSAwKSB7CiAgICAgIGNvbnN0ICQgPSBNYXRoLnBvdygyLCAtcSksIHogPSBNYXRoLmZsb29yKEMuaW1hZ2Uud2lkdGggKiAkKSwgZnQgPSBNYXRoLmZsb29yKEMuaW1hZ2UuaGVpZ2h0ICogJCksIFN0ID0gQiAhPT0gbnVsbCA/IEIueCA6IDAsIER0ID0gQiAhPT0gbnVsbCA/IEIueSA6IDA7CiAgICAgIHh0LnNldFRleHR1cmUyRChDLCAwKSwgRC5jb3B5VGV4U3ViSW1hZ2UyRChELlRFWFRVUkVfMkQsIHEsIDAsIDAsIFN0LCBEdCwgeiwgZnQpLCBLLnVuYmluZFRleHR1cmUoKTsKICAgIH07CiAgICBjb25zdCBkeCA9IEQuY3JlYXRlRnJhbWVidWZmZXIoKSwgcHggPSBELmNyZWF0ZUZyYW1lYnVmZmVyKCk7CiAgICB0aGlzLmNvcHlUZXh0dXJlVG9UZXh0dXJlID0gZnVuY3Rpb24oQywgQiwgcSA9IG51bGwsICQgPSBudWxsLCB6ID0gMCwgZnQgPSBudWxsKSB7CiAgICAgIGZ0ID09PSBudWxsICYmICh6ICE9PSAwID8gKFBvKCJXZWJHTFJlbmRlcmVyOiBjb3B5VGV4dHVyZVRvVGV4dHVyZSBmdW5jdGlvbiBzaWduYXR1cmUgaGFzIGNoYW5nZWQgdG8gc3VwcG9ydCBzcmMgYW5kIGRzdCBtaXBtYXAgbGV2ZWxzLiIpLCBmdCA9IHosIHogPSAwKSA6IGZ0ID0gMCk7CiAgICAgIGxldCBTdCwgRHQsIEN0LCBPdCwgR3QsIEJ0LCB0ZSwgcGUsIEFlOwogICAgICBjb25zdCBfZSA9IEMuaXNDb21wcmVzc2VkVGV4dHVyZSA/IEMubWlwbWFwc1tmdF0gOiBDLmltYWdlOwogICAgICBpZiAocSAhPT0gbnVsbCkKICAgICAgICBTdCA9IHEubWF4LnggLSBxLm1pbi54LCBEdCA9IHEubWF4LnkgLSBxLm1pbi55LCBDdCA9IHEuaXNCb3gzID8gcS5tYXgueiAtIHEubWluLnogOiAxLCBPdCA9IHEubWluLngsIEd0ID0gcS5taW4ueSwgQnQgPSBxLmlzQm94MyA/IHEubWluLnogOiAwOwogICAgICBlbHNlIHsKICAgICAgICBjb25zdCBWaSA9IE1hdGgucG93KDIsIC16KTsKICAgICAgICBTdCA9IE1hdGguZmxvb3IoX2Uud2lkdGggKiBWaSksIER0ID0gTWF0aC5mbG9vcihfZS5oZWlnaHQgKiBWaSksIEMuaXNEYXRhQXJyYXlUZXh0dXJlID8gQ3QgPSBfZS5kZXB0aCA6IEMuaXNEYXRhM0RUZXh0dXJlID8gQ3QgPSBNYXRoLmZsb29yKF9lLmRlcHRoICogVmkpIDogQ3QgPSAxLCBPdCA9IDAsIEd0ID0gMCwgQnQgPSAwOwogICAgICB9CiAgICAgICQgIT09IG51bGwgPyAodGUgPSAkLngsIHBlID0gJC55LCBBZSA9ICQueikgOiAodGUgPSAwLCBwZSA9IDAsIEFlID0gMCk7CiAgICAgIGNvbnN0IGZlID0gVHQuY29udmVydChCLmZvcm1hdCksIHp0ID0gVHQuY29udmVydChCLnR5cGUpOwogICAgICBsZXQgYmU7CiAgICAgIEIuaXNEYXRhM0RUZXh0dXJlID8gKHh0LnNldFRleHR1cmUzRChCLCAwKSwgYmUgPSBELlRFWFRVUkVfM0QpIDogQi5pc0RhdGFBcnJheVRleHR1cmUgfHwgQi5pc0NvbXByZXNzZWRBcnJheVRleHR1cmUgPyAoeHQuc2V0VGV4dHVyZTJEQXJyYXkoQiwgMCksIGJlID0gRC5URVhUVVJFXzJEX0FSUkFZKSA6ICh4dC5zZXRUZXh0dXJlMkQoQiwgMCksIGJlID0gRC5URVhUVVJFXzJEKSwgRC5waXhlbFN0b3JlaShELlVOUEFDS19GTElQX1lfV0VCR0wsIEIuZmxpcFkpLCBELnBpeGVsU3RvcmVpKEQuVU5QQUNLX1BSRU1VTFRJUExZX0FMUEhBX1dFQkdMLCBCLnByZW11bHRpcGx5QWxwaGEpLCBELnBpeGVsU3RvcmVpKEQuVU5QQUNLX0FMSUdOTUVOVCwgQi51bnBhY2tBbGlnbm1lbnQpOwogICAgICBjb25zdCBhZSA9IEQuZ2V0UGFyYW1ldGVyKEQuVU5QQUNLX1JPV19MRU5HVEgpLCBDaSA9IEQuZ2V0UGFyYW1ldGVyKEQuVU5QQUNLX0lNQUdFX0hFSUdIVCksIHhyID0gRC5nZXRQYXJhbWV0ZXIoRC5VTlBBQ0tfU0tJUF9QSVhFTFMpLCBSaSA9IEQuZ2V0UGFyYW1ldGVyKEQuVU5QQUNLX1NLSVBfUk9XUyksIFVhID0gRC5nZXRQYXJhbWV0ZXIoRC5VTlBBQ0tfU0tJUF9JTUFHRVMpOwogICAgICBELnBpeGVsU3RvcmVpKEQuVU5QQUNLX1JPV19MRU5HVEgsIF9lLndpZHRoKSwgRC5waXhlbFN0b3JlaShELlVOUEFDS19JTUFHRV9IRUlHSFQsIF9lLmhlaWdodCksIEQucGl4ZWxTdG9yZWkoRC5VTlBBQ0tfU0tJUF9QSVhFTFMsIE90KSwgRC5waXhlbFN0b3JlaShELlVOUEFDS19TS0lQX1JPV1MsIEd0KSwgRC5waXhlbFN0b3JlaShELlVOUEFDS19TS0lQX0lNQUdFUywgQnQpOwogICAgICBjb25zdCBNZSA9IEMuaXNEYXRhQXJyYXlUZXh0dXJlIHx8IEMuaXNEYXRhM0RUZXh0dXJlLCBraSA9IEIuaXNEYXRhQXJyYXlUZXh0dXJlIHx8IEIuaXNEYXRhM0RUZXh0dXJlOwogICAgICBpZiAoQy5pc0RlcHRoVGV4dHVyZSkgewogICAgICAgIGNvbnN0IFZpID0gdXQuZ2V0KEMpLCBjaSA9IHV0LmdldChCKSwgeGkgPSB1dC5nZXQoVmkuX19yZW5kZXJUYXJnZXQpLCBndSA9IHV0LmdldChjaS5fX3JlbmRlclRhcmdldCk7CiAgICAgICAgSy5iaW5kRnJhbWVidWZmZXIoRC5SRUFEX0ZSQU1FQlVGRkVSLCB4aS5fX3dlYmdsRnJhbWVidWZmZXIpLCBLLmJpbmRGcmFtZWJ1ZmZlcihELkRSQVdfRlJBTUVCVUZGRVIsIGd1Ll9fd2ViZ2xGcmFtZWJ1ZmZlcik7CiAgICAgICAgZm9yIChsZXQgenMgPSAwOyB6cyA8IEN0OyB6cysrKQogICAgICAgICAgTWUgJiYgKEQuZnJhbWVidWZmZXJUZXh0dXJlTGF5ZXIoRC5SRUFEX0ZSQU1FQlVGRkVSLCBELkNPTE9SX0FUVEFDSE1FTlQwLCB1dC5nZXQoQykuX193ZWJnbFRleHR1cmUsIHosIEJ0ICsgenMpLCBELmZyYW1lYnVmZmVyVGV4dHVyZUxheWVyKEQuRFJBV19GUkFNRUJVRkZFUiwgRC5DT0xPUl9BVFRBQ0hNRU5UMCwgdXQuZ2V0KEIpLl9fd2ViZ2xUZXh0dXJlLCBmdCwgQWUgKyB6cykpLCBELmJsaXRGcmFtZWJ1ZmZlcihPdCwgR3QsIFN0LCBEdCwgdGUsIHBlLCBTdCwgRHQsIEQuREVQVEhfQlVGRkVSX0JJVCwgRC5ORUFSRVNUKTsKICAgICAgICBLLmJpbmRGcmFtZWJ1ZmZlcihELlJFQURfRlJBTUVCVUZGRVIsIG51bGwpLCBLLmJpbmRGcmFtZWJ1ZmZlcihELkRSQVdfRlJBTUVCVUZGRVIsIG51bGwpOwogICAgICB9IGVsc2UgaWYgKHogIT09IDAgfHwgQy5pc1JlbmRlclRhcmdldFRleHR1cmUgfHwgdXQuaGFzKEMpKSB7CiAgICAgICAgY29uc3QgVmkgPSB1dC5nZXQoQyksIGNpID0gdXQuZ2V0KEIpOwogICAgICAgIEsuYmluZEZyYW1lYnVmZmVyKEQuUkVBRF9GUkFNRUJVRkZFUiwgZHgpLCBLLmJpbmRGcmFtZWJ1ZmZlcihELkRSQVdfRlJBTUVCVUZGRVIsIHB4KTsKICAgICAgICBmb3IgKGxldCB4aSA9IDA7IHhpIDwgQ3Q7IHhpKyspCiAgICAgICAgICBNZSA/IEQuZnJhbWVidWZmZXJUZXh0dXJlTGF5ZXIoRC5SRUFEX0ZSQU1FQlVGRkVSLCBELkNPTE9SX0FUVEFDSE1FTlQwLCBWaS5fX3dlYmdsVGV4dHVyZSwgeiwgQnQgKyB4aSkgOiBELmZyYW1lYnVmZmVyVGV4dHVyZTJEKEQuUkVBRF9GUkFNRUJVRkZFUiwgRC5DT0xPUl9BVFRBQ0hNRU5UMCwgRC5URVhUVVJFXzJELCBWaS5fX3dlYmdsVGV4dHVyZSwgeiksIGtpID8gRC5mcmFtZWJ1ZmZlclRleHR1cmVMYXllcihELkRSQVdfRlJBTUVCVUZGRVIsIEQuQ09MT1JfQVRUQUNITUVOVDAsIGNpLl9fd2ViZ2xUZXh0dXJlLCBmdCwgQWUgKyB4aSkgOiBELmZyYW1lYnVmZmVyVGV4dHVyZTJEKEQuRFJBV19GUkFNRUJVRkZFUiwgRC5DT0xPUl9BVFRBQ0hNRU5UMCwgRC5URVhUVVJFXzJELCBjaS5fX3dlYmdsVGV4dHVyZSwgZnQpLCB6ICE9PSAwID8gRC5ibGl0RnJhbWVidWZmZXIoT3QsIEd0LCBTdCwgRHQsIHRlLCBwZSwgU3QsIER0LCBELkNPTE9SX0JVRkZFUl9CSVQsIEQuTkVBUkVTVCkgOiBraSA/IEQuY29weVRleFN1YkltYWdlM0QoYmUsIGZ0LCB0ZSwgcGUsIEFlICsgeGksIE90LCBHdCwgU3QsIER0KSA6IEQuY29weVRleFN1YkltYWdlMkQoYmUsIGZ0LCB0ZSwgcGUsIE90LCBHdCwgU3QsIER0KTsKICAgICAgICBLLmJpbmRGcmFtZWJ1ZmZlcihELlJFQURfRlJBTUVCVUZGRVIsIG51bGwpLCBLLmJpbmRGcmFtZWJ1ZmZlcihELkRSQVdfRlJBTUVCVUZGRVIsIG51bGwpOwogICAgICB9IGVsc2UKICAgICAgICBraSA/IEMuaXNEYXRhVGV4dHVyZSB8fCBDLmlzRGF0YTNEVGV4dHVyZSA/IEQudGV4U3ViSW1hZ2UzRChiZSwgZnQsIHRlLCBwZSwgQWUsIFN0LCBEdCwgQ3QsIGZlLCB6dCwgX2UuZGF0YSkgOiBCLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSA/IEQuY29tcHJlc3NlZFRleFN1YkltYWdlM0QoYmUsIGZ0LCB0ZSwgcGUsIEFlLCBTdCwgRHQsIEN0LCBmZSwgX2UuZGF0YSkgOiBELnRleFN1YkltYWdlM0QoYmUsIGZ0LCB0ZSwgcGUsIEFlLCBTdCwgRHQsIEN0LCBmZSwgenQsIF9lKSA6IEMuaXNEYXRhVGV4dHVyZSA/IEQudGV4U3ViSW1hZ2UyRChELlRFWFRVUkVfMkQsIGZ0LCB0ZSwgcGUsIFN0LCBEdCwgZmUsIHp0LCBfZS5kYXRhKSA6IEMuaXNDb21wcmVzc2VkVGV4dHVyZSA/IEQuY29tcHJlc3NlZFRleFN1YkltYWdlMkQoRC5URVhUVVJFXzJELCBmdCwgdGUsIHBlLCBfZS53aWR0aCwgX2UuaGVpZ2h0LCBmZSwgX2UuZGF0YSkgOiBELnRleFN1YkltYWdlMkQoRC5URVhUVVJFXzJELCBmdCwgdGUsIHBlLCBTdCwgRHQsIGZlLCB6dCwgX2UpOwogICAgICBELnBpeGVsU3RvcmVpKEQuVU5QQUNLX1JPV19MRU5HVEgsIGFlKSwgRC5waXhlbFN0b3JlaShELlVOUEFDS19JTUFHRV9IRUlHSFQsIENpKSwgRC5waXhlbFN0b3JlaShELlVOUEFDS19TS0lQX1BJWEVMUywgeHIpLCBELnBpeGVsU3RvcmVpKEQuVU5QQUNLX1NLSVBfUk9XUywgUmkpLCBELnBpeGVsU3RvcmVpKEQuVU5QQUNLX1NLSVBfSU1BR0VTLCBVYSksIGZ0ID09PSAwICYmIEIuZ2VuZXJhdGVNaXBtYXBzICYmIEQuZ2VuZXJhdGVNaXBtYXAoYmUpLCBLLnVuYmluZFRleHR1cmUoKTsKICAgIH0sIHRoaXMuaW5pdFJlbmRlclRhcmdldCA9IGZ1bmN0aW9uKEMpIHsKICAgICAgdXQuZ2V0KEMpLl9fd2ViZ2xGcmFtZWJ1ZmZlciA9PT0gdm9pZCAwICYmIHh0LnNldHVwUmVuZGVyVGFyZ2V0KEMpOwogICAgfSwgdGhpcy5pbml0VGV4dHVyZSA9IGZ1bmN0aW9uKEMpIHsKICAgICAgQy5pc0N1YmVUZXh0dXJlID8geHQuc2V0VGV4dHVyZUN1YmUoQywgMCkgOiBDLmlzRGF0YTNEVGV4dHVyZSA/IHh0LnNldFRleHR1cmUzRChDLCAwKSA6IEMuaXNEYXRhQXJyYXlUZXh0dXJlIHx8IEMuaXNDb21wcmVzc2VkQXJyYXlUZXh0dXJlID8geHQuc2V0VGV4dHVyZTJEQXJyYXkoQywgMCkgOiB4dC5zZXRUZXh0dXJlMkQoQywgMCksIEsudW5iaW5kVGV4dHVyZSgpOwogICAgfSwgdGhpcy5yZXNldFN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHcgPSAwLCBUID0gMCwgUiA9IG51bGwsIEsucmVzZXQoKSwgdnQucmVzZXQoKTsKICAgIH0sIHR5cGVvZiBfX1RIUkVFX0RFVlRPT0xTX18gPCAidSIgJiYgX19USFJFRV9ERVZUT09MU19fLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCJvYnNlcnZlIiwgeyBkZXRhaWw6IHRoaXMgfSkpOwogIH0KICAvKioKICAgKiBEZWZpbmVzIHRoZSBjb29yZGluYXRlIHN5c3RlbSBvZiB0aGUgcmVuZGVyZXIuCiAgICoKICAgKiBJbiBgV2ViR0xSZW5kZXJlcmAsIHRoZSB2YWx1ZSBpcyBhbHdheXMgYFdlYkdMQ29vcmRpbmF0ZVN5c3RlbWAuCiAgICoKICAgKiBAdHlwZSB7V2ViR0xDb29yZGluYXRlU3lzdGVtfFdlYkdQVUNvb3JkaW5hdGVTeXN0ZW19CiAgICogQGRlZmF1bHQgV2ViR0xDb29yZGluYXRlU3lzdGVtCiAgICogQHJlYWRvbmx5CiAgICovCiAgZ2V0IGNvb3JkaW5hdGVTeXN0ZW0oKSB7CiAgICByZXR1cm4gTmk7CiAgfQogIC8qKgogICAqIERlZmluZXMgdGhlIG91dHB1dCBjb2xvciBzcGFjZSBvZiB0aGUgcmVuZGVyZXIuCiAgICoKICAgKiBAdHlwZSB7U1JHQkNvbG9yU3BhY2V8TGluZWFyU1JHQkNvbG9yU3BhY2V9CiAgICogQGRlZmF1bHQgU1JHQkNvbG9yU3BhY2UKICAgKi8KICBnZXQgb3V0cHV0Q29sb3JTcGFjZSgpIHsKICAgIHJldHVybiB0aGlzLl9vdXRwdXRDb2xvclNwYWNlOwogIH0KICBzZXQgb3V0cHV0Q29sb3JTcGFjZSh0KSB7CiAgICB0aGlzLl9vdXRwdXRDb2xvclNwYWNlID0gdDsKICAgIGNvbnN0IGUgPSB0aGlzLmdldENvbnRleHQoKTsKICAgIGUuZHJhd2luZ0J1ZmZlckNvbG9yU3BhY2UgPSBlZS5fZ2V0RHJhd2luZ0J1ZmZlckNvbG9yU3BhY2UodCksIGUudW5wYWNrQ29sb3JTcGFjZSA9IGVlLl9nZXRVbnBhY2tDb2xvclNwYWNlKCk7CiAgfQp9CnZhciB3RSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuZnJlZXplKHsKICBfX3Byb3RvX186IG51bGwsCiAgQUNFU0ZpbG1pY1RvbmVNYXBwaW5nOiBqMCwKICBBZGRFcXVhdGlvbjogdnMsCiAgQWRkT3BlcmF0aW9uOiAkMCwKICBBZGRpdGl2ZUFuaW1hdGlvbkJsZW5kTW9kZTogRHAsCiAgQWRkaXRpdmVCbGVuZGluZzogWmQsCiAgQWdYVG9uZU1hcHBpbmc6IEswLAogIEFscGhhRm9ybWF0OiBDcCwKICBBbHdheXNDb21wYXJlOiBkeSwKICBBbHdheXNEZXB0aDogRmgsCiAgQWx3YXlzU3RlbmNpbEZ1bmM6IFRvLAogIEFtYmllbnRMaWdodDogYWYsCiAgQW5pbWF0aW9uQWN0aW9uOiBnXywKICBBbmltYXRpb25DbGlwOiBNYSwKICBBbmltYXRpb25Mb2FkZXI6IE9iLAogIEFuaW1hdGlvbk1peGVyOiB5XywKICBBbmltYXRpb25PYmplY3RHcm91cDogZE0sCiAgQW5pbWF0aW9uVXRpbHM6IFViLAogIEFyY0N1cnZlOiB6eSwKICBBcnJheUNhbWVyYTogcF8sCiAgQXJyb3dIZWxwZXI6IEJNLAogIEF0dGFjaGVkQmluZE1vZGU6IEtkLAogIEF1ZGlvOiBmXywKICBBdWRpb0FuYWx5c2VyOiBpTSwKICBBdWRpb0NvbnRleHQ6IG9mLAogIEF1ZGlvTGlzdGVuZXI6IFFiLAogIEF1ZGlvTG9hZGVyOiBqYiwKICBBeGVzSGVscGVyOiB6TSwKICBCYWNrU2lkZTogSGUsCiAgQmFzaWNEZXB0aFBhY2tpbmc6IGl5LAogIEJhc2ljU2hhZG93TWFwOiB5eCwKICBCYXRjaGVkTWVzaDogTHksCiAgQm9uZTogT3AsCiAgQm9vbGVhbktleWZyYW1lVHJhY2s6IGdyLAogIEJveDI6IGJNLAogIEJveDM6IHdlLAogIEJveDNIZWxwZXI6IEZNLAogIEJveEdlb21ldHJ5OiBtciwKICBCb3hIZWxwZXI6IERNLAogIEJ1ZmZlckF0dHJpYnV0ZTogaWUsCiAgQnVmZmVyR2VvbWV0cnk6IEh0LAogIEJ1ZmZlckdlb21ldHJ5TG9hZGVyOiBkXywKICBCeXRlVHlwZTogd3AsCiAgQ2FjaGU6IFRuLAogIENhbWVyYToga2MsCiAgQ2FtZXJhSGVscGVyOiBMTSwKICBDYW52YXNUZXh0dXJlOiBVeSwKICBDYXBzdWxlR2VvbWV0cnk6IFpjLAogIENhdG11bGxSb21DdXJ2ZTM6IE55LAogIENpbmVvblRvbmVNYXBwaW5nOiBaMCwKICBDaXJjbGVHZW9tZXRyeTogamMsCiAgQ2xhbXBUb0VkZ2VXcmFwcGluZzogU2ksCiAgQ2xvY2s6IGxmLAogIENvbG9yOiBjdCwKICBDb2xvcktleWZyYW1lVHJhY2s6IGVmLAogIENvbG9yTWFuYWdlbWVudDogZWUsCiAgQ29tcHJlc3NlZEFycmF5VGV4dHVyZTogbmIsCiAgQ29tcHJlc3NlZEN1YmVUZXh0dXJlOiBzYiwKICBDb21wcmVzc2VkVGV4dHVyZTogWWMsCiAgQ29tcHJlc3NlZFRleHR1cmVMb2FkZXI6IGtiLAogIENvbmVHZW9tZXRyeTogQ2EsCiAgQ29uc3RhbnRBbHBoYUZhY3RvcjogRzAsCiAgQ29uc3RhbnRDb2xvckZhY3RvcjogVjAsCiAgQ29udHJvbHM6IE5NLAogIEN1YmVDYW1lcmE6IEF5LAogIEN1YmVSZWZsZWN0aW9uTWFwcGluZzogaXMsCiAgQ3ViZVJlZnJhY3Rpb25NYXBwaW5nOiBUcywKICBDdWJlVGV4dHVyZTogT28sCiAgQ3ViZVRleHR1cmVMb2FkZXI6IFZiLAogIEN1YmVVVlJlZmxlY3Rpb25NYXBwaW5nOiBTYSwKICBDdWJpY0JlemllckN1cnZlOiBXcCwKICBDdWJpY0JlemllckN1cnZlMzogT3ksCiAgQ3ViaWNJbnRlcnBvbGFudDogaV8sCiAgQ3VsbEZhY2VCYWNrOiBZZCwKICBDdWxsRmFjZUZyb250OiBBMCwKICBDdWxsRmFjZUZyb250QmFjazogZ3gsCiAgQ3VsbEZhY2VOb25lOiB3MCwKICBDdXJ2ZTogbW4sCiAgQ3VydmVQYXRoOiBWeSwKICBDdXN0b21CbGVuZGluZzogVDAsCiAgQ3VzdG9tVG9uZU1hcHBpbmc6IEowLAogIEN5bGluZGVyR2VvbWV0cnk6IFRhLAogIEN5bGluZHJpY2FsOiB2TSwKICBEYXRhM0RUZXh0dXJlOiB6YywKICBEYXRhQXJyYXlUZXh0dXJlOiBCYywKICBEYXRhVGV4dHVyZTogQ24sCiAgRGF0YVRleHR1cmVMb2FkZXI6IEhiLAogIERhdGFVdGlsczogQ3YsCiAgRGVjcmVtZW50U3RlbmNpbE9wOiBQeCwKICBEZWNyZW1lbnRXcmFwU3RlbmNpbE9wOiB3aCwKICBEZWZhdWx0TG9hZGluZ01hbmFnZXI6IHJfLAogIERlcHRoRm9ybWF0OiBmYSwKICBEZXB0aFN0ZW5jaWxGb3JtYXQ6IG1hLAogIERlcHRoVGV4dHVyZTogVnAsCiAgRGV0YWNoZWRCaW5kTW9kZTogdHksCiAgRGlyZWN0aW9uYWxMaWdodDogcmYsCiAgRGlyZWN0aW9uYWxMaWdodEhlbHBlcjogSU0sCiAgRGlzY3JldGVJbnRlcnBvbGFudDogbl8sCiAgRG9kZWNhaGVkcm9uR2VvbWV0cnk6IEpjLAogIERvdWJsZVNpZGU6IE1pLAogIERzdEFscGhhRmFjdG9yOiBCMCwKICBEc3RDb2xvckZhY3RvcjogTjAsCiAgRHluYW1pY0NvcHlVc2FnZTogV3gsCiAgRHluYW1pY0RyYXdVc2FnZTogTngsCiAgRHluYW1pY1JlYWRVc2FnZTogVngsCiAgRWRnZXNHZW9tZXRyeTogQnksCiAgRWxsaXBzZUN1cnZlOiBLYywKICBFcXVhbENvbXBhcmU6IGx5LAogIEVxdWFsRGVwdGg6IEJoLAogIEVxdWFsU3RlbmNpbEZ1bmM6IEZ4LAogIEVxdWlyZWN0YW5ndWxhclJlZmxlY3Rpb25NYXBwaW5nOiB2bywKICBFcXVpcmVjdGFuZ3VsYXJSZWZyYWN0aW9uTWFwcGluZzogYm8sCiAgRXVsZXI6IGZuLAogIEV2ZW50RGlzcGF0Y2hlcjogRWksCiAgRXh0ZXJuYWxUZXh0dXJlOiBIcCwKICBFeHRydWRlR2VvbWV0cnk6IFZvLAogIEZpbGVMb2FkZXI6IHNzLAogIEZsb2F0MTZCdWZmZXJBdHRyaWJ1dGU6IFV2LAogIEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGU6IHd0LAogIEZsb2F0VHlwZTogd2ksCiAgRm9nOiBIYywKICBGb2dFeHAyOiBWYywKICBGcmFtZWJ1ZmZlclRleHR1cmU6IGliLAogIEZyb250U2lkZTogJGksCiAgRnJ1c3R1bTogRWEsCiAgRnJ1c3R1bUFycmF5OiAkYywKICBHTEJ1ZmZlckF0dHJpYnV0ZTogeU0sCiAgR0xTTDE6ICR4LAogIEdMU0wzOiBRZCwKICBHcmVhdGVyQ29tcGFyZTogaHksCiAgR3JlYXRlckRlcHRoOiBOaCwKICBHcmVhdGVyRXF1YWxDb21wYXJlOiB1eSwKICBHcmVhdGVyRXF1YWxEZXB0aDogemgsCiAgR3JlYXRlckVxdWFsU3RlbmNpbEZ1bmM6IHp4LAogIEdyZWF0ZXJTdGVuY2lsRnVuYzogQngsCiAgR3JpZEhlbHBlcjogUk0sCiAgR3JvdXA6IHlpLAogIEhhbGZGbG9hdFR5cGU6IHdhLAogIEhlbWlzcGhlcmVMaWdodDogYV8sCiAgSGVtaXNwaGVyZUxpZ2h0SGVscGVyOiBDTSwKICBJY29zYWhlZHJvbkdlb21ldHJ5OiBRYywKICBJbWFnZUJpdG1hcExvYWRlcjogWmIsCiAgSW1hZ2VMb2FkZXI6IFVvLAogIEltYWdlVXRpbHM6IHh5LAogIEluY3JlbWVudFN0ZW5jaWxPcDogUngsCiAgSW5jcmVtZW50V3JhcFN0ZW5jaWxPcDogU2gsCiAgSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlOiB4YSwKICBJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeTogb3UsCiAgSW5zdGFuY2VkSW50ZXJsZWF2ZWRCdWZmZXI6IHZjLAogIEluc3RhbmNlZE1lc2g6IEl5LAogIEludDE2QnVmZmVyQXR0cmlidXRlOiBEdiwKICBJbnQzMkJ1ZmZlckF0dHJpYnV0ZTogRnYsCiAgSW50OEJ1ZmZlckF0dHJpYnV0ZTogUHYsCiAgSW50VHlwZTogUmMsCiAgSW50ZXJsZWF2ZWRCdWZmZXI6IEdjLAogIEludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlOiB1biwKICBJbnRlcnBvbGFudDogV28sCiAgSW50ZXJwb2xhdGVEaXNjcmV0ZTogd28sCiAgSW50ZXJwb2xhdGVMaW5lYXI6IGZjLAogIEludGVycG9sYXRlU21vb3RoOiBiaCwKICBJbnRlcnBvbGF0aW9uU2FtcGxpbmdNb2RlOiBaeCwKICBJbnRlcnBvbGF0aW9uU2FtcGxpbmdUeXBlOiBZeCwKICBJbnZlcnRTdGVuY2lsT3A6IEl4LAogIEtlZXBTdGVuY2lsT3A6IGVyLAogIEtleWZyYW1lVHJhY2s6IFlpLAogIExPRDogUnksCiAgTGF0aGVHZW9tZXRyeTogdHUsCiAgTGF5ZXJzOiBOYywKICBMZXNzQ29tcGFyZTogb3ksCiAgTGVzc0RlcHRoOiBVaCwKICBMZXNzRXF1YWxDb21wYXJlOiBGcCwKICBMZXNzRXF1YWxEZXB0aDogcHIsCiAgTGVzc0VxdWFsU3RlbmNpbEZ1bmM6IFV4LAogIExlc3NTdGVuY2lsRnVuYzogRHgsCiAgTGlnaHQ6IEZzLAogIExpZ2h0UHJvYmU6IHVfLAogIExpbmU6IFJzLAogIExpbmUzOiB4XywKICBMaW5lQmFzaWNNYXRlcmlhbDogUGUsCiAgTGluZUN1cnZlOiBxcCwKICBMaW5lQ3VydmUzOiBreSwKICBMaW5lRGFzaGVkTWF0ZXJpYWw6IEtwLAogIExpbmVMb29wOiBEeSwKICBMaW5lU2VnbWVudHM6IG9pLAogIExpbmVhckZpbHRlcjogQ2UsCiAgTGluZWFySW50ZXJwb2xhbnQ6IHRmLAogIExpbmVhck1pcE1hcExpbmVhckZpbHRlcjogYngsCiAgTGluZWFyTWlwTWFwTmVhcmVzdEZpbHRlcjogdngsCiAgTGluZWFyTWlwbWFwTGluZWFyRmlsdGVyOiBFbiwKICBMaW5lYXJNaXBtYXBOZWFyZXN0RmlsdGVyOiBsbywKICBMaW5lYXJTUkdCQ29sb3JTcGFjZTogQ3MsCiAgTGluZWFyVG9uZU1hcHBpbmc6IFgwLAogIExpbmVhclRyYW5zZmVyOiBFbywKICBMb2FkZXI6IFRpLAogIExvYWRlclV0aWxzOiBycCwKICBMb2FkaW5nTWFuYWdlcjogbmYsCiAgTG9vcE9uY2U6IGV5LAogIExvb3BQaW5nUG9uZzogTHAsCiAgTG9vcFJlcGVhdDogSXAsCiAgTU9VU0U6IFplLAogIE1hdGVyaWFsOiBoaSwKICBNYXRlcmlhbExvYWRlcjogYXUsCiAgTWF0aFV0aWxzOiBweSwKICBNYXRyaXgyOiBkZiwKICBNYXRyaXgzOiBYdCwKICBNYXRyaXg0OiBWdCwKICBNYXhFcXVhdGlvbjogSTAsCiAgTWVzaDogcmUsCiAgTWVzaEJhc2ljTWF0ZXJpYWw6IGxpLAogIE1lc2hEZXB0aE1hdGVyaWFsOiBqcCwKICBNZXNoRGlzdGFuY2VNYXRlcmlhbDogSnAsCiAgTWVzaExhbWJlcnRNYXRlcmlhbDogS3ksCiAgTWVzaE1hdGNhcE1hdGVyaWFsOiBReSwKICBNZXNoTm9ybWFsTWF0ZXJpYWw6IEp5LAogIE1lc2hQaG9uZ01hdGVyaWFsOiBaeSwKICBNZXNoUGh5c2ljYWxNYXRlcmlhbDogWXksCiAgTWVzaFN0YW5kYXJkTWF0ZXJpYWw6IGhyLAogIE1lc2hUb29uTWF0ZXJpYWw6IGp5LAogIE1pbkVxdWF0aW9uOiBQMCwKICBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nOiBTbywKICBNaXhPcGVyYXRpb246IHEwLAogIE11bHRpcGx5QmxlbmRpbmc6IEpkLAogIE11bHRpcGx5T3BlcmF0aW9uOiB6bywKICBOZWFyZXN0RmlsdGVyOiBqZSwKICBOZWFyZXN0TWlwTWFwTGluZWFyRmlsdGVyOiB4eCwKICBOZWFyZXN0TWlwTWFwTmVhcmVzdEZpbHRlcjogX3gsCiAgTmVhcmVzdE1pcG1hcExpbmVhckZpbHRlcjogc2EsCiAgTmVhcmVzdE1pcG1hcE5lYXJlc3RGaWx0ZXI6IFNwLAogIE5ldXRyYWxUb25lTWFwcGluZzogUTAsCiAgTmV2ZXJDb21wYXJlOiBheSwKICBOZXZlckRlcHRoOiBEaCwKICBOZXZlclN0ZW5jaWxGdW5jOiBMeCwKICBOb0JsZW5kaW5nOiBZbiwKICBOb0NvbG9yU3BhY2U6ICRuLAogIE5vVG9uZU1hcHBpbmc6IFpuLAogIE5vcm1hbEFuaW1hdGlvbkJsZW5kTW9kZTogVWMsCiAgTm9ybWFsQmxlbmRpbmc6IHdzLAogIE5vdEVxdWFsQ29tcGFyZTogY3ksCiAgTm90RXF1YWxEZXB0aDogT2gsCiAgTm90RXF1YWxTdGVuY2lsRnVuYzogcnksCiAgTnVtYmVyS2V5ZnJhbWVUcmFjazogRm8sCiAgT2JqZWN0M0Q6IGxlLAogIE9iamVjdExvYWRlcjogWGIsCiAgT2JqZWN0U3BhY2VOb3JtYWxNYXA6IHN5LAogIE9jdGFoZWRyb25HZW9tZXRyeTogSG8sCiAgT25lRmFjdG9yOiBEMCwKICBPbmVNaW51c0NvbnN0YW50QWxwaGFGYWN0b3I6IFcwLAogIE9uZU1pbnVzQ29uc3RhbnRDb2xvckZhY3RvcjogSDAsCiAgT25lTWludXNEc3RBbHBoYUZhY3RvcjogejAsCiAgT25lTWludXNEc3RDb2xvckZhY3RvcjogTzAsCiAgT25lTWludXNTcmNBbHBoYUZhY3RvcjogTGgsCiAgT25lTWludXNTcmNDb2xvckZhY3RvcjogVTAsCiAgT3J0aG9ncmFwaGljQ2FtZXJhOiBJYSwKICBQQ0ZTaGFkb3dNYXA6IE1wLAogIFBDRlNvZnRTaGFkb3dNYXA6IEUwLAogIFBNUkVNR2VuZXJhdG9yOiBocCwKICBQYXRoOiB4YywKICBQZXJzcGVjdGl2ZUNhbWVyYTogVmUsCiAgUGxhbmU6IHFuLAogIFBsYW5lR2VvbWV0cnk6IERzLAogIFBsYW5lSGVscGVyOiBVTSwKICBQb2ludExpZ2h0OiBsXywKICBQb2ludExpZ2h0SGVscGVyOiBFTSwKICBQb2ludHM6IGtwLAogIFBvaW50c01hdGVyaWFsOiBYYywKICBQb2xhckdyaWRIZWxwZXI6IFBNLAogIFBvbHloZWRyb25HZW9tZXRyeTogTHMsCiAgUG9zaXRpb25hbEF1ZGlvOiBlTSwKICBQcm9wZXJ0eUJpbmRpbmc6IHNlLAogIFByb3BlcnR5TWl4ZXI6IG1fLAogIFF1YWRyYXRpY0JlemllckN1cnZlOiAkcCwKICBRdWFkcmF0aWNCZXppZXJDdXJ2ZTM6IFhwLAogIFF1YXRlcm5pb246IHZlLAogIFF1YXRlcm5pb25LZXlmcmFtZVRyYWNrOiBQYSwKICBRdWF0ZXJuaW9uTGluZWFySW50ZXJwb2xhbnQ6IHNfLAogIFJFRF9HUkVFTl9SR1RDMl9Gb3JtYXQ6IGRjLAogIFJFRF9SR1RDMV9Gb3JtYXQ6IGNjLAogIFJFVklTSU9OOiBUYywKICBSR0JBRGVwdGhQYWNraW5nOiBueSwKICBSR0JBRm9ybWF0OiBnaSwKICBSR0JBSW50ZWdlckZvcm1hdDogRmMsCiAgUkdCQV9BU1RDXzEweDEwX0Zvcm1hdDogc2MsCiAgUkdCQV9BU1RDXzEweDVfRm9ybWF0OiBlYywKICBSR0JBX0FTVENfMTB4Nl9Gb3JtYXQ6IGljLAogIFJHQkFfQVNUQ18xMHg4X0Zvcm1hdDogbmMsCiAgUkdCQV9BU1RDXzEyeDEwX0Zvcm1hdDogcmMsCiAgUkdCQV9BU1RDXzEyeDEyX0Zvcm1hdDogYWMsCiAgUkdCQV9BU1RDXzR4NF9Gb3JtYXQ6IFhoLAogIFJHQkFfQVNUQ181eDRfRm9ybWF0OiBZaCwKICBSR0JBX0FTVENfNXg1X0Zvcm1hdDogWmgsCiAgUkdCQV9BU1RDXzZ4NV9Gb3JtYXQ6IGpoLAogIFJHQkFfQVNUQ182eDZfRm9ybWF0OiBKaCwKICBSR0JBX0FTVENfOHg1X0Zvcm1hdDogS2gsCiAgUkdCQV9BU1RDXzh4Nl9Gb3JtYXQ6IFFoLAogIFJHQkFfQVNUQ184eDhfRm9ybWF0OiB0YywKICBSR0JBX0JQVENfRm9ybWF0OiBvYywKICBSR0JBX0VUQzJfRUFDX0Zvcm1hdDogJGgsCiAgUkdCQV9QVlJUQ18yQlBQVjFfRm9ybWF0OiBHaCwKICBSR0JBX1BWUlRDXzRCUFBWMV9Gb3JtYXQ6IEhoLAogIFJHQkFfUzNUQ19EWFQxX0Zvcm1hdDogY28sCiAgUkdCQV9TM1RDX0RYVDNfRm9ybWF0OiB1bywKICBSR0JBX1MzVENfRFhUNV9Gb3JtYXQ6IHBvLAogIFJHQkRlcHRoUGFja2luZzogRXgsCiAgUkdCRm9ybWF0OiBScCwKICBSR0JJbnRlZ2VyRm9ybWF0OiBNeCwKICBSR0JfQlBUQ19TSUdORURfRm9ybWF0OiBsYywKICBSR0JfQlBUQ19VTlNJR05FRF9Gb3JtYXQ6IGhjLAogIFJHQl9FVEMxX0Zvcm1hdDogV2gsCiAgUkdCX0VUQzJfRm9ybWF0OiBxaCwKICBSR0JfUFZSVENfMkJQUFYxX0Zvcm1hdDogVmgsCiAgUkdCX1BWUlRDXzRCUFBWMV9Gb3JtYXQ6IGtoLAogIFJHQl9TM1RDX0RYVDFfRm9ybWF0OiBobywKICBSR0RlcHRoUGFja2luZzogVHgsCiAgUkdGb3JtYXQ6IFBwLAogIFJHSW50ZWdlckZvcm1hdDogRGMsCiAgUmF3U2hhZGVyTWF0ZXJpYWw6IFh5LAogIFJheTogQWEsCiAgUmF5Y2FzdGVyOiBfXywKICBSZWN0QXJlYUxpZ2h0OiBoXywKICBSZWRGb3JtYXQ6IExjLAogIFJlZEludGVnZXJGb3JtYXQ6IE5vLAogIFJlaW5oYXJkVG9uZU1hcHBpbmc6IFkwLAogIFJlbmRlclRhcmdldDogQnAsCiAgUmVuZGVyVGFyZ2V0M0Q6IGZNLAogIFJlcGVhdFdyYXBwaW5nOiBNbywKICBSZXBsYWNlU3RlbmNpbE9wOiBNaCwKICBSZXZlcnNlU3VidHJhY3RFcXVhdGlvbjogUjAsCiAgUmluZ0dlb21ldHJ5OiBldSwKICBTSUdORURfUkVEX0dSRUVOX1JHVEMyX0Zvcm1hdDogcGMsCiAgU0lHTkVEX1JFRF9SR1RDMV9Gb3JtYXQ6IHVjLAogIFNSR0JDb2xvclNwYWNlOiByaSwKICBTUkdCVHJhbnNmZXI6IGNlLAogIFNjZW5lOiBrbywKICBTaGFkZXJDaHVuazogWnQsCiAgU2hhZGVyTGliOiBmaSwKICBTaGFkZXJNYXRlcmlhbDogWGksCiAgU2hhZG93TWF0ZXJpYWw6ICR5LAogIFNoYXBlOiBBcywKICBTaGFwZUdlb21ldHJ5OiBHbywKICBTaGFwZVBhdGg6IGJfLAogIFNoYXBlVXRpbHM6IGRuLAogIFNob3J0VHlwZTogQXAsCiAgU2tlbGV0b246IHFjLAogIFNrZWxldG9uSGVscGVyOiBBTSwKICBTa2lubmVkTWVzaDogUHksCiAgU291cmNlOiBNcywKICBTcGhlcmU6IFJlLAogIFNwaGVyZUdlb21ldHJ5OiBSYSwKICBTcGhlcmljYWw6IG9wLAogIFNwaGVyaWNhbEhhcm1vbmljczM6IGNfLAogIFNwbGluZUN1cnZlOiBZcCwKICBTcG90TGlnaHQ6IG9fLAogIFNwb3RMaWdodEhlbHBlcjogd00sCiAgU3ByaXRlOiBtYywKICBTcHJpdGVNYXRlcmlhbDogV2MsCiAgU3JjQWxwaGFGYWN0b3I6IEloLAogIFNyY0FscGhhU2F0dXJhdGVGYWN0b3I6IGswLAogIFNyY0NvbG9yRmFjdG9yOiBGMCwKICBTdGF0aWNDb3B5VXNhZ2U6IEd4LAogIFN0YXRpY0RyYXdVc2FnZTogQ28sCiAgU3RhdGljUmVhZFVzYWdlOiBreCwKICBTdGVyZW9DYW1lcmE6IEpiLAogIFN0cmVhbUNvcHlVc2FnZTogcXgsCiAgU3RyZWFtRHJhd1VzYWdlOiBPeCwKICBTdHJlYW1SZWFkVXNhZ2U6IEh4LAogIFN0cmluZ0tleWZyYW1lVHJhY2s6IHlyLAogIFN1YnRyYWN0RXF1YXRpb246IEMwLAogIFN1YnRyYWN0aXZlQmxlbmRpbmc6IGpkLAogIFRPVUNIOiB6aSwKICBUYW5nZW50U3BhY2VOb3JtYWxNYXA6IElzLAogIFRldHJhaGVkcm9uR2VvbWV0cnk6IGl1LAogIFRleHR1cmU6IE5lLAogIFRleHR1cmVMb2FkZXI6IEdiLAogIFRleHR1cmVVdGlsczogR00sCiAgVGltZXI6IF9NLAogIFRpbWVzdGFtcFF1ZXJ5OiBYeCwKICBUb3J1c0dlb21ldHJ5OiBudSwKICBUb3J1c0tub3RHZW9tZXRyeTogc3UsCiAgVHJpYW5nbGU6IGJzLAogIFRyaWFuZ2xlRmFuRHJhd01vZGU6IEF4LAogIFRyaWFuZ2xlU3RyaXBEcmF3TW9kZTogd3gsCiAgVHJpYW5nbGVzRHJhd01vZGU6IFN4LAogIFR1YmVHZW9tZXRyeTogcnUsCiAgVVZNYXBwaW5nOiBDYywKICBVaW50MTZCdWZmZXJBdHRyaWJ1dGU6IHpwLAogIFVpbnQzMkJ1ZmZlckF0dHJpYnV0ZTogTnAsCiAgVWludDhCdWZmZXJBdHRyaWJ1dGU6IEl2LAogIFVpbnQ4Q2xhbXBlZEJ1ZmZlckF0dHJpYnV0ZTogTHYsCiAgVW5pZm9ybTogdWYsCiAgVW5pZm9ybXNHcm91cDogZ00sCiAgVW5pZm9ybXNMaWI6IGJ0LAogIFVuaWZvcm1zVXRpbHM6IE9jLAogIFVuc2lnbmVkQnl0ZVR5cGU6IHBuLAogIFVuc2lnbmVkSW50MTAxMTExVHlwZTogVHAsCiAgVW5zaWduZWRJbnQyNDhUeXBlOiBwYSwKICBVbnNpZ25lZEludDU5OTlUeXBlOiBFcCwKICBVbnNpZ25lZEludFR5cGU6IG5zLAogIFVuc2lnbmVkU2hvcnQ0NDQ0VHlwZTogUGMsCiAgVW5zaWduZWRTaG9ydDU1NTFUeXBlOiBJYywKICBVbnNpZ25lZFNob3J0VHlwZTogZGEsCiAgVlNNU2hhZG93TWFwOiBTbiwKICBWZWN0b3IyOiBKLAogIFZlY3RvcjM6IEUsCiAgVmVjdG9yNDogUXQsCiAgVmVjdG9yS2V5ZnJhbWVUcmFjazogYmEsCiAgVmlkZW9GcmFtZVRleHR1cmU6IGViLAogIFZpZGVvVGV4dHVyZTogRnksCiAgV2ViR0wzRFJlbmRlclRhcmdldDogX3YsCiAgV2ViR0xBcnJheVJlbmRlclRhcmdldDogeXYsCiAgV2ViR0xDb29yZGluYXRlU3lzdGVtOiBOaSwKICBXZWJHTEN1YmVSZW5kZXJUYXJnZXQ6IEV5LAogIFdlYkdMUmVuZGVyVGFyZ2V0OiBSbiwKICBXZWJHTFJlbmRlcmVyOiBDXywKICBXZWJHTFV0aWxzOiBUXywKICBXZWJHUFVDb29yZGluYXRlU3lzdGVtOiBnYSwKICBXZWJYUkNvbnRyb2xsZXI6IFRoLAogIFdpcmVmcmFtZUdlb21ldHJ5OiBacCwKICBXcmFwQXJvdW5kRW5kaW5nOiBBbywKICBaZXJvQ3VydmF0dXJlRW5kaW5nOiBzciwKICBaZXJvRmFjdG9yOiBMMCwKICBaZXJvU2xvcGVFbmRpbmc6IHJyLAogIFplcm9TdGVuY2lsT3A6IEN4LAogIGNyZWF0ZUNhbnZhc0VsZW1lbnQ6IF95Cn0pOwpmdW5jdGlvbiBiYyhhKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYSkpCiAgICByZXR1cm4gYS5tYXAoKG4pID0+IGJjKG4pKTsKICBpZiAodHlwZW9mIGEgPT0gIm9iamVjdCIpIHsKICAgIHZhciB0ID0ge307CiAgICBmb3IgKHZhciBbZSwgaV0gb2YgT2JqZWN0LmVudHJpZXMoYSkpCiAgICAgIHRbZV0gPSBiYyhpKTsKICAgIHJldHVybiB0OwogIH0gZWxzZQogICAgcmV0dXJuIGE7Cn0KZnVuY3Rpb24geHMoYSwgdCA9IDEpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShhKSA/IGEuZmxhdCh0KSA6IGE7Cn0KZnVuY3Rpb24gdXAoYSwgdCwgZSA9IDFlLTkpIHsKICBpZiAoQXJyYXkuaXNBcnJheShhKSAmJiBBcnJheS5pc0FycmF5KHQpKQogICAgcmV0dXJuIGEubGVuZ3RoID09PSB0Lmxlbmd0aCAmJiBhLmV2ZXJ5KChzLCByKSA9PiB1cChzLCB0W3JdKSk7CiAgaWYgKHR5cGVvZiBhID09ICJvYmplY3QiICYmIHR5cGVvZiB0ID09ICJvYmplY3QiKSB7CiAgICB2YXIgaSA9IE9iamVjdC5rZXlzKGEpLCBuID0gT2JqZWN0LmtleXModCk7CiAgICByZXR1cm4gaS5sZW5ndGggPT0gbi5sZW5ndGggJiYgaS5ldmVyeSgocykgPT4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHMpKSA/IGkuZXZlcnkoKHMpID0+IHVwKGFbc10sIHRbc10pKSA6ICExOwogIH0gZWxzZQogICAgcmV0dXJuIE51bWJlcihhKSA9PT0gYSAmJiBOdW1iZXIodCkgPT09IHQgPyBNYXRoLmFicyhhIC0gdCkgPCBlIDogYSA9PT0gdDsKfQpmdW5jdGlvbiBSXyhhLCB0KSB7CiAgYSAmJiAodChhKSwgYS5jaGlsZHJlbiAmJiBhLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgYS5jaGlsZHJlbi5mb3JFYWNoKChlKSA9PiB7CiAgICBSXyhlLCB0KTsKICB9KSk7Cn0KZnVuY3Rpb24gUF8oYSkgewogIHZhciB0OwogIGlmIChhKSB7CiAgICBhLmRpc3Bvc2UoKTsKICAgIGZvciAoY29uc3QgZSBvZiBPYmplY3QudmFsdWVzKGEuYXR0cmlidXRlcykpCiAgICAgICh0ID0gZSA9PSBudWxsID8gdm9pZCAwIDogZS5kaXNwb3NlKSA9PSBudWxsIHx8IHQuY2FsbChlKTsKICB9Cn0KZnVuY3Rpb24gQUUoYSkgewogIGEuZ2VvbWV0cnkgJiYgUF8oYS5nZW9tZXRyeSksIGEubWF0ZXJpYWwgJiYgKEFycmF5LmlzQXJyYXkoYS5tYXRlcmlhbCkgPyBhLm1hdGVyaWFsLmZvckVhY2goKHQpID0+IHQuZGlzcG9zZSgpKSA6IGEubWF0ZXJpYWwuZGlzcG9zZSgpKTsKfQpmdW5jdGlvbiBtZShhKSB7CiAgYSAmJiAoQXJyYXkuaXNBcnJheShhLmNoaWxkcmVuKSAmJiBhLmNoaWxkcmVuLmZvckVhY2gobWUpLCBhLmRpc3Bvc2UgPyBhLmRpc3Bvc2UoKSA6IEFycmF5LmlzQXJyYXkoYSkgPyBhLmZvckVhY2gobWUpIDogKGEuaXNNZXNoIHx8IGEuaXNMaW5lKSAmJiBBRShhKSk7Cn0KY2xhc3MgRUUgewogIGNvbnN0cnVjdG9yKCkgewogICAgayh0aGlzLCAiZ2V0c2hvcnRjdXRzIiwgKHQpID0+IHRoaXMua2V5TWFwcGluZ1t0XS5yZXBsYWNlKCJLZXkiLCAiIikpOwogICAgayh0aGlzLCAiZ2V0IiwgKHQsIGUpID0+IHRbdGhpcy5rZXlNYXBwaW5nW2VdXSk7CiAgICBrKHRoaXMsICJzZXQiLCAodCkgPT4gewogICAgICBmb3IgKHZhciBlIGluIHQpCiAgICAgICAgdGhpcy5rZXlNYXBwaW5nW2VdID0gdFtlXTsKICAgIH0pOwogICAgdGhpcy5rZXlNYXBwaW5nID0gewogICAgICBzaGlmdDogImN0cmxLZXkiLAogICAgICBjdHJsOiAic2hpZnRLZXkiLAogICAgICBtZXRhOiAiYWx0S2V5IiwKICAgICAgYWx0OiAibWV0YUtleSIKICAgIH07CiAgfQogIGdldF9jb25maWcoKSB7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5rZXlNYXBwaW5nKTsKICB9Cn0KZnVuY3Rpb24ga2woYSkgewogIHJldHVybiBNYXRoLnJvdW5kKE1hdGguUEkgKiBhKTsKfQpjb25zdCBEZSA9IG5ldyBFRSgpOwpjbGFzcyBURSB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBrKHRoaXMsICJhZGQiLCAodCwgZSwgaSwgbiA9ICExKSA9PiB7CiAgICAgIHQuYWRkRXZlbnRMaXN0ZW5lcihlLCBpLCBuKSwgdGhpcy5saXN0ZW5lcnMucHVzaCh7CiAgICAgICAgdGFyZ2V0OiB0LAogICAgICAgIGV2ZW50OiBlLAogICAgICAgIGhhbmRsZXI6IGksCiAgICAgICAgb3B0aW9uczogbgogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy5saXN0ZW5lcnMgPSBbXTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMubGlzdGVuZXJzLmZvckVhY2goKHsgdGFyZ2V0OiB0LCBldmVudDogZSwgaGFuZGxlcjogaSwgb3B0aW9uczogbiB9KSA9PiB7CiAgICAgIHQucmVtb3ZlRXZlbnRMaXN0ZW5lcihlLCBpLCBuKTsKICAgIH0pLCB0aGlzLmxpc3RlbmVycyA9IFtdOwogIH0KfQpjbGFzcyBZYSB7CiAgY29uc3RydWN0b3IodCwgZSwgaSwgbikgewogICAgayh0aGlzLCAiX25vdGlmeSIsICh0LCBlID0gITApID0+IHsKICAgICAgaWYgKHRoaXMudHlwZSA9PSAicGxhbmUiKSB7CiAgICAgICAgY29uc3QgaSA9IHt9OwogICAgICAgIGlbYGNsaXBfc2xpZGVyXyR7dGhpcy5pbmRleCAtIDF9YF0gPSBwYXJzZUZsb2F0KHQpLCB0aGlzLmRpc3BsYXkudmlld2VyLmNoZWNrQ2hhbmdlcyhpLCBlKTsKICAgICAgfQogICAgfSk7CiAgICBrKHRoaXMsICJzbGlkZXJDaGFuZ2UiLCAodCkgPT4gewogICAgICBjb25zdCBlID0gdC50YXJnZXQudmFsdWU7CiAgICAgIHRoaXMuaW5wdXQudmFsdWUgPSBNYXRoLnJvdW5kKDFlMyAqIGUpIC8gMWUzLCB0aGlzLl9oYW5kbGUodGhpcy50eXBlLCB0aGlzLmluZGV4LCB0aGlzLmlucHV0LnZhbHVlKSwgdGhpcy5fbm90aWZ5KGUpOwogICAgfSk7CiAgICBrKHRoaXMsICJpbnB1dENoYW5nZSIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSBNYXRoLm1heCgKICAgICAgICBNYXRoLm1pbih0LnRhcmdldC52YWx1ZSwgdGhpcy5zbGlkZXIubWF4KSwKICAgICAgICB0aGlzLnNsaWRlci5taW4KICAgICAgKTsKICAgICAgdGhpcy5zbGlkZXIudmFsdWUgPSBlLCB0aGlzLl9oYW5kbGUodGhpcy50eXBlLCB0aGlzLmluZGV4LCB0aGlzLmlucHV0LnZhbHVlKSwgdGhpcy5fbm90aWZ5KGUpOwogICAgfSk7CiAgICB0LnN0YXJ0c1dpdGgoInBsYW5lIikgPyAodGhpcy5pbmRleCA9IHBhcnNlSW50KHQuc3Vic3RyaW5nKDUpKSwgdGhpcy50eXBlID0gInBsYW5lIikgOiAodGhpcy5pbmRleCA9IHZvaWQgMCwgdGhpcy50eXBlID0gdCksIHRoaXMuZGlzcGxheSA9IG4sIHRoaXMuc2xpZGVyID0gbi5jb250YWluZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgKICAgICAgYHRjdl9zbGRfdmFsdWVfJHt0fWAKICAgIClbMF0sIHRoaXMuc2xpZGVyLm1pbiA9IGUsIHRoaXMuc2xpZGVyLm1heCA9IGksIHRoaXMuaW5wdXQgPSBuLmNvbnRhaW5lci5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKAogICAgICBgdGN2X2lucF92YWx1ZV8ke3R9YAogICAgKVswXSwgdGhpcy5pbnB1dC52YWx1ZSA9IGksIHRoaXMuc2xpZGVyLm9uaW5wdXQgPSB0aGlzLnNsaWRlckNoYW5nZSwgdGhpcy5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCB0aGlzLmlucHV0Q2hhbmdlKTsKICB9CiAgX2hhbmRsZSh0LCBlLCBpKSB7CiAgICB0ID09ICJwbGFuZSIgPyB0aGlzLmRpc3BsYXkucmVmcmVzaFBsYW5lKGUsIGkpIDogdCA9PT0gImFtYmllbnRsaWdodCIgPyB0aGlzLmRpc3BsYXkudmlld2VyLnJlYWR5ICYmIHRoaXMuZGlzcGxheS52aWV3ZXIuc2V0QW1iaWVudExpZ2h0KGkgLyAxMDApIDogdCA9PT0gInBvaW50bGlnaHQiID8gdGhpcy5kaXNwbGF5LnZpZXdlci5yZWFkeSAmJiB0aGlzLmRpc3BsYXkudmlld2VyLnNldERpcmVjdExpZ2h0KGkgLyAxMDApIDogdCA9PT0gIm1ldGFsbmVzcyIgPyB0aGlzLmRpc3BsYXkudmlld2VyLnJlYWR5ICYmIHRoaXMuZGlzcGxheS52aWV3ZXIuc2V0TWV0YWxuZXNzKGkgLyAxMDApIDogdCA9PT0gInJvdWdobmVzcyIgJiYgdGhpcy5kaXNwbGF5LnZpZXdlci5yZWFkeSAmJiB0aGlzLmRpc3BsYXkudmlld2VyLnNldFJvdWdobmVzcyhpIC8gMTAwKTsKICB9CiAgc2V0U2xpZGVyKHQpIHsKICAgIGNvbnN0IGUgPSBNYXRoLmFicyhNYXRoLnJvdW5kKE1hdGgubG9nMTAoMiAqIHQpKSk7CiAgICB0aGlzLnNsaWRlci5taW4gPSAtdCwgdGhpcy5zbGlkZXIubWF4ID0gdCwgdGhpcy5zbGlkZXIuc3RlcCA9IE1hdGgucG93KDEwLCAtKDMgLSBlKSksIHRoaXMuc2xpZGVyLnZhbHVlID0gdCwgdGhpcy5pbnB1dC52YWx1ZSA9IE1hdGgucm91bmQoMWUzICogdGhpcy5zbGlkZXIubWF4KSAvIDFlMywgdGhpcy5kaXNwbGF5LnJlZnJlc2hQbGFuZSh0aGlzLmluZGV4LCB0aGlzLmlucHV0LnZhbHVlKTsKICB9CiAgZ2V0VmFsdWUoKSB7CiAgICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmlucHV0LnZhbHVlKTsKICB9CiAgc2V0VmFsdWUodCwgZSA9ICEwKSB7CiAgICBjb25zdCBpID0gTWF0aC5tYXgoCiAgICAgIE1hdGgubWluKHQsIHRoaXMuc2xpZGVyLm1heCksCiAgICAgIHRoaXMuc2xpZGVyLm1pbgogICAgKTsKICAgIHRoaXMuaW5wdXQudmFsdWUgPSBNYXRoLnJvdW5kKDFlMyAqIGkpIC8gMWUzLCB0aGlzLnNsaWRlci52YWx1ZSA9IHQsIHRoaXMuX2hhbmRsZSh0aGlzLnR5cGUsIHRoaXMuaW5kZXgsIHRoaXMuaW5wdXQudmFsdWUpLCB0aGlzLl9ub3RpZnkodCwgZSk7CiAgfQp9CmNsYXNzIENFIHsKICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICBrKHRoaXMsICJtaW5pbWl6ZSIsICh0ID0gbnVsbCkgPT4gewogICAgICB0aGlzLl90b2dnbGUoITAsIHQpOwogICAgfSk7CiAgICBrKHRoaXMsICJtYXhpbWl6ZSIsICh0ID0gbnVsbCkgPT4gewogICAgICB0aGlzLl90b2dnbGUoITApLCB0aGlzLl90b2dnbGUoITEsIHQpOwogICAgfSk7CiAgICB0aGlzLmlkID0gZSwgdGhpcy5jb250YWluZXIgPSB0LCB0aGlzLmRpc3BsYXkgPSBpLCB0aGlzLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWxlYXZlIiwgKG4pID0+IHsKICAgICAgKHRoaXMuZGlzcGxheS5nbGFzcyA/IHRoaXMuZGlzcGxheS5jYWRXaWR0aCA6IHRoaXMuZGlzcGxheS5jYWRXaWR0aCArIHRoaXMuZGlzcGxheS50cmVlV2lkdGgpIDwgdGhpcy5kaXNwbGF5LndpZHRoVGhyZXNob2xkKCkgJiYgdGhpcy5taW5pbWl6ZSgpOwogICAgfSksIHRoaXMuYnV0dG9ucyA9IHt9LCB0aGlzLmVsbGlwc2VzID0gW10sIHRoaXMudG9nZ2xlcyA9IHsgMDogW10sIDE6IFtdLCAyOiBbXSwgMzogW10gfTsKICB9CiAgYWRkQnV0dG9uKHQsIGUpIHsKICAgIHQuc2V0SWQodGhpcy5pZCksIHRoaXMuYnV0dG9uc1t0Lm5hbWVdID0gdCwgZSAhPSAtMSAmJiB0aGlzLnRvZ2dsZXNbZV0ucHVzaCh0KSwgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodC5odG1sKTsKICB9CiAgYWRkU2VwYXJhdG9yKCkgewogICAgdmFyIHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICB0LmNsYXNzTmFtZSA9ICJ0Y3Zfc2VwYXJhdG9yIiwgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodCk7CiAgfQogIGFkZEVsbGlwc2lzKHQpIHsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZENoaWxkKHQuaHRtbCksIHRoaXMuZWxsaXBzZXMucHVzaCh0Lmh0bWwpOwogIH0KICBkZWZpbmVHcm91cCh0KSB7CiAgICBmb3IgKHZhciBlIG9mIHQpCiAgICAgIGZvciAodmFyIGkgb2YgdCkKICAgICAgICBpICE9IGUgJiYgZS5hZGRHcm91cE1lbWJlcihpKTsKICB9CiAgX3RvZ2dsZSh0LCBlID0gbnVsbCkgewogICAgdmFyIGksIG47CiAgICBlID09IG51bGwgPyAoaSA9IHRoaXMudG9nZ2xlcywgbiA9IHRoaXMuZWxsaXBzZXMpIDogKGkgPSB7fSwgaVtlXSA9IHRoaXMudG9nZ2xlc1tlXSwgbiA9IFt0aGlzLmVsbGlwc2VzW2VdXSk7CiAgICBmb3IgKHZhciBzIG9mIG4pCiAgICAgIHQgPyBzLmNsYXNzTGlzdC5yZW1vdmUoInRjdl91bnZpc2libGUiKSA6IHMuY2xhc3NMaXN0LmFkZCgidGN2X3VudmlzaWJsZSIpOwogICAgZm9yICh2YXIgciBpbiBpKQogICAgICBmb3IgKHZhciBvIG9mIGlbcl0pCiAgICAgICAgIXQgJiYgKG8ubmFtZSA9PT0gImRpc3RhbmNlIiAmJiAhdGhpcy5kaXNwbGF5Lm1lYXN1cmVUb29scyB8fCBvLm5hbWUgPT09ICJwcm9wZXJ0aWVzIiAmJiAhdGhpcy5kaXNwbGF5Lm1lYXN1cmVUb29scyB8fCBvLm5hbWUgPT09ICJzZWxlY3QiICYmICF0aGlzLmRpc3BsYXkuc2VsZWN0VG9vbCB8fCBvLm5hbWUgPT09ICJleHBsb2RlIiAmJiAhdGhpcy5kaXNwbGF5LmV4cGxvZGVUb29sKSB8fCBvLnNob3coIXQpOwogIH0KfQpjbGFzcyBWbCB7CiAgY29uc3RydWN0b3IodCwgZSkgewogICAgdGhpcy5pZCA9IHQsIHRoaXMuYWN0aW9uID0gZTsKICAgIHZhciBpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgaS5pbm5lckhUTUwgPSAiLi4uIiwgaS5jbGFzc05hbWUgPSAidGN2X2VsbGlwc2lzIHRjdl91bnZpc2libGUiLCB0aGlzLmh0bWwgPSBpLCB0aGlzLmh0bWwuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VlbnRlciIsIChuKSA9PiB7CiAgICAgIHRoaXMuYWN0aW9uKHRoaXMuaWQpOwogICAgfSk7CiAgfQp9CmNsYXNzIElfIHsKICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKICAgIGsodGhpcywgImhhbmRsZXIiLCAodCkgPT4gewogICAgICBjb25zb2xlLmxvZygibm90IGltcGxlbWVudGVkIHlldCIpOwogICAgfSk7CiAgICB0aGlzLm5hbWUgPSBlOwogICAgdmFyIG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBuLmNsYXNzTmFtZSA9ICJ0Y3ZfdG9vbHRpcCIsIG4uc2V0QXR0cmlidXRlKCJkYXRhLXRvb2x0aXAiLCBpKTsKICAgIHZhciBzID0gbi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIikpOwogICAgcy5jbGFzc05hbWUgPSAidGN2X2J1dHRvbl9mcmFtZSIsIHMuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKSksIHMuY2hpbGRyZW5bMF0uY2xhc3NOYW1lID0gInRjdl9yZXNldCB0Y3ZfYnRuIiwgcy5jaGlsZHJlblswXS50eXBlID0gImJ1dHRvbiIsIHMuY2hpbGRyZW5bMF0uY2xhc3NMaXN0LmFkZChgdGN2X2J1dHRvbl8ke2V9YCksIHRoaXMuaHRtbCA9IG4sIHRoaXMuaHRtbC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChyKSA9PiB7CiAgICAgIHRoaXMuaGFuZGxlcihyKTsKICAgIH0pOwogIH0KICBkaXNwb3NlKCkgewogICAgdGhpcy5odG1sID0gIiIsIHRoaXMuY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5oYW5kbGVyKTsKICB9CiAgc2V0SWQodCkgewogICAgdGhpcy5jb250YWluZXJJZCA9IHQ7CiAgfQogIGFsaWduUmlnaHQoKSB7CiAgICB0aGlzLmh0bWwuY2xhc3NMaXN0LmFkZCgidGN2X2FsaWduX3JpZ2h0Iik7CiAgfQogIHNob3codCkgewogICAgdGhpcy5odG1sLnN0eWxlLmRpc3BsYXkgPSB0ID8gImlubGluZS1ibG9jayIgOiAibm9uZSI7CiAgfQp9CmNsYXNzIEtpIGV4dGVuZHMgSV8gewogIGNvbnN0cnVjdG9yKGUsIGksIG4sIHMpIHsKICAgIHN1cGVyKGUsIGksIG4pOwogICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzCiAgICBrKHRoaXMsICJoYW5kbGVyIiwgKGUpID0+IHsKICAgICAgdGhpcy5hY3Rpb24odGhpcy5uYW1lLCBEZS5nZXQoZSwgInNoaWZ0IikpOwogICAgfSk7CiAgICBrKHRoaXMsICJoaWdobGlnaHQiLCAoZSkgPT4gewogICAgICBlID8gdGhpcy5odG1sLmZpcnN0Q2hpbGQuY2xhc3NMaXN0LmFkZCgidGN2X2J0bl9oaWdobGlnaHQiKSA6IHRoaXMuaHRtbC5maXJzdENoaWxkLmNsYXNzTGlzdC5yZW1vdmUoInRjdl9idG5faGlnaGxpZ2h0Iik7CiAgICB9KTsKICAgIHRoaXMuYWN0aW9uID0gczsKICB9Cn0KY2xhc3MgUWkgZXh0ZW5kcyBJXyB7CiAgY29uc3RydWN0b3IoZSwgaSwgbiwgcywgciA9ICExLCBvID0gbnVsbCkgewogICAgc3VwZXIoZSwgaSwgbik7CiAgICBrKHRoaXMsICJnZXQiLCAoKSA9PiB0aGlzLnN0YXRlKTsKICAgIGsodGhpcywgInNldCIsIChlKSA9PiB7CiAgICAgIHRoaXMuc3RhdGUgPSBlLCB0aGlzLmh0bWwuY2hpbGRyZW5bMF0uY2xhc3NMaXN0LnRvZ2dsZSgidGN2X2J0bl9jbGljazIiLCB0aGlzLnN0YXRlKTsKICAgIH0pOwogICAgayh0aGlzLCAiY2xlYXJHcm91cCIsICgpID0+IHsKICAgICAgZm9yICh2YXIgZSBvZiB0aGlzLnNhbWVHcm91cCkKICAgICAgICBlLnN0YXRlICYmIChlLnN0YXRlID0gITEsIGUuaHRtbC5jaGlsZHJlblswXS5jbGFzc0xpc3QucmVtb3ZlKCJ0Y3ZfYnRuX2NsaWNrMiIpLCBlLmFjdGlvbih0aGlzLm5hbWUsICExKSk7CiAgICB9KTsKICAgIGsodGhpcywgImV4dHJhY3RJZEZyb21OYW1lIiwgKGUpID0+IHsKICAgICAgY29uc3QgaSA9ICJncmlkLSIsIG4gPSBlLmluZGV4T2YoaSkgKyBpLmxlbmd0aCwgcyA9IGUuaW5kZXhPZigiXyIsIG4pOwogICAgICByZXR1cm4gZS5zbGljZShuLCBzKTsKICAgIH0pOwogICAgayh0aGlzLCAiaGFuZGxlciIsIChlKSA9PiB7CiAgICAgIGNvbnN0IGkgPSB0aGlzLmV4dHJhY3RJZEZyb21OYW1lKGUudGFyZ2V0LmlkKTsKICAgICAgaWYgKHRoaXMuZHJvcGRvd24gIT0gbnVsbCAmJiBpICYmIHRoaXMuZHJvcGRvd24uaW5jbHVkZXMoaSkpIHsKICAgICAgICBjb25zdCBuID0gZS50YXJnZXQuY2hlY2tlZDsKICAgICAgICB0aGlzLmFjdGlvbihgZ3JpZC0ke2l9YCwgbiksIHRoaXMuY2hlY2tFbGVtc1tpXS5jaGVja2VkID0gbjsKICAgICAgfSBlbHNlIGUudGFyZ2V0LnR5cGUgPT09ICJidXR0b24iICYmICh0aGlzLnN0YXRlIHx8IHRoaXMuY2xlYXJHcm91cCgpLCB0aGlzLnNldCghdGhpcy5zdGF0ZSksIHRoaXMuYWN0aW9uKHRoaXMubmFtZSwgdGhpcy5zdGF0ZSkpOwogICAgfSk7CiAgICBpZiAodGhpcy5hY3Rpb24gPSBzLCB0aGlzLnN0YXRlID0gciwgdGhpcy5kcm9wZG93biA9IG8sIHRoaXMuc2FtZUdyb3VwID0gW10sIHRoaXMuY2hlY2tFbGVtcyA9IHt9LCBvICE9IG51bGwpIHsKICAgICAgY29uc3QgaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgaC5jbGFzc0xpc3QuYWRkKCJ0Y3ZfZ3JpZC1jb250ZW50IiksIGguY2xhc3NMaXN0LmFkZCgidGN2X2Ryb3Bkb3duLWNvbnRlbnQiKSwgaC5jbGFzc0xpc3QuYWRkKCJ0Y3Zfcm91bmQiKTsKICAgICAgZm9yICh2YXIgbCBvZiBvKSB7CiAgICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGMuY2xhc3NOYW1lID0gInRjdl90b29sdGlwIiwgYy5zZXRBdHRyaWJ1dGUoImRhdGEtdG9vbHRpcCIsIGAke259ICR7bH1gKSwgYy5pbm5lckhUTUwgPSBgPGlucHV0IGNsYXNzPSd0Y3ZfZ3JpZC0ke2x9IHRjdl9jaGVjayB0Y3ZfZHJvcGRvd24tZW50cnknIGlkPSd0Y3ZfZ3JpZC0ke2x9XyR7dGhpcy5jb250YWluZXJJZH0nIHR5cGU9ImNoZWNrYm94Ij48bGFiZWwgZm9yPSd0Y3ZfZ3JpZC0ke2x9XyR7dGhpcy5jb250YWluZXJJZH0nIGNsYXNzPSJ0Y3ZfbGFiZWwgdGN2X2Ryb3Bkb3duLWVudHJ5Ij4ke2x9PC9sYWJlbD5gLCBoLmFwcGVuZENoaWxkKGMpLCB0aGlzLmNoZWNrRWxlbXNbbF0gPSBjLmNoaWxkcmVuWzBdOwogICAgICB9CiAgICAgIHRoaXMuaHRtbC5jaGlsZHJlblswXS5hcHBlbmRDaGlsZChoKSwgdGhpcy5odG1sLmNoaWxkcmVuWzBdLmNsYXNzTGlzdC5hZGQoInRjdl9ncmlkLWRyb3Bkb3duIik7CiAgICB9CiAgfQogIGFkZEdyb3VwTWVtYmVyKGUpIHsKICAgIHRoaXMuc2FtZUdyb3VwLnB1c2goZSk7CiAgfQp9CmNvbnN0IGFnID0gbmV3IHdlKCksIEhsID0gbmV3IEUoKTsKbGV0IGZmID0gY2xhc3MgZXh0ZW5kcyBvdSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBsaW5lIHNlZ21lbnRzIGdlb21ldHJ5LgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0xpbmVTZWdtZW50c0dlb21ldHJ5ID0gITAsIHRoaXMudHlwZSA9ICJMaW5lU2VnbWVudHNHZW9tZXRyeSI7CiAgICBjb25zdCB0ID0gWy0xLCAyLCAwLCAxLCAyLCAwLCAtMSwgMSwgMCwgMSwgMSwgMCwgLTEsIDAsIDAsIDEsIDAsIDAsIC0xLCAtMSwgMCwgMSwgLTEsIDBdLCBlID0gWy0xLCAyLCAxLCAyLCAtMSwgMSwgMSwgMSwgLTEsIC0xLCAxLCAtMSwgLTEsIC0yLCAxLCAtMl0sIGkgPSBbMCwgMiwgMSwgMiwgMywgMSwgMiwgNCwgMywgNCwgNSwgMywgNCwgNiwgNSwgNiwgNywgNV07CiAgICB0aGlzLnNldEluZGV4KGkpLCB0aGlzLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgd3QodCwgMykpLCB0aGlzLnNldEF0dHJpYnV0ZSgidXYiLCBuZXcgd3QoZSwgMikpOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiA0eDQgdHJhbnNmb3JtYXRpb24gbWF0cml4IHRvIHRoZSBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIG1hdHJpeCB0byBhcHBseS4KICAgKiBAcmV0dXJuIHtMaW5lU2VnbWVudHNHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhcHBseU1hdHJpeDQodCkgewogICAgY29uc3QgZSA9IHRoaXMuYXR0cmlidXRlcy5pbnN0YW5jZVN0YXJ0LCBpID0gdGhpcy5hdHRyaWJ1dGVzLmluc3RhbmNlRW5kOwogICAgcmV0dXJuIGUgIT09IHZvaWQgMCAmJiAoZS5hcHBseU1hdHJpeDQodCksIGkuYXBwbHlNYXRyaXg0KHQpLCBlLm5lZWRzVXBkYXRlID0gITApLCB0aGlzLmJvdW5kaW5nQm94ICE9PSBudWxsICYmIHRoaXMuY29tcHV0ZUJvdW5kaW5nQm94KCksIHRoaXMuYm91bmRpbmdTcGhlcmUgIT09IG51bGwgJiYgdGhpcy5jb21wdXRlQm91bmRpbmdTcGhlcmUoKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gbGluZSBwb3NpdGlvbnMgZm9yIHRoaXMgZ2VvbWV0cnkuIFRoZSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIHNpeCBzaW5jZQogICAqIGVhY2ggbGluZSBzZWdtZW50IGlzIGRlZmluZWQgYnkgYSBzdGFydCBlbmQgdmVydGV4IGluIHRoZSBwYXR0ZXJuIGAoeHl6IHh5eilgLgogICAqCiAgICogQHBhcmFtIHtGbG9hdDMyQXJyYXl8QXJyYXk8bnVtYmVyPn0gYXJyYXkgLSBUaGUgcG9zaXRpb24gZGF0YSB0byBzZXQuCiAgICogQHJldHVybiB7TGluZVNlZ21lbnRzR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgZ2VvbWV0cnkuCiAgICovCiAgc2V0UG9zaXRpb25zKHQpIHsKICAgIGxldCBlOwogICAgdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSA/IGUgPSB0IDogQXJyYXkuaXNBcnJheSh0KSAmJiAoZSA9IG5ldyBGbG9hdDMyQXJyYXkodCkpOwogICAgY29uc3QgaSA9IG5ldyB2YyhlLCA2LCAxKTsKICAgIHJldHVybiB0aGlzLnNldEF0dHJpYnV0ZSgiaW5zdGFuY2VTdGFydCIsIG5ldyB1bihpLCAzLCAwKSksIHRoaXMuc2V0QXR0cmlidXRlKCJpbnN0YW5jZUVuZCIsIG5ldyB1bihpLCAzLCAzKSksIHRoaXMuaW5zdGFuY2VDb3VudCA9IHRoaXMuYXR0cmlidXRlcy5pbnN0YW5jZVN0YXJ0LmNvdW50LCB0aGlzLmNvbXB1dGVCb3VuZGluZ0JveCgpLCB0aGlzLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBsaW5lIGNvbG9ycyBmb3IgdGhpcyBnZW9tZXRyeS4gVGhlIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2Ygc2l4IHNpbmNlCiAgICogZWFjaCBsaW5lIHNlZ21lbnQgaXMgZGVmaW5lZCBieSBhIHN0YXJ0IGVuZCBjb2xvciBpbiB0aGUgcGF0dGVybiBgKHJnYiByZ2IpYC4KICAgKgogICAqIEBwYXJhbSB7RmxvYXQzMkFycmF5fEFycmF5PG51bWJlcj59IGFycmF5IC0gVGhlIHBvc2l0aW9uIGRhdGEgdG8gc2V0LgogICAqIEByZXR1cm4ge0xpbmVTZWdtZW50c0dlb21ldHJ5fSBBIHJlZmVyZW5jZSB0byB0aGlzIGdlb21ldHJ5LgogICAqLwogIHNldENvbG9ycyh0KSB7CiAgICBsZXQgZTsKICAgIHQgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgPyBlID0gdCA6IEFycmF5LmlzQXJyYXkodCkgJiYgKGUgPSBuZXcgRmxvYXQzMkFycmF5KHQpKTsKICAgIGNvbnN0IGkgPSBuZXcgdmMoZSwgNiwgMSk7CiAgICByZXR1cm4gdGhpcy5zZXRBdHRyaWJ1dGUoImluc3RhbmNlQ29sb3JTdGFydCIsIG5ldyB1bihpLCAzLCAwKSksIHRoaXMuc2V0QXR0cmlidXRlKCJpbnN0YW5jZUNvbG9yRW5kIiwgbmV3IHVuKGksIDMsIDMpKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0dXBzIHRoaXMgbGluZSBzZWdtZW50cyBnZW9tZXRyeSBmcm9tIHRoZSBnaXZlbiB3aXJlZnJhbWUgZ2VvbWV0cnkuCiAgICoKICAgKiBAcGFyYW0ge1dpcmVmcmFtZUdlb21ldHJ5fSBnZW9tZXRyeSAtIFRoZSBnZW9tZXRyeSB0aGF0IHNob3VsZCBiZSB1c2VkIGFzIGEgZGF0YSBzb3VyY2UgZm9yIHRoaXMgZ2VvbWV0cnkuCiAgICogQHJldHVybiB7TGluZVNlZ21lbnRzR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgZ2VvbWV0cnkuCiAgICovCiAgZnJvbVdpcmVmcmFtZUdlb21ldHJ5KHQpIHsKICAgIHJldHVybiB0aGlzLnNldFBvc2l0aW9ucyh0LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXkpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXR1cHMgdGhpcyBsaW5lIHNlZ21lbnRzIGdlb21ldHJ5IGZyb20gdGhlIGdpdmVuIGVkZ2VzIGdlb21ldHJ5LgogICAqCiAgICogQHBhcmFtIHtFZGdlc0dlb21ldHJ5fSBnZW9tZXRyeSAtIFRoZSBnZW9tZXRyeSB0aGF0IHNob3VsZCBiZSB1c2VkIGFzIGEgZGF0YSBzb3VyY2UgZm9yIHRoaXMgZ2VvbWV0cnkuCiAgICogQHJldHVybiB7TGluZVNlZ21lbnRzR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgZ2VvbWV0cnkuCiAgICovCiAgZnJvbUVkZ2VzR2VvbWV0cnkodCkgewogICAgcmV0dXJuIHRoaXMuc2V0UG9zaXRpb25zKHQuYXR0cmlidXRlcy5wb3NpdGlvbi5hcnJheSksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHVwcyB0aGlzIGxpbmUgc2VnbWVudHMgZ2VvbWV0cnkgZnJvbSB0aGUgZ2l2ZW4gbWVzaC4KICAgKgogICAqIEBwYXJhbSB7TWVzaH0gbWVzaCAtIFRoZSBtZXNoIGdlb21ldHJ5IHRoYXQgc2hvdWxkIGJlIHVzZWQgYXMgYSBkYXRhIHNvdXJjZSBmb3IgdGhpcyBnZW9tZXRyeS4KICAgKiBAcmV0dXJuIHtMaW5lU2VnbWVudHNHZW9tZXRyeX0gQSByZWZlcmVuY2UgdG8gdGhpcyBnZW9tZXRyeS4KICAgKi8KICBmcm9tTWVzaCh0KSB7CiAgICByZXR1cm4gdGhpcy5mcm9tV2lyZWZyYW1lR2VvbWV0cnkobmV3IFpwKHQuZ2VvbWV0cnkpKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0dXBzIHRoaXMgbGluZSBzZWdtZW50cyBnZW9tZXRyeSBmcm9tIHRoZSBnaXZlbiBsaW5lIHNlZ21lbnRzLgogICAqCiAgICogQHBhcmFtIHtMaW5lU2VnbWVudHN9IGxpbmVTZWdtZW50cyAtIFRoZSBsaW5lIHNlZ21lbnRzIHRoYXQgc2hvdWxkIGJlIHVzZWQgYXMgYSBkYXRhIHNvdXJjZSBmb3IgdGhpcyBnZW9tZXRyeS4KICAgKiBBc3N1bWVzIHRoZSBzb3VyY2UgZ2VvbWV0cnkgaXMgbm90IHVzaW5nIGluZGljZXMuCiAgICogQHJldHVybiB7TGluZVNlZ21lbnRzR2VvbWV0cnl9IEEgcmVmZXJlbmNlIHRvIHRoaXMgZ2VvbWV0cnkuCiAgICovCiAgZnJvbUxpbmVTZWdtZW50cyh0KSB7CiAgICBjb25zdCBlID0gdC5nZW9tZXRyeTsKICAgIHJldHVybiB0aGlzLnNldFBvc2l0aW9ucyhlLmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXkpLCB0aGlzOwogIH0KICBjb21wdXRlQm91bmRpbmdCb3goKSB7CiAgICB0aGlzLmJvdW5kaW5nQm94ID09PSBudWxsICYmICh0aGlzLmJvdW5kaW5nQm94ID0gbmV3IHdlKCkpOwogICAgY29uc3QgdCA9IHRoaXMuYXR0cmlidXRlcy5pbnN0YW5jZVN0YXJ0LCBlID0gdGhpcy5hdHRyaWJ1dGVzLmluc3RhbmNlRW5kOwogICAgdCAhPT0gdm9pZCAwICYmIGUgIT09IHZvaWQgMCAmJiAodGhpcy5ib3VuZGluZ0JveC5zZXRGcm9tQnVmZmVyQXR0cmlidXRlKHQpLCBhZy5zZXRGcm9tQnVmZmVyQXR0cmlidXRlKGUpLCB0aGlzLmJvdW5kaW5nQm94LnVuaW9uKGFnKSk7CiAgfQogIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpIHsKICAgIHRoaXMuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgJiYgKHRoaXMuYm91bmRpbmdTcGhlcmUgPSBuZXcgUmUoKSksIHRoaXMuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgdGhpcy5jb21wdXRlQm91bmRpbmdCb3goKTsKICAgIGNvbnN0IHQgPSB0aGlzLmF0dHJpYnV0ZXMuaW5zdGFuY2VTdGFydCwgZSA9IHRoaXMuYXR0cmlidXRlcy5pbnN0YW5jZUVuZDsKICAgIGlmICh0ICE9PSB2b2lkIDAgJiYgZSAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGkgPSB0aGlzLmJvdW5kaW5nU3BoZXJlLmNlbnRlcjsKICAgICAgdGhpcy5ib3VuZGluZ0JveC5nZXRDZW50ZXIoaSk7CiAgICAgIGxldCBuID0gMDsKICAgICAgZm9yIChsZXQgcyA9IDAsIHIgPSB0LmNvdW50OyBzIDwgcjsgcysrKQogICAgICAgIEhsLmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgcyksIG4gPSBNYXRoLm1heChuLCBpLmRpc3RhbmNlVG9TcXVhcmVkKEhsKSksIEhsLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgcyksIG4gPSBNYXRoLm1heChuLCBpLmRpc3RhbmNlVG9TcXVhcmVkKEhsKSk7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmUucmFkaXVzID0gTWF0aC5zcXJ0KG4pLCBpc05hTih0aGlzLmJvdW5kaW5nU3BoZXJlLnJhZGl1cykgJiYgY29uc29sZS5lcnJvcigiVEhSRUUuTGluZVNlZ21lbnRzR2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk6IENvbXB1dGVkIHJhZGl1cyBpcyBOYU4uIFRoZSBpbnN0YW5jZWQgcG9zaXRpb24gZGF0YSBpcyBsaWtlbHkgdG8gaGF2ZSBOYU4gdmFsdWVzLiIsIHRoaXMpOwogICAgfQogIH0KICB0b0pTT04oKSB7CiAgfQp9OwpidC5saW5lID0gewogIHdvcmxkVW5pdHM6IHsgdmFsdWU6IDEgfSwKICBsaW5ld2lkdGg6IHsgdmFsdWU6IDEgfSwKICByZXNvbHV0aW9uOiB7IHZhbHVlOiBuZXcgSigxLCAxKSB9LAogIGRhc2hPZmZzZXQ6IHsgdmFsdWU6IDAgfSwKICBkYXNoU2NhbGU6IHsgdmFsdWU6IDEgfSwKICBkYXNoU2l6ZTogeyB2YWx1ZTogMSB9LAogIGdhcFNpemU6IHsgdmFsdWU6IDEgfQogIC8vIHRvZG8gRklYIC0gbWF5YmUgY2hhbmdlIHRvIHRvdGFsU2l6ZQp9OwpmaS5saW5lID0gewogIHVuaWZvcm1zOiBPYy5tZXJnZShbCiAgICBidC5jb21tb24sCiAgICBidC5mb2csCiAgICBidC5saW5lCiAgXSksCiAgdmVydGV4U2hhZGVyOiAoCiAgICAvKiBnbHNsICovCiAgICBgCgkJI2luY2x1ZGUgPGNvbW1vbj4KCQkjaW5jbHVkZSA8Y29sb3JfcGFyc192ZXJ0ZXg+CgkJI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KCQkjaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+CgkJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4KCgkJdW5pZm9ybSBmbG9hdCBsaW5ld2lkdGg7CgkJdW5pZm9ybSB2ZWMyIHJlc29sdXRpb247CgoJCWF0dHJpYnV0ZSB2ZWMzIGluc3RhbmNlU3RhcnQ7CgkJYXR0cmlidXRlIHZlYzMgaW5zdGFuY2VFbmQ7CgoJCWF0dHJpYnV0ZSB2ZWMzIGluc3RhbmNlQ29sb3JTdGFydDsKCQlhdHRyaWJ1dGUgdmVjMyBpbnN0YW5jZUNvbG9yRW5kOwoKCQkjaWZkZWYgV09STERfVU5JVFMKCgkJCXZhcnlpbmcgdmVjNCB3b3JsZFBvczsKCQkJdmFyeWluZyB2ZWMzIHdvcmxkU3RhcnQ7CgkJCXZhcnlpbmcgdmVjMyB3b3JsZEVuZDsKCgkJCSNpZmRlZiBVU0VfREFTSAoKCQkJCXZhcnlpbmcgdmVjMiB2VXY7CgoJCQkjZW5kaWYKCgkJI2Vsc2UKCgkJCXZhcnlpbmcgdmVjMiB2VXY7CgoJCSNlbmRpZgoKCQkjaWZkZWYgVVNFX0RBU0gKCgkJCXVuaWZvcm0gZmxvYXQgZGFzaFNjYWxlOwoJCQlhdHRyaWJ1dGUgZmxvYXQgaW5zdGFuY2VEaXN0YW5jZVN0YXJ0OwoJCQlhdHRyaWJ1dGUgZmxvYXQgaW5zdGFuY2VEaXN0YW5jZUVuZDsKCQkJdmFyeWluZyBmbG9hdCB2TGluZURpc3RhbmNlOwoKCQkjZW5kaWYKCgkJdm9pZCB0cmltU2VnbWVudCggY29uc3QgaW4gdmVjNCBzdGFydCwgaW5vdXQgdmVjNCBlbmQgKSB7CgoJCQkvLyB0cmltIGVuZCBzZWdtZW50IHNvIGl0IHRlcm1pbmF0ZXMgYmV0d2VlbiB0aGUgY2FtZXJhIHBsYW5lIGFuZCB0aGUgbmVhciBwbGFuZQoKCQkJLy8gY29uc2VydmF0aXZlIGVzdGltYXRlIG9mIHRoZSBuZWFyIHBsYW5lCgkJCWZsb2F0IGEgPSBwcm9qZWN0aW9uTWF0cml4WyAyIF1bIDIgXTsgLy8gM25kIGVudHJ5IGluIDN0aCBjb2x1bW4KCQkJZmxvYXQgYiA9IHByb2plY3Rpb25NYXRyaXhbIDMgXVsgMiBdOyAvLyAzbmQgZW50cnkgaW4gNHRoIGNvbHVtbgoJCQlmbG9hdCBuZWFyRXN0aW1hdGUgPSAtIDAuNSAqIGIgLyBhOwoKCQkJZmxvYXQgYWxwaGEgPSAoIG5lYXJFc3RpbWF0ZSAtIHN0YXJ0LnogKSAvICggZW5kLnogLSBzdGFydC56ICk7CgoJCQllbmQueHl6ID0gbWl4KCBzdGFydC54eXosIGVuZC54eXosIGFscGhhICk7CgoJCX0KCgkJdm9pZCBtYWluKCkgewoKCQkJI2lmZGVmIFVTRV9DT0xPUgoKCQkJCXZDb2xvci54eXogPSAoIHBvc2l0aW9uLnkgPCAwLjUgKSA/IGluc3RhbmNlQ29sb3JTdGFydCA6IGluc3RhbmNlQ29sb3JFbmQ7CgoJCQkjZW5kaWYKCgkJCSNpZmRlZiBVU0VfREFTSAoKCQkJCXZMaW5lRGlzdGFuY2UgPSAoIHBvc2l0aW9uLnkgPCAwLjUgKSA/IGRhc2hTY2FsZSAqIGluc3RhbmNlRGlzdGFuY2VTdGFydCA6IGRhc2hTY2FsZSAqIGluc3RhbmNlRGlzdGFuY2VFbmQ7CgkJCQl2VXYgPSB1djsKCgkJCSNlbmRpZgoKCQkJZmxvYXQgYXNwZWN0ID0gcmVzb2x1dGlvbi54IC8gcmVzb2x1dGlvbi55OwoKCQkJLy8gY2FtZXJhIHNwYWNlCgkJCXZlYzQgc3RhcnQgPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KCBpbnN0YW5jZVN0YXJ0LCAxLjAgKTsKCQkJdmVjNCBlbmQgPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KCBpbnN0YW5jZUVuZCwgMS4wICk7CgoJCQkjaWZkZWYgV09STERfVU5JVFMKCgkJCQl3b3JsZFN0YXJ0ID0gc3RhcnQueHl6OwoJCQkJd29ybGRFbmQgPSBlbmQueHl6OwoKCQkJI2Vsc2UKCgkJCQl2VXYgPSB1djsKCgkJCSNlbmRpZgoKCQkJLy8gc3BlY2lhbCBjYXNlIGZvciBwZXJzcGVjdGl2ZSBwcm9qZWN0aW9uLCBhbmQgc2VnbWVudHMgdGhhdCB0ZXJtaW5hdGUgZWl0aGVyIGluLCBvciBiZWhpbmQsIHRoZSBjYW1lcmEgcGxhbmUKCQkJLy8gY2xlYXJseSB0aGUgZ3B1IGZpcm13YXJlIGhhcyBhIHdheSBvZiBhZGRyZXNzaW5nIHRoaXMgaXNzdWUgd2hlbiBwcm9qZWN0aW5nIGludG8gbmRjIHNwYWNlCgkJCS8vIGJ1dCB3ZSBuZWVkIHRvIHBlcmZvcm0gbmRjLXNwYWNlIGNhbGN1bGF0aW9ucyBpbiB0aGUgc2hhZGVyLCBzbyB3ZSBtdXN0IGFkZHJlc3MgdGhpcyBpc3N1ZSBkaXJlY3RseQoJCQkvLyBwZXJoYXBzIHRoZXJlIGlzIGEgbW9yZSBlbGVnYW50IHNvbHV0aW9uIC0tIFdlc3RMYW5nbGV5CgoJCQlib29sIHBlcnNwZWN0aXZlID0gKCBwcm9qZWN0aW9uTWF0cml4WyAyIF1bIDMgXSA9PSAtIDEuMCApOyAvLyA0dGggZW50cnkgaW4gdGhlIDNyZCBjb2x1bW4KCgkJCWlmICggcGVyc3BlY3RpdmUgKSB7CgoJCQkJaWYgKCBzdGFydC56IDwgMC4wICYmIGVuZC56ID49IDAuMCApIHsKCgkJCQkJdHJpbVNlZ21lbnQoIHN0YXJ0LCBlbmQgKTsKCgkJCQl9IGVsc2UgaWYgKCBlbmQueiA8IDAuMCAmJiBzdGFydC56ID49IDAuMCApIHsKCgkJCQkJdHJpbVNlZ21lbnQoIGVuZCwgc3RhcnQgKTsKCgkJCQl9CgoJCQl9CgoJCQkvLyBjbGlwIHNwYWNlCgkJCXZlYzQgY2xpcFN0YXJ0ID0gcHJvamVjdGlvbk1hdHJpeCAqIHN0YXJ0OwoJCQl2ZWM0IGNsaXBFbmQgPSBwcm9qZWN0aW9uTWF0cml4ICogZW5kOwoKCQkJLy8gbmRjIHNwYWNlCgkJCXZlYzMgbmRjU3RhcnQgPSBjbGlwU3RhcnQueHl6IC8gY2xpcFN0YXJ0Lnc7CgkJCXZlYzMgbmRjRW5kID0gY2xpcEVuZC54eXogLyBjbGlwRW5kLnc7CgoJCQkvLyBkaXJlY3Rpb24KCQkJdmVjMiBkaXIgPSBuZGNFbmQueHkgLSBuZGNTdGFydC54eTsKCgkJCS8vIGFjY291bnQgZm9yIGNsaXAtc3BhY2UgYXNwZWN0IHJhdGlvCgkJCWRpci54ICo9IGFzcGVjdDsKCQkJZGlyID0gbm9ybWFsaXplKCBkaXIgKTsKCgkJCSNpZmRlZiBXT1JMRF9VTklUUwoKCQkJCXZlYzMgd29ybGREaXIgPSBub3JtYWxpemUoIGVuZC54eXogLSBzdGFydC54eXogKTsKCQkJCXZlYzMgdG1wRndkID0gbm9ybWFsaXplKCBtaXgoIHN0YXJ0Lnh5eiwgZW5kLnh5eiwgMC41ICkgKTsKCQkJCXZlYzMgd29ybGRVcCA9IG5vcm1hbGl6ZSggY3Jvc3MoIHdvcmxkRGlyLCB0bXBGd2QgKSApOwoJCQkJdmVjMyB3b3JsZEZ3ZCA9IGNyb3NzKCB3b3JsZERpciwgd29ybGRVcCApOwoJCQkJd29ybGRQb3MgPSBwb3NpdGlvbi55IDwgMC41ID8gc3RhcnQ6IGVuZDsKCgkJCQkvLyBoZWlnaHQgb2Zmc2V0CgkJCQlmbG9hdCBodyA9IGxpbmV3aWR0aCAqIDAuNTsKCQkJCXdvcmxkUG9zLnh5eiArPSBwb3NpdGlvbi54IDwgMC4wID8gaHcgKiB3b3JsZFVwIDogLSBodyAqIHdvcmxkVXA7CgoJCQkJLy8gZG9uJ3QgZXh0ZW5kIHRoZSBsaW5lIGlmIHdlJ3JlIHJlbmRlcmluZyBkYXNoZXMgYmVjYXVzZSB3ZQoJCQkJLy8gd29uJ3QgYmUgcmVuZGVyaW5nIHRoZSBlbmRjYXBzCgkJCQkjaWZuZGVmIFVTRV9EQVNICgoJCQkJCS8vIGNhcCBleHRlbnNpb24KCQkJCQl3b3JsZFBvcy54eXogKz0gcG9zaXRpb24ueSA8IDAuNSA/IC0gaHcgKiB3b3JsZERpciA6IGh3ICogd29ybGREaXI7CgoJCQkJCS8vIGFkZCB3aWR0aCB0byB0aGUgYm94CgkJCQkJd29ybGRQb3MueHl6ICs9IHdvcmxkRndkICogaHc7CgoJCQkJCS8vIGVuZGNhcHMKCQkJCQlpZiAoIHBvc2l0aW9uLnkgPiAxLjAgfHwgcG9zaXRpb24ueSA8IDAuMCApIHsKCgkJCQkJCXdvcmxkUG9zLnh5eiAtPSB3b3JsZEZ3ZCAqIDIuMCAqIGh3OwoKCQkJCQl9CgoJCQkJI2VuZGlmCgoJCQkJLy8gcHJvamVjdCB0aGUgd29ybGRwb3MKCQkJCXZlYzQgY2xpcCA9IHByb2plY3Rpb25NYXRyaXggKiB3b3JsZFBvczsKCgkJCQkvLyBzaGlmdCB0aGUgZGVwdGggb2YgdGhlIHByb2plY3RlZCBwb2ludHMgc28gdGhlIGxpbmUKCQkJCS8vIHNlZ21lbnRzIG92ZXJsYXAgbmVhdGx5CgkJCQl2ZWMzIGNsaXBQb3NlID0gKCBwb3NpdGlvbi55IDwgMC41ICkgPyBuZGNTdGFydCA6IG5kY0VuZDsKCQkJCWNsaXAueiA9IGNsaXBQb3NlLnogKiBjbGlwLnc7CgoJCQkjZWxzZQoKCQkJCXZlYzIgb2Zmc2V0ID0gdmVjMiggZGlyLnksIC0gZGlyLnggKTsKCQkJCS8vIHVuZG8gYXNwZWN0IHJhdGlvIGFkanVzdG1lbnQKCQkJCWRpci54IC89IGFzcGVjdDsKCQkJCW9mZnNldC54IC89IGFzcGVjdDsKCgkJCQkvLyBzaWduIGZsaXAKCQkJCWlmICggcG9zaXRpb24ueCA8IDAuMCApIG9mZnNldCAqPSAtIDEuMDsKCgkJCQkvLyBlbmRjYXBzCgkJCQlpZiAoIHBvc2l0aW9uLnkgPCAwLjAgKSB7CgoJCQkJCW9mZnNldCArPSAtIGRpcjsKCgkJCQl9IGVsc2UgaWYgKCBwb3NpdGlvbi55ID4gMS4wICkgewoKCQkJCQlvZmZzZXQgKz0gZGlyOwoKCQkJCX0KCgkJCQkvLyBhZGp1c3QgZm9yIGxpbmV3aWR0aAoJCQkJb2Zmc2V0ICo9IGxpbmV3aWR0aDsKCgkJCQkvLyBhZGp1c3QgZm9yIGNsaXAtc3BhY2UgdG8gc2NyZWVuLXNwYWNlIGNvbnZlcnNpb24gLy8gbWF5YmUgcmVzb2x1dGlvbiBzaG91bGQgYmUgYmFzZWQgb24gdmlld3BvcnQgLi4uCgkJCQlvZmZzZXQgLz0gcmVzb2x1dGlvbi55OwoKCQkJCS8vIHNlbGVjdCBlbmQKCQkJCXZlYzQgY2xpcCA9ICggcG9zaXRpb24ueSA8IDAuNSApID8gY2xpcFN0YXJ0IDogY2xpcEVuZDsKCgkJCQkvLyBiYWNrIHRvIGNsaXAgc3BhY2UKCQkJCW9mZnNldCAqPSBjbGlwLnc7CgoJCQkJY2xpcC54eSArPSBvZmZzZXQ7CgoJCQkjZW5kaWYKCgkJCWdsX1Bvc2l0aW9uID0gY2xpcDsKCgkJCXZlYzQgbXZQb3NpdGlvbiA9ICggcG9zaXRpb24ueSA8IDAuNSApID8gc3RhcnQgOiBlbmQ7IC8vIHRoaXMgaXMgYW4gYXBwcm94aW1hdGlvbgoKCQkJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD4KCQkJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc192ZXJ0ZXg+CgkJCSNpbmNsdWRlIDxmb2dfdmVydGV4PgoKCQl9CgkJYAogICksCiAgZnJhZ21lbnRTaGFkZXI6ICgKICAgIC8qIGdsc2wgKi8KICAgIGAKCQl1bmlmb3JtIHZlYzMgZGlmZnVzZTsKCQl1bmlmb3JtIGZsb2F0IG9wYWNpdHk7CgkJdW5pZm9ybSBmbG9hdCBsaW5ld2lkdGg7CgoJCSNpZmRlZiBVU0VfREFTSAoKCQkJdW5pZm9ybSBmbG9hdCBkYXNoT2Zmc2V0OwoJCQl1bmlmb3JtIGZsb2F0IGRhc2hTaXplOwoJCQl1bmlmb3JtIGZsb2F0IGdhcFNpemU7CgoJCSNlbmRpZgoKCQl2YXJ5aW5nIGZsb2F0IHZMaW5lRGlzdGFuY2U7CgoJCSNpZmRlZiBXT1JMRF9VTklUUwoKCQkJdmFyeWluZyB2ZWM0IHdvcmxkUG9zOwoJCQl2YXJ5aW5nIHZlYzMgd29ybGRTdGFydDsKCQkJdmFyeWluZyB2ZWMzIHdvcmxkRW5kOwoKCQkJI2lmZGVmIFVTRV9EQVNICgoJCQkJdmFyeWluZyB2ZWMyIHZVdjsKCgkJCSNlbmRpZgoKCQkjZWxzZQoKCQkJdmFyeWluZyB2ZWMyIHZVdjsKCgkJI2VuZGlmCgoJCSNpbmNsdWRlIDxjb21tb24+CgkJI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+CgkJI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PgoJCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgoJCSNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudD4KCgkJdmVjMiBjbG9zZXN0TGluZVRvTGluZSh2ZWMzIHAxLCB2ZWMzIHAyLCB2ZWMzIHAzLCB2ZWMzIHA0KSB7CgoJCQlmbG9hdCBtdWE7CgkJCWZsb2F0IG11YjsKCgkJCXZlYzMgcDEzID0gcDEgLSBwMzsKCQkJdmVjMyBwNDMgPSBwNCAtIHAzOwoKCQkJdmVjMyBwMjEgPSBwMiAtIHAxOwoKCQkJZmxvYXQgZDEzNDMgPSBkb3QoIHAxMywgcDQzICk7CgkJCWZsb2F0IGQ0MzIxID0gZG90KCBwNDMsIHAyMSApOwoJCQlmbG9hdCBkMTMyMSA9IGRvdCggcDEzLCBwMjEgKTsKCQkJZmxvYXQgZDQzNDMgPSBkb3QoIHA0MywgcDQzICk7CgkJCWZsb2F0IGQyMTIxID0gZG90KCBwMjEsIHAyMSApOwoKCQkJZmxvYXQgZGVub20gPSBkMjEyMSAqIGQ0MzQzIC0gZDQzMjEgKiBkNDMyMTsKCgkJCWZsb2F0IG51bWVyID0gZDEzNDMgKiBkNDMyMSAtIGQxMzIxICogZDQzNDM7CgoJCQltdWEgPSBudW1lciAvIGRlbm9tOwoJCQltdWEgPSBjbGFtcCggbXVhLCAwLjAsIDEuMCApOwoJCQltdWIgPSAoIGQxMzQzICsgZDQzMjEgKiAoIG11YSApICkgLyBkNDM0MzsKCQkJbXViID0gY2xhbXAoIG11YiwgMC4wLCAxLjAgKTsKCgkJCXJldHVybiB2ZWMyKCBtdWEsIG11YiApOwoKCQl9CgoJCXZvaWQgbWFpbigpIHsKCgkJCWZsb2F0IGFscGhhID0gb3BhY2l0eTsKCQkJdmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBhbHBoYSApOwoKCQkJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCgkJCSNpZmRlZiBVU0VfREFTSAoKCQkJCWlmICggdlV2LnkgPCAtIDEuMCB8fCB2VXYueSA+IDEuMCApIGRpc2NhcmQ7IC8vIGRpc2NhcmQgZW5kY2FwcwoKCQkJCWlmICggbW9kKCB2TGluZURpc3RhbmNlICsgZGFzaE9mZnNldCwgZGFzaFNpemUgKyBnYXBTaXplICkgPiBkYXNoU2l6ZSApIGRpc2NhcmQ7IC8vIHRvZG8gLSBGSVgKCgkJCSNlbmRpZgoKCQkJI2lmZGVmIFdPUkxEX1VOSVRTCgoJCQkJLy8gRmluZCB0aGUgY2xvc2VzdCBwb2ludHMgb24gdGhlIHZpZXcgcmF5IGFuZCB0aGUgbGluZSBzZWdtZW50CgkJCQl2ZWMzIHJheUVuZCA9IG5vcm1hbGl6ZSggd29ybGRQb3MueHl6ICkgKiAxZTU7CgkJCQl2ZWMzIGxpbmVEaXIgPSB3b3JsZEVuZCAtIHdvcmxkU3RhcnQ7CgkJCQl2ZWMyIHBhcmFtcyA9IGNsb3Nlc3RMaW5lVG9MaW5lKCB3b3JsZFN0YXJ0LCB3b3JsZEVuZCwgdmVjMyggMC4wLCAwLjAsIDAuMCApLCByYXlFbmQgKTsKCgkJCQl2ZWMzIHAxID0gd29ybGRTdGFydCArIGxpbmVEaXIgKiBwYXJhbXMueDsKCQkJCXZlYzMgcDIgPSByYXlFbmQgKiBwYXJhbXMueTsKCQkJCXZlYzMgZGVsdGEgPSBwMSAtIHAyOwoJCQkJZmxvYXQgbGVuID0gbGVuZ3RoKCBkZWx0YSApOwoJCQkJZmxvYXQgbm9ybSA9IGxlbiAvIGxpbmV3aWR0aDsKCgkJCQkjaWZuZGVmIFVTRV9EQVNICgoJCQkJCSNpZmRlZiBVU0VfQUxQSEFfVE9fQ09WRVJBR0UKCgkJCQkJCWZsb2F0IGRub3JtID0gZndpZHRoKCBub3JtICk7CgkJCQkJCWFscGhhID0gMS4wIC0gc21vb3Roc3RlcCggMC41IC0gZG5vcm0sIDAuNSArIGRub3JtLCBub3JtICk7CgoJCQkJCSNlbHNlCgoJCQkJCQlpZiAoIG5vcm0gPiAwLjUgKSB7CgoJCQkJCQkJZGlzY2FyZDsKCgkJCQkJCX0KCgkJCQkJI2VuZGlmCgoJCQkJI2VuZGlmCgoJCQkjZWxzZQoKCQkJCSNpZmRlZiBVU0VfQUxQSEFfVE9fQ09WRVJBR0UKCgkJCQkJLy8gYXJ0aWZhY3RzIGFwcGVhciBvbiBzb21lIGhhcmR3YXJlIGlmIGEgZGVyaXZhdGl2ZSBpcyB0YWtlbiB3aXRoaW4gYSBjb25kaXRpb25hbAoJCQkJCWZsb2F0IGEgPSB2VXYueDsKCQkJCQlmbG9hdCBiID0gKCB2VXYueSA+IDAuMCApID8gdlV2LnkgLSAxLjAgOiB2VXYueSArIDEuMDsKCQkJCQlmbG9hdCBsZW4yID0gYSAqIGEgKyBiICogYjsKCQkJCQlmbG9hdCBkbGVuID0gZndpZHRoKCBsZW4yICk7CgoJCQkJCWlmICggYWJzKCB2VXYueSApID4gMS4wICkgewoKCQkJCQkJYWxwaGEgPSAxLjAgLSBzbW9vdGhzdGVwKCAxLjAgLSBkbGVuLCAxLjAgKyBkbGVuLCBsZW4yICk7CgoJCQkJCX0KCgkJCQkjZWxzZQoKCQkJCQlpZiAoIGFicyggdlV2LnkgKSA+IDEuMCApIHsKCgkJCQkJCWZsb2F0IGEgPSB2VXYueDsKCQkJCQkJZmxvYXQgYiA9ICggdlV2LnkgPiAwLjAgKSA/IHZVdi55IC0gMS4wIDogdlV2LnkgKyAxLjA7CgkJCQkJCWZsb2F0IGxlbjIgPSBhICogYSArIGIgKiBiOwoKCQkJCQkJaWYgKCBsZW4yID4gMS4wICkgZGlzY2FyZDsKCgkJCQkJfQoKCQkJCSNlbmRpZgoKCQkJI2VuZGlmCgoJCQkjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+CgkJCSNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD4KCgkJCWdsX0ZyYWdDb2xvciA9IHZlYzQoIGRpZmZ1c2VDb2xvci5yZ2IsIGFscGhhICk7CgoJCQkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkJCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PgoJCQkjaW5jbHVkZSA8Zm9nX2ZyYWdtZW50PgoJCQkjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD4KCgkJfQoJCWAKICApCn07CmxldCBodSA9IGNsYXNzIGV4dGVuZHMgWGkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgbGluZSBzZWdtZW50cyBnZW9tZXRyeS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1ldGVyc10gLSBBbiBvYmplY3Qgd2l0aCBvbmUgb3IgbW9yZSBwcm9wZXJ0aWVzCiAgICogZGVmaW5pbmcgdGhlIG1hdGVyaWFsJ3MgYXBwZWFyYW5jZS4gQW55IHByb3BlcnR5IG9mIHRoZSBtYXRlcmlhbAogICAqIChpbmNsdWRpbmcgYW55IHByb3BlcnR5IGZyb20gaW5oZXJpdGVkIG1hdGVyaWFscykgY2FuIGJlIHBhc3NlZAogICAqIGluIGhlcmUuIENvbG9yIHZhbHVlcyBjYW4gYmUgcGFzc2VkIGFueSB0eXBlIG9mIHZhbHVlIGFjY2VwdGVkCiAgICogYnkge0BsaW5rIENvbG9yI3NldH0uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoewogICAgICB0eXBlOiAiTGluZU1hdGVyaWFsIiwKICAgICAgdW5pZm9ybXM6IE9jLmNsb25lKGZpLmxpbmUudW5pZm9ybXMpLAogICAgICB2ZXJ0ZXhTaGFkZXI6IGZpLmxpbmUudmVydGV4U2hhZGVyLAogICAgICBmcmFnbWVudFNoYWRlcjogZmkubGluZS5mcmFnbWVudFNoYWRlciwKICAgICAgY2xpcHBpbmc6ICEwCiAgICAgIC8vIHJlcXVpcmVkIGZvciBjbGlwcGluZyBzdXBwb3J0CiAgICB9KSwgdGhpcy5pc0xpbmVNYXRlcmlhbCA9ICEwLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgLyoqCiAgICogVGhlIG1hdGVyaWFsJ3MgY29sb3IuCiAgICoKICAgKiBAdHlwZSB7Q29sb3J9CiAgICogQGRlZmF1bHQgKDEsMSwxKQogICAqLwogIGdldCBjb2xvcigpIHsKICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmRpZmZ1c2UudmFsdWU7CiAgfQogIHNldCBjb2xvcih0KSB7CiAgICB0aGlzLnVuaWZvcm1zLmRpZmZ1c2UudmFsdWUgPSB0OwogIH0KICAvKioKICAgKiBXaGV0aGVyIHRoZSBtYXRlcmlhbCdzIHNpemVzICh3aWR0aCwgZGFzaCBnYXBzKSBhcmUgaW4gd29ybGQgdW5pdHMuCiAgICoKICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKiBAZGVmYXVsdCBmYWxzZQogICAqLwogIGdldCB3b3JsZFVuaXRzKCkgewogICAgcmV0dXJuICJXT1JMRF9VTklUUyIgaW4gdGhpcy5kZWZpbmVzOwogIH0KICBzZXQgd29ybGRVbml0cyh0KSB7CiAgICB0ID09PSAhMCA/IHRoaXMuZGVmaW5lcy5XT1JMRF9VTklUUyA9ICIiIDogZGVsZXRlIHRoaXMuZGVmaW5lcy5XT1JMRF9VTklUUzsKICB9CiAgLyoqCiAgICogQ29udHJvbHMgbGluZSB0aGlja25lc3MgaW4gQ1NTIHBpeGVsIHVuaXRzIHdoZW4gYHdvcmxkVW5pdHNgIGlzIGBmYWxzZWAgKGRlZmF1bHQpLAogICAqIG9yIGluIHdvcmxkIHVuaXRzIHdoZW4gYHdvcmxkVW5pdHNgIGlzIGB0cnVlYC4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMQogICAqLwogIGdldCBsaW5ld2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5saW5ld2lkdGgudmFsdWU7CiAgfQogIHNldCBsaW5ld2lkdGgodCkgewogICAgdGhpcy51bmlmb3Jtcy5saW5ld2lkdGggJiYgKHRoaXMudW5pZm9ybXMubGluZXdpZHRoLnZhbHVlID0gdCk7CiAgfQogIC8qKgogICAqIFdoZXRoZXIgdGhlIGxpbmUgaXMgZGFzaGVkLCBvciBzb2xpZC4KICAgKgogICAqIEB0eXBlIHtib29sZWFufQogICAqIEBkZWZhdWx0IGZhbHNlCiAgICovCiAgZ2V0IGRhc2hlZCgpIHsKICAgIHJldHVybiAiVVNFX0RBU0giIGluIHRoaXMuZGVmaW5lczsKICB9CiAgc2V0IGRhc2hlZCh0KSB7CiAgICB0ID09PSAhMCAhPT0gdGhpcy5kYXNoZWQgJiYgKHRoaXMubmVlZHNVcGRhdGUgPSAhMCksIHQgPT09ICEwID8gdGhpcy5kZWZpbmVzLlVTRV9EQVNIID0gIiIgOiBkZWxldGUgdGhpcy5kZWZpbmVzLlVTRV9EQVNIOwogIH0KICAvKioKICAgKiBUaGUgc2NhbGUgb2YgdGhlIGRhc2hlcyBhbmQgZ2Fwcy4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMQogICAqLwogIGdldCBkYXNoU2NhbGUoKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5kYXNoU2NhbGUudmFsdWU7CiAgfQogIHNldCBkYXNoU2NhbGUodCkgewogICAgdGhpcy51bmlmb3Jtcy5kYXNoU2NhbGUudmFsdWUgPSB0OwogIH0KICAvKioKICAgKiBUaGUgc2l6ZSBvZiB0aGUgZGFzaC4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMQogICAqLwogIGdldCBkYXNoU2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmRhc2hTaXplLnZhbHVlOwogIH0KICBzZXQgZGFzaFNpemUodCkgewogICAgdGhpcy51bmlmb3Jtcy5kYXNoU2l6ZS52YWx1ZSA9IHQ7CiAgfQogIC8qKgogICAqIFdoZXJlIGluIHRoZSBkYXNoIGN5Y2xlIHRoZSBkYXNoIHN0YXJ0cy4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMAogICAqLwogIGdldCBkYXNoT2Zmc2V0KCkgewogICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuZGFzaE9mZnNldC52YWx1ZTsKICB9CiAgc2V0IGRhc2hPZmZzZXQodCkgewogICAgdGhpcy51bmlmb3Jtcy5kYXNoT2Zmc2V0LnZhbHVlID0gdDsKICB9CiAgLyoqCiAgICogVGhlIHNpemUgb2YgdGhlIGdhcC4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMAogICAqLwogIGdldCBnYXBTaXplKCkgewogICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuZ2FwU2l6ZS52YWx1ZTsKICB9CiAgc2V0IGdhcFNpemUodCkgewogICAgdGhpcy51bmlmb3Jtcy5nYXBTaXplLnZhbHVlID0gdDsKICB9CiAgLyoqCiAgICogVGhlIG9wYWNpdHkuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDEKICAgKi8KICBnZXQgb3BhY2l0eSgpIHsKICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLm9wYWNpdHkudmFsdWU7CiAgfQogIHNldCBvcGFjaXR5KHQpIHsKICAgIHRoaXMudW5pZm9ybXMgJiYgKHRoaXMudW5pZm9ybXMub3BhY2l0eS52YWx1ZSA9IHQpOwogIH0KICAvKioKICAgKiBUaGUgc2l6ZSBvZiB0aGUgdmlld3BvcnQsIGluIHNjcmVlbiBwaXhlbHMuIFRoaXMgbXVzdCBiZSBrZXB0IHVwZGF0ZWQgdG8gbWFrZQogICAqIHNjcmVlbi1zcGFjZSByZW5kZXJpbmcgYWNjdXJhdGUuVGhlIGBMaW5lU2VnbWVudHMyLm9uQmVmb3JlUmVuZGVyYCBjYWxsYmFjawogICAqIHBlcmZvcm1zIHRoZSB1cGRhdGUgZm9yIHZpc2libGUgb2JqZWN0cy4KICAgKgogICAqIEB0eXBlIHtWZWN0b3IyfQogICAqLwogIGdldCByZXNvbHV0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZTsKICB9CiAgc2V0IHJlc29sdXRpb24odCkgewogICAgdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLmNvcHkodCk7CiAgfQogIC8qKgogICAqIFdoZXRoZXIgdG8gdXNlIGFscGhhVG9Db3ZlcmFnZSBvciBub3QuIFdoZW4gZW5hYmxlZCwgdGhpcyBjYW4gaW1wcm92ZSB0aGUKICAgKiBhbnRpLWFsaWFzaW5nIG9mIGxpbmUgZWRnZXMgd2hlbiB1c2luZyBNU0FBLgogICAqCiAgICogQHR5cGUge2Jvb2xlYW59CiAgICovCiAgZ2V0IGFscGhhVG9Db3ZlcmFnZSgpIHsKICAgIHJldHVybiAiVVNFX0FMUEhBX1RPX0NPVkVSQUdFIiBpbiB0aGlzLmRlZmluZXM7CiAgfQogIHNldCBhbHBoYVRvQ292ZXJhZ2UodCkgewogICAgdGhpcy5kZWZpbmVzICYmICh0ID09PSAhMCAhPT0gdGhpcy5hbHBoYVRvQ292ZXJhZ2UgJiYgKHRoaXMubmVlZHNVcGRhdGUgPSAhMCksIHQgPT09ICEwID8gdGhpcy5kZWZpbmVzLlVTRV9BTFBIQV9UT19DT1ZFUkFHRSA9ICIiIDogZGVsZXRlIHRoaXMuZGVmaW5lcy5VU0VfQUxQSEFfVE9fQ09WRVJBR0UpOwogIH0KfTsKY29uc3Qgb2QgPSBuZXcgUXQoKSwgb2cgPSBuZXcgRSgpLCBsZyA9IG5ldyBFKCksIEdlID0gbmV3IFF0KCksIFdlID0gbmV3IFF0KCksIHhuID0gbmV3IFF0KCksIGxkID0gbmV3IEUoKSwgaGQgPSBuZXcgVnQoKSwgWGUgPSBuZXcgeF8oKSwgaGcgPSBuZXcgRSgpLCBHbCA9IG5ldyB3ZSgpLCBXbCA9IG5ldyBSZSgpLCB2biA9IG5ldyBRdCgpOwpsZXQgd24sIGNyOwpmdW5jdGlvbiBjZyhhLCB0LCBlKSB7CiAgcmV0dXJuIHZuLnNldCgwLCAwLCAtdCwgMSkuYXBwbHlNYXRyaXg0KGEucHJvamVjdGlvbk1hdHJpeCksIHZuLm11bHRpcGx5U2NhbGFyKDEgLyB2bi53KSwgdm4ueCA9IGNyIC8gZS53aWR0aCwgdm4ueSA9IGNyIC8gZS5oZWlnaHQsIHZuLmFwcGx5TWF0cml4NChhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlKSwgdm4ubXVsdGlwbHlTY2FsYXIoMSAvIHZuLncpLCBNYXRoLmFicyhNYXRoLm1heCh2bi54LCB2bi55KSk7Cn0KZnVuY3Rpb24gUkUoYSwgdCkgewogIGNvbnN0IGUgPSBhLm1hdHJpeFdvcmxkLCBpID0gYS5nZW9tZXRyeSwgbiA9IGkuYXR0cmlidXRlcy5pbnN0YW5jZVN0YXJ0LCBzID0gaS5hdHRyaWJ1dGVzLmluc3RhbmNlRW5kLCByID0gTWF0aC5taW4oaS5pbnN0YW5jZUNvdW50LCBuLmNvdW50KTsKICBmb3IgKGxldCBvID0gMCwgbCA9IHI7IG8gPCBsOyBvKyspIHsKICAgIFhlLnN0YXJ0LmZyb21CdWZmZXJBdHRyaWJ1dGUobiwgbyksIFhlLmVuZC5mcm9tQnVmZmVyQXR0cmlidXRlKHMsIG8pLCBYZS5hcHBseU1hdHJpeDQoZSk7CiAgICBjb25zdCBoID0gbmV3IEUoKSwgYyA9IG5ldyBFKCk7CiAgICB3bi5kaXN0YW5jZVNxVG9TZWdtZW50KFhlLnN0YXJ0LCBYZS5lbmQsIGMsIGgpLCBjLmRpc3RhbmNlVG8oaCkgPCBjciAqIDAuNSAmJiB0LnB1c2goewogICAgICBwb2ludDogYywKICAgICAgcG9pbnRPbkxpbmU6IGgsCiAgICAgIGRpc3RhbmNlOiB3bi5vcmlnaW4uZGlzdGFuY2VUbyhjKSwKICAgICAgb2JqZWN0OiBhLAogICAgICBmYWNlOiBudWxsLAogICAgICBmYWNlSW5kZXg6IG8sCiAgICAgIHV2OiBudWxsLAogICAgICB1djE6IG51bGwKICAgIH0pOwogIH0KfQpmdW5jdGlvbiBQRShhLCB0LCBlKSB7CiAgY29uc3QgaSA9IHQucHJvamVjdGlvbk1hdHJpeCwgcyA9IGEubWF0ZXJpYWwucmVzb2x1dGlvbiwgciA9IGEubWF0cml4V29ybGQsIG8gPSBhLmdlb21ldHJ5LCBsID0gby5hdHRyaWJ1dGVzLmluc3RhbmNlU3RhcnQsIGggPSBvLmF0dHJpYnV0ZXMuaW5zdGFuY2VFbmQsIGMgPSBNYXRoLm1pbihvLmluc3RhbmNlQ291bnQsIGwuY291bnQpLCB1ID0gLXQubmVhcjsKICB3bi5hdCgxLCB4biksIHhuLncgPSAxLCB4bi5hcHBseU1hdHJpeDQodC5tYXRyaXhXb3JsZEludmVyc2UpLCB4bi5hcHBseU1hdHJpeDQoaSksIHhuLm11bHRpcGx5U2NhbGFyKDEgLyB4bi53KSwgeG4ueCAqPSBzLnggLyAyLCB4bi55ICo9IHMueSAvIDIsIHhuLnogPSAwLCBsZC5jb3B5KHhuKSwgaGQubXVsdGlwbHlNYXRyaWNlcyh0Lm1hdHJpeFdvcmxkSW52ZXJzZSwgcik7CiAgZm9yIChsZXQgZCA9IDAsIHAgPSBjOyBkIDwgcDsgZCsrKSB7CiAgICBpZiAoR2UuZnJvbUJ1ZmZlckF0dHJpYnV0ZShsLCBkKSwgV2UuZnJvbUJ1ZmZlckF0dHJpYnV0ZShoLCBkKSwgR2UudyA9IDEsIFdlLncgPSAxLCBHZS5hcHBseU1hdHJpeDQoaGQpLCBXZS5hcHBseU1hdHJpeDQoaGQpLCBHZS56ID4gdSAmJiBXZS56ID4gdSkKICAgICAgY29udGludWU7CiAgICBpZiAoR2UueiA+IHUpIHsKICAgICAgY29uc3QgeCA9IEdlLnogLSBXZS56LCBfID0gKEdlLnogLSB1KSAvIHg7CiAgICAgIEdlLmxlcnAoV2UsIF8pOwogICAgfSBlbHNlIGlmIChXZS56ID4gdSkgewogICAgICBjb25zdCB4ID0gV2UueiAtIEdlLnosIF8gPSAoV2UueiAtIHUpIC8geDsKICAgICAgV2UubGVycChHZSwgXyk7CiAgICB9CiAgICBHZS5hcHBseU1hdHJpeDQoaSksIFdlLmFwcGx5TWF0cml4NChpKSwgR2UubXVsdGlwbHlTY2FsYXIoMSAvIEdlLncpLCBXZS5tdWx0aXBseVNjYWxhcigxIC8gV2UudyksIEdlLnggKj0gcy54IC8gMiwgR2UueSAqPSBzLnkgLyAyLCBXZS54ICo9IHMueCAvIDIsIFdlLnkgKj0gcy55IC8gMiwgWGUuc3RhcnQuY29weShHZSksIFhlLnN0YXJ0LnogPSAwLCBYZS5lbmQuY29weShXZSksIFhlLmVuZC56ID0gMDsKICAgIGNvbnN0IHkgPSBYZS5jbG9zZXN0UG9pbnRUb1BvaW50UGFyYW1ldGVyKGxkLCAhMCk7CiAgICBYZS5hdCh5LCBoZyk7CiAgICBjb25zdCBnID0gcHkubGVycChHZS56LCBXZS56LCB5KSwgbSA9IGcgPj0gLTEgJiYgZyA8PSAxLCB2ID0gbGQuZGlzdGFuY2VUbyhoZykgPCBjciAqIDAuNTsKICAgIGlmIChtICYmIHYpIHsKICAgICAgWGUuc3RhcnQuZnJvbUJ1ZmZlckF0dHJpYnV0ZShsLCBkKSwgWGUuZW5kLmZyb21CdWZmZXJBdHRyaWJ1dGUoaCwgZCksIFhlLnN0YXJ0LmFwcGx5TWF0cml4NChyKSwgWGUuZW5kLmFwcGx5TWF0cml4NChyKTsKICAgICAgY29uc3QgeCA9IG5ldyBFKCksIF8gPSBuZXcgRSgpOwogICAgICB3bi5kaXN0YW5jZVNxVG9TZWdtZW50KFhlLnN0YXJ0LCBYZS5lbmQsIF8sIHgpLCBlLnB1c2goewogICAgICAgIHBvaW50OiBfLAogICAgICAgIHBvaW50T25MaW5lOiB4LAogICAgICAgIGRpc3RhbmNlOiB3bi5vcmlnaW4uZGlzdGFuY2VUbyhfKSwKICAgICAgICBvYmplY3Q6IGEsCiAgICAgICAgZmFjZTogbnVsbCwKICAgICAgICBmYWNlSW5kZXg6IGQsCiAgICAgICAgdXY6IG51bGwsCiAgICAgICAgdXYxOiBudWxsCiAgICAgIH0pOwogICAgfQogIH0KfQpsZXQgbWYgPSBjbGFzcyBleHRlbmRzIHJlIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHdpZGUgbGluZS4KICAgKgogICAqIEBwYXJhbSB7TGluZVNlZ21lbnRzR2VvbWV0cnl9IFtnZW9tZXRyeV0gLSBUaGUgbGluZSBnZW9tZXRyeS4KICAgKiBAcGFyYW0ge0xpbmVNYXRlcmlhbH0gW21hdGVyaWFsXSAtIFRoZSBsaW5lIG1hdGVyaWFsLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBuZXcgZmYoKSwgZSA9IG5ldyBodSh7IGNvbG9yOiBNYXRoLnJhbmRvbSgpICogMTY3NzcyMTUgfSkpIHsKICAgIHN1cGVyKHQsIGUpLCB0aGlzLmlzTGluZVNlZ21lbnRzMiA9ICEwLCB0aGlzLnR5cGUgPSAiTGluZVNlZ21lbnRzMiI7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIGFuIGFycmF5IG9mIGRpc3RhbmNlIHZhbHVlcyB3aGljaCBhcmUgbmVjZXNzYXJ5IGZvciByZW5kZXJpbmcgZGFzaGVkIGxpbmVzLgogICAqIEZvciBlYWNoIHZlcnRleCBpbiB0aGUgZ2VvbWV0cnksIHRoZSBtZXRob2QgY2FsY3VsYXRlcyB0aGUgY3VtdWxhdGl2ZSBsZW5ndGggZnJvbSB0aGUKICAgKiBjdXJyZW50IHBvaW50IHRvIHRoZSB2ZXJ5IGJlZ2lubmluZyBvZiB0aGUgbGluZS4KICAgKgogICAqIEByZXR1cm4ge0xpbmVTZWdtZW50czJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY29tcHV0ZUxpbmVEaXN0YW5jZXMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5nZW9tZXRyeSwgZSA9IHQuYXR0cmlidXRlcy5pbnN0YW5jZVN0YXJ0LCBpID0gdC5hdHRyaWJ1dGVzLmluc3RhbmNlRW5kLCBuID0gbmV3IEZsb2F0MzJBcnJheSgyICogZS5jb3VudCk7CiAgICBmb3IgKGxldCByID0gMCwgbyA9IDAsIGwgPSBlLmNvdW50OyByIDwgbDsgcisrLCBvICs9IDIpCiAgICAgIG9nLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgciksIGxnLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSwgciksIG5bb10gPSBvID09PSAwID8gMCA6IG5bbyAtIDFdLCBuW28gKyAxXSA9IG5bb10gKyBvZy5kaXN0YW5jZVRvKGxnKTsKICAgIGNvbnN0IHMgPSBuZXcgdmMobiwgMiwgMSk7CiAgICByZXR1cm4gdC5zZXRBdHRyaWJ1dGUoImluc3RhbmNlRGlzdGFuY2VTdGFydCIsIG5ldyB1bihzLCAxLCAwKSksIHQuc2V0QXR0cmlidXRlKCJpbnN0YW5jZURpc3RhbmNlRW5kIiwgbmV3IHVuKHMsIDEsIDEpKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgaW50ZXJzZWN0aW9uIHBvaW50cyBiZXR3ZWVuIGEgY2FzdGVkIHJheSBhbmQgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7UmF5Y2FzdGVyfSByYXljYXN0ZXIgLSBUaGUgcmF5Y2FzdGVyLgogICAqIEBwYXJhbSB7QXJyYXk8T2JqZWN0Pn0gaW50ZXJzZWN0cyAtIFRoZSB0YXJnZXQgYXJyYXkgdGhhdCBob2xkcyB0aGUgaW50ZXJzZWN0aW9uIHBvaW50cy4KICAgKi8KICByYXljYXN0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLm1hdGVyaWFsLndvcmxkVW5pdHMsIG4gPSB0LmNhbWVyYTsKICAgIG4gPT09IG51bGwgJiYgIWkgJiYgY29uc29sZS5lcnJvcignTGluZVNlZ21lbnRzMjogIlJheWNhc3Rlci5jYW1lcmEiIG5lZWRzIHRvIGJlIHNldCBpbiBvcmRlciB0byByYXljYXN0IGFnYWluc3QgTGluZVNlZ21lbnRzMiB3aGlsZSB3b3JsZFVuaXRzIGlzIHNldCB0byBmYWxzZS4nKTsKICAgIGNvbnN0IHMgPSB0LnBhcmFtcy5MaW5lMiAhPT0gdm9pZCAwICYmIHQucGFyYW1zLkxpbmUyLnRocmVzaG9sZCB8fCAwOwogICAgd24gPSB0LnJheTsKICAgIGNvbnN0IHIgPSB0aGlzLm1hdHJpeFdvcmxkLCBvID0gdGhpcy5nZW9tZXRyeSwgbCA9IHRoaXMubWF0ZXJpYWw7CiAgICBjciA9IGwubGluZXdpZHRoICsgcywgby5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiBvLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCBXbC5jb3B5KG8uYm91bmRpbmdTcGhlcmUpLmFwcGx5TWF0cml4NChyKTsKICAgIGxldCBoOwogICAgaWYgKGkpCiAgICAgIGggPSBjciAqIDAuNTsKICAgIGVsc2UgewogICAgICBjb25zdCB1ID0gTWF0aC5tYXgobi5uZWFyLCBXbC5kaXN0YW5jZVRvUG9pbnQod24ub3JpZ2luKSk7CiAgICAgIGggPSBjZyhuLCB1LCBsLnJlc29sdXRpb24pOwogICAgfQogICAgaWYgKFdsLnJhZGl1cyArPSBoLCB3bi5pbnRlcnNlY3RzU3BoZXJlKFdsKSA9PT0gITEpCiAgICAgIHJldHVybjsKICAgIG8uYm91bmRpbmdCb3ggPT09IG51bGwgJiYgby5jb21wdXRlQm91bmRpbmdCb3goKSwgR2wuY29weShvLmJvdW5kaW5nQm94KS5hcHBseU1hdHJpeDQocik7CiAgICBsZXQgYzsKICAgIGlmIChpKQogICAgICBjID0gY3IgKiAwLjU7CiAgICBlbHNlIHsKICAgICAgY29uc3QgdSA9IE1hdGgubWF4KG4ubmVhciwgR2wuZGlzdGFuY2VUb1BvaW50KHduLm9yaWdpbikpOwogICAgICBjID0gY2cobiwgdSwgbC5yZXNvbHV0aW9uKTsKICAgIH0KICAgIEdsLmV4cGFuZEJ5U2NhbGFyKGMpLCB3bi5pbnRlcnNlY3RzQm94KEdsKSAhPT0gITEgJiYgKGkgPyBSRSh0aGlzLCBlKSA6IFBFKHRoaXMsIG4sIGUpKTsKICB9CiAgb25CZWZvcmVSZW5kZXIodCkgewogICAgY29uc3QgZSA9IHRoaXMubWF0ZXJpYWwudW5pZm9ybXM7CiAgICBlICYmIGUucmVzb2x1dGlvbiAmJiAodC5nZXRWaWV3cG9ydChvZCksIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS5zZXQob2Queiwgb2QudykpOwogIH0KfTsKY29uc3QgbGEgPSB7CiAgbm9uZTogbnVsbCwKICB2ZXJ0ZXg6ICJ2ZXJ0ZXgiLAogIGVkZ2U6ICJlZGdlIiwKICBmYWNlOiAiZmFjZSIsCiAgc29saWQ6ICJzb2xpZCIKfSwgSUUgPSB7CiAgZmFjZTogWwogICAgInBsYW5lIiwKICAgICJjeWxpbmRlciIsCiAgICAiY29uZSIsCiAgICAic3BoZXJlIiwKICAgICJ0b3J1cyIsCiAgICAiYmV6aWVyIiwKICAgICJic3BsaW5lIiwKICAgICJyZXZvbHV0aW9uIiwKICAgICJleHRydXNpb24iLAogICAgIm9mZnNldCIsCiAgICAib3RoZXIiCiAgXSwKICBlZGdlOiBbCiAgICAibGluZSIsCiAgICAiY2lyY2xlIiwKICAgICJlbGxpcHNlIiwKICAgICJoeXBlcmJvbGEiLAogICAgInBhcmFib2xhIiwKICAgICJiZXppZXIiLAogICAgImJzcGxpbmUiLAogICAgIm9mZnNldCIsCiAgICAib3RoZXIiCiAgXQp9OwpjbGFzcyBMRSB7CiAgY29uc3RydWN0b3IodCwgZSkgewogICAgdGhpcy5vYmogPSB0LCB0aGlzLmZyb21Tb2xpZCA9IGU7CiAgfQogIC8qKgogICAqIFJldHVybnMgYWxsIHRoZSBmYWNlcyBPYmplY3RHcm91cHMgdGhhdCBkZWZpbmUgdGhlIHNvbGlkIGZyb20gdGhlIHBpY2tlZCBvYmplY3QuCiAgICovCiAgX2dldFNvbGlkT2JqZWN0R3JvdXBzKHQpIHsKICAgIGNvbnN0IGUgPSB0LnBhcmVudC5wYXJlbnQ7CiAgICBsZXQgaTsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgZS5jaGlsZHJlbi5sZW5ndGg7IG4rKykgewogICAgICBjb25zdCBzID0gZS5jaGlsZHJlbltuXTsKICAgICAgaWYgKHMubmFtZSA9PT0gZS5uYW1lICsgInxmYWNlcyIpIHsKICAgICAgICBpID0gczsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGkuY2hpbGRyZW47CiAgfQogIC8qKgogICAqIElmIHRoZSBwaWNrZWQgb2JqZWN0IGlzIHBhcnQgb2YgYSBzb2xpZCwgcmV0dXJucyBhbGwgdGhlIGZhY2VzIE9iamVjdEdyb3VwcyB0aGF0IGRlZmluZSB0aGUgc29saWQuCiAgICogT3RoZXJ3aXNlLCByZXR1cm5zIHRoZSBwaWNrZWQgb2JqZWN0LgogICAqIEByZXR1cm5zIHtPYmplY3RHcm91cFtdfSBUaGUgcGlja2VkIG9iamVjdHMuCiAgICovCiAgb2JqcygpIHsKICAgIHJldHVybiB0aGlzLmZyb21Tb2xpZCA/IHRoaXMuX2dldFNvbGlkT2JqZWN0R3JvdXBzKHRoaXMub2JqKSA6IFt0aGlzLm9ial07CiAgfQp9CmNsYXNzIHVnIHsKICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuLCBzLCByLCBvKSB7CiAgICAvKioKICAgICAqIEhhbmRsZSBsZWZ0IG1vdXNlIGJ1dHRvbiBkb3duIGV2ZW50CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZSAtIGEgRE9NIE1vdXNlRXZlbnQKICAgICAqLwogICAgayh0aGlzLCAib25Nb3VzZUtleURvd24iLCAodCkgPT4gewogICAgICB0aGlzLnJheWNhc3RNb2RlICYmICh0LmJ1dHRvbiA9PSBaZS5MRUZUIHx8IHQuYnV0dG9uID09IFplLlJJR0hUKSAmJiAodGhpcy5sYXN0UG9zaXRpb24gPSB0aGlzLmNhbWVyYS5nZXRQb3NpdGlvbigpLmNsb25lKCkpOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZSBsZWZ0IG1vdXNlIGJ1dHRvbiB1cCBldmVudAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGUgLSBhIERPTSBNb3VzZUV2ZW50CiAgICAgKi8KICAgIGsodGhpcywgIm9uTW91c2VLZXlVcCIsICh0KSA9PiB7CiAgICAgIHRoaXMucmF5Y2FzdE1vZGUgJiYgKHQuYnV0dG9uID09IFplLkxFRlQgPyB0aGlzLmxhc3RQb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMuY2FtZXJhLmdldFBvc2l0aW9uKCkpIDwgMWUtNiAmJiB0aGlzLmNhbGxiYWNrKHsgbW91c2U6ICJsZWZ0Iiwgc2hpZnQ6IERlLmdldCh0LCAic2hpZnQiKSB9KSA6IHQuYnV0dG9uID09IFplLlJJR0hUICYmIHRoaXMubGFzdFBvc2l0aW9uLmRpc3RhbmNlVG8odGhpcy5jYW1lcmEuZ2V0UG9zaXRpb24oKSkgPCAxZS02ICYmIHRoaXMuY2FsbGJhY2soeyBtb3VzZTogInJpZ2h0IiB9KSk7CiAgICB9KTsKICAgIC8qKgogICAgICogSGFuZGxlIGtleSBkb3duIGV2ZW50CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZSAtIGEgRE9NIE1vdXNlRXZlbnQKICAgICAqLwogICAgayh0aGlzLCAib25LZXlEb3duIiwgKHQpID0+IHsKICAgICAgdGhpcy5yYXljYXN0TW9kZSAmJiAodC5rZXkgPT0gIkJhY2tzcGFjZSIgPyB0aGlzLmNhbGxiYWNrKHsga2V5OiAiQmFja3NwYWNlIiB9KSA6IHQua2V5ID09ICJFc2NhcGUiICYmIHRoaXMuY2FsbGJhY2soeyBrZXk6ICJFc2NhcGUiIH0pKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBHZXQgdGhlIGN1cnJlbnQgbW91c2UgcG9zaXRpb24KICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fSBlIC0gYSBET00gTW91c2VFdmVudAogICAgICovCiAgICBrKHRoaXMsICJvblBvaW50ZXJNb3ZlIiwgKHQpID0+IHsKICAgICAgY29uc3QgZSA9IHRoaXMuZG9tRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgaSA9IGUueCArIHdpbmRvdy5zY3JvbGxYLCBuID0gZS55ICsgd2luZG93LnNjcm9sbFk7CiAgICAgIHRoaXMubW91c2UueCA9ICh0LnBhZ2VYIC0gaSkgLyB0aGlzLndpZHRoICogMiAtIDEsIHRoaXMubW91c2UueSA9IC0oKHQucGFnZVkgLSBuKSAvIHRoaXMuaGVpZ2h0KSAqIDIgKyAxLCB0aGlzLm1vdXNlTW92ZWQgPSAhMDsKICAgIH0pOwogICAgdGhpcy5jYW1lcmEgPSB0LCB0aGlzLmdyb3VwID0gciwgdGhpcy5kb21FbGVtZW50ID0gZSwgdGhpcy53aWR0aCA9IGksIHRoaXMuaGVpZ2h0ID0gbiwgdGhpcy50aHJlc2hvbGQgPSBzLCB0aGlzLmNhbGxiYWNrID0gbywgdGhpcy5yYXljYXN0ZXIgPSBuZXcgX18oKSwgdGhpcy5yYXljYXN0TW9kZSA9ICExLCB0aGlzLmxhc3RQb3NpdGlvbiA9IG51bGwsIHRoaXMubW91c2UgPSBuZXcgSigpLCB0aGlzLm1vdXNlTW92ZWQgPSAhMSwgdGhpcy5maWx0ZXJzID0gewogICAgICB0b3BvRmlsdGVyOiBbbGEubm9uZV0KICAgIH07CiAgfQogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRvbUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgdGhpcy5vblBvaW50ZXJNb3ZlKSwgdGhpcy5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCB0aGlzLm1vdXNlS2V0VXApLCB0aGlzLmRvbUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5vbk1vdXNlS2V5RG93biksIHRoaXMuZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5vbktleURvd24pLCB0aGlzLnJheWNhc3RNb2RlID0gITEsIHRoaXMuZ3JvdXBzID0gbnVsbCwgdGhpcy5kb21FbGVtZW50ID0gbnVsbCwgdGhpcy5jYW1lcmEgPSBudWxsOwogIH0KICBpbml0KCkgewogICAgdGhpcy5kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHRoaXMub25Qb2ludGVyTW92ZSksIHRoaXMuZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgdGhpcy5vbk1vdXNlS2V5VXAsICExKSwgdGhpcy5kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHRoaXMub25Nb3VzZUtleURvd24sICExKSwgdGhpcy5kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLm9uS2V5RG93biwgITEpLCB0aGlzLnJheWNhc3RNb2RlID0gITA7CiAgfQogIC8qKgogICAqIFJldHJpZXZlIGFsbCB0aGUgdmFsaWQgaW50ZXJzZWN0ZWQgb2JqZWN0cyBieSBhIHJheSBjYXN0ZXIgZnJvbSB0aGUgbW91c2UuCiAgICovCiAgZ2V0SW50ZXJzZWN0ZWRPYmpzKCkgewogICAgdGhpcy5yYXljYXN0ZXIuc2V0RnJvbUNhbWVyYSh0aGlzLm1vdXNlLCB0aGlzLmNhbWVyYS5nZXRDYW1lcmEoKSksIHRoaXMucmF5Y2FzdGVyLnBhcmFtcy5Qb2ludHMudGhyZXNob2xkID0gdGhpcy50aHJlc2hvbGQgLyB0aGlzLmNhbWVyYS5nZXRab29tKCksIHRoaXMucmF5Y2FzdGVyLnBhcmFtcy5MaW5lMiA9IHsgdGhyZXNob2xkOiA0IH07CiAgICB2YXIgdCA9IHRoaXMucmF5Y2FzdGVyLmludGVyc2VjdE9iamVjdHModGhpcy5ncm91cCwgITApLCBlID0gW107CiAgICBmb3IgKHZhciBpIGluIHQpCiAgICAgIHRbaV0ub2JqZWN0Lm1hdGVyaWFsLnZpc2libGUgJiYgZS5wdXNoKHRbaV0pOwogICAgcmV0dXJuIGU7CiAgfQogIC8qKgogICAqIFJldHJpZXZlIGFsbCB0aGUgdmFsaWQgaW50ZXJzZWN0ZWQgb2JqZWN0cyBieSBhIHJheSBjYXN0ZXIgZnJvbSB0aGUgbW91c2UuCiAgICogVGhlIG9iamVjdHMgYXJlIHNvcnRlZCBieSB0aGVpciBkaXN0YW5jZSBmcm9tIHRoZSByYXkuIChUaGUgY2xvc2VzdCBmaXJzdCkKICAgKi8KICBnZXRWYWxpZEludGVyc2VjdGVkT2JqcygpIHsKICAgIHZhciB0ID0gW107CiAgICBpZiAodGhpcy5tb3VzZU1vdmVkKSB7CiAgICAgIGNvbnN0IGkgPSB0aGlzLmdldEludGVyc2VjdGVkT2JqcygpOwogICAgICBmb3IgKHZhciBlIG9mIGkpCiAgICAgICAgaWYgKGUub2JqZWN0Lm1hdGVyaWFsLnZpc2libGUpIHsKICAgICAgICAgIGNvbnN0IG4gPSBlLm9iamVjdC5wYXJlbnQ7CiAgICAgICAgICBpZiAobiA9PSBudWxsIHx8ICFuLnNoYXBlSW5mbykgY29udGludWU7CiAgICAgICAgICBjb25zdCBzID0gbi5zaGFwZUluZm8udG9wbzsKICAgICAgICAgIHMgIT09ICJ2ZXJ0ZXgiICYmIElFW3NdW24uc2hhcGVJbmZvLmdlb210eXBlXTsKICAgICAgICAgIGNvbnN0IHIgPSBuLnN1YnR5cGUgPT09ICJzb2xpZCI7CiAgICAgICAgICAodGhpcy5maWx0ZXJzLnRvcG9GaWx0ZXIuaW5jbHVkZXMobGEuc29saWQpICYmIHIgfHwgdGhpcy5maWx0ZXJzLnRvcG9GaWx0ZXIuaW5jbHVkZXMobGEubm9uZSkgfHwgdGhpcy5maWx0ZXJzLnRvcG9GaWx0ZXIuaW5jbHVkZXMocykpICYmIHQucHVzaChlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdDsKICB9Cn0KZnVuY3Rpb24gZHAoYSwgdCkgewogIGNvbnN0IGUgPSBbCiAgICAidGN2X3hfbWVhc3VyZV92YWwiLAogICAgInRjdl95X21lYXN1cmVfdmFsIiwKICAgICJ0Y3Zfel9tZWFzdXJlX3ZhbCIKICBdLCBpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidHIiKSwgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRoIik7CiAgbi50ZXh0Q29udGVudCA9IGEsIG4uY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfa2V5IiksIG4uY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfY2VsbCIpLCBpLmFwcGVuZENoaWxkKG4pOwogIGNvbnN0IHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZCIpOwogIHMudGV4dENvbnRlbnQgPSAiKCIsIHMuY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfY2VsbF9icmFja2V0IiksIGkuYXBwZW5kQ2hpbGQocyk7CiAgZm9yIChsZXQgbyA9IDA7IG8gPCAzOyArK28pIHsKICAgIGNvbnN0IGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ZCIpOwogICAgbC50ZXh0Q29udGVudCA9IHRbb10udG9GaXhlZCgzKSwgbC5jbGFzc0xpc3QuYWRkKCJ0Y3ZfbWVhc3VyZV92YWwiKSwgbC5jbGFzc0xpc3QuYWRkKCJ0Y3ZfbWVhc3VyZV9jZWxsIiksIGwuY2xhc3NMaXN0LmFkZChlW29dKSwgaS5hcHBlbmRDaGlsZChsKTsKICB9CiAgY29uc3QgciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgcmV0dXJuIHIudGV4dENvbnRlbnQgPSAiKSIsIHIuY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfY2VsbF9icmFja2V0IiksIGkuYXBwZW5kQ2hpbGQociksIGk7Cn0KZnVuY3Rpb24gZGcoYSwgdCkgewogIGNvbnN0IGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpLCBpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGgiKSwgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgcmV0dXJuIGkudGV4dENvbnRlbnQgPSBhLCBpLmNsYXNzTGlzdC5hZGQoInRjdl9tZWFzdXJlX2tleSIpLCBpLmNsYXNzTGlzdC5hZGQoInRjdl9tZWFzdXJlX2NlbGwiKSwgZS5hcHBlbmRDaGlsZChpKSwgbi50ZXh0Q29udGVudCA9IHQsIG4uY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfdmFsX2NlbnRlciIpLCBuLmNsYXNzTGlzdC5hZGQoInRjdl9tZWFzdXJlX2NlbGwiKSwgbi5jb2xTcGFuID0gNSwgZS5hcHBlbmRDaGlsZChuKSwgZTsKfQpmdW5jdGlvbiBwcChhLCB0LCBlID0gbnVsbCkgewogIGNvbnN0IGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0ciIpLCBuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGgiKSwgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgbi50ZXh0Q29udGVudCA9IGEsIG4uY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfa2V5IiksIG4uY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfY2VsbCIpLCBpLmFwcGVuZENoaWxkKG4pOwogIGZvciAodmFyIHIgPSAwOyByIDwgMjsgcisrKSB7CiAgICBjb25zdCBvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGQiKTsKICAgIGkuYXBwZW5kQ2hpbGQobyk7CiAgfQogIGlmIChzLnRleHRDb250ZW50ID0gdC50b0ZpeGVkKDMpLCBzLmNsYXNzTGlzdC5hZGQoInRjdl9tZWFzdXJlX3ZhbCIpLCBzLmNsYXNzTGlzdC5hZGQoInRjdl9tZWFzdXJlX2NlbGwiKSwgaS5hcHBlbmRDaGlsZChzKSwgZSA9PSBudWxsKQogICAgZm9yICh2YXIgciA9IDA7IHIgPCAyOyByKyspIHsKICAgICAgY29uc3QgbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRkIik7CiAgICAgIGkuYXBwZW5kQ2hpbGQobCk7CiAgICB9CiAgZWxzZSB7CiAgICBjb25zdCBvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGQiKTsKICAgIG8udGV4dENvbnRlbnQgPSBgKCR7ZX0pYCwgby5jbGFzc0xpc3QuYWRkKCJ0Y3ZfbWVhc3VyZV9jZWxsIiksIGkuYXBwZW5kQ2hpbGQobyk7CiAgICBjb25zdCBsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGQiKTsKICAgIGkuYXBwZW5kQ2hpbGQobCk7CiAgfQogIHJldHVybiBpOwp9CmNsYXNzIExfIHsKICAvKioKICAgKiBAcGFyYW0ge2ltcG9ydCAoIi4uL2Rpc3BsYXkuanMiKS5EaXNwbGF5fSBkaXNwbGF5CiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgLyoqCiAgICAgKiBTaG93IG9yIGhpZGUgdGhlIHBhbmVsCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcKICAgICAqLwogICAgayh0aGlzLCAic2hvdyIsICh0KSA9PiB7CiAgICAgIHRoaXMuaHRtbC5zdHlsZS5kaXNwbGF5ID0gdCA/ICJpbmxpbmUtYmxvY2siIDogIm5vbmUiOwogICAgfSk7CiAgICAvKioKICAgICAqIEdldCBzdGF0dXMgb2YgdGhlIHBhbmVsCiAgICAgKi8KICAgIGsodGhpcywgImlzVmlzaWJsZSIsICgpID0+IHRoaXMuaHRtbC5zdHlsZS5kaXNwbGF5ID09ICJpbmxpbmUtYmxvY2siKTsKICAgIC8qKgogICAgICogU2V0cyB0aGUgcG9zaXRpb24gb2YgdGhlIHBhbmVsICh3aXRoIHRoZSB0b3AgbGVmdCBjb3JuZXIgYXQgdGhlIHNwZWNpZmllZCBjb29yZGluYXRlcykKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAgKiBAcGFyYW0ge251bWJlcn0geQogICAgICovCiAgICBrKHRoaXMsICJyZWxvY2F0ZSIsICh0LCBlKSA9PiB7CiAgICAgIHRoaXMuaHRtbC5zdHlsZS5sZWZ0ID0gYCR7dH1weGAsIHRoaXMuaHRtbC5zdHlsZS50b3AgPSBgJHtlfXB4YDsKICAgIH0pOwogICAgdGhpcy5kaXNwbGF5ID0gdCwgdGhpcy5odG1sID0gdGhpcy5fZ2V0SHRtbCgpLCB0aGlzLmZpbmlzaGVkID0gITEsIHRoaXMuY2FsbGJhY2tzID0gW10sIHRoaXMuaHRtbC5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIChlKSA9PiB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIH0pOwogIH0KICBfcmVtb3ZlVGFibGUoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5odG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0YWJsZSIpOwogICAgdC5sZW5ndGggPiAwICYmIHRbMF0ucmVtb3ZlKCksIHRoaXMuZmluaXNoZWQgPSAhMTsKICB9CiAgX2dldEh0bWwoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZCIpOwogIH0KICAvKioKICAgKiBSZWdpc3RlciBhIGNhbGxiYWNrIGZvciBhIHNwZWNpZmljIGV2ZW50IHR5cGUKICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnRUeXBlIC0gVGhlIHR5cGUgb2YgZXZlbnQgdG8gcmVnaXN0ZXIgdGhlIGNhbGxiYWNrIGZvcgogICAqIEBwYXJhbSB7Q2FsbGFibGVGdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gdG8gcmVnaXN0ZXIKICAgKi8KICByZWdpc3RlckNhbGxiYWNrKHQsIGUpIHsKICAgIHRoaXMuY2FsbGJhY2tzLnB1c2goeyBjYWxsYmFjazogZSwgdHlwZTogdCB9KSwgdGhpcy5odG1sLmFkZEV2ZW50TGlzdGVuZXIodCwgZSk7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICBmb3IgKHZhciB0IG9mIHRoaXMuY2FsbGJhY2tzKQogICAgICB0aGlzLmh0bWwucmVtb3ZlRXZlbnRMaXN0ZW5lcih0LnR5cGUsIHQuY2FsbGJhY2spOwogIH0KfQpjbGFzcyBERSBleHRlbmRzIExfIHsKICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcih0KTsKICB9CiAgX2dldEh0bWwoKSB7CiAgICByZXR1cm4gdGhpcy5kaXNwbGF5Ll9nZXRFbGVtZW50KCJ0Y3ZfZGlzdGFuY2VfbWVhc3VyZW1lbnRfcGFuZWwiKTsKICB9CiAgY3JlYXRlVGFibGUodCkgewogICAgaWYgKHRoaXMuZmluaXNoZWQpIHJldHVybjsKICAgIHRoaXMuX3JlbW92ZVRhYmxlKCk7CiAgICBjb25zdCBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGFibGUiKTsKICAgIGUuY2xhc3NMaXN0LmFkZCgidGN2X3Byb3BlcnRpZXNfdGFibGUiKTsKICAgIGNvbnN0IGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpOwogICAgZm9yICh2YXIgbiBpbiB0KSB7CiAgICAgIGlmICghdC5oYXNPd25Qcm9wZXJ0eShuKSB8fCBbCiAgICAgICAgInNoYXBlX3R5cGUiLAogICAgICAgICJnZW9tX3R5cGUiLAogICAgICAgICJ0eXBlIiwKICAgICAgICAidHlwZSIsCiAgICAgICAgInRvb2xfdHlwZSIsCiAgICAgICAgInN1YnR5cGUiLAogICAgICAgICJpbmZvIiwKICAgICAgICAiaW5mbzEiLAogICAgICAgICJpbmZvMiIsCiAgICAgICAgInJlZnBvaW50MSIsCiAgICAgICAgInJlZnBvaW50MiIKICAgICAgXS5pbmNsdWRlcyhuLnRvTG93ZXJDYXNlKCkpKQogICAgICAgIGNvbnRpbnVlOwogICAgICBjb25zdCByID0gdFtuXTsKICAgICAgdmFyIHM7CiAgICAgIEFycmF5LmlzQXJyYXkocikgJiYgci5sZW5ndGggPT09IDMgPyAocyA9IGRwKG4sIHIpLCBpLmFwcGVuZENoaWxkKHMpKSA6IChuLnRvTG93ZXJDYXNlKCkgPT09ICJkaXN0YW5jZSIgPyBzID0gcHAobiwgciwgdC5pbmZvKSA6IHMgPSBwcChuLCByKSwgaS5hcHBlbmRDaGlsZChzKSwgbi50b0xvd2VyQ2FzZSgpID09ICJhbmdsZSIgJiYgKHMuY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfY2VsbF90b3BfYm9yZGVyIiksIHMgPSBkZygiUmVmZXJlbmNlIDEiLCB0LmluZm8xKSwgaS5hcHBlbmRDaGlsZChzKSwgcyA9IGRnKCJSZWZlcmVuY2UgMiIsIHQuaW5mbzIpLCBpLmFwcGVuZENoaWxkKHMpKSksIGkuYXBwZW5kQ2hpbGQocyk7CiAgICB9CiAgICBlLmFwcGVuZENoaWxkKGkpLCB0aGlzLmh0bWwuYXBwZW5kKGUpLCB0aGlzLmZpbmlzaGVkID0gITA7CiAgfQp9CmNsYXNzIEZFIGV4dGVuZHMgTF8gewogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHN1cGVyKHQpOwogIH0KICBfZ2V0SHRtbCgpIHsKICAgIHJldHVybiB0aGlzLmRpc3BsYXkuX2dldEVsZW1lbnQoInRjdl9wcm9wZXJ0aWVzX21lYXN1cmVtZW50X3BhbmVsIik7CiAgfQogIF9zZXRTdWJIZWFkZXIodCkgewogICAgdGhpcy5odG1sLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoInRjdl9tZWFzdXJlX3N1YmhlYWRlciIpWzBdLnRleHRDb250ZW50ID0gdDsKICB9CiAgY3JlYXRlVGFibGUodCkgewogICAgaWYgKHRoaXMuZmluaXNoZWQpIHJldHVybjsKICAgIHRoaXMuX3JlbW92ZVRhYmxlKCksIHRoaXMuX3NldFN1YkhlYWRlcigKICAgICAgYCR7dC5zaGFwZV90eXBlfSAvICR7dC5nZW9tX3R5cGV9YAogICAgKTsKICAgIGNvbnN0IGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0YWJsZSIpOwogICAgZS5jbGFzc0xpc3QuYWRkKCJ0Y3ZfcHJvcGVydGllc190YWJsZSIpOwogICAgY29uc3QgaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRib2R5Iik7CiAgICBmb3IgKHZhciBuIGluIHQpIHsKICAgICAgaWYgKCF0Lmhhc093blByb3BlcnR5KG4pIHx8IFsKICAgICAgICAic2hhcGVfdHlwZSIsCiAgICAgICAgImdlb21fdHlwZSIsCiAgICAgICAgInR5cGUiLAogICAgICAgICJ0b29sX3R5cGUiLAogICAgICAgICJzdWJ0eXBlIiwKICAgICAgICAicmVmcG9pbnQiCiAgICAgIF0uaW5jbHVkZXMobi50b0xvd2VyQ2FzZSgpKSkKICAgICAgICBjb250aW51ZTsKICAgICAgY29uc3QgbyA9IHRbbl07CiAgICAgIHZhciBzOwogICAgICBpZiAobi50b0xvd2VyQ2FzZSgpID09PSAiYmIiKQogICAgICAgIGZvciAodmFyIHIgaW4gbykgewogICAgICAgICAgY29uc3QgbCA9IGRwKGBCQiAke3J9YCwgb1tyXSk7CiAgICAgICAgICByID09PSAibWluIiAmJiBsLmNsYXNzTGlzdC5hZGQoInRjdl9tZWFzdXJlX2NlbGxfdG9wX2JvcmRlciIpLCBpLmFwcGVuZENoaWxkKGwpOwogICAgICAgIH0KICAgICAgZWxzZSBBcnJheS5pc0FycmF5KG8pICYmIG8ubGVuZ3RoID09PSAzID8gKHMgPSBkcChuLCBvKSwgaS5hcHBlbmRDaGlsZChzKSkgOiAocyA9IHBwKG4sIG8pLCBpLmFwcGVuZENoaWxkKHMpKTsKICAgICAgWyJsZW5ndGgiLCAiYXJlYSIsICJ2b2x1bWUiLCAic3RhcnQiXS5pbmNsdWRlcyhuLnRvTG93ZXJDYXNlKCkpICYmIHMuY2xhc3NMaXN0LmFkZCgidGN2X21lYXN1cmVfY2VsbF90b3BfYm9yZGVyIik7CiAgICB9CiAgICBlLmFwcGVuZENoaWxkKGkpLCB0aGlzLmh0bWwuYXBwZW5kKGUpLCB0aGlzLmZpbmlzaGVkID0gITA7CiAgfQp9CmNsYXNzIFVFIHsKICAvKioKICAgKiBJbml0aWFsaXplIGEgbmV3IGZpbHRlciBkcm9wIGRvd24gbWVudSwgaXQgbmVlZHMgdGhlIHJheWNhc3QgdG8gdXBkYXRlIGludGVyYWN0aXZlbHkgdGhlIGZpbHRlciBtb2RlCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgayh0aGlzLCAiX3NldFZhbHVlIiwgKHQpID0+IHsKICAgICAgdGhpcy5yYXljYXN0ZXIgIT0gbnVsbCAmJiAodGhpcy5kaXNwbGF5Ll9nZXRFbGVtZW50KCJ0Y3ZfZmlsdGVyX3ZhbHVlIikuaW5uZXJUZXh0ID0gdCwgdCA9PSAibm9uZSIgPyB0aGlzLnJheWNhc3Rlci5maWx0ZXJzLnRvcG9GaWx0ZXIgPSBbbGEubm9uZV0gOiB0aGlzLnJheWNhc3Rlci5maWx0ZXJzLnRvcG9GaWx0ZXIgPSBbCiAgICAgICAgbGFbdC50b0xvd2VyQ2FzZSgpXQogICAgICBdKTsKICAgIH0pOwogICAgayh0aGlzLCAiX3RvZ2dsZURyb3Bkb3duIiwgKHQpID0+IHsKICAgICAgdCAhPSBudWxsICYmIHQuc3RvcFByb3BhZ2F0aW9uKCksIHRoaXMuZHJvcGRvd25FbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygidGN2X2ZpbHRlcl9kcm9wZG93bl9hY3RpdmUiKSA/ICh0aGlzLmRyb3Bkb3duRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCJ0Y3ZfZmlsdGVyX2Ryb3Bkb3duX2FjdGl2ZSIpLCB0aGlzLmFycm93RWxlbWVudC5pbm5lclRleHQgPSAi4o+2IikgOiAodGhpcy5kcm9wZG93bkVsZW1lbnQuY2xhc3NMaXN0LmFkZCgidGN2X2ZpbHRlcl9kcm9wZG93bl9hY3RpdmUiKSwgdGhpcy5hcnJvd0VsZW1lbnQuaW5uZXJUZXh0ID0gIuKPtyIpOwogICAgfSk7CiAgICBrKHRoaXMsICJfY2xvc2VEcm9wZG93biIsICh0KSA9PiB7CiAgICAgIHRoaXMuZHJvcGRvd25FbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygidGN2X2ZpbHRlcl9kcm9wZG93bl9hY3RpdmUiKSAmJiB0aGlzLl90b2dnbGVEcm9wZG93bih0KTsKICAgIH0pOwogICAgayh0aGlzLCAiaGFuZGxlU2VsZWN0aW9uIiwgKHQpID0+IHsKICAgICAgY29uc3QgZSA9IHQudGFyZ2V0LmlubmVyVGV4dDsKICAgICAgdGhpcy5fc2V0VmFsdWUoZSksIHRoaXMuX3RvZ2dsZURyb3Bkb3duKHQpOwogICAgfSk7CiAgICBrKHRoaXMsICJyZXNldCIsICgpID0+IHsKICAgICAgdGhpcy5fc2V0VmFsdWUoIk5vbmUiKTsKICAgIH0pOwogICAgayh0aGlzLCAiX2tleWJpbmRTZWxlY3QiLCAodCkgPT4gewogICAgICBbIm4iLCAidiIsICJlIiwgImYiLCAicyIsICJFc2NhcGUiXS5pbmRleE9mKHQua2V5KSAhPT0gLTEgJiYgKHQua2V5ID09ICJuIiA/IHRoaXMuX3NldFZhbHVlKCJOb25lIikgOiB0LmtleSA9PSAidiIgPyB0aGlzLl9zZXRWYWx1ZSgiVmVydGV4IikgOiB0LmtleSA9PSAiZSIgPyB0aGlzLl9zZXRWYWx1ZSgiRWRnZSIpIDogdC5rZXkgPT0gImYiID8gdGhpcy5fc2V0VmFsdWUoIkZhY2UiKSA6IHQua2V5ID09ICJzIiA/IHRoaXMuX3NldFZhbHVlKCJTb2xpZCIpIDogdC5rZXkgPT0gIkVzY2FwZSIgJiYgdGhpcy5fY2xvc2VEcm9wZG93bigpKTsKICAgIH0pOwogICAgdGhpcy5kaXNwbGF5ID0gdCwgdGhpcy5zZWxlY3RFbGVtZW50ID0gdC5fZ2V0RWxlbWVudCgidGN2X3NoYXBlX2ZpbHRlciIpLCB0aGlzLmRyb3Bkb3duRWxlbWVudCA9IHQuX2dldEVsZW1lbnQoInRjdl9maWx0ZXJfZHJvcGRvd24iKSwgdGhpcy5hcnJvd0VsZW1lbnQgPSB0Ll9nZXRFbGVtZW50KCJ0Y3ZfZmlsdGVyX2ljb24iKSwgdGhpcy5vcHRpb25zID0gWyJub25lIiwgInZlcnRleCIsICJlZGdlIiwgImZhY2UiLCAic29saWQiXSwgdGhpcy5zZWxlY3RFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMucmF5Y2FzdGVyID0gbnVsbDsKICB9CiAgLyoqCiAgICogU2V0IHRoZSByYXljYXN0ZXIgdG8gdXBkYXRlIHRoZSBmaWx0ZXIgbW9kZQogICAqIEBwYXJhbSB7aW1wb3J0ICgiLi8uLi9yYXljYXN0LmpzIikuUmF5Y2FzdGVyIH0gcmF5Y2FzdGVyCiAgICovCiAgc2V0UmF5Y2FzdGVyKHQpIHsKICAgIHRoaXMucmF5Y2FzdGVyID0gdDsKICB9CiAgLyoqCiAgICogU2hvdyBvciBoaWRlIHRoZSBkcm9wIGRvd24gbWVudQogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZwogICAqLwogIHNob3codCkgewogICAgaWYgKHQpIHsKICAgICAgdGhpcy5kaXNwbGF5LmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5fa2V5YmluZFNlbGVjdCksIHRoaXMuZGlzcGxheS5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl9jbG9zZURyb3Bkb3duKTsKICAgICAgbGV0IGUgPSB0aGlzLmRpc3BsYXkuX2dldEVsZW1lbnQoInRjdl9maWx0ZXJfY29udGVudCIpOwogICAgICBlLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fdG9nZ2xlRHJvcGRvd24pOwogICAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy5vcHRpb25zKQogICAgICAgIGUgPSB0aGlzLmRpc3BsYXkuX2dldEVsZW1lbnQoYHR2Y19maWx0ZXJfJHtpfWApLCBlLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5oYW5kbGVTZWxlY3Rpb24pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5kaXNwbGF5LmNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKAogICAgICAgICJrZXlkb3duIiwKICAgICAgICB0aGlzLl9rZXliaW5kU2VsZWN0CiAgICAgICksIHRoaXMuZGlzcGxheS5jb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl9jbG9zZURyb3Bkb3duKTsKICAgICAgbGV0IGUgPSB0aGlzLmRpc3BsYXkuX2dldEVsZW1lbnQoInRjdl9maWx0ZXJfY29udGVudCIpOwogICAgICBlLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fdG9nZ2xlRHJvcGRvd24pOwogICAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy5vcHRpb25zKQogICAgICAgIGUgPSB0aGlzLmRpc3BsYXkuX2dldEVsZW1lbnQoYHR2Y19maWx0ZXJfJHtpfWApLCBlLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5oYW5kbGVTZWxlY3Rpb24pOwogICAgfQogICAgdGhpcy5zZWxlY3RFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSB0ID8gImJsb2NrIiA6ICJub25lIjsKICB9Cn0KY2xhc3MgZnAgZXh0ZW5kcyB5aSB7CiAgLyoqCiAgICoKICAgKiBAcGFyYW0ge1RIUkVFLlZlY3RvcjN9IHBvaW50MSBUaGUgc3RhcnQgcG9pbnQgb2YgdGhlIGxpbmUKICAgKiBAcGFyYW0ge1RIUkVFLlZlY3RvcjN9IHBvaW50MiBUaGUgZW5kIHBvaW50IG9mIHRoZSBsaW5lCiAgICogQHBhcmFtIHtudW1iZXJ9IGxpbmV3aWR0aCBUaGUgdGhpY2tuZXNzIG9mIHRoZSBsaW5lCiAgICogQHBhcmFtIHtUSFJFRS5Db2xvcn0gY29sb3IgVGhlIGNvbG9yIG9mIHRoZSBsaW5lCiAgICogQHBhcmFtIHtib29sZWFufSBhcnJvd1N0YXJ0IElmIHRydWUsIGEgY29uZSBpcyBhZGRlZCBhdCB0aGUgc3RhcnQgb2YgdGhlIGxpbmUKICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFycm93RW5kIElmIHRydWUsIGEgY29uZSBpcyBhZGRlZCBhdCB0aGUgZW5kIG9mIHRoZSBsaW5lCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgciA9ICEwLCBvID0gITApIHsKICAgIHN1cGVyKCksIHRoaXMuY29uZUxlbmd0aCA9IHQsIHRoaXMucG9pbnQxID0gZSwgdGhpcy5wb2ludDIgPSBpLCB0aGlzLmxpbmV3aWR0aCA9IG4sIHRoaXMuY29sb3IgPSBzLCB0aGlzLmFycm93U3RhcnQgPSByLCB0aGlzLmFycm93RW5kID0gbywgdGhpcy50eXBlID0gIkRpc3RhbmNlTGluZUFycm93IiwgdGhpcy5saW5lVmVjID0gdm9pZCAwLCB0aGlzLmluaXRpYWxpemUoKTsKICB9CiAgaW5pdGlhbGl6ZSgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmNvbmVMZW5ndGg7CiAgICB0aGlzLmxpbmVWZWMgPSB0aGlzLnBvaW50MS5jbG9uZSgpLnN1Yih0aGlzLnBvaW50Mi5jbG9uZSgpKS5ub3JtYWxpemUoKTsKICAgIGxldCBlLCBpOwogICAgdGhpcy5hcnJvd1N0YXJ0ID8gZSA9IHRoaXMucG9pbnQxLmNsb25lKCkuc3ViKHRoaXMubGluZVZlYy5jbG9uZSgpLm11bHRpcGx5U2NhbGFyKHQgLyAyKSkgOiBlID0gdGhpcy5wb2ludDEuY2xvbmUoKSwgdGhpcy5hcnJvd0VuZCA/IGkgPSB0aGlzLnBvaW50Mi5jbG9uZSgpLnN1Yih0aGlzLmxpbmVWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcigtdCAvIDIpKSA6IGkgPSB0aGlzLnBvaW50Mi5jbG9uZSgpOwogICAgY29uc3QgbiA9IG5ldyBodSh7CiAgICAgIGxpbmV3aWR0aDogdGhpcy5saW5ld2lkdGgsCiAgICAgIGNvbG9yOiB0aGlzLmNvbG9yCiAgICB9KSwgcyA9IG5ldyBmZigpOwogICAgcy5zZXRQb3NpdGlvbnMoWy4uLmUudG9BcnJheSgpLCAuLi5pLnRvQXJyYXkoKV0pOwogICAgY29uc3QgciA9IG5ldyBtZihzLCBuKSwgbyA9IG5ldyBDYSh0IC8gNCwgdCwgMTApLCBsID0gbmV3IGxpKHsgY29sb3I6IHRoaXMuY29sb3IgfSksIGggPSBuZXcgcmUobywgbCksIGMgPSBuZXcgcmUobywgbCk7CiAgICBoLm5hbWUgPSAic3RhcnRDb25lIiwgYy5uYW1lID0gImVuZENvbmUiOwogICAgY29uc3QgdSA9IG5ldyBWdCgpLCBkID0gbmV3IHZlKCk7CiAgICB1Lmxvb2tBdCh0aGlzLnBvaW50MSwgdGhpcy5wb2ludDIsIGgudXApLCBkLnNldEZyb21Sb3RhdGlvbk1hdHJpeCh1KSwgaC5zZXRSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKGQpLCB1Lmxvb2tBdCh0aGlzLnBvaW50MiwgdGhpcy5wb2ludDEsIGMudXApLCBkLnNldEZyb21Sb3RhdGlvbk1hdHJpeCh1KSwgYy5zZXRSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKGQpLCBoLnJvdGF0ZVgoOTAgKiBNYXRoLlBJIC8gMTgwKSwgYy5yb3RhdGVYKDkwICogTWF0aC5QSSAvIDE4MCksIGgucG9zaXRpb24uY29weShlKSwgYy5wb3NpdGlvbi5jb3B5KGkpLCB0aGlzLmFycm93U3RhcnQgJiYgdGhpcy5hZGQoaCksIHRoaXMuYXJyb3dFbmQgJiYgdGhpcy5hZGQoYyksIHRoaXMuYWRkKHIpOwogIH0KICAvKioKICAgKiBVcGRhdGUgdGhlIGFycm93IHNvIGl0IGtlZXBzIHRoZSBzYW1lIHNpemUgb24gdGhlIHNjcmVlbi4KICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGVGYWN0b3IKICAgKi8KICB1cGRhdGUodCkgewogICAgY29uc3QgZSA9IHRoaXMucG9pbnQxLmNsb25lKCkuc3ViKAogICAgICB0aGlzLmxpbmVWZWMuY2xvbmUoKS5tdWx0aXBseVNjYWxhcih0ICogdGhpcy5jb25lTGVuZ3RoIC8gMikKICAgICksIGkgPSB0aGlzLnBvaW50Mi5jbG9uZSgpLnN1YigKICAgICAgdGhpcy5saW5lVmVjLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoLXQgKiB0aGlzLmNvbmVMZW5ndGggLyAyKQogICAgKTsKICAgIGlmICh0aGlzLmNoaWxkcmVuLmZpbmQoKHMpID0+IHMudHlwZSA9PSAiTGluZVNlZ21lbnRzMiIpLmdlb21ldHJ5LnNldFBvc2l0aW9ucyhbCiAgICAgIC4uLnRoaXMuYXJyb3dTdGFydCA/IGUudG9BcnJheSgpIDogdGhpcy5wb2ludDEsCiAgICAgIC4uLnRoaXMuYXJyb3dFbmQgPyBpLnRvQXJyYXkoKSA6IHRoaXMucG9pbnQyCiAgICBdKSwgdGhpcy5hcnJvd1N0YXJ0KSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLmNoaWxkcmVuLmZpbmQoCiAgICAgICAgKHIpID0+IHIudHlwZSA9PSAiTWVzaCIgJiYgci5uYW1lID09ICJzdGFydENvbmUiCiAgICAgICk7CiAgICAgIHMucG9zaXRpb24uY29weShlKSwgcy5zY2FsZS5zZXQodCwgdCwgdCk7CiAgICB9CiAgICBpZiAodGhpcy5hcnJvd0VuZCkgewogICAgICBjb25zdCBzID0gdGhpcy5jaGlsZHJlbi5maW5kKAogICAgICAgIChyKSA9PiByLnR5cGUgPT0gIk1lc2giICYmIHIubmFtZSA9PSAiZW5kQ29uZSIKICAgICAgKTsKICAgICAgcy5wb3NpdGlvbi5jb3B5KGkpLCBzLnNjYWxlLnNldCh0LCB0LCB0KTsKICAgIH0KICB9Cn0KY2xhc3MgRF8gewogIC8qKgogICAqCiAgICogQHBhcmFtIHtpbXBvcnQgKCIuLi92aWV3ZXIuanMiKS5WaWV3ZXJ9IHZpZXdlciBUaGUgdmlld2VyIGluc3RhbmNlCiAgICogQHBhcmFtIHtEaXN0YW5jZVBhbmVsIHwgUHJvcGVydGllc1BhbmVsIH0gcGFuZWwgVGhlIHBhbmVsIHRvIGRpc3BsYXkgdGhlIG1lYXN1cmVtZW50CiAgICovCiAgY29uc3RydWN0b3IodCwgZSkgewogICAgLyoqCiAgICAgKiBSZWFjdCB0byBlYWNoIG5ldyBzZWxlY3RlZCBlbGVtZW50IGluIHRoZSB2aWV3ZXIuCiAgICAgKiBvYmo6IE9iamVjdEdyb3VwCiAgICAgKiBmcm9tU29saWQ6IGJvb2xlYW4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZWxlY3RlZE9iaiBUaGUgc2VsZWN0ZWQgb2JqLgogICAgICovCiAgICBrKHRoaXMsICJoYW5kbGVTZWxlY3Rpb24iLCAodCwgZSA9ICExKSA9PiB7CiAgICAgIHRoaXMuc2hpZnQgPSBlLCB0aGlzLnNlbGVjdGVkU2hhcGVzLmZpbmQoKGkpID0+IGkub2JqLm5hbWUgPT09IHQub2JqLm5hbWUpICE9PSB2b2lkIDAgPyB0aGlzLnNlbGVjdGVkU2hhcGVzLnNwbGljZSh0aGlzLnNlbGVjdGVkU2hhcGVzLmluZGV4T2YodCksIDEpIDogdGhpcy5zZWxlY3RlZFNoYXBlcy5wdXNoKHQpLCB0aGlzLnBhbmVsLmZpbmlzaGVkID0gITEsIHRoaXMuX3VwZGF0ZU1lYXN1cmVtZW50KCk7CiAgICB9KTsKICAgIGsodGhpcywgIl9tb3VzZXVwIiwgKHQpID0+IHsKICAgICAgdGhpcy5wYW5lbERyYWdEYXRhLmNsaWNrZWQgPSAhMSwgdC5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0pOwogICAgayh0aGlzLCAiX21vdmVQYW5lbCIsICgpID0+IHsKICAgICAgaWYgKCF0aGlzLnBhbmVsLmlzVmlzaWJsZSgpKSByZXR1cm47CiAgICAgIGNvbnN0IHQgPSB0aGlzLnZpZXdlci5yZW5kZXJlci5kb21FbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCBlID0gdGhpcy5wYW5lbC5odG1sLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBpZiAodGhpcy5wYW5lbFggPT0gbnVsbCAmJiB0aGlzLm1pZGRsZVBvaW50ICE9IG51bGwpIHsKICAgICAgICBsZXQgYyA9IHRoaXMubWlkZGxlUG9pbnQuY2xvbmUoKS5wcm9qZWN0KHRoaXMudmlld2VyLmNhbWVyYS5nZXRDYW1lcmEoKSksIHUgPSAoYy54ICsgMSkgKiAodC53aWR0aCAvIDIpLCBkID0gKDEgLSBjLnkpICogKHQuaGVpZ2h0IC8gMik7CiAgICAgICAgdSA8IHQud2lkdGggLyAyID8gdGhpcy5wYW5lbFggPSB1ICsgZS53aWR0aCAvIDIgOiB0aGlzLnBhbmVsWCA9IHUgLSBlLndpZHRoIC0gZS53aWR0aCAvIDIsIHRoaXMucGFuZWxYID0gTWF0aC5tYXgoCiAgICAgICAgICAwLAogICAgICAgICAgTWF0aC5taW4odC53aWR0aCAtIGUud2lkdGgsIHRoaXMucGFuZWxYKQogICAgICAgICksIHRoaXMucGFuZWxZID0gZCwgdGhpcy5wYW5lbFkgPSBNYXRoLm1heCgKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoLm1pbih0LmhlaWdodCAtIGUuaGVpZ2h0LCB0aGlzLnBhbmVsWSkKICAgICAgICApOwogICAgICB9CiAgICAgIHRoaXMucGFuZWwucmVsb2NhdGUodGhpcy5wYW5lbFgsIHRoaXMucGFuZWxZKTsKICAgICAgY29uc3QgaSA9IHRoaXMucGFuZWxYICsgZS53aWR0aCAvIDIsIG4gPSB0aGlzLnBhbmVsWSArIGUuaGVpZ2h0IC8gMiwgcyA9IGkgLyAodC53aWR0aCAvIDIpIC0gMSwgciA9IDEgLSBuIC8gKHQuaGVpZ2h0IC8gMiksIG8gPSB0aGlzLnZpZXdlci5vcnRobyA/IC0wLjkgOiAxOwogICAgICB2YXIgbCA9IG5ldyBFKHMsIHIsIG8pOwogICAgICBjb25zdCBoID0gdGhpcy52aWV3ZXIuY2FtZXJhLmdldENhbWVyYSgpOwogICAgICBoLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKSwgaC51cGRhdGVNYXRyaXhXb3JsZCgpLCB0aGlzLnBhbmVsQ2VudGVyID0gbC51bnByb2plY3QoaCksIHRoaXMuc2NlbmUuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl91cGRhdGVDb25uZWN0aW9uTGluZSgpOwogICAgfSk7CiAgICAvKioKICAgICAqIFRoaXMgaGFuZGxlciBpcyByZXNwb25zaWJsZSB0byB1cGRhdGUgdGhlIHBhbmVsIGNlbnRlciB2ZWN0b3Igd2hlbiB0aGUgdXNlciBkcmFnIHRoZSBwYW5lbCBvbiB0aGUgc2NyZWVuLgogICAgICogQHBhcmFtIHtFdmVudH0gZQogICAgICogQHJldHVybnMKICAgICAqLwogICAgayh0aGlzLCAiX2RyYWdQYW5lbCIsICh0KSA9PiB7CiAgICAgIGlmICghdGhpcy5wYW5lbERyYWdEYXRhLmNsaWNrZWQpIHJldHVybjsKICAgICAgY29uc3QgZSA9IHRoaXMucGFuZWwuaHRtbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgaSA9IHRoaXMudmlld2VyLnJlbmRlcmVyLmRvbUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGxldCBuID0gdC5jbGllbnRYIC0gdGhpcy5wYW5lbERyYWdEYXRhLngsIHMgPSB0LmNsaWVudFkgLSB0aGlzLnBhbmVsRHJhZ0RhdGEueTsKICAgICAgZS54ICsgbiA8IGkueCAmJiB0Lm1vdmVtZW50WCA8PSAwIHx8IGUueCArIG4gPiBpLnggKyBpLndpZHRoIC0gZS53aWR0aCAmJiB0Lm1vdmVtZW50WCA+PSAwIHx8ICh0aGlzLnBhbmVsWCArPSBuKSwgZS55ICsgcyA8IGkueSAmJiB0Lm1vdmVtZW50WSA8PSAwIHx8IGUueSArIHMgPiBpLnkgKyBpLmhlaWdodCAtIGUuaGVpZ2h0ICYmIHQubW92ZW1lbnRZID49IDAgfHwgKHRoaXMucGFuZWxZICs9IHMpLCB0aGlzLl91cGRhdGVNZWFzdXJlbWVudCgpLCB0aGlzLnBhbmVsRHJhZ0RhdGEueCA9IHQuY2xpZW50WCwgdGhpcy5wYW5lbERyYWdEYXRhLnkgPSB0LmNsaWVudFk7CiAgICB9KTsKICAgIHRoaXMuc2VsZWN0ZWRTaGFwZXMgPSBbXSwgdGhpcy5wb2ludDEgPSBudWxsLCB0aGlzLnBvaW50MiA9IG51bGwsIHRoaXMubWlkZGxlUG9pbnQgPSBudWxsLCB0aGlzLmNvbnRleHRFbmFibGVkID0gITEsIHRoaXMudmlld2VyID0gdCwgdGhpcy5zY2VuZSA9IG5ldyBrbygpLCB0aGlzLnBhbmVsID0gZSwgdGhpcy5wYW5lbENlbnRlciA9IG51bGwsIHRoaXMucGFuZWxYID0gbnVsbCwgdGhpcy5wYW5lbFkgPSBudWxsLCB0aGlzLnBhbmVsU2hvd24gPSAhMSwgdGhpcy5yZXNwb25zZURhdGEgPSBudWxsLCB0aGlzLm1lYXN1cmVtZW50TGluZUNvbG9yID0gMCwgdGhpcy5jb25uZWN0aW5nTGluZUNvbG9yID0gODM4ODczNiwgdGhpcy5jb25lTGVuZ3RoID0gdm9pZCAwLCB0aGlzLnBhbmVsRHJhZ0RhdGEgPSB7IHg6IG51bGwsIHk6IG51bGwsIGNsaWNrZWQ6ICExIH0sIHRoaXMucGFuZWwucmVnaXN0ZXJDYWxsYmFjaygibW91c2Vkb3duIiwgKGkpID0+IHsKICAgICAgdGhpcy5wYW5lbERyYWdEYXRhLmNsaWNrZWQgPSAhMCwgdGhpcy5wYW5lbERyYWdEYXRhLnggPSBpLmNsaWVudFgsIHRoaXMucGFuZWxEcmFnRGF0YS55ID0gaS5jbGllbnRZLCBpLnN0b3BQcm9wYWdhdGlvbigpOwogICAgfSksIHRoaXMuc2hpZnQgPSAhMTsKICB9CiAgZW5hYmxlQ29udGV4dCgpIHsKICAgIHRoaXMuY29udGV4dEVuYWJsZWQgPSAhMCwgdGhpcy5wYW5lbENlbnRlciA9IG5ldyBFKDEsIDAsIDApLCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgdGhpcy5fbW91c2V1cCksIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHRoaXMuX2RyYWdQYW5lbCk7CiAgfQogIGRpc2FibGVDb250ZXh0KCkgewogICAgdGhpcy5faGlkZU1lYXN1cmVtZW50KCksIHRoaXMuY29udGV4dEVuYWJsZWQgPSAhMSwgdGhpcy5yZXNwb25zZURhdGEgPSBudWxsOwogICAgZm9yICh2YXIgdCBvZiB0aGlzLnNlbGVjdGVkU2hhcGVzKQogICAgICB0Lm9iai5jbGVhckhpZ2hsaWdodHMoKTsKICAgIHRoaXMuc2VsZWN0ZWRTaGFwZXMgPSBbXSwgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2V1cCIsIHRoaXMuX21vdXNldXApLCBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZW1vdmUiLCB0aGlzLl9kcmFnUGFuZWwpLCB0aGlzLnZpZXdlci5jaGVja0NoYW5nZXMoeyBzZWxlY3RlZFNoYXBlSURzOiBbXSB9KTsKICB9CiAgX2hpZGVNZWFzdXJlbWVudCgpIHsKICAgIHRoaXMucGFuZWwuc2hvdyghMSksIHRoaXMuZGlzcG9zZUFycm93cygpLCB0aGlzLnNjZW5lLmNsZWFyKCk7CiAgfQogIC8qKgogICAqIFJlc3BvbnNlIGhhbmRsZXIgZm9yIHRoZSBtZWFzdXJlIGNvbnRleHQKICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UKICAgKi8KICBoYW5kbGVSZXNwb25zZSh0KSB7CiAgfQogIF9jcmVhdGVQYW5lbCgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiU3ViY2xhc3MgbmVlZHMgdG8gb3ZlcnJpZGUgdGhpcyBtZXRob2QiKTsKICB9CiAgX21ha2VMaW5lcygpIHsKICAgIHRocm93IG5ldyBFcnJvcigiU3ViY2xhc3MgbmVlZHMgdG8gb3ZlcnJpZGUgdGhpcyBtZXRob2QiKTsKICB9CiAgX3VwZGF0ZUNvbm5lY3Rpb25MaW5lKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJTdWJjbGFzcyBuZWVkcyB0byBvdmVycmlkZSB0aGlzIG1ldGhvZCIpOwogIH0KICAvKioKICAgKiBHZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIHNlbGVjdGVkIG9iaiB0aGlzIG1lYXN1cmVtZW50IGNhbiBoYW5kbGUKICAgKiBAcmV0dXJucyB7aW50fSBUaGUgbnVtYmVycyBvZiBvYmogaGFuZGxlZCBieSB0aGUgbWVhc3VyZW1lbnQKICAgKi8KICBfZ2V0TWF4T2JqU2VsZWN0ZWQoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlN1YmNsYXNzIG5lZWRzIHRvIG92ZXJyaWRlIHRoaXMgbWV0aG9kIik7CiAgfQogIC8qKgogICAqIFdhaXQgZm9yIHRoZSBiYWNrZW5kIHRvIHNlbmQgdGhlIGRhdGEgbmVlZGVkIHRvIGRpc3BsYXkgdGhlIHJlYWwgQlJFUCBtZWFzdXJlbWVudC4KICAgKiBAcGFyYW0geyp9IHJlc29sdmUKICAgKiBAcGFyYW0geyp9IHJlamVjdAogICAqLwogIF93YWl0UmVzcG9uc2UodCwgZSkgewogICAgdGhpcy5yZXNwb25zZURhdGEgPyB0KHRoaXMucmVzcG9uc2VEYXRhKSA6IHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aGlzLl93YWl0UmVzcG9uc2UodCwgZSk7CiAgICB9LCAxMDApOwogIH0KICAvKioKICAgKiBVcGRhdGUgdGhlIG1lYXN1cmVtZW50IHBhbmVsLCBpZiBlbm91Z2ggc2hhcGVzIGhhdmUgYmVlbiBzZWxlY3RlZCBmb3IgdGhlIGN1cnJlbnQgdG9vbCwKICAgKiBhc2sgdGhlIGJhY2tlbmQgZm9yIHRoZSByZWFsIG1lYXN1cmVtZW50IGRhdGEgYW5kIGRpc3BsYXkgaXQuCiAgICogQHJldHVybnMKICAgKi8KICBfdXBkYXRlTWVhc3VyZW1lbnQoKSB7CiAgICBsZXQgdCA9IChuKSA9PiBuLmZyb21Tb2xpZCA/IG4ub2JqLm5hbWUucmVwbGFjZSgvXHxmYWNlcy4qJC8sICIiKS5yZXBsYWNlKC9cfGVkZ2VzLiokLywgIiIpLnJlcGxhY2UoL1x8dmVydGljZXMuKiQvLCAiIikucmVwbGFjZUFsbCgifCIsICIvIikgOiBuLm9iai5uYW1lLnJlcGxhY2VBbGwoInwiLCAiLyIpOwogICAgY29uc3QgZSA9IHRoaXMuc2VsZWN0ZWRTaGFwZXMubWFwKHQpOwogICAgaWYgKHRoaXMucmVzcG9uc2VEYXRhID0gbnVsbCwgdGhpcy5kZWJ1ZykgewogICAgICBjb25zdCBuID0gNTAgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyMDApOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFNoYXBlcy5sZW5ndGggPT0gMCkgcmV0dXJuOwogICAgICAgIGxldCBzOwogICAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgRl8pIHsKICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkU2hhcGVzLmxlbmd0aCA8IDIpIHJldHVybjsKICAgICAgICAgIHZhciByID0gdGhpcy5zZWxlY3RlZFNoYXBlc1swXS5vYmosIG8gPSB0aGlzLnNlbGVjdGVkU2hhcGVzWzFdLm9iajsKICAgICAgICAgIHRoaXMucG9pbnQxID0gci5jaGlsZHJlblswXS5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZS5jZW50ZXIuY2xvbmUoKSwgdGhpcy5wb2ludDEgPSByLmxvY2FsVG9Xb3JsZCh0aGlzLnBvaW50MSksIHRoaXMucG9pbnQyID0gby5jaGlsZHJlblswXS5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZS5jZW50ZXIuY2xvbmUoKSwgdGhpcy5wb2ludDIgPSBvLmxvY2FsVG9Xb3JsZCh0aGlzLnBvaW50MiksIHMgPSB7CiAgICAgICAgICAgIHR5cGU6ICJiYWNrZW5kX3Jlc3BvbnNlIiwKICAgICAgICAgICAgRGlzdGFuY2U6IDIuMzQ1LAogICAgICAgICAgICBpbmZvOiAiY2VudGVyIiwKICAgICAgICAgICAgcmVmcG9pbnQxOiB0aGlzLnBvaW50MS50b0FycmF5KCksCiAgICAgICAgICAgIHJlZnBvaW50MjogdGhpcy5wb2ludDIudG9BcnJheSgpLAogICAgICAgICAgICBBbmdsZTogNDMuMjEsCiAgICAgICAgICAgIGluZm8xOiAiUGxhbmUgKEZhY2UpIiwKICAgICAgICAgICAgaW5mbzI6ICJQbGFuZSAoRmFjZSkiCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodGhpcyBpbnN0YW5jZW9mIFVfKSB7CiAgICAgICAgICBjb25zdCBsID0gdGhpcy5zZWxlY3RlZFNoYXBlc1swXS5vYmosIGggPSBsLmNoaWxkcmVuWzBdLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLmNlbnRlci5jbG9uZSgpOwogICAgICAgICAgdGhpcy5wb2ludDEgPSBsLmxvY2FsVG9Xb3JsZChoKSwgcyA9IHsKICAgICAgICAgICAgdHlwZTogImJhY2tlbmRfcmVzcG9uc2UiLAogICAgICAgICAgICBzaGFwZV90eXBlOiAiRWRnZSIsCiAgICAgICAgICAgIGdlb21fdHlwZTogIkVsbGlwc2VBcmMiLAogICAgICAgICAgICAiTWFqb3IgcmFkaXVzIjogMC40LAogICAgICAgICAgICAiTWlub3IgcmFkaXVzIjogMC4yLAogICAgICAgICAgICBMZW5ndGg6IDAuNjg2ODU5MjQwNDcxNjM3NCwKICAgICAgICAgICAgU3RhcnQ6IFsyLjQsIC0xLCAwXSwKICAgICAgICAgICAgQ2VudGVyOiB0aGlzLnBvaW50MS50b0FycmF5KCksCiAgICAgICAgICAgIHJlZnBvaW50OiB0aGlzLnBvaW50MS50b0FycmF5KCksCiAgICAgICAgICAgIEVuZDogWzEuOCwgLTAuODI2Nzk0OTE5MjQzMTExMSwgMF0sCiAgICAgICAgICAgIGJiOiB7CiAgICAgICAgICAgICAgbWluOiBbMS44LCAtMSwgMF0sCiAgICAgICAgICAgICAgY2VudGVyOiBbMi4xLCAtMC45LCAwXSwKICAgICAgICAgICAgICBtYXg6IFsyLjQsIC0wLjgsIDBdLAogICAgICAgICAgICAgIHNpemU6IFswLjU2LCAwLjIsIDBdCiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHRoaXMuaGFuZGxlUmVzcG9uc2Uocyk7CiAgICAgIH0sIG4pOwogICAgfSBlbHNlCiAgICAgIHRoaXMudmlld2VyLmNoZWNrQ2hhbmdlcyh7CiAgICAgICAgc2VsZWN0ZWRTaGFwZUlEczogWy4uLmUsIHRoaXMuc2hpZnRdCiAgICAgIH0pOwogICAgaWYgKHRoaXMuc2VsZWN0ZWRTaGFwZXMubGVuZ3RoICE9IHRoaXMuX2dldE1heE9ialNlbGVjdGVkKCkpIHsKICAgICAgdGhpcy5faGlkZU1lYXN1cmVtZW50KCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIG5ldyBQcm9taXNlKChuLCBzKSA9PiB7CiAgICAgIHRoaXMuX3dhaXRSZXNwb25zZShuLCBzKTsKICAgIH0pLnRoZW4oKG4pID0+IHsKICAgICAgdGhpcy5fY3JlYXRlUGFuZWwoKSwgdGhpcy5fbWFrZUxpbmVzKCksIHRoaXMucGFuZWwuc2hvdyghMCksIHRoaXMuX21vdmVQYW5lbCgpOwogICAgfSk7CiAgfQogIHJlbW92ZUxhc3RTZWxlY3RlZE9iaih0ID0gITEpIHsKICAgIGlmICh0IHx8IHRoaXMuc2VsZWN0ZWRTaGFwZXMubGVuZ3RoID09IHRoaXMuX2dldE1heE9ialNlbGVjdGVkKCkpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuc2VsZWN0ZWRTaGFwZXMucG9wKCk7CiAgICAgIGlmIChlKSB7CiAgICAgICAgbGV0IGkgPSBlLm9ianMoKTsKICAgICAgICBmb3IgKGxldCBuIG9mIGkpCiAgICAgICAgICBuLmNsZWFySGlnaGxpZ2h0cygpOwogICAgICB9CiAgICAgIHRoaXMuX3VwZGF0ZU1lYXN1cmVtZW50KCk7CiAgICB9CiAgfQogIC8qKgogICAqIEFkanVzdCB0aGUgYXJyb3cgY29uZXMgc2NhbGUgZmFjdG9yIHRvIGVuc3VyZSB0aGV5IGtlZXAgdGhlIHNhbWUgc2l6ZSBvbiB0aGUgc2NyZWVuLgogICAqIEBwYXJhbSB7bnVtYmVyfSB6b29tCiAgICovCiAgX2FkanVzdEFycm93c1NjYWxlRmFjdG9yKHQpIHsKICAgIGNvbnN0IGUgPSAxIC8gdDsKICAgIHRoaXMuc2NlbmUuY2hpbGRyZW4uZm9yRWFjaCgoaSkgPT4gaS51cGRhdGUoZSkpOwogIH0KICB1cGRhdGUoKSB7CiAgICBjb25zdCB0ID0gdGhpcy52aWV3ZXIuY2FtZXJhLmdldENhbWVyYSgpLCBlID0gdGhpcy52aWV3ZXIuY2FtZXJhLmdldFpvb20oKTsKICAgIHRoaXMuY29uZUxlbmd0aCA9IHRoaXMudmlld2VyLmJiX3JhZGl1cyAvIChNYXRoLm1heCh0aGlzLnZpZXdlci5jYWRXaWR0aCwgdGhpcy52aWV3ZXIuaGVpZ2h0KSAvIDYwKSwgdGhpcy5fYWRqdXN0QXJyb3dzU2NhbGVGYWN0b3IoZSksIHRoaXMudmlld2VyLnJlbmRlcmVyLmNsZWFyRGVwdGgoKSwgdGhpcy5fbW92ZVBhbmVsKCksIHRoaXMudmlld2VyLnJlbmRlcmVyLnJlbmRlcih0aGlzLnNjZW5lLCB0KTsKICB9CiAgZGlzcG9zZUFycm93cygpIHsKICAgIG1lKHRoaXMuc2NlbmUpLCB0aGlzLnNjZW5lLmNsZWFyKCk7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLnBhbmVsICYmICh0aGlzLnBhbmVsLnNob3coITEpLCBtZSh0aGlzLnBhbmVsKSksIHRoaXMuZGlzcG9zZUFycm93cygpLCB0aGlzLnBhbmVsID0gbnVsbCwgdGhpcy52aWV3ZXIgPSBudWxsLCB0aGlzLnNjZW5lID0gbnVsbDsKICB9Cn0KY2xhc3MgRl8gZXh0ZW5kcyBEXyB7CiAgY29uc3RydWN0b3IodCwgZSkgewogICAgc3VwZXIodCwgbmV3IERFKHQuZGlzcGxheSkpLCB0aGlzLnBvaW50MSA9IG51bGwsIHRoaXMucG9pbnQyID0gbnVsbCwgdGhpcy5taWRkbGVQb2ludCA9IG51bGwsIHRoaXMuZGVidWcgPSBlOwogIH0KICBfY3JlYXRlUGFuZWwoKSB7CiAgICB0aGlzLnBhbmVsLmNyZWF0ZVRhYmxlKHRoaXMucmVzcG9uc2VEYXRhKTsKICB9CiAgX2dldE1heE9ialNlbGVjdGVkKCkgewogICAgcmV0dXJuIDI7CiAgfQogIF9nZXRQb2ludHMoKSB7CiAgICB0aGlzLnBvaW50MSA9IG5ldyBFKC4uLnRoaXMucmVzcG9uc2VEYXRhLnJlZnBvaW50MSksIHRoaXMucG9pbnQyID0gbmV3IEUoLi4udGhpcy5yZXNwb25zZURhdGEucmVmcG9pbnQyKTsKICB9CiAgX21ha2VMaW5lcygpIHsKICAgIGlmICh0aGlzLnNjZW5lLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkgewogICAgICBjb25zdCBlID0gbmV3IGZwKAogICAgICAgIHRoaXMuY29uZUxlbmd0aCwKICAgICAgICB0aGlzLnBvaW50MSwKICAgICAgICB0aGlzLnBvaW50MiwKICAgICAgICAzLAogICAgICAgIHRoaXMubWVhc3VyZW1lbnRMaW5lQ29sb3IKICAgICAgKTsKICAgICAgdGhpcy5zY2VuZS5hZGQoZSksIHRoaXMubWlkZGxlUG9pbnQgPSBuZXcgRSgpLmFkZFZlY3RvcnModGhpcy5wb2ludDEsIHRoaXMucG9pbnQyKS5tdWx0aXBseVNjYWxhcigwLjUpOwogICAgICBjb25zdCBpID0gbmV3IGZwKAogICAgICAgIHRoaXMuY29uZUxlbmd0aCwKICAgICAgICB0aGlzLnBhbmVsQ2VudGVyLAogICAgICAgIHRoaXMubWlkZGxlUG9pbnQsCiAgICAgICAgMS41LAogICAgICAgIHRoaXMuY29ubmVjdGluZ0xpbmVDb2xvciwKICAgICAgICAhMSwKICAgICAgICAhMQogICAgICApOwogICAgICB0aGlzLnNjZW5lLmFkZChpKTsKICAgIH0KICB9CiAgX3VwZGF0ZUNvbm5lY3Rpb25MaW5lKCkgewogICAgdGhpcy5zY2VuZS5jaGlsZHJlblsxXS5jaGlsZHJlblswXS5nZW9tZXRyeS5zZXRQb3NpdGlvbnMoWwogICAgICAuLi50aGlzLm1pZGRsZVBvaW50LAogICAgICAuLi50aGlzLnBhbmVsQ2VudGVyCiAgICBdKTsKICB9CiAgLyoqCiAgICogSGFuZGxlIHRoZSByZXNwb25zZSBmcm9tIHRoZSBiYWNrZW5kLgogICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZQogICAqLwogIGhhbmRsZVJlc3BvbnNlKHQpIHsKICAgIHRoaXMucmVzcG9uc2VEYXRhID0geyAuLi50IH0sIHRoaXMuX2dldFBvaW50cygpOwogIH0KfQpjbGFzcyBVXyBleHRlbmRzIERfIHsKICBjb25zdHJ1Y3Rvcih0LCBlKSB7CiAgICBzdXBlcih0LCBuZXcgRkUodC5kaXNwbGF5KSksIHRoaXMubWlkZGxlUG9pbnQgPSBudWxsLCB0aGlzLmRlYnVnID0gZTsKICB9CiAgX2NyZWF0ZVBhbmVsKCkgewogICAgdGhpcy5wYW5lbC5jcmVhdGVUYWJsZSh0aGlzLnJlc3BvbnNlRGF0YSk7CiAgfQogIF9nZXRNYXhPYmpTZWxlY3RlZCgpIHsKICAgIHJldHVybiAxOwogIH0KICBfZ2V0UG9pbnQoKSB7CiAgICB0aGlzLnBvaW50MSA9IG5ldyBFKC4uLnRoaXMucmVzcG9uc2VEYXRhLnJlZnBvaW50KTsKICB9CiAgX21ha2VMaW5lcygpIHsKICAgIGlmICh0aGlzLnNjZW5lLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLm1pZGRsZVBvaW50ID0gdGhpcy5wb2ludDE7CiAgICAgIGNvbnN0IHQgPSAxLjUsIGUgPSBuZXcgZnAoCiAgICAgICAgdGhpcy5jb25lTGVuZ3RoLAogICAgICAgIHRoaXMucGFuZWxDZW50ZXIsCiAgICAgICAgdGhpcy5taWRkbGVQb2ludCwKICAgICAgICB0LAogICAgICAgIHRoaXMuY29ubmVjdGluZ0xpbmVDb2xvciwKICAgICAgICAhMSwKICAgICAgICAhMQogICAgICApOwogICAgICB0aGlzLnNjZW5lLmFkZChlKTsKICAgIH0KICB9CiAgX3VwZGF0ZUNvbm5lY3Rpb25MaW5lKCkgewogICAgdGhpcy5zY2VuZS5jaGlsZHJlblswXS5jaGlsZHJlblswXS5nZW9tZXRyeS5zZXRQb3NpdGlvbnMoWwogICAgICAuLi50aGlzLm1pZGRsZVBvaW50LAogICAgICAuLi50aGlzLnBhbmVsQ2VudGVyCiAgICBdKTsKICB9CiAgLyoqCiAgICogSGFuZGxlIHRoZSByZXNwb25zZSBmcm9tIHRoZSBiYWNrZW5kLgogICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZQogICAqLwogIGhhbmRsZVJlc3BvbnNlKHQpIHsKICAgIHRoaXMucmVzcG9uc2VEYXRhID0geyAuLi50IH0sIHRoaXMuX2dldFBvaW50KCk7CiAgfQp9CmNsYXNzIEJFIHsKICBjb25zdHJ1Y3Rvcih0KSB7CiAgICB0aGlzLnZpZXdlciA9IHQsIHRoaXMuc2VsZWN0ZWRTaGFwZXMgPSBbXSwgdGhpcy5jb250ZXh0RW5hYmxlZCA9ICExOwogIH0KICBlbmFibGVDb250ZXh0KCkgewogICAgdGhpcy5jb250ZXh0RW5hYmxlZCA9ICEwOwogIH0KICBkaXNhYmxlQ29udGV4dCgpIHsKICAgIHRoaXMuY29udGV4dEVuYWJsZWQgPSAhMTsKICAgIGZvciAodmFyIHQgb2YgdGhpcy5zZWxlY3RlZFNoYXBlcykKICAgICAgdC5vYmouY2xlYXJIaWdobGlnaHRzKCk7CiAgICB0aGlzLnNlbGVjdGVkU2hhcGVzID0gW107CiAgfQogIF9nZXRNYXhPYmpTZWxlY3RlZCgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBfZ2V0SW5kZXgodCkgewogICAgY29uc3QgZSA9IHQuc3BsaXQoInwiKTsKICAgIHJldHVybiBlW2UubGVuZ3RoIC0gMV0uc3BsaXQoIl8iKVsxXTsKICB9CiAgX2luY2x1ZGVzKHQpIHsKICAgIGZvciAodmFyIGUgb2YgdGhpcy5zZWxlY3RlZFNoYXBlcykKICAgICAgaWYgKHQgPT09IGUub2JqLm5hbWUpCiAgICAgICAgcmV0dXJuICEwOwogICAgcmV0dXJuICExOwogIH0KICBub3RpZnkoKSB7CiAgICB2YXIgdCA9IFtdOwogICAgZm9yIChsZXQgaSBvZiB0aGlzLnNlbGVjdGVkU2hhcGVzKSB7CiAgICAgIHZhciBlID0gaS5vYmoubmFtZTsKICAgICAgdC5wdXNoKHRoaXMuX2dldEluZGV4KGUpKTsKICAgIH0KICAgIHRoaXMudmlld2VyLmNoZWNrQ2hhbmdlcyh7IHNlbGVjdGVkOiB0IH0sICEwKTsKICB9CiAgaGFuZGxlU2VsZWN0aW9uKHQpIHsKICAgIGlmICh0KSB7CiAgICAgIHZhciBlID0gdC5vYmoubmFtZTsKICAgICAgdGhpcy5faW5jbHVkZXMoZSkgPyB0aGlzLnNlbGVjdGVkU2hhcGVzID0gdGhpcy5zZWxlY3RlZFNoYXBlcy5maWx0ZXIoCiAgICAgICAgKGkpID0+IGkub2JqLm5hbWUgIT09IGUKICAgICAgKSA6IHRoaXMuc2VsZWN0ZWRTaGFwZXMucHVzaCh0KSwgdGhpcy5ub3RpZnkoKTsKICAgIH0KICB9CiAgX3JlbW92ZUxhc3RTZWxlY3RlZE9iaih0KSB7CiAgICBpZiAodCkgewogICAgICBsZXQgZSA9IHQub2JqcygpOwogICAgICBmb3IgKGxldCBpIG9mIGUpCiAgICAgICAgaS5jbGVhckhpZ2hsaWdodHMoKTsKICAgIH0KICAgIHRoaXMubm90aWZ5KCk7CiAgfQogIHJlbW92ZUxhc3RTZWxlY3RlZE9iaih0KSB7CiAgICBpZiAodCkgewogICAgICBmb3IgKHZhciBlIG9mIHRoaXMuc2VsZWN0ZWRTaGFwZXMpCiAgICAgICAgdGhpcy5fcmVtb3ZlTGFzdFNlbGVjdGVkT2JqKGUpOwogICAgICB0aGlzLnNlbGVjdGVkU2hhcGVzID0gW107CiAgICB9IGVsc2UgewogICAgICBjb25zdCBpID0gdGhpcy5zZWxlY3RlZFNoYXBlcy5wb3AoKTsKICAgICAgdGhpcy5fcmVtb3ZlTGFzdFNlbGVjdGVkT2JqKGkpLCB0aGlzLm5vdGlmeSgpOwogICAgfQogIH0KICB1cGRhdGUoKSB7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc2FibGVDb250ZXh0KCk7CiAgfQp9CmNvbnN0IFVlID0gewogIE5PTkU6ICJOb25lIiwKICBESVNUQU5DRTogIkRpc3RhbmNlTWVhc3VyZW1lbnQiLAogIFBST1BFUlRJRVM6ICJQcm9wZXJ0aWVzTWVhc3VyZW1lbnQiLAogIFNFTEVDVDogIlNlbGVjdE9iamVjdHMiCn07CmNsYXNzIHpFIHsKICAvKioKICAgKgogICAqIEBwYXJhbSB7aW1wb3J0ICgiLi4vdmlld2VyLmpzIikuVmlld2VyfSB2aWV3ZXIgVGhlIHZpZXdlciBpbnN0YW5jZQogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIHRoaXMudmlld2VyID0gdCwgdGhpcy5kaXN0YW5jZU1lYXN1cmVtZW50ID0gbmV3IEZfKHQsIGUpLCB0aGlzLnByb3BlcnRpZXNNZWFzdXJlbWVudCA9IG5ldyBVXyh0LCBlKSwgdGhpcy5zZWxlY3RPYmplY3QgPSBuZXcgQkUodCksIHRoaXMuZW5hYmxlZFRvb2wgPSBudWxsOwogIH0KICAvKioKICAgKiBFbmFibGVzIGEgc3BlY2lmaWMgdG9vbC4gKERpc2FibGVzIHRoZSBjdXJyZW50bHkgZW5hYmxlZCB0b29sIGlmIGFueSkKICAgKiBAcGFyYW0ge1Rvb2xUeXBlc30gdG9vbFR5cGUgLSBUaGUgdHlwZSBvZiB0b29sIHRvIGVuYWJsZS4KICAgKi8KICBlbmFibGUodCkgewogICAgc3dpdGNoICh0aGlzLmVuYWJsZWRUb29sICYmIHRoaXMuZGlzYWJsZSgpLCB0KSB7CiAgICAgIGNhc2UgVWUuRElTVEFOQ0U6CiAgICAgICAgdGhpcy5kaXN0YW5jZU1lYXN1cmVtZW50LmVuYWJsZUNvbnRleHQoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBVZS5QUk9QRVJUSUVTOgogICAgICAgIHRoaXMucHJvcGVydGllc01lYXN1cmVtZW50LmVuYWJsZUNvbnRleHQoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBVZS5TRUxFQ1Q6CiAgICAgICAgdGhpcy5zZWxlY3RPYmplY3QuZW5hYmxlQ29udGV4dCgpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0b29sIHR5cGU6ICR7dH1gKTsKICAgIH0KICAgIHRoaXMuZW5hYmxlZFRvb2wgPSB0OwogIH0KICBkaXNhYmxlKCkgewogICAgdGhpcy5lbmFibGVkVG9vbCAmJiAodGhpcy52aWV3ZXIuZGlzcGxheS5zaGFwZUZpbHRlckRyb3BEb3duTWVudS5yZXNldCgpLCB0aGlzLl9kaXNhYmxlKCkpOwogIH0KICAvKioKICAgKiBEaXNhYmxlcyB0aGUgY3VycmVudGx5IGVuYWJsZWQgdG9vbC4KICAgKi8KICBfZGlzYWJsZSgpIHsKICAgIGlmICh0aGlzLmVuYWJsZWRUb29sKSB7CiAgICAgIHN3aXRjaCAodGhpcy5lbmFibGVkVG9vbCkgewogICAgICAgIGNhc2UgVWUuRElTVEFOQ0U6CiAgICAgICAgICB0aGlzLmRpc3RhbmNlTWVhc3VyZW1lbnQuZGlzYWJsZUNvbnRleHQoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgVWUuUFJPUEVSVElFUzoKICAgICAgICAgIHRoaXMucHJvcGVydGllc01lYXN1cmVtZW50LmRpc2FibGVDb250ZXh0KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIFVlLlNFTEVDVDoKICAgICAgICAgIHRoaXMuc2VsZWN0T2JqZWN0LmRpc2FibGVDb250ZXh0KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIHRvb2wgdHlwZTogJHt0aGlzLmVuYWJsZWRUb29sfWApOwogICAgICB9CiAgICAgIHRoaXMuZW5hYmxlZFRvb2wgPSBudWxsOwogICAgfQogIH0KICBoYW5kbGVSZW1vdmVMYXN0U2VsZWN0aW9uKHQgPSAhMSkgewogICAgdGhpcy5kaXN0YW5jZU1lYXN1cmVtZW50LmNvbnRleHRFbmFibGVkID8gdGhpcy5kaXN0YW5jZU1lYXN1cmVtZW50LnJlbW92ZUxhc3RTZWxlY3RlZE9iaih0KSA6IHRoaXMucHJvcGVydGllc01lYXN1cmVtZW50LmNvbnRleHRFbmFibGVkID8gdGhpcy5wcm9wZXJ0aWVzTWVhc3VyZW1lbnQucmVtb3ZlTGFzdFNlbGVjdGVkT2JqKHQpIDogdGhpcy5zZWxlY3RPYmplY3QuY29udGV4dEVuYWJsZWQgJiYgdGhpcy5zZWxlY3RPYmplY3QucmVtb3ZlTGFzdFNlbGVjdGVkT2JqKCExKTsKICB9CiAgLyoqCiAgICogb2JqOiBPYmplY3RHcm91cAogICAqIEBwYXJhbSB7b2JqZWN0fSBzZWxlY3RlZE9iaiBUaGUgc2VsZWN0ZWQgb2JqLgogICAqLwogIGhhbmRsZVNlbGVjdGVkT2JqKHQsIGUsIGkpIHsKICAgIHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudC5jb250ZXh0RW5hYmxlZCA/IChlICYmIHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudC5yZW1vdmVMYXN0U2VsZWN0ZWRPYmooKSwgdGhpcy5kaXN0YW5jZU1lYXN1cmVtZW50LmhhbmRsZVNlbGVjdGlvbih0LCBpKSkgOiB0aGlzLnByb3BlcnRpZXNNZWFzdXJlbWVudC5jb250ZXh0RW5hYmxlZCA/IChlICYmIHRoaXMucHJvcGVydGllc01lYXN1cmVtZW50LnJlbW92ZUxhc3RTZWxlY3RlZE9iaigpLCB0aGlzLnByb3BlcnRpZXNNZWFzdXJlbWVudC5oYW5kbGVTZWxlY3Rpb24odCkpIDogdGhpcy5zZWxlY3RPYmplY3QuY29udGV4dEVuYWJsZWQgJiYgdGhpcy5zZWxlY3RPYmplY3QuaGFuZGxlU2VsZWN0aW9uKHQpOwogIH0KICBoYW5kbGVSZXNldFNlbGVjdGlvbigpIHsKICAgIHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudC5jb250ZXh0RW5hYmxlZCA/ICh0aGlzLmRpc3RhbmNlTWVhc3VyZW1lbnQucmVtb3ZlTGFzdFNlbGVjdGVkT2JqKCEwKSwgdGhpcy5kaXN0YW5jZU1lYXN1cmVtZW50LnJlbW92ZUxhc3RTZWxlY3RlZE9iaighMCkpIDogdGhpcy5wcm9wZXJ0aWVzTWVhc3VyZW1lbnQuY29udGV4dEVuYWJsZWQgPyB0aGlzLnByb3BlcnRpZXNNZWFzdXJlbWVudC5yZW1vdmVMYXN0U2VsZWN0ZWRPYmooITApIDogdGhpcy5zZWxlY3RPYmplY3QuY29udGV4dEVuYWJsZWQgJiYgdGhpcy5zZWxlY3RPYmplY3QucmVtb3ZlTGFzdFNlbGVjdGVkT2JqKCEwKTsKICB9CiAgLyoqCiAgICogSGFuZGxlIHRoZSByZXNwb25zZSBmcm9tIHRoZSBiYWNrZW5kLgogICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZQogICAqLwogIGhhbmRsZVJlc3BvbnNlKHQpIHsKICAgIHN3aXRjaCAodC50b29sX3R5cGUpIHsKICAgICAgY2FzZSBVZS5ESVNUQU5DRToKICAgICAgICB0aGlzLmRpc3RhbmNlTWVhc3VyZW1lbnQuaGFuZGxlUmVzcG9uc2UodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgVWUuUFJPUEVSVElFUzoKICAgICAgICB0aGlzLnByb3BlcnRpZXNNZWFzdXJlbWVudC5oYW5kbGVSZXNwb25zZSh0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBVZS5TRUxFQ1Q6CiAgICAgICAgdGhpcy5zZWxlY3RPYmplY3QuaGFuZGxlUmVzcG9uc2UodCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIC8qKgogICAqIFRoaXMgaXMgY2FsbGVkIGVhY2ggdGltZSB0aGUgdmlld2VyIGdldHMgdXBkYXRlZAogICAqLwogIHVwZGF0ZSgpIHsKICAgIHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudC5jb250ZXh0RW5hYmxlZCA/IHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudC51cGRhdGUoKSA6IHRoaXMucHJvcGVydGllc01lYXN1cmVtZW50LmNvbnRleHRFbmFibGVkID8gdGhpcy5wcm9wZXJ0aWVzTWVhc3VyZW1lbnQudXBkYXRlKCkgOiB0aGlzLnNlbGVjdE9iamVjdC5jb250ZXh0RW5hYmxlZCAmJiB0aGlzLnNlbGVjdE9iamVjdC51cGRhdGUoKTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudC5kaXNwb3NlKCksIHRoaXMucHJvcGVydGllc01lYXN1cmVtZW50LmRpc3Bvc2UoKSwgdGhpcy5zZWxlY3RPYmplY3QuZGlzcG9zZSgpOwogIH0KfQp2YXIgTkUgPSBgPGRpdiBjbGFzcz0idGN2X2NhZF92aWV3ZXIiPgogICAgPGRpdiBjbGFzcz0idGN2X2NhZF90b29sYmFyIHRjdl9yb3VuZCI+PC9kaXY+CgogICAgPGRpdiBjbGFzcz0idGN2X2NhZF9ib2R5Ij4KICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX25hdmlnYXRpb24iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX3RyZWUgdGN2X3JvdW5kIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl90YWJuYXYiPgogICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0ndGN2X3RhYl90cmVlIHRjdl90YWIgdGN2X3RhYi1sZWZ0IHRjdl90YWItc2VsZWN0ZWQnIHZhbHVlPSJUcmVlIiB0eXBlPSJidXR0b24iIC8+CiAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfdGFiX2NsaXAgdGN2X3RhYiB0Y3ZfdGFiLXJpZ2h0IHRjdl90YWItdW5zZWxlY3RlZCcgdmFsdWU9IkNsaXBwaW5nIgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlPSJidXR0b24iIC8+CiAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfdGFiX21hdGVyaWFsIHRjdl90YWIgdGN2X3RhYi1yaWdodCB0Y3ZfdGFiLXVuc2VsZWN0ZWQnIHZhbHVlPSJNYXRlcmlhbCIKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0iYnV0dG9uIiAvPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX3RyZWVfdG9nZ2xlcyI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl90b29sdGlwIiBkYXRhLXRvb2x0aXA9IkNvbGxwYXNlIG5vZGVzIHdpdGggYSBzaW5nbGUgbGVhZiI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0ndGN2X2NvbGxhcHNlX3NpbmdsZXMgdGN2X2J0biB0Y3Zfc21hbGxfYnRuJyB2YWx1ZT0iMSIgdHlwZT0iYnV0dG9uIiAvPgogICAgICAgICAgICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idGN2X3Rvb2x0aXAiIGRhdGEtdG9vbHRpcD0iRXhwYW5kIHJvb3Qgbm9kZSBvbmx5Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfZXhwYW5kX3Jvb3QgdGN2X2J0biB0Y3Zfc21hbGxfYnRuJyB2YWx1ZT0iUiIgdHlwZT0iYnV0dG9uIiAvPgogICAgICAgICAgICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idGN2X3Rvb2x0aXAiIGRhdGEtdG9vbHRpcD0iQ29sbHBhc2UgdHJlZSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0ndGN2X2NvbGxhcHNlX2FsbCB0Y3ZfYnRuIHRjdl9zbWFsbF9idG4nIHZhbHVlPSJDIiB0eXBlPSJidXR0b24iIC8+CiAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfdG9vbHRpcCIgZGF0YS10b29sdGlwPSJFeHBhbmQgdHJlZSI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0ndGN2X2V4cGFuZCB0Y3ZfYnRuIHRjdl9zbWFsbF9idG4nIHZhbHVlPSJFIiB0eXBlPSJidXR0b24iIC8+CiAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfYm94X2NvbnRlbnQgdGN2X21hYy1zY3JvbGxiYXIgdGN2X3Njcm9sbGVyIj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX3RyZWVfY29udGFpbmVyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX2NsaXBfY29udGFpbmVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X3NsaWRlcl9ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfdG9vbHRpcCIgZGF0YS10b29sdGlwPSJTZXQgcmVkIGNsaXBwaW5nIHBsYW5lIHRvIHZpZXcgZGlyZWN0aW9uIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfYnRuX25vcm1fcGxhbmUxIHRjdl9idG4gdGN2X3BsYW5lJyB0eXBlPSJidXR0b24iIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfbGJsX25vcm1fcGxhbmUxIHRjdl9sYWJlbCI+TjEgPSAobi9hLCBuL2EsIG4vYSk8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjEiIG1heD0iMTAwIiB2YWx1ZT0iNTAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ0Y3Zfc2xkX3ZhbHVlX3BsYW5lMSB0Y3ZfY2xpcF9zbGlkZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB2YWx1ZT01MCBjbGFzcz0idGN2X2lucF92YWx1ZV9wbGFuZTEgdGN2X2NsaXBfaW5wdXQiPjwvaW5wdXQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9zbGlkZXJfZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idG9vbHRpcCIgZGF0YS10b29sdGlwPSJTZXQgZ3JlZW4gY2xpcHBpbmcgcGxhbmUgdG8gdmlldyBkaXJlY3Rpb24iPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgY2xhc3M9J3Rjdl9idG5fbm9ybV9wbGFuZTIgdGN2X2J0biB0Y3ZfcGxhbmUnIHR5cGU9ImJ1dHRvbiIgLz4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl9sYmxfbm9ybV9wbGFuZTIgdGN2X2xhYmVsIj5OMiA9IChuL2EsIG4vYSwgbi9hKTwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0icmFuZ2UiIG1pbj0iMSIgbWF4PSIxMDAiIHZhbHVlPSI1MCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M9InRjdl9zbGRfdmFsdWVfcGxhbmUyIHRjdl9jbGlwX3NsaWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHZhbHVlPTUwIGNsYXNzPSJ0Y3ZfaW5wX3ZhbHVlX3BsYW5lMiB0Y3ZfY2xpcF9pbnB1dCI+PC9pbnB1dD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X3NsaWRlcl9ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0b29sdGlwIiBkYXRhLXRvb2x0aXA9IlNldCBibHVlIGNsaXBwaW5nIHBsYW5lIHRvIHZpZXcgZGlyZWN0aW9uIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfYnRuX25vcm1fcGxhbmUzIHRjdl9idG4gdGN2X3BsYW5lJyB0eXBlPSJidXR0b24iIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfbGJsX25vcm1fcGxhbmUzIHRjdl9sYWJlbCI+TjMgPSAobi9hLCBuL2EsIG4vYSk8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjEiIG1heD0iMTAwIiB2YWx1ZT0iNTAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ0Y3Zfc2xkX3ZhbHVlX3BsYW5lMyB0Y3ZfY2xpcF9zbGlkZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB2YWx1ZT01MCBjbGFzcz0idGN2X2lucF92YWx1ZV9wbGFuZTMgdGN2X2NsaXBfaW5wdXQiPjwvaW5wdXQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9jbGlwX2NoZWNrcyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfdG9vbHRpcCIgZGF0YS10b29sdGlwPSJVc2UgaW50ZXJzZWN0aW9uIGNsaXBwaW5nIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfY2xpcF9pbnRlcnNlY3Rpb24gdGN2X2NoZWNrJyB0eXBlPSJjaGVja2JveCIgLz4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl9sYWJlbCI+SW50ZXJzZWN0aW9uPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idGN2X3Rvb2x0aXAiIGRhdGEtdG9vbHRpcD0iU2hvdyBjbGlwcGluZyBwbGFuZXMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgY2xhc3M9J3Rjdl9jbGlwX3BsYW5lX2hlbHBlcnMgdGN2X2F4ZXMwIHRjdl9jaGVjaycgdHlwZT0iY2hlY2tib3giIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfbGFiZWwiPlBsYW5lczwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfdG9vbHRpcCIgZGF0YS10b29sdGlwPSJVc2Ugb2JqZWN0IGNvbG9yIGNhcHMgaW5zdGVhZCBvZiBSR0IiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0ndGN2X2NsaXBfY2FwcyB0Y3ZfYXhlczAgdGN2X2NoZWNrJyB0eXBlPSJjaGVja2JveCIgLz4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idGN2X2xhYmVsIj5Vc2Ugb2JqZWN0IGNvbG9yIGNhcHM8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9jYWRfbWF0ZXJpYWxfY29udGFpbmVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X2NhZF90cmVlX3RvZ2dsZXMiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl90b29sdGlwIiBkYXRhLXRvb2x0aXA9IlJlc2V0IHRvIG9yaWdpbmFsIHZhbHVlcyI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IGNsYXNzPSd0Y3ZfbWF0ZXJpYWxfcmVzZXQgdGN2X2J0biB0Y3Zfc21hbGxfYnRuJyB2YWx1ZT0iUiIgdHlwZT0iYnV0dG9uIiAvPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X21hdGVyaWFsX2FtYmllbnRsaWdodCB0Y3ZfbGFiZWwiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgQW1iaWVudCBsaWdodCBpbnRlbnNpdHkgKCUpCiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3Zfc2xpZGVyX2dyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjAiIG1heD0iMjAiIHZhbHVlPSIxIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz0idGN2X3NsZF92YWx1ZV9hbWJpZW50bGlnaHQgdGN2X2NsaXBfc2xpZGVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdmFsdWU9MSBjbGFzcz0idGN2X2lucF92YWx1ZV9hbWJpZW50bGlnaHQgdGN2X2NsaXBfaW5wdXQiPjwvaW5wdXQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9tYXRlcmlhbF9wb2ludGxpZ2h0IHRjdl9sYWJlbCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBEaXJlY3Rpb25hbCBsaWdodCBpbnRlbnNpdHkgKCUpCiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3Zfc2xpZGVyX2dyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjAiIG1heD0iNDAiIHZhbHVlPSIxIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz0idGN2X3NsZF92YWx1ZV9wb2ludGxpZ2h0IHRjdl9jbGlwX3NsaWRlciI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHZhbHVlPTEgY2xhc3M9InRjdl9pbnBfdmFsdWVfcG9pbnRsaWdodCB0Y3ZfY2xpcF9pbnB1dCI+PC9pbnB1dD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X21hdGVyaWFsX21ldGFsbmVzcyB0Y3ZfbGFiZWwiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgTWV0YWxuZXNzICglKQogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X3NsaWRlcl9ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYW5nZSIgbWluPSIwIiBtYXg9IjEwMCIgdmFsdWU9IjQwIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz0idGN2X3NsZF92YWx1ZV9tZXRhbG5lc3MgdGN2X2NsaXBfc2xpZGVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdmFsdWU9NDAgY2xhc3M9InRjdl9pbnBfdmFsdWVfbWV0YWxuZXNzIHRjdl9jbGlwX2lucHV0Ij48L2lucHV0PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfbWF0ZXJpYWxfcm91Z2huZXNzIHRjdl9sYWJlbCI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBSb3VnaG5lc3MgKCUpCiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3Zfc2xpZGVyX2dyb3VwIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjAiIG1heD0iMTAwIiB2YWx1ZT0iNDAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ0Y3Zfc2xkX3ZhbHVlX3JvdWdobmVzcyB0Y3ZfY2xpcF9zbGlkZXIiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB2YWx1ZT00MCBjbGFzcz0idGN2X2lucF92YWx1ZV9yb3VnaG5lc3MgdGN2X2NsaXBfaW5wdXQiPjwvaW5wdXQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9tYXRlcmlhbF9pbmZvIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgaXMgbm90IGEgZnVsbCBtYXRlcmlhbCByZW5kZXJlciAoZS5nLiB0aGUgZW52aXJvbm1lbnQgaXMgYmxhY2spLCBzbwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90IGV2ZXJ5IGNvbWJpbmF0aW9uIGNyZWF0ZXMgZXhwZWN0ZWQgb3IgZ29vZCByZXN1bHRzLgogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X2NhZF9pbmZvX3dyYXBwZXIiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X3RvZ2dsZV9pbmZvX3dyYXBwZXIiPgogICAgICAgICAgICAgICAgICAgIDwhLS0gPHNwYW4gY2xhc3M9InRvb2x0aXAiIGRhdGEtdG9vbHRpcD0iT3Blbi9jbG9zZSBpbmZvIGJveCI+IC0tPgogICAgICAgICAgICAgICAgICAgICAgICA8IS0tIDxpbnB1dCBjbGFzcz0ndGN2X3RvZ2dsZV9pbmZvIHRjdl9idG4gdGN2X3NtYWxsX2luZm9fYnRuJyB2YWx1ZT0iPCIgdHlwZT0iYnV0dG9uIiAvPiAtLT4KICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9J3Rjdl90b2dnbGVfaW5mbyc+PC9zcGFuPjxzcGFuIGNsYXNzPSJ0Y3ZfaW5mb19sYWJlbCI+SW5mbzwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8IS0tIDwvc3Bhbj4gLS0+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9jYWRfaW5mbyB0Y3Zfcm91bmQiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9ib3hfY29udGVudCB0Y3ZfbWFjLXNjcm9sbGJhciB0Y3Zfc2Nyb2xsZXIiPgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX2luZm9fY29udGFpbmVyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KCiAgICAgICAgPGRpdiBjbGFzcz0idGN2X2NhZF92aWV3Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X2Rpc3RhbmNlX21lYXN1cmVtZW50X3BhbmVsIHRjdl9wYW5lbCB0Y3Zfcm91bmQiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X21lYXN1cmVfaGVhZGVyIj5EaXN0YW5jZTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9wcm9wZXJ0aWVzX21lYXN1cmVtZW50X3BhbmVsIHRjdl9wYW5lbCB0Y3Zfcm91bmQiPgogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X21lYXN1cmVfaGVhZGVyIj5Qcm9wZXJ0aWVzPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfbWVhc3VyZV9zdWJoZWFkZXIiPlNoYXBlPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X2NhZF9hbmltYXRpb24gdGN2X3JvdW5kIj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfYW5pbWF0aW9uX2xhYmVsIj5FPC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4+PGlucHV0IHR5cGU9InJhbmdlIiBtaW49IjAiIG1heD0iMTAwMCIgdmFsdWU9IjAiCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ0Y3ZfYW5pbWF0aW9uX3NsaWRlciB0Y3ZfY2xpcF9zbGlkZXIiPjwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfdG9vbHRpcCIgZGF0YS10b29sdGlwPSJQbGF5IGFuaW1hdGlvbiI+PGlucHV0IGNsYXNzPSd0Y3ZfcGxheSB0Y3ZfYnRuJwogICAgICAgICAgICAgICAgICAgICAgICB0eXBlPSJidXR0b24iIC8+PC9zcGFuPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl90b29sdGlwIiBkYXRhLXRvb2x0aXA9IlBhdXNlIGFuaW1hdGlvbiI+PGlucHV0IGNsYXNzPSd0Y3ZfcGF1c2UgdGN2X2J0bicKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0iYnV0dG9uIiAvPjwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJ0Y3ZfdG9vbHRpcCIgZGF0YS10b29sdGlwPSJTdG9wIGFuZCByZXNldCBhbmltYXRpb24iPjxpbnB1dCBjbGFzcz0ndGN2X3N0b3AgdGN2X2J0bicKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZT0iYnV0dG9uIiAvPjwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX3pzY2FsZSB0Y3Zfcm91bmQiPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl9hbmltYXRpb25fbGFiZWwiPlo8L3NwYW4+CiAgICAgICAgICAgICAgICA8c3Bhbj48aW5wdXQgdHlwZT0icmFuZ2UiIG1pbj0iMSIgbWF4PSIzMiIgdmFsdWU9IjAiCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPSJ0Y3ZfenNjYWxlX3NsaWRlciB0Y3ZfY2xpcF9zbGlkZXIiPjwvc3Bhbj4KICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfY2FkX2hlbHAgdGN2X3JvdW5kIj4KICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0idGN2X2NhZF9oZWxwX2xheW91dCI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxiPk1vdXNlIE5hdmlnYXRpb248L2I+PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPlJvdGF0ZTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4mbHQ7bGVmdCBtb3VzZSBidXR0b24mZ3Q7PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPlJvdGF0ZSB1cCAvIGRvd248L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O3t7Y3RybH19Jmd0OyArICZsdDtsZWZ0IG1vdXNlIGJ1dHRvbiZndDs8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Um90YXRlIGxlZnQgLyByaWdodDwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4mbHQ7e3ttZXRhfX0mZ3Q7ICsgJmx0O2xlZnQgbW91c2UgYnV0dG9uJmd0OzwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5QYW48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O3t7c2hpZnR9fSZndDsgKyAmbHQ7bGVmdCBtb3VzZSBidXR0b24mZ3Q7IG9yICZsdDtyaWdodCBtb3VzZSBidXR0b24mZ3Q7PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPlpvb208L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O21vdXNlIHdoZWVsJmd0OyBvciAmbHQ7bWlkZGxlIG1vdXNlIGJ1dHRvbiZndDs8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48Yj5Nb3VzZSBTZWxlY3Rpb248L2I+PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPlBpY2sgZWxlbWVudDwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4mbHQ7bGVmdCBtb3VzZSBidXR0b24mZ3Q7IGRvdWJsZSBjbGljazwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Q2xpY2sgb24gbmF2aWdhdGlvbiB0cmVlIGxhYmVsPC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4oU2hvd3MgYXhpcy1hbGlnbmVkIGJvdW5kaW5nIGJveCwgQUFCQik8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+SXNvbGF0ZSBlbGVtZW50PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPiZsdDt7e3NoaWZ0fX0mZ3Q7ICsgJmx0O2xlZnQgbW91c2UgYnV0dG9uJmd0OyBkb3VibGUgY2xpY2s8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPiZsdDt7e3NoaWZ0fX0mZ3Q7ICsgY2xpY2sgb24gbmF2aWdhdGlvbiB0cmVlIGxhYmVsIChuZXN0ZWQpPC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPkhpZGUgZWxlbWVudDwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4mbHQ7e3ttZXRhfX0mZ3Q7ICsgJmx0O2xlZnQgbW91c2UgYnV0dG9uJmd0OyBkb3VibGUgY2xpY2sgb2JqZWN0PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4gICAgCiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48L3RkPiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgPHRkPiZsdDt7e21ldGF9fSZndDsgKyAmbHQ7bGVmdCBtb3VzZSBidXR0b24mZ3Q7IGNsaWNrIHRyZWUgbGFiZWwgKG5lc3RlZCk8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+SGlkZSBvdGhlciBlbGVtZW50czwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4mbHQ7e3tzaGlmdH19Jmd0OyArICZsdDt7e21ldGF9fSZndDsgKyAmbHQ7bGVmdCBtb3VzZSBidXR0b24mZ3Q7IGNsaWNrIHRyZWUgbGFiZWwgKG5lc3RlZCk8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+U2V0IGNhbWVyYSB0YXJnZXQ8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O3t7c2hpZnR9fSZndCArICZsdDt7e21ldGF9fSZndDsgKyAmbHQ7bGVmdCBtb3VzZSBidXR0b24mZ3Q7IGRvdWJsZSBjbGljazwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4gICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48Yj5DQUQgT2JqZWN0IFRyZWU8L2I+PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPkNvbGxhcHNlIHNpbmdsZSBsZWFmczwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5CdXR0b24gJzEnIChhbGwgbm9kZXMgd2l0aCBvbmUgbGVhZiBvbmx5KTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5FeHBhbmQgcm9vdCBvbmx5PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPkJ1dHRvbiAnUic8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Q29sbGFwc2UgYWxsIG5vZGVzPC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPkJ1dHRvbiAnQyc8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+RXhwYW5kIGFsbCBub2RlczwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5CdXR0b24gJ0UnPC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48Yj5NZWFzdXJlIE1vZGU8L2I+PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPlNlbGVjdCAxLiAoYW5kIDIuKSBvYmplY3Q8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O2xlZnQgbW91c2UgYnV0dG9uJmd0OzwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5Vc2UgY2VudGVyIGluc3RlYWQgb2YgbWluIGRpc3RhbmNlPC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPiZsdDt7e3NoaWZ0fX0mZ3Q7ICsgJmx0O2xlZnQgbW91c2UgYnV0dG9uJmd0OyBmb3IgdGhlIHNlY29uZCBzZWxlY3Rpb248L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+RmlsdGVyIG9iamVjdCB0eXBlczwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD5UeXBlIG1lbnUgb3IgJmx0O24mZ3Q7b25lLCAmbHQ7cyZndDtvbGlkLCAmbHQ7ZiZndDthY2UsICZsdDtlJmd0O2RnZSAsICZsdDt2Jmd0O2VydGljZXM8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+VW5zZWxlY3QgbGFzdCBvYmplY3Q8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O3JpZ2h0IG1vdXNlIGJ1dHRvbiZndDs8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+VW5zZWxlY3QgYWxsIG9iamVjdHM8L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+Jmx0O0VTQyZndDs8L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzcz0idGN2X2ZpbHRlcl9tZW51Ij4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9kcm9wX2Rvd24gdGN2X3NoYXBlX2ZpbHRlciI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl9yb3VuZCB0Y3ZfZmlsdGVyX2NvbnRlbnQiPjxzcGFuIGNsYXNzPSJ0Y3ZfZmlsdGVyX3ZhbHVlIj5Ob25lPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idGN2X2ZpbHRlcl9pY29uIj7ij7YKICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfZmlsdGVyX2Ryb3Bkb3duIHRjdl9yb3VuZCI+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9maWx0ZXJfZHJvcGRvd25fdmFsdWUgdHZjX2ZpbHRlcl9ub25lIj5Ob25lPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InRjdl9maWx0ZXJfZHJvcGRvd25fdmFsdWUgdHZjX2ZpbHRlcl92ZXJ0ZXgiPlZlcnRleDwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfZmlsdGVyX2Ryb3Bkb3duX3ZhbHVlIHR2Y19maWx0ZXJfZWRnZSI+RWRnZTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfZmlsdGVyX2Ryb3Bkb3duX3ZhbHVlIHR2Y19maWx0ZXJfZmFjZSI+RmFjZTwvZGl2PgogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfZmlsdGVyX2Ryb3Bkb3duX3ZhbHVlIHR2Y19maWx0ZXJfc29saWQiPlNvbGlkPC9kaXY+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRjdl90aWNrX3NpemUiPgogICAgICAgIOKKouKKozxzcGFuIGNsYXNzPSJ0Y3ZfdGlja19zaXplX3ZhbHVlIj4wPC9zcGFuPgogICAgPC9kaXY+CjwvZGl2PmA7CmZ1bmN0aW9uIE9FKGEpIHsKICBjb25zdCB0ID0gRGUuZ2V0c2hvcnRjdXRzKCJzaGlmdCIpLCBlID0gRGUuZ2V0c2hvcnRjdXRzKCJjdHJsIiksIGkgPSBEZS5nZXRzaG9ydGN1dHMoIm1ldGEiKSwgbiA9IERlLmdldHNob3J0Y3V0cygiYWx0Iik7CiAgdmFyIHMgPSBORS5yZXBsYWNlQWxsKCJ7e2lkfX0iLCBhKS5yZXBsYWNlQWxsKCJ7e3NoaWZ0fX0iLCB0KS5yZXBsYWNlQWxsKCJ7e2N0cmx9fSIsIGUpLnJlcGxhY2VBbGwoInt7bWV0YX19IiwgaSkucmVwbGFjZUFsbCgie3thbHR9fSIsIG4pOwogIHJldHVybiBzOwp9CmZ1bmN0aW9uIExpKGEpIHsKICByZXR1cm4gYCR7YX1weGA7Cn0KY29uc3Qga0UgPSBbInBsYW5lIiwgInBsYXkiLCAicGF1c2UiLCAic3RvcCJdLCBObiA9IG5ldyBURSgpOwpjbGFzcyBWRSB7CiAgLyoqCiAgICogQ3JlYXRlIERpc3BsYXkKICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGNvbnRhaW5lciAtIHRoZSBET00gZWxlbWVudCwgZS5nLiBkaXYsIHRoYXQgc2hvdWxkIGNvbnRhaW4gdGhlIERpc3BsYXkKICAgKiBAcGFyYW0ge30gb3B0aW9ucyAtIGRpc3BsYXkgb3B0aW9ucwogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIC8vIGhhbmRsZXIgKGJvdW5kIHRvIERpc3BsYXkgaW5zdGFuY2UpCiAgICAvKioKICAgICAqCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHRvIHNldCBvciBub3QKICAgICAqLwogICAgayh0aGlzLCAic2V0QXhlcyIsICh0LCBlKSA9PiB7CiAgICAgIHRoaXMudmlld2VyLnNldEF4ZXMoZSk7CiAgICB9KTsKICAgIC8qKgogICAgICogQ2hlY2svdW5jaGVjayB0aGUgYXhlcyBjaGVja2JveAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIGNoZWNrIG9yIHVuY2hlY2sgdGhlIGF4ZXMgY2hlY2tib3gKICAgICAqLwogICAgayh0aGlzLCAic2V0QXhlc0NoZWNrIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5heGVzLnNldCh0KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVja2JveCBIYW5kbGVyIGZvciBzZXR0aW5nIHRoZSBncmlkIHBhcmFtZXRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB0byBzZXQgb3Igbm90CiAgICAgKi8KICAgIGsodGhpcywgInNldEdyaWQiLCAodCwgZSkgPT4gewogICAgICB0aGlzLnZpZXdlci5zZXRHcmlkKHQsIGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrL3VuY2hlY2sgdGhlIG1haW4gZ3JpZCBVSSBlbGVtZW50CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgbWFpbiBncmlkIGNoZWNrYm94CiAgICAgKi8KICAgIGsodGhpcywgInNldEdyaWRDaGVjayIsICh0KSA9PiB7CiAgICAgIHRoaXMuY2hlY2tFbGVtZW50KCJ0Y3ZfZ3JpZCIsIHQpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrYm94IEhhbmRsZXIgZm9yIHNldHRpbmcgdGhlIGF4ZXMwIHBhcmFtZXRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB0byBzZXQgb3Igbm90CiAgICAgKi8KICAgIGsodGhpcywgInNldEF4ZXMwIiwgKHQsIGUpID0+IHsKICAgICAgdGhpcy52aWV3ZXIuc2V0QXhlczAoZSk7CiAgICB9KTsKICAgIC8qKgogICAgICogQ2hlY2svdW5jaGVjayB0aGUgQXhlczAgY2hlY2tib3gKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBjaGVjayBvciB1bmNoZWNrIHRoZSBBeGVzMCBjaGVja2JveAogICAgICovCiAgICBrKHRoaXMsICJzZXRBeGVzMENoZWNrIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5heGVzMC5zZXQodCk7CiAgICB9KTsKICAgIC8qKgogICAgICogQ2hlY2tib3ggSGFuZGxlciBmb3Igc2V0dGluZyB0aGUgb3J0aG8gcGFyYW1ldGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHRvIHNldCBvciBub3QKICAgICAqLwogICAgayh0aGlzLCAic2V0T3J0aG8iLCAodCwgZSkgPT4gewogICAgICB0aGlzLnZpZXdlci5zd2l0Y2hDYW1lcmEoIWUpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrIG9yIHVuY2hlY2sgdGhlIE9ydGhvIGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgb3J0aG8gY2hlY2tib3gKICAgICAqLwogICAgayh0aGlzLCAic2V0T3J0aG9DaGVjayIsICh0KSA9PiB7CiAgICAgIHRoaXMudG9vbGJhckJ1dHRvbnMucGVyc3BlY3RpdmUuc2V0KCF0KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVja2JveCBIYW5kbGVyIGZvciBzZXR0aW5nIHRoZSB0cmFuc3BhcmVudCBwYXJhbWV0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gdG8gc2V0IG9yIG5vdAogICAgICovCiAgICBrKHRoaXMsICJzZXRUcmFuc3BhcmVudCIsICh0LCBlKSA9PiB7CiAgICAgIHRoaXMudmlld2VyLnNldFRyYW5zcGFyZW50KGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrIG9yIHVuY2hlY2sgdGhlIFRyYW5zcGFyZW50IGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgVHJhbnNwYXJlbnQgY2hlY2tib3gKICAgICAqLwogICAgayh0aGlzLCAic2V0VHJhbnNwYXJlbnRDaGVjayIsICh0KSA9PiB7CiAgICAgIHRoaXMudG9vbGJhckJ1dHRvbnMudHJhbnNwYXJlbnQuc2V0KHQpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrYm94IEhhbmRsZXIgZm9yIHNldHRpbmcgdGhlIGJsYWNrIGVkZ2VzIHBhcmFtZXRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB0byBzZXQgb3Igbm90CiAgICAgKi8KICAgIGsodGhpcywgInNldEJsYWNrRWRnZXMiLCAodCwgZSkgPT4gewogICAgICB0aGlzLnZpZXdlci5zZXRCbGFja0VkZ2VzKGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrIG9yIHVuY2hlY2sgdGhlIEJsYWNrIEVkZ2VzIGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgQmxhY2sgRWRnZXMgY2hlY2tib3gKICAgICAqLwogICAgayh0aGlzLCAic2V0QmxhY2tFZGdlc0NoZWNrIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5ibGFja2VkZ2VzLnNldCh0KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVja2JveCBIYW5kbGVyIGZvciBzZXR0aW5nIHRoZSBleHBsb2RlIG1vZGUKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gdG8gc2V0IG9yIG5vdAogICAgICovCiAgICBrKHRoaXMsICJzZXRFeHBsb2RlIiwgKHQsIGUpID0+IHsKICAgICAgZSAmJiB0aGlzLmV4cGxvZGVGbGFnIHx8ICFlICYmICF0aGlzLmV4cGxvZGVGbGFnIHx8IChlID8gKHRoaXMudmlld2VyLmhhc0FuaW1hdGlvbigpICYmIHRoaXMudmlld2VyLmJhY2t1cEFuaW1hdGlvbigpLCB0aGlzLnZpZXdlci5leHBsb2RlKCksIHRoaXMuZXhwbG9kZUZsYWcgPSAhMCkgOiAodGhpcy52aWV3ZXIuaGFzQW5pbWF0aW9uKCkgJiYgKHRoaXMuY29udHJvbEFuaW1hdGlvbkJ5TmFtZSgic3RvcCIpLCB0aGlzLnZpZXdlci5jbGVhckFuaW1hdGlvbigpLCB0aGlzLnZpZXdlci5yZXN0b3JlQW5pbWF0aW9uKCkpLCB0aGlzLmV4cGxvZGVGbGFnID0gITEpKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVjayBvciB1bmNoZWNrIHRoZSBFeHBsb2RlIGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgQmxhY2sgRWRnZXMgY2hlY2tib3gKICAgICAqLwogICAgayh0aGlzLCAic2V0RXhwbG9kZUNoZWNrIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5leHBsb2RlLnNldCh0KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93IG9yIGhpZGUgdGhlIEV4cGxvZGUgY2hlY2tib3gKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBjaGVjayBvciB1bmNoZWNrIHRoZSBCbGFjayBFZGdlcyBjaGVja2JveAogICAgICovCiAgICBrKHRoaXMsICJzaG93RXhwbG9kZSIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfZXhwbG9kZV93aWRnZXQiKTsKICAgICAgZS5zdHlsZS5kaXNwbGF5ID0gdCA/ICJpbmxpbmUtYmxvY2siIDogIm5vbmUiOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrYm94IEhhbmRsZXIgZm9yIHNldHRpbmcgdGhlIHpzY2FsZSBtb2RlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHRvIHNldCBvciBub3QKICAgICAqLwogICAgayh0aGlzLCAic2V0WlNjYWxlIiwgKHQsIGUpID0+IHsKICAgICAgdGhpcy5zaG93WlNjYWxlKGUpLCB0aGlzLnZpZXdlci5uZXN0ZWRHcm91cC5zZXRaU2NhbGUoMSksIHRoaXMudmlld2VyLnVwZGF0ZSghMCksIHRoaXMuX2dldEVsZW1lbnQoInRjdl96c2NhbGVfc2xpZGVyIikudmFsdWUgPSAxOwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cgb3IgaGlkZSB0aGUgWlNjYWxlIHNsaWRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIHNob3cgdGhlIFpTY2FsZSBzbGlkZXIKICAgICAqLwogICAgayh0aGlzLCAic2hvd1pTY2FsZSIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX3pzY2FsZSIpOwogICAgICBlLnN0eWxlLmRpc3BsYXkgPSB0ID8gImlubGluZS1ibG9jayIgOiAibm9uZSI7CiAgICB9KTsKICAgIC8qKgogICAgICogQ2hlY2sgb3IgdW5jaGVjayB0aGUgWlNjYWxlIGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgWlNjYWxlIGNoZWNrYm94CiAgICAgKi8KICAgIGsodGhpcywgInNldFpTY2FsZUNoZWNrIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy56c2NhbGUuc2V0KHQpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrYm94IEhhbmRsZXIgZm9yIHNldHRpbmcgdGhlIHRvb2xzIG1vZGUKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBzdGFydCBvciBzdG9wIG1lYXN1cmUgY29udGV4dAogICAgICovCiAgICBrKHRoaXMsICJzZXRUb29sIiwgKHQsIGUpID0+IHsKICAgICAgdGhpcy52aWV3ZXIudG9nZ2xlQW5pbWF0aW9uTG9vcChlKSwgZSA/ICh0aGlzLnNob3dBbmltYXRpb25Db250cm9sKCExKSwgdGhpcy52aWV3ZXIuaGFzQW5pbWF0aW9uKCkgJiYgdGhpcy52aWV3ZXIuYmFja3VwQW5pbWF0aW9uKCksIFsiZGlzdGFuY2UiLCAicHJvcGVydGllcyIsICJhbmdsZSIsICJzZWxlY3QiXS5pbmNsdWRlcyh0KSAmJiAhWyJkaXN0YW5jZSIsICJwcm9wZXJ0aWVzIiwgImFuZ2xlIiwgInNlbGVjdCJdLmluY2x1ZGVzKAogICAgICAgIHRoaXMuY3VycmVudEJ1dHRvbgogICAgICApICYmICh0aGlzLnZpZXdlci50b2dnbGVHcm91cCghMCksIHRoaXMudmlld2VyLnRvZ2dsZVRhYighMCkpLCB0aGlzLnZpZXdlci5zZXRSYXljYXN0TW9kZShlKSwgdGhpcy5zaGFwZUZpbHRlckRyb3BEb3duTWVudS5zZXRSYXljYXN0ZXIodGhpcy52aWV3ZXIucmF5Y2FzdGVyKSwgdCA9PSAiZGlzdGFuY2UiID8gKHRoaXMudmlld2VyLmNhZFRvb2xzLmVuYWJsZShVZS5ESVNUQU5DRSksIHRoaXMudmlld2VyLmNoZWNrQ2hhbmdlcyh7IGFjdGl2ZVRvb2w6IFVlLkRJU1RBTkNFIH0pKSA6IHQgPT0gInByb3BlcnRpZXMiID8gKHRoaXMudmlld2VyLmNhZFRvb2xzLmVuYWJsZShVZS5QUk9QRVJUSUVTKSwgdGhpcy52aWV3ZXIuY2hlY2tDaGFuZ2VzKHsgYWN0aXZlVG9vbDogVWUuUFJPUEVSVElFUyB9KSkgOiB0ID09ICJzZWxlY3QiICYmICh0aGlzLnZpZXdlci5jYWRUb29scy5lbmFibGUoVWUuU0VMRUNUKSwgdGhpcy52aWV3ZXIuY2hlY2tDaGFuZ2VzKHsgYWN0aXZlVG9vbDogVWUuU0VMRUNUIH0pKSwgdGhpcy5jdXJyZW50QnV0dG9uID0gdCkgOiAoKHRoaXMuY3VycmVudEJ1dHRvbiA9PSB0IHx8IHQgPT0gImV4cGxvZGUiKSAmJiAodGhpcy52aWV3ZXIudG9nZ2xlR3JvdXAoITEpLCB0aGlzLnZpZXdlci50b2dnbGVUYWIoITEpLCB0aGlzLmN1cnJlbnRCdXR0b24gPSBudWxsKSwgdCA9PSAiZGlzdGFuY2UiID8gdGhpcy52aWV3ZXIuY2FkVG9vbHMuZGlzYWJsZShVZS5ESVNUQU5DRSkgOiB0ID09ICJwcm9wZXJ0aWVzIiA/IHRoaXMudmlld2VyLmNhZFRvb2xzLmRpc2FibGUoVWUuUFJPUEVSVElFUykgOiB0ID09ICJzZWxlY3QiICYmIHRoaXMudmlld2VyLmNhZFRvb2xzLmRpc2FibGUoVWUuU0VMRUNUKSwgdGhpcy52aWV3ZXIuY2hlY2tDaGFuZ2VzKHsgYWN0aXZlVG9vbDogVWUuTk9ORSB9KSwgdGhpcy52aWV3ZXIuY2xlYXJTZWxlY3Rpb24oKSwgdGhpcy52aWV3ZXIuaGFzQW5pbWF0aW9uKCkgJiYgKHRoaXMuY29udHJvbEFuaW1hdGlvbkJ5TmFtZSgic3RvcCIpLCB0aGlzLnZpZXdlci5jbGVhckFuaW1hdGlvbigpLCB0aGlzLnZpZXdlci5yZXN0b3JlQW5pbWF0aW9uKCksIHRoaXMuc2hvd0FuaW1hdGlvbkNvbnRyb2woITApKSwgdGhpcy52aWV3ZXIuc2V0UmF5Y2FzdE1vZGUoZSkpLCB0aGlzLnZpZXdlci5zZXRQaWNrSGFuZGxlcighZSksIHRoaXMuc2hhcGVGaWx0ZXJEcm9wRG93bk1lbnUuc2hvdyhlKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVja2JveCBIYW5kbGVyIGZvciBzZXR0aW5nIHRoZSBjbGlwIHBsYW5lcyBwYXJhbWV0ZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtFdmVudH0gZSAtIGEgRE9NIGNsaWNrIGV2ZW50CiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBQbGFuZUhlbHBlcnMiLCAodCkgPT4gewogICAgICBjb25zdCBlID0gISF0LnRhcmdldC5jaGVja2VkOwogICAgICB0aGlzLnNldENsaXBQbGFuZUhlbHBlcnNDaGVjayhlKSwgdGhpcy52aWV3ZXIuc2V0Q2xpcFBsYW5lSGVscGVycyhlKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVjayBvciB1bmNoZWNrIHRoZSBQbGFuZSBIZWxwZXJzIGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgUGxhbmUgSGVscGVycyBjaGVja2JveAogICAgICovCiAgICBrKHRoaXMsICJzZXRDbGlwUGxhbmVIZWxwZXJzQ2hlY2siLCAodCkgPT4gewogICAgICB0aGlzLmNoZWNrRWxlbWVudCgidGN2X2NsaXBfcGxhbmVfaGVscGVycyIsIHQpLCB0aGlzLmxhc3RQbGFuZVN0YXRlID0gdDsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93IG9yIGhpZGUgdGhlIENBRCB0b29scwogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIHNob3cgb3IgaGlkZSB0aGUgQ0FEIHRvb2xzCiAgICAgKi8KICAgIGsodGhpcywgInNob3dUb29scyIsICh0KSA9PiB7CiAgICAgIHRoaXMudG9vbHMgPSB0LCB0aGlzLnZpZXdlciAmJiAodGhpcy52aWV3ZXIudG9vbHMgPSB0KTsKICAgICAgdmFyIGUgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX3Rvb2xiYXIiKSwgaSA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfbmF2aWdhdGlvbiIpOwogICAgICB0ID8gKGUuc3R5bGUuaGVpZ2h0ID0gIjM4cHgiLCBlLnN0eWxlLmRpc3BsYXkgPSAiZmxleCIsIGkuc3R5bGUuaGVpZ2h0ID0gIjM4cHgiLCBpLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siKSA6IChlLnN0eWxlLmhlaWdodCA9ICIwcHgiLCBlLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIGkuc3R5bGUuaGVpZ2h0ID0gIjBweCIsIGkuc3R5bGUuZGlzcGxheSA9ICJub25lIik7CiAgICB9KTsKICAgIC8qKgogICAgICogU2hvdyBvciBoaWRlcyBtZWFzdXJlbWVudCB0b29scywgbWVhc3VyZW1lbnQgdG9vbHMgbmVlZHMgYSBiYWNrZW5kIHRvIGJlIHVzZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcKICAgICAqLwogICAgayh0aGlzLCAic2hvd01lYXN1cmVUb29scyIsICh0KSA9PiB7CiAgICAgIHRoaXMudG9vbGJhckJ1dHRvbnMuZGlzdGFuY2Uuc2hvdyh0KSwgdGhpcy50b29sYmFyQnV0dG9ucy5wcm9wZXJ0aWVzLnNob3codCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2hvdyBvciBoaWRlcyBtZWFzdXJlbWVudCB0b29scywgbWVhc3VyZW1lbnQgdG9vbHMgbmVlZHMgYSBiYWNrZW5kIHRvIGJlIHVzZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcKICAgICAqLwogICAgayh0aGlzLCAic2hvd1NlbGVjdFRvb2wiLCAodCkgPT4gewogICAgICB0aGlzLnRvb2xiYXJCdXR0b25zLnNlbGVjdC5zaG93KHQpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cgb3IgaGlkZXMgZXhwbG9kZSB0b29sCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcKICAgICAqLwogICAgayh0aGlzLCAic2hvd0V4cGxvZGVUb29sIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5leHBsb2RlLnNob3codCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2hvdyBvciBoaWRlcyBaU2NhbGUgdG9vbAogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnCiAgICAgKi8KICAgIGsodGhpcywgInNob3daU2NhbGVUb29sIiwgKHQpID0+IHsKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy56c2NhbGUuc2hvdyh0KSwgdCB8fCB0aGlzLnNob3daU2NhbGUoITEpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrYm94IEhhbmRsZXIgZm9yIHNldHRpbmcgdGhlIGNsaXAgaW50ZXJzZWN0aW9uIHBhcmFtZXRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0geyp9IGUKICAgICAqLwogICAgayh0aGlzLCAic2V0Q2xpcEludGVyc2VjdGlvbiIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSAhIXQudGFyZ2V0LmNoZWNrZWQ7CiAgICAgIHRoaXMudmlld2VyLnNldENsaXBJbnRlcnNlY3Rpb24oZSk7CiAgICB9KTsKICAgIC8qKgogICAgICogQ2hlY2sgb3IgdW5jaGVjayB0aGUgSW50ZXJzZWN0aW9uIGNoZWNrYm94CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gY2hlY2sgb3IgdW5jaGVjayB0aGUgSW50ZXJzZWN0aW9uIGNoZWNrYm94CiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBJbnRlcnNlY3Rpb25DaGVjayIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2xpcF9pbnRlcnNlY3Rpb24iKTsKICAgICAgZS5jaGVja2VkID0gdDsKICAgIH0pOwogICAgLyoqCiAgICAgKiBDaGVja2JveCBIYW5kbGVyIGZvciB0b2dnbGluZyB0aGUgY2xpcCBjYXBzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Kn0gZQogICAgICovCiAgICBrKHRoaXMsICJzZXRPYmplY3RDb2xvckNhcHMiLCAodCkgPT4gewogICAgICBjb25zdCBlID0gISF0LnRhcmdldC5jaGVja2VkOwogICAgICB0aGlzLnZpZXdlci5zZXRDbGlwT2JqZWN0Q29sb3JDYXBzKGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIENoZWNrIG9yIHVuY2hlY2sgdGhlIEludGVyc2VjdGlvbiBjaGVja2JveAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIGNoZWNrIG9yIHVuY2hlY2sgdGhlIG9iamVjdCBjb2xvcnMgY2hlY2tib3gKICAgICAqLwogICAgayh0aGlzLCAic2V0Q2xpcE9iamVjdENvbG9yc0NoZWNrIiwgKHQpID0+IHsKICAgICAgY29uc3QgZSA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl9jbGlwX2NhcHMiKTsKICAgICAgZS5jaGVja2VkID0gdDsKICAgIH0pOwogICAgLyoqCiAgICAgKiBIYW5kbGVyIHRvIHJlc2V0IHBvc2l0aW9uLCB6b29tIGFuZCB1cCBvZiB0aGUgY2FtZXJhCiAgICAgKiBAZnVuY3Rpb24KICAgICAqLwogICAgayh0aGlzLCAicmVzZXQiLCAoKSA9PiB7CiAgICAgIHRoaXMudmlld2VyLnJlc2V0KCksIHRoaXMuY2xlYXJIaWdobGlnaHRzKCk7CiAgICB9KTsKICAgIC8qKgogICAgICogSGFuZGxlciB0byByZXNldCB6b29tIG9mIHRoZSBjYW1lcmEKICAgICAqIEBmdW5jdGlvbgogICAgICovCiAgICBrKHRoaXMsICJyZXNpemUiLCAoKSA9PiB7CiAgICAgIHRoaXMudmlld2VyLnJlc2l6ZSgpOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZXIgdG8gc2V0IGNhbWVyYSB0byBhIHByZWRlZmluZWQgcG9zaXRpb24KICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtFdmVudH0gZSAtIGEgRE9NIGNsaWNrIGV2ZW50CiAgICAgKi8KICAgIGsodGhpcywgInNldFZpZXciLCAodCwgZSA9ICExKSA9PiB7CiAgICAgIHRoaXMudmlld2VyLnByZXNldENhbWVyYSh0KSwgZSAmJiB0aGlzLnZpZXdlci5jZW50ZXJWaXNpYmxlT2JqZWN0cygpLCB0aGlzLmhpZ2hsaWdodEJ1dHRvbih0KSwgdGhpcy52aWV3ZXIudXBkYXRlKCEwLCAhMSk7CiAgICB9KTsKICAgIC8qKgogICAgICogUGluIHNjcmVlbnNob3Qgb2YgY2FudmFzIGFzIFBORwogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gYSBET00gY2xpY2sgZXZlbnQKICAgICAqLwogICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzCiAgICBrKHRoaXMsICJwaW5Bc1BuZyIsICh0KSA9PiB7CiAgICAgIHRoaXMudmlld2VyLnBpbkFzUG5nKCk7CiAgICB9KTsKICAgIC8qKgogICAgICogSGFuZGxlciB0byBzZXQgdGhlIGxhYmVsIG9mIGEgY2xpcHBpbmcgbm9ybWFsIHdpZGdldAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBpbmRleCBvZiB0aGUgbm9ybWFsIHdpZGdldAogICAgICogQHBhcmFtIHtWZWN0b3IzfSBub3JtYWwgLSB0aGUgbm9ybWFsCiAgICAgKi8KICAgIGsodGhpcywgInNldE5vcm1hbExhYmVsIiwgKHQsIGUpID0+IHsKICAgICAgdGhpcy5wbGFuZUxhYmVsc1t0XS5pbm5lckhUTUwgPSBgTj0oJHtlWzBdLnRvRml4ZWQoCiAgICAgICAgMgogICAgICApfSwgJHtlWzFdLnRvRml4ZWQoMil9LCAke2VbMl0udG9GaXhlZCgyKX0pYDsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXQgdGhlIG5vcm1hbCBhdCBpbmRleCB0byB0aGUgY3VycmVudCB2aWV3aW5nIGRpcmVjdGlvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gYSBET00gY2xpY2sgZXZlbnQKICAgICAqLwogICAgayh0aGlzLCAic2V0Q2xpcE5vcm1hbEZyb21Qb3NpdGlvbiIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSBwYXJzZUludCh0LnRhcmdldC5jbGFzc0xpc3RbMF0uc2xpY2UoLTEpKTsKICAgICAgdGhpcy52aWV3ZXIuc2V0Q2xpcE5vcm1hbEZyb21Qb3NpdGlvbihlIC0gMSk7CiAgICB9KTsKICAgIC8qKgogICAgICogSGFuZGxlciB0byBhY3RpdmF0ZSBhIFVJIHRhYiAodHJlZSAvIGNsaXBwaW5nKQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gYSBET00gY2xpY2sgZXZlbnQKICAgICAqLwogICAgayh0aGlzLCAic2VsZWN0VGFiIiwgKHQpID0+IHsKICAgICAgY29uc3QgZSA9IHQudGFyZ2V0LmNsYXNzTmFtZS5zcGxpdCgiICIpWzBdOwogICAgICB0aGlzLnNlbGVjdFRhYkJ5TmFtZShlLnNsaWNlKDgpKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFtYmllbnQgbGlnaHQgaW50ZW5zaXR5IGluIHRoZSBVSQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gYSBmbG9hdCBiZXR3ZWVuIDAgYW5kIDQKICAgICAqLwogICAgayh0aGlzLCAic2V0QW1iaWVudExpZ2h0IiwgKHQpID0+IHsKICAgICAgdGhpcy5hbWJpZW50bGlnaHRTbGlkZXIuc2V0VmFsdWUodCAqIDEwMCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IHRoZSBkaXJlY3QgbGlnaHQgaW50ZW5zaXR5IGluIHRoZSBVSQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gYSBmbG9hdCBiZXR3ZWVuIDAgYW5kIDQKICAgICAqLwogICAgayh0aGlzLCAic2V0RGlyZWN0TGlnaHQiLCAodCkgPT4gewogICAgICB0aGlzLmRpcmVjdGlvbmFsbGlnaHRTbGlkZXIuc2V0VmFsdWUodCAqIDEwMCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IG1hdGVyaWFsIG1ldGFsbmVzcyBpbiB0aGUgVUkKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbCAtIGEgZmxvYXQgYmV0d2VlbiAwIGFuZCAxCiAgICAgKi8KICAgIGsodGhpcywgInNldE1ldGFsbmVzcyIsICh0KSA9PiB7CiAgICAgIHRoaXMubWV0YWxuZXNzU2xpZGVyLnNldFZhbHVlKHQgKiAxMDApOwogICAgfSk7CiAgICAvKioKICAgICAqIFNldCBtYXRlcmlhbCByb3VnaG5lc3MgaW4gdGhlIFVJCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgLSBhIGZsb2F0IGJldHdlZW4gMCBhbmQgMQogICAgICovCiAgICBrKHRoaXMsICJzZXRSb3VnaG5lc3MiLCAodCkgPT4gewogICAgICB0aGlzLnJvdWdobmVzc1NsaWRlci5zZXRWYWx1ZSh0ICogMTAwKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBSZXNldCBtYXRlcmlhbCB2YWx1ZXMgdG8gb3JpZ2luYWwgdmFsdWVzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgLSBhIERPTSBjbGljayBldmVudAogICAgICovCiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKICAgIGsodGhpcywgImhhbmRsZU1hdGVyaWFsUmVzZXQiLCAodCkgPT4gewogICAgICB0aGlzLnZpZXdlci5yZXNldE1hdGVyaWFsKCk7CiAgICB9KTsKICAgIC8qKgogICAgICogVG9nZ2xlIHZpc2liaWxpdHkgb2YgdGhlIGNsaXBwaW5nIHRhYgogICAgICogQGZ1bmN0aW9uCiAgICAgKi8KICAgIGsodGhpcywgInRvZ2dsZUNsaXBwaW5nVGFiIiwgKHQpID0+IHsKICAgICAgdCA/IHRoaXMudGFiQ2xpcC5yZW1vdmVBdHRyaWJ1dGUoImRpc2FibGVkIikgOiB0aGlzLnRhYkNsaXAuc2V0QXR0cmlidXRlKCJkaXNhYmxlZCIsICJ0cnVlIiksIHRoaXMudGFiQ2xpcC5jbGFzc0xpc3QudG9nZ2xlKCJ0Y3ZfdGFiLWRpc2FibGVkIiwgIXQpOwogICAgfSk7CiAgICAvKioKICAgICAqIENvbGxhcHNlIG5vZGVzIGhhbmRsZXIKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtFdmVudH0gZSAtIGEgRE9NIGNsaWNrIGV2ZW50CiAgICAgKi8KICAgIGsodGhpcywgImhhbmRsZUNvbGxhcHNlTm9kZXMiLCAodCkgPT4gewogICAgICB0aGlzLmNvbGxhcHNlTm9kZXModC50YXJnZXQudmFsdWUpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cgb3IgaGlkZSB0aGUgQW5pbWF0aW9uIGNvbnRyb2wgd2lkZ2V0CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gc2hvdyBvciBoaWRlIHRoZSBBbmltYXRpb24gY29udHJvbCB3aWRnZXQKICAgICAqLwogICAgayh0aGlzLCAic2hvd0FuaW1hdGlvbkNvbnRyb2wiLCAodCkgPT4gewogICAgICB0aGlzLmNhZEFuaW0uc3R5bGUuZGlzcGxheSA9IHQgPyAiYmxvY2siIDogIm5vbmUiOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZXIgZm9yIHRoZSBhbmltYXRpb24gY29udHJvbAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gYSBET00gY2xpY2sgZXZlbnQKICAgICAqLwogICAgayh0aGlzLCAiY29udHJvbEFuaW1hdGlvbiIsICh0KSA9PiB7CiAgICAgIGNvbnN0IGUgPSB0LnRhcmdldC5jbGFzc05hbWUuc3BsaXQoIiAiKVswXS5zbGljZSg0KTsKICAgICAgdGhpcy5jb250cm9sQW5pbWF0aW9uQnlOYW1lKGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZXIgZm9yIHRoZSBhbmltYXRpb24gc2xpZGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgLSBhIERPTSBjbGljayBldmVudAogICAgICovCiAgICBrKHRoaXMsICJhbmltYXRpb25DaGFuZ2UiLCAodCkgPT4gewogICAgICB0aGlzLnZpZXdlci5hbmltYXRpb24uc2V0UmVsYXRpdmVUaW1lKHQudGFyZ2V0LnZhbHVlQXNOdW1iZXIgLyAxZTMpLCB0aGlzLnZpZXdlci5sYXN0QmJveCAhPSBudWxsICYmICh0aGlzLnZpZXdlci5sYXN0QmJveC5uZWVkc1VwZGF0ZSA9ICEwKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93IG9yIGhpZGUgaGVscCBkaWFsb2cKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBzaG93IG9yIGhpZGUgaGVscCBkaWFsb2cKICAgICAqLwogICAgayh0aGlzLCAic2hvd0hlbHAiLCAodCkgPT4gewogICAgICB0aGlzLmNhZEhlbHAuc3R5bGUuZGlzcGxheSA9IHQgPyAiYmxvY2siIDogIm5vbmUiLCB0aGlzLmhlbHBfc2hvd24gPSB0OwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cgb3IgaGlkZSB0aGUgZGlzdGFuY2UgbWVhc3VyZW1lbnQgcGFuZWwKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZwogICAgICovCiAgICBrKHRoaXMsICJzaG93RGlzdGFuY2VQYW5lbCIsICh0KSA9PiB7CiAgICAgIHRoaXMuZGlzdGFuY2VNZWFzdXJlbWVudFBhbmVsLnN0eWxlLmRpc3BsYXkgPSB0ID8gImJsb2NrIiA6ICJub25lIjsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93IG9yIGhpZGUgdGhlIHByb3BlcnRpZXMgbWVhc3VyZW1lbnQgcGFuZWwKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZwogICAgICovCiAgICBrKHRoaXMsICJzaG93UHJvcGVydGllc1BhbmVsIiwgKHQpID0+IHsKICAgICAgdGhpcy5wcm9wZXJ0aWVzTWVhc3VyZW1lbnRQYW5lbC5zdHlsZS5kaXNwbGF5ID0gdCA/ICJibG9jayIgOiAibm9uZSI7CiAgICB9KTsKICAgIC8qKgogICAgICogU2hvdyBoZWxwIGRpYWxvZwogICAgICogQGZ1bmN0aW9uCiAgICAgKi8KICAgIGsodGhpcywgInRvZ2dsZUhlbHAiLCAoKSA9PiB7CiAgICAgIHRoaXMuc2hvd0hlbHAoIXRoaXMuaGVscF9zaG93bik7CiAgICB9KTsKICAgIC8qKgogICAgICogU2hvdyBvciBoaWRlIGluZm8gZGlhbG9nCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gc2hvdyBvciBoaWRlIGluZm8gZGlhbG9nCiAgICAgKi8KICAgIGsodGhpcywgInNob3dJbmZvIiwgKHQpID0+IHsKICAgICAgdGhpcy5jYWRJbmZvLnBhcmVudE5vZGUucGFyZW50Tm9kZS5zdHlsZS5kaXNwbGF5ID0gdCA/ICJibG9jayIgOiAibm9uZSIsIHRoaXMuX2dldEVsZW1lbnQoInRjdl90b2dnbGVfaW5mbyIpLmlubmVySFRNTCA9IHQgPyAi4pa+IiA6ICLilrgiLCB0aGlzLmluZm9fc2hvd24gPSB0OwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cgaW5mbyBkaWFsb2cKICAgICAqIEBmdW5jdGlvbgogICAgICovCiAgICBrKHRoaXMsICJ0b2dnbGVJbmZvIiwgKCkgPT4gewogICAgICB0aGlzLnNob3dJbmZvKCF0aGlzLmluZm9fc2hvd24pOwogICAgfSk7CiAgICB0aGlzLmNvbnRhaW5lciA9IHQsIHRoaXMuY29udGFpbmVyLmlubmVySFRNTCA9IE9FKHRoaXMuY29udGFpbmVyLmlkKSwgdGhpcy5jYWRCb2R5ID0gdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF9ib2R5IiksIHRoaXMubWVhc3VyZVRvb2xzID0gZS5tZWFzdXJlVG9vbHMsIHRoaXMubWVhc3VyZW1lbnREZWJ1ZyA9IGUubWVhc3VyZW1lbnREZWJ1ZywgdGhpcy5zZWxlY3RUb29sID0gZS5zZWxlY3RUb29sLCB0aGlzLmV4cGxvZGVUb29sID0gZS5leHBsb2RlVG9vbCwgdGhpcy56c2NhbGVUb29sID0gZS56c2NhbGVUb29sLCB0aGlzLnpTY2FsZSA9IDEsIHRoaXMuY2FkVG9vbCA9IG5ldyBDRSgKICAgICAgdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF90b29sYmFyIiksCiAgICAgIHQuaWQsCiAgICAgIHRoaXMKICAgICksIHRoaXMuY2FkVmlldyA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfdmlldyIpLCB0aGlzLmRpc3RhbmNlTWVhc3VyZW1lbnRQYW5lbCA9IHRoaXMuX2dldEVsZW1lbnQoCiAgICAgICJ0Y3ZfZGlzdGFuY2VfbWVhc3VyZW1lbnRfcGFuZWwiCiAgICApLCB0aGlzLnByb3BlcnRpZXNNZWFzdXJlbWVudFBhbmVsID0gdGhpcy5fZ2V0RWxlbWVudCgKICAgICAgInRjdl9wcm9wZXJ0aWVzX21lYXN1cmVtZW50X3BhbmVsIgogICAgKSwgdGhpcy5jYWRUcmVlID0gdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF90cmVlX2NvbnRhaW5lciIpLCB0aGlzLmNhZFRyZWVTY3JvbGxDb250YWluZXIgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfYm94X2NvbnRlbnQiKSwgdGhpcy5jYWRUcmVlVG9nZ2xlcyA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfdHJlZV90b2dnbGVzIiksIHRoaXMuY2FkQ2xpcCA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfY2xpcF9jb250YWluZXIiKSwgdGhpcy5jYWRNYXRlcmlhbCA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfbWF0ZXJpYWxfY29udGFpbmVyIiksIHRoaXMudGFiVHJlZSA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl90YWJfdHJlZSIpLCB0aGlzLnRhYkNsaXAgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfdGFiX2NsaXAiKSwgdGhpcy50YWJNYXRlcmlhbCA9IHRoaXMuX2dldEVsZW1lbnQoInRjdl90YWJfbWF0ZXJpYWwiKSwgdGhpcy5jYWRJbmZvID0gdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF9pbmZvX2NvbnRhaW5lciIpLCB0aGlzLmNhZEFuaW0gPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX2FuaW1hdGlvbiIpLCB0aGlzLmNhZFRvb2xzID0gdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF90b29scyIpLCB0aGlzLmNhZEhlbHAgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX2hlbHAiKSwgTm4uYWRkKHRoaXMuY2FkSGVscCwgImNvbnRleHRtZW51IiwgKHIpID0+IChyLnByZXZlbnREZWZhdWx0KCksIHIuc3RvcFByb3BhZ2F0aW9uKCksICExKSksIHRoaXMucGxhbmVMYWJlbHMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgNDsgaSsrKQogICAgICB0aGlzLnBsYW5lTGFiZWxzLnB1c2godGhpcy5fZ2V0RWxlbWVudChgdGN2X2xibF9ub3JtX3BsYW5lJHtpfWApKTsKICAgIHRoaXMudmlld2VyID0gbnVsbCwgdGhpcy5nbGFzcyA9IGUuZ2xhc3MsIHRoaXMudG9vbHMgPSBlLnRvb2xzLCB0aGlzLmNhZFdpZHRoID0gZS5jYWRXaWR0aCwgdGhpcy5oZWlnaHQgPSBlLmhlaWdodCwgdGhpcy50cmVlV2lkdGggPSBlLnRyZWVXaWR0aCwgdGhpcy5fZXZlbnRzID0gW10sIHRoaXMuc2V0U2l6ZXMoZSksIHRoaXMuYWN0aXZlVGFiID0gInRyZWUiLCB0aGlzLmNhZFRyZWUuc3R5bGUuZGlzcGxheSA9ICJibG9jayIsIHRoaXMuY2FkQ2xpcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCB0aGlzLmNhZE1hdGVyaWFsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMuY2xpcFNsaWRlcnMgPSBudWxsLCB0aGlzLmV4cGxvZGVGbGFnID0gITEsIHRoaXMuY3VycmVudEJ1dHRvbiA9IG51bGwsIHRoaXMubGFzdFBsYW5lU3RhdGUgPSAhMTsKICAgIGNvbnN0IG4gPSBlLnRoZW1lOwogICAgaWYgKHRoaXMudGhlbWUgPSBuLCB0aGlzLnNldEJ1dHRvbkJhY2tncm91bmQobiksIHRoaXMudG9vbGJhckJ1dHRvbnMgPSB7fSwgdGhpcy50b29sYmFyQnV0dG9ucy5heGVzID0gbmV3IFFpKAogICAgICBuLAogICAgICAiYXhlcyIsCiAgICAgICJTaG93IGF4ZXMiLAogICAgICB0aGlzLnNldEF4ZXMKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5heGVzLCAtMSksIHRoaXMuY2FkVG9vbC5hZGRFbGxpcHNpcyhuZXcgVmwoMCwgdGhpcy5jYWRUb29sLm1heGltaXplKSksIHRoaXMudG9vbGJhckJ1dHRvbnMuYXhlczAgPSBuZXcgUWkoCiAgICAgIG4sCiAgICAgICJheGVzMCIsCiAgICAgICJTaG93IGF4ZXMgYXQgb3JpZ2luICgwLDAsMCkiLAogICAgICB0aGlzLnNldEF4ZXMwCiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMuYXhlczAsIDApLCB0aGlzLnRvb2xiYXJCdXR0b25zLmdyaWQgPSBuZXcgUWkoCiAgICAgIG4sCiAgICAgICJncmlkIiwKICAgICAgIlNob3cgZ3JpZCIsCiAgICAgIHRoaXMuc2V0R3JpZCwKICAgICAgbnVsbCwKICAgICAgWyJ4eSIsICJ4eiIsICJ5eiJdCiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMuZ3JpZCwgMCksIHRoaXMuY2FkVG9vbC5hZGRTZXBhcmF0b3IoKSwgdGhpcy50b29sYmFyQnV0dG9ucy5wZXJzcGVjdGl2ZSA9IG5ldyBRaSgKICAgICAgbiwKICAgICAgInBlcnNwZWN0aXZlIiwKICAgICAgIlVzZSBwZXJzcGVjdGl2ZSBjYW1lcmEiLAogICAgICB0aGlzLnNldE9ydGhvCiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMucGVyc3BlY3RpdmUsIC0xKSwgdGhpcy5jYWRUb29sLmFkZEVsbGlwc2lzKG5ldyBWbCgxLCB0aGlzLmNhZFRvb2wubWF4aW1pemUpKSwgdGhpcy50b29sYmFyQnV0dG9ucy50cmFuc3BhcmVudCA9IG5ldyBRaSgKICAgICAgbiwKICAgICAgInRyYW5zcGFyZW50IiwKICAgICAgIlNob3cgdHJhbnNwYXJlbnQgZmFjZXMiLAogICAgICB0aGlzLnNldFRyYW5zcGFyZW50CiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMudHJhbnNwYXJlbnQsIDEpLCB0aGlzLnRvb2xiYXJCdXR0b25zLmJsYWNrZWRnZXMgPSBuZXcgUWkoCiAgICAgIG4sCiAgICAgICJibGFja2VkZ2VzIiwKICAgICAgIlNob3cgYmxhY2sgZWRnZXMiLAogICAgICB0aGlzLnNldEJsYWNrRWRnZXMKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5ibGFja2VkZ2VzLCAxKSwgdGhpcy5jYWRUb29sLmFkZFNlcGFyYXRvcigpLCB0aGlzLnRvb2xiYXJCdXR0b25zLnJlc2V0ID0gbmV3IEtpKAogICAgICBuLAogICAgICAicmVzZXQiLAogICAgICAiUmVzZXQgdmlldyIsCiAgICAgIHRoaXMucmVzZXQKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5yZXNldCwgLTEpLCB0aGlzLmNhZFRvb2wuYWRkRWxsaXBzaXMobmV3IFZsKDIsIHRoaXMuY2FkVG9vbC5tYXhpbWl6ZSkpLCB0aGlzLnRvb2xiYXJCdXR0b25zLnJlc2l6ZSA9IG5ldyBLaSgKICAgICAgbiwKICAgICAgInJlc2l6ZSIsCiAgICAgICJSZXNpemUgb2JqZWN0IiwKICAgICAgdGhpcy5yZXNpemUKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5yZXNpemUsIDIpLCB0aGlzLnRvb2xiYXJCdXR0b25zLmlzbyA9IG5ldyBLaSgKICAgICAgbiwKICAgICAgImlzbyIsCiAgICAgICJTd2l0Y2ggdG8gaXNvIHZpZXciLAogICAgICB0aGlzLnNldFZpZXcKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5pc28sIDIpLCB0aGlzLnRvb2xiYXJCdXR0b25zLmZyb250ID0gbmV3IEtpKAogICAgICBuLAogICAgICAiZnJvbnQiLAogICAgICAiU3dpdGNoIHRvIGZyb250IHZpZXciLAogICAgICB0aGlzLnNldFZpZXcKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5mcm9udCwgMiksIHRoaXMudG9vbGJhckJ1dHRvbnMucmVhciA9IG5ldyBLaSgKICAgICAgbiwKICAgICAgInJlYXIiLAogICAgICAiU3dpdGNoIHRvIGJhY2sgdmlldyIsCiAgICAgIHRoaXMuc2V0VmlldwogICAgKSwgdGhpcy5jYWRUb29sLmFkZEJ1dHRvbih0aGlzLnRvb2xiYXJCdXR0b25zLnJlYXIsIDIpLCB0aGlzLnRvb2xiYXJCdXR0b25zLnRvcCA9IG5ldyBLaSgKICAgICAgbiwKICAgICAgInRvcCIsCiAgICAgICJTd2l0Y2ggdG8gdG9wIHZpZXciLAogICAgICB0aGlzLnNldFZpZXcKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy50b3AsIDIpLCB0aGlzLnRvb2xiYXJCdXR0b25zLmJvdHRvbSA9IG5ldyBLaSgKICAgICAgbiwKICAgICAgImJvdHRvbSIsCiAgICAgICJTd2l0Y2ggdG8gYm90dG9tIHZpZXciLAogICAgICB0aGlzLnNldFZpZXcKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5ib3R0b20sIDIpLCB0aGlzLnRvb2xiYXJCdXR0b25zLmxlZnQgPSBuZXcgS2koCiAgICAgIG4sCiAgICAgICJsZWZ0IiwKICAgICAgIlN3aXRjaCB0byBsZWZ0IHZpZXciLAogICAgICB0aGlzLnNldFZpZXcKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5sZWZ0LCAyKSwgdGhpcy50b29sYmFyQnV0dG9ucy5yaWdodCA9IG5ldyBLaSgKICAgICAgbiwKICAgICAgInJpZ2h0IiwKICAgICAgIlN3aXRjaCB0byByaWdodCB2aWV3IiwKICAgICAgdGhpcy5zZXRWaWV3CiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMucmlnaHQsIDIpLCB0aGlzLmNhZFRvb2wuYWRkU2VwYXJhdG9yKCksIHRoaXMudG9vbGJhckJ1dHRvbnMuZXhwbG9kZSA9IG5ldyBRaSgKICAgICAgbiwKICAgICAgImV4cGxvZGUiLAogICAgICAiRXhwbG9kZSB0b29sIiwKICAgICAgdGhpcy5zZXRFeHBsb2RlCiAgICApLCB0aGlzLmV4cGxvZGVUb29sICYmICF0aGlzLnpzY2FsZVRvb2wgJiYgdGhpcy5jYWRUb29sLmFkZEJ1dHRvbih0aGlzLnRvb2xiYXJCdXR0b25zLmV4cGxvZGUsIC0xKSwgdGhpcy50b29sYmFyQnV0dG9ucy56c2NhbGUgPSBuZXcgUWkoCiAgICAgIG4sCiAgICAgICJ6c2NhbGUiLAogICAgICAiU2NhbGUgYWxvbmcgdGhlIFotYXhpcyIsCiAgICAgIHRoaXMuc2V0WlNjYWxlCiAgICApLCB0aGlzLnpzY2FsZVRvb2wgJiYgIXRoaXMuZXhwbG9kZVRvb2wpIHsKICAgICAgdGhpcy5jYWRUb29sLmFkZEJ1dHRvbih0aGlzLnRvb2xiYXJCdXR0b25zLnpzY2FsZSwgLTEpLCB0aGlzLnNob3daU2NhbGUoITEpOwogICAgICBjb25zdCByID0gdGhpcy5fZ2V0RWxlbWVudCgidGN2X3pzY2FsZV9zbGlkZXIiKTsKICAgICAgTm4uYWRkKHIsICJjaGFuZ2UiLCAobykgPT4gewogICAgICAgIHRoaXMuelNjYWxlID0gcGFyc2VJbnQoby50YXJnZXQudmFsdWUpLCB0aGlzLnZpZXdlci5zZXRac2NhbGVWYWx1ZShvLnRhcmdldC52YWx1ZSk7CiAgICAgIH0pOwogICAgfQogICAgdGhpcy50b29sYmFyQnV0dG9ucy5kaXN0YW5jZSA9IG5ldyBRaSgKICAgICAgbiwKICAgICAgImRpc3RhbmNlIiwKICAgICAgIk1lYXN1cmUgZGlzdGFuY2UgYmV0d2VlbiBzaGFwZXMiLAogICAgICB0aGlzLnNldFRvb2wKICAgICksIHRoaXMuY2FkVG9vbC5hZGRCdXR0b24odGhpcy50b29sYmFyQnV0dG9ucy5kaXN0YW5jZSwgMyksICh0aGlzLm1lYXN1cmVUb29scyA/IDIgOiAwKSArICh0aGlzLmV4cGxvZGVUb29sID8gMSA6IDApICsgKHRoaXMuc2VsZWN0VG9vbCA/IDEgOiAwKSArICh0aGlzLnpzY2FsZVRvb2wgPyAxIDogMCkgPiAxICYmIHRoaXMuY2FkVG9vbC5hZGRFbGxpcHNpcyhuZXcgVmwoMywgdGhpcy5jYWRUb29sLm1heGltaXplKSksIHRoaXMudG9vbGJhckJ1dHRvbnMucHJvcGVydGllcyA9IG5ldyBRaSgKICAgICAgbiwKICAgICAgInByb3BlcnRpZXMiLAogICAgICAiU2hvdyBzaGFwZSBwcm9wZXJ0aWVzIiwKICAgICAgdGhpcy5zZXRUb29sCiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMucHJvcGVydGllcywgMyksIHRoaXMudG9vbGJhckJ1dHRvbnMuc2VsZWN0ID0gbmV3IFFpKAogICAgICBuLAogICAgICAic2VsZWN0IiwKICAgICAgIkNvcHkgc2hhcGUgSURzIHRvIGNsaXBib2FyZCIsCiAgICAgIHRoaXMuc2V0VG9vbAogICAgKSwgdGhpcy5jYWRUb29sLmFkZEJ1dHRvbih0aGlzLnRvb2xiYXJCdXR0b25zLnNlbGVjdCwgMyksIHRoaXMuY2FkVG9vbC5kZWZpbmVHcm91cChbCiAgICAgIHRoaXMudG9vbGJhckJ1dHRvbnMuZXhwbG9kZSwKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5kaXN0YW5jZSwKICAgICAgdGhpcy50b29sYmFyQnV0dG9ucy5wcm9wZXJ0aWVzLAogICAgICB0aGlzLnRvb2xiYXJCdXR0b25zLnNlbGVjdAogICAgXSksIE5uLmFkZChkb2N1bWVudCwgImtleWRvd24iLCAocikgPT4gewogICAgICByLmtleSA9PT0gIkVzY2FwZSIgJiYgdGhpcy5oZWxwX3Nob3duICYmIChyLnByZXZlbnREZWZhdWx0KCksIHRoaXMuc2hvd0hlbHAoITEpKTsKICAgIH0pLCB0aGlzLmNhZFRvb2wuYWRkU2VwYXJhdG9yKCksIHRoaXMudG9vbGJhckJ1dHRvbnMucGluID0gbmV3IEtpKAogICAgICBuLAogICAgICAicGluIiwKICAgICAgIlBpbiB2aWV3ZXIgYXMgcG5nIiwKICAgICAgdGhpcy5waW5Bc1BuZwogICAgKSwgdGhpcy50b29sYmFyQnV0dG9ucy5waW4uYWxpZ25SaWdodCgpLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMucGluLCAtMSksIHRoaXMuc2hhcGVGaWx0ZXJEcm9wRG93bk1lbnUgPSBuZXcgVUUodGhpcyksIHRoaXMuc2hvd1Bpbm5pbmcoZS5waW5uaW5nKSwgdGhpcy50b29sYmFyQnV0dG9ucy5oZWxwID0gbmV3IEtpKAogICAgICBuLAogICAgICAiaGVscCIsCiAgICAgICJIZWxwIiwKICAgICAgdGhpcy50b2dnbGVIZWxwCiAgICApLCB0aGlzLmNhZFRvb2wuYWRkQnV0dG9uKHRoaXMudG9vbGJhckJ1dHRvbnMuaGVscCwgLTEpOwogIH0KICBzZXRCdXR0b25CYWNrZ3JvdW5kKHQpIHsKICAgIGZvciAodmFyIGUgb2Yga0UpCiAgICAgIGZvciAodmFyIGkgPSB0aGlzLmNvbnRhaW5lci5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGB0Y3ZfJHtlfWApLCBuID0gMDsgbiA8IGkubGVuZ3RoOyBuKyspIHsKICAgICAgICB2YXIgcyA9IGlbbl07CiAgICAgICAgcy5jbGFzc0xpc3QuYWRkKGB0Y3ZfYnV0dG9uXyR7ZX1gKTsKICAgICAgfQogIH0KICB3aWR0aFRocmVzaG9sZCgpIHsKICAgIHZhciB0ID0gNzcwOwogICAgcmV0dXJuIHRoaXMudmlld2VyLnBpbm5pbmcgfHwgKHQgLT0gMzApLCB0aGlzLnZpZXdlci5zZWxlY3RUb29sIHx8ICh0IC09IDMwKSwgIXRoaXMudmlld2VyLmV4cGxvZGVUb29sICYmICF0aGlzLnpzY2FsZVRvb2wgJiYgKHQgLT0gMzApLCB0OwogIH0KICBfc2V0dXBDaGVja0V2ZW50KHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLl9nZXRFbGVtZW50KHQpOwogICAgTm4uYWRkKG4sICJjaGFuZ2UiLCBlKSwgaSAhPSBudWxsICYmIChuLmNoZWNrZWQgPSBpKSwgdGhpcy5fZXZlbnRzLnB1c2goWyJjaGFuZ2UiLCB0LCBlXSk7CiAgfQogIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwogIF9zZXR1cENsaWNrRXZlbnQodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuX2dldEVsZW1lbnQodCk7CiAgICBObi5hZGQobiwgImNsaWNrIiwgZSksIHRoaXMuX2V2ZW50cy5wdXNoKFsiY2xpY2siLCB0LCBlXSk7CiAgfQogIC8qKgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgRE9NIGVsZW1lbnQKICAgKiBAcmV0dXJucyB7RE9NRWxlbWVudH0KICAgKi8KICBfZ2V0RWxlbWVudCh0KSB7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXIuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSh0KVswXTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIE5uLmRpc3Bvc2UoKSwgdGhpcy52aWV3ZXIgPSB2b2lkIDAsIHRoaXMuY2FkVHJlZS5pbm5lckhUTUwgPSAiIiwgdGhpcy5jYWRUcmVlID0gdm9pZCAwLCB0aGlzLmNhZFZpZXcucmVtb3ZlQ2hpbGQodGhpcy5jYWRWaWV3LmNoaWxkcmVuWzJdKSwgdGhpcy5jb250YWluZXIuaW5uZXJIVE1MID0gIiIsIHRoaXMuY29udGFpbmVyID0gbnVsbCwgdGhpcy5jYWRUcmVlU2Nyb2xsQ29udGFpbmVyID0gbnVsbDsKICB9CiAgLyoqCiAgICogU2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBkaWZmZXJlbnQgVUkgZWxlbWVudHMgKHRyZWUsIGNhbnZhcyBhbmQgaW5mbyBib3gpCiAgICogQHBhcmFtIHtEaXNwbGF5T3B0aW9uc30gb3B0aW9ucwogICAqLwogIHNldFNpemVzKHQsIGUgPSAyIC8gMykgewogICAgaWYgKHQuY2FkV2lkdGggJiYgKHRoaXMuY2FkV2lkdGggPSB0LmNhZFdpZHRoLCB0aGlzLmNhZFZpZXcuc3R5bGUud2lkdGggPSBMaSh0LmNhZFdpZHRoKSksIHQuaGVpZ2h0ICYmICh0aGlzLmhlaWdodCA9IHQuaGVpZ2h0LCB0aGlzLmNhZFZpZXcuc3R5bGUuaGVpZ2h0ID0gTGkodC5oZWlnaHQpKSwgdC50cmVlV2lkdGggJiYgKHRoaXMudHJlZVdpZHRoID0gdC50cmVlV2lkdGgsIHRoaXMuY2FkVHJlZS5wYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQuc3R5bGUud2lkdGggPSBMaSgKICAgICAgdC50cmVlV2lkdGgKICAgICksIHRoaXMuY2FkSW5mby5wYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQuc3R5bGUud2lkdGggPSBMaSgKICAgICAgdC50cmVlV2lkdGgKICAgICkpLCAhdC5nbGFzcykgewogICAgICBjb25zdCBpID0gTWF0aC5yb3VuZCh0LmhlaWdodCAqIGUpOwogICAgICB0aGlzLmNhZFRyZWUucGFyZW50RWxlbWVudC5wYXJlbnRFbGVtZW50LnN0eWxlLmhlaWdodCA9IExpKGkpLCB0aGlzLmNhZEluZm8ucGFyZW50RWxlbWVudC5wYXJlbnRFbGVtZW50LnN0eWxlLmhlaWdodCA9IExpKAogICAgICAgIHQuaGVpZ2h0IC0gaSAtIDQKICAgICAgKTsKICAgIH0KICAgIHQudG9vbHMgJiYgIXQuZ2xhc3MgPyAodGhpcy5jYWRUb29sLmNvbnRhaW5lci5zdHlsZS53aWR0aCA9IExpKAogICAgICB0LnRyZWVXaWR0aCArIHQuY2FkV2lkdGggKyA0CiAgICApLCB0aGlzLmNhZEJvZHkuc3R5bGUud2lkdGggPSBMaSh0LnRyZWVXaWR0aCArIHQuY2FkV2lkdGggKyA0KSkgOiAodGhpcy5jYWRUb29sLmNvbnRhaW5lci5zdHlsZS53aWR0aCA9IExpKHQuY2FkV2lkdGggKyAyKSwgdGhpcy5jYWRCb2R5LnN0eWxlLndpZHRoID0gTGkodC5jYWRXaWR0aCArIDIpKSwgdGhpcy5jYWRCb2R5LnN0eWxlLmhlaWdodCA9IExpKHQuaGVpZ2h0ICsgNCk7CiAgfQogIC8qKgogICAqIFNldCB1cCB0aGUgVUkKICAgKiBAcGFyYW0ge1ZpZXdlcn0gdmlld2VyIC0gdGhlIHZpZXdlciBmb3IgdGhpcyBVSQogICAqLwogIHNldHVwVUkodCkgewogICAgdGhpcy52aWV3ZXIgPSB0LCB0aGlzLnRoZW1lID09PSAiYnJvd3NlciIgJiYgKHRoaXMubWVkaWFRdWVyeSA9IHdpbmRvdy5tYXRjaE1lZGlhKCIocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIiksIE5uLmFkZCh0aGlzLm1lZGlhUXVlcnksICJjaGFuZ2UiLCAobikgPT4gewogICAgICBuLm1hdGNoZXMgPyB0aGlzLnNldFRoZW1lKCJkYXJrIikgOiB0aGlzLnNldFRoZW1lKCJsaWdodCIpOwogICAgfSkpLCB0aGlzLl9zZXR1cENsaWNrRXZlbnQoInRjdl9leHBhbmRfcm9vdCIsIHRoaXMuaGFuZGxlQ29sbGFwc2VOb2RlcyksIHRoaXMuX3NldHVwQ2xpY2tFdmVudCgidGN2X2NvbGxhcHNlX3NpbmdsZXMiLCB0aGlzLmhhbmRsZUNvbGxhcHNlTm9kZXMpLCB0aGlzLl9zZXR1cENsaWNrRXZlbnQoInRjdl9jb2xsYXBzZV9hbGwiLCB0aGlzLmhhbmRsZUNvbGxhcHNlTm9kZXMpLCB0aGlzLl9zZXR1cENsaWNrRXZlbnQoInRjdl9leHBhbmQiLCB0aGlzLmhhbmRsZUNvbGxhcHNlTm9kZXMpLCB0aGlzLl9zZXR1cENsaWNrRXZlbnQoInRjdl9tYXRlcmlhbF9yZXNldCIsIHRoaXMuaGFuZGxlTWF0ZXJpYWxSZXNldCksIHRoaXMuX3NldHVwQ2xpY2tFdmVudCgidGN2X3RvZ2dsZV9pbmZvIiwgdGhpcy50b2dnbGVJbmZvKSwgdGhpcy5oZWxwX3Nob3duID0gITAsIHRoaXMuaW5mb19zaG93biA9ICF0aGlzLmdsYXNzLCBbInRjdl90YWJfdHJlZSIsICJ0Y3ZfdGFiX2NsaXAiLCAidGN2X3RhYl9tYXRlcmlhbCJdLmZvckVhY2goKG4pID0+IHsKICAgICAgdGhpcy5fc2V0dXBDbGlja0V2ZW50KG4sIHRoaXMuc2VsZWN0VGFiKTsKICAgIH0pLCB0aGlzLmNsaXBTbGlkZXJzID0gW107CiAgICBmb3IgKHZhciBpID0gMTsgaSA8IDQ7IGkrKykKICAgICAgdGhpcy5jbGlwU2xpZGVycy5wdXNoKG5ldyBZYShgcGxhbmUke2l9YCwgMCwgMTAwLCB0aGlzKSk7CiAgICBmb3IgKHRoaXMuYW1iaWVudGxpZ2h0U2xpZGVyID0gbmV3IFlhKCJhbWJpZW50bGlnaHQiLCAwLCA0MDAsIHRoaXMpLCB0aGlzLmRpcmVjdGlvbmFsbGlnaHRTbGlkZXIgPSBuZXcgWWEoInBvaW50bGlnaHQiLCAwLCA0MDAsIHRoaXMpLCB0aGlzLm1ldGFsbmVzc1NsaWRlciA9IG5ldyBZYSgibWV0YWxuZXNzIiwgMCwgMTAwLCB0aGlzKSwgdGhpcy5yb3VnaG5lc3NTbGlkZXIgPSBuZXcgWWEoInJvdWdobmVzcyIsIDAsIDEwMCwgdGhpcyksIHRoaXMuX3NldHVwQ2hlY2tFdmVudCgKICAgICAgInRjdl9jbGlwX3BsYW5lX2hlbHBlcnMiLAogICAgICB0aGlzLnNldENsaXBQbGFuZUhlbHBlcnMsCiAgICAgICExCiAgICApLCB0aGlzLl9zZXR1cENoZWNrRXZlbnQoCiAgICAgICJ0Y3ZfY2xpcF9pbnRlcnNlY3Rpb24iLAogICAgICB0aGlzLnNldENsaXBJbnRlcnNlY3Rpb24sCiAgICAgICExCiAgICApLCB0aGlzLl9zZXR1cENoZWNrRXZlbnQoInRjdl9jbGlwX2NhcHMiLCB0aGlzLnNldE9iamVjdENvbG9yQ2FwcywgITEpLCBpID0gMTsgaSA8IDQ7IGkrKykKICAgICAgdGhpcy5fc2V0dXBDbGlja0V2ZW50KAogICAgICAgIGB0Y3ZfYnRuX25vcm1fcGxhbmUke2l9YCwKICAgICAgICB0aGlzLnNldENsaXBOb3JtYWxGcm9tUG9zaXRpb24sCiAgICAgICAgITEKICAgICAgKTsKICAgIHRoaXMuX3NldHVwQ2xpY2tFdmVudCgidGN2X3BsYXkiLCB0aGlzLmNvbnRyb2xBbmltYXRpb24sICExKSwgdGhpcy5fc2V0dXBDbGlja0V2ZW50KCJ0Y3ZfcGF1c2UiLCB0aGlzLmNvbnRyb2xBbmltYXRpb24sICExKSwgdGhpcy5fc2V0dXBDbGlja0V2ZW50KCJ0Y3Zfc3RvcCIsIHRoaXMuY29udHJvbEFuaW1hdGlvbiwgITEpLCB0aGlzLmFuaW1hdGlvblNsaWRlciA9IHRoaXMuY29udGFpbmVyLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoCiAgICAgICJ0Y3ZfYW5pbWF0aW9uX3NsaWRlciIKICAgIClbMF0sIHRoaXMuYW5pbWF0aW9uU2xpZGVyLnZhbHVlID0gMCwgTm4uYWRkKHRoaXMuYW5pbWF0aW9uU2xpZGVyLCAiaW5wdXQiLCB0aGlzLmFuaW1hdGlvbkNoYW5nZSksIHRoaXMuc2hvd0FuaW1hdGlvbkNvbnRyb2woITEpLCB0aGlzLnNob3dIZWxwKCExKSwgdGhpcy5zaG93RGlzdGFuY2VQYW5lbCghMSksIHRoaXMuc2hvd1Byb3BlcnRpZXNQYW5lbCghMSksIHRoaXMuc2hvd01lYXN1cmVUb29scyh0aGlzLm1lYXN1cmVUb29scyksIHRoaXMuc2hvd1NlbGVjdFRvb2wodGhpcy5zZWxlY3RUb29sKSwgdGhpcy5zaG93RXhwbG9kZVRvb2wodGhpcy5leHBsb2RlVG9vbCksIHRoaXMuc2hvd1pTY2FsZVRvb2wodGhpcy56c2NhbGVUb29sKTsKICB9CiAgLyoqCiAgICogQ2hlY2sgb3IgdW5jaGVjayBhIGNoZWNrYm94CiAgICogQHByb3BlcnR5IHtib29sZWFufSBbYXhlcyA9IGZhbHNlXSAtIHNob3cgWC0sIFktLCBaLWF4ZXMuCiAgICogQHByb3BlcnR5IHtib29sZWFufSBbYXhlczAgPSBmYWxzZV0gLSBzaG93IGF4ZXMgYXQgWzAsMCwwXSBvdCBhdCBvYmplY3QgY2VudGVyICh0YXJnZXQpLgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW29ydGhvID0gdHJ1ZV0gLSB1c2UgYW4gb3J0aG9ncmFwaGljICh0cnVlKSBvciBwZXJzcGVjdGl2ZSBjYW1lcmEgKGZhbHNlKQogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3RyYW5zcGFyZW50ID0gZmFsc2VdIC0gc2hvdyBDQUQgb2JqZWN0IHRyYW5zcGFyZW50LgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2JsYWNrRWRnZXMgPSBmYWxzZV0gLSBzaG93IGVkZ2VzIGluIGJsYWNrIGFuZCBub3QgaW4gZWRnZUNvbG9yLgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW3Rvb2xzID0gdHJ1ZV0gLSBzaG93IENBRCB0b29scy4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IFtnbGFzcyA9IGZhbHNlXSAtIHVzZSBnbGFzcyBtb2RlLCBpLmUuIENBRCBuYXZpZ2F0aW9uIGFzIG92ZXJsYXkuCiAgICovCiAgdXBkYXRlVUkodCwgZSwgaSwgbiwgcywgciwgbykgewogICAgdGhpcy50b29sYmFyQnV0dG9ucy5heGVzLnNldCh0KSwgdGhpcy50b29sYmFyQnV0dG9ucy5heGVzMC5zZXQoZSksIHRoaXMudG9vbGJhckJ1dHRvbnMucGVyc3BlY3RpdmUuc2V0KCFpKSwgdGhpcy50b29sYmFyQnV0dG9ucy50cmFuc3BhcmVudC5zZXQobiksIHRoaXMudG9vbGJhckJ1dHRvbnMuYmxhY2tlZGdlcy5zZXQocyksIHRoaXMuc2hvd1Rvb2xzKHIpLCB0aGlzLmdsYXNzTW9kZShvKSwgKHRoaXMuZ2xhc3MgPyB0aGlzLmNhZFdpZHRoIDogdGhpcy5jYWRXaWR0aCArIHRoaXMudHJlZVdpZHRoKSA8IHRoaXMud2lkdGhUaHJlc2hvbGQoKSAmJiB0aGlzLmNhZFRvb2wubWluaW1pemUoKTsKICB9CiAgLy8gc2V0dXAgZnVuY3Rpb25zCiAgLyoqCiAgICogQ2hlY2sgb3IgdW5jaGVjayBhIGNoZWNrYm94CiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBuYW1lIG9mIHRoZSBjaGVjayBib3gsIHNlZSBnZXRFbGVtZW50CiAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBjaGVjayBvciB1bmNoZWNrCiAgICovCiAgY2hlY2tFbGVtZW50KHQsIGUpIHsKICAgIHRoaXMuX2dldEVsZW1lbnQodCkuY2hlY2tlZCA9IGU7CiAgfQogIC8qKgogICAqIEFkZCB0aGUgQ2FkIFZpZXcgKHRoZSBjYW52YXMgZm9yIHRocmVlanMpCiAgICogQHBhcmFtIHtET01FbGVtZW50fSBjYWRWaWV3IC0gdGhlIERPTSBlbGVtZW50IHRoYXQgY29udGFpbnMgdGhlIGNhZFZpZXcKICAgKi8KICBhZGRDYWRWaWV3KHQpIHsKICAgIHZhciBlID0gdGhpcy5jYWRWaWV3LnF1ZXJ5U2VsZWN0b3IoImNhbnZhcyIpOwogICAgZSA/IHRoaXMuY2FkVmlldy5yZXBsYWNlQ2hpbGQodCwgZSkgOiAodGhpcy5jYWRWaWV3LmFwcGVuZENoaWxkKHQpLCBlID0gdGhpcy5jYWRWaWV3LnF1ZXJ5U2VsZWN0b3IoImNhbnZhcyIpKSwgTm4uYWRkKGUsICJjbGljayIsIChpKSA9PiB7CiAgICAgIHRoaXMuaGVscF9zaG93biAmJiB0aGlzLnNob3dIZWxwKCExKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBHZXQgdGhlIERPTSBjYW52YXMgZWxlbWVudAogICAqLwogIGdldENhbnZhcygpIHsKICAgIHJldHVybiB0aGlzLmNhZFZpZXcuY2hpbGRyZW5bdGhpcy5jYWRWaWV3LmNoaWxkcmVuLmxlbmd0aCAtIDFdOwogIH0KICAvKioKICAgKiBDbGVhciB0aGUgQ2FkIHRyZWUKICAgKi8KICBjbGVhckNhZFRyZWUoKSB7CiAgICB0aGlzLmNhZFRyZWUuaW5uZXJIVE1MID0gIiI7CiAgfQogIC8qKgogICAqIEFkZCB0aGUgQ2FkIHRyZWUgYW5kIG90aGVyIFVJIGVsZW1lbnRzIGxpa2UgQ2xpcHBpbmcKICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGNhZFRyZWUgLSB0aGUgRE9NIGVsZW1lbnQgdGhhdCBjb250YWlucyB0aGUgY2FkVHJlZQogICAqLwogIGFkZENhZFRyZWUodCkgewogICAgdGhpcy5jYWRUcmVlLmFwcGVuZENoaWxkKHQpOwogIH0KICAvKioKICAgKiBDbGVhciBhbGwgaGlnaGxpZ2h0cyBvZiBuYXZpZ2F0aW9uIHRyZWUgZW50cmllcwogICAqLwogIGNsZWFySGlnaGxpZ2h0cygpIHsKICAgIFsiZnJvbnQiLCAicmVhciIsICJ0b3AiLCAiYm90dG9tIiwgImxlZnQiLCAicmlnaHQiLCAiaXNvIl0uZm9yRWFjaCgoZSkgPT4gewogICAgICB2YXIgaSA9IHRoaXMudG9vbGJhckJ1dHRvbnNbZV07CiAgICAgIGkuaGlnaGxpZ2h0KCExKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBIaWdobGlnaHQgdGhlIHNlbGVjdGVkIGJ1dHRvbgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gQSBDQUQgb2JqZWN0IGlkIChwYXRoKQogICAqLwogIGhpZ2hsaWdodEJ1dHRvbih0KSB7CiAgICB0aGlzLmNsZWFySGlnaGxpZ2h0cygpOwogICAgdmFyIGUgPSB0aGlzLnRvb2xiYXJCdXR0b25zW3RdOwogICAgZS5oaWdobGlnaHQoITApLCB0aGlzLnZpZXdlci5rZWVwSGlnaGxpZ2h0ID0gITA7CiAgfQogIC8qKgogICAqIFNob3cvaGlkZSBwaW5uaW5nIGJ1dHRvbgogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIFdoZXRoZXIgdG8gc2hvdy9oaWRlIHRoZSBwaW5uaW5nIGJ1dHRvbgogICAqLwogIHNob3dQaW5uaW5nKHQpIHsKICAgIHRoaXMudG9vbGJhckJ1dHRvbnMucGluLnNob3codCk7CiAgfQogIC8qKgogICAqIEFjdGl2YXRlIHRoZSBVSSB0YWIgZ2l2ZW4gdGhlIG5hbWUgb2YgdGhlIHRhYgogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWIgLSBuYW1lIG9mIHRoZSB0YWIgInRyZWUiIG9yICJjbGlwIgogICAqLwogIHNlbGVjdFRhYkJ5TmFtZSh0KSB7CiAgICBpZiAoWyJjbGlwIiwgInRyZWUiLCAibWF0ZXJpYWwiXS5pbmNsdWRlcyh0KSkgewogICAgICBpZiAodCA9PT0gInRyZWUiICYmIHRoaXMuYWN0aXZlVGFiICE9PSAidHJlZSIpIHsKICAgICAgICB0aGlzLmNhZFRyZWUuc3R5bGUuZGlzcGxheSA9ICJibG9jayIsIHRoaXMuY2FkVHJlZVRvZ2dsZXMuc3R5bGUuZGlzcGxheSA9ICJibG9jayIsIHRoaXMuY2FkQ2xpcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCB0aGlzLmNhZE1hdGVyaWFsLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMudmlld2VyLm5lc3RlZEdyb3VwLnNldEJhY2tWaXNpYmxlKCExKSwgdGhpcy52aWV3ZXIuc2V0TG9jYWxDbGlwcGluZyghMSksIHRoaXMudmlld2VyLmNsaXBwaW5nLnNldFZpc2libGUoITEpOwogICAgICAgIHZhciBlID0gdGhpcy52aWV3ZXIuZ2V0Q2xpcFBsYW5lSGVscGVycygpOwogICAgICAgIHRoaXMudmlld2VyLnNldENsaXBQbGFuZUhlbHBlcnMoITEpLCB0aGlzLmxhc3RQbGFuZVN0YXRlID0gZTsKICAgICAgfSBlbHNlIHQgPT09ICJjbGlwIiAmJiB0aGlzLmFjdGl2ZVRhYiAhPT0gImNsaXAiID8gKHRoaXMuY2FkVHJlZS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCB0aGlzLmNhZFRyZWVUb2dnbGVzLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMuY2FkQ2xpcC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIiwgdGhpcy5jYWRNYXRlcmlhbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCB0aGlzLnZpZXdlci5uZXN0ZWRHcm91cC5zZXRCYWNrVmlzaWJsZSghMCksIHRoaXMudmlld2VyLnNldExvY2FsQ2xpcHBpbmcoITApLCB0aGlzLnZpZXdlci5zZXRDbGlwSW50ZXJzZWN0aW9uKHRoaXMudmlld2VyLmNsaXBJbnRlcnNlY3Rpb24pLCB0aGlzLnZpZXdlci5zZXRDbGlwUGxhbmVIZWxwZXJzKHRoaXMubGFzdFBsYW5lU3RhdGUpLCB0aGlzLnZpZXdlci5jbGlwcGluZy5zZXRWaXNpYmxlKCEwKSwgdGhpcy52aWV3ZXIudXBkYXRlKCEwLCAhMSkpIDogdCA9PT0gIm1hdGVyaWFsIiAmJiB0aGlzLmFjdGl2ZVRhYiAhPT0gIm1hdGVyaWFsIiAmJiAodGhpcy5jYWRUcmVlLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMuY2FkVHJlZVRvZ2dsZXMuc3R5bGUuZGlzcGxheSA9ICJub25lIiwgdGhpcy5jYWRDbGlwLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMuY2FkTWF0ZXJpYWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayIsIHRoaXMudmlld2VyLm5lc3RlZEdyb3VwLnNldEJhY2tWaXNpYmxlKCExKSwgdGhpcy52aWV3ZXIuc2V0TG9jYWxDbGlwcGluZyghMSksIHRoaXMudmlld2VyLnNldENsaXBQbGFuZUhlbHBlcnMoITEpLCB0aGlzLnZpZXdlci5jbGlwcGluZy5zZXRWaXNpYmxlKCExKSk7CiAgICAgIHRoaXMuYWN0aXZlVGFiID0gdCwgdGhpcy52aWV3ZXIuY2hlY2tDaGFuZ2VzKHsgdGFiOiB0IH0pLCB0ID09ICJ0cmVlIiA/ICh0aGlzLnRhYlRyZWUuY2xhc3NMaXN0LmFkZCgidGN2X3RhYi1zZWxlY3RlZCIpLCB0aGlzLnRhYlRyZWUuY2xhc3NMaXN0LnJlbW92ZSgidGN2X3RhYi11bnNlbGVjdGVkIiksIHRoaXMudGFiQ2xpcC5jbGFzc0xpc3QucmVtb3ZlKCJ0Y3ZfdGFiLXNlbGVjdGVkIiksIHRoaXMudGFiQ2xpcC5jbGFzc0xpc3QuYWRkKCJ0Y3ZfdGFiLXVuc2VsZWN0ZWQiKSwgdGhpcy50YWJNYXRlcmlhbC5jbGFzc0xpc3QucmVtb3ZlKCJ0Y3ZfdGFiLXNlbGVjdGVkIiksIHRoaXMudGFiTWF0ZXJpYWwuY2xhc3NMaXN0LmFkZCgidGN2X3RhYi11bnNlbGVjdGVkIikpIDogdCA9PSAiY2xpcCIgPyAodGhpcy50YWJUcmVlLmNsYXNzTGlzdC5yZW1vdmUoInRjdl90YWItc2VsZWN0ZWQiKSwgdGhpcy50YWJUcmVlLmNsYXNzTGlzdC5hZGQoInRjdl90YWItdW5zZWxlY3RlZCIpLCB0aGlzLnRhYkNsaXAuY2xhc3NMaXN0LmFkZCgidGN2X3RhYi1zZWxlY3RlZCIpLCB0aGlzLnRhYkNsaXAuY2xhc3NMaXN0LnJlbW92ZSgidGN2X3RhYi11bnNlbGVjdGVkIiksIHRoaXMudGFiTWF0ZXJpYWwuY2xhc3NMaXN0LnJlbW92ZSgidGN2X3RhYi1zZWxlY3RlZCIpLCB0aGlzLnRhYk1hdGVyaWFsLmNsYXNzTGlzdC5hZGQoInRjdl90YWItdW5zZWxlY3RlZCIpKSA6ICh0aGlzLnRhYlRyZWUuY2xhc3NMaXN0LmFkZCgidGN2X3RhYi11bnNlbGVjdGVkIiksIHRoaXMudGFiVHJlZS5jbGFzc0xpc3QucmVtb3ZlKCJ0Y3ZfdGFiLXNlbGVjdGVkIiksIHRoaXMudGFiQ2xpcC5jbGFzc0xpc3QuYWRkKCJ0Y3ZfdGFiLXVuc2VsZWN0ZWQiKSwgdGhpcy50YWJDbGlwLmNsYXNzTGlzdC5yZW1vdmUoInRjdl90YWItc2VsZWN0ZWQiKSwgdGhpcy50YWJNYXRlcmlhbC5jbGFzc0xpc3QuYWRkKCJ0Y3ZfdGFiLXNlbGVjdGVkIiksIHRoaXMudGFiTWF0ZXJpYWwuY2xhc3NMaXN0LnJlbW92ZSgidGN2X3RhYi11bnNlbGVjdGVkIikpOwogICAgfQogIH0KICAvKioKICAgKiBDb2xsYXBzZSBub2RlcyBoYW5kbGVyCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gMTogY29sbGFwc2UgYWxsIGxlYWYgbm9kZXMsICJSIjogZXhwYW5kIHJvb3QgbGV2ZWwgb25seSwgIkMiOiBjb2xsYXBzZSBhbGwgbm9kZXMsICJFIjogZXhwYW5kIGFsbCBub2RlcwogICAqLwogIGNvbGxhcHNlTm9kZXModCkgewogICAgdCA9PT0gIjEiID8gdGhpcy52aWV3ZXIudHJlZXZpZXcub3BlbkxldmVsKC0xKSA6IHQgPT09ICJSIiA/IHRoaXMudmlld2VyLnRyZWV2aWV3Lm9wZW5MZXZlbCgxKSA6IHQgPT09ICJDIiA/IHRoaXMudmlld2VyLnRyZWV2aWV3LmNvbGxhcHNlQWxsKCkgOiB0ID09PSAiRSIgJiYgdGhpcy52aWV3ZXIudHJlZXZpZXcuZXhwYW5kQWxsKCk7CiAgfQogIC8qKgogICAqIFNldCBtaW5pbXVtIGFuZCBtYXhpbXVtIG9mIHRoZSBzbGlkZXJzCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gaW5kZXggb2YgdGhlIHBsYW5lOiAwLDEsMgogICAqIEBwYXJhbSB7bnVtYmVyfSBsaW1pdCAtIHRoZSB2YWx1ZSBmb3IgYm90aCBtaW5pbXVtIGFuZCBtYXhpbXVtIHZhbHVlIG9mIHRoZSBzbGlkZXIKICAgKi8KICBzZXRTbGlkZXJMaW1pdHModCkgewogICAgZm9yICh2YXIgZSA9IDA7IGUgPCAzOyBlKyspCiAgICAgIHRoaXMuY2xpcFNsaWRlcnNbZV0uc2V0U2xpZGVyKHQpOwogIH0KICAvKioKICAgKiBSZWZyZXNoIGNsaXBwaW5nIHBsYW5lCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gaW5kZXggb2YgdGhlIHBsYW5lOiAwLDEsMgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIGRpc3RhbmNlIG9uIHRoZSBjbGlwcGluZyBub3JtYWwgZnJvbSB0aGUgY2VudGVyCiAgICovCiAgcmVmcmVzaFBsYW5lKHQsIGUpIHsKICAgIHRoaXMudmlld2VyLnJlZnJlc2hQbGFuZSh0IC0gMSwgcGFyc2VGbG9hdChlKSk7CiAgfQogIC8qKgogICAqIEhhbmRsZSBhbmltYXRpb24gY29udHJvbAogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7c3RyaW5nfSBidG4gLSBhbmltYXRpb24gY29udHJvbCBidXR0b24gbmFtZQogICAqLwogIGNvbnRyb2xBbmltYXRpb25CeU5hbWUodCkgewogICAgdGhpcy52aWV3ZXIuY29udHJvbEFuaW1hdGlvbih0KTsKICAgIHZhciBlID0gdGhpcy52aWV3ZXIuYW5pbWF0aW9uLmdldFJlbGF0aXZlVGltZSgpOwogICAgdGhpcy5hbmltYXRpb25TbGlkZXIudmFsdWUgPSAxZTMgKiBlLCB0ID09ICJwbGF5IiA/IHRoaXMudmlld2VyLmJib3hOZWVkc1VwZGF0ZSA9ICEwIDogdCA9PSAic3RvcCIgPyAodGhpcy52aWV3ZXIuYmJveE5lZWRzVXBkYXRlID0gITEsIHRoaXMudmlld2VyLmxhc3RCYm94ICE9IG51bGwgJiYgKHRoaXMudmlld2VyLmxhc3RCYm94Lm5lZWRzVXBkYXRlID0gITApKSA6IHRoaXMudmlld2VyLmJib3hOZWVkc1VwZGF0ZSA9ICF0aGlzLnZpZXdlci5iYm94TmVlZHNVcGRhdGU7CiAgfQogIC8qKgogICAqIFNldCBsYWJlbCB0ZXh0IG9mIGFuaW1hdGlvbiBjb250cm9sCiAgICogQHBhcmFtIHtzdHJpbmd9IGxhYmVsIC0gIkEiIGZvciBhbmltYXRpb24gYW5kICJFIiBmb3IgRXhwbG9kZSBjb250cm9sCiAgICovCiAgc2V0QW5pbWF0aW9uTGFiZWwodCkgewogICAgdmFyIGUgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfYW5pbWF0aW9uX2xhYmVsIik7CiAgICBlLmlubmVySFRNTCA9IHQ7CiAgfQogIC8qKgogICAqIFJlc2V0IGFuaW1hdGlvbiBzbGlkZXIgdG8gMAogICAqLwogIHJlc2V0QW5pbWF0aW9uU2xpZGVyKCkgewogICAgdGhpcy5hbmltYXRpb25TbGlkZXIudmFsdWUgPSAwOwogIH0KICAvKioKICAgKiBBdXRvIGNvbGxhcHNlIHRyZWUgbm9kZXMsIHdoZW4gY2FkIHdpZHRoIDwgNjAwCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBlbmFibGUvZGlzYWJsZSBnbGFzcyBtb2RlCiAgICovCiAgYXV0b0NvbGxhcHNlKCkgewogICAgdGhpcy5jYWRXaWR0aCA8IDYwMCAmJiB0aGlzLmdsYXNzICYmIChjb25zb2xlLmluZm8oIlNtYWxsIHZpZXcsIGNvbGxhcHNpbmcgdHJlZSIpLCB0aGlzLmNvbGxhcHNlTm9kZXMoIkMiKSk7CiAgfQogIC8qKgogICAqIEVuYWJsZS9kaXNhYmxlIGdsYXNzIG1vZGUKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIGVuYWJsZS9kaXNhYmxlIGdsYXNzIG1vZGUKICAgKi8KICBnbGFzc01vZGUodCkgewogICAgdCA/ICh0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX3RyZWUiKS5jbGFzc0xpc3QuYWRkKCJ0Y3ZfY2FkX3RyZWVfZ2xhc3MiKSwgdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF90cmVlIikuc3R5bGUuaGVpZ2h0ID0gbnVsbCwgdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF90cmVlIikuc3R5bGVbIm1heC1oZWlnaHQiXSA9IExpKAogICAgICBNYXRoLnJvdW5kKHRoaXMuaGVpZ2h0ICogMiAvIDMpIC0gMTgKICAgICksIHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfaW5mbyIpLmNsYXNzTGlzdC5hZGQoInRjdl9jYWRfaW5mb19nbGFzcyIpLCB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX3ZpZXciKS5jbGFzc0xpc3QuYWRkKCJ0Y3ZfY2FkX3ZpZXdfZ2xhc3MiKSwgdGhpcy5fZ2V0RWxlbWVudCgidGN2X3RvZ2dsZV9pbmZvX3dyYXBwZXIiKS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIiwgdGhpcy5zaG93SW5mbyghMSksIHRoaXMuZ2xhc3MgPSAhMCwgdGhpcy5hdXRvQ29sbGFwc2UoKSkgOiAodGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF90cmVlIikuY2xhc3NMaXN0LnJlbW92ZSgidGN2X2NhZF90cmVlX2dsYXNzIiksIHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfdHJlZSIpLnN0eWxlWyJtYXgtaGVpZ2h0Il0gPSBudWxsLCB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX3RyZWUiKS5zdHlsZS5oZWlnaHQgPSBMaSgKICAgICAgTWF0aC5yb3VuZCh0aGlzLmhlaWdodCAqIDIgLyAzKQogICAgKSwgdGhpcy5fZ2V0RWxlbWVudCgidGN2X2NhZF9pbmZvIikuY2xhc3NMaXN0LnJlbW92ZSgidGN2X2NhZF9pbmZvX2dsYXNzIiksIHRoaXMuX2dldEVsZW1lbnQoInRjdl9jYWRfdmlldyIpLmNsYXNzTGlzdC5yZW1vdmUoInRjdl9jYWRfdmlld19nbGFzcyIpLCB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfdG9nZ2xlX2luZm9fd3JhcHBlciIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSIsIHRoaXMuc2hvd0luZm8oITApLCB0aGlzLmdsYXNzID0gITEpLCB0aGlzLnZpZXdlciAmJiAodGhpcy52aWV3ZXIuZ2xhc3MgPSAhMSk7CiAgICBjb25zdCBlID0gewogICAgICBjYWRXaWR0aDogdGhpcy5jYWRXaWR0aCwKICAgICAgZ2xhc3M6IHRoaXMuZ2xhc3MsCiAgICAgIGhlaWdodDogdGhpcy5oZWlnaHQsCiAgICAgIHRvb2xzOiB0aGlzLnRvb2xzLAogICAgICB0cmVlV2lkdGg6IHQgPyAwIDogdGhpcy50cmVlV2lkdGgKICAgIH07CiAgICB0aGlzLnNldFNpemVzKGUpOwogIH0KICB1cGRhdGVIZWxwKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9nZXRFbGVtZW50KCJ0Y3ZfY2FkX2hlbHBfbGF5b3V0Iik7CiAgICBmb3IgKHZhciBuIGluIHQpCiAgICAgIHRbbl0gJiYgZVtuXSAmJiAoaS5pbm5lckhUTUwgPSBpLmlubmVySFRNTC5yZXBsYWNlQWxsKAogICAgICAgICImbHQ7IiArIHRbbl0uc2xpY2UoMCwgLTMpICsgIiZndDsiLAogICAgICAgICImbHQ7XyIgKyBlW25dLnNsaWNlKDAsIC0zKSArICImZ3Q7IgogICAgICApKTsKICAgIGkuaW5uZXJIVE1MID0gaS5pbm5lckhUTUwucmVwbGFjZUFsbCgiX3NoaWZ0IiwgInNoaWZ0IiksIGkuaW5uZXJIVE1MID0gaS5pbm5lckhUTUwucmVwbGFjZUFsbCgiX2N0cmwiLCAiY3RybCIpLCBpLmlubmVySFRNTCA9IGkuaW5uZXJIVE1MLnJlcGxhY2VBbGwoIl9hbHQiLCAiYWx0IiksIGkuaW5uZXJIVE1MID0gaS5pbm5lckhUTUwucmVwbGFjZUFsbCgiX21ldGEiLCAibWV0YSIpOwogIH0KICBzZXRUaGVtZSh0KSB7CiAgICByZXR1cm4gdCA9PT0gImRhcmsiIHx8IHQgPT0gImJyb3dzZXIiICYmIHdpbmRvdy5tYXRjaE1lZGlhKCIocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIikubWF0Y2hlcyA/ICh0aGlzLmNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoImRhdGEtdGhlbWUiLCAiZGFyayIpLCBkb2N1bWVudC5ib2R5LnNldEF0dHJpYnV0ZSgiZGF0YS10aGVtZSIsICJkYXJrIiksIHRoaXMudmlld2VyLm9yaWVudGF0aW9uTWFya2VyICYmIHRoaXMudmlld2VyLm9yaWVudGF0aW9uTWFya2VyLmNoYW5nZVRoZW1lKCJkYXJrIiksIHRoaXMudmlld2VyLmdyaWRIZWxwZXIgJiYgKHRoaXMudmlld2VyLmdyaWRIZWxwZXIuY2xlYXJDYWNoZSgpLCB0aGlzLnZpZXdlci5ncmlkSGVscGVyLnVwZGF0ZSgKICAgICAgdGhpcy52aWV3ZXIuZ2V0Q2FtZXJhWm9vbSgpLAogICAgICAhMCwKICAgICAgImRhcmsiCiAgICApKSwgdGhpcy52aWV3ZXIudXBkYXRlKCEwKSwgImRhcmsiKSA6ICh0aGlzLmNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoImRhdGEtdGhlbWUiLCAibGlnaHQiKSwgZG9jdW1lbnQuYm9keS5zZXRBdHRyaWJ1dGUoImRhdGEtdGhlbWUiLCAibGlnaHQiKSwgdGhpcy52aWV3ZXIub3JpZW50YXRpb25NYXJrZXIgJiYgdGhpcy52aWV3ZXIub3JpZW50YXRpb25NYXJrZXIuY2hhbmdlVGhlbWUoImxpZ2h0IiksIHRoaXMudmlld2VyLmdyaWRIZWxwZXIgJiYgKHRoaXMudmlld2VyLmdyaWRIZWxwZXIuY2xlYXJDYWNoZSgpLCB0aGlzLnZpZXdlci5ncmlkSGVscGVyLnVwZGF0ZSgKICAgICAgdGhpcy52aWV3ZXIuZ2V0Q2FtZXJhWm9vbSgpLAogICAgICAhMCwKICAgICAgImxpZ2h0IgogICAgKSksIHRoaXMudmlld2VyLnVwZGF0ZSghMCksICJsaWdodCIpOwogIH0KfQpsZXQgQl8gPSBjbGFzcyBleHRlbmRzIGZmIHsKICB0b0pTT04oKSB7CiAgICByZXR1cm4gb3UucHJvdG90eXBlLnRvSlNPTi5jYWxsKHRoaXMpOwogIH0KfTsKY29uc3QgWmEgPSBuZXcgRSgpLCBqYSA9IG5ldyBFKCksIHBnID0gbmV3IFh0KCk7CmNsYXNzIEhFIGV4dGVuZHMgb2kgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgdmVydGV4IG5vcm1hbHMgaGVscGVyLgogICAqCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIG9iamVjdCBmb3Igd2hpY2ggdG8gdmlzdWFsaXplIHZlcnRleCBub3JtYWxzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xXSAtIFRoZSBoZWxwZXIncyBzaXplLgogICAqIEBwYXJhbSB7bnVtYmVyfENvbG9yfHN0cmluZ30gW2NvbG9yPTB4ZmYwMDAwXSAtIFRoZSBoZWxwZXIncyBjb2xvci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlID0gMSwgaSA9IDE2NzExNjgwKSB7CiAgICBjb25zdCBuID0gbmV3IEh0KCksIHMgPSB0Lmdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsLmNvdW50LCByID0gbmV3IHd0KHMgKiAyICogMywgMyk7CiAgICBuLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCByKSwgc3VwZXIobiwgbmV3IFBlKHsgY29sb3I6IGksIHRvbmVNYXBwZWQ6ICExIH0pKSwgdGhpcy5vYmplY3QgPSB0LCB0aGlzLnNpemUgPSBlLCB0aGlzLnR5cGUgPSAiVmVydGV4Tm9ybWFsc0hlbHBlciIsIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9ICExLCB0aGlzLmlzVmVydGV4Tm9ybWFsc0hlbHBlciA9ICEwLCB0aGlzLnVwZGF0ZSgpOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSB2ZXJ0ZXggbm9ybWFscyBwcmV2aWV3IGJhc2VkIG9uIHRoZSBvYmplY3QncyB3b3JsZCB0cmFuc2Zvcm0uCiAgICovCiAgdXBkYXRlKCkgewogICAgdGhpcy5vYmplY3QudXBkYXRlTWF0cml4V29ybGQoITApLCBwZy5nZXROb3JtYWxNYXRyaXgodGhpcy5vYmplY3QubWF0cml4V29ybGQpOwogICAgY29uc3QgdCA9IHRoaXMub2JqZWN0Lm1hdHJpeFdvcmxkLCBlID0gdGhpcy5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBpID0gdGhpcy5vYmplY3QuZ2VvbWV0cnk7CiAgICBpZiAoaSkgewogICAgICBjb25zdCBuID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBzID0gaS5hdHRyaWJ1dGVzLm5vcm1hbDsKICAgICAgbGV0IHIgPSAwOwogICAgICBmb3IgKGxldCBvID0gMCwgbCA9IG4uY291bnQ7IG8gPCBsOyBvKyspCiAgICAgICAgWmEuZnJvbUJ1ZmZlckF0dHJpYnV0ZShuLCBvKS5hcHBseU1hdHJpeDQodCksIGphLmZyb21CdWZmZXJBdHRyaWJ1dGUocywgbyksIGphLmFwcGx5TWF0cml4MyhwZykubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodGhpcy5zaXplKS5hZGQoWmEpLCBlLnNldFhZWihyLCBaYS54LCBaYS55LCBaYS56KSwgciA9IHIgKyAxLCBlLnNldFhZWihyLCBqYS54LCBqYS55LCBqYS56KSwgciA9IHIgKyAxOwogICAgfQogICAgZS5uZWVkc1VwZGF0ZSA9ICEwOwogIH0KICAvKioKICAgKiBGcmVlcyB0aGUgR1BVLXJlbGF0ZWQgcmVzb3VyY2VzIGFsbG9jYXRlZCBieSB0aGlzIGluc3RhbmNlLiBDYWxsIHRoaXMKICAgKiBtZXRob2Qgd2hlbmV2ZXIgdGhpcyBpbnN0YW5jZSBpcyBubyBsb25nZXIgdXNlZCBpbiB5b3VyIGFwcC4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCksIHRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpOwogIH0KfQpjbGFzcyBvciBleHRlbmRzIHdlIHsKICBleHBhbmRCeU9iamVjdCh0LCBlID0gITEpIHsKICAgIGlmICh0LnVwZGF0ZVdvcmxkTWF0cml4KCExLCAhMSksIHQuY29uc3RydWN0b3IubmFtZSA9PSAiT2JqZWN0R3JvdXAiKQogICAgICByZXR1cm4gdGhpcy5leHBhbmRCeU9iamVjdCh0LmNoaWxkcmVuWzBdLCBlKSwgdGhpczsKICAgIGNvbnN0IGkgPSB0Lmdlb21ldHJ5OwogICAgaWYgKGkgIT09IHZvaWQgMCkKICAgICAgaWYgKGUgJiYgaS5hdHRyaWJ1dGVzICE9IG51bGwgJiYgaS5hdHRyaWJ1dGVzLnBvc2l0aW9uICE9PSB2b2lkIDApCiAgICAgICAgaWYgKHQudHlwZS5zdGFydHNXaXRoKCJMaW5lU2VnbWVudCIpKSB7CiAgICAgICAgICB2YXIgbiA9IGkuY2xvbmUoKTsKICAgICAgICAgIG4uYXBwbHlNYXRyaXg0KHQubWF0cml4V29ybGQpLCBuLmJvdW5kaW5nQm94ID0gbnVsbCwgbi5jb21wdXRlQm91bmRpbmdCb3goKSwgSmEuY29weShuLmJvdW5kaW5nQm94KSwgdGhpcy51bmlvbihKYSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHIgPSBpLmF0dHJpYnV0ZXMucG9zaXRpb247CiAgICAgICAgICBmb3IgKGxldCBvID0gMCwgbCA9IHIuY291bnQ7IG8gPCBsOyBvKyspCiAgICAgICAgICAgIHFsLmZyb21CdWZmZXJBdHRyaWJ1dGUociwgbykuYXBwbHlNYXRyaXg0KHQubWF0cml4V29ybGQpLCB0aGlzLmV4cGFuZEJ5UG9pbnQocWwpOwogICAgICAgIH0KICAgICAgZWxzZQogICAgICAgIGkuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgaS5jb21wdXRlQm91bmRpbmdCb3goKSwgSmEuY29weShpLmJvdW5kaW5nQm94KSwgSmEuYXBwbHlNYXRyaXg0KHQubWF0cml4V29ybGQpLCB0aGlzLnVuaW9uKEphKTsKICAgIGNvbnN0IHMgPSB0LmNoaWxkcmVuOwogICAgZm9yIChsZXQgciA9IDAsIG8gPSBzLmxlbmd0aDsgciA8IG87IHIrKykKICAgICAgc1tyXS5uYW1lID09ICJQbGFuZU1lc2hlcyIgJiYgc1tyXS5jaGlsZHJlbiAmJiBzW3JdLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgc1tyXS5jaGlsZHJlblswXS50eXBlLnN0YXJ0c1dpdGgoIlN0ZW5jaWxQbGFuZSIpIHx8IHRoaXMuZXhwYW5kQnlPYmplY3Qoc1tyXSwgZSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWF4X2Rpc3RfZnJvbV9jZW50ZXIoKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoCiAgICAgIC4uLnRoaXMubWluLnRvQXJyYXkoKS5jb25jYXQodGhpcy5tYXgudG9BcnJheSgpKS5tYXAoKHQpID0+IE1hdGguYWJzKHQpKQogICAgKTsKICB9CiAgYm91bmRpbmdTcGhlcmUoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRCb3VuZGluZ1NwaGVyZShmZyksIGZnOwogIH0KICBjZW50ZXIoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDZW50ZXIocWwpLCBxbC50b0FycmF5KCk7CiAgfQp9CmNsYXNzIEdFIGV4dGVuZHMgb2kgewogIGNvbnN0cnVjdG9yKHQsIGUgPSAxNjc3Njk2MCkgewogICAgY29uc3QgaSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDEsCiAgICAgIDIsCiAgICAgIDIsCiAgICAgIDMsCiAgICAgIDMsCiAgICAgIDAsCiAgICAgIDQsCiAgICAgIDUsCiAgICAgIDUsCiAgICAgIDYsCiAgICAgIDYsCiAgICAgIDcsCiAgICAgIDcsCiAgICAgIDQsCiAgICAgIDAsCiAgICAgIDQsCiAgICAgIDEsCiAgICAgIDUsCiAgICAgIDIsCiAgICAgIDYsCiAgICAgIDMsCiAgICAgIDcKICAgIF0pLCBuID0gbmV3IEZsb2F0MzJBcnJheSg4ICogMyksIHMgPSBuZXcgSHQoKTsKICAgIHMuc2V0SW5kZXgobmV3IGllKGksIDEpKSwgcy5zZXRBdHRyaWJ1dGUoInBvc2l0aW9uIiwgbmV3IGllKG4sIDMpKSwgc3VwZXIoCiAgICAgIHMsCiAgICAgIG5ldyBQZSh7IGNvbG9yOiBlLCB0b25lTWFwcGVkOiAhMSB9KQogICAgKSwgdGhpcy5vYmplY3QgPSB0LCB0aGlzLnR5cGUgPSAiQm94SGVscGVyIiwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gITEsIHRoaXMudXBkYXRlKCk7CiAgfQogIHVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLm9iamVjdCAhPT0gdm9pZCAwICYmICRsLnNldEZyb21PYmplY3QodGhpcy5vYmplY3QsICEwKSwgJGwuaXNFbXB0eSgpKSByZXR1cm47CiAgICBjb25zdCB0ID0gJGwubWluLCBlID0gJGwubWF4LCBpID0gdGhpcy5nZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBuID0gaS5hcnJheTsKICAgIG5bMF0gPSBlLngsIG5bMV0gPSBlLnksIG5bMl0gPSBlLnosIG5bM10gPSB0LngsIG5bNF0gPSBlLnksIG5bNV0gPSBlLnosIG5bNl0gPSB0LngsIG5bN10gPSB0LnksIG5bOF0gPSBlLnosIG5bOV0gPSBlLngsIG5bMTBdID0gdC55LCBuWzExXSA9IGUueiwgblsxMl0gPSBlLngsIG5bMTNdID0gZS55LCBuWzE0XSA9IHQueiwgblsxNV0gPSB0LngsIG5bMTZdID0gZS55LCBuWzE3XSA9IHQueiwgblsxOF0gPSB0LngsIG5bMTldID0gdC55LCBuWzIwXSA9IHQueiwgblsyMV0gPSBlLngsIG5bMjJdID0gdC55LCBuWzIzXSA9IHQueiwgaS5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzLmdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwogIH0KICBzZXRGcm9tT2JqZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLm9iamVjdCA9IHQsIHRoaXMudXBkYXRlKCksIHRoaXM7CiAgfQp9CmNvbnN0IHFsID0gbmV3IEUoKSwgSmEgPSBuZXcgb3IoKSwgJGwgPSBuZXcgb3IoKSwgZmcgPSBuZXcgUmUoKTsKbGV0IGxuID0gY2xhc3MgZXh0ZW5kcyB5aSB7CiAgLyoqCiAgICoKICAgKiBAcGFyYW0geyp9IG9wYWNpdHkKICAgKiBAcGFyYW0geyp9IGFscGhhCiAgICogQHBhcmFtIHsqfSBlZGdlX2NvbG9yCiAgICogQHBhcmFtIHtvYmplY3R9IHNoYXBlSW5mbyBBIGRpY3Rpb25hcnkgb2Ygc2hhcGUgaW5mb3JtYXRpb24gd2l0aCBhICJ0b3BvIiBmaWVsZCBhbmQgImdlb210eXBlIiBmaWVsZC4KICAgKiBAcGFyYW0geyp9IHJlbmRlcmJhY2sKICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuLCBzLCByKSB7CiAgICBzdXBlcigpLCB0aGlzLm9wYWNpdHkgPSB0LCB0aGlzLmFscGhhID0gZSA/PyAxLCB0aGlzLmVkZ2VfY29sb3IgPSBpLCB0aGlzLnNoYXBlSW5mbyA9IG4sIHRoaXMuc3VidHlwZSA9IHMsIHRoaXMucmVuZGVyYmFjayA9IHIsIHRoaXMudHlwZXMgPSB7IGZyb250OiBudWxsLCBiYWNrOiBudWxsLCBlZGdlczogbnVsbCwgdmVydGljZXM6IG51bGwgfSwgdGhpcy5pc1NlbGVjdGVkID0gITEsIHRoaXMub3JpZ2luYWxDb2xvciA9IG51bGwsIHRoaXMub3JpZ2luYWxCYWNrQ29sb3IgPSBudWxsLCB0aGlzLm9yaWdpbmFsV2lkdGggPSBudWxsLCB0aGlzLnZlcnRleEZvY3VzU2l6ZSA9IDgsIHRoaXMuZWRnZUZvY3VzV2lkdGggPSA1OwogIH0KICBkaXNwb3NlKCkgewogICAgdGhpcy5zaGFwZUdlb21ldHJ5ICYmIChQXyh0aGlzLnNoYXBlR2VvbWV0cnkpLCB0aGlzLnNoYXBlR2VvbWV0cnkgPSBudWxsKSwgbWUoT2JqZWN0LnZhbHVlcyh0aGlzLnR5cGVzKSksIHRoaXMuY2hpbGRyZW4gJiYgKG1lKHRoaXMuY2hpbGRyZW4pLCB0aGlzLmNsZWFyKCkpOwogIH0KICBhZGRUeXBlKHQsIGUpIHsKICAgIHRoaXMuYWRkKHQpLCB0aGlzLnR5cGVzW2VdID0gdCwgdGhpcy50eXBlcy52ZXJ0aWNlcyA/ICh0aGlzLm9yaWdpbmFsQ29sb3IgPSB0aGlzLnR5cGVzLnZlcnRpY2VzLm1hdGVyaWFsLmNvbG9yLmNsb25lKCksIHRoaXMub3JpZ2luYWxXaWR0aCA9IHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwuc2l6ZSkgOiB0aGlzLnR5cGVzLmVkZ2VzICYmICF0aGlzLnR5cGVzLmZyb250ID8gKHRoaXMub3JpZ2luYWxDb2xvciA9IHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwuY29sb3IuY2xvbmUoKSwgdGhpcy5vcmlnaW5hbFdpZHRoID0gdGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC5saW5ld2lkdGgpIDogdGhpcy50eXBlcy5mcm9udCA/IHRoaXMub3JpZ2luYWxDb2xvciA9IHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwuY29sb3IuY2xvbmUoKSA6IHRoaXMudHlwZXMuYmFjayAmJiAodGhpcy5vcmlnaW5hbEJhY2tDb2xvciA9IHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC5jb2xvci5jbG9uZSgpKTsKICB9CiAgd2lkZW4odCkgewogICAgdGhpcy50eXBlcy52ZXJ0aWNlcyA/IHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwuc2l6ZSA9IHQgPyB0aGlzLnZlcnRleEZvY3VzU2l6ZSA6IHRoaXMuaXNTZWxlY3RlZCA/IHRoaXMudmVydGV4Rm9jdXNTaXplIC0gMiA6IHRoaXMub3JpZ2luYWxXaWR0aCA6IHRoaXMudHlwZXMuZWRnZXMgJiYgKHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwubGluZXdpZHRoID0gdCA/IHRoaXMuZWRnZUZvY3VzV2lkdGggOiB0aGlzLmlzU2VsZWN0ZWQgPyB0aGlzLmVkZ2VGb2N1c1dpZHRoIC0gMiA6IHRoaXMub3JpZ2luYWxXaWR0aCk7CiAgfQogIHRvZ2dsZVNlbGVjdGlvbigpIHsKICAgIGNvbnN0IHQgPSAhdGhpcy5pc1NlbGVjdGVkOwogICAgdGhpcy5pc1NlbGVjdGVkID0gdCwgdGhpcy5oaWdobGlnaHQodCksIHRoaXMud2lkZW4oITEpOwogIH0KICB1bmhpZ2hsaWdodCh0KSB7CiAgICAoIXQgfHwgIXRoaXMuaXNTZWxlY3RlZCkgJiYgKHRoaXMuaXNTZWxlY3RlZCA9ICExLCB0aGlzLmhpZ2hsaWdodCghMSkpLCB0aGlzLndpZGVuKCExKTsKICB9CiAgaGlnaGxpZ2h0KHQpIHsKICAgIHZhciBlID0gbnVsbCwgaSA9IG51bGwsIG4gPSBudWxsOwogICAgdGhpcy50eXBlcy5mcm9udCA/IChlID0gdGhpcy50eXBlcy5mcm9udCwgaSA9IHRoaXMuaXNTZWxlY3RlZCA/IG5ldyBjdCg1NDgwNjc1KSA6IG5ldyBjdCg5MDI2MDE5KSwgbiA9IHRoaXMub3JpZ2luYWxDb2xvcikgOiB0aGlzLnR5cGVzLnZlcnRpY2VzID8gKGUgPSB0aGlzLnR5cGVzLnZlcnRpY2VzLCBpID0gdGhpcy5pc1NlbGVjdGVkID8gbmV3IGN0KDU0ODA2NzUpIDogbmV3IGN0KDkwMjYwMTkpLCBuID0gdGhpcy5vcmlnaW5hbENvbG9yKSA6IHRoaXMudHlwZXMuZWRnZXMgJiYgKGUgPSB0aGlzLnR5cGVzLmVkZ2VzLCBpID0gdGhpcy5pc1NlbGVjdGVkID8gbmV3IGN0KDU0ODA2NzUpIDogbmV3IGN0KDkwMjYwMTkpLCBuID0gdGhpcy5vcmlnaW5hbENvbG9yKSwgZSAhPSBudWxsICYmICh0aGlzLndpZGVuKHQpLCBlLm1hdGVyaWFsLmNvbG9yID0gdCA/IGkgOiBuLCBlLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApLCB0aGlzLnR5cGVzLmJhY2sgJiYgKGUgPSB0aGlzLnR5cGVzLmJhY2ssIGkgPSB0aGlzLmlzU2VsZWN0ZWQgPyBuZXcgY3QoNTQ4MDY3NSkgOiBuZXcgY3QoOTAyNjAxOSksIG4gPSB0aGlzLm9yaWdpbmFsQmFja0NvbG9yKSwgZSAhPSBudWxsICYmIChlLm1hdGVyaWFsLmNvbG9yID0gdCA/IGkgOiBuLCBlLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApOwogIH0KICBjbGVhckhpZ2hsaWdodHMoKSB7CiAgICB0aGlzLmhpZ2hsaWdodCghMSksIHRoaXMuaXNTZWxlY3RlZCA9ICExLCB0aGlzLndpZGVuKCExKTsKICB9CiAgbWV0cmljcygpIHsKICAgIGlmICh0aGlzLnR5cGVzLmZyb250KQogICAgICByZXR1cm4geyBuYW1lOiAiZmFjZSIsIHZhbHVlOiAwIH07CiAgICBpZiAodGhpcy50eXBlcy52ZXJ0aWNlcykKICAgICAgcmV0dXJuIHsgbmFtZTogInZlcnRleCIsIHZhbHVlOiAwIH07CiAgICBpZiAodGhpcy50eXBlcy5lZGdlcykKICAgICAgcmV0dXJuIHsgbmFtZTogImVkZ2UiLCB2YWx1ZTogMCB9OwogIH0KICBzZXRNZXRhbG5lc3ModCkgewogICAgZm9yICh2YXIgZSBvZiB0aGlzLmNoaWxkcmVuKQogICAgICBlLm5hbWUuc3RhcnRzV2l0aCgiY2xpcHBpbmciKSB8fCAoZS5tYXRlcmlhbC5tZXRhbG5lc3MgPSB0LCBlLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApOwogIH0KICBzZXRSb3VnaG5lc3ModCkgewogICAgZm9yICh2YXIgZSBvZiB0aGlzLmNoaWxkcmVuKQogICAgICBlLm5hbWUuc3RhcnRzV2l0aCgiY2xpcHBpbmciKSB8fCAoZS5tYXRlcmlhbC5yb3VnaG5lc3MgPSB0LCBlLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApOwogIH0KICBzZXRUcmFuc3BhcmVudCh0KSB7CiAgICB0aGlzLnR5cGVzLmJhY2sgJiYgKHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC5vcGFjaXR5ID0gdCA/IHRoaXMub3BhY2l0eSAqIHRoaXMuYWxwaGEgOiB0aGlzLmFscGhhLCB0aGlzLnR5cGVzLmZyb250Lm1hdGVyaWFsLm9wYWNpdHkgPSB0ID8gdGhpcy5vcGFjaXR5ICogdGhpcy5hbHBoYSA6IHRoaXMuYWxwaGEpOwogICAgZm9yICh2YXIgZSBvZiB0aGlzLmNoaWxkcmVuKQogICAgICBlLm5hbWUuc3RhcnRzV2l0aCgiY2xpcHBpbmciKSB8fCAoZS5tYXRlcmlhbC5kZXB0aFdyaXRlID0gdGhpcy5hbHBoYSA8IDEgPyAhMSA6ICF0LCBlLm1hdGVyaWFsLmRlcHRoVGVzdCA9ICEwLCBlLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApOwogIH0KICBzZXRCbGFja0VkZ2VzKHQpIHsKICAgIGlmICh0aGlzLnR5cGVzLmVkZ2VzKSB7CiAgICAgIGNvbnN0IGUgPSB0ID8gMCA6IHRoaXMuZWRnZV9jb2xvcjsKICAgICAgdGhpcy5vcmlnaW5hbENvbG9yID0gbmV3IGN0KGUpLCB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLmNvbG9yID0gbmV3IGN0KGUpLCB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITA7CiAgICB9CiAgfQogIHNldEVkZ2VDb2xvcih0KSB7CiAgICB0aGlzLnR5cGVzLmVkZ2VzICYmICh0aGlzLmVkZ2VfY29sb3IgPSB0LCB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLmNvbG9yID0gbmV3IGN0KHQpLCB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApOwogIH0KICBzZXRPcGFjaXR5KHQpIHsKICAgICh0aGlzLnR5cGVzLmZyb250IHx8IHRoaXMudHlwZXMuYmFjaykgJiYgKHRoaXMub3BhY2l0eSA9IHQsIHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC5vcGFjaXR5ID0gdGhpcy5vcGFjaXR5LCB0aGlzLnR5cGVzLmZyb250Lm1hdGVyaWFsLm9wYWNpdHkgPSB0aGlzLm9wYWNpdHksIHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9ICEwLCB0aGlzLnR5cGVzLmZyb250Lm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITApOwogIH0KICBzZXRTaGFwZVZpc2libGUodCkgewogICAgdGhpcy50eXBlcy5mcm9udCAmJiAodGhpcy50eXBlcy5mcm9udC5tYXRlcmlhbC52aXNpYmxlID0gdCk7CiAgICBmb3IgKHZhciBlIG9mIFsiY2xpcHBpbmctMCIsICJjbGlwcGluZy0xIiwgImNsaXBwaW5nLTIiXSkKICAgICAgdGhpcy50eXBlc1tlXSAmJiAodGhpcy50eXBlc1tlXS5jaGlsZHJlblswXS5tYXRlcmlhbC52aXNpYmxlID0gdCwgdGhpcy50eXBlc1tlXS5jaGlsZHJlblsxXS5tYXRlcmlhbC52aXNpYmxlID0gdCk7CiAgICB0aGlzLnR5cGVzLmJhY2sgJiYgdGhpcy5yZW5kZXJiYWNrICYmICh0aGlzLnR5cGVzLmJhY2subWF0ZXJpYWwudmlzaWJsZSA9IHQpOwogIH0KICBzZXRFZGdlc1Zpc2libGUodCkgewogICAgdGhpcy50eXBlcy5lZGdlcyAmJiAodGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC52aXNpYmxlID0gdCksIHRoaXMudHlwZXMudmVydGljZXMgJiYgKHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwudmlzaWJsZSA9IHQpOwogIH0KICBzZXRCYWNrVmlzaWJsZSh0KSB7CiAgICB0aGlzLnR5cGVzLmJhY2sgJiYgdGhpcy50eXBlcy5mcm9udC5tYXRlcmlhbC52aXNpYmxlICYmICh0aGlzLnR5cGVzLmJhY2subWF0ZXJpYWwudmlzaWJsZSA9IHRoaXMucmVuZGVyYmFjayB8fCB0KTsKICB9CiAgZ2V0VmlzaWJpbGl0eSgpIHsKICAgIHJldHVybiB0aGlzLnR5cGVzLmZyb250ID8gdGhpcy50eXBlcy5lZGdlcyA/IHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwudmlzaWJsZSB8fCB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLnZpc2libGUgOiB0aGlzLnR5cGVzLmZyb250Lm1hdGVyaWFsLnZpc2libGUgOiB0aGlzLnR5cGVzLmVkZ2VzID8gdGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC52aXNpYmxlIDogdGhpcy50eXBlcy52ZXJ0aWNlcyA/IHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwudmlzaWJsZSA6ICExOwogIH0KICBzZXRDbGlwSW50ZXJzZWN0aW9uKHQpIHsKICAgIGZvciAodmFyIGUgb2YgdGhpcy5jaGlsZHJlbikKICAgICAgZS5uYW1lLnN0YXJ0c1dpdGgoImNsaXBwaW5nIikgfHwgKGUubWF0ZXJpYWwuY2xpcEludGVyc2VjdGlvbiA9IHQsIGUubWF0ZXJpYWwuY2xpcEludGVyc2VjdGlvbiA9IHQsIGUubWF0ZXJpYWwuY2xpcEludGVyc2VjdGlvbiA9IHQpOwogIH0KICBzZXRDbGlwUGxhbmVzKHQpIHsKICAgIHRoaXMudHlwZXMuYmFjayAmJiAodGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzID0gdCksIHRoaXMudHlwZXMuZnJvbnQgJiYgKHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwuY2xpcHBpbmdQbGFuZXMgPSB0KSwgdGhpcy50eXBlcy5lZGdlcyAmJiAodGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC5jbGlwcGluZ1BsYW5lcyA9IHQpLCB0aGlzLnR5cGVzLnZlcnRpY2VzICYmICh0aGlzLnR5cGVzLnZlcnRpY2VzLm1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzID0gdCksIHRoaXMudXBkYXRlTWF0ZXJpYWxzKCEwKTsKICB9CiAgc2V0UG9seWdvbk9mZnNldCh0KSB7CiAgICB0aGlzLnR5cGVzLmJhY2sgJiYgKHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC5wb2x5Z29uT2Zmc2V0VW5pdHMgPSB0KTsKICB9CiAgc2V0WlNjYWxlKHQpIHsKICAgIGZ1bmN0aW9uIGUoaSwgbiwgcywgciA9ICEwKSB7CiAgICAgIGZvciAodmFyIG8gb2YgaS5jaGlsZHJlbikKICAgICAgICBvLmlzTWVzaCB8fCBvLmlzTGluZSA/IChvLnNjYWxlLnogPSB0LCByICYmIChvLnBhcmVudC5wb3NpdGlvbi56ID0gbiAqIHQpKSA6IG8uaXNHcm91cCAmJiBlKG8sIG4sIHMsICFvLm5hbWUuc3RhcnRzV2l0aCgiY2xpcHBpbmciKSk7CiAgICB9CiAgICAodGhpcy50eXBlcy5mcm9udCB8fCB0aGlzLnR5cGVzLmJhY2sgfHwgdGhpcy50eXBlcy5lZGdlcykgJiYgZSh0aGlzLCB0aGlzLm1pblosIHRoaXMuaGVpZ2h0KTsKICB9CiAgdXBkYXRlTWF0ZXJpYWxzKHQpIHsKICAgIHRoaXMudHlwZXMuYmFjayAmJiAodGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdCksIHRoaXMudHlwZXMuZnJvbnQgJiYgKHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0KSwgdGhpcy50eXBlcy5lZGdlcyAmJiAodGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHQpLCB0aGlzLnR5cGVzLnZlcnRpY2VzICYmICh0aGlzLnR5cGVzLnZlcnRpY2VzLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdCk7CiAgfQp9OwpjbGFzcyBXRSB7CiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCwgYykgewogICAgdGhpcy5zaGFwZXMgPSB0LCB0aGlzLndpZHRoID0gZSwgdGhpcy5oZWlnaHQgPSBpLCB0aGlzLmVkZ2VDb2xvciA9IG4sIHRoaXMudHJhbnNwYXJlbnQgPSBzLCB0aGlzLm1ldGFsbmVzcyA9IG8sIHRoaXMucm91Z2huZXNzID0gbCwgdGhpcy5kZWZhdWx0T3BhY2l0eSA9IHIsIHRoaXMubm9ybWFsTGVuID0gaCwgdGhpcy5ibGFja0VkZ2VzID0gITEsIHRoaXMuYmFja1Zpc2libGUgPSAhMSwgdGhpcy5iYl9tYXggPSBjLCB0aGlzLmRlbGltID0gInwiLCB0aGlzLnJvb3RHcm91cCA9IG51bGwsIHRoaXMuaW5zdGFuY2VzID0gbnVsbCwgdGhpcy5iYm94ID0gbnVsbCwgdGhpcy5ic3BoZXJlID0gbnVsbCwgdGhpcy5ncm91cHMgPSB7fSwgdGhpcy5jbGlwUGxhbmVzID0gbnVsbDsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZ3JvdXBzICYmIChtZShPYmplY3QudmFsdWVzKHRoaXMuZ3JvdXBzKSksIHRoaXMuZ3JvdXBzID0gbnVsbCksIHRoaXMucm9vdEdyb3VwICYmIChtZSh0aGlzLnJvb3RHcm91cCksIHRoaXMucm9vdEdyb3VwID0gbnVsbCksIHRoaXMuc2hhcGVzICYmIChtZSh0aGlzLnNoYXBlcyksIHRoaXMuc2hhcGVzID0gbnVsbCk7CiAgfQogIF9kdW1wKHQpIHsKICAgIGlmICh0ID09IG51bGwgJiYgKHQgPSAiIiksIHRoaXMucGFydHMpCiAgICAgIGZvciAodmFyIGUgb2YgdGhpcy5wYXJ0cykKICAgICAgICB0aGlzLl9kdW1wKGUsIHQgKyAiICAiKTsKICB9CiAgX3JlbmRlckVkZ2VzKHQsIGUsIGksIG4pIHsKICAgIHZhciBzID0gdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSA/IHQgOiBuZXcgRmxvYXQzMkFycmF5KHhzKHQsIDMpKTsKICAgIGNvbnN0IHIgPSBuZXcgQl8oKTsKICAgIHIuc2V0UG9zaXRpb25zKHMpOwogICAgY29uc3QgbyA9IG5ldyBodSh7CiAgICAgIGxpbmV3aWR0aDogZSwKICAgICAgdHJhbnNwYXJlbnQ6ICEwLAogICAgICBkZXB0aFdyaXRlOiAhdGhpcy50cmFuc3BhcmVudCwKICAgICAgZGVwdGhUZXN0OiAhdGhpcy50cmFuc3BhcmVudCwKICAgICAgY2xpcEludGVyc2VjdGlvbjogITEKICAgIH0pOwogICAgaWYgKEFycmF5LmlzQXJyYXkoaSkpIHsKICAgICAgdmFyIGwgPSBpLm1hcCgoYykgPT4gWwogICAgICAgIG5ldyBjdChjKS50b0FycmF5KCksCiAgICAgICAgbmV3IGN0KGMpLnRvQXJyYXkoKQogICAgICBdKS5mbGF0KDIpOwogICAgICByLnNldENvbG9ycyhsKSwgby52ZXJ0ZXhDb2xvcnMgPSAiVmVydGV4Q29sb3JzIjsKICAgIH0gZWxzZQogICAgICBvLmNvbG9yID0gbmV3IGN0KAogICAgICAgIGkgPz8gdGhpcy5lZGdlQ29sb3IKICAgICAgKTsKICAgIG8udmlzaWJsZSA9IG4gPT0gMSwgby5yZXNvbHV0aW9uLnNldCh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgICB2YXIgaCA9IG5ldyBtZihyLCBvKTsKICAgIHJldHVybiBoLnJlbmRlck9yZGVyID0gOTk5LCBoOwogIH0KICByZW5kZXJFZGdlcyh0LCBlLCBpLCBuLCBzLCByLCBvID0gbnVsbCkgewogICAgdmFyIGwgPSBuZXcgbG4oCiAgICAgIHRoaXMuZGVmYXVsdE9wYWNpdHksCiAgICAgIDEsCiAgICAgIGkgPz8gdGhpcy5lZGdlQ29sb3IsCiAgICAgIG8sCiAgICAgICJlZGdlcyIKICAgICksIGggPSB0aGlzLl9yZW5kZXJFZGdlcygKICAgICAgdC5lZGdlcyA/IHQuZWRnZXMgOiB4cyh0KSwKICAgICAgLy8gcHJvdG9jb2wgdmVyc2lvbiAxCiAgICAgIGUsCiAgICAgIGksCiAgICAgIHIKICAgICk7CiAgICByZXR1cm4gcyAmJiAoaC5uYW1lID0gcyksIGwuYWRkVHlwZShoLCAiZWRnZXMiKSwgdGhpcy5ncm91cHNbbl0gPSBsLCBsLm5hbWUgPSBuLnJlcGxhY2VBbGwoIi8iLCB0aGlzLmRlbGltKSwgbDsKICB9CiAgcmVuZGVyVmVydGljZXModCwgZSwgaSwgbiwgcywgciwgbyA9IG51bGwpIHsKICAgIHZhciBsID0gbmV3IGxuKAogICAgICB0aGlzLmRlZmF1bHRPcGFjaXR5LAogICAgICAxLAogICAgICBpID8/IHRoaXMuZWRnZUNvbG9yLAogICAgICBvLAogICAgICAidmVydGljZXMiCiAgICApOwogICAgY29uc3QgaCA9IGkgPz8gdGhpcy5lZGdlQ29sb3I7CiAgICBsZXQgYzsKICAgIHQub2JqX3ZlcnRpY2VzID8gYyA9IHQub2JqX3ZlcnRpY2VzIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5ID8gdC5vYmpfdmVydGljZXMgOiBuZXcgRmxvYXQzMkFycmF5KHQub2JqX3ZlcnRpY2VzKSA6IGMgPSB0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5ID8gdCA6IG5ldyBGbG9hdDMyQXJyYXkoeHModCkpOwogICAgY29uc3QgdSA9IG5ldyBIdCgpOwogICAgdS5zZXRBdHRyaWJ1dGUoCiAgICAgICJwb3NpdGlvbiIsCiAgICAgIG5ldyB3dChjLCAzKQogICAgKTsKICAgIGNvbnN0IGQgPSBuZXcgWGMoewogICAgICBjb2xvcjogaCwKICAgICAgc2l6ZUF0dGVudWF0aW9uOiAhMSwKICAgICAgc2l6ZTogZSwKICAgICAgdHJhbnNwYXJlbnQ6ICEwLAogICAgICBjbGlwSW50ZXJzZWN0aW9uOiAhMSwKICAgICAgdmlzaWJsZTogciA9PSAxCiAgICB9KTsKICAgIHZhciBwID0gbmV3IGtwKHUsIGQpOwogICAgcmV0dXJuIHMgJiYgKHAubmFtZSA9IHMpLCBsLmFkZFR5cGUocCwgInZlcnRpY2VzIiksIHRoaXMuZ3JvdXBzW25dID0gbCwgbC5uYW1lID0gbi5yZXBsYWNlQWxsKCIvIiwgdGhpcy5kZWxpbSksIGw7CiAgfQogIHJlbmRlclNoYXBlKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGggPSBudWxsLCBjID0gbnVsbCwgdSA9IG51bGwsIGQgPSBudWxsLCBwID0gbnVsbCkgewogICAgY29uc3QgZiA9IHQudmVydGljZXMgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgPyB0LnZlcnRpY2VzIDogbmV3IEZsb2F0MzJBcnJheSh4cyh0LnZlcnRpY2VzKSksIHkgPSB0Lm5vcm1hbHMgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgPyB0Lm5vcm1hbHMgOiBuZXcgRmxvYXQzMkFycmF5KHhzKHQubm9ybWFscykpLCBnID0gdC50cmlhbmdsZXMgaW5zdGFuY2VvZiBVaW50MzJBcnJheSA/IHQudHJpYW5nbGVzIDogbmV3IFVpbnQzMkFycmF5KHhzKHQudHJpYW5nbGVzKSk7CiAgICB2YXIgbSA9IG5ldyBsbigKICAgICAgdGhpcy5kZWZhdWx0T3BhY2l0eSwKICAgICAgaSwKICAgICAgdGhpcy5lZGdlQ29sb3IsCiAgICAgIGgsCiAgICAgIGMsCiAgICAgIG4KICAgICk7CiAgICB0aGlzLmdyb3Vwc1tyXSA9IG0sIG0ubmFtZSA9IHIucmVwbGFjZUFsbCgiLyIsIHRoaXMuZGVsaW0pLCBpID09IG51bGwgPyBpID0gMSA6IGkgPCAxICYmICh0aGlzLnRyYW5zcGFyZW50ID0gITApOwogICAgdmFyIHYsIHggPSBudWxsLCBfID0gbnVsbDsKICAgIGlmICh1ICE9IG51bGwpIHsKICAgICAgY29uc3QgVSA9IGBkYXRhOmltYWdlLyR7dS5mb3JtYXR9O2Jhc2U2NCwke3UuZGF0YX1gOwogICAgICB2YXIgUyA9IG5ldyBJbWFnZSgpOwogICAgICBTLnNldEF0dHJpYnV0ZSgic3JjIiwgVSksIHYgPSBuZXcgRHMoZCwgcCksIHggPSBuZXcgTmUoUyksIHgubmVlZHNVcGRhdGUgPSAhMCwgeC5jb2xvclNwYWNlID0gcmksIF8gPSBuZXcgbGkoewogICAgICAgIGNvbG9yOiAiI2ZmZmZmZiIsCiAgICAgICAgbWFwOiB4LAogICAgICAgIHNpZGU6IE1pCiAgICAgIH0pLCBuID0gITE7CiAgICB9IGVsc2UKICAgICAgdiA9IG5ldyBIdCgpLCB2LnNldEF0dHJpYnV0ZSgKICAgICAgICAicG9zaXRpb24iLAogICAgICAgIG5ldyBpZShmLCAzKQogICAgICApLCB2LnNldEF0dHJpYnV0ZSgKICAgICAgICAibm9ybWFsIiwKICAgICAgICBuZXcgaWUoeSwgMykKICAgICAgKSwgdi5zZXRJbmRleChuZXcgaWUoZywgMSkpLCBtLnNoYXBlR2VvbWV0cnkgPSB2LCBfID0gbmV3IGhyKHsKICAgICAgICBjb2xvcjogZSwKICAgICAgICBtZXRhbG5lc3M6IHRoaXMubWV0YWxuZXNzLAogICAgICAgIHJvdWdobmVzczogdGhpcy5yb3VnaG5lc3MsCiAgICAgICAgLy8gZW52TWFwOiB0ZXh0dXJlLAogICAgICAgIHBvbHlnb25PZmZzZXQ6ICEwLAogICAgICAgIHBvbHlnb25PZmZzZXRGYWN0b3I6IDEsCiAgICAgICAgcG9seWdvbk9mZnNldFVuaXRzOiAxLAogICAgICAgIHRyYW5zcGFyZW50OiAhMCwKICAgICAgICBvcGFjaXR5OiB0aGlzLnRyYW5zcGFyZW50ID8gdGhpcy5kZWZhdWx0T3BhY2l0eSAqIGkgOiBpLAogICAgICAgIC8vIHR1cm4gZGVwdGggd3JpdGUgb2ZmIGZvciB0cmFuc3BhcmVudCBvYmplY3RzCiAgICAgICAgZGVwdGhXcml0ZTogIXRoaXMudHJhbnNwYXJlbnQsCiAgICAgICAgLy8gYnV0IGtlZXAgZGVwdGggdGVzdAogICAgICAgIGRlcHRoVGVzdDogITAsCiAgICAgICAgY2xpcEludGVyc2VjdGlvbjogITEsCiAgICAgICAgc2lkZTogJGksCiAgICAgICAgdmlzaWJsZTogbFswXSA9PSAxLAogICAgICAgIG1hcDogeCwKICAgICAgICBuYW1lOiAiZnJvbnRNYXRlcmlhbCIKICAgICAgfSk7CiAgICBjb25zdCB3ID0gbS5zdWJ0eXBlID09PSAic29saWQiICYmICFzID8gZSA6IG5ldyBjdCh0aGlzLmVkZ2VDb2xvcikubGVycChuZXcgY3QoMSwgMSwgMSksIDAuMTUpLCBUID0gbmV3IGxpKHsKICAgICAgY29sb3I6IHcsCiAgICAgIHNpZGU6IEhlLAogICAgICBwb2x5Z29uT2Zmc2V0OiAhMCwKICAgICAgcG9seWdvbk9mZnNldEZhY3RvcjogMSwKICAgICAgcG9seWdvbk9mZnNldFVuaXRzOiAxLAogICAgICB0cmFuc3BhcmVudDogITAsCiAgICAgIG9wYWNpdHk6IHRoaXMudHJhbnNwYXJlbnQgPyB0aGlzLmRlZmF1bHRPcGFjaXR5ICogaSA6IGksCiAgICAgIC8vIHR1cm4gZGVwdGggd3JpdGUgb2ZmIGZvciB0cmFuc3BhcmVudCBvYmplY3RzCiAgICAgIGRlcHRoV3JpdGU6ICF0aGlzLnRyYW5zcGFyZW50LAogICAgICAvLyBidXQga2VlcCBkZXB0aCB0ZXN0CiAgICAgIGRlcHRoVGVzdDogITAsCiAgICAgIGNsaXBJbnRlcnNlY3Rpb246ICExLAogICAgICB2aXNpYmxlOiBsWzBdID09IDEgJiYgKG4gfHwgdGhpcy5iYWNrVmlzaWJsZSksCiAgICAgIG5hbWU6ICJiYWNrTWF0ZXJpYWwiCiAgICB9KSwgUiA9IG5ldyByZSh2LCBUKTsKICAgIFIubmFtZSA9IG87CiAgICBjb25zdCBiID0gbmV3IHJlKHYsIF8pOwogICAgaWYgKGIubmFtZSA9IG8sIGkgPCAxICYmIChSLnJlbmRlck9yZGVyID0gOTk5LCBiLnJlbmRlck9yZGVyID0gOTk5KSwgYi5nZW9tZXRyeS5ib3VuZGluZ0JveCA9PSBudWxsICYmIGIuZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCksIG0uYWRkVHlwZShSLCAiYmFjayIpLCBtLmFkZFR5cGUoYiwgImZyb250IiksIHRoaXMubm9ybWFsTGVuID4gMCkgewogICAgICBjb25zdCBVID0gbmV3IEhFKAogICAgICAgIGIsCiAgICAgICAgdGhpcy5ub3JtYWxMZW4sCiAgICAgICAgMTY3MTE5MzUKICAgICAgKTsKICAgICAgbS5hZGQoVSk7CiAgICB9CiAgICBjb25zdCBNID0gdC5lZGdlczsKICAgIGlmIChNLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIEwgPSB0aGlzLl9yZW5kZXJFZGdlcyhNLCAxLCBudWxsLCBsWzFdKTsKICAgICAgTC5uYW1lID0gbywgbS5hZGRUeXBlKEwsICJlZGdlcyIpOwogICAgfQogICAgcmV0dXJuIG07CiAgfQogIHJlbmRlclBvbHlnb25zKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgsIGMgPSBudWxsLCB1ID0gbnVsbCkgewogICAgY29uc3QgZCA9IChWLCBXKSA9PiB7CiAgICAgIGNvbnN0IEcgPSBbXSwgZXQgPSBbXTsKICAgICAgbGV0IEggPSAwOwogICAgICBmb3IgKGxldCBwdCA9IDA7IHB0IDwgVi5sZW5ndGg7IHB0KyspIHsKICAgICAgICBjb25zdCBMdCA9IFZbcHRdLmdldFBvaW50cygpLCBqdCA9IEx0Lm1hcCgoWSkgPT4gbmV3IEUoWS54LCBZLnksIDApKSwgbmUgPSBMdC5tYXAoKFkpID0+IG5ldyBFKFkueCwgWS55LCBXKSksIEp0ID0gKFkpID0+IHsKICAgICAgICAgIGZvciAobGV0IHN0ID0gMDsgc3QgPCBZLmxlbmd0aDsgc3QrKykgewogICAgICAgICAgICBjb25zdCBFdCA9IChzdCArIDEpICUgWS5sZW5ndGg7CiAgICAgICAgICAgIGV0LnB1c2goSCArIHN0LCBIICsgRXQpOwogICAgICAgICAgfQogICAgICAgICAgRy5wdXNoKC4uLlkpLCBIICs9IFkubGVuZ3RoOwogICAgICAgIH07CiAgICAgICAgSnQoanQpLCBKdChuZSk7CiAgICAgICAgZm9yIChsZXQgWSA9IDA7IFkgPCBMdC5sZW5ndGg7IFkrKykKICAgICAgICAgIGV0LnB1c2goCiAgICAgICAgICAgIEggLSAyICogTHQubGVuZ3RoICsgWSwKICAgICAgICAgICAgLy8gQm90dG9tIHBvaW50IGluZGV4CiAgICAgICAgICAgIEggLSBMdC5sZW5ndGggKyBZCiAgICAgICAgICAgIC8vIFRvcCBwb2ludCBpbmRleAogICAgICAgICAgKTsKICAgICAgfQogICAgICBjb25zdCBhdCA9IG5ldyBIdCgpOwogICAgICByZXR1cm4gYXQuc2V0RnJvbVBvaW50cyhHKSwgYXQuc2V0SW5kZXgoZXQpLCBhdDsKICAgIH07CiAgICB2YXIgcCA9IG5ldyBsbigKICAgICAgdGhpcy5kZWZhdWx0T3BhY2l0eSwKICAgICAgMSwKICAgICAgdGhpcy5lZGdlQ29sb3IsCiAgICAgIGMsCiAgICAgIHUsCiAgICAgIHMKICAgICk7CiAgICBwLm5hbWUgPSBvLnJlcGxhY2VBbGwoIi8iLCB0aGlzLmRlbGltKSwgcC5taW5aID0gZSwgcC5oZWlnaHQgPSB0LmhlaWdodCwgdGhpcy5ncm91cHNbb10gPSBwOwogICAgdmFyIGYgPSBbXSwgeTsKICAgIHQubWF0cmljZXMgJiYgdC5tYXRyaWNlcy5sZW5ndGggPiAwID8geSA9IHQubWF0cmljZXMgOiB5ID0gWzEsIDAsIDAsIDAsIDEsIDBdOwogICAgZm9yICh2YXIgZyBvZiB0LnJlZnMpIHsKICAgICAgdmFyIG0gPSB0aGlzLmluc3RhbmNlc1tnXTsKICAgICAgY29uc3QgViA9IG0ubGVuZ3RoIC8gMjsKICAgICAgZm9yICh2YXIgdiA9IG5ldyBBcnJheShWKSwgeCA9IDA7IHggPCB5Lmxlbmd0aCAvIDY7IHgrKykgewogICAgICAgIGNvbnN0IFcgPSB5WzYgKiB4XSwgRyA9IHlbNiAqIHggKyAxXSwgZXQgPSB5WzYgKiB4ICsgMl0sIEggPSB5WzYgKiB4ICsgM10sIGF0ID0geVs2ICogeCArIDRdLCBwdCA9IHlbNiAqIHggKyA1XTsKICAgICAgICBmb3IgKGxldCBMdCA9IDA7IEx0IDwgVjsgTHQrKykKICAgICAgICAgIHZbTHRdID0gbmV3IEooCiAgICAgICAgICAgIFcgKiBtWzIgKiBMdF0gKyBHICogbVsyICogTHQgKyAxXSArIGV0LAogICAgICAgICAgICBIICogbVsyICogTHRdICsgYXQgKiBtWzIgKiBMdCArIDFdICsgcHQKICAgICAgICAgICk7CiAgICAgICAgY29uc3QgTXQgPSBuZXcgQXModik7CiAgICAgICAgZi5wdXNoKE10KTsKICAgICAgfQogICAgfQogICAgY29uc3QgXyA9IHsKICAgICAgZGVwdGg6IHQuaGVpZ2h0LAogICAgICBiZXZlbEVuYWJsZWQ6ICExCiAgICB9OwogICAgbGV0IFM7CiAgICBTID0gbmV3IFZvKGYsIF8pOwogICAgY29uc3QgdyA9IHsKICAgICAgY29sb3I6IGksCiAgICAgIG1ldGFsbmVzczogdGhpcy5tZXRhbG5lc3MsCiAgICAgIHJvdWdobmVzczogdGhpcy5yb3VnaG5lc3MsCiAgICAgIC8vIGVudk1hcDogdGV4dHVyZSwKICAgICAgcG9seWdvbk9mZnNldDogITAsCiAgICAgIHBvbHlnb25PZmZzZXRGYWN0b3I6IDEsCiAgICAgIHBvbHlnb25PZmZzZXRVbml0czogMSwKICAgICAgdHJhbnNwYXJlbnQ6ICEwLAogICAgICBvcGFjaXR5OiB0aGlzLnRyYW5zcGFyZW50ID8gdGhpcy5kZWZhdWx0T3BhY2l0eSAqIG4gOiBuLAogICAgICAvLyB0dXJuIGRlcHRoIHdyaXRlIG9mZiBmb3IgdHJhbnNwYXJlbnQgb2JqZWN0cwogICAgICBkZXB0aFdyaXRlOiAhdGhpcy50cmFuc3BhcmVudCwKICAgICAgLy8gYnV0IGtlZXAgZGVwdGggdGVzdAogICAgICBkZXB0aFRlc3Q6ICEwLAogICAgICBjbGlwSW50ZXJzZWN0aW9uOiAhMQogICAgfTsKICAgIHZhciBUID0gbmV3IGhyKHsKICAgICAgc2lkZTogJGksCiAgICAgIG5hbWU6ICJmcm9udE1hdGVyaWFsIiwKICAgICAgdmlzaWJsZTogaFswXSA9PSAxLAogICAgICAuLi53CiAgICB9KSwgUiA9IG5ldyBocih7CiAgICAgIHNpZGU6IEhlLAogICAgICB2aXNpYmxlOiBoWzBdID09IDEgJiYgKHMgfHwgdGhpcy5iYWNrVmlzaWJsZSksCiAgICAgIG5hbWU6ICJiYWNrTWF0ZXJpYWwiLAogICAgICAuLi53CiAgICB9KTsKICAgIGNvbnN0IGIgPSBuZXcgcmUoUywgUik7CiAgICBiLm5hbWUgPSBsOwogICAgY29uc3QgTSA9IG5ldyByZShTLCBUKTsKICAgIE0ubmFtZSA9IGw7CiAgICBjb25zdCBMID0gZChmLCB0LmhlaWdodCk7CiAgICB2YXIgVSA9IG5ldyBQZSh7CiAgICAgIGNvbG9yOiB0aGlzLmVkZ2VDb2xvciwKICAgICAgZGVwdGhXcml0ZTogIXRoaXMudHJhbnNwYXJlbnQsCiAgICAgIGRlcHRoVGVzdDogIXRoaXMudHJhbnNwYXJlbnQsCiAgICAgIGNsaXBJbnRlcnNlY3Rpb246ICExCiAgICB9KSwgTyA9IG5ldyBvaShMLCBVKTsKICAgIHJldHVybiBwLnNoYXBlR2VvbWV0cnkgPSBTLCBwLmFkZFR5cGUoTSwgImZyb250IiksIHAuYWRkVHlwZShiLCAiYmFjayIpLCBwLmFkZFR5cGUoTywgImVkZ2VzIiksIHA7CiAgfQogIHJlbmRlckxvb3AodCkgewogICAgY29uc3QgZSA9IChsLCBoLCBjLCB1KSA9PiB7CiAgICAgIHZhciBkOwogICAgICBzd2l0Y2ggKGwudHlwZSkgewogICAgICAgIGNhc2UgImVkZ2VzIjoKICAgICAgICAgIGQgPSB0aGlzLnJlbmRlckVkZ2VzKAogICAgICAgICAgICBsLnNoYXBlLAogICAgICAgICAgICBsLndpZHRoLAogICAgICAgICAgICBsLmNvbG9yLAogICAgICAgICAgICBsLmlkLAogICAgICAgICAgICBsLm5hbWUsCiAgICAgICAgICAgIGwuc3RhdGVbMV0sCiAgICAgICAgICAgIHsgdG9wbzogImVkZ2UiLCBnZW9tdHlwZTogbC5nZW9tdHlwZSB9CiAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAidmVydGljZXMiOgogICAgICAgICAgZCA9IHRoaXMucmVuZGVyVmVydGljZXMoCiAgICAgICAgICAgIGwuc2hhcGUsCiAgICAgICAgICAgIGwuc2l6ZSwKICAgICAgICAgICAgbC5jb2xvciwKICAgICAgICAgICAgbC5pZCwKICAgICAgICAgICAgbC5uYW1lLAogICAgICAgICAgICBsLnN0YXRlWzFdLAogICAgICAgICAgICB7IHRvcG86ICJ2ZXJ0ZXgiLCBnZW9tdHlwZTogbnVsbCB9CiAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAicG9seWdvbiI6CiAgICAgICAgICBkID0gdGhpcy5yZW5kZXJQb2x5Z29ucygKICAgICAgICAgICAgbC5zaGFwZSwKICAgICAgICAgICAgbC5sb2NbMF1bMl0sCiAgICAgICAgICAgIGwuY29sb3IsCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIGwucmVuZGVyYmFjayA9PSBudWxsID8gITEgOiBsLnJlbmRlcmJhY2ssCiAgICAgICAgICAgICExLAogICAgICAgICAgICAvL2V4cGxvZGVkCiAgICAgICAgICAgIGwuaWQsCiAgICAgICAgICAgIGwubmFtZSwKICAgICAgICAgICAgbC5zdGF0ZSwKICAgICAgICAgICAgeyB0b3BvOiAiZmFjZSIsIGdlb210eXBlOiBsLmdlb210eXBlIH0sCiAgICAgICAgICAgIGwuc3VidHlwZQogICAgICAgICAgKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBkID0gdGhpcy5yZW5kZXJTaGFwZSgKICAgICAgICAgICAgbC5zaGFwZSwKICAgICAgICAgICAgbC5jb2xvciwKICAgICAgICAgICAgbC5hbHBoYSwKICAgICAgICAgICAgbC5yZW5kZXJiYWNrID09IG51bGwgPyAhMSA6IGwucmVuZGVyYmFjaywKICAgICAgICAgICAgbC5leHBsb2RlZCwKICAgICAgICAgICAgbC5pZCwKICAgICAgICAgICAgbC5uYW1lLAogICAgICAgICAgICBsLnN0YXRlLAogICAgICAgICAgICB7IHRvcG86ICJmYWNlIiwgZ2VvbXR5cGU6IGwuZ2VvbXR5cGUgfSwKICAgICAgICAgICAgbC5zdWJ0eXBlLAogICAgICAgICAgICBoLAogICAgICAgICAgICBjLAogICAgICAgICAgICB1CiAgICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBsLmxvYyAhPSBudWxsICYmIChkLnBvc2l0aW9uLnNldCguLi5sLmxvY1swXSksIGQucXVhdGVybmlvbi5zZXQoLi4ubC5sb2NbMV0pKSwgZDsKICAgIH07CiAgICB2YXIgaSA9IG5ldyB5aSgpOwogICAgdC5sb2MgPT0gbnVsbCAmJiAodC5sb2MgPSBbCiAgICAgIFswLCAwLCAwXSwKICAgICAgWzAsIDAsIDAsIDFdCiAgICBdKSwgaS5wb3NpdGlvbi5zZXQoLi4udC5sb2NbMF0pLCBpLnF1YXRlcm5pb24uc2V0KC4uLnQubG9jWzFdKSwgdGhpcy5ncm91cHNbdC5pZF0gPSBpLCBpLm5hbWUgPSB0LmlkLnJlcGxhY2VBbGwoIi8iLCAifCIpOwogICAgZm9yICh2YXIgbiBvZiB0LnBhcnRzKQogICAgICBpZiAobi5wYXJ0cykKICAgICAgICBpLmFkZCh0aGlzLnJlbmRlckxvb3AobikpOwogICAgICBlbHNlIHsKICAgICAgICBjb25zdCBsID0gbi50ZXh0dXJlICE9IG51bGw7CiAgICAgICAgdmFyIHMgPSBsID8gbi50ZXh0dXJlLmltYWdlIDogbnVsbCwgciA9IGwgPyBuLnRleHR1cmUud2lkdGggOiBudWxsLCBvID0gbCA/IG4udGV4dHVyZS5oZWlnaHQgOiBudWxsOwogICAgICAgIGNvbnN0IGggPSBlKG4sIHMsIHIsIG8pOwogICAgICAgIHRoaXMuZ3JvdXBzW24uaWRdID0gaCwgaS5hZGQoaCk7CiAgICAgIH0KICAgIHJldHVybiBpOwogIH0KICByZW5kZXIoKSB7CiAgICByZXR1cm4gdGhpcy5zaGFwZXMuZm9ybWF0ID09ICJHRFMiICYmICh0aGlzLmluc3RhbmNlcyA9IHRoaXMuc2hhcGVzLmluc3RhbmNlcyksIHRoaXMucm9vdEdyb3VwID0gdGhpcy5yZW5kZXJMb29wKHRoaXMuc2hhcGVzKSwgdGhpcy5yb290R3JvdXA7CiAgfQogIGJvdW5kaW5nQm94KCkgewogICAgcmV0dXJuIHRoaXMuYmJveCA9PSBudWxsICYmICh0aGlzLmJib3ggPSBuZXcgb3IoKSwgdGhpcy5iYm94LnNldEZyb21PYmplY3QodGhpcy5yb290R3JvdXAsICExKSksIHRoaXMuYmJveDsKICB9CiAgX3RyYXZlcnNlKHQsIGUpIHsKICAgIGZvciAodmFyIGkgaW4gdGhpcy5ncm91cHMpIHsKICAgICAgdmFyIG4gPSB0aGlzLmdyb3Vwc1tpXTsKICAgICAgbiBpbnN0YW5jZW9mIGxuICYmIG5bdF0oZSk7CiAgICB9CiAgfQogIHNlbGVjdGlvbigpIHsKICAgIHZhciB0ID0gW107CiAgICBmb3IgKHZhciBlIGluIHRoaXMuZ3JvdXBzKQogICAgICBmb3IgKHZhciBpIG9mIHRoaXMuZ3JvdXBzW2VdLmNoaWxkcmVuKQogICAgICAgIGkgaW5zdGFuY2VvZiBsbiAmJiBpLmlzU2VsZWN0ZWQgJiYgdC5wdXNoKGkpOwogICAgcmV0dXJuIHQ7CiAgfQogIGNsZWFyU2VsZWN0aW9uKCkgewogICAgZm9yICh2YXIgdCBvZiB0aGlzLnNlbGVjdGlvbigpKQogICAgICB0LmNsZWFySGlnaGxpZ2h0cygpOwogIH0KICBzZXRNZXRhbG5lc3ModCkgewogICAgdGhpcy5tZXRhbG5lc3MgPSB0LCB0aGlzLl90cmF2ZXJzZSgic2V0TWV0YWxuZXNzIiwgdCk7CiAgfQogIHNldFJvdWdobmVzcyh0KSB7CiAgICB0aGlzLnJvdWdobmVzcyA9IHQsIHRoaXMuX3RyYXZlcnNlKCJzZXRSb3VnaG5lc3MiLCB0KTsKICB9CiAgc2V0VHJhbnNwYXJlbnQodCkgewogICAgdGhpcy50cmFuc3BhcmVudCA9IHQsIHRoaXMuX3RyYXZlcnNlKCJzZXRUcmFuc3BhcmVudCIsIHQpOwogIH0KICBzZXRCbGFja0VkZ2VzKHQpIHsKICAgIHRoaXMuYmxhY2tFZGdlcyA9IHQsIHRoaXMuX3RyYXZlcnNlKCJzZXRCbGFja0VkZ2VzIiwgdCk7CiAgfQogIHNldEJhY2tWaXNpYmxlKHQpIHsKICAgIHRoaXMuYmFja1Zpc2libGUgPSB0LCB0aGlzLl90cmF2ZXJzZSgic2V0QmFja1Zpc2libGUiLCB0KTsKICB9CiAgc2V0RWRnZUNvbG9yKHQpIHsKICAgIHRoaXMuZWRnZV9jb2xvciA9IHQsIHRoaXMuX3RyYXZlcnNlKCJzZXRFZGdlQ29sb3IiLCB0KTsKICB9CiAgc2V0T3BhY2l0eSh0KSB7CiAgICB0aGlzLm9wYWNpdHkgPSB0LCB0aGlzLl90cmF2ZXJzZSgic2V0T3BhY2l0eSIsIHQpOwogIH0KICBzZXRDbGlwSW50ZXJzZWN0aW9uKHQpIHsKICAgIHRoaXMuX3RyYXZlcnNlKCJzZXRDbGlwSW50ZXJzZWN0aW9uIiwgdCk7CiAgfQogIHNldENsaXBQbGFuZXModCkgewogICAgdGhpcy5jbGlwUGxhbmVzID0gdCwgdGhpcy5fdHJhdmVyc2UoInNldENsaXBQbGFuZXMiLCB0KTsKICB9CiAgc2V0UG9seWdvbk9mZnNldCh0KSB7CiAgICB0aGlzLl90cmF2ZXJzZSgic2V0UG9seWdvbk9mZnNldCIsIHQpOwogIH0KICBzZXRaU2NhbGUodCkgewogICAgdGhpcy5fdHJhdmVyc2UoInNldFpTY2FsZSIsIHQpOwogIH0KICBzZXRNaW5aKCkgewogICAgdGhpcy5fdHJhdmVyc2UoInNldE1pbloiKTsKICB9CiAgdXBkYXRlTWF0ZXJpYWxzKCkgewogICAgdGhpcy5fdHJhdmVyc2UoInVwZGF0ZU1hdGVyaWFscyIsICEwKTsKICB9Cn0KZnVuY3Rpb24gcUUoYSwgdCwgZSwgaSwgbikgewogIGNvbnN0IHMgPSAoaSAtIHQpIC8gKGUgLSBhKTsKICByZXR1cm4gbiA8IGEgPyB0IDogbiA+IGUgPyBpIDogcyAqIChuIC0gYSkgKyB0Owp9CmZ1bmN0aW9uIG1nKGEpIHsKICB2YXIgdCA9IGEucmVwbGFjZSgvKFwuXGQqWzEtOV0pMCskLywgIiQxIikucmVwbGFjZSgvXC4wKyQvLCAiIik7CiAgcmV0dXJuIHQgPT09ICItMCIgJiYgKHQgPSAiMCIpLCB0LmluZGV4T2YoIi4iKSA8IDAgJiYgKHQgPSBgJHt0fS4wYCksIHQ7Cn0KY2xhc3MgJEUgZXh0ZW5kcyBsZSB7CiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcykgewogICAgc3VwZXIoKTsKICAgIGNvbnN0IHIgPSB0IC8gZSwgbyA9IHQgLyAyLCBsID0gW10sIGggPSBbXSwgYyA9IFtdOwogICAgdmFyIHUgPSAhMTsKICAgIGZvciAobGV0IFMgPSAwOyBTIDw9IGU7IFMrKykgewogICAgICBjb25zdCB3ID0gLW8gKyBTICogcjsKICAgICAgTWF0aC5hYnModykgPiAxZS0xMCA/IGwucHVzaCgtbywgMCwgdywgbywgMCwgdykgOiAoYy5wdXNoKC1vLCAwLCB3LCBvLCAwLCB3KSwgdSA9ICEwKSwgdSB8fCBjLnB1c2goLW8sIDAsIDAsIG8sIDAsIDApLCB1ID0gITEsIE1hdGguYWJzKHcpID4gMWUtMTAgPyBsLnB1c2godywgMCwgLW8sIHcsIDAsIG8pIDogaC5wdXNoKHcsIDAsIC1vLCB3LCAwLCBvKSwgdSB8fCBoLnB1c2goMCwgMCwgLW8sIDAsIDAsIG8pOwogICAgfQogICAgY29uc3QgZCA9IG5ldyBIdCgpOwogICAgZC5zZXRBdHRyaWJ1dGUoCiAgICAgICJwb3NpdGlvbiIsCiAgICAgIG5ldyB3dChsLCAzKQogICAgKTsKICAgIGNvbnN0IHAgPSBkLmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKSwgZiA9IG5ldyBGbG9hdDMyQXJyYXkocC5jb3VudCk7CiAgICBmb3IgKGxldCBTID0gMDsgUyA8IHAuY291bnQ7IFMgKz0gMikgewogICAgICBjb25zdCB3ID0gcC5nZXRYKFMpLCBUID0gcC5nZXRZKFMpLCBSID0gcC5nZXRaKFMpLCBiID0gcC5nZXRYKFMgKyAxKSwgTSA9IHAuZ2V0WShTICsgMSksIEwgPSBwLmdldFooUyArIDEpOwogICAgICBmW1NdID0gMCwgZltTICsgMV0gPSBNYXRoLnNxcnQoCiAgICAgICAgKGIgLSB3KSAqKiAyICsgKE0gLSBUKSAqKiAyICsgKEwgLSBSKSAqKiAyCiAgICAgICk7CiAgICB9CiAgICBkLnNldEF0dHJpYnV0ZSgKICAgICAgImxpbmVEaXN0YW5jZSIsCiAgICAgIG5ldyBpZShmLCAxKQogICAgKTsKICAgIGNvbnN0IHkgPSBuZXcgS3AoewogICAgICBjb2xvcjogcywKICAgICAgZGFzaFNpemU6IHIgLyAyMCwKICAgICAgZ2FwU2l6ZTogciAvIDIwLAogICAgICBvcGFjaXR5OiAxLAogICAgICB0cmFuc3BhcmVudDogITEsCiAgICAgIHZlcnRleENvbG9yczogITEKICAgIH0pLCBnID0gbmV3IG9pKGQsIHkpOwogICAgdGhpcy5hZGQoZyk7CiAgICBjb25zdCBtID0gbmV3IEh0KCk7CiAgICBtLnNldEF0dHJpYnV0ZSgKICAgICAgInBvc2l0aW9uIiwKICAgICAgbmV3IHd0KGgsIDMpCiAgICApOwogICAgY29uc3QgdiA9IG5ldyBQZSh7IGNvbG9yOiBpIH0pOwogICAgdGhpcy5hZGQobmV3IG9pKG0sIHYpKTsKICAgIGNvbnN0IHggPSBuZXcgSHQoKTsKICAgIHguc2V0QXR0cmlidXRlKAogICAgICAicG9zaXRpb24iLAogICAgICBuZXcgd3QoYywgMykKICAgICk7CiAgICBjb25zdCBfID0gbmV3IFBlKHsgY29sb3I6IG4gfSk7CiAgICB0aGlzLmFkZChuZXcgb2koeCwgXykpOwogIH0KfQpjbGFzcyBYRSBleHRlbmRzIHlpIHsKICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKSB7CiAgICBzdXBlcigpLCBpID09PSB2b2lkIDAgJiYgKGkgPSA1KSwgdGhpcy50aWNrcyA9IGksIHRoaXMuZ3JpZEZvbnRTaXplID0gbiwgdGhpcy52aWV3ZXIgPSB0LCB0aGlzLmJib3ggPSBlLCB0aGlzLmNlbnRlckdyaWQgPSBzLCB0aGlzLmF4ZXMwID0gciwgdGhpcy5ncmlkID0gbywgdGhpcy5hbGxHcmlkID0gb1swXSB8IG9bMV0gfCBvWzJdLCB0aGlzLnRoZW1lID0gaCwgdGhpcy5mbGlwWSA9IGwsIHRoaXMubGFzdFpvb21JbmRleCA9IDAsIHRoaXMubGFzdEZvbnRJbmRleCA9IDUwLCB0aGlzLnRpY2tWYWx1ZSA9IHRoaXMudmlld2VyLmRpc3BsYXkuX2dldEVsZW1lbnQoInRjdl90aWNrX3NpemVfdmFsdWUiKSwgdGhpcy5pbmZvID0gdGhpcy52aWV3ZXIuZGlzcGxheS5fZ2V0RWxlbWVudCgidGN2X3RpY2tfc2l6ZSIpOwogICAgY29uc3QgYyA9IGUubWF4X2Rpc3RfZnJvbV9jZW50ZXIoKSwgdSA9IE1hdGgubWluKHRoaXMudmlld2VyLmNhZFdpZHRoLCB0aGlzLnZpZXdlci5oZWlnaHQpLCBkID0gTWF0aC5tYXgoMSwgNiAtIE1hdGgubG9nMih1IC8gMTAwKSk7CiAgICB0aGlzLm1pbkZvbnRJbmRleCA9IE1hdGgucm91bmQoCiAgICAgIChjIDwgMiA/IDYgOiBjIDwgMWUzID8gNSA6IDMpICogZAogICAgKSwgdGhpcy5taW5ab29tSW5kZXggPSAtNCwgdGhpcy56b29tTWF4SW5kZXggPSA1LCB0aGlzLmNhbnZhc0hlaWdodCA9IDEyOCwgdGhpcy5nZW9tQ2FjaGUgPSB7fSwgdGhpcy50ZXh0dXJlQXNwZWN0UmF0aW9zID0ge30sIHRoaXMubGFiZWxDYWNoZSA9IHt9LCB0aGlzLm1hdGVyaWFsQ2FjaGUgPSB7fSwgdGhpcy5jb2xvcnMgPSB7CiAgICAgIGRhcms6IFsKICAgICAgICAiI2ZmNDUwMCIsCiAgICAgICAgLy8geAogICAgICAgICIjMzJjZDMyIiwKICAgICAgICAvLyB5CiAgICAgICAgIiMzYjllZmYiCiAgICAgICAgLy8gegogICAgICBdLAogICAgICBsaWdodDogWwogICAgICAgICIjZmY0NTAwIiwKICAgICAgICAvLyB4CiAgICAgICAgIiMzMmNkMzIiLAogICAgICAgIC8vIHkKICAgICAgICAiIzNiOWVmZiIKICAgICAgICAvLyB6CiAgICAgIF0KICAgIH0sIHRoaXMuY3JlYXRlKCk7CiAgfQogIGNhbGN1bGF0ZVRleHRTY2FsZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy52aWV3ZXIuY2FtZXJhLmdldENhbWVyYSgpLCBpID0gdGhpcy52aWV3ZXIuaGVpZ2h0LCBuID0gcUUoMzAwLCAwLjgsIDgwMCwgMSwgaSkgKiB0OwogICAgaWYgKHRoaXMudmlld2VyLm9ydGhvKSB7CiAgICAgIGNvbnN0IHMgPSAoZS50b3AgLSBlLmJvdHRvbSkgLyBlLnpvb20sIHIgPSBpIC8gczsKICAgICAgcmV0dXJuIG4gLyByICogMS42OwogICAgfSBlbHNlCiAgICAgIHJldHVybiBuIC8gaSAqIDAuNjsKICB9CiAgc2NhbGVMYWJlbHMoKSB7CiAgICBmb3IgKHZhciB0IGluIHRoaXMuY2hpbGRyZW4pCiAgICAgIGZvciAodmFyIGUgPSB0aGlzLmNoaWxkcmVuW3RdLCBpID0gMTsgaSA8IGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBzID0gZS5jaGlsZHJlbltpXTsKICAgICAgICB2YXIgbiA9IHRoaXMuY2FsY3VsYXRlVGV4dFNjYWxlKHRoaXMuZ3JpZEZvbnRTaXplKTsKICAgICAgICBjb25zdCByID0gcy51c2VyRGF0YS5hc3BlY3RSYXRpbyB8fCA0OwogICAgICAgIHMuc2NhbGUuc2V0KG4gKiByLCBuLCAxKTsKICAgICAgfQogIH0KICBzaG93TGFiZWxzKHQpIHsKICAgIGZvciAodmFyIGUgaW4gdGhpcy5jaGlsZHJlbikKICAgICAgZm9yICh2YXIgaSA9IHRoaXMuY2hpbGRyZW5bZV0sIG4gPSAxOyBuIDwgaS5jaGlsZHJlbi5sZW5ndGg7IG4rKykgewogICAgICAgIGNvbnN0IHMgPSBpLmNoaWxkcmVuW25dOwogICAgICAgIHMudmlzaWJsZSA9IHQ7CiAgICAgIH0KICB9CiAgYXN5bmMgdXBkYXRlKHQsIGUgPSAhMSwgaSA9IG51bGwpIHsKICAgIGlmICghdGhpcy5nZXRWaXNpYmxlKCkpIHJldHVybjsKICAgIGkgJiYgKHRoaXMudGhlbWUgPSBpKTsKICAgIHZhciBuID0gTWF0aC5yb3VuZChNYXRoLmxvZzIoMC40ICogdCkpOwogICAgaWYgKE1hdGguYWJzKG4pIDwgMWUtNiAmJiAobiA9IDApLCBlIHx8IG4gIT0gdGhpcy5sYXN0Wm9vbUluZGV4ICYmIG4gPCB0aGlzLnpvb21NYXhJbmRleCAmJiBuID4gdGhpcy5taW5ab29tSW5kZXgpIHsKICAgICAgbWUodGhpcy5jaGlsZHJlbiksIHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgICAgY29uc3QgciA9IHRoaXMudGlja3MwIC8gMiAqIDIgKiogbjsKICAgICAgdGhpcy50aWNrcyA9IE1hdGgucm91bmQoMiAqIHIpLCBhd2FpdCB0aGlzLmNyZWF0ZSghMSksIHRoaXMubGFzdFpvb21JbmRleCA9IG4sIGUgPSAhMDsKICAgIH0KICAgIGNvbnN0IHMgPSBNYXRoLnJvdW5kKHQgKiA1MCk7CiAgICAoZSB8fCBzICE9IHRoaXMubGFzdEZvbnRJbmRleCkgJiYgKHMgPCB0aGlzLm1pbkZvbnRJbmRleCA/IHRoaXMuc2hvd0xhYmVscyghMSkgOiAodGhpcy52aWV3ZXIub3J0aG8gJiYgdGhpcy5zY2FsZUxhYmVscygpLCB0aGlzLnNob3dMYWJlbHMoITApKSwgdGhpcy5sYXN0Rm9udEluZGV4ID0gcyk7CiAgfQogIGFzeW5jIGNyZWF0ZSh0ID0gITApIHsKICAgIGlmICh0KSB7CiAgICAgIGNvbnN0IGMgPSBNYXRoLm1heCgKICAgICAgICBNYXRoLmFicyh0aGlzLmJib3gubWF4LngpLAogICAgICAgIE1hdGguYWJzKHRoaXMuYmJveC5tYXgueSksCiAgICAgICAgTWF0aC5hYnModGhpcy5iYm94Lm1heC56KSwKICAgICAgICBNYXRoLmFicyh0aGlzLmJib3gubWluLngpLAogICAgICAgIE1hdGguYWJzKHRoaXMuYmJveC5taW4ueSksCiAgICAgICAgTWF0aC5hYnModGhpcy5iYm94Lm1pbi56KQogICAgICApOwogICAgICB2YXIgW2UsIGksIG5dID0gdGhpcy5uaWNlQm91bmRzKAogICAgICAgIC1jICogMS4wNSwKICAgICAgICBjICogMS4wNSwKICAgICAgICB0aGlzLnRpY2tzCiAgICAgICk7CiAgICAgIHRoaXMuc2l6ZSA9IGkgLSBlLCB0aGlzLnRpY2tzID0gdGhpcy5zaXplIC8gbiwgdGhpcy50aWNrczAgPSB0aGlzLnRpY2tzLCB0aGlzLmRlbHRhID0gbjsKICAgIH0gZWxzZQogICAgICB0aGlzLmRlbHRhID0gdGhpcy5zaXplIC8gdGhpcy50aWNrczsKICAgIHRoaXMuc2V0VGlja0luZm8odGhpcy5kZWx0YSAvIDIpOwogICAgZm9yICh2YXIgcyA9IDA7IHMgPCAzOyBzKyspIHsKICAgICAgdmFyIHIgPSBuZXcgeWkoKTsKICAgICAgci5uYW1lID0gYEdyaWRIZWxwZXItJHtzfWAsIHIuYWRkKAogICAgICAgIG5ldyAkRSgKICAgICAgICAgIHRoaXMuc2l6ZSwKICAgICAgICAgIDIgKiB0aGlzLnRpY2tzLAogICAgICAgICAgdGhpcy5jb2xvcnNbdGhpcy50aGVtZV1bcyA9PT0gMCA/IDEgOiBzID09PSAxID8gMCA6IDJdLAogICAgICAgICAgdGhpcy5jb2xvcnNbdGhpcy50aGVtZV1bcyA9PT0gMCA/IDAgOiBzID09PSAxID8gMiA6IDFdLAogICAgICAgICAgdGhpcy50aGVtZSA9PSAiZGFyayIgPyAxMjUyNjk4NzkgOiAxMjMwMzI5MQogICAgICAgICkKICAgICAgKTsKICAgICAgZm9yICh2YXIgbywgbCA9IC10aGlzLnNpemUgLyAyOyBsIDw9IHRoaXMuc2l6ZSAvIDI7IGwgKz0gdGhpcy5kZWx0YSAvIDIpCiAgICAgICAgaWYgKCEoTWF0aC5hYnMobCkgPCAxZS02KSkgewogICAgICAgICAgdmFyIGggPSBtZyhsLnRvRml4ZWQoNCkpOwogICAgICAgICAgbCA+IDAgJiYgKGggPSAiKyIgKyBoKSwgbyA9IHRoaXMuY3JlYXRlTGFiZWwoaCwgbCwgcywgITApLCByLmFkZChvKSwgbyA9IHRoaXMuY3JlYXRlTGFiZWwoaCwgbCwgcywgITEpLCByLmFkZChvKTsKICAgICAgICB9CiAgICAgIHRoaXMuYWRkKHIpOwogICAgfQogICAgdGhpcy5jaGlsZHJlblswXS5yb3RhdGVYKE1hdGguUEkgLyAyKSwgdGhpcy5jaGlsZHJlblsxXS5yb3RhdGVZKE1hdGguUEkgLyAyKSwgdGhpcy5jaGlsZHJlblsyXS5yb3RhdGVaKE1hdGguUEkgLyAyKSwgdGhpcy5zZXRDZW50ZXIodGhpcy5heGVzMCwgdGhpcy5mbGlwWSksIHRoaXMuc2NhbGVMYWJlbHMoKSwgdGhpcy5zZXRDZW50ZXIodGhpcy52aWV3ZXIuYXhlczAsIHRoaXMuZmxpcFkpLCB0aGlzLnNldFZpc2libGUoKTsKICB9CiAgY3JlYXRlVGV4dFRleHR1cmUodCkgewogICAgaWYgKHRoaXMuZ2VvbUNhY2hlW3RdKQogICAgICByZXR1cm4gdGhpcy5nZW9tQ2FjaGVbdF07CiAgICBjb25zdCBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksIGkgPSBlLmdldENvbnRleHQoIjJkIiwgewogICAgICBhbHBoYTogITAsCiAgICAgIGRlc3luY2hyb25pemVkOiAhMSwKICAgICAgd2lsbFJlYWRGcmVxdWVudGx5OiAhMQogICAgfSksIG4gPSA4MCwgcyA9IDEyLCBvID0gYCR7dGhpcy50aGVtZSA9PT0gImRhcmsiID8gIjUwMCIgOiAiNTYwIn0gJHtufXB4IFZlcmRhbmEsIEFyaWFsLCBzYW5zLXNlcmlmYDsKICAgIGkuZm9udCA9IG87CiAgICBjb25zdCBoID0gaS5tZWFzdXJlVGV4dCh0KS53aWR0aCwgdSA9IE1hdGgucm91bmQoaCArIDIwICogMiksIGQgPSB0aGlzLmNhbnZhc0hlaWdodDsKICAgIGUud2lkdGggPSB1LCBlLmhlaWdodCA9IGQsIGkudGV4dFJlbmRlcmluZyA9ICJvcHRpbWl6ZUxlZ2liaWxpdHkiLCBpLmZvbnQgPSBvLCBpLnRleHRBbGlnbiA9ICJjZW50ZXIiLCBpLnRleHRCYXNlbGluZSA9ICJtaWRkbGUiLCBpLmNsZWFyUmVjdCgwLCAwLCBlLndpZHRoLCBlLmhlaWdodCk7CiAgICBjb25zdCBwID0gZS53aWR0aCAvIDIsIGYgPSBlLmhlaWdodCAvIDI7CiAgICBpLmxpbmVXaWR0aCA9IHMsIGkubGluZUpvaW4gPSAicm91bmQiLCBpLm1pdGVyTGltaXQgPSAyLCBpLnN0cm9rZVN0eWxlID0gdGhpcy50aGVtZSA9PT0gImRhcmsiID8gIiM0NDQ0NDQiIDogIiNmZmZmZmYiLCBpLnN0cm9rZVRleHQodCwgcCwgZiksIGkuZmlsbFN0eWxlID0gdGhpcy50aGVtZSA9PT0gImRhcmsiID8gIiNhYWFhYWEiIDogIiMzMzMzMzMiLCBpLmZpbGxUZXh0KHQsIHAsIGYpOwogICAgY29uc3QgeSA9IG5ldyBVeShlKTsKICAgIHJldHVybiB5Lm5lZWRzVXBkYXRlID0gITAsIHkuY29sb3JTcGFjZSA9IHRoaXMudGhlbWUgPT09ICJkYXJrIiA/IHJpIDogQ3MsIHkubWluRmlsdGVyID0gQ2UsIHkubWFnRmlsdGVyID0gQ2UsIHkuZ2VuZXJhdGVNaXBtYXBzID0gITEsIHkuYW5pc290cm9weSA9IHRoaXMudmlld2VyLnJlbmRlcmVyLmNhcGFiaWxpdGllcy5nZXRNYXhBbmlzb3Ryb3B5KCksIHkucHJlbXVsdGlwbHlBbHBoYSA9ICExLCB5LndyYXBTID0gU2ksIHkud3JhcFQgPSBTaSwgdGhpcy5nZW9tQ2FjaGVbdF0gPSB5LCB0aGlzLnRleHR1cmVBc3BlY3RSYXRpb3NbdF0gPSB1IC8gZCwgeTsKICB9CiAgY3JlYXRlTGFiZWwodCwgZSwgaSwgbikgewogICAgY29uc3QgcyA9IGAke3R9XyR7aX1fJHtufWA7CiAgICBpZiAodGhpcy5sYWJlbENhY2hlW3NdKSB7CiAgICAgIGNvbnN0IHAgPSB0aGlzLmxhYmVsQ2FjaGVbc10sIGYgPSBuZXcgbWMocC5tYXRlcmlhbCk7CiAgICAgIHJldHVybiBmLnBvc2l0aW9uLmNvcHkocC5wb3NpdGlvbiksIGYuc2NhbGUuY29weShwLnNjYWxlKSwgZi51c2VyRGF0YS5hc3BlY3RSYXRpbyA9IHAudXNlckRhdGEuYXNwZWN0UmF0aW8sIGY7CiAgICB9CiAgICBjb25zdCByID0gdGhpcy5jcmVhdGVUZXh0VGV4dHVyZSh0KTsKICAgIGxldCBvID0gMDsKICAgIGkgPT09IDAgPyBvID0gMCA6IGkgPT09IDEgPyBvID0gbiA/IE1hdGguUEkgLyAyIDogMCA6IG8gPSBuID8gMCA6IE1hdGguUEkgLyAyOwogICAgY29uc3QgbCA9IGAke3R9XyR7aX1fJHtufWA7CiAgICBsZXQgaCA9IHRoaXMubWF0ZXJpYWxDYWNoZVtsXTsKICAgIGggfHwgKGggPSBuZXcgV2MoewogICAgICBtYXA6IHIsCiAgICAgIHRyYW5zcGFyZW50OiAhMCwKICAgICAgZGVwdGhUZXN0OiAhMCwKICAgICAgZGVwdGhXcml0ZTogITEsCiAgICAgIGJsZW5kaW5nOiB3cywKICAgICAgcm90YXRpb246IG8sCiAgICAgIHNpemVBdHRlbnVhdGlvbjogITEKICAgICAgLy8gRGlzYWJsZSBkaXN0YW5jZSBzY2FsaW5nIC0gbWFpbnRhaW4gY29uc3RhbnQgc2NyZWVuIHNpemUKICAgIH0pLCB0aGlzLm1hdGVyaWFsQ2FjaGVbbF0gPSBoKTsKICAgIGNvbnN0IGMgPSBuZXcgbWMoaCk7CiAgICBsZXQgdTsKICAgIGkgPT09IDAgPyB1ID0gbiA/IDEgOiAtMSA6IGkgPT09IDEgPyB1ID0gbiA/IC0xIDogMSA6IHUgPSAxLCBuID8gYy5wb3NpdGlvbi5zZXQodSAqIGUsIDAsIDApIDogYy5wb3NpdGlvbi5zZXQoMCwgMCwgdSAqIGUpOwogICAgY29uc3QgZCA9IHRoaXMudGV4dHVyZUFzcGVjdFJhdGlvc1t0XSB8fCA0OwogICAgcmV0dXJuIGMuc2NhbGUuc2V0KGQsIDEsIDEpLCBjLnVzZXJEYXRhLmFzcGVjdFJhdGlvID0gZCwgdGhpcy5sYWJlbENhY2hlW3NdID0gYywgYzsKICB9CiAgLy8gQ2FsY3VsYXRlIG5pY2Ugc3ltbWV0cmljIGdyaWQgYm91bmRzIGNlbnRlcmVkIGF0IHplcm8KICAvLyBudW1UaWNrczogZGVzaXJlZCBudW1iZXIgb2YgdGlja3MgaW4gb25lIGRpcmVjdGlvbiAoZnJvbSAwIHRvIG1heCkKICBuaWNlQm91bmRzKHQsIGUsIGkpIHsKICAgIGkgfHwgKGkgPSA4KTsKICAgIGNvbnN0IG4gPSBNYXRoLm1heChNYXRoLmFicyh0KSwgTWF0aC5hYnMoZSkpOwogICAgaWYgKG4gPT09IDApCiAgICAgIHJldHVybiBbMCwgMCwgMF07CiAgICBjb25zdCBzID0gbiAvIGksIHIgPSBNYXRoLmZsb29yKE1hdGgubG9nMTAocykpLCBvID0gTWF0aC5wb3coMTAsIHIpLCBsID0gcyAvIG87CiAgICBsZXQgaDsKICAgIGwgPD0gMSA/IGggPSAxIDogbCA8PSAyID8gaCA9IDIgOiBsIDw9IDIuNSA/IGggPSAyLjUgOiBsIDw9IDUgPyBoID0gNSA6IGggPSAxMDsKICAgIGNvbnN0IGMgPSBoICogbywgdSA9IE1hdGguY2VpbChuIC8gYyksIGQgPSBjICogdTsKICAgIHJldHVybiBbLWQsIGQsIGNdOwogIH0KICBjb21wdXRlR3JpZCgpIHsKICAgIHRoaXMuYWxsR3JpZCA9IHRoaXMuZ3JpZFswXSB8IHRoaXMuZ3JpZFsxXSB8IHRoaXMuZ3JpZFsyXSwgdGhpcy52aWV3ZXIuZGlzcGxheS50b29sYmFyQnV0dG9ucy5ncmlkLnNldCh0aGlzLmFsbEdyaWQpLCB0aGlzLnZpZXdlci5kaXNwbGF5LmNoZWNrRWxlbWVudCgidGN2X2dyaWQteHkiLCB0aGlzLmdyaWRbMF0pLCB0aGlzLnZpZXdlci5kaXNwbGF5LmNoZWNrRWxlbWVudCgidGN2X2dyaWQteHoiLCB0aGlzLmdyaWRbMV0pLCB0aGlzLnZpZXdlci5kaXNwbGF5LmNoZWNrRWxlbWVudCgidGN2X2dyaWQteXoiLCB0aGlzLmdyaWRbMl0pLCB0aGlzLnNldFZpc2libGUoKTsKICB9CiAgc2V0R3JpZCh0LCBlID0gbnVsbCkgewogICAgc3dpdGNoICh0KSB7CiAgICAgIGNhc2UgImdyaWQiOgogICAgICAgIHRoaXMuYWxsR3JpZCA9IGUgPz8gIXRoaXMuYWxsR3JpZCwgdGhpcy5ncmlkWzBdID0gdGhpcy5hbGxHcmlkLCB0aGlzLmdyaWRbMV0gPSB0aGlzLmFsbEdyaWQsIHRoaXMuZ3JpZFsyXSA9IHRoaXMuYWxsR3JpZDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZ3JpZC14eSI6CiAgICAgICAgdGhpcy5ncmlkWzBdID0gIXRoaXMuZ3JpZFswXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZ3JpZC14eiI6CiAgICAgICAgdGhpcy5ncmlkWzFdID0gIXRoaXMuZ3JpZFsxXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZ3JpZC15eiI6CiAgICAgICAgdGhpcy5ncmlkWzJdID0gIXRoaXMuZ3JpZFsyXTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuY29tcHV0ZUdyaWQoKTsKICB9CiAgc2V0R3JpZHModCwgZSwgaSkgewogICAgdGhpcy5ncmlkWzBdID0gdCwgdGhpcy5ncmlkWzFdID0gZSwgdGhpcy5ncmlkWzJdID0gaSwgdGhpcy5jb21wdXRlR3JpZCgpOwogIH0KICBzZXRDZW50ZXIodCwgZSkgewogICAgY29uc3QgaSA9IHQgPyBbMCwgMCwgMF0gOiB0aGlzLmJib3guY2VudGVyKCk7CiAgICB0aGlzLmNoaWxkcmVuLmZvckVhY2goKG4pID0+IG4ucG9zaXRpb24uc2V0KC4uLmkpKSwgdGhpcy5jZW50ZXJHcmlkIHx8ICh0aGlzLmNoaWxkcmVuWzBdLnBvc2l0aW9uLnogLT0gdGhpcy5zaXplIC8gMiwgdGhpcy5jaGlsZHJlblsxXS5wb3NpdGlvbi55IC09IChlID8gLTEgOiAxKSAqIHRoaXMuc2l6ZSAvIDIsIHRoaXMuY2hpbGRyZW5bMl0ucG9zaXRpb24ueCAtPSB0aGlzLnNpemUgLyAyKTsKICB9CiAgc2V0VmlzaWJsZSgpIHsKICAgIHRoaXMuY2hpbGRyZW4uZm9yRWFjaCgodCwgZSkgPT4gewogICAgICB0LnZpc2libGUgPSB0aGlzLmdyaWRbZV07CiAgICB9KSwgdGhpcy5hbGxHcmlkID8gdGhpcy5pbmZvLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siIDogdGhpcy5pbmZvLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfQogIHNldFRpY2tJbmZvKCkgewogICAgdGhpcy50aWNrVmFsdWUuaW5uZXJUZXh0ID0gbWcoKHRoaXMuZGVsdGEgLyAyKS50b0ZpeGVkKDQpKTsKICB9CiAgZ2V0VmlzaWJsZSgpIHsKICAgIHJldHVybiB0aGlzLmFsbEdyaWQ7CiAgfQogIGNsZWFyQ2FjaGUoKSB7CiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5nZW9tQ2FjaGUpLmxlbmd0aCA+IDApIHsKICAgICAgZm9yICh2YXIgdCBvZiBPYmplY3Qua2V5cyh0aGlzLmdlb21DYWNoZSkpCiAgICAgICAgdGhpcy5nZW9tQ2FjaGVbdF0uZGlzcG9zZSgpOwogICAgICB0aGlzLmdlb21DYWNoZSA9IHt9OwogICAgfQogICAgaWYgKHRoaXMudGV4dHVyZUFzcGVjdFJhdGlvcyA9IHt9LCB0aGlzLm1hdGVyaWFsQ2FjaGUgJiYgT2JqZWN0LmtleXModGhpcy5tYXRlcmlhbENhY2hlKS5sZW5ndGggPiAwKSB7CiAgICAgIGZvciAodmFyIHQgb2YgT2JqZWN0LmtleXModGhpcy5tYXRlcmlhbENhY2hlKSkKICAgICAgICB0aGlzLm1hdGVyaWFsQ2FjaGVbdF0uZGlzcG9zZSgpOwogICAgICB0aGlzLm1hdGVyaWFsQ2FjaGUgPSB7fTsKICAgIH0KICAgIE9iamVjdC5rZXlzKHRoaXMubGFiZWxDYWNoZSkubGVuZ3RoID4gMCAmJiAodGhpcy5sYWJlbENhY2hlID0ge30pOwogIH0KICBkaXNwb3NlKCkgewogICAgdGhpcy5jbGVhckNhY2hlKCk7CiAgfQp9CmNsYXNzIHpfIGV4dGVuZHMgbWYgewogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwpIHsKICAgIGNvbnN0IGggPSBuZXcgRmxvYXQzMkFycmF5KFsKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgZQogICAgXSksIGMgPSBuZXcgQl8oKTsKICAgIGMuc2V0UG9zaXRpb25zKGgpOwogICAgY29uc3QgdSA9IG5ldyBodSh7CiAgICAgIHZlcnRleENvbG9yczogITAsCiAgICAgIHRvbmVNYXBwZWQ6ICExLAogICAgICBsaW5ld2lkdGg6IGksCiAgICAgIHRyYW5zcGFyZW50OiAhMAogICAgfSk7CiAgICB1LnJlc29sdXRpb24uc2V0KG4sIHMpLCBzdXBlcihjLCB1KSwgdGhpcy5jb2xvcnMgPSB7CiAgICAgIGRhcms6IFsKICAgICAgICAxLAogICAgICAgIDY5IC8gMjU1LAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICA2OSAvIDI1NSwKICAgICAgICAwLAogICAgICAgIC8vIHgKICAgICAgICA1MCAvIDI1NSwKICAgICAgICAyMDUgLyAyNTUsCiAgICAgICAgNTAgLyAyNTUsCiAgICAgICAgNTAgLyAyNTUsCiAgICAgICAgMjA1IC8gMjU1LAogICAgICAgIDUwIC8gMjU1LAogICAgICAgIC8vIHkKICAgICAgICA1OSAvIDI1NSwKICAgICAgICAxNTggLyAyNTUsCiAgICAgICAgMSwKICAgICAgICA1OSAvIDI1NSwKICAgICAgICAxNTggLyAyNTUsCiAgICAgICAgMQogICAgICAgIC8vIHoKICAgICAgXSwKICAgICAgbGlnaHQ6IFsKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAvLyB4CiAgICAgICAgMCwKICAgICAgICAwLjcsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAuNywKICAgICAgICAwLAogICAgICAgIC8vIHkKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMQogICAgICAgIC8vIHoKICAgICAgXQogICAgfSwgYy5zZXRDb2xvcnMobmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbG9yc1tsXSkpLCB0aGlzLmdlb21ldHJ5ID0gYywgdGhpcy5jZW50ZXIgPSB0LCB0aGlzLnR5cGUgPSAiQXhlc0hlbHBlciIsIHRoaXMubmFtZSA9ICJBeGVzSGVscGVyIiwgdGhpcy52aXNpYmxlID0gbywgdGhpcy5zZXRDZW50ZXIocik7CiAgfQogIHNldENlbnRlcih0KSB7CiAgICB0ID8gdGhpcy5wb3NpdGlvbi5zZXQoMCwgMCwgMCkgOiB0aGlzLnBvc2l0aW9uLnNldCguLi50aGlzLmNlbnRlcik7CiAgfQogIHNldFZpc2libGUodCkgewogICAgdGhpcy52aXNpYmxlID0gdDsKICB9CiAgY2hhbmdlVGhlbWUodCkgewogICAgdGhpcy5nZW9tZXRyeS5zZXRDb2xvcnMobmV3IEZsb2F0MzJBcnJheSh0aGlzLmNvbG9yc1t0XSkpOwogIH0KfQpjbGFzcyBZRSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyBmb250LgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBUaGUgZm9udCBkYXRhIGFzIEpTT04uCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgdGhpcy5pc0ZvbnQgPSAhMCwgdGhpcy50eXBlID0gIkZvbnQiLCB0aGlzLmRhdGEgPSB0OwogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgZ2VvbWV0cnkgc2hhcGVzIGZyb20gdGhlIGdpdmVuIHRleHQgYW5kIHNpemUuIFRoZSByZXN1bHQgb2YgdGhpcyBtZXRob2QKICAgKiBzaG91bGQgYmUgdXNlZCB3aXRoIHtAbGluayBTaGFwZUdlb21ldHJ5fSB0byBnZW5lcmF0ZSB0aGUgYWN0dWFsIGdlb21ldHJ5IGRhdGEuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSB0ZXh0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xMDBdIC0gVGhlIHRleHQgc2l6ZS4KICAgKiBAcmV0dXJuIHtBcnJheTxTaGFwZT59IEFuIGFycmF5IG9mIHNoYXBlcyByZXByZXNlbnRpbmcgdGhlIHRleHQuCiAgICovCiAgZ2VuZXJhdGVTaGFwZXModCwgZSA9IDEwMCkgewogICAgY29uc3QgaSA9IFtdLCBuID0gWkUodCwgZSwgdGhpcy5kYXRhKTsKICAgIGZvciAobGV0IHMgPSAwLCByID0gbi5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgIGkucHVzaCguLi5uW3NdLnRvU2hhcGVzKCkpOwogICAgcmV0dXJuIGk7CiAgfQp9CmZ1bmN0aW9uIFpFKGEsIHQsIGUpIHsKICBjb25zdCBpID0gQXJyYXkuZnJvbShhKSwgbiA9IHQgLyBlLnJlc29sdXRpb24sIHMgPSAoZS5ib3VuZGluZ0JveC55TWF4IC0gZS5ib3VuZGluZ0JveC55TWluICsgZS51bmRlcmxpbmVUaGlja25lc3MpICogbiwgciA9IFtdOwogIGxldCBvID0gMCwgbCA9IDA7CiAgZm9yIChsZXQgaCA9IDA7IGggPCBpLmxlbmd0aDsgaCsrKSB7CiAgICBjb25zdCBjID0gaVtoXTsKICAgIGlmIChjID09PSBgCmApCiAgICAgIG8gPSAwLCBsIC09IHM7CiAgICBlbHNlIHsKICAgICAgY29uc3QgdSA9IGpFKGMsIG4sIG8sIGwsIGUpOwogICAgICBvICs9IHUub2Zmc2V0WCwgci5wdXNoKHUucGF0aCk7CiAgICB9CiAgfQogIHJldHVybiByOwp9CmZ1bmN0aW9uIGpFKGEsIHQsIGUsIGksIG4pIHsKICBjb25zdCBzID0gbi5nbHlwaHNbYV0gfHwgbi5nbHlwaHNbIj8iXTsKICBpZiAoIXMpIHsKICAgIGNvbnNvbGUuZXJyb3IoJ1RIUkVFLkZvbnQ6IGNoYXJhY3RlciAiJyArIGEgKyAnIiBkb2VzIG5vdCBleGlzdHMgaW4gZm9udCBmYW1pbHkgJyArIG4uZmFtaWx5TmFtZSArICIuIik7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHIgPSBuZXcgYl8oKTsKICBsZXQgbywgbCwgaCwgYywgdSwgZCwgcCwgZjsKICBpZiAocy5vKSB7CiAgICBjb25zdCB5ID0gcy5fY2FjaGVkT3V0bGluZSB8fCAocy5fY2FjaGVkT3V0bGluZSA9IHMuby5zcGxpdCgiICIpKTsKICAgIGZvciAobGV0IGcgPSAwLCBtID0geS5sZW5ndGg7IGcgPCBtOyApCiAgICAgIHN3aXRjaCAoeVtnKytdKSB7CiAgICAgICAgY2FzZSAibSI6CiAgICAgICAgICBvID0geVtnKytdICogdCArIGUsIGwgPSB5W2crK10gKiB0ICsgaSwgci5tb3ZlVG8obywgbCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJsIjoKICAgICAgICAgIG8gPSB5W2crK10gKiB0ICsgZSwgbCA9IHlbZysrXSAqIHQgKyBpLCByLmxpbmVUbyhvLCBsKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInEiOgogICAgICAgICAgaCA9IHlbZysrXSAqIHQgKyBlLCBjID0geVtnKytdICogdCArIGksIHUgPSB5W2crK10gKiB0ICsgZSwgZCA9IHlbZysrXSAqIHQgKyBpLCByLnF1YWRyYXRpY0N1cnZlVG8odSwgZCwgaCwgYyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJiIjoKICAgICAgICAgIGggPSB5W2crK10gKiB0ICsgZSwgYyA9IHlbZysrXSAqIHQgKyBpLCB1ID0geVtnKytdICogdCArIGUsIGQgPSB5W2crK10gKiB0ICsgaSwgcCA9IHlbZysrXSAqIHQgKyBlLCBmID0geVtnKytdICogdCArIGksIHIuYmV6aWVyQ3VydmVUbyh1LCBkLCBwLCBmLCBoLCBjKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgfQogIHJldHVybiB7IG9mZnNldFg6IHMuaGEgKiB0LCBwYXRoOiByIH07Cn0KY29uc3QgSkUgPSB7CiAgZ2x5cGhzOiB7CiAgICBYOiB7CiAgICAgIHhfbWluOiAtMC4wMTU2MjUsCiAgICAgIHhfbWF4OiA4NTQuMTU2MjUsCiAgICAgIGhhOiA5NDAsCiAgICAgIG86ICJtIDg1NCAwIGwgNjgzIDAgbCA0MjMgNDA5IGwgMTY2IDAgbCAwIDAgbCAzNDcgNTE5IGwgMTggMTAxMyBsIDE4NiAxMDEzIGwgNDI4IDYzNyBsIDY3NSAxMDEzIGwgODM2IDEwMTMgbCA1MDQgNTIwIGwgODU0IDAgIgogICAgfSwKICAgIFk6IHsKICAgICAgeF9taW46IDAsCiAgICAgIHhfbWF4OiA4MjAsCiAgICAgIGhhOiA4ODYsCiAgICAgIG86ICJtIDgyMCAxMDEzIGwgNDgyIDQxNiBsIDQ4MiAwIGwgMzQyIDAgbCAzNDIgNDE2IGwgMCAxMDEzIGwgMTQwIDEwMTMgbCA0MTEgNTM0IGwgNjc5IDEwMTIgbCA4MjAgMTAxMyAiCiAgICB9LAogICAgWjogewogICAgICB4X21pbjogMCwKICAgICAgeF9tYXg6IDc3OSwKICAgICAgaGE6IDg0OSwKICAgICAgbzogIm0gNzc5IDAgbCAwIDAgbCAwIDExMyBsIDYyMSA4OTYgbCA0MCA4OTYgbCA0MCAxMDEzIGwgNzc5IDEwMTMgbCA3NzggODg3IGwgMTcxIDEyNCBsIDc3OSAxMjQgbCA3NzkgMCAiCiAgICB9LAogICAgZTogewogICAgICB4X21pbjogMCwKICAgICAgeF9tYXg6IDcxNCwKICAgICAgaGE6IDgxMywKICAgICAgbzogIm0gNzE0IDMyNiBsIDE0MCAzMjYgcSAyMDAgMTU3IDE0MCAyMjcgcSAzNTkgODcgMjYwIDg3IHEgNDg4IDEzMCA0MzEgODcgcSA1NjEgMjQ1IDU0NSAxNzQgbCA2OTcgMjQ1IHEgNTc3IDQ4IDY3MCAxMjMgcSAzNTggLTI2IDQ4NCAtMjYgcSA5NyA4NSAxOTUgLTI2IHEgMCAzNjMgMCAxOTcgcSA5NCA2NDIgMCA1MjkgcSAzNTggNzY1IDE5NSA3NjUgcSA2MjYgNjI3IDUyOSA3NjUgcSA3MTQgMzI2IDcxNCA1MDMgbSA1NzYgNDI5IHEgNTA3IDU4MyA1NjQgNTIyIHEgMzU1IDY1MCA0NDUgNjUwIHEgMjA2IDU4MyAyNjYgNjUwIHEgMTQwIDQyOSAxNTIgNTIyIGwgNTc2IDQyOSAiCiAgICB9LAogICAgMDogewogICAgICB4X21pbjogNzMsCiAgICAgIHhfbWF4OiA3MTUsCiAgICAgIGhhOiA3OTIsCiAgICAgIG86ICJtIDM5NCAtMjkgcSAxNTMgMTI5IDI0MiAtMjkgcSA3MyA0NzkgNzMgMjcyIHEgMTUyIDgyOSA3MyA2ODcgcSAzOTQgOTg5IDI0MSA5ODkgcSA2MzQgODI5IDU0NSA5ODkgcSA3MTUgNDc5IDcxNSA2ODQgcSA2MzUgMTI5IDcxNSAyNzAgcSAzOTQgLTI5IDU0NiAtMjkgbSAzOTQgODkgcSA1NDYgMjExIDQ4OSA4OSBxIDU5OCA0NzkgNTk4IDMyMiBxIDU0OCA3NDggNTk4IDY0MCBxIDM5NCA4NzEgNDkxIDg3MSBxIDI0MSA3NDggMjk4IDg3MSBxIDE5MCA0NzkgMTkwIDYzNyBxIDIzOSAyMTEgMTkwIDMxOSBxIDM5NCA4OSAyOTYgODkgIgogICAgfSwKICAgIDE6IHsKICAgICAgeF9taW46IDIxNS42NzE4NzUsCiAgICAgIHhfbWF4OiA1NzQsCiAgICAgIGhhOiA3OTIsCiAgICAgIG86ICJtIDU3NCAwIGwgNDQyIDAgbCA0NDIgNjk3IGwgMjE1IDY5NyBsIDIxNSA3OTYgcSAzODYgODMzIDMzMCA3OTYgcSA0NzUgOTg2IDQ0NyA4NzUgbCA1NzQgOTg2IGwgNTc0IDAgIgogICAgfSwKICAgIDI6IHsKICAgICAgeF9taW46IDU5LAogICAgICB4X21heDogNzMxLAogICAgICBoYTogNzkyLAogICAgICBvOiAibSA3MzEgMCBsIDU5IDAgcSAxOTcgMzE0IDU5IDE4OCBxIDQ1NyA0ODcgMTk5IDMxNSBxIDU5OCA2OTEgNTk4IDU4MCBxIDU0MyA4MTkgNTk4IDc3MiBxIDQxMSA4NjcgNDg4IDg2NyBxIDI3MiA4MTEgMzI4IDg2NyBxIDIwOSA2MzAgMjA5IDc0NyBsIDgxIDYzMCBxIDE4MiA5MDEgODEgODA1IHEgNDA4IDk4NiAyNzEgOTg2IHEgNjI5IDkwOSA1MzYgOTg2IHEgNzMxIDY5NCA3MzEgODI2IHEgNjEzIDQ0OSA3MzEgNTQxIHEgMzc4IDMxNiA0OTUgMzgzIHEgMjAxIDEyMiAyMzUgMjM0IGwgNzMxIDEyMiBsIDczMSAwICIKICAgIH0sCiAgICAzOiB7CiAgICAgIHhfbWluOiA1NCwKICAgICAgeF9tYXg6IDczNywKICAgICAgaGE6IDc5MiwKICAgICAgbzogIm0gNzM3IDI4NCBxIDYzNSA1NSA3MzcgMTQxIHEgMzk5IC0yNSA1NDEgLTI1IHEgMTU2IDUyIDI0OCAtMjUgcSA1NCAzMDggNTQgMTQwIGwgMTg1IDMwOCBxIDI0NSAxNDcgMTg1IDIwMiBxIDM5NSA5NiAzMDIgOTYgcSA1MzkgMTQwIDQ4NCA5NiBxIDYwMiAyODAgNjAyIDE5MCBxIDUxMCA0MjkgNjAyIDM5MCBxIDMyNCA0NTQgNDUxIDQ1NCBsIDMyNCA1NjUgcSA0ODcgNTg0IDQ0MSA1NjUgcSA1NjUgNzE5IDU2NSA2MTcgcSA1MTUgODM1IDU2NSA3OTEgcSAzOTUgODc5IDQ2NiA4NzkgcSAyNTUgODI0IDMwNyA4NzkgcSAyMDMgNjYxIDIwMyA3NjkgbCA3OCA2NjEgcSAxNjYgOTA5IDc4IDgyMiBxIDM4NyA5OTIgMjUwIDk5MiBxIDYwMyA5MjEgNTEzIDk5MiBxIDcwMSA3MjMgNzAxIDg0NCBxIDY2OSA2MDcgNzAxIDY1NiBxIDU3OCA1MjQgNjM3IDU1OCBxIDY5NiA0MzQgNjU1IDQ5OSBxIDczNyAyODQgNzM3IDM2OSAiCiAgICB9LAogICAgNDogewogICAgICB4X21pbjogNDgsCiAgICAgIHhfbWF4OiA3NDIuNDUzMTI1LAogICAgICBoYTogNzkyLAogICAgICBvOiAibSA3NDIgMjQzIGwgNjAyIDI0MyBsIDYwMiAwIGwgNDc2IDAgbCA0NzYgMjQzIGwgNDggMjQzIGwgNDggMzY4IGwgNDc2IDk1OCBsIDYwMiA5NTggbCA2MDIgMzU0IGwgNzQyIDM1NCBsIDc0MiAyNDMgbSA0NzYgMzU0IGwgNDc2IDc5MiBsIDE2MiAzNTQgbCA0NzYgMzU0ICIKICAgIH0sCiAgICA1OiB7CiAgICAgIHhfbWluOiA1NC4xNzE4NzUsCiAgICAgIHhfbWF4OiA3MzgsCiAgICAgIGhhOiA3OTIsCiAgICAgIG86ICJtIDczOCAzMTQgcSA2MjYgNjAgNzM4IDE1MyBxIDM4MiAtMjMgNTI2IC0yMyBxIDE1NSA0NyAyNDggLTIzIHEgNTQgMjU2IDU0IDEyNSBsIDE4MyAyNTYgcSAyNTkgMTMyIDIwNCAxNzQgcSAzODIgOTEgMzE0IDkxIHEgNTMzIDE0OSA0NzEgOTEgcSA2MDIgMzE0IDYwMiAyMTMgcSA1MzggNDY5IDYwMiA0MTEgcSAzODYgNTI4IDQ3NSA1MjggcSAyODQgNTA2IDMzMiA1MjggcSAxOTcgNDM5IDIzNyA0ODQgbCA4MSA0MzkgbCAxNTkgOTU4IGwgNjg0IDk1OCBsIDY4NCA4NDAgbCAyNTQgODQwIGwgMjE0IDU3OSBxIDMwNiA2MjcgMjU4IDYxMiBxIDQwNyA2NDMgMzU0IDY0MyBxIDYzNiA1NTIgNTQwIDY0MyBxIDczOCAzMTQgNzM4IDQ1NyAiCiAgICB9LAogICAgNjogewogICAgICB4X21pbjogNTMsCiAgICAgIHhfbWF4OiA3MzksCiAgICAgIGhhOiA3OTIsCiAgICAgIG86ICJtIDczOSAzMTIgcSA2MzMgNjIgNzM5IDE2MiBxIDQwMCAtMzEgNTM0IC0zMSBxIDE2MiA3OCAyNTcgLTMxIHEgNTMgNDM5IDUzIDIwNiBxIDE3OCA4NTkgNTMgNzEyIHEgNDQxIDk4NiAyODQgOTg2IHEgNjQzIDkxMiA1NTkgOTg2IHEgNzMyIDcxMyA3MzIgODMzIGwgNjAxIDcxMyBxIDU0NCA4MzAgNTk0IDc4NiBxIDQyNiA4NzUgNDk0IDg3NSBxIDI2OCA3OTMgMzMxIDg3NSBxIDE5MyA1MTcgMTkzIDY5NyBxIDMwMSA1OTcgMjQwIDU3MCBxIDQyNyA2MjQgMzYyIDYyNCBxIDY0MyA1NDAgNTUyIDYyNCBxIDczOSAzMTIgNzM5IDQ1MSBtIDYwMyAyOTggcSA1NDAgNDYxIDYwMyA0MDAgcSA0MDQgNTE2IDQ4NCA1MTYgcSAyNjggNDYxIDMyMyA1MTYgcSAyMDcgMzAwIDIwNyA0MDEgcSAyNjkgMTM3IDIwNyAxOTggcSA0MDUgODMgMzI1IDgzIHEgNTQxIDEzNyA0ODYgODMgcSA2MDMgMjk4IDYwMyAxOTcgIgogICAgfSwKICAgIDc6IHsKICAgICAgeF9taW46IDU4LjcxODc1LAogICAgICB4X21heDogNzMwLjk1MzEyNSwKICAgICAgaGE6IDc5MiwKICAgICAgbzogIm0gNzMwIDgzOSBxIDQ2OSA0NDggNTYwIDY0MSBxIDMzNSAwIDM3OCAyNTUgbCAxOTIgMCBxIDMyOCA0NDEgMjM1IDI1MiBxIDU5MyA4MzAgNDIxIDYzMCBsIDU4IDgzMCBsIDU4IDk1OCBsIDczMCA5NTggbCA3MzAgODM5ICIKICAgIH0sCiAgICA4OiB7CiAgICAgIHhfbWluOiA1NSwKICAgICAgeF9tYXg6IDczNiwKICAgICAgaGE6IDc5MiwKICAgICAgbzogIm0gNTcxIDUyNyBxIDY5NCA0MjQgNjUyIDQ5MSBxIDczNiAyODAgNzM2IDM1OCBxIDY0OCA3MSA3MzYgMTU4IHEgMzk1IC0yNiA1NTEgLTI2IHEgMTQyIDY5IDIzOCAtMjYgcSA1NSAyNzkgNTUgMTU3IHEgOTYgNDI1IDU1IDM1OSBxIDIyMCA1MjcgMTM4IDQ5MSBxIDEyMCA2MTUgMTUzIDU2MiBxIDg4IDcyNiA4OCA2NjggcSAxNzEgOTA0IDg4IDgyNyBxIDM5NSA5ODYgMjYxIDk4NiBxIDYxOCA5MDUgNTI5IDk4NiBxIDcwMiA3MjcgNzAyIDgzMCBxIDY3MCA2MTYgNzAyIDY2NyBxIDU3MSA1MjcgNjM4IDU2NSBtIDM5NCA1NjUgcSA1MTkgNjEwIDQ3NSA1NjUgcSA1NjMgNzE3IDU2MyA2NTUgcSA1MjEgODIzIDU2MyA3ODEgcSAzOTIgODcyIDQ3NCA4NzIgcSAyNjUgODI0IDMxMiA4NzIgcSAyMjQgNzIwIDIyNCA3ODMgcSAyNjUgNjEzIDIyNCA2NTYgcSAzOTQgNTY1IDMxMiA1NjUgbSAzOTUgOTEgcSA1NDUgMTUwIDQ4OCA5MSBxIDU5NyAyODAgNTk3IDIwNCBxIDU0NiA0MDggNTk3IDM1NSBxIDM5NSA0NjUgNDkyIDQ2NSBxIDI0NCA0MDggMjk5IDQ2NSBxIDE5NCAyODAgMTk0IDM1NiBxIDI0NCAxNTAgMTk0IDIwMyBxIDM5NSA5MSAyOTkgOTEgIgogICAgfSwKICAgIDk6IHsKICAgICAgeF9taW46IDUzLAogICAgICB4X21heDogNzM5LAogICAgICBoYTogNzkyLAogICAgICBvOiAibSA3MzkgNTI0IHEgNjE5IDk0IDczOSAyNDEgcSAzNjIgLTMyIDUxNiAtMzIgcSAxNTAgNDcgMjQyIC0zMiBxIDU5IDI0NCA1OSAxMjYgbCAxOTEgMjQ0IHEgMjQ2IDEyOSAxOTEgMTc2IHEgMzczIDgyIDMwMSA4MiBxIDUyNiAxNjEgNDY2IDgyIHEgNTk3IDQ0MCA1OTcgMjU1IHEgMzYzIDMzNCA1MDEgMzM0IHEgMTMwIDQzMiAyMTYgMzM0IHEgNTMgNjUwIDUzIDUyMSBxIDEzNCA4ODAgNTMgNzg2IHEgMzgzIDk4NiAyMjYgOTg2IHEgNjU5IDg0MSA1NjYgOTg2IHEgNzM5IDUyNCA3MzkgNzE5IG0gMzg4IDQ0OSBxIDUzNSA1MTQgNDgwIDQ0OSBxIDU4NSA2NTggNTg1IDU3MyBxIDUzNSA4MDUgNTg1IDc0NCBxIDM4OCA4NzMgNDgwIDg3MyBxIDI0MiA4MDkgMjk0IDg3MyBxIDE5MSA2NTggMTkxIDc0NSBxIDIzOSA1MTQgMTkxIDU3MiBxIDM4OCA0NDkgMjkyIDQ0OSAiCiAgICB9LAogICAgIisiOiB7CiAgICAgIHhfbWluOiAyMywKICAgICAgeF9tYXg6IDc2OCwKICAgICAgaGE6IDc5MiwKICAgICAgbzogIm0gNzY4IDM3MiBsIDQ0NCAzNzIgbCA0NDQgMCBsIDM0NyAwIGwgMzQ3IDM3MiBsIDIzIDM3MiBsIDIzIDQ2OCBsIDM0NyA0NjggbCAzNDcgODQwIGwgNDQ0IDg0MCBsIDQ0NCA0NjggbCA3NjggNDY4IGwgNzY4IDM3MiAiCiAgICB9LAogICAgIi0iOiB7CiAgICAgIHhfbWluOiA4LjcxODc1LAogICAgICB4X21heDogMzUwLjM5MDYyNSwKICAgICAgaGE6IDQ3OCwKICAgICAgbzogIm0gMzUwIDMxNyBsIDggMzE3IGwgOCA0MjggbCAzNTAgNDI4IGwgMzUwIDMxNyAiCiAgICB9LAogICAgIi4iOiB7CiAgICAgIHhfbWluOiAwLAogICAgICB4X21heDogMTQyLAogICAgICBoYTogMjM5LAogICAgICBvOiAibSAxNDIgMCBsIDAgMCBsIDAgMTUxIGwgMTQyIDE1MSBsIDE0MiAwICIKICAgIH0KICB9LAogIGNzc0ZvbnRXZWlnaHQ6ICJub3JtYWwiLAogIGFzY2VuZGVyOiAxMTg5LAogIHVuZGVybGluZVBvc2l0aW9uOiAtMTAwLAogIGNzc0ZvbnRTdHlsZTogIm5vcm1hbCIsCiAgYm91bmRpbmdCb3g6IHsgeU1pbjogLTMzNCwgeE1pbjogLTExMSwgeU1heDogMTE4OSwgeE1heDogMTY3MiB9LAogIHJlc29sdXRpb246IDFlMywKICBvcmlnaW5hbF9mb250X2luZm9ybWF0aW9uOiAic2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9tcmRvb2IvdGhyZWUuanMvYmxvYi9kZXYvZXhhbXBsZXMvZm9udHMvaGVsdmV0aWtlcl9yZWd1bGFyLnR5cGVmYWNlLmpzb24iLAogIGRlc2NlbmRlcjogLTMzNCwKICBmYW1pbHlOYW1lOiAiSGVsdmV0aWtlciIsCiAgbGluZUhlaWdodDogMTUyMiwKICB1bmRlcmxpbmVUaGlja25lc3M6IDUwCn0sIGFvID0gNTQsIGNkID0gYW8gKyAxODsKY2xhc3MgS0UgewogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4pIHsKICAgIHRoaXMud2lkdGggPSB0LCB0aGlzLmhlaWdodCA9IGUsIHRoaXMuY2FkX2NhbWVyYSA9IGksIHRoaXMudGhlbWUgPSBuLCB0aGlzLmNhbWVyYSA9IG51bGwsIHRoaXMuc2NlbmUgPSBudWxsLCB0aGlzLnJlbmRlcmVyID0gbnVsbCwgdGhpcy5sYWJlbHMgPSBbXSwgdGhpcy5yZWFkeSA9ICExOwogIH0KICBjcmVhdGUoKSB7CiAgICBjb25zdCB0ID0gbmV3IFlFKEpFKSwgZSA9IDIuNTsKICAgIHRoaXMuc2NlbmUgPSBuZXcga28oKSwgdGhpcy5jYW1lcmEgPSBuZXcgSWEoCiAgICAgIC10aGlzLndpZHRoLAogICAgICB0aGlzLndpZHRoLAogICAgICB0aGlzLmhlaWdodCwKICAgICAgLXRoaXMuaGVpZ2h0LAogICAgICAxLAogICAgICAxZTMKICAgICksIHRoaXMuY2FtZXJhLnVwID0gdGhpcy5jYWRfY2FtZXJhLnVwLCB0aGlzLmNhbWVyYS5sb29rQXQobmV3IEUoMCwgMCwgMCkpLCB0aGlzLmF4ZXMgPSBuZXcgel8oCiAgICAgIFswLCAwLCAwXSwKICAgICAgYW8sCiAgICAgIGUsCiAgICAgIHRoaXMud2lkdGgsCiAgICAgIHRoaXMuaGVpZ2h0LAogICAgICAhMCwKICAgICAgITAsCiAgICAgIHRoaXMudGhlbWUKICAgICksIHRoaXMuc2NlbmUuYWRkKHRoaXMuYXhlcyksIHRoaXMuY29sb3JzID0gewogICAgICBkYXJrOiBbCiAgICAgICAgWzEsIDY5IC8gMjU1LCAwXSwKICAgICAgICBbNTAgLyAyNTUsIDIwNSAvIDI1NSwgNTAgLyAyNTVdLAogICAgICAgIFs1OSAvIDI1NSwgMTU4IC8gMjU1LCAxXQogICAgICBdLAogICAgICBsaWdodDogWwogICAgICAgIFsxLCAwLCAwXSwKICAgICAgICBbMCwgMC41LCAwXSwKICAgICAgICBbMCwgMCwgMV0KICAgICAgXQogICAgfSwgdGhpcy5jb25lcyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgdmFyIG4gPSBuZXcgVGEoCiAgICAgICAgMCwKICAgICAgICAyLjUgKiBlLAogICAgICAgIDUgKiBlLAogICAgICAgIDIwLAogICAgICAgIDEKICAgICAgKTsKICAgICAgY29uc3QgaCA9IG5ldyBsaSh7CiAgICAgICAgY29sb3I6IG5ldyBjdCguLi50aGlzLmNvbG9yc1t0aGlzLnRoZW1lXVtpXSksCiAgICAgICAgdG9uZU1hcHBlZDogITEKICAgICAgfSksIGMgPSBuZXcgcmUobiwgaCk7CiAgICAgIGMubWF0cml4QXV0b1VwZGF0ZSA9ICExLCB0aGlzLmNvbmVzLnB1c2goYyk7CiAgICB9CiAgICB0aGlzLmNvbmVzWzBdLmdlb21ldHJ5LnJvdGF0ZVooLU1hdGguUEkgLyAyKSwgdGhpcy5jb25lc1swXS5nZW9tZXRyeS50cmFuc2xhdGUoYW8sIDAsIDApLCB0aGlzLmNvbmVzWzFdLmdlb21ldHJ5LnRyYW5zbGF0ZSgwLCBhbywgMCksIHRoaXMuY29uZXNbMl0uZ2VvbWV0cnkucm90YXRlWChNYXRoLlBJIC8gMiksIHRoaXMuY29uZXNbMl0uZ2VvbWV0cnkudHJhbnNsYXRlKDAsIDAsIGFvKSwgdGhpcy5zY2VuZS5hZGQoLi4udGhpcy5jb25lcyk7CiAgICBjb25zdCBzID0gWyJYIiwgIlkiLCAiWiJdOwogICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICBjb25zdCBoID0gbmV3IFBlKHsKICAgICAgICAvLyBjb2xvcjogbmV3IFRIUkVFLkNvbG9yKC4uLnRoaXMuY29sb3JzW3RoaXMudGhlbWVdW2ldKSwKICAgICAgICBjb2xvcjogdGhpcy50aGVtZSA9PT0gImRhcmsiID8gbmV3IGN0KDAuOSwgMC45LCAwLjkpIDogbmV3IGN0KDAsIDAsIDApLAogICAgICAgIHNpZGU6IE1pCiAgICAgIH0pLCBjID0gdC5nZW5lcmF0ZVNoYXBlcyhzW2ldLCAxNiksIHUgPSBuZXcgR28oYyk7CiAgICAgIHUuY29tcHV0ZUJvdW5kaW5nQm94KCk7CiAgICAgIGNvbnN0IGQgPSAtMC41ICogKHUuYm91bmRpbmdCb3gubWF4LnggLSB1LmJvdW5kaW5nQm94Lm1pbi54KSwgcCA9IC0wLjUgKiAodS5ib3VuZGluZ0JveC5tYXgueSAtIHUuYm91bmRpbmdCb3gubWluLnkpOwogICAgICB1LnRyYW5zbGF0ZShkLCBwLCAwKTsKICAgICAgY29uc3QgZiA9IG5ldyByZSh1LCBoKTsKICAgICAgdGhpcy5zY2VuZS5hZGQoZiksIHRoaXMubGFiZWxzLnB1c2goZik7CiAgICB9CiAgICBjb25zdCByID0gbmV3IFJhKDMgKiBlLCAyMCwgMjApLCBvID0gbmV3IGxpKHsgY29sb3I6IDEwNTI2ODgwIH0pLCBsID0gbmV3IHJlKHIsIG8pOwogICAgdGhpcy5zY2VuZS5hZGQobCksIHRoaXMuc2NlbmUuYmFja2dyb3VuZCA9IG51bGwsIHRoaXMucmVhZHkgPSAhMDsKICB9CiAgc2V0VmlzaWJsZSh0KSB7CiAgICBmb3IgKHZhciBlIG9mIHRoaXMuc2NlbmUuY2hpbGRyZW4pCiAgICAgIGUudmlzaWJsZSA9IHQ7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICBSXyh0aGlzLnNjZW5lLCAodCkgPT4gewogICAgICB2YXIgZSwgaTsKICAgICAgKGUgPSB0Lmdlb21ldHJ5KSA9PSBudWxsIHx8IGUuZGlzcG9zZSgpLCAoaSA9IHQubWF0ZXJpYWwpID09IG51bGwgfHwgaS5kaXNwb3NlKCk7CiAgICB9KSwgdGhpcy5zY2VuZSA9IG51bGwsIHRoaXMuY2FtZXJhID0gbnVsbCwgdGhpcy5jYWRfY2FtZXJhID0gbnVsbCwgdGhpcy5jb25lcyA9IG51bGwsIHRoaXMubGFiZWxzID0gbnVsbDsKICB9CiAgcmVuZGVyKHQpIHsKICAgIHRoaXMucmVhZHkgJiYgKHQuc2V0Vmlld3BvcnQoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpLCB0LnJlbmRlcih0aGlzLnNjZW5lLCB0aGlzLmNhbWVyYSkpOwogIH0KICAvLyBoYW5kbGVyIChib3VuZCB0byBPcmllbnRhdGlvbk1hcmtlciBpbnN0YW5jZSkKICB1cGRhdGUodCwgZSkgewogICAgaWYgKHRoaXMucmVhZHkpIHsKICAgICAgbGV0IG4gPSBuZXcgdmUoKS5zZXRGcm9tVW5pdFZlY3RvcnMoCiAgICAgICAgbmV3IEUoMCwgMCwgMSksCiAgICAgICAgdC5ub3JtYWxpemUoKQogICAgICApOwogICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5zZXQoMCwgMCwgMSkuYXBwbHlRdWF0ZXJuaW9uKG4pLm11bHRpcGx5U2NhbGFyKDMwMCksIHRoaXMuY2FtZXJhLnF1YXRlcm5pb24uY29weShlKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspCiAgICAgICAgdGhpcy5sYWJlbHNbaV0ucG9zaXRpb24uc2V0KAogICAgICAgICAgaSA9PSAwID8gY2QgOiAwLAogICAgICAgICAgaSA9PSAxID8gY2QgOiAwLAogICAgICAgICAgaSA9PSAyID8gY2QgOiAwCiAgICAgICAgKSwgdGhpcy5sYWJlbHNbaV0ucXVhdGVybmlvbi5jb3B5KGUpOwogICAgfQogIH0KICBjaGFuZ2VUaGVtZSh0KSB7CiAgICBmb3IgKGNvbnN0IGUgaW4gdGhpcy5jb25lcykgewogICAgICBjb25zdCBpID0gdGhpcy5jb25lc1tlXTsKICAgICAgaS5tYXRlcmlhbC5jb2xvciA9IG5ldyBjdCguLi50aGlzLmNvbG9yc1t0XVtlXSk7CiAgICB9CiAgICB0aGlzLmF4ZXMuY2hhbmdlVGhlbWUodCk7CiAgICBmb3IgKGNvbnN0IGUgaW4gdGhpcy5sYWJlbHMpIHsKICAgICAgY29uc3QgaSA9IHRoaXMubGFiZWxzW2VdOwogICAgICBpLm1hdGVyaWFsLmNvbG9yID0gdCA9PT0gImRhcmsiID8gbmV3IGN0KDAuOSwgMC45LCAwLjkpIDogbmV3IGN0KDAsIDAsIDApOwogICAgfQogIH0KfQpjb25zdCB4ZSA9IHsKICB1bnNlbGVjdGVkOiAwLAogIHNlbGVjdGVkOiAxLAogIG1peGVkOiAyLAogIGRpc2FibGVkOiAzCn07CnZhciBnZyA9IDA7CmNsYXNzIFFFIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgVHJlZVZpZXcgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gY29udGFpbmVyIC0gVGhlIGNvbnRhaW5lciBlbGVtZW50IGZvciB0aGUgdHJlZSB2aWV3LgogICAqIEBwYXJhbSB7T2JqZWN0fSB0cmVlIC0gVGhlIHRyZWUgc3RydWN0dXJlIGRhdGEuCiAgICogQHBhcmFtIHtib29sZWFufSBbZGVidWc9ZmFsc2VdIC0gSW5kaWNhdGVzIHdoZXRoZXIgdG8gZW5hYmxlIGRlYnVnIG1vZGUuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCwgYyA9ICExKSB7CiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgKiAgSGFuZGxlcnMKICAgICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgICAvKioKICAgICAqIEhhbmRsZXMgdGhlIHNjcm9sbCBldmVudC4KICAgICAqLwogICAgayh0aGlzLCAiaGFuZGxlU2Nyb2xsIiwgKCkgPT4gewogICAgICB0aGlzLnNjcm9sbENvbnRhaW5lciAmJiAodGhpcy5sYXN0U2Nyb2xsVG9wID0gdGhpcy5zY3JvbGxDb250YWluZXIuc2Nyb2xsVG9wLCB0aGlzLmRlYnVnICYmIGNvbnNvbGUubG9nKCJ1cGRhdGUgPT4gc2Nyb2xsIiksIHRoaXMudXBkYXRlKCkpOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZXMgdGhlIGNsaWNrIGV2ZW50IG9uIGEgbmF2aWdhdGlvbiBub2RlLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBub2RlIC0gVGhlIG5vZGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBuYXZpZ2F0aW9uIG1hcmtlci4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gLSBUaGUgZXZlbnQgaGFuZGxlciBmdW5jdGlvbi4KICAgICAqLwogICAgayh0aGlzLCAiaGFuZGxlTmF2aWdhdGlvbkNsaWNrIiwgKHQpID0+IChlKSA9PiB7CiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCksIHQuZXhwYW5kZWQgPSAhdC5leHBhbmRlZCwgdGhpcy5zaG93Q2hpbGRDb250YWluZXIodCksIHRoaXMuZGVidWcgJiYgY29uc29sZS5sb2coInVwZGF0ZSA9PiBuYXZDbGljayIpLCB0aGlzLnVwZGF0ZSgpOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZXMgdGhlIGNsaWNrIGV2ZW50IG9uIGFuIGljb24uCiAgICAgKgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlIC0gVGhlIG5vZGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBpY29uLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHMgLSBUaGUgaWNvbiBudW1iZXIgJ3MnLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSAtIFRoZSBldmVudCBoYW5kbGVyIGZ1bmN0aW9uLgogICAgICovCiAgICBrKHRoaXMsICJoYW5kbGVJY29uQ2xpY2siLCAodCwgZSkgPT4gKGkpID0+IHsKICAgICAgaS5zdG9wUHJvcGFnYXRpb24oKSwgdGhpcy50b2dnbGVJY29uKHQsIGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIFVwZGF0ZXMgdGhlIHRyZWUgdmlldyB3aXRoIHRoZSBnaXZlbiBwcmVmaXguCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8bnVsbH0gcHJlZml4IC0gVGhlIHByZWZpeCB0byBmaWx0ZXIgdGhlIHZpc2libGUgZWxlbWVudHMuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJZiBudWxsLCBhbGwgZWxlbWVudHMgYXJlIGNvbnNpZGVyZWQuCiAgICAgKi8KICAgIGsodGhpcywgInVwZGF0ZSIsICh0ID0gbnVsbCkgPT4gewogICAgICBjb25zdCBlID0gdGhpcy5nZXRWaXNpYmxlRWxlbWVudHMoKS5maWx0ZXIoCiAgICAgICAgKHMpID0+IHQgPT0gbnVsbCB8fCBzLmRhdGFzZXQucGF0aC5zdGFydHNXaXRoKHQpCiAgICAgICk7CiAgICAgIGZvciAodmFyIGkgb2YgZSkgewogICAgICAgIGNvbnN0IHMgPSBpLmRhdGFzZXQucGF0aCwgciA9IHRoaXMuZmluZE5vZGVCeVBhdGgocyk7CiAgICAgICAgaWYgKHIgIT0gbnVsbCkgewogICAgICAgICAgaWYgKHIucmVuZGVyZWQgfHwgKHRoaXMucmVuZGVyTm9kZShyLCBpKSwgci5yZW5kZXJlZCA9ICEwKSwgci5leHBhbmRlZCkgewogICAgICAgICAgICBjb25zdCBvID0gaS5xdWVyeVNlbGVjdG9yKCIudHYtY2hpbGRyZW4iKTsKICAgICAgICAgICAgaWYgKG8gIT0gbnVsbCAmJiBvLmNoaWxkcmVuICE9IG51bGwgJiYgby5jaGlsZHJlbi5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIHIuY2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGwgPSByLmNoaWxkcmVuW25dOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJQbGFjZWhvbGRlcihsLCBvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5zaG93Q2hpbGRDb250YWluZXIociksIHRoaXMudXBkYXRlKHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBvIGluIFswLCAxXSkgewogICAgICAgICAgICBjb25zdCBsID0gaS5kYXRhc2V0W2BzdGF0ZSR7b31gXSwgaCA9IHIuc3RhdGVbb107CiAgICAgICAgICAgIGwgIT0gaCAmJiB0aGlzLnVwZGF0ZUljb25JbkRPTShyLCBvKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2hvd0NoaWxkQ29udGFpbmVyKHIpOwogICAgICAgIH0gZWxzZQogICAgICAgICAgY29uc29sZS5lcnJvcihgTm9kZSBub3QgZm91bmQ6ICR7c31gKTsKICAgICAgfQogICAgfSk7CiAgICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICAgKiAgRE9NIGZ1bmN0aW9ucwogICAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBET00gbm9kZSB3aXRoIHRoZSBzcGVjaWZpZWQgcGF0aC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBET00gbm9kZSB0byByZXRyaWV2ZS4KICAgICAqIEByZXR1cm5zIHtFbGVtZW50fG51bGx9IC0gVGhlIERPTSBub2RlIHdpdGggdGhlIHNwZWNpZmllZCBwYXRoLCBvciBudWxsIGlmIG5vdCBmb3VuZC4KICAgICAqLwogICAgayh0aGlzLCAiZ2V0RG9tTm9kZSIsICh0KSA9PiB0aGlzLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKGBbZGF0YS1wYXRoPSIke3R9Il1gKSk7CiAgICAvKioKICAgICAqIFVwZGF0ZXMgdGhlIG9iamVjdCBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgbm9kZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBub2RlIC0gVGhlIG5vZGUgdG8gdXBkYXRlIHRoZSBvYmplY3Qgd2l0aC4KICAgICAqLwogICAgayh0aGlzLCAidXBkYXRlT2JqZWN0IiwgKHQsIGUpID0+IHsKICAgICAgdmFyIGkgPSBlID09IDAgJiYgdGhpcy5saW5rSWNvbnMgPyBbMCwgMV0gOiBbZV07CiAgICAgIGZvciAodmFyIG4gb2YgaSkKICAgICAgICB0aGlzLm9iamVjdEhhbmRsZXIodGhpcy5nZXROb2RlUGF0aCh0KSwgdC5zdGF0ZVtuXSwgbiwgITAsICExKTsKICAgIH0pOwogICAgdGhpcy52aWV3SWNvbnMgPSBbCiAgICAgIFsic2hhcGVfbm8iLCAic2hhcGUiLCAic2hhcGVfbWl4IiwgInNoYXBlX2VtcHR5Il0sCiAgICAgIFsibWVzaF9ubyIsICJtZXNoIiwgIm1lc2hfbWl4IiwgIm1lc2hfZW1wdHkiXQogICAgXSwgdGhpcy5uYXZJY29ucyA9IHsKICAgICAgcmlnaHQ6ICLilr4iLAogICAgICBkb3duOiAi4pa4IgogICAgfSwgdGhpcy50cmVlID0gdCwgdGhpcy5vZmZzZXQgPSAxMiwgdGhpcy5zY3JvbGxDb250YWluZXIgPSBlLCB0aGlzLm9iamVjdEhhbmRsZXIgPSBpLCB0aGlzLnBpY2tIYW5kbGVyID0gbiwgdGhpcy51cGRhdGVIYW5kbGVyID0gcywgdGhpcy5ub3RpZmljYXRpb25IYW5kbGVyID0gciwgdGhpcy5jb2xvckdldHRlciA9IG8sIHRoaXMudGhlbWUgPSBsLCB0aGlzLmxpbmtJY29ucyA9IGgsIHRoaXMuZGVidWcgPSBjOwogIH0KICBjcmVhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5tYXhMZXZlbCA9IDAsIHRoaXMucm9vdCA9IHRoaXMuYnVpbGRUcmVlU3RydWN0dXJlKHRoaXMudHJlZSksIHRoaXMuY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKSwgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgidGN2X3RvcGxldmVsIiksIHRoaXMuc2Nyb2xsQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoInNjcm9sbCIsIHRoaXMuaGFuZGxlU2Nyb2xsKSwgdGhpcy5sYXN0TGFiZWwgPSBudWxsLCB0aGlzLmNvbnRhaW5lcjsKICB9CiAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAqICBUcmVlIGNyZWF0aW9uIGFuZCBzeW5jaGluZwogICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgLyoqCiAgICogQnVpbGRzIGEgdHJlZSBzdHJ1Y3R1cmUgYmFzZWQgb24gdGhlIHByb3ZpZGVkIGRhdGEuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIFRoZSBkYXRhIHVzZWQgdG8gYnVpbGQgdGhlIHRyZWUgc3RydWN0dXJlLgogICAqIEByZXR1cm5zIHtPYmplY3R9IC0gVGhlIHJvb3Qgbm9kZSBvZiB0aGUgdHJlZSBzdHJ1Y3R1cmUuCiAgICovCiAgYnVpbGRUcmVlU3RydWN0dXJlKHQpIHsKICAgIGNvbnN0IGUgPSAobiwgcywgcikgPT4gewogICAgICB2YXIgbyA9IFstMSwgLTFdOwogICAgICBjb25zdCBsID0gKHApID0+IHsKICAgICAgICBmb3IgKGxldCBmIG9mIFswLCAxXSkKICAgICAgICAgIHBbeGUubWl4ZWRdW2ZdIHx8IHBbeGUuc2VsZWN0ZWRdW2ZdICYmIHBbeGUudW5zZWxlY3RlZF1bZl0gPyBvW2ZdID0geGUubWl4ZWQgOiBwW3hlLnNlbGVjdGVkXVtmXSA/IG9bZl0gPSB4ZS5zZWxlY3RlZCA6IHBbeGUudW5zZWxlY3RlZF1bZl0gPyBvW2ZdID0geGUudW5zZWxlY3RlZCA6IHBbeGUuZGlzYWJsZWRdW2ZdICYmIChvW2ZdID0geGUuZGlzYWJsZWQpOwogICAgICAgIHJldHVybiBvOwogICAgICB9LCBoID0ge307CiAgICAgIHRoaXMubWF4TGV2ZWwgPCByICYmICh0aGlzLm1heExldmVsID0gcik7CiAgICAgIHZhciBjID0gWwogICAgICAgIFshMSwgITFdLAogICAgICAgIFshMSwgITFdLAogICAgICAgIFshMSwgITFdLAogICAgICAgIFshMSwgITFdCiAgICAgIF07CiAgICAgIGZvciAoY29uc3QgcCBpbiBuKSB7CiAgICAgICAgdmFyIHUgPSAiIjsKICAgICAgICBzID09IG51bGwgPyB1ID0gcCA6IHUgPSBgJHtzfS8ke3B9YDsKICAgICAgICBsZXQgZjsKICAgICAgICBjb25zdCB5ID0gbltwXTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh5KSkKICAgICAgICAgIGYgPSB5LCBjW3lbMF1dWzBdID0gITAsIGNbeVsxXV1bMV0gPSAhMCwgaFtwXSA9IHsKICAgICAgICAgICAgbmFtZTogcCwKICAgICAgICAgICAgc3RhdGU6IGYsCiAgICAgICAgICAgIHBhdGg6IHUsCiAgICAgICAgICAgIHJlbmRlcmVkOiAhMSwKICAgICAgICAgICAgbGV2ZWw6IHIKICAgICAgICAgIH07CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBsZXQgZzsKICAgICAgICAgIFtnLCBmXSA9IGUoeSwgdSwgciArIDEpLCBjW2ZbMF1dWzBdID0gITAsIGNbZlsxXV1bMV0gPSAhMCwgaFtwXSA9IHsKICAgICAgICAgICAgbmFtZTogcCwKICAgICAgICAgICAgc3RhdGU6IGYsCiAgICAgICAgICAgIHBhdGg6IHUsCiAgICAgICAgICAgIHJlbmRlcmVkOiAhMSwKICAgICAgICAgICAgbGV2ZWw6IHIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBnLAogICAgICAgICAgICBleHBhbmRlZDogITEKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGQgPSBsKGMpOwogICAgICByZXR1cm4gW2gsIGRdOwogICAgfSwgaSA9IGUodCwgbnVsbCwgMClbMF07CiAgICByZXR1cm4gaVtPYmplY3Qua2V5cyhpKVswXV07CiAgfQogIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgKiBWaXNibGUgZWxlbWVudHMgaGFuZGxpbmcKICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgdmlzaWJsZSBlbGVtZW50cyB3aXRoaW4gdGhlIGNvbnRhaW5lci4KICAgKiBAcmV0dXJucyB7RWxlbWVudFtdfSBBbiBhcnJheSBvZiB2aXNpYmxlIGVsZW1lbnRzLgogICAqLwogIGdldFZpc2libGVFbGVtZW50cygpIHsKICAgIGNvbnN0IHQgPSAocywgcikgPT4gewogICAgICBjb25zdCBvID0gcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgcmV0dXJuIG8uaGVpZ2h0ID4gMCAmJiBvLnRvcCA+PSAtdGhpcy5vZmZzZXQgJiYgby50b3AgPD0gci5ib3R0b20gKyB0aGlzLm9mZnNldDsKICAgIH0sIGUgPSB0aGlzLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCIudHYtdHJlZS1ub2RlIiksIGkgPSB0aGlzLnNjcm9sbENvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgbiA9IEFycmF5LmZyb20oZSkuZmlsdGVyKAogICAgICAocykgPT4gdChzLCBpKQogICAgKTsKICAgIGlmICh0aGlzLmRlYnVnKSB7CiAgICAgIGdnKyssIGNvbnNvbGUubG9nKAogICAgICAgIGAKJHtnZ30+IHZpc2libGUgZWxlbWVudHMgKCR7bi5sZW5ndGh9KTpgCiAgICAgICk7CiAgICAgIGZvciAobGV0IHMgaW4gbikgewogICAgICAgIGNvbnN0IHIgPSBuW3NdLCBvID0gdGhpcy5maW5kTm9kZUJ5UGF0aChyLmRhdGFzZXQucGF0aCk7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICBvLnBhdGgsCiAgICAgICAgICBvLnN0YXRlWzBdLAogICAgICAgICAgby5zdGF0ZVsxXSwKICAgICAgICAgICIgPT4gIiwKICAgICAgICAgIHIuZGF0YXNldC5zdGF0ZTAsCiAgICAgICAgICByLmRhdGFzZXQuc3RhdGUxCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG47CiAgfQogIC8qKgogICAqIEhhbmRsZXMgdGhlIGNsaWNrIGV2ZW50IG9uIGEgbGFiZWwuCiAgICoKICAgKiBAcGFyYW0ge05vZGV9IG5vZGUgLSBUaGUgbm9kZSB0aGF0IHdhcyBjbGlja2VkLgogICAqIEByZXR1cm5zIHt2b2lkfQogICAqLwogIGhhbmRsZUxhYmVsQ2xpY2sodCwgZSkgewogICAgdGhpcy5waWNrSGFuZGxlcigKICAgICAgdGhpcy5nZXROb2RlUGF0aCh0aGlzLmdldFBhcmVudCh0KSksCiAgICAgIHQubmFtZSwKICAgICAgRGUuZ2V0KGUsICJtZXRhIiksCiAgICAgIERlLmdldChlLCAic2hpZnQiKSwKICAgICAgRGUuZ2V0KGUsICJhbHQiKSwKICAgICAgbnVsbCwKICAgICAgdGhpcy5pc0xlYWYodCkgPyAibGVhZiIgOiAibm9kZSIsCiAgICAgICEwCiAgICApLCBjb25zb2xlLmxvZyhgTGFiZWwgY2xpY2tlZDogJHt0aGlzLmdldE5vZGVQYXRoKHQpfWApOwogIH0KICAvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICogIFJlbmRlcmluZyByb3V0aW5lcwogICAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgLyoqCiAgICogUmVuZGVycyB0aGUgdHJlZSB2aWV3IGJ5IGNsZWFyaW5nIHRoZSBjb250YWluZXIsIHJlbmRlcmluZyB0aGUgcGxhY2Vob2xkZXIsCiAgICogYW5kIHVwZGF0aW5nIHRoZSB0cmVlLgogICAqLwogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmlubmVySFRNTCA9ICIiLCB0aGlzLnJlbmRlclBsYWNlaG9sZGVyKHRoaXMucm9vdCwgdGhpcy5jb250YWluZXIpLCB0aGlzLmRlYnVnICYmIGNvbnNvbGUubG9nKCJ1cGRhdGUgPT4gcmVuZGVyIiksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFJlbmRlcnMgYSBwbGFjZWhvbGRlciBub2RlIGluIHRoZSB0cmVlIHZpZXcuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbm9kZSAtIFRoZSBub2RlIG9iamVjdCB0byByZW5kZXIuCiAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gY29udGFpbmVyIC0gVGhlIGNvbnRhaW5lciBlbGVtZW50IHRvIGFwcGVuZCB0aGUgcmVuZGVyZWQgbm9kZSB0by4KICAgKiBAcGFyYW0ge3N0cmluZ3xudWxsfSBvcGVuUGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBub2RlIHRvIGJlIG9wZW5lZCwgb3IgbnVsbCBpZiBubyBub2RlIHNob3VsZCBiZSBvcGVuZWQuCiAgICovCiAgcmVuZGVyUGxhY2Vob2xkZXIodCwgZSwgaSA9IG51bGwpIHsKICAgIHRoaXMuZGVidWcgJiYgY29uc29sZS5sb2coInJlbmRlclBsYWNlaG9sZGVyIiwgdC5wYXRoLCB0LmxldmVsKTsKICAgIGNvbnN0IG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIG4uY2xhc3NOYW1lID0gInR2LXRyZWUtbm9kZSIsIG4uZGF0YXNldC5wYXRoID0gdGhpcy5nZXROb2RlUGF0aCh0KSwgbi5kYXRhc2V0Lm9wZW5QYXRoID0gaSwgbi5kYXRhc2V0LnN0YXRlMCA9IHQuc3RhdGVbMF0sIG4uZGF0YXNldC5zdGF0ZTEgPSB0LnN0YXRlWzFdOwogICAgY29uc3QgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgcy5jbGFzc05hbWUgPSAidHYtbm9kZS1jb250ZW50IiwgdGhpcy5kZWJ1ZyAmJiAocy5pbm5lclRleHQgPSB0LnBhdGgpLCBuLmFwcGVuZENoaWxkKHMpLCBlLmFwcGVuZENoaWxkKG4pOwogIH0KICAvKioKICAgKiBSZW5kZXJzIGEgbm9kZSBpbiB0aGUgdHJlZSB2aWV3IHRvIHJlcGxhY2UgdGhlIHBsYWNlaG9sZGVyLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG5vZGUgLSBUaGUgbm9kZSBvYmplY3QgdG8gcmVuZGVyLgogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IHBhcmVudEVsZW1lbnQgLSBUaGUgcGFyZW50IGVsZW1lbnQgdG8gYXBwZW5kIHRoZSByZW5kZXJlZCBub2RlIHRvLgogICAqIEByZXR1cm5zIHtIVE1MRWxlbWVudH0gLSBUaGUgY29udGFpbmVyIGVsZW1lbnQgZm9yIHRoZSBub2RlJ3MgY2hpbGRyZW4sIGlmIGFueS4KICAgKi8KICByZW5kZXJOb2RlKHQsIGUpIHsKICAgIHRoaXMuZGVidWcgJiYgY29uc29sZS5sb2coInJlbmRlck5vZGUiLCB0LnBhdGgsIHQubGV2ZWwpOwogICAgY29uc3QgaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgaS5jbGFzc05hbWUgPSAidHYtbm9kZS1jb250ZW50IiwgZS5yZW1vdmVDaGlsZChlLmZpcnN0Q2hpbGQpLCBlLmFwcGVuZENoaWxkKGkpOwogICAgY29uc3QgbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIG4uY2xhc3NOYW1lID0gInR2LW5hdi1tYXJrZXIiLCBuLmlubmVySFRNTCA9IHQuY2hpbGRyZW4gPyB0LmV4cGFuZGVkID8gIuKWviIgOiAi4pa4IiA6ICIiLCBuLm9uY2xpY2sgPSB0aGlzLmhhbmRsZU5hdmlnYXRpb25DbGljayh0KSwgaS5kYXRhc2V0LnN0YXRlMCA9IHQuc3RhdGVbMF0sIGkuZGF0YXNldC5zdGF0ZTEgPSB0LnN0YXRlWzFdLCBpLmFwcGVuZENoaWxkKG4pOwogICAgZm9yICh2YXIgcyBvZiBbMCwgMV0pIHsKICAgICAgY29uc3QgYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKSwgdSA9IHQuc3RhdGVbc107CiAgICAgIHZhciByID0gYHR2LWljb24gdHYtaWNvbiR7c31gOwogICAgICB1ICE9PSB4ZS5kaXNhYmxlZCAmJiAociArPSAiIHR2LXBvaW50ZXIiKSwgYy5jbGFzc05hbWUgPSByLCBjLmNsYXNzTGlzdC5hZGQoInRjdl90cmVlX2J1dHRvbiIpLCBjLmNsYXNzTGlzdC5hZGQoYHRjdl9idXR0b25fJHt0aGlzLnZpZXdJY29uc1tzXVt1XX1gKSwgdSAhPT0geGUuZGlzYWJsZWQgJiYgKGMub25tb3VzZWRvd24gPSAoZCkgPT4gewogICAgICAgIGQucHJldmVudERlZmF1bHQoKTsKICAgICAgfSwgYy5vbmNsaWNrID0gdGhpcy5oYW5kbGVJY29uQ2xpY2sodCwgcykpLCBpLmFwcGVuZENoaWxkKGMpOwogICAgfQogICAgY29uc3QgbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIG8uY2xhc3NOYW1lID0gInR2LW5vZGUtbGFiZWwiLCBvLmlubmVySFRNTCA9IHQubmFtZTsKICAgIGNvbnN0IGwgPSB0aGlzLmNvbG9yR2V0dGVyKHQucGF0aCk7CiAgICBsICE9IG51bGwgJiYgKG8uaW5uZXJIVE1MICs9IGA8c3BhbiBzdHlsZT0iY29sb3I6JHtsfSI+IOKaiDwvc3Bhbj5gKSwgby5vbm1vdXNlZG93biA9IChjKSA9PiB7CiAgICAgIGMucHJldmVudERlZmF1bHQoKTsKICAgIH0sIG8ub25jb250ZXh0bWVudSA9IChjKSA9PiB7CiAgICAgIGMucHJldmVudERlZmF1bHQoKSwgYy5zdG9wUHJvcGFnYXRpb24oKSwgdGhpcy5oYW5kbGVMYWJlbENsaWNrKHQsIGMpOwogICAgfSwgby5vbmNsaWNrID0gKGMpID0+IHsKICAgICAgYy5zdG9wUHJvcGFnYXRpb24oKSwgdGhpcy5oYW5kbGVMYWJlbENsaWNrKHQsIGMpOwogICAgfSwgaS5hcHBlbmRDaGlsZChvKTsKICAgIGxldCBoID0gbnVsbDsKICAgIHJldHVybiB0LmNoaWxkcmVuICYmIChoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksIGguY2xhc3NOYW1lID0gInR2LWNoaWxkcmVuIiwgaC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCBlLmFwcGVuZENoaWxkKGgpKSwgaDsKICB9CiAgLyoqCiAgICogU2hvd3Mgb3IgaGlkZXMgdGhlIGNoaWxkIGNvbnRhaW5lciBvZiBhIG5vZGUgYmFzZWQgb24gdGhlIGV4cGFuZGVkIHBhcmFtZXRlci4KICAgKgogICAqIEBwYXJhbSB7b2JqZWN0fSBub2RlIC0gVGhlIG5vZGUgb2JqZWN0LgogICAqLwogIHNob3dDaGlsZENvbnRhaW5lcih0KSB7CiAgICBpZiAodC5leHBhbmRlZCA9PSBudWxsKSByZXR1cm47CiAgICBjb25zdCBlID0gdGhpcy5nZXROb2RlUGF0aCh0KSwgaSA9IHRoaXMuZ2V0RG9tTm9kZShlKTsKICAgIGlmIChpKSB7CiAgICAgIGNvbnN0IG4gPSBpLnF1ZXJ5U2VsZWN0b3IoIi50di1jaGlsZHJlbiIpOwogICAgICBuICYmIG4uc3R5bGUuZGlzcGxheSAhPT0gIm5vbmUiICE9PSB0LmV4cGFuZGVkICYmIChuLnN0eWxlLmRpc3BsYXkgPSB0LmV4cGFuZGVkID8gImJsb2NrIiA6ICJub25lIiwgaS5xdWVyeVNlbGVjdG9yKCIudHYtbmF2LW1hcmtlciIpLmlubmVySFRNTCA9IHQuZXhwYW5kZWQgPyB0aGlzLm5hdkljb25zLnJpZ2h0IDogdGhpcy5uYXZJY29ucy5kb3duLCB0LmV4cGFuZGVkIHx8ICh0aGlzLmRlYnVnICYmIGNvbnNvbGUubG9nKCJ1cGRhdGUgPT4gc2hvd0NoaWxkQ29udGFpbmVyIiksIHRoaXMudXBkYXRlKCkpKTsKICAgIH0gZWxzZQogICAgICBjb25zb2xlLmVycm9yKGBFbGVtZW50IG5vdCBmb3VuZDogJHtlfWApOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSBpY29uIGluIHRoZSBET00gZm9yIGEgZ2l2ZW4gbm9kZS4KICAgKgogICAqIEBwYXJhbSB7Tm9kZX0gbm9kZSAtIFRoZSBub2RlIHRvIHVwZGF0ZSB0aGUgaWNvbiBmb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGljb25OdW1iZXIgLSBUaGUgaWNvbiBudW1iZXIgdG8gdXBkYXRlLgogICAqLwogIHVwZGF0ZUljb25JbkRPTSh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5nZXROb2RlUGF0aCh0KSwgbiA9IHRoaXMuY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoCiAgICAgIGBbZGF0YS1wYXRoPSIke2l9Il1gCiAgICApOwogICAgaWYgKG4pIHsKICAgICAgY29uc3QgciA9IG4ucXVlcnlTZWxlY3RvcihgLnR2LWljb24ke2V9YCk7CiAgICAgIGlmIChyKSB7CiAgICAgICAgZm9yICh2YXIgcyBvZiB0aGlzLnZpZXdJY29uc1tlXSkKICAgICAgICAgIHIuY2xhc3NMaXN0LnJlbW92ZShgdGN2X2J1dHRvbl8ke3N9YCk7CiAgICAgICAgci5jbGFzc0xpc3QuYWRkKAogICAgICAgICAgYHRjdl9idXR0b25fJHt0aGlzLnZpZXdJY29uc1tlXVt0LnN0YXRlW2VdXX1gCiAgICAgICAgKTsKICAgICAgfQogICAgICBuLmRhdGFzZXRbYHN0YXRlJHtlfWBdID0gdC5zdGF0ZVtlXTsKICAgIH0KICB9CiAgLyoqCiAgICogVG9nZ2xlcyB0aGUgY29sb3Igb2YgdGhlIGxhYmVsIGZvciBhIGdpdmVuIG5vZGUuCiAgICogQHBhcmFtIHtOb2RlfSBub2RlIC0gVGhlIG5vZGUgZm9yIHdoaWNoIHRvIHRvZ2dsZSB0aGUgbGFiZWwgY29sb3IuCiAgICogQHBhcmFtIHtzdHJ9IHBhdGggLSBJZiBub2RlIGlzIG51bGwsIHRoZSBwYXRoIGZvciB3aGljaCB0byB0b2dnbGUgdGhlIGxhYmVsIGNvbG9yLgogICAqLwogIHRvZ2dsZUxhYmVsQ29sb3IodCwgZSA9IG51bGwpIHsKICAgIGNvbnN0IGkgPSBlID8/IHRoaXMuZ2V0Tm9kZVBhdGgodCksIG4gPSB0aGlzLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKAogICAgICBgW2RhdGEtcGF0aD0iJHtpfSJdYAogICAgKTsKICAgIGlmICh0aGlzLmxhc3RMYWJlbCAmJiB0aGlzLmxhc3RMYWJlbC5jbGFzc0xpc3QucmVtb3ZlKCJ0di1ub2RlLWxhYmVsLWhpZ2hsaWdodCIpLCBuKSB7CiAgICAgIGNvbnN0IHMgPSBuLnF1ZXJ5U2VsZWN0b3IoIi50di1ub2RlLWxhYmVsIik7CiAgICAgIHMgJiYgKHRoaXMubGFzdExhYmVsID09PSBzID8gdGhpcy5sYXN0TGFiZWwgPSBudWxsIDogKHMuY2xhc3NMaXN0LnRvZ2dsZSgidHYtbm9kZS1sYWJlbC1oaWdobGlnaHQiKSwgdGhpcy5sYXN0TGFiZWwgPSBzKSk7CiAgICB9CiAgfQogIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgKiAgVHJlZSBoYW5kbGluZyBmdW5jdGlvbnMKICAgKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwogIC8qKgogICAqIFRyYXZlcnNlcyBhIHRyZWUtbGlrZSBzdHJ1Y3R1cmUgYW5kIGFwcGxpZXMgYSBjYWxsYmFjayBmdW5jdGlvbiB0byBlYWNoIG5vZGUuCiAgICogQHBhcmFtIHtPYmplY3R9IG5vZGUgLSBUaGUgcm9vdCBub2RlIG9mIHRoZSB0cmVlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGFwcGxpZWQgdG8gZWFjaCBub2RlLgogICAqLwogIHRyYXZlcnNlKHQsIGUpIHsKICAgIGlmIChlKHQpLCB0LmNoaWxkcmVuKQogICAgICBmb3IgKGxldCBpIG9mIE9iamVjdC5rZXlzKHQuY2hpbGRyZW4pKQogICAgICAgIHRoaXMudHJhdmVyc2UodC5jaGlsZHJlbltpXSwgZSk7CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIG5vZGUgaXMgYSBsZWFmIG5vZGUuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbm9kZSAtIFRoZSBub2RlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgbm9kZSBpcyBhIGxlYWYgbm9kZSwgZmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIGlzTGVhZih0KSB7CiAgICByZXR1cm4gdC5jaGlsZHJlbiA9PSBudWxsOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBwYXRoIG9mIGEgZ2l2ZW4gbm9kZS4KICAgKgogICAqIEBwYXJhbSB7Tm9kZX0gbm9kZSAtIFRoZSBub2RlIG9iamVjdC4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcGF0aCBvZiB0aGUgbm9kZS4KICAgKi8KICBnZXROb2RlUGF0aCh0KSB7CiAgICByZXR1cm4gdCA9PSBudWxsID8gIiIgOiAiLyIgKyB0LnBhdGg7CiAgfQogIC8qKgogICAqIEZpbmRzIGEgbm9kZSBpbiB0aGUgdHJlZSBieSBpdHMgcGF0aC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfHN0cmluZ1tdfSBwYXRoIC0gVGhlIHBhdGggb2YgdGhlIG5vZGUgdG8gZmluZC4gQ2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiBhcnJheSBvZiBzdHJpbmdzLgogICAqIEByZXR1cm5zIHtvYmplY3R8bnVsbH0gLSBUaGUgZm91bmQgbm9kZSBvciBudWxsIGlmIHRoZSBub2RlIGlzIG5vdCBmb3VuZC4KICAgKi8KICBmaW5kTm9kZUJ5UGF0aCh0KSB7CiAgICB2YXIgZSA9IEFycmF5LmlzQXJyYXkodCkgPyB0IDogdC5zcGxpdCgiLyIpLmZpbHRlcihCb29sZWFuKTsKICAgIGxldCBpID0gdGhpcy5yb290OwogICAgZm9yIChsZXQgbiA9IDE7IG4gPCBlLmxlbmd0aDsgbisrKSB7CiAgICAgIGNvbnN0IHMgPSBlW25dOwogICAgICBpZiAoaS5jaGlsZHJlbltzXSkKICAgICAgICBpID0gaS5jaGlsZHJlbltzXTsKICAgICAgZWxzZQogICAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIGk7CiAgfQogIC8qKgogICAqIFJldHJpZXZlcyB0aGUgcGFyZW50IG5vZGUgb2YgdGhlIGdpdmVuIG5vZGUuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gbm9kZSAtIFRoZSBub2RlIGZvciB3aGljaCB0byBmaW5kIHRoZSBwYXJlbnQuCiAgICogQHJldHVybnMge09iamVjdHxudWxsfSAtIFRoZSBwYXJlbnQgbm9kZSBpZiBmb3VuZCwgb3IgbnVsbCBpZiB0aGUgZ2l2ZW4gbm9kZSBpcyB0aGUgcm9vdCBub2RlLgogICAqLwogIGdldFBhcmVudCh0KSB7CiAgICBjb25zdCBlID0gdC5wYXRoLnN1YnN0cmluZygwLCB0LnBhdGgubGFzdEluZGV4T2YoIi8iKSk7CiAgICByZXR1cm4gZS5sZW5ndGggPT09IDAgPyBudWxsIDogdGhpcy5maW5kTm9kZUJ5UGF0aChlKTsKICB9CiAgLyoqCiAgICogVG9nZ2xlcyB0aGUgc3RhdGUgb2YgYW4gaWNvbiBmb3IgYSBnaXZlbiBub2RlLgogICAqCiAgICogQHBhcmFtIHtOb2RlfSBub2RlIC0gVGhlIG5vZGUgZm9yIHdoaWNoIHRvIHRvZ2dsZSB0aGUgaWNvbiBzdGF0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gaWNvbk51bWJlciAtIFRoZSBpbmRleCBvZiB0aGUgaWNvbiB0byB0b2dnbGUuCiAgICogQHJldHVybnMge3ZvaWR9CiAgICovCiAgdG9nZ2xlSWNvbih0LCBlLCBpID0gbnVsbCkgewogICAgY29uc3QgbiA9IHQuc3RhdGVbZV07CiAgICBpZiAobiAhPT0geGUuZGlzYWJsZWQpIHsKICAgICAgdmFyIHMgPSBlID09IDAgPyB0aGlzLmxpbmtJY29ucyA/IFswLCAxXSA6IFswXSA6IFsxXTsKICAgICAgZm9yICh2YXIgciBvZiBzKQogICAgICAgIHQuc3RhdGVbcl0gIT0gMyAmJiAoaSAhPSBudWxsID8gdC5zdGF0ZVtyXSA9IGkgPyAxIDogMCA6IHQuc3RhdGVbcl0gPSBuID09PSB4ZS5zZWxlY3RlZCA/IHhlLnVuc2VsZWN0ZWQgOiB4ZS5zZWxlY3RlZCksIHRoaXMudXBkYXRlT2JqZWN0KHQsIGUpLCB0aGlzLnVwZGF0ZVBhcmVudFN0YXRlcyh0LCByKSwgdGhpcy51cGRhdGVDaGlsZHJlblN0YXRlcyh0LCByKSwgdGhpcy51cGRhdGUobnVsbCwgcik7CiAgICAgIHRoaXMudXBkYXRlSGFuZGxlcighMCksIHRoaXMubm90aWZpY2F0aW9uSGFuZGxlcigpOwogICAgfQogIH0KICAvKioKICAgKiBIaWRlcyBhbGwgbm9kZXMgaW4gdGhlIHRyZWUuCiAgICovCiAgaGlkZUFsbCgpIHsKICAgIHRoaXMudG9nZ2xlSWNvbih0aGlzLnJvb3QsIDAsICExKSwgKCF0aGlzLmxpbmtJY29ucyB8fCB0aGlzLnJvb3Quc3RhdGVbMF0gPT09IDMpICYmIHRoaXMudG9nZ2xlSWNvbih0aGlzLnJvb3QsIDEsICExKTsKICB9CiAgLyoqCiAgICogU2hvd3MgYWxsIG5vZGVzIGluIHRoZSB0cmVlLgogICAqLwogIHNob3dBbGwoKSB7CiAgICB0aGlzLnRvZ2dsZUljb24odGhpcy5yb290LCAwLCAhMCksIHRoaXMubGlua0ljb25zIHx8IHRoaXMudG9nZ2xlSWNvbih0aGlzLnJvb3QsIDEsICEwKTsKICB9CiAgLyoqCiAgICogU2hvd3MgdGhlIG5vZGUgc3BlY2lmaWVkIGJ5IHRoZSBnaXZlbiBwYXRoLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgcGF0aCBvZiB0aGUgbm9kZSB0byBiZSBzaG93bi4KICAgKi8KICBzaG93KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmZpbmROb2RlQnlQYXRoKHQpOwogICAgZSAmJiB0aGlzLnRvZ2dsZUljb24oZSwgMCwgITApOwogIH0KICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIHN0YXRlcyBvZiBhIG5vZGUgc3BlY2lmaWVkIGJ5IHRoZSBnaXZlbiBwYXRoLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgcGF0aCBvZiB0aGUgbm9kZS4KICAgKiBAcmV0dXJucyB7b2JqZWN0fG51bGx9IC0gVGhlIHN0YXRlcyBvZiB0aGUgbm9kZSwgb3IgbnVsbCBpZiB0aGUgbm9kZSBpcyBub3QgZm91bmQuCiAgICovCiAgZ2V0U3RhdGUodCkgewogICAgY29uc3QgZSA9IHRoaXMuZmluZE5vZGVCeVBhdGgodCk7CiAgICByZXR1cm4gZSA/IGUuc3RhdGUgOiBudWxsOwogIH0KICAvKioKICAgKiBSZXRyaWV2ZXMgdGhlIHN0YXRlcyBvZiBhbGwgbGVhZiBub2RlcyBpbiB0aGUgdHJlZS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgc3RhdGVzIG9mIGFsbCBsZWFmIG5vZGVzLgogICAqLwogIGdldFN0YXRlcygpIHsKICAgIGNvbnN0IHQgPSB7fSwgZSA9IChpKSA9PiB7CiAgICAgIHRoaXMuaXNMZWFmKGkpICYmICh0W3RoaXMuZ2V0Tm9kZVBhdGgoaSldID0gaS5zdGF0ZSk7CiAgICB9OwogICAgcmV0dXJuIHRoaXMudHJhdmVyc2UodGhpcy5yb290LCBlKSwgdDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgc3RhdGUgb2YgYSBub2RlIGlkZW50aWZpZWQgYnkgdGhlIGdpdmVuIHBhdGguCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBub2RlLgogICAqIEBwYXJhbSB7QXJyYXl9IHN0YXRlIC0gVGhlIG5ldyBzdGF0ZSBvZiB0aGUgbm9kZS4KICAgKi8KICBzZXRTdGF0ZSh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5maW5kTm9kZUJ5UGF0aCh0KTsKICAgIGkgJiYgKHRoaXMudG9nZ2xlSWNvbihpLCAwLCBlWzBdKSwgdGhpcy50b2dnbGVJY29uKGksIDEsIGVbMV0pKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgc3RhdGVzIG9mIHRoZSBub2RlcyBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgc3RhdGVzIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZXMgLSBUaGUgc3RhdGVzIG9iamVjdCBjb250YWluaW5nIHRoZSBub2RlIHBhdGhzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIHN0YXRlcy4KICAgKi8KICBzZXRTdGF0ZXModCkgewogICAgZm9yICh2YXIgZSBpbiB0KQogICAgICB0aGlzLnNldFN0YXRlKGUsIHRbZV0pOwogICAgdGhpcy51cGRhdGUoKTsKICB9CiAgLyoqCiAgICogSGlkZXMgdGhlIG5vZGUgc3BlY2lmaWVkIGJ5IHRoZSBnaXZlbiBwYXRoLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgcGF0aCBvZiB0aGUgbm9kZSB0byBoaWRlLgogICAqLwogIGhpZGUodCkgewogICAgY29uc3QgZSA9IHRoaXMuZmluZE5vZGVCeVBhdGgodCk7CiAgICBlICYmIHRoaXMudG9nZ2xlSWNvbihlLCAwLCAhMSk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHN0YXRlIG9mIHBhcmVudCBub2RlcyBiYXNlZCBvbiB0aGUgc3RhdGUgb2YgdGhlaXIgY2hpbGRyZW4uCiAgICoKICAgKiBAcGFyYW0ge05vZGV9IG5vZGUgLSBUaGUgbm9kZSB3aG9zZSBwYXJlbnQgc3RhdGVzIG5lZWQgdG8gYmUgdXBkYXRlZC4KICAgKiBAcGFyYW0ge251bWJlcn0gaWNvbk51bWJlciAtIFRoZSBpY29uIG51bWJlciByZXByZXNlbnRpbmcgdGhlIHN0YXRlLgogICAqLwogIHVwZGF0ZVBhcmVudFN0YXRlcyh0LCBlKSB7CiAgICBsZXQgaSA9IHRoaXMuZ2V0UGFyZW50KHQpOwogICAgZm9yICg7IGk7ICkgewogICAgICBjb25zdCBuID0gT2JqZWN0LnZhbHVlcyhpLmNoaWxkcmVuKSwgcyA9IG4uZXZlcnkoCiAgICAgICAgKGwpID0+IGwuc3RhdGVbZV0gPT09IHhlLnNlbGVjdGVkIHx8IGwuc3RhdGVbZV0gPT09IHhlLmRpc2FibGVkCiAgICAgICksIHIgPSBuLmV2ZXJ5KAogICAgICAgIChsKSA9PiBsLnN0YXRlW2VdID09PSB4ZS51bnNlbGVjdGVkIHx8IGwuc3RhdGVbZV0gPT09IHhlLmRpc2FibGVkCiAgICAgICksIG8gPSBzID8geGUuc2VsZWN0ZWQgOiByID8geGUudW5zZWxlY3RlZCA6IHhlLm1peGVkOwogICAgICBpLnN0YXRlW2VdICE9PSBvICYmIGkuc3RhdGVbZV0gIT09IHhlLmRpc2FibGVkICYmIChpLnN0YXRlW2VdID0gbywgdGhpcy51cGRhdGVPYmplY3QoaSwgZSkpLCBpID0gdGhpcy5nZXRQYXJlbnQoaSk7CiAgICB9CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHN0YXRlcyBvZiB0aGUgY2hpbGRyZW4gbm9kZXMgYmFzZWQgb24gdGhlIGdpdmVuIGljb24gbnVtYmVyLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG5vZGUgLSBUaGUgbm9kZSB3aG9zZSBjaGlsZHJlbiBzdGF0ZXMgbmVlZCB0byBiZSB1cGRhdGVkLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpY29uTnVtYmVyIC0gVGhlIGljb24gbnVtYmVyIHRvIGRldGVybWluZSB0aGUgbmV3IHN0YXRlIG9mIHRoZSBjaGlsZHJlbiBub2Rlcy4KICAgKi8KICB1cGRhdGVDaGlsZHJlblN0YXRlcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdC5zdGF0ZVtlXSwgbiA9IChzKSA9PiB7CiAgICAgIGlmIChzLnN0YXRlW2VdICE9PSBpICYmIHMuc3RhdGVbZV0gIT09IHhlLmRpc2FibGVkICYmIChzLnN0YXRlW2VdID0gaSwgdGhpcy51cGRhdGVPYmplY3QocywgZSkpLCBzLmNoaWxkcmVuKQogICAgICAgIGZvciAodmFyIHIgaW4gcy5jaGlsZHJlbikKICAgICAgICAgIG4ocy5jaGlsZHJlbltyXSk7CiAgICB9OwogICAgbih0KTsKICB9CiAgLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAqICBUcmVlIGhhbmRsaW5nIGhpZ2ggbGV2ZWwgQVBJCiAgICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KICAvKioKICAgKiBTY3JvbGxzIHRoZSBwYXJlbnQgY29udGFpbmVyIHRvIGNlbnRlciB0aGUgc3BlY2lmaWVkIGVsZW1lbnQgd2l0aGluIHRoZSB2aXNpYmxlIGFyZWEuCiAgICogRW5zdXJlcyB0aGUgc2Nyb2xsaW5nIGRvZXMgbm90IGV4Y2VlZCB0aGUgc2Nyb2xsYWJsZSBib3VuZHMgb2YgdGhlIHBhcmVudCBjb250YWluZXIuCiAgICoKICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBlbGVtZW50IC0gVGhlIERPTSBlbGVtZW50IHRvIGNlbnRlciB3aXRoaW4gdGhlIHNjcm9sbCBjb250YWluZXIuCiAgICovCiAgc2Nyb2xsQ2VudGVyZWQodCkgewogICAgaWYgKHQgIT0gbnVsbCkgewogICAgICBsZXQgZSA9IHRoaXMuc2Nyb2xsQ29udGFpbmVyOwogICAgICBjb25zdCBpID0gdC5vZmZzZXRIZWlnaHQsIG4gPSBlLmNsaWVudEhlaWdodCwgciA9IHQub2Zmc2V0VG9wIC0gZS5vZmZzZXRUb3AgLSBuIC8gMiArIGkgLyAyLCBvID0gZS5zY3JvbGxIZWlnaHQgLSBuLCBsID0gTWF0aC5tYXgoMCwgTWF0aC5taW4ociwgbykpOwogICAgICBlLnNjcm9sbFRvKHsgdG9wOiBsLCBiZWhhdmlvcjogInNtb290aCIgfSk7CiAgICB9CiAgfQogIC8qKgogICAqIE9wZW5zIHRoZSBzcGVjaWZpZWQgcGF0aCBpbiB0aGUgdHJlZSB2aWV3LgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgcGF0aCB0byBvcGVuIGluIHRoZSB0cmVlIHZpZXcuCiAgICovCiAgb3BlblBhdGgodCkgewogICAgY29uc3QgZSA9IHQuc3BsaXQoIi8iKS5maWx0ZXIoQm9vbGVhbik7CiAgICB2YXIgaSA9ICIiLCBuOwogICAgbGV0IHM7CiAgICBmb3IgKHZhciByIG9mIGUpCiAgICAgIGlmIChpICs9ICIvIiArIHIsIG4gPSB0aGlzLmZpbmROb2RlQnlQYXRoKGkpLCBzID0gdGhpcy5nZXREb21Ob2RlKGkpLCBuKQogICAgICAgIG4uZXhwYW5kZWQgPSAhMCwgdGhpcy5zaG93Q2hpbGRDb250YWluZXIobiksIHRoaXMuZGVidWcgJiYgY29uc29sZS5sb2coInVwZGF0ZSA9PiBvcGVuUGF0aCIpLCB0aGlzLnVwZGF0ZSgpOwogICAgICBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBQYXRoIG5vdCBmb3VuZDogJHtpfWApOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB0aGlzLnNjcm9sbENlbnRlcmVkKHMpLCB0aGlzLnRvZ2dsZUxhYmVsQ29sb3Iobik7CiAgfQogIC8qKgogICAqIENsb3NlcyB0aGUgc3BlY2lmaWVkIHBhdGggaW4gdGhlIHRyZWUgdmlldy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gVGhlIHBhdGggdG8gYmUgY2xvc2VkLgogICAqLwogIGNsb3NlUGF0aCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5maW5kTm9kZUJ5UGF0aCh0KTsKICAgIGlmIChlKSB7CiAgICAgIGUuZXhwYW5kZWQgPSAhMSwgdGhpcy5zaG93Q2hpbGRDb250YWluZXIoZSk7CiAgICAgIGNvbnN0IGkgPSB0aGlzLmdldERvbU5vZGUodCk7CiAgICAgIGlmIChpICE9IG51bGwpIHsKICAgICAgICBjb25zdCBuID0gdGhpcy5zY3JvbGxDb250YWluZXI7CiAgICAgICAgbi5zY3JvbGxUb3AgPSBpLm9mZnNldFRvcCAtIG4ub2Zmc2V0VG9wOwogICAgICB9CiAgICAgIHRoaXMuZGVidWcgJiYgY29uc29sZS5sb2coInVwZGF0ZSA9PiBjb2xsYXBzZVBhdGgiKSwgdGhpcy51cGRhdGUoKTsKICAgIH0gZWxzZQogICAgICBjb25zb2xlLmVycm9yKGBQYXRoIG5vdCBmb3VuZDogJHt0fWApOwogIH0KICAvKioKICAgKiBPcGVucyB0aGUgc3BlY2lmaWVkIGxldmVsIGluIHRoZSB0cmVlIHZpZXcuCiAgICogQHBhcmFtIHtudW1iZXJ9IGxldmVsIC0gVGhlIGxldmVsIHRvIG9wZW4uCiAgICovCiAgb3BlbkxldmVsKHQpIHsKICAgIGNvbnN0IGUgPSAocykgPT4gewogICAgICB0aGlzLmlzTGVhZihzKSB8fCAodCA9PSAtMSA/IHMuZXhwYW5kZWQgPSBzLmNoaWxkcmVuICE9IG51bGwgJiYgIShPYmplY3Qua2V5cyhzLmNoaWxkcmVuKS5sZW5ndGggPT0gMSAmJiB0aGlzLmlzTGVhZihPYmplY3QudmFsdWVzKHMuY2hpbGRyZW4pWzBdKSkgOiBzLmV4cGFuZGVkID0gcy5sZXZlbCA8IHQpOwogICAgfTsKICAgIHRoaXMudHJhdmVyc2UodGhpcy5yb290LCBlKTsKICAgIGNvbnN0IGkgPSB0aGlzLmdldERvbU5vZGUodGhpcy5nZXROb2RlUGF0aCh0aGlzLnJvb3QpKTsKICAgIGlmIChpICE9IG51bGwpIHsKICAgICAgY29uc3QgcyA9IHRoaXMuc2Nyb2xsQ29udGFpbmVyOwogICAgICBzLnNjcm9sbFRvcCA9IGkub2Zmc2V0VG9wIC0gcy5vZmZzZXRUb3A7CiAgICB9CiAgICBmb3IgKHZhciBuID0gMDsgbiA8PSAodCA9PSAtMSA/IHRoaXMubWF4TGV2ZWwgOiB0KTsgbisrKQogICAgICB0aGlzLmRlYnVnICYmIGNvbnNvbGUubG9nKCJ1cGRhdGUgPT4gb3BlbkxldmVsIiksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIENvbGxhcHNlcyBhbGwgbm9kZXMgaW4gdGhlIHRyZWUgdmlldy4KICAgKi8KICBjb2xsYXBzZUFsbCgpIHsKICAgIHRoaXMub3BlbkxldmVsKDApOwogIH0KICAvKioKICAgKiBFeHBhbmRzIGFsbCBub2RlcyBpbiB0aGUgdHJlZXZpZXcuCiAgICovCiAgZXhwYW5kQWxsKCkgewogICAgdGhpcy5vcGVuTGV2ZWwodGhpcy5tYXhMZXZlbCk7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLnJvb3QgPSBudWxsLCB0aGlzLnRyZWUgPSBudWxsLCB0aGlzLnNjcm9sbENvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJzY3JvbGwiLCB0aGlzLmhhbmRsZVNjcm9sbCk7CiAgfQp9CmNsYXNzIHVkIHsKICBjb25zdHJ1Y3Rvcih0LCBlKSB7CiAgICB0aGlzLnByZWZpeCA9IHQsIHRoaXMudGltZWl0ID0gZSwgdGhpcy5zdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpLCB0aGlzLmxhc3QgPSB0aGlzLnN0YXJ0LCBlICYmIGNvbnNvbGUuaW5mbyhgdGhyZWUtY2FkLXZpZXdlcjogJHt0fTp0aW1lciBzdGFydGApOwogIH0KICBzcGxpdCh0KSB7CiAgICBpZiAodGhpcy50aW1laXQpIHsKICAgICAgY29uc3QgZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICBjb25zb2xlLmluZm8oCiAgICAgICAgYHRocmVlLWNhZC12aWV3ZXI6ICR7dGhpcy5wcmVmaXh9OiR7dH06dGltZXIgc3BsaXQgJHsoZSAtIHRoaXMubGFzdCkudG9GaXhlZCgxKX0gbXNgCiAgICAgICksIHRoaXMubGFzdCA9IGU7CiAgICB9CiAgfQogIHN0b3AoKSB7CiAgICBpZiAodGhpcy50aW1laXQpIHsKICAgICAgY29uc3QgdCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICBjb25zb2xlLmluZm8oCiAgICAgICAgYHRocmVlLWNhZC12aWV3ZXI6ICR7dGhpcy5wcmVmaXh9OnRpbWVyIHN0b3AgJHsodCAtIHRoaXMuc3RhcnQpLnRvRml4ZWQoCiAgICAgICAgICAxCiAgICAgICAgKX0gbXM6YAogICAgICApOwogICAgfQogIH0KfQpjb25zdCBkZCA9IFsKICBuZXcgRSgtMSwgMCwgMCksCiAgbmV3IEUoMCwgLTEsIDApLAogIG5ldyBFKDAsIDAsIC0xKQpdLCBYbCA9IHsKICBsaWdodDogWzE2NzExNjgwLCA2NTI4MCwgMjU1XSwKICBkYXJrOiBbMTY3MjkzNDQsIDMzMjkzMzAsIDM5MDczMjddCn0sIHRUID0gbmV3IGxpKHsKICBvcGFjaXR5OiAwLjEsCiAgdHJhbnNwYXJlbnQ6ICEwLAogIGRlcHRoV3JpdGU6ICExLAogIHRvbmVNYXBwZWQ6ICExLAogIHNpZGU6IE1pCn0pLCBlVCA9IG5ldyBsaSh7CiAgZGVwdGhXcml0ZTogITEsCiAgZGVwdGhUZXN0OiAhMSwKICBjb2xvcldyaXRlOiAhMSwKICBzaWRlOiBIZSwKICBzdGVuY2lsV3JpdGU6ICEwLAogIHN0ZW5jaWxGdW5jOiBUbywKICBzdGVuY2lsRmFpbDogU2gsCiAgc3RlbmNpbFpGYWlsOiBTaCwKICBzdGVuY2lsWlBhc3M6IFNoCn0pLCBpVCA9IG5ldyBsaSh7CiAgZGVwdGhXcml0ZTogITEsCiAgZGVwdGhUZXN0OiAhMSwKICBjb2xvcldyaXRlOiAhMSwKICBzaWRlOiAkaSwKICBzdGVuY2lsV3JpdGU6ICEwLAogIHN0ZW5jaWxGdW5jOiBUbywKICBzdGVuY2lsRmFpbDogd2gsCiAgc3RlbmNpbFpGYWlsOiB3aCwKICBzdGVuY2lsWlBhc3M6IHdoCn0pLCBuVCA9IG5ldyBocih7CiAgbWV0YWxuZXNzOiAwLjMsCiAgcm91Z2huZXNzOiAwLjY1LAogIG9wYWNpdHk6IDEsCiAgdHJhbnNwYXJlbnQ6ICExLAogIHNpZGU6IE1pLAogIHBvbHlnb25PZmZzZXQ6ICEwLAogIHBvbHlnb25PZmZzZXRGYWN0b3I6IDEsCiAgcG9seWdvbk9mZnNldFVuaXRzOiAxLAogIHN0ZW5jaWxXcml0ZTogITAsCiAgc3RlbmNpbFJlZjogMCwKICBzdGVuY2lsRnVuYzogcnksCiAgc3RlbmNpbEZhaWw6IE1oLAogIHN0ZW5jaWxaRmFpbDogTWgsCiAgc3RlbmNpbFpQYXNzOiBNaAp9KTsKY2xhc3MgeWcgZXh0ZW5kcyBxbiB7CiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIodCwgZSksIHRoaXMuY2VudGVyID0gaSwgdGhpcy5zZXRDb25zdGFudChlKTsKICB9CiAgc2V0Q29uc3RhbnQodCkgewogICAgdGhpcy5jZW50ZXJlZENvbnN0YW50ID0gdDsKICAgIGNvbnN0IGUgPSB0aGlzLmRpc3RhbmNlVG9Qb2ludChuZXcgRSguLi50aGlzLmNlbnRlcikpLCBpID0gdGhpcy5kaXN0YW5jZVRvUG9pbnQobmV3IEUoMCwgMCwgMCkpOwogICAgdGhpcy5jb25zdGFudCA9IGkgLSBlICsgdDsKICB9Cn0KY29uc3QgeG8gPSBjbGFzcyB4byBleHRlbmRzIHJlIHsKICBjb25zdHJ1Y3RvcihlLCBpLCBuLCBzLCByLCBvLCBsKSB7CiAgICBjb25zdCBoID0gbmV3IERzKDIsIDIpOwogICAgaC5jb21wdXRlQm91bmRpbmdTcGhlcmUoKSwgci5jb2xvci5zZXQobmV3IGN0KG8pKTsKICAgIHN1cGVyKGgsIHIpOwogICAgayh0aGlzLCAib25BZnRlclJlbmRlciIsIChlKSA9PiB7CiAgICAgIHRoaXMudHlwZS5zdGFydHNXaXRoKCJTdGVuY2lsUGxhbmUiKSAmJiBlLmNsZWFyU3RlbmNpbCgpOwogICAgfSk7CiAgICB0aGlzLnR5cGUgPSBsLCB0aGlzLmluZGV4ID0gZSwgdGhpcy5wbGFuZSA9IGksIHRoaXMuc2l6ZSA9IHMsIHRoaXMuY2VudGVyID0gbjsKICB9CiAgLy8gaHR0cHM6Ly9kaXNjb3Vyc2UudGhyZWVqcy5vcmcvdC9jZW50ZXItdGhyZWVqcy1wbGFuZWhlbHBlci1vbi1nZW9tZXRyeS80ODUxNi80CiAgdXBkYXRlTWF0cml4V29ybGQoZSkgewogICAgdGhpcy5wb3NpdGlvbi5zZXQoMCwgMCwgMCksIHRoaXMuc2NhbGUuc2V0KDAuNSAqIHRoaXMuc2l6ZSwgMC41ICogdGhpcy5zaXplLCAxKSwgeG8ubWF0cml4Lmxvb2tBdCh0aGlzLnBvc2l0aW9uLCB0aGlzLnBsYW5lLm5vcm1hbCwgdGhpcy51cCksIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgoeG8ubWF0cml4KSwgdGhpcy50cmFuc2xhdGVaKHRoaXMucGxhbmUuY29uc3RhbnQpLCBzdXBlci51cGRhdGVNYXRyaXhXb3JsZCh0aGlzLCBlKTsKICB9Cn07CmsoeG8sICJtYXRyaXgiLCBuZXcgVnQoKSk7CmxldCBNYyA9IHhvOwpmdW5jdGlvbiBfZyhhLCB0LCBlLCBpKSB7CiAgdC5jbGlwcGluZ1BsYW5lcyA9IFtpXTsKICBjb25zdCBuID0gbmV3IHJlKGUsIHQpOwogIHJldHVybiBuLm5hbWUgPSBhLCBuOwp9CmNsYXNzIHNUIGV4dGVuZHMgeWkgewogIGNvbnN0cnVjdG9yKGUsIGksIG4sIHMsIHIpIHsKICAgIHN1cGVyKCk7CiAgICBrKHRoaXMsICJzZXROb3JtYWwiLCAoZSwgaSkgPT4gewogICAgICB2YXIgbiA9IGkuY2xvbmUoKTsKICAgICAgdGhpcy5jbGlwUGxhbmVzW2VdLm5vcm1hbCA9IG4sIHRoaXMucmV2ZXJzZUNsaXBQbGFuZXNbZV0ubm9ybWFsID0gbi5jbG9uZSgpLm5lZ2F0ZSgpLCB0aGlzLnNldENvbnN0YW50KGUsIHRoaXMuZGlzdGFuY2UpLCB0aGlzLmRpc3BsYXkuc2V0Tm9ybWFsTGFiZWwoZSwgbi50b0FycmF5KCkpOwogICAgfSk7CiAgICBrKHRoaXMsICJnZXRPYmplY3RDb2xvckNhcHMiLCAoKSA9PiB0aGlzLm9iamVjdENvbG9yQ2Fwcyk7CiAgICBrKHRoaXMsICJzZXRPYmplY3RDb2xvckNhcHMiLCAoZSkgPT4gewogICAgICB2YXIgaTsKICAgICAgZm9yIChpIG9mIHRoaXMubmVzdGVkR3JvdXAucm9vdEdyb3VwLmNoaWxkcmVuKQogICAgICAgIGlmIChpLm5hbWUgPT09ICJQbGFuZU1lc2hlcyIpCiAgICAgICAgICBicmVhazsKICAgICAgdmFyIG4gPSAwLCBzID0gLTE7CiAgICAgIGNvbnN0IHIgPSBPYmplY3Qua2V5cyhpLmNoaWxkcmVuKS5sZW5ndGggLyAzOwogICAgICBmb3IgKHZhciBvIG9mIGkuY2hpbGRyZW4pCiAgICAgICAgbiAlIHIgPT09IDAgJiYgcysrLCBlID8gby5tYXRlcmlhbC5jb2xvci5zZXQobmV3IGN0KHRoaXMub2JqZWN0Q29sb3JzW25dKSkgOiBvLm1hdGVyaWFsLmNvbG9yLnNldChuZXcgY3QoWGxbdGhpcy50aGVtZV1bc10pKSwgbisrOwogICAgICB0aGlzLm9iamVjdENvbG9yQ2FwcyA9IGU7CiAgICB9KTsKICAgIGsodGhpcywgInNldFZpc2libGUiLCAoZSkgPT4gewogICAgICB2YXIgaTsKICAgICAgZm9yIChpIG9mIHRoaXMubmVzdGVkR3JvdXAucm9vdEdyb3VwLmNoaWxkcmVuKQogICAgICAgIGlmIChpLm5hbWUgPT09ICJQbGFuZU1lc2hlcyIpCiAgICAgICAgICBicmVhazsKICAgICAgZm9yICh2YXIgbiBvZiBpLmNoaWxkcmVuKQogICAgICAgIG4ubWF0ZXJpYWwudmlzaWJsZSA9IGU7CiAgICB9KTsKICAgIHRoaXMuY2VudGVyID0gZSwgdGhpcy5kaXN0YW5jZSA9IGkgLyAyLCB0aGlzLmRpc3BsYXkgPSBzLCB0aGlzLnRoZW1lID0gciwgdGhpcy5uZXN0ZWRHcm91cCA9IG4sIHRoaXMucGxhbmVIZWxwZXJzID0gbmV3IHlpKCksIHRoaXMucGxhbmVIZWxwZXJzLm5hbWUgPSAiUGxhbmVIZWxwZXJzIiwgdGhpcy5jbGlwUGxhbmVzID0gW10sIHRoaXMucmV2ZXJzZUNsaXBQbGFuZXMgPSBbXSwgdGhpcy5hZGQodGhpcy5wbGFuZUhlbHBlcnMpLCB0aGlzLm5hbWUgPSAiUGxhbmVIZWxwZXJzIiwgdGhpcy5vYmplY3RDb2xvcnMgPSBbXSwgdGhpcy5vYmplY3RDb2xvckNhcHMgPSAhMTsKICAgIHZhciBvOwogICAgZm9yIChvID0gMDsgbyA8IDM7IG8rKykgewogICAgICBjb25zdCBmID0gbmV3IHlnKGRkW29dLCB0aGlzLmRpc3RhbmNlLCBlKTsKICAgICAgdGhpcy5jbGlwUGxhbmVzLnB1c2goZik7CiAgICAgIGNvbnN0IHkgPSBuZXcgeWcoCiAgICAgICAgZGRbb10uY2xvbmUoKS5uZWdhdGUoKSwKICAgICAgICAtdGhpcy5kaXN0YW5jZSwKICAgICAgICBlCiAgICAgICk7CiAgICAgIHRoaXMucmV2ZXJzZUNsaXBQbGFuZXMucHVzaCh5KSwgdGhpcy5kaXNwbGF5LnNldE5vcm1hbExhYmVsKG8sIGRkW29dLnRvQXJyYXkoKSk7CiAgICAgIGNvbnN0IGcgPSB0VC5jbG9uZSgpOwogICAgICBnLm9wYWNpdHkgPSByID09PSAiZGFyayIgPyAwLjIgOiAwLjEsIHRoaXMucGxhbmVIZWxwZXJzLmFkZCgKICAgICAgICBuZXcgTWMoCiAgICAgICAgICBvLAogICAgICAgICAgZiwKICAgICAgICAgIGUsCiAgICAgICAgICBpLAogICAgICAgICAgZywKICAgICAgICAgIFhsW3JdW29dLAogICAgICAgICAgIlBsYW5lSGVscGVyIgogICAgICAgICkKICAgICAgKTsKICAgIH0KICAgIGZvciAodGhpcy5wbGFuZUhlbHBlcnMudmlzaWJsZSA9ICExLCBvID0gMDsgbyA8IDM7IG8rKykgewogICAgICBjb25zdCBmID0gdGhpcy5jbGlwUGxhbmVzLmZpbHRlcigoeSwgZykgPT4gZyAhPT0gbyk7CiAgICAgIHRoaXMucGxhbmVIZWxwZXJzLmNoaWxkcmVuW29dLm1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzID0gZjsKICAgIH0KICAgIHZhciBsID0gbmV3IHlpKCk7CiAgICBmb3IgKGwubmFtZSA9ICJQbGFuZU1lc2hlcyIsIG8gPSAwOyBvIDwgMzsgbysrKSB7CiAgICAgIGNvbnN0IGYgPSB0aGlzLmNsaXBQbGFuZXNbb10sIHkgPSB0aGlzLmNsaXBQbGFuZXMuZmlsdGVyKChnLCBtKSA9PiBtICE9PSBvKTsKICAgICAgdmFyIGggPSAwOwogICAgICBmb3IgKHZhciBjIGluIG4uZ3JvdXBzKSB7CiAgICAgICAgdmFyIHUgPSBuZXcgeWkoKTsKICAgICAgICB1Lm5hbWUgPSBgY2xpcHBpbmctJHtvfWA7CiAgICAgICAgdmFyIGQgPSBuLmdyb3Vwc1tjXTsKICAgICAgICBpZiAoZCBpbnN0YW5jZW9mIGxuICYmIGQuc3VidHlwZSA9PT0gInNvbGlkIikgewogICAgICAgICAgdGhpcy5vYmplY3RDb2xvcnMucHVzaChkLmNoaWxkcmVuWzBdLm1hdGVyaWFsLmNvbG9yLmdldEhleCgpKSwgdS5hZGQoCiAgICAgICAgICAgIF9nKAogICAgICAgICAgICAgIGBmcm9udFN0ZW5jaWwtJHtvfS0ke2h9YCwKICAgICAgICAgICAgICBpVC5jbG9uZSgpLAogICAgICAgICAgICAgIGQuc2hhcGVHZW9tZXRyeSwKICAgICAgICAgICAgICBmCiAgICAgICAgICAgICkKICAgICAgICAgICksIHUuYWRkKAogICAgICAgICAgICBfZygKICAgICAgICAgICAgICBgYmFja1N0ZW5jaWwtJHtvfS0ke2h9YCwKICAgICAgICAgICAgICBlVC5jbG9uZSgpLAogICAgICAgICAgICAgIGQuc2hhcGVHZW9tZXRyeSwKICAgICAgICAgICAgICBmCiAgICAgICAgICAgICkKICAgICAgICAgICksIGQuYWRkVHlwZSh1LCBgY2xpcHBpbmctJHtvfWApOwogICAgICAgICAgdmFyIHAgPSBuVC5jbG9uZSgpOwogICAgICAgICAgcC5jb2xvci5zZXQobmV3IGN0KFhsW3JdW29dKSksIHAuY2xpcHBpbmdQbGFuZXMgPSB5LCBsLmFkZCgKICAgICAgICAgICAgbmV3IE1jKAogICAgICAgICAgICAgIG8sCiAgICAgICAgICAgICAgZiwKICAgICAgICAgICAgICBlLAogICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgcCwKICAgICAgICAgICAgICBYbFtyXVtvXSwKICAgICAgICAgICAgICBgU3RlbmNpbFBsYW5lLSR7b30tJHtofWAKICAgICAgICAgICAgKQogICAgICAgICAgKSwgaCsrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbi5yb290R3JvdXAuYWRkKGwpOwogIH0KICBzZXRDb25zdGFudChlLCBpKSB7CiAgICB0aGlzLmNsaXBQbGFuZXNbZV0uc2V0Q29uc3RhbnQoaSksIHRoaXMucmV2ZXJzZUNsaXBQbGFuZXNbZV0uc2V0Q29uc3RhbnQoLWkpOwogIH0KICBkaXNwb3NlKCkgewogICAgbWUodGhpcy5jbGlwUGxhbmVzKSwgbWUodGhpcy5yZXZlcnNlQ2xpcFBsYW5lcyksIHRoaXMubmVzdGVkR3JvdXAgPSBudWxsLCB0aGlzLmNsaXBQbGFuZXMgPSBudWxsLCB0aGlzLnJldmVyc2VDbGlwUGxhbmVzID0gbnVsbCwgdGhpcy5vYmplY3RDb2xvcnMgPSBudWxsLCB0aGlzLmRpc3BsYXkgPSBudWxsLCB0aGlzLmNlbnRlciA9IG51bGw7CiAgfQp9CmNvbnN0IHhnID0gWyJ0IiwgInR4IiwgInR5IiwgInR6IiwgInEiLCAicngiLCAicnkiLCAicnoiXTsKZnVuY3Rpb24gclQoYSwgdCkgewogIHN3aXRjaCAoYSkgewogICAgY2FzZSAieCI6CiAgICAgIGEgPSBuZXcgRSgxLCAwLCAwKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJ5IjoKICAgICAgYSA9IG5ldyBFKDAsIDEsIDApOwogICAgICBicmVhazsKICAgIGNhc2UgInoiOgogICAgICBhID0gbmV3IEUoMCwgMCwgMSk7CiAgICAgIGJyZWFrOwogIH0KICB2YXIgZSA9IG5ldyB2ZSgpOwogIHJldHVybiBlLnNldEZyb21BeGlzQW5nbGUoYSwgdCAvIDE4MCAqIE1hdGguUEkpLCBlOwp9CmNsYXNzIGFUIHsKICBjb25zdHJ1Y3Rvcih0KSB7CiAgICB0aGlzLmRlbGltID0gdCwgdGhpcy50cmFja3MgPSBbXSwgdGhpcy5taXhlciA9IG51bGwsIHRoaXMuY2xpcCA9IG51bGwsIHRoaXMuY2xpcEFjdGlvbiA9IG51bGwsIHRoaXMuY2xvY2sgPSBuZXcgbGYoKSwgdGhpcy5kdXJhdGlvbiA9IDAsIHRoaXMuX2JhY2t1cCA9IFtdLCB0aGlzLnJvb3QgPSBudWxsLCB0aGlzLmR1cmF0aW9uID0gbnVsbCwgdGhpcy5zcGVlZCA9IG51bGwsIHRoaXMucmVwZWF0ID0gbnVsbDsKICB9CiAgYWRkVHJhY2sodCwgZSwgaSwgbiwgcykgewogICAgaWYgKHQgPSB0LnJlcGxhY2VBbGwoIi8iLCB0aGlzLmRlbGltKSwgeGcuaW5kZXhPZihpKSA9PT0gLTEpIHsKICAgICAgY29uc29sZS5lcnJvcihgVW5rbm93biBhY3Rpb246ICIke2l9IiBub3QgaW4gJHt4Z31gKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKG4ubGVuZ3RoICE9IHMubGVuZ3RoKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoInRpbWVzIGFuZCB2YWx1ZXMgYXJyYXlzIG5lZWQgaGF2ZSB0aGUgc2FtZSBsZW5naHQiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHI7CiAgICBpZiAoaS5zdGFydHNXaXRoKCJ0IikpIHsKICAgICAgY29uc3QgbyA9IGUucG9zaXRpb247CiAgICAgIHN3aXRjaCAoaSkgewogICAgICAgIGNhc2UgInQiOgogICAgICAgICAgciA9IHMubWFwKAogICAgICAgICAgICAobCkgPT4gby5jbG9uZSgpLmFkZChuZXcgRSguLi5sKSkudG9BcnJheSgpCiAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAidHgiOgogICAgICAgICAgciA9IHMubWFwKAogICAgICAgICAgICAobCkgPT4gby5hZGQobmV3IEUobCwgMCwgMCkpLnRvQXJyYXkoKQogICAgICAgICAgKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInR5IjoKICAgICAgICAgIHIgPSBzLm1hcCgKICAgICAgICAgICAgKGwpID0+IG8uYWRkKG5ldyBFKDAsIGwsIDApKS50b0FycmF5KCkKICAgICAgICAgICk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJ0eiI6CiAgICAgICAgICByID0gcy5tYXAoCiAgICAgICAgICAgIChsKSA9PiBvLmFkZChuZXcgRSgwLCAwLCBsKSkudG9BcnJheSgpCiAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGFjdGlvbiAke2l9IGlzIG5vdCBzdXBwb3J0ZWRgKTsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRyYWNrcy5wdXNoKAogICAgICAgIG5ldyBiYSgKICAgICAgICAgIHQgKyAiLnBvc2l0aW9uIiwKICAgICAgICAgIG4sCiAgICAgICAgICByLmZsYXQoKQogICAgICAgICkKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IG8gPSBlLnF1YXRlcm5pb247CiAgICAgIGlmIChpLnN0YXJ0c1dpdGgoInIiKSkKICAgICAgICByID0gcy5tYXAoCiAgICAgICAgICAoaCkgPT4gclQoaS5zbGljZSgxKSwgaCkKICAgICAgICApLm1hcCgKICAgICAgICAgIChoKSA9PiBvLmNsb25lKCkubXVsdGlwbHkoaCkudG9BcnJheSgpCiAgICAgICAgKTsKICAgICAgZWxzZSBpZiAoaSA9PSAicSIpCiAgICAgICAgciA9IHMubWFwKChsKSA9PiBvLmNsb25lKCkubXVsdGlwbHkobCkudG9BcnJheSgpKTsKICAgICAgZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgYWN0aW9uICR7aX0gaXMgbm90IHN1cHBvcnRlZGApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnRyYWNrcy5wdXNoKAogICAgICAgIG5ldyBQYSgKICAgICAgICAgIHQgKyAiLnF1YXRlcm5pb24iLAogICAgICAgICAgbiwKICAgICAgICAgIHIuZmxhdCgpCiAgICAgICAgKQogICAgICApOwogICAgfQogIH0KICBiYWNrdXAoKSB7CiAgICB0aGlzLl9iYWNrdXAgPSB7CiAgICAgIHRyYWNrczogdGhpcy50cmFja3MsCiAgICAgIHJvb3Q6IHRoaXMucm9vdCwKICAgICAgZHVyYXRpb246IHRoaXMuZHVyYXRpb24sCiAgICAgIHNwZWVkOiB0aGlzLnNwZWVkLAogICAgICByZXBlYXQ6IHRoaXMucmVwZWF0CiAgICB9OwogIH0KICByZXN0b3JlKCkgewogICAgcmV0dXJuIHRoaXMudHJhY2tzID0gdGhpcy5fYmFja3VwLnRyYWNrcywgewogICAgICBkdXJhdGlvbjogdGhpcy5fYmFja3VwLmR1cmF0aW9uLAogICAgICBzcGVlZDogdGhpcy5fYmFja3VwLnNwZWVkLAogICAgICByZXBlYXQ6IHRoaXMuX2JhY2t1cC5yZXBlYXQKICAgIH07CiAgfQogIGNsZWFuQmFja3VwKCkgewogICAgdGhpcy5fYmFja3VwID0gW107CiAgfQogIGhhc1RyYWNrcygpIHsKICAgIHJldHVybiB0aGlzLnRyYWNrcyAhPSBudWxsICYmIHRoaXMudHJhY2tzLmxlbmd0aCA+IDA7CiAgfQogIGhhc0JhY2t1cCgpIHsKICAgIHJldHVybiB0aGlzLl9iYWNrdXAgIT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0aGlzLl9iYWNrdXApLmxlbmd0aCA+IDA7CiAgfQogIGFuaW1hdGUodCwgZSwgaSwgbiA9ICEwKSB7CiAgICByZXR1cm4gdGhpcy5yb290ID0gdCwgdGhpcy5kdXJhdGlvbiA9IGUsIHRoaXMuc3BlZWQgPSBpLCB0aGlzLnJlcGVhdCA9IG4sIHRoaXMuY2xpcCA9IG5ldyBNYSgidHJhY2siLCBlLCB0aGlzLnRyYWNrcyksIHRoaXMubWl4ZXIgPSBuZXcgeV8odCksIHRoaXMubWl4ZXIudGltZVNjYWxlID0gaSwgdGhpcy5jbGlwQWN0aW9uID0gdGhpcy5taXhlci5jbGlwQWN0aW9uKHRoaXMuY2xpcCksIHRoaXMuY2xpcEFjdGlvbi5zZXRMb29wKG4gPyBJcCA6IExwKSwgdGhpcy5jbGlwQWN0aW9uOwogIH0KICBzZXRSZWxhdGl2ZVRpbWUodCkgewogICAgdGhpcy5jbGlwQWN0aW9uLnBsYXkoKSwgdGhpcy5jbGlwQWN0aW9uLnBhdXNlZCA9ICEwOwogICAgdmFyIGUgPSB0aGlzLmR1cmF0aW9uICogdDsKICAgIHRoaXMuY2xpcEFjdGlvbi50aW1lID0gZTsKICB9CiAgZ2V0UmVsYXRpdmVUaW1lKCkgewogICAgcmV0dXJuIHRoaXMuY2xpcEFjdGlvbi50aW1lIC8gdGhpcy5kdXJhdGlvbjsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMubWl4ZXIgPSBudWxsLCB0aGlzLmNsaXBBY3Rpb24gPSBudWxsLCB0aGlzLmNsaXAgPSBudWxsLCB0aGlzLnRyYWNrcyA9IFtdLCB0aGlzLnJvb3QgPSBudWxsOwogIH0KICB1cGRhdGUoKSB7CiAgICB0aGlzLm1peGVyICYmIHRoaXMubWl4ZXIudXBkYXRlKHRoaXMuY2xvY2suZ2V0RGVsdGEoKSk7CiAgfQp9CmNsYXNzIG9UIHsKICBjb25zdHJ1Y3Rvcih0LCBlKSB7CiAgICB0aGlzLmh0bWwgPSB0LCB0aGlzLmNsZWFyKCk7CiAgfQogIGNsZWFyKCkgewogICAgdGhpcy5odG1sLnZhbHVlID0gIiIsIHRoaXMubnVtYmVyID0gMCwgdGhpcy5jaHVua3MgPSBbXTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuY2xlYXIoKSwgdGhpcy5odG1sLmlubmVySFRNTCA9ICIiOwogIH0KICBhZGRUZXh0KHQpIHsKICAgIHRoaXMuYWRkSHRtbChgPHByZSBzdHlsZT0id2hpdGUtc3BhY2U6IG5vd3JhcDsiPiR7dH08L3ByZT5gKTsKICB9CiAgYWRkSHRtbCh0KSB7CiAgICB0aGlzLmNodW5rcy51bnNoaWZ0KFt0aGlzLm51bWJlciwgdF0pLCB0aGlzLm51bWJlciArPSAxLCB0aGlzLnJlbmRlcigpOwogIH0KICByZW5kZXIoKSB7CiAgICB2YXIgdCA9ICI8dGFibGUgY2xhc3M9J3Rjdl9pbmZvX3RhYmxlJz4iOwogICAgZm9yICh2YXIgZSBvZiB0aGlzLmNodW5rcykKICAgICAgdCArPSAiPHRyIGNsYXNzPSd0Y3ZfaW5mb19yb3cnPiIsIHQgKz0gYDx0ZD48cHJlIGNsYXNzPSJ0Y3ZfaW5mb19udW0iPlske2VbMF19XTwvcHJlPjwvdGQ+YCwgdCArPSBgPHRkPiR7ZVsxXX08L3RkPmAsIHQgKz0gIjwvdHI+IjsKICAgIHQgKz0gIjwvdGFibGU+IiwgdGhpcy5odG1sLmlubmVySFRNTCA9IHQ7CiAgfQogIHZlcnNpb25Nc2codCwgZSkgewogICAgdGhpcy5hZGRIdG1sKAogICAgICBgPGI+VmVyc2lvbnM8L2I+CiAgICAgICAgICA8dGFibGU+CiAgICAgICAgICAgIDx0ciBjbGFzcz0idGN2X3NtYWxsX3RhYmxlIj48dGQ+Q2FkUXVlcnk6PC90ZD4gICAgICAgIDx0ZD4ke3R9PC90ZD4gPC90cj4KICAgICAgICAgICAgPHRyIGNsYXNzPSJ0Y3Zfc21hbGxfdGFibGUiPjx0ZD5KdXB5dGVyIENhZFF1ZXJ5OjwvdGQ+PHRkPiR7ZX08L3RkPiA8L3RyPgogICAgICAgICAgPC90YWJsZT5gCiAgICApOwogIH0KICByZWFkeU1zZyh0LCBlKSB7CiAgICB2YXIgaSA9IGA8ZGl2IGNsYXNzPSJ0Y3ZfaW5mb19oZWFkZXIiPlJlYWR5PC9kaXY+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0ic21hbGxfdGFibGUiPgogICAgICAgICAgICAgIDx0ciBjbGFzcz0idGN2X3NtYWxsX3RhYmxlX3JvdyIgPjx0ZD5WZXJzaW9uPC90ZD48dGQ+JHt0fTwvdGQ+IDwvdHI+CiAgICAgICAgICAgICAgPHRyIGNsYXNzPSJ0Y3Zfc21hbGxfdGFibGVfcm93IiA+PHRkPkNvbnRyb2w8L3RkPjx0ZD4ke2V9PC90ZD48L3RyPgogICAgICAgICAgICAgIDx0ciBjbGFzcz0idGN2X3NtYWxsX3RhYmxlX3JvdyIgPjx0ZD5BeGVzPC90ZD4KICAgICAgICAgICAgICAgIDx0ZD4KICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl9pbmZvX3JlZCI+PGI+WDwvYj48L3NwYW4+LAogICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idGN2X2luZm9fZ3JlZW4iPjxiPlk8L2I+PC9zcGFuPiwKICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9InRjdl9pbmZvX2JsdWUiPjxiPlo8L2I+PC9zcGFuPgogICAgICAgICAgICAgICAgPC90ZD4gCiAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90YWJsZT5gOwogICAgdGhpcy5hZGRIdG1sKGkpOwogIH0KICBiYkluZm8odCwgZSwgaSkgewogICAgdmFyIG4gPSBgCiAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0idGN2X3NtYWxsX3RhYmxlIj4KICAgICAgICAgICAgICAgIDx0ciBjbGFzcz0idGN2X3NtYWxsX3RhYmxlX3JvdyI+CiAgICAgICAgICAgICAgICAgICAgPHRkPjxiPlBhdGg6PC9iPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPHRkPiR7dH08L3RkPgogICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgIDx0ciBjbGFzcz0idGN2X3NtYWxsX3RhYmxlX3JvdyI+CiAgICAgICAgICAgICAgICAgICAgPHRkPjxiPk5hbWU6PC9iPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPHRkPiR7ZX08L3RkPgogICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgYDsKICAgIG4gKz0gYAogICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0Y3ZfaW5mb19oZWFkZXIiPkJvdW5kaW5nIGJveDo8L2Rpdj4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzPSJ0Y3Zfc21hbGxfdGFibGUiPgogICAgICAgICAgICAgICAgPHRyIGNsYXNzPSJ0Y3Zfc21hbGxfdGFibGVfcm93Ij4KICAgICAgICAgICAgICAgICAgICA8dGg+PC90aD4KICAgICAgICAgICAgICAgICAgICA8dGg+bWluPC90aD4KICAgICAgICAgICAgICAgICAgICA8dGg+bWF4PC90aD4KICAgICAgICAgICAgICAgICAgICA8dGg+Y2VudGVyPC90aD4KICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgIGA7CiAgICB2YXIgcyA9IG5ldyBFKCk7CiAgICBpLmdldENlbnRlcihzKSwgWyJ4IiwgInkiLCAieiJdLmZvckVhY2goKHIpID0+IHsKICAgICAgbiArPSBgCiAgICAgICAgICAgICAgICA8dHIgY2xhc3M9InRjdl9zbWFsbF90YWJsZV9yb3ciPgogICAgICAgICAgICAgICAgICAgIDx0aD4ke3J9PC90aD4KICAgICAgICAgICAgICAgICAgICA8dGQgYWxpZ249J3JpZ2h0Jz4ke2kubWluW3JdLnRvRml4ZWQoMyl9PC90ZD4KICAgICAgICAgICAgICAgICAgICA8dGQgYWxpZ249J3JpZ2h0Jz4ke2kubWF4W3JdLnRvRml4ZWQoMyl9PC90ZD4KICAgICAgICAgICAgICAgICAgICA8dGQgYWxpZ249J3JpZ2h0Jz4ke3Nbcl0udG9GaXhlZCgzKX08L3RkPgogICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgYDsKICAgIH0pLCBuICs9ICI8L3RhYmxlPiIsIHRoaXMuYWRkSHRtbChuKTsKICB9CiAgY2VudGVySW5mbyh0KSB7CiAgICB2YXIgZSA9IGA8ZGl2PkNhbWVyYSB0YXJnZXQgc2V0IHRvIEFBQkIgY2VudGVyOjwvZGl2PjxkaXYgY2xhc3M9J3Rjdl9pbmZvX2xpbmUnPnsgeDogJHt0WzBdLnRvRml4ZWQoMil9LCB5OiAke3RbMV0udG9GaXhlZCgyKX0sIHo6ICR7dFsyXS50b0ZpeGVkKDIpfSB9PC9kaXY+YDsKICAgIHRoaXMuYWRkSHRtbChlKTsKICB9Cn0KdmFyIFBzID0gZnVuY3Rpb24oYSwgdCkgewogIHQgPT09IHZvaWQgMCAmJiBjb25zb2xlLndhcm4oJ1RIUkVFLkNhbWVyYUNvbnRyb2xzOiBUaGUgc2Vjb25kIHBhcmFtZXRlciAiZG9tRWxlbWVudCIgaXMgbm93IG1hbmRhdG9yeS4nKSwgdCA9PT0gZG9jdW1lbnQgJiYgY29uc29sZS5lcnJvcignVEhSRUUuQ2FtZXJhQ29udHJvbHM6ICJkb2N1bWVudCIgc2hvdWxkIG5vdCBiZSB1c2VkIGFzIHRoZSB0YXJnZXQgImRvbUVsZW1lbnQiLiBQbGVhc2UgdXNlICJyZW5kZXJlci5kb21FbGVtZW50IiBpbnN0ZWFkLicpLCB0aGlzLm9iamVjdCA9IGEsIHRoaXMuZG9tRWxlbWVudCA9IHQsIHRoaXMuZW5hYmxlZCA9ICEwLCB0aGlzLnRhcmdldCA9IG5ldyBFKCksIHRoaXMudHJhY2tiYWxsID0gITEsIHRoaXMuaG9scm95ZCA9ICEwLCB0aGlzLnJhZGl1cyA9IDAuOSwgdGhpcy5taW5EaXN0YW5jZSA9IDAsIHRoaXMubWF4RGlzdGFuY2UgPSAxIC8gMCwgdGhpcy5taW5ab29tID0gMCwgdGhpcy5tYXhab29tID0gMSAvIDAsIHRoaXMubWluUG9sYXJBbmdsZSA9IDAsIHRoaXMubWF4UG9sYXJBbmdsZSA9IE1hdGguUEksIHRoaXMubWluQXppbXV0aEFuZ2xlID0gLTEgLyAwLCB0aGlzLm1heEF6aW11dGhBbmdsZSA9IDEgLyAwLCB0aGlzLmVuYWJsZURhbXBpbmcgPSAhMSwgdGhpcy5kYW1waW5nRmFjdG9yID0gMC4wNSwgdGhpcy5lbmFibGVab29tID0gITAsIHRoaXMuem9vbVNwZWVkID0gMSwgdGhpcy5lbmFibGVSb3RhdGUgPSAhMCwgdGhpcy5yb3RhdGVTcGVlZCA9IDEsIHRoaXMuZW5hYmxlUGFuID0gITAsIHRoaXMucGFuU3BlZWQgPSAxLCB0aGlzLnNjcmVlblNwYWNlUGFubmluZyA9ICExLCB0aGlzLmtleVBhblNwZWVkID0gNywgdGhpcy5hdXRvUm90YXRlID0gITEsIHRoaXMuYXV0b1JvdGF0ZVNwZWVkID0gMiwgdGhpcy5lbmFibGVLZXlzID0gITAsIHRoaXMua2V5cyA9IHsgTEVGVDogMzcsIFVQOiAzOCwgUklHSFQ6IDM5LCBCT1RUT006IDQwIH0sIHRoaXMubW91c2VCdXR0b25zID0geyBMRUZUOiBaZS5ST1RBVEUsIE1JRERMRTogWmUuRE9MTFksIFJJR0hUOiBaZS5QQU4gfSwgdGhpcy50b3VjaGVzID0geyBPTkU6IHppLlJPVEFURSwgVFdPOiB6aS5ET0xMWV9QQU4gfSwgdGhpcy50YXJnZXQwID0gdGhpcy50YXJnZXQuY2xvbmUoKSwgdGhpcy5wb3NpdGlvbjAgPSB0aGlzLm9iamVjdC5wb3NpdGlvbi5jbG9uZSgpLCB0aGlzLnF1YXRlcm5pb24wID0gdGhpcy5vYmplY3QucXVhdGVybmlvbi5jbG9uZSgpLCB0aGlzLnpvb20wID0gdGhpcy5vYmplY3Quem9vbSwgdGhpcy5nZXRQb2xhckFuZ2xlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdS5waGk7CiAgfSwgdGhpcy5nZXRBemltdXRoYWxBbmdsZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHUudGhldGE7CiAgfSwgdGhpcy5zYXZlU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIG4udGFyZ2V0MC5jb3B5KG4udGFyZ2V0KSwgbi5wb3NpdGlvbjAuY29weShuLm9iamVjdC5wb3NpdGlvbiksIG4ucXVhdGVybmlvbjAuY29weShuLm9iamVjdC5xdWF0ZXJuaW9uKSwgbi56b29tMCA9IG4ub2JqZWN0Lnpvb207CiAgfSwgdGhpcy5yZXNldCA9IGZ1bmN0aW9uKCkgewogICAgbi50YXJnZXQuY29weShuLnRhcmdldDApLCBuLm9iamVjdC5wb3NpdGlvbi5jb3B5KG4ucG9zaXRpb24wKSwgbi5vYmplY3QucXVhdGVybmlvbi5jb3B5KG4ucXVhdGVybmlvbjApLCBuLm9iamVjdC56b29tID0gbi56b29tMCwgbi5vYmplY3QudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpLCBuLmRpc3BhdGNoRXZlbnQocyksIG4udXBkYXRlKCksIGggPSBsLk5PTkU7CiAgfSwgdGhpcy51cGRhdGUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBJID0gbmV3IEUoKSwgbHQgPSBuZXcgdmUoKS5zZXRGcm9tVW5pdFZlY3RvcnMoYS51cCwgbmV3IEUoMCwgMSwgMCkpLCBndCA9IGx0LmNsb25lKCkuaW52ZXJ0KCksIGogPSBuZXcgRSgpLCBtdCA9IG5ldyB2ZSgpLCBBdCA9IG5ldyB2ZSgpLCBUdCA9IG5ldyBFKCk7CiAgICBjb25zdCB2dCA9IG5ldyBFKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBGID0gbi5vYmplY3QucG9zaXRpb24sIGh0OwogICAgICBpZiAoSS5jb3B5KEYpLnN1YihuLnRhcmdldCksIG4udHJhY2tiYWxsICYmICFuLmhvbHJveWQpCiAgICAgICAgZC50aGV0YSAmJiAoVHQuc2V0KDAsIDEsIDApLmFwcGx5UXVhdGVybmlvbihuLm9iamVjdC5xdWF0ZXJuaW9uKSwgaHQgPSBuLmVuYWJsZURhbXBpbmcgPyBuLmRhbXBpbmdGYWN0b3IgOiAxLCBBdC5zZXRGcm9tQXhpc0FuZ2xlKFR0LCBkLnRoZXRhICogaHQpLCBuLm9iamVjdC5xdWF0ZXJuaW9uLnByZW11bHRpcGx5KEF0KSwgSS5hcHBseVF1YXRlcm5pb24oQXQpKSwgZC5waGkgJiYgKFR0LnNldCgxLCAwLCAwKS5hcHBseVF1YXRlcm5pb24obi5vYmplY3QucXVhdGVybmlvbiksIGh0ID0gbi5lbmFibGVEYW1waW5nID8gbi5kYW1waW5nRmFjdG9yIDogMSwgQXQuc2V0RnJvbUF4aXNBbmdsZShUdCwgZC5waGkgKiBodCksIG4ub2JqZWN0LnF1YXRlcm5pb24ucHJlbXVsdGlwbHkoQXQpLCBJLmFwcGx5UXVhdGVybmlvbihBdCkpLCBJLm11bHRpcGx5U2NhbGFyKHApLCBJLmNsYW1wTGVuZ3RoKG4ubWluRGlzdGFuY2UsIG4ubWF4RGlzdGFuY2UpOwogICAgICBlbHNlIGlmIChuLnRyYWNrYmFsbCAmJiBuLmhvbHJveWQpIHsKICAgICAgICB2dC5jcm9zc1ZlY3RvcnMoeCwgXyk7CiAgICAgICAgdmFyIF90ID0gTWF0aC5hdGFuKHZ0Lmxlbmd0aCgpIC8geC5kb3QoXykpOwogICAgICAgIF90ICYmICh2dC5ub3JtYWxpemUoKSwgdnQuYXBwbHlRdWF0ZXJuaW9uKG4ub2JqZWN0LnF1YXRlcm5pb24pLCBodCA9IG4uZW5hYmxlRGFtcGluZyA/IG4uZGFtcGluZ0ZhY3RvciA6IDEsIF90ICo9IC0yICogaHQsIEF0LnNldEZyb21BeGlzQW5nbGUodnQsIF90KSwgbi5vYmplY3QucXVhdGVybmlvbi5wcmVtdWx0aXBseShBdCksIEkuYXBwbHlRdWF0ZXJuaW9uKEF0KSksIEkubXVsdGlwbHlTY2FsYXIocCksIEkuY2xhbXBMZW5ndGgobi5taW5EaXN0YW5jZSwgbi5tYXhEaXN0YW5jZSksIHguc2V0KDAsIDAsIDApLCBfLnNldCgwLCAwLCAwKTsKICAgICAgfSBlbHNlCiAgICAgICAgSS5hcHBseVF1YXRlcm5pb24obHQpLCBuLmF1dG9Sb3RhdGUgJiYgaCA9PT0gbC5OT05FICYmIFcoTygpKSwgdS5zZXRGcm9tVmVjdG9yMyhJKSwgbi5lbmFibGVEYW1waW5nID8gKHUudGhldGEgKz0gZC50aGV0YSAqIG4uZGFtcGluZ0ZhY3RvciwgdS5waGkgKz0gZC5waGkgKiBuLmRhbXBpbmdGYWN0b3IpIDogKHUudGhldGEgKz0gZC50aGV0YSwgdS5waGkgKz0gZC5waGkpLCB1LnRoZXRhID0gTWF0aC5tYXgobi5taW5BemltdXRoQW5nbGUsIE1hdGgubWluKG4ubWF4QXppbXV0aEFuZ2xlLCB1LnRoZXRhKSksIHUucGhpID0gTWF0aC5tYXgobi5taW5Qb2xhckFuZ2xlLCBNYXRoLm1pbihuLm1heFBvbGFyQW5nbGUsIHUucGhpKSksIHUubWFrZVNhZmUoKSwgdS5yYWRpdXMgKj0gcCwgdS5yYWRpdXMgPSBNYXRoLm1heChuLm1pbkRpc3RhbmNlLCBNYXRoLm1pbihuLm1heERpc3RhbmNlLCB1LnJhZGl1cykpLCBJLnNldEZyb21TcGhlcmljYWwodSksIEkuYXBwbHlRdWF0ZXJuaW9uKGd0KTsKICAgICAgcmV0dXJuIG4uZW5hYmxlRGFtcGluZyA9PT0gITAgPyBuLnRhcmdldC5hZGRTY2FsZWRWZWN0b3IoZiwgbi5kYW1waW5nRmFjdG9yKSA6IG4udGFyZ2V0LmFkZChmKSwgRi5jb3B5KG4udGFyZ2V0KS5hZGQoSSksIG4udHJhY2tiYWxsID09PSAhMSAmJiBuLm9iamVjdC5sb29rQXQobi50YXJnZXQpLCBuLmVuYWJsZURhbXBpbmcgPT09ICEwID8gKGQudGhldGEgKj0gMSAtIG4uZGFtcGluZ0ZhY3RvciwgZC5waGkgKj0gMSAtIG4uZGFtcGluZ0ZhY3RvciwgZi5tdWx0aXBseVNjYWxhcigxIC0gbi5kYW1waW5nRmFjdG9yKSkgOiAoZC5zZXQoMCwgMCwgMCksIGYuc2V0KDAsIDAsIDApKSwgcCA9IDEsIHkgfHwgai5kaXN0YW5jZVRvU3F1YXJlZChuLm9iamVjdC5wb3NpdGlvbikgPiBjIHx8IDggKiAoMSAtIG10LmRvdChuLm9iamVjdC5xdWF0ZXJuaW9uKSkgPiBjID8gKG4uZGlzcGF0Y2hFdmVudChzKSwgai5jb3B5KG4ub2JqZWN0LnBvc2l0aW9uKSwgbXQuY29weShuLm9iamVjdC5xdWF0ZXJuaW9uKSwgeSA9ICExLCAhMCkgOiAhMTsKICAgIH07CiAgfSgpOwogIGNvbnN0IGUgPSB7CiAgICB4OiBuZXcgRSgxLCAwLCAwKSwKICAgIHk6IG5ldyBFKDAsIDEsIDApLAogICAgejogbmV3IEUoMCwgMCwgMSkKICB9OwogIGZ1bmN0aW9uIGkoSSwgbHQpIHsKICAgIGlmIChuLnRyYWNrYmFsbCkgewogICAgICBjb25zdCBndCA9IGVbSV0sIGogPSBuZXcgdmUoKS5zZXRGcm9tQXhpc0FuZ2xlKGd0LCBsdCk7CiAgICAgIG4ub2JqZWN0LnF1YXRlcm5pb24ucHJlbXVsdGlwbHkoaiksIG4ub2JqZWN0LnBvc2l0aW9uLnN1YihuLnRhcmdldCkuYXBwbHlRdWF0ZXJuaW9uKGopLmFkZChuLnRhcmdldCk7CiAgICB9IGVsc2UKICAgICAgY29uc29sZS5sb2coIm5vdCBzdXBwb3J0ZWQgZm9yIG9yYml0IGNvbnRyb2xzIik7CiAgfQogIHRoaXMucm90YXRlWCA9IGZ1bmN0aW9uKEkpIHsKICAgIGkoIngiLCBJKTsKICB9LCB0aGlzLnJvdGF0ZVkgPSBmdW5jdGlvbihJKSB7CiAgICBpKCJ5IiwgSSk7CiAgfSwgdGhpcy5yb3RhdGVaID0gZnVuY3Rpb24oSSkgewogICAgaSgieiIsIEkpOwogIH0sIHRoaXMucm90YXRlTGVmdCA9IGZ1bmN0aW9uKEkpIHsKICAgIHRoaXMudHJhY2tiYWxsID8gY29uc29sZS5sb2coIm5vdCBzdXBwb3J0ZWQgZm9yIHRyYWNrYmFsbCBjb250cm9scyIpIDogVyhJKTsKICB9LCB0aGlzLnJvdGF0ZVVwID0gZnVuY3Rpb24oSSkgewogICAgdGhpcy50cmFja2JhbGwgPyBjb25zb2xlLmxvZygibm90IHN1cHBvcnRlZCBmb3IgdHJhY2tiYWxsIGNvbnRyb2xzIikgOiBHKEkpOwogIH0sIHRoaXMuZGlzcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgbi5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51IiwgSXQsICExKSwgbi5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIFd0LCAhMSksIG4uZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ3aGVlbCIsIEEsICExKSwgbi5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRvdWNoc3RhcnQiLCBYLCAhMSksIG4uZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ0b3VjaGVuZCIsIFosICExKSwgbi5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRvdWNobW92ZSIsIHJ0LCAhMSksIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIE50LCAhMSksIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBQLCAhMSksIG4uZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgTiwgITEpOwogIH07CiAgdmFyIG4gPSB0aGlzLCBzID0geyB0eXBlOiAiY2hhbmdlIiB9LCByID0geyB0eXBlOiAic3RhcnQiIH0sIG8gPSB7IHR5cGU6ICJlbmQiIH0sIGwgPSB7CiAgICBOT05FOiAtMSwKICAgIFJPVEFURTogMCwKICAgIERPTExZOiAxLAogICAgUEFOOiAyLAogICAgVE9VQ0hfUk9UQVRFOiAzLAogICAgVE9VQ0hfUEFOOiA0LAogICAgVE9VQ0hfRE9MTFlfUEFOOiA1LAogICAgVE9VQ0hfRE9MTFlfUk9UQVRFOiA2CiAgfSwgaCA9IGwuTk9ORSwgYyA9IDFlLTYsIHUgPSBuZXcgb3AoKSwgZCA9IG5ldyBvcCgpLCBwID0gMSwgZiA9IG5ldyBFKCksIHkgPSAhMSwgZyA9IG5ldyBKKCksIG0gPSBuZXcgSigpLCB2ID0gbmV3IEooKSwgeCA9IG5ldyBFKCksIF8gPSBuZXcgRSgpLCBTID0gbmV3IEooKSwgdyA9IG5ldyBKKCksIFQgPSBuZXcgSigpLCBSID0gbmV3IEooKSwgYiA9IG5ldyBKKCksIE0gPSBuZXcgSigpLCBMID0gITAsIFUgPSAhMDsKICBmdW5jdGlvbiBPKCkgewogICAgcmV0dXJuIDIgKiBNYXRoLlBJIC8gNjAgLyA2MCAqIG4uYXV0b1JvdGF0ZVNwZWVkOwogIH0KICBmdW5jdGlvbiBWKCkgewogICAgcmV0dXJuIE1hdGgucG93KDAuOTUsIG4uem9vbVNwZWVkKTsKICB9CiAgZnVuY3Rpb24gVyhJKSB7CiAgICBMICYmIChkLnRoZXRhIC09IEkpOwogIH0KICBmdW5jdGlvbiBHKEkpIHsKICAgIFUgJiYgKGQucGhpIC09IEkpOwogIH0KICB2YXIgZXQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBJID0gbmV3IEUoKTsKICAgIHJldHVybiBmdW5jdGlvbihndCwgaikgewogICAgICBJLnNldEZyb21NYXRyaXhDb2x1bW4oaiwgMCksIEkubXVsdGlwbHlTY2FsYXIoLWd0KSwgZi5hZGQoSSk7CiAgICB9OwogIH0oKSwgSCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIEkgPSBuZXcgRSgpOwogICAgcmV0dXJuIGZ1bmN0aW9uKGd0LCBqKSB7CiAgICAgIG4uc2NyZWVuU3BhY2VQYW5uaW5nID09PSAhMCA/IEkuc2V0RnJvbU1hdHJpeENvbHVtbihqLCAxKSA6IChJLnNldEZyb21NYXRyaXhDb2x1bW4oaiwgMCksIEkuY3Jvc3NWZWN0b3JzKG4ub2JqZWN0LnVwLCBJKSksIEkubXVsdGlwbHlTY2FsYXIoZ3QpLCBmLmFkZChJKTsKICAgIH07CiAgfSgpLCBhdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIEkgPSBuZXcgRSgpOwogICAgcmV0dXJuIGZ1bmN0aW9uKGd0LCBqKSB7CiAgICAgIHZhciBtdCA9IG4uZG9tRWxlbWVudDsKICAgICAgaWYgKG4ub2JqZWN0LmlzUGVyc3BlY3RpdmVDYW1lcmEpIHsKICAgICAgICB2YXIgQXQgPSBuLm9iamVjdC5wb3NpdGlvbjsKICAgICAgICBJLmNvcHkoQXQpLnN1YihuLnRhcmdldCk7CiAgICAgICAgdmFyIFR0ID0gSS5sZW5ndGgoKTsKICAgICAgICBUdCAqPSBNYXRoLnRhbihuLm9iamVjdC5mb3YgLyAyICogTWF0aC5QSSAvIDE4MCksIGV0KDIgKiBndCAqIFR0IC8gbXQuY2xpZW50SGVpZ2h0LCBuLm9iamVjdC5tYXRyaXgpLCBIKDIgKiBqICogVHQgLyBtdC5jbGllbnRIZWlnaHQsIG4ub2JqZWN0Lm1hdHJpeCk7CiAgICAgIH0gZWxzZSBuLm9iamVjdC5pc09ydGhvZ3JhcGhpY0NhbWVyYSA/IChldChndCAqIChuLm9iamVjdC5yaWdodCAtIG4ub2JqZWN0LmxlZnQpIC8gbi5vYmplY3Quem9vbSAvIG10LmNsaWVudFdpZHRoLCBuLm9iamVjdC5tYXRyaXgpLCBIKGogKiAobi5vYmplY3QudG9wIC0gbi5vYmplY3QuYm90dG9tKSAvIG4ub2JqZWN0Lnpvb20gLyBtdC5jbGllbnRIZWlnaHQsIG4ub2JqZWN0Lm1hdHJpeCkpIDogKGNvbnNvbGUud2FybigiV0FSTklORzogQ2FtZXJhQ29udHJvbHMuanMgZW5jb3VudGVyZWQgYW4gdW5rbm93biBjYW1lcmEgdHlwZSAtIHBhbiBkaXNhYmxlZC4iKSwgbi5lbmFibGVQYW4gPSAhMSk7CiAgICB9OwogIH0oKTsKICBmdW5jdGlvbiBwdChJKSB7CiAgICBuLm9iamVjdC5pc1BlcnNwZWN0aXZlQ2FtZXJhID8gcCAvPSBJIDogbi5vYmplY3QuaXNPcnRob2dyYXBoaWNDYW1lcmEgPyAobi5vYmplY3Quem9vbSA9IE1hdGgubWF4KG4ubWluWm9vbSwgTWF0aC5taW4obi5tYXhab29tLCBuLm9iamVjdC56b29tICogSSkpLCBuLm9iamVjdC51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCksIHkgPSAhMCkgOiAoY29uc29sZS53YXJuKCJXQVJOSU5HOiBDYW1lcmFDb250cm9scy5qcyBlbmNvdW50ZXJlZCBhbiB1bmtub3duIGNhbWVyYSB0eXBlIC0gZG9sbHkvem9vbSBkaXNhYmxlZC4iKSwgbi5lbmFibGVab29tID0gITEpOwogIH0KICBmdW5jdGlvbiBNdChJKSB7CiAgICBuLm9iamVjdC5pc1BlcnNwZWN0aXZlQ2FtZXJhID8gcCAqPSBJIDogbi5vYmplY3QuaXNPcnRob2dyYXBoaWNDYW1lcmEgPyAobi5vYmplY3Quem9vbSA9IE1hdGgubWF4KG4ubWluWm9vbSwgTWF0aC5taW4obi5tYXhab29tLCBuLm9iamVjdC56b29tIC8gSSkpLCBuLm9iamVjdC51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCksIHkgPSAhMCkgOiAoY29uc29sZS53YXJuKCJXQVJOSU5HOiBDYW1lcmFDb250cm9scy5qcyBlbmNvdW50ZXJlZCBhbiB1bmtub3duIGNhbWVyYSB0eXBlIC0gZG9sbHkvem9vbSBkaXNhYmxlZC4iKSwgbi5lbmFibGVab29tID0gITEpOwogIH0KICBjb25zdCBMdCA9IGZ1bmN0aW9uKCkgewogICAgY29uc3QgSSA9IG5ldyBFKCksIGx0ID0gbi5yYWRpdXMgKiBuLnJhZGl1czsKICAgIGZ1bmN0aW9uIGd0KGosIG10KSB7CiAgICAgIGogKj0gbi5yb3RhdGVTcGVlZCwgbXQgKj0gbi5yb3RhdGVTcGVlZDsKICAgICAgdmFyIEF0ID0gaiAqIGogKyBtdCAqIG10OwogICAgICBBdCA8PSBsdCAvIDIgPyBJLnNldChqLCBtdCwgTWF0aC5zcXJ0KGx0IC0gQXQpKSA6IEkuc2V0KGosIG10LCBsdCAvICgyICogTWF0aC5zcXJ0KEF0KSkpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKG10KSB7CiAgICAgIGNvbnN0IEF0ID0gbi5kb21FbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLCBUdCA9IChtdC54IC0gQXQueCkgLyAoQXQud2lkdGggLyAyKSAtIDEsIHZ0ID0gMSAtIChtdC55IC0gQXQueSkgLyAoQXQuaGVpZ2h0IC8gMik7CiAgICAgIHJldHVybiBndCgKICAgICAgICBMID8gVHQgOiAwLAogICAgICAgIFUgPyB2dCA6IDAKICAgICAgKSwgSTsKICAgIH07CiAgfSgpOwogIGZ1bmN0aW9uIGp0KEkpIHsKICAgIGcuc2V0KEkuY2xpZW50WCwgSS5jbGllbnRZKTsKICB9CiAgZnVuY3Rpb24gbmUoSSkgewogICAgUi5zZXQoSS5jbGllbnRYLCBJLmNsaWVudFkpOwogIH0KICBmdW5jdGlvbiBKdChJKSB7CiAgICBTLnNldChJLmNsaWVudFgsIEkuY2xpZW50WSk7CiAgfQogIGZ1bmN0aW9uIFkoSSkgewogICAgaWYgKG0uc2V0KEkuY2xpZW50WCwgSS5jbGllbnRZKSwgbi50cmFja2JhbGwgJiYgbi5ob2xyb3lkKQogICAgICB4ID0gTHQoZykuY2xvbmUoKSwgXyA9IEx0KG0pLmNsb25lKCk7CiAgICBlbHNlIHsKICAgICAgdmFyIGx0ID0gbi5kb21FbGVtZW50OwogICAgICB2LnN1YlZlY3RvcnMobSwgZykubXVsdGlwbHlTY2FsYXIobi5yb3RhdGVTcGVlZCksIFcoMiAqIE1hdGguUEkgKiB2LnggLyBsdC5jbGllbnRIZWlnaHQpLCBHKDIgKiBNYXRoLlBJICogdi55IC8gbHQuY2xpZW50SGVpZ2h0KTsKICAgIH0KICAgIGcuY29weShtKSwgbi51cGRhdGUoKTsKICB9CiAgZnVuY3Rpb24gc3QoSSkgewogICAgYi5zZXQoSS5jbGllbnRYLCBJLmNsaWVudFkpLCBNLnN1YlZlY3RvcnMoYiwgUiksIE0ueSA+IDAgPyBwdChWKCkpIDogTS55IDwgMCAmJiBNdChWKCkpLCBSLmNvcHkoYiksIG4udXBkYXRlKCk7CiAgfQogIGZ1bmN0aW9uIEV0KEkpIHsKICAgIHcuc2V0KEkuY2xpZW50WCwgSS5jbGllbnRZKSwgVC5zdWJWZWN0b3JzKHcsIFMpLm11bHRpcGx5U2NhbGFyKG4ucGFuU3BlZWQpLCBhdChULngsIFQueSksIFMuY29weSh3KSwgbi51cGRhdGUoKTsKICB9CiAgZnVuY3Rpb24gVXQoSSkgewogICAgSS5kZWx0YVkgPCAwID8gTXQoVigpKSA6IEkuZGVsdGFZID4gMCAmJiBwdChWKCkpLCBuLnVwZGF0ZSgpOwogIH0KICBmdW5jdGlvbiBQdChJKSB7CiAgICB2YXIgbHQgPSAhMTsKICAgIHN3aXRjaCAoSS5rZXlDb2RlKSB7CiAgICAgIGNhc2Ugbi5rZXlzLlVQOgogICAgICAgIGF0KDAsIG4ua2V5UGFuU3BlZWQpLCBsdCA9ICEwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIG4ua2V5cy5CT1RUT006CiAgICAgICAgYXQoMCwgLW4ua2V5UGFuU3BlZWQpLCBsdCA9ICEwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIG4ua2V5cy5MRUZUOgogICAgICAgIGF0KG4ua2V5UGFuU3BlZWQsIDApLCBsdCA9ICEwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIG4ua2V5cy5SSUdIVDoKICAgICAgICBhdCgtbi5rZXlQYW5TcGVlZCwgMCksIGx0ID0gITA7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBsdCAmJiAoSS5wcmV2ZW50RGVmYXVsdCgpLCBuLnVwZGF0ZSgpKTsKICB9CiAgZnVuY3Rpb24gS3QoSSkgewogICAgaWYgKEkudG91Y2hlcy5sZW5ndGggPT0gMSkKICAgICAgZy5zZXQoSS50b3VjaGVzWzBdLnBhZ2VYLCBJLnRvdWNoZXNbMF0ucGFnZVkpOwogICAgZWxzZSB7CiAgICAgIHZhciBsdCA9IDAuNSAqIChJLnRvdWNoZXNbMF0ucGFnZVggKyBJLnRvdWNoZXNbMV0ucGFnZVgpLCBndCA9IDAuNSAqIChJLnRvdWNoZXNbMF0ucGFnZVkgKyBJLnRvdWNoZXNbMV0ucGFnZVkpOwogICAgICBnLnNldChsdCwgZ3QpOwogICAgfQogIH0KICBmdW5jdGlvbiBoZShJKSB7CiAgICBpZiAoSS50b3VjaGVzLmxlbmd0aCA9PSAxKQogICAgICBTLnNldChJLnRvdWNoZXNbMF0ucGFnZVgsIEkudG91Y2hlc1swXS5wYWdlWSk7CiAgICBlbHNlIHsKICAgICAgdmFyIGx0ID0gMC41ICogKEkudG91Y2hlc1swXS5wYWdlWCArIEkudG91Y2hlc1sxXS5wYWdlWCksIGd0ID0gMC41ICogKEkudG91Y2hlc1swXS5wYWdlWSArIEkudG91Y2hlc1sxXS5wYWdlWSk7CiAgICAgIFMuc2V0KGx0LCBndCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEQoSSkgewogICAgdmFyIGx0ID0gSS50b3VjaGVzWzBdLnBhZ2VYIC0gSS50b3VjaGVzWzFdLnBhZ2VYLCBndCA9IEkudG91Y2hlc1swXS5wYWdlWSAtIEkudG91Y2hlc1sxXS5wYWdlWSwgaiA9IE1hdGguc3FydChsdCAqIGx0ICsgZ3QgKiBndCk7CiAgICBSLnNldCgwLCBqKTsKICB9CiAgZnVuY3Rpb24gb3QoSSkgewogICAgbi5lbmFibGVab29tICYmIEQoSSksIG4uZW5hYmxlUGFuICYmIGhlKEkpOwogIH0KICBmdW5jdGlvbiBpdChJKSB7CiAgICBuLmVuYWJsZVpvb20gJiYgRChJKSwgbi5lbmFibGVSb3RhdGUgJiYgS3QoSSk7CiAgfQogIGZ1bmN0aW9uIFEoSSkgewogICAgaWYgKEkudG91Y2hlcy5sZW5ndGggPT0gMSkKICAgICAgbS5zZXQoSS50b3VjaGVzWzBdLnBhZ2VYLCBJLnRvdWNoZXNbMF0ucGFnZVkpOwogICAgZWxzZSB7CiAgICAgIHZhciBsdCA9IDAuNSAqIChJLnRvdWNoZXNbMF0ucGFnZVggKyBJLnRvdWNoZXNbMV0ucGFnZVgpLCBndCA9IDAuNSAqIChJLnRvdWNoZXNbMF0ucGFnZVkgKyBJLnRvdWNoZXNbMV0ucGFnZVkpOwogICAgICBtLnNldChsdCwgZ3QpOwogICAgfQogICAgaWYgKG4udHJhY2tiYWxsICYmIG4uaG9scm95ZCkKICAgICAgeCA9IEx0KGcpLmNsb25lKCksIF8gPSBMdChtKS5jbG9uZSgpOwogICAgZWxzZSB7CiAgICAgIHYuc3ViVmVjdG9ycyhtLCBnKS5tdWx0aXBseVNjYWxhcihuLnJvdGF0ZVNwZWVkKTsKICAgICAgdmFyIGogPSBuLmRvbUVsZW1lbnQ7CiAgICAgIFcoMiAqIE1hdGguUEkgKiB2LnggLyBqLmNsaWVudEhlaWdodCksIEcoMiAqIE1hdGguUEkgKiB2LnkgLyBqLmNsaWVudEhlaWdodCk7CiAgICB9CiAgICBnLmNvcHkobSk7CiAgfQogIGZ1bmN0aW9uIEsoSSkgewogICAgaWYgKEkudG91Y2hlcy5sZW5ndGggPT0gMSkKICAgICAgdy5zZXQoSS50b3VjaGVzWzBdLnBhZ2VYLCBJLnRvdWNoZXNbMF0ucGFnZVkpOwogICAgZWxzZSB7CiAgICAgIHZhciBsdCA9IDAuNSAqIChJLnRvdWNoZXNbMF0ucGFnZVggKyBJLnRvdWNoZXNbMV0ucGFnZVgpLCBndCA9IDAuNSAqIChJLnRvdWNoZXNbMF0ucGFnZVkgKyBJLnRvdWNoZXNbMV0ucGFnZVkpOwogICAgICB3LnNldChsdCwgZ3QpOwogICAgfQogICAgVC5zdWJWZWN0b3JzKHcsIFMpLm11bHRpcGx5U2NhbGFyKG4ucGFuU3BlZWQpLCBhdChULngsIFQueSksIFMuY29weSh3KTsKICB9CiAgZnVuY3Rpb24geXQoSSkgewogICAgdmFyIGx0ID0gSS50b3VjaGVzWzBdLnBhZ2VYIC0gSS50b3VjaGVzWzFdLnBhZ2VYLCBndCA9IEkudG91Y2hlc1swXS5wYWdlWSAtIEkudG91Y2hlc1sxXS5wYWdlWSwgaiA9IE1hdGguc3FydChsdCAqIGx0ICsgZ3QgKiBndCk7CiAgICBiLnNldCgwLCBqKSwgTS5zZXQoMCwgTWF0aC5wb3coYi55IC8gUi55LCBuLnpvb21TcGVlZCkpLCBwdChNLnkpLCBSLmNvcHkoYik7CiAgfQogIGZ1bmN0aW9uIHV0KEkpIHsKICAgIG4uZW5hYmxlWm9vbSAmJiB5dChJKSwgbi5lbmFibGVQYW4gJiYgSyhJKTsKICB9CiAgZnVuY3Rpb24geHQoSSkgewogICAgbi5lbmFibGVab29tICYmIHl0KEkpLCBuLmVuYWJsZVJvdGF0ZSAmJiBRKEkpOwogIH0KICBmdW5jdGlvbiBXdChJKSB7CiAgICBpZiAobi5lbmFibGVkICE9PSAhMSkgewogICAgICBJLnByZXZlbnREZWZhdWx0KCksIEkuc3RvcFByb3BhZ2F0aW9uKCksIG4uZG9tRWxlbWVudC5mb2N1cyA/IG4uZG9tRWxlbWVudC5mb2N1cygpIDogd2luZG93LmZvY3VzKCk7CiAgICAgIHZhciBsdDsKICAgICAgc3dpdGNoIChJLmJ1dHRvbikgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIGx0ID0gbi5tb3VzZUJ1dHRvbnMuTEVGVDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMToKICAgICAgICAgIGx0ID0gbi5tb3VzZUJ1dHRvbnMuTUlERExFOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAyOgogICAgICAgICAgbHQgPSBuLm1vdXNlQnV0dG9ucy5SSUdIVDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBsdCA9IC0xOwogICAgICB9CiAgICAgIHN3aXRjaCAobHQpIHsKICAgICAgICBjYXNlIFplLkRPTExZOgogICAgICAgICAgaWYgKG4uZW5hYmxlWm9vbSA9PT0gITEpIHJldHVybjsKICAgICAgICAgIG5lKEkpLCBoID0gbC5ET0xMWTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgWmUuUk9UQVRFOgogICAgICAgICAgaWYgKERlLmdldChJLCAic2hpZnQiKSkgewogICAgICAgICAgICBpZiAobi5lbmFibGVQYW4gPT09ICExKSByZXR1cm47CiAgICAgICAgICAgIEp0KEkpLCBoID0gbC5QQU47CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobi5lbmFibGVSb3RhdGUgPT09ICExKSByZXR1cm47CiAgICAgICAgICAgIERlLmdldChJLCAiY3RybCIpICYmIChMID0gITEpLCBEZS5nZXQoSSwgIm1ldGEiKSAmJiAoVSA9ICExKSwganQoSSksIGggPSBsLlJPVEFURTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgWmUuUEFOOgogICAgICAgICAgaWYgKERlLmdldChJLCAiY3RybCIpIHx8IERlLmdldChJLCAibWV0YSIpIHx8IERlLmdldChJLCAic2hpZnQiKSkgewogICAgICAgICAgICBpZiAobi5lbmFibGVSb3RhdGUgPT09ICExKSByZXR1cm47CiAgICAgICAgICAgIGp0KEkpLCBoID0gbC5ST1RBVEU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobi5lbmFibGVQYW4gPT09ICExKSByZXR1cm47CiAgICAgICAgICAgIEp0KEkpLCBoID0gbC5QQU47CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaCA9IGwuTk9ORTsKICAgICAgfQogICAgICBoICE9PSBsLk5PTkUgJiYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIE50LCAhMSksIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBQLCAhMSksIG4uZGlzcGF0Y2hFdmVudChyKSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIE50KEkpIHsKICAgIGlmIChuLmVuYWJsZWQgIT09ICExKQogICAgICBzd2l0Y2ggKEkucHJldmVudERlZmF1bHQoKSwgSS5zdG9wUHJvcGFnYXRpb24oKSwgaCkgewogICAgICAgIGNhc2UgbC5ST1RBVEU6CiAgICAgICAgICBpZiAobi5lbmFibGVSb3RhdGUgPT09ICExKSByZXR1cm47CiAgICAgICAgICBZKEkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBsLkRPTExZOgogICAgICAgICAgaWYgKG4uZW5hYmxlWm9vbSA9PT0gITEpIHJldHVybjsKICAgICAgICAgIHN0KEkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBsLlBBTjoKICAgICAgICAgIGlmIChuLmVuYWJsZVBhbiA9PT0gITEpIHJldHVybjsKICAgICAgICAgIEV0KEkpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICB9CiAgZnVuY3Rpb24gUChJKSB7CiAgICBuLmVuYWJsZWQgIT09ICExICYmIChkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZW1vdmUiLCBOdCwgITEpLCBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgUCwgITEpLCBMID0gITAsIFUgPSAhMCwgbi5kaXNwYXRjaEV2ZW50KG8pLCBoID0gbC5OT05FKTsKICB9CiAgZnVuY3Rpb24gQShJKSB7CiAgICBuLmVuYWJsZWQgPT09ICExIHx8IG4uZW5hYmxlWm9vbSA9PT0gITEgfHwgaCAhPT0gbC5OT05FICYmIGggIT09IGwuUk9UQVRFIHx8IChJLnByZXZlbnREZWZhdWx0KCksIEkuc3RvcFByb3BhZ2F0aW9uKCksIG4uZGlzcGF0Y2hFdmVudChyKSwgVXQoSSksIG4uZGlzcGF0Y2hFdmVudChvKSk7CiAgfQogIGZ1bmN0aW9uIE4oSSkgewogICAgbi5lbmFibGVkID09PSAhMSB8fCBuLmVuYWJsZUtleXMgPT09ICExIHx8IG4uZW5hYmxlUGFuID09PSAhMSB8fCBQdChJKTsKICB9CiAgZnVuY3Rpb24gWChJKSB7CiAgICBpZiAobi5lbmFibGVkICE9PSAhMSkgewogICAgICBzd2l0Y2ggKEkucHJldmVudERlZmF1bHQoKSwgSS50b3VjaGVzLmxlbmd0aCkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHN3aXRjaCAobi50b3VjaGVzLk9ORSkgewogICAgICAgICAgICBjYXNlIHppLlJPVEFURToKICAgICAgICAgICAgICBpZiAobi5lbmFibGVSb3RhdGUgPT09ICExKSByZXR1cm47CiAgICAgICAgICAgICAgS3QoSSksIGggPSBsLlRPVUNIX1JPVEFURTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSB6aS5QQU46CiAgICAgICAgICAgICAgaWYgKG4uZW5hYmxlUGFuID09PSAhMSkgcmV0dXJuOwogICAgICAgICAgICAgIGhlKEkpLCBoID0gbC5UT1VDSF9QQU47CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaCA9IGwuTk9ORTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHN3aXRjaCAobi50b3VjaGVzLlRXTykgewogICAgICAgICAgICBjYXNlIHppLkRPTExZX1BBTjoKICAgICAgICAgICAgICBpZiAobi5lbmFibGVab29tID09PSAhMSAmJiBuLmVuYWJsZVBhbiA9PT0gITEpIHJldHVybjsKICAgICAgICAgICAgICBvdChJKSwgaCA9IGwuVE9VQ0hfRE9MTFlfUEFOOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIHppLkRPTExZX1JPVEFURToKICAgICAgICAgICAgICBpZiAobi5lbmFibGVab29tID09PSAhMSAmJiBuLmVuYWJsZVJvdGF0ZSA9PT0gITEpIHJldHVybjsKICAgICAgICAgICAgICBpdChJKSwgaCA9IGwuVE9VQ0hfRE9MTFlfUk9UQVRFOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGggPSBsLk5PTkU7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaCA9IGwuTk9ORTsKICAgICAgfQogICAgICBoICE9PSBsLk5PTkUgJiYgbi5kaXNwYXRjaEV2ZW50KHIpOwogICAgfQogIH0KICBmdW5jdGlvbiBydChJKSB7CiAgICBpZiAobi5lbmFibGVkICE9PSAhMSkKICAgICAgc3dpdGNoIChJLnByZXZlbnREZWZhdWx0KCksIEkuc3RvcFByb3BhZ2F0aW9uKCksIGgpIHsKICAgICAgICBjYXNlIGwuVE9VQ0hfUk9UQVRFOgogICAgICAgICAgaWYgKG4uZW5hYmxlUm90YXRlID09PSAhMSkgcmV0dXJuOwogICAgICAgICAgUShJKSwgbi51cGRhdGUoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgbC5UT1VDSF9QQU46CiAgICAgICAgICBpZiAobi5lbmFibGVQYW4gPT09ICExKSByZXR1cm47CiAgICAgICAgICBLKEkpLCBuLnVwZGF0ZSgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBsLlRPVUNIX0RPTExZX1BBTjoKICAgICAgICAgIGlmIChuLmVuYWJsZVpvb20gPT09ICExICYmIG4uZW5hYmxlUGFuID09PSAhMSkgcmV0dXJuOwogICAgICAgICAgdXQoSSksIG4udXBkYXRlKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIGwuVE9VQ0hfRE9MTFlfUk9UQVRFOgogICAgICAgICAgaWYgKG4uZW5hYmxlWm9vbSA9PT0gITEgJiYgbi5lbmFibGVSb3RhdGUgPT09ICExKSByZXR1cm47CiAgICAgICAgICB4dChJKSwgbi51cGRhdGUoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBoID0gbC5OT05FOwogICAgICB9CiAgfQogIGZ1bmN0aW9uIFooSSkgewogICAgbi5lbmFibGVkICE9PSAhMSAmJiAobi5kaXNwYXRjaEV2ZW50KG8pLCBoID0gbC5OT05FKTsKICB9CiAgZnVuY3Rpb24gSXQoSSkgewogICAgbi5lbmFibGVkICE9PSAhMSAmJiBJLnByZXZlbnREZWZhdWx0KCk7CiAgfQogIG4uZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIEl0LCAhMSksIG4uZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBXdCwgITEpLCBuLmRvbUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigid2hlZWwiLCBBLCAhMSksIG4uZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaHN0YXJ0IiwgWCwgITEpLCBuLmRvbUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hlbmQiLCBaLCAhMSksIG4uZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaG1vdmUiLCBydCwgITEpLCBuLmRvbUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIE4sICExKSwgbi5kb21FbGVtZW50LnRhYkluZGV4ID09PSAtMSAmJiAobi5kb21FbGVtZW50LnRhYkluZGV4ID0gMCksIHRoaXMub2JqZWN0Lmxvb2tBdChuLnRhcmdldCksIHRoaXMudXBkYXRlKCksIHRoaXMuc2F2ZVN0YXRlKCk7Cn07ClBzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRWkucHJvdG90eXBlKTsKUHMucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHM7CnZhciBtcCA9IGZ1bmN0aW9uKGEsIHQpIHsKICBQcy5jYWxsKHRoaXMsIGEsIHQpLCB0aGlzLm1vdXNlQnV0dG9ucy5MRUZUID0gWmUuUk9UQVRFLCB0aGlzLm1vdXNlQnV0dG9ucy5SSUdIVCA9IFplLlBBTiwgdGhpcy50b3VjaGVzLk9ORSA9IHppLlJPVEFURSwgdGhpcy50b3VjaGVzLlRXTyA9IHppLkRPTExZX1BBTjsKfTsKbXAucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFaS5wcm90b3R5cGUpOwptcC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBtcDsKdmFyIGdwID0gZnVuY3Rpb24oYSwgdCkgewogIFBzLmNhbGwodGhpcywgYSwgdCksIHRoaXMubW91c2VCdXR0b25zLkxFRlQgPSBaZS5QQU4sIHRoaXMubW91c2VCdXR0b25zLlJJR0hUID0gWmUuUk9UQVRFLCB0aGlzLnRvdWNoZXMuT05FID0gemkuUEFOLCB0aGlzLnRvdWNoZXMuVFdPID0gemkuRE9MTFlfUk9UQVRFOwp9OwpncC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVpLnByb3RvdHlwZSk7CmdwLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGdwOwp2YXIgeXAgPSBmdW5jdGlvbihhLCB0KSB7CiAgUHMuY2FsbCh0aGlzLCBhLCB0KSwgdGhpcy50cmFja2JhbGwgPSAhMCwgdGhpcy5zY3JlZW5TcGFjZVBhbm5pbmcgPSAhMCwgdGhpcy5hdXRvUm90YXRlID0gITEsIHRoaXMubW91c2VCdXR0b25zLkxFRlQgPSBaZS5ST1RBVEUsIHRoaXMubW91c2VCdXR0b25zLlJJR0hUID0gWmUuUEFOLCB0aGlzLnRvdWNoZXMuT05FID0gemkuUk9UQVRFLCB0aGlzLnRvdWNoZXMuVFdPID0gemkuRE9MTFlfUEFOOwp9Owp5cC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVpLnByb3RvdHlwZSk7CnlwLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHlwOwpjbGFzcyBsVCB7CiAgLyoqCiAgICogQ3JlYXRlIENhbWVyYSBDb250cm9scy4KICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFR5cGUgb2YgY29udHJvbHM6ICJvcmJpdCIsICJ0cmFja2JhbGwiLgogICAqIEBwYXJhbSB7VEhSRUUuQ2FtZXJhfSBjYW1lcmEgLSBUaGUgY2FtZXJhIG9iamVjdC4KICAgKiBAcGFyYW0ge1RIUkVFLlZlY3RvcjN9IHRhcmdldCAtIFRoZSBsb29rQXQgdGFyZ2V0IGZvciB0aGUgY2FtZXJhLgogICAqIEBwYXJhbSB7Y2FudmFzfSBkb21FbGVtZW50IC0gVGhlIGRvbSBlbGVtZW50IG9mIHRoZSByZW5kZXJpbmcgY2FudmFzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbcm90YXRlU3BlZWQ9MS4wXSAtIFNwZWVkIGZvciByb3RhdGluZy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3pvb21TcGVlZD0xLjBdIC0gU3BlZWQgZm9yIHpvb21pbmcuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtwYW5TcGVlZD0xLjBdIC0gU3BlZWQgZm9yIHBhbm5pbmcuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcyA9IDEsIHIgPSAxLCBvID0gMSkgewogICAgLyoqCiAgICAgKiBHZXQgcmVzZXQgbG9jYXRpb24gdmFsdWUuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IC0gdGFyZ2V0LCBwb3NpdGlvbiwgcXVhdGVybmlvbiwgem9vbSBhcyBvYmplY3QuCiAgICAgKi8KICAgIGsodGhpcywgImdldFJlc2V0TG9jYXRpb24iLCAoKSA9PiAoewogICAgICB0YXJnZXQwOiB0aGlzLmNvbnRyb2xzLnRhcmdldDAuY2xvbmUoKSwKICAgICAgcG9zaXRpb24wOiB0aGlzLmNvbnRyb2xzLnBvc2l0aW9uMC5jbG9uZSgpLAogICAgICBxdWF0ZXJuaW9uMDogdGhpcy5jb250cm9scy5xdWF0ZXJuaW9uMC5jbG9uZSgpLAogICAgICB6b29tMDogdGhpcy5jb250cm9scy56b29tMAogICAgfSkpOwogICAgLyoqCiAgICAgKiBTZXQgcmVzZXQgbG9jYXRpb24gdmFsdWUuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IHRhcmdldCAtIGNhbWVyYSB0YXJnZXQgYXMgVEhSRUUuVmVjdG9yMy4KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IHBvc2l0aW9uIC0gY2FtZXJhIHBvc2l0aW9uIGFzIFRIUkVFLlZlY3RvcjMuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IGNhbWVyYSByb3RhdGlvbiBhcyBUSFJFRS5RdWF0ZXJuaW9uLgogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldFJlc2V0TG9jYXRpb24iLCAodCwgZSwgaSwgbikgPT4gewogICAgICB0aGlzLmNvbnRyb2xzLnRhcmdldDAuY29weSh0KSwgdGhpcy5jb250cm9scy5wb3NpdGlvbjAuY29weShlKSwgdGhpcy5jb250cm9scy5xdWF0ZXJuaW9uMC5jb3B5KGkpLCB0aGlzLmNvbnRyb2xzLnpvb20wID0gbjsKICAgIH0pOwogICAgc3dpdGNoICh0aGlzLnR5cGUgPSB0LCB0aGlzLmNhbWVyYSA9IGUsIHRoaXMudGFyZ2V0ID0gaSwgdGhpcy50YXJnZXQwID0gaS5zbGljZSgpLCB0aGlzLmRvbUVsZW1lbnQgPSBuLCB0aGlzLnJvdGF0ZVNwZWVkID0gcywgdGhpcy56b29tU3BlZWQgPSByLCB0aGlzLnBhblNwZWVkID0gbywgdCkgewogICAgICBjYXNlICJvcmJpdCI6CiAgICAgICAgdGhpcy5pbml0T3JiaXRDb250cm9scygpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ0cmFja2JhbGwiOgogICAgICAgIHRoaXMuaW5pdFRyYWNrYmFsbENvbnRyb2xzKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLmNvbnRyb2xzLnRhcmdldCA9IG5ldyBFKC4uLnRoaXMudGFyZ2V0KSwgdGhpcy5jb250cm9scy5yb3RhdGVTcGVlZCA9IHRoaXMucm90YXRlU3BlZWQsIHRoaXMuY29udHJvbHMuem9vbVNwZWVkID0gdGhpcy56b29tU3BlZWQsIHRoaXMuY29udHJvbHMucGFuU3BlZWQgPSB0aGlzLnBhblNwZWVkLCB0aGlzLmN1cnJlbnRVcGRhdGVDYWxsYmFjayA9IG51bGwsIHRoaXMuc2F2ZVN0YXRlKCksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFJlbW92ZSBhc3NldHMgYW5kIGV2ZW50IGhhbmRsZXJzLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmNvbnRyb2xzICYmICh0aGlzLmNvbnRyb2xzLmRpc3Bvc2UoKSwgdGhpcy5jb250cm9scyA9IG51bGwpOwogIH0KICAvKioKICAgKiBTYXZlIHN0YXRlIGZvciByZXNldC4KICAgKi8KICBzYXZlU3RhdGUoKSB7CiAgICB0aGlzLmNvbnRyb2xzLnNhdmVTdGF0ZSgpOwogIH0KICAvKioKICAgKiBJbml0aWFsaXplIFRyYWNrYmFsbCBDb250cm9scy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtob2xyb3lkPXRydWVdIC0gZW5hYmxlIGhvbHJveWQgKG5vbiB0dW1ibGluZykgbW9kZS4KICAgKiovCiAgaW5pdFRyYWNrYmFsbENvbnRyb2xzKHQgPSAhMCkgewogICAgdGhpcy5jb250cm9scyA9IG5ldyBQcyh0aGlzLmNhbWVyYSwgdGhpcy5kb21FbGVtZW50KSwgdGhpcy5jb250cm9scy50cmFja2JhbGwgPSAhMCwgdGhpcy5zZXRIb2xyb3lkVHJhY2tiYWxsKHQpOwogIH0KICAvKioKICAgKiBJbml0aWFsaXplIE9yYml0IENvbnRyb2xzLgogICAqKi8KICBpbml0T3JiaXRDb250cm9scygpIHsKICAgIHRoaXMuY29udHJvbHMgPSBuZXcgUHModGhpcy5jYW1lcmEsIHRoaXMuZG9tRWxlbWVudCk7CiAgfQogIC8qKgogICAqIEFkZCBhbiBldmVudCBsaXN0ZW5lciBjYWxsYmFjayBmb3IgdGhlICJjaGFuZ2UiIGV2ZW50LgogICAqIEBwYXJhbSB7Y2FsbGJhY2t9IGRvbUV2ZW50Q2FsbGJhY2sgLSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uCiAgICoqLwogIGFkZENoYW5nZUxpc3RlbmVyKHQpIHsKICAgIHRoaXMuY3VycmVudFVwZGF0ZUNhbGxiYWNrID09IG51bGwgJiYgKHRoaXMuY3VycmVudFVwZGF0ZUNhbGxiYWNrID0gdCwgdGhpcy5jb250cm9scy5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCB0KSk7CiAgfQogIC8qKgogICAqIFJlbW92ZSB0aGUgZXZlbnQgbGlzdGVuZXIgY2FsbGJhY2sgZm9yIHRoZSAiY2hhbmdlIiBldmVudC4KICAgKiovCiAgcmVtb3ZlQ2hhbmdlTGlzdGVuZXIoKSB7CiAgICB0aGlzLmN1cnJlbnRVcGRhdGVDYWxsYmFjayAhPSBudWxsICYmICh0aGlzLmNvbnRyb2xzLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIHRoaXMuY3VycmVudFVwZGF0ZUNhbGxiYWNrKSwgdGhpcy5jdXJyZW50VXBkYXRlQ2FsbGJhY2sgPSBudWxsKTsKICB9CiAgLyoqCiAgICogVXBkYXRlIGNvbnRyb2xzIGFmdGVyIGNhbWVyYSBwb3NpdGlvbiwgem9vbSBvciBxdWF0ZXJuaW9uIGNoYW5nZXMuCiAgICoqLwogIHVwZGF0ZSgpIHsKICAgIHRoaXMuY29udHJvbHMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFJlc2V0IGNhbWVyYSB0byBpbml0aWFsIChhdXRvbWF0aWNhbGx5IHNhdmVkKSBzdGF0ZSBvZiBwb3NpdGlvbiwgdXAsIHF1YXRlcm5pb24gYW5kIHpvb20uCiAgICoqLwogIHJlc2V0KCkgewogICAgdGhpcy5jb250cm9scy5yZXNldCgpOwogIH0KICAvKioKICAgKiBTZXQgdGhlIGNhbWVyYSB0byBiZSBjb250cm9sbGVkLgogICAqIEBwYXJhbSB7VEhSRUUuQ2FtZXJhfSBjYW1lcmEgLSBhIHRocmVlanMgQ2FtZXJhIG9iamVjdC4KICAgKiovCiAgc2V0Q2FtZXJhKHQpIHsKICAgIHRoaXMuY29udHJvbHMub2JqZWN0ID0gdDsKICB9CiAgLyoqCiAgICogQ2hhbmdlIHRoZSB0cmFja2JhbGwgaG9scm95ZCAobm9uIHR1bWJsaW5nKSBmbGFnLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIGEgdGhyZWVqcyBDYW1lcmEgb2JqZWN0LgogICAqKi8KICBzZXRIb2xyb3lkVHJhY2tiYWxsKHQpIHsKICAgIHRoaXMuY29udHJvbHMuaG9scm95ZCA9IHQ7CiAgfQogIC8qKgogICAqIEdldCB0aGUgbG9va0F0IHRhcmdldCBvZiB0aGUgY2FtZXJhLgogICAqIEByZXR1cm5zIHtUSFJFRS5WZWN0b3IzfSBUaGUgbG9va0F0IHRhcmdldAogICAqKi8KICBnZXRUYXJnZXQoKSB7CiAgICByZXR1cm4gdGhpcy5jb250cm9scy50YXJnZXQ7CiAgfQogIC8qKgogICAqIEdldCB0aGUgaW5pdGlhbCB6b29tIHZhbHVlIG9mIHRoZSBjYW1lcmEuCiAgICoqLwogIGdldFpvb20wKCkgewogICAgcmV0dXJuIHRoaXMuY29udHJvbHMuem9vbTA7CiAgfQogIC8qKgogICAqIEdldCB0aGUgbG9va0F0IHRhcmdldCBvZiB0aGUgY2FtZXJhLgogICAqIEBwYXJhbSB7bnVtYmVyW119IHRhcmdldCAtIGNhbWVyYSB0YXJnZXQgYXMgVEhSRUUuVmVjdG9yMy4KICAgKiovCiAgc2V0VGFyZ2V0KHQpIHsKICAgIHRoaXMuY29udHJvbHMudGFyZ2V0LmNvcHkodCk7CiAgfQogIC8qKgogICAqIFNldCB0aGUgem9vbSBzcGVlZC4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gdGhlIHNwZWVkIHZhbHVlLgogICAqKi8KICBzZXRab29tU3BlZWQodCkgewogICAgdGhpcy5jb250cm9scy56b29tU3BlZWQgPSB0OwogIH0KICAvKioKICAgKiBTZXQgdGhlIHBhbiBzcGVlZC4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gdGhlIHNwZWVkIHZhbHVlLgogICAqKi8KICBzZXRQYW5TcGVlZCh0KSB7CiAgICB0aGlzLmNvbnRyb2xzLnBhblNwZWVkID0gdDsKICB9CiAgLyoqCiAgICogU2V0IHRoZSByb3RhdGUgc3BlZWQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbCAtIHRoZSBzcGVlZCB2YWx1ZS4KICAgKiovCiAgc2V0Um90YXRlU3BlZWQodCkgewogICAgdGhpcy5jb250cm9scy5yb3RhdGVTcGVlZCA9IHQ7CiAgfQogIC8vIFJvdGF0aW9ucyBmb3IgT3JiaXRDb250cm9scwogIC8qKgogICAqIFJvdGF0ZSBjYW1lcmEgdXAgKE9yYml0Q29udHJvbHMgb25seSkKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSB0aGUgYW5nbGUgdG8gcm90YXRlLgogICAqKi8KICByb3RhdGVVcCh0KSB7CiAgICB0aGlzLmNvbnRyb2xzLnJvdGF0ZVVwKC10IC8gMTgwICogTWF0aC5QSSksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFJvdGF0ZSBjYW1lcmEgbGVmdCAoT3JiaXRDb250cm9scyBvbmx5KQogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIHRoZSBhbmdsZSB0byByb3RhdGUuCiAgICoqLwogIHJvdGF0ZUxlZnQodCkgewogICAgdGhpcy5jb250cm9scy5yb3RhdGVMZWZ0KHQgLyAxODAgKiBNYXRoLlBJKSwgdGhpcy51cGRhdGUoKTsKICB9CiAgLy8gUm90YXRpb25zIGZvciBUcmFja2JhbGxDb250cm9scwogIC8qKgogICAqIFJvdGF0ZSBjYW1lcmEgYXJvdW5kIHgtYXhpcyAoVHJhY2tiYWxsQ29udHJvbHMgb25seSkKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSB0aGUgYW5nbGUgdG8gcm90YXRlLgogICAqKi8KICByb3RhdGVYKHQpIHsKICAgIHRoaXMuY29udHJvbHMucm90YXRlWCh0IC8gMTgwICogTWF0aC5QSSksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFJvdGF0ZSBjYW1lcmEgYXJvdW5kIHktYXhpcyAoVHJhY2tiYWxsQ29udHJvbHMgb25seSkKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSB0aGUgYW5nbGUgdG8gcm90YXRlLgogICAqKi8KICByb3RhdGVZKHQpIHsKICAgIHRoaXMuY29udHJvbHMucm90YXRlWSh0IC8gMTgwICogTWF0aC5QSSksIHRoaXMudXBkYXRlKCk7CiAgfQogIC8qKgogICAqIFJvdGF0ZSBjYW1lcmEgYXJvdW5kIHotYXhpcyAoVHJhY2tiYWxsQ29udHJvbHMgb25seSkKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSB0aGUgYW5nbGUgdG8gcm90YXRlLgogICAqKi8KICByb3RhdGVaKHQpIHsKICAgIHRoaXMuY29udHJvbHMucm90YXRlWih0IC8gMTgwICogTWF0aC5QSSksIHRoaXMudXBkYXRlKCk7CiAgfQp9CmNvbnN0IHBkID0gewogIHlfdXA6IHsKICAgIC8vIGNvbXBhdGlibGUgdG8gZnVzaW9uIDM2MAogICAgaXNvOiB7IHBvczogbmV3IEUoMSwgMSwgMSksIHF1YXQ6IG51bGwgfSwKICAgIGZyb250OiB7IHBvczogbmV3IEUoMCwgMCwgMSksIHF1YXQ6IG51bGwgfSwKICAgIHJlYXI6IHsgcG9zOiBuZXcgRSgwLCAwLCAtMSksIHF1YXQ6IG51bGwgfSwKICAgIGxlZnQ6IHsgcG9zOiBuZXcgRSgtMSwgMCwgMCksIHF1YXQ6IG51bGwgfSwKICAgIHJpZ2h0OiB7IHBvczogbmV3IEUoMSwgMCwgMCksIHF1YXQ6IG51bGwgfSwKICAgIHRvcDogeyBwb3M6IG5ldyBFKDAsIDEsIDApLCBxdWF0OiBudWxsIH0sCiAgICBib3R0b206IHsgcG9zOiBuZXcgRSgwLCAtMSwgMCksIHF1YXQ6IG51bGwgfQogIH0sCiAgel91cDogewogICAgLy8gY29tcGF0aWJsZSB0byBGcmVlQ0FELCBPblNoYXBlCiAgICBpc286IHsgcG9zOiBuZXcgRSgxLCAtMSwgMSksIHF1YXQ6IG51bGwgfSwKICAgIGZyb250OiB7IHBvczogbmV3IEUoMCwgLTEsIDApLCBxdWF0OiBudWxsIH0sCiAgICByZWFyOiB7IHBvczogbmV3IEUoMCwgMSwgMCksIHF1YXQ6IG51bGwgfSwKICAgIGxlZnQ6IHsgcG9zOiBuZXcgRSgtMSwgMCwgMCksIHF1YXQ6IG51bGwgfSwKICAgIHJpZ2h0OiB7IHBvczogbmV3IEUoMSwgMCwgMCksIHF1YXQ6IG51bGwgfSwKICAgIHRvcDogeyBwb3M6IG5ldyBFKDAsIDAsIDEpLCBxdWF0OiBbMCwgMCwgMCwgMV0gfSwKICAgIGJvdHRvbTogeyBwb3M6IG5ldyBFKDAsIDAsIC0xKSwgcXVhdDogWzEsIDAsIDAsIDBdIH0KICB9LAogIGxlZ2FjeTogewogICAgLy8gbGVnYWN5IFogdXAKICAgIGlzbzogeyBwb3M6IG5ldyBFKDEsIDEsIDEpLCBxdWF0OiBudWxsIH0sCiAgICBmcm9udDogeyBwb3M6IG5ldyBFKDEsIDAsIDApLCBxdWF0OiBudWxsIH0sCiAgICByZWFyOiB7IHBvczogbmV3IEUoLTEsIDAsIDApLCBxdWF0OiBudWxsIH0sCiAgICBsZWZ0OiB7IHBvczogbmV3IEUoMCwgMSwgMCksIHF1YXQ6IG51bGwgfSwKICAgIHJpZ2h0OiB7IHBvczogbmV3IEUoMCwgLTEsIDApLCBxdWF0OiBudWxsIH0sCiAgICB0b3A6IHsgcG9zOiBuZXcgRSgwLCAwLCAxKSwgcXVhdDogbnVsbCB9LAogICAgYm90dG9tOiB7IHBvczogbmV3IEUoMCwgMCwgLTEpLCBxdWF0OiBudWxsIH0KICB9Cn0sIGZkID0gewogIHlfdXA6IFswLCAxLCAwXSwKICB6X3VwOiBbMCwgMCwgMV0sCiAgbGVnYWN5OiBbMCwgMCwgMV0KfTsKY2xhc3MgaFQgewogIC8qKgogICAqIENyZWF0ZSBhIGNvbWJpbmVkIGNhbWVyYSAob3J0aG9ncmFwaGljIGFuZCBwZXJzZXBjdGl2ZSkuCiAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gY2FudmFzIHdpZHRoLgogICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBjYW52YXMgaGVpZ2h0LgogICAqIEBwYXJhbSB7bnVtYmVyfSBkaXN0YW5jZSAtIGRpc3RhbmNlIGZyb20gdGhlIGxvb2tBdCBwb2ludC4KICAgKiBAcGFyYW0ge1RIUkVFLlZlY3RvcjN9IHRhcmdldCAtIHRhcmdldCAoVmVjdG9yMykgdG8gbG9vayBhdC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9ydGhvIC0gZmxhZyB3aGV0aGVyIHRoZSBpbml0aWFsIGNhbWVyYSBzaG91bGQgYmUgb3J0aG9ncmFwaGljLgogICAqIEBwYXJhbSB7c3RyaW5nfSB1cCAtIFogb3IgWSB0byBkZWZpbmUgd2hldGhlciBaIG9yIFkgZGlyZWN0aW9uIGlzIGNhbWVyYSB1cC4KICAgKiovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgcikgewogICAgY29uc3QgbyA9IHsKICAgICAgWTogInlfdXAiLAogICAgICBaOiAiel91cCIsCiAgICAgIEw6ICJsZWdhY3kiCiAgICB9OwogICAgdGhpcy50YXJnZXQgPSBuZXcgRSguLi5uKSwgdGhpcy5vcnRobyA9IHMsIHRoaXMudXAgPSBvW3JdLCB0aGlzLnlheGlzID0gbmV3IEUoMCwgMSwgMCksIHRoaXMuemF4aXMgPSBuZXcgRSgwLCAwLCAxKTsKICAgIGNvbnN0IGwgPSB0IC8gZTsKICAgIHZhciBoID0gMjI7CiAgICBjb25zdCBjID0gNTsKICAgIHRoaXMuY2FtZXJhX2Rpc3RhbmNlID0gYyAqIGksIHRoaXMucENhbWVyYSA9IG5ldyBWZSgKICAgICAgaCwKICAgICAgbCwKICAgICAgMC4xLAogICAgICAxMDAgKiBpCiAgICApLCB0aGlzLnBDYW1lcmEudXAuc2V0KC4uLmZkW3RoaXMudXBdKSwgdGhpcy5wQ2FtZXJhLmxvb2tBdCh0aGlzLnRhcmdldCk7CiAgICBjb25zdCB1ID0gdGhpcy5wcm9qZWN0U2l6ZShpLCBsKTsKICAgIHRoaXMub0NhbWVyYSA9IG5ldyBJYSgKICAgICAgLXVbMF0sCiAgICAgIHVbMF0sCiAgICAgIHVbMV0sCiAgICAgIC11WzFdLAogICAgICAwLjEsCiAgICAgIDEwMCAqIGkKICAgICksIHRoaXMub0NhbWVyYS51cC5zZXQoLi4uZmRbdGhpcy51cF0pLCB0aGlzLm9DYW1lcmEubG9va0F0KHRoaXMudGFyZ2V0KSwgdGhpcy5jYW1lcmEgPSBzID8gdGhpcy5vQ2FtZXJhIDogdGhpcy5wQ2FtZXJhLCB0aGlzLmNhbWVyYS51cC5zZXQoLi4uZmRbdGhpcy51cF0pOwogIH0KICAvKioKICAgKiBSZW1vdmUgYXNzZXRzLgogICAqLwogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLm9DYW1lcmEgPSBudWxsLCB0aGlzLnBDYW1lcmEgPSBudWxsOwogIH0KICAvKioKICAgKiBHZXQgdGhlIGN1cnJlbnQgY2FtZXJhLgogICAqIEByZXR1cm5zIHtUSFJFRS5DYW1lcmF9IENhbWVyYSBvYmplY3QuCiAgICoqLwogIGdldENhbWVyYSgpIHsKICAgIHJldHVybiB0aGlzLmNhbWVyYTsKICB9CiAgLyoqCiAgICogU2V0IHRoZSBsb29rQXQgcG9pbnQgZm9yIHRoZSBjYW1lcmEgdG8gdGhlIHByb3ZpZGVkIHRhcmdldC4KICAgKiovCiAgbG9va0F0VGFyZ2V0KCkgewogICAgdGhpcy5jYW1lcmEubG9va0F0KHRoaXMudGFyZ2V0KTsKICB9CiAgLyoqCiAgICogVXBkYXRlIGN1cnJlbnQgY2FtZXJhJ3MgcHJvamVjdGlvbiBtYXRyaXguCiAgICoqLwogIHVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKSB7CiAgICB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgfQogIC8qKgogICAqIFN3aXRjaCBiZXR3ZWVuIG9ydGhvZ3JhcGhpYyBhbmQgcGVyc3BlY3RpdmUgY2FtZXJhLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3J0aG9fZmxhZyAtIHRydWUgZm9yIG9ydGhvZ3JhcGhpYyBjYW1lcmEsIGVsc2UgcGVyc2VwY3RpdmUgY2FtZXJhLgogICAqKi8KICBzd2l0Y2hDYW1lcmEodCkgewogICAgdmFyIGUgPSB0aGlzLmdldFBvc2l0aW9uKCkuY2xvbmUoKTsKICAgIGNvbnN0IGkgPSB0aGlzLmdldFpvb20oKSwgbiA9IHRoaXMuZ2V0UXVhdGVybmlvbigpLmNsb25lKCk7CiAgICB0ID8gKHRoaXMuY2FtZXJhID0gdGhpcy5vQ2FtZXJhLCB0aGlzLm9ydGhvID0gITApIDogKHRoaXMuY2FtZXJhID0gdGhpcy5wQ2FtZXJhLCB0aGlzLm9ydGhvID0gITEpLCB0aGlzLnNldFBvc2l0aW9uKGUsICExKSwgdGhpcy5zZXRab29tKGkpLCB0aGlzLnNldFF1YXRlcm5pb24obiksIHRoaXMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwogIH0KICAvKioKICAgKiBDYWxjdWxhdGUgcHJvamVjdGVkIHNpemUgZm9yIG9ydGhvZ3JhcGhpYyBjYSxlcmEKICAgKiBAcGFyYW0ge251bWJlcn0gZnJ1c3R1bSAtIHZpZXcgZnJ1c3R1bS4KICAgKiBAcGFyYW0ge251bWJlcn0gYXNwZWN0IC0gdmlld2VyIGFzcGVjdCAod2lkdGggLyBoZWlnaHQpLgogICAqKi8KICBwcm9qZWN0U2l6ZSh0LCBlKSB7CiAgICB2YXIgaSwgbjsKICAgIHJldHVybiBlIDwgMSA/IChpID0gdCwgbiA9IGkgLyBlKSA6IChuID0gdCwgaSA9IG4gKiBlKSwgW2ksIG5dOwogIH0KICAvKioKICAgKiBTZXR1cCB0aGUgY3VycmVudCBjYW1lcmEuCiAgICogQHBhcmFtIHtib29sZWFufSByZWxhdGl2ZSAtIGZsYWcgd2hldGhlciB0aGUgcG9zaXRpb24gaXMgYSByZWxhdGl2ZSAoZS5nLiBbMSwxLDFdIGZvciBpc28pIG9yIGFic29sdXRlIHBvaW50LgogICAqIEBwYXJhbSB7VEhSRUUuVmVjdG9yM30gcG9zaXRpb24gLSB0aGUgY2FtZXJhIHBvc2l0aW9uIChyZWxhdGl2ZSBvciBhYnNvbHV0ZSkuCiAgICogQHBhcmFtIHtUSFJFRS5RdWF0ZXJuaW9ufSBxdWF0ZXJuaW9uIC0gdGhlIGNhbWVyYSByb3RhdGlvbiBleHByZXNzZWQgYnkgYSBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSB6b29tIC0gem9vbSB2YWx1ZS4KICAgKiovCiAgc2V0dXBDYW1lcmEodCwgZSA9IG51bGwsIGkgPSBudWxsLCBuID0gbnVsbCkgewogICAgaWYgKGUgIT0gbnVsbCkgewogICAgICB2YXIgcyA9IHQgPyBlLmNsb25lKCkubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodGhpcy5jYW1lcmFfZGlzdGFuY2UpLmFkZCh0aGlzLnRhcmdldCkgOiBlOwogICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5zZXQoLi4ucy50b0FycmF5KCkpOwogICAgfQogICAgaSAhPSBudWxsICYmIHRoaXMuY2FtZXJhLnF1YXRlcm5pb24uc2V0KC4uLmkudG9BcnJheSgpKSwgbiAhPSBudWxsICYmIHRoaXMuc2V0Wm9vbShuKSwgdGhpcy51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgfQogIC8qKgogICAqIE1vdmUgdGhlIGNhbWVyYSB0byBhIGdpdmVuIHByZXNldC4KICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyIC0gY2FuIGJlICJpc28iLCAidG9wIiwgImJvdHRvbSIsICJmcm9udCIsICJyZWFyIiwgImxlZnQiLCAicmlnaHQiCiAgICoqLwogIHByZXNldENhbWVyYSh0LCBlID0gbnVsbCkgewogICAgaWYgKGUgPT0gbnVsbCAmJiAoZSA9IHRoaXMuY2FtZXJhLnpvb20pLCB0aGlzLnNldHVwQ2FtZXJhKCEwLCBwZFt0aGlzLnVwXVt0XS5wb3MsIG51bGwsIGUpLCB0aGlzLmxvb2tBdFRhcmdldCgpLCBwZFt0aGlzLnVwXVt0XS5xdWF0ICE9IG51bGwpIHsKICAgICAgdmFyIGkgPSBwZFt0aGlzLnVwXVt0XS5xdWF0OwogICAgICB0aGlzLnNldFF1YXRlcm5pb24oaSk7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybiBjdXJyZW50IHpvb20gdmFsdWUuCiAgICogQHJldHVybnMge251bWJlcn0gem9vbSB2YWx1ZS4KICAgKiovCiAgZ2V0Wm9vbSgpIHsKICAgIGlmICh0aGlzLm9ydGhvKQogICAgICByZXR1cm4gdGhpcy5jYW1lcmEuem9vbTsKICAgIHZhciB0ID0gdGhpcy5jYW1lcmEucG9zaXRpb24uY2xvbmUoKS5zdWIodGhpcy50YXJnZXQpOwogICAgcmV0dXJuIHRoaXMuY2FtZXJhX2Rpc3RhbmNlIC8gdC5sZW5ndGgoKTsKICB9CiAgLyoqCiAgICogU2V0IHpvb20gdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbCAtIGZsb2F0IHpvb20gdmFsdWUuCiAgICoqLwogIHNldFpvb20odCkgewogICAgdGhpcy5vcnRobyA/IHRoaXMuY2FtZXJhLnpvb20gPSB0IDogdGhpcy5jYW1lcmEucG9zaXRpb24uc3ViKHRoaXMudGFyZ2V0KS5zZXRMZW5ndGgodGhpcy5jYW1lcmFfZGlzdGFuY2UgLyB0KS5hZGQodGhpcy50YXJnZXQpLCB0aGlzLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBjdXJyZW50IGNhbWVyYSBwb3NpdGlvbi4KICAgKiBAcmV0dXJucyB7VEhSRUUuVmVjdG9yM30gY2FtZXJhIHBvc2l0aW9uLgogICAqKi8KICBnZXRQb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmNhbWVyYS5wb3NpdGlvbjsKICB9CiAgLyoqCiAgICogU2V0IGNhbWVyYSBwb3NpdGlvbi4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJlbGF0aXZlIC0gZmxhZyB3aGV0aGVyIHRoZSBwb3NpdGlvbiBpcyBhIHJlbGF0aXZlIChlLmcuIFsxLDEsMV0gZm9yIGlzbykgb3IgYWJzb2x1dGUgcG9pbnQuCiAgICogQHBhcmFtIHsoQXJyYXkoMykgfCBUSFJFRS5WZWN0b3IzKX0gcG9zaXRpb24gLSBwb3NpdGlvbiBhcyAzIGRpbSBBcnJheSBbeCx5LHpdIG9yIGFzIFZlY3RvcjMuCiAgICoqLwogIHNldFBvc2l0aW9uKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzOwogICAgQXJyYXkuaXNBcnJheSh0KSAmJiB0Lmxlbmd0aCA9PT0gMyA/IGkuc2V0dXBDYW1lcmEoZSwgbmV3IEUoLi4udCkpIDogdCBpbnN0YW5jZW9mIEUgPyBpLnNldHVwQ2FtZXJhKGUsIHQpIDogY29uc29sZS5lcnJvcigid3JvbmcgdHlwZSBmb3IgcG9zaXRpb24iLCB0KTsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBjdXJyZW50IGNhbWVyYSBxdWF0ZXJuaW9uLgogICAqIEByZXR1cm5zIHtUSFJFRS5RdWF0ZXJuaW9ufSBjYW1lcmEgcXVhdGVybmlvbi4KICAgKiovCiAgZ2V0UXVhdGVybmlvbigpIHsKICAgIHJldHVybiB0aGlzLmNhbWVyYS5xdWF0ZXJuaW9uOwogIH0KICAvKioKICAgKiBTZXQgY2FtZXJhIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHsoQXJyYXkoNCl8VEhSRUUuUXVhdGVybmlvbil9IHF1YXRlcm5pb24gLSBxdWF0ZXJuaW9uIGFzIDQgZGltIEFycmF5IG9yIGFzIFF1YXRlcm5pb24uCiAgICoqLwogIHNldFF1YXRlcm5pb24odCkgewogICAgY29uc3QgZSA9IHRoaXM7CiAgICBBcnJheS5pc0FycmF5KHQpICYmIHQubGVuZ3RoID09PSA0ID8gZS5zZXR1cENhbWVyYShudWxsLCBudWxsLCBuZXcgdmUoLi4udCkpIDogdCBpbnN0YW5jZW9mIHZlID8gZS5zZXR1cENhbWVyYShudWxsLCBudWxsLCB0KSA6IGNvbnNvbGUuZXJyb3IoIndyb25nIHR5cGUgZm9yIHF1YXRlcm5pb24iLCB0KSwgdGhpcy51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgfQogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBjYW1lcmEgcm90YXRpb24uCiAgICogQHJldHVybnMge1RIUkVFLkV1bGVyfSBjYW1lcmEgcm90YXRpb24uCiAgICoqLwogIGdldFJvdGF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuY2FtZXJhLnJvdGF0aW9uOwogIH0KICBnZXRWaXNpYmxlQXJlYSgpIHsKICAgIGlmICh0aGlzLm9ydGhvKSB7CiAgICAgIGNvbnN0IHQgPSB0aGlzLmdldENhbWVyYSgpLCBlID0gKHQudG9wIC0gdC5ib3R0b20pIC8gdC56b29tOwogICAgICByZXR1cm4geyB3aWR0aDogKHQucmlnaHQgLSB0LmxlZnQpIC8gdC56b29tLCBoZWlnaHQ6IGUgfTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHQgPSB0aGlzLmdldENhbWVyYSgpLCBlID0gdC5wb3NpdGlvbi5kaXN0YW5jZVRvKHRoaXMudGFyZ2V0KSwgaSA9IHQuZm92ICogTWF0aC5QSSAvIDE4MCwgbiA9IDIgKiBNYXRoLnRhbihpIC8gMikgKiBlOwogICAgICByZXR1cm4geyB3aWR0aDogbiAqIHQuYXNwZWN0LCBoZWlnaHQ6IG4gfTsKICAgIH0KICB9CiAgY2hhbmdlRGltZW5zaW9ucyh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0gZSAvIGksIHMgPSB0aGlzLnByb2plY3RTaXplKHQsIG4pOwogICAgdGhpcy5vQ2FtZXJhICYmICh0aGlzLm9DYW1lcmEubGVmdCA9IC1zWzBdLCB0aGlzLm9DYW1lcmEucmlnaHQgPSBzWzBdLCB0aGlzLm9DYW1lcmEudG9wID0gc1sxXSwgdGhpcy5vQ2FtZXJhLmJvdHRvbSA9IC1zWzFdKSwgdGhpcy5wQ2FtZXJhICYmICh0aGlzLnBDYW1lcmEuYXNwZWN0ID0gbiksIHRoaXMuY2FtZXJhICYmIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKICB9Cn0KY29uc3QgdmcgPSAiMy42LjMiOwpjbGFzcyBjVCB7CiAgLyoqCiAgICogQ3JlYXRlIFZpZXdlci4KICAgKiBAcGFyYW0ge0Rpc3BsYXl9IGRpc3BsYXkgLSBUaGUgRGlzcGxheSBvYmplY3QuCiAgICogQHBhcmFtIHtEaXNwbGF5T3B0aW9uc30gb3B0aW9ucyAtIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycy4KICAgKiBAcGFyYW0ge05vdGlmaWNhdGlvbkNhbGxiYWNrfSBub3RpZnlDYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0byByZWNlaXZlIGNoYW5nZXMgb2Ygdmlld2VyIHBhcmFtZXRlcnMuCiAgICogQHBhcmFtIHtib29sZWFufSB1cGRhdGVNYXJrZXIgLSBlbmZvcmNlIHRvIHJlZHJhdyBvcmllbnRhdGlvbiBtYXJrZXIgYWZ0ZXIgZXZyeSB1aSBhY3Rpdml0eQogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4gPSBudWxsLCBzID0gITApIHsKICAgIC8vIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtCiAgICAvLyBVcGRhdGUgaGFuZGxpbmcgb2YgdGhlIHJlbmRlcmVyCiAgICAvLyAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLQogICAgLyoqCiAgICAgKiBDcmVhdGVzIENoYW5nZU5vdGlmaWNhdGlvbiBvYmplY3QgaWYgbmV3IHZhbHVlICE9IG9sZCB2YWx1ZSBhbmQgc2VuZHMgY2hhbmdlIG5vdGlmaWNhdGlvbnMgdmlhIHZpZXdlci5ub3RpZnlDYWxsYmFjay4KICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtDaGFuZ2VJbmZvc30gY2hhbmdlcyAtIGNoYW5nZSBpbmZvcm1hdGlvbi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbm90aWZ5IC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgImNoZWNrQ2hhbmdlcyIsICh0LCBlID0gITApID0+IHsKICAgICAgdmFyIGkgPSB7fTsKICAgICAgT2JqZWN0LmtleXModCkuZm9yRWFjaCgobikgPT4gewogICAgICAgIGlmICghdXAodGhpcy5sYXN0Tm90aWZpY2F0aW9uW25dLCB0W25dKSkgewogICAgICAgICAgdmFyIHMgPSBiYyh0W25dKTsKICAgICAgICAgIGlbbl0gPSB7CiAgICAgICAgICAgIG5ldzogcywKICAgICAgICAgICAgLy8gbWFwIHVuZGVmaW5lZCBpbiBsYXN0Tm90aWZpY2F0aW9uIHRvIG51bGwgdG8gZW5hYmxlIEpTT04gZXhjaGFuZ2UKICAgICAgICAgICAgb2xkOiB0aGlzLmxhc3ROb3RpZmljYXRpb25bbl0gPT0gbnVsbCA/IG51bGwgOiBiYyh0aGlzLmxhc3ROb3RpZmljYXRpb25bbl0pCiAgICAgICAgICB9LCB0aGlzLmxhc3ROb3RpZmljYXRpb25bbl0gPSBzOwogICAgICAgIH0KICAgICAgfSksIE9iamVjdC5rZXlzKGkpLmluY2x1ZGVzKCJwb3NpdGlvbiIpICYmICh0aGlzLmtlZXBIaWdobGlnaHQgPyB0aGlzLmtlZXBIaWdobGlnaHQgPSAhMSA6IHRoaXMuZGlzcGxheS5jbGVhckhpZ2hsaWdodHMoKSksIGUgJiYgdGhpcy5ub3RpZnlDYWxsYmFjayAmJiBPYmplY3Qua2V5cyhpKS5sZW5ndGggJiYgdGhpcy5ub3RpZnlDYWxsYmFjayhpKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBOb3RpZmllcyB0aGUgc3RhdGVzIGJ5IGNoZWNraW5nIGZvciBjaGFuZ2VzIGFuZCBwYXNzaW5nIHRoZSBzdGF0ZXMgdG8gdGhlIGNoZWNrQ2hhbmdlcyBtZXRob2QuCiAgICAgKi8KICAgIGsodGhpcywgIm5vdGlmeVN0YXRlcyIsICgpID0+IHsKICAgICAgdGhpcy5jaGVja0NoYW5nZXMoeyBzdGF0ZXM6IHRoaXMuZ2V0U3RhdGVzKCkgfSwgITApOwogICAgfSk7CiAgICAvKioKICAgICAqIFJlbmRlciBzY2VuZSBhbmQgdXBkYXRlIG9yaWVudGF0aW9uIG1hcmtlcgogICAgICogSWYgbm8gYW5pbWF0aW9uIGxvb3AgZXhpc3RzLCB0aGlzIG5lZWRzIHRvIGJlIGNhbGxlZCBtYW51YWxseSBhZnRlciBldmVyeSBjYW1lcmEvc2NlbmUgY2hhbmdlCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gdXBkYXRlTWFya2VyIC0gd2hldGhlciB0byB1cGRhdGUgdGhlIG9yaWVudGF0aW9uIG1hcmtlcgogICAgICogQHBhcmFtIHtib29sZWFufSBmcm9tQW5pbWF0aW9uTG9vcCAtIHdoZXRoZXIgYSBhbmltYXRpb24gbG9vcCBpcyBydW5uaW5nIGluIHRoZSBiYWNrZ3JvdW5kLiBVcGRhdGUgd2lsbCBza2lwcGVkIGZvciB0aGlzIGNhc2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbm90aWZ5IC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInVwZGF0ZSIsICh0LCBlID0gITApID0+IHsKICAgICAgdGhpcy5yZWFkeSAmJiAodGhpcy5yZW5kZXJlci5jbGVhcigpLCB0aGlzLnJheWNhc3RlciAmJiB0aGlzLnJheWNhc3Rlci5yYXljYXN0TW9kZSAmJiB0aGlzLmhhbmRsZVJheWNhc3QoKSwgdGhpcy5ncmlkSGVscGVyLnVwZGF0ZSh0aGlzLmNhbWVyYS5nZXRab29tKCkpLCB0aGlzLnJlbmRlcmVyLnNldFZpZXdwb3J0KDAsIDAsIHRoaXMuY2FkV2lkdGgsIHRoaXMuaGVpZ2h0KSwgdGhpcy5yZW5kZXJlci5yZW5kZXIodGhpcy5zY2VuZSwgdGhpcy5jYW1lcmEuZ2V0Q2FtZXJhKCkpLCB0aGlzLmNhZFRvb2xzLnVwZGF0ZSgpLCB0aGlzLmRpcmVjdExpZ2h0LnBvc2l0aW9uLmNvcHkodGhpcy5jYW1lcmEuZ2V0Q2FtZXJhKCkucG9zaXRpb24pLCB0aGlzLmxhc3RCYm94ICE9IG51bGwgJiYgKHRoaXMubGFzdEJib3gubmVlZHNVcGRhdGUgfHwgdGhpcy5iYm94TmVlZHNVcGRhdGUpICYmIChjb25zb2xlLmRlYnVnKCJ1cGRhdGVkIGJib3giKSwgdGhpcy5sYXN0QmJveC5iYm94LnVwZGF0ZSgpLCB0aGlzLmxhc3RCYm94Lm5lZWRzVXBkYXRlID0gITEpLCB0ICYmICh0aGlzLnJlbmRlcmVyLmNsZWFyRGVwdGgoKSwgdGhpcy5vcmllbnRhdGlvbk1hcmtlci51cGRhdGUoCiAgICAgICAgdGhpcy5jYW1lcmEuZ2V0UG9zaXRpb24oKS5jbG9uZSgpLnN1Yih0aGlzLmNvbnRyb2xzLmdldFRhcmdldCgpKSwKICAgICAgICB0aGlzLmNhbWVyYS5nZXRRdWF0ZXJuaW9uKCkKICAgICAgKSwgdGhpcy5vcmllbnRhdGlvbk1hcmtlci5yZW5kZXIodGhpcy5yZW5kZXJlcikpLCB0aGlzLmFuaW1hdGlvbiAmJiB0aGlzLmFuaW1hdGlvbi51cGRhdGUoKSwgdGhpcy5jaGVja0NoYW5nZXMoCiAgICAgICAgewogICAgICAgICAgem9vbTogdGhpcy5jYW1lcmEuZ2V0Wm9vbSgpLAogICAgICAgICAgcG9zaXRpb246IHRoaXMuY2FtZXJhLmdldFBvc2l0aW9uKCkudG9BcnJheSgpLAogICAgICAgICAgcXVhdGVybmlvbjogdGhpcy5jYW1lcmEuZ2V0UXVhdGVybmlvbigpLnRvQXJyYXkoKSwKICAgICAgICAgIHRhcmdldDogdGhpcy5jb250cm9scy5nZXRUYXJnZXQoKS50b0FycmF5KCkKICAgICAgICB9LAogICAgICAgIGUKICAgICAgKSk7CiAgICB9KTsKICAgIC8qKgogICAgICogU3RhcnQgdGhlIGFuaW1hdGlvbiBsb29wCiAgICAgKiBAZnVuY3Rpb24KICAgICAqLwogICAgayh0aGlzLCAiYW5pbWF0ZSIsICgpID0+IHsKICAgICAgdGhpcy5jb250aW51ZUFuaW1hdGlvbiA/IChyZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5hbmltYXRlKSwgdGhpcy5jb250cm9scy51cGRhdGUoKSwgdGhpcy51cGRhdGUoITAsICEwKSkgOiBjb25zb2xlLmRlYnVnKCJ0aHJlZS1jYWQtdmlld2VyOiBBbmltYXRpb24gbG9vcCBzdG9wcGVkIik7CiAgICB9KTsKICAgIC8vIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtCiAgICAvLyBSZW5kZXJpbmcKICAgIC8vIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtCiAgICAvKioKICAgICAqIFN5bmNocm9uaXplcyB0aGUgc3RhdGVzIG9mIHR3byB0cmVlIHN0cnVjdHVyZXMgcmVjdXJzaXZlbHkuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R9IGNvbXBhY3RUcmVlIC0gVGhlIGNvbXBhY3QgdHJlZSBzdHJ1Y3R1cmUuCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gZXhwYW5kZWRUcmVlIC0gVGhlIGV4cGFuZGVkIHRyZWUgc3RydWN0dXJlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBUaGUgY3VycmVudCBwYXRoIGluIHRoZSB0cmVlIHN0cnVjdHVyZS4KICAgICAqLwogICAgayh0aGlzLCAic3luY1RyZWVTdGF0ZXMiLCAodCwgZSwgaSwgbikgPT4gewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh0KSkKICAgICAgICBpZiAoaSkKICAgICAgICAgIGZvciAodmFyIHMgaW4gZSkKICAgICAgICAgICAgZm9yICh2YXIgciBpbiBlW3NdKSB7CiAgICAgICAgICAgICAgY29uc3QgdSA9IGAke259LyR7c30vJHtyfWAsIGQgPSB0aGlzLmV4cGFuZGVkTmVzdGVkR3JvdXAuZ3JvdXBzW3VdOwogICAgICAgICAgICAgIGZvciAodmFyIG8gb2YgWzAsIDFdKQogICAgICAgICAgICAgICAgbyA9PSAwID8gZC5zZXRTaGFwZVZpc2libGUodFswXSA9PSAxKSA6IGQuc2V0RWRnZXNWaXNpYmxlKHRbMV0gPT0gMSksIGVbc11bcl1bb10gIT0gMyAmJiAoZVtzXVtyXVtvXSA9IHRbb10pOwogICAgICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBjb25zdCB1ID0gdGhpcy5jb21wYWN0TmVzdGVkR3JvdXAuZ3JvdXBzW25dOwogICAgICAgICAgZm9yICh2YXIgbyBvZiBbMCwgMV0pIHsKICAgICAgICAgICAgdmFyIGwgPSAhMTsKICAgICAgICAgICAgZm9yICh2YXIgcyBpbiBlKQogICAgICAgICAgICAgIGZvciAodmFyIHIgaW4gZVtzXSkKICAgICAgICAgICAgICAgIGVbc11bcl1bb10gPT0gMSAmJiAobCA9ICEwKTsKICAgICAgICAgICAgbyA9PSAwID8gdS5zZXRTaGFwZVZpc2libGUobCkgOiB1LnNldEVkZ2VzVmlzaWJsZShsKSwgdFtvXSAhPSAzICYmICh0W29dID0gbCA/IDEgOiAwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIGVsc2UKICAgICAgICBmb3IgKHZhciBoIGluIHQpIHsKICAgICAgICAgIHZhciBjID0gYCR7bn0vJHtofWA7CiAgICAgICAgICB0aGlzLnN5bmNUcmVlU3RhdGVzKHRbaF0sIGVbaF0sIGksIGMpOwogICAgICAgIH0KICAgIH0pOwogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNvbG9yIG9mIGEgbm9kZSBmcm9tIGl0cyBwYXRoCiAgICAgKiBAcGFyYW0gcGF0aCAtIHBhdGggb2YgdGhlIENBRCBvYmplY3QKICAgICAqLwogICAgayh0aGlzLCAiZ2V0Tm9kZUNvbG9yIiwgKHQpID0+IHsKICAgICAgdmFyIGUgPSB0aGlzLm5lc3RlZEdyb3VwLmdyb3Vwc1siLyIgKyB0XTsKICAgICAgaWYgKGUgaW5zdGFuY2VvZiBsbikgewogICAgICAgIGxldCBpID0gIiI7CiAgICAgICAgcmV0dXJuIGUuY2hpbGRyZW5bMF0udHlwZSAhPT0gIk1lc2giIHx8IGUuY2hpbGRyZW5bMF0ubWF0ZXJpYWwubmFtZSA9PSAiZnJvbnRNYXRlcmlhbCIgPyBpID0gZS5jaGlsZHJlblswXS5tYXRlcmlhbC5jb2xvciA6IGkgPSBlLmNoaWxkcmVuWzFdLm1hdGVyaWFsLmNvbG9yLCAiIyIgKyBpLmdldEhleFN0cmluZygpOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfSk7CiAgICAvLyAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLQogICAgLy8gRXZlbnQgaGFuZGxlcnMKICAgIC8vIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtCiAgICAvKioKICAgICAqIE1vdmUgdGhlIGNhbWVyYSB0byBhIGdpdmVuIGxvY2F0aW9ucwogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge3JlbGF0aXZlfSBbcmVsYXRpdmU9ZmFsc2VdIC0gZmxhZyB3aGV0aGVyIHRoZSBwb3NpdGlvbiBpcyBhIHJlbGF0aXZlIChlLmcuIFsxLDEsMV0gZm9yIGlzbykgb3IgYWJzb2x1dGUgcG9pbnQuCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBwb3NpdGlvbiAtIHRoZSBjYW1lcmEgcG9zaXRpb24gYXMgMyBkaW0gYXJyYXkgW3gseSx6XQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gW3F1YXRlcm5pb249bnVsbF0gLSB0aGUgY2FtZXJhIHJvdGF0aW9uIGV4cHJlc3NlZCBieSBhIHF1YXRlcm5pb24gYXJyYXkgW3gseSx6LHddLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFt6b29tPW51bGxdIC0gem9vbSB2YWx1ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAgICovCiAgICBrKHRoaXMsICJzZXRDYW1lcmEiLCAodCwgZSwgaSA9IG51bGwsIG4gPSBudWxsLCBzID0gITApID0+IHsKICAgICAgdGhpcy5jYW1lcmEuc2V0dXBDYW1lcmEoCiAgICAgICAgdCwKICAgICAgICBuZXcgRSguLi5lKSwKICAgICAgICBpICE9IG51bGwgPyBuZXcgdmUoLi4uaSkgOiBudWxsLAogICAgICAgIG4sCiAgICAgICAgcwogICAgICApLCB0aGlzLnVwZGF0ZSghMCwgcyk7CiAgICB9KTsKICAgIC8qKgogICAgICogTW92ZSB0aGUgY2FtZXJhIHRvIG9uZSBvZiB0aGUgcHJlc2V0IGxvY2F0aW9ucwogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyIC0gY2FuIGJlICJpc28iLCAidG9wIiwgImJvdHRvbSIsICJmcm9udCIsICJyZWFyIiwgImxlZnQiLCAicmlnaHQiCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3pvb209bnVsbF0gLSB6b29tIHZhbHVlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgICAqLwogICAgayh0aGlzLCAicHJlc2V0Q2FtZXJhIiwgKHQsIGUgPSBudWxsLCBpID0gITApID0+IHsKICAgICAgdGhpcy5jYW1lcmEudGFyZ2V0ID0gbmV3IEUoLi4udGhpcy5iYm94LmNlbnRlcigpKSwgdGhpcy5jYW1lcmEucHJlc2V0Q2FtZXJhKHQsIGUsIGkpLCB0aGlzLmNvbnRyb2xzLnNldFRhcmdldCh0aGlzLmNhbWVyYS50YXJnZXQpLCB0aGlzLnVwZGF0ZSghMCwgaSk7CiAgICB9KTsKICAgIC8qKgogICAgICogUmVzZXQgem9vbSB0byAxLjAKICAgICAqIEBmdW5jdGlvbgogICAgICovCiAgICBrKHRoaXMsICJyZXNpemUiLCAoKSA9PiB7CiAgICAgIHRoaXMuY2FtZXJhLnNldFpvb20oMSksIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKSwgdGhpcy51cGRhdGUoITApOwogICAgfSk7CiAgICAvKioKICAgICAqIFJlc2V0IHRoZSB2aWV3IHRvIHRoZSBpbml0aWFsIGNhbWVyYSBhbmQgY29udHJvbHMgc2V0dGluZ3MKICAgICAqIEBmdW5jdGlvbgogICAgICovCiAgICBrKHRoaXMsICJyZXNldCIsICgpID0+IHsKICAgICAgdGhpcy5jb250cm9scy5yZXNldCgpLCB0aGlzLnVwZGF0ZSghMCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0cyB0aGUgdmlzaWJpbGl0eSBzdGF0ZSBvZiBhbiBvYmplY3QgaW4gdGhlIHZpZXdlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoIG9mIHRoZSBvYmplY3QuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gc3RhdGUgLSBUaGUgdmlzaWJpbGl0eSBzdGF0ZSAoMCBvciAxKS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpY29uTnVtYmVyIC0gVGhlIGljb24gbnVtYmVyLgogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gV2hldGhlciB0byBub3RpZnkgdGhlIGNoYW5nZXMuCiAgICAgKi8KICAgIGsodGhpcywgInNldE9iamVjdCIsICh0LCBlLCBpLCBuID0gITAsIHMgPSAhMCkgPT4gewogICAgICB2YXIgciA9IHRoaXMubmVzdGVkR3JvdXAuZ3JvdXBzW3RdOwogICAgICByICE9IG51bGwgJiYgciBpbnN0YW5jZW9mIGxuICYmIChpID09IDAgPyByLnNldFNoYXBlVmlzaWJsZShlID09PSAxKSA6IHIuc2V0RWRnZXNWaXNpYmxlKGUgPT09IDEpLCBuICYmIHRoaXMuZ2V0U3RhdGUodCksIHMgJiYgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBib3VuZGluZyBib3ggZm9yIGEgZ2l2ZW4gSUQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgLSBUaGUgSUQgb2YgdGhlIGdyb3VwLgogICAgICovCiAgICBrKHRoaXMsICJzZXRCb3VuZGluZ0JveCIsICh0KSA9PiB7CiAgICAgIHZhciBlID0gdGhpcy5uZXN0ZWRHcm91cC5ncm91cHNbdF07CiAgICAgIGUgIT0gbnVsbCAmJiAodGhpcy5sYXN0QmJveCAhPSBudWxsICYmIHRoaXMuc2NlbmUucmVtb3ZlKHRoaXMubGFzdEJib3guYmJveCksIHRoaXMubGFzdEJib3ggPT0gbnVsbCB8fCB0aGlzLmxhc3RCYm94ICE9IG51bGwgJiYgdCAhPSB0aGlzLmxhc3RCYm94LmlkID8gKHRoaXMubGFzdEJib3ggPSB7CiAgICAgICAgaWQ6IHQsCiAgICAgICAgYmJveDogbmV3IEdFKGUsIDE2NzExOTM1KSwKICAgICAgICBuZWVkc1VwZGF0ZTogITEKICAgICAgfSwgdGhpcy5zY2VuZS5hZGQodGhpcy5sYXN0QmJveC5iYm94KSkgOiB0aGlzLmxhc3RCYm94ID0gbnVsbCwgdGhpcy51cGRhdGUoITEsICExLCAhMSkpOwogICAgfSk7CiAgICAvKioKICAgICAqIFJlZnJlc2ggY2xpcHBpbmcgcGxhbmUKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gaW5kZXggb2YgdGhlIHBsYW5lOiAwLDEsMgogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gZGlzdGFuY2Ugb24gdGhlIGNsaXBwaW5nIG5vcm1hbCBmcm9tIHRoZSBjZW50ZXIKICAgICAqLwogICAgayh0aGlzLCAicmVmcmVzaFBsYW5lIiwgKHQsIGUpID0+IHsKICAgICAgdGhpcy5jbGlwcGluZy5zZXRDb25zdGFudCh0LCBlKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpOwogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZXIgZm9yIHRoZSBhbmltYXRpb24gY29udHJvbAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYnRuIC0gdGhlIHByZXNzZWQgYnV0dG9uIGFzIHN0cmluZzogInBsYXkiLCAicGF1c2UiLCAic3RvcCIKICAgICAqLwogICAgayh0aGlzLCAiY29udHJvbEFuaW1hdGlvbiIsICh0KSA9PiB7CiAgICAgIHN3aXRjaCAodCkgewogICAgICAgIGNhc2UgInBsYXkiOgogICAgICAgICAgdGhpcy5jbGlwQWN0aW9uLnBhdXNlZCAmJiAodGhpcy5jbGlwQWN0aW9uLnBhdXNlZCA9ICExKSwgdGhpcy5jbGlwQWN0aW9uLnBsYXkoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgIHRoaXMuY2xpcEFjdGlvbi5wYXVzZWQgPSAhdGhpcy5jbGlwQWN0aW9uLnBhdXNlZDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInN0b3AiOgogICAgICAgICAgdGhpcy5jbGlwQWN0aW9uLnN0b3AoKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IHN0YXRlIG9mIG9uZSBlbnRyeSBvZiBhIHRyZWV2aWV3IGxlYWYgZ2l2ZW4gYnkgYW4gaWQKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gb2JqZWN0IGlkCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBzdGF0ZSAtIDIgZGltIGFycmF5IFttZXNoLCBlZGdlc10gPSBbMC8xLCAwLzFdCiAgICAgKiBAcF5hcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldFN0YXRlIiwgKHQsIGUsIGkgPSAibGVhZiIsIG4gPSAhMCkgPT4gewogICAgICB0aGlzLnRyZWV2aWV3LnNldFN0YXRlKHQsIGUpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlciwgbik7CiAgICB9KTsKICAgIC8qKgogICAgICogSGFuZGxlIGJvdW5kaW5nIGJveCBhbmQgbm90aWZpY2F0aW9ucyBmb3IgcGlja2VkIGVsZW1lbnRzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7c3RyaW5nfSAtIHBhdGggb2Ygb2JqZWN0CiAgICAgKiBAcGFyYW0ge3N0cmluZ30gLSBuYW1lIG9mIG9iamVjdCAoaWQgPSBwYXRoL25hbWUpCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IC0gbWV0YSBrZXkgcHJlc3NlZAogICAgICogQHBhcmFtIHtib29sZWFufSBzaGlmdCAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAgICovCiAgICBrKHRoaXMsICJoYW5kbGVQaWNrIiwgKHQsIGUsIGksIG4sIHMsIHIsIG8gPSAibGVhZiIsIGwpID0+IHsKICAgICAgdmFyIHA7CiAgICAgIGNvbnN0IGggPSBgJHt0fS8ke2V9YCwgYyA9IHRoaXMubmVzdGVkR3JvdXAuZ3JvdXBzW2hdOwogICAgICBpZiAoYyAhPSBudWxsKSB7CiAgICAgICAgdmFyIHU7CiAgICAgICAgaWYgKGMucGFyZW50ICE9IG51bGwpCiAgICAgICAgICB1ID0gbmV3IG9yKCkuc2V0RnJvbU9iamVjdChjLCAhMCk7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICB1ID0gbmV3IG9yKCk7CiAgICAgICAgICBmb3IgKHZhciBkID0gMDsgZCA8IGMuY2hpbGRyZW4ubGVuZ3RoIC0gMTsgZCsrKQogICAgICAgICAgICB1ID0gdS5leHBhbmRCeU9iamVjdChjLmNoaWxkcmVuW2RdKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMubGFzdEJib3ggIT0gbnVsbCAmJiB0aGlzLmxhc3RCYm94LmlkID09PSBoICYmICFpICYmICFuKQogICAgICAgICAgdGhpcy5yZW1vdmVMYXN0QmJveCgpLCB0aGlzLnRyZWV2aWV3LnRvZ2dsZUxhYmVsQ29sb3IobnVsbCwgaCk7CiAgICAgICAgZWxzZSBpZiAodGhpcy5jaGVja0NoYW5nZXMoewogICAgICAgICAgbGFzdFBpY2s6IHsKICAgICAgICAgICAgcGF0aDogdCwKICAgICAgICAgICAgbmFtZTogZSwKICAgICAgICAgICAgYm91bmRpbmdCb3g6IHUsCiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiB1LmJvdW5kaW5nU3BoZXJlKCkKICAgICAgICAgIH0KICAgICAgICB9KSwgKHAgPSB0aGlzLmFuaW1hdGlvbi5jbGlwQWN0aW9uKSAhPSBudWxsICYmIHAuaXNSdW5uaW5nKCkgJiYgKHRoaXMuYmJveE5lZWRzVXBkYXRlID0gITApLCBuICYmIGkpCiAgICAgICAgICBpZiAodGhpcy5yZW1vdmVMYXN0QmJveCgpLCBsKQogICAgICAgICAgICB0aGlzLnRyZWV2aWV3LmhpZGVBbGwoKSwgdGhpcy5zZXRTdGF0ZShoLCBbMSwgMV0sIG8pOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGYgPSB1LmNlbnRlcigpOwogICAgICAgICAgICB0aGlzLnNldENhbWVyYVRhcmdldChyKSwgdGhpcy5pbmZvLmNlbnRlckluZm8oZik7CiAgICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAobikgewogICAgICAgICAgdGhpcy5yZW1vdmVMYXN0QmJveCgpLCB0aGlzLnRyZWV2aWV3LmhpZGVBbGwoKSwgdGhpcy5zZXRTdGF0ZShoLCBbMSwgMV0sIG8pOwogICAgICAgICAgY29uc3QgZiA9IHUuY2VudGVyKCk7CiAgICAgICAgICB0aGlzLnNldENhbWVyYVRhcmdldChuZXcgRSguLi5mKSksIHRoaXMuaW5mby5jZW50ZXJJbmZvKGYpOwogICAgICAgIH0gZWxzZSBpID8gdGhpcy5zZXRTdGF0ZShoLCBbMCwgMF0sIG8pIDogKHRoaXMuaW5mby5iYkluZm8odCwgZSwgdSksIHRoaXMuc2V0Qm91bmRpbmdCb3goaCksIHRoaXMudHJlZXZpZXcub3BlblBhdGgoaCkpOwogICAgICAgIHRoaXMudXBkYXRlKCEwKTsKICAgICAgfQogICAgfSk7CiAgICAvKioKICAgICAqIEZpbmQgdGhlIHNoYXBlIHRoYXQgd2FzIGRvdWJsZSBjbGlja2VkIGFuZCBzZW5kIG5vdGlmaWNhdGlvbgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGUgLSBhIERPTSBNb3VzZUV2ZW50CiAgICAgKi8KICAgIGsodGhpcywgInBpY2siLCAodCkgPT4gewogICAgICBjb25zdCBlID0gbmV3IHVnKAogICAgICAgIHRoaXMuY2FtZXJhLAogICAgICAgIHRoaXMucmVuZGVyZXIuZG9tRWxlbWVudCwKICAgICAgICB0aGlzLmNhZFdpZHRoLAogICAgICAgIHRoaXMuaGVpZ2h0LAogICAgICAgIHRoaXMuYmJfbWF4IC8gMzAsCiAgICAgICAgdGhpcy5zY2VuZS5jaGlsZHJlbi5zbGljZSgwLCAxKSwKICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnMKICAgICAgICAobCkgPT4gewogICAgICAgIH0KICAgICAgKTsKICAgICAgZS5pbml0KCksIGUub25Qb2ludGVyTW92ZSh0KTsKICAgICAgY29uc3QgaSA9IGUuZ2V0SW50ZXJzZWN0ZWRPYmpzKHQpOwogICAgICBpZiAoaS5sZW5ndGggPT0gMCkKICAgICAgICByZXR1cm47CiAgICAgIGxldCBuID0gbnVsbDsKICAgICAgZm9yICh2YXIgcyBpbiBpKQogICAgICAgIGlmIChpW3NdLm9iamVjdCBpbnN0YW5jZW9mIHJlKSB7CiAgICAgICAgICBuID0gaVtzXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgaWYgKG4gPT0gbnVsbCkKICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IHIgPSBuLnBvaW50LCBvID0gewogICAgICAgIHBhdGg6IG4ub2JqZWN0LnBhcmVudC5wYXJlbnQubmFtZS5yZXBsYWNlQWxsKCJ8IiwgIi8iKSwKICAgICAgICBuYW1lOiBuLm9iamVjdC5uYW1lLAogICAgICAgIGJvdW5kaW5nQm94OiB0aGlzLnNoYXBlcy5mb3JtYXQgPT0gIkdEUyIgPyBuZXcgd2UoCiAgICAgICAgICByLmNsb25lKCkuc3ViU2NhbGFyKDEwKSwKICAgICAgICAgIHIuY2xvbmUoKS5hZGRTY2FsYXIoMTApCiAgICAgICAgKSA6IG4ub2JqZWN0Lmdlb21ldHJ5LmJvdW5kaW5nQm94LAogICAgICAgIGJvdW5kaW5nU3BoZXJlOiB0aGlzLnNoYXBlcy5mb3JtYXQgPT0gIkdEUyIgPyBuZXcgUmUociwgMSkgOiBuLm9iamVjdC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICBvYmplY3RHcm91cDogbi5vYmplY3QucGFyZW50CiAgICAgIH07CiAgICAgIG8gIT0gbnVsbCAmJiB0aGlzLmhhbmRsZVBpY2soCiAgICAgICAgby5wYXRoLAogICAgICAgIG8ubmFtZSwKICAgICAgICBEZS5nZXQodCwgIm1ldGEiKSwKICAgICAgICBEZS5nZXQodCwgInNoaWZ0IiksCiAgICAgICAgRGUuZ2V0KHQsICJhbHQiKSwKICAgICAgICBuLnBvaW50LAogICAgICAgIG51bGwsCiAgICAgICAgITEKICAgICAgKSwgZS5kaXNwb3NlKCk7CiAgICB9KTsKICAgIC8vCiAgICAvLyBIYW5kbGUgQ0FEIFRvb2xzCiAgICAvLwogICAgayh0aGlzLCAiY2xlYXJTZWxlY3Rpb24iLCAoKSA9PiB7CiAgICAgIHRoaXMubmVzdGVkR3JvdXAuY2xlYXJTZWxlY3Rpb24oKSwgdGhpcy5jYWRUb29scy5oYW5kbGVSZXNldFNlbGVjdGlvbigpOwogICAgfSk7CiAgICBrKHRoaXMsICJfcmVsZWFzZUxhc3RTZWxlY3RlZCIsICgpID0+IHsKICAgICAgaWYgKHRoaXMubGFzdE9iamVjdCAhPSBudWxsKSB7CiAgICAgICAgbGV0IHQgPSB0aGlzLmxhc3RPYmplY3Qub2JqcygpOwogICAgICAgIGZvciAobGV0IGUgb2YgdCkKICAgICAgICAgIGUudW5oaWdobGlnaHQoITApOwogICAgICB9CiAgICB9KTsKICAgIGsodGhpcywgIl9yZW1vdmVMYXN0U2VsZWN0ZWQiLCAoKSA9PiB7CiAgICAgIGlmICh0aGlzLmxhc3RTZWxlY3Rpb24gIT0gbnVsbCkgewogICAgICAgIGxldCB0ID0gdGhpcy5sYXN0U2VsZWN0aW9uLm9ianMoKTsKICAgICAgICBmb3IgKGxldCBlIG9mIHQpCiAgICAgICAgICBlLnVuaGlnaGxpZ2h0KCExKSwgdGhpcy50cmVldmlldy50b2dnbGVMYWJlbENvbG9yKAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICBlLm5hbWUucmVwbGFjZUFsbCh0aGlzLm5lc3RlZEdyb3VwLmRlbGltLCAiLyIpCiAgICAgICAgICApOwogICAgICAgIHRoaXMubGFzdFNlbGVjdGlvbiA9IG51bGwsIHRoaXMubGFzdE9iamVjdCA9IG51bGw7CiAgICAgIH0KICAgICAgdGhpcy5jYWRUb29scy5oYW5kbGVSZW1vdmVMYXN0U2VsZWN0aW9uKCEwKTsKICAgIH0pOwogICAgayh0aGlzLCAiaGFuZGxlUmF5Y2FzdCIsICgpID0+IHsKICAgICAgY29uc3QgdCA9IHRoaXMucmF5Y2FzdGVyLmdldFZhbGlkSW50ZXJzZWN0ZWRPYmpzKCk7CiAgICAgIGlmICh0Lmxlbmd0aCA+IDApCiAgICAgICAgZm9yICh2YXIgZSBvZiB0KSB7CiAgICAgICAgICBjb25zdCBzID0gZS5vYmplY3QucGFyZW50OwogICAgICAgICAgdmFyIGkgPSBzID8gcy5uYW1lIDogbnVsbCwgbiA9IHRoaXMubGFzdE9iamVjdCA/IHRoaXMubGFzdE9iamVjdC5vYmoubmFtZSA6IG51bGw7CiAgICAgICAgICBpZiAoaSAhPSBudWxsICYmIGkgIT09IG4pIHsKICAgICAgICAgICAgdGhpcy5fcmVsZWFzZUxhc3RTZWxlY3RlZCgpOwogICAgICAgICAgICBjb25zdCByID0gdGhpcy5yYXljYXN0ZXIuZmlsdGVycy50b3BvRmlsdGVyLmluY2x1ZGVzKAogICAgICAgICAgICAgIGxhLnNvbGlkCiAgICAgICAgICAgICksIG8gPSBuZXcgTEUocywgcik7CiAgICAgICAgICAgIGZvciAobGV0IGwgb2Ygby5vYmpzKCkpCiAgICAgICAgICAgICAgbC5oaWdobGlnaHQoITApOwogICAgICAgICAgICB0aGlzLmxhc3RPYmplY3QgPSBvOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBlbHNlCiAgICAgICAgdGhpcy5sYXN0T2JqZWN0ICE9IG51bGwgJiYgKHRoaXMuX3JlbGVhc2VMYXN0U2VsZWN0ZWQoKSwgdGhpcy5sYXN0T2JqZWN0ID0gbnVsbCk7CiAgICB9KTsKICAgIGsodGhpcywgImhhbmRsZVJheWNhc3RFdmVudCIsICh0KSA9PiB7CiAgICAgIHZhciBlOwogICAgICBpZiAodC5rZXkpCiAgICAgICAgc3dpdGNoICh0LmtleSkgewogICAgICAgICAgY2FzZSAiRXNjYXBlIjoKICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbigpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIkJhY2tzcGFjZSI6CiAgICAgICAgICAgIHRoaXMuX3JlbW92ZUxhc3RTZWxlY3RlZCgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGVsc2UKICAgICAgICBzd2l0Y2ggKHQubW91c2UpIHsKICAgICAgICAgIGNhc2UgImxlZnQiOgogICAgICAgICAgICBpZiAodGhpcy5sYXN0T2JqZWN0ICE9IG51bGwpIHsKICAgICAgICAgICAgICBjb25zdCBpID0gdGhpcy5sYXN0T2JqZWN0Lm9ianMoKTsKICAgICAgICAgICAgICBmb3IgKGxldCBuIG9mIGkpCiAgICAgICAgICAgICAgICBuLnRvZ2dsZVNlbGVjdGlvbigpOwogICAgICAgICAgICAgIHRoaXMuY2FkVG9vbHMuaGFuZGxlU2VsZWN0ZWRPYmooCiAgICAgICAgICAgICAgICB0aGlzLmxhc3RPYmplY3QsCiAgICAgICAgICAgICAgICAoKGUgPSB0aGlzLmxhc3RTZWxlY3Rpb24pID09IG51bGwgPyB2b2lkIDAgOiBlLm9iai5uYW1lKSAhPSB0aGlzLmxhc3RPYmplY3Qub2JqLm5hbWUsCiAgICAgICAgICAgICAgICB0LnNoaWZ0CiAgICAgICAgICAgICAgKSwgdGhpcy5sYXN0U2VsZWN0aW9uID0gdGhpcy5sYXN0T2JqZWN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAicmlnaHQiOgogICAgICAgICAgICB0aGlzLl9yZW1vdmVMYXN0U2VsZWN0ZWQoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfSk7CiAgICAvKioKICAgICAqIEhhbmRsZSBhIGJhY2tlbmQgcmVzcG9uc2Ugc2VudCBieSB0aGUgYmFja2VuZAogICAgICogVGhlIHJlc3BvbnNlIGlzIGEgSlNPTiBvYmplY3Qgc2VudCBieSB0aGUgUHl0aG9uIGJhY2tlbmQgdGhyb3VnaCBWU0NvZGUKICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZQogICAgICovCiAgICBrKHRoaXMsICJoYW5kbGVCYWNrZW5kUmVzcG9uc2UiLCAodCkgPT4gewogICAgICB0LnN1YnR5cGUgPT09ICJ0b29sX3Jlc3BvbnNlIiAmJiB0aGlzLmNhZFRvb2xzLmhhbmRsZVJlc3BvbnNlKHQpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cvaGlkZSBheGVzIGhlbHBlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIHNob3cgdGhlIGF4ZXMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbm90aWZ5IC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldEF4ZXMiLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIHRoaXMuYXhlcyA9IHQsIHRoaXMuYXhlc0hlbHBlci5zZXRWaXNpYmxlKHQpLCB0aGlzLmRpc3BsYXkuc2V0QXhlc0NoZWNrKHQpLCB0aGlzLmNoZWNrQ2hhbmdlcyh7IGF4ZXM6IHQgfSwgZSksIHRoaXMudXBkYXRlKHRoaXMudXBkYXRlTWFya2VyKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93L2hpZGUgZ3JpZHMKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtzdHJpbmd9IGFjdGlvbiAtICBvbmUgb2YgImdyaWQiIChhbGwgZ3JpZHMpLCAiZ3JpZC14eSIsImdyaWQteHoiLCAiZ3JpZC15eiIKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAgICovCiAgICBrKHRoaXMsICJzZXRHcmlkIiwgKHQsIGUsIGkgPSAhMCkgPT4gewogICAgICB0aGlzLmdyaWRIZWxwZXIuc2V0R3JpZCh0LCBlKSwgdGhpcy5jaGVja0NoYW5nZXMoeyBncmlkOiB0aGlzLmdyaWRIZWxwZXIuZ3JpZCB9LCBpKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpOwogICAgfSk7CiAgICAvKioKICAgICAqIFRvZ2dsZSBncmlkIHZpc2liaWxpdHkKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFuW119IGdyaWRzIC0gMyBkaW0gZ3JpZCB2aXNpYmlsaXR5ICh4eSwgeHosIHl6KQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldEdyaWRzIiwgKHQsIGUgPSAhMCkgPT4gewogICAgICB0aGlzLmdyaWRIZWxwZXIuc2V0R3JpZHMoLi4udCksIHRoaXMuZ3JpZCA9IHRoaXMuZ3JpZEhlbHBlci5ncmlkLCB0aGlzLmNoZWNrQ2hhbmdlcyh7IGdyaWQ6IHRoaXMuZ3JpZEhlbHBlci5ncmlkIH0sIGUpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlcik7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IGdyaWQgY2VudGVyCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbltdfSBjZW50ZXIgLSB0cnVlIGZvciBjZW50ZXJpbmcgZ3JpZCBhdCAoMCwwLDApCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgICAqLwogICAgayh0aGlzLCAic2V0R3JpZENlbnRlciIsICh0LCBlID0gITApID0+IHsKICAgICAgdGhpcy5ncmlkSGVscGVyLmNlbnRlckdyaWQgPSB0LCB0aGlzLmdyaWRIZWxwZXIuc2V0Q2VudGVyKHRoaXMuYXhlczAsIHRoaXMudXAgPT0gIloiKSwgdGhpcy5jaGVja0NoYW5nZXMoeyBjZW50ZXJfZ3JpZDogdGhpcy5ncmlkSGVscGVyLmNlbnRlckdyaWQgfSwgZSksIHRoaXMudXBkYXRlKHRoaXMudXBkYXRlTWFya2VyKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXQgd2hldGhlciBncmlkcyBhbmQgYXhlcyBjZW50ZXIgYXQgdGhlIG9yaWdpbiBvciB0aGUgb2JqZWN0J3MgYm91bmRhcnkgYm94IGNlbnRlcgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIGdyaWRzIGFuZCBheGVzIGNlbnRlciBhdCB0aGUgb3JpZ2luICgwLDAsMCkKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAgICovCiAgICBrKHRoaXMsICJzZXRBeGVzMCIsICh0LCBlID0gITApID0+IHsKICAgICAgdGhpcy5heGVzMCA9IHQsIHRoaXMuZ3JpZEhlbHBlci5zZXRDZW50ZXIodCwgdGhpcy51cCA9PSAiWiIpLCB0aGlzLmRpc3BsYXkuc2V0QXhlczBDaGVjayh0KSwgdGhpcy5heGVzSGVscGVyLnNldENlbnRlcih0KSwgdGhpcy5jaGVja0NoYW5nZXMoeyBheGVzMDogdCB9LCBlKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNldCB0aGUgaW50ZW5zaXR5IG9mIGFtYmllbnQgbGlnaHQKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbCAtIHRoZSBuZXcgYW1iaWVudCBsaWdodCBpbnRlbnNpdHkKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VpPWZhbHNlXSAtIGlmIHRydWUsIHNldCB0aGUgVUkgc2xpZGVyIHZhbHVlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgICAqLwogICAgayh0aGlzLCAic2V0QW1iaWVudExpZ2h0IiwgKHQsIGUgPSAhMSwgaSA9ICEwKSA9PiB7CiAgICAgIHRoaXMuYW1iaWVudEludGVuc2l0eSA9IHQsIHRoaXMuYW1iaWVudExpZ2h0LmludGVuc2l0eSA9IGtsKHQpLCB0aGlzLmNoZWNrQ2hhbmdlcyh7IGFtYmllbnRfaW50ZW5zaXR5OiB0IH0sIGkpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlciwgaSksIGUgJiYgdGhpcy5kaXNwbGF5LnNldEFtYmllbnRMaWdodCh0KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXQgdGhlIGludGVuc2l0eSBvZiBkaXJlY3Rpb25hbCBsaWdodAogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gdGhlIG5ldyBkaXJlY3QgbGlnaHQgaW50ZW5zaXR5CiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1aT1mYWxzZV0gLSBpZiB0cnVlLCBzZXQgdGhlIFVJIHNsaWRlciB2YWx1ZQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldERpcmVjdExpZ2h0IiwgKHQsIGUgPSAhMSwgaSA9ICEwKSA9PiB7CiAgICAgIHRoaXMuZGlyZWN0SW50ZW5zaXR5ID0gdCwgdGhpcy5kaXJlY3RMaWdodC5pbnRlbnNpdHkgPSBrbCh0KSwgdGhpcy5jaGVja0NoYW5nZXMoeyBkaXJlY3RfaW50ZW5zaXR5OiB0IH0sIGkpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlciwgaSksIGUgJiYgdGhpcy5kaXNwbGF5LnNldERpcmVjdExpZ2h0KHQpOwogICAgfSk7CiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgbWV0YWxuZXNzIHZhbHVlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBjdXJyZW50IG1ldGFsbmVzcyB2YWx1ZS4KICAgICAqLwogICAgayh0aGlzLCAiZ2V0TWV0YWxuZXNzIiwgKCkgPT4gdGhpcy5tZXRhbG5lc3MpOwogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBtZXRhbG5lc3MgdmFsdWUgZm9yIHRoZSB2aWV3ZXIgYW5kIHVwZGF0ZXMgcmVsYXRlZCBwcm9wZXJ0aWVzLgogICAgICoKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBtZXRhbG5lc3MgdmFsdWUgdG8gc2V0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbdWk9ZmFsc2VdIC0gV2hldGhlciB0byB1cGRhdGUgdGhlIFVJIHdpdGggdGhlIG5ldyBtZXRhbG5lc3MgdmFsdWUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSBXaGV0aGVyIHRvIG5vdGlmeSBhYm91dCB0aGUgY2hhbmdlcy4KICAgICAqLwogICAgayh0aGlzLCAic2V0TWV0YWxuZXNzIiwgKHQsIGUgPSAhMSwgaSA9ICEwKSA9PiB7CiAgICAgIHRoaXMubWV0YWxuZXNzID0gdCwgdGhpcy5uZXN0ZWRHcm91cC5zZXRNZXRhbG5lc3ModCksIHRoaXMuY2hlY2tDaGFuZ2VzKHsgbWV0YWxuZXNzOiB0IH0sIGkpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlciksIGUgJiYgdGhpcy5kaXNwbGF5LnNldE1ldGFsbmVzcyh0KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgdGhlIHJvdWdobmVzcyB2YWx1ZS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgY3VycmVudCByb3VnaG5lc3MgdmFsdWUuCiAgICAgKi8KICAgIGsodGhpcywgImdldFJvdWdobmVzcyIsICgpID0+IHRoaXMucm91Z2huZXNzKTsKICAgIC8qKgogICAgICogU2V0cyB0aGUgcm91Z2huZXNzIHZhbHVlIGZvciB0aGUgdmlld2VyIGFuZCB1cGRhdGVzIHJlbGF0ZWQgY29tcG9uZW50cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgcm91Z2huZXNzIHZhbHVlIHRvIHNldC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VpPWZhbHNlXSAtIFdoZXRoZXIgdG8gdXBkYXRlIHRoZSBVSSBkaXJlY3RseS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIFdoZXRoZXIgdG8gbm90aWZ5IGFib3V0IHRoZSBjaGFuZ2VzLgogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KICAgIGsodGhpcywgInNldFJvdWdobmVzcyIsICh0LCBlID0gITEsIGkgPSAhMCkgPT4gewogICAgICB0aGlzLnJvdWdobmVzcyA9IHQsIHRoaXMubmVzdGVkR3JvdXAuc2V0Um91Z2huZXNzKHQpLCB0aGlzLmNoZWNrQ2hhbmdlcyh7IHJvdWdobmVzczogdCB9LCBpKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpLCBlICYmIHRoaXMuZGlzcGxheS5zZXRSb3VnaG5lc3ModCk7CiAgICB9KTsKICAgIC8qKgogICAgICogUmVzZXRzIHRoZSBtYXRlcmlhbCBzZXR0aW5ncyBvZiB0aGUgdmlld2VyIHRvIHRoZWlyIGRlZmF1bHQgdmFsdWVzLgogICAgICogVXBkYXRlcyB0aGUgbWV0YWxuZXNzLCByb3VnaG5lc3MsIGFtYmllbnQgbGlnaHQgaW50ZW5zaXR5LCBhbmQgZGlyZWN0IGxpZ2h0IGludGVuc2l0eQogICAgICogYmFzZWQgb24gdGhlIGN1cnJlbnQgbWF0ZXJpYWwgc2V0dGluZ3MuCiAgICAgKgogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KICAgIGsodGhpcywgInJlc2V0TWF0ZXJpYWwiLCAoKSA9PiB7CiAgICAgIHRoaXMuc2V0TWV0YWxuZXNzKHRoaXMubWF0ZXJpYWxTZXR0aW5ncy5tZXRhbG5lc3MsICEwLCAhMCksIHRoaXMuc2V0Um91Z2huZXNzKHRoaXMubWF0ZXJpYWxTZXR0aW5ncy5yb3VnaG5lc3MsICEwLCAhMCksIHRoaXMuc2V0QW1iaWVudExpZ2h0KHRoaXMubWF0ZXJpYWxTZXR0aW5ncy5hbWJpZW50SW50ZW5zaXR5LCAhMCwgITApLCB0aGlzLnNldERpcmVjdExpZ2h0KHRoaXMubWF0ZXJpYWxTZXR0aW5ncy5kaXJlY3RJbnRlbnNpdHksICEwLCAhMCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IENBRCBvYmplY3RzIHRyYW5zcGFyZW5jeQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIHNob3cgdGhlIENBRCBvYmplY3QgaW4gdHJhbnNwYXJlbnQgbW9kZQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldFRyYW5zcGFyZW50IiwgKHQsIGUgPSAhMCkgPT4gewogICAgICB0aGlzLnRyYW5zcGFyZW50ID0gdCwgdGhpcy5uZXN0ZWRHcm91cC5zZXRUcmFuc3BhcmVudCh0KSwgdGhpcy5kaXNwbGF5LnNldFRyYW5zcGFyZW50Q2hlY2sodCksIHRoaXMuY2hlY2tDaGFuZ2VzKHsgdHJhbnNwYXJlbnQ6IHQgfSwgZSksIHRoaXMudXBkYXRlKHRoaXMudXBkYXRlTWFya2VyKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93IGVkZ2VzIGluIGJsYWNrIG9yIHRoZSBkZWZhdWx0IGVkZ2UgY29sb3IKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBzaG93IGVkZ2VzIGluIGJsYWNrCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgICAqLwogICAgayh0aGlzLCAic2V0QmxhY2tFZGdlcyIsICh0LCBlID0gITApID0+IHsKICAgICAgdGhpcy5ibGFja0VkZ2VzID0gdCwgdGhpcy5uZXN0ZWRHcm91cC5zZXRCbGFja0VkZ2VzKHQpLCB0aGlzLmRpc3BsYXkuc2V0QmxhY2tFZGdlc0NoZWNrKHQpLCB0aGlzLmNoZWNrQ2hhbmdlcyh7IGJsYWNrX2VkZ2VzOiB0IH0sIGUpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlcik7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IHRoZSBkZWZhdWx0IGVkZ2UgY29sb3IKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJ9IGVkZ2UgY29sb3IgKDB4cnJnZ2JiKQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldEVkZ2VDb2xvciIsICh0LCBlID0gITApID0+IHsKICAgICAgdGhpcy5lZGdlQ29sb3IgPSB0LCB0aGlzLm5lc3RlZEdyb3VwLnNldEVkZ2VDb2xvcih0KSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIsIGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNldCB0aGUgZGVmYXVsdCBvcGFjaXR5CiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBvcGFjaXR5IChiZXR3ZWVuIDAuMCBhbmQgMS4wKQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldE9wYWNpdHkiLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIHRoaXMuZGVmYXVsdE9wYWNpdHkgPSB0LCB0aGlzLm5lc3RlZEdyb3VwLnNldE9wYWNpdHkodCksIHRoaXMudXBkYXRlKHRoaXMudXBkYXRlTWFya2VyLCBlKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTaG93L2hpZGUgdGhlIENBRCB0b29scwogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAgICovCiAgICBrKHRoaXMsICJzaG93VG9vbHMiLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIHRoaXMudG9vbHMgPSB0LCB0aGlzLmRpc3BsYXkuc2hvd1Rvb2xzKHQpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlciwgZSk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IHN0YXRlcyBvZiBhIHRyZWV2aWV3IGxlYWZzCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7ZGljdH0gLSBzdGF0ZXMKICAgICAqLwogICAgayh0aGlzLCAic2V0U3RhdGVzIiwgKHQpID0+IHsKICAgICAgdGhpcy50cmVldmlldy5zZXRTdGF0ZXModCk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IHpvb20gc3BlZWQuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgLSB0aGUgbmV3IHpvb20gc3BlZWQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbm90aWZ5IC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldFpvb21TcGVlZCIsICh0LCBlID0gITApID0+IHsKICAgICAgdGhpcy56b29tU3BlZWQgPSB0LCB0aGlzLmNvbnRyb2xzLnNldFpvb21TcGVlZCh0KSwgdGhpcy5jaGVja0NoYW5nZXMoeyBncmlkOiB0aGlzLmdyaWRIZWxwZXIuZ3JpZCB9LCBlKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXQgcGFuIHNwZWVkLgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gdGhlIG5ldyBwYW4gc3BlZWQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbm90aWZ5IC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldFBhblNwZWVkIiwgKHQsIGUgPSAhMCkgPT4gewogICAgICB0aGlzLnBhblNwZWVkID0gdCwgdGhpcy5jb250cm9scy5zZXRQYW5TcGVlZCh0KSwgdGhpcy5jaGVja0NoYW5nZXMoeyBncmlkOiB0aGlzLmdyaWRIZWxwZXIuZ3JpZCB9LCBlKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBTZXQgcm90YXRpb24gc3BlZWQuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgLSB0aGUgbmV3IHJvdGF0aW9uIHNwZWVkLgogICAgICogQHBhcmFtIHtib29sZWFufSBub3RpZnkgLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgICAqLwogICAgayh0aGlzLCAic2V0Um90YXRlU3BlZWQiLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIHRoaXMucm90YXRlU3BlZWQgPSB0LCB0aGlzLmNvbnRyb2xzLnNldFJvdGF0ZVNwZWVkKHQpLCB0aGlzLmNoZWNrQ2hhbmdlcyh7IGdyaWQ6IHRoaXMuZ3JpZEhlbHBlci5ncmlkIH0sIGUpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNldCB0aGUgY2xpcHBpbmcgbW9kZSB0byBpbnRlcnNlY3Rpb24gbW9kZQogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIHVzZSBpbnRlcnNlY3Rpb24gbW9kZQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBJbnRlcnNlY3Rpb24iLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIGlmICh0ICE9IG51bGwpIHsKICAgICAgICB0aGlzLmNsaXBJbnRlcnNlY3Rpb24gPSB0LCB0aGlzLm5lc3RlZEdyb3VwLnNldENsaXBJbnRlcnNlY3Rpb24odCksIHRoaXMuZGlzcGxheS5zZXRDbGlwSW50ZXJzZWN0aW9uQ2hlY2sodCk7CiAgICAgICAgZm9yICh2YXIgaSBvZiB0aGlzLm5lc3RlZEdyb3VwLnJvb3RHcm91cC5jaGlsZHJlbikKICAgICAgICAgIGlmIChpLm5hbWUgPT0gIlBsYW5lTWVzaGVzIikKICAgICAgICAgICAgZm9yICh2YXIgbiBvZiBpLmNoaWxkcmVuKQogICAgICAgICAgICAgIHQgPyBuLm1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzID0gdGhpcy5jbGlwcGluZy5yZXZlcnNlQ2xpcFBsYW5lcy5maWx0ZXIoCiAgICAgICAgICAgICAgICAociwgbykgPT4gbyAhPT0gbi5pbmRleAogICAgICAgICAgICAgICkgOiBuLm1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzID0gdGhpcy5jbGlwcGluZy5jbGlwUGxhbmVzLmZpbHRlcigKICAgICAgICAgICAgICAgIChyLCBvKSA9PiBvICE9PSBuLmluZGV4CiAgICAgICAgICAgICAgKTsKICAgICAgICBmb3IgKGkgb2YgdGhpcy5zY2VuZS5jaGlsZHJlbikKICAgICAgICAgIGlmIChpLm5hbWUgPT0gIlBsYW5lSGVscGVycyIpCiAgICAgICAgICAgIGZvciAodmFyIHMgb2YgaS5jaGlsZHJlblswXS5jaGlsZHJlbikKICAgICAgICAgICAgICB0ID8gcy5tYXRlcmlhbC5jbGlwcGluZ1BsYW5lcyA9IHRoaXMuY2xpcHBpbmcucmV2ZXJzZUNsaXBQbGFuZXMuZmlsdGVyKAogICAgICAgICAgICAgICAgKHIsIG8pID0+IG8gIT09IHMuaW5kZXgKICAgICAgICAgICAgICApIDogcy5tYXRlcmlhbC5jbGlwcGluZ1BsYW5lcyA9IHRoaXMuY2xpcHBpbmcuY2xpcFBsYW5lcy5maWx0ZXIoCiAgICAgICAgICAgICAgICAociwgbykgPT4gbyAhPT0gcy5pbmRleAogICAgICAgICAgICAgICk7CiAgICAgICAgdGhpcy5jaGVja0NoYW5nZXMoeyBjbGlwX2ludGVyc2VjdGlvbjogdCB9LCBlKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpOwogICAgICB9CiAgICB9KTsKICAgIC8qKgogICAgICogR2V0IHdoZXRoZXIgdGhlIGNsaXBwaW5nIGNhcHMgY29sb3Igc3RhdHVzCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gY29sb3IgY2FwcyB2YWx1ZSAob2JqZWN0IGNvbG9yICh0cnVlKSBvciBSR0IgKGZhbHNlKSkuCiAgICAgKi8KICAgIGsodGhpcywgImdldE9iamVjdENvbG9yQ2FwcyIsICgpID0+IHRoaXMuY2xpcHBpbmcuZ2V0T2JqZWN0Q29sb3JDYXBzKCkpOwogICAgLyoqCiAgICAgKiBUb2dnbGUgdGhlIGNsaXBwaW5nIGNhcHMgY29sb3IgYmV0d2VlbiBvYmplY3QgY29sb3IgYW5kIFJHQgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIHVzZSBpbnRlcnNlY3Rpb24gbW9kZQogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBPYmplY3RDb2xvckNhcHMiLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIHQgIT0gbnVsbCAmJiAodGhpcy5jbGlwcGluZy5zZXRPYmplY3RDb2xvckNhcHModCksIHRoaXMuZGlzcGxheS5zZXRDbGlwT2JqZWN0Q29sb3JzQ2hlY2sodCksIHRoaXMuY2hlY2tDaGFuZ2VzKHsgY2xpcF9vYmplY3RfY29sb3JzOiB0IH0sIGUpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlcikpOwogICAgfSk7CiAgICAvKioKICAgICAqIFNob3cvaGlkZSBjbGlwIHBsYW5lIGhlbHBlcnMKICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gd2hldGhlciB0byBzaG93IGNsaXAgcGxhbmUgaGVscGVycwogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBQbGFuZUhlbHBlcnMiLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIHQgIT0gbnVsbCAmJiAodGhpcy5jbGlwUGxhbmVIZWxwZXJzID0gdCwgdGhpcy5jbGlwcGluZy5wbGFuZUhlbHBlcnMudmlzaWJsZSA9IHQsIHRoaXMuZGlzcGxheS5zZXRDbGlwUGxhbmVIZWxwZXJzQ2hlY2sodCksIHRoaXMuY2hlY2tDaGFuZ2VzKHsgY2xpcF9wbGFuZXM6IHQgfSwgZSksIHRoaXMudXBkYXRlKHRoaXMudXBkYXRlTWFya2VyKSk7CiAgICB9KTsKICAgIC8qKgogICAgICogU2V0IHRoZSBub3JtYWwgYXQgaW5kZXggdG8gdGhlIGN1cnJlbnQgdmlld2luZyBkaXJlY3Rpb24KICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gaW5kZXggb2YgdGhlIG5vcm1hbDogMCwgMSAsMgogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBOb3JtYWxGcm9tUG9zaXRpb24iLCAodCwgZSA9ICEwKSA9PiB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLmNhbWVyYS5nZXRQb3NpdGlvbigpLmNsb25lKCkuc3ViKHRoaXMuY29udHJvbHMuZ2V0VGFyZ2V0KCkpLm5vcm1hbGl6ZSgpLm5lZ2F0ZSgpLnRvQXJyYXkoKTsKICAgICAgdGhpcy5zZXRDbGlwTm9ybWFsKHQsIG4sIG51bGwsIGUpOwogICAgICB2YXIgcyA9IHt9OwogICAgICBzW2BjbGlwX25vcm1hbF8ke3R9YF0gPSBuLCB0aGlzLmNoZWNrQ2hhbmdlcyhzLCBlKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBHZXQgY2xpcHBpbmcgc2xpZGVyIHZhbHVlLgogICAgICogQGZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBpbmRleCBvZiB0aGUgbm9ybWFsOiAwLCAxICwyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gY2xpcCBwbGFuZSB2aXNpYmlsaXR5IHZhbHVlLgogICAgICoqLwogICAgayh0aGlzLCAiZ2V0Q2xpcFNsaWRlciIsICh0KSA9PiB0aGlzLmRpc3BsYXkuY2xpcFNsaWRlcnNbdF0uZ2V0VmFsdWUoKSk7CiAgICAvKioKICAgICAqIFNldCBjbGlwcGluZyBzbGlkZXIgdmFsdWUuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIGluZGV4IG9mIHRoZSBub3JtYWw6IDAsIDEgLDIKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIHZhbHVlIGZvciB0aGUgY2xpcHBpbmcgc2xpZGUuIHdpbGwgYmUgdHJpbW1lZCB0byBzbGlkZSBtaW4vbWF4IGxpbWl0cwogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldENsaXBTbGlkZXIiLCAodCwgZSwgaSA9ICEwKSA9PiB7CiAgICAgIGUgPT0gLTEgfHwgZSA9PSBudWxsIHx8IHRoaXMuZGlzcGxheS5jbGlwU2xpZGVyc1t0XS5zZXRWYWx1ZShlLCBpKTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBHZXQgcmVzZXQgbG9jYXRpb24gdmFsdWUuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IC0gdGFyZ2V0LCBwb3NpdGlvbiwgcXVhdGVybmlvbiwgem9vbSBhcyBvYmplY3QuCiAgICAgKi8KICAgIGsodGhpcywgImdldFJlc2V0TG9jYXRpb24iLCAoKSA9PiB7CiAgICAgIGNvbnN0IHQgPSB0aGlzLmNvbnRyb2xzLmdldFJlc2V0TG9jYXRpb24oKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB0YXJnZXQwOiB0LnRhcmdldDAudG9BcnJheSgpLAogICAgICAgIHBvc2l0aW9uMDogdC5wb3NpdGlvbjAudG9BcnJheSgpLAogICAgICAgIHF1YXRlcm5pb24wOiB0LnF1YXRlcm5pb24wLnRvQXJyYXkoKSwKICAgICAgICB6b29tMDogdC56b29tMAogICAgICB9OwogICAgfSk7CiAgICAvKioKICAgICAqIFNldCByZXNldCBsb2NhdGlvbiB2YWx1ZS4KICAgICAqIEBmdW5jdGlvbgogICAgICogQHBhcmFtIHtudW1iZXJbXX0gdGFyZ2V0IC0gY2FtZXJhIHRhcmdldCBhcyAzIGRpbSBBcnJheSBbeCx5LHpdLgogICAgICogQHBhcmFtIHtudW1iZXJbXX0gcG9zaXRpb24gLSBjYW1lcmEgcG9zaXRpb24gYXMgMyBkaW0gQXJyYXkgW3gseSx6XS4KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IHF1YXRlcm5pb24gLSBjYW1lcmEgcm90YXRpb24gYXMgNCBkaW0gcXVhdGVybmlvbiBhcnJheSBbeCx5LHosd10uCiAgICAgKiBAcGFyYW0ge251bWJlcn0gem9vbSAtIGNhbWVyYSB6b29tIHZhbHVlLgogICAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICAgKi8KICAgIGsodGhpcywgInNldFJlc2V0TG9jYXRpb24iLCAodCwgZSwgaSwgbiwgcyA9ICEwKSA9PiB7CiAgICAgIHZhciByID0gdGhpcy5nZXRSZXNldExvY2F0aW9uKCk7CiAgICAgIHRoaXMuY29udHJvbHMuc2V0UmVzZXRMb2NhdGlvbigKICAgICAgICBuZXcgRSguLi50KSwKICAgICAgICBuZXcgRSguLi5lKSwKICAgICAgICBuZXcgUXQoLi4uaSksCiAgICAgICAgbgogICAgICApLCBzICYmIHRoaXMubm90aWZ5Q2FsbGJhY2sgJiYgdGhpcy5ub3RpZnlDYWxsYmFjayh7CiAgICAgICAgdGFyZ2V0MDogeyBvbGQ6IHIudGFyZ2V0MCwgbmV3OiB0IH0sCiAgICAgICAgcG9zaXRpb24wOiB7IG9sZDogci5wb3NpdGlvbjAsIG5ldzogZSB9LAogICAgICAgIHF1YXRlcm5pb24wOiB7IG9sZDogci5xdWF0ZXJuaW9uMCwgbmV3OiBpIH0sCiAgICAgICAgem9vbTA6IHsgb2xkOiByLnpvb20wLCBuZXc6IG4gfQogICAgICB9KTsKICAgIH0pOwogICAgLyoqCiAgICAgKiBSZXBsYWNlIENhZFZpZXcgd2l0aCBhbiBpbmxpbmUgcG5nIGltYWdlIG9mIHRoZSBjYW52YXMuCiAgICAgKgogICAgICogTm90ZTogT25seSB0aGUgY2FudmFzIHdpbGwgYmUgc2hvd24sIG5vIHRvb2xzIGFuZCBvcmllbnRhdGlvbiBtYXJrZXIKICAgICAqLwogICAgayh0aGlzLCAicGluQXNQbmciLCAoKSA9PiB7CiAgICAgIHRoaXMuZ2V0SW1hZ2UoInNjcmVlbnNob3QiKS50aGVuKChlKSA9PiB7CiAgICAgICAgdmFyIGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgICBpZiAoaS53aWR0aCA9IHRoaXMuY2FkV2lkdGgsIGkuaGVpZ2h0ID0gdGhpcy5oZWlnaHQsIGkuc3JjID0gZS5kYXRhVXJsLCB0aGlzLnBpbkFzUG5nQ2FsbGJhY2sgPT0gbnVsbCkgewogICAgICAgICAgZm9yICh2YXIgbiBvZiB0aGlzLmRpc3BsYXkuY29udGFpbmVyLmNoaWxkcmVuKQogICAgICAgICAgICB0aGlzLmRpc3BsYXkuY29udGFpbmVyLnJlbW92ZUNoaWxkKG4pOwogICAgICAgICAgdGhpcy5kaXNwbGF5LmNvbnRhaW5lci5hcHBlbmRDaGlsZChpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICAvKioKICAgICAqIEdldCB0aGUgY3VycmVudCBjYW52YXMgYXMgcG5nIGRhdGEuCiAgICAgKiBAZnVuY3Rpb24KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWtzSWQgLSBhbmQgaWQgdG8gaWRlbnRpZnkgdGhlIHNjcmVlbnNob3QKICAgICAqIE5vdGU6IE9ubHkgdGhlIGNhbnZhcyB3aWxsIGJlIHNob3duLCBubyB0b29scyBhbmQgb3JpZW50YXRpb24gbWFya2VyCiAgICAgKi8KICAgIGsodGhpcywgImdldEltYWdlIiwgKHQpID0+IHsKICAgICAgY29uc3QgZSA9IHRoaXMuaGFzQW5pbWF0aW9uTG9vcDsKICAgICAgcmV0dXJuIGUgfHwgdGhpcy50b2dnbGVBbmltYXRpb25Mb29wKCEwKSwgdGhpcy5vcmllbnRhdGlvbk1hcmtlci5zZXRWaXNpYmxlKCExKSwgdGhpcy51cGRhdGUoITApLCBuZXcgUHJvbWlzZSgobiwgcykgPT4gewogICAgICAgIGNvbnN0IHIgPSB0aGlzLmRpc3BsYXkuZ2V0Q2FudmFzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRWaWV3cG9ydCgwLCAwLCB0aGlzLmNhZFdpZHRoLCB0aGlzLmhlaWdodCksIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhLmdldENhbWVyYSgpKSwgci50b0Jsb2IoKG8pID0+IHsKICAgICAgICAgIGxldCBsID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICAgIGwuYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgICAgICAgImxvYWQiLAogICAgICAgICAgICAoKSA9PiB7CiAgICAgICAgICAgICAgbih7IHRhc2s6IHQsIGRhdGFVcmw6IGwucmVzdWx0IH0pLCBlIHx8IHRoaXMudG9nZ2xlQW5pbWF0aW9uTG9vcCghMSksIHRoaXMub3JpZW50YXRpb25NYXJrZXIuc2V0VmlzaWJsZSghMCksIHRoaXMudXBkYXRlKCEwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgeyBvbmNlOiAhMCB9CiAgICAgICAgICApLCBsLnJlYWRBc0RhdGFVUkwobyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLm5vdGlmeUNhbGxiYWNrID0gaSwgdGhpcy5waW5Bc1BuZ0NhbGxiYWNrID0gbiwgdGhpcy51cGRhdGVNYXJrZXIgPSBzLCB0aGlzLmhhc0FuaW1hdGlvbkxvb3AgPSAhMSwgdGhpcy5zZXREaXNwbGF5RGVmYXVsdHMoZSksIHRoaXMuZGlzcGxheSA9IHQsIGUua2V5bWFwICYmIHRoaXMuc2V0S2V5TWFwKGUua2V5bWFwKSwgd2luZG93LlRIUkVFID0gd0UsIHRoaXMubmVzdGVkR3JvdXAgPSBudWxsLCB0aGlzLm1hcHBpbmcgPSBudWxsLCB0aGlzLnRyZWUgPSBudWxsLCB0aGlzLmJib3ggPSBudWxsLCB0aGlzLmJiX21heCA9IDAsIHRoaXMuc2NlbmUgPSBudWxsLCB0aGlzLmNhbWVyYSA9IG51bGwsIHRoaXMuZ3JpZEhlbHBlciA9IG51bGwsIHRoaXMuYXhlc0hlbHBlciA9IG51bGwsIHRoaXMuY29udHJvbHMgPSBudWxsLCB0aGlzLm9yaWVudGF0aW9uTWFya2VyID0gbnVsbCwgdGhpcy50cmVldmlldyA9IG51bGwsIHRoaXMuY2FkVG9vbHMgPSBuZXcgekUodGhpcywgZS5tZWFzdXJlbWVudERlYnVnKSwgdGhpcy5uZXdUcmVlQmVoYXZpb3IgPSBlLm5ld1RyZWVCZWhhdmlvciwgdGhpcy5yZWFkeSA9ICExLCB0aGlzLm1peGVyID0gbnVsbCwgdGhpcy5hbmltYXRpb24gPSBuZXcgYVQoInwiKSwgdGhpcy5jb250aW51ZUFuaW1hdGlvbiA9ICEwLCB0aGlzLmNsaXBOb3JtYWxzID0gWwogICAgICBbLTEsIDAsIDBdLAogICAgICBbMCwgLTEsIDBdLAogICAgICBbMCwgMCwgLTFdCiAgICBdLCB0aGlzLmNhbWVyYV9kaXN0YW5jZSA9IDAsIHRoaXMubW91c2UgPSBuZXcgSigpLCB0aGlzLnJlbmRlcmVyID0gbmV3IENfKHsKICAgICAgYWxwaGE6ICEwLAogICAgICBhbnRpYWxpYXM6ICEwLAogICAgICBzdGVuY2lsOiAhMAogICAgfSksIHRoaXMucmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyh3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyksIHRoaXMucmVuZGVyZXIuc2V0U2l6ZSh0aGlzLmNhZFdpZHRoLCB0aGlzLmhlaWdodCksIHRoaXMucmVuZGVyZXIuc2V0Q2xlYXJDb2xvcigxNjc3NzIxNSwgMCksIHRoaXMucmVuZGVyZXIuYXV0b0NsZWFyID0gITEsIHRoaXMubGFzdE5vdGlmaWNhdGlvbiA9IHt9LCB0aGlzLmxhc3RCYm94ID0gbnVsbCwgdGhpcy5leHBhbmRlZFRyZWUgPSBudWxsLCB0aGlzLmNvbXBhY3RUcmVlID0gbnVsbCwgdGhpcy5leHBhbmRlZE5lc3RlZEdyb3VwID0gbnVsbCwgdGhpcy5jb21wYWN0TmVzdGVkR3JvdXAgPSBudWxsLCB0aGlzLmxhc3RPYmplY3QgPSBudWxsLCB0aGlzLmxhc3RTZWxlY3Rpb24gPSBudWxsLCB0aGlzLmxhc3RQb3NpdGlvbiA9IG51bGwsIHRoaXMuYmJveE5lZWRzVXBkYXRlID0gITEsIHRoaXMua2VlcEhpZ2hsaWdodCA9ICExLCB0aGlzLnNldFBpY2tIYW5kbGVyKCEwKSwgdGhpcy5yZW5kZXJlci5kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICJjb250ZXh0bWVudSIsCiAgICAgIChyKSA9PiByLnN0b3BQcm9wYWdhdGlvbigpCiAgICApLCB0aGlzLmRpc3BsYXkuc2V0dXBVSSh0aGlzKSwgdGhpcy5kaXNwbGF5LmFkZENhZFZpZXcodGhpcy5yZW5kZXJlci5kb21FbGVtZW50KSwgY29uc29sZS5kZWJ1ZygidGhyZWUtY2FkLXZpZXdlcjogV2ViR0wgUmVuZGVyZXIgY3JlYXRlZCIpLCB3aW5kb3cudmlld2VyID0gdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJuIHRocmVlLWNhZC12aWV3ZXIgdmVyc2lvbiBhcyBzZW12ZXIgc3RyaW5nCiAgICogQHJldHVybnMgc2VtdmVyIHZlcnNpb24KICAgKi8KICB2ZXJzaW9uKCkgewogICAgcmV0dXJuIHZnOwogIH0KICAvKioKICAgKiBFbmhhbmNlIHRoZSBnaXZlbiBvcHRpb25zIGZvciB2aWV3ZXIgY3JlYXRpb24gYnkgZGVmYXVsdCB2YWx1ZXMuCiAgICogQHBhcmFtIHtEaXNwbGF5T3B0aW9uc30gb3B0aW9ucyAtIFRoZSBwcm92aWRlZCBvcHRpb25zIG9iamVjdCBmb3IgdGhlIHZpZXdlci4KICAgKi8KICBzZXREaXNwbGF5RGVmYXVsdHModCkgewogICAgdGhpcy50aGVtZSA9ICJsaWdodCIsIHRoaXMuY2FkV2lkdGggPSA4MDAsIHRoaXMudHJlZVdpZHRoID0gMjUwLCB0aGlzLmhlaWdodCA9IDYwMCwgdGhpcy5waW5uaW5nID0gITEsIHRoaXMuZ2xhc3MgPSAhMSwgdGhpcy50b29scyA9ICEwLCB0aGlzLmtleW1hcCA9IHsgc2hpZnQ6ICJzaGlmdEtleSIsIGN0cmw6ICJjdHJsS2V5IiwgbWV0YTogIm1ldGFLZXkiIH0sIHRoaXMubmV3VHJlZUJlaGF2aW9yID0gITAsIHRoaXMubWVhc3VyZVRvb2xzID0gITAsIHRoaXMuc2VsZWN0VG9vbCA9ICEwLCB0aGlzLmV4cGxvZGVUb29sID0gITAsIHRoaXMuenNjYWxlVG9vbCA9ICExLCB0aGlzLm1lYXN1cmVtZW50RGVidWcgPSAhMDsKICAgIGZvciAodmFyIGUgaW4gdCkKICAgICAgdGhpc1tlXSA9PSBudWxsID8gY29uc29sZS53YXJuKGBVbmtub3duIG9wdGlvbiAiJHtlfSIgdG8gY3JlYXRlIGEgdmlld2VyIC0gaWdub3JlZGApIDogdGhpc1tlXSA9IHRbZV07CiAgICB0LnRoZW1lID09PSAiZGFyayIgfHwgdC50aGVtZSA9PSAiYnJvd3NlciIgJiYgd2luZG93Lm1hdGNoTWVkaWEoIihwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykiKS5tYXRjaGVzID8gdGhpcy50aGVtZSA9ICJkYXJrIiA6IHRoaXMudGhlbWUgPSAibGlnaHQiOwogIH0KICAvKioKICAgKiBFbmhhbmNlIHRoZSBnaXZlbiBvcHRpb25zIGZvciByZW5kZXJpbmcgYnkgZGVmYXVsdCB2YWx1ZXMuCiAgICogQHBhcmFtIHtSZW5kZXJPcHRpb25zfSBvcHRpb25zIC0gVGhlIHByb3ZpZGVkIG9wdGlvbnMgb2JqZWN0IGZvciB0aGUgdmlld2VyLgogICAqLwogIHNldFJlbmRlckRlZmF1bHRzKHQpIHsKICAgIHRoaXMuYW1iaWVudEludGVuc2l0eSA9IDAuNSwgdGhpcy5kaXJlY3RJbnRlbnNpdHkgPSAwLjYsIHRoaXMubWV0YWxuZXNzID0gMC43LCB0aGlzLnJvdWdobmVzcyA9IDAuNywgdGhpcy5kZWZhdWx0T3BhY2l0eSA9IDAuNSwgdGhpcy5lZGdlQ29sb3IgPSA3MzY4ODE2LCB0aGlzLm5vcm1hbExlbiA9IDA7CiAgICBmb3IgKHZhciBlIGluIHQpCiAgICAgIHRoaXNbZV0gPT09IHZvaWQgMCA/IGNvbnNvbGUud2FybihgVW5rbm93biBvcHRpb24gIiR7ZX0iIHRvIGNyZWF0ZSBhIHZpZXdlciAtIGlnbm9yZWRgKSA6IHRoaXNbZV0gPSB0W2VdOwogICAgdGhpcy5tYXRlcmlhbFNldHRpbmdzID0gewogICAgICBhbWJpZW50SW50ZW5zaXR5OiB0aGlzLmFtYmllbnRJbnRlbnNpdHksCiAgICAgIGRpcmVjdEludGVuc2l0eTogdGhpcy5kaXJlY3RJbnRlbnNpdHksCiAgICAgIG1ldGFsbmVzczogdGhpcy5tZXRhbG5lc3MsCiAgICAgIHJvdWdobmVzczogdGhpcy5yb3VnaG5lc3MKICAgIH07CiAgfQogIC8qKgogICAqIEVuaGFuY2UgdGhlIGdpdmVuIG9wdGlvbnMgZm9yIHRoZSB2aWV3IGJ5IGRlZmF1bHQgdmFsdWVzLgogICAqIEBwYXJhbSB7Vmlld09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgcHJvdmlkZWQgb3B0aW9ucyBvYmplY3QgZm9yIHRoZSB2aWV3ZXIuCiAgICovCiAgc2V0Vmlld2VyRGVmYXVsdHModCkgewogICAgdGhpcy5heGVzID0gITEsIHRoaXMuYXhlczAgPSAhMSwgdGhpcy5ncmlkID0gWyExLCAhMSwgITFdLCB0aGlzLm9ydGhvID0gITAsIHRoaXMudHJhbnNwYXJlbnQgPSAhMSwgdGhpcy5ibGFja0VkZ2VzID0gITEsIHRoaXMuY29sbGFwc2UgPSAwLCB0aGlzLmNsaXBJbnRlcnNlY3Rpb24gPSAhMSwgdGhpcy5jbGlwUGxhbmVIZWxwZXJzID0gITEsIHRoaXMuY2xpcE9iamVjdENvbG9ycyA9ICExLCB0aGlzLmNsaXBOb3JtYWwwID0gWy0xLCAwLCAwXSwgdGhpcy5jbGlwTm9ybWFsMSA9IFswLCAtMSwgMF0sIHRoaXMuY2xpcE5vcm1hbDIgPSBbMCwgMCwgLTFdLCB0aGlzLmNsaXBTbGlkZXIwID0gLTEsIHRoaXMuY2xpcFNsaWRlcjEgPSAtMSwgdGhpcy5jbGlwU2xpZGVyMiA9IC0xLCB0aGlzLmNvbnRyb2wgPSAib3JiaXQiLCB0aGlzLnVwID0gIloiLCB0aGlzLnRpY2tzID0gMTAsIHRoaXMuZ3JpZEZvbnRTaXplID0gMTAsIHRoaXMuY2VudGVyR3JpZCA9ICExLCB0aGlzLnBvc2l0aW9uID0gbnVsbCwgdGhpcy5xdWF0ZXJuaW9uID0gbnVsbCwgdGhpcy50YXJnZXQgPSBudWxsLCB0aGlzLnpvb20gPSAxLCB0aGlzLnBhblNwZWVkID0gMC41LCB0aGlzLnJvdGF0ZVNwZWVkID0gMSwgdGhpcy56b29tU3BlZWQgPSAwLjUsIHRoaXMudGltZWl0ID0gITE7CiAgICBmb3IgKHZhciBlIGluIHQpCiAgICAgIHRoaXNbZV0gPT09IHZvaWQgMCA/IGNvbnNvbGUud2FybihgVW5rbm93biBvcHRpb24gJHtlfSB0byBhZGQgc2hhcGVzIC0gaWdub3JlZGApIDogdGhpc1tlXSA9IHRbZV07CiAgfQogIGR1bXBPcHRpb25zKCkgewogICAgY29uc29sZS5sb2coIkRpc3BsYXk6IiksIGNvbnNvbGUubG9nKCItIGNhZFdpZHRoIiwgdGhpcy5jYWRXaWR0aCksIGNvbnNvbGUubG9nKCItIGNvbnRyb2wiLCB0aGlzLmNvbnRyb2wpLCBjb25zb2xlLmxvZygiLSBoZWlnaHQiLCB0aGlzLmhlaWdodCksIGNvbnNvbGUubG9nKCItIHBpbm5pbmciLCB0aGlzLnBpbm5pbmcpLCBjb25zb2xlLmxvZygiLSB0aGVtZSIsIHRoaXMudGhlbWUpLCBjb25zb2xlLmxvZygiLSB0cmVlSGVpZ2h0IiwgdGhpcy50cmVlSGVpZ2h0KSwgY29uc29sZS5sb2coIi0gdHJlZVdpZHRoIiwgdGhpcy50cmVlV2lkdGgpLCBjb25zb2xlLmxvZygiUmVuZGVyOiIpLCBjb25zb2xlLmxvZygiLSBhbWJpZW50SW50ZW5zaXR5IiwgdGhpcy5hbWJpZW50SW50ZW5zaXR5KSwgY29uc29sZS5sb2coIi0gZGVmYXVsdE9wYWNpdHkiLCB0aGlzLmRlZmF1bHRPcGFjaXR5KSwgY29uc29sZS5sb2coIi0gZGlyZWN0SW50ZW5zaXR5IiwgdGhpcy5kaXJlY3RJbnRlbnNpdHkpLCBjb25zb2xlLmxvZygiLSBlZGdlQ29sb3IiLCB0aGlzLmVkZ2VDb2xvciksIGNvbnNvbGUubG9nKCItIG5vcm1hbExlbiIsIHRoaXMubm9ybWFsTGVuKSwgY29uc29sZS5sb2coIlZpZXc6IiksIGNvbnNvbGUubG9nKCItIGF4ZXMiLCB0aGlzLmF4ZXMpLCBjb25zb2xlLmxvZygiLSBheGVzMCIsIHRoaXMuYXhlczApLCBjb25zb2xlLmxvZygiLSBibGFja0VkZ2VzIiwgdGhpcy5ibGFja0VkZ2VzKSwgY29uc29sZS5sb2coIi0gY2xpcEludGVyc2VjdGlvbiIsIHRoaXMuY2xpcEludGVyc2VjdGlvbiksIGNvbnNvbGUubG9nKCItIGNsaXBQbGFuZUhlbHBlcnMiLCB0aGlzLmNsaXBQbGFuZUhlbHBlcnMpLCBjb25zb2xlLmxvZygiLSBjbGlwT2JqZWN0Q29sb3JzIiwgdGhpcy5jbGlwT2JqZWN0Q29sb3JzKSwgY29uc29sZS5sb2coIi0gY2xpcE5vcm1hbDAiLCB0aGlzLmNsaXBOb3JtYWwwKSwgY29uc29sZS5sb2coIi0gY2xpcE5vcm1hbDEiLCB0aGlzLmNsaXBOb3JtYWwxKSwgY29uc29sZS5sb2coIi0gY2xpcE5vcm1hbDIiLCB0aGlzLmNsaXBOb3JtYWwyKSwgY29uc29sZS5sb2coIi0gY2xpcFNsaWRlcjAiLCB0aGlzLmNsaXBTbGlkZXIwKSwgY29uc29sZS5sb2coIi0gY2xpcFNsaWRlcjEiLCB0aGlzLmNsaXBTbGlkZXIxKSwgY29uc29sZS5sb2coIi0gY2xpcFNsaWRlcjIiLCB0aGlzLmNsaXBTbGlkZXIyKSwgY29uc29sZS5sb2coIi0gZ3JpZCIsIHRoaXMuZ3JpZCksIGNvbnNvbGUubG9nKCItIG9ydGhvIiwgdGhpcy5vcnRobyksIGNvbnNvbGUubG9nKCItIHBhblNwZWVkIiwgdGhpcy5wYW5TcGVlZCksIGNvbnNvbGUubG9nKCItIHBvc2l0aW9uIiwgdGhpcy5wb3NpdGlvbiksIGNvbnNvbGUubG9nKCItIHF1YXRlcm5pb24iLCB0aGlzLnF1YXRlcm5pb24pLCBjb25zb2xlLmxvZygiLSByb3RhdGVTcGVlZCIsIHRoaXMucm90YXRlU3BlZWQpLCBjb25zb2xlLmxvZygiLSB0aWNrcyIsIHRoaXMudGlja3MpLCBjb25zb2xlLmxvZygiLSB0aW1laXQiLCB0aGlzLnRpbWVpdCksIGNvbnNvbGUubG9nKCItIHRvb2xzIiwgdGhpcy50b29scyksIGNvbnNvbGUubG9nKCItIGdsYXNzIiwgdGhpcy5nbGFzcyksIGNvbnNvbGUubG9nKCItIHRyYW5zcGFyZW50IiwgdGhpcy50cmFuc3BhcmVudCksIGNvbnNvbGUubG9nKCItIHpvb20iLCB0aGlzLnpvb20pLCBjb25zb2xlLmxvZygiLSB6b29tMCIsIHRoaXMuY29udHJvbHMuZ2V0Wm9vbTAoKSksIGNvbnNvbGUubG9nKCItIHpvb21TcGVlZCIsIHRoaXMuem9vbVNwZWVkKTsKICB9CiAgLy8gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0KICAvLyBMb2FkIFRlc3NlbGF0ZWQgU2hhcGVzCiAgLy8gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0KICAvKioKICAgKiBSZW5kZXIgdGVzc2VsbGF0ZWQgc2hhcGVzIG9mIGEgQ0FEIG9iamVjdC4KICAgKiBAcGFyYW0ge1NoYXBlc30gc2hhcGVzIC0gVGhlIFNoYXBlcyBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSB0ZXNzZWxsYXRlZCBDQUQgb2JqZWN0LgogICAqIEByZXR1cm5zIHtUSFJFRS5Hcm91cH0gQSBuZXN0ZWQgVEhSRUUuR3JvdXAgb2JqZWN0LgogICAqLwogIF9yZW5kZXJUZXNzZWxsYXRlZFNoYXBlcyh0KSB7CiAgICBjb25zdCBlID0gbmV3IFdFKAogICAgICB0LAogICAgICB0aGlzLmNhZFdpZHRoLAogICAgICB0aGlzLmhlaWdodCwKICAgICAgdGhpcy5lZGdlQ29sb3IsCiAgICAgIHRoaXMudHJhbnNwYXJlbnQsCiAgICAgIHRoaXMuZGVmYXVsdE9wYWNpdHksCiAgICAgIHRoaXMubWV0YWxuZXNzLAogICAgICB0aGlzLnJvdWdobmVzcywKICAgICAgdGhpcy5ub3JtYWxMZW4KICAgICk7CiAgICByZXR1cm4gdC5iYiAmJiAodGhpcy5iYm94ID0gbmV3IG9yKAogICAgICBuZXcgRSh0LmJiLnhtaW4sIHQuYmIueW1pbiwgdC5iYi56bWluKSwKICAgICAgbmV3IEUodC5iYi54bWF4LCB0LmJiLnltYXgsIHQuYmIuem1heCkKICAgICkpLCBlLnJlbmRlcigpLCBlOwogIH0KICAvKioKICAgKiBSZXRyaWV2ZSB0aGUgbmF2aWdhdGlvbiB0cmVlIGZyb20gYSBTaGFwZXMgb2JqZWN0LgogICAqIEBwYXJhbSB7U2hhcGVzfSBzaGFwZXMgLSBUaGUgU2hhcGVzIG9iamVjdC4KICAgKiBAcmV0dXJucyB7TmF2VHJlZX0gVGhlIG5hdmlnYXRpb24gdHJlZSBvYmplY3QuCiAgICovCiAgX2dldFRyZWUodCkgewogICAgY29uc3QgZSA9IChuKSA9PiB7CiAgICAgIHZhciBzID0ge307CiAgICAgIGZvciAodmFyIHIgb2YgbikKICAgICAgICByLnBhcnRzICE9IG51bGwgPyBzW3IubmFtZV0gPSBlKHIucGFydHMpIDogc1tyLm5hbWVdID0gci5zdGF0ZTsKICAgICAgcmV0dXJuIHM7CiAgICB9OwogICAgdmFyIGkgPSB7fTsKICAgIHJldHVybiBpW3QubmFtZV0gPSBlKHQucGFydHMpLCBpOwogIH0KICAvKioKICAgKiBEZWNvbXBvc2UgYSBDQUQgb2JqZWN0IGludG8gZmFjZXMsIGVkZ2VzIGFuZCB2ZXJ0aWNlcy4KICAgKiBAcGFyYW0ge1NoYXBlc30gc2hhcGVzIC0gVGhlIFNoYXBlcyBvYmplY3QuCiAgICogQHJldHVybnMge1NoYXBlc30gQSBkZWNvbXBvc2VkIFNoYXBlcyBvYmplY3QuCiAgICovCiAgX2RlY29tcG9zZSh0KSB7CiAgICBjb25zdCBlID0gdC5zaGFwZTsKICAgIHZhciBpOwogICAgaWYgKHQucGFydHMgPSBbXSwgdC50eXBlID09ICJzaGFwZXMiKSB7CiAgICAgIHZhciBuID0gewogICAgICAgIHBhcnRzOiBbXSwKICAgICAgICBsb2M6IFsKICAgICAgICAgIFswLCAwLCAwXSwKICAgICAgICAgIFswLCAwLCAwLCAxXQogICAgICAgIF0sCiAgICAgICAgbmFtZTogImZhY2VzIiwKICAgICAgICBpZDogYCR7dC5pZH0vZmFjZXNgCiAgICAgIH0sIHM7CiAgICAgIGNvbnN0IHkgPSBlLnZlcnRpY2VzLCBnID0gZS5ub3JtYWxzLCBtID0gZS50cmlhbmdsZXNfcGVyX2ZhY2UgPyBlLnRyaWFuZ2xlc19wZXJfZmFjZS5sZW5ndGggOiBlLnRyaWFuZ2xlcy5sZW5ndGg7CiAgICAgIHZhciByID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IG07IGkrKykgewogICAgICAgIGUudHJpYW5nbGVzX3Blcl9mYWNlID8gKHMgPSBlLnRyaWFuZ2xlcy5zdWJhcnJheSgKICAgICAgICAgIHIsCiAgICAgICAgICByICsgMyAqIGUudHJpYW5nbGVzX3Blcl9mYWNlW2ldCiAgICAgICAgKSwgciArPSAzICogZS50cmlhbmdsZXNfcGVyX2ZhY2VbaV0pIDogcyA9IGUudHJpYW5nbGVzW2ldOwogICAgICAgIGZvciAodmFyIG8gPSBuZXcgRmxvYXQzMkFycmF5KHMubGVuZ3RoICogMyksIGwgPSBuZXcgRmxvYXQzMkFycmF5KHMubGVuZ3RoICogMyksIGggPSAwOyBoIDwgcy5sZW5ndGg7IGgrKykgewogICAgICAgICAgdmFyIGMgPSBzW2hdOwogICAgICAgICAgb1szICogaF0gPSB5WzMgKiBjXSwgb1szICogaCArIDFdID0geVszICogYyArIDFdLCBvWzMgKiBoICsgMl0gPSB5WzMgKiBjICsgMl0sIGxbMyAqIGhdID0gZ1szICogY10sIGxbMyAqIGggKyAxXSA9IGdbMyAqIGMgKyAxXSwgbFszICogaCArIDJdID0gZ1szICogYyArIDJdOwogICAgICAgIH0KICAgICAgICB2YXIgdSA9IHsKICAgICAgICAgIGxvYzogWwogICAgICAgICAgICBbMCwgMCwgMF0sCiAgICAgICAgICAgIFswLCAwLCAwLCAxXQogICAgICAgICAgXSwKICAgICAgICAgIG5hbWU6IGBmYWNlc18ke2l9YCwKICAgICAgICAgIGlkOiBgJHt0LmlkfS9mYWNlcy9mYWNlc18ke2l9YCwKICAgICAgICAgIHR5cGU6ICJzaGFwZXMiLAogICAgICAgICAgY29sb3I6IHQuY29sb3IsCiAgICAgICAgICBhbHBoYTogdC5hbHBoYSwKICAgICAgICAgIHJlbmRlcmJhY2s6ICEwLAogICAgICAgICAgc3RhdGU6IFsxLCAzXSwKICAgICAgICAgIGFjY3VyYWN5OiB0LmFjY3VyYWN5LAogICAgICAgICAgYmI6IHt9LAogICAgICAgICAgZ2VvbXR5cGU6IGUuZmFjZV90eXBlc1tpXSwKICAgICAgICAgIHN1YnR5cGU6IHQuc3VidHlwZSwKICAgICAgICAgIGV4cGxvZGVkOiAhMCwKICAgICAgICAgIHNoYXBlOiB7CiAgICAgICAgICAgIHRyaWFuZ2xlczogWy4uLkFycmF5KHMubGVuZ3RoKS5rZXlzKCldLAogICAgICAgICAgICB2ZXJ0aWNlczogbywKICAgICAgICAgICAgbm9ybWFsczogbCwKICAgICAgICAgICAgZWRnZXM6IFtdCiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0LnRleHR1cmUgJiYgKHUudGV4dHVyZSA9IHQudGV4dHVyZSksIG4ucGFydHMucHVzaCh1KTsKICAgICAgfQogICAgICB0LnBhcnRzLnB1c2gobik7CiAgICB9CiAgICBpZiAodC50eXBlID09ICJzaGFwZXMiIHx8IHQudHlwZSA9PSAiZWRnZXMiKSB7CiAgICAgIG4gPSB7CiAgICAgICAgcGFydHM6IFtdLAogICAgICAgIGxvYzogWwogICAgICAgICAgWzAsIDAsIDBdLAogICAgICAgICAgWzAsIDAsIDAsIDFdCiAgICAgICAgXSwKICAgICAgICBuYW1lOiAiZWRnZXMiLAogICAgICAgIGlkOiBgJHt0LmlkfS9lZGdlc2AKICAgICAgfTsKICAgICAgY29uc3QgeSA9IEFycmF5LmlzQXJyYXkodC5jb2xvcikgJiYgdC5jb2xvci5sZW5ndGggPT0gZS5lZGdlcy5sZW5ndGg7CiAgICAgIHZhciBkOwogICAgICBjb25zdCBnID0gZS5zZWdtZW50c19wZXJfZWRnZSA/IGUuc2VnbWVudHNfcGVyX2VkZ2UubGVuZ3RoIDogZS5lZGdlcy5sZW5ndGg7CiAgICAgIHIgPSAwOwogICAgICB2YXIgcDsKICAgICAgZm9yIChpID0gMDsgaSA8IGc7IGkrKykKICAgICAgICBlLnNlZ21lbnRzX3Blcl9lZGdlID8gKHAgPSBlLmVkZ2VzLnN1YmFycmF5KAogICAgICAgICAgciwKICAgICAgICAgIHIgKyA2ICogZS5zZWdtZW50c19wZXJfZWRnZVtpXQogICAgICAgICksIHIgKz0gNiAqIGUuc2VnbWVudHNfcGVyX2VkZ2VbaV0pIDogcCA9IGUuZWRnZXNbaV0sIGQgPSB5ID8gdC5jb2xvcltpXSA6IHQuY29sb3IsIHUgPSB7CiAgICAgICAgICBsb2M6IFsKICAgICAgICAgICAgWzAsIDAsIDBdLAogICAgICAgICAgICBbMCwgMCwgMCwgMV0KICAgICAgICAgIF0sCiAgICAgICAgICBuYW1lOiBgZWRnZXNfJHtpfWAsCiAgICAgICAgICBpZDogYCR7dC5pZH0vZWRnZXMvZWRnZXNfJHtpfWAsCiAgICAgICAgICB0eXBlOiAiZWRnZXMiLAogICAgICAgICAgY29sb3I6IHQudHlwZSA9PSAic2hhcGVzIiA/IHRoaXMuZWRnZUNvbG9yIDogZCwKICAgICAgICAgIHN0YXRlOiBbMywgMV0sCiAgICAgICAgICB3aWR0aDogdC50eXBlID09ICJzaGFwZXMiID8gMSA6IHQud2lkdGgsCiAgICAgICAgICBiYjoge30sCiAgICAgICAgICBnZW9tdHlwZTogZS5lZGdlX3R5cGVzW2ldLAogICAgICAgICAgc2hhcGU6IHsgZWRnZXM6IHAgfQogICAgICAgIH0sIG4ucGFydHMucHVzaCh1KTsKICAgICAgbi5wYXJ0cy5sZW5ndGggPiAwICYmIHQucGFydHMucHVzaChuKTsKICAgIH0KICAgIG4gPSB7CiAgICAgIHBhcnRzOiBbXSwKICAgICAgbG9jOiBbCiAgICAgICAgWzAsIDAsIDBdLAogICAgICAgIFswLCAwLCAwLCAxXQogICAgICBdLAogICAgICBuYW1lOiAidmVydGljZXMiLAogICAgICBpZDogYCR7dC5pZH0vdmVydGljZXNgCiAgICB9OwogICAgdmFyIGYgPSBlLm9ial92ZXJ0aWNlczsKICAgIGZvciAoaSA9IDA7IGkgPCBmLmxlbmd0aCAvIDM7IGkrKykKICAgICAgdSA9IHsKICAgICAgICBsb2M6IFsKICAgICAgICAgIFswLCAwLCAwXSwKICAgICAgICAgIFswLCAwLCAwLCAxXQogICAgICAgIF0sCiAgICAgICAgbmFtZTogYHZlcnRpY2VzXyR7aX1gLAogICAgICAgIGlkOiBgJHt0LmlkfS92ZXJ0aWNlcy92ZXJ0aWNlc18ke2l9YCwKICAgICAgICB0eXBlOiAidmVydGljZXMiLAogICAgICAgIGNvbG9yOiB0LnR5cGUgPT0gInNoYXBlcyIgfHwgdC50eXBlID09ICJlZGdlcyIgPyB0aGlzLmVkZ2VDb2xvciA6IHQuY29sb3IsCiAgICAgICAgc3RhdGU6IFszLCAxXSwKICAgICAgICBzaXplOiB0LnR5cGUgPT0gInNoYXBlcyIgfHwgdC50eXBlID09ICJlZGdlcyIgPyA0IDogdC5zaXplLAogICAgICAgIGJiOiB7fSwKICAgICAgICBzaGFwZTogewogICAgICAgICAgb2JqX3ZlcnRpY2VzOiBbCiAgICAgICAgICAgIGZbMyAqIGldLAogICAgICAgICAgICBmWzMgKiBpICsgMV0sCiAgICAgICAgICAgIGZbMyAqIGkgKyAyXQogICAgICAgICAgXQogICAgICAgIH0KICAgICAgfSwgbi5wYXJ0cy5wdXNoKHUpOwogICAgcmV0dXJuIG4ucGFydHMubGVuZ3RoID4gMCAmJiB0LnBhcnRzLnB1c2gobiksIGRlbGV0ZSB0LnNoYXBlLCBkZWxldGUgdC5jb2xvciwgZGVsZXRlIHQuYWxwaGEsIGRlbGV0ZSB0LmFjY3VyYWN5LCBkZWxldGUgdC5yZW5kZXJCYWNrLCB0OwogIH0KICAvKioKICAgKiBSZW5kZXIgdGhlIHNoYXBlcyBvZiB0aGUgQ0FEIG9iamVjdC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGV4cGxvZGVkIC0gV2hldGhlciB0byByZW5kZXIgdGhlIGNvbXBhY3Qgb3IgZXhwbG9kZWQgdmVyc2lvbgogICAqIEBwYXJhbSB7U2hhcGVzfSBzaGFwZXMgLSBUaGUgU2hhcGVzIG9iamVjdC4KICAgKiBAcmV0dXJucyB7VEhSRUUuR3JvdXB9IEEgbmVzdGVkIFRIUkVFLkdyb3VwIG9iamVjdC4KICAgKi8KICByZW5kZXJUZXNzZWxsYXRlZFNoYXBlcyh0LCBlKSB7CiAgICBjb25zdCBpID0gKGwpID0+IHsKICAgICAgbC50cmlhbmdsZXMgIT0gbnVsbCAmJiAhKGwudHJpYW5nbGVzIGluc3RhbmNlb2YgVWludDMyQXJyYXkpICYmIChsLnRyaWFuZ2xlcyA9IG5ldyBVaW50MzJBcnJheShsLnRyaWFuZ2xlcykpLCBsLmVkZ2VzICE9IG51bGwgJiYgIShsLmVkZ2VzIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KSAmJiAobC5lZGdlcyA9IG5ldyBGbG9hdDMyQXJyYXkoeHMobC5lZGdlcywgMykpKSwgbC52ZXJ0aWNlcyAhPSBudWxsICYmICEobC52ZXJ0aWNlcyBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkgJiYgKGwudmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KGwudmVydGljZXMpKSwgbC5ub3JtYWxzICE9IG51bGwgJiYgIShsLm5vcm1hbHMgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpICYmIChsLm5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KHhzKGwubm9ybWFscywgMikpKSwgbC5vYmpfdmVydGljZXMgIT0gbnVsbCAmJiAhKGwub2JqX3ZlcnRpY2VzIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KSAmJiAobC5vYmpfdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KGwub2JqX3ZlcnRpY2VzKSksIGwuZmFjZV90eXBlcyAhPSBudWxsICYmICEobC5mYWNlX3R5cGVzIGluc3RhbmNlb2YgVWludDMyQXJyYXkpICYmIChsLmZhY2VfdHlwZXMgPSBuZXcgVWludDMyQXJyYXkobC5mYWNlX3R5cGVzKSksIGwuZWRnZV90eXBlcyAhPSBudWxsICYmICEobC5lZGdlX3R5cGVzIGluc3RhbmNlb2YgVWludDMyQXJyYXkpICYmIChsLmVkZ2VfdHlwZXMgPSBuZXcgVWludDMyQXJyYXkobC5lZGdlX3R5cGVzKSksIGwudHJpYW5nbGVzX3Blcl9mYWNlICE9IG51bGwgJiYgIShsLnRyaWFuZ2xlc19wZXJfZmFjZSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSAmJiAobC50cmlhbmdsZXNfcGVyX2ZhY2UgPSBuZXcgVWludDMyQXJyYXkobC50cmlhbmdsZXNfcGVyX2ZhY2UpKSwgbC5zZWdtZW50c19wZXJfZWRnZSAhPSBudWxsICYmICEobC5zZWdtZW50c19wZXJfZWRnZSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSAmJiAobC5zZWdtZW50c19wZXJfZWRnZSA9IG5ldyBVaW50MzJBcnJheShsLnNlZ21lbnRzX3Blcl9lZGdlKSk7CiAgICB9LCBuID0gKGwpID0+IHsKICAgICAgdmFyIGg7CiAgICAgIGlmIChsLnZlcnNpb24gPT0gMiB8fCBsLnZlcnNpb24gPT0gMykgewogICAgICAgIHZhciBjLCB1OwogICAgICAgIGxldCBkID0gW107CiAgICAgICAgZm9yIChjID0gMDsgYyA8IGwucGFydHMubGVuZ3RoOyBjKyspCiAgICAgICAgICBoID0gbC5wYXJ0c1tjXSwgaC5zaGFwZSAhPSBudWxsICYmIGkoaC5zaGFwZSksIGgucGFydHMgIT0gbnVsbCA/ICh1ID0gbihoKSwgZC5wdXNoKHUpKSA6IGQucHVzaCh0aGlzLl9kZWNvbXBvc2UoaCkpOwogICAgICAgIGwucGFydHMgPSBkOwogICAgICB9CiAgICAgIHJldHVybiBsOwogICAgfTsKICAgIHZhciBzOwogICAgdCA/IHMgPSBuKHN0cnVjdHVyZWRDbG9uZShlKSkgOiBzID0gc3RydWN0dXJlZENsb25lKGUpOwogICAgdmFyIHIgPSB0aGlzLl9yZW5kZXJUZXNzZWxsYXRlZFNoYXBlcyhzKSwgbyA9IHRoaXMuX2dldFRyZWUocyk7CiAgICByZXR1cm4gewogICAgICBncm91cDogciwKICAgICAgdHJlZTogbwogICAgfTsKICB9CiAgLy8gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0KICAvLyBBbmltYXRpb24KICAvLyAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLQogIC8qKgogICAqIEFkZCBhbiBhbmltYXRpb24gdHJhY2sgZm9yIGEgVEhSRUUuR3JvdXAKICAgKiBAcGFyYW0ge3N0cmluZ30gc2VsZWN0b3IgLSBwYXRoL2lkIG9mIGdyb3VwIHRvIGJlIGFuaW1hdGVkLgogICAqIEBwYXJhbSB7c3RyaW5nfSBhY3Rpb24gLSBvbmUgb2YgInJ4IiwgInJ5IiwgInJ6IiBmb3Igcm90YXRpb25zIGFyb3VuZCBheGVzLCAicSIgZm9yIHF1YXRlcm5pb25zIG9yICJ0IiwgInR4IiwgInR5IiwgInR6IiBmb3IgdHJhbnNsYXRpb25zLgogICAqIEBwYXJhbSB7bnVtYmVyW119IHRpbWUgLSBhcnJheSBvZiB0aW1lcy4KICAgKiBAcGFyYW0ge251bWJlcltdfSB2YWx1ZXMgLSBhcnJheSBvZiB2YWx1ZXMsIHRoZSB0eXBlIGRlcGVuZHMgb24gdGhlIGFjdGlvbi4KICAgKi8KICBhZGRBbmltYXRpb25UcmFjayh0LCBlLCBpLCBuKSB7CiAgICB0aGlzLmFuaW1hdGlvbi5hZGRUcmFjaygKICAgICAgdCwKICAgICAgdGhpcy5uZXN0ZWRHcm91cC5ncm91cHNbdF0sCiAgICAgIGUsCiAgICAgIGksCiAgICAgIG4KICAgICk7CiAgfQogIC8qKgogICAqIEluaXRpYWxpemUgdGhlIGFuaW1hdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBvdmVyYWxsIGR1cmF0aW9uIG9mIHRoZSBhbm1pYXRpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHNwZWVkIC0gc3BlZWQgb2YgdGhlIGFuaW1hdGlvbi4KICAgKi8KICBpbml0QW5pbWF0aW9uKHQsIGUsIGkgPSAiQSIsIG4gPSAhMCkgewogICAgaWYgKHRoaXMuYW5pbWF0aW9uID09IG51bGwgfHwgdGhpcy5hbmltYXRpb24udHJhY2tzLmxlbmdodCA9PSAwKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkFuaW1hdGlvbiBkb2VzIG5vdCBoYXZlIHRyYWNrcyIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zb2xlLmRlYnVnKCJ0aHJlZS1jYWQtdmlld2VyOiBBbmltYXRpb24gaW5pdGlhbGl6ZWQiKSwgdGhpcy5oYXNBbmltYXRpb25Mb29wIHx8IHRoaXMudG9nZ2xlQW5pbWF0aW9uTG9vcCghMCksIHRoaXMuZGlzcGxheS5zaG93QW5pbWF0aW9uQ29udHJvbCghMCksIHRoaXMuY2xpcEFjdGlvbiA9IHRoaXMuYW5pbWF0aW9uLmFuaW1hdGUoCiAgICAgIHRoaXMubmVzdGVkR3JvdXAucm9vdEdyb3VwLAogICAgICB0LAogICAgICBlLAogICAgICBuCiAgICApLCB0aGlzLmRpc3BsYXkuc2V0QW5pbWF0aW9uTGFiZWwoaSksIHRoaXMuZGlzcGxheS5yZXNldEFuaW1hdGlvblNsaWRlcigpOwogIH0KICAvKioKICAgKiBDaGVjayB3aGV0aGVyIGFuaW1hdGlvbiBvYmplY3QgZXhpc3RzCiAgICovCiAgaGFzQW5pbWF0aW9uKCkgewogICAgcmV0dXJuICEhdGhpcy5hbmltYXRpb24uY2xpcEFjdGlvbjsKICB9CiAgLyoqCiAgICogQ2xlYXIgdGhlIGFuaW1hdGlvbiBvYmVjdCBhbmQgZGlzcG9zZSBkZXBlbmRlbnQgb2JqZWN0cwogICAqLwogIGNsZWFyQW5pbWF0aW9uKCkgewogICAgdGhpcy5hbmltYXRpb24gJiYgbWUodGhpcy5hbmltYXRpb24pLCB0aGlzLmRpc3BsYXkuc2hvd0FuaW1hdGlvbkNvbnRyb2woITEpLCB0aGlzLnRvZ2dsZUFuaW1hdGlvbkxvb3AoITEpOwogIH0KICB0b2dnbGVBbmltYXRpb25Mb29wKHQpIHsKICAgIHQgPyAodGhpcy5jb250aW51ZUFuaW1hdGlvbiA9ICEwLCB0aGlzLmhhc0FuaW1hdGlvbkxvb3AgPSAhMCwgdGhpcy5jb250cm9scy5yZW1vdmVDaGFuZ2VMaXN0ZW5lcigpLCBjb25zb2xlLmRlYnVnKCJ0aHJlZS1jYWQtdmlld2VyOiBDaGFuZ2UgbGlzdGVuZXIgcmVtb3ZlZCIpLCB0aGlzLmFuaW1hdGUoKSwgY29uc29sZS5kZWJ1ZygidGhyZWUtY2FkLXZpZXdlcjogQW5pbWF0aW9uIGxvb3Agc3RhcnRlZCIpKSA6ICh0aGlzLmhhc0FuaW1hdGlvbkxvb3AgJiYgY29uc29sZS5kZWJ1ZygidGhyZWUtY2FkLXZpZXdlcjogVHVybmluZyBhbmltYXRpb24gbG9vcCBvZmYiKSwgdGhpcy5jb250aW51ZUFuaW1hdGlvbiA9ICExLCB0aGlzLmhhc0FuaW1hdGlvbkxvb3AgPSAhMSwgdGhpcy5jb250cm9scy5hZGRDaGFuZ2VMaXN0ZW5lcigoKSA9PiB0aGlzLnVwZGF0ZSghMCwgITApKSwgY29uc29sZS5kZWJ1ZygidGhyZWUtY2FkLXZpZXdlcjogQ2hhbmdlIGxpc3RlbmVyIHJlZ2lzdGVyZWQiKSwgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZSghMCwgITApLCA1MCkpOwogIH0KICAvLyAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLQogIC8vIENsZWFuIHVwCiAgLy8gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0gLSAtIC0KICAvKioKICAgKiBSZW1vdmUgYXNzZXRzIGFuZCBldmVudCBoYW5kbGVycy4KICAgKi8KICBkaXNwb3NlKCkgewogICAgdGhpcy5jbGVhcigpLCBtZSh0aGlzLmdyaWRIZWxwZXIpLCB0aGlzLmdyaWRIZWxwZXIgPSBudWxsLCB0aGlzLm9yaWVudGF0aW9uTWFya2VyICE9IG51bGwgJiYgdGhpcy5vcmllbnRhdGlvbk1hcmtlci5kaXNwb3NlKCksIHRoaXMucmVuZGVyZXIgIT0gbnVsbCAmJiAodGhpcy5yZW5kZXJlci5yZW5kZXJMaXN0cy5kaXNwb3NlKCksIHRoaXMucmVuZGVyZXIuZ2V0Q29udGV4dCgid2ViZ2wyIikuZ2V0RXh0ZW5zaW9uKCJXRUJHTF9sb3NlX2NvbnRleHQiKS5sb3NlQ29udGV4dCgpLCBjb25zb2xlLmRlYnVnKCJ0aHJlZS1jYWQtdmlld2VyOiBXZWJHTCBjb250ZXh0IGRpc3Bvc2VkIiksIHRoaXMucmVuZGVyZXIgPSBudWxsKSwgdGhpcy5hbWJpZW50TGlnaHQuZGlzcG9zZSgpLCB0aGlzLmFtYmllbnRMaWdodCA9IG51bGwsIHRoaXMuZGlyZWN0TGlnaHQuZGlzcG9zZSgpLCB0aGlzLmRpcmVjdExpZ2h0ID0gbnVsbCwgdGhpcy5tYXRlcmlhbFNldHRpbmdzID0gbnVsbCwgdGhpcy5jbGlwcGluZyA9IG51bGwsIHRoaXMuY2FtZXJhID0gbnVsbCwgdGhpcy5ncmlkSGVscGVyID0gbnVsbCwgdGhpcy5heGVzSGVscGVyID0gbnVsbCwgdGhpcy5jb250cm9scyA9IG51bGwsIHRoaXMub3JpZW50YXRpb25NYXJrZXIgPSBudWxsLCB0aGlzLmNvbXBhY3RUcmVlID0gbnVsbCwgbWUodGhpcy5jYWRUb29scyksIHRoaXMuY2FkVG9vbHMgPSBudWxsLCB0aGlzLmNsaXBBY3Rpb24gPSBudWxsLCB0aGlzLnRyZWV2aWV3LmRpc3Bvc2UoKSwgdGhpcy50cmVldmlldyA9IG51bGwsIHRoaXMuYW5pbWF0aW9uID0gbnVsbCwgdGhpcy5jbGlwTm9ybWFscyA9IG51bGwsIHRoaXMubGFzdE5vdGlmaWNhdGlvbiA9IG51bGwsIHRoaXMuY2xpcE5vcm1hbDAgPSBudWxsLCB0aGlzLmNsaXBOb3JtYWwxID0gbnVsbCwgdGhpcy5jbGlwTm9ybWFsMiA9IG51bGwsIHRoaXMuZGlzcGxheSA9IG51bGwsIHRoaXMucmVuZGVyT3B0aW9ucyA9IG51bGwsIHRoaXMubW91c2UgPSBudWxsLCB0aGlzLnRyZWUgPSBudWxsLCB0aGlzLmluZm8gPSBudWxsLCB0aGlzLmJib3ggPSBudWxsLCB0aGlzLmtleW1hcCA9IG51bGwsIHRoaXMucmF5Y2FzdGVyICYmICh0aGlzLnJheWNhc3Rlci5kaXNwb3NlKCksIHRoaXMucmF5Y2FzdGVyID0gbnVsbCk7CiAgfQogIC8qKgogICAqIENsZWFyIENBRCB2aWV3IGFuZCByZW1vdmUgZXZlbnQgaGFuZGxlci4KICAgKi8KICBjbGVhcigpIHsKICAgIHRoaXMuc2NlbmUgIT0gbnVsbCAmJiAodGhpcy5oYXNBbmltYXRpb25Mb29wID0gITEsIHRoaXMuY29udGludWVBbmltYXRpb24gPSAhMSwgdGhpcy5oYXNBbmltYXRpb25Mb29wIHx8ICh0aGlzLmNvbnRyb2xzLnJlbW92ZUNoYW5nZUxpc3RlbmVyKCksIGNvbnNvbGUuZGVidWcoInRocmVlLWNhZC12aWV3ZXI6IENoYW5nZSBsaXN0ZW5lciByZW1vdmVkIikpLCB0aGlzLmhhc0FuaW1hdGlvbkxvb3AgPSAhMSwgdGhpcy5kaXNwbGF5LnNob3dBbmltYXRpb25Db250cm9sKCExKSwgdGhpcy5hbmltYXRpb24gIT0gbnVsbCAmJiBtZSh0aGlzLmFuaW1hdGlvbiksIHRoaXMuZGlzcGxheS5zZXRFeHBsb2RlQ2hlY2soITEpLCB0aGlzLmRpc3BsYXkuc2V0RXhwbG9kZSgiIiwgITEpLCB0aGlzLnNoYXBlcy5mb3JtYXQgPT0gIkdEUyIgJiYgKHRoaXMuZGlzcGxheS5zZXRaU2NhbGVDaGVjayghMSksIHRoaXMuZGlzcGxheS5zZXRaU2NhbGUoIiIsICExKSksIHRoaXMucmVuZGVyZXIuY2xlYXIoKSwgdGhpcy5jYWRUb29scyAmJiAodGhpcy5jYWRUb29scy5kaXNhYmxlKCksIHRoaXMuZGlzcGxheS5jdXJyZW50QnV0dG9uICE9IG51bGwgJiYgKHRoaXMuZGlzcGxheS50b29sYmFyQnV0dG9uc1t0aGlzLmRpc3BsYXkuY3VycmVudEJ1dHRvbl0uc2V0KCExKSwgdGhpcy5kaXNwbGF5LnNldFRvb2wodGhpcy5kaXNwbGF5LmN1cnJlbnRCdXR0b24sICExKSkpLCBtZSh0aGlzLnNjZW5lKSwgbWUodGhpcy5ncmlkSGVscGVyKSwgbWUodGhpcy5jbGlwcGluZyksIHRoaXMuY2xpcHBpbmcgPSBudWxsLCB0aGlzLmRpc3BsYXkuY2xlYXJDYWRUcmVlKCksIG1lKHRoaXMuaW5mbyksIG1lKHRoaXMuY2FtZXJhKSwgbWUodGhpcy5jb250cm9scyksIHRoaXMuc2NlbmUgPSBudWxsLCB0aGlzLnJlYWR5ID0gITEpLCB0aGlzLnNoYXBlcyAhPSBudWxsICYmIChtZSh0aGlzLnNoYXBlcyksIHRoaXMuc2hhcGVzID0gbnVsbCksIHRoaXMuZXhwYW5kZWROZXN0ZWRHcm91cCAhPSBudWxsICYmIChtZSh0aGlzLmV4cGFuZGVkTmVzdGVkR3JvdXApLCB0aGlzLmV4cGFuZGVkTmVzdGVkR3JvdXAgPSBudWxsKSwgdGhpcy5jb21wYWN0TmVzdGVkR3JvdXAgIT0gbnVsbCAmJiAobWUodGhpcy5jb21wYWN0TmVzdGVkR3JvdXApLCB0aGlzLmNvbXBhY3ROZXN0ZWRHcm91cCA9IG51bGwpLCB0aGlzLm5lc3RlZEdyb3VwICE9IG51bGwgJiYgKG1lKHRoaXMubmVzdGVkR3JvdXApLCB0aGlzLm5lc3RlZEdyb3VwID0gbnVsbCk7CiAgfQogIC8qKgogICAqIFRvZ2dsZSB0aGUgdHdvIHZlcnNpb24gb2YgdGhlIE5lc3RlZEdyb3VwCiAgICogQHBhcmFtIGV4cGFuZGVkIC0gd2hldGhlciB0byByZW5kZXIgdGhlIGV4cGxvZGVkIG9yIGNvbXBhY3QgdmVyc2lvbgogICAqLwogIHRvZ2dsZUdyb3VwKHQpIHsKICAgIHZhciBlID0gbmV3IHVkKCJ0b2dnbGVHcm91cCIsIHRoaXMudGltZWl0KSwgaSA9ICgpID0+IHsKICAgICAgdGhpcy5uZXN0ZWRHcm91cC5zZXRUcmFuc3BhcmVudCh0aGlzLnRyYW5zcGFyZW50KSwgdGhpcy5uZXN0ZWRHcm91cC5zZXRCbGFja0VkZ2VzKHRoaXMuYmxhY2tFZGdlcyksIHRoaXMubmVzdGVkR3JvdXAuc2V0TWV0YWxuZXNzKHRoaXMubWV0YWxuZXNzKSwgdGhpcy5uZXN0ZWRHcm91cC5zZXRSb3VnaG5lc3ModGhpcy5yb3VnaG5lc3MpLCB0aGlzLm5lc3RlZEdyb3VwLnNldFBvbHlnb25PZmZzZXQoMik7CiAgICB9OwogICAgaWYgKHRoaXMuY29tcGFjdE5lc3RlZEdyb3VwID09IG51bGwgJiYgIXQgfHwgdGhpcy5leHBhbmRlZE5lc3RlZEdyb3VwID09IG51bGwgJiYgdCkgewogICAgICB0aGlzLnNldFJlbmRlckRlZmF1bHRzKHRoaXMucmVuZGVyT3B0aW9ucyk7CiAgICAgIHZhciBuOwogICAgICB0ID8gdGhpcy5leHBhbmRlZE5lc3RlZEdyb3VwID09IG51bGwgJiYgKG4gPSB0aGlzLnJlbmRlclRlc3NlbGxhdGVkU2hhcGVzKHQsIHRoaXMuc2hhcGVzKSwgdGhpcy5uZXN0ZWRHcm91cCA9IG4uZ3JvdXAsIHRoaXMuZXhwYW5kZWROZXN0ZWRHcm91cCA9IG4uZ3JvdXAsIGkoKSwgdGhpcy5leHBhbmRlZFRyZWUgPSBuLnRyZWUpIDogdGhpcy5jb21wYWN0TmVzdGVkR3JvdXAgPT0gbnVsbCAmJiAobiA9IHRoaXMucmVuZGVyVGVzc2VsbGF0ZWRTaGFwZXModCwgdGhpcy5zaGFwZXMpLCB0aGlzLm5lc3RlZEdyb3VwID0gbi5ncm91cCwgdGhpcy5jb21wYWN0TmVzdGVkR3JvdXAgPSBuLmdyb3VwLCBpKCksIHRoaXMuY29tcGFjdFRyZWUgPSBuLnRyZWUpLCBlLnNwbGl0KGByZW5kZXJlZCR7dCA/ICIgZXhwbG9kZWQiIDogIiBjb21wYWN0In0gc2hhcGVzYCk7CiAgICB9IGVsc2UKICAgICAgdGhpcy5uZXN0ZWRHcm91cCA9IHQgPyB0aGlzLmV4cGFuZGVkTmVzdGVkR3JvdXAgOiB0aGlzLmNvbXBhY3ROZXN0ZWRHcm91cCwgaSgpOwogICAgdGhpcy5leHBhbmRlZFRyZWUgJiYgdGhpcy5zeW5jVHJlZVN0YXRlcyh0aGlzLmNvbXBhY3RUcmVlLCB0aGlzLmV4cGFuZGVkVHJlZSwgdCwgIiIpLCBlLnNwbGl0KCJzeW5jaGVkIHRyZWUgc3RhdGVzIiksIHRoaXMudHJlZSA9IHQgPyB0aGlzLmV4cGFuZGVkVHJlZSA6IHRoaXMuY29tcGFjdFRyZWUsIHRoaXMuc2NlbmUuY2hpbGRyZW5bMF0gPSB0aGlzLm5lc3RlZEdyb3VwLnJvb3RHcm91cCwgZS5zcGxpdCgiYWRkZWQgc2hhcGVzIHRvIHNjZW5lIiksIG1lKHRoaXMudHJlZXZpZXcpLCB0aGlzLnRyZWV2aWV3ID0gbmV3IFFFKAogICAgICB0aGlzLnRyZWUsCiAgICAgIHRoaXMuZGlzcGxheS5jYWRUcmVlU2Nyb2xsQ29udGFpbmVyLAogICAgICB0aGlzLnNldE9iamVjdCwKICAgICAgdGhpcy5oYW5kbGVQaWNrLAogICAgICB0aGlzLnVwZGF0ZSwKICAgICAgdGhpcy5ub3RpZnlTdGF0ZXMsCiAgICAgIHRoaXMuZ2V0Tm9kZUNvbG9yLAogICAgICB0aGlzLnRoZW1lLAogICAgICB0aGlzLm5ld1RyZWVCZWhhdmlvciwKICAgICAgITEKICAgICksIHRoaXMuZGlzcGxheS5jbGVhckNhZFRyZWUoKTsKICAgIGNvbnN0IHMgPSB0aGlzLnRyZWV2aWV3LmNyZWF0ZSgpOwogICAgZS5zcGxpdCgiY3JlYXRlZCB0cmVlIiksIHRoaXMuZGlzcGxheS5hZGRDYWRUcmVlKHMpLCB0aGlzLnRyZWV2aWV3LnJlbmRlcigpLCBlLnNwbGl0KCJyZW5kZXJlZCB0cmVlIiksIGUuc3RvcCgpOwogIH0KICAvKioKICAgKiBUb2dnbGUgdGFiIGFuZCBlbnN1cmUgY29sbGFwcyBpcyB0cmVhdGVkIGNvcnJlY3RseQogICAqIE5lZWRzIHRvIGJlIGNhbGxlZCBpbiBzeW5jIHdpdGggdG9nZ2xlR3JvdXAhCiAgICogQHBhcmFtIGJvb2xlYW4gZGlzYWJsZSAtIHRydWUgdG8gZGlzYWJsZSBjbGlwcGluZyB0YWIKICAgKi8KICB0b2dnbGVUYWIodCkgewogICAgdmFyIGUgPSBuZXcgdWQoInRvZ2dsZVRhYiIsIHRoaXMudGltZWl0KTsKICAgIHN3aXRjaCAodGhpcy5kaXNwbGF5LnNlbGVjdFRhYkJ5TmFtZSgidHJlZSIpLCBlLnNwbGl0KCJjb2xsYXBzZSB0cmVlIiksIHRoaXMuY29sbGFwc2UpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMudHJlZXZpZXcuZXhwYW5kQWxsKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnRyZWV2aWV3Lm9wZW5MZXZlbCgtMSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLnRyZWV2aWV3LmNvbGxhcHNlQWxsKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLnRyZWV2aWV3Lm9wZW5MZXZlbCgxKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuY2hlY2tDaGFuZ2VzKHsgc3RhdGVzOiB0aGlzLmdldFN0YXRlcygpIH0sICEwKSwgZS5zcGxpdCgibm90aWZ5IHN0YXRlIGNoYW5nZXMiKSwgZS5zdG9wKCksIHRoaXMuZGlzcGxheS50b2dnbGVDbGlwcGluZ1RhYighdCk7CiAgfQogIC8qKgogICAqIFJlbmRlciBhIENBRCBvYmplY3QgYW5kIGJ1aWxkIHRoZSBuYXZpZ2F0aW9uIHRyZWUKICAgKiBAcGFyYW0ge1NoYXBlc30gc2hhcGVzIC0gdGhlIFNoYXBlcyBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSB0ZXNzZWxsYXRlZCBDQUQgb2JqZWN0CiAgICogQHBhcmFtIHtSZW5kZXJPcHRpb25zfSByZW5kZXJPcHRpb25zIC0gdGhlIHJlbmRlciBvcHRpb25zCiAgICogQHBhcmFtIHtWaWV3ZXJPcHRpb25zfSB2aWV3ZXJPcHRpb25zIC0gdGhlIHZpZXdlciBvcHRpb25zCiAgICovCiAgcmVuZGVyKHQsIGUsIGkpIHsKICAgIHRoaXMuc2hhcGVzID0gdCwgdGhpcy5yZW5kZXJPcHRpb25zID0gZSwgdGhpcy5zZXRWaWV3ZXJEZWZhdWx0cyhpKSwgdGhpcy5hbmltYXRpb24uY2xlYW5CYWNrdXAoKTsKICAgIGNvbnN0IG4gPSBuZXcgdWQoInZpZXdlciIsIHRoaXMudGltZWl0KTsKICAgIHRoaXMuc2NlbmUgPSBuZXcga28oKSwgdGhpcy50b2dnbGVHcm91cCghMSksIG4uc3BsaXQoInNjZW5lIGFuZCB0cmVlIGRvbmUiKSwgdGhpcy5iYm94IHx8ICh0aGlzLmJib3ggPSB0aGlzLm5lc3RlZEdyb3VwLmJvdW5kaW5nQm94KCkpOwogICAgY29uc3QgcyA9IG5ldyBFKCk7CiAgICB0aGlzLmJib3guZ2V0Q2VudGVyKHMpLCB0aGlzLmJiX21heCA9IHRoaXMuYmJveC5tYXhfZGlzdF9mcm9tX2NlbnRlcigpLCB0aGlzLmJiX3JhZGl1cyA9IE1hdGgubWF4KAogICAgICB0aGlzLmJib3guYm91bmRpbmdTcGhlcmUoKS5yYWRpdXMsCiAgICAgIHMubGVuZ3RoKCkKICAgICksIG4uc3BsaXQoImJvdW5kaW5nIGJveCIpLCB0aGlzLmluZm8gPSBuZXcgb1QodGhpcy5kaXNwbGF5LmNhZEluZm8sIHRoaXMudGhlbWUpLCB0aGlzLmNhbWVyYSA9IG5ldyBoVCgKICAgICAgdGhpcy5jYWRXaWR0aCwKICAgICAgdGhpcy5oZWlnaHQsCiAgICAgIHRoaXMuYmJfcmFkaXVzLAogICAgICBpLnRhcmdldCA9PSBudWxsID8gdGhpcy5iYm94LmNlbnRlcigpIDogaS50YXJnZXQsCiAgICAgIHRoaXMub3J0aG8sCiAgICAgIGkudXAKICAgICksIHRoaXMuY29udHJvbHMgPSBuZXcgbFQoCiAgICAgIHRoaXMuY29udHJvbCwKICAgICAgdGhpcy5jYW1lcmEuZ2V0Q2FtZXJhKCksCiAgICAgIGkudGFyZ2V0ID09IG51bGwgPyB0aGlzLmJib3guY2VudGVyKCkgOiBpLnRhcmdldCwKICAgICAgdGhpcy5yZW5kZXJlci5kb21FbGVtZW50LAogICAgICB0aGlzLnJvdGF0ZVNwZWVkLAogICAgICB0aGlzLnpvb21TcGVlZCwKICAgICAgdGhpcy5wYW5TcGVlZAogICAgKSwgdGhpcy5jb250cm9scy5lbmFibGVLZXlzID0gITEsIHRoaXMuY29udHJvbHMuY29udHJvbHMuc2NyZWVuU3BhY2VQYW5uaW5nID0gITAsIGkucG9zaXRpb24gPT0gbnVsbCAmJiBpLnF1YXRlcm5pb24gPT0gbnVsbCA/ICh0aGlzLnByZXNldENhbWVyYSgiaXNvIiwgdGhpcy56b29tKSwgdGhpcy5kaXNwbGF5LmhpZ2hsaWdodEJ1dHRvbigiaXNvIikpIDogaS5wb3NpdGlvbiAhPSBudWxsID8gKHRoaXMuc2V0Q2FtZXJhKAogICAgICAhMSwKICAgICAgaS5wb3NpdGlvbiwKICAgICAgaS5xdWF0ZXJuaW9uLAogICAgICB0aGlzLnpvb20KICAgICksIGkucXVhdGVybmlvbiA9PSBudWxsICYmIHRoaXMuY2FtZXJhLmxvb2tBdFRhcmdldCgpKSA6ICh0aGlzLmluZm8uYWRkSHRtbCgKICAgICAgIjxiPnF1YXRlcm5pb24gbmVlZHMgcG9zaXRpb24gdG8gYmUgcHJvdmlkZWQsIGZhbGxpbmcgYmFjayB0byBJU08gdmlldzwvYj4iCiAgICApLCB0aGlzLnByZXNldENhbWVyYSgiaXNvIiwgdGhpcy56b29tKSksIHRoaXMuY29udHJvbHMudXBkYXRlKCksIHRoaXMuY29udHJvbHMuc2F2ZVN0YXRlKCksIHRoaXMuYW1iaWVudExpZ2h0ID0gbmV3IGFmKAogICAgICAxNjc3NzIxNSwKICAgICAga2wodGhpcy5hbWJpZW50SW50ZW5zaXR5KQogICAgKSwgdGhpcy5zY2VuZS5hZGQodGhpcy5hbWJpZW50TGlnaHQpLCB0aGlzLmRpcmVjdExpZ2h0ID0gbmV3IHJmKAogICAgICAxNjc3NzIxNSwKICAgICAga2wodGhpcy5kaXJlY3RJbnRlbnNpdHkpCiAgICApLCB0aGlzLnNjZW5lLmFkZCh0aGlzLmRpcmVjdExpZ2h0KSwgdGhpcy5zZXRBbWJpZW50TGlnaHQodGhpcy5hbWJpZW50SW50ZW5zaXR5KSwgdGhpcy5zZXREaXJlY3RMaWdodCh0aGlzLmRpcmVjdEludGVuc2l0eSksIHRoaXMuZ3JpZEhlbHBlciA9IG5ldyBYRSgKICAgICAgdGhpcywKICAgICAgdGhpcy5iYm94LAogICAgICB0aGlzLnRpY2tzLAogICAgICB0aGlzLmdyaWRGb250U2l6ZSwKICAgICAgdGhpcy5jZW50ZXJHcmlkLAogICAgICB0aGlzLmF4ZXMwLAogICAgICB0aGlzLmdyaWQsCiAgICAgIGkudXAgPT0gIloiLAogICAgICB0aGlzLnRoZW1lCiAgICApLCB0aGlzLmdyaWRIZWxwZXIuY29tcHV0ZUdyaWQoKSwgdGhpcy5zY2VuZS5hZGQodGhpcy5ncmlkSGVscGVyKSwgdGhpcy5ncmlkU2l6ZSA9IHRoaXMuZ3JpZEhlbHBlci5zaXplLCB0aGlzLmF4ZXNIZWxwZXIgPSBuZXcgel8oCiAgICAgIHRoaXMuYmJveC5jZW50ZXIoKSwKICAgICAgdGhpcy5ncmlkU2l6ZSAvIDIsCiAgICAgIDIsCiAgICAgIHRoaXMuY2FkV2lkdGgsCiAgICAgIHRoaXMuaGVpZ2h0LAogICAgICB0aGlzLmF4ZXMwLAogICAgICB0aGlzLmF4ZXMsCiAgICAgIHRoaXMudGhlbWUKICAgICksIHRoaXMuc2NlbmUuYWRkKHRoaXMuYXhlc0hlbHBlcik7CiAgICBjb25zdCByID0gMS4xICogTWF0aC5tYXgoCiAgICAgIE1hdGguYWJzKHRoaXMuYmJveC5taW4ubGVuZ3RoKCkpLAogICAgICBNYXRoLmFicyh0aGlzLmJib3gubWF4Lmxlbmd0aCgpKQogICAgKTsKICAgIHRoaXMuY2xpcHBpbmcgPSBuZXcgc1QoCiAgICAgIHRoaXMuYmJveC5jZW50ZXIoKSwKICAgICAgMiAqIHIsCiAgICAgIHRoaXMubmVzdGVkR3JvdXAsCiAgICAgIHRoaXMuZGlzcGxheSwKICAgICAgdGhpcy50aGVtZQogICAgKSwgdGhpcy5kaXNwbGF5LnNldFNsaWRlckxpbWl0cyh0aGlzLmdyaWRTaXplIC8gMiwgdGhpcy5iYm94LmNlbnRlcigpKSwgdGhpcy5zZXRDbGlwTm9ybWFsKDAsIGkuY2xpcE5vcm1hbDAsIG51bGwsICEwKSwgdGhpcy5zZXRDbGlwTm9ybWFsKDEsIGkuY2xpcE5vcm1hbDEsIG51bGwsICEwKSwgdGhpcy5zZXRDbGlwTm9ybWFsKDIsIGkuY2xpcE5vcm1hbDIsIG51bGwsICEwKSwgdGhpcy5jbGlwU2xpZGVyMCA9IGkuY2xpcFNsaWRlcjAgIT0gbnVsbCA/IGkuY2xpcFNsaWRlcjAgOiB0aGlzLmdyaWRTaXplIC8gMiwgdGhpcy5jbGlwU2xpZGVyMSA9IGkuY2xpcFNsaWRlcjEgIT0gbnVsbCA/IGkuY2xpcFNsaWRlcjEgOiB0aGlzLmdyaWRTaXplIC8gMiwgdGhpcy5jbGlwU2xpZGVyMiA9IGkuY2xpcFNsaWRlcjIgIT0gbnVsbCA/IGkuY2xpcFNsaWRlcjIgOiB0aGlzLmdyaWRTaXplIC8gMiwgdGhpcy5zZXRDbGlwU2xpZGVyKDAsIHRoaXMuY2xpcFNsaWRlcjAsICEwKSwgdGhpcy5zZXRDbGlwU2xpZGVyKDEsIHRoaXMuY2xpcFNsaWRlcjEsICEwKSwgdGhpcy5zZXRDbGlwU2xpZGVyKDIsIHRoaXMuY2xpcFNsaWRlcjIsICEwKSwgdGhpcy5zZXRDbGlwSW50ZXJzZWN0aW9uKGkuY2xpcEludGVyc2VjdGlvbiwgITApLCB0aGlzLnNldENsaXBPYmplY3RDb2xvckNhcHMoaS5jbGlwT2JqZWN0Q29sb3JzLCAhMCksIHRoaXMuc2V0Q2xpcFBsYW5lSGVscGVyc0NoZWNrKGkuY2xpcFBsYW5lSGVscGVycywgITApLCB0aGlzLnNjZW5lLmFkZCh0aGlzLmNsaXBwaW5nKSwgdGhpcy5uZXN0ZWRHcm91cC5zZXRDbGlwUGxhbmVzKHRoaXMuY2xpcHBpbmcuY2xpcFBsYW5lcyksIHRoaXMuc2V0TG9jYWxDbGlwcGluZyghMSksIHRoaXMuY2xpcHBpbmcuc2V0VmlzaWJsZSghMSksIHRoaXMudG9nZ2xlVGFiKCExKSwgdGhpcy5kaXNwbGF5Lm1ldGFsbmVzc1NsaWRlci5zZXRWYWx1ZSh0aGlzLm1ldGFsbmVzcyAqIDEwMCksIHRoaXMuZGlzcGxheS5yb3VnaG5lc3NTbGlkZXIuc2V0VmFsdWUodGhpcy5yb3VnaG5lc3MgKiAxMDApLCB0aGlzLmRpc3BsYXkuYW1iaWVudGxpZ2h0U2xpZGVyLnNldFZhbHVlKHRoaXMuYW1iaWVudEludGVuc2l0eSAqIDEwMCksIHRoaXMuZGlzcGxheS5kaXJlY3Rpb25hbGxpZ2h0U2xpZGVyLnNldFZhbHVlKHRoaXMuZGlyZWN0SW50ZW5zaXR5ICogMTAwKTsKICAgIGNvbnN0IG8gPSB0aGlzLnRoZW1lID09PSAiZGFyayIgfHwgdGhpcy50aGVtZSA9PT0gImJyb3dzZXIiICYmIHdpbmRvdy5tYXRjaE1lZGlhKCIocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIikubWF0Y2hlcyA/ICJkYXJrIiA6ICJsaWdodCI7CiAgICB0aGlzLm9yaWVudGF0aW9uTWFya2VyID0gbmV3IEtFKAogICAgICA4MCwKICAgICAgODAsCiAgICAgIHRoaXMuY2FtZXJhLmdldENhbWVyYSgpLAogICAgICBvCiAgICApLCB0aGlzLm9yaWVudGF0aW9uTWFya2VyLmNyZWF0ZSgpLCB0aGlzLmRpc3BsYXkudXBkYXRlVUkoCiAgICAgIHRoaXMuYXhlcywKICAgICAgdGhpcy5heGVzMCwKICAgICAgdGhpcy5vcnRobywKICAgICAgdGhpcy50cmFuc3BhcmVudCwKICAgICAgdGhpcy5ibGFja0VkZ2VzLAogICAgICB0aGlzLnRvb2xzLAogICAgICB0aGlzLmdsYXNzCiAgICApLCBuLnNwbGl0KCJ1aSB1cGRhdGVkIiksIHRoaXMuZGlzcGxheS5hdXRvQ29sbGFwc2UoKSwgbi5zcGxpdCgic3RlbmNpbCBkb25lIiksIHRoaXMudG9nZ2xlQW5pbWF0aW9uTG9vcCh0aGlzLmhhc0FuaW1hdGlvbkxvb3ApLCB0aGlzLnJlYWR5ID0gITAsIHRoaXMuaW5mby5yZWFkeU1zZyh2ZywgdGhpcy5jb250cm9sKSwgbi5zcGxpdCgic2hvdyBkb25lIiksIHRoaXMubm90aWZ5Q2FsbGJhY2sgJiYgdGhpcy5ub3RpZnlDYWxsYmFjayh7CiAgICAgIHRhYjogeyBvbGQ6IG51bGwsIG5ldzogdGhpcy5kaXNwbGF5LmFjdGl2ZVRhYiB9LAogICAgICB0YXJnZXQ6IHsgb2xkOiBudWxsLCBuZXc6IHRoaXMuY29udHJvbHMudGFyZ2V0IH0sCiAgICAgIHRhcmdldDA6IHsgb2xkOiBudWxsLCBuZXc6IHRoaXMuY29udHJvbHMudGFyZ2V0MCB9LAogICAgICBjbGlwX25vcm1hbF8wOiB7IG9sZDogbnVsbCwgbmV3OiB0aGlzLmNsaXBOb3JtYWwwIH0sCiAgICAgIGNsaXBfbm9ybWFsXzE6IHsgb2xkOiBudWxsLCBuZXc6IHRoaXMuY2xpcE5vcm1hbDEgfSwKICAgICAgY2xpcF9ub3JtYWxfMjogeyBvbGQ6IG51bGwsIG5ldzogdGhpcy5jbGlwTm9ybWFsMiB9CiAgICB9KSwgbi5zcGxpdCgibm90aWZpY2F0aW9uIGRvbmUiKSwgdGhpcy51cGRhdGUoITAsICExKSwgdGhpcy50cmVldmlldy51cGRhdGUoKSwgdGhpcy5kaXNwbGF5LnNldFRoZW1lKHRoaXMudGhlbWUpLCBuLnNwbGl0KCJ1cGRhdGUgZG9uZSIpLCBuLnN0b3AoKTsKICB9CiAgLyoqCiAgICogR2V0IGNhbWVyYSB0eXBlLgogICAqIEByZXR1cm5zIHtzdHJpbmd9ICJvcnRobyIgb3IgInBlcnNwZWN0aXZlIi4KICAgKiovCiAgZ2V0Q2FtZXJhVHlwZSgpIHsKICAgIHJldHVybiB0aGlzLmNhbWVyYS5vcnRobyA/ICJvcnRobyIgOiAicGVyc3BlY3RpdmUiOwogIH0KICAvKioKICAgKiBTZXQgY2FtZXJhIG1vZGUgdG8gT3J0aG9ncmFwaGljQ2FtZXJhIG9yIFBlcnNlcGN0aXZlQ2FtZXJhIChzZWUgYWxzbyBzZXRPcnRobykKICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRoZSBjYW1lcnkgc2hvdWxkIGJlIG9ydGhvZ3JhcGhpYyBvciBwZXJzZXBjdGl2ZQogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAqLwogIHN3aXRjaENhbWVyYSh0LCBlID0gITApIHsKICAgIHRoaXMub3J0aG8gPSB0LCB0aGlzLmNhbWVyYS5zd2l0Y2hDYW1lcmEodCwgZSksIHRoaXMuY29udHJvbHMuc2V0Q2FtZXJhKHRoaXMuY2FtZXJhLmdldENhbWVyYSgpKSwgdGhpcy5kaXNwbGF5LnNldE9ydGhvQ2hlY2sodCksIHRoaXMuY2hlY2tDaGFuZ2VzKHsgb3J0aG86IHQgfSwgZSksIHRoaXMuZ3JpZEhlbHBlci5zY2FsZUxhYmVscygpLCB0aGlzLmdyaWRIZWxwZXIudXBkYXRlKHRoaXMuY2FtZXJhLmdldFpvb20oKSwgITApLCB0aGlzLnVwZGF0ZSghMCwgZSk7CiAgfQogIC8qKgogICAqIFRPRE86IERvZXNuJ3Qgd29yayBhcyBleHBlY3RlZC4gTmVlZHMgdG8gYmUgZml4ZWQuCiAgICoKICAgKiBTZXQgY2FtZXJhIG1vZGUgdG8gT3J0aG9ncmFwaGljQ2FtZXJhIG9yIFBlcnNlcGN0aXZlQ2FtZXJhIChzZWUgYWxzbyBzZXRPcnRobykKICAgKiBAcGFyYW0ge251bWJlcn0gZGlzdGFuY2UgLSBpZiBwcm92aWRlZCwgbmV3IGNhbWVyYSBkaXN0YW5jZQogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAqLwogIHJlY2VudGVyQ2FtZXJhKHQgPSAhMCkgewogICAgY29uc3QgZSA9IHRoaXMuY2FtZXJhLmdldENhbWVyYSgpLCBpID0gbmV3IEUoKSwgbiA9IHRoaXMuYmJveC5jZW50ZXIoKTsKICAgIGkuZnJvbUFycmF5KG4pOwogICAgY29uc3QgcyA9IG5ldyBFKCksIHIgPSB0aGlzLmNvbnRyb2xzLnRhcmdldDsKICAgIHMuZnJvbUFycmF5KHIpLCB0aGlzLmNhbWVyYS5jYW1lcmFfZGlzdGFuY2UgPSA1ICogdGhpcy5iYl9yYWRpdXMsIGUucG9zaXRpb24uc3ViKHMpLmFkZChpKSwgdGhpcy5jb250cm9scy5jb250cm9scy50YXJnZXQgPSBpOwogICAgbGV0IG8gPSBuZXcgRSgpOwogICAgZS5nZXRXb3JsZERpcmVjdGlvbihvKTsKICAgIGxldCBsID0gaS5jbG9uZSgpLmFkZChvLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKC10aGlzLmNhbWVyYS5jYW1lcmFfZGlzdGFuY2UpKTsKICAgIGUucG9zaXRpb24uc2V0KGwueCwgbC55LCBsLnopLCB0aGlzLnVwZGF0ZSghMCwgdCk7CiAgfQogIC8qKgogICAqIENlbnRlcnMgdGhlIGNhbWVyYSB2aWV3IG9uIGFsbCB2aXNpYmxlIG9iamVjdHMgaW4gdGhlIHNjZW5lLgogICAqIENhbGN1bGF0ZXMgYSBib3VuZGluZyBib3ggdGhhdCBlbmNvbXBhc3NlcyBhbGwgdmlzaWJsZSBPYmplY3RHcm91cCBpbnN0YW5jZXMKICAgKiBhbmQgc2V0cyB0aGUgY2FtZXJhIHRhcmdldCB0byB0aGUgY2VudGVyIG9mIHRoYXQgYm91bmRpbmcgYm94LgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gV2hldGhlciB0byBub3RpZnkgbGlzdGVuZXJzIG9mIHRoZSBjYW1lcmEgdXBkYXRlCiAgICovCiAgY2VudGVyVmlzaWJsZU9iamVjdHModCA9ICEwKSB7CiAgICBjb25zdCBlID0gdGhpcy5uZXN0ZWRHcm91cC5ncm91cHM7CiAgICB2YXIgaSA9IG5ldyBvcigpOwogICAgZm9yICh2YXIgbiBpbiBlKSB7CiAgICAgIHZhciBzID0gZVtuXTsKICAgICAgcyBpbnN0YW5jZW9mIGxuICYmIHMuZ2V0VmlzaWJpbGl0eSgpICYmIChjb25zb2xlLmxvZyhuKSwgaS5leHBhbmRCeU9iamVjdChzKSk7CiAgICB9CiAgICBjb25zdCByID0gbmV3IEUoLi4uaS5jZW50ZXIoKSk7CiAgICB0aGlzLnNldENhbWVyYVRhcmdldChyKSwgdGhpcy51cGRhdGUoITAsIHQpOwogIH0KICAvKioKICAgKiBFbmJhYmxlL2Rpc2FibGUgbG9jYWwgY2xpcHBpbmcKICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZsYWcgLSB3aGV0aGVyIHRvIGVuYWJsZSBsb2NhbCBjbGlwcGluZwogICAqLwogIHNldExvY2FsQ2xpcHBpbmcodCkgewogICAgdGhpcy5yZW5kZXJlci5sb2NhbENsaXBwaW5nRW5hYmxlZCA9IHQsIHRoaXMudXBkYXRlKHRoaXMudXBkYXRlTWFya2VyKTsKICB9CiAgLyoqCiAgICogQmFja3VwIGFuaW1hdGlvbiAoZm9yIHN3aXRjaCB0byBleHBsb2RlIGFuaW1hdGlvbikKICAgKi8KICBiYWNrdXBBbmltYXRpb24oKSB7CiAgICB0aGlzLmFuaW1hdGlvbi5oYXNUcmFja3MoKSAmJiAodGhpcy5iYWNrdXBUcmFja3MgPSB0aGlzLmFuaW1hdGlvbi5iYWNrdXAoKSk7CiAgfQogIC8qKgogICAqIFJlc3RvcmUgYW5pbWF0aW9uIChmb3Igc3dpdGNoIGJhY2sgZnJvbSBleHBsb2RlIGFuaW1hdGlvbikKICAgKi8KICByZXN0b3JlQW5pbWF0aW9uKCkgewogICAgaWYgKHRoaXMuYW5pbWF0aW9uLmhhc0JhY2t1cCgpKSB7CiAgICAgIHZhciB0ID0gdGhpcy5hbmltYXRpb24ucmVzdG9yZSgpOwogICAgICB0aGlzLmluaXRBbmltYXRpb24odC5kdXJhdGlvbiwgdC5zcGVlZCwgIkEiLCB0LnJlcGVhdCk7CiAgICB9CiAgfQogIHJlbW92ZUxhc3RCYm94KCkgewogICAgdGhpcy5sYXN0QmJveCAhPSBudWxsICYmICh0aGlzLnNjZW5lLnJlbW92ZSh0aGlzLmxhc3RCYm94LmJib3gpLCB0aGlzLmxhc3RCYm94ID0gbnVsbCk7CiAgfQogIHNldFBpY2tIYW5kbGVyKHQpIHsKICAgIHQgPyB0aGlzLnJlbmRlcmVyLmRvbUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZGJsY2xpY2siLCB0aGlzLnBpY2ssICExKSA6IHRoaXMucmVuZGVyZXIuZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKAogICAgICAiZGJsY2xpY2siLAogICAgICB0aGlzLnBpY2ssCiAgICAgICExCiAgICApOwogIH0KICAvKioKICAgKiBTZXQgcmF5Y2FzdCBtb2RlCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtib29sZWFufSBmbGFnIC0gdHVybiByYXljYXN0IG1vZGUgb24gb3Igb2ZmCiAgICovCiAgc2V0UmF5Y2FzdE1vZGUodCkgewogICAgdCA/ICh0aGlzLnJheWNhc3RlciA9IG5ldyB1ZygKICAgICAgdGhpcy5jYW1lcmEsCiAgICAgIHRoaXMucmVuZGVyZXIuZG9tRWxlbWVudCwKICAgICAgdGhpcy5jYWRXaWR0aCwKICAgICAgdGhpcy5oZWlnaHQsCiAgICAgIHRoaXMuYmJfbWF4IC8gMzAsCiAgICAgIHRoaXMuc2NlbmUuY2hpbGRyZW4uc2xpY2UoMCwgMSksCiAgICAgIHRoaXMuaGFuZGxlUmF5Y2FzdEV2ZW50CiAgICApLCB0aGlzLnJheWNhc3Rlci5pbml0KCkpIDogKHRoaXMucmF5Y2FzdGVyICYmIHRoaXMucmF5Y2FzdGVyLmRpc3Bvc2UoKSwgdGhpcy5yYXljYXN0ZXIgPSBudWxsKTsKICB9CiAgLy8KICAvLyBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgLy8KICAvKioKICAgKiBHZXQgd2hldGhlciBheGVzIGhlbHBlcnMgYXJlIHNob24vaGlkZGVuLgogICAqIEByZXR1cm5zIHtib29sZWFufSBheGVzIHZhbHVlLgogICAqKi8KICBnZXRBeGVzKCkgewogICAgcmV0dXJuIHRoaXMuYXhlczsKICB9CiAgLyoqCiAgICogR2V0IHZpc2liaWxpdHkgb2YgZ3JpZHMuCiAgICogQHJldHVybnMge251bWJlcltdfSBncmlkcyB2YWx1ZS4KICAgKiovCiAgZ2V0R3JpZHMoKSB7CiAgICByZXR1cm4gdGhpcy5ncmlkOwogIH0KICAvKioKICAgKiBHZXQgbG9jYXRpb24gb2YgYXhlcy4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gYXhlczAgdmFsdWUsIHRydWUgbWVhbnMgYXQgb3JpZ2luICgwLDAsMCkKICAgKiovCiAgZ2V0QXhlczAoKSB7CiAgICByZXR1cm4gdGhpcy5heGVzMDsKICB9CiAgLyoqCiAgICogR2V0IGludGVuc2l0eSBvZiBhbWJpZW50IGxpZ2h0LgogICAqIEByZXR1cm5zIHtudW1iZXJ9IGFtYmllbnRMaWdodCB2YWx1ZS4KICAgKiovCiAgZ2V0QW1iaWVudExpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMuYW1iaWVudEludGVuc2l0eTsKICB9CiAgLyoqCiAgICogR2V0IGludGVuc2l0eSBvZiBkaXJlY3QgbGlnaHQuCiAgICogQHJldHVybnMge251bWJlcn0gZGlyZWN0TGlnaHQgdmFsdWUuCiAgICoqLwogIGdldERpcmVjdExpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMuZGlyZWN0SW50ZW5zaXR5OwogIH0KICAvKioKICAgKiBHZXQgdHJhbnNwYXJlbmN5IHN0YXRlIG9mIENBRCBvYmplY3RzLgogICAqIEByZXR1cm5zIHtib29sZWFufSB0cmFuc3BhcmVudCB2YWx1ZS4KICAgKiovCiAgZ2V0VHJhbnNwYXJlbnQoKSB7CiAgICByZXR1cm4gdGhpcy50cmFuc3BhcmVudDsKICB9CiAgLyoqCiAgICogR2V0IGJsYWNrRWRnZXMgdmFsdWUuCiAgICogQHJldHVybnMge2Jvb2xlYW59IGJsYWNrRWRnZXMgdmFsdWUuCiAgICoqLwogIGdldEJsYWNrRWRnZXMoKSB7CiAgICByZXR1cm4gdGhpcy5ibGFja0VkZ2VzOwogIH0KICAvKioKICAgKiBHZXQgb3J0aG8gdmFsdWUuCiAgICogQHJldHVybnMge251bWJlcn0gb3J0aG8gdmFsdWUuCiAgICoqLwogIGdldE9ydGhvKCkgewogICAgcmV0dXJuIHRoaXMuY2FtZXJhLm9ydGhvOwogIH0KICAvKioKICAgKiBTZXQvdW5zZXQgY2FtZXJhJ3Mgb3J0aG9ncmFwaGljIG1vZGUuCiAgICogQHBhcmFtIHtib29sZWFufSB3aGV0aGVyIHRvIHNldCBvcnRob2dyYXBoaWMgbW9kZSBvciBub3QuCiAgICoqLwogIHNldE9ydGhvKHQsIGUgPSAhMCkgewogICAgdGhpcy5zd2l0Y2hDYW1lcmEodCwgZSk7CiAgfQogIC8qKgogICAqIFNldCB6c2NhbGluZyB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGUgZmFjdG9yLgogICAqKi8KICBzZXRac2NhbGVWYWx1ZSh0KSB7CiAgICB0aGlzLm5lc3RlZEdyb3VwLnNldFpTY2FsZSh0KSwgdGhpcy56U2NhbGUgPSB0LCB0aGlzLnVwZGF0ZSghMCk7CiAgfQogIC8qKgogICAqIEdldCB6b29tIHZhbHVlLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IHpvb20gdmFsdWUuCiAgICoqLwogIGdldENhbWVyYVpvb20oKSB7CiAgICByZXR1cm4gdGhpcy5jYW1lcmEuZ2V0Wm9vbSgpOwogIH0KICAvKioKICAgKiBTZXQgem9vbSB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsIC0gZmxvYXQgem9vbSB2YWx1ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgKiovCiAgc2V0Q2FtZXJhWm9vbSh0LCBlID0gITApIHsKICAgIHRoaXMuY2FtZXJhLnNldFpvb20odCksIHRoaXMuY29udHJvbHMudXBkYXRlKCksIHRoaXMudXBkYXRlKCEwLCBlKTsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBjdXJyZW50IGNhbWVyYSBwb3NpdGlvbi4KICAgKiBAcmV0dXJucyB7bnVtYmVyW119IGNhbWVyYSBwb3NpdGlvbiBhcyAzIGRpbSBhcnJheSBbeCx5LHpdLgogICAqKi8KICBnZXRDYW1lcmFQb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmNhbWVyYS5nZXRQb3NpdGlvbigpLnRvQXJyYXkoKTsKICB9CiAgLyoqCiAgICogU2V0IGNhbWVyYSBwb3NpdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcltdfSBwb3NpdGlvbiAtIGNhbWVyYSBwb3NpdGlvbiBhcyAzIGRpbSBBcnJheSBbeCx5LHpdLgogICAqIEBwYXJhbSB7cmVsYXRpdmV9IFtyZWxhdGl2ZT1mYWxzZV0gLSBmbGFnIHdoZXRoZXIgdGhlIHBvc2l0aW9uIGlzIGEgcmVsYXRpdmUgKGUuZy4gWzEsMSwxXSBmb3IgaXNvKSBvciBhYnNvbHV0ZSBwb2ludC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtub3RpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHNlbmQgbm90aWZpY2F0aW9uIG9yIG5vdC4KICAgKiovCiAgc2V0Q2FtZXJhUG9zaXRpb24odCwgZSA9ICExLCBpID0gITApIHsKICAgIHRoaXMuY2FtZXJhLnNldFBvc2l0aW9uKHQsIGUpLCB0aGlzLmNvbnRyb2xzLnVwZGF0ZSgpLCB0aGlzLnVwZGF0ZSghMCwgaSk7CiAgfQogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBjYW1lcmEgcm90YXRpb24gYXMgcXVhdGVybmlvbi4KICAgKiBAcmV0dXJucyB7bnVtYmVyW119IGNhbWVyYSByb3RhdGlvbiBhcyA0IGRpbSBxdWF0ZXJuaW9uIGFycmF5IFt4LHkseix3XS4KICAgKiovCiAgZ2V0Q2FtZXJhUXVhdGVybmlvbigpIHsKICAgIHJldHVybiB0aGlzLmNhbWVyYS5nZXRRdWF0ZXJuaW9uKCkudG9BcnJheSgpOwogIH0KICAvKioKICAgKiBTZXQgY2FtZXJhIHJvdGF0aW9uIHZpYSBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyW119IHF1YXRlcm5pb24gLSBjYW1lcmEgcm90YXRpb24gYXMgNCBkaW0gcXVhdGVybmlvbiBhcnJheSBbeCx5LHosd10uCiAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICoqLwogIHNldENhbWVyYVF1YXRlcm5pb24odCwgZSA9ICEwKSB7CiAgICB0aGlzLmNhbWVyYS5zZXRRdWF0ZXJuaW9uKHQpLCB0aGlzLmNvbnRyb2xzLnVwZGF0ZSgpLCB0aGlzLnVwZGF0ZSghMCwgZSk7CiAgfQogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBjYW1lcmEgdGFyZ2V0LgogICAqIEByZXR1cm5zIHtudW1iZXJbXX0gY2FtZXJhIHRhcmdldCBhcyAzIGRpbSBhcnJheSBhcnJheSBbeCx5LHpdLgogICAqKi8KICBnZXRDYW1lcmFUYXJnZXQoKSB7CiAgICByZXR1cm4gdGhpcy5jb250cm9scy5nZXRUYXJnZXQoKS50b0FycmF5KCk7CiAgfQogIC8qKgogICAqIFNldCBjYW1lcmEgdGFyZ2V0LgogICAqIEBwYXJhbSB7bnVtYmVyW119IHRhcmdldCAtIGNhbWVyYSB0YXJnZXQgYXMgMyBkaW0gcXVhdGVybmlvbiBhcnJheSBbeCx5LHpdLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25vdGlmeT10cnVlXSAtIHdoZXRoZXIgdG8gc2VuZCBub3RpZmljYXRpb24gb3Igbm90LgogICAqKi8KICBzZXRDYW1lcmFUYXJnZXQodCwgZSA9ICEwKSB7CiAgICBjb25zdCBpID0gdGhpcy5jYW1lcmEuZ2V0Q2FtZXJhKCksIG4gPSBpLnpvb20sIHMgPSBpLnBvc2l0aW9uLmNsb25lKCkuc3ViKHRoaXMuY29udHJvbHMuZ2V0VGFyZ2V0KCkpOwogICAgaS5wb3NpdGlvbi5jb3B5KHQuY2xvbmUoKS5hZGQocykpLCBpLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHRoaXMuY29udHJvbHMuZ2V0VGFyZ2V0KCkuY29weSh0KSwgaS50eXBlID09PSAiT3J0aG9ncmFwaGljQ2FtZXJhIiAmJiAoaS56b29tID0gbiwgaS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCkpLCB0aGlzLmNvbnRyb2xzLnVwZGF0ZSgpLCB0aGlzLnVwZGF0ZSghMCwgZSk7CiAgfQogIGdldENhbWVyYUxvY2F0aW9uU2V0dGluZ3MoKSB7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbjogdGhpcy5nZXRDYW1lcmFQb3NpdGlvbigpLAogICAgICBxdWF0ZXJuaW9uOiB0aGlzLmdldENhbWVyYVF1YXRlcm5pb24oKSwKICAgICAgdGFyZ2V0OiB0aGlzLmdldENhbWVyYVRhcmdldCgpLAogICAgICB6b29tOiB0aGlzLmdldENhbWVyYVpvb20oKQogICAgfTsKICB9CiAgc2V0Q2FtZXJhTG9jYXRpb25TZXR0aW5ncyh0ID0gbnVsbCwgZSA9IG51bGwsIGkgPSBudWxsLCBuID0gbnVsbCwgcyA9ICEwKSB7CiAgICB0ICE9IG51bGwgJiYgdGhpcy5jYW1lcmEuc2V0UG9zaXRpb24odCwgITEpLCBlICE9IG51bGwgJiYgdGhpcy5jb250cm9sID09PSAidHJhY2tiYWxsIiAmJiB0aGlzLmNhbWVyYS5zZXRRdWF0ZXJuaW9uKGUpLCBpICE9IG51bGwgJiYgdGhpcy5jb250cm9scy5zZXRUYXJnZXQobmV3IEUoLi4uaSkpLCBuICE9IG51bGwgJiYgdGhpcy5jYW1lcmEuc2V0Wm9vbShuKSwgdGhpcy5jb250cm9scy51cGRhdGUoKSwgdGhpcy51cGRhdGUoITAsIHMpOwogIH0KICAvKioKICAgKiBHZXQgZGVmYXVsdCBjb2xvciBvZiB0aGUgZWRnZXMuCiAgICogQHJldHVybnMge251bWJlcn0gZWRnZUNvbG9yIHZhbHVlLgogICAqKi8KICBnZXRFZGdlQ29sb3IoKSB7CiAgICByZXR1cm4gdGhpcy5lZGdlQ29sb3I7CiAgfQogIC8qKgogICAqIEdldCBkZWZhdWx0IG9wYWNpdHkuCiAgICogQHJldHVybnMge251bWJlcn0gb3BhY2l0eSB2YWx1ZS4KICAgKiovCiAgZ2V0T3BhY2l0eSgpIHsKICAgIHJldHVybiB0aGlzLmRlZmF1bHRPcGFjaXR5OwogIH0KICAvKioKICAgKiBHZXQgd2hldGhlciB0b29scyBhcmUgc2hvd24vaGlkZGVuLgogICAqIEByZXR1cm5zIHtib29sZWFufSB0b29scyB2YWx1ZS4KICAgKiovCiAgZ2V0VG9vbHMoKSB7CiAgICByZXR1cm4gdGhpcy50b29sczsKICB9CiAgLyoqCiAgICogR2V0IHN0YXRlcyBvZiBhIHRyZWV2aWV3IGxlYWZzLgogICAqKi8KICBnZXRTdGF0ZXMoKSB7CiAgICByZXR1cm4gdGhpcy50cmVldmlldy5nZXRTdGF0ZXMoKTsKICB9CiAgLyoqCiAgICogR2V0IHN0YXRlIG9mIGEgdHJlZXZpZXcgbGVhZnMgZm9yIGEgcGF0aC4KICAgKiBzZXBhcmF0b3IgY2FuIGJlIC8gb3IgfAogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gcGF0aCBvZiB0aGUgb2JqZWN0CiAgICogQHJldHVybnMge251bWJlcltdfSBzdGF0ZSB2YWx1ZSBpbiB0aGUgZm9ybSBvZiBbbWVzaCwgZWRnZXNdID0gWzAvMSwgMC8xXQogICAqKi8KICBnZXRTdGF0ZSh0KSB7CiAgICB2YXIgZSA9IHQucmVwbGFjZUFsbCgifCIsICIvIik7CiAgICByZXR1cm4gdGhpcy50cmVldmlldy5nZXRTdGF0ZShlKTsKICB9CiAgLyoqCiAgICogR2V0IHpvb20gc3BlZWQuCiAgICogQHJldHVybnMge251bWJlcn0gem9vbVNwZWVkIHZhbHVlLgogICAqKi8KICBnZXRab29tU3BlZWQoKSB7CiAgICByZXR1cm4gdGhpcy56b29tU3BlZWQ7CiAgfQogIC8qKgogICAqIEdldCBwYW5uaW5nIHNwZWVkLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IHBhbiBzcGVlZCB2YWx1ZS4KICAgKiovCiAgZ2V0UGFuU3BlZWQoKSB7CiAgICByZXR1cm4gdGhpcy5wYW5TcGVlZDsKICB9CiAgLyoqCiAgICogR2V0IHJvdGF0aW9uIHNwZWVkLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IHJvdGF0aW9uIHNwZWVkIHZhbHVlLgogICAqKi8KICBnZXRSb3RhdGVTcGVlZCgpIHsKICAgIHJldHVybiB0aGlzLnJvdGF0ZVNwZWVkOwogIH0KICAvKioKICAgKiBHZXQgaW50ZXJzZWN0aW9uIG1vZGUuCiAgICogQHJldHVybnMge2Jvb2xlYW59IGNsaXAgaW50ZXJzZWN0aW9uIHZhbHVlLgogICAqKi8KICBnZXRDbGlwSW50ZXJzZWN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuY2xpcEludGVyc2VjdGlvbjsKICB9CiAgLyoqCiAgICogR2V0IGNsaXBwaW5nIHBsYW5lIHN0YXRlLgogICAqIEByZXR1cm5zIHtib29sZWFufSBjbGlwIHBsYW5lIHZpc2liaWxpdHkgdmFsdWUuCiAgICoqLwogIGdldENsaXBQbGFuZUhlbHBlcnMoKSB7CiAgICByZXR1cm4gdGhpcy5jbGlwUGxhbmVIZWxwZXJzOwogIH0KICAvKioKICAgKiBTZXQgY2xpcCBwbGFuZSBoZWxwZXJzIGNoZWNrIGJveAogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gZmxhZyAtIHdoZXRoZXIgdG8gc2hvdyBjbGlwIHBsYW5lIGhlbHBlcnMKICAgKi8KICBzZXRDbGlwUGxhbmVIZWxwZXJzQ2hlY2sodCkgewogICAgdCAhPSBudWxsICYmIHRoaXMuZGlzcGxheS5zZXRDbGlwUGxhbmVIZWxwZXJzQ2hlY2sodCk7CiAgfQogIC8qKgogICAqIEdldCBjbGlwcGluZyBwbGFuZSBzdGF0ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGluZGV4IC0gaW5kZXggb2YgdGhlIG5vcm1hbDogMCwgMSAsMgogICAqIEByZXR1cm5zIHtib29sZWFufSBjbGlwIHBsYW5lIHZpc2liaWxpdHkgdmFsdWUuCiAgICoqLwogIGdldENsaXBOb3JtYWwodCkgewogICAgcmV0dXJuIHRoaXMuY2xpcE5vcm1hbHNbdF07CiAgfQogIC8qKgogICAqIFNldCB0aGUgbm9ybWFsIGF0IGluZGV4IHRvIGEgZ2l2ZW4gbm9ybWFsCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gaW5kZXggb2YgdGhlIG5vcm1hbDogMCwgMSAsMgogICAqIEBwYXJhbSB7bnVtYmVyW119IG5vcm1hbCAtIDMgZGltIGFycmF5IHJlcHJlc2VudGluZyB0aGUgbm9ybWFsCiAgICogQHBhcmFtIHtudW1iZXJ9IFt2YWx1ZT1udWxsXSAtIHZhbHVlIG9mIHRoZSBzbGlkZXIsIGlmIGdpdmVuCiAgICogQHBhcmFtIHtib29sZWFufSBbbm90aWZ5PXRydWVdIC0gd2hldGhlciB0byBzZW5kIG5vdGlmaWNhdGlvbiBvciBub3QuCiAgICovCiAgc2V0Q2xpcE5vcm1hbCh0LCBlLCBpID0gbnVsbCwgbiA9ICEwKSB7CiAgICBpZiAoZSA9PSBudWxsKSByZXR1cm47CiAgICBjb25zdCBzID0gbmV3IEUoLi4uZSkubm9ybWFsaXplKCkudG9BcnJheSgpOwogICAgdGhpcy5jbGlwTm9ybWFsc1t0XSA9IHMsIHRoaXMuY2xpcHBpbmcuc2V0Tm9ybWFsKHQsIG5ldyBFKC4uLnMpKSwgdGhpcy5jbGlwcGluZy5zZXRDb25zdGFudCh0LCB0aGlzLmdyaWRTaXplIC8gMiksIGkgPT0gbnVsbCAmJiAoaSA9IHRoaXMuZ3JpZFNpemUgLyAyKSwgdGhpcy5zZXRDbGlwU2xpZGVyKHQsIGkpOwogICAgdmFyIHIgPSB7fTsKICAgIHJbYGNsaXBfbm9ybWFsXyR7dH1gXSA9IHMsIHJbYGNsaXBfc2xpZGVyXyR7dH1gXSA9IGksIHRoaXMuY2hlY2tDaGFuZ2VzKHIsIG4pLCB0aGlzLm5lc3RlZEdyb3VwLnNldENsaXBQbGFuZXModGhpcy5jbGlwcGluZy5jbGlwUGxhbmVzKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpOwogIH0KICAvKioKICAgKiBDYWxjdWxhdGUgZXhwbG9kZSB0cmFqZWN0b3JpZXMgYW5kIGluaXRpYXRlIHRoZSBhbmltYXRpb24KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249Ml0gLSBkdXJhdGlvbiBvZiBhbmltYXRpb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD0xXSAtIHNwZWVkIG9mIGFuaW1hdGlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gW211bHRpcGxpZXI9Mi41XSAtIG11bHRpcGxpZXIgZm9yIGxlbmd0aCBvZiB0cmFqZWN0b3JpZXMuCiAgICovCiAgZXhwbG9kZSh0ID0gMiwgZSA9IDEsIGkgPSAyLjUpIHsKICAgIHRoaXMuY2xlYXJBbmltYXRpb24oKTsKICAgIGNvbnN0IG4gPSB0aGlzLmdldEF4ZXMwKCk7CiAgICB2YXIgcyA9IG5ldyBFKCksIHIgPSBuZXcgRSgpLCBvID0gbnVsbCwgbCA9IG51bGwsIGggPSBudWxsOwogICAgaWYgKCFuKSB7CiAgICAgIHZhciBjID0gbmV3IHdlKCkuc2V0RnJvbU9iamVjdCh0aGlzLm5lc3RlZEdyb3VwLnJvb3RHcm91cCk7CiAgICAgIGMuZ2V0Q2VudGVyKHMpOwogICAgfQogICAgZm9yICh2YXIgdSBpbiB0aGlzLm5lc3RlZEdyb3VwLmdyb3VwcykgewogICAgICB2YXIgZCA9IHRoaXMubmVzdGVkR3JvdXAuZ3JvdXBzW3VdLCBwID0gbmV3IHdlKCk7CiAgICAgIGQgaW5zdGFuY2VvZiBsbiAmJiBwLmV4cGFuZEJ5T2JqZWN0KGQpLCAhcC5pc0VtcHR5KCkgJiYgKHAuZ2V0Q2VudGVyKHIpLCBvID0gci5zdWIocyksIGwgPSBkLnBhcmVudC53b3JsZFRvTG9jYWwoby5jbG9uZSgpKSwgaCA9IGQucGFyZW50LndvcmxkVG9Mb2NhbCgKICAgICAgICBvLmNsb25lKCkubXVsdGlwbHlTY2FsYXIoaSkKICAgICAgKSwgaC5zdWIobCksIHRoaXMuYWRkQW5pbWF0aW9uVHJhY2soCiAgICAgICAgdSwKICAgICAgICAidCIsCiAgICAgICAgWzAsIHRdLAogICAgICAgIFtbMCwgMCwgMF0sIGgudG9BcnJheSgpXQogICAgICApKTsKICAgIH0KICAgIHRoaXMuaW5pdEFuaW1hdGlvbih0LCBlLCAiRSIsICExKTsKICB9CiAgLyoqCiAgICogU2V0IG1vZGlmaWVycyBmb3Iga2V5bWFwCiAgICoKICAgKiBAcGFyYW0ge2NvbmZpZ30ga2V5bWFwIC0gZS5nLiB7InNoaWZ0IjogInNoaWZ0S2V5IiwgImN0cmwiOiAiY3RybEtleSIsICJtZXRhIjogImFsdEtleSJ9CiAgICovCiAgc2V0S2V5TWFwKHQpIHsKICAgIGNvbnN0IGUgPSBEZS5nZXRfY29uZmlnKCk7CiAgICBEZS5zZXQodCksIHRoaXMuZGlzcGxheS51cGRhdGVIZWxwKGUsIHQpOwogIH0KICAvKioKICAgKiBSZXNpemUgVUkgYW5kIHJlbmRlcmVyCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gY2FkV2lkdGggLSBuZXcgd2lkdGggb2YgQ0FEIFZpZXcKICAgKiBAcGFyYW0ge251bWJlcn0gdHJlZVdpZHRoIC0gbmV3IHdpZHRoIG9mIG5hdmlnYXRpb24gdHJlZQogICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBuZXcgaGVpZ2h0IG9mIENBRCBWaWV3CiAgICogQHBhcmFtIHtib29sZWFufSBbZ2xhc3M9ZmFsc2VdIC0gV2hldGhlciB0byB1c2UgZ2xhc3MgbW9kZSBvciBub3QKICAgKi8KICByZXNpemVDYWRWaWV3KHQsIGUsIGksIG4gPSAhMSkgewogICAgdGhpcy5jYWRXaWR0aCA9IHQsIHRoaXMuaGVpZ2h0ID0gaSwgdGhpcy5yZW5kZXJlci5zZXRTaXplKHQsIGkpLCB0aGlzLmRpc3BsYXkuc2V0U2l6ZXMoewogICAgICB0cmVlV2lkdGg6IGUsCiAgICAgIGNhZFdpZHRoOiB0LAogICAgICBoZWlnaHQ6IGkKICAgIH0pLCB0aGlzLmRpc3BsYXkuZ2xhc3NNb2RlKG4pLCB0ICsgKG4gPyAwIDogZSkgPj0gdGhpcy5kaXNwbGF5LndpZHRoVGhyZXNob2xkKCkgPyB0aGlzLmRpc3BsYXkuY2FkVG9vbC5tYXhpbWl6ZSgpIDogdGhpcy5kaXNwbGF5LmNhZFRvb2wubWluaW1pemUoKSwgdGhpcy5jYW1lcmEuY2hhbmdlRGltZW5zaW9ucyh0aGlzLmJiX3JhZGl1cywgdCwgaSksIHRoaXMudXBkYXRlKCEwKSwgdGhpcy5yYXljYXN0ZXIgJiYgKHRoaXMucmF5Y2FzdGVyLndpZHRoID0gdCwgdGhpcy5yYXljYXN0ZXIuaGVpZ2h0ID0gaSk7CiAgfQogIHZlY3RvcjModCA9IDAsIGUgPSAwLCBpID0gMCkgewogICAgcmV0dXJuIG5ldyBFKHQsIGUsIGkpOwogIH0KICBxdWF0ZXJuaW9uKHQgPSAwLCBlID0gMCwgaSA9IDAsIG4gPSAxKSB7CiAgICByZXR1cm4gbmV3IHZlKHQsIGUsIGksIG4pOwogIH0KfQovKioKICogQGxpY2Vuc2UKICogQ29weXJpZ2h0IDIwMTAtMjAyNCBUaHJlZS5qcyBBdXRob3JzCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKICovCmNvbnN0IE5fID0gIjE3MCIsIEJvID0gMCwgZ2YgPSAxLCBiZyA9IDEsIE1nID0gMTAwLCBTZyA9IDIwNCwgd2cgPSAyMDUsIEFnID0gMywgdVQgPSAwLCBPXyA9IDMwMCwgRWcgPSAxZTMsIFlsID0gMTAwMSwgVGcgPSAxMDAyLCBkVCA9IDEwMDYsIHBUID0gMTAwOCwgZlQgPSAxMDA5LCBtVCA9IDEwMTUsIGdUID0gMTAyMywgeVQgPSAwLCBrXyA9ICIiLCBhbiA9ICJzcmdiIiwgVl8gPSAic3JnYi1saW5lYXIiLCBIXyA9ICJsaW5lYXIiLCBfcCA9ICJzcmdiIiwgVnIgPSA3NjgwLCBtZCA9IDM0MDU1LCBnZCA9IDM0MDU2LCBTYyA9IDUxOSwgeHAgPSAzNTA0NCwgWmwgPSAyZTMsIENnID0gMjAwMTsKbGV0IGN1ID0gY2xhc3MgewogIGFkZEV2ZW50TGlzdGVuZXIodCwgZSkgewogICAgdGhpcy5fbGlzdGVuZXJzID09PSB2b2lkIDAgJiYgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsKICAgIGNvbnN0IGkgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICBpW3RdID09PSB2b2lkIDAgJiYgKGlbdF0gPSBbXSksIGlbdF0uaW5kZXhPZihlKSA9PT0gLTEgJiYgaVt0XS5wdXNoKGUpOwogIH0KICBoYXNFdmVudExpc3RlbmVyKHQsIGUpIHsKICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHZvaWQgMCkgcmV0dXJuICExOwogICAgY29uc3QgaSA9IHRoaXMuX2xpc3RlbmVyczsKICAgIHJldHVybiBpW3RdICE9PSB2b2lkIDAgJiYgaVt0XS5pbmRleE9mKGUpICE9PSAtMTsKICB9CiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0LCBlKSB7CiAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB2b2lkIDApIHJldHVybjsKICAgIGNvbnN0IG4gPSB0aGlzLl9saXN0ZW5lcnNbdF07CiAgICBpZiAobiAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IHMgPSBuLmluZGV4T2YoZSk7CiAgICAgIHMgIT09IC0xICYmIG4uc3BsaWNlKHMsIDEpOwogICAgfQogIH0KICBkaXNwYXRjaEV2ZW50KHQpIHsKICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHZvaWQgMCkgcmV0dXJuOwogICAgY29uc3QgaSA9IHRoaXMuX2xpc3RlbmVyc1t0LnR5cGVdOwogICAgaWYgKGkgIT09IHZvaWQgMCkgewogICAgICB0LnRhcmdldCA9IHRoaXM7CiAgICAgIGNvbnN0IG4gPSBpLnNsaWNlKDApOwogICAgICBmb3IgKGxldCBzID0gMCwgciA9IG4ubGVuZ3RoOyBzIDwgcjsgcysrKQogICAgICAgIG5bc10uY2FsbCh0aGlzLCB0KTsKICAgICAgdC50YXJnZXQgPSBudWxsOwogICAgfQogIH0KfTsKY29uc3QgdGkgPSBbIjAwIiwgIjAxIiwgIjAyIiwgIjAzIiwgIjA0IiwgIjA1IiwgIjA2IiwgIjA3IiwgIjA4IiwgIjA5IiwgIjBhIiwgIjBiIiwgIjBjIiwgIjBkIiwgIjBlIiwgIjBmIiwgIjEwIiwgIjExIiwgIjEyIiwgIjEzIiwgIjE0IiwgIjE1IiwgIjE2IiwgIjE3IiwgIjE4IiwgIjE5IiwgIjFhIiwgIjFiIiwgIjFjIiwgIjFkIiwgIjFlIiwgIjFmIiwgIjIwIiwgIjIxIiwgIjIyIiwgIjIzIiwgIjI0IiwgIjI1IiwgIjI2IiwgIjI3IiwgIjI4IiwgIjI5IiwgIjJhIiwgIjJiIiwgIjJjIiwgIjJkIiwgIjJlIiwgIjJmIiwgIjMwIiwgIjMxIiwgIjMyIiwgIjMzIiwgIjM0IiwgIjM1IiwgIjM2IiwgIjM3IiwgIjM4IiwgIjM5IiwgIjNhIiwgIjNiIiwgIjNjIiwgIjNkIiwgIjNlIiwgIjNmIiwgIjQwIiwgIjQxIiwgIjQyIiwgIjQzIiwgIjQ0IiwgIjQ1IiwgIjQ2IiwgIjQ3IiwgIjQ4IiwgIjQ5IiwgIjRhIiwgIjRiIiwgIjRjIiwgIjRkIiwgIjRlIiwgIjRmIiwgIjUwIiwgIjUxIiwgIjUyIiwgIjUzIiwgIjU0IiwgIjU1IiwgIjU2IiwgIjU3IiwgIjU4IiwgIjU5IiwgIjVhIiwgIjViIiwgIjVjIiwgIjVkIiwgIjVlIiwgIjVmIiwgIjYwIiwgIjYxIiwgIjYyIiwgIjYzIiwgIjY0IiwgIjY1IiwgIjY2IiwgIjY3IiwgIjY4IiwgIjY5IiwgIjZhIiwgIjZiIiwgIjZjIiwgIjZkIiwgIjZlIiwgIjZmIiwgIjcwIiwgIjcxIiwgIjcyIiwgIjczIiwgIjc0IiwgIjc1IiwgIjc2IiwgIjc3IiwgIjc4IiwgIjc5IiwgIjdhIiwgIjdiIiwgIjdjIiwgIjdkIiwgIjdlIiwgIjdmIiwgIjgwIiwgIjgxIiwgIjgyIiwgIjgzIiwgIjg0IiwgIjg1IiwgIjg2IiwgIjg3IiwgIjg4IiwgIjg5IiwgIjhhIiwgIjhiIiwgIjhjIiwgIjhkIiwgIjhlIiwgIjhmIiwgIjkwIiwgIjkxIiwgIjkyIiwgIjkzIiwgIjk0IiwgIjk1IiwgIjk2IiwgIjk3IiwgIjk4IiwgIjk5IiwgIjlhIiwgIjliIiwgIjljIiwgIjlkIiwgIjllIiwgIjlmIiwgImEwIiwgImExIiwgImEyIiwgImEzIiwgImE0IiwgImE1IiwgImE2IiwgImE3IiwgImE4IiwgImE5IiwgImFhIiwgImFiIiwgImFjIiwgImFkIiwgImFlIiwgImFmIiwgImIwIiwgImIxIiwgImIyIiwgImIzIiwgImI0IiwgImI1IiwgImI2IiwgImI3IiwgImI4IiwgImI5IiwgImJhIiwgImJiIiwgImJjIiwgImJkIiwgImJlIiwgImJmIiwgImMwIiwgImMxIiwgImMyIiwgImMzIiwgImM0IiwgImM1IiwgImM2IiwgImM3IiwgImM4IiwgImM5IiwgImNhIiwgImNiIiwgImNjIiwgImNkIiwgImNlIiwgImNmIiwgImQwIiwgImQxIiwgImQyIiwgImQzIiwgImQ0IiwgImQ1IiwgImQ2IiwgImQ3IiwgImQ4IiwgImQ5IiwgImRhIiwgImRiIiwgImRjIiwgImRkIiwgImRlIiwgImRmIiwgImUwIiwgImUxIiwgImUyIiwgImUzIiwgImU0IiwgImU1IiwgImU2IiwgImU3IiwgImU4IiwgImU5IiwgImVhIiwgImViIiwgImVjIiwgImVkIiwgImVlIiwgImVmIiwgImYwIiwgImYxIiwgImYyIiwgImYzIiwgImY0IiwgImY1IiwgImY2IiwgImY3IiwgImY4IiwgImY5IiwgImZhIiwgImZiIiwgImZjIiwgImZkIiwgImZlIiwgImZmIl07CmxldCBSZyA9IDEyMzQ1Njc7CmNvbnN0IEdfID0gTWF0aC5QSSAvIDE4MCwgV18gPSAxODAgLyBNYXRoLlBJOwpmdW5jdGlvbiBKbigpIHsKICBjb25zdCBhID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwLCB0ID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwLCBlID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwLCBpID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIHJldHVybiAodGlbYSAmIDI1NV0gKyB0aVthID4+IDggJiAyNTVdICsgdGlbYSA+PiAxNiAmIDI1NV0gKyB0aVthID4+IDI0ICYgMjU1XSArICItIiArIHRpW3QgJiAyNTVdICsgdGlbdCA+PiA4ICYgMjU1XSArICItIiArIHRpW3QgPj4gMTYgJiAxNSB8IDY0XSArIHRpW3QgPj4gMjQgJiAyNTVdICsgIi0iICsgdGlbZSAmIDYzIHwgMTI4XSArIHRpW2UgPj4gOCAmIDI1NV0gKyAiLSIgKyB0aVtlID4+IDE2ICYgMjU1XSArIHRpW2UgPj4gMjQgJiAyNTVdICsgdGlbaSAmIDI1NV0gKyB0aVtpID4+IDggJiAyNTVdICsgdGlbaSA+PiAxNiAmIDI1NV0gKyB0aVtpID4+IDI0ICYgMjU1XSkudG9Mb3dlckNhc2UoKTsKfQpmdW5jdGlvbiBhaShhLCB0LCBlKSB7CiAgcmV0dXJuIE1hdGgubWF4KHQsIE1hdGgubWluKGUsIGEpKTsKfQpmdW5jdGlvbiB5ZihhLCB0KSB7CiAgcmV0dXJuIChhICUgdCArIHQpICUgdDsKfQpmdW5jdGlvbiBfVChhLCB0LCBlLCBpLCBuKSB7CiAgcmV0dXJuIGkgKyAoYSAtIHQpICogKG4gLSBpKSAvIChlIC0gdCk7Cn0KZnVuY3Rpb24geFQoYSwgdCwgZSkgewogIHJldHVybiBhICE9PSB0ID8gKGUgLSBhKSAvICh0IC0gYSkgOiAwOwp9CmZ1bmN0aW9uIHlvKGEsIHQsIGUpIHsKICByZXR1cm4gKDEgLSBlKSAqIGEgKyBlICogdDsKfQpmdW5jdGlvbiB2VChhLCB0LCBlLCBpKSB7CiAgcmV0dXJuIHlvKGEsIHQsIDEgLSBNYXRoLmV4cCgtZSAqIGkpKTsKfQpmdW5jdGlvbiBiVChhLCB0ID0gMSkgewogIHJldHVybiB0IC0gTWF0aC5hYnMoeWYoYSwgdCAqIDIpIC0gdCk7Cn0KZnVuY3Rpb24gTVQoYSwgdCwgZSkgewogIHJldHVybiBhIDw9IHQgPyAwIDogYSA+PSBlID8gMSA6IChhID0gKGEgLSB0KSAvIChlIC0gdCksIGEgKiBhICogKDMgLSAyICogYSkpOwp9CmZ1bmN0aW9uIFNUKGEsIHQsIGUpIHsKICByZXR1cm4gYSA8PSB0ID8gMCA6IGEgPj0gZSA/IDEgOiAoYSA9IChhIC0gdCkgLyAoZSAtIHQpLCBhICogYSAqIGEgKiAoYSAqIChhICogNiAtIDE1KSArIDEwKSk7Cn0KZnVuY3Rpb24gd1QoYSwgdCkgewogIHJldHVybiBhICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKHQgLSBhICsgMSkpOwp9CmZ1bmN0aW9uIEFUKGEsIHQpIHsKICByZXR1cm4gYSArIE1hdGgucmFuZG9tKCkgKiAodCAtIGEpOwp9CmZ1bmN0aW9uIEVUKGEpIHsKICByZXR1cm4gYSAqICgwLjUgLSBNYXRoLnJhbmRvbSgpKTsKfQpmdW5jdGlvbiBUVChhKSB7CiAgYSAhPT0gdm9pZCAwICYmIChSZyA9IGEpOwogIGxldCB0ID0gUmcgKz0gMTgzMTU2NTgxMzsKICByZXR1cm4gdCA9IE1hdGguaW11bCh0IF4gdCA+Pj4gMTUsIHQgfCAxKSwgdCBePSB0ICsgTWF0aC5pbXVsKHQgXiB0ID4+PiA3LCB0IHwgNjEpLCAoKHQgXiB0ID4+PiAxNCkgPj4+IDApIC8gNDI5NDk2NzI5NjsKfQpmdW5jdGlvbiBDVChhKSB7CiAgcmV0dXJuIGEgKiBHXzsKfQpmdW5jdGlvbiBSVChhKSB7CiAgcmV0dXJuIGEgKiBXXzsKfQpmdW5jdGlvbiBQVChhKSB7CiAgcmV0dXJuIChhICYgYSAtIDEpID09PSAwICYmIGEgIT09IDA7Cn0KZnVuY3Rpb24gSVQoYSkgewogIHJldHVybiBNYXRoLnBvdygyLCBNYXRoLmNlaWwoTWF0aC5sb2coYSkgLyBNYXRoLkxOMikpOwp9CmZ1bmN0aW9uIExUKGEpIHsKICByZXR1cm4gTWF0aC5wb3coMiwgTWF0aC5mbG9vcihNYXRoLmxvZyhhKSAvIE1hdGguTE4yKSk7Cn0KZnVuY3Rpb24gRFQoYSwgdCwgZSwgaSwgbikgewogIGNvbnN0IHMgPSBNYXRoLmNvcywgciA9IE1hdGguc2luLCBvID0gcyhlIC8gMiksIGwgPSByKGUgLyAyKSwgaCA9IHMoKHQgKyBpKSAvIDIpLCBjID0gcigodCArIGkpIC8gMiksIHUgPSBzKCh0IC0gaSkgLyAyKSwgZCA9IHIoKHQgLSBpKSAvIDIpLCBwID0gcygoaSAtIHQpIC8gMiksIGYgPSByKChpIC0gdCkgLyAyKTsKICBzd2l0Y2ggKG4pIHsKICAgIGNhc2UgIlhZWCI6CiAgICAgIGEuc2V0KG8gKiBjLCBsICogdSwgbCAqIGQsIG8gKiBoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJZWlkiOgogICAgICBhLnNldChsICogZCwgbyAqIGMsIGwgKiB1LCBvICogaCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWlhaIjoKICAgICAgYS5zZXQobCAqIHUsIGwgKiBkLCBvICogYywgbyAqIGgpOwogICAgICBicmVhazsKICAgIGNhc2UgIlhaWCI6CiAgICAgIGEuc2V0KG8gKiBjLCBsICogZiwgbCAqIHAsIG8gKiBoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJZWFkiOgogICAgICBhLnNldChsICogcCwgbyAqIGMsIGwgKiBmLCBvICogaCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWllaIjoKICAgICAgYS5zZXQobCAqIGYsIGwgKiBwLCBvICogYywgbyAqIGgpOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuTWF0aFV0aWxzOiAuc2V0UXVhdGVybmlvbkZyb21Qcm9wZXJFdWxlcigpIGVuY291bnRlcmVkIGFuIHVua25vd24gb3JkZXI6ICIgKyBuKTsKICB9Cn0KZnVuY3Rpb24gaG4oYSwgdCkgewogIHN3aXRjaCAodC5jb25zdHJ1Y3RvcikgewogICAgY2FzZSBGbG9hdDMyQXJyYXk6CiAgICAgIHJldHVybiBhOwogICAgY2FzZSBVaW50MzJBcnJheToKICAgICAgcmV0dXJuIGEgLyA0Mjk0OTY3Mjk1OwogICAgY2FzZSBVaW50MTZBcnJheToKICAgICAgcmV0dXJuIGEgLyA2NTUzNTsKICAgIGNhc2UgVWludDhBcnJheToKICAgICAgcmV0dXJuIGEgLyAyNTU7CiAgICBjYXNlIEludDMyQXJyYXk6CiAgICAgIHJldHVybiBNYXRoLm1heChhIC8gMjE0NzQ4MzY0NywgLTEpOwogICAgY2FzZSBJbnQxNkFycmF5OgogICAgICByZXR1cm4gTWF0aC5tYXgoYSAvIDMyNzY3LCAtMSk7CiAgICBjYXNlIEludDhBcnJheToKICAgICAgcmV0dXJuIE1hdGgubWF4KGEgLyAxMjcsIC0xKTsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBjb21wb25lbnQgdHlwZS4iKTsKICB9Cn0KZnVuY3Rpb24gdWUoYSwgdCkgewogIHN3aXRjaCAodC5jb25zdHJ1Y3RvcikgewogICAgY2FzZSBGbG9hdDMyQXJyYXk6CiAgICAgIHJldHVybiBhOwogICAgY2FzZSBVaW50MzJBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYSAqIDQyOTQ5NjcyOTUpOwogICAgY2FzZSBVaW50MTZBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYSAqIDY1NTM1KTsKICAgIGNhc2UgVWludDhBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYSAqIDI1NSk7CiAgICBjYXNlIEludDMyQXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiAyMTQ3NDgzNjQ3KTsKICAgIGNhc2UgSW50MTZBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQoYSAqIDMyNzY3KTsKICAgIGNhc2UgSW50OEFycmF5OgogICAgICByZXR1cm4gTWF0aC5yb3VuZChhICogMTI3KTsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBjb21wb25lbnQgdHlwZS4iKTsKICB9Cn0KY29uc3QgRlQgPSB7CiAgREVHMlJBRDogR18sCiAgUkFEMkRFRzogV18sCiAgZ2VuZXJhdGVVVUlEOiBKbiwKICBjbGFtcDogYWksCiAgZXVjbGlkZWFuTW9kdWxvOiB5ZiwKICBtYXBMaW5lYXI6IF9ULAogIGludmVyc2VMZXJwOiB4VCwKICBsZXJwOiB5bywKICBkYW1wOiB2VCwKICBwaW5ncG9uZzogYlQsCiAgc21vb3Roc3RlcDogTVQsCiAgc21vb3RoZXJzdGVwOiBTVCwKICByYW5kSW50OiB3VCwKICByYW5kRmxvYXQ6IEFULAogIHJhbmRGbG9hdFNwcmVhZDogRVQsCiAgc2VlZGVkUmFuZG9tOiBUVCwKICBkZWdUb1JhZDogQ1QsCiAgcmFkVG9EZWc6IFJULAogIGlzUG93ZXJPZlR3bzogUFQsCiAgY2VpbFBvd2VyT2ZUd286IElULAogIGZsb29yUG93ZXJPZlR3bzogTFQsCiAgc2V0UXVhdGVybmlvbkZyb21Qcm9wZXJFdWxlcjogRFQsCiAgbm9ybWFsaXplOiB1ZSwKICBkZW5vcm1hbGl6ZTogaG4KfTsKbGV0IF9pID0gY2xhc3MgcV8gewogIGNvbnN0cnVjdG9yKHQgPSAwLCBlID0gMCkgewogICAgcV8ucHJvdG90eXBlLmlzVmVjdG9yMiA9ICEwLCB0aGlzLnggPSB0LCB0aGlzLnkgPSBlOwogIH0KICBnZXQgd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy54OwogIH0KICBzZXQgd2lkdGgodCkgewogICAgdGhpcy54ID0gdDsKICB9CiAgZ2V0IGhlaWdodCgpIHsKICAgIHJldHVybiB0aGlzLnk7CiAgfQogIHNldCBoZWlnaHQodCkgewogICAgdGhpcy55ID0gdDsKICB9CiAgc2V0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzLnkgPSBlLCB0aGlzOwogIH0KICBzZXRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQsIHRoaXMueSA9IHQsIHRoaXM7CiAgfQogIHNldFgodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQsIHRoaXM7CiAgfQogIHNldFkodCkgewogICAgcmV0dXJuIHRoaXMueSA9IHQsIHRoaXM7CiAgfQogIHNldENvbXBvbmVudCh0LCBlKSB7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMueCA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSBlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgZ2V0Q29tcG9uZW50KHQpIHsKICAgIHN3aXRjaCAodCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyB0KTsKICAgIH0KICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy54LCB0aGlzLnkpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LngsIHRoaXMueSA9IHQueSwgdGhpczsKICB9CiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54LCB0aGlzLnkgKz0gdC55LCB0aGlzOwogIH0KICBhZGRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCArPSB0LCB0aGlzLnkgKz0gdCwgdGhpczsKICB9CiAgYWRkVmVjdG9ycyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54ICsgZS54LCB0aGlzLnkgPSB0LnkgKyBlLnksIHRoaXM7CiAgfQogIGFkZFNjYWxlZFZlY3Rvcih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQueCAqIGUsIHRoaXMueSArPSB0LnkgKiBlLCB0aGlzOwogIH0KICBzdWIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LngsIHRoaXMueSAtPSB0LnksIHRoaXM7CiAgfQogIHN1YlNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54IC09IHQsIHRoaXMueSAtPSB0LCB0aGlzOwogIH0KICBzdWJWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggLSBlLngsIHRoaXMueSA9IHQueSAtIGUueSwgdGhpczsKICB9CiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LngsIHRoaXMueSAqPSB0LnksIHRoaXM7CiAgfQogIG11bHRpcGx5U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggKj0gdCwgdGhpcy55ICo9IHQsIHRoaXM7CiAgfQogIGRpdmlkZSh0KSB7CiAgICByZXR1cm4gdGhpcy54IC89IHQueCwgdGhpcy55IC89IHQueSwgdGhpczsKICB9CiAgZGl2aWRlU2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5U2NhbGFyKDEgLyB0KTsKICB9CiAgYXBwbHlNYXRyaXgzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMueCA9IG5bMF0gKiBlICsgblszXSAqIGkgKyBuWzZdLCB0aGlzLnkgPSBuWzFdICogZSArIG5bNF0gKiBpICsgbls3XSwgdGhpczsKICB9CiAgbWluKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1pbih0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdC55KSwgdGhpczsKICB9CiAgbWF4KHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1heCh0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWF4KHRoaXMueSwgdC55KSwgdGhpczsKICB9CiAgY2xhbXAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWF4KHQueCwgTWF0aC5taW4oZS54LCB0aGlzLngpKSwgdGhpcy55ID0gTWF0aC5tYXgodC55LCBNYXRoLm1pbihlLnksIHRoaXMueSkpLCB0aGlzOwogIH0KICBjbGFtcFNjYWxhcih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5tYXgodCwgTWF0aC5taW4oZSwgdGhpcy54KSksIHRoaXMueSA9IE1hdGgubWF4KHQsIE1hdGgubWluKGUsIHRoaXMueSkpLCB0aGlzOwogIH0KICBjbGFtcExlbmd0aCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcihpIHx8IDEpLm11bHRpcGx5U2NhbGFyKE1hdGgubWF4KHQsIE1hdGgubWluKGUsIGkpKSk7CiAgfQogIGZsb29yKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KSwgdGhpcy55ID0gTWF0aC5mbG9vcih0aGlzLnkpLCB0aGlzOwogIH0KICBjZWlsKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGguY2VpbCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KSwgdGhpczsKICB9CiAgcm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yb3VuZCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnJvdW5kKHRoaXMueSksIHRoaXM7CiAgfQogIHJvdW5kVG9aZXJvKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KSwgdGhpcy55ID0gTWF0aC50cnVuYyh0aGlzLnkpLCB0aGlzOwogIH0KICBuZWdhdGUoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gLXRoaXMueCwgdGhpcy55ID0gLXRoaXMueSwgdGhpczsKICB9CiAgZG90KHQpIHsKICAgIHJldHVybiB0aGlzLnggKiB0LnggKyB0aGlzLnkgKiB0Lnk7CiAgfQogIGNyb3NzKHQpIHsKICAgIHJldHVybiB0aGlzLnggKiB0LnkgLSB0aGlzLnkgKiB0Lng7CiAgfQogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueTsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkpOwogIH0KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSk7CiAgfQogIG5vcm1hbGl6ZSgpIHsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcih0aGlzLmxlbmd0aCgpIHx8IDEpOwogIH0KICBhbmdsZSgpIHsKICAgIHJldHVybiBNYXRoLmF0YW4yKC10aGlzLnksIC10aGlzLngpICsgTWF0aC5QSTsKICB9CiAgYW5nbGVUbyh0KSB7CiAgICBjb25zdCBlID0gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3EoKSAqIHQubGVuZ3RoU3EoKSk7CiAgICBpZiAoZSA9PT0gMCkgcmV0dXJuIE1hdGguUEkgLyAyOwogICAgY29uc3QgaSA9IHRoaXMuZG90KHQpIC8gZTsKICAgIHJldHVybiBNYXRoLmFjb3MoYWkoaSwgLTEsIDEpKTsKICB9CiAgZGlzdGFuY2VUbyh0KSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuZGlzdGFuY2VUb1NxdWFyZWQodCkpOwogIH0KICBkaXN0YW5jZVRvU3F1YXJlZCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy54IC0gdC54LCBpID0gdGhpcy55IC0gdC55OwogICAgcmV0dXJuIGUgKiBlICsgaSAqIGk7CiAgfQogIG1hbmhhdHRhbkRpc3RhbmNlVG8odCkgewogICAgcmV0dXJuIE1hdGguYWJzKHRoaXMueCAtIHQueCkgKyBNYXRoLmFicyh0aGlzLnkgLSB0LnkpOwogIH0KICBzZXRMZW5ndGgodCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIodCk7CiAgfQogIGxlcnAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCArPSAodC54IC0gdGhpcy54KSAqIGUsIHRoaXMueSArPSAodC55IC0gdGhpcy55KSAqIGUsIHRoaXM7CiAgfQogIGxlcnBWZWN0b3JzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKyAoZS54IC0gdC54KSAqIGksIHRoaXMueSA9IHQueSArIChlLnkgLSB0LnkpICogaSwgdGhpczsKICB9CiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0LnggPT09IHRoaXMueCAmJiB0LnkgPT09IHRoaXMueTsKICB9CiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdFtlXSwgdGhpcy55ID0gdFtlICsgMV0sIHRoaXM7CiAgfQogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgcmV0dXJuIHRbZV0gPSB0aGlzLngsIHRbZSArIDFdID0gdGhpcy55LCB0OwogIH0KICBmcm9tQnVmZmVyQXR0cmlidXRlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LmdldFgoZSksIHRoaXMueSA9IHQuZ2V0WShlKSwgdGhpczsKICB9CiAgcm90YXRlQXJvdW5kKHQsIGUpIHsKICAgIGNvbnN0IGkgPSBNYXRoLmNvcyhlKSwgbiA9IE1hdGguc2luKGUpLCBzID0gdGhpcy54IC0gdC54LCByID0gdGhpcy55IC0gdC55OwogICAgcmV0dXJuIHRoaXMueCA9IHMgKiBpIC0gciAqIG4gKyB0LngsIHRoaXMueSA9IHMgKiBuICsgciAqIGkgKyB0LnksIHRoaXM7CiAgfQogIHJhbmRvbSgpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLnJhbmRvbSgpLCB0aGlzLnkgPSBNYXRoLnJhbmRvbSgpLCB0aGlzOwogIH0KICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICB5aWVsZCB0aGlzLngsIHlpZWxkIHRoaXMueTsKICB9Cn0sIGRlID0gY2xhc3MgJF8gewogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgpIHsKICAgICRfLnByb3RvdHlwZS5pc01hdHJpeDMgPSAhMCwgdGhpcy5lbGVtZW50cyA9IFsKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgXSwgdCAhPT0gdm9pZCAwICYmIHRoaXMuc2V0KHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgpOwogIH0KICBzZXQodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCkgewogICAgY29uc3QgYyA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gY1swXSA9IHQsIGNbMV0gPSBuLCBjWzJdID0gbywgY1szXSA9IGUsIGNbNF0gPSBzLCBjWzVdID0gbCwgY1s2XSA9IGksIGNbN10gPSByLCBjWzhdID0gaCwgdGhpczsKICB9CiAgaWRlbnRpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIGNvcHkodCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHMsIGkgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIGVbMF0gPSBpWzBdLCBlWzFdID0gaVsxXSwgZVsyXSA9IGlbMl0sIGVbM10gPSBpWzNdLCBlWzRdID0gaVs0XSwgZVs1XSA9IGlbNV0sIGVbNl0gPSBpWzZdLCBlWzddID0gaVs3XSwgZVs4XSA9IGlbOF0sIHRoaXM7CiAgfQogIGV4dHJhY3RCYXNpcyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdC5zZXRGcm9tTWF0cml4M0NvbHVtbih0aGlzLCAwKSwgZS5zZXRGcm9tTWF0cml4M0NvbHVtbih0aGlzLCAxKSwgaS5zZXRGcm9tTWF0cml4M0NvbHVtbih0aGlzLCAyKSwgdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeDQodCkgewogICAgY29uc3QgZSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGVbMF0sCiAgICAgIGVbNF0sCiAgICAgIGVbOF0sCiAgICAgIGVbMV0sCiAgICAgIGVbNV0sCiAgICAgIGVbOV0sCiAgICAgIGVbMl0sCiAgICAgIGVbNl0sCiAgICAgIGVbMTBdCiAgICApLCB0aGlzOwogIH0KICBtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHRoaXMsIHQpOwogIH0KICBwcmVtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHQsIHRoaXMpOwogIH0KICBtdWx0aXBseU1hdHJpY2VzKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0LmVsZW1lbnRzLCBuID0gZS5lbGVtZW50cywgcyA9IHRoaXMuZWxlbWVudHMsIHIgPSBpWzBdLCBvID0gaVszXSwgbCA9IGlbNl0sIGggPSBpWzFdLCBjID0gaVs0XSwgdSA9IGlbN10sIGQgPSBpWzJdLCBwID0gaVs1XSwgZiA9IGlbOF0sIHkgPSBuWzBdLCBnID0gblszXSwgbSA9IG5bNl0sIHYgPSBuWzFdLCB4ID0gbls0XSwgXyA9IG5bN10sIFMgPSBuWzJdLCB3ID0gbls1XSwgVCA9IG5bOF07CiAgICByZXR1cm4gc1swXSA9IHIgKiB5ICsgbyAqIHYgKyBsICogUywgc1szXSA9IHIgKiBnICsgbyAqIHggKyBsICogdywgc1s2XSA9IHIgKiBtICsgbyAqIF8gKyBsICogVCwgc1sxXSA9IGggKiB5ICsgYyAqIHYgKyB1ICogUywgc1s0XSA9IGggKiBnICsgYyAqIHggKyB1ICogdywgc1s3XSA9IGggKiBtICsgYyAqIF8gKyB1ICogVCwgc1syXSA9IGQgKiB5ICsgcCAqIHYgKyBmICogUywgc1s1XSA9IGQgKiBnICsgcCAqIHggKyBmICogdywgc1s4XSA9IGQgKiBtICsgcCAqIF8gKyBmICogVCwgdGhpczsKICB9CiAgbXVsdGlwbHlTY2FsYXIodCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gZVswXSAqPSB0LCBlWzNdICo9IHQsIGVbNl0gKj0gdCwgZVsxXSAqPSB0LCBlWzRdICo9IHQsIGVbN10gKj0gdCwgZVsyXSAqPSB0LCBlWzVdICo9IHQsIGVbOF0gKj0gdCwgdGhpczsKICB9CiAgZGV0ZXJtaW5hbnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0sIGkgPSB0WzFdLCBuID0gdFsyXSwgcyA9IHRbM10sIHIgPSB0WzRdLCBvID0gdFs1XSwgbCA9IHRbNl0sIGggPSB0WzddLCBjID0gdFs4XTsKICAgIHJldHVybiBlICogciAqIGMgLSBlICogbyAqIGggLSBpICogcyAqIGMgKyBpICogbyAqIGwgKyBuICogcyAqIGggLSBuICogciAqIGw7CiAgfQogIGludmVydCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmVsZW1lbnRzLCBlID0gdFswXSwgaSA9IHRbMV0sIG4gPSB0WzJdLCBzID0gdFszXSwgciA9IHRbNF0sIG8gPSB0WzVdLCBsID0gdFs2XSwgaCA9IHRbN10sIGMgPSB0WzhdLCB1ID0gYyAqIHIgLSBvICogaCwgZCA9IG8gKiBsIC0gYyAqIHMsIHAgPSBoICogcyAtIHIgKiBsLCBmID0gZSAqIHUgKyBpICogZCArIG4gKiBwOwogICAgaWYgKGYgPT09IDApIHJldHVybiB0aGlzLnNldCgwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKTsKICAgIGNvbnN0IHkgPSAxIC8gZjsKICAgIHJldHVybiB0WzBdID0gdSAqIHksIHRbMV0gPSAobiAqIGggLSBjICogaSkgKiB5LCB0WzJdID0gKG8gKiBpIC0gbiAqIHIpICogeSwgdFszXSA9IGQgKiB5LCB0WzRdID0gKGMgKiBlIC0gbiAqIGwpICogeSwgdFs1XSA9IChuICogcyAtIG8gKiBlKSAqIHksIHRbNl0gPSBwICogeSwgdFs3XSA9IChpICogbCAtIGggKiBlKSAqIHksIHRbOF0gPSAociAqIGUgLSBpICogcykgKiB5LCB0aGlzOwogIH0KICB0cmFuc3Bvc2UoKSB7CiAgICBsZXQgdDsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIHQgPSBlWzFdLCBlWzFdID0gZVszXSwgZVszXSA9IHQsIHQgPSBlWzJdLCBlWzJdID0gZVs2XSwgZVs2XSA9IHQsIHQgPSBlWzVdLCBlWzVdID0gZVs3XSwgZVs3XSA9IHQsIHRoaXM7CiAgfQogIGdldE5vcm1hbE1hdHJpeCh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tTWF0cml4NCh0KS5pbnZlcnQoKS50cmFuc3Bvc2UoKTsKICB9CiAgdHJhbnNwb3NlSW50b0FycmF5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIHRbMF0gPSBlWzBdLCB0WzFdID0gZVszXSwgdFsyXSA9IGVbNl0sIHRbM10gPSBlWzFdLCB0WzRdID0gZVs0XSwgdFs1XSA9IGVbN10sIHRbNl0gPSBlWzJdLCB0WzddID0gZVs1XSwgdFs4XSA9IGVbOF0sIHRoaXM7CiAgfQogIHNldFV2VHJhbnNmb3JtKHQsIGUsIGksIG4sIHMsIHIsIG8pIHsKICAgIGNvbnN0IGwgPSBNYXRoLmNvcyhzKSwgaCA9IE1hdGguc2luKHMpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBpICogbCwKICAgICAgaSAqIGgsCiAgICAgIC1pICogKGwgKiByICsgaCAqIG8pICsgciArIHQsCiAgICAgIC1uICogaCwKICAgICAgbiAqIGwsCiAgICAgIC1uICogKC1oICogciArIGwgKiBvKSArIG8gKyBlLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvLwogIHNjYWxlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnByZW11bHRpcGx5KHlkLm1ha2VTY2FsZSh0LCBlKSksIHRoaXM7CiAgfQogIHJvdGF0ZSh0KSB7CiAgICByZXR1cm4gdGhpcy5wcmVtdWx0aXBseSh5ZC5tYWtlUm90YXRpb24oLXQpKSwgdGhpczsKICB9CiAgdHJhbnNsYXRlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnByZW11bHRpcGx5KHlkLm1ha2VUcmFuc2xhdGlvbih0LCBlKSksIHRoaXM7CiAgfQogIC8vIGZvciAyRCBUcmFuc2Zvcm1zCiAgbWFrZVRyYW5zbGF0aW9uKHQsIGUpIHsKICAgIHJldHVybiB0LmlzVmVjdG9yMiA/IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICB0LngsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIHQueSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSA6IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICB0LAogICAgICAwLAogICAgICAxLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICBtYWtlUm90YXRpb24odCkgewogICAgY29uc3QgZSA9IE1hdGguY29zKHQpLCBpID0gTWF0aC5zaW4odCk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGUsCiAgICAgIC1pLAogICAgICAwLAogICAgICBpLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICBtYWtlU2NhbGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICB0LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvLwogIGVxdWFscyh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQuZWxlbWVudHM7CiAgICBmb3IgKGxldCBuID0gMDsgbiA8IDk7IG4rKykKICAgICAgaWYgKGVbbl0gIT09IGlbbl0pIHJldHVybiAhMTsKICAgIHJldHVybiAhMDsKICB9CiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDk7IGkrKykKICAgICAgdGhpcy5lbGVtZW50c1tpXSA9IHRbaSArIGVdOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgY29uc3QgaSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdFtlXSA9IGlbMF0sIHRbZSArIDFdID0gaVsxXSwgdFtlICsgMl0gPSBpWzJdLCB0W2UgKyAzXSA9IGlbM10sIHRbZSArIDRdID0gaVs0XSwgdFtlICsgNV0gPSBpWzVdLCB0W2UgKyA2XSA9IGlbNl0sIHRbZSArIDddID0gaVs3XSwgdFtlICsgOF0gPSBpWzhdLCB0OwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmZyb21BcnJheSh0aGlzLmVsZW1lbnRzKTsKICB9Cn07CmNvbnN0IHlkID0gLyogQF9fUFVSRV9fICovIG5ldyBkZSgpOwpmdW5jdGlvbiBVVChhKSB7CiAgZm9yIChsZXQgdCA9IGEubGVuZ3RoIC0gMTsgdCA+PSAwOyAtLXQpCiAgICBpZiAoYVt0XSA+PSA2NTUzNSkgcmV0dXJuICEwOwogIHJldHVybiAhMTsKfQpmdW5jdGlvbiBQZyhhKSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIsIGEpOwp9CmNvbnN0IFdpID0gewogIGVuYWJsZWQ6ICEwLAogIHdvcmtpbmdDb2xvclNwYWNlOiBWXywKICAvKioKICAgKiBJbXBsZW1lbnRhdGlvbnMgb2Ygc3VwcG9ydGVkIGNvbG9yIHNwYWNlcy4KICAgKgogICAqIFJlcXVpcmVkOgogICAqCS0gcHJpbWFyaWVzOiBjaHJvbWF0aWNpdHkgY29vcmRpbmF0ZXMgWyByeCByeSBneCBneSBieCBieSBdCiAgICoJLSB3aGl0ZVBvaW50OiByZWZlcmVuY2Ugd2hpdGUgWyB4IHkgXQogICAqCS0gdHJhbnNmZXI6IHRyYW5zZmVyIGZ1bmN0aW9uIChwcmUtZGVmaW5lZCkKICAgKgktIHRvWFlaOiBNYXRyaXgzIFJHQiB0byBYWVogdHJhbnNmb3JtCiAgICoJLSBmcm9tWFlaOiBNYXRyaXgzIFhZWiB0byBSR0IgdHJhbnNmb3JtCiAgICoJLSBsdW1pbmFuY2VDb2VmZmljaWVudHM6IFJHQiBsdW1pbmFuY2UgY29lZmZpY2llbnRzCiAgICoKICAgKiBPcHRpb25hbDoKICAgKiAgLSBvdXRwdXRDb2xvclNwYWNlQ29uZmlnOiB7IGRyYXdpbmdCdWZmZXJDb2xvclNwYWNlOiBDb2xvclNwYWNlIH0KICAgKiAgLSB3b3JraW5nQ29sb3JTcGFjZUNvbmZpZzogeyB1bnBhY2tDb2xvclNwYWNlOiBDb2xvclNwYWNlIH0KICAgKgogICAqIFJlZmVyZW5jZToKICAgKiAtIGh0dHBzOi8vd3d3LnJ1c3NlbGxjb3R0cmVsbC5jb20vcGhvdG8vbWF0cml4Q2FsY3VsYXRvci5odG0KICAgKi8KICBzcGFjZXM6IHt9LAogIGNvbnZlcnQ6IGZ1bmN0aW9uKGEsIHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmVuYWJsZWQgPT09ICExIHx8IHQgPT09IGUgfHwgIXQgfHwgIWUgfHwgKHRoaXMuc3BhY2VzW3RdLnRyYW5zZmVyID09PSBfcCAmJiAoYS5yID0gS24oYS5yKSwgYS5nID0gS24oYS5nKSwgYS5iID0gS24oYS5iKSksIHRoaXMuc3BhY2VzW3RdLnByaW1hcmllcyAhPT0gdGhpcy5zcGFjZXNbZV0ucHJpbWFyaWVzICYmIChhLmFwcGx5TWF0cml4Myh0aGlzLnNwYWNlc1t0XS50b1hZWiksIGEuYXBwbHlNYXRyaXgzKHRoaXMuc3BhY2VzW2VdLmZyb21YWVopKSwgdGhpcy5zcGFjZXNbZV0udHJhbnNmZXIgPT09IF9wICYmIChhLnIgPSBoYShhLnIpLCBhLmcgPSBoYShhLmcpLCBhLmIgPSBoYShhLmIpKSksIGE7CiAgfSwKICBmcm9tV29ya2luZ0NvbG9yU3BhY2U6IGZ1bmN0aW9uKGEsIHQpIHsKICAgIHJldHVybiB0aGlzLmNvbnZlcnQoYSwgdGhpcy53b3JraW5nQ29sb3JTcGFjZSwgdCk7CiAgfSwKICB0b1dvcmtpbmdDb2xvclNwYWNlOiBmdW5jdGlvbihhLCB0KSB7CiAgICByZXR1cm4gdGhpcy5jb252ZXJ0KGEsIHQsIHRoaXMud29ya2luZ0NvbG9yU3BhY2UpOwogIH0sCiAgZ2V0UHJpbWFyaWVzOiBmdW5jdGlvbihhKSB7CiAgICByZXR1cm4gdGhpcy5zcGFjZXNbYV0ucHJpbWFyaWVzOwogIH0sCiAgZ2V0VHJhbnNmZXI6IGZ1bmN0aW9uKGEpIHsKICAgIHJldHVybiBhID09PSBrXyA/IEhfIDogdGhpcy5zcGFjZXNbYV0udHJhbnNmZXI7CiAgfSwKICBnZXRMdW1pbmFuY2VDb2VmZmljaWVudHM6IGZ1bmN0aW9uKGEsIHQgPSB0aGlzLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICByZXR1cm4gYS5mcm9tQXJyYXkodGhpcy5zcGFjZXNbdF0ubHVtaW5hbmNlQ29lZmZpY2llbnRzKTsKICB9LAogIGRlZmluZTogZnVuY3Rpb24oYSkgewogICAgT2JqZWN0LmFzc2lnbih0aGlzLnNwYWNlcywgYSk7CiAgfSwKICAvLyBJbnRlcm5hbCBBUElzCiAgX2dldE1hdHJpeDogZnVuY3Rpb24oYSwgdCwgZSkgewogICAgcmV0dXJuIGEuY29weSh0aGlzLnNwYWNlc1t0XS50b1hZWikubXVsdGlwbHkodGhpcy5zcGFjZXNbZV0uZnJvbVhZWik7CiAgfSwKICBfZ2V0RHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U6IGZ1bmN0aW9uKGEpIHsKICAgIHJldHVybiB0aGlzLnNwYWNlc1thXS5vdXRwdXRDb2xvclNwYWNlQ29uZmlnLmRyYXdpbmdCdWZmZXJDb2xvclNwYWNlOwogIH0sCiAgX2dldFVucGFja0NvbG9yU3BhY2U6IGZ1bmN0aW9uKGEgPSB0aGlzLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICByZXR1cm4gdGhpcy5zcGFjZXNbYV0ud29ya2luZ0NvbG9yU3BhY2VDb25maWcudW5wYWNrQ29sb3JTcGFjZTsKICB9Cn07CmZ1bmN0aW9uIEtuKGEpIHsKICByZXR1cm4gYSA8IDAuMDQwNDUgPyBhICogMC4wNzczOTkzODA4IDogTWF0aC5wb3coYSAqIDAuOTQ3ODY3Mjk4NiArIDAuMDUyMTMyNzAxNCwgMi40KTsKfQpmdW5jdGlvbiBoYShhKSB7CiAgcmV0dXJuIGEgPCAzMTMwOGUtNyA/IGEgKiAxMi45MiA6IDEuMDU1ICogTWF0aC5wb3coYSwgMC40MTY2NikgLSAwLjA1NTsKfQpjb25zdCBJZyA9IFswLjY0LCAwLjMzLCAwLjMsIDAuNiwgMC4xNSwgMC4wNl0sIExnID0gWzAuMjEyNiwgMC43MTUyLCAwLjA3MjJdLCBEZyA9IFswLjMxMjcsIDAuMzI5XSwgRmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkuc2V0KAogIDAuNDEyMzkwOCwKICAwLjM1NzU4NDMsCiAgMC4xODA0ODA4LAogIDAuMjEyNjM5LAogIDAuNzE1MTY4NywKICAwLjA3MjE5MjMsCiAgMC4wMTkzMzA4LAogIDAuMTE5MTk0OCwKICAwLjk1MDUzMjIKKSwgVWcgPSAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkuc2V0KAogIDMuMjQwOTY5OSwKICAtMS41MzczODMyLAogIC0wLjQ5ODYxMDgsCiAgLTAuOTY5MjQzNiwKICAxLjg3NTk2NzUsCiAgMC4wNDE1NTUxLAogIDAuMDU1NjMwMSwKICAtMC4yMDM5NzcsCiAgMS4wNTY5NzE1Cik7CldpLmRlZmluZSh7CiAgW1ZfXTogewogICAgcHJpbWFyaWVzOiBJZywKICAgIHdoaXRlUG9pbnQ6IERnLAogICAgdHJhbnNmZXI6IEhfLAogICAgdG9YWVo6IEZnLAogICAgZnJvbVhZWjogVWcsCiAgICBsdW1pbmFuY2VDb2VmZmljaWVudHM6IExnLAogICAgd29ya2luZ0NvbG9yU3BhY2VDb25maWc6IHsgdW5wYWNrQ29sb3JTcGFjZTogYW4gfSwKICAgIG91dHB1dENvbG9yU3BhY2VDb25maWc6IHsgZHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U6IGFuIH0KICB9LAogIFthbl06IHsKICAgIHByaW1hcmllczogSWcsCiAgICB3aGl0ZVBvaW50OiBEZywKICAgIHRyYW5zZmVyOiBfcCwKICAgIHRvWFlaOiBGZywKICAgIGZyb21YWVo6IFVnLAogICAgbHVtaW5hbmNlQ29lZmZpY2llbnRzOiBMZywKICAgIG91dHB1dENvbG9yU3BhY2VDb25maWc6IHsgZHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U6IGFuIH0KICB9Cn0pOwpsZXQgSHIsIEJUID0gY2xhc3MgewogIHN0YXRpYyBnZXREYXRhVVJMKHQpIHsKICAgIGlmICgvXmRhdGE6L2kudGVzdCh0LnNyYykgfHwgdHlwZW9mIEhUTUxDYW52YXNFbGVtZW50ID4gInUiKQogICAgICByZXR1cm4gdC5zcmM7CiAgICBsZXQgZTsKICAgIGlmICh0IGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpCiAgICAgIGUgPSB0OwogICAgZWxzZSB7CiAgICAgIEhyID09PSB2b2lkIDAgJiYgKEhyID0gUGcoImNhbnZhcyIpKSwgSHIud2lkdGggPSB0LndpZHRoLCBIci5oZWlnaHQgPSB0LmhlaWdodDsKICAgICAgY29uc3QgaSA9IEhyLmdldENvbnRleHQoIjJkIik7CiAgICAgIHQgaW5zdGFuY2VvZiBJbWFnZURhdGEgPyBpLnB1dEltYWdlRGF0YSh0LCAwLCAwKSA6IGkuZHJhd0ltYWdlKHQsIDAsIDAsIHQud2lkdGgsIHQuaGVpZ2h0KSwgZSA9IEhyOwogICAgfQogICAgcmV0dXJuIGUud2lkdGggPiAyMDQ4IHx8IGUuaGVpZ2h0ID4gMjA0OCA/IChjb25zb2xlLndhcm4oIlRIUkVFLkltYWdlVXRpbHMuZ2V0RGF0YVVSTDogSW1hZ2UgY29udmVydGVkIHRvIGpwZyBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucyIsIHQpLCBlLnRvRGF0YVVSTCgiaW1hZ2UvanBlZyIsIDAuNikpIDogZS50b0RhdGFVUkwoImltYWdlL3BuZyIpOwogIH0KICBzdGF0aWMgc1JHQlRvTGluZWFyKHQpIHsKICAgIGlmICh0eXBlb2YgSFRNTEltYWdlRWxlbWVudCA8ICJ1IiAmJiB0IGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCB8fCB0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgPCAidSIgJiYgdCBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50IHx8IHR5cGVvZiBJbWFnZUJpdG1hcCA8ICJ1IiAmJiB0IGluc3RhbmNlb2YgSW1hZ2VCaXRtYXApIHsKICAgICAgY29uc3QgZSA9IFBnKCJjYW52YXMiKTsKICAgICAgZS53aWR0aCA9IHQud2lkdGgsIGUuaGVpZ2h0ID0gdC5oZWlnaHQ7CiAgICAgIGNvbnN0IGkgPSBlLmdldENvbnRleHQoIjJkIik7CiAgICAgIGkuZHJhd0ltYWdlKHQsIDAsIDAsIHQud2lkdGgsIHQuaGVpZ2h0KTsKICAgICAgY29uc3QgbiA9IGkuZ2V0SW1hZ2VEYXRhKDAsIDAsIHQud2lkdGgsIHQuaGVpZ2h0KSwgcyA9IG4uZGF0YTsKICAgICAgZm9yIChsZXQgciA9IDA7IHIgPCBzLmxlbmd0aDsgcisrKQogICAgICAgIHNbcl0gPSBLbihzW3JdIC8gMjU1KSAqIDI1NTsKICAgICAgcmV0dXJuIGkucHV0SW1hZ2VEYXRhKG4sIDAsIDApLCBlOwogICAgfSBlbHNlIGlmICh0LmRhdGEpIHsKICAgICAgY29uc3QgZSA9IHQuZGF0YS5zbGljZSgwKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlLmxlbmd0aDsgaSsrKQogICAgICAgIGUgaW5zdGFuY2VvZiBVaW50OEFycmF5IHx8IGUgaW5zdGFuY2VvZiBVaW50OENsYW1wZWRBcnJheSA/IGVbaV0gPSBNYXRoLmZsb29yKEtuKGVbaV0gLyAyNTUpICogMjU1KSA6IGVbaV0gPSBLbihlW2ldKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBlLAogICAgICAgIHdpZHRoOiB0LndpZHRoLAogICAgICAgIGhlaWdodDogdC5oZWlnaHQKICAgICAgfTsKICAgIH0gZWxzZQogICAgICByZXR1cm4gY29uc29sZS53YXJuKCJUSFJFRS5JbWFnZVV0aWxzLnNSR0JUb0xpbmVhcigpOiBVbnN1cHBvcnRlZCBpbWFnZSB0eXBlLiBObyBjb2xvciBzcGFjZSBjb252ZXJzaW9uIGFwcGxpZWQuIiksIHQ7CiAgfQp9LCB6VCA9IDAsIE5UID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHQgPSBudWxsKSB7CiAgICB0aGlzLmlzU291cmNlID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiB6VCsrIH0pLCB0aGlzLnV1aWQgPSBKbigpLCB0aGlzLmRhdGEgPSB0LCB0aGlzLmRhdGFSZWFkeSA9ICEwLCB0aGlzLnZlcnNpb24gPSAwOwogIH0KICBzZXQgbmVlZHNVcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgdGhpcy52ZXJzaW9uKys7CiAgfQogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gdCA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0ID09ICJzdHJpbmciOwogICAgaWYgKCFlICYmIHQuaW1hZ2VzW3RoaXMudXVpZF0gIT09IHZvaWQgMCkKICAgICAgcmV0dXJuIHQuaW1hZ2VzW3RoaXMudXVpZF07CiAgICBjb25zdCBpID0gewogICAgICB1dWlkOiB0aGlzLnV1aWQsCiAgICAgIHVybDogIiIKICAgIH0sIG4gPSB0aGlzLmRhdGE7CiAgICBpZiAobiAhPT0gbnVsbCkgewogICAgICBsZXQgczsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkobikpIHsKICAgICAgICBzID0gW107CiAgICAgICAgZm9yIChsZXQgciA9IDAsIG8gPSBuLmxlbmd0aDsgciA8IG87IHIrKykKICAgICAgICAgIG5bcl0uaXNEYXRhVGV4dHVyZSA/IHMucHVzaChfZChuW3JdLmltYWdlKSkgOiBzLnB1c2goX2QobltyXSkpOwogICAgICB9IGVsc2UKICAgICAgICBzID0gX2Qobik7CiAgICAgIGkudXJsID0gczsKICAgIH0KICAgIHJldHVybiBlIHx8ICh0LmltYWdlc1t0aGlzLnV1aWRdID0gaSksIGk7CiAgfQp9OwpmdW5jdGlvbiBfZChhKSB7CiAgcmV0dXJuIHR5cGVvZiBIVE1MSW1hZ2VFbGVtZW50IDwgInUiICYmIGEgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50IHx8IHR5cGVvZiBIVE1MQ2FudmFzRWxlbWVudCA8ICJ1IiAmJiBhIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQgfHwgdHlwZW9mIEltYWdlQml0bWFwIDwgInUiICYmIGEgaW5zdGFuY2VvZiBJbWFnZUJpdG1hcCA/IEJULmdldERhdGFVUkwoYSkgOiBhLmRhdGEgPyB7CiAgICBkYXRhOiBBcnJheS5mcm9tKGEuZGF0YSksCiAgICB3aWR0aDogYS53aWR0aCwKICAgIGhlaWdodDogYS5oZWlnaHQsCiAgICB0eXBlOiBhLmRhdGEuY29uc3RydWN0b3IubmFtZQogIH0gOiAoY29uc29sZS53YXJuKCJUSFJFRS5UZXh0dXJlOiBVbmFibGUgdG8gc2VyaWFsaXplIFRleHR1cmUuIiksIHt9KTsKfQpsZXQgT1QgPSAwLCBfZiA9IGNsYXNzIFJoIGV4dGVuZHMgY3UgewogIGNvbnN0cnVjdG9yKHQgPSBSaC5ERUZBVUxUX0lNQUdFLCBlID0gUmguREVGQVVMVF9NQVBQSU5HLCBpID0gWWwsIG4gPSBZbCwgcyA9IGRULCByID0gcFQsIG8gPSBnVCwgbCA9IGZULCBoID0gUmguREVGQVVMVF9BTklTT1RST1BZLCBjID0ga18pIHsKICAgIHN1cGVyKCksIHRoaXMuaXNUZXh0dXJlID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiBPVCsrIH0pLCB0aGlzLnV1aWQgPSBKbigpLCB0aGlzLm5hbWUgPSAiIiwgdGhpcy5zb3VyY2UgPSBuZXcgTlQodCksIHRoaXMubWlwbWFwcyA9IFtdLCB0aGlzLm1hcHBpbmcgPSBlLCB0aGlzLmNoYW5uZWwgPSAwLCB0aGlzLndyYXBTID0gaSwgdGhpcy53cmFwVCA9IG4sIHRoaXMubWFnRmlsdGVyID0gcywgdGhpcy5taW5GaWx0ZXIgPSByLCB0aGlzLmFuaXNvdHJvcHkgPSBoLCB0aGlzLmZvcm1hdCA9IG8sIHRoaXMuaW50ZXJuYWxGb3JtYXQgPSBudWxsLCB0aGlzLnR5cGUgPSBsLCB0aGlzLm9mZnNldCA9IG5ldyBfaSgwLCAwKSwgdGhpcy5yZXBlYXQgPSBuZXcgX2koMSwgMSksIHRoaXMuY2VudGVyID0gbmV3IF9pKDAsIDApLCB0aGlzLnJvdGF0aW9uID0gMCwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gITAsIHRoaXMubWF0cml4ID0gbmV3IGRlKCksIHRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gITAsIHRoaXMucHJlbXVsdGlwbHlBbHBoYSA9ICExLCB0aGlzLmZsaXBZID0gITAsIHRoaXMudW5wYWNrQWxpZ25tZW50ID0gNCwgdGhpcy5jb2xvclNwYWNlID0gYywgdGhpcy51c2VyRGF0YSA9IHt9LCB0aGlzLnZlcnNpb24gPSAwLCB0aGlzLm9uVXBkYXRlID0gbnVsbCwgdGhpcy5pc1JlbmRlclRhcmdldFRleHR1cmUgPSAhMSwgdGhpcy5wbXJlbVZlcnNpb24gPSAwOwogIH0KICBnZXQgaW1hZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5zb3VyY2UuZGF0YTsKICB9CiAgc2V0IGltYWdlKHQgPSBudWxsKSB7CiAgICB0aGlzLnNvdXJjZS5kYXRhID0gdDsKICB9CiAgdXBkYXRlTWF0cml4KCkgewogICAgdGhpcy5tYXRyaXguc2V0VXZUcmFuc2Zvcm0odGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSwgdGhpcy5yZXBlYXQueCwgdGhpcy5yZXBlYXQueSwgdGhpcy5yb3RhdGlvbiwgdGhpcy5jZW50ZXIueCwgdGhpcy5jZW50ZXIueSk7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5uYW1lID0gdC5uYW1lLCB0aGlzLnNvdXJjZSA9IHQuc291cmNlLCB0aGlzLm1pcG1hcHMgPSB0Lm1pcG1hcHMuc2xpY2UoMCksIHRoaXMubWFwcGluZyA9IHQubWFwcGluZywgdGhpcy5jaGFubmVsID0gdC5jaGFubmVsLCB0aGlzLndyYXBTID0gdC53cmFwUywgdGhpcy53cmFwVCA9IHQud3JhcFQsIHRoaXMubWFnRmlsdGVyID0gdC5tYWdGaWx0ZXIsIHRoaXMubWluRmlsdGVyID0gdC5taW5GaWx0ZXIsIHRoaXMuYW5pc290cm9weSA9IHQuYW5pc290cm9weSwgdGhpcy5mb3JtYXQgPSB0LmZvcm1hdCwgdGhpcy5pbnRlcm5hbEZvcm1hdCA9IHQuaW50ZXJuYWxGb3JtYXQsIHRoaXMudHlwZSA9IHQudHlwZSwgdGhpcy5vZmZzZXQuY29weSh0Lm9mZnNldCksIHRoaXMucmVwZWF0LmNvcHkodC5yZXBlYXQpLCB0aGlzLmNlbnRlci5jb3B5KHQuY2VudGVyKSwgdGhpcy5yb3RhdGlvbiA9IHQucm90YXRpb24sIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IHQubWF0cml4QXV0b1VwZGF0ZSwgdGhpcy5tYXRyaXguY29weSh0Lm1hdHJpeCksIHRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gdC5nZW5lcmF0ZU1pcG1hcHMsIHRoaXMucHJlbXVsdGlwbHlBbHBoYSA9IHQucHJlbXVsdGlwbHlBbHBoYSwgdGhpcy5mbGlwWSA9IHQuZmxpcFksIHRoaXMudW5wYWNrQWxpZ25tZW50ID0gdC51bnBhY2tBbGlnbm1lbnQsIHRoaXMuY29sb3JTcGFjZSA9IHQuY29sb3JTcGFjZSwgdGhpcy51c2VyRGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodC51c2VyRGF0YSkpLCB0aGlzLm5lZWRzVXBkYXRlID0gITAsIHRoaXM7CiAgfQogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gdCA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0ID09ICJzdHJpbmciOwogICAgaWYgKCFlICYmIHQudGV4dHVyZXNbdGhpcy51dWlkXSAhPT0gdm9pZCAwKQogICAgICByZXR1cm4gdC50ZXh0dXJlc1t0aGlzLnV1aWRdOwogICAgY29uc3QgaSA9IHsKICAgICAgbWV0YWRhdGE6IHsKICAgICAgICB2ZXJzaW9uOiA0LjYsCiAgICAgICAgdHlwZTogIlRleHR1cmUiLAogICAgICAgIGdlbmVyYXRvcjogIlRleHR1cmUudG9KU09OIgogICAgICB9LAogICAgICB1dWlkOiB0aGlzLnV1aWQsCiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgaW1hZ2U6IHRoaXMuc291cmNlLnRvSlNPTih0KS51dWlkLAogICAgICBtYXBwaW5nOiB0aGlzLm1hcHBpbmcsCiAgICAgIGNoYW5uZWw6IHRoaXMuY2hhbm5lbCwKICAgICAgcmVwZWF0OiBbdGhpcy5yZXBlYXQueCwgdGhpcy5yZXBlYXQueV0sCiAgICAgIG9mZnNldDogW3RoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnldLAogICAgICBjZW50ZXI6IFt0aGlzLmNlbnRlci54LCB0aGlzLmNlbnRlci55XSwKICAgICAgcm90YXRpb246IHRoaXMucm90YXRpb24sCiAgICAgIHdyYXA6IFt0aGlzLndyYXBTLCB0aGlzLndyYXBUXSwKICAgICAgZm9ybWF0OiB0aGlzLmZvcm1hdCwKICAgICAgaW50ZXJuYWxGb3JtYXQ6IHRoaXMuaW50ZXJuYWxGb3JtYXQsCiAgICAgIHR5cGU6IHRoaXMudHlwZSwKICAgICAgY29sb3JTcGFjZTogdGhpcy5jb2xvclNwYWNlLAogICAgICBtaW5GaWx0ZXI6IHRoaXMubWluRmlsdGVyLAogICAgICBtYWdGaWx0ZXI6IHRoaXMubWFnRmlsdGVyLAogICAgICBhbmlzb3Ryb3B5OiB0aGlzLmFuaXNvdHJvcHksCiAgICAgIGZsaXBZOiB0aGlzLmZsaXBZLAogICAgICBnZW5lcmF0ZU1pcG1hcHM6IHRoaXMuZ2VuZXJhdGVNaXBtYXBzLAogICAgICBwcmVtdWx0aXBseUFscGhhOiB0aGlzLnByZW11bHRpcGx5QWxwaGEsCiAgICAgIHVucGFja0FsaWdubWVudDogdGhpcy51bnBhY2tBbGlnbm1lbnQKICAgIH07CiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy51c2VyRGF0YSkubGVuZ3RoID4gMCAmJiAoaS51c2VyRGF0YSA9IHRoaXMudXNlckRhdGEpLCBlIHx8ICh0LnRleHR1cmVzW3RoaXMudXVpZF0gPSBpKSwgaTsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZGlzcGF0Y2hFdmVudCh7IHR5cGU6ICJkaXNwb3NlIiB9KTsKICB9CiAgdHJhbnNmb3JtVXYodCkgewogICAgaWYgKHRoaXMubWFwcGluZyAhPT0gT18pIHJldHVybiB0OwogICAgaWYgKHQuYXBwbHlNYXRyaXgzKHRoaXMubWF0cml4KSwgdC54IDwgMCB8fCB0LnggPiAxKQogICAgICBzd2l0Y2ggKHRoaXMud3JhcFMpIHsKICAgICAgICBjYXNlIEVnOgogICAgICAgICAgdC54ID0gdC54IC0gTWF0aC5mbG9vcih0LngpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBZbDoKICAgICAgICAgIHQueCA9IHQueCA8IDAgPyAwIDogMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgVGc6CiAgICAgICAgICBNYXRoLmFicyhNYXRoLmZsb29yKHQueCkgJSAyKSA9PT0gMSA/IHQueCA9IE1hdGguY2VpbCh0LngpIC0gdC54IDogdC54ID0gdC54IC0gTWF0aC5mbG9vcih0LngpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIGlmICh0LnkgPCAwIHx8IHQueSA+IDEpCiAgICAgIHN3aXRjaCAodGhpcy53cmFwVCkgewogICAgICAgIGNhc2UgRWc6CiAgICAgICAgICB0LnkgPSB0LnkgLSBNYXRoLmZsb29yKHQueSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIFlsOgogICAgICAgICAgdC55ID0gdC55IDwgMCA/IDAgOiAxOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBUZzoKICAgICAgICAgIE1hdGguYWJzKE1hdGguZmxvb3IodC55KSAlIDIpID09PSAxID8gdC55ID0gTWF0aC5jZWlsKHQueSkgLSB0LnkgOiB0LnkgPSB0LnkgLSBNYXRoLmZsb29yKHQueSk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgcmV0dXJuIHRoaXMuZmxpcFkgJiYgKHQueSA9IDEgLSB0LnkpLCB0OwogIH0KICBzZXQgbmVlZHNVcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgKHRoaXMudmVyc2lvbisrLCB0aGlzLnNvdXJjZS5uZWVkc1VwZGF0ZSA9ICEwKTsKICB9CiAgc2V0IG5lZWRzUE1SRU1VcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgdGhpcy5wbXJlbVZlcnNpb24rKzsKICB9Cn07Cl9mLkRFRkFVTFRfSU1BR0UgPSBudWxsOwpfZi5ERUZBVUxUX01BUFBJTkcgPSBPXzsKX2YuREVGQVVMVF9BTklTT1RST1BZID0gMTsKY2xhc3MgUG4gewogIGNvbnN0cnVjdG9yKHQgPSAwLCBlID0gMCwgaSA9IDAsIG4gPSAxKSB7CiAgICBQbi5wcm90b3R5cGUuaXNWZWN0b3I0ID0gITAsIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXMueiA9IGksIHRoaXMudyA9IG47CiAgfQogIGdldCB3aWR0aCgpIHsKICAgIHJldHVybiB0aGlzLno7CiAgfQogIHNldCB3aWR0aCh0KSB7CiAgICB0aGlzLnogPSB0OwogIH0KICBnZXQgaGVpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMudzsKICB9CiAgc2V0IGhlaWdodCh0KSB7CiAgICB0aGlzLncgPSB0OwogIH0KICBzZXQodCwgZSwgaSwgbikgewogICAgcmV0dXJuIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXMueiA9IGksIHRoaXMudyA9IG4sIHRoaXM7CiAgfQogIHNldFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpcy55ID0gdCwgdGhpcy56ID0gdCwgdGhpcy53ID0gdCwgdGhpczsKICB9CiAgc2V0WCh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpczsKICB9CiAgc2V0WSh0KSB7CiAgICByZXR1cm4gdGhpcy55ID0gdCwgdGhpczsKICB9CiAgc2V0Wih0KSB7CiAgICByZXR1cm4gdGhpcy56ID0gdCwgdGhpczsKICB9CiAgc2V0Vyh0KSB7CiAgICByZXR1cm4gdGhpcy53ID0gdCwgdGhpczsKICB9CiAgc2V0Q29tcG9uZW50KHQsIGUpIHsKICAgIHN3aXRjaCAodCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMueSA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLnogPSBlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgdGhpcy53ID0gZTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImluZGV4IGlzIG91dCBvZiByYW5nZTogIiArIHQpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldENvbXBvbmVudCh0KSB7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiB0aGlzLng7CiAgICAgIGNhc2UgMToKICAgICAgICByZXR1cm4gdGhpcy55OwogICAgICBjYXNlIDI6CiAgICAgICAgcmV0dXJuIHRoaXMuejsKICAgICAgY2FzZSAzOgogICAgICAgIHJldHVybiB0aGlzLnc7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyB0KTsKICAgIH0KICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy54LCB0aGlzLnksIHRoaXMueiwgdGhpcy53KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54LCB0aGlzLnkgPSB0LnksIHRoaXMueiA9IHQueiwgdGhpcy53ID0gdC53ICE9PSB2b2lkIDAgPyB0LncgOiAxLCB0aGlzOwogIH0KICBhZGQodCkgewogICAgcmV0dXJuIHRoaXMueCArPSB0LngsIHRoaXMueSArPSB0LnksIHRoaXMueiArPSB0LnosIHRoaXMudyArPSB0LncsIHRoaXM7CiAgfQogIGFkZFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQsIHRoaXMueSArPSB0LCB0aGlzLnogKz0gdCwgdGhpcy53ICs9IHQsIHRoaXM7CiAgfQogIGFkZFZlY3RvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCArIGUueCwgdGhpcy55ID0gdC55ICsgZS55LCB0aGlzLnogPSB0LnogKyBlLnosIHRoaXMudyA9IHQudyArIGUudywgdGhpczsKICB9CiAgYWRkU2NhbGVkVmVjdG9yKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54ICogZSwgdGhpcy55ICs9IHQueSAqIGUsIHRoaXMueiArPSB0LnogKiBlLCB0aGlzLncgKz0gdC53ICogZSwgdGhpczsKICB9CiAgc3ViKHQpIHsKICAgIHJldHVybiB0aGlzLnggLT0gdC54LCB0aGlzLnkgLT0gdC55LCB0aGlzLnogLT0gdC56LCB0aGlzLncgLT0gdC53LCB0aGlzOwogIH0KICBzdWJTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LCB0aGlzLnkgLT0gdCwgdGhpcy56IC09IHQsIHRoaXMudyAtPSB0LCB0aGlzOwogIH0KICBzdWJWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggLSBlLngsIHRoaXMueSA9IHQueSAtIGUueSwgdGhpcy56ID0gdC56IC0gZS56LCB0aGlzLncgPSB0LncgLSBlLncsIHRoaXM7CiAgfQogIG11bHRpcGx5KHQpIHsKICAgIHJldHVybiB0aGlzLnggKj0gdC54LCB0aGlzLnkgKj0gdC55LCB0aGlzLnogKj0gdC56LCB0aGlzLncgKj0gdC53LCB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICo9IHQsIHRoaXMueSAqPSB0LCB0aGlzLnogKj0gdCwgdGhpcy53ICo9IHQsIHRoaXM7CiAgfQogIGFwcGx5TWF0cml4NCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy54LCBpID0gdGhpcy55LCBuID0gdGhpcy56LCBzID0gdGhpcy53LCByID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnggPSByWzBdICogZSArIHJbNF0gKiBpICsgcls4XSAqIG4gKyByWzEyXSAqIHMsIHRoaXMueSA9IHJbMV0gKiBlICsgcls1XSAqIGkgKyByWzldICogbiArIHJbMTNdICogcywgdGhpcy56ID0gclsyXSAqIGUgKyByWzZdICogaSArIHJbMTBdICogbiArIHJbMTRdICogcywgdGhpcy53ID0gclszXSAqIGUgKyByWzddICogaSArIHJbMTFdICogbiArIHJbMTVdICogcywgdGhpczsKICB9CiAgZGl2aWRlKHQpIHsKICAgIHJldHVybiB0aGlzLnggLz0gdC54LCB0aGlzLnkgLz0gdC55LCB0aGlzLnogLz0gdC56LCB0aGlzLncgLz0gdC53LCB0aGlzOwogIH0KICBkaXZpZGVTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoMSAvIHQpOwogIH0KICBzZXRBeGlzQW5nbGVGcm9tUXVhdGVybmlvbih0KSB7CiAgICB0aGlzLncgPSAyICogTWF0aC5hY29zKHQudyk7CiAgICBjb25zdCBlID0gTWF0aC5zcXJ0KDEgLSB0LncgKiB0LncpOwogICAgcmV0dXJuIGUgPCAxZS00ID8gKHRoaXMueCA9IDEsIHRoaXMueSA9IDAsIHRoaXMueiA9IDApIDogKHRoaXMueCA9IHQueCAvIGUsIHRoaXMueSA9IHQueSAvIGUsIHRoaXMueiA9IHQueiAvIGUpLCB0aGlzOwogIH0KICBzZXRBeGlzQW5nbGVGcm9tUm90YXRpb25NYXRyaXgodCkgewogICAgbGV0IGUsIGksIG4sIHM7CiAgICBjb25zdCBsID0gdC5lbGVtZW50cywgaCA9IGxbMF0sIGMgPSBsWzRdLCB1ID0gbFs4XSwgZCA9IGxbMV0sIHAgPSBsWzVdLCBmID0gbFs5XSwgeSA9IGxbMl0sIGcgPSBsWzZdLCBtID0gbFsxMF07CiAgICBpZiAoTWF0aC5hYnMoYyAtIGQpIDwgMC4wMSAmJiBNYXRoLmFicyh1IC0geSkgPCAwLjAxICYmIE1hdGguYWJzKGYgLSBnKSA8IDAuMDEpIHsKICAgICAgaWYgKE1hdGguYWJzKGMgKyBkKSA8IDAuMSAmJiBNYXRoLmFicyh1ICsgeSkgPCAwLjEgJiYgTWF0aC5hYnMoZiArIGcpIDwgMC4xICYmIE1hdGguYWJzKGggKyBwICsgbSAtIDMpIDwgMC4xKQogICAgICAgIHJldHVybiB0aGlzLnNldCgxLCAwLCAwLCAwKSwgdGhpczsKICAgICAgZSA9IE1hdGguUEk7CiAgICAgIGNvbnN0IHggPSAoaCArIDEpIC8gMiwgXyA9IChwICsgMSkgLyAyLCBTID0gKG0gKyAxKSAvIDIsIHcgPSAoYyArIGQpIC8gNCwgVCA9ICh1ICsgeSkgLyA0LCBSID0gKGYgKyBnKSAvIDQ7CiAgICAgIHJldHVybiB4ID4gXyAmJiB4ID4gUyA/IHggPCAwLjAxID8gKGkgPSAwLCBuID0gMC43MDcxMDY3ODEsIHMgPSAwLjcwNzEwNjc4MSkgOiAoaSA9IE1hdGguc3FydCh4KSwgbiA9IHcgLyBpLCBzID0gVCAvIGkpIDogXyA+IFMgPyBfIDwgMC4wMSA/IChpID0gMC43MDcxMDY3ODEsIG4gPSAwLCBzID0gMC43MDcxMDY3ODEpIDogKG4gPSBNYXRoLnNxcnQoXyksIGkgPSB3IC8gbiwgcyA9IFIgLyBuKSA6IFMgPCAwLjAxID8gKGkgPSAwLjcwNzEwNjc4MSwgbiA9IDAuNzA3MTA2NzgxLCBzID0gMCkgOiAocyA9IE1hdGguc3FydChTKSwgaSA9IFQgLyBzLCBuID0gUiAvIHMpLCB0aGlzLnNldChpLCBuLCBzLCBlKSwgdGhpczsKICAgIH0KICAgIGxldCB2ID0gTWF0aC5zcXJ0KChnIC0gZikgKiAoZyAtIGYpICsgKHUgLSB5KSAqICh1IC0geSkgKyAoZCAtIGMpICogKGQgLSBjKSk7CiAgICByZXR1cm4gTWF0aC5hYnModikgPCAxZS0zICYmICh2ID0gMSksIHRoaXMueCA9IChnIC0gZikgLyB2LCB0aGlzLnkgPSAodSAtIHkpIC8gdiwgdGhpcy56ID0gKGQgLSBjKSAvIHYsIHRoaXMudyA9IE1hdGguYWNvcygoaCArIHAgKyBtIC0gMSkgLyAyKSwgdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMueCA9IGVbMTJdLCB0aGlzLnkgPSBlWzEzXSwgdGhpcy56ID0gZVsxNF0sIHRoaXMudyA9IGVbMTVdLCB0aGlzOwogIH0KICBtaW4odCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWluKHRoaXMueCwgdC54KSwgdGhpcy55ID0gTWF0aC5taW4odGhpcy55LCB0LnkpLCB0aGlzLnogPSBNYXRoLm1pbih0aGlzLnosIHQueiksIHRoaXMudyA9IE1hdGgubWluKHRoaXMudywgdC53KSwgdGhpczsKICB9CiAgbWF4KHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1heCh0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWF4KHRoaXMueSwgdC55KSwgdGhpcy56ID0gTWF0aC5tYXgodGhpcy56LCB0LnopLCB0aGlzLncgPSBNYXRoLm1heCh0aGlzLncsIHQudyksIHRoaXM7CiAgfQogIGNsYW1wKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1heCh0LngsIE1hdGgubWluKGUueCwgdGhpcy54KSksIHRoaXMueSA9IE1hdGgubWF4KHQueSwgTWF0aC5taW4oZS55LCB0aGlzLnkpKSwgdGhpcy56ID0gTWF0aC5tYXgodC56LCBNYXRoLm1pbihlLnosIHRoaXMueikpLCB0aGlzLncgPSBNYXRoLm1heCh0LncsIE1hdGgubWluKGUudywgdGhpcy53KSksIHRoaXM7CiAgfQogIGNsYW1wU2NhbGFyKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1heCh0LCBNYXRoLm1pbihlLCB0aGlzLngpKSwgdGhpcy55ID0gTWF0aC5tYXgodCwgTWF0aC5taW4oZSwgdGhpcy55KSksIHRoaXMueiA9IE1hdGgubWF4KHQsIE1hdGgubWluKGUsIHRoaXMueikpLCB0aGlzLncgPSBNYXRoLm1heCh0LCBNYXRoLm1pbihlLCB0aGlzLncpKSwgdGhpczsKICB9CiAgY2xhbXBMZW5ndGgodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMubGVuZ3RoKCk7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIoaSB8fCAxKS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCh0LCBNYXRoLm1pbihlLCBpKSkpOwogIH0KICBmbG9vcigpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCksIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KSwgdGhpcy56ID0gTWF0aC5mbG9vcih0aGlzLnopLCB0aGlzLncgPSBNYXRoLmZsb29yKHRoaXMudyksIHRoaXM7CiAgfQogIGNlaWwoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCksIHRoaXMueSA9IE1hdGguY2VpbCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLmNlaWwodGhpcy56KSwgdGhpcy53ID0gTWF0aC5jZWlsKHRoaXMudyksIHRoaXM7CiAgfQogIHJvdW5kKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KSwgdGhpcy55ID0gTWF0aC5yb3VuZCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLnJvdW5kKHRoaXMueiksIHRoaXMudyA9IE1hdGgucm91bmQodGhpcy53KSwgdGhpczsKICB9CiAgcm91bmRUb1plcm8oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC50cnVuYyh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnRydW5jKHRoaXMueSksIHRoaXMueiA9IE1hdGgudHJ1bmModGhpcy56KSwgdGhpcy53ID0gTWF0aC50cnVuYyh0aGlzLncpLCB0aGlzOwogIH0KICBuZWdhdGUoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gLXRoaXMueCwgdGhpcy55ID0gLXRoaXMueSwgdGhpcy56ID0gLXRoaXMueiwgdGhpcy53ID0gLXRoaXMudywgdGhpczsKICB9CiAgZG90KHQpIHsKICAgIHJldHVybiB0aGlzLnggKiB0LnggKyB0aGlzLnkgKiB0LnkgKyB0aGlzLnogKiB0LnogKyB0aGlzLncgKiB0Lnc7CiAgfQogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueiArIHRoaXMudyAqIHRoaXMudzsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnogKyB0aGlzLncgKiB0aGlzLncpOwogIH0KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopICsgTWF0aC5hYnModGhpcy53KTsKICB9CiAgbm9ybWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKHRoaXMubGVuZ3RoKCkgfHwgMSk7CiAgfQogIHNldExlbmd0aCh0KSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih0KTsKICB9CiAgbGVycCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ICs9ICh0LnggLSB0aGlzLngpICogZSwgdGhpcy55ICs9ICh0LnkgLSB0aGlzLnkpICogZSwgdGhpcy56ICs9ICh0LnogLSB0aGlzLnopICogZSwgdGhpcy53ICs9ICh0LncgLSB0aGlzLncpICogZSwgdGhpczsKICB9CiAgbGVycFZlY3RvcnModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCArIChlLnggLSB0LngpICogaSwgdGhpcy55ID0gdC55ICsgKGUueSAtIHQueSkgKiBpLCB0aGlzLnogPSB0LnogKyAoZS56IC0gdC56KSAqIGksIHRoaXMudyA9IHQudyArIChlLncgLSB0LncpICogaSwgdGhpczsKICB9CiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0LnggPT09IHRoaXMueCAmJiB0LnkgPT09IHRoaXMueSAmJiB0LnogPT09IHRoaXMueiAmJiB0LncgPT09IHRoaXMudzsKICB9CiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdFtlXSwgdGhpcy55ID0gdFtlICsgMV0sIHRoaXMueiA9IHRbZSArIDJdLCB0aGlzLncgPSB0W2UgKyAzXSwgdGhpczsKICB9CiAgdG9BcnJheSh0ID0gW10sIGUgPSAwKSB7CiAgICByZXR1cm4gdFtlXSA9IHRoaXMueCwgdFtlICsgMV0gPSB0aGlzLnksIHRbZSArIDJdID0gdGhpcy56LCB0W2UgKyAzXSA9IHRoaXMudywgdDsKICB9CiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC5nZXRYKGUpLCB0aGlzLnkgPSB0LmdldFkoZSksIHRoaXMueiA9IHQuZ2V0WihlKSwgdGhpcy53ID0gdC5nZXRXKGUpLCB0aGlzOwogIH0KICByYW5kb20oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yYW5kb20oKSwgdGhpcy55ID0gTWF0aC5yYW5kb20oKSwgdGhpcy56ID0gTWF0aC5yYW5kb20oKSwgdGhpcy53ID0gTWF0aC5yYW5kb20oKSwgdGhpczsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy54LCB5aWVsZCB0aGlzLnksIHlpZWxkIHRoaXMueiwgeWllbGQgdGhpcy53OwogIH0KfQpsZXQgcW8gPSBjbGFzcyB7CiAgY29uc3RydWN0b3IodCA9IDAsIGUgPSAwLCBpID0gMCwgbiA9IDEpIHsKICAgIHRoaXMuaXNRdWF0ZXJuaW9uID0gITAsIHRoaXMuX3ggPSB0LCB0aGlzLl95ID0gZSwgdGhpcy5feiA9IGksIHRoaXMuX3cgPSBuOwogIH0KICBzdGF0aWMgc2xlcnBGbGF0KHQsIGUsIGksIG4sIHMsIHIsIG8pIHsKICAgIGxldCBsID0gaVtuICsgMF0sIGggPSBpW24gKyAxXSwgYyA9IGlbbiArIDJdLCB1ID0gaVtuICsgM107CiAgICBjb25zdCBkID0gc1tyICsgMF0sIHAgPSBzW3IgKyAxXSwgZiA9IHNbciArIDJdLCB5ID0gc1tyICsgM107CiAgICBpZiAobyA9PT0gMCkgewogICAgICB0W2UgKyAwXSA9IGwsIHRbZSArIDFdID0gaCwgdFtlICsgMl0gPSBjLCB0W2UgKyAzXSA9IHU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChvID09PSAxKSB7CiAgICAgIHRbZSArIDBdID0gZCwgdFtlICsgMV0gPSBwLCB0W2UgKyAyXSA9IGYsIHRbZSArIDNdID0geTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHUgIT09IHkgfHwgbCAhPT0gZCB8fCBoICE9PSBwIHx8IGMgIT09IGYpIHsKICAgICAgbGV0IGcgPSAxIC0gbzsKICAgICAgY29uc3QgbSA9IGwgKiBkICsgaCAqIHAgKyBjICogZiArIHUgKiB5LCB2ID0gbSA+PSAwID8gMSA6IC0xLCB4ID0gMSAtIG0gKiBtOwogICAgICBpZiAoeCA+IE51bWJlci5FUFNJTE9OKSB7CiAgICAgICAgY29uc3QgUyA9IE1hdGguc3FydCh4KSwgdyA9IE1hdGguYXRhbjIoUywgbSAqIHYpOwogICAgICAgIGcgPSBNYXRoLnNpbihnICogdykgLyBTLCBvID0gTWF0aC5zaW4obyAqIHcpIC8gUzsKICAgICAgfQogICAgICBjb25zdCBfID0gbyAqIHY7CiAgICAgIGlmIChsID0gbCAqIGcgKyBkICogXywgaCA9IGggKiBnICsgcCAqIF8sIGMgPSBjICogZyArIGYgKiBfLCB1ID0gdSAqIGcgKyB5ICogXywgZyA9PT0gMSAtIG8pIHsKICAgICAgICBjb25zdCBTID0gMSAvIE1hdGguc3FydChsICogbCArIGggKiBoICsgYyAqIGMgKyB1ICogdSk7CiAgICAgICAgbCAqPSBTLCBoICo9IFMsIGMgKj0gUywgdSAqPSBTOwogICAgICB9CiAgICB9CiAgICB0W2VdID0gbCwgdFtlICsgMV0gPSBoLCB0W2UgKyAyXSA9IGMsIHRbZSArIDNdID0gdTsKICB9CiAgc3RhdGljIG11bHRpcGx5UXVhdGVybmlvbnNGbGF0KHQsIGUsIGksIG4sIHMsIHIpIHsKICAgIGNvbnN0IG8gPSBpW25dLCBsID0gaVtuICsgMV0sIGggPSBpW24gKyAyXSwgYyA9IGlbbiArIDNdLCB1ID0gc1tyXSwgZCA9IHNbciArIDFdLCBwID0gc1tyICsgMl0sIGYgPSBzW3IgKyAzXTsKICAgIHJldHVybiB0W2VdID0gbyAqIGYgKyBjICogdSArIGwgKiBwIC0gaCAqIGQsIHRbZSArIDFdID0gbCAqIGYgKyBjICogZCArIGggKiB1IC0gbyAqIHAsIHRbZSArIDJdID0gaCAqIGYgKyBjICogcCArIG8gKiBkIC0gbCAqIHUsIHRbZSArIDNdID0gYyAqIGYgLSBvICogdSAtIGwgKiBkIC0gaCAqIHAsIHQ7CiAgfQogIGdldCB4KCkgewogICAgcmV0dXJuIHRoaXMuX3g7CiAgfQogIHNldCB4KHQpIHsKICAgIHRoaXMuX3ggPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIGdldCB5KCkgewogICAgcmV0dXJuIHRoaXMuX3k7CiAgfQogIHNldCB5KHQpIHsKICAgIHRoaXMuX3kgPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIGdldCB6KCkgewogICAgcmV0dXJuIHRoaXMuX3o7CiAgfQogIHNldCB6KHQpIHsKICAgIHRoaXMuX3ogPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIGdldCB3KCkgewogICAgcmV0dXJuIHRoaXMuX3c7CiAgfQogIHNldCB3KHQpIHsKICAgIHRoaXMuX3cgPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIHNldCh0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHQsIHRoaXMuX3kgPSBlLCB0aGlzLl96ID0gaSwgdGhpcy5fdyA9IG4sIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5feCwgdGhpcy5feSwgdGhpcy5feiwgdGhpcy5fdyk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuX3ggPSB0LngsIHRoaXMuX3kgPSB0LnksIHRoaXMuX3ogPSB0LnosIHRoaXMuX3cgPSB0LncsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgc2V0RnJvbUV1bGVyKHQsIGUgPSAhMCkgewogICAgY29uc3QgaSA9IHQuX3gsIG4gPSB0Ll95LCBzID0gdC5feiwgciA9IHQuX29yZGVyLCBvID0gTWF0aC5jb3MsIGwgPSBNYXRoLnNpbiwgaCA9IG8oaSAvIDIpLCBjID0gbyhuIC8gMiksIHUgPSBvKHMgLyAyKSwgZCA9IGwoaSAvIDIpLCBwID0gbChuIC8gMiksIGYgPSBsKHMgLyAyKTsKICAgIHN3aXRjaCAocikgewogICAgICBjYXNlICJYWVoiOgogICAgICAgIHRoaXMuX3ggPSBkICogYyAqIHUgKyBoICogcCAqIGYsIHRoaXMuX3kgPSBoICogcCAqIHUgLSBkICogYyAqIGYsIHRoaXMuX3ogPSBoICogYyAqIGYgKyBkICogcCAqIHUsIHRoaXMuX3cgPSBoICogYyAqIHUgLSBkICogcCAqIGY7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIllYWiI6CiAgICAgICAgdGhpcy5feCA9IGQgKiBjICogdSArIGggKiBwICogZiwgdGhpcy5feSA9IGggKiBwICogdSAtIGQgKiBjICogZiwgdGhpcy5feiA9IGggKiBjICogZiAtIGQgKiBwICogdSwgdGhpcy5fdyA9IGggKiBjICogdSArIGQgKiBwICogZjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWlhZIjoKICAgICAgICB0aGlzLl94ID0gZCAqIGMgKiB1IC0gaCAqIHAgKiBmLCB0aGlzLl95ID0gaCAqIHAgKiB1ICsgZCAqIGMgKiBmLCB0aGlzLl96ID0gaCAqIGMgKiBmICsgZCAqIHAgKiB1LCB0aGlzLl93ID0gaCAqIGMgKiB1IC0gZCAqIHAgKiBmOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaWVgiOgogICAgICAgIHRoaXMuX3ggPSBkICogYyAqIHUgLSBoICogcCAqIGYsIHRoaXMuX3kgPSBoICogcCAqIHUgKyBkICogYyAqIGYsIHRoaXMuX3ogPSBoICogYyAqIGYgLSBkICogcCAqIHUsIHRoaXMuX3cgPSBoICogYyAqIHUgKyBkICogcCAqIGY7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIllaWCI6CiAgICAgICAgdGhpcy5feCA9IGQgKiBjICogdSArIGggKiBwICogZiwgdGhpcy5feSA9IGggKiBwICogdSArIGQgKiBjICogZiwgdGhpcy5feiA9IGggKiBjICogZiAtIGQgKiBwICogdSwgdGhpcy5fdyA9IGggKiBjICogdSAtIGQgKiBwICogZjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWFpZIjoKICAgICAgICB0aGlzLl94ID0gZCAqIGMgKiB1IC0gaCAqIHAgKiBmLCB0aGlzLl95ID0gaCAqIHAgKiB1IC0gZCAqIGMgKiBmLCB0aGlzLl96ID0gaCAqIGMgKiBmICsgZCAqIHAgKiB1LCB0aGlzLl93ID0gaCAqIGMgKiB1ICsgZCAqIHAgKiBmOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuUXVhdGVybmlvbjogLnNldEZyb21FdWxlcigpIGVuY291bnRlcmVkIGFuIHVua25vd24gb3JkZXI6ICIgKyByKTsKICAgIH0KICAgIHJldHVybiBlID09PSAhMCAmJiB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIHNldEZyb21BeGlzQW5nbGUodCwgZSkgewogICAgY29uc3QgaSA9IGUgLyAyLCBuID0gTWF0aC5zaW4oaSk7CiAgICByZXR1cm4gdGhpcy5feCA9IHQueCAqIG4sIHRoaXMuX3kgPSB0LnkgKiBuLCB0aGlzLl96ID0gdC56ICogbiwgdGhpcy5fdyA9IE1hdGguY29zKGkpLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIHNldEZyb21Sb3RhdGlvbk1hdHJpeCh0KSB7CiAgICBjb25zdCBlID0gdC5lbGVtZW50cywgaSA9IGVbMF0sIG4gPSBlWzRdLCBzID0gZVs4XSwgciA9IGVbMV0sIG8gPSBlWzVdLCBsID0gZVs5XSwgaCA9IGVbMl0sIGMgPSBlWzZdLCB1ID0gZVsxMF0sIGQgPSBpICsgbyArIHU7CiAgICBpZiAoZCA+IDApIHsKICAgICAgY29uc3QgcCA9IDAuNSAvIE1hdGguc3FydChkICsgMSk7CiAgICAgIHRoaXMuX3cgPSAwLjI1IC8gcCwgdGhpcy5feCA9IChjIC0gbCkgKiBwLCB0aGlzLl95ID0gKHMgLSBoKSAqIHAsIHRoaXMuX3ogPSAociAtIG4pICogcDsKICAgIH0gZWxzZSBpZiAoaSA+IG8gJiYgaSA+IHUpIHsKICAgICAgY29uc3QgcCA9IDIgKiBNYXRoLnNxcnQoMSArIGkgLSBvIC0gdSk7CiAgICAgIHRoaXMuX3cgPSAoYyAtIGwpIC8gcCwgdGhpcy5feCA9IDAuMjUgKiBwLCB0aGlzLl95ID0gKG4gKyByKSAvIHAsIHRoaXMuX3ogPSAocyArIGgpIC8gcDsKICAgIH0gZWxzZSBpZiAobyA+IHUpIHsKICAgICAgY29uc3QgcCA9IDIgKiBNYXRoLnNxcnQoMSArIG8gLSBpIC0gdSk7CiAgICAgIHRoaXMuX3cgPSAocyAtIGgpIC8gcCwgdGhpcy5feCA9IChuICsgcikgLyBwLCB0aGlzLl95ID0gMC4yNSAqIHAsIHRoaXMuX3ogPSAobCArIGMpIC8gcDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHAgPSAyICogTWF0aC5zcXJ0KDEgKyB1IC0gaSAtIG8pOwogICAgICB0aGlzLl93ID0gKHIgLSBuKSAvIHAsIHRoaXMuX3ggPSAocyArIGgpIC8gcCwgdGhpcy5feSA9IChsICsgYykgLyBwLCB0aGlzLl96ID0gMC4yNSAqIHA7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICBzZXRGcm9tVW5pdFZlY3RvcnModCwgZSkgewogICAgbGV0IGkgPSB0LmRvdChlKSArIDE7CiAgICByZXR1cm4gaSA8IE51bWJlci5FUFNJTE9OID8gKGkgPSAwLCBNYXRoLmFicyh0LngpID4gTWF0aC5hYnModC56KSA/ICh0aGlzLl94ID0gLXQueSwgdGhpcy5feSA9IHQueCwgdGhpcy5feiA9IDAsIHRoaXMuX3cgPSBpKSA6ICh0aGlzLl94ID0gMCwgdGhpcy5feSA9IC10LnosIHRoaXMuX3ogPSB0LnksIHRoaXMuX3cgPSBpKSkgOiAodGhpcy5feCA9IHQueSAqIGUueiAtIHQueiAqIGUueSwgdGhpcy5feSA9IHQueiAqIGUueCAtIHQueCAqIGUueiwgdGhpcy5feiA9IHQueCAqIGUueSAtIHQueSAqIGUueCwgdGhpcy5fdyA9IGkpLCB0aGlzLm5vcm1hbGl6ZSgpOwogIH0KICBhbmdsZVRvKHQpIHsKICAgIHJldHVybiAyICogTWF0aC5hY29zKE1hdGguYWJzKGFpKHRoaXMuZG90KHQpLCAtMSwgMSkpKTsKICB9CiAgcm90YXRlVG93YXJkcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5hbmdsZVRvKHQpOwogICAgaWYgKGkgPT09IDApIHJldHVybiB0aGlzOwogICAgY29uc3QgbiA9IE1hdGgubWluKDEsIGUgLyBpKTsKICAgIHJldHVybiB0aGlzLnNsZXJwKHQsIG4pLCB0aGlzOwogIH0KICBpZGVudGl0eSgpIHsKICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwLCAxKTsKICB9CiAgaW52ZXJ0KCkgewogICAgcmV0dXJuIHRoaXMuY29uanVnYXRlKCk7CiAgfQogIGNvbmp1Z2F0ZSgpIHsKICAgIHJldHVybiB0aGlzLl94ICo9IC0xLCB0aGlzLl95ICo9IC0xLCB0aGlzLl96ICo9IC0xLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIGRvdCh0KSB7CiAgICByZXR1cm4gdGhpcy5feCAqIHQuX3ggKyB0aGlzLl95ICogdC5feSArIHRoaXMuX3ogKiB0Ll96ICsgdGhpcy5fdyAqIHQuX3c7CiAgfQogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMuX3ggKiB0aGlzLl94ICsgdGhpcy5feSAqIHRoaXMuX3kgKyB0aGlzLl96ICogdGhpcy5feiArIHRoaXMuX3cgKiB0aGlzLl93OwogIH0KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX3ggKiB0aGlzLl94ICsgdGhpcy5feSAqIHRoaXMuX3kgKyB0aGlzLl96ICogdGhpcy5feiArIHRoaXMuX3cgKiB0aGlzLl93KTsKICB9CiAgbm9ybWFsaXplKCkgewogICAgbGV0IHQgPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHQgPT09IDAgPyAodGhpcy5feCA9IDAsIHRoaXMuX3kgPSAwLCB0aGlzLl96ID0gMCwgdGhpcy5fdyA9IDEpIDogKHQgPSAxIC8gdCwgdGhpcy5feCA9IHRoaXMuX3ggKiB0LCB0aGlzLl95ID0gdGhpcy5feSAqIHQsIHRoaXMuX3ogPSB0aGlzLl96ICogdCwgdGhpcy5fdyA9IHRoaXMuX3cgKiB0KSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICBtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVF1YXRlcm5pb25zKHRoaXMsIHQpOwogIH0KICBwcmVtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVF1YXRlcm5pb25zKHQsIHRoaXMpOwogIH0KICBtdWx0aXBseVF1YXRlcm5pb25zKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0Ll94LCBuID0gdC5feSwgcyA9IHQuX3osIHIgPSB0Ll93LCBvID0gZS5feCwgbCA9IGUuX3ksIGggPSBlLl96LCBjID0gZS5fdzsKICAgIHJldHVybiB0aGlzLl94ID0gaSAqIGMgKyByICogbyArIG4gKiBoIC0gcyAqIGwsIHRoaXMuX3kgPSBuICogYyArIHIgKiBsICsgcyAqIG8gLSBpICogaCwgdGhpcy5feiA9IHMgKiBjICsgciAqIGggKyBpICogbCAtIG4gKiBvLCB0aGlzLl93ID0gciAqIGMgLSBpICogbyAtIG4gKiBsIC0gcyAqIGgsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgc2xlcnAodCwgZSkgewogICAgaWYgKGUgPT09IDApIHJldHVybiB0aGlzOwogICAgaWYgKGUgPT09IDEpIHJldHVybiB0aGlzLmNvcHkodCk7CiAgICBjb25zdCBpID0gdGhpcy5feCwgbiA9IHRoaXMuX3ksIHMgPSB0aGlzLl96LCByID0gdGhpcy5fdzsKICAgIGxldCBvID0gciAqIHQuX3cgKyBpICogdC5feCArIG4gKiB0Ll95ICsgcyAqIHQuX3o7CiAgICBpZiAobyA8IDAgPyAodGhpcy5fdyA9IC10Ll93LCB0aGlzLl94ID0gLXQuX3gsIHRoaXMuX3kgPSAtdC5feSwgdGhpcy5feiA9IC10Ll96LCBvID0gLW8pIDogdGhpcy5jb3B5KHQpLCBvID49IDEpCiAgICAgIHJldHVybiB0aGlzLl93ID0gciwgdGhpcy5feCA9IGksIHRoaXMuX3kgPSBuLCB0aGlzLl96ID0gcywgdGhpczsKICAgIGNvbnN0IGwgPSAxIC0gbyAqIG87CiAgICBpZiAobCA8PSBOdW1iZXIuRVBTSUxPTikgewogICAgICBjb25zdCBwID0gMSAtIGU7CiAgICAgIHJldHVybiB0aGlzLl93ID0gcCAqIHIgKyBlICogdGhpcy5fdywgdGhpcy5feCA9IHAgKiBpICsgZSAqIHRoaXMuX3gsIHRoaXMuX3kgPSBwICogbiArIGUgKiB0aGlzLl95LCB0aGlzLl96ID0gcCAqIHMgKyBlICogdGhpcy5feiwgdGhpcy5ub3JtYWxpemUoKSwgdGhpczsKICAgIH0KICAgIGNvbnN0IGggPSBNYXRoLnNxcnQobCksIGMgPSBNYXRoLmF0YW4yKGgsIG8pLCB1ID0gTWF0aC5zaW4oKDEgLSBlKSAqIGMpIC8gaCwgZCA9IE1hdGguc2luKGUgKiBjKSAvIGg7CiAgICByZXR1cm4gdGhpcy5fdyA9IHIgKiB1ICsgdGhpcy5fdyAqIGQsIHRoaXMuX3ggPSBpICogdSArIHRoaXMuX3ggKiBkLCB0aGlzLl95ID0gbiAqIHUgKyB0aGlzLl95ICogZCwgdGhpcy5feiA9IHMgKiB1ICsgdGhpcy5feiAqIGQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgc2xlcnBRdWF0ZXJuaW9ucyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5jb3B5KHQpLnNsZXJwKGUsIGkpOwogIH0KICByYW5kb20oKSB7CiAgICBjb25zdCB0ID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpLCBlID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpLCBpID0gTWF0aC5yYW5kb20oKSwgbiA9IE1hdGguc3FydCgxIC0gaSksIHMgPSBNYXRoLnNxcnQoaSk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIG4gKiBNYXRoLnNpbih0KSwKICAgICAgbiAqIE1hdGguY29zKHQpLAogICAgICBzICogTWF0aC5zaW4oZSksCiAgICAgIHMgKiBNYXRoLmNvcyhlKQogICAgKTsKICB9CiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0Ll94ID09PSB0aGlzLl94ICYmIHQuX3kgPT09IHRoaXMuX3kgJiYgdC5feiA9PT0gdGhpcy5feiAmJiB0Ll93ID09PSB0aGlzLl93OwogIH0KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLl94ID0gdFtlXSwgdGhpcy5feSA9IHRbZSArIDFdLCB0aGlzLl96ID0gdFtlICsgMl0sIHRoaXMuX3cgPSB0W2UgKyAzXSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIHJldHVybiB0W2VdID0gdGhpcy5feCwgdFtlICsgMV0gPSB0aGlzLl95LCB0W2UgKyAyXSA9IHRoaXMuX3osIHRbZSArIDNdID0gdGhpcy5fdywgdDsKICB9CiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHQuZ2V0WChlKSwgdGhpcy5feSA9IHQuZ2V0WShlKSwgdGhpcy5feiA9IHQuZ2V0WihlKSwgdGhpcy5fdyA9IHQuZ2V0VyhlKSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy50b0FycmF5KCk7CiAgfQogIF9vbkNoYW5nZSh0KSB7CiAgICByZXR1cm4gdGhpcy5fb25DaGFuZ2VDYWxsYmFjayA9IHQsIHRoaXM7CiAgfQogIF9vbkNoYW5nZUNhbGxiYWNrKCkgewogIH0KICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICB5aWVsZCB0aGlzLl94LCB5aWVsZCB0aGlzLl95LCB5aWVsZCB0aGlzLl96LCB5aWVsZCB0aGlzLl93OwogIH0KfSwgdHQgPSBjbGFzcyBYXyB7CiAgY29uc3RydWN0b3IodCA9IDAsIGUgPSAwLCBpID0gMCkgewogICAgWF8ucHJvdG90eXBlLmlzVmVjdG9yMyA9ICEwLCB0aGlzLnggPSB0LCB0aGlzLnkgPSBlLCB0aGlzLnogPSBpOwogIH0KICBzZXQodCwgZSwgaSkgewogICAgcmV0dXJuIGkgPT09IHZvaWQgMCAmJiAoaSA9IHRoaXMueiksIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXMueiA9IGksIHRoaXM7CiAgfQogIHNldFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpcy55ID0gdCwgdGhpcy56ID0gdCwgdGhpczsKICB9CiAgc2V0WCh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpczsKICB9CiAgc2V0WSh0KSB7CiAgICByZXR1cm4gdGhpcy55ID0gdCwgdGhpczsKICB9CiAgc2V0Wih0KSB7CiAgICByZXR1cm4gdGhpcy56ID0gdCwgdGhpczsKICB9CiAgc2V0Q29tcG9uZW50KHQsIGUpIHsKICAgIHN3aXRjaCAodCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMueSA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLnogPSBlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgZ2V0Q29tcG9uZW50KHQpIHsKICAgIHN3aXRjaCAodCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGNhc2UgMjoKICAgICAgICByZXR1cm4gdGhpcy56OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMueCwgdGhpcy55LCB0aGlzLnopOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LngsIHRoaXMueSA9IHQueSwgdGhpcy56ID0gdC56LCB0aGlzOwogIH0KICBhZGQodCkgewogICAgcmV0dXJuIHRoaXMueCArPSB0LngsIHRoaXMueSArPSB0LnksIHRoaXMueiArPSB0LnosIHRoaXM7CiAgfQogIGFkZFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQsIHRoaXMueSArPSB0LCB0aGlzLnogKz0gdCwgdGhpczsKICB9CiAgYWRkVmVjdG9ycyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54ICsgZS54LCB0aGlzLnkgPSB0LnkgKyBlLnksIHRoaXMueiA9IHQueiArIGUueiwgdGhpczsKICB9CiAgYWRkU2NhbGVkVmVjdG9yKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54ICogZSwgdGhpcy55ICs9IHQueSAqIGUsIHRoaXMueiArPSB0LnogKiBlLCB0aGlzOwogIH0KICBzdWIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LngsIHRoaXMueSAtPSB0LnksIHRoaXMueiAtPSB0LnosIHRoaXM7CiAgfQogIHN1YlNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54IC09IHQsIHRoaXMueSAtPSB0LCB0aGlzLnogLT0gdCwgdGhpczsKICB9CiAgc3ViVmVjdG9ycyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54IC0gZS54LCB0aGlzLnkgPSB0LnkgLSBlLnksIHRoaXMueiA9IHQueiAtIGUueiwgdGhpczsKICB9CiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LngsIHRoaXMueSAqPSB0LnksIHRoaXMueiAqPSB0LnosIHRoaXM7CiAgfQogIG11bHRpcGx5U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggKj0gdCwgdGhpcy55ICo9IHQsIHRoaXMueiAqPSB0LCB0aGlzOwogIH0KICBtdWx0aXBseVZlY3RvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCAqIGUueCwgdGhpcy55ID0gdC55ICogZS55LCB0aGlzLnogPSB0LnogKiBlLnosIHRoaXM7CiAgfQogIGFwcGx5RXVsZXIodCkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlRdWF0ZXJuaW9uKEJnLnNldEZyb21FdWxlcih0KSk7CiAgfQogIGFwcGx5QXhpc0FuZ2xlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihCZy5zZXRGcm9tQXhpc0FuZ2xlKHQsIGUpKTsKICB9CiAgYXBwbHlNYXRyaXgzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0aGlzLnosIHMgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMueCA9IHNbMF0gKiBlICsgc1szXSAqIGkgKyBzWzZdICogbiwgdGhpcy55ID0gc1sxXSAqIGUgKyBzWzRdICogaSArIHNbN10gKiBuLCB0aGlzLnogPSBzWzJdICogZSArIHNbNV0gKiBpICsgc1s4XSAqIG4sIHRoaXM7CiAgfQogIGFwcGx5Tm9ybWFsTWF0cml4KHQpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4Myh0KS5ub3JtYWxpemUoKTsKICB9CiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0aGlzLnosIHMgPSB0LmVsZW1lbnRzLCByID0gMSAvIChzWzNdICogZSArIHNbN10gKiBpICsgc1sxMV0gKiBuICsgc1sxNV0pOwogICAgcmV0dXJuIHRoaXMueCA9IChzWzBdICogZSArIHNbNF0gKiBpICsgc1s4XSAqIG4gKyBzWzEyXSkgKiByLCB0aGlzLnkgPSAoc1sxXSAqIGUgKyBzWzVdICogaSArIHNbOV0gKiBuICsgc1sxM10pICogciwgdGhpcy56ID0gKHNbMl0gKiBlICsgc1s2XSAqIGkgKyBzWzEwXSAqIG4gKyBzWzE0XSkgKiByLCB0aGlzOwogIH0KICBhcHBseVF1YXRlcm5pb24odCkgewogICAgY29uc3QgZSA9IHRoaXMueCwgaSA9IHRoaXMueSwgbiA9IHRoaXMueiwgcyA9IHQueCwgciA9IHQueSwgbyA9IHQueiwgbCA9IHQudywgaCA9IDIgKiAociAqIG4gLSBvICogaSksIGMgPSAyICogKG8gKiBlIC0gcyAqIG4pLCB1ID0gMiAqIChzICogaSAtIHIgKiBlKTsKICAgIHJldHVybiB0aGlzLnggPSBlICsgbCAqIGggKyByICogdSAtIG8gKiBjLCB0aGlzLnkgPSBpICsgbCAqIGMgKyBvICogaCAtIHMgKiB1LCB0aGlzLnogPSBuICsgbCAqIHUgKyBzICogYyAtIHIgKiBoLCB0aGlzOwogIH0KICBwcm9qZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkSW52ZXJzZSkuYXBwbHlNYXRyaXg0KHQucHJvamVjdGlvbk1hdHJpeCk7CiAgfQogIHVucHJvamVjdCh0KSB7CiAgICByZXR1cm4gdGhpcy5hcHBseU1hdHJpeDQodC5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZSkuYXBwbHlNYXRyaXg0KHQubWF0cml4V29ybGQpOwogIH0KICB0cmFuc2Zvcm1EaXJlY3Rpb24odCkgewogICAgY29uc3QgZSA9IHRoaXMueCwgaSA9IHRoaXMueSwgbiA9IHRoaXMueiwgcyA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy54ID0gc1swXSAqIGUgKyBzWzRdICogaSArIHNbOF0gKiBuLCB0aGlzLnkgPSBzWzFdICogZSArIHNbNV0gKiBpICsgc1s5XSAqIG4sIHRoaXMueiA9IHNbMl0gKiBlICsgc1s2XSAqIGkgKyBzWzEwXSAqIG4sIHRoaXMubm9ybWFsaXplKCk7CiAgfQogIGRpdmlkZSh0KSB7CiAgICByZXR1cm4gdGhpcy54IC89IHQueCwgdGhpcy55IC89IHQueSwgdGhpcy56IC89IHQueiwgdGhpczsKICB9CiAgZGl2aWRlU2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5U2NhbGFyKDEgLyB0KTsKICB9CiAgbWluKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1pbih0aGlzLngsIHQueCksIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdC55KSwgdGhpcy56ID0gTWF0aC5taW4odGhpcy56LCB0LnopLCB0aGlzOwogIH0KICBtYXgodCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWF4KHRoaXMueCwgdC54KSwgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB0LnkpLCB0aGlzLnogPSBNYXRoLm1heCh0aGlzLnosIHQueiksIHRoaXM7CiAgfQogIGNsYW1wKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLm1heCh0LngsIE1hdGgubWluKGUueCwgdGhpcy54KSksIHRoaXMueSA9IE1hdGgubWF4KHQueSwgTWF0aC5taW4oZS55LCB0aGlzLnkpKSwgdGhpcy56ID0gTWF0aC5tYXgodC56LCBNYXRoLm1pbihlLnosIHRoaXMueikpLCB0aGlzOwogIH0KICBjbGFtcFNjYWxhcih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5tYXgodCwgTWF0aC5taW4oZSwgdGhpcy54KSksIHRoaXMueSA9IE1hdGgubWF4KHQsIE1hdGgubWluKGUsIHRoaXMueSkpLCB0aGlzLnogPSBNYXRoLm1heCh0LCBNYXRoLm1pbihlLCB0aGlzLnopKSwgdGhpczsKICB9CiAgY2xhbXBMZW5ndGgodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMubGVuZ3RoKCk7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIoaSB8fCAxKS5tdWx0aXBseVNjYWxhcihNYXRoLm1heCh0LCBNYXRoLm1pbihlLCBpKSkpOwogIH0KICBmbG9vcigpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCksIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KSwgdGhpcy56ID0gTWF0aC5mbG9vcih0aGlzLnopLCB0aGlzOwogIH0KICBjZWlsKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGguY2VpbCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KSwgdGhpcy56ID0gTWF0aC5jZWlsKHRoaXMueiksIHRoaXM7CiAgfQogIHJvdW5kKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KSwgdGhpcy55ID0gTWF0aC5yb3VuZCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLnJvdW5kKHRoaXMueiksIHRoaXM7CiAgfQogIHJvdW5kVG9aZXJvKCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KSwgdGhpcy55ID0gTWF0aC50cnVuYyh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLnRydW5jKHRoaXMueiksIHRoaXM7CiAgfQogIG5lZ2F0ZSgpIHsKICAgIHJldHVybiB0aGlzLnggPSAtdGhpcy54LCB0aGlzLnkgPSAtdGhpcy55LCB0aGlzLnogPSAtdGhpcy56LCB0aGlzOwogIH0KICBkb3QodCkgewogICAgcmV0dXJuIHRoaXMueCAqIHQueCArIHRoaXMueSAqIHQueSArIHRoaXMueiAqIHQuejsKICB9CiAgLy8gVE9ETyBsZW5ndGhTcXVhcmVkPwogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMuejsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnopOwogIH0KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopOwogIH0KICBub3JtYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIodGhpcy5sZW5ndGgoKSB8fCAxKTsKICB9CiAgc2V0TGVuZ3RoKHQpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHQpOwogIH0KICBsZXJwKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gKHQueCAtIHRoaXMueCkgKiBlLCB0aGlzLnkgKz0gKHQueSAtIHRoaXMueSkgKiBlLCB0aGlzLnogKz0gKHQueiAtIHRoaXMueikgKiBlLCB0aGlzOwogIH0KICBsZXJwVmVjdG9ycyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54ICsgKGUueCAtIHQueCkgKiBpLCB0aGlzLnkgPSB0LnkgKyAoZS55IC0gdC55KSAqIGksIHRoaXMueiA9IHQueiArIChlLnogLSB0LnopICogaSwgdGhpczsKICB9CiAgY3Jvc3ModCkgewogICAgcmV0dXJuIHRoaXMuY3Jvc3NWZWN0b3JzKHRoaXMsIHQpOwogIH0KICBjcm9zc1ZlY3RvcnModCwgZSkgewogICAgY29uc3QgaSA9IHQueCwgbiA9IHQueSwgcyA9IHQueiwgciA9IGUueCwgbyA9IGUueSwgbCA9IGUuejsKICAgIHJldHVybiB0aGlzLnggPSBuICogbCAtIHMgKiBvLCB0aGlzLnkgPSBzICogciAtIGkgKiBsLCB0aGlzLnogPSBpICogbyAtIG4gKiByLCB0aGlzOwogIH0KICBwcm9qZWN0T25WZWN0b3IodCkgewogICAgY29uc3QgZSA9IHQubGVuZ3RoU3EoKTsKICAgIGlmIChlID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCk7CiAgICBjb25zdCBpID0gdC5kb3QodGhpcykgLyBlOwogICAgcmV0dXJuIHRoaXMuY29weSh0KS5tdWx0aXBseVNjYWxhcihpKTsKICB9CiAgcHJvamVjdE9uUGxhbmUodCkgewogICAgcmV0dXJuIHhkLmNvcHkodGhpcykucHJvamVjdE9uVmVjdG9yKHQpLCB0aGlzLnN1Yih4ZCk7CiAgfQogIHJlZmxlY3QodCkgewogICAgcmV0dXJuIHRoaXMuc3ViKHhkLmNvcHkodCkubXVsdGlwbHlTY2FsYXIoMiAqIHRoaXMuZG90KHQpKSk7CiAgfQogIGFuZ2xlVG8odCkgewogICAgY29uc3QgZSA9IE1hdGguc3FydCh0aGlzLmxlbmd0aFNxKCkgKiB0Lmxlbmd0aFNxKCkpOwogICAgaWYgKGUgPT09IDApIHJldHVybiBNYXRoLlBJIC8gMjsKICAgIGNvbnN0IGkgPSB0aGlzLmRvdCh0KSAvIGU7CiAgICByZXR1cm4gTWF0aC5hY29zKGFpKGksIC0xLCAxKSk7CiAgfQogIGRpc3RhbmNlVG8odCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLmRpc3RhbmNlVG9TcXVhcmVkKHQpKTsKICB9CiAgZGlzdGFuY2VUb1NxdWFyZWQodCkgewogICAgY29uc3QgZSA9IHRoaXMueCAtIHQueCwgaSA9IHRoaXMueSAtIHQueSwgbiA9IHRoaXMueiAtIHQuejsKICAgIHJldHVybiBlICogZSArIGkgKiBpICsgbiAqIG47CiAgfQogIG1hbmhhdHRhbkRpc3RhbmNlVG8odCkgewogICAgcmV0dXJuIE1hdGguYWJzKHRoaXMueCAtIHQueCkgKyBNYXRoLmFicyh0aGlzLnkgLSB0LnkpICsgTWF0aC5hYnModGhpcy56IC0gdC56KTsKICB9CiAgc2V0RnJvbVNwaGVyaWNhbCh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tU3BoZXJpY2FsQ29vcmRzKHQucmFkaXVzLCB0LnBoaSwgdC50aGV0YSk7CiAgfQogIHNldEZyb21TcGhlcmljYWxDb29yZHModCwgZSwgaSkgewogICAgY29uc3QgbiA9IE1hdGguc2luKGUpICogdDsKICAgIHJldHVybiB0aGlzLnggPSBuICogTWF0aC5zaW4oaSksIHRoaXMueSA9IE1hdGguY29zKGUpICogdCwgdGhpcy56ID0gbiAqIE1hdGguY29zKGkpLCB0aGlzOwogIH0KICBzZXRGcm9tQ3lsaW5kcmljYWwodCkgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbUN5bGluZHJpY2FsQ29vcmRzKHQucmFkaXVzLCB0LnRoZXRhLCB0LnkpOwogIH0KICBzZXRGcm9tQ3lsaW5kcmljYWxDb29yZHModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQgKiBNYXRoLnNpbihlKSwgdGhpcy55ID0gaSwgdGhpcy56ID0gdCAqIE1hdGguY29zKGUpLCB0aGlzOwogIH0KICBzZXRGcm9tTWF0cml4UG9zaXRpb24odCkgewogICAgY29uc3QgZSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy54ID0gZVsxMl0sIHRoaXMueSA9IGVbMTNdLCB0aGlzLnogPSBlWzE0XSwgdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeFNjYWxlKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4odCwgMCkubGVuZ3RoKCksIGkgPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4odCwgMSkubGVuZ3RoKCksIG4gPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4odCwgMikubGVuZ3RoKCk7CiAgICByZXR1cm4gdGhpcy54ID0gZSwgdGhpcy55ID0gaSwgdGhpcy56ID0gbiwgdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeENvbHVtbih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkodC5lbGVtZW50cywgZSAqIDQpOwogIH0KICBzZXRGcm9tTWF0cml4M0NvbHVtbih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkodC5lbGVtZW50cywgZSAqIDMpOwogIH0KICBzZXRGcm9tRXVsZXIodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQuX3gsIHRoaXMueSA9IHQuX3ksIHRoaXMueiA9IHQuX3osIHRoaXM7CiAgfQogIHNldEZyb21Db2xvcih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC5yLCB0aGlzLnkgPSB0LmcsIHRoaXMueiA9IHQuYiwgdGhpczsKICB9CiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0LnggPT09IHRoaXMueCAmJiB0LnkgPT09IHRoaXMueSAmJiB0LnogPT09IHRoaXMuejsKICB9CiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdFtlXSwgdGhpcy55ID0gdFtlICsgMV0sIHRoaXMueiA9IHRbZSArIDJdLCB0aGlzOwogIH0KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIHJldHVybiB0W2VdID0gdGhpcy54LCB0W2UgKyAxXSA9IHRoaXMueSwgdFtlICsgMl0gPSB0aGlzLnosIHQ7CiAgfQogIGZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQuZ2V0WChlKSwgdGhpcy55ID0gdC5nZXRZKGUpLCB0aGlzLnogPSB0LmdldFooZSksIHRoaXM7CiAgfQogIHJhbmRvbSgpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLnJhbmRvbSgpLCB0aGlzLnkgPSBNYXRoLnJhbmRvbSgpLCB0aGlzLnogPSBNYXRoLnJhbmRvbSgpLCB0aGlzOwogIH0KICByYW5kb21EaXJlY3Rpb24oKSB7CiAgICBjb25zdCB0ID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyLCBlID0gTWF0aC5yYW5kb20oKSAqIDIgLSAxLCBpID0gTWF0aC5zcXJ0KDEgLSBlICogZSk7CiAgICByZXR1cm4gdGhpcy54ID0gaSAqIE1hdGguY29zKHQpLCB0aGlzLnkgPSBlLCB0aGlzLnogPSBpICogTWF0aC5zaW4odCksIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueCwgeWllbGQgdGhpcy55LCB5aWVsZCB0aGlzLno7CiAgfQp9Owpjb25zdCB4ZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgQmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IHFvKCk7CmNsYXNzIFVzIHsKICBjb25zdHJ1Y3Rvcih0ID0gbmV3IHR0KDEgLyAwLCAxIC8gMCwgMSAvIDApLCBlID0gbmV3IHR0KC0xIC8gMCwgLTEgLyAwLCAtMSAvIDApKSB7CiAgICB0aGlzLmlzQm94MyA9ICEwLCB0aGlzLm1pbiA9IHQsIHRoaXMubWF4ID0gZTsKICB9CiAgc2V0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm1pbi5jb3B5KHQpLCB0aGlzLm1heC5jb3B5KGUpLCB0aGlzOwogIH0KICBzZXRGcm9tQXJyYXkodCkgewogICAgdGhpcy5tYWtlRW1wdHkoKTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5sZW5ndGg7IGUgPCBpOyBlICs9IDMpCiAgICAgIHRoaXMuZXhwYW5kQnlQb2ludCh0bi5mcm9tQXJyYXkodCwgZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21CdWZmZXJBdHRyaWJ1dGUodCkgewogICAgdGhpcy5tYWtlRW1wdHkoKTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgdGhpcy5leHBhbmRCeVBvaW50KHRuLmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21Qb2ludHModCkgewogICAgdGhpcy5tYWtlRW1wdHkoKTsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdC5sZW5ndGg7IGUgPCBpOyBlKyspCiAgICAgIHRoaXMuZXhwYW5kQnlQb2ludCh0W2VdKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tQ2VudGVyQW5kU2l6ZSh0LCBlKSB7CiAgICBjb25zdCBpID0gdG4uY29weShlKS5tdWx0aXBseVNjYWxhcigwLjUpOwogICAgcmV0dXJuIHRoaXMubWluLmNvcHkodCkuc3ViKGkpLCB0aGlzLm1heC5jb3B5KHQpLmFkZChpKSwgdGhpczsKICB9CiAgc2V0RnJvbU9iamVjdCh0LCBlID0gITEpIHsKICAgIHJldHVybiB0aGlzLm1ha2VFbXB0eSgpLCB0aGlzLmV4cGFuZEJ5T2JqZWN0KHQsIGUpOwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMubWluLmNvcHkodC5taW4pLCB0aGlzLm1heC5jb3B5KHQubWF4KSwgdGhpczsKICB9CiAgbWFrZUVtcHR5KCkgewogICAgcmV0dXJuIHRoaXMubWluLnggPSB0aGlzLm1pbi55ID0gdGhpcy5taW4ueiA9IDEgLyAwLCB0aGlzLm1heC54ID0gdGhpcy5tYXgueSA9IHRoaXMubWF4LnogPSAtMSAvIDAsIHRoaXM7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5tYXgueCA8IHRoaXMubWluLnggfHwgdGhpcy5tYXgueSA8IHRoaXMubWluLnkgfHwgdGhpcy5tYXgueiA8IHRoaXMubWluLno7CiAgfQogIGdldENlbnRlcih0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0LnNldCgwLCAwLCAwKSA6IHQuYWRkVmVjdG9ycyh0aGlzLm1pbiwgdGhpcy5tYXgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgfQogIGdldFNpemUodCkgewogICAgcmV0dXJuIHRoaXMuaXNFbXB0eSgpID8gdC5zZXQoMCwgMCwgMCkgOiB0LnN1YlZlY3RvcnModGhpcy5tYXgsIHRoaXMubWluKTsKICB9CiAgZXhwYW5kQnlQb2ludCh0KSB7CiAgICByZXR1cm4gdGhpcy5taW4ubWluKHQpLCB0aGlzLm1heC5tYXgodCksIHRoaXM7CiAgfQogIGV4cGFuZEJ5VmVjdG9yKHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi5zdWIodCksIHRoaXMubWF4LmFkZCh0KSwgdGhpczsKICB9CiAgZXhwYW5kQnlTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubWluLmFkZFNjYWxhcigtdCksIHRoaXMubWF4LmFkZFNjYWxhcih0KSwgdGhpczsKICB9CiAgZXhwYW5kQnlPYmplY3QodCwgZSA9ICExKSB7CiAgICB0LnVwZGF0ZVdvcmxkTWF0cml4KCExLCAhMSk7CiAgICBjb25zdCBpID0gdC5nZW9tZXRyeTsKICAgIGlmIChpICE9PSB2b2lkIDApIHsKICAgICAgY29uc3QgcyA9IGkuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpOwogICAgICBpZiAoZSA9PT0gITAgJiYgcyAhPT0gdm9pZCAwICYmIHQuaXNJbnN0YW5jZWRNZXNoICE9PSAhMCkKICAgICAgICBmb3IgKGxldCByID0gMCwgbyA9IHMuY291bnQ7IHIgPCBvOyByKyspCiAgICAgICAgICB0LmlzTWVzaCA9PT0gITAgPyB0LmdldFZlcnRleFBvc2l0aW9uKHIsIHRuKSA6IHRuLmZyb21CdWZmZXJBdHRyaWJ1dGUocywgciksIHRuLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkKSwgdGhpcy5leHBhbmRCeVBvaW50KHRuKTsKICAgICAgZWxzZQogICAgICAgIHQuYm91bmRpbmdCb3ggIT09IHZvaWQgMCA/ICh0LmJvdW5kaW5nQm94ID09PSBudWxsICYmIHQuY29tcHV0ZUJvdW5kaW5nQm94KCksIGpsLmNvcHkodC5ib3VuZGluZ0JveCkpIDogKGkuYm91bmRpbmdCb3ggPT09IG51bGwgJiYgaS5jb21wdXRlQm91bmRpbmdCb3goKSwgamwuY29weShpLmJvdW5kaW5nQm94KSksIGpsLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkKSwgdGhpcy51bmlvbihqbCk7CiAgICB9CiAgICBjb25zdCBuID0gdC5jaGlsZHJlbjsKICAgIGZvciAobGV0IHMgPSAwLCByID0gbi5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgIHRoaXMuZXhwYW5kQnlPYmplY3QobltzXSwgZSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY29udGFpbnNQb2ludCh0KSB7CiAgICByZXR1cm4gdC54ID49IHRoaXMubWluLnggJiYgdC54IDw9IHRoaXMubWF4LnggJiYgdC55ID49IHRoaXMubWluLnkgJiYgdC55IDw9IHRoaXMubWF4LnkgJiYgdC56ID49IHRoaXMubWluLnogJiYgdC56IDw9IHRoaXMubWF4Lno7CiAgfQogIGNvbnRhaW5zQm94KHQpIHsKICAgIHJldHVybiB0aGlzLm1pbi54IDw9IHQubWluLnggJiYgdC5tYXgueCA8PSB0aGlzLm1heC54ICYmIHRoaXMubWluLnkgPD0gdC5taW4ueSAmJiB0Lm1heC55IDw9IHRoaXMubWF4LnkgJiYgdGhpcy5taW4ueiA8PSB0Lm1pbi56ICYmIHQubWF4LnogPD0gdGhpcy5tYXguejsKICB9CiAgZ2V0UGFyYW1ldGVyKHQsIGUpIHsKICAgIHJldHVybiBlLnNldCgKICAgICAgKHQueCAtIHRoaXMubWluLngpIC8gKHRoaXMubWF4LnggLSB0aGlzLm1pbi54KSwKICAgICAgKHQueSAtIHRoaXMubWluLnkpIC8gKHRoaXMubWF4LnkgLSB0aGlzLm1pbi55KSwKICAgICAgKHQueiAtIHRoaXMubWluLnopIC8gKHRoaXMubWF4LnogLSB0aGlzLm1pbi56KQogICAgKTsKICB9CiAgaW50ZXJzZWN0c0JveCh0KSB7CiAgICByZXR1cm4gdC5tYXgueCA+PSB0aGlzLm1pbi54ICYmIHQubWluLnggPD0gdGhpcy5tYXgueCAmJiB0Lm1heC55ID49IHRoaXMubWluLnkgJiYgdC5taW4ueSA8PSB0aGlzLm1heC55ICYmIHQubWF4LnogPj0gdGhpcy5taW4ueiAmJiB0Lm1pbi56IDw9IHRoaXMubWF4Lno7CiAgfQogIGludGVyc2VjdHNTcGhlcmUodCkgewogICAgcmV0dXJuIHRoaXMuY2xhbXBQb2ludCh0LmNlbnRlciwgdG4pLCB0bi5kaXN0YW5jZVRvU3F1YXJlZCh0LmNlbnRlcikgPD0gdC5yYWRpdXMgKiB0LnJhZGl1czsKICB9CiAgaW50ZXJzZWN0c1BsYW5lKHQpIHsKICAgIGxldCBlLCBpOwogICAgcmV0dXJuIHQubm9ybWFsLnggPiAwID8gKGUgPSB0Lm5vcm1hbC54ICogdGhpcy5taW4ueCwgaSA9IHQubm9ybWFsLnggKiB0aGlzLm1heC54KSA6IChlID0gdC5ub3JtYWwueCAqIHRoaXMubWF4LngsIGkgPSB0Lm5vcm1hbC54ICogdGhpcy5taW4ueCksIHQubm9ybWFsLnkgPiAwID8gKGUgKz0gdC5ub3JtYWwueSAqIHRoaXMubWluLnksIGkgKz0gdC5ub3JtYWwueSAqIHRoaXMubWF4LnkpIDogKGUgKz0gdC5ub3JtYWwueSAqIHRoaXMubWF4LnksIGkgKz0gdC5ub3JtYWwueSAqIHRoaXMubWluLnkpLCB0Lm5vcm1hbC56ID4gMCA/IChlICs9IHQubm9ybWFsLnogKiB0aGlzLm1pbi56LCBpICs9IHQubm9ybWFsLnogKiB0aGlzLm1heC56KSA6IChlICs9IHQubm9ybWFsLnogKiB0aGlzLm1heC56LCBpICs9IHQubm9ybWFsLnogKiB0aGlzLm1pbi56KSwgZSA8PSAtdC5jb25zdGFudCAmJiBpID49IC10LmNvbnN0YW50OwogIH0KICBpbnRlcnNlY3RzVHJpYW5nbGUodCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKQogICAgICByZXR1cm4gITE7CiAgICB0aGlzLmdldENlbnRlcihLYSksIEpsLnN1YlZlY3RvcnModGhpcy5tYXgsIEthKSwgR3Iuc3ViVmVjdG9ycyh0LmEsIEthKSwgV3Iuc3ViVmVjdG9ycyh0LmIsIEthKSwgcXIuc3ViVmVjdG9ycyh0LmMsIEthKSwgZHMuc3ViVmVjdG9ycyhXciwgR3IpLCBwcy5zdWJWZWN0b3JzKHFyLCBXciksIEtzLnN1YlZlY3RvcnMoR3IsIHFyKTsKICAgIGxldCBlID0gWwogICAgICAwLAogICAgICAtZHMueiwKICAgICAgZHMueSwKICAgICAgMCwKICAgICAgLXBzLnosCiAgICAgIHBzLnksCiAgICAgIDAsCiAgICAgIC1Lcy56LAogICAgICBLcy55LAogICAgICBkcy56LAogICAgICAwLAogICAgICAtZHMueCwKICAgICAgcHMueiwKICAgICAgMCwKICAgICAgLXBzLngsCiAgICAgIEtzLnosCiAgICAgIDAsCiAgICAgIC1Lcy54LAogICAgICAtZHMueSwKICAgICAgZHMueCwKICAgICAgMCwKICAgICAgLXBzLnksCiAgICAgIHBzLngsCiAgICAgIDAsCiAgICAgIC1Lcy55LAogICAgICBLcy54LAogICAgICAwCiAgICBdOwogICAgcmV0dXJuICF2ZChlLCBHciwgV3IsIHFyLCBKbCkgfHwgKGUgPSBbMSwgMCwgMCwgMCwgMSwgMCwgMCwgMCwgMV0sICF2ZChlLCBHciwgV3IsIHFyLCBKbCkpID8gITEgOiAoS2wuY3Jvc3NWZWN0b3JzKGRzLCBwcyksIGUgPSBbS2wueCwgS2wueSwgS2wuel0sIHZkKGUsIEdyLCBXciwgcXIsIEpsKSk7CiAgfQogIGNsYW1wUG9pbnQodCwgZSkgewogICAgcmV0dXJuIGUuY29weSh0KS5jbGFtcCh0aGlzLm1pbiwgdGhpcy5tYXgpOwogIH0KICBkaXN0YW5jZVRvUG9pbnQodCkgewogICAgcmV0dXJuIHRoaXMuY2xhbXBQb2ludCh0LCB0bikuZGlzdGFuY2VUbyh0KTsKICB9CiAgZ2V0Qm91bmRpbmdTcGhlcmUodCkgewogICAgcmV0dXJuIHRoaXMuaXNFbXB0eSgpID8gdC5tYWtlRW1wdHkoKSA6ICh0aGlzLmdldENlbnRlcih0LmNlbnRlciksIHQucmFkaXVzID0gdGhpcy5nZXRTaXplKHRuKS5sZW5ndGgoKSAqIDAuNSksIHQ7CiAgfQogIGludGVyc2VjdCh0KSB7CiAgICByZXR1cm4gdGhpcy5taW4ubWF4KHQubWluKSwgdGhpcy5tYXgubWluKHQubWF4KSwgdGhpcy5pc0VtcHR5KCkgJiYgdGhpcy5tYWtlRW1wdHkoKSwgdGhpczsKICB9CiAgdW5pb24odCkgewogICAgcmV0dXJuIHRoaXMubWluLm1pbih0Lm1pbiksIHRoaXMubWF4Lm1heCh0Lm1heCksIHRoaXM7CiAgfQogIGFwcGx5TWF0cml4NCh0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0aGlzIDogKE9uWzBdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1pbi55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIE9uWzFdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1pbi55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIE9uWzJdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1heC55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIE9uWzNdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1heC55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIE9uWzRdLnNldCh0aGlzLm1heC54LCB0aGlzLm1pbi55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIE9uWzVdLnNldCh0aGlzLm1heC54LCB0aGlzLm1pbi55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIE9uWzZdLnNldCh0aGlzLm1heC54LCB0aGlzLm1heC55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksIE9uWzddLnNldCh0aGlzLm1heC54LCB0aGlzLm1heC55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksIHRoaXMuc2V0RnJvbVBvaW50cyhPbiksIHRoaXMpOwogIH0KICB0cmFuc2xhdGUodCkgewogICAgcmV0dXJuIHRoaXMubWluLmFkZCh0KSwgdGhpcy5tYXguYWRkKHQpLCB0aGlzOwogIH0KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQubWluLmVxdWFscyh0aGlzLm1pbikgJiYgdC5tYXguZXF1YWxzKHRoaXMubWF4KTsKICB9Cn0KY29uc3QgT24gPSBbCiAgLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksCiAgLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksCiAgLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKQpdLCB0biA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgamwgPSAvKiBAX19QVVJFX18gKi8gbmV3IFVzKCksIEdyID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBXciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgcXIgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIGRzID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBwcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgS3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIEthID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBKbCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgS2wgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIFFzID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpOwpmdW5jdGlvbiB2ZChhLCB0LCBlLCBpLCBuKSB7CiAgZm9yIChsZXQgcyA9IDAsIHIgPSBhLmxlbmd0aCAtIDM7IHMgPD0gcjsgcyArPSAzKSB7CiAgICBRcy5mcm9tQXJyYXkoYSwgcyk7CiAgICBjb25zdCBvID0gbi54ICogTWF0aC5hYnMoUXMueCkgKyBuLnkgKiBNYXRoLmFicyhRcy55KSArIG4ueiAqIE1hdGguYWJzKFFzLnopLCBsID0gdC5kb3QoUXMpLCBoID0gZS5kb3QoUXMpLCBjID0gaS5kb3QoUXMpOwogICAgaWYgKE1hdGgubWF4KC1NYXRoLm1heChsLCBoLCBjKSwgTWF0aC5taW4obCwgaCwgYykpID4gbykKICAgICAgcmV0dXJuICExOwogIH0KICByZXR1cm4gITA7Cn0KY29uc3Qga1QgPSAvKiBAX19QVVJFX18gKi8gbmV3IFVzKCksIFFhID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBiZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKTsKY2xhc3MgdXUgewogIGNvbnN0cnVjdG9yKHQgPSBuZXcgdHQoKSwgZSA9IC0xKSB7CiAgICB0aGlzLmlzU3BoZXJlID0gITAsIHRoaXMuY2VudGVyID0gdCwgdGhpcy5yYWRpdXMgPSBlOwogIH0KICBzZXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMuY2VudGVyLmNvcHkodCksIHRoaXMucmFkaXVzID0gZSwgdGhpczsKICB9CiAgc2V0RnJvbVBvaW50cyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5jZW50ZXI7CiAgICBlICE9PSB2b2lkIDAgPyBpLmNvcHkoZSkgOiBrVC5zZXRGcm9tUG9pbnRzKHQpLmdldENlbnRlcihpKTsKICAgIGxldCBuID0gMDsKICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgIG4gPSBNYXRoLm1heChuLCBpLmRpc3RhbmNlVG9TcXVhcmVkKHRbc10pKTsKICAgIHJldHVybiB0aGlzLnJhZGl1cyA9IE1hdGguc3FydChuKSwgdGhpczsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5jZW50ZXIuY29weSh0LmNlbnRlciksIHRoaXMucmFkaXVzID0gdC5yYWRpdXMsIHRoaXM7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5yYWRpdXMgPCAwOwogIH0KICBtYWtlRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5jZW50ZXIuc2V0KDAsIDAsIDApLCB0aGlzLnJhZGl1cyA9IC0xLCB0aGlzOwogIH0KICBjb250YWluc1BvaW50KHQpIHsKICAgIHJldHVybiB0LmRpc3RhbmNlVG9TcXVhcmVkKHRoaXMuY2VudGVyKSA8PSB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzOwogIH0KICBkaXN0YW5jZVRvUG9pbnQodCkgewogICAgcmV0dXJuIHQuZGlzdGFuY2VUbyh0aGlzLmNlbnRlcikgLSB0aGlzLnJhZGl1czsKICB9CiAgaW50ZXJzZWN0c1NwaGVyZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5yYWRpdXMgKyB0LnJhZGl1czsKICAgIHJldHVybiB0LmNlbnRlci5kaXN0YW5jZVRvU3F1YXJlZCh0aGlzLmNlbnRlcikgPD0gZSAqIGU7CiAgfQogIGludGVyc2VjdHNCb3godCkgewogICAgcmV0dXJuIHQuaW50ZXJzZWN0c1NwaGVyZSh0aGlzKTsKICB9CiAgaW50ZXJzZWN0c1BsYW5lKHQpIHsKICAgIHJldHVybiBNYXRoLmFicyh0LmRpc3RhbmNlVG9Qb2ludCh0aGlzLmNlbnRlcikpIDw9IHRoaXMucmFkaXVzOwogIH0KICBjbGFtcFBvaW50KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmNlbnRlci5kaXN0YW5jZVRvU3F1YXJlZCh0KTsKICAgIHJldHVybiBlLmNvcHkodCksIGkgPiB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzICYmIChlLnN1Yih0aGlzLmNlbnRlcikubm9ybWFsaXplKCksIGUubXVsdGlwbHlTY2FsYXIodGhpcy5yYWRpdXMpLmFkZCh0aGlzLmNlbnRlcikpLCBlOwogIH0KICBnZXRCb3VuZGluZ0JveCh0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyAodC5tYWtlRW1wdHkoKSwgdCkgOiAodC5zZXQodGhpcy5jZW50ZXIsIHRoaXMuY2VudGVyKSwgdC5leHBhbmRCeVNjYWxhcih0aGlzLnJhZGl1cyksIHQpOwogIH0KICBhcHBseU1hdHJpeDQodCkgewogICAgcmV0dXJuIHRoaXMuY2VudGVyLmFwcGx5TWF0cml4NCh0KSwgdGhpcy5yYWRpdXMgPSB0aGlzLnJhZGl1cyAqIHQuZ2V0TWF4U2NhbGVPbkF4aXMoKSwgdGhpczsKICB9CiAgdHJhbnNsYXRlKHQpIHsKICAgIHJldHVybiB0aGlzLmNlbnRlci5hZGQodCksIHRoaXM7CiAgfQogIGV4cGFuZEJ5UG9pbnQodCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKQogICAgICByZXR1cm4gdGhpcy5jZW50ZXIuY29weSh0KSwgdGhpcy5yYWRpdXMgPSAwLCB0aGlzOwogICAgUWEuc3ViVmVjdG9ycyh0LCB0aGlzLmNlbnRlcik7CiAgICBjb25zdCBlID0gUWEubGVuZ3RoU3EoKTsKICAgIGlmIChlID4gdGhpcy5yYWRpdXMgKiB0aGlzLnJhZGl1cykgewogICAgICBjb25zdCBpID0gTWF0aC5zcXJ0KGUpLCBuID0gKGkgLSB0aGlzLnJhZGl1cykgKiAwLjU7CiAgICAgIHRoaXMuY2VudGVyLmFkZFNjYWxlZFZlY3RvcihRYSwgbiAvIGkpLCB0aGlzLnJhZGl1cyArPSBuOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHVuaW9uKHQpIHsKICAgIHJldHVybiB0LmlzRW1wdHkoKSA/IHRoaXMgOiB0aGlzLmlzRW1wdHkoKSA/ICh0aGlzLmNvcHkodCksIHRoaXMpIDogKHRoaXMuY2VudGVyLmVxdWFscyh0LmNlbnRlcikgPT09ICEwID8gdGhpcy5yYWRpdXMgPSBNYXRoLm1heCh0aGlzLnJhZGl1cywgdC5yYWRpdXMpIDogKGJkLnN1YlZlY3RvcnModC5jZW50ZXIsIHRoaXMuY2VudGVyKS5zZXRMZW5ndGgodC5yYWRpdXMpLCB0aGlzLmV4cGFuZEJ5UG9pbnQoUWEuY29weSh0LmNlbnRlcikuYWRkKGJkKSksIHRoaXMuZXhwYW5kQnlQb2ludChRYS5jb3B5KHQuY2VudGVyKS5zdWIoYmQpKSksIHRoaXMpOwogIH0KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuY2VudGVyLmVxdWFscyh0aGlzLmNlbnRlcikgJiYgdC5yYWRpdXMgPT09IHRoaXMucmFkaXVzOwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQp9CmNvbnN0IGtuID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBNZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgUWwgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIGZzID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBTZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgdGggPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIHdkID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpOwpjbGFzcyBWVCB7CiAgY29uc3RydWN0b3IodCA9IG5ldyB0dCgpLCBlID0gbmV3IHR0KDAsIDAsIC0xKSkgewogICAgdGhpcy5vcmlnaW4gPSB0LCB0aGlzLmRpcmVjdGlvbiA9IGU7CiAgfQogIHNldCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5vcmlnaW4uY29weSh0KSwgdGhpcy5kaXJlY3Rpb24uY29weShlKSwgdGhpczsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5vcmlnaW4uY29weSh0Lm9yaWdpbiksIHRoaXMuZGlyZWN0aW9uLmNvcHkodC5kaXJlY3Rpb24pLCB0aGlzOwogIH0KICBhdCh0LCBlKSB7CiAgICByZXR1cm4gZS5jb3B5KHRoaXMub3JpZ2luKS5hZGRTY2FsZWRWZWN0b3IodGhpcy5kaXJlY3Rpb24sIHQpOwogIH0KICBsb29rQXQodCkgewogICAgcmV0dXJuIHRoaXMuZGlyZWN0aW9uLmNvcHkodCkuc3ViKHRoaXMub3JpZ2luKS5ub3JtYWxpemUoKSwgdGhpczsKICB9CiAgcmVjYXN0KHQpIHsKICAgIHJldHVybiB0aGlzLm9yaWdpbi5jb3B5KHRoaXMuYXQodCwga24pKSwgdGhpczsKICB9CiAgY2xvc2VzdFBvaW50VG9Qb2ludCh0LCBlKSB7CiAgICBlLnN1YlZlY3RvcnModCwgdGhpcy5vcmlnaW4pOwogICAgY29uc3QgaSA9IGUuZG90KHRoaXMuZGlyZWN0aW9uKTsKICAgIHJldHVybiBpIDwgMCA/IGUuY29weSh0aGlzLm9yaWdpbikgOiBlLmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgaSk7CiAgfQogIGRpc3RhbmNlVG9Qb2ludCh0KSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuZGlzdGFuY2VTcVRvUG9pbnQodCkpOwogIH0KICBkaXN0YW5jZVNxVG9Qb2ludCh0KSB7CiAgICBjb25zdCBlID0ga24uc3ViVmVjdG9ycyh0LCB0aGlzLm9yaWdpbikuZG90KHRoaXMuZGlyZWN0aW9uKTsKICAgIHJldHVybiBlIDwgMCA/IHRoaXMub3JpZ2luLmRpc3RhbmNlVG9TcXVhcmVkKHQpIDogKGtuLmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgZSksIGtuLmRpc3RhbmNlVG9TcXVhcmVkKHQpKTsKICB9CiAgZGlzdGFuY2VTcVRvU2VnbWVudCh0LCBlLCBpLCBuKSB7CiAgICBNZC5jb3B5KHQpLmFkZChlKS5tdWx0aXBseVNjYWxhcigwLjUpLCBRbC5jb3B5KGUpLnN1Yih0KS5ub3JtYWxpemUoKSwgZnMuY29weSh0aGlzLm9yaWdpbikuc3ViKE1kKTsKICAgIGNvbnN0IHMgPSB0LmRpc3RhbmNlVG8oZSkgKiAwLjUsIHIgPSAtdGhpcy5kaXJlY3Rpb24uZG90KFFsKSwgbyA9IGZzLmRvdCh0aGlzLmRpcmVjdGlvbiksIGwgPSAtZnMuZG90KFFsKSwgaCA9IGZzLmxlbmd0aFNxKCksIGMgPSBNYXRoLmFicygxIC0gciAqIHIpOwogICAgbGV0IHUsIGQsIHAsIGY7CiAgICBpZiAoYyA+IDApCiAgICAgIGlmICh1ID0gciAqIGwgLSBvLCBkID0gciAqIG8gLSBsLCBmID0gcyAqIGMsIHUgPj0gMCkKICAgICAgICBpZiAoZCA+PSAtZikKICAgICAgICAgIGlmIChkIDw9IGYpIHsKICAgICAgICAgICAgY29uc3QgeSA9IDEgLyBjOwogICAgICAgICAgICB1ICo9IHksIGQgKj0geSwgcCA9IHUgKiAodSArIHIgKiBkICsgMiAqIG8pICsgZCAqIChyICogdSArIGQgKyAyICogbCkgKyBoOwogICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgIGQgPSBzLCB1ID0gTWF0aC5tYXgoMCwgLShyICogZCArIG8pKSwgcCA9IC11ICogdSArIGQgKiAoZCArIDIgKiBsKSArIGg7CiAgICAgICAgZWxzZQogICAgICAgICAgZCA9IC1zLCB1ID0gTWF0aC5tYXgoMCwgLShyICogZCArIG8pKSwgcCA9IC11ICogdSArIGQgKiAoZCArIDIgKiBsKSArIGg7CiAgICAgIGVsc2UKICAgICAgICBkIDw9IC1mID8gKHUgPSBNYXRoLm1heCgwLCAtKC1yICogcyArIG8pKSwgZCA9IHUgPiAwID8gLXMgOiBNYXRoLm1pbihNYXRoLm1heCgtcywgLWwpLCBzKSwgcCA9IC11ICogdSArIGQgKiAoZCArIDIgKiBsKSArIGgpIDogZCA8PSBmID8gKHUgPSAwLCBkID0gTWF0aC5taW4oTWF0aC5tYXgoLXMsIC1sKSwgcyksIHAgPSBkICogKGQgKyAyICogbCkgKyBoKSA6ICh1ID0gTWF0aC5tYXgoMCwgLShyICogcyArIG8pKSwgZCA9IHUgPiAwID8gcyA6IE1hdGgubWluKE1hdGgubWF4KC1zLCAtbCksIHMpLCBwID0gLXUgKiB1ICsgZCAqIChkICsgMiAqIGwpICsgaCk7CiAgICBlbHNlCiAgICAgIGQgPSByID4gMCA/IC1zIDogcywgdSA9IE1hdGgubWF4KDAsIC0ociAqIGQgKyBvKSksIHAgPSAtdSAqIHUgKyBkICogKGQgKyAyICogbCkgKyBoOwogICAgcmV0dXJuIGkgJiYgaS5jb3B5KHRoaXMub3JpZ2luKS5hZGRTY2FsZWRWZWN0b3IodGhpcy5kaXJlY3Rpb24sIHUpLCBuICYmIG4uY29weShNZCkuYWRkU2NhbGVkVmVjdG9yKFFsLCBkKSwgcDsKICB9CiAgaW50ZXJzZWN0U3BoZXJlKHQsIGUpIHsKICAgIGtuLnN1YlZlY3RvcnModC5jZW50ZXIsIHRoaXMub3JpZ2luKTsKICAgIGNvbnN0IGkgPSBrbi5kb3QodGhpcy5kaXJlY3Rpb24pLCBuID0ga24uZG90KGtuKSAtIGkgKiBpLCBzID0gdC5yYWRpdXMgKiB0LnJhZGl1czsKICAgIGlmIChuID4gcykgcmV0dXJuIG51bGw7CiAgICBjb25zdCByID0gTWF0aC5zcXJ0KHMgLSBuKSwgbyA9IGkgLSByLCBsID0gaSArIHI7CiAgICByZXR1cm4gbCA8IDAgPyBudWxsIDogbyA8IDAgPyB0aGlzLmF0KGwsIGUpIDogdGhpcy5hdChvLCBlKTsKICB9CiAgaW50ZXJzZWN0c1NwaGVyZSh0KSB7CiAgICByZXR1cm4gdGhpcy5kaXN0YW5jZVNxVG9Qb2ludCh0LmNlbnRlcikgPD0gdC5yYWRpdXMgKiB0LnJhZGl1czsKICB9CiAgZGlzdGFuY2VUb1BsYW5lKHQpIHsKICAgIGNvbnN0IGUgPSB0Lm5vcm1hbC5kb3QodGhpcy5kaXJlY3Rpb24pOwogICAgaWYgKGUgPT09IDApCiAgICAgIHJldHVybiB0LmRpc3RhbmNlVG9Qb2ludCh0aGlzLm9yaWdpbikgPT09IDAgPyAwIDogbnVsbDsKICAgIGNvbnN0IGkgPSAtKHRoaXMub3JpZ2luLmRvdCh0Lm5vcm1hbCkgKyB0LmNvbnN0YW50KSAvIGU7CiAgICByZXR1cm4gaSA+PSAwID8gaSA6IG51bGw7CiAgfQogIGludGVyc2VjdFBsYW5lKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmRpc3RhbmNlVG9QbGFuZSh0KTsKICAgIHJldHVybiBpID09PSBudWxsID8gbnVsbCA6IHRoaXMuYXQoaSwgZSk7CiAgfQogIGludGVyc2VjdHNQbGFuZSh0KSB7CiAgICBjb25zdCBlID0gdC5kaXN0YW5jZVRvUG9pbnQodGhpcy5vcmlnaW4pOwogICAgcmV0dXJuIGUgPT09IDAgfHwgdC5ub3JtYWwuZG90KHRoaXMuZGlyZWN0aW9uKSAqIGUgPCAwOwogIH0KICBpbnRlcnNlY3RCb3godCwgZSkgewogICAgbGV0IGksIG4sIHMsIHIsIG8sIGw7CiAgICBjb25zdCBoID0gMSAvIHRoaXMuZGlyZWN0aW9uLngsIGMgPSAxIC8gdGhpcy5kaXJlY3Rpb24ueSwgdSA9IDEgLyB0aGlzLmRpcmVjdGlvbi56LCBkID0gdGhpcy5vcmlnaW47CiAgICByZXR1cm4gaCA+PSAwID8gKGkgPSAodC5taW4ueCAtIGQueCkgKiBoLCBuID0gKHQubWF4LnggLSBkLngpICogaCkgOiAoaSA9ICh0Lm1heC54IC0gZC54KSAqIGgsIG4gPSAodC5taW4ueCAtIGQueCkgKiBoKSwgYyA+PSAwID8gKHMgPSAodC5taW4ueSAtIGQueSkgKiBjLCByID0gKHQubWF4LnkgLSBkLnkpICogYykgOiAocyA9ICh0Lm1heC55IC0gZC55KSAqIGMsIHIgPSAodC5taW4ueSAtIGQueSkgKiBjKSwgaSA+IHIgfHwgcyA+IG4gfHwgKChzID4gaSB8fCBpc05hTihpKSkgJiYgKGkgPSBzKSwgKHIgPCBuIHx8IGlzTmFOKG4pKSAmJiAobiA9IHIpLCB1ID49IDAgPyAobyA9ICh0Lm1pbi56IC0gZC56KSAqIHUsIGwgPSAodC5tYXgueiAtIGQueikgKiB1KSA6IChvID0gKHQubWF4LnogLSBkLnopICogdSwgbCA9ICh0Lm1pbi56IC0gZC56KSAqIHUpLCBpID4gbCB8fCBvID4gbikgfHwgKChvID4gaSB8fCBpICE9PSBpKSAmJiAoaSA9IG8pLCAobCA8IG4gfHwgbiAhPT0gbikgJiYgKG4gPSBsKSwgbiA8IDApID8gbnVsbCA6IHRoaXMuYXQoaSA+PSAwID8gaSA6IG4sIGUpOwogIH0KICBpbnRlcnNlY3RzQm94KHQpIHsKICAgIHJldHVybiB0aGlzLmludGVyc2VjdEJveCh0LCBrbikgIT09IG51bGw7CiAgfQogIGludGVyc2VjdFRyaWFuZ2xlKHQsIGUsIGksIG4sIHMpIHsKICAgIFNkLnN1YlZlY3RvcnMoZSwgdCksIHRoLnN1YlZlY3RvcnMoaSwgdCksIHdkLmNyb3NzVmVjdG9ycyhTZCwgdGgpOwogICAgbGV0IHIgPSB0aGlzLmRpcmVjdGlvbi5kb3Qod2QpLCBvOwogICAgaWYgKHIgPiAwKSB7CiAgICAgIGlmIChuKSByZXR1cm4gbnVsbDsKICAgICAgbyA9IDE7CiAgICB9IGVsc2UgaWYgKHIgPCAwKQogICAgICBvID0gLTEsIHIgPSAtcjsKICAgIGVsc2UKICAgICAgcmV0dXJuIG51bGw7CiAgICBmcy5zdWJWZWN0b3JzKHRoaXMub3JpZ2luLCB0KTsKICAgIGNvbnN0IGwgPSBvICogdGhpcy5kaXJlY3Rpb24uZG90KHRoLmNyb3NzVmVjdG9ycyhmcywgdGgpKTsKICAgIGlmIChsIDwgMCkKICAgICAgcmV0dXJuIG51bGw7CiAgICBjb25zdCBoID0gbyAqIHRoaXMuZGlyZWN0aW9uLmRvdChTZC5jcm9zcyhmcykpOwogICAgaWYgKGggPCAwIHx8IGwgKyBoID4gcikKICAgICAgcmV0dXJuIG51bGw7CiAgICBjb25zdCBjID0gLW8gKiBmcy5kb3Qod2QpOwogICAgcmV0dXJuIGMgPCAwID8gbnVsbCA6IHRoaXMuYXQoYyAvIHIsIHMpOwogIH0KICBhcHBseU1hdHJpeDQodCkgewogICAgcmV0dXJuIHRoaXMub3JpZ2luLmFwcGx5TWF0cml4NCh0KSwgdGhpcy5kaXJlY3Rpb24udHJhbnNmb3JtRGlyZWN0aW9uKHQpLCB0aGlzOwogIH0KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQub3JpZ2luLmVxdWFscyh0aGlzLm9yaWdpbikgJiYgdC5kaXJlY3Rpb24uZXF1YWxzKHRoaXMuZGlyZWN0aW9uKTsKICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KHRoaXMpOwogIH0KfQpsZXQgUW4gPSBjbGFzcyB2cCB7CiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCwgYywgdSwgZCwgcCwgZiwgeSwgZykgewogICAgdnAucHJvdG90eXBlLmlzTWF0cml4NCA9ICEwLCB0aGlzLmVsZW1lbnRzID0gWwogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICBdLCB0ICE9PSB2b2lkIDAgJiYgdGhpcy5zZXQodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCwgYywgdSwgZCwgcCwgZiwgeSwgZyk7CiAgfQogIHNldCh0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoLCBjLCB1LCBkLCBwLCBmLCB5LCBnKSB7CiAgICBjb25zdCBtID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiBtWzBdID0gdCwgbVs0XSA9IGUsIG1bOF0gPSBpLCBtWzEyXSA9IG4sIG1bMV0gPSBzLCBtWzVdID0gciwgbVs5XSA9IG8sIG1bMTNdID0gbCwgbVsyXSA9IGgsIG1bNl0gPSBjLCBtWzEwXSA9IHUsIG1bMTRdID0gZCwgbVszXSA9IHAsIG1bN10gPSBmLCBtWzExXSA9IHksIG1bMTVdID0gZywgdGhpczsKICB9CiAgaWRlbnRpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB2cCgpLmZyb21BcnJheSh0aGlzLmVsZW1lbnRzKTsKICB9CiAgY29weSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gZVswXSA9IGlbMF0sIGVbMV0gPSBpWzFdLCBlWzJdID0gaVsyXSwgZVszXSA9IGlbM10sIGVbNF0gPSBpWzRdLCBlWzVdID0gaVs1XSwgZVs2XSA9IGlbNl0sIGVbN10gPSBpWzddLCBlWzhdID0gaVs4XSwgZVs5XSA9IGlbOV0sIGVbMTBdID0gaVsxMF0sIGVbMTFdID0gaVsxMV0sIGVbMTJdID0gaVsxMl0sIGVbMTNdID0gaVsxM10sIGVbMTRdID0gaVsxNF0sIGVbMTVdID0gaVsxNV0sIHRoaXM7CiAgfQogIGNvcHlQb3NpdGlvbih0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gZVsxMl0gPSBpWzEyXSwgZVsxM10gPSBpWzEzXSwgZVsxNF0gPSBpWzE0XSwgdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeDModCkgewogICAgY29uc3QgZSA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGVbMF0sCiAgICAgIGVbM10sCiAgICAgIGVbNl0sCiAgICAgIDAsCiAgICAgIGVbMV0sCiAgICAgIGVbNF0sCiAgICAgIGVbN10sCiAgICAgIDAsCiAgICAgIGVbMl0sCiAgICAgIGVbNV0sCiAgICAgIGVbOF0sCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIGV4dHJhY3RCYXNpcyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdC5zZXRGcm9tTWF0cml4Q29sdW1uKHRoaXMsIDApLCBlLnNldEZyb21NYXRyaXhDb2x1bW4odGhpcywgMSksIGkuc2V0RnJvbU1hdHJpeENvbHVtbih0aGlzLCAyKSwgdGhpczsKICB9CiAgbWFrZUJhc2lzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgdC54LAogICAgICBlLngsCiAgICAgIGkueCwKICAgICAgMCwKICAgICAgdC55LAogICAgICBlLnksCiAgICAgIGkueSwKICAgICAgMCwKICAgICAgdC56LAogICAgICBlLnosCiAgICAgIGkueiwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgZXh0cmFjdFJvdGF0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50cywgbiA9IDEgLyAkci5zZXRGcm9tTWF0cml4Q29sdW1uKHQsIDApLmxlbmd0aCgpLCBzID0gMSAvICRyLnNldEZyb21NYXRyaXhDb2x1bW4odCwgMSkubGVuZ3RoKCksIHIgPSAxIC8gJHIuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAyKS5sZW5ndGgoKTsKICAgIHJldHVybiBlWzBdID0gaVswXSAqIG4sIGVbMV0gPSBpWzFdICogbiwgZVsyXSA9IGlbMl0gKiBuLCBlWzNdID0gMCwgZVs0XSA9IGlbNF0gKiBzLCBlWzVdID0gaVs1XSAqIHMsIGVbNl0gPSBpWzZdICogcywgZVs3XSA9IDAsIGVbOF0gPSBpWzhdICogciwgZVs5XSA9IGlbOV0gKiByLCBlWzEwXSA9IGlbMTBdICogciwgZVsxMV0gPSAwLCBlWzEyXSA9IDAsIGVbMTNdID0gMCwgZVsxNF0gPSAwLCBlWzE1XSA9IDEsIHRoaXM7CiAgfQogIG1ha2VSb3RhdGlvbkZyb21FdWxlcih0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQueCwgbiA9IHQueSwgcyA9IHQueiwgciA9IE1hdGguY29zKGkpLCBvID0gTWF0aC5zaW4oaSksIGwgPSBNYXRoLmNvcyhuKSwgaCA9IE1hdGguc2luKG4pLCBjID0gTWF0aC5jb3MocyksIHUgPSBNYXRoLnNpbihzKTsKICAgIGlmICh0Lm9yZGVyID09PSAiWFlaIikgewogICAgICBjb25zdCBkID0gciAqIGMsIHAgPSByICogdSwgZiA9IG8gKiBjLCB5ID0gbyAqIHU7CiAgICAgIGVbMF0gPSBsICogYywgZVs0XSA9IC1sICogdSwgZVs4XSA9IGgsIGVbMV0gPSBwICsgZiAqIGgsIGVbNV0gPSBkIC0geSAqIGgsIGVbOV0gPSAtbyAqIGwsIGVbMl0gPSB5IC0gZCAqIGgsIGVbNl0gPSBmICsgcCAqIGgsIGVbMTBdID0gciAqIGw7CiAgICB9IGVsc2UgaWYgKHQub3JkZXIgPT09ICJZWFoiKSB7CiAgICAgIGNvbnN0IGQgPSBsICogYywgcCA9IGwgKiB1LCBmID0gaCAqIGMsIHkgPSBoICogdTsKICAgICAgZVswXSA9IGQgKyB5ICogbywgZVs0XSA9IGYgKiBvIC0gcCwgZVs4XSA9IHIgKiBoLCBlWzFdID0gciAqIHUsIGVbNV0gPSByICogYywgZVs5XSA9IC1vLCBlWzJdID0gcCAqIG8gLSBmLCBlWzZdID0geSArIGQgKiBvLCBlWzEwXSA9IHIgKiBsOwogICAgfSBlbHNlIGlmICh0Lm9yZGVyID09PSAiWlhZIikgewogICAgICBjb25zdCBkID0gbCAqIGMsIHAgPSBsICogdSwgZiA9IGggKiBjLCB5ID0gaCAqIHU7CiAgICAgIGVbMF0gPSBkIC0geSAqIG8sIGVbNF0gPSAtciAqIHUsIGVbOF0gPSBmICsgcCAqIG8sIGVbMV0gPSBwICsgZiAqIG8sIGVbNV0gPSByICogYywgZVs5XSA9IHkgLSBkICogbywgZVsyXSA9IC1yICogaCwgZVs2XSA9IG8sIGVbMTBdID0gciAqIGw7CiAgICB9IGVsc2UgaWYgKHQub3JkZXIgPT09ICJaWVgiKSB7CiAgICAgIGNvbnN0IGQgPSByICogYywgcCA9IHIgKiB1LCBmID0gbyAqIGMsIHkgPSBvICogdTsKICAgICAgZVswXSA9IGwgKiBjLCBlWzRdID0gZiAqIGggLSBwLCBlWzhdID0gZCAqIGggKyB5LCBlWzFdID0gbCAqIHUsIGVbNV0gPSB5ICogaCArIGQsIGVbOV0gPSBwICogaCAtIGYsIGVbMl0gPSAtaCwgZVs2XSA9IG8gKiBsLCBlWzEwXSA9IHIgKiBsOwogICAgfSBlbHNlIGlmICh0Lm9yZGVyID09PSAiWVpYIikgewogICAgICBjb25zdCBkID0gciAqIGwsIHAgPSByICogaCwgZiA9IG8gKiBsLCB5ID0gbyAqIGg7CiAgICAgIGVbMF0gPSBsICogYywgZVs0XSA9IHkgLSBkICogdSwgZVs4XSA9IGYgKiB1ICsgcCwgZVsxXSA9IHUsIGVbNV0gPSByICogYywgZVs5XSA9IC1vICogYywgZVsyXSA9IC1oICogYywgZVs2XSA9IHAgKiB1ICsgZiwgZVsxMF0gPSBkIC0geSAqIHU7CiAgICB9IGVsc2UgaWYgKHQub3JkZXIgPT09ICJYWlkiKSB7CiAgICAgIGNvbnN0IGQgPSByICogbCwgcCA9IHIgKiBoLCBmID0gbyAqIGwsIHkgPSBvICogaDsKICAgICAgZVswXSA9IGwgKiBjLCBlWzRdID0gLXUsIGVbOF0gPSBoICogYywgZVsxXSA9IGQgKiB1ICsgeSwgZVs1XSA9IHIgKiBjLCBlWzldID0gcCAqIHUgLSBmLCBlWzJdID0gZiAqIHUgLSBwLCBlWzZdID0gbyAqIGMsIGVbMTBdID0geSAqIHUgKyBkOwogICAgfQogICAgcmV0dXJuIGVbM10gPSAwLCBlWzddID0gMCwgZVsxMV0gPSAwLCBlWzEyXSA9IDAsIGVbMTNdID0gMCwgZVsxNF0gPSAwLCBlWzE1XSA9IDEsIHRoaXM7CiAgfQogIG1ha2VSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKHQpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvc2UoSFQsIHQsIEdUKTsKICB9CiAgbG9va0F0KHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIERpLnN1YlZlY3RvcnModCwgZSksIERpLmxlbmd0aFNxKCkgPT09IDAgJiYgKERpLnogPSAxKSwgRGkubm9ybWFsaXplKCksIG1zLmNyb3NzVmVjdG9ycyhpLCBEaSksIG1zLmxlbmd0aFNxKCkgPT09IDAgJiYgKE1hdGguYWJzKGkueikgPT09IDEgPyBEaS54ICs9IDFlLTQgOiBEaS56ICs9IDFlLTQsIERpLm5vcm1hbGl6ZSgpLCBtcy5jcm9zc1ZlY3RvcnMoaSwgRGkpKSwgbXMubm9ybWFsaXplKCksIGVoLmNyb3NzVmVjdG9ycyhEaSwgbXMpLCBuWzBdID0gbXMueCwgbls0XSA9IGVoLngsIG5bOF0gPSBEaS54LCBuWzFdID0gbXMueSwgbls1XSA9IGVoLnksIG5bOV0gPSBEaS55LCBuWzJdID0gbXMueiwgbls2XSA9IGVoLnosIG5bMTBdID0gRGkueiwgdGhpczsKICB9CiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlNYXRyaWNlcyh0aGlzLCB0KTsKICB9CiAgcHJlbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlNYXRyaWNlcyh0LCB0aGlzKTsKICB9CiAgbXVsdGlwbHlNYXRyaWNlcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdC5lbGVtZW50cywgbiA9IGUuZWxlbWVudHMsIHMgPSB0aGlzLmVsZW1lbnRzLCByID0gaVswXSwgbyA9IGlbNF0sIGwgPSBpWzhdLCBoID0gaVsxMl0sIGMgPSBpWzFdLCB1ID0gaVs1XSwgZCA9IGlbOV0sIHAgPSBpWzEzXSwgZiA9IGlbMl0sIHkgPSBpWzZdLCBnID0gaVsxMF0sIG0gPSBpWzE0XSwgdiA9IGlbM10sIHggPSBpWzddLCBfID0gaVsxMV0sIFMgPSBpWzE1XSwgdyA9IG5bMF0sIFQgPSBuWzRdLCBSID0gbls4XSwgYiA9IG5bMTJdLCBNID0gblsxXSwgTCA9IG5bNV0sIFUgPSBuWzldLCBPID0gblsxM10sIFYgPSBuWzJdLCBXID0gbls2XSwgRyA9IG5bMTBdLCBldCA9IG5bMTRdLCBIID0gblszXSwgYXQgPSBuWzddLCBwdCA9IG5bMTFdLCBNdCA9IG5bMTVdOwogICAgcmV0dXJuIHNbMF0gPSByICogdyArIG8gKiBNICsgbCAqIFYgKyBoICogSCwgc1s0XSA9IHIgKiBUICsgbyAqIEwgKyBsICogVyArIGggKiBhdCwgc1s4XSA9IHIgKiBSICsgbyAqIFUgKyBsICogRyArIGggKiBwdCwgc1sxMl0gPSByICogYiArIG8gKiBPICsgbCAqIGV0ICsgaCAqIE10LCBzWzFdID0gYyAqIHcgKyB1ICogTSArIGQgKiBWICsgcCAqIEgsIHNbNV0gPSBjICogVCArIHUgKiBMICsgZCAqIFcgKyBwICogYXQsIHNbOV0gPSBjICogUiArIHUgKiBVICsgZCAqIEcgKyBwICogcHQsIHNbMTNdID0gYyAqIGIgKyB1ICogTyArIGQgKiBldCArIHAgKiBNdCwgc1syXSA9IGYgKiB3ICsgeSAqIE0gKyBnICogViArIG0gKiBILCBzWzZdID0gZiAqIFQgKyB5ICogTCArIGcgKiBXICsgbSAqIGF0LCBzWzEwXSA9IGYgKiBSICsgeSAqIFUgKyBnICogRyArIG0gKiBwdCwgc1sxNF0gPSBmICogYiArIHkgKiBPICsgZyAqIGV0ICsgbSAqIE10LCBzWzNdID0gdiAqIHcgKyB4ICogTSArIF8gKiBWICsgUyAqIEgsIHNbN10gPSB2ICogVCArIHggKiBMICsgXyAqIFcgKyBTICogYXQsIHNbMTFdID0gdiAqIFIgKyB4ICogVSArIF8gKiBHICsgUyAqIHB0LCBzWzE1XSA9IHYgKiBiICsgeCAqIE8gKyBfICogZXQgKyBTICogTXQsIHRoaXM7CiAgfQogIG11bHRpcGx5U2NhbGFyKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIGVbMF0gKj0gdCwgZVs0XSAqPSB0LCBlWzhdICo9IHQsIGVbMTJdICo9IHQsIGVbMV0gKj0gdCwgZVs1XSAqPSB0LCBlWzldICo9IHQsIGVbMTNdICo9IHQsIGVbMl0gKj0gdCwgZVs2XSAqPSB0LCBlWzEwXSAqPSB0LCBlWzE0XSAqPSB0LCBlWzNdICo9IHQsIGVbN10gKj0gdCwgZVsxMV0gKj0gdCwgZVsxNV0gKj0gdCwgdGhpczsKICB9CiAgZGV0ZXJtaW5hbnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0sIGkgPSB0WzRdLCBuID0gdFs4XSwgcyA9IHRbMTJdLCByID0gdFsxXSwgbyA9IHRbNV0sIGwgPSB0WzldLCBoID0gdFsxM10sIGMgPSB0WzJdLCB1ID0gdFs2XSwgZCA9IHRbMTBdLCBwID0gdFsxNF0sIGYgPSB0WzNdLCB5ID0gdFs3XSwgZyA9IHRbMTFdLCBtID0gdFsxNV07CiAgICByZXR1cm4gZiAqICgrcyAqIGwgKiB1IC0gbiAqIGggKiB1IC0gcyAqIG8gKiBkICsgaSAqIGggKiBkICsgbiAqIG8gKiBwIC0gaSAqIGwgKiBwKSArIHkgKiAoK2UgKiBsICogcCAtIGUgKiBoICogZCArIHMgKiByICogZCAtIG4gKiByICogcCArIG4gKiBoICogYyAtIHMgKiBsICogYykgKyBnICogKCtlICogaCAqIHUgLSBlICogbyAqIHAgLSBzICogciAqIHUgKyBpICogciAqIHAgKyBzICogbyAqIGMgLSBpICogaCAqIGMpICsgbSAqICgtbiAqIG8gKiBjIC0gZSAqIGwgKiB1ICsgZSAqIG8gKiBkICsgbiAqIHIgKiB1IC0gaSAqIHIgKiBkICsgaSAqIGwgKiBjKTsKICB9CiAgdHJhbnNwb3NlKCkgewogICAgY29uc3QgdCA9IHRoaXMuZWxlbWVudHM7CiAgICBsZXQgZTsKICAgIHJldHVybiBlID0gdFsxXSwgdFsxXSA9IHRbNF0sIHRbNF0gPSBlLCBlID0gdFsyXSwgdFsyXSA9IHRbOF0sIHRbOF0gPSBlLCBlID0gdFs2XSwgdFs2XSA9IHRbOV0sIHRbOV0gPSBlLCBlID0gdFszXSwgdFszXSA9IHRbMTJdLCB0WzEyXSA9IGUsIGUgPSB0WzddLCB0WzddID0gdFsxM10sIHRbMTNdID0gZSwgZSA9IHRbMTFdLCB0WzExXSA9IHRbMTRdLCB0WzE0XSA9IGUsIHRoaXM7CiAgfQogIHNldFBvc2l0aW9uKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIHQuaXNWZWN0b3IzID8gKG5bMTJdID0gdC54LCBuWzEzXSA9IHQueSwgblsxNF0gPSB0LnopIDogKG5bMTJdID0gdCwgblsxM10gPSBlLCBuWzE0XSA9IGkpLCB0aGlzOwogIH0KICBpbnZlcnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0sIGkgPSB0WzFdLCBuID0gdFsyXSwgcyA9IHRbM10sIHIgPSB0WzRdLCBvID0gdFs1XSwgbCA9IHRbNl0sIGggPSB0WzddLCBjID0gdFs4XSwgdSA9IHRbOV0sIGQgPSB0WzEwXSwgcCA9IHRbMTFdLCBmID0gdFsxMl0sIHkgPSB0WzEzXSwgZyA9IHRbMTRdLCBtID0gdFsxNV0sIHYgPSB1ICogZyAqIGggLSB5ICogZCAqIGggKyB5ICogbCAqIHAgLSBvICogZyAqIHAgLSB1ICogbCAqIG0gKyBvICogZCAqIG0sIHggPSBmICogZCAqIGggLSBjICogZyAqIGggLSBmICogbCAqIHAgKyByICogZyAqIHAgKyBjICogbCAqIG0gLSByICogZCAqIG0sIF8gPSBjICogeSAqIGggLSBmICogdSAqIGggKyBmICogbyAqIHAgLSByICogeSAqIHAgLSBjICogbyAqIG0gKyByICogdSAqIG0sIFMgPSBmICogdSAqIGwgLSBjICogeSAqIGwgLSBmICogbyAqIGQgKyByICogeSAqIGQgKyBjICogbyAqIGcgLSByICogdSAqIGcsIHcgPSBlICogdiArIGkgKiB4ICsgbiAqIF8gKyBzICogUzsKICAgIGlmICh3ID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCk7CiAgICBjb25zdCBUID0gMSAvIHc7CiAgICByZXR1cm4gdFswXSA9IHYgKiBULCB0WzFdID0gKHkgKiBkICogcyAtIHUgKiBnICogcyAtIHkgKiBuICogcCArIGkgKiBnICogcCArIHUgKiBuICogbSAtIGkgKiBkICogbSkgKiBULCB0WzJdID0gKG8gKiBnICogcyAtIHkgKiBsICogcyArIHkgKiBuICogaCAtIGkgKiBnICogaCAtIG8gKiBuICogbSArIGkgKiBsICogbSkgKiBULCB0WzNdID0gKHUgKiBsICogcyAtIG8gKiBkICogcyAtIHUgKiBuICogaCArIGkgKiBkICogaCArIG8gKiBuICogcCAtIGkgKiBsICogcCkgKiBULCB0WzRdID0geCAqIFQsIHRbNV0gPSAoYyAqIGcgKiBzIC0gZiAqIGQgKiBzICsgZiAqIG4gKiBwIC0gZSAqIGcgKiBwIC0gYyAqIG4gKiBtICsgZSAqIGQgKiBtKSAqIFQsIHRbNl0gPSAoZiAqIGwgKiBzIC0gciAqIGcgKiBzIC0gZiAqIG4gKiBoICsgZSAqIGcgKiBoICsgciAqIG4gKiBtIC0gZSAqIGwgKiBtKSAqIFQsIHRbN10gPSAociAqIGQgKiBzIC0gYyAqIGwgKiBzICsgYyAqIG4gKiBoIC0gZSAqIGQgKiBoIC0gciAqIG4gKiBwICsgZSAqIGwgKiBwKSAqIFQsIHRbOF0gPSBfICogVCwgdFs5XSA9IChmICogdSAqIHMgLSBjICogeSAqIHMgLSBmICogaSAqIHAgKyBlICogeSAqIHAgKyBjICogaSAqIG0gLSBlICogdSAqIG0pICogVCwgdFsxMF0gPSAociAqIHkgKiBzIC0gZiAqIG8gKiBzICsgZiAqIGkgKiBoIC0gZSAqIHkgKiBoIC0gciAqIGkgKiBtICsgZSAqIG8gKiBtKSAqIFQsIHRbMTFdID0gKGMgKiBvICogcyAtIHIgKiB1ICogcyAtIGMgKiBpICogaCArIGUgKiB1ICogaCArIHIgKiBpICogcCAtIGUgKiBvICogcCkgKiBULCB0WzEyXSA9IFMgKiBULCB0WzEzXSA9IChjICogeSAqIG4gLSBmICogdSAqIG4gKyBmICogaSAqIGQgLSBlICogeSAqIGQgLSBjICogaSAqIGcgKyBlICogdSAqIGcpICogVCwgdFsxNF0gPSAoZiAqIG8gKiBuIC0gciAqIHkgKiBuIC0gZiAqIGkgKiBsICsgZSAqIHkgKiBsICsgciAqIGkgKiBnIC0gZSAqIG8gKiBnKSAqIFQsIHRbMTVdID0gKHIgKiB1ICogbiAtIGMgKiBvICogbiArIGMgKiBpICogbCAtIGUgKiB1ICogbCAtIHIgKiBpICogZCArIGUgKiBvICogZCkgKiBULCB0aGlzOwogIH0KICBzY2FsZSh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQueCwgbiA9IHQueSwgcyA9IHQuejsKICAgIHJldHVybiBlWzBdICo9IGksIGVbNF0gKj0gbiwgZVs4XSAqPSBzLCBlWzFdICo9IGksIGVbNV0gKj0gbiwgZVs5XSAqPSBzLCBlWzJdICo9IGksIGVbNl0gKj0gbiwgZVsxMF0gKj0gcywgZVszXSAqPSBpLCBlWzddICo9IG4sIGVbMTFdICo9IHMsIHRoaXM7CiAgfQogIGdldE1heFNjYWxlT25BeGlzKCkgewogICAgY29uc3QgdCA9IHRoaXMuZWxlbWVudHMsIGUgPSB0WzBdICogdFswXSArIHRbMV0gKiB0WzFdICsgdFsyXSAqIHRbMl0sIGkgPSB0WzRdICogdFs0XSArIHRbNV0gKiB0WzVdICsgdFs2XSAqIHRbNl0sIG4gPSB0WzhdICogdFs4XSArIHRbOV0gKiB0WzldICsgdFsxMF0gKiB0WzEwXTsKICAgIHJldHVybiBNYXRoLnNxcnQoTWF0aC5tYXgoZSwgaSwgbikpOwogIH0KICBtYWtlVHJhbnNsYXRpb24odCwgZSwgaSkgewogICAgcmV0dXJuIHQuaXNWZWN0b3IzID8gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIHQueCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgdC55LAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICB0LnosCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICkgOiB0aGlzLnNldCgKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgdCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgbWFrZVJvdGF0aW9uWCh0KSB7CiAgICBjb25zdCBlID0gTWF0aC5jb3ModCksIGkgPSBNYXRoLnNpbih0KTsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgZSwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIGksCiAgICAgIGUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIG1ha2VSb3RhdGlvblkodCkgewogICAgY29uc3QgZSA9IE1hdGguY29zKHQpLCBpID0gTWF0aC5zaW4odCk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGUsCiAgICAgIDAsCiAgICAgIGksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIC1pLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICBtYWtlUm90YXRpb25aKHQpIHsKICAgIGNvbnN0IGUgPSBNYXRoLmNvcyh0KSwgaSA9IE1hdGguc2luKHQpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBlLAogICAgICAtaSwKICAgICAgMCwKICAgICAgMCwKICAgICAgaSwKICAgICAgZSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgbWFrZVJvdGF0aW9uQXhpcyh0LCBlKSB7CiAgICBjb25zdCBpID0gTWF0aC5jb3MoZSksIG4gPSBNYXRoLnNpbihlKSwgcyA9IDEgLSBpLCByID0gdC54LCBvID0gdC55LCBsID0gdC56LCBoID0gcyAqIHIsIGMgPSBzICogbzsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgaCAqIHIgKyBpLAogICAgICBoICogbyAtIG4gKiBsLAogICAgICBoICogbCArIG4gKiBvLAogICAgICAwLAogICAgICBoICogbyArIG4gKiBsLAogICAgICBjICogbyArIGksCiAgICAgIGMgKiBsIC0gbiAqIHIsCiAgICAgIDAsCiAgICAgIGggKiBsIC0gbiAqIG8sCiAgICAgIGMgKiBsICsgbiAqIHIsCiAgICAgIHMgKiBsICogbCArIGksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIG1ha2VTY2FsZSh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIHQsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIGUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIGksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIG1ha2VTaGVhcih0LCBlLCBpLCBuLCBzLCByKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIGksCiAgICAgIHMsCiAgICAgIDAsCiAgICAgIHQsCiAgICAgIDEsCiAgICAgIHIsCiAgICAgIDAsCiAgICAgIGUsCiAgICAgIG4sCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIGNvbXBvc2UodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuZWxlbWVudHMsIHMgPSBlLl94LCByID0gZS5feSwgbyA9IGUuX3osIGwgPSBlLl93LCBoID0gcyArIHMsIGMgPSByICsgciwgdSA9IG8gKyBvLCBkID0gcyAqIGgsIHAgPSBzICogYywgZiA9IHMgKiB1LCB5ID0gciAqIGMsIGcgPSByICogdSwgbSA9IG8gKiB1LCB2ID0gbCAqIGgsIHggPSBsICogYywgXyA9IGwgKiB1LCBTID0gaS54LCB3ID0gaS55LCBUID0gaS56OwogICAgcmV0dXJuIG5bMF0gPSAoMSAtICh5ICsgbSkpICogUywgblsxXSA9IChwICsgXykgKiBTLCBuWzJdID0gKGYgLSB4KSAqIFMsIG5bM10gPSAwLCBuWzRdID0gKHAgLSBfKSAqIHcsIG5bNV0gPSAoMSAtIChkICsgbSkpICogdywgbls2XSA9IChnICsgdikgKiB3LCBuWzddID0gMCwgbls4XSA9IChmICsgeCkgKiBULCBuWzldID0gKGcgLSB2KSAqIFQsIG5bMTBdID0gKDEgLSAoZCArIHkpKSAqIFQsIG5bMTFdID0gMCwgblsxMl0gPSB0LngsIG5bMTNdID0gdC55LCBuWzE0XSA9IHQueiwgblsxNV0gPSAxLCB0aGlzOwogIH0KICBkZWNvbXBvc2UodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuZWxlbWVudHM7CiAgICBsZXQgcyA9ICRyLnNldChuWzBdLCBuWzFdLCBuWzJdKS5sZW5ndGgoKTsKICAgIGNvbnN0IHIgPSAkci5zZXQobls0XSwgbls1XSwgbls2XSkubGVuZ3RoKCksIG8gPSAkci5zZXQobls4XSwgbls5XSwgblsxMF0pLmxlbmd0aCgpOwogICAgdGhpcy5kZXRlcm1pbmFudCgpIDwgMCAmJiAocyA9IC1zKSwgdC54ID0gblsxMl0sIHQueSA9IG5bMTNdLCB0LnogPSBuWzE0XSwgZW4uY29weSh0aGlzKTsKICAgIGNvbnN0IGggPSAxIC8gcywgYyA9IDEgLyByLCB1ID0gMSAvIG87CiAgICByZXR1cm4gZW4uZWxlbWVudHNbMF0gKj0gaCwgZW4uZWxlbWVudHNbMV0gKj0gaCwgZW4uZWxlbWVudHNbMl0gKj0gaCwgZW4uZWxlbWVudHNbNF0gKj0gYywgZW4uZWxlbWVudHNbNV0gKj0gYywgZW4uZWxlbWVudHNbNl0gKj0gYywgZW4uZWxlbWVudHNbOF0gKj0gdSwgZW4uZWxlbWVudHNbOV0gKj0gdSwgZW4uZWxlbWVudHNbMTBdICo9IHUsIGUuc2V0RnJvbVJvdGF0aW9uTWF0cml4KGVuKSwgaS54ID0gcywgaS55ID0gciwgaS56ID0gbywgdGhpczsKICB9CiAgbWFrZVBlcnNwZWN0aXZlKHQsIGUsIGksIG4sIHMsIHIsIG8gPSBabCkgewogICAgY29uc3QgbCA9IHRoaXMuZWxlbWVudHMsIGggPSAyICogcyAvIChlIC0gdCksIGMgPSAyICogcyAvIChpIC0gbiksIHUgPSAoZSArIHQpIC8gKGUgLSB0KSwgZCA9IChpICsgbikgLyAoaSAtIG4pOwogICAgbGV0IHAsIGY7CiAgICBpZiAobyA9PT0gWmwpCiAgICAgIHAgPSAtKHIgKyBzKSAvIChyIC0gcyksIGYgPSAtMiAqIHIgKiBzIC8gKHIgLSBzKTsKICAgIGVsc2UgaWYgKG8gPT09IENnKQogICAgICBwID0gLXIgLyAociAtIHMpLCBmID0gLXIgKiBzIC8gKHIgLSBzKTsKICAgIGVsc2UKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5NYXRyaXg0Lm1ha2VQZXJzcGVjdGl2ZSgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAiICsgbyk7CiAgICByZXR1cm4gbFswXSA9IGgsIGxbNF0gPSAwLCBsWzhdID0gdSwgbFsxMl0gPSAwLCBsWzFdID0gMCwgbFs1XSA9IGMsIGxbOV0gPSBkLCBsWzEzXSA9IDAsIGxbMl0gPSAwLCBsWzZdID0gMCwgbFsxMF0gPSBwLCBsWzE0XSA9IGYsIGxbM10gPSAwLCBsWzddID0gMCwgbFsxMV0gPSAtMSwgbFsxNV0gPSAwLCB0aGlzOwogIH0KICBtYWtlT3J0aG9ncmFwaGljKHQsIGUsIGksIG4sIHMsIHIsIG8gPSBabCkgewogICAgY29uc3QgbCA9IHRoaXMuZWxlbWVudHMsIGggPSAxIC8gKGUgLSB0KSwgYyA9IDEgLyAoaSAtIG4pLCB1ID0gMSAvIChyIC0gcyksIGQgPSAoZSArIHQpICogaCwgcCA9IChpICsgbikgKiBjOwogICAgbGV0IGYsIHk7CiAgICBpZiAobyA9PT0gWmwpCiAgICAgIGYgPSAociArIHMpICogdSwgeSA9IC0yICogdTsKICAgIGVsc2UgaWYgKG8gPT09IENnKQogICAgICBmID0gcyAqIHUsIHkgPSAtMSAqIHU7CiAgICBlbHNlCiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuTWF0cml4NC5tYWtlT3J0aG9ncmFwaGljKCk6IEludmFsaWQgY29vcmRpbmF0ZSBzeXN0ZW06ICIgKyBvKTsKICAgIHJldHVybiBsWzBdID0gMiAqIGgsIGxbNF0gPSAwLCBsWzhdID0gMCwgbFsxMl0gPSAtZCwgbFsxXSA9IDAsIGxbNV0gPSAyICogYywgbFs5XSA9IDAsIGxbMTNdID0gLXAsIGxbMl0gPSAwLCBsWzZdID0gMCwgbFsxMF0gPSB5LCBsWzE0XSA9IC1mLCBsWzNdID0gMCwgbFs3XSA9IDAsIGxbMTFdID0gMCwgbFsxNV0gPSAxLCB0aGlzOwogIH0KICBlcXVhbHModCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHMsIGkgPSB0LmVsZW1lbnRzOwogICAgZm9yIChsZXQgbiA9IDA7IG4gPCAxNjsgbisrKQogICAgICBpZiAoZVtuXSAhPT0gaVtuXSkgcmV0dXJuICExOwogICAgcmV0dXJuICEwOwogIH0KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKykKICAgICAgdGhpcy5lbGVtZW50c1tpXSA9IHRbaSArIGVdOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgY29uc3QgaSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdFtlXSA9IGlbMF0sIHRbZSArIDFdID0gaVsxXSwgdFtlICsgMl0gPSBpWzJdLCB0W2UgKyAzXSA9IGlbM10sIHRbZSArIDRdID0gaVs0XSwgdFtlICsgNV0gPSBpWzVdLCB0W2UgKyA2XSA9IGlbNl0sIHRbZSArIDddID0gaVs3XSwgdFtlICsgOF0gPSBpWzhdLCB0W2UgKyA5XSA9IGlbOV0sIHRbZSArIDEwXSA9IGlbMTBdLCB0W2UgKyAxMV0gPSBpWzExXSwgdFtlICsgMTJdID0gaVsxMl0sIHRbZSArIDEzXSA9IGlbMTNdLCB0W2UgKyAxNF0gPSBpWzE0XSwgdFtlICsgMTVdID0gaVsxNV0sIHQ7CiAgfQp9Owpjb25zdCAkciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFFuKCksIEhUID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgwLCAwLCAwKSwgR1QgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KDEsIDEsIDEpLCBtcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgZWggPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIERpID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCB6ZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUW4oKSwgTmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IHFvKCk7CmxldCBkdSA9IGNsYXNzIFlfIHsKICBjb25zdHJ1Y3Rvcih0ID0gMCwgZSA9IDAsIGkgPSAwLCBuID0gWV8uREVGQVVMVF9PUkRFUikgewogICAgdGhpcy5pc0V1bGVyID0gITAsIHRoaXMuX3ggPSB0LCB0aGlzLl95ID0gZSwgdGhpcy5feiA9IGksIHRoaXMuX29yZGVyID0gbjsKICB9CiAgZ2V0IHgoKSB7CiAgICByZXR1cm4gdGhpcy5feDsKICB9CiAgc2V0IHgodCkgewogICAgdGhpcy5feCA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgZ2V0IHkoKSB7CiAgICByZXR1cm4gdGhpcy5feTsKICB9CiAgc2V0IHkodCkgewogICAgdGhpcy5feSA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgZ2V0IHooKSB7CiAgICByZXR1cm4gdGhpcy5fejsKICB9CiAgc2V0IHoodCkgewogICAgdGhpcy5feiA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgZ2V0IG9yZGVyKCkgewogICAgcmV0dXJuIHRoaXMuX29yZGVyOwogIH0KICBzZXQgb3JkZXIodCkgewogICAgdGhpcy5fb3JkZXIgPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIHNldCh0LCBlLCBpLCBuID0gdGhpcy5fb3JkZXIpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdCwgdGhpcy5feSA9IGUsIHRoaXMuX3ogPSBpLCB0aGlzLl9vcmRlciA9IG4sIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5feCwgdGhpcy5feSwgdGhpcy5feiwgdGhpcy5fb3JkZXIpOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdC5feCwgdGhpcy5feSA9IHQuX3ksIHRoaXMuX3ogPSB0Ll96LCB0aGlzLl9vcmRlciA9IHQuX29yZGVyLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIHNldEZyb21Sb3RhdGlvbk1hdHJpeCh0LCBlID0gdGhpcy5fb3JkZXIsIGkgPSAhMCkgewogICAgY29uc3QgbiA9IHQuZWxlbWVudHMsIHMgPSBuWzBdLCByID0gbls0XSwgbyA9IG5bOF0sIGwgPSBuWzFdLCBoID0gbls1XSwgYyA9IG5bOV0sIHUgPSBuWzJdLCBkID0gbls2XSwgcCA9IG5bMTBdOwogICAgc3dpdGNoIChlKSB7CiAgICAgIGNhc2UgIlhZWiI6CiAgICAgICAgdGhpcy5feSA9IE1hdGguYXNpbihhaShvLCAtMSwgMSkpLCBNYXRoLmFicyhvKSA8IDAuOTk5OTk5OSA/ICh0aGlzLl94ID0gTWF0aC5hdGFuMigtYywgcCksIHRoaXMuX3ogPSBNYXRoLmF0YW4yKC1yLCBzKSkgOiAodGhpcy5feCA9IE1hdGguYXRhbjIoZCwgaCksIHRoaXMuX3ogPSAwKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWVhaIjoKICAgICAgICB0aGlzLl94ID0gTWF0aC5hc2luKC1haShjLCAtMSwgMSkpLCBNYXRoLmFicyhjKSA8IDAuOTk5OTk5OSA/ICh0aGlzLl95ID0gTWF0aC5hdGFuMihvLCBwKSwgdGhpcy5feiA9IE1hdGguYXRhbjIobCwgaCkpIDogKHRoaXMuX3kgPSBNYXRoLmF0YW4yKC11LCBzKSwgdGhpcy5feiA9IDApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaWFkiOgogICAgICAgIHRoaXMuX3ggPSBNYXRoLmFzaW4oYWkoZCwgLTEsIDEpKSwgTWF0aC5hYnMoZCkgPCAwLjk5OTk5OTkgPyAodGhpcy5feSA9IE1hdGguYXRhbjIoLXUsIHApLCB0aGlzLl96ID0gTWF0aC5hdGFuMigtciwgaCkpIDogKHRoaXMuX3kgPSAwLCB0aGlzLl96ID0gTWF0aC5hdGFuMihsLCBzKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlpZWCI6CiAgICAgICAgdGhpcy5feSA9IE1hdGguYXNpbigtYWkodSwgLTEsIDEpKSwgTWF0aC5hYnModSkgPCAwLjk5OTk5OTkgPyAodGhpcy5feCA9IE1hdGguYXRhbjIoZCwgcCksIHRoaXMuX3ogPSBNYXRoLmF0YW4yKGwsIHMpKSA6ICh0aGlzLl94ID0gMCwgdGhpcy5feiA9IE1hdGguYXRhbjIoLXIsIGgpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWVpYIjoKICAgICAgICB0aGlzLl96ID0gTWF0aC5hc2luKGFpKGwsIC0xLCAxKSksIE1hdGguYWJzKGwpIDwgMC45OTk5OTk5ID8gKHRoaXMuX3ggPSBNYXRoLmF0YW4yKC1jLCBoKSwgdGhpcy5feSA9IE1hdGguYXRhbjIoLXUsIHMpKSA6ICh0aGlzLl94ID0gMCwgdGhpcy5feSA9IE1hdGguYXRhbjIobywgcCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJYWlkiOgogICAgICAgIHRoaXMuX3ogPSBNYXRoLmFzaW4oLWFpKHIsIC0xLCAxKSksIE1hdGguYWJzKHIpIDwgMC45OTk5OTk5ID8gKHRoaXMuX3ggPSBNYXRoLmF0YW4yKGQsIGgpLCB0aGlzLl95ID0gTWF0aC5hdGFuMihvLCBzKSkgOiAodGhpcy5feCA9IE1hdGguYXRhbjIoLWMsIHApLCB0aGlzLl95ID0gMCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5FdWxlcjogLnNldEZyb21Sb3RhdGlvbk1hdHJpeCgpIGVuY291bnRlcmVkIGFuIHVua25vd24gb3JkZXI6ICIgKyBlKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9vcmRlciA9IGUsIGkgPT09ICEwICYmIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgc2V0RnJvbVF1YXRlcm5pb24odCwgZSwgaSkgewogICAgcmV0dXJuIHpnLm1ha2VSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKHQpLCB0aGlzLnNldEZyb21Sb3RhdGlvbk1hdHJpeCh6ZywgZSwgaSk7CiAgfQogIHNldEZyb21WZWN0b3IzKHQsIGUgPSB0aGlzLl9vcmRlcikgewogICAgcmV0dXJuIHRoaXMuc2V0KHQueCwgdC55LCB0LnosIGUpOwogIH0KICByZW9yZGVyKHQpIHsKICAgIHJldHVybiBOZy5zZXRGcm9tRXVsZXIodGhpcyksIHRoaXMuc2V0RnJvbVF1YXRlcm5pb24oTmcsIHQpOwogIH0KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuX3ggPT09IHRoaXMuX3ggJiYgdC5feSA9PT0gdGhpcy5feSAmJiB0Ll96ID09PSB0aGlzLl96ICYmIHQuX29yZGVyID09PSB0aGlzLl9vcmRlcjsKICB9CiAgZnJvbUFycmF5KHQpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdFswXSwgdGhpcy5feSA9IHRbMV0sIHRoaXMuX3ogPSB0WzJdLCB0WzNdICE9PSB2b2lkIDAgJiYgKHRoaXMuX29yZGVyID0gdFszXSksIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgdG9BcnJheSh0ID0gW10sIGUgPSAwKSB7CiAgICByZXR1cm4gdFtlXSA9IHRoaXMuX3gsIHRbZSArIDFdID0gdGhpcy5feSwgdFtlICsgMl0gPSB0aGlzLl96LCB0W2UgKyAzXSA9IHRoaXMuX29yZGVyLCB0OwogIH0KICBfb25DaGFuZ2UodCkgewogICAgcmV0dXJuIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2sgPSB0LCB0aGlzOwogIH0KICBfb25DaGFuZ2VDYWxsYmFjaygpIHsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy5feCwgeWllbGQgdGhpcy5feSwgeWllbGQgdGhpcy5feiwgeWllbGQgdGhpcy5fb3JkZXI7CiAgfQp9OwpkdS5ERUZBVUxUX09SREVSID0gIlhZWiI7CmxldCBXVCA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFzayA9IDE7CiAgfQogIHNldCh0KSB7CiAgICB0aGlzLm1hc2sgPSAoMSA8PCB0IHwgMCkgPj4+IDA7CiAgfQogIGVuYWJsZSh0KSB7CiAgICB0aGlzLm1hc2sgfD0gMSA8PCB0IHwgMDsKICB9CiAgZW5hYmxlQWxsKCkgewogICAgdGhpcy5tYXNrID0gLTE7CiAgfQogIHRvZ2dsZSh0KSB7CiAgICB0aGlzLm1hc2sgXj0gMSA8PCB0IHwgMDsKICB9CiAgZGlzYWJsZSh0KSB7CiAgICB0aGlzLm1hc2sgJj0gfigxIDw8IHQgfCAwKTsKICB9CiAgZGlzYWJsZUFsbCgpIHsKICAgIHRoaXMubWFzayA9IDA7CiAgfQogIHRlc3QodCkgewogICAgcmV0dXJuICh0aGlzLm1hc2sgJiB0Lm1hc2spICE9PSAwOwogIH0KICBpc0VuYWJsZWQodCkgewogICAgcmV0dXJuICh0aGlzLm1hc2sgJiAoMSA8PCB0IHwgMCkpICE9PSAwOwogIH0KfSwgcVQgPSAwOwpjb25zdCBPZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgWHIgPSAvKiBAX19QVVJFX18gKi8gbmV3IHFvKCksIFZuID0gLyogQF9fUFVSRV9fICovIG5ldyBRbigpLCBpaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgdG8gPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksICRUID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBYVCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgcW8oKSwga2cgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KDEsIDAsIDApLCBWZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoMCwgMSwgMCksIEhnID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgwLCAwLCAxKSwgR2cgPSB7IHR5cGU6ICJhZGRlZCIgfSwgWVQgPSB7IHR5cGU6ICJyZW1vdmVkIiB9LCBZciA9IHsgdHlwZTogImNoaWxkYWRkZWQiLCBjaGlsZDogbnVsbCB9LCBBZCA9IHsgdHlwZTogImNoaWxkcmVtb3ZlZCIsIGNoaWxkOiBudWxsIH07CmxldCBEYSA9IGNsYXNzIFBoIGV4dGVuZHMgY3UgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc09iamVjdDNEID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiBxVCsrIH0pLCB0aGlzLnV1aWQgPSBKbigpLCB0aGlzLm5hbWUgPSAiIiwgdGhpcy50eXBlID0gIk9iamVjdDNEIiwgdGhpcy5wYXJlbnQgPSBudWxsLCB0aGlzLmNoaWxkcmVuID0gW10sIHRoaXMudXAgPSBQaC5ERUZBVUxUX1VQLmNsb25lKCk7CiAgICBjb25zdCB0ID0gbmV3IHR0KCksIGUgPSBuZXcgZHUoKSwgaSA9IG5ldyBxbygpLCBuID0gbmV3IHR0KDEsIDEsIDEpOwogICAgZnVuY3Rpb24gcygpIHsKICAgICAgaS5zZXRGcm9tRXVsZXIoZSwgITEpOwogICAgfQogICAgZnVuY3Rpb24gcigpIHsKICAgICAgZS5zZXRGcm9tUXVhdGVybmlvbihpLCB2b2lkIDAsICExKTsKICAgIH0KICAgIGUuX29uQ2hhbmdlKHMpLCBpLl9vbkNoYW5nZShyKSwgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICBwb3NpdGlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IHQKICAgICAgfSwKICAgICAgcm90YXRpb246IHsKICAgICAgICBjb25maWd1cmFibGU6ICEwLAogICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgIHZhbHVlOiBlCiAgICAgIH0sCiAgICAgIHF1YXRlcm5pb246IHsKICAgICAgICBjb25maWd1cmFibGU6ICEwLAogICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgIHZhbHVlOiBpCiAgICAgIH0sCiAgICAgIHNjYWxlOiB7CiAgICAgICAgY29uZmlndXJhYmxlOiAhMCwKICAgICAgICBlbnVtZXJhYmxlOiAhMCwKICAgICAgICB2YWx1ZTogbgogICAgICB9LAogICAgICBtb2RlbFZpZXdNYXRyaXg6IHsKICAgICAgICB2YWx1ZTogbmV3IFFuKCkKICAgICAgfSwKICAgICAgbm9ybWFsTWF0cml4OiB7CiAgICAgICAgdmFsdWU6IG5ldyBkZSgpCiAgICAgIH0KICAgIH0pLCB0aGlzLm1hdHJpeCA9IG5ldyBRbigpLCB0aGlzLm1hdHJpeFdvcmxkID0gbmV3IFFuKCksIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IFBoLkRFRkFVTFRfTUFUUklYX0FVVE9fVVBEQVRFLCB0aGlzLm1hdHJpeFdvcmxkQXV0b1VwZGF0ZSA9IFBoLkRFRkFVTFRfTUFUUklYX1dPUkxEX0FVVE9fVVBEQVRFLCB0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSAhMSwgdGhpcy5sYXllcnMgPSBuZXcgV1QoKSwgdGhpcy52aXNpYmxlID0gITAsIHRoaXMuY2FzdFNoYWRvdyA9ICExLCB0aGlzLnJlY2VpdmVTaGFkb3cgPSAhMSwgdGhpcy5mcnVzdHVtQ3VsbGVkID0gITAsIHRoaXMucmVuZGVyT3JkZXIgPSAwLCB0aGlzLmFuaW1hdGlvbnMgPSBbXSwgdGhpcy51c2VyRGF0YSA9IHt9OwogIH0KICBvbkJlZm9yZVNoYWRvdygpIHsKICB9CiAgb25BZnRlclNoYWRvdygpIHsKICB9CiAgb25CZWZvcmVSZW5kZXIoKSB7CiAgfQogIG9uQWZ0ZXJSZW5kZXIoKSB7CiAgfQogIGFwcGx5TWF0cml4NCh0KSB7CiAgICB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgJiYgdGhpcy51cGRhdGVNYXRyaXgoKSwgdGhpcy5tYXRyaXgucHJlbXVsdGlwbHkodCksIHRoaXMubWF0cml4LmRlY29tcG9zZSh0aGlzLnBvc2l0aW9uLCB0aGlzLnF1YXRlcm5pb24sIHRoaXMuc2NhbGUpOwogIH0KICBhcHBseVF1YXRlcm5pb24odCkgewogICAgcmV0dXJuIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseSh0KSwgdGhpczsKICB9CiAgc2V0Um90YXRpb25Gcm9tQXhpc0FuZ2xlKHQsIGUpIHsKICAgIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKHQsIGUpOwogIH0KICBzZXRSb3RhdGlvbkZyb21FdWxlcih0KSB7CiAgICB0aGlzLnF1YXRlcm5pb24uc2V0RnJvbUV1bGVyKHQsICEwKTsKICB9CiAgc2V0Um90YXRpb25Gcm9tTWF0cml4KHQpIHsKICAgIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgodCk7CiAgfQogIHNldFJvdGF0aW9uRnJvbVF1YXRlcm5pb24odCkgewogICAgdGhpcy5xdWF0ZXJuaW9uLmNvcHkodCk7CiAgfQogIHJvdGF0ZU9uQXhpcyh0LCBlKSB7CiAgICByZXR1cm4gWHIuc2V0RnJvbUF4aXNBbmdsZSh0LCBlKSwgdGhpcy5xdWF0ZXJuaW9uLm11bHRpcGx5KFhyKSwgdGhpczsKICB9CiAgcm90YXRlT25Xb3JsZEF4aXModCwgZSkgewogICAgcmV0dXJuIFhyLnNldEZyb21BeGlzQW5nbGUodCwgZSksIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseShYciksIHRoaXM7CiAgfQogIHJvdGF0ZVgodCkgewogICAgcmV0dXJuIHRoaXMucm90YXRlT25BeGlzKGtnLCB0KTsKICB9CiAgcm90YXRlWSh0KSB7CiAgICByZXR1cm4gdGhpcy5yb3RhdGVPbkF4aXMoVmcsIHQpOwogIH0KICByb3RhdGVaKHQpIHsKICAgIHJldHVybiB0aGlzLnJvdGF0ZU9uQXhpcyhIZywgdCk7CiAgfQogIHRyYW5zbGF0ZU9uQXhpcyh0LCBlKSB7CiAgICByZXR1cm4gT2cuY29weSh0KS5hcHBseVF1YXRlcm5pb24odGhpcy5xdWF0ZXJuaW9uKSwgdGhpcy5wb3NpdGlvbi5hZGQoT2cubXVsdGlwbHlTY2FsYXIoZSkpLCB0aGlzOwogIH0KICB0cmFuc2xhdGVYKHQpIHsKICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZU9uQXhpcyhrZywgdCk7CiAgfQogIHRyYW5zbGF0ZVkodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKFZnLCB0KTsKICB9CiAgdHJhbnNsYXRlWih0KSB7CiAgICByZXR1cm4gdGhpcy50cmFuc2xhdGVPbkF4aXMoSGcsIHQpOwogIH0KICBsb2NhbFRvV29ybGQodCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdC5hcHBseU1hdHJpeDQodGhpcy5tYXRyaXhXb3JsZCk7CiAgfQogIHdvcmxkVG9Mb2NhbCh0KSB7CiAgICByZXR1cm4gdGhpcy51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0LmFwcGx5TWF0cml4NChWbi5jb3B5KHRoaXMubWF0cml4V29ybGQpLmludmVydCgpKTsKICB9CiAgbG9va0F0KHQsIGUsIGkpIHsKICAgIHQuaXNWZWN0b3IzID8gaWguY29weSh0KSA6IGloLnNldCh0LCBlLCBpKTsKICAgIGNvbnN0IG4gPSB0aGlzLnBhcmVudDsKICAgIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdG8uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubWF0cml4V29ybGQpLCB0aGlzLmlzQ2FtZXJhIHx8IHRoaXMuaXNMaWdodCA/IFZuLmxvb2tBdCh0bywgaWgsIHRoaXMudXApIDogVm4ubG9va0F0KGloLCB0bywgdGhpcy51cCksIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgoVm4pLCBuICYmIChWbi5leHRyYWN0Um90YXRpb24obi5tYXRyaXhXb3JsZCksIFhyLnNldEZyb21Sb3RhdGlvbk1hdHJpeChWbiksIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseShYci5pbnZlcnQoKSkpOwogIH0KICBhZGQodCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgIGZvciAobGV0IGUgPSAwOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKQogICAgICAgIHRoaXMuYWRkKGFyZ3VtZW50c1tlXSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgcmV0dXJuIHQgPT09IHRoaXMgPyAoY29uc29sZS5lcnJvcigiVEhSRUUuT2JqZWN0M0QuYWRkOiBvYmplY3QgY2FuJ3QgYmUgYWRkZWQgYXMgYSBjaGlsZCBvZiBpdHNlbGYuIiwgdCksIHRoaXMpIDogKHQgJiYgdC5pc09iamVjdDNEID8gKHQucmVtb3ZlRnJvbVBhcmVudCgpLCB0LnBhcmVudCA9IHRoaXMsIHRoaXMuY2hpbGRyZW4ucHVzaCh0KSwgdC5kaXNwYXRjaEV2ZW50KEdnKSwgWXIuY2hpbGQgPSB0LCB0aGlzLmRpc3BhdGNoRXZlbnQoWXIpLCBZci5jaGlsZCA9IG51bGwpIDogY29uc29sZS5lcnJvcigiVEhSRUUuT2JqZWN0M0QuYWRkOiBvYmplY3Qgbm90IGFuIGluc3RhbmNlIG9mIFRIUkVFLk9iamVjdDNELiIsIHQpLCB0aGlzKTsKICB9CiAgcmVtb3ZlKHQpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykKICAgICAgICB0aGlzLnJlbW92ZShhcmd1bWVudHNbaV0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuLmluZGV4T2YodCk7CiAgICByZXR1cm4gZSAhPT0gLTEgJiYgKHQucGFyZW50ID0gbnVsbCwgdGhpcy5jaGlsZHJlbi5zcGxpY2UoZSwgMSksIHQuZGlzcGF0Y2hFdmVudChZVCksIEFkLmNoaWxkID0gdCwgdGhpcy5kaXNwYXRjaEV2ZW50KEFkKSwgQWQuY2hpbGQgPSBudWxsKSwgdGhpczsKICB9CiAgcmVtb3ZlRnJvbVBhcmVudCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLnBhcmVudDsKICAgIHJldHVybiB0ICE9PSBudWxsICYmIHQucmVtb3ZlKHRoaXMpLCB0aGlzOwogIH0KICBjbGVhcigpIHsKICAgIHJldHVybiB0aGlzLnJlbW92ZSguLi50aGlzLmNoaWxkcmVuKTsKICB9CiAgYXR0YWNoKHQpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIFZuLmNvcHkodGhpcy5tYXRyaXhXb3JsZCkuaW52ZXJ0KCksIHQucGFyZW50ICE9PSBudWxsICYmICh0LnBhcmVudC51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCBWbi5tdWx0aXBseSh0LnBhcmVudC5tYXRyaXhXb3JsZCkpLCB0LmFwcGx5TWF0cml4NChWbiksIHQucmVtb3ZlRnJvbVBhcmVudCgpLCB0LnBhcmVudCA9IHRoaXMsIHRoaXMuY2hpbGRyZW4ucHVzaCh0KSwgdC51cGRhdGVXb3JsZE1hdHJpeCghMSwgITApLCB0LmRpc3BhdGNoRXZlbnQoR2cpLCBZci5jaGlsZCA9IHQsIHRoaXMuZGlzcGF0Y2hFdmVudChZciksIFlyLmNoaWxkID0gbnVsbCwgdGhpczsKICB9CiAgZ2V0T2JqZWN0QnlJZCh0KSB7CiAgICByZXR1cm4gdGhpcy5nZXRPYmplY3RCeVByb3BlcnR5KCJpZCIsIHQpOwogIH0KICBnZXRPYmplY3RCeU5hbWUodCkgewogICAgcmV0dXJuIHRoaXMuZ2V0T2JqZWN0QnlQcm9wZXJ0eSgibmFtZSIsIHQpOwogIH0KICBnZXRPYmplY3RCeVByb3BlcnR5KHQsIGUpIHsKICAgIGlmICh0aGlzW3RdID09PSBlKSByZXR1cm4gdGhpczsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgY29uc3QgciA9IHRoaXMuY2hpbGRyZW5baV0uZ2V0T2JqZWN0QnlQcm9wZXJ0eSh0LCBlKTsKICAgICAgaWYgKHIgIT09IHZvaWQgMCkKICAgICAgICByZXR1cm4gcjsKICAgIH0KICB9CiAgZ2V0T2JqZWN0c0J5UHJvcGVydHkodCwgZSwgaSA9IFtdKSB7CiAgICB0aGlzW3RdID09PSBlICYmIGkucHVzaCh0aGlzKTsKICAgIGNvbnN0IG4gPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgcyA9IDAsIHIgPSBuLmxlbmd0aDsgcyA8IHI7IHMrKykKICAgICAgbltzXS5nZXRPYmplY3RzQnlQcm9wZXJ0eSh0LCBlLCBpKTsKICAgIHJldHVybiBpOwogIH0KICBnZXRXb3JsZFBvc2l0aW9uKHQpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHQuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubWF0cml4V29ybGQpOwogIH0KICBnZXRXb3JsZFF1YXRlcm5pb24odCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdGhpcy5tYXRyaXhXb3JsZC5kZWNvbXBvc2UodG8sIHQsICRUKSwgdDsKICB9CiAgZ2V0V29ybGRTY2FsZSh0KSB7CiAgICByZXR1cm4gdGhpcy51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0aGlzLm1hdHJpeFdvcmxkLmRlY29tcG9zZSh0bywgWFQsIHQpLCB0OwogIH0KICBnZXRXb3JsZERpcmVjdGlvbih0KSB7CiAgICB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSk7CiAgICBjb25zdCBlID0gdGhpcy5tYXRyaXhXb3JsZC5lbGVtZW50czsKICAgIHJldHVybiB0LnNldChlWzhdLCBlWzldLCBlWzEwXSkubm9ybWFsaXplKCk7CiAgfQogIHJheWNhc3QoKSB7CiAgfQogIHRyYXZlcnNlKHQpIHsKICAgIHQodGhpcyk7CiAgICBjb25zdCBlID0gdGhpcy5jaGlsZHJlbjsKICAgIGZvciAobGV0IGkgPSAwLCBuID0gZS5sZW5ndGg7IGkgPCBuOyBpKyspCiAgICAgIGVbaV0udHJhdmVyc2UodCk7CiAgfQogIHRyYXZlcnNlVmlzaWJsZSh0KSB7CiAgICBpZiAodGhpcy52aXNpYmxlID09PSAhMSkgcmV0dXJuOwogICAgdCh0aGlzKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS50cmF2ZXJzZVZpc2libGUodCk7CiAgfQogIHRyYXZlcnNlQW5jZXN0b3JzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLnBhcmVudDsKICAgIGUgIT09IG51bGwgJiYgKHQoZSksIGUudHJhdmVyc2VBbmNlc3RvcnModCkpOwogIH0KICB1cGRhdGVNYXRyaXgoKSB7CiAgICB0aGlzLm1hdHJpeC5jb21wb3NlKHRoaXMucG9zaXRpb24sIHRoaXMucXVhdGVybmlvbiwgdGhpcy5zY2FsZSksIHRoaXMubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9ICEwOwogIH0KICB1cGRhdGVNYXRyaXhXb3JsZCh0KSB7CiAgICB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgJiYgdGhpcy51cGRhdGVNYXRyaXgoKSwgKHRoaXMubWF0cml4V29ybGROZWVkc1VwZGF0ZSB8fCB0KSAmJiAodGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09ICEwICYmICh0aGlzLnBhcmVudCA9PT0gbnVsbCA/IHRoaXMubWF0cml4V29ybGQuY29weSh0aGlzLm1hdHJpeCkgOiB0aGlzLm1hdHJpeFdvcmxkLm11bHRpcGx5TWF0cmljZXModGhpcy5wYXJlbnQubWF0cml4V29ybGQsIHRoaXMubWF0cml4KSksIHRoaXMubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9ICExLCB0ID0gITApOwogICAgY29uc3QgZSA9IHRoaXMuY2hpbGRyZW47CiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUubGVuZ3RoOyBpIDwgbjsgaSsrKQogICAgICBlW2ldLnVwZGF0ZU1hdHJpeFdvcmxkKHQpOwogIH0KICB1cGRhdGVXb3JsZE1hdHJpeCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5wYXJlbnQ7CiAgICBpZiAodCA9PT0gITAgJiYgaSAhPT0gbnVsbCAmJiBpLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHRoaXMubWF0cml4QXV0b1VwZGF0ZSAmJiB0aGlzLnVwZGF0ZU1hdHJpeCgpLCB0aGlzLm1hdHJpeFdvcmxkQXV0b1VwZGF0ZSA9PT0gITAgJiYgKHRoaXMucGFyZW50ID09PSBudWxsID8gdGhpcy5tYXRyaXhXb3JsZC5jb3B5KHRoaXMubWF0cml4KSA6IHRoaXMubWF0cml4V29ybGQubXVsdGlwbHlNYXRyaWNlcyh0aGlzLnBhcmVudC5tYXRyaXhXb3JsZCwgdGhpcy5tYXRyaXgpKSwgZSA9PT0gITApIHsKICAgICAgY29uc3QgbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgIGZvciAobGV0IHMgPSAwLCByID0gbi5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgICAgbltzXS51cGRhdGVXb3JsZE1hdHJpeCghMSwgITApOwogICAgfQogIH0KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHQgPT09IHZvaWQgMCB8fCB0eXBlb2YgdCA9PSAic3RyaW5nIiwgaSA9IHt9OwogICAgZSAmJiAodCA9IHsKICAgICAgZ2VvbWV0cmllczoge30sCiAgICAgIG1hdGVyaWFsczoge30sCiAgICAgIHRleHR1cmVzOiB7fSwKICAgICAgaW1hZ2VzOiB7fSwKICAgICAgc2hhcGVzOiB7fSwKICAgICAgc2tlbGV0b25zOiB7fSwKICAgICAgYW5pbWF0aW9uczoge30sCiAgICAgIG5vZGVzOiB7fQogICAgfSwgaS5tZXRhZGF0YSA9IHsKICAgICAgdmVyc2lvbjogNC42LAogICAgICB0eXBlOiAiT2JqZWN0IiwKICAgICAgZ2VuZXJhdG9yOiAiT2JqZWN0M0QudG9KU09OIgogICAgfSk7CiAgICBjb25zdCBuID0ge307CiAgICBuLnV1aWQgPSB0aGlzLnV1aWQsIG4udHlwZSA9IHRoaXMudHlwZSwgdGhpcy5uYW1lICE9PSAiIiAmJiAobi5uYW1lID0gdGhpcy5uYW1lKSwgdGhpcy5jYXN0U2hhZG93ID09PSAhMCAmJiAobi5jYXN0U2hhZG93ID0gITApLCB0aGlzLnJlY2VpdmVTaGFkb3cgPT09ICEwICYmIChuLnJlY2VpdmVTaGFkb3cgPSAhMCksIHRoaXMudmlzaWJsZSA9PT0gITEgJiYgKG4udmlzaWJsZSA9ICExKSwgdGhpcy5mcnVzdHVtQ3VsbGVkID09PSAhMSAmJiAobi5mcnVzdHVtQ3VsbGVkID0gITEpLCB0aGlzLnJlbmRlck9yZGVyICE9PSAwICYmIChuLnJlbmRlck9yZGVyID0gdGhpcy5yZW5kZXJPcmRlciksIE9iamVjdC5rZXlzKHRoaXMudXNlckRhdGEpLmxlbmd0aCA+IDAgJiYgKG4udXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhKSwgbi5sYXllcnMgPSB0aGlzLmxheWVycy5tYXNrLCBuLm1hdHJpeCA9IHRoaXMubWF0cml4LnRvQXJyYXkoKSwgbi51cCA9IHRoaXMudXAudG9BcnJheSgpLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPT09ICExICYmIChuLm1hdHJpeEF1dG9VcGRhdGUgPSAhMSksIHRoaXMuaXNJbnN0YW5jZWRNZXNoICYmIChuLnR5cGUgPSAiSW5zdGFuY2VkTWVzaCIsIG4uY291bnQgPSB0aGlzLmNvdW50LCBuLmluc3RhbmNlTWF0cml4ID0gdGhpcy5pbnN0YW5jZU1hdHJpeC50b0pTT04oKSwgdGhpcy5pbnN0YW5jZUNvbG9yICE9PSBudWxsICYmIChuLmluc3RhbmNlQ29sb3IgPSB0aGlzLmluc3RhbmNlQ29sb3IudG9KU09OKCkpKSwgdGhpcy5pc0JhdGNoZWRNZXNoICYmIChuLnR5cGUgPSAiQmF0Y2hlZE1lc2giLCBuLnBlck9iamVjdEZydXN0dW1DdWxsZWQgPSB0aGlzLnBlck9iamVjdEZydXN0dW1DdWxsZWQsIG4uc29ydE9iamVjdHMgPSB0aGlzLnNvcnRPYmplY3RzLCBuLmRyYXdSYW5nZXMgPSB0aGlzLl9kcmF3UmFuZ2VzLCBuLnJlc2VydmVkUmFuZ2VzID0gdGhpcy5fcmVzZXJ2ZWRSYW5nZXMsIG4udmlzaWJpbGl0eSA9IHRoaXMuX3Zpc2liaWxpdHksIG4uYWN0aXZlID0gdGhpcy5fYWN0aXZlLCBuLmJvdW5kcyA9IHRoaXMuX2JvdW5kcy5tYXAoKG8pID0+ICh7CiAgICAgIGJveEluaXRpYWxpemVkOiBvLmJveEluaXRpYWxpemVkLAogICAgICBib3hNaW46IG8uYm94Lm1pbi50b0FycmF5KCksCiAgICAgIGJveE1heDogby5ib3gubWF4LnRvQXJyYXkoKSwKICAgICAgc3BoZXJlSW5pdGlhbGl6ZWQ6IG8uc3BoZXJlSW5pdGlhbGl6ZWQsCiAgICAgIHNwaGVyZVJhZGl1czogby5zcGhlcmUucmFkaXVzLAogICAgICBzcGhlcmVDZW50ZXI6IG8uc3BoZXJlLmNlbnRlci50b0FycmF5KCkKICAgIH0pKSwgbi5tYXhJbnN0YW5jZUNvdW50ID0gdGhpcy5fbWF4SW5zdGFuY2VDb3VudCwgbi5tYXhWZXJ0ZXhDb3VudCA9IHRoaXMuX21heFZlcnRleENvdW50LCBuLm1heEluZGV4Q291bnQgPSB0aGlzLl9tYXhJbmRleENvdW50LCBuLmdlb21ldHJ5SW5pdGlhbGl6ZWQgPSB0aGlzLl9nZW9tZXRyeUluaXRpYWxpemVkLCBuLmdlb21ldHJ5Q291bnQgPSB0aGlzLl9nZW9tZXRyeUNvdW50LCBuLm1hdHJpY2VzVGV4dHVyZSA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZS50b0pTT04odCksIHRoaXMuX2NvbG9yc1RleHR1cmUgIT09IG51bGwgJiYgKG4uY29sb3JzVGV4dHVyZSA9IHRoaXMuX2NvbG9yc1RleHR1cmUudG9KU09OKHQpKSwgdGhpcy5ib3VuZGluZ1NwaGVyZSAhPT0gbnVsbCAmJiAobi5ib3VuZGluZ1NwaGVyZSA9IHsKICAgICAgY2VudGVyOiBuLmJvdW5kaW5nU3BoZXJlLmNlbnRlci50b0FycmF5KCksCiAgICAgIHJhZGl1czogbi5ib3VuZGluZ1NwaGVyZS5yYWRpdXMKICAgIH0pLCB0aGlzLmJvdW5kaW5nQm94ICE9PSBudWxsICYmIChuLmJvdW5kaW5nQm94ID0gewogICAgICBtaW46IG4uYm91bmRpbmdCb3gubWluLnRvQXJyYXkoKSwKICAgICAgbWF4OiBuLmJvdW5kaW5nQm94Lm1heC50b0FycmF5KCkKICAgIH0pKTsKICAgIGZ1bmN0aW9uIHMobywgbCkgewogICAgICByZXR1cm4gb1tsLnV1aWRdID09PSB2b2lkIDAgJiYgKG9bbC51dWlkXSA9IGwudG9KU09OKHQpKSwgbC51dWlkOwogICAgfQogICAgaWYgKHRoaXMuaXNTY2VuZSkKICAgICAgdGhpcy5iYWNrZ3JvdW5kICYmICh0aGlzLmJhY2tncm91bmQuaXNDb2xvciA/IG4uYmFja2dyb3VuZCA9IHRoaXMuYmFja2dyb3VuZC50b0pTT04oKSA6IHRoaXMuYmFja2dyb3VuZC5pc1RleHR1cmUgJiYgKG4uYmFja2dyb3VuZCA9IHRoaXMuYmFja2dyb3VuZC50b0pTT04odCkudXVpZCkpLCB0aGlzLmVudmlyb25tZW50ICYmIHRoaXMuZW52aXJvbm1lbnQuaXNUZXh0dXJlICYmIHRoaXMuZW52aXJvbm1lbnQuaXNSZW5kZXJUYXJnZXRUZXh0dXJlICE9PSAhMCAmJiAobi5lbnZpcm9ubWVudCA9IHRoaXMuZW52aXJvbm1lbnQudG9KU09OKHQpLnV1aWQpOwogICAgZWxzZSBpZiAodGhpcy5pc01lc2ggfHwgdGhpcy5pc0xpbmUgfHwgdGhpcy5pc1BvaW50cykgewogICAgICBuLmdlb21ldHJ5ID0gcyh0Lmdlb21ldHJpZXMsIHRoaXMuZ2VvbWV0cnkpOwogICAgICBjb25zdCBvID0gdGhpcy5nZW9tZXRyeS5wYXJhbWV0ZXJzOwogICAgICBpZiAobyAhPT0gdm9pZCAwICYmIG8uc2hhcGVzICE9PSB2b2lkIDApIHsKICAgICAgICBjb25zdCBsID0gby5zaGFwZXM7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobCkpCiAgICAgICAgICBmb3IgKGxldCBoID0gMCwgYyA9IGwubGVuZ3RoOyBoIDwgYzsgaCsrKSB7CiAgICAgICAgICAgIGNvbnN0IHUgPSBsW2hdOwogICAgICAgICAgICBzKHQuc2hhcGVzLCB1KTsKICAgICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgICBzKHQuc2hhcGVzLCBsKTsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuaXNTa2lubmVkTWVzaCAmJiAobi5iaW5kTW9kZSA9IHRoaXMuYmluZE1vZGUsIG4uYmluZE1hdHJpeCA9IHRoaXMuYmluZE1hdHJpeC50b0FycmF5KCksIHRoaXMuc2tlbGV0b24gIT09IHZvaWQgMCAmJiAocyh0LnNrZWxldG9ucywgdGhpcy5za2VsZXRvbiksIG4uc2tlbGV0b24gPSB0aGlzLnNrZWxldG9uLnV1aWQpKSwgdGhpcy5tYXRlcmlhbCAhPT0gdm9pZCAwKQogICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLm1hdGVyaWFsKSkgewogICAgICAgIGNvbnN0IG8gPSBbXTsKICAgICAgICBmb3IgKGxldCBsID0gMCwgaCA9IHRoaXMubWF0ZXJpYWwubGVuZ3RoOyBsIDwgaDsgbCsrKQogICAgICAgICAgby5wdXNoKHModC5tYXRlcmlhbHMsIHRoaXMubWF0ZXJpYWxbbF0pKTsKICAgICAgICBuLm1hdGVyaWFsID0gbzsKICAgICAgfSBlbHNlCiAgICAgICAgbi5tYXRlcmlhbCA9IHModC5tYXRlcmlhbHMsIHRoaXMubWF0ZXJpYWwpOwogICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgICBuLmNoaWxkcmVuID0gW107CiAgICAgIGZvciAobGV0IG8gPSAwOyBvIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IG8rKykKICAgICAgICBuLmNoaWxkcmVuLnB1c2godGhpcy5jaGlsZHJlbltvXS50b0pTT04odCkub2JqZWN0KTsKICAgIH0KICAgIGlmICh0aGlzLmFuaW1hdGlvbnMubGVuZ3RoID4gMCkgewogICAgICBuLmFuaW1hdGlvbnMgPSBbXTsKICAgICAgZm9yIChsZXQgbyA9IDA7IG8gPCB0aGlzLmFuaW1hdGlvbnMubGVuZ3RoOyBvKyspIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5hbmltYXRpb25zW29dOwogICAgICAgIG4uYW5pbWF0aW9ucy5wdXNoKHModC5hbmltYXRpb25zLCBsKSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChlKSB7CiAgICAgIGNvbnN0IG8gPSByKHQuZ2VvbWV0cmllcyksIGwgPSByKHQubWF0ZXJpYWxzKSwgaCA9IHIodC50ZXh0dXJlcyksIGMgPSByKHQuaW1hZ2VzKSwgdSA9IHIodC5zaGFwZXMpLCBkID0gcih0LnNrZWxldG9ucyksIHAgPSByKHQuYW5pbWF0aW9ucyksIGYgPSByKHQubm9kZXMpOwogICAgICBvLmxlbmd0aCA+IDAgJiYgKGkuZ2VvbWV0cmllcyA9IG8pLCBsLmxlbmd0aCA+IDAgJiYgKGkubWF0ZXJpYWxzID0gbCksIGgubGVuZ3RoID4gMCAmJiAoaS50ZXh0dXJlcyA9IGgpLCBjLmxlbmd0aCA+IDAgJiYgKGkuaW1hZ2VzID0gYyksIHUubGVuZ3RoID4gMCAmJiAoaS5zaGFwZXMgPSB1KSwgZC5sZW5ndGggPiAwICYmIChpLnNrZWxldG9ucyA9IGQpLCBwLmxlbmd0aCA+IDAgJiYgKGkuYW5pbWF0aW9ucyA9IHApLCBmLmxlbmd0aCA+IDAgJiYgKGkubm9kZXMgPSBmKTsKICAgIH0KICAgIHJldHVybiBpLm9iamVjdCA9IG4sIGk7CiAgICBmdW5jdGlvbiByKG8pIHsKICAgICAgY29uc3QgbCA9IFtdOwogICAgICBmb3IgKGNvbnN0IGggaW4gbykgewogICAgICAgIGNvbnN0IGMgPSBvW2hdOwogICAgICAgIGRlbGV0ZSBjLm1ldGFkYXRhLCBsLnB1c2goYyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGw7CiAgICB9CiAgfQogIGNsb25lKHQpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcywgdCk7CiAgfQogIGNvcHkodCwgZSA9ICEwKSB7CiAgICBpZiAodGhpcy5uYW1lID0gdC5uYW1lLCB0aGlzLnVwLmNvcHkodC51cCksIHRoaXMucG9zaXRpb24uY29weSh0LnBvc2l0aW9uKSwgdGhpcy5yb3RhdGlvbi5vcmRlciA9IHQucm90YXRpb24ub3JkZXIsIHRoaXMucXVhdGVybmlvbi5jb3B5KHQucXVhdGVybmlvbiksIHRoaXMuc2NhbGUuY29weSh0LnNjYWxlKSwgdGhpcy5tYXRyaXguY29weSh0Lm1hdHJpeCksIHRoaXMubWF0cml4V29ybGQuY29weSh0Lm1hdHJpeFdvcmxkKSwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gdC5tYXRyaXhBdXRvVXBkYXRlLCB0aGlzLm1hdHJpeFdvcmxkQXV0b1VwZGF0ZSA9IHQubWF0cml4V29ybGRBdXRvVXBkYXRlLCB0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSB0Lm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUsIHRoaXMubGF5ZXJzLm1hc2sgPSB0LmxheWVycy5tYXNrLCB0aGlzLnZpc2libGUgPSB0LnZpc2libGUsIHRoaXMuY2FzdFNoYWRvdyA9IHQuY2FzdFNoYWRvdywgdGhpcy5yZWNlaXZlU2hhZG93ID0gdC5yZWNlaXZlU2hhZG93LCB0aGlzLmZydXN0dW1DdWxsZWQgPSB0LmZydXN0dW1DdWxsZWQsIHRoaXMucmVuZGVyT3JkZXIgPSB0LnJlbmRlck9yZGVyLCB0aGlzLmFuaW1hdGlvbnMgPSB0LmFuaW1hdGlvbnMuc2xpY2UoKSwgdGhpcy51c2VyRGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodC51c2VyRGF0YSkpLCBlID09PSAhMCkKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgbiA9IHQuY2hpbGRyZW5baV07CiAgICAgICAgdGhpcy5hZGQobi5jbG9uZSgpKTsKICAgICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQp9OwpEYS5ERUZBVUxUX1VQID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgwLCAxLCAwKTsKRGEuREVGQVVMVF9NQVRSSVhfQVVUT19VUERBVEUgPSAhMDsKRGEuREVGQVVMVF9NQVRSSVhfV09STERfQVVUT19VUERBVEUgPSAhMDsKY29uc3Qgbm4gPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIEhuID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBFZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgR24gPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIFpyID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBqciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgV2cgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIFRkID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBDZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgUmQgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIFBkID0gLyogQF9fUFVSRV9fICovIG5ldyBQbigpLCBJZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUG4oKSwgTGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFBuKCk7CmNsYXNzIGNuIHsKICBjb25zdHJ1Y3Rvcih0ID0gbmV3IHR0KCksIGUgPSBuZXcgdHQoKSwgaSA9IG5ldyB0dCgpKSB7CiAgICB0aGlzLmEgPSB0LCB0aGlzLmIgPSBlLCB0aGlzLmMgPSBpOwogIH0KICBzdGF0aWMgZ2V0Tm9ybWFsKHQsIGUsIGksIG4pIHsKICAgIG4uc3ViVmVjdG9ycyhpLCBlKSwgbm4uc3ViVmVjdG9ycyh0LCBlKSwgbi5jcm9zcyhubik7CiAgICBjb25zdCBzID0gbi5sZW5ndGhTcSgpOwogICAgcmV0dXJuIHMgPiAwID8gbi5tdWx0aXBseVNjYWxhcigxIC8gTWF0aC5zcXJ0KHMpKSA6IG4uc2V0KDAsIDAsIDApOwogIH0KICAvLyBzdGF0aWMvaW5zdGFuY2UgbWV0aG9kIHRvIGNhbGN1bGF0ZSBiYXJ5Y2VudHJpYyBjb29yZGluYXRlcwogIC8vIGJhc2VkIG9uOiBodHRwOi8vd3d3LmJsYWNrcGF3bi5jb20vdGV4dHMvcG9pbnRpbnBvbHkvZGVmYXVsdC5odG1sCiAgc3RhdGljIGdldEJhcnljb29yZCh0LCBlLCBpLCBuLCBzKSB7CiAgICBubi5zdWJWZWN0b3JzKG4sIGUpLCBIbi5zdWJWZWN0b3JzKGksIGUpLCBFZC5zdWJWZWN0b3JzKHQsIGUpOwogICAgY29uc3QgciA9IG5uLmRvdChubiksIG8gPSBubi5kb3QoSG4pLCBsID0gbm4uZG90KEVkKSwgaCA9IEhuLmRvdChIbiksIGMgPSBIbi5kb3QoRWQpLCB1ID0gciAqIGggLSBvICogbzsKICAgIGlmICh1ID09PSAwKQogICAgICByZXR1cm4gcy5zZXQoMCwgMCwgMCksIG51bGw7CiAgICBjb25zdCBkID0gMSAvIHUsIHAgPSAoaCAqIGwgLSBvICogYykgKiBkLCBmID0gKHIgKiBjIC0gbyAqIGwpICogZDsKICAgIHJldHVybiBzLnNldCgxIC0gcCAtIGYsIGYsIHApOwogIH0KICBzdGF0aWMgY29udGFpbnNQb2ludCh0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdGhpcy5nZXRCYXJ5Y29vcmQodCwgZSwgaSwgbiwgR24pID09PSBudWxsID8gITEgOiBHbi54ID49IDAgJiYgR24ueSA+PSAwICYmIEduLnggKyBHbi55IDw9IDE7CiAgfQogIHN0YXRpYyBnZXRJbnRlcnBvbGF0aW9uKHQsIGUsIGksIG4sIHMsIHIsIG8sIGwpIHsKICAgIHJldHVybiB0aGlzLmdldEJhcnljb29yZCh0LCBlLCBpLCBuLCBHbikgPT09IG51bGwgPyAobC54ID0gMCwgbC55ID0gMCwgInoiIGluIGwgJiYgKGwueiA9IDApLCAidyIgaW4gbCAmJiAobC53ID0gMCksIG51bGwpIDogKGwuc2V0U2NhbGFyKDApLCBsLmFkZFNjYWxlZFZlY3RvcihzLCBHbi54KSwgbC5hZGRTY2FsZWRWZWN0b3IociwgR24ueSksIGwuYWRkU2NhbGVkVmVjdG9yKG8sIEduLnopLCBsKTsKICB9CiAgc3RhdGljIGdldEludGVycG9sYXRlZEF0dHJpYnV0ZSh0LCBlLCBpLCBuLCBzLCByKSB7CiAgICByZXR1cm4gUGQuc2V0U2NhbGFyKDApLCBJZC5zZXRTY2FsYXIoMCksIExkLnNldFNjYWxhcigwKSwgUGQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSwgSWQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBpKSwgTGQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBuKSwgci5zZXRTY2FsYXIoMCksIHIuYWRkU2NhbGVkVmVjdG9yKFBkLCBzLngpLCByLmFkZFNjYWxlZFZlY3RvcihJZCwgcy55KSwgci5hZGRTY2FsZWRWZWN0b3IoTGQsIHMueiksIHI7CiAgfQogIHN0YXRpYyBpc0Zyb250RmFjaW5nKHQsIGUsIGksIG4pIHsKICAgIHJldHVybiBubi5zdWJWZWN0b3JzKGksIGUpLCBIbi5zdWJWZWN0b3JzKHQsIGUpLCBubi5jcm9zcyhIbikuZG90KG4pIDwgMDsKICB9CiAgc2V0KHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLmEuY29weSh0KSwgdGhpcy5iLmNvcHkoZSksIHRoaXMuYy5jb3B5KGkpLCB0aGlzOwogIH0KICBzZXRGcm9tUG9pbnRzQW5kSW5kaWNlcyh0LCBlLCBpLCBuKSB7CiAgICByZXR1cm4gdGhpcy5hLmNvcHkodFtlXSksIHRoaXMuYi5jb3B5KHRbaV0pLCB0aGlzLmMuY29weSh0W25dKSwgdGhpczsKICB9CiAgc2V0RnJvbUF0dHJpYnV0ZUFuZEluZGljZXModCwgZSwgaSwgbikgewogICAgcmV0dXJuIHRoaXMuYS5mcm9tQnVmZmVyQXR0cmlidXRlKHQsIGUpLCB0aGlzLmIuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBpKSwgdGhpcy5jLmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgbiksIHRoaXM7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5hLmNvcHkodC5hKSwgdGhpcy5iLmNvcHkodC5iKSwgdGhpcy5jLmNvcHkodC5jKSwgdGhpczsKICB9CiAgZ2V0QXJlYSgpIHsKICAgIHJldHVybiBubi5zdWJWZWN0b3JzKHRoaXMuYywgdGhpcy5iKSwgSG4uc3ViVmVjdG9ycyh0aGlzLmEsIHRoaXMuYiksIG5uLmNyb3NzKEhuKS5sZW5ndGgoKSAqIDAuNTsKICB9CiAgZ2V0TWlkcG9pbnQodCkgewogICAgcmV0dXJuIHQuYWRkVmVjdG9ycyh0aGlzLmEsIHRoaXMuYikuYWRkKHRoaXMuYykubXVsdGlwbHlTY2FsYXIoMSAvIDMpOwogIH0KICBnZXROb3JtYWwodCkgewogICAgcmV0dXJuIGNuLmdldE5vcm1hbCh0aGlzLmEsIHRoaXMuYiwgdGhpcy5jLCB0KTsKICB9CiAgZ2V0UGxhbmUodCkgewogICAgcmV0dXJuIHQuc2V0RnJvbUNvcGxhbmFyUG9pbnRzKHRoaXMuYSwgdGhpcy5iLCB0aGlzLmMpOwogIH0KICBnZXRCYXJ5Y29vcmQodCwgZSkgewogICAgcmV0dXJuIGNuLmdldEJhcnljb29yZCh0LCB0aGlzLmEsIHRoaXMuYiwgdGhpcy5jLCBlKTsKICB9CiAgZ2V0SW50ZXJwb2xhdGlvbih0LCBlLCBpLCBuLCBzKSB7CiAgICByZXR1cm4gY24uZ2V0SW50ZXJwb2xhdGlvbih0LCB0aGlzLmEsIHRoaXMuYiwgdGhpcy5jLCBlLCBpLCBuLCBzKTsKICB9CiAgY29udGFpbnNQb2ludCh0KSB7CiAgICByZXR1cm4gY24uY29udGFpbnNQb2ludCh0LCB0aGlzLmEsIHRoaXMuYiwgdGhpcy5jKTsKICB9CiAgaXNGcm9udEZhY2luZyh0KSB7CiAgICByZXR1cm4gY24uaXNGcm9udEZhY2luZyh0aGlzLmEsIHRoaXMuYiwgdGhpcy5jLCB0KTsKICB9CiAgaW50ZXJzZWN0c0JveCh0KSB7CiAgICByZXR1cm4gdC5pbnRlcnNlY3RzVHJpYW5nbGUodGhpcyk7CiAgfQogIGNsb3Nlc3RQb2ludFRvUG9pbnQodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuYSwgbiA9IHRoaXMuYiwgcyA9IHRoaXMuYzsKICAgIGxldCByLCBvOwogICAgWnIuc3ViVmVjdG9ycyhuLCBpKSwganIuc3ViVmVjdG9ycyhzLCBpKSwgVGQuc3ViVmVjdG9ycyh0LCBpKTsKICAgIGNvbnN0IGwgPSBaci5kb3QoVGQpLCBoID0ganIuZG90KFRkKTsKICAgIGlmIChsIDw9IDAgJiYgaCA8PSAwKQogICAgICByZXR1cm4gZS5jb3B5KGkpOwogICAgQ2Quc3ViVmVjdG9ycyh0LCBuKTsKICAgIGNvbnN0IGMgPSBaci5kb3QoQ2QpLCB1ID0ganIuZG90KENkKTsKICAgIGlmIChjID49IDAgJiYgdSA8PSBjKQogICAgICByZXR1cm4gZS5jb3B5KG4pOwogICAgY29uc3QgZCA9IGwgKiB1IC0gYyAqIGg7CiAgICBpZiAoZCA8PSAwICYmIGwgPj0gMCAmJiBjIDw9IDApCiAgICAgIHJldHVybiByID0gbCAvIChsIC0gYyksIGUuY29weShpKS5hZGRTY2FsZWRWZWN0b3IoWnIsIHIpOwogICAgUmQuc3ViVmVjdG9ycyh0LCBzKTsKICAgIGNvbnN0IHAgPSBaci5kb3QoUmQpLCBmID0ganIuZG90KFJkKTsKICAgIGlmIChmID49IDAgJiYgcCA8PSBmKQogICAgICByZXR1cm4gZS5jb3B5KHMpOwogICAgY29uc3QgeSA9IHAgKiBoIC0gbCAqIGY7CiAgICBpZiAoeSA8PSAwICYmIGggPj0gMCAmJiBmIDw9IDApCiAgICAgIHJldHVybiBvID0gaCAvIChoIC0gZiksIGUuY29weShpKS5hZGRTY2FsZWRWZWN0b3IoanIsIG8pOwogICAgY29uc3QgZyA9IGMgKiBmIC0gcCAqIHU7CiAgICBpZiAoZyA8PSAwICYmIHUgLSBjID49IDAgJiYgcCAtIGYgPj0gMCkKICAgICAgcmV0dXJuIFdnLnN1YlZlY3RvcnMocywgbiksIG8gPSAodSAtIGMpIC8gKHUgLSBjICsgKHAgLSBmKSksIGUuY29weShuKS5hZGRTY2FsZWRWZWN0b3IoV2csIG8pOwogICAgY29uc3QgbSA9IDEgLyAoZyArIHkgKyBkKTsKICAgIHJldHVybiByID0geSAqIG0sIG8gPSBkICogbSwgZS5jb3B5KGkpLmFkZFNjYWxlZFZlY3RvcihaciwgcikuYWRkU2NhbGVkVmVjdG9yKGpyLCBvKTsKICB9CiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0LmEuZXF1YWxzKHRoaXMuYSkgJiYgdC5iLmVxdWFscyh0aGlzLmIpICYmIHQuYy5lcXVhbHModGhpcy5jKTsKICB9Cn0KY29uc3QgWl8gPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9LCBncyA9IHsgaDogMCwgczogMCwgbDogMCB9LCBuaCA9IHsgaDogMCwgczogMCwgbDogMCB9OwpmdW5jdGlvbiBEZChhLCB0LCBlKSB7CiAgcmV0dXJuIGUgPCAwICYmIChlICs9IDEpLCBlID4gMSAmJiAoZSAtPSAxKSwgZSA8IDEgLyA2ID8gYSArICh0IC0gYSkgKiA2ICogZSA6IGUgPCAxIC8gMiA/IHQgOiBlIDwgMiAvIDMgPyBhICsgKHQgLSBhKSAqIDYgKiAoMiAvIDMgLSBlKSA6IGE7Cn0KbGV0IEFpID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLmlzQ29sb3IgPSAhMCwgdGhpcy5yID0gMSwgdGhpcy5nID0gMSwgdGhpcy5iID0gMSwgdGhpcy5zZXQodCwgZSwgaSk7CiAgfQogIHNldCh0LCBlLCBpKSB7CiAgICBpZiAoZSA9PT0gdm9pZCAwICYmIGkgPT09IHZvaWQgMCkgewogICAgICBjb25zdCBuID0gdDsKICAgICAgbiAmJiBuLmlzQ29sb3IgPyB0aGlzLmNvcHkobikgOiB0eXBlb2YgbiA9PSAibnVtYmVyIiA/IHRoaXMuc2V0SGV4KG4pIDogdHlwZW9mIG4gPT0gInN0cmluZyIgJiYgdGhpcy5zZXRTdHlsZShuKTsKICAgIH0gZWxzZQogICAgICB0aGlzLnNldFJHQih0LCBlLCBpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMuciA9IHQsIHRoaXMuZyA9IHQsIHRoaXMuYiA9IHQsIHRoaXM7CiAgfQogIHNldEhleCh0LCBlID0gYW4pIHsKICAgIHJldHVybiB0ID0gTWF0aC5mbG9vcih0KSwgdGhpcy5yID0gKHQgPj4gMTYgJiAyNTUpIC8gMjU1LCB0aGlzLmcgPSAodCA+PiA4ICYgMjU1KSAvIDI1NSwgdGhpcy5iID0gKHQgJiAyNTUpIC8gMjU1LCBXaS50b1dvcmtpbmdDb2xvclNwYWNlKHRoaXMsIGUpLCB0aGlzOwogIH0KICBzZXRSR0IodCwgZSwgaSwgbiA9IFdpLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICByZXR1cm4gdGhpcy5yID0gdCwgdGhpcy5nID0gZSwgdGhpcy5iID0gaSwgV2kudG9Xb3JraW5nQ29sb3JTcGFjZSh0aGlzLCBuKSwgdGhpczsKICB9CiAgc2V0SFNMKHQsIGUsIGksIG4gPSBXaS53b3JraW5nQ29sb3JTcGFjZSkgewogICAgaWYgKHQgPSB5Zih0LCAxKSwgZSA9IGFpKGUsIDAsIDEpLCBpID0gYWkoaSwgMCwgMSksIGUgPT09IDApCiAgICAgIHRoaXMuciA9IHRoaXMuZyA9IHRoaXMuYiA9IGk7CiAgICBlbHNlIHsKICAgICAgY29uc3QgcyA9IGkgPD0gMC41ID8gaSAqICgxICsgZSkgOiBpICsgZSAtIGkgKiBlLCByID0gMiAqIGkgLSBzOwogICAgICB0aGlzLnIgPSBEZChyLCBzLCB0ICsgMSAvIDMpLCB0aGlzLmcgPSBEZChyLCBzLCB0KSwgdGhpcy5iID0gRGQociwgcywgdCAtIDEgLyAzKTsKICAgIH0KICAgIHJldHVybiBXaS50b1dvcmtpbmdDb2xvclNwYWNlKHRoaXMsIG4pLCB0aGlzOwogIH0KICBzZXRTdHlsZSh0LCBlID0gYW4pIHsKICAgIGZ1bmN0aW9uIGkocykgewogICAgICBzICE9PSB2b2lkIDAgJiYgcGFyc2VGbG9hdChzKSA8IDEgJiYgY29uc29sZS53YXJuKCJUSFJFRS5Db2xvcjogQWxwaGEgY29tcG9uZW50IG9mICIgKyB0ICsgIiB3aWxsIGJlIGlnbm9yZWQuIik7CiAgICB9CiAgICBsZXQgbjsKICAgIGlmIChuID0gL14oXHcrKVwoKFteXCldKilcKS8uZXhlYyh0KSkgewogICAgICBsZXQgczsKICAgICAgY29uc3QgciA9IG5bMV0sIG8gPSBuWzJdOwogICAgICBzd2l0Y2ggKHIpIHsKICAgICAgICBjYXNlICJyZ2IiOgogICAgICAgIGNhc2UgInJnYmEiOgogICAgICAgICAgaWYgKHMgPSAvXlxzKihcZCspXHMqLFxzKihcZCspXHMqLFxzKihcZCspXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKG8pKQogICAgICAgICAgICByZXR1cm4gaShzWzRdKSwgdGhpcy5zZXRSR0IoCiAgICAgICAgICAgICAgTWF0aC5taW4oMjU1LCBwYXJzZUludChzWzFdLCAxMCkpIC8gMjU1LAogICAgICAgICAgICAgIE1hdGgubWluKDI1NSwgcGFyc2VJbnQoc1syXSwgMTApKSAvIDI1NSwKICAgICAgICAgICAgICBNYXRoLm1pbigyNTUsIHBhcnNlSW50KHNbM10sIDEwKSkgLyAyNTUsCiAgICAgICAgICAgICAgZQogICAgICAgICAgICApOwogICAgICAgICAgaWYgKHMgPSAvXlxzKihcZCspXCVccyosXHMqKFxkKylcJVxzKixccyooXGQrKVwlXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKG8pKQogICAgICAgICAgICByZXR1cm4gaShzWzRdKSwgdGhpcy5zZXRSR0IoCiAgICAgICAgICAgICAgTWF0aC5taW4oMTAwLCBwYXJzZUludChzWzFdLCAxMCkpIC8gMTAwLAogICAgICAgICAgICAgIE1hdGgubWluKDEwMCwgcGFyc2VJbnQoc1syXSwgMTApKSAvIDEwMCwKICAgICAgICAgICAgICBNYXRoLm1pbigxMDAsIHBhcnNlSW50KHNbM10sIDEwKSkgLyAxMDAsCiAgICAgICAgICAgICAgZQogICAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiaHNsIjoKICAgICAgICBjYXNlICJoc2xhIjoKICAgICAgICAgIGlmIChzID0gL15ccyooXGQqXC4/XGQrKVxzKixccyooXGQqXC4/XGQrKVwlXHMqLFxzKihcZCpcLj9cZCspXCVccyooPzosXHMqKFxkKlwuP1xkKylccyopPyQvLmV4ZWMobykpCiAgICAgICAgICAgIHJldHVybiBpKHNbNF0pLCB0aGlzLnNldEhTTCgKICAgICAgICAgICAgICBwYXJzZUZsb2F0KHNbMV0pIC8gMzYwLAogICAgICAgICAgICAgIHBhcnNlRmxvYXQoc1syXSkgLyAxMDAsCiAgICAgICAgICAgICAgcGFyc2VGbG9hdChzWzNdKSAvIDEwMCwKICAgICAgICAgICAgICBlCiAgICAgICAgICAgICk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5Db2xvcjogVW5rbm93biBjb2xvciBtb2RlbCAiICsgdCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobiA9IC9eXCMoW0EtRmEtZlxkXSspJC8uZXhlYyh0KSkgewogICAgICBjb25zdCBzID0gblsxXSwgciA9IHMubGVuZ3RoOwogICAgICBpZiAociA9PT0gMykKICAgICAgICByZXR1cm4gdGhpcy5zZXRSR0IoCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgwKSwgMTYpIC8gMTUsCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgxKSwgMTYpIC8gMTUsCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgyKSwgMTYpIC8gMTUsCiAgICAgICAgICBlCiAgICAgICAgKTsKICAgICAgaWYgKHIgPT09IDYpCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0SGV4KHBhcnNlSW50KHMsIDE2KSwgZSk7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuQ29sb3I6IEludmFsaWQgaGV4IGNvbG9yICIgKyB0KTsKICAgIH0gZWxzZSBpZiAodCAmJiB0Lmxlbmd0aCA+IDApCiAgICAgIHJldHVybiB0aGlzLnNldENvbG9yTmFtZSh0LCBlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRDb2xvck5hbWUodCwgZSA9IGFuKSB7CiAgICBjb25zdCBpID0gWl9bdC50b0xvd2VyQ2FzZSgpXTsKICAgIHJldHVybiBpICE9PSB2b2lkIDAgPyB0aGlzLnNldEhleChpLCBlKSA6IGNvbnNvbGUud2FybigiVEhSRUUuQ29sb3I6IFVua25vd24gY29sb3IgIiArIHQpLCB0aGlzOwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLnIsIHRoaXMuZywgdGhpcy5iKTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gdC5yLCB0aGlzLmcgPSB0LmcsIHRoaXMuYiA9IHQuYiwgdGhpczsKICB9CiAgY29weVNSR0JUb0xpbmVhcih0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gS24odC5yKSwgdGhpcy5nID0gS24odC5nKSwgdGhpcy5iID0gS24odC5iKSwgdGhpczsKICB9CiAgY29weUxpbmVhclRvU1JHQih0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gaGEodC5yKSwgdGhpcy5nID0gaGEodC5nKSwgdGhpcy5iID0gaGEodC5iKSwgdGhpczsKICB9CiAgY29udmVydFNSR0JUb0xpbmVhcigpIHsKICAgIHJldHVybiB0aGlzLmNvcHlTUkdCVG9MaW5lYXIodGhpcyksIHRoaXM7CiAgfQogIGNvbnZlcnRMaW5lYXJUb1NSR0IoKSB7CiAgICByZXR1cm4gdGhpcy5jb3B5TGluZWFyVG9TUkdCKHRoaXMpLCB0aGlzOwogIH0KICBnZXRIZXgodCA9IGFuKSB7CiAgICByZXR1cm4gV2kuZnJvbVdvcmtpbmdDb2xvclNwYWNlKGVpLmNvcHkodGhpcyksIHQpLCBNYXRoLnJvdW5kKGFpKGVpLnIgKiAyNTUsIDAsIDI1NSkpICogNjU1MzYgKyBNYXRoLnJvdW5kKGFpKGVpLmcgKiAyNTUsIDAsIDI1NSkpICogMjU2ICsgTWF0aC5yb3VuZChhaShlaS5iICogMjU1LCAwLCAyNTUpKTsKICB9CiAgZ2V0SGV4U3RyaW5nKHQgPSBhbikgewogICAgcmV0dXJuICgiMDAwMDAwIiArIHRoaXMuZ2V0SGV4KHQpLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTYpOwogIH0KICBnZXRIU0wodCwgZSA9IFdpLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICBXaS5mcm9tV29ya2luZ0NvbG9yU3BhY2UoZWkuY29weSh0aGlzKSwgZSk7CiAgICBjb25zdCBpID0gZWkuciwgbiA9IGVpLmcsIHMgPSBlaS5iLCByID0gTWF0aC5tYXgoaSwgbiwgcyksIG8gPSBNYXRoLm1pbihpLCBuLCBzKTsKICAgIGxldCBsLCBoOwogICAgY29uc3QgYyA9IChvICsgcikgLyAyOwogICAgaWYgKG8gPT09IHIpCiAgICAgIGwgPSAwLCBoID0gMDsKICAgIGVsc2UgewogICAgICBjb25zdCB1ID0gciAtIG87CiAgICAgIHN3aXRjaCAoaCA9IGMgPD0gMC41ID8gdSAvIChyICsgbykgOiB1IC8gKDIgLSByIC0gbyksIHIpIHsKICAgICAgICBjYXNlIGk6CiAgICAgICAgICBsID0gKG4gLSBzKSAvIHUgKyAobiA8IHMgPyA2IDogMCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIG46CiAgICAgICAgICBsID0gKHMgLSBpKSAvIHUgKyAyOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBzOgogICAgICAgICAgbCA9IChpIC0gbikgLyB1ICsgNDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGwgLz0gNjsKICAgIH0KICAgIHJldHVybiB0LmggPSBsLCB0LnMgPSBoLCB0LmwgPSBjLCB0OwogIH0KICBnZXRSR0IodCwgZSA9IFdpLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICByZXR1cm4gV2kuZnJvbVdvcmtpbmdDb2xvclNwYWNlKGVpLmNvcHkodGhpcyksIGUpLCB0LnIgPSBlaS5yLCB0LmcgPSBlaS5nLCB0LmIgPSBlaS5iLCB0OwogIH0KICBnZXRTdHlsZSh0ID0gYW4pIHsKICAgIFdpLmZyb21Xb3JraW5nQ29sb3JTcGFjZShlaS5jb3B5KHRoaXMpLCB0KTsKICAgIGNvbnN0IGUgPSBlaS5yLCBpID0gZWkuZywgbiA9IGVpLmI7CiAgICByZXR1cm4gdCAhPT0gYW4gPyBgY29sb3IoJHt0fSAke2UudG9GaXhlZCgzKX0gJHtpLnRvRml4ZWQoMyl9ICR7bi50b0ZpeGVkKDMpfSlgIDogYHJnYigke01hdGgucm91bmQoZSAqIDI1NSl9LCR7TWF0aC5yb3VuZChpICogMjU1KX0sJHtNYXRoLnJvdW5kKG4gKiAyNTUpfSlgOwogIH0KICBvZmZzZXRIU0wodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMuZ2V0SFNMKGdzKSwgdGhpcy5zZXRIU0woZ3MuaCArIHQsIGdzLnMgKyBlLCBncy5sICsgaSk7CiAgfQogIGFkZCh0KSB7CiAgICByZXR1cm4gdGhpcy5yICs9IHQuciwgdGhpcy5nICs9IHQuZywgdGhpcy5iICs9IHQuYiwgdGhpczsKICB9CiAgYWRkQ29sb3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0LnIgKyBlLnIsIHRoaXMuZyA9IHQuZyArIGUuZywgdGhpcy5iID0gdC5iICsgZS5iLCB0aGlzOwogIH0KICBhZGRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMuciArPSB0LCB0aGlzLmcgKz0gdCwgdGhpcy5iICs9IHQsIHRoaXM7CiAgfQogIHN1Yih0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gTWF0aC5tYXgoMCwgdGhpcy5yIC0gdC5yKSwgdGhpcy5nID0gTWF0aC5tYXgoMCwgdGhpcy5nIC0gdC5nKSwgdGhpcy5iID0gTWF0aC5tYXgoMCwgdGhpcy5iIC0gdC5iKSwgdGhpczsKICB9CiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMuciAqPSB0LnIsIHRoaXMuZyAqPSB0LmcsIHRoaXMuYiAqPSB0LmIsIHRoaXM7CiAgfQogIG11bHRpcGx5U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnIgKj0gdCwgdGhpcy5nICo9IHQsIHRoaXMuYiAqPSB0LCB0aGlzOwogIH0KICBsZXJwKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnIgKz0gKHQuciAtIHRoaXMucikgKiBlLCB0aGlzLmcgKz0gKHQuZyAtIHRoaXMuZykgKiBlLCB0aGlzLmIgKz0gKHQuYiAtIHRoaXMuYikgKiBlLCB0aGlzOwogIH0KICBsZXJwQ29sb3JzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0LnIgKyAoZS5yIC0gdC5yKSAqIGksIHRoaXMuZyA9IHQuZyArIChlLmcgLSB0LmcpICogaSwgdGhpcy5iID0gdC5iICsgKGUuYiAtIHQuYikgKiBpLCB0aGlzOwogIH0KICBsZXJwSFNMKHQsIGUpIHsKICAgIHRoaXMuZ2V0SFNMKGdzKSwgdC5nZXRIU0wobmgpOwogICAgY29uc3QgaSA9IHlvKGdzLmgsIG5oLmgsIGUpLCBuID0geW8oZ3MucywgbmgucywgZSksIHMgPSB5byhncy5sLCBuaC5sLCBlKTsKICAgIHJldHVybiB0aGlzLnNldEhTTChpLCBuLCBzKSwgdGhpczsKICB9CiAgc2V0RnJvbVZlY3RvcjModCkgewogICAgcmV0dXJuIHRoaXMuciA9IHQueCwgdGhpcy5nID0gdC55LCB0aGlzLmIgPSB0LnosIHRoaXM7CiAgfQogIGFwcGx5TWF0cml4Myh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5yLCBpID0gdGhpcy5nLCBuID0gdGhpcy5iLCBzID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnIgPSBzWzBdICogZSArIHNbM10gKiBpICsgc1s2XSAqIG4sIHRoaXMuZyA9IHNbMV0gKiBlICsgc1s0XSAqIGkgKyBzWzddICogbiwgdGhpcy5iID0gc1syXSAqIGUgKyBzWzVdICogaSArIHNbOF0gKiBuLCB0aGlzOwogIH0KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuciA9PT0gdGhpcy5yICYmIHQuZyA9PT0gdGhpcy5nICYmIHQuYiA9PT0gdGhpcy5iOwogIH0KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnIgPSB0W2VdLCB0aGlzLmcgPSB0W2UgKyAxXSwgdGhpcy5iID0gdFtlICsgMl0sIHRoaXM7CiAgfQogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgcmV0dXJuIHRbZV0gPSB0aGlzLnIsIHRbZSArIDFdID0gdGhpcy5nLCB0W2UgKyAyXSA9IHRoaXMuYiwgdDsKICB9CiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5yID0gdC5nZXRYKGUpLCB0aGlzLmcgPSB0LmdldFkoZSksIHRoaXMuYiA9IHQuZ2V0WihlKSwgdGhpczsKICB9CiAgdG9KU09OKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0SGV4KCk7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMuciwgeWllbGQgdGhpcy5nLCB5aWVsZCB0aGlzLmI7CiAgfQp9Owpjb25zdCBlaSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWkoKTsKQWkuTkFNRVMgPSBaXzsKbGV0IFpUID0gMDsKY2xhc3MgeGYgZXh0ZW5kcyBjdSB7CiAgc3RhdGljIGdldCB0eXBlKCkgewogICAgcmV0dXJuICJNYXRlcmlhbCI7CiAgfQogIGdldCB0eXBlKCkgewogICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudHlwZTsKICB9CiAgc2V0IHR5cGUodCkgewogIH0KICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNNYXRlcmlhbCA9ICEwLCBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgImlkIiwgeyB2YWx1ZTogWlQrKyB9KSwgdGhpcy51dWlkID0gSm4oKSwgdGhpcy5uYW1lID0gIiIsIHRoaXMuYmxlbmRpbmcgPSBiZywgdGhpcy5zaWRlID0gQm8sIHRoaXMudmVydGV4Q29sb3JzID0gITEsIHRoaXMub3BhY2l0eSA9IDEsIHRoaXMudHJhbnNwYXJlbnQgPSAhMSwgdGhpcy5hbHBoYUhhc2ggPSAhMSwgdGhpcy5ibGVuZFNyYyA9IFNnLCB0aGlzLmJsZW5kRHN0ID0gd2csIHRoaXMuYmxlbmRFcXVhdGlvbiA9IE1nLCB0aGlzLmJsZW5kU3JjQWxwaGEgPSBudWxsLCB0aGlzLmJsZW5kRHN0QWxwaGEgPSBudWxsLCB0aGlzLmJsZW5kRXF1YXRpb25BbHBoYSA9IG51bGwsIHRoaXMuYmxlbmRDb2xvciA9IG5ldyBBaSgwLCAwLCAwKSwgdGhpcy5ibGVuZEFscGhhID0gMCwgdGhpcy5kZXB0aEZ1bmMgPSBBZywgdGhpcy5kZXB0aFRlc3QgPSAhMCwgdGhpcy5kZXB0aFdyaXRlID0gITAsIHRoaXMuc3RlbmNpbFdyaXRlTWFzayA9IDI1NSwgdGhpcy5zdGVuY2lsRnVuYyA9IFNjLCB0aGlzLnN0ZW5jaWxSZWYgPSAwLCB0aGlzLnN0ZW5jaWxGdW5jTWFzayA9IDI1NSwgdGhpcy5zdGVuY2lsRmFpbCA9IFZyLCB0aGlzLnN0ZW5jaWxaRmFpbCA9IFZyLCB0aGlzLnN0ZW5jaWxaUGFzcyA9IFZyLCB0aGlzLnN0ZW5jaWxXcml0ZSA9ICExLCB0aGlzLmNsaXBwaW5nUGxhbmVzID0gbnVsbCwgdGhpcy5jbGlwSW50ZXJzZWN0aW9uID0gITEsIHRoaXMuY2xpcFNoYWRvd3MgPSAhMSwgdGhpcy5zaGFkb3dTaWRlID0gbnVsbCwgdGhpcy5jb2xvcldyaXRlID0gITAsIHRoaXMucHJlY2lzaW9uID0gbnVsbCwgdGhpcy5wb2x5Z29uT2Zmc2V0ID0gITEsIHRoaXMucG9seWdvbk9mZnNldEZhY3RvciA9IDAsIHRoaXMucG9seWdvbk9mZnNldFVuaXRzID0gMCwgdGhpcy5kaXRoZXJpbmcgPSAhMSwgdGhpcy5hbHBoYVRvQ292ZXJhZ2UgPSAhMSwgdGhpcy5wcmVtdWx0aXBsaWVkQWxwaGEgPSAhMSwgdGhpcy5mb3JjZVNpbmdsZVBhc3MgPSAhMSwgdGhpcy52aXNpYmxlID0gITAsIHRoaXMudG9uZU1hcHBlZCA9ICEwLCB0aGlzLnVzZXJEYXRhID0ge30sIHRoaXMudmVyc2lvbiA9IDAsIHRoaXMuX2FscGhhVGVzdCA9IDA7CiAgfQogIGdldCBhbHBoYVRlc3QoKSB7CiAgICByZXR1cm4gdGhpcy5fYWxwaGFUZXN0OwogIH0KICBzZXQgYWxwaGFUZXN0KHQpIHsKICAgIHRoaXMuX2FscGhhVGVzdCA+IDAgIT0gdCA+IDAgJiYgdGhpcy52ZXJzaW9uKyssIHRoaXMuX2FscGhhVGVzdCA9IHQ7CiAgfQogIC8vIG9uQmVmb3JlUmVuZGVyIGFuZCBvbkJlZm9yZUNvbXBpbGUgb25seSBzdXBwb3J0ZWQgaW4gV2ViR0xSZW5kZXJlcgogIG9uQmVmb3JlUmVuZGVyKCkgewogIH0KICBvbkJlZm9yZUNvbXBpbGUoKSB7CiAgfQogIGN1c3RvbVByb2dyYW1DYWNoZUtleSgpIHsKICAgIHJldHVybiB0aGlzLm9uQmVmb3JlQ29tcGlsZS50b1N0cmluZygpOwogIH0KICBzZXRWYWx1ZXModCkgewogICAgaWYgKHQgIT09IHZvaWQgMCkKICAgICAgZm9yIChjb25zdCBlIGluIHQpIHsKICAgICAgICBjb25zdCBpID0gdFtlXTsKICAgICAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oYFRIUkVFLk1hdGVyaWFsOiBwYXJhbWV0ZXIgJyR7ZX0nIGhhcyB2YWx1ZSBvZiB1bmRlZmluZWQuYCk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbiA9IHRoaXNbZV07CiAgICAgICAgaWYgKG4gPT09IHZvaWQgMCkgewogICAgICAgICAgY29uc29sZS53YXJuKGBUSFJFRS5NYXRlcmlhbDogJyR7ZX0nIGlzIG5vdCBhIHByb3BlcnR5IG9mIFRIUkVFLiR7dGhpcy50eXBlfS5gKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBuICYmIG4uaXNDb2xvciA/IG4uc2V0KGkpIDogbiAmJiBuLmlzVmVjdG9yMyAmJiBpICYmIGkuaXNWZWN0b3IzID8gbi5jb3B5KGkpIDogdGhpc1tlXSA9IGk7CiAgICAgIH0KICB9CiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSB0ID09PSB2b2lkIDAgfHwgdHlwZW9mIHQgPT0gInN0cmluZyI7CiAgICBlICYmICh0ID0gewogICAgICB0ZXh0dXJlczoge30sCiAgICAgIGltYWdlczoge30KICAgIH0pOwogICAgY29uc3QgaSA9IHsKICAgICAgbWV0YWRhdGE6IHsKICAgICAgICB2ZXJzaW9uOiA0LjYsCiAgICAgICAgdHlwZTogIk1hdGVyaWFsIiwKICAgICAgICBnZW5lcmF0b3I6ICJNYXRlcmlhbC50b0pTT04iCiAgICAgIH0KICAgIH07CiAgICBpLnV1aWQgPSB0aGlzLnV1aWQsIGkudHlwZSA9IHRoaXMudHlwZSwgdGhpcy5uYW1lICE9PSAiIiAmJiAoaS5uYW1lID0gdGhpcy5uYW1lKSwgdGhpcy5jb2xvciAmJiB0aGlzLmNvbG9yLmlzQ29sb3IgJiYgKGkuY29sb3IgPSB0aGlzLmNvbG9yLmdldEhleCgpKSwgdGhpcy5yb3VnaG5lc3MgIT09IHZvaWQgMCAmJiAoaS5yb3VnaG5lc3MgPSB0aGlzLnJvdWdobmVzcyksIHRoaXMubWV0YWxuZXNzICE9PSB2b2lkIDAgJiYgKGkubWV0YWxuZXNzID0gdGhpcy5tZXRhbG5lc3MpLCB0aGlzLnNoZWVuICE9PSB2b2lkIDAgJiYgKGkuc2hlZW4gPSB0aGlzLnNoZWVuKSwgdGhpcy5zaGVlbkNvbG9yICYmIHRoaXMuc2hlZW5Db2xvci5pc0NvbG9yICYmIChpLnNoZWVuQ29sb3IgPSB0aGlzLnNoZWVuQ29sb3IuZ2V0SGV4KCkpLCB0aGlzLnNoZWVuUm91Z2huZXNzICE9PSB2b2lkIDAgJiYgKGkuc2hlZW5Sb3VnaG5lc3MgPSB0aGlzLnNoZWVuUm91Z2huZXNzKSwgdGhpcy5lbWlzc2l2ZSAmJiB0aGlzLmVtaXNzaXZlLmlzQ29sb3IgJiYgKGkuZW1pc3NpdmUgPSB0aGlzLmVtaXNzaXZlLmdldEhleCgpKSwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSAhPT0gdm9pZCAwICYmIHRoaXMuZW1pc3NpdmVJbnRlbnNpdHkgIT09IDEgJiYgKGkuZW1pc3NpdmVJbnRlbnNpdHkgPSB0aGlzLmVtaXNzaXZlSW50ZW5zaXR5KSwgdGhpcy5zcGVjdWxhciAmJiB0aGlzLnNwZWN1bGFyLmlzQ29sb3IgJiYgKGkuc3BlY3VsYXIgPSB0aGlzLnNwZWN1bGFyLmdldEhleCgpKSwgdGhpcy5zcGVjdWxhckludGVuc2l0eSAhPT0gdm9pZCAwICYmIChpLnNwZWN1bGFySW50ZW5zaXR5ID0gdGhpcy5zcGVjdWxhckludGVuc2l0eSksIHRoaXMuc3BlY3VsYXJDb2xvciAmJiB0aGlzLnNwZWN1bGFyQ29sb3IuaXNDb2xvciAmJiAoaS5zcGVjdWxhckNvbG9yID0gdGhpcy5zcGVjdWxhckNvbG9yLmdldEhleCgpKSwgdGhpcy5zaGluaW5lc3MgIT09IHZvaWQgMCAmJiAoaS5zaGluaW5lc3MgPSB0aGlzLnNoaW5pbmVzcyksIHRoaXMuY2xlYXJjb2F0ICE9PSB2b2lkIDAgJiYgKGkuY2xlYXJjb2F0ID0gdGhpcy5jbGVhcmNvYXQpLCB0aGlzLmNsZWFyY29hdFJvdWdobmVzcyAhPT0gdm9pZCAwICYmIChpLmNsZWFyY29hdFJvdWdobmVzcyA9IHRoaXMuY2xlYXJjb2F0Um91Z2huZXNzKSwgdGhpcy5jbGVhcmNvYXRNYXAgJiYgdGhpcy5jbGVhcmNvYXRNYXAuaXNUZXh0dXJlICYmIChpLmNsZWFyY29hdE1hcCA9IHRoaXMuY2xlYXJjb2F0TWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgJiYgdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAuaXNUZXh0dXJlICYmIChpLmNsZWFyY29hdFJvdWdobmVzc01hcCA9IHRoaXMuY2xlYXJjb2F0Um91Z2huZXNzTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5jbGVhcmNvYXROb3JtYWxNYXAgJiYgdGhpcy5jbGVhcmNvYXROb3JtYWxNYXAuaXNUZXh0dXJlICYmIChpLmNsZWFyY29hdE5vcm1hbE1hcCA9IHRoaXMuY2xlYXJjb2F0Tm9ybWFsTWFwLnRvSlNPTih0KS51dWlkLCBpLmNsZWFyY29hdE5vcm1hbFNjYWxlID0gdGhpcy5jbGVhcmNvYXROb3JtYWxTY2FsZS50b0FycmF5KCkpLCB0aGlzLmRpc3BlcnNpb24gIT09IHZvaWQgMCAmJiAoaS5kaXNwZXJzaW9uID0gdGhpcy5kaXNwZXJzaW9uKSwgdGhpcy5pcmlkZXNjZW5jZSAhPT0gdm9pZCAwICYmIChpLmlyaWRlc2NlbmNlID0gdGhpcy5pcmlkZXNjZW5jZSksIHRoaXMuaXJpZGVzY2VuY2VJT1IgIT09IHZvaWQgMCAmJiAoaS5pcmlkZXNjZW5jZUlPUiA9IHRoaXMuaXJpZGVzY2VuY2VJT1IpLCB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UgIT09IHZvaWQgMCAmJiAoaS5pcmlkZXNjZW5jZVRoaWNrbmVzc1JhbmdlID0gdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc1JhbmdlKSwgdGhpcy5pcmlkZXNjZW5jZU1hcCAmJiB0aGlzLmlyaWRlc2NlbmNlTWFwLmlzVGV4dHVyZSAmJiAoaS5pcmlkZXNjZW5jZU1hcCA9IHRoaXMuaXJpZGVzY2VuY2VNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwICYmIHRoaXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAuaXNUZXh0dXJlICYmIChpLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwID0gdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcC50b0pTT04odCkudXVpZCksIHRoaXMuYW5pc290cm9weSAhPT0gdm9pZCAwICYmIChpLmFuaXNvdHJvcHkgPSB0aGlzLmFuaXNvdHJvcHkpLCB0aGlzLmFuaXNvdHJvcHlSb3RhdGlvbiAhPT0gdm9pZCAwICYmIChpLmFuaXNvdHJvcHlSb3RhdGlvbiA9IHRoaXMuYW5pc290cm9weVJvdGF0aW9uKSwgdGhpcy5hbmlzb3Ryb3B5TWFwICYmIHRoaXMuYW5pc290cm9weU1hcC5pc1RleHR1cmUgJiYgKGkuYW5pc290cm9weU1hcCA9IHRoaXMuYW5pc290cm9weU1hcC50b0pTT04odCkudXVpZCksIHRoaXMubWFwICYmIHRoaXMubWFwLmlzVGV4dHVyZSAmJiAoaS5tYXAgPSB0aGlzLm1hcC50b0pTT04odCkudXVpZCksIHRoaXMubWF0Y2FwICYmIHRoaXMubWF0Y2FwLmlzVGV4dHVyZSAmJiAoaS5tYXRjYXAgPSB0aGlzLm1hdGNhcC50b0pTT04odCkudXVpZCksIHRoaXMuYWxwaGFNYXAgJiYgdGhpcy5hbHBoYU1hcC5pc1RleHR1cmUgJiYgKGkuYWxwaGFNYXAgPSB0aGlzLmFscGhhTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5saWdodE1hcCAmJiB0aGlzLmxpZ2h0TWFwLmlzVGV4dHVyZSAmJiAoaS5saWdodE1hcCA9IHRoaXMubGlnaHRNYXAudG9KU09OKHQpLnV1aWQsIGkubGlnaHRNYXBJbnRlbnNpdHkgPSB0aGlzLmxpZ2h0TWFwSW50ZW5zaXR5KSwgdGhpcy5hb01hcCAmJiB0aGlzLmFvTWFwLmlzVGV4dHVyZSAmJiAoaS5hb01hcCA9IHRoaXMuYW9NYXAudG9KU09OKHQpLnV1aWQsIGkuYW9NYXBJbnRlbnNpdHkgPSB0aGlzLmFvTWFwSW50ZW5zaXR5KSwgdGhpcy5idW1wTWFwICYmIHRoaXMuYnVtcE1hcC5pc1RleHR1cmUgJiYgKGkuYnVtcE1hcCA9IHRoaXMuYnVtcE1hcC50b0pTT04odCkudXVpZCwgaS5idW1wU2NhbGUgPSB0aGlzLmJ1bXBTY2FsZSksIHRoaXMubm9ybWFsTWFwICYmIHRoaXMubm9ybWFsTWFwLmlzVGV4dHVyZSAmJiAoaS5ub3JtYWxNYXAgPSB0aGlzLm5vcm1hbE1hcC50b0pTT04odCkudXVpZCwgaS5ub3JtYWxNYXBUeXBlID0gdGhpcy5ub3JtYWxNYXBUeXBlLCBpLm5vcm1hbFNjYWxlID0gdGhpcy5ub3JtYWxTY2FsZS50b0FycmF5KCkpLCB0aGlzLmRpc3BsYWNlbWVudE1hcCAmJiB0aGlzLmRpc3BsYWNlbWVudE1hcC5pc1RleHR1cmUgJiYgKGkuZGlzcGxhY2VtZW50TWFwID0gdGhpcy5kaXNwbGFjZW1lbnRNYXAudG9KU09OKHQpLnV1aWQsIGkuZGlzcGxhY2VtZW50U2NhbGUgPSB0aGlzLmRpc3BsYWNlbWVudFNjYWxlLCBpLmRpc3BsYWNlbWVudEJpYXMgPSB0aGlzLmRpc3BsYWNlbWVudEJpYXMpLCB0aGlzLnJvdWdobmVzc01hcCAmJiB0aGlzLnJvdWdobmVzc01hcC5pc1RleHR1cmUgJiYgKGkucm91Z2huZXNzTWFwID0gdGhpcy5yb3VnaG5lc3NNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLm1ldGFsbmVzc01hcCAmJiB0aGlzLm1ldGFsbmVzc01hcC5pc1RleHR1cmUgJiYgKGkubWV0YWxuZXNzTWFwID0gdGhpcy5tZXRhbG5lc3NNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLmVtaXNzaXZlTWFwICYmIHRoaXMuZW1pc3NpdmVNYXAuaXNUZXh0dXJlICYmIChpLmVtaXNzaXZlTWFwID0gdGhpcy5lbWlzc2l2ZU1hcC50b0pTT04odCkudXVpZCksIHRoaXMuc3BlY3VsYXJNYXAgJiYgdGhpcy5zcGVjdWxhck1hcC5pc1RleHR1cmUgJiYgKGkuc3BlY3VsYXJNYXAgPSB0aGlzLnNwZWN1bGFyTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5zcGVjdWxhckludGVuc2l0eU1hcCAmJiB0aGlzLnNwZWN1bGFySW50ZW5zaXR5TWFwLmlzVGV4dHVyZSAmJiAoaS5zcGVjdWxhckludGVuc2l0eU1hcCA9IHRoaXMuc3BlY3VsYXJJbnRlbnNpdHlNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLnNwZWN1bGFyQ29sb3JNYXAgJiYgdGhpcy5zcGVjdWxhckNvbG9yTWFwLmlzVGV4dHVyZSAmJiAoaS5zcGVjdWxhckNvbG9yTWFwID0gdGhpcy5zcGVjdWxhckNvbG9yTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy5lbnZNYXAgJiYgdGhpcy5lbnZNYXAuaXNUZXh0dXJlICYmIChpLmVudk1hcCA9IHRoaXMuZW52TWFwLnRvSlNPTih0KS51dWlkLCB0aGlzLmNvbWJpbmUgIT09IHZvaWQgMCAmJiAoaS5jb21iaW5lID0gdGhpcy5jb21iaW5lKSksIHRoaXMuZW52TWFwUm90YXRpb24gIT09IHZvaWQgMCAmJiAoaS5lbnZNYXBSb3RhdGlvbiA9IHRoaXMuZW52TWFwUm90YXRpb24udG9BcnJheSgpKSwgdGhpcy5lbnZNYXBJbnRlbnNpdHkgIT09IHZvaWQgMCAmJiAoaS5lbnZNYXBJbnRlbnNpdHkgPSB0aGlzLmVudk1hcEludGVuc2l0eSksIHRoaXMucmVmbGVjdGl2aXR5ICE9PSB2b2lkIDAgJiYgKGkucmVmbGVjdGl2aXR5ID0gdGhpcy5yZWZsZWN0aXZpdHkpLCB0aGlzLnJlZnJhY3Rpb25SYXRpbyAhPT0gdm9pZCAwICYmIChpLnJlZnJhY3Rpb25SYXRpbyA9IHRoaXMucmVmcmFjdGlvblJhdGlvKSwgdGhpcy5ncmFkaWVudE1hcCAmJiB0aGlzLmdyYWRpZW50TWFwLmlzVGV4dHVyZSAmJiAoaS5ncmFkaWVudE1hcCA9IHRoaXMuZ3JhZGllbnRNYXAudG9KU09OKHQpLnV1aWQpLCB0aGlzLnRyYW5zbWlzc2lvbiAhPT0gdm9pZCAwICYmIChpLnRyYW5zbWlzc2lvbiA9IHRoaXMudHJhbnNtaXNzaW9uKSwgdGhpcy50cmFuc21pc3Npb25NYXAgJiYgdGhpcy50cmFuc21pc3Npb25NYXAuaXNUZXh0dXJlICYmIChpLnRyYW5zbWlzc2lvbk1hcCA9IHRoaXMudHJhbnNtaXNzaW9uTWFwLnRvSlNPTih0KS51dWlkKSwgdGhpcy50aGlja25lc3MgIT09IHZvaWQgMCAmJiAoaS50aGlja25lc3MgPSB0aGlzLnRoaWNrbmVzcyksIHRoaXMudGhpY2tuZXNzTWFwICYmIHRoaXMudGhpY2tuZXNzTWFwLmlzVGV4dHVyZSAmJiAoaS50aGlja25lc3NNYXAgPSB0aGlzLnRoaWNrbmVzc01hcC50b0pTT04odCkudXVpZCksIHRoaXMuYXR0ZW51YXRpb25EaXN0YW5jZSAhPT0gdm9pZCAwICYmIHRoaXMuYXR0ZW51YXRpb25EaXN0YW5jZSAhPT0gMSAvIDAgJiYgKGkuYXR0ZW51YXRpb25EaXN0YW5jZSA9IHRoaXMuYXR0ZW51YXRpb25EaXN0YW5jZSksIHRoaXMuYXR0ZW51YXRpb25Db2xvciAhPT0gdm9pZCAwICYmIChpLmF0dGVudWF0aW9uQ29sb3IgPSB0aGlzLmF0dGVudWF0aW9uQ29sb3IuZ2V0SGV4KCkpLCB0aGlzLnNpemUgIT09IHZvaWQgMCAmJiAoaS5zaXplID0gdGhpcy5zaXplKSwgdGhpcy5zaGFkb3dTaWRlICE9PSBudWxsICYmIChpLnNoYWRvd1NpZGUgPSB0aGlzLnNoYWRvd1NpZGUpLCB0aGlzLnNpemVBdHRlbnVhdGlvbiAhPT0gdm9pZCAwICYmIChpLnNpemVBdHRlbnVhdGlvbiA9IHRoaXMuc2l6ZUF0dGVudWF0aW9uKSwgdGhpcy5ibGVuZGluZyAhPT0gYmcgJiYgKGkuYmxlbmRpbmcgPSB0aGlzLmJsZW5kaW5nKSwgdGhpcy5zaWRlICE9PSBCbyAmJiAoaS5zaWRlID0gdGhpcy5zaWRlKSwgdGhpcy52ZXJ0ZXhDb2xvcnMgPT09ICEwICYmIChpLnZlcnRleENvbG9ycyA9ICEwKSwgdGhpcy5vcGFjaXR5IDwgMSAmJiAoaS5vcGFjaXR5ID0gdGhpcy5vcGFjaXR5KSwgdGhpcy50cmFuc3BhcmVudCA9PT0gITAgJiYgKGkudHJhbnNwYXJlbnQgPSAhMCksIHRoaXMuYmxlbmRTcmMgIT09IFNnICYmIChpLmJsZW5kU3JjID0gdGhpcy5ibGVuZFNyYyksIHRoaXMuYmxlbmREc3QgIT09IHdnICYmIChpLmJsZW5kRHN0ID0gdGhpcy5ibGVuZERzdCksIHRoaXMuYmxlbmRFcXVhdGlvbiAhPT0gTWcgJiYgKGkuYmxlbmRFcXVhdGlvbiA9IHRoaXMuYmxlbmRFcXVhdGlvbiksIHRoaXMuYmxlbmRTcmNBbHBoYSAhPT0gbnVsbCAmJiAoaS5ibGVuZFNyY0FscGhhID0gdGhpcy5ibGVuZFNyY0FscGhhKSwgdGhpcy5ibGVuZERzdEFscGhhICE9PSBudWxsICYmIChpLmJsZW5kRHN0QWxwaGEgPSB0aGlzLmJsZW5kRHN0QWxwaGEpLCB0aGlzLmJsZW5kRXF1YXRpb25BbHBoYSAhPT0gbnVsbCAmJiAoaS5ibGVuZEVxdWF0aW9uQWxwaGEgPSB0aGlzLmJsZW5kRXF1YXRpb25BbHBoYSksIHRoaXMuYmxlbmRDb2xvciAmJiB0aGlzLmJsZW5kQ29sb3IuaXNDb2xvciAmJiAoaS5ibGVuZENvbG9yID0gdGhpcy5ibGVuZENvbG9yLmdldEhleCgpKSwgdGhpcy5ibGVuZEFscGhhICE9PSAwICYmIChpLmJsZW5kQWxwaGEgPSB0aGlzLmJsZW5kQWxwaGEpLCB0aGlzLmRlcHRoRnVuYyAhPT0gQWcgJiYgKGkuZGVwdGhGdW5jID0gdGhpcy5kZXB0aEZ1bmMpLCB0aGlzLmRlcHRoVGVzdCA9PT0gITEgJiYgKGkuZGVwdGhUZXN0ID0gdGhpcy5kZXB0aFRlc3QpLCB0aGlzLmRlcHRoV3JpdGUgPT09ICExICYmIChpLmRlcHRoV3JpdGUgPSB0aGlzLmRlcHRoV3JpdGUpLCB0aGlzLmNvbG9yV3JpdGUgPT09ICExICYmIChpLmNvbG9yV3JpdGUgPSB0aGlzLmNvbG9yV3JpdGUpLCB0aGlzLnN0ZW5jaWxXcml0ZU1hc2sgIT09IDI1NSAmJiAoaS5zdGVuY2lsV3JpdGVNYXNrID0gdGhpcy5zdGVuY2lsV3JpdGVNYXNrKSwgdGhpcy5zdGVuY2lsRnVuYyAhPT0gU2MgJiYgKGkuc3RlbmNpbEZ1bmMgPSB0aGlzLnN0ZW5jaWxGdW5jKSwgdGhpcy5zdGVuY2lsUmVmICE9PSAwICYmIChpLnN0ZW5jaWxSZWYgPSB0aGlzLnN0ZW5jaWxSZWYpLCB0aGlzLnN0ZW5jaWxGdW5jTWFzayAhPT0gMjU1ICYmIChpLnN0ZW5jaWxGdW5jTWFzayA9IHRoaXMuc3RlbmNpbEZ1bmNNYXNrKSwgdGhpcy5zdGVuY2lsRmFpbCAhPT0gVnIgJiYgKGkuc3RlbmNpbEZhaWwgPSB0aGlzLnN0ZW5jaWxGYWlsKSwgdGhpcy5zdGVuY2lsWkZhaWwgIT09IFZyICYmIChpLnN0ZW5jaWxaRmFpbCA9IHRoaXMuc3RlbmNpbFpGYWlsKSwgdGhpcy5zdGVuY2lsWlBhc3MgIT09IFZyICYmIChpLnN0ZW5jaWxaUGFzcyA9IHRoaXMuc3RlbmNpbFpQYXNzKSwgdGhpcy5zdGVuY2lsV3JpdGUgPT09ICEwICYmIChpLnN0ZW5jaWxXcml0ZSA9IHRoaXMuc3RlbmNpbFdyaXRlKSwgdGhpcy5yb3RhdGlvbiAhPT0gdm9pZCAwICYmIHRoaXMucm90YXRpb24gIT09IDAgJiYgKGkucm90YXRpb24gPSB0aGlzLnJvdGF0aW9uKSwgdGhpcy5wb2x5Z29uT2Zmc2V0ID09PSAhMCAmJiAoaS5wb2x5Z29uT2Zmc2V0ID0gITApLCB0aGlzLnBvbHlnb25PZmZzZXRGYWN0b3IgIT09IDAgJiYgKGkucG9seWdvbk9mZnNldEZhY3RvciA9IHRoaXMucG9seWdvbk9mZnNldEZhY3RvciksIHRoaXMucG9seWdvbk9mZnNldFVuaXRzICE9PSAwICYmIChpLnBvbHlnb25PZmZzZXRVbml0cyA9IHRoaXMucG9seWdvbk9mZnNldFVuaXRzKSwgdGhpcy5saW5ld2lkdGggIT09IHZvaWQgMCAmJiB0aGlzLmxpbmV3aWR0aCAhPT0gMSAmJiAoaS5saW5ld2lkdGggPSB0aGlzLmxpbmV3aWR0aCksIHRoaXMuZGFzaFNpemUgIT09IHZvaWQgMCAmJiAoaS5kYXNoU2l6ZSA9IHRoaXMuZGFzaFNpemUpLCB0aGlzLmdhcFNpemUgIT09IHZvaWQgMCAmJiAoaS5nYXBTaXplID0gdGhpcy5nYXBTaXplKSwgdGhpcy5zY2FsZSAhPT0gdm9pZCAwICYmIChpLnNjYWxlID0gdGhpcy5zY2FsZSksIHRoaXMuZGl0aGVyaW5nID09PSAhMCAmJiAoaS5kaXRoZXJpbmcgPSAhMCksIHRoaXMuYWxwaGFUZXN0ID4gMCAmJiAoaS5hbHBoYVRlc3QgPSB0aGlzLmFscGhhVGVzdCksIHRoaXMuYWxwaGFIYXNoID09PSAhMCAmJiAoaS5hbHBoYUhhc2ggPSAhMCksIHRoaXMuYWxwaGFUb0NvdmVyYWdlID09PSAhMCAmJiAoaS5hbHBoYVRvQ292ZXJhZ2UgPSAhMCksIHRoaXMucHJlbXVsdGlwbGllZEFscGhhID09PSAhMCAmJiAoaS5wcmVtdWx0aXBsaWVkQWxwaGEgPSAhMCksIHRoaXMuZm9yY2VTaW5nbGVQYXNzID09PSAhMCAmJiAoaS5mb3JjZVNpbmdsZVBhc3MgPSAhMCksIHRoaXMud2lyZWZyYW1lID09PSAhMCAmJiAoaS53aXJlZnJhbWUgPSAhMCksIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID4gMSAmJiAoaS53aXJlZnJhbWVMaW5ld2lkdGggPSB0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCksIHRoaXMud2lyZWZyYW1lTGluZWNhcCAhPT0gInJvdW5kIiAmJiAoaS53aXJlZnJhbWVMaW5lY2FwID0gdGhpcy53aXJlZnJhbWVMaW5lY2FwKSwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiAhPT0gInJvdW5kIiAmJiAoaS53aXJlZnJhbWVMaW5lam9pbiA9IHRoaXMud2lyZWZyYW1lTGluZWpvaW4pLCB0aGlzLmZsYXRTaGFkaW5nID09PSAhMCAmJiAoaS5mbGF0U2hhZGluZyA9ICEwKSwgdGhpcy52aXNpYmxlID09PSAhMSAmJiAoaS52aXNpYmxlID0gITEpLCB0aGlzLnRvbmVNYXBwZWQgPT09ICExICYmIChpLnRvbmVNYXBwZWQgPSAhMSksIHRoaXMuZm9nID09PSAhMSAmJiAoaS5mb2cgPSAhMSksIE9iamVjdC5rZXlzKHRoaXMudXNlckRhdGEpLmxlbmd0aCA+IDAgJiYgKGkudXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhKTsKICAgIGZ1bmN0aW9uIG4ocykgewogICAgICBjb25zdCByID0gW107CiAgICAgIGZvciAoY29uc3QgbyBpbiBzKSB7CiAgICAgICAgY29uc3QgbCA9IHNbb107CiAgICAgICAgZGVsZXRlIGwubWV0YWRhdGEsIHIucHVzaChsKTsKICAgICAgfQogICAgICByZXR1cm4gcjsKICAgIH0KICAgIGlmIChlKSB7CiAgICAgIGNvbnN0IHMgPSBuKHQudGV4dHVyZXMpLCByID0gbih0LmltYWdlcyk7CiAgICAgIHMubGVuZ3RoID4gMCAmJiAoaS50ZXh0dXJlcyA9IHMpLCByLmxlbmd0aCA+IDAgJiYgKGkuaW1hZ2VzID0gcik7CiAgICB9CiAgICByZXR1cm4gaTsKICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KHRoaXMpOwogIH0KICBjb3B5KHQpIHsKICAgIHRoaXMubmFtZSA9IHQubmFtZSwgdGhpcy5ibGVuZGluZyA9IHQuYmxlbmRpbmcsIHRoaXMuc2lkZSA9IHQuc2lkZSwgdGhpcy52ZXJ0ZXhDb2xvcnMgPSB0LnZlcnRleENvbG9ycywgdGhpcy5vcGFjaXR5ID0gdC5vcGFjaXR5LCB0aGlzLnRyYW5zcGFyZW50ID0gdC50cmFuc3BhcmVudCwgdGhpcy5ibGVuZFNyYyA9IHQuYmxlbmRTcmMsIHRoaXMuYmxlbmREc3QgPSB0LmJsZW5kRHN0LCB0aGlzLmJsZW5kRXF1YXRpb24gPSB0LmJsZW5kRXF1YXRpb24sIHRoaXMuYmxlbmRTcmNBbHBoYSA9IHQuYmxlbmRTcmNBbHBoYSwgdGhpcy5ibGVuZERzdEFscGhhID0gdC5ibGVuZERzdEFscGhhLCB0aGlzLmJsZW5kRXF1YXRpb25BbHBoYSA9IHQuYmxlbmRFcXVhdGlvbkFscGhhLCB0aGlzLmJsZW5kQ29sb3IuY29weSh0LmJsZW5kQ29sb3IpLCB0aGlzLmJsZW5kQWxwaGEgPSB0LmJsZW5kQWxwaGEsIHRoaXMuZGVwdGhGdW5jID0gdC5kZXB0aEZ1bmMsIHRoaXMuZGVwdGhUZXN0ID0gdC5kZXB0aFRlc3QsIHRoaXMuZGVwdGhXcml0ZSA9IHQuZGVwdGhXcml0ZSwgdGhpcy5zdGVuY2lsV3JpdGVNYXNrID0gdC5zdGVuY2lsV3JpdGVNYXNrLCB0aGlzLnN0ZW5jaWxGdW5jID0gdC5zdGVuY2lsRnVuYywgdGhpcy5zdGVuY2lsUmVmID0gdC5zdGVuY2lsUmVmLCB0aGlzLnN0ZW5jaWxGdW5jTWFzayA9IHQuc3RlbmNpbEZ1bmNNYXNrLCB0aGlzLnN0ZW5jaWxGYWlsID0gdC5zdGVuY2lsRmFpbCwgdGhpcy5zdGVuY2lsWkZhaWwgPSB0LnN0ZW5jaWxaRmFpbCwgdGhpcy5zdGVuY2lsWlBhc3MgPSB0LnN0ZW5jaWxaUGFzcywgdGhpcy5zdGVuY2lsV3JpdGUgPSB0LnN0ZW5jaWxXcml0ZTsKICAgIGNvbnN0IGUgPSB0LmNsaXBwaW5nUGxhbmVzOwogICAgbGV0IGkgPSBudWxsOwogICAgaWYgKGUgIT09IG51bGwpIHsKICAgICAgY29uc3QgbiA9IGUubGVuZ3RoOwogICAgICBpID0gbmV3IEFycmF5KG4pOwogICAgICBmb3IgKGxldCBzID0gMDsgcyAhPT0gbjsgKytzKQogICAgICAgIGlbc10gPSBlW3NdLmNsb25lKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jbGlwcGluZ1BsYW5lcyA9IGksIHRoaXMuY2xpcEludGVyc2VjdGlvbiA9IHQuY2xpcEludGVyc2VjdGlvbiwgdGhpcy5jbGlwU2hhZG93cyA9IHQuY2xpcFNoYWRvd3MsIHRoaXMuc2hhZG93U2lkZSA9IHQuc2hhZG93U2lkZSwgdGhpcy5jb2xvcldyaXRlID0gdC5jb2xvcldyaXRlLCB0aGlzLnByZWNpc2lvbiA9IHQucHJlY2lzaW9uLCB0aGlzLnBvbHlnb25PZmZzZXQgPSB0LnBvbHlnb25PZmZzZXQsIHRoaXMucG9seWdvbk9mZnNldEZhY3RvciA9IHQucG9seWdvbk9mZnNldEZhY3RvciwgdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMgPSB0LnBvbHlnb25PZmZzZXRVbml0cywgdGhpcy5kaXRoZXJpbmcgPSB0LmRpdGhlcmluZywgdGhpcy5hbHBoYVRlc3QgPSB0LmFscGhhVGVzdCwgdGhpcy5hbHBoYUhhc2ggPSB0LmFscGhhSGFzaCwgdGhpcy5hbHBoYVRvQ292ZXJhZ2UgPSB0LmFscGhhVG9Db3ZlcmFnZSwgdGhpcy5wcmVtdWx0aXBsaWVkQWxwaGEgPSB0LnByZW11bHRpcGxpZWRBbHBoYSwgdGhpcy5mb3JjZVNpbmdsZVBhc3MgPSB0LmZvcmNlU2luZ2xlUGFzcywgdGhpcy52aXNpYmxlID0gdC52aXNpYmxlLCB0aGlzLnRvbmVNYXBwZWQgPSB0LnRvbmVNYXBwZWQsIHRoaXMudXNlckRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHQudXNlckRhdGEpKSwgdGhpczsKICB9CiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZGlzcGF0Y2hFdmVudCh7IHR5cGU6ICJkaXNwb3NlIiB9KTsKICB9CiAgc2V0IG5lZWRzVXBkYXRlKHQpIHsKICAgIHQgPT09ICEwICYmIHRoaXMudmVyc2lvbisrOwogIH0KICBvbkJ1aWxkKCkgewogICAgY29uc29sZS53YXJuKCJNYXRlcmlhbDogb25CdWlsZCgpIGhhcyBiZWVuIHJlbW92ZWQuIik7CiAgfQp9CmNsYXNzIHB1IGV4dGVuZHMgeGYgewogIHN0YXRpYyBnZXQgdHlwZSgpIHsKICAgIHJldHVybiAiTWVzaEJhc2ljTWF0ZXJpYWwiOwogIH0KICBjb25zdHJ1Y3Rvcih0KSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTWVzaEJhc2ljTWF0ZXJpYWwgPSAhMCwgdGhpcy5jb2xvciA9IG5ldyBBaSgxNjc3NzIxNSksIHRoaXMubWFwID0gbnVsbCwgdGhpcy5saWdodE1hcCA9IG51bGwsIHRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSAxLCB0aGlzLmFvTWFwID0gbnVsbCwgdGhpcy5hb01hcEludGVuc2l0eSA9IDEsIHRoaXMuc3BlY3VsYXJNYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5lbnZNYXAgPSBudWxsLCB0aGlzLmVudk1hcFJvdGF0aW9uID0gbmV3IGR1KCksIHRoaXMuY29tYmluZSA9IHVULCB0aGlzLnJlZmxlY3Rpdml0eSA9IDEsIHRoaXMucmVmcmFjdGlvblJhdGlvID0gMC45OCwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAicm91bmQiLCB0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gInJvdW5kIiwgdGhpcy5mb2cgPSAhMCwgdGhpcy5zZXRWYWx1ZXModCk7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMuY29sb3IuY29weSh0LmNvbG9yKSwgdGhpcy5tYXAgPSB0Lm1hcCwgdGhpcy5saWdodE1hcCA9IHQubGlnaHRNYXAsIHRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSB0LmxpZ2h0TWFwSW50ZW5zaXR5LCB0aGlzLmFvTWFwID0gdC5hb01hcCwgdGhpcy5hb01hcEludGVuc2l0eSA9IHQuYW9NYXBJbnRlbnNpdHksIHRoaXMuc3BlY3VsYXJNYXAgPSB0LnNwZWN1bGFyTWFwLCB0aGlzLmFscGhhTWFwID0gdC5hbHBoYU1hcCwgdGhpcy5lbnZNYXAgPSB0LmVudk1hcCwgdGhpcy5lbnZNYXBSb3RhdGlvbi5jb3B5KHQuZW52TWFwUm90YXRpb24pLCB0aGlzLmNvbWJpbmUgPSB0LmNvbWJpbmUsIHRoaXMucmVmbGVjdGl2aXR5ID0gdC5yZWZsZWN0aXZpdHksIHRoaXMucmVmcmFjdGlvblJhdGlvID0gdC5yZWZyYWN0aW9uUmF0aW8sIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHQud2lyZWZyYW1lTGluZWNhcCwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHQud2lyZWZyYW1lTGluZWpvaW4sIHRoaXMuZm9nID0gdC5mb2csIHRoaXM7CiAgfQp9CmNvbnN0IExlID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBzaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgX2koKTsKY2xhc3MgcWkgewogIGNvbnN0cnVjdG9yKHQsIGUsIGkgPSAhMSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkodCkpCiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRIUkVFLkJ1ZmZlckF0dHJpYnV0ZTogYXJyYXkgc2hvdWxkIGJlIGEgVHlwZWQgQXJyYXkuIik7CiAgICB0aGlzLmlzQnVmZmVyQXR0cmlidXRlID0gITAsIHRoaXMubmFtZSA9ICIiLCB0aGlzLmFycmF5ID0gdCwgdGhpcy5pdGVtU2l6ZSA9IGUsIHRoaXMuY291bnQgPSB0ICE9PSB2b2lkIDAgPyB0Lmxlbmd0aCAvIGUgOiAwLCB0aGlzLm5vcm1hbGl6ZWQgPSBpLCB0aGlzLnVzYWdlID0geHAsIHRoaXMudXBkYXRlUmFuZ2VzID0gW10sIHRoaXMuZ3B1VHlwZSA9IG1ULCB0aGlzLnZlcnNpb24gPSAwOwogIH0KICBvblVwbG9hZENhbGxiYWNrKCkgewogIH0KICBzZXQgbmVlZHNVcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgdGhpcy52ZXJzaW9uKys7CiAgfQogIHNldFVzYWdlKHQpIHsKICAgIHJldHVybiB0aGlzLnVzYWdlID0gdCwgdGhpczsKICB9CiAgYWRkVXBkYXRlUmFuZ2UodCwgZSkgewogICAgdGhpcy51cGRhdGVSYW5nZXMucHVzaCh7IHN0YXJ0OiB0LCBjb3VudDogZSB9KTsKICB9CiAgY2xlYXJVcGRhdGVSYW5nZXMoKSB7CiAgICB0aGlzLnVwZGF0ZVJhbmdlcy5sZW5ndGggPSAwOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLm5hbWUgPSB0Lm5hbWUsIHRoaXMuYXJyYXkgPSBuZXcgdC5hcnJheS5jb25zdHJ1Y3Rvcih0LmFycmF5KSwgdGhpcy5pdGVtU2l6ZSA9IHQuaXRlbVNpemUsIHRoaXMuY291bnQgPSB0LmNvdW50LCB0aGlzLm5vcm1hbGl6ZWQgPSB0Lm5vcm1hbGl6ZWQsIHRoaXMudXNhZ2UgPSB0LnVzYWdlLCB0aGlzLmdwdVR5cGUgPSB0LmdwdVR5cGUsIHRoaXM7CiAgfQogIGNvcHlBdCh0LCBlLCBpKSB7CiAgICB0ICo9IHRoaXMuaXRlbVNpemUsIGkgKj0gZS5pdGVtU2l6ZTsKICAgIGZvciAobGV0IG4gPSAwLCBzID0gdGhpcy5pdGVtU2l6ZTsgbiA8IHM7IG4rKykKICAgICAgdGhpcy5hcnJheVt0ICsgbl0gPSBlLmFycmF5W2kgKyBuXTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjb3B5QXJyYXkodCkgewogICAgcmV0dXJuIHRoaXMuYXJyYXkuc2V0KHQpLCB0aGlzOwogIH0KICBhcHBseU1hdHJpeDModCkgewogICAgaWYgKHRoaXMuaXRlbVNpemUgPT09IDIpCiAgICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgICBzaC5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCBzaC5hcHBseU1hdHJpeDModCksIHRoaXMuc2V0WFkoZSwgc2gueCwgc2gueSk7CiAgICBlbHNlIGlmICh0aGlzLml0ZW1TaXplID09PSAzKQogICAgICBmb3IgKGxldCBlID0gMCwgaSA9IHRoaXMuY291bnQ7IGUgPCBpOyBlKyspCiAgICAgICAgTGUuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0aGlzLCBlKSwgTGUuYXBwbHlNYXRyaXgzKHQpLCB0aGlzLnNldFhZWihlLCBMZS54LCBMZS55LCBMZS56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBhcHBseU1hdHJpeDQodCkgewogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0aGlzLmNvdW50OyBlIDwgaTsgZSsrKQogICAgICBMZS5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCBMZS5hcHBseU1hdHJpeDQodCksIHRoaXMuc2V0WFlaKGUsIExlLngsIExlLnksIExlLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5Tm9ybWFsTWF0cml4KHQpIHsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgTGUuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0aGlzLCBlKSwgTGUuYXBwbHlOb3JtYWxNYXRyaXgodCksIHRoaXMuc2V0WFlaKGUsIExlLngsIExlLnksIExlLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRyYW5zZm9ybURpcmVjdGlvbih0KSB7CiAgICBmb3IgKGxldCBlID0gMCwgaSA9IHRoaXMuY291bnQ7IGUgPCBpOyBlKyspCiAgICAgIExlLmZyb21CdWZmZXJBdHRyaWJ1dGUodGhpcywgZSksIExlLnRyYW5zZm9ybURpcmVjdGlvbih0KSwgdGhpcy5zZXRYWVooZSwgTGUueCwgTGUueSwgTGUueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0KHQsIGUgPSAwKSB7CiAgICByZXR1cm4gdGhpcy5hcnJheS5zZXQodCwgZSksIHRoaXM7CiAgfQogIGdldENvbXBvbmVudCh0LCBlKSB7CiAgICBsZXQgaSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyBlXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGkgPSBobihpLCB0aGlzLmFycmF5KSksIGk7CiAgfQogIHNldENvbXBvbmVudCh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChpID0gdWUoaSwgdGhpcy5hcnJheSkpLCB0aGlzLmFycmF5W3QgKiB0aGlzLml0ZW1TaXplICsgZV0gPSBpLCB0aGlzOwogIH0KICBnZXRYKHQpIHsKICAgIGxldCBlID0gdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZV07CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gaG4oZSwgdGhpcy5hcnJheSkpLCBlOwogIH0KICBzZXRYKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemVdID0gZSwgdGhpczsKICB9CiAgZ2V0WSh0KSB7CiAgICBsZXQgZSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAxXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBobihlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIHNldFkodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IHVlKGUsIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZSArIDFdID0gZSwgdGhpczsKICB9CiAgZ2V0Wih0KSB7CiAgICBsZXQgZSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAyXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBobihlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIHNldFoodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IHVlKGUsIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZSArIDJdID0gZSwgdGhpczsKICB9CiAgZ2V0Vyh0KSB7CiAgICBsZXQgZSA9IHRoaXMuYXJyYXlbdCAqIHRoaXMuaXRlbVNpemUgKyAzXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBobihlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIHNldFcodCwgZSkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IHVlKGUsIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICogdGhpcy5pdGVtU2l6ZSArIDNdID0gZSwgdGhpczsKICB9CiAgc2V0WFkodCwgZSwgaSkgewogICAgcmV0dXJuIHQgKj0gdGhpcy5pdGVtU2l6ZSwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gdWUoZSwgdGhpcy5hcnJheSksIGkgPSB1ZShpLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5hcnJheVt0ICsgMV0gPSBpLCB0aGlzOwogIH0KICBzZXRYWVoodCwgZSwgaSwgbikgewogICAgcmV0dXJuIHQgKj0gdGhpcy5pdGVtU2l6ZSwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gdWUoZSwgdGhpcy5hcnJheSksIGkgPSB1ZShpLCB0aGlzLmFycmF5KSwgbiA9IHVlKG4sIHRoaXMuYXJyYXkpKSwgdGhpcy5hcnJheVt0ICsgMF0gPSBlLCB0aGlzLmFycmF5W3QgKyAxXSA9IGksIHRoaXMuYXJyYXlbdCArIDJdID0gbiwgdGhpczsKICB9CiAgc2V0WFlaVyh0LCBlLCBpLCBuLCBzKSB7CiAgICByZXR1cm4gdCAqPSB0aGlzLml0ZW1TaXplLCB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSwgaSA9IHVlKGksIHRoaXMuYXJyYXkpLCBuID0gdWUobiwgdGhpcy5hcnJheSksIHMgPSB1ZShzLCB0aGlzLmFycmF5KSksIHRoaXMuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5hcnJheVt0ICsgMV0gPSBpLCB0aGlzLmFycmF5W3QgKyAyXSA9IG4sIHRoaXMuYXJyYXlbdCArIDNdID0gcywgdGhpczsKICB9CiAgb25VcGxvYWQodCkgewogICAgcmV0dXJuIHRoaXMub25VcGxvYWRDYWxsYmFjayA9IHQsIHRoaXM7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXJyYXksIHRoaXMuaXRlbVNpemUpLmNvcHkodGhpcyk7CiAgfQogIHRvSlNPTigpIHsKICAgIGNvbnN0IHQgPSB7CiAgICAgIGl0ZW1TaXplOiB0aGlzLml0ZW1TaXplLAogICAgICB0eXBlOiB0aGlzLmFycmF5LmNvbnN0cnVjdG9yLm5hbWUsCiAgICAgIGFycmF5OiBBcnJheS5mcm9tKHRoaXMuYXJyYXkpLAogICAgICBub3JtYWxpemVkOiB0aGlzLm5vcm1hbGl6ZWQKICAgIH07CiAgICByZXR1cm4gdGhpcy5uYW1lICE9PSAiIiAmJiAodC5uYW1lID0gdGhpcy5uYW1lKSwgdGhpcy51c2FnZSAhPT0geHAgJiYgKHQudXNhZ2UgPSB0aGlzLnVzYWdlKSwgdDsKICB9Cn0KY2xhc3MgalQgZXh0ZW5kcyBxaSB7CiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IFVpbnQxNkFycmF5KHQpLCBlLCBpKTsKICB9Cn0KY2xhc3MgSlQgZXh0ZW5kcyBxaSB7CiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IFVpbnQzMkFycmF5KHQpLCBlLCBpKTsKICB9Cn0KY2xhc3Mgd2MgZXh0ZW5kcyBxaSB7CiAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgc3VwZXIobmV3IEZsb2F0MzJBcnJheSh0KSwgZSwgaSk7CiAgfQp9CmxldCBLVCA9IDA7CmNvbnN0IEdpID0gLyogQF9fUFVSRV9fICovIG5ldyBRbigpLCBGZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGEoKSwgSnIgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIEZpID0gLyogQF9fUFVSRV9fICovIG5ldyBVcygpLCBlbyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVXMoKSwga2UgPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCk7CmNsYXNzIEZhIGV4dGVuZHMgY3UgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0J1ZmZlckdlb21ldHJ5ID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiBLVCsrIH0pLCB0aGlzLnV1aWQgPSBKbigpLCB0aGlzLm5hbWUgPSAiIiwgdGhpcy50eXBlID0gIkJ1ZmZlckdlb21ldHJ5IiwgdGhpcy5pbmRleCA9IG51bGwsIHRoaXMuaW5kaXJlY3QgPSBudWxsLCB0aGlzLmF0dHJpYnV0ZXMgPSB7fSwgdGhpcy5tb3JwaEF0dHJpYnV0ZXMgPSB7fSwgdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9ICExLCB0aGlzLmdyb3VwcyA9IFtdLCB0aGlzLmJvdW5kaW5nQm94ID0gbnVsbCwgdGhpcy5ib3VuZGluZ1NwaGVyZSA9IG51bGwsIHRoaXMuZHJhd1JhbmdlID0geyBzdGFydDogMCwgY291bnQ6IDEgLyAwIH0sIHRoaXMudXNlckRhdGEgPSB7fTsKICB9CiAgZ2V0SW5kZXgoKSB7CiAgICByZXR1cm4gdGhpcy5pbmRleDsKICB9CiAgc2V0SW5kZXgodCkgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodCkgPyB0aGlzLmluZGV4ID0gbmV3IChVVCh0KSA/IEpUIDogalQpKHQsIDEpIDogdGhpcy5pbmRleCA9IHQsIHRoaXM7CiAgfQogIHNldEluZGlyZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLmluZGlyZWN0ID0gdCwgdGhpczsKICB9CiAgZ2V0SW5kaXJlY3QoKSB7CiAgICByZXR1cm4gdGhpcy5pbmRpcmVjdDsKICB9CiAgZ2V0QXR0cmlidXRlKHQpIHsKICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbdF07CiAgfQogIHNldEF0dHJpYnV0ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW3RdID0gZSwgdGhpczsKICB9CiAgZGVsZXRlQXR0cmlidXRlKHQpIHsKICAgIHJldHVybiBkZWxldGUgdGhpcy5hdHRyaWJ1dGVzW3RdLCB0aGlzOwogIH0KICBoYXNBdHRyaWJ1dGUodCkgewogICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1t0XSAhPT0gdm9pZCAwOwogIH0KICBhZGRHcm91cCh0LCBlLCBpID0gMCkgewogICAgdGhpcy5ncm91cHMucHVzaCh7CiAgICAgIHN0YXJ0OiB0LAogICAgICBjb3VudDogZSwKICAgICAgbWF0ZXJpYWxJbmRleDogaQogICAgfSk7CiAgfQogIGNsZWFyR3JvdXBzKCkgewogICAgdGhpcy5ncm91cHMgPSBbXTsKICB9CiAgc2V0RHJhd1JhbmdlKHQsIGUpIHsKICAgIHRoaXMuZHJhd1JhbmdlLnN0YXJ0ID0gdCwgdGhpcy5kcmF3UmFuZ2UuY291bnQgPSBlOwogIH0KICBhcHBseU1hdHJpeDQodCkgewogICAgY29uc3QgZSA9IHRoaXMuYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgIGUgIT09IHZvaWQgMCAmJiAoZS5hcHBseU1hdHJpeDQodCksIGUubmVlZHNVcGRhdGUgPSAhMCk7CiAgICBjb25zdCBpID0gdGhpcy5hdHRyaWJ1dGVzLm5vcm1hbDsKICAgIGlmIChpICE9PSB2b2lkIDApIHsKICAgICAgY29uc3QgcyA9IG5ldyBkZSgpLmdldE5vcm1hbE1hdHJpeCh0KTsKICAgICAgaS5hcHBseU5vcm1hbE1hdHJpeChzKSwgaS5uZWVkc1VwZGF0ZSA9ICEwOwogICAgfQogICAgY29uc3QgbiA9IHRoaXMuYXR0cmlidXRlcy50YW5nZW50OwogICAgcmV0dXJuIG4gIT09IHZvaWQgMCAmJiAobi50cmFuc2Zvcm1EaXJlY3Rpb24odCksIG4ubmVlZHNVcGRhdGUgPSAhMCksIHRoaXMuYm91bmRpbmdCb3ggIT09IG51bGwgJiYgdGhpcy5jb21wdXRlQm91bmRpbmdCb3goKSwgdGhpcy5ib3VuZGluZ1NwaGVyZSAhPT0gbnVsbCAmJiB0aGlzLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCB0aGlzOwogIH0KICBhcHBseVF1YXRlcm5pb24odCkgewogICAgcmV0dXJuIEdpLm1ha2VSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKHQpLCB0aGlzLmFwcGx5TWF0cml4NChHaSksIHRoaXM7CiAgfQogIHJvdGF0ZVgodCkgewogICAgcmV0dXJuIEdpLm1ha2VSb3RhdGlvblgodCksIHRoaXMuYXBwbHlNYXRyaXg0KEdpKSwgdGhpczsKICB9CiAgcm90YXRlWSh0KSB7CiAgICByZXR1cm4gR2kubWFrZVJvdGF0aW9uWSh0KSwgdGhpcy5hcHBseU1hdHJpeDQoR2kpLCB0aGlzOwogIH0KICByb3RhdGVaKHQpIHsKICAgIHJldHVybiBHaS5tYWtlUm90YXRpb25aKHQpLCB0aGlzLmFwcGx5TWF0cml4NChHaSksIHRoaXM7CiAgfQogIHRyYW5zbGF0ZSh0LCBlLCBpKSB7CiAgICByZXR1cm4gR2kubWFrZVRyYW5zbGF0aW9uKHQsIGUsIGkpLCB0aGlzLmFwcGx5TWF0cml4NChHaSksIHRoaXM7CiAgfQogIHNjYWxlKHQsIGUsIGkpIHsKICAgIHJldHVybiBHaS5tYWtlU2NhbGUodCwgZSwgaSksIHRoaXMuYXBwbHlNYXRyaXg0KEdpKSwgdGhpczsKICB9CiAgbG9va0F0KHQpIHsKICAgIHJldHVybiBGZC5sb29rQXQodCksIEZkLnVwZGF0ZU1hdHJpeCgpLCB0aGlzLmFwcGx5TWF0cml4NChGZC5tYXRyaXgpLCB0aGlzOwogIH0KICBjZW50ZXIoKSB7CiAgICByZXR1cm4gdGhpcy5jb21wdXRlQm91bmRpbmdCb3goKSwgdGhpcy5ib3VuZGluZ0JveC5nZXRDZW50ZXIoSnIpLm5lZ2F0ZSgpLCB0aGlzLnRyYW5zbGF0ZShKci54LCBKci55LCBKci56KSwgdGhpczsKICB9CiAgc2V0RnJvbVBvaW50cyh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoInBvc2l0aW9uIik7CiAgICBpZiAoZSA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGkgPSBbXTsKICAgICAgZm9yIChsZXQgbiA9IDAsIHMgPSB0Lmxlbmd0aDsgbiA8IHM7IG4rKykgewogICAgICAgIGNvbnN0IHIgPSB0W25dOwogICAgICAgIGkucHVzaChyLngsIHIueSwgci56IHx8IDApOwogICAgICB9CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3YyhpLCAzKSk7CiAgICB9IGVsc2UgewogICAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUuY291bnQ7IGkgPCBuOyBpKyspIHsKICAgICAgICBjb25zdCBzID0gdFtpXTsKICAgICAgICBlLnNldFhZWihpLCBzLngsIHMueSwgcy56IHx8IDApOwogICAgICB9CiAgICAgIHQubGVuZ3RoID4gZS5jb3VudCAmJiBjb25zb2xlLndhcm4oIlRIUkVFLkJ1ZmZlckdlb21ldHJ5OiBCdWZmZXIgc2l6ZSB0b28gc21hbGwgZm9yIHBvaW50cyBkYXRhLiBVc2UgLmRpc3Bvc2UoKSBhbmQgY3JlYXRlIGEgbmV3IGdlb21ldHJ5LiIpLCBlLm5lZWRzVXBkYXRlID0gITA7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgY29tcHV0ZUJvdW5kaW5nQm94KCkgewogICAgdGhpcy5ib3VuZGluZ0JveCA9PT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ0JveCA9IG5ldyBVcygpKTsKICAgIGNvbnN0IHQgPSB0aGlzLmF0dHJpYnV0ZXMucG9zaXRpb24sIGUgPSB0aGlzLm1vcnBoQXR0cmlidXRlcy5wb3NpdGlvbjsKICAgIGlmICh0ICYmIHQuaXNHTEJ1ZmZlckF0dHJpYnV0ZSkgewogICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5CdWZmZXJHZW9tZXRyeS5jb21wdXRlQm91bmRpbmdCb3goKTogR0xCdWZmZXJBdHRyaWJ1dGUgcmVxdWlyZXMgYSBtYW51YWwgYm91bmRpbmcgYm94LiIsIHRoaXMpLCB0aGlzLmJvdW5kaW5nQm94LnNldCgKICAgICAgICBuZXcgdHQoLTEgLyAwLCAtMSAvIDAsIC0xIC8gMCksCiAgICAgICAgbmV3IHR0KDEgLyAwLCAxIC8gMCwgMSAvIDApCiAgICAgICk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0ICE9PSB2b2lkIDApIHsKICAgICAgaWYgKHRoaXMuYm91bmRpbmdCb3guc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZSh0KSwgZSkKICAgICAgICBmb3IgKGxldCBpID0gMCwgbiA9IGUubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBzID0gZVtpXTsKICAgICAgICAgIEZpLnNldEZyb21CdWZmZXJBdHRyaWJ1dGUocyksIHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmUgPyAoa2UuYWRkVmVjdG9ycyh0aGlzLmJvdW5kaW5nQm94Lm1pbiwgRmkubWluKSwgdGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KGtlKSwga2UuYWRkVmVjdG9ycyh0aGlzLmJvdW5kaW5nQm94Lm1heCwgRmkubWF4KSwgdGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KGtlKSkgOiAodGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KEZpLm1pbiksIHRoaXMuYm91bmRpbmdCb3guZXhwYW5kQnlQb2ludChGaS5tYXgpKTsKICAgICAgICB9CiAgICB9IGVsc2UKICAgICAgdGhpcy5ib3VuZGluZ0JveC5tYWtlRW1wdHkoKTsKICAgIChpc05hTih0aGlzLmJvdW5kaW5nQm94Lm1pbi54KSB8fCBpc05hTih0aGlzLmJvdW5kaW5nQm94Lm1pbi55KSB8fCBpc05hTih0aGlzLmJvdW5kaW5nQm94Lm1pbi56KSkgJiYgY29uc29sZS5lcnJvcignVEhSRUUuQnVmZmVyR2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCk6IENvbXB1dGVkIG1pbi9tYXggaGF2ZSBOYU4gdmFsdWVzLiBUaGUgInBvc2l0aW9uIiBhdHRyaWJ1dGUgaXMgbGlrZWx5IHRvIGhhdmUgTmFOIHZhbHVlcy4nLCB0aGlzKTsKICB9CiAgY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCkgewogICAgdGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ1NwaGVyZSA9IG5ldyB1dSgpKTsKICAgIGNvbnN0IHQgPSB0aGlzLmF0dHJpYnV0ZXMucG9zaXRpb24sIGUgPSB0aGlzLm1vcnBoQXR0cmlidXRlcy5wb3NpdGlvbjsKICAgIGlmICh0ICYmIHQuaXNHTEJ1ZmZlckF0dHJpYnV0ZSkgewogICAgICBjb25zb2xlLmVycm9yKCJUSFJFRS5CdWZmZXJHZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTogR0xCdWZmZXJBdHRyaWJ1dGUgcmVxdWlyZXMgYSBtYW51YWwgYm91bmRpbmcgc3BoZXJlLiIsIHRoaXMpLCB0aGlzLmJvdW5kaW5nU3BoZXJlLnNldChuZXcgdHQoKSwgMSAvIDApOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodCkgewogICAgICBjb25zdCBpID0gdGhpcy5ib3VuZGluZ1NwaGVyZS5jZW50ZXI7CiAgICAgIGlmIChGaS5zZXRGcm9tQnVmZmVyQXR0cmlidXRlKHQpLCBlKQogICAgICAgIGZvciAobGV0IHMgPSAwLCByID0gZS5sZW5ndGg7IHMgPCByOyBzKyspIHsKICAgICAgICAgIGNvbnN0IG8gPSBlW3NdOwogICAgICAgICAgZW8uc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZShvKSwgdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSA/IChrZS5hZGRWZWN0b3JzKEZpLm1pbiwgZW8ubWluKSwgRmkuZXhwYW5kQnlQb2ludChrZSksIGtlLmFkZFZlY3RvcnMoRmkubWF4LCBlby5tYXgpLCBGaS5leHBhbmRCeVBvaW50KGtlKSkgOiAoRmkuZXhwYW5kQnlQb2ludChlby5taW4pLCBGaS5leHBhbmRCeVBvaW50KGVvLm1heCkpOwogICAgICAgIH0KICAgICAgRmkuZ2V0Q2VudGVyKGkpOwogICAgICBsZXQgbiA9IDA7CiAgICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5jb3VudDsgcyA8IHI7IHMrKykKICAgICAgICBrZS5mcm9tQnVmZmVyQXR0cmlidXRlKHQsIHMpLCBuID0gTWF0aC5tYXgobiwgaS5kaXN0YW5jZVRvU3F1YXJlZChrZSkpOwogICAgICBpZiAoZSkKICAgICAgICBmb3IgKGxldCBzID0gMCwgciA9IGUubGVuZ3RoOyBzIDwgcjsgcysrKSB7CiAgICAgICAgICBjb25zdCBvID0gZVtzXSwgbCA9IHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmU7CiAgICAgICAgICBmb3IgKGxldCBoID0gMCwgYyA9IG8uY291bnQ7IGggPCBjOyBoKyspCiAgICAgICAgICAgIGtlLmZyb21CdWZmZXJBdHRyaWJ1dGUobywgaCksIGwgJiYgKEpyLmZyb21CdWZmZXJBdHRyaWJ1dGUodCwgaCksIGtlLmFkZChKcikpLCBuID0gTWF0aC5tYXgobiwgaS5kaXN0YW5jZVRvU3F1YXJlZChrZSkpOwogICAgICAgIH0KICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBNYXRoLnNxcnQobiksIGlzTmFOKHRoaXMuYm91bmRpbmdTcGhlcmUucmFkaXVzKSAmJiBjb25zb2xlLmVycm9yKCdUSFJFRS5CdWZmZXJHZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTogQ29tcHV0ZWQgcmFkaXVzIGlzIE5hTi4gVGhlICJwb3NpdGlvbiIgYXR0cmlidXRlIGlzIGxpa2VseSB0byBoYXZlIE5hTiB2YWx1ZXMuJywgdGhpcyk7CiAgICB9CiAgfQogIGNvbXB1dGVUYW5nZW50cygpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmluZGV4LCBlID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgaWYgKHQgPT09IG51bGwgfHwgZS5wb3NpdGlvbiA9PT0gdm9pZCAwIHx8IGUubm9ybWFsID09PSB2b2lkIDAgfHwgZS51diA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlRIUkVFLkJ1ZmZlckdlb21ldHJ5OiAuY29tcHV0ZVRhbmdlbnRzKCkgZmFpbGVkLiBNaXNzaW5nIHJlcXVpcmVkIGF0dHJpYnV0ZXMgKGluZGV4LCBwb3NpdGlvbiwgbm9ybWFsIG9yIHV2KSIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpID0gZS5wb3NpdGlvbiwgbiA9IGUubm9ybWFsLCBzID0gZS51djsKICAgIHRoaXMuaGFzQXR0cmlidXRlKCJ0YW5nZW50IikgPT09ICExICYmIHRoaXMuc2V0QXR0cmlidXRlKCJ0YW5nZW50IiwgbmV3IHFpKG5ldyBGbG9hdDMyQXJyYXkoNCAqIGkuY291bnQpLCA0KSk7CiAgICBjb25zdCByID0gdGhpcy5nZXRBdHRyaWJ1dGUoInRhbmdlbnQiKSwgbyA9IFtdLCBsID0gW107CiAgICBmb3IgKGxldCBSID0gMDsgUiA8IGkuY291bnQ7IFIrKykKICAgICAgb1tSXSA9IG5ldyB0dCgpLCBsW1JdID0gbmV3IHR0KCk7CiAgICBjb25zdCBoID0gbmV3IHR0KCksIGMgPSBuZXcgdHQoKSwgdSA9IG5ldyB0dCgpLCBkID0gbmV3IF9pKCksIHAgPSBuZXcgX2koKSwgZiA9IG5ldyBfaSgpLCB5ID0gbmV3IHR0KCksIGcgPSBuZXcgdHQoKTsKICAgIGZ1bmN0aW9uIG0oUiwgYiwgTSkgewogICAgICBoLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSwgUiksIGMuZnJvbUJ1ZmZlckF0dHJpYnV0ZShpLCBiKSwgdS5mcm9tQnVmZmVyQXR0cmlidXRlKGksIE0pLCBkLmZyb21CdWZmZXJBdHRyaWJ1dGUocywgUiksIHAuZnJvbUJ1ZmZlckF0dHJpYnV0ZShzLCBiKSwgZi5mcm9tQnVmZmVyQXR0cmlidXRlKHMsIE0pLCBjLnN1YihoKSwgdS5zdWIoaCksIHAuc3ViKGQpLCBmLnN1YihkKTsKICAgICAgY29uc3QgTCA9IDEgLyAocC54ICogZi55IC0gZi54ICogcC55KTsKICAgICAgaXNGaW5pdGUoTCkgJiYgKHkuY29weShjKS5tdWx0aXBseVNjYWxhcihmLnkpLmFkZFNjYWxlZFZlY3Rvcih1LCAtcC55KS5tdWx0aXBseVNjYWxhcihMKSwgZy5jb3B5KHUpLm11bHRpcGx5U2NhbGFyKHAueCkuYWRkU2NhbGVkVmVjdG9yKGMsIC1mLngpLm11bHRpcGx5U2NhbGFyKEwpLCBvW1JdLmFkZCh5KSwgb1tiXS5hZGQoeSksIG9bTV0uYWRkKHkpLCBsW1JdLmFkZChnKSwgbFtiXS5hZGQoZyksIGxbTV0uYWRkKGcpKTsKICAgIH0KICAgIGxldCB2ID0gdGhpcy5ncm91cHM7CiAgICB2Lmxlbmd0aCA9PT0gMCAmJiAodiA9IFt7CiAgICAgIHN0YXJ0OiAwLAogICAgICBjb3VudDogdC5jb3VudAogICAgfV0pOwogICAgZm9yIChsZXQgUiA9IDAsIGIgPSB2Lmxlbmd0aDsgUiA8IGI7ICsrUikgewogICAgICBjb25zdCBNID0gdltSXSwgTCA9IE0uc3RhcnQsIFUgPSBNLmNvdW50OwogICAgICBmb3IgKGxldCBPID0gTCwgViA9IEwgKyBVOyBPIDwgVjsgTyArPSAzKQogICAgICAgIG0oCiAgICAgICAgICB0LmdldFgoTyArIDApLAogICAgICAgICAgdC5nZXRYKE8gKyAxKSwKICAgICAgICAgIHQuZ2V0WChPICsgMikKICAgICAgICApOwogICAgfQogICAgY29uc3QgeCA9IG5ldyB0dCgpLCBfID0gbmV3IHR0KCksIFMgPSBuZXcgdHQoKSwgdyA9IG5ldyB0dCgpOwogICAgZnVuY3Rpb24gVChSKSB7CiAgICAgIFMuZnJvbUJ1ZmZlckF0dHJpYnV0ZShuLCBSKSwgdy5jb3B5KFMpOwogICAgICBjb25zdCBiID0gb1tSXTsKICAgICAgeC5jb3B5KGIpLCB4LnN1YihTLm11bHRpcGx5U2NhbGFyKFMuZG90KGIpKSkubm9ybWFsaXplKCksIF8uY3Jvc3NWZWN0b3JzKHcsIGIpOwogICAgICBjb25zdCBMID0gXy5kb3QobFtSXSkgPCAwID8gLTEgOiAxOwogICAgICByLnNldFhZWlcoUiwgeC54LCB4LnksIHgueiwgTCk7CiAgICB9CiAgICBmb3IgKGxldCBSID0gMCwgYiA9IHYubGVuZ3RoOyBSIDwgYjsgKytSKSB7CiAgICAgIGNvbnN0IE0gPSB2W1JdLCBMID0gTS5zdGFydCwgVSA9IE0uY291bnQ7CiAgICAgIGZvciAobGV0IE8gPSBMLCBWID0gTCArIFU7IE8gPCBWOyBPICs9IDMpCiAgICAgICAgVCh0LmdldFgoTyArIDApKSwgVCh0LmdldFgoTyArIDEpKSwgVCh0LmdldFgoTyArIDIpKTsKICAgIH0KICB9CiAgY29tcHV0ZVZlcnRleE5vcm1hbHMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5pbmRleCwgZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCJwb3NpdGlvbiIpOwogICAgaWYgKGUgIT09IHZvaWQgMCkgewogICAgICBsZXQgaSA9IHRoaXMuZ2V0QXR0cmlidXRlKCJub3JtYWwiKTsKICAgICAgaWYgKGkgPT09IHZvaWQgMCkKICAgICAgICBpID0gbmV3IHFpKG5ldyBGbG9hdDMyQXJyYXkoZS5jb3VudCAqIDMpLCAzKSwgdGhpcy5zZXRBdHRyaWJ1dGUoIm5vcm1hbCIsIGkpOwogICAgICBlbHNlCiAgICAgICAgZm9yIChsZXQgZCA9IDAsIHAgPSBpLmNvdW50OyBkIDwgcDsgZCsrKQogICAgICAgICAgaS5zZXRYWVooZCwgMCwgMCwgMCk7CiAgICAgIGNvbnN0IG4gPSBuZXcgdHQoKSwgcyA9IG5ldyB0dCgpLCByID0gbmV3IHR0KCksIG8gPSBuZXcgdHQoKSwgbCA9IG5ldyB0dCgpLCBoID0gbmV3IHR0KCksIGMgPSBuZXcgdHQoKSwgdSA9IG5ldyB0dCgpOwogICAgICBpZiAodCkKICAgICAgICBmb3IgKGxldCBkID0gMCwgcCA9IHQuY291bnQ7IGQgPCBwOyBkICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGYgPSB0LmdldFgoZCArIDApLCB5ID0gdC5nZXRYKGQgKyAxKSwgZyA9IHQuZ2V0WChkICsgMik7CiAgICAgICAgICBuLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgZiksIHMuZnJvbUJ1ZmZlckF0dHJpYnV0ZShlLCB5KSwgci5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIGcpLCBjLnN1YlZlY3RvcnMociwgcyksIHUuc3ViVmVjdG9ycyhuLCBzKSwgYy5jcm9zcyh1KSwgby5mcm9tQnVmZmVyQXR0cmlidXRlKGksIGYpLCBsLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSwgeSksIGguZnJvbUJ1ZmZlckF0dHJpYnV0ZShpLCBnKSwgby5hZGQoYyksIGwuYWRkKGMpLCBoLmFkZChjKSwgaS5zZXRYWVooZiwgby54LCBvLnksIG8ueiksIGkuc2V0WFlaKHksIGwueCwgbC55LCBsLnopLCBpLnNldFhZWihnLCBoLngsIGgueSwgaC56KTsKICAgICAgICB9CiAgICAgIGVsc2UKICAgICAgICBmb3IgKGxldCBkID0gMCwgcCA9IGUuY291bnQ7IGQgPCBwOyBkICs9IDMpCiAgICAgICAgICBuLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgZCArIDApLCBzLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgZCArIDEpLCByLmZyb21CdWZmZXJBdHRyaWJ1dGUoZSwgZCArIDIpLCBjLnN1YlZlY3RvcnMociwgcyksIHUuc3ViVmVjdG9ycyhuLCBzKSwgYy5jcm9zcyh1KSwgaS5zZXRYWVooZCArIDAsIGMueCwgYy55LCBjLnopLCBpLnNldFhZWihkICsgMSwgYy54LCBjLnksIGMueiksIGkuc2V0WFlaKGQgKyAyLCBjLngsIGMueSwgYy56KTsKICAgICAgdGhpcy5ub3JtYWxpemVOb3JtYWxzKCksIGkubmVlZHNVcGRhdGUgPSAhMDsKICAgIH0KICB9CiAgbm9ybWFsaXplTm9ybWFscygpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmF0dHJpYnV0ZXMubm9ybWFsOwogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0LmNvdW50OyBlIDwgaTsgZSsrKQogICAgICBrZS5mcm9tQnVmZmVyQXR0cmlidXRlKHQsIGUpLCBrZS5ub3JtYWxpemUoKSwgdC5zZXRYWVooZSwga2UueCwga2UueSwga2Uueik7CiAgfQogIHRvTm9uSW5kZXhlZCgpIHsKICAgIGZ1bmN0aW9uIHQobywgbCkgewogICAgICBjb25zdCBoID0gby5hcnJheSwgYyA9IG8uaXRlbVNpemUsIHUgPSBvLm5vcm1hbGl6ZWQsIGQgPSBuZXcgaC5jb25zdHJ1Y3RvcihsLmxlbmd0aCAqIGMpOwogICAgICBsZXQgcCA9IDAsIGYgPSAwOwogICAgICBmb3IgKGxldCB5ID0gMCwgZyA9IGwubGVuZ3RoOyB5IDwgZzsgeSsrKSB7CiAgICAgICAgby5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlID8gcCA9IGxbeV0gKiBvLmRhdGEuc3RyaWRlICsgby5vZmZzZXQgOiBwID0gbFt5XSAqIGM7CiAgICAgICAgZm9yIChsZXQgbSA9IDA7IG0gPCBjOyBtKyspCiAgICAgICAgICBkW2YrK10gPSBoW3ArK107CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBxaShkLCBjLCB1KTsKICAgIH0KICAgIGlmICh0aGlzLmluZGV4ID09PSBudWxsKQogICAgICByZXR1cm4gY29uc29sZS53YXJuKCJUSFJFRS5CdWZmZXJHZW9tZXRyeS50b05vbkluZGV4ZWQoKTogQnVmZmVyR2VvbWV0cnkgaXMgYWxyZWFkeSBub24taW5kZXhlZC4iKSwgdGhpczsKICAgIGNvbnN0IGUgPSBuZXcgRmEoKSwgaSA9IHRoaXMuaW5kZXguYXJyYXksIG4gPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IG8gaW4gbikgewogICAgICBjb25zdCBsID0gbltvXSwgaCA9IHQobCwgaSk7CiAgICAgIGUuc2V0QXR0cmlidXRlKG8sIGgpOwogICAgfQogICAgY29uc3QgcyA9IHRoaXMubW9ycGhBdHRyaWJ1dGVzOwogICAgZm9yIChjb25zdCBvIGluIHMpIHsKICAgICAgY29uc3QgbCA9IFtdLCBoID0gc1tvXTsKICAgICAgZm9yIChsZXQgYyA9IDAsIHUgPSBoLmxlbmd0aDsgYyA8IHU7IGMrKykgewogICAgICAgIGNvbnN0IGQgPSBoW2NdLCBwID0gdChkLCBpKTsKICAgICAgICBsLnB1c2gocCk7CiAgICAgIH0KICAgICAgZS5tb3JwaEF0dHJpYnV0ZXNbb10gPSBsOwogICAgfQogICAgZS5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9IHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmU7CiAgICBjb25zdCByID0gdGhpcy5ncm91cHM7CiAgICBmb3IgKGxldCBvID0gMCwgbCA9IHIubGVuZ3RoOyBvIDwgbDsgbysrKSB7CiAgICAgIGNvbnN0IGggPSByW29dOwogICAgICBlLmFkZEdyb3VwKGguc3RhcnQsIGguY291bnQsIGgubWF0ZXJpYWxJbmRleCk7CiAgICB9CiAgICByZXR1cm4gZTsKICB9CiAgdG9KU09OKCkgewogICAgY29uc3QgdCA9IHsKICAgICAgbWV0YWRhdGE6IHsKICAgICAgICB2ZXJzaW9uOiA0LjYsCiAgICAgICAgdHlwZTogIkJ1ZmZlckdlb21ldHJ5IiwKICAgICAgICBnZW5lcmF0b3I6ICJCdWZmZXJHZW9tZXRyeS50b0pTT04iCiAgICAgIH0KICAgIH07CiAgICBpZiAodC51dWlkID0gdGhpcy51dWlkLCB0LnR5cGUgPSB0aGlzLnR5cGUsIHRoaXMubmFtZSAhPT0gIiIgJiYgKHQubmFtZSA9IHRoaXMubmFtZSksIE9iamVjdC5rZXlzKHRoaXMudXNlckRhdGEpLmxlbmd0aCA+IDAgJiYgKHQudXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhKSwgdGhpcy5wYXJhbWV0ZXJzICE9PSB2b2lkIDApIHsKICAgICAgY29uc3QgbCA9IHRoaXMucGFyYW1ldGVyczsKICAgICAgZm9yIChjb25zdCBoIGluIGwpCiAgICAgICAgbFtoXSAhPT0gdm9pZCAwICYmICh0W2hdID0gbFtoXSk7CiAgICAgIHJldHVybiB0OwogICAgfQogICAgdC5kYXRhID0geyBhdHRyaWJ1dGVzOiB7fSB9OwogICAgY29uc3QgZSA9IHRoaXMuaW5kZXg7CiAgICBlICE9PSBudWxsICYmICh0LmRhdGEuaW5kZXggPSB7CiAgICAgIHR5cGU6IGUuYXJyYXkuY29uc3RydWN0b3IubmFtZSwKICAgICAgYXJyYXk6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGUuYXJyYXkpCiAgICB9KTsKICAgIGNvbnN0IGkgPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IGwgaW4gaSkgewogICAgICBjb25zdCBoID0gaVtsXTsKICAgICAgdC5kYXRhLmF0dHJpYnV0ZXNbbF0gPSBoLnRvSlNPTih0LmRhdGEpOwogICAgfQogICAgY29uc3QgbiA9IHt9OwogICAgbGV0IHMgPSAhMTsKICAgIGZvciAoY29uc3QgbCBpbiB0aGlzLm1vcnBoQXR0cmlidXRlcykgewogICAgICBjb25zdCBoID0gdGhpcy5tb3JwaEF0dHJpYnV0ZXNbbF0sIGMgPSBbXTsKICAgICAgZm9yIChsZXQgdSA9IDAsIGQgPSBoLmxlbmd0aDsgdSA8IGQ7IHUrKykgewogICAgICAgIGNvbnN0IHAgPSBoW3VdOwogICAgICAgIGMucHVzaChwLnRvSlNPTih0LmRhdGEpKTsKICAgICAgfQogICAgICBjLmxlbmd0aCA+IDAgJiYgKG5bbF0gPSBjLCBzID0gITApOwogICAgfQogICAgcyAmJiAodC5kYXRhLm1vcnBoQXR0cmlidXRlcyA9IG4sIHQuZGF0YS5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9IHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmUpOwogICAgY29uc3QgciA9IHRoaXMuZ3JvdXBzOwogICAgci5sZW5ndGggPiAwICYmICh0LmRhdGEuZ3JvdXBzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyKSkpOwogICAgY29uc3QgbyA9IHRoaXMuYm91bmRpbmdTcGhlcmU7CiAgICByZXR1cm4gbyAhPT0gbnVsbCAmJiAodC5kYXRhLmJvdW5kaW5nU3BoZXJlID0gewogICAgICBjZW50ZXI6IG8uY2VudGVyLnRvQXJyYXkoKSwKICAgICAgcmFkaXVzOiBvLnJhZGl1cwogICAgfSksIHQ7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgY29weSh0KSB7CiAgICB0aGlzLmluZGV4ID0gbnVsbCwgdGhpcy5hdHRyaWJ1dGVzID0ge30sIHRoaXMubW9ycGhBdHRyaWJ1dGVzID0ge30sIHRoaXMuZ3JvdXBzID0gW10sIHRoaXMuYm91bmRpbmdCb3ggPSBudWxsLCB0aGlzLmJvdW5kaW5nU3BoZXJlID0gbnVsbDsKICAgIGNvbnN0IGUgPSB7fTsKICAgIHRoaXMubmFtZSA9IHQubmFtZTsKICAgIGNvbnN0IGkgPSB0LmluZGV4OwogICAgaSAhPT0gbnVsbCAmJiB0aGlzLnNldEluZGV4KGkuY2xvbmUoZSkpOwogICAgY29uc3QgbiA9IHQuYXR0cmlidXRlczsKICAgIGZvciAoY29uc3QgaCBpbiBuKSB7CiAgICAgIGNvbnN0IGMgPSBuW2hdOwogICAgICB0aGlzLnNldEF0dHJpYnV0ZShoLCBjLmNsb25lKGUpKTsKICAgIH0KICAgIGNvbnN0IHMgPSB0Lm1vcnBoQXR0cmlidXRlczsKICAgIGZvciAoY29uc3QgaCBpbiBzKSB7CiAgICAgIGNvbnN0IGMgPSBbXSwgdSA9IHNbaF07CiAgICAgIGZvciAobGV0IGQgPSAwLCBwID0gdS5sZW5ndGg7IGQgPCBwOyBkKyspCiAgICAgICAgYy5wdXNoKHVbZF0uY2xvbmUoZSkpOwogICAgICB0aGlzLm1vcnBoQXR0cmlidXRlc1toXSA9IGM7CiAgICB9CiAgICB0aGlzLm1vcnBoVGFyZ2V0c1JlbGF0aXZlID0gdC5tb3JwaFRhcmdldHNSZWxhdGl2ZTsKICAgIGNvbnN0IHIgPSB0Lmdyb3VwczsKICAgIGZvciAobGV0IGggPSAwLCBjID0gci5sZW5ndGg7IGggPCBjOyBoKyspIHsKICAgICAgY29uc3QgdSA9IHJbaF07CiAgICAgIHRoaXMuYWRkR3JvdXAodS5zdGFydCwgdS5jb3VudCwgdS5tYXRlcmlhbEluZGV4KTsKICAgIH0KICAgIGNvbnN0IG8gPSB0LmJvdW5kaW5nQm94OwogICAgbyAhPT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ0JveCA9IG8uY2xvbmUoKSk7CiAgICBjb25zdCBsID0gdC5ib3VuZGluZ1NwaGVyZTsKICAgIHJldHVybiBsICE9PSBudWxsICYmICh0aGlzLmJvdW5kaW5nU3BoZXJlID0gbC5jbG9uZSgpKSwgdGhpcy5kcmF3UmFuZ2Uuc3RhcnQgPSB0LmRyYXdSYW5nZS5zdGFydCwgdGhpcy5kcmF3UmFuZ2UuY291bnQgPSB0LmRyYXdSYW5nZS5jb3VudCwgdGhpcy51c2VyRGF0YSA9IHQudXNlckRhdGEsIHRoaXM7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiAiZGlzcG9zZSIgfSk7CiAgfQp9CmNvbnN0IHFnID0gLyogQF9fUFVSRV9fICovIG5ldyBRbigpLCB0ciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVlQoKSwgcmggPSAvKiBAX19QVVJFX18gKi8gbmV3IHV1KCksICRnID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBhaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgb2ggPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIGxoID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBVZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgaGggPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCksIFhnID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpLCBjaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKTsKY2xhc3MgQWMgZXh0ZW5kcyBEYSB7CiAgY29uc3RydWN0b3IodCA9IG5ldyBGYSgpLCBlID0gbmV3IHB1KCkpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNNZXNoID0gITAsIHRoaXMudHlwZSA9ICJNZXNoIiwgdGhpcy5nZW9tZXRyeSA9IHQsIHRoaXMubWF0ZXJpYWwgPSBlLCB0aGlzLnVwZGF0ZU1vcnBoVGFyZ2V0cygpOwogIH0KICBjb3B5KHQsIGUpIHsKICAgIHJldHVybiBzdXBlci5jb3B5KHQsIGUpLCB0Lm1vcnBoVGFyZ2V0SW5mbHVlbmNlcyAhPT0gdm9pZCAwICYmICh0aGlzLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcyA9IHQubW9ycGhUYXJnZXRJbmZsdWVuY2VzLnNsaWNlKCkpLCB0Lm1vcnBoVGFyZ2V0RGljdGlvbmFyeSAhPT0gdm9pZCAwICYmICh0aGlzLm1vcnBoVGFyZ2V0RGljdGlvbmFyeSA9IE9iamVjdC5hc3NpZ24oe30sIHQubW9ycGhUYXJnZXREaWN0aW9uYXJ5KSksIHRoaXMubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KHQubWF0ZXJpYWwpID8gdC5tYXRlcmlhbC5zbGljZSgpIDogdC5tYXRlcmlhbCwgdGhpcy5nZW9tZXRyeSA9IHQuZ2VvbWV0cnksIHRoaXM7CiAgfQogIHVwZGF0ZU1vcnBoVGFyZ2V0cygpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcywgaSA9IE9iamVjdC5rZXlzKGUpOwogICAgaWYgKGkubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBuID0gZVtpWzBdXTsKICAgICAgaWYgKG4gIT09IHZvaWQgMCkgewogICAgICAgIHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzID0gW10sIHRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5ID0ge307CiAgICAgICAgZm9yIChsZXQgcyA9IDAsIHIgPSBuLmxlbmd0aDsgcyA8IHI7IHMrKykgewogICAgICAgICAgY29uc3QgbyA9IG5bc10ubmFtZSB8fCBTdHJpbmcocyk7CiAgICAgICAgICB0aGlzLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcy5wdXNoKDApLCB0aGlzLm1vcnBoVGFyZ2V0RGljdGlvbmFyeVtvXSA9IHM7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGdldFZlcnRleFBvc2l0aW9uKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmdlb21ldHJ5LCBuID0gaS5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBzID0gaS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24sIHIgPSBpLm1vcnBoVGFyZ2V0c1JlbGF0aXZlOwogICAgZS5mcm9tQnVmZmVyQXR0cmlidXRlKG4sIHQpOwogICAgY29uc3QgbyA9IHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzOwogICAgaWYgKHMgJiYgbykgewogICAgICBoaC5zZXQoMCwgMCwgMCk7CiAgICAgIGZvciAobGV0IGwgPSAwLCBoID0gcy5sZW5ndGg7IGwgPCBoOyBsKyspIHsKICAgICAgICBjb25zdCBjID0gb1tsXSwgdSA9IHNbbF07CiAgICAgICAgYyAhPT0gMCAmJiAoVWQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh1LCB0KSwgciA/IGhoLmFkZFNjYWxlZFZlY3RvcihVZCwgYykgOiBoaC5hZGRTY2FsZWRWZWN0b3IoVWQuc3ViKGUpLCBjKSk7CiAgICAgIH0KICAgICAgZS5hZGQoaGgpOwogICAgfQogICAgcmV0dXJuIGU7CiAgfQogIHJheWNhc3QodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuZ2VvbWV0cnksIG4gPSB0aGlzLm1hdGVyaWFsLCBzID0gdGhpcy5tYXRyaXhXb3JsZDsKICAgIG4gIT09IHZvaWQgMCAmJiAoaS5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiBpLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCByaC5jb3B5KGkuYm91bmRpbmdTcGhlcmUpLCByaC5hcHBseU1hdHJpeDQocyksIHRyLmNvcHkodC5yYXkpLnJlY2FzdCh0Lm5lYXIpLCAhKHJoLmNvbnRhaW5zUG9pbnQodHIub3JpZ2luKSA9PT0gITEgJiYgKHRyLmludGVyc2VjdFNwaGVyZShyaCwgJGcpID09PSBudWxsIHx8IHRyLm9yaWdpbi5kaXN0YW5jZVRvU3F1YXJlZCgkZykgPiAodC5mYXIgLSB0Lm5lYXIpICoqIDIpKSAmJiAocWcuY29weShzKS5pbnZlcnQoKSwgdHIuY29weSh0LnJheSkuYXBwbHlNYXRyaXg0KHFnKSwgIShpLmJvdW5kaW5nQm94ICE9PSBudWxsICYmIHRyLmludGVyc2VjdHNCb3goaS5ib3VuZGluZ0JveCkgPT09ICExKSAmJiB0aGlzLl9jb21wdXRlSW50ZXJzZWN0aW9ucyh0LCBlLCB0cikpKTsKICB9CiAgX2NvbXB1dGVJbnRlcnNlY3Rpb25zKHQsIGUsIGkpIHsKICAgIGxldCBuOwogICAgY29uc3QgcyA9IHRoaXMuZ2VvbWV0cnksIHIgPSB0aGlzLm1hdGVyaWFsLCBvID0gcy5pbmRleCwgbCA9IHMuYXR0cmlidXRlcy5wb3NpdGlvbiwgaCA9IHMuYXR0cmlidXRlcy51diwgYyA9IHMuYXR0cmlidXRlcy51djEsIHUgPSBzLmF0dHJpYnV0ZXMubm9ybWFsLCBkID0gcy5ncm91cHMsIHAgPSBzLmRyYXdSYW5nZTsKICAgIGlmIChvICE9PSBudWxsKQogICAgICBpZiAoQXJyYXkuaXNBcnJheShyKSkKICAgICAgICBmb3IgKGxldCBmID0gMCwgeSA9IGQubGVuZ3RoOyBmIDwgeTsgZisrKSB7CiAgICAgICAgICBjb25zdCBnID0gZFtmXSwgbSA9IHJbZy5tYXRlcmlhbEluZGV4XSwgdiA9IE1hdGgubWF4KGcuc3RhcnQsIHAuc3RhcnQpLCB4ID0gTWF0aC5taW4oby5jb3VudCwgTWF0aC5taW4oZy5zdGFydCArIGcuY291bnQsIHAuc3RhcnQgKyBwLmNvdW50KSk7CiAgICAgICAgICBmb3IgKGxldCBfID0gdiwgUyA9IHg7IF8gPCBTOyBfICs9IDMpIHsKICAgICAgICAgICAgY29uc3QgdyA9IG8uZ2V0WChfKSwgVCA9IG8uZ2V0WChfICsgMSksIFIgPSBvLmdldFgoXyArIDIpOwogICAgICAgICAgICBuID0gdWgodGhpcywgbSwgdCwgaSwgaCwgYywgdSwgdywgVCwgUiksIG4gJiYgKG4uZmFjZUluZGV4ID0gTWF0aC5mbG9vcihfIC8gMyksIG4uZmFjZS5tYXRlcmlhbEluZGV4ID0gZy5tYXRlcmlhbEluZGV4LCBlLnB1c2gobikpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgY29uc3QgZiA9IE1hdGgubWF4KDAsIHAuc3RhcnQpLCB5ID0gTWF0aC5taW4oby5jb3VudCwgcC5zdGFydCArIHAuY291bnQpOwogICAgICAgIGZvciAobGV0IGcgPSBmLCBtID0geTsgZyA8IG07IGcgKz0gMykgewogICAgICAgICAgY29uc3QgdiA9IG8uZ2V0WChnKSwgeCA9IG8uZ2V0WChnICsgMSksIF8gPSBvLmdldFgoZyArIDIpOwogICAgICAgICAgbiA9IHVoKHRoaXMsIHIsIHQsIGksIGgsIGMsIHUsIHYsIHgsIF8pLCBuICYmIChuLmZhY2VJbmRleCA9IE1hdGguZmxvb3IoZyAvIDMpLCBlLnB1c2gobikpOwogICAgICAgIH0KICAgICAgfQogICAgZWxzZSBpZiAobCAhPT0gdm9pZCAwKQogICAgICBpZiAoQXJyYXkuaXNBcnJheShyKSkKICAgICAgICBmb3IgKGxldCBmID0gMCwgeSA9IGQubGVuZ3RoOyBmIDwgeTsgZisrKSB7CiAgICAgICAgICBjb25zdCBnID0gZFtmXSwgbSA9IHJbZy5tYXRlcmlhbEluZGV4XSwgdiA9IE1hdGgubWF4KGcuc3RhcnQsIHAuc3RhcnQpLCB4ID0gTWF0aC5taW4obC5jb3VudCwgTWF0aC5taW4oZy5zdGFydCArIGcuY291bnQsIHAuc3RhcnQgKyBwLmNvdW50KSk7CiAgICAgICAgICBmb3IgKGxldCBfID0gdiwgUyA9IHg7IF8gPCBTOyBfICs9IDMpIHsKICAgICAgICAgICAgY29uc3QgdyA9IF8sIFQgPSBfICsgMSwgUiA9IF8gKyAyOwogICAgICAgICAgICBuID0gdWgodGhpcywgbSwgdCwgaSwgaCwgYywgdSwgdywgVCwgUiksIG4gJiYgKG4uZmFjZUluZGV4ID0gTWF0aC5mbG9vcihfIC8gMyksIG4uZmFjZS5tYXRlcmlhbEluZGV4ID0gZy5tYXRlcmlhbEluZGV4LCBlLnB1c2gobikpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgY29uc3QgZiA9IE1hdGgubWF4KDAsIHAuc3RhcnQpLCB5ID0gTWF0aC5taW4obC5jb3VudCwgcC5zdGFydCArIHAuY291bnQpOwogICAgICAgIGZvciAobGV0IGcgPSBmLCBtID0geTsgZyA8IG07IGcgKz0gMykgewogICAgICAgICAgY29uc3QgdiA9IGcsIHggPSBnICsgMSwgXyA9IGcgKyAyOwogICAgICAgICAgbiA9IHVoKHRoaXMsIHIsIHQsIGksIGgsIGMsIHUsIHYsIHgsIF8pLCBuICYmIChuLmZhY2VJbmRleCA9IE1hdGguZmxvb3IoZyAvIDMpLCBlLnB1c2gobikpOwogICAgICAgIH0KICAgICAgfQogIH0KfQpmdW5jdGlvbiBRVChhLCB0LCBlLCBpLCBuLCBzLCByLCBvKSB7CiAgbGV0IGw7CiAgaWYgKHQuc2lkZSA9PT0gZ2YgPyBsID0gaS5pbnRlcnNlY3RUcmlhbmdsZShyLCBzLCBuLCAhMCwgbykgOiBsID0gaS5pbnRlcnNlY3RUcmlhbmdsZShuLCBzLCByLCB0LnNpZGUgPT09IEJvLCBvKSwgbCA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgY2guY29weShvKSwgY2guYXBwbHlNYXRyaXg0KGEubWF0cml4V29ybGQpOwogIGNvbnN0IGggPSBlLnJheS5vcmlnaW4uZGlzdGFuY2VUbyhjaCk7CiAgcmV0dXJuIGggPCBlLm5lYXIgfHwgaCA+IGUuZmFyID8gbnVsbCA6IHsKICAgIGRpc3RhbmNlOiBoLAogICAgcG9pbnQ6IGNoLmNsb25lKCksCiAgICBvYmplY3Q6IGEKICB9Owp9CmZ1bmN0aW9uIHVoKGEsIHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgpIHsKICBhLmdldFZlcnRleFBvc2l0aW9uKG8sIGFoKSwgYS5nZXRWZXJ0ZXhQb3NpdGlvbihsLCBvaCksIGEuZ2V0VmVydGV4UG9zaXRpb24oaCwgbGgpOwogIGNvbnN0IGMgPSBRVChhLCB0LCBlLCBpLCBhaCwgb2gsIGxoLCBYZyk7CiAgaWYgKGMpIHsKICAgIGNvbnN0IHUgPSBuZXcgdHQoKTsKICAgIGNuLmdldEJhcnljb29yZChYZywgYWgsIG9oLCBsaCwgdSksIG4gJiYgKGMudXYgPSBjbi5nZXRJbnRlcnBvbGF0ZWRBdHRyaWJ1dGUobiwgbywgbCwgaCwgdSwgbmV3IF9pKCkpKSwgcyAmJiAoYy51djEgPSBjbi5nZXRJbnRlcnBvbGF0ZWRBdHRyaWJ1dGUocywgbywgbCwgaCwgdSwgbmV3IF9pKCkpKSwgciAmJiAoYy5ub3JtYWwgPSBjbi5nZXRJbnRlcnBvbGF0ZWRBdHRyaWJ1dGUociwgbywgbCwgaCwgdSwgbmV3IHR0KCkpLCBjLm5vcm1hbC5kb3QoaS5kaXJlY3Rpb24pID4gMCAmJiBjLm5vcm1hbC5tdWx0aXBseVNjYWxhcigtMSkpOwogICAgY29uc3QgZCA9IHsKICAgICAgYTogbywKICAgICAgYjogbCwKICAgICAgYzogaCwKICAgICAgbm9ybWFsOiBuZXcgdHQoKSwKICAgICAgbWF0ZXJpYWxJbmRleDogMAogICAgfTsKICAgIGNuLmdldE5vcm1hbChhaCwgb2gsIGxoLCBkLm5vcm1hbCksIGMuZmFjZSA9IGQsIGMuYmFyeWNvb3JkID0gdTsKICB9CiAgcmV0dXJuIGM7Cn0KZnVuY3Rpb24gdmYoYSkgewogIGNvbnN0IHQgPSB7fTsKICBmb3IgKGNvbnN0IGUgaW4gYSkgewogICAgdFtlXSA9IHt9OwogICAgZm9yIChjb25zdCBpIGluIGFbZV0pIHsKICAgICAgY29uc3QgbiA9IGFbZV1baV07CiAgICAgIG4gJiYgKG4uaXNDb2xvciB8fCBuLmlzTWF0cml4MyB8fCBuLmlzTWF0cml4NCB8fCBuLmlzVmVjdG9yMiB8fCBuLmlzVmVjdG9yMyB8fCBuLmlzVmVjdG9yNCB8fCBuLmlzVGV4dHVyZSB8fCBuLmlzUXVhdGVybmlvbikgPyBuLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA/IChjb25zb2xlLndhcm4oIlVuaWZvcm1zVXRpbHM6IFRleHR1cmVzIG9mIHJlbmRlciB0YXJnZXRzIGNhbm5vdCBiZSBjbG9uZWQgdmlhIGNsb25lVW5pZm9ybXMoKSBvciBtZXJnZVVuaWZvcm1zKCkuIiksIHRbZV1baV0gPSBudWxsKSA6IHRbZV1baV0gPSBuLmNsb25lKCkgOiBBcnJheS5pc0FycmF5KG4pID8gdFtlXVtpXSA9IG4uc2xpY2UoKSA6IHRbZV1baV0gPSBuOwogICAgfQogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBiZihhKSB7CiAgY29uc3QgdCA9IHt9OwogIGZvciAobGV0IGUgPSAwOyBlIDwgYS5sZW5ndGg7IGUrKykgewogICAgY29uc3QgaSA9IHZmKGFbZV0pOwogICAgZm9yIChjb25zdCBuIGluIGkpCiAgICAgIHRbbl0gPSBpW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiB0QyhhKSB7CiAgY29uc3QgdCA9IFtdOwogIGZvciAobGV0IGUgPSAwOyBlIDwgYS5sZW5ndGg7IGUrKykKICAgIHQucHVzaChhW2VdLmNsb25lKCkpOwogIHJldHVybiB0Owp9CmNvbnN0IGpfID0geyBjbG9uZTogdmYsIG1lcmdlOiBiZiB9Owp2YXIgZUMgPSBgdm9pZCBtYWluKCkgewoJZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbW9kZWxWaWV3TWF0cml4ICogdmVjNCggcG9zaXRpb24sIDEuMCApOwp9YCwgaUMgPSBgdm9pZCBtYWluKCkgewoJZ2xfRnJhZ0NvbG9yID0gdmVjNCggMS4wLCAwLjAsIDAuMCwgMS4wICk7Cn1gOwpjbGFzcyBuQyBleHRlbmRzIHhmIHsKICBzdGF0aWMgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gIlNoYWRlck1hdGVyaWFsIjsKICB9CiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc1NoYWRlck1hdGVyaWFsID0gITAsIHRoaXMuZGVmaW5lcyA9IHt9LCB0aGlzLnVuaWZvcm1zID0ge30sIHRoaXMudW5pZm9ybXNHcm91cHMgPSBbXSwgdGhpcy52ZXJ0ZXhTaGFkZXIgPSBlQywgdGhpcy5mcmFnbWVudFNoYWRlciA9IGlDLCB0aGlzLmxpbmV3aWR0aCA9IDEsIHRoaXMud2lyZWZyYW1lID0gITEsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gMSwgdGhpcy5mb2cgPSAhMSwgdGhpcy5saWdodHMgPSAhMSwgdGhpcy5jbGlwcGluZyA9ICExLCB0aGlzLmZvcmNlU2luZ2xlUGFzcyA9ICEwLCB0aGlzLmV4dGVuc2lvbnMgPSB7CiAgICAgIGNsaXBDdWxsRGlzdGFuY2U6ICExLAogICAgICAvLyBzZXQgdG8gdXNlIHZlcnRleCBzaGFkZXIgY2xpcHBpbmcKICAgICAgbXVsdGlEcmF3OiAhMQogICAgICAvLyBzZXQgdG8gdXNlIHZlcnRleCBzaGFkZXIgbXVsdGlfZHJhdyAvIGVuYWJsZSBnbF9EcmF3SUQKICAgIH0sIHRoaXMuZGVmYXVsdEF0dHJpYnV0ZVZhbHVlcyA9IHsKICAgICAgY29sb3I6IFsxLCAxLCAxXSwKICAgICAgdXY6IFswLCAwXSwKICAgICAgdXYxOiBbMCwgMF0KICAgIH0sIHRoaXMuaW5kZXgwQXR0cmlidXRlTmFtZSA9IHZvaWQgMCwgdGhpcy51bmlmb3Jtc05lZWRVcGRhdGUgPSAhMSwgdGhpcy5nbHNsVmVyc2lvbiA9IG51bGwsIHQgIT09IHZvaWQgMCAmJiB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5mcmFnbWVudFNoYWRlciA9IHQuZnJhZ21lbnRTaGFkZXIsIHRoaXMudmVydGV4U2hhZGVyID0gdC52ZXJ0ZXhTaGFkZXIsIHRoaXMudW5pZm9ybXMgPSB2Zih0LnVuaWZvcm1zKSwgdGhpcy51bmlmb3Jtc0dyb3VwcyA9IHRDKHQudW5pZm9ybXNHcm91cHMpLCB0aGlzLmRlZmluZXMgPSBPYmplY3QuYXNzaWduKHt9LCB0LmRlZmluZXMpLCB0aGlzLndpcmVmcmFtZSA9IHQud2lyZWZyYW1lLCB0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IHQud2lyZWZyYW1lTGluZXdpZHRoLCB0aGlzLmZvZyA9IHQuZm9nLCB0aGlzLmxpZ2h0cyA9IHQubGlnaHRzLCB0aGlzLmNsaXBwaW5nID0gdC5jbGlwcGluZywgdGhpcy5leHRlbnNpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdC5leHRlbnNpb25zKSwgdGhpcy5nbHNsVmVyc2lvbiA9IHQuZ2xzbFZlcnNpb24sIHRoaXM7CiAgfQogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gc3VwZXIudG9KU09OKHQpOwogICAgZS5nbHNsVmVyc2lvbiA9IHRoaXMuZ2xzbFZlcnNpb24sIGUudW5pZm9ybXMgPSB7fTsKICAgIGZvciAoY29uc3QgbiBpbiB0aGlzLnVuaWZvcm1zKSB7CiAgICAgIGNvbnN0IHIgPSB0aGlzLnVuaWZvcm1zW25dLnZhbHVlOwogICAgICByICYmIHIuaXNUZXh0dXJlID8gZS51bmlmb3Jtc1tuXSA9IHsKICAgICAgICB0eXBlOiAidCIsCiAgICAgICAgdmFsdWU6IHIudG9KU09OKHQpLnV1aWQKICAgICAgfSA6IHIgJiYgci5pc0NvbG9yID8gZS51bmlmb3Jtc1tuXSA9IHsKICAgICAgICB0eXBlOiAiYyIsCiAgICAgICAgdmFsdWU6IHIuZ2V0SGV4KCkKICAgICAgfSA6IHIgJiYgci5pc1ZlY3RvcjIgPyBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHR5cGU6ICJ2MiIsCiAgICAgICAgdmFsdWU6IHIudG9BcnJheSgpCiAgICAgIH0gOiByICYmIHIuaXNWZWN0b3IzID8gZS51bmlmb3Jtc1tuXSA9IHsKICAgICAgICB0eXBlOiAidjMiLAogICAgICAgIHZhbHVlOiByLnRvQXJyYXkoKQogICAgICB9IDogciAmJiByLmlzVmVjdG9yNCA/IGUudW5pZm9ybXNbbl0gPSB7CiAgICAgICAgdHlwZTogInY0IiwKICAgICAgICB2YWx1ZTogci50b0FycmF5KCkKICAgICAgfSA6IHIgJiYgci5pc01hdHJpeDMgPyBlLnVuaWZvcm1zW25dID0gewogICAgICAgIHR5cGU6ICJtMyIsCiAgICAgICAgdmFsdWU6IHIudG9BcnJheSgpCiAgICAgIH0gOiByICYmIHIuaXNNYXRyaXg0ID8gZS51bmlmb3Jtc1tuXSA9IHsKICAgICAgICB0eXBlOiAibTQiLAogICAgICAgIHZhbHVlOiByLnRvQXJyYXkoKQogICAgICB9IDogZS51bmlmb3Jtc1tuXSA9IHsKICAgICAgICB2YWx1ZTogcgogICAgICB9OwogICAgfQogICAgT2JqZWN0LmtleXModGhpcy5kZWZpbmVzKS5sZW5ndGggPiAwICYmIChlLmRlZmluZXMgPSB0aGlzLmRlZmluZXMpLCBlLnZlcnRleFNoYWRlciA9IHRoaXMudmVydGV4U2hhZGVyLCBlLmZyYWdtZW50U2hhZGVyID0gdGhpcy5mcmFnbWVudFNoYWRlciwgZS5saWdodHMgPSB0aGlzLmxpZ2h0cywgZS5jbGlwcGluZyA9IHRoaXMuY2xpcHBpbmc7CiAgICBjb25zdCBpID0ge307CiAgICBmb3IgKGNvbnN0IG4gaW4gdGhpcy5leHRlbnNpb25zKQogICAgICB0aGlzLmV4dGVuc2lvbnNbbl0gPT09ICEwICYmIChpW25dID0gITApOwogICAgcmV0dXJuIE9iamVjdC5rZXlzKGkpLmxlbmd0aCA+IDAgJiYgKGUuZXh0ZW5zaW9ucyA9IGkpLCBlOwogIH0KfQpjb25zdCBzQyA9IGAjZGVmaW5lIFNUQU5EQVJECnZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uOwojaWZkZWYgVVNFX1RSQU5TTUlTU0lPTgoJdmFyeWluZyB2ZWMzIHZXb3JsZFBvc2l0aW9uOwojZW5kaWYKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PgojaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PgojaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD4Kdm9pZCBtYWluKCkgewoJI2luY2x1ZGUgPHV2X3ZlcnRleD4KCSNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhpbnN0YW5jZV92ZXJ0ZXg+CgkjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PgoJI2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD4KCSNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PgoJI2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PgoJI2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+CgkjaW5jbHVkZSA8YmVnaW5fdmVydGV4PgoJI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD4KCSNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+CgkjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD4KCSNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD4KCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+CgkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCXZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6OwoJI2luY2x1ZGUgPHdvcmxkcG9zX3ZlcnRleD4KCSNpbmNsdWRlIDxzaGFkb3dtYXBfdmVydGV4PgoJI2luY2x1ZGUgPGZvZ192ZXJ0ZXg+CiNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OCgl2V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24ueHl6OwojZW5kaWYKfWAsIHJDID0gYCNkZWZpbmUgU1RBTkRBUkQKI2lmZGVmIFBIWVNJQ0FMCgkjZGVmaW5lIElPUgoJI2RlZmluZSBVU0VfU1BFQ1VMQVIKI2VuZGlmCnVuaWZvcm0gdmVjMyBkaWZmdXNlOwp1bmlmb3JtIHZlYzMgZW1pc3NpdmU7CnVuaWZvcm0gZmxvYXQgcm91Z2huZXNzOwp1bmlmb3JtIGZsb2F0IG1ldGFsbmVzczsKdW5pZm9ybSBmbG9hdCBvcGFjaXR5OwojaWZkZWYgSU9SCgl1bmlmb3JtIGZsb2F0IGlvcjsKI2VuZGlmCiNpZmRlZiBVU0VfU1BFQ1VMQVIKCXVuaWZvcm0gZmxvYXQgc3BlY3VsYXJJbnRlbnNpdHk7Cgl1bmlmb3JtIHZlYzMgc3BlY3VsYXJDb2xvcjsKCSNpZmRlZiBVU0VfU1BFQ1VMQVJfQ09MT1JNQVAKCQl1bmlmb3JtIHNhbXBsZXIyRCBzcGVjdWxhckNvbG9yTWFwOwoJI2VuZGlmCgkjaWZkZWYgVVNFX1NQRUNVTEFSX0lOVEVOU0lUWU1BUAoJCXVuaWZvcm0gc2FtcGxlcjJEIHNwZWN1bGFySW50ZW5zaXR5TWFwOwoJI2VuZGlmCiNlbmRpZgojaWZkZWYgVVNFX0NMRUFSQ09BVAoJdW5pZm9ybSBmbG9hdCBjbGVhcmNvYXQ7Cgl1bmlmb3JtIGZsb2F0IGNsZWFyY29hdFJvdWdobmVzczsKI2VuZGlmCiNpZmRlZiBVU0VfRElTUEVSU0lPTgoJdW5pZm9ybSBmbG9hdCBkaXNwZXJzaW9uOwojZW5kaWYKI2lmZGVmIFVTRV9JUklERVNDRU5DRQoJdW5pZm9ybSBmbG9hdCBpcmlkZXNjZW5jZTsKCXVuaWZvcm0gZmxvYXQgaXJpZGVzY2VuY2VJT1I7Cgl1bmlmb3JtIGZsb2F0IGlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bTsKCXVuaWZvcm0gZmxvYXQgaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtOwojZW5kaWYKI2lmZGVmIFVTRV9TSEVFTgoJdW5pZm9ybSB2ZWMzIHNoZWVuQ29sb3I7Cgl1bmlmb3JtIGZsb2F0IHNoZWVuUm91Z2huZXNzOwoJI2lmZGVmIFVTRV9TSEVFTl9DT0xPUk1BUAoJCXVuaWZvcm0gc2FtcGxlcjJEIHNoZWVuQ29sb3JNYXA7CgkjZW5kaWYKCSNpZmRlZiBVU0VfU0hFRU5fUk9VR0hORVNTTUFQCgkJdW5pZm9ybSBzYW1wbGVyMkQgc2hlZW5Sb3VnaG5lc3NNYXA7CgkjZW5kaWYKI2VuZGlmCiNpZmRlZiBVU0VfQU5JU09UUk9QWQoJdW5pZm9ybSB2ZWMyIGFuaXNvdHJvcHlWZWN0b3I7CgkjaWZkZWYgVVNFX0FOSVNPVFJPUFlNQVAKCQl1bmlmb3JtIHNhbXBsZXIyRCBhbmlzb3Ryb3B5TWFwOwoJI2VuZGlmCiNlbmRpZgp2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjsKI2luY2x1ZGUgPGNvbW1vbj4KI2luY2x1ZGUgPHBhY2tpbmc+CiNpbmNsdWRlIDxkaXRoZXJpbmdfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGFvbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsaWdodG1hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW1pc3NpdmVtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGlyaWRlc2NlbmNlX2ZyYWdtZW50PgojaW5jbHVkZSA8Y3ViZV91dl9yZWZsZWN0aW9uX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8ZW52bWFwX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGxpZ2h0c19wYXJzX2JlZ2luPgojaW5jbHVkZSA8bm9ybWFsX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsaWdodHNfcGh5c2ljYWxfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHRyYW5zbWlzc2lvbl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxidW1wbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxub3JtYWxtYXBfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPGNsZWFyY29hdF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8aXJpZGVzY2VuY2VfcGFyc19mcmFnbWVudD4KI2luY2x1ZGUgPHJvdWdobmVzc21hcF9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8bWV0YWxuZXNzbWFwX3BhcnNfZnJhZ21lbnQ+CiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PgojaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+CnZvaWQgbWFpbigpIHsKCXZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApOwoJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCVJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ID0gUmVmbGVjdGVkTGlnaHQoIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApICk7Cgl2ZWMzIHRvdGFsRW1pc3NpdmVSYWRpYW5jZSA9IGVtaXNzaXZlOwoJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PgoJI2luY2x1ZGUgPG1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxhbHBoYXRlc3RfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8YWxwaGFoYXNoX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHJvdWdobmVzc21hcF9mcmFnbWVudD4KCSNpbmNsdWRlIDxtZXRhbG5lc3NtYXBfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X2JlZ2luPgoJI2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGNsZWFyY29hdF9ub3JtYWxfZnJhZ21lbnRfYmVnaW4+CgkjaW5jbHVkZSA8Y2xlYXJjb2F0X25vcm1hbF9mcmFnbWVudF9tYXBzPgoJI2luY2x1ZGUgPGVtaXNzaXZlbWFwX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGxpZ2h0c19waHlzaWNhbF9mcmFnbWVudD4KCSNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfYmVnaW4+CgkjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X21hcHM+CgkjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2VuZD4KCSNpbmNsdWRlIDxhb21hcF9mcmFnbWVudD4KCXZlYzMgdG90YWxEaWZmdXNlID0gcmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArIHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZTsKCXZlYzMgdG90YWxTcGVjdWxhciA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdFNwZWN1bGFyICsgcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3RTcGVjdWxhcjsKCSNpbmNsdWRlIDx0cmFuc21pc3Npb25fZnJhZ21lbnQ+Cgl2ZWMzIG91dGdvaW5nTGlnaHQgPSB0b3RhbERpZmZ1c2UgKyB0b3RhbFNwZWN1bGFyICsgdG90YWxFbWlzc2l2ZVJhZGlhbmNlOwoJI2lmZGVmIFVTRV9TSEVFTgoJCWZsb2F0IHNoZWVuRW5lcmd5Q29tcCA9IDEuMCAtIDAuMTU3ICogbWF4MyggbWF0ZXJpYWwuc2hlZW5Db2xvciApOwoJCW91dGdvaW5nTGlnaHQgPSBvdXRnb2luZ0xpZ2h0ICogc2hlZW5FbmVyZ3lDb21wICsgc2hlZW5TcGVjdWxhckRpcmVjdCArIHNoZWVuU3BlY3VsYXJJbmRpcmVjdDsKCSNlbmRpZgoJI2lmZGVmIFVTRV9DTEVBUkNPQVQKCQlmbG9hdCBkb3ROVmNjID0gc2F0dXJhdGUoIGRvdCggZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGdlb21ldHJ5Vmlld0RpciApICk7CgkJdmVjMyBGY2MgPSBGX1NjaGxpY2soIG1hdGVyaWFsLmNsZWFyY29hdEYwLCBtYXRlcmlhbC5jbGVhcmNvYXRGOTAsIGRvdE5WY2MgKTsKCQlvdXRnb2luZ0xpZ2h0ID0gb3V0Z29pbmdMaWdodCAqICggMS4wIC0gbWF0ZXJpYWwuY2xlYXJjb2F0ICogRmNjICkgKyAoIGNsZWFyY29hdFNwZWN1bGFyRGlyZWN0ICsgY2xlYXJjb2F0U3BlY3VsYXJJbmRpcmVjdCApICogbWF0ZXJpYWwuY2xlYXJjb2F0OwoJI2VuZGlmCgkjaW5jbHVkZSA8b3BhcXVlX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHRvbmVtYXBwaW5nX2ZyYWdtZW50PgoJI2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8Zm9nX2ZyYWdtZW50PgoJI2luY2x1ZGUgPHByZW11bHRpcGxpZWRfYWxwaGFfZnJhZ21lbnQ+CgkjaW5jbHVkZSA8ZGl0aGVyaW5nX2ZyYWdtZW50Pgp9YCwgWWcgPSB7CiAgbWVzaHBoeXNpY2FsX3ZlcnQ6IHNDLAogIG1lc2hwaHlzaWNhbF9mcmFnOiByQwp9LCBzaSA9IHsKICBjb21tb246IHsKICAgIGRpZmZ1c2U6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWkoMTY3NzcyMTUpIH0sCiAgICBvcGFjaXR5OiB7IHZhbHVlOiAxIH0sCiAgICBtYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIG1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICBhbHBoYU1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgYWxwaGFNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9LAogICAgYWxwaGFUZXN0OiB7IHZhbHVlOiAwIH0KICB9LAogIGVudm1hcDogewogICAgZW52TWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBlbnZNYXBSb3RhdGlvbjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICBmbGlwRW52TWFwOiB7IHZhbHVlOiAtMSB9LAogICAgcmVmbGVjdGl2aXR5OiB7IHZhbHVlOiAxIH0sCiAgICAvLyBiYXNpYywgbGFtYmVydCwgcGhvbmcKICAgIGlvcjogeyB2YWx1ZTogMS41IH0sCiAgICAvLyBwaHlzaWNhbAogICAgcmVmcmFjdGlvblJhdGlvOiB7IHZhbHVlOiAwLjk4IH0KICAgIC8vIGJhc2ljLCBsYW1iZXJ0LCBwaG9uZwogIH0sCiAgYW9tYXA6IHsKICAgIGFvTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBhb01hcEludGVuc2l0eTogeyB2YWx1ZTogMSB9LAogICAgYW9NYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9CiAgfSwKICBsaWdodG1hcDogewogICAgbGlnaHRNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGxpZ2h0TWFwSW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0sCiAgICBsaWdodE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0KICB9LAogIGJ1bXBtYXA6IHsKICAgIGJ1bXBNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGJ1bXBNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9LAogICAgYnVtcFNjYWxlOiB7IHZhbHVlOiAxIH0KICB9LAogIG5vcm1hbG1hcDogewogICAgbm9ybWFsTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICBub3JtYWxNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9LAogICAgbm9ybWFsU2NhbGU6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgX2koMSwgMSkgfQogIH0sCiAgZGlzcGxhY2VtZW50bWFwOiB7CiAgICBkaXNwbGFjZW1lbnRNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGRpc3BsYWNlbWVudE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICBkaXNwbGFjZW1lbnRTY2FsZTogeyB2YWx1ZTogMSB9LAogICAgZGlzcGxhY2VtZW50QmlhczogeyB2YWx1ZTogMCB9CiAgfSwKICBlbWlzc2l2ZW1hcDogewogICAgZW1pc3NpdmVNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIGVtaXNzaXZlTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkgfQogIH0sCiAgbWV0YWxuZXNzbWFwOiB7CiAgICBtZXRhbG5lc3NNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgIG1ldGFsbmVzc01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0KICB9LAogIHJvdWdobmVzc21hcDogewogICAgcm91Z2huZXNzTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICByb3VnaG5lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9CiAgfSwKICBmb2c6IHsKICAgIGZvZ0RlbnNpdHk6IHsgdmFsdWU6IDI1ZS01IH0sCiAgICBmb2dOZWFyOiB7IHZhbHVlOiAxIH0sCiAgICBmb2dGYXI6IHsgdmFsdWU6IDJlMyB9LAogICAgZm9nQ29sb3I6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWkoMTY3NzcyMTUpIH0KICB9LAogIGxpZ2h0czogewogICAgYW1iaWVudExpZ2h0Q29sb3I6IHsgdmFsdWU6IFtdIH0sCiAgICBsaWdodFByb2JlOiB7IHZhbHVlOiBbXSB9LAogICAgZGlyZWN0aW9uYWxMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIGRpcmVjdGlvbjoge30sCiAgICAgIGNvbG9yOiB7fQogICAgfSB9LAogICAgZGlyZWN0aW9uYWxMaWdodFNoYWRvd3M6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIHNoYWRvd0ludGVuc2l0eTogMSwKICAgICAgc2hhZG93Qmlhczoge30sCiAgICAgIHNoYWRvd05vcm1hbEJpYXM6IHt9LAogICAgICBzaGFkb3dSYWRpdXM6IHt9LAogICAgICBzaGFkb3dNYXBTaXplOiB7fQogICAgfSB9LAogICAgZGlyZWN0aW9uYWxTaGFkb3dNYXA6IHsgdmFsdWU6IFtdIH0sCiAgICBkaXJlY3Rpb25hbFNoYWRvd01hdHJpeDogeyB2YWx1ZTogW10gfSwKICAgIHNwb3RMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIGNvbG9yOiB7fSwKICAgICAgcG9zaXRpb246IHt9LAogICAgICBkaXJlY3Rpb246IHt9LAogICAgICBkaXN0YW5jZToge30sCiAgICAgIGNvbmVDb3M6IHt9LAogICAgICBwZW51bWJyYUNvczoge30sCiAgICAgIGRlY2F5OiB7fQogICAgfSB9LAogICAgc3BvdExpZ2h0U2hhZG93czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKICAgICAgc2hhZG93SW50ZW5zaXR5OiAxLAogICAgICBzaGFkb3dCaWFzOiB7fSwKICAgICAgc2hhZG93Tm9ybWFsQmlhczoge30sCiAgICAgIHNoYWRvd1JhZGl1czoge30sCiAgICAgIHNoYWRvd01hcFNpemU6IHt9CiAgICB9IH0sCiAgICBzcG90TGlnaHRNYXA6IHsgdmFsdWU6IFtdIH0sCiAgICBzcG90U2hhZG93TWFwOiB7IHZhbHVlOiBbXSB9LAogICAgc3BvdExpZ2h0TWF0cml4OiB7IHZhbHVlOiBbXSB9LAogICAgcG9pbnRMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIGNvbG9yOiB7fSwKICAgICAgcG9zaXRpb246IHt9LAogICAgICBkZWNheToge30sCiAgICAgIGRpc3RhbmNlOiB7fQogICAgfSB9LAogICAgcG9pbnRMaWdodFNoYWRvd3M6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIHNoYWRvd0ludGVuc2l0eTogMSwKICAgICAgc2hhZG93Qmlhczoge30sCiAgICAgIHNoYWRvd05vcm1hbEJpYXM6IHt9LAogICAgICBzaGFkb3dSYWRpdXM6IHt9LAogICAgICBzaGFkb3dNYXBTaXplOiB7fSwKICAgICAgc2hhZG93Q2FtZXJhTmVhcjoge30sCiAgICAgIHNoYWRvd0NhbWVyYUZhcjoge30KICAgIH0gfSwKICAgIHBvaW50U2hhZG93TWFwOiB7IHZhbHVlOiBbXSB9LAogICAgcG9pbnRTaGFkb3dNYXRyaXg6IHsgdmFsdWU6IFtdIH0sCiAgICBoZW1pc3BoZXJlTGlnaHRzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewogICAgICBkaXJlY3Rpb246IHt9LAogICAgICBza3lDb2xvcjoge30sCiAgICAgIGdyb3VuZENvbG9yOiB7fQogICAgfSB9LAogICAgLy8gVE9ETyAoYWJlbG5hdGlvbik6IFJlY3RBcmVhTGlnaHQgQlJERiBkYXRhIG5lZWRzIHRvIGJlIG1vdmVkIGZyb20gZXhhbXBsZSB0byBtYWluIHNyYwogICAgcmVjdEFyZWFMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CiAgICAgIGNvbG9yOiB7fSwKICAgICAgcG9zaXRpb246IHt9LAogICAgICB3aWR0aDoge30sCiAgICAgIGhlaWdodDoge30KICAgIH0gfSwKICAgIGx0Y18xOiB7IHZhbHVlOiBudWxsIH0sCiAgICBsdGNfMjogeyB2YWx1ZTogbnVsbCB9CiAgfQp9LCBjYSA9IHsKICBzdGFuZGFyZDogewogICAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBiZihbCiAgICAgIHNpLmNvbW1vbiwKICAgICAgc2kuZW52bWFwLAogICAgICBzaS5hb21hcCwKICAgICAgc2kubGlnaHRtYXAsCiAgICAgIHNpLmVtaXNzaXZlbWFwLAogICAgICBzaS5idW1wbWFwLAogICAgICBzaS5ub3JtYWxtYXAsCiAgICAgIHNpLmRpc3BsYWNlbWVudG1hcCwKICAgICAgc2kucm91Z2huZXNzbWFwLAogICAgICBzaS5tZXRhbG5lc3NtYXAsCiAgICAgIHNpLmZvZywKICAgICAgc2kubGlnaHRzLAogICAgICB7CiAgICAgICAgZW1pc3NpdmU6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWkoMCkgfSwKICAgICAgICByb3VnaG5lc3M6IHsgdmFsdWU6IDEgfSwKICAgICAgICBtZXRhbG5lc3M6IHsgdmFsdWU6IDAgfSwKICAgICAgICBlbnZNYXBJbnRlbnNpdHk6IHsgdmFsdWU6IDEgfQogICAgICB9CiAgICBdKQogIH0KfTsKY2EucGh5c2ljYWwgPSB7CiAgdW5pZm9ybXM6IC8qIEBfX1BVUkVfXyAqLyBiZihbCiAgICBjYS5zdGFuZGFyZC51bmlmb3JtcywKICAgIHsKICAgICAgY2xlYXJjb2F0OiB7IHZhbHVlOiAwIH0sCiAgICAgIGNsZWFyY29hdE1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBjbGVhcmNvYXRNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9LAogICAgICBjbGVhcmNvYXROb3JtYWxNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgY2xlYXJjb2F0Tm9ybWFsTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkgfSwKICAgICAgY2xlYXJjb2F0Tm9ybWFsU2NhbGU6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgX2koMSwgMSkgfSwKICAgICAgY2xlYXJjb2F0Um91Z2huZXNzOiB7IHZhbHVlOiAwIH0sCiAgICAgIGNsZWFyY29hdFJvdWdobmVzc01hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBjbGVhcmNvYXRSb3VnaG5lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9LAogICAgICBkaXNwZXJzaW9uOiB7IHZhbHVlOiAwIH0sCiAgICAgIGlyaWRlc2NlbmNlOiB7IHZhbHVlOiAwIH0sCiAgICAgIGlyaWRlc2NlbmNlTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIGlyaWRlc2NlbmNlTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkgfSwKICAgICAgaXJpZGVzY2VuY2VJT1I6IHsgdmFsdWU6IDEuMyB9LAogICAgICBpcmlkZXNjZW5jZVRoaWNrbmVzc01pbmltdW06IHsgdmFsdWU6IDEwMCB9LAogICAgICBpcmlkZXNjZW5jZVRoaWNrbmVzc01heGltdW06IHsgdmFsdWU6IDQwMCB9LAogICAgICBpcmlkZXNjZW5jZVRoaWNrbmVzc01hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBpcmlkZXNjZW5jZVRoaWNrbmVzc01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICAgIHNoZWVuOiB7IHZhbHVlOiAwIH0sCiAgICAgIHNoZWVuQ29sb3I6IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgQWkoMCkgfSwKICAgICAgc2hlZW5Db2xvck1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICBzaGVlbkNvbG9yTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkgfSwKICAgICAgc2hlZW5Sb3VnaG5lc3M6IHsgdmFsdWU6IDEgfSwKICAgICAgc2hlZW5Sb3VnaG5lc3NNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgc2hlZW5Sb3VnaG5lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgZGUoKSB9LAogICAgICB0cmFuc21pc3Npb246IHsgdmFsdWU6IDAgfSwKICAgICAgdHJhbnNtaXNzaW9uTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHRyYW5zbWlzc2lvbk1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICAgIHRyYW5zbWlzc2lvblNhbXBsZXJTaXplOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IF9pKCkgfSwKICAgICAgdHJhbnNtaXNzaW9uU2FtcGxlck1hcDogeyB2YWx1ZTogbnVsbCB9LAogICAgICB0aGlja25lc3M6IHsgdmFsdWU6IDAgfSwKICAgICAgdGhpY2tuZXNzTWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHRoaWNrbmVzc01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICAgIGF0dGVudWF0aW9uRGlzdGFuY2U6IHsgdmFsdWU6IDAgfSwKICAgICAgYXR0ZW51YXRpb25Db2xvcjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBBaSgwKSB9LAogICAgICBzcGVjdWxhckNvbG9yOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IEFpKDEsIDEsIDEpIH0sCiAgICAgIHNwZWN1bGFyQ29sb3JNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgc3BlY3VsYXJDb2xvck1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0sCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0sCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5TWFwOiB7IHZhbHVlOiBudWxsIH0sCiAgICAgIHNwZWN1bGFySW50ZW5zaXR5TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKiBAX19QVVJFX18gKi8gbmV3IGRlKCkgfSwKICAgICAgYW5pc290cm9weVZlY3RvcjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBfaSgpIH0sCiAgICAgIGFuaXNvdHJvcHlNYXA6IHsgdmFsdWU6IG51bGwgfSwKICAgICAgYW5pc290cm9weU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBkZSgpIH0KICAgIH0KICBdKSwKICB2ZXJ0ZXhTaGFkZXI6IFlnLm1lc2hwaHlzaWNhbF92ZXJ0LAogIGZyYWdtZW50U2hhZGVyOiBZZy5tZXNocGh5c2ljYWxfZnJhZwp9OwpsZXQgYUMgPSBjbGFzcyBleHRlbmRzIERhIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNHcm91cCA9ICEwLCB0aGlzLnR5cGUgPSAiR3JvdXAiOwogIH0KfTsKY2xhc3Mgb0MgewogIGNvbnN0cnVjdG9yKHQsIGUpIHsKICAgIHRoaXMuaXNJbnRlcmxlYXZlZEJ1ZmZlciA9ICEwLCB0aGlzLmFycmF5ID0gdCwgdGhpcy5zdHJpZGUgPSBlLCB0aGlzLmNvdW50ID0gdCAhPT0gdm9pZCAwID8gdC5sZW5ndGggLyBlIDogMCwgdGhpcy51c2FnZSA9IHhwLCB0aGlzLnVwZGF0ZVJhbmdlcyA9IFtdLCB0aGlzLnZlcnNpb24gPSAwLCB0aGlzLnV1aWQgPSBKbigpOwogIH0KICBvblVwbG9hZENhbGxiYWNrKCkgewogIH0KICBzZXQgbmVlZHNVcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgdGhpcy52ZXJzaW9uKys7CiAgfQogIHNldFVzYWdlKHQpIHsKICAgIHJldHVybiB0aGlzLnVzYWdlID0gdCwgdGhpczsKICB9CiAgYWRkVXBkYXRlUmFuZ2UodCwgZSkgewogICAgdGhpcy51cGRhdGVSYW5nZXMucHVzaCh7IHN0YXJ0OiB0LCBjb3VudDogZSB9KTsKICB9CiAgY2xlYXJVcGRhdGVSYW5nZXMoKSB7CiAgICB0aGlzLnVwZGF0ZVJhbmdlcy5sZW5ndGggPSAwOwogIH0KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLmFycmF5ID0gbmV3IHQuYXJyYXkuY29uc3RydWN0b3IodC5hcnJheSksIHRoaXMuY291bnQgPSB0LmNvdW50LCB0aGlzLnN0cmlkZSA9IHQuc3RyaWRlLCB0aGlzLnVzYWdlID0gdC51c2FnZSwgdGhpczsKICB9CiAgY29weUF0KHQsIGUsIGkpIHsKICAgIHQgKj0gdGhpcy5zdHJpZGUsIGkgKj0gZS5zdHJpZGU7CiAgICBmb3IgKGxldCBuID0gMCwgcyA9IHRoaXMuc3RyaWRlOyBuIDwgczsgbisrKQogICAgICB0aGlzLmFycmF5W3QgKyBuXSA9IGUuYXJyYXlbaSArIG5dOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldCh0LCBlID0gMCkgewogICAgcmV0dXJuIHRoaXMuYXJyYXkuc2V0KHQsIGUpLCB0aGlzOwogIH0KICBjbG9uZSh0KSB7CiAgICB0LmFycmF5QnVmZmVycyA9PT0gdm9pZCAwICYmICh0LmFycmF5QnVmZmVycyA9IHt9KSwgdGhpcy5hcnJheS5idWZmZXIuX3V1aWQgPT09IHZvaWQgMCAmJiAodGhpcy5hcnJheS5idWZmZXIuX3V1aWQgPSBKbigpKSwgdC5hcnJheUJ1ZmZlcnNbdGhpcy5hcnJheS5idWZmZXIuX3V1aWRdID09PSB2b2lkIDAgJiYgKHQuYXJyYXlCdWZmZXJzW3RoaXMuYXJyYXkuYnVmZmVyLl91dWlkXSA9IHRoaXMuYXJyYXkuc2xpY2UoMCkuYnVmZmVyKTsKICAgIGNvbnN0IGUgPSBuZXcgdGhpcy5hcnJheS5jb25zdHJ1Y3Rvcih0LmFycmF5QnVmZmVyc1t0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZF0pLCBpID0gbmV3IHRoaXMuY29uc3RydWN0b3IoZSwgdGhpcy5zdHJpZGUpOwogICAgcmV0dXJuIGkuc2V0VXNhZ2UodGhpcy51c2FnZSksIGk7CiAgfQogIG9uVXBsb2FkKHQpIHsKICAgIHJldHVybiB0aGlzLm9uVXBsb2FkQ2FsbGJhY2sgPSB0LCB0aGlzOwogIH0KICB0b0pTT04odCkgewogICAgcmV0dXJuIHQuYXJyYXlCdWZmZXJzID09PSB2b2lkIDAgJiYgKHQuYXJyYXlCdWZmZXJzID0ge30pLCB0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCA9PT0gdm9pZCAwICYmICh0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCA9IEpuKCkpLCB0LmFycmF5QnVmZmVyc1t0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZF0gPT09IHZvaWQgMCAmJiAodC5hcnJheUJ1ZmZlcnNbdGhpcy5hcnJheS5idWZmZXIuX3V1aWRdID0gQXJyYXkuZnJvbShuZXcgVWludDMyQXJyYXkodGhpcy5hcnJheS5idWZmZXIpKSksIHsKICAgICAgdXVpZDogdGhpcy51dWlkLAogICAgICBidWZmZXI6IHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkLAogICAgICB0eXBlOiB0aGlzLmFycmF5LmNvbnN0cnVjdG9yLm5hbWUsCiAgICAgIHN0cmlkZTogdGhpcy5zdHJpZGUKICAgIH07CiAgfQp9CmNvbnN0IGRpID0gLyogQF9fUFVSRV9fICovIG5ldyB0dCgpOwpjbGFzcyBTcyB7CiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiA9ICExKSB7CiAgICB0aGlzLmlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUgPSAhMCwgdGhpcy5uYW1lID0gIiIsIHRoaXMuZGF0YSA9IHQsIHRoaXMuaXRlbVNpemUgPSBlLCB0aGlzLm9mZnNldCA9IGksIHRoaXMubm9ybWFsaXplZCA9IG47CiAgfQogIGdldCBjb3VudCgpIHsKICAgIHJldHVybiB0aGlzLmRhdGEuY291bnQ7CiAgfQogIGdldCBhcnJheSgpIHsKICAgIHJldHVybiB0aGlzLmRhdGEuYXJyYXk7CiAgfQogIHNldCBuZWVkc1VwZGF0ZSh0KSB7CiAgICB0aGlzLmRhdGEubmVlZHNVcGRhdGUgPSB0OwogIH0KICBhcHBseU1hdHJpeDQodCkgewogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0aGlzLmRhdGEuY291bnQ7IGUgPCBpOyBlKyspCiAgICAgIGRpLmZyb21CdWZmZXJBdHRyaWJ1dGUodGhpcywgZSksIGRpLmFwcGx5TWF0cml4NCh0KSwgdGhpcy5zZXRYWVooZSwgZGkueCwgZGkueSwgZGkueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXBwbHlOb3JtYWxNYXRyaXgodCkgewogICAgZm9yIChsZXQgZSA9IDAsIGkgPSB0aGlzLmNvdW50OyBlIDwgaTsgZSsrKQogICAgICBkaS5mcm9tQnVmZmVyQXR0cmlidXRlKHRoaXMsIGUpLCBkaS5hcHBseU5vcm1hbE1hdHJpeCh0KSwgdGhpcy5zZXRYWVooZSwgZGkueCwgZGkueSwgZGkueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdHJhbnNmb3JtRGlyZWN0aW9uKHQpIHsKICAgIGZvciAobGV0IGUgPSAwLCBpID0gdGhpcy5jb3VudDsgZSA8IGk7IGUrKykKICAgICAgZGkuZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0aGlzLCBlKSwgZGkudHJhbnNmb3JtRGlyZWN0aW9uKHQpLCB0aGlzLnNldFhZWihlLCBkaS54LCBkaS55LCBkaS56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBnZXRDb21wb25lbnQodCwgZSkgewogICAgbGV0IGkgPSB0aGlzLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgKyBlXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGkgPSBobihpLCB0aGlzLmFycmF5KSksIGk7CiAgfQogIHNldENvbXBvbmVudCh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChpID0gdWUoaSwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIGVdID0gaSwgdGhpczsKICB9CiAgc2V0WCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gdWUoZSwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldF0gPSBlLCB0aGlzOwogIH0KICBzZXRZKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSksIHRoaXMuZGF0YS5hcnJheVt0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgMV0gPSBlLCB0aGlzOwogIH0KICBzZXRaKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSksIHRoaXMuZGF0YS5hcnJheVt0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgMl0gPSBlLCB0aGlzOwogIH0KICBzZXRXKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSksIHRoaXMuZGF0YS5hcnJheVt0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgM10gPSBlLCB0aGlzOwogIH0KICBnZXRYKHQpIHsKICAgIGxldCBlID0gdGhpcy5kYXRhLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXRdOwogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IGhuKGUsIHRoaXMuYXJyYXkpKSwgZTsKICB9CiAgZ2V0WSh0KSB7CiAgICBsZXQgZSA9IHRoaXMuZGF0YS5hcnJheVt0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgMV07CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkICYmIChlID0gaG4oZSwgdGhpcy5hcnJheSkpLCBlOwogIH0KICBnZXRaKHQpIHsKICAgIGxldCBlID0gdGhpcy5kYXRhLmFycmF5W3QgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgKyAyXTsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSBobihlLCB0aGlzLmFycmF5KSksIGU7CiAgfQogIGdldFcodCkgewogICAgbGV0IGUgPSB0aGlzLmRhdGEuYXJyYXlbdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDNdOwogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplZCAmJiAoZSA9IGhuKGUsIHRoaXMuYXJyYXkpKSwgZTsKICB9CiAgc2V0WFkodCwgZSwgaSkgewogICAgcmV0dXJuIHQgPSB0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0LCB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSwgaSA9IHVlKGksIHRoaXMuYXJyYXkpKSwgdGhpcy5kYXRhLmFycmF5W3QgKyAwXSA9IGUsIHRoaXMuZGF0YS5hcnJheVt0ICsgMV0gPSBpLCB0aGlzOwogIH0KICBzZXRYWVoodCwgZSwgaSwgbikgewogICAgcmV0dXJuIHQgPSB0ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0LCB0aGlzLm5vcm1hbGl6ZWQgJiYgKGUgPSB1ZShlLCB0aGlzLmFycmF5KSwgaSA9IHVlKGksIHRoaXMuYXJyYXkpLCBuID0gdWUobiwgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5kYXRhLmFycmF5W3QgKyAxXSA9IGksIHRoaXMuZGF0YS5hcnJheVt0ICsgMl0gPSBuLCB0aGlzOwogIH0KICBzZXRYWVpXKHQsIGUsIGksIG4sIHMpIHsKICAgIHJldHVybiB0ID0gdCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCwgdGhpcy5ub3JtYWxpemVkICYmIChlID0gdWUoZSwgdGhpcy5hcnJheSksIGkgPSB1ZShpLCB0aGlzLmFycmF5KSwgbiA9IHVlKG4sIHRoaXMuYXJyYXkpLCBzID0gdWUocywgdGhpcy5hcnJheSkpLCB0aGlzLmRhdGEuYXJyYXlbdCArIDBdID0gZSwgdGhpcy5kYXRhLmFycmF5W3QgKyAxXSA9IGksIHRoaXMuZGF0YS5hcnJheVt0ICsgMl0gPSBuLCB0aGlzLmRhdGEuYXJyYXlbdCArIDNdID0gcywgdGhpczsKICB9CiAgY2xvbmUodCkgewogICAgaWYgKHQgPT09IHZvaWQgMCkgewogICAgICBjb25zb2xlLmxvZygiVEhSRUUuSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUuY2xvbmUoKTogQ2xvbmluZyBhbiBpbnRlcmxlYXZlZCBidWZmZXIgYXR0cmlidXRlIHdpbGwgZGUtaW50ZXJsZWF2ZSBidWZmZXIgZGF0YS4iKTsKICAgICAgY29uc3QgZSA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY291bnQ7IGkrKykgewogICAgICAgIGNvbnN0IG4gPSBpICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0OwogICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgdGhpcy5pdGVtU2l6ZTsgcysrKQogICAgICAgICAgZS5wdXNoKHRoaXMuZGF0YS5hcnJheVtuICsgc10pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgcWkobmV3IHRoaXMuYXJyYXkuY29uc3RydWN0b3IoZSksIHRoaXMuaXRlbVNpemUsIHRoaXMubm9ybWFsaXplZCk7CiAgICB9IGVsc2UKICAgICAgcmV0dXJuIHQuaW50ZXJsZWF2ZWRCdWZmZXJzID09PSB2b2lkIDAgJiYgKHQuaW50ZXJsZWF2ZWRCdWZmZXJzID0ge30pLCB0LmludGVybGVhdmVkQnVmZmVyc1t0aGlzLmRhdGEudXVpZF0gPT09IHZvaWQgMCAmJiAodC5pbnRlcmxlYXZlZEJ1ZmZlcnNbdGhpcy5kYXRhLnV1aWRdID0gdGhpcy5kYXRhLmNsb25lKHQpKSwgbmV3IFNzKHQuaW50ZXJsZWF2ZWRCdWZmZXJzW3RoaXMuZGF0YS51dWlkXSwgdGhpcy5pdGVtU2l6ZSwgdGhpcy5vZmZzZXQsIHRoaXMubm9ybWFsaXplZCk7CiAgfQogIHRvSlNPTih0KSB7CiAgICBpZiAodCA9PT0gdm9pZCAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJUSFJFRS5JbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZS50b0pTT04oKTogU2VyaWFsaXppbmcgYW4gaW50ZXJsZWF2ZWQgYnVmZmVyIGF0dHJpYnV0ZSB3aWxsIGRlLWludGVybGVhdmUgYnVmZmVyIGRhdGEuIik7CiAgICAgIGNvbnN0IGUgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvdW50OyBpKyspIHsKICAgICAgICBjb25zdCBuID0gaSAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldDsKICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHRoaXMuaXRlbVNpemU7IHMrKykKICAgICAgICAgIGUucHVzaCh0aGlzLmRhdGEuYXJyYXlbbiArIHNdKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGl0ZW1TaXplOiB0aGlzLml0ZW1TaXplLAogICAgICAgIHR5cGU6IHRoaXMuYXJyYXkuY29uc3RydWN0b3IubmFtZSwKICAgICAgICBhcnJheTogZSwKICAgICAgICBub3JtYWxpemVkOiB0aGlzLm5vcm1hbGl6ZWQKICAgICAgfTsKICAgIH0gZWxzZQogICAgICByZXR1cm4gdC5pbnRlcmxlYXZlZEJ1ZmZlcnMgPT09IHZvaWQgMCAmJiAodC5pbnRlcmxlYXZlZEJ1ZmZlcnMgPSB7fSksIHQuaW50ZXJsZWF2ZWRCdWZmZXJzW3RoaXMuZGF0YS51dWlkXSA9PT0gdm9pZCAwICYmICh0LmludGVybGVhdmVkQnVmZmVyc1t0aGlzLmRhdGEudXVpZF0gPSB0aGlzLmRhdGEudG9KU09OKHQpKSwgewogICAgICAgIGlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGU6ICEwLAogICAgICAgIGl0ZW1TaXplOiB0aGlzLml0ZW1TaXplLAogICAgICAgIGRhdGE6IHRoaXMuZGF0YS51dWlkLAogICAgICAgIG9mZnNldDogdGhpcy5vZmZzZXQsCiAgICAgICAgbm9ybWFsaXplZDogdGhpcy5ub3JtYWxpemVkCiAgICAgIH07CiAgfQp9CmNsYXNzIGxDIGV4dGVuZHMgRmEgewogIGNvbnN0cnVjdG9yKHQgPSBudWxsKSB7CiAgICBpZiAoc3VwZXIoKSwgdGhpcy50eXBlID0gIldpcmVmcmFtZUdlb21ldHJ5IiwgdGhpcy5wYXJhbWV0ZXJzID0gewogICAgICBnZW9tZXRyeTogdAogICAgfSwgdCAhPT0gbnVsbCkgewogICAgICBjb25zdCBlID0gW10sIGkgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLCBuID0gbmV3IHR0KCksIHMgPSBuZXcgdHQoKTsKICAgICAgaWYgKHQuaW5kZXggIT09IG51bGwpIHsKICAgICAgICBjb25zdCByID0gdC5hdHRyaWJ1dGVzLnBvc2l0aW9uLCBvID0gdC5pbmRleDsKICAgICAgICBsZXQgbCA9IHQuZ3JvdXBzOwogICAgICAgIGwubGVuZ3RoID09PSAwICYmIChsID0gW3sgc3RhcnQ6IDAsIGNvdW50OiBvLmNvdW50LCBtYXRlcmlhbEluZGV4OiAwIH1dKTsKICAgICAgICBmb3IgKGxldCBoID0gMCwgYyA9IGwubGVuZ3RoOyBoIDwgYzsgKytoKSB7CiAgICAgICAgICBjb25zdCB1ID0gbFtoXSwgZCA9IHUuc3RhcnQsIHAgPSB1LmNvdW50OwogICAgICAgICAgZm9yIChsZXQgZiA9IGQsIHkgPSBkICsgcDsgZiA8IHk7IGYgKz0gMykKICAgICAgICAgICAgZm9yIChsZXQgZyA9IDA7IGcgPCAzOyBnKyspIHsKICAgICAgICAgICAgICBjb25zdCBtID0gby5nZXRYKGYgKyBnKSwgdiA9IG8uZ2V0WChmICsgKGcgKyAxKSAlIDMpOwogICAgICAgICAgICAgIG4uZnJvbUJ1ZmZlckF0dHJpYnV0ZShyLCBtKSwgcy5mcm9tQnVmZmVyQXR0cmlidXRlKHIsIHYpLCBaZyhuLCBzLCBpKSA9PT0gITAgJiYgKGUucHVzaChuLngsIG4ueSwgbi56KSwgZS5wdXNoKHMueCwgcy55LCBzLnopKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCByID0gdC5hdHRyaWJ1dGVzLnBvc2l0aW9uOwogICAgICAgIGZvciAobGV0IG8gPSAwLCBsID0gci5jb3VudCAvIDM7IG8gPCBsOyBvKyspCiAgICAgICAgICBmb3IgKGxldCBoID0gMDsgaCA8IDM7IGgrKykgewogICAgICAgICAgICBjb25zdCBjID0gMyAqIG8gKyBoLCB1ID0gMyAqIG8gKyAoaCArIDEpICUgMzsKICAgICAgICAgICAgbi5mcm9tQnVmZmVyQXR0cmlidXRlKHIsIGMpLCBzLmZyb21CdWZmZXJBdHRyaWJ1dGUociwgdSksIFpnKG4sIHMsIGkpID09PSAhMCAmJiAoZS5wdXNoKG4ueCwgbi55LCBuLnopLCBlLnB1c2gocy54LCBzLnksIHMueikpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3YyhlLCAzKSk7CiAgICB9CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHN1cGVyLmNvcHkodCksIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHQucGFyYW1ldGVycyksIHRoaXM7CiAgfQp9CmZ1bmN0aW9uIFpnKGEsIHQsIGUpIHsKICBjb25zdCBpID0gYCR7YS54fSwke2EueX0sJHthLnp9LSR7dC54fSwke3QueX0sJHt0Lnp9YCwgbiA9IGAke3QueH0sJHt0Lnl9LCR7dC56fS0ke2EueH0sJHthLnl9LCR7YS56fWA7CiAgcmV0dXJuIGUuaGFzKGkpID09PSAhMCB8fCBlLmhhcyhuKSA9PT0gITAgPyAhMSA6IChlLmFkZChpKSwgZS5hZGQobiksICEwKTsKfQpjbGFzcyBoQyBleHRlbmRzIHhmIHsKICBzdGF0aWMgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gIk1lc2hTdGFuZGFyZE1hdGVyaWFsIjsKICB9CiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoKSwgdGhpcy5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID0gITAsIHRoaXMuZGVmaW5lcyA9IHsgU1RBTkRBUkQ6ICIiIH0sIHRoaXMuY29sb3IgPSBuZXcgQWkoMTY3NzcyMTUpLCB0aGlzLnJvdWdobmVzcyA9IDEsIHRoaXMubWV0YWxuZXNzID0gMCwgdGhpcy5tYXAgPSBudWxsLCB0aGlzLmxpZ2h0TWFwID0gbnVsbCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IDEsIHRoaXMuYW9NYXAgPSBudWxsLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gMSwgdGhpcy5lbWlzc2l2ZSA9IG5ldyBBaSgwKSwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IDEsIHRoaXMuZW1pc3NpdmVNYXAgPSBudWxsLCB0aGlzLmJ1bXBNYXAgPSBudWxsLCB0aGlzLmJ1bXBTY2FsZSA9IDEsIHRoaXMubm9ybWFsTWFwID0gbnVsbCwgdGhpcy5ub3JtYWxNYXBUeXBlID0geVQsIHRoaXMubm9ybWFsU2NhbGUgPSBuZXcgX2koMSwgMSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gbnVsbCwgdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IDEsIHRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDAsIHRoaXMucm91Z2huZXNzTWFwID0gbnVsbCwgdGhpcy5tZXRhbG5lc3NNYXAgPSBudWxsLCB0aGlzLmFscGhhTWFwID0gbnVsbCwgdGhpcy5lbnZNYXAgPSBudWxsLCB0aGlzLmVudk1hcFJvdGF0aW9uID0gbmV3IGR1KCksIHRoaXMuZW52TWFwSW50ZW5zaXR5ID0gMSwgdGhpcy53aXJlZnJhbWUgPSAhMSwgdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxLCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAicm91bmQiLCB0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gInJvdW5kIiwgdGhpcy5mbGF0U2hhZGluZyA9ICExLCB0aGlzLmZvZyA9ICEwLCB0aGlzLnNldFZhbHVlcyh0KTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5kZWZpbmVzID0geyBTVEFOREFSRDogIiIgfSwgdGhpcy5jb2xvci5jb3B5KHQuY29sb3IpLCB0aGlzLnJvdWdobmVzcyA9IHQucm91Z2huZXNzLCB0aGlzLm1ldGFsbmVzcyA9IHQubWV0YWxuZXNzLCB0aGlzLm1hcCA9IHQubWFwLCB0aGlzLmxpZ2h0TWFwID0gdC5saWdodE1hcCwgdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHQubGlnaHRNYXBJbnRlbnNpdHksIHRoaXMuYW9NYXAgPSB0LmFvTWFwLCB0aGlzLmFvTWFwSW50ZW5zaXR5ID0gdC5hb01hcEludGVuc2l0eSwgdGhpcy5lbWlzc2l2ZS5jb3B5KHQuZW1pc3NpdmUpLCB0aGlzLmVtaXNzaXZlTWFwID0gdC5lbWlzc2l2ZU1hcCwgdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IHQuZW1pc3NpdmVJbnRlbnNpdHksIHRoaXMuYnVtcE1hcCA9IHQuYnVtcE1hcCwgdGhpcy5idW1wU2NhbGUgPSB0LmJ1bXBTY2FsZSwgdGhpcy5ub3JtYWxNYXAgPSB0Lm5vcm1hbE1hcCwgdGhpcy5ub3JtYWxNYXBUeXBlID0gdC5ub3JtYWxNYXBUeXBlLCB0aGlzLm5vcm1hbFNjYWxlLmNvcHkodC5ub3JtYWxTY2FsZSksIHRoaXMuZGlzcGxhY2VtZW50TWFwID0gdC5kaXNwbGFjZW1lbnRNYXAsIHRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSB0LmRpc3BsYWNlbWVudFNjYWxlLCB0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSB0LmRpc3BsYWNlbWVudEJpYXMsIHRoaXMucm91Z2huZXNzTWFwID0gdC5yb3VnaG5lc3NNYXAsIHRoaXMubWV0YWxuZXNzTWFwID0gdC5tZXRhbG5lc3NNYXAsIHRoaXMuYWxwaGFNYXAgPSB0LmFscGhhTWFwLCB0aGlzLmVudk1hcCA9IHQuZW52TWFwLCB0aGlzLmVudk1hcFJvdGF0aW9uLmNvcHkodC5lbnZNYXBSb3RhdGlvbiksIHRoaXMuZW52TWFwSW50ZW5zaXR5ID0gdC5lbnZNYXBJbnRlbnNpdHksIHRoaXMud2lyZWZyYW1lID0gdC53aXJlZnJhbWUsIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gdC53aXJlZnJhbWVMaW5ld2lkdGgsIHRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHQud2lyZWZyYW1lTGluZWNhcCwgdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHQud2lyZWZyYW1lTGluZWpvaW4sIHRoaXMuZmxhdFNoYWRpbmcgPSB0LmZsYXRTaGFkaW5nLCB0aGlzLmZvZyA9IHQuZm9nLCB0aGlzOwogIH0KfQpjbGFzcyBjQyBleHRlbmRzIEZhIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCksIHRoaXMuaXNJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSA9ICEwLCB0aGlzLnR5cGUgPSAiSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkiLCB0aGlzLmluc3RhbmNlQ291bnQgPSAxIC8gMDsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5pbnN0YW5jZUNvdW50ID0gdC5pbnN0YW5jZUNvdW50LCB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICBjb25zdCB0ID0gc3VwZXIudG9KU09OKCk7CiAgICByZXR1cm4gdC5pbnN0YW5jZUNvdW50ID0gdGhpcy5pbnN0YW5jZUNvdW50LCB0LmlzSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgPSAhMCwgdDsKICB9Cn0KY2xhc3MgYnAgZXh0ZW5kcyBvQyB7CiAgY29uc3RydWN0b3IodCwgZSwgaSA9IDEpIHsKICAgIHN1cGVyKHQsIGUpLCB0aGlzLmlzSW5zdGFuY2VkSW50ZXJsZWF2ZWRCdWZmZXIgPSAhMCwgdGhpcy5tZXNoUGVyQXR0cmlidXRlID0gaTsKICB9CiAgY29weSh0KSB7CiAgICByZXR1cm4gc3VwZXIuY29weSh0KSwgdGhpcy5tZXNoUGVyQXR0cmlidXRlID0gdC5tZXNoUGVyQXR0cmlidXRlLCB0aGlzOwogIH0KICBjbG9uZSh0KSB7CiAgICBjb25zdCBlID0gc3VwZXIuY2xvbmUodCk7CiAgICByZXR1cm4gZS5tZXNoUGVyQXR0cmlidXRlID0gdGhpcy5tZXNoUGVyQXR0cmlidXRlLCBlOwogIH0KICB0b0pTT04odCkgewogICAgY29uc3QgZSA9IHN1cGVyLnRvSlNPTih0KTsKICAgIHJldHVybiBlLmlzSW5zdGFuY2VkSW50ZXJsZWF2ZWRCdWZmZXIgPSAhMCwgZS5tZXNoUGVyQXR0cmlidXRlID0gdGhpcy5tZXNoUGVyQXR0cmlidXRlLCBlOwogIH0KfQpjb25zdCBqZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgdHQoKSwgZGggPSAvKiBAX19QVVJFX18gKi8gbmV3IHR0KCk7CmNsYXNzIHVDIHsKICBjb25zdHJ1Y3Rvcih0ID0gbmV3IHR0KCksIGUgPSBuZXcgdHQoKSkgewogICAgdGhpcy5zdGFydCA9IHQsIHRoaXMuZW5kID0gZTsKICB9CiAgc2V0KHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnN0YXJ0LmNvcHkodCksIHRoaXMuZW5kLmNvcHkoZSksIHRoaXM7CiAgfQogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuc3RhcnQuY29weSh0LnN0YXJ0KSwgdGhpcy5lbmQuY29weSh0LmVuZCksIHRoaXM7CiAgfQogIGdldENlbnRlcih0KSB7CiAgICByZXR1cm4gdC5hZGRWZWN0b3JzKHRoaXMuc3RhcnQsIHRoaXMuZW5kKS5tdWx0aXBseVNjYWxhcigwLjUpOwogIH0KICBkZWx0YSh0KSB7CiAgICByZXR1cm4gdC5zdWJWZWN0b3JzKHRoaXMuZW5kLCB0aGlzLnN0YXJ0KTsKICB9CiAgZGlzdGFuY2VTcSgpIHsKICAgIHJldHVybiB0aGlzLnN0YXJ0LmRpc3RhbmNlVG9TcXVhcmVkKHRoaXMuZW5kKTsKICB9CiAgZGlzdGFuY2UoKSB7CiAgICByZXR1cm4gdGhpcy5zdGFydC5kaXN0YW5jZVRvKHRoaXMuZW5kKTsKICB9CiAgYXQodCwgZSkgewogICAgcmV0dXJuIHRoaXMuZGVsdGEoZSkubXVsdGlwbHlTY2FsYXIodCkuYWRkKHRoaXMuc3RhcnQpOwogIH0KICBjbG9zZXN0UG9pbnRUb1BvaW50UGFyYW1ldGVyKHQsIGUpIHsKICAgIGpnLnN1YlZlY3RvcnModCwgdGhpcy5zdGFydCksIGRoLnN1YlZlY3RvcnModGhpcy5lbmQsIHRoaXMuc3RhcnQpOwogICAgY29uc3QgaSA9IGRoLmRvdChkaCk7CiAgICBsZXQgcyA9IGRoLmRvdChqZykgLyBpOwogICAgcmV0dXJuIGUgJiYgKHMgPSBhaShzLCAwLCAxKSksIHM7CiAgfQogIGNsb3Nlc3RQb2ludFRvUG9pbnQodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuY2xvc2VzdFBvaW50VG9Qb2ludFBhcmFtZXRlcih0LCBlKTsKICAgIHJldHVybiB0aGlzLmRlbHRhKGkpLm11bHRpcGx5U2NhbGFyKG4pLmFkZCh0aGlzLnN0YXJ0KTsKICB9CiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIHJldHVybiB0aGlzLnN0YXJ0LmFwcGx5TWF0cml4NCh0KSwgdGhpcy5lbmQuYXBwbHlNYXRyaXg0KHQpLCB0aGlzOwogIH0KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuc3RhcnQuZXF1YWxzKHRoaXMuc3RhcnQpICYmIHQuZW5kLmVxdWFscyh0aGlzLmVuZCk7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9Cn0KdHlwZW9mIF9fVEhSRUVfREVWVE9PTFNfXyA8ICJ1IiAmJiBfX1RIUkVFX0RFVlRPT0xTX18uZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoInJlZ2lzdGVyIiwgeyBkZXRhaWw6IHsKICByZXZpc2lvbjogTl8KfSB9KSk7CnR5cGVvZiB3aW5kb3cgPCAidSIgJiYgKHdpbmRvdy5fX1RIUkVFX18gPyBjb25zb2xlLndhcm4oIldBUk5JTkc6IE11bHRpcGxlIGluc3RhbmNlcyBvZiBUaHJlZS5qcyBiZWluZyBpbXBvcnRlZC4iKSA6IHdpbmRvdy5fX1RIUkVFX18gPSBOXyk7Ci8qKgogKiBAbGljZW5zZQogKiBDb3B5cmlnaHQgMjAxMC0yMDI1IFRocmVlLmpzIEF1dGhvcnMKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVAogKi8KY29uc3QgSl8gPSAiMTgwIiwgS18gPSAzMDAsIEpnID0gMWUzLCBwaCA9IDEwMDEsIEtnID0gMTAwMiwgZEMgPSAxMDA2LCBwQyA9IDEwMDgsIGZDID0gMTAwOSwgbUMgPSAxMDIzLCBRXyA9ICIiLCBvbiA9ICJzcmdiIiwgUWcgPSAic3JnYi1saW5lYXIiLCB0MCA9ICJsaW5lYXIiLCBCZCA9ICJzcmdiIiwgZmggPSAyZTMsIGUwID0gMjAwMTsKY2xhc3MgdHggewogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIGV2ZW50IGxpc3RlbmVyIHRvIHRoZSBnaXZlbiBldmVudCB0eXBlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBvZiBldmVudCB0byBsaXN0ZW4gdG8uCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgLSBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCB3aGVuIHRoZSBldmVudCBpcyBmaXJlZC4KICAgKi8KICBhZGRFdmVudExpc3RlbmVyKHQsIGUpIHsKICAgIHRoaXMuX2xpc3RlbmVycyA9PT0gdm9pZCAwICYmICh0aGlzLl9saXN0ZW5lcnMgPSB7fSk7CiAgICBjb25zdCBpID0gdGhpcy5fbGlzdGVuZXJzOwogICAgaVt0XSA9PT0gdm9pZCAwICYmIChpW3RdID0gW10pLCBpW3RdLmluZGV4T2YoZSkgPT09IC0xICYmIGlbdF0ucHVzaChlKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIGV2ZW50IGxpc3RlbmVyIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBnaXZlbiBldmVudCB0eXBlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgdHlwZSBvZiBldmVudC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFRoZSBsaXN0ZW5lciB0byBjaGVjay4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSBnaXZlbiBldmVudCBsaXN0ZW5lciBoYXMgYmVlbiBhZGRlZCB0byB0aGUgZ2l2ZW4gZXZlbnQgdHlwZS4KICAgKi8KICBoYXNFdmVudExpc3RlbmVyKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICByZXR1cm4gaSA9PT0gdm9pZCAwID8gITEgOiBpW3RdICE9PSB2b2lkIDAgJiYgaVt0XS5pbmRleE9mKGUpICE9PSAtMTsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgZ2l2ZW4gZXZlbnQgbGlzdGVuZXIgZnJvbSB0aGUgZ2l2ZW4gZXZlbnQgdHlwZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIHR5cGUgb2YgZXZlbnQuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgLSBUaGUgbGlzdGVuZXIgdG8gcmVtb3ZlLgogICAqLwogIHJlbW92ZUV2ZW50TGlzdGVuZXIodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuX2xpc3RlbmVyczsKICAgIGlmIChpID09PSB2b2lkIDApIHJldHVybjsKICAgIGNvbnN0IG4gPSBpW3RdOwogICAgaWYgKG4gIT09IHZvaWQgMCkgewogICAgICBjb25zdCBzID0gbi5pbmRleE9mKGUpOwogICAgICBzICE9PSAtMSAmJiBuLnNwbGljZShzLCAxKTsKICAgIH0KICB9CiAgLyoqCiAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgdGhhdCBnZXRzIGZpcmVkLgogICAqLwogIGRpc3BhdGNoRXZlbnQodCkgewogICAgY29uc3QgZSA9IHRoaXMuX2xpc3RlbmVyczsKICAgIGlmIChlID09PSB2b2lkIDApIHJldHVybjsKICAgIGNvbnN0IGkgPSBlW3QudHlwZV07CiAgICBpZiAoaSAhPT0gdm9pZCAwKSB7CiAgICAgIHQudGFyZ2V0ID0gdGhpczsKICAgICAgY29uc3QgbiA9IGkuc2xpY2UoMCk7CiAgICAgIGZvciAobGV0IHMgPSAwLCByID0gbi5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgICAgbltzXS5jYWxsKHRoaXMsIHQpOwogICAgICB0LnRhcmdldCA9IG51bGw7CiAgICB9CiAgfQp9CmNvbnN0IGlpID0gWyIwMCIsICIwMSIsICIwMiIsICIwMyIsICIwNCIsICIwNSIsICIwNiIsICIwNyIsICIwOCIsICIwOSIsICIwYSIsICIwYiIsICIwYyIsICIwZCIsICIwZSIsICIwZiIsICIxMCIsICIxMSIsICIxMiIsICIxMyIsICIxNCIsICIxNSIsICIxNiIsICIxNyIsICIxOCIsICIxOSIsICIxYSIsICIxYiIsICIxYyIsICIxZCIsICIxZSIsICIxZiIsICIyMCIsICIyMSIsICIyMiIsICIyMyIsICIyNCIsICIyNSIsICIyNiIsICIyNyIsICIyOCIsICIyOSIsICIyYSIsICIyYiIsICIyYyIsICIyZCIsICIyZSIsICIyZiIsICIzMCIsICIzMSIsICIzMiIsICIzMyIsICIzNCIsICIzNSIsICIzNiIsICIzNyIsICIzOCIsICIzOSIsICIzYSIsICIzYiIsICIzYyIsICIzZCIsICIzZSIsICIzZiIsICI0MCIsICI0MSIsICI0MiIsICI0MyIsICI0NCIsICI0NSIsICI0NiIsICI0NyIsICI0OCIsICI0OSIsICI0YSIsICI0YiIsICI0YyIsICI0ZCIsICI0ZSIsICI0ZiIsICI1MCIsICI1MSIsICI1MiIsICI1MyIsICI1NCIsICI1NSIsICI1NiIsICI1NyIsICI1OCIsICI1OSIsICI1YSIsICI1YiIsICI1YyIsICI1ZCIsICI1ZSIsICI1ZiIsICI2MCIsICI2MSIsICI2MiIsICI2MyIsICI2NCIsICI2NSIsICI2NiIsICI2NyIsICI2OCIsICI2OSIsICI2YSIsICI2YiIsICI2YyIsICI2ZCIsICI2ZSIsICI2ZiIsICI3MCIsICI3MSIsICI3MiIsICI3MyIsICI3NCIsICI3NSIsICI3NiIsICI3NyIsICI3OCIsICI3OSIsICI3YSIsICI3YiIsICI3YyIsICI3ZCIsICI3ZSIsICI3ZiIsICI4MCIsICI4MSIsICI4MiIsICI4MyIsICI4NCIsICI4NSIsICI4NiIsICI4NyIsICI4OCIsICI4OSIsICI4YSIsICI4YiIsICI4YyIsICI4ZCIsICI4ZSIsICI4ZiIsICI5MCIsICI5MSIsICI5MiIsICI5MyIsICI5NCIsICI5NSIsICI5NiIsICI5NyIsICI5OCIsICI5OSIsICI5YSIsICI5YiIsICI5YyIsICI5ZCIsICI5ZSIsICI5ZiIsICJhMCIsICJhMSIsICJhMiIsICJhMyIsICJhNCIsICJhNSIsICJhNiIsICJhNyIsICJhOCIsICJhOSIsICJhYSIsICJhYiIsICJhYyIsICJhZCIsICJhZSIsICJhZiIsICJiMCIsICJiMSIsICJiMiIsICJiMyIsICJiNCIsICJiNSIsICJiNiIsICJiNyIsICJiOCIsICJiOSIsICJiYSIsICJiYiIsICJiYyIsICJiZCIsICJiZSIsICJiZiIsICJjMCIsICJjMSIsICJjMiIsICJjMyIsICJjNCIsICJjNSIsICJjNiIsICJjNyIsICJjOCIsICJjOSIsICJjYSIsICJjYiIsICJjYyIsICJjZCIsICJjZSIsICJjZiIsICJkMCIsICJkMSIsICJkMiIsICJkMyIsICJkNCIsICJkNSIsICJkNiIsICJkNyIsICJkOCIsICJkOSIsICJkYSIsICJkYiIsICJkYyIsICJkZCIsICJkZSIsICJkZiIsICJlMCIsICJlMSIsICJlMiIsICJlMyIsICJlNCIsICJlNSIsICJlNiIsICJlNyIsICJlOCIsICJlOSIsICJlYSIsICJlYiIsICJlYyIsICJlZCIsICJlZSIsICJlZiIsICJmMCIsICJmMSIsICJmMiIsICJmMyIsICJmNCIsICJmNSIsICJmNiIsICJmNyIsICJmOCIsICJmOSIsICJmYSIsICJmYiIsICJmYyIsICJmZCIsICJmZSIsICJmZiJdOwpmdW5jdGlvbiBNZigpIHsKICBjb25zdCBhID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwLCB0ID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwLCBlID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwLCBpID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIHJldHVybiAoaWlbYSAmIDI1NV0gKyBpaVthID4+IDggJiAyNTVdICsgaWlbYSA+PiAxNiAmIDI1NV0gKyBpaVthID4+IDI0ICYgMjU1XSArICItIiArIGlpW3QgJiAyNTVdICsgaWlbdCA+PiA4ICYgMjU1XSArICItIiArIGlpW3QgPj4gMTYgJiAxNSB8IDY0XSArIGlpW3QgPj4gMjQgJiAyNTVdICsgIi0iICsgaWlbZSAmIDYzIHwgMTI4XSArIGlpW2UgPj4gOCAmIDI1NV0gKyAiLSIgKyBpaVtlID4+IDE2ICYgMjU1XSArIGlpW2UgPj4gMjQgJiAyNTVdICsgaWlbaSAmIDI1NV0gKyBpaVtpID4+IDggJiAyNTVdICsgaWlbaSA+PiAxNiAmIDI1NV0gKyBpaVtpID4+IDI0ICYgMjU1XSkudG9Mb3dlckNhc2UoKTsKfQpmdW5jdGlvbiB5ZShhLCB0LCBlKSB7CiAgcmV0dXJuIE1hdGgubWF4KHQsIE1hdGgubWluKGUsIGEpKTsKfQpmdW5jdGlvbiBnQyhhLCB0KSB7CiAgcmV0dXJuIChhICUgdCArIHQpICUgdDsKfQpmdW5jdGlvbiB6ZChhLCB0LCBlKSB7CiAgcmV0dXJuICgxIC0gZSkgKiBhICsgZSAqIHQ7Cn0KY2xhc3MgX28gewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgMkQgdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gVGhlIHggdmFsdWUgb2YgdGhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIHkgdmFsdWUgb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgY29uc3RydWN0b3IodCA9IDAsIGUgPSAwKSB7CiAgICBfby5wcm90b3R5cGUuaXNWZWN0b3IyID0gITAsIHRoaXMueCA9IHQsIHRoaXMueSA9IGU7CiAgfQogIC8qKgogICAqIEFsaWFzIGZvciB7QGxpbmsgVmVjdG9yMiN4fS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgZ2V0IHdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMueDsKICB9CiAgc2V0IHdpZHRoKHQpIHsKICAgIHRoaXMueCA9IHQ7CiAgfQogIC8qKgogICAqIEFsaWFzIGZvciB7QGxpbmsgVmVjdG9yMiN5fS4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgZ2V0IGhlaWdodCgpIHsKICAgIHJldHVybiB0aGlzLnk7CiAgfQogIHNldCBoZWlnaHQodCkgewogICAgdGhpcy55ID0gdDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSBvZiB0aGUgeCBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmFsdWUgb2YgdGhlIHkgY29tcG9uZW50LgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpcy55ID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgdG8gdGhlIHNhbWUgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGFyIC0gVGhlIHZhbHVlIHRvIHNldCBmb3IgYWxsIHZlY3RvciBjb21wb25lbnRzLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldFNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpcy55ID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yJ3MgeCBjb21wb25lbnQgdG8gdGhlIGdpdmVuIHZhbHVlCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSB0byBzZXQuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0WCh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yJ3MgeSBjb21wb25lbnQgdG8gdGhlIGdpdmVuIHZhbHVlCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBzZXQuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0WSh0KSB7CiAgICByZXR1cm4gdGhpcy55ID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQWxsb3dzIHRvIHNldCBhIHZlY3RvciBjb21wb25lbnQgd2l0aCBhbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBjb21wb25lbnQgaW5kZXguIGAwYCBlcXVhbHMgdG8geCwgYDFgIGVxdWFscyB0byB5LgogICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBzZXQuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0Q29tcG9uZW50KHQsIGUpIHsKICAgIHN3aXRjaCAodCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMueSA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyB0KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgdmVjdG9yIGNvbXBvbmVudCB3aGljaCBtYXRjaGVzIHRoZSBnaXZlbiBpbmRleC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBjb21wb25lbnQgaW5kZXguIGAwYCBlcXVhbHMgdG8geCwgYDFgIGVxdWFscyB0byB5LgogICAqIEByZXR1cm4ge251bWJlcn0gQSB2ZWN0b3IgY29tcG9uZW50IHZhbHVlLgogICAqLwogIGdldENvbXBvbmVudCh0KSB7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJldHVybiB0aGlzLng7CiAgICAgIGNhc2UgMToKICAgICAgICByZXR1cm4gdGhpcy55OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgdCk7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgdmVjdG9yIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy54LCB0aGlzLnkpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gdmVjdG9yIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIGNvcHkuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54LCB0aGlzLnkgPSB0LnksIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBhZGQuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54LCB0aGlzLnkgKz0gdC55LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiBzY2FsYXIgdmFsdWUgdG8gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBhZGQuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkU2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdCwgdGhpcy55ICs9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHZlY3RvcnMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0IGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IGEgLSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gYiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZFZlY3RvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCArIGUueCwgdGhpcy55ID0gdC55ICsgZS55LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3Igc2NhbGVkIGJ5IHRoZSBnaXZlbiBmYWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IHMgLSBUaGUgZmFjdG9yIHRoYXQgc2NhbGVzIGB2YC4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhZGRTY2FsZWRWZWN0b3IodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCArPSB0LnggKiBlLCB0aGlzLnkgKz0gdC55ICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogU3VidHJhY3RzIHRoZSBnaXZlbiB2ZWN0b3IgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LngsIHRoaXMueSAtPSB0LnksIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIGZyb20gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWJTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LCB0aGlzLnkgLT0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogU3VidHJhY3RzIHRoZSBnaXZlbiB2ZWN0b3JzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBhIC0gVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IGIgLSBUaGUgc2Vjb25kIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWJWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggLSBlLngsIHRoaXMueSA9IHQueSAtIGUueSwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gbXVsdGlwbHkuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LngsIHRoaXMueSAqPSB0LnksIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSB3aXRoIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGFyIC0gVGhlIHNjYWxhciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICo9IHQsIHRoaXMueSAqPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBEaXZpZGVzIHRoaXMgaW5zdGFuY2UgYnkgdGhlIGdpdmVuIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gZGl2aWRlLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGRpdmlkZSh0KSB7CiAgICByZXR1cm4gdGhpcy54IC89IHQueCwgdGhpcy55IC89IHQueSwgdGhpczsKICB9CiAgLyoqCiAgICogRGl2aWRlcyB0aGlzIHZlY3RvciBieSB0aGUgZ2l2ZW4gc2NhbGFyLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxhciAtIFRoZSBzY2FsYXIgdG8gZGl2aWRlLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGRpdmlkZVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhcigxIC8gdCk7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhpcyB2ZWN0b3IgKHdpdGggYW4gaW1wbGljaXQgMSBhcyB0aGUgM3JkIGNvbXBvbmVudCkgYnkKICAgKiB0aGUgZ2l2ZW4gM3gzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gYXBwbHkuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlNYXRyaXgzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMueCA9IG5bMF0gKiBlICsgblszXSAqIGkgKyBuWzZdLCB0aGlzLnkgPSBuWzFdICogZSArIG5bNF0gKiBpICsgbls3XSwgdGhpczsKICB9CiAgLyoqCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4IG9yIHkgdmFsdWUgaXMgZ3JlYXRlciB0aGFuIHRoZSBnaXZlbiB2ZWN0b3IncyB4IG9yIHkKICAgKiB2YWx1ZSwgcmVwbGFjZSB0aGF0IHZhbHVlIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgbWluIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtaW4odCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWluKHRoaXMueCwgdC54KSwgdGhpcy55ID0gTWF0aC5taW4odGhpcy55LCB0LnkpLCB0aGlzOwogIH0KICAvKioKICAgKiBJZiB0aGlzIHZlY3RvcidzIHggb3IgeSB2YWx1ZSBpcyBsZXNzIHRoYW4gdGhlIGdpdmVuIHZlY3RvcidzIHggb3IgeQogICAqIHZhbHVlLCByZXBsYWNlIHRoYXQgdmFsdWUgd2l0aCB0aGUgY29ycmVzcG9uZGluZyBtYXggdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIG1heCh0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5tYXgodGhpcy54LCB0LngpLCB0aGlzLnkgPSBNYXRoLm1heCh0aGlzLnksIHQueSksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCBvciB5IHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZlY3RvcidzIHggb3IgeQogICAqIHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieSB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHggb3IgeSB2YWx1ZSBpcyBsZXNzIHRoYW4gdGhlIG1pbiB2ZWN0b3IncyB4IG9yIHkgdmFsdWUsCiAgICogaXQgaXMgcmVwbGFjZWQgYnkgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IG1pbiAtIFRoZSBtaW5pbXVtIHggYW5kIHkgdmFsdWVzLgogICAqIEBwYXJhbSB7VmVjdG9yMn0gbWF4IC0gVGhlIG1heGltdW0geCBhbmQgeSB2YWx1ZXMgaW4gdGhlIGRlc2lyZWQgcmFuZ2UuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHllKHRoaXMueCwgdC54LCBlLngpLCB0aGlzLnkgPSB5ZSh0aGlzLnksIHQueSwgZS55KSwgdGhpczsKICB9CiAgLyoqCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4IG9yIHkgdmFsdWVzIGFyZSBncmVhdGVyIHRoYW4gdGhlIG1heCB2YWx1ZSwgdGhleSBhcmUKICAgKiByZXBsYWNlZCBieSB0aGUgbWF4IHZhbHVlLgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCBvciB5IHZhbHVlcyBhcmUgbGVzcyB0aGFuIHRoZSBtaW4gdmFsdWUsIHRoZXkgYXJlCiAgICogcmVwbGFjZWQgYnkgdGhlIG1pbiB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBtaW5WYWwgLSBUaGUgbWluaW11bSB2YWx1ZSB0aGUgY29tcG9uZW50cyB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heFZhbCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRoZSBjb21wb25lbnRzIHdpbGwgYmUgY2xhbXBlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBjbGFtcFNjYWxhcih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0geWUodGhpcy54LCB0LCBlKSwgdGhpcy55ID0geWUodGhpcy55LCB0LCBlKSwgdGhpczsKICB9CiAgLyoqCiAgICogSWYgdGhpcyB2ZWN0b3IncyBsZW5ndGggaXMgZ3JlYXRlciB0aGFuIHRoZSBtYXggdmFsdWUsIGl0IGlzIHJlcGxhY2VkIGJ5CiAgICogdGhlIG1heCB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIGxlbmd0aCBpcyBsZXNzIHRoYW4gdGhlIG1pbiB2YWx1ZSwgaXQgaXMgcmVwbGFjZWQgYnkgdGhlCiAgICogbWluIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIHRoZSB2ZWN0b3IgbGVuZ3RoIHdpbGwgYmUgY2xhbXBlZCB0by4KICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdGhlIHZlY3RvciBsZW5ndGggd2lsbCBiZSBjbGFtcGVkIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNsYW1wTGVuZ3RoKHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKGkgfHwgMSkubXVsdGlwbHlTY2FsYXIoeWUoaSwgdCwgZSkpOwogIH0KICAvKioKICAgKiBUaGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciBhcmUgcm91bmRlZCBkb3duIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgdmFsdWUuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmbG9vcigpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCksIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdXAgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNlaWwoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCksIHRoaXMueSA9IE1hdGguY2VpbCh0aGlzLnkpLCB0aGlzOwogIH0KICAvKioKICAgKiBUaGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciBhcmUgcm91bmRlZCB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIHZhbHVlCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICByb3VuZCgpIHsKICAgIHJldHVybiB0aGlzLnggPSBNYXRoLnJvdW5kKHRoaXMueCksIHRoaXMueSA9IE1hdGgucm91bmQodGhpcy55KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG93YXJkcyB6ZXJvICh1cCBpZiBuZWdhdGl2ZSwKICAgKiBkb3duIGlmIHBvc2l0aXZlKSB0byBhbiBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmRUb1plcm8oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC50cnVuYyh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnRydW5jKHRoaXMueSksIHRoaXM7CiAgfQogIC8qKgogICAqIEludmVydHMgdGhpcyB2ZWN0b3IgLSBpLmUuIHNldHMgeCA9IC14IGFuZCB5ID0gLXkuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBuZWdhdGUoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gLXRoaXMueCwgdGhpcy55ID0gLXRoaXMueSwgdGhpczsKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgZG90IHByb2R1Y3Qgb2YgdGhlIGdpdmVuIHZlY3RvciB3aXRoIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIGNvbXB1dGUgdGhlIGRvdCBwcm9kdWN0IHdpdGguCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcmVzdWx0IG9mIHRoZSBkb3QgcHJvZHVjdC4KICAgKi8KICBkb3QodCkgewogICAgcmV0dXJuIHRoaXMueCAqIHQueCArIHRoaXMueSAqIHQueTsKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgY3Jvc3MgcHJvZHVjdCBvZiB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgY3Jvc3MgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgY3Jvc3MgcHJvZHVjdC4KICAgKi8KICBjcm9zcyh0KSB7CiAgICByZXR1cm4gdGhpcy54ICogdC55IC0gdGhpcy55ICogdC54OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgc3F1YXJlIG9mIHRoZSBFdWNsaWRlYW4gbGVuZ3RoIChzdHJhaWdodC1saW5lIGxlbmd0aCkgZnJvbQogICAqICgwLCAwKSB0byAoeCwgeSkuIElmIHlvdSBhcmUgY29tcGFyaW5nIHRoZSBsZW5ndGhzIG9mIHZlY3RvcnMsIHlvdSBzaG91bGQKICAgKiBjb21wYXJlIHRoZSBsZW5ndGggc3F1YXJlZCBpbnN0ZWFkIGFzIGl0IGlzIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IHRvIGNhbGN1bGF0ZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgIEV1Y2xpZGVhbiBsZW5ndGggKHN0cmFpZ2h0LWxpbmUgbGVuZ3RoKSBmcm9tICgwLCAwKSB0byAoeCwgeSkuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkpOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgTWFuaGF0dGFuIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSk7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIHRoaXMgdmVjdG9yIHRvIGEgdW5pdCB2ZWN0b3IgLSB0aGF0IGlzLCBzZXRzIGl0IGVxdWFsIHRvIGEgdmVjdG9yCiAgICogd2l0aCB0aGUgc2FtZSBkaXJlY3Rpb24gYXMgdGhpcyBvbmUsIGJ1dCB3aXRoIGEgdmVjdG9yIGxlbmd0aCBvZiBgMWAuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBub3JtYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIodGhpcy5sZW5ndGgoKSB8fCAxKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGFuZ2xlIGluIHJhZGlhbnMgb2YgdGhpcyB2ZWN0b3Igd2l0aCByZXNwZWN0IHRvIHRoZSBwb3NpdGl2ZSB4LWF4aXMuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAqLwogIGFuZ2xlKCkgewogICAgcmV0dXJuIE1hdGguYXRhbjIoLXRoaXMueSwgLXRoaXMueCkgKyBNYXRoLlBJOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBhbmdsZSBiZXR3ZWVuIHRoZSBnaXZlbiB2ZWN0b3IgYW5kIHRoaXMgaW5zdGFuY2UgaW4gcmFkaWFucy4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgYW5nbGUgd2l0aC4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAqLwogIGFuZ2xlVG8odCkgewogICAgY29uc3QgZSA9IE1hdGguc3FydCh0aGlzLmxlbmd0aFNxKCkgKiB0Lmxlbmd0aFNxKCkpOwogICAgaWYgKGUgPT09IDApIHJldHVybiBNYXRoLlBJIC8gMjsKICAgIGNvbnN0IGkgPSB0aGlzLmRvdCh0KSAvIGU7CiAgICByZXR1cm4gTWF0aC5hY29zKHllKGksIC0xLCAxKSk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBkaXN0YW5jZSBmcm9tIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgZGlzdGFuY2UgdG8uCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UuCiAgICovCiAgZGlzdGFuY2VUbyh0KSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuZGlzdGFuY2VUb1NxdWFyZWQodCkpOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgc3F1YXJlZCBkaXN0YW5jZSBmcm9tIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKiBJZiB5b3UgYXJlIGp1c3QgY29tcGFyaW5nIHRoZSBkaXN0YW5jZSB3aXRoIGFub3RoZXIgZGlzdGFuY2UsIHlvdSBzaG91bGQgY29tcGFyZQogICAqIHRoZSBkaXN0YW5jZSBzcXVhcmVkIGluc3RlYWQgYXMgaXQgaXMgc2xpZ2h0bHkgbW9yZSBlZmZpY2llbnQgdG8gY2FsY3VsYXRlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBzcXVhcmVkIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZWQgZGlzdGFuY2UuCiAgICovCiAgZGlzdGFuY2VUb1NxdWFyZWQodCkgewogICAgY29uc3QgZSA9IHRoaXMueCAtIHQueCwgaSA9IHRoaXMueSAtIHQueTsKICAgIHJldHVybiBlICogZSArIGkgKiBpOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgTWFuaGF0dGFuIGRpc3RhbmNlIGZyb20gdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBNYW5oYXR0YW4gZGlzdGFuY2UgdG8uCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgTWFuaGF0dGFuIGRpc3RhbmNlLgogICAqLwogIG1hbmhhdHRhbkRpc3RhbmNlVG8odCkgewogICAgcmV0dXJuIE1hdGguYWJzKHRoaXMueCAtIHQueCkgKyBNYXRoLmFicyh0aGlzLnkgLSB0LnkpOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgdmVjdG9yIHRvIGEgdmVjdG9yIHdpdGggdGhlIHNhbWUgZGlyZWN0aW9uIGFzIHRoaXMgb25lLCBidXQKICAgKiB3aXRoIHRoZSBzcGVjaWZpZWQgbGVuZ3RoLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBuZXcgbGVuZ3RoIG9mIHRoaXMgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldExlbmd0aCh0KSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcih0KTsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIHZlY3RvciBhbmQgdGhpcyBpbnN0YW5jZSwgd2hlcmUKICAgKiBhbHBoYSBpcyB0aGUgcGVyY2VudCBkaXN0YW5jZSBhbG9uZyB0aGUgbGluZSAtIGFscGhhID0gMCB3aWxsIGJlIHRoaXMKICAgKiB2ZWN0b3IsIGFuZCBhbHBoYSA9IDEgd2lsbCBiZSB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2IC0gVGhlIHZlY3RvciB0byBpbnRlcnBvbGF0ZSB0b3dhcmRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciwgdHlwaWNhbGx5IGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLCAxXWAuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVycCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ICs9ICh0LnggLSB0aGlzLngpICogZSwgdGhpcy55ICs9ICh0LnkgLSB0aGlzLnkpICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIHZlY3RvcnMsIHdoZXJlIGFscGhhIGlzIHRoZSBwZXJjZW50CiAgICogZGlzdGFuY2UgYWxvbmcgdGhlIGxpbmUgLSBhbHBoYSA9IDAgd2lsbCBiZSBmaXJzdCB2ZWN0b3IsIGFuZCBhbHBoYSA9IDEgd2lsbAogICAqIGJlIHRoZSBzZWNvbmQgb25lLiBUaGUgcmVzdWx0IGlzIHN0b3JlZCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2MSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IyfSB2MiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciwgdHlwaWNhbGx5IGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLCAxXWAuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVycFZlY3RvcnModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCArIChlLnggLSB0LngpICogaSwgdGhpcy55ID0gdC55ICsgKGUueSAtIHQueSkgKiBpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIHZlY3RvciBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjJ9IHYgLSBUaGUgdmVjdG9yIHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyB2ZWN0b3IgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqLwogIGVxdWFscyh0KSB7CiAgICByZXR1cm4gdC54ID09PSB0aGlzLnggJiYgdC55ID09PSB0aGlzLnk7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyB2ZWN0b3IncyB4IHZhbHVlIHRvIGJlIGBhcnJheVsgb2Zmc2V0IF1gIGFuZCB5CiAgICogdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgKyAxIF1gLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIEFuIGFycmF5IGhvbGRpbmcgdGhlIHZlY3RvciBjb21wb25lbnQgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnggPSB0W2VdLCB0aGlzLnkgPSB0W2UgKyAxXSwgdGhpczsKICB9CiAgLyoqCiAgICogV3JpdGVzIHRoZSBjb21wb25lbnRzIG9mIHRoaXMgdmVjdG9yIHRvIHRoZSBnaXZlbiBhcnJheS4gSWYgbm8gYXJyYXkgaXMgcHJvdmlkZWQsCiAgICogdGhlIG1ldGhvZCByZXR1cm5zIGEgbmV3IGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBbYXJyYXk9W11dIC0gVGhlIHRhcmdldCBhcnJheSBob2xkaW5nIHRoZSB2ZWN0b3IgY29tcG9uZW50cy4KICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldD0wXSAtIEluZGV4IG9mIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgdmVjdG9yIGNvbXBvbmVudHMuCiAgICovCiAgdG9BcnJheSh0ID0gW10sIGUgPSAwKSB7CiAgICByZXR1cm4gdFtlXSA9IHRoaXMueCwgdFtlICsgMV0gPSB0aGlzLnksIHQ7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgZnJvbSB0aGUgZ2l2ZW4gYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyQXR0cmlidXRlfSBhdHRyaWJ1dGUgLSBUaGUgYnVmZmVyIGF0dHJpYnV0ZSBob2xkaW5nIHZlY3RvciBkYXRhLgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBpbnRvIHRoZSBhdHRyaWJ1dGUuCiAgICogQHJldHVybiB7VmVjdG9yMn0gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC5nZXRYKGUpLCB0aGlzLnkgPSB0LmdldFkoZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhpcyB2ZWN0b3IgYXJvdW5kIHRoZSBnaXZlbiBjZW50ZXIgYnkgdGhlIGdpdmVuIGFuZ2xlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IyfSBjZW50ZXIgLSBUaGUgcG9pbnQgYXJvdW5kIHdoaWNoIHRvIHJvdGF0ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgdG8gcm90YXRlLCBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJvdGF0ZUFyb3VuZCh0LCBlKSB7CiAgICBjb25zdCBpID0gTWF0aC5jb3MoZSksIG4gPSBNYXRoLnNpbihlKSwgcyA9IHRoaXMueCAtIHQueCwgciA9IHRoaXMueSAtIHQueTsKICAgIHJldHVybiB0aGlzLnggPSBzICogaSAtIHIgKiBuICsgdC54LCB0aGlzLnkgPSBzICogbiArIHIgKiBpICsgdC55LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIGVhY2ggY29tcG9uZW50IG9mIHRoaXMgdmVjdG9yIHRvIGEgcHNldWRvLXJhbmRvbSB2YWx1ZSBiZXR3ZWVuIGAwYCBhbmQKICAgKiBgMWAsIGV4Y2x1ZGluZyBgMWAuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IyfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICByYW5kb20oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yYW5kb20oKSwgdGhpcy55ID0gTWF0aC5yYW5kb20oKSwgdGhpczsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy54LCB5aWVsZCB0aGlzLnk7CiAgfQp9CmNsYXNzICRvIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHF1YXRlcm5pb24uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgeCB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIHkgdmFsdWUgb2YgdGhpcyBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbej0wXSAtIFRoZSB6IHZhbHVlIG9mIHRoaXMgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gW3c9MV0gLSBUaGUgdyB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgY29uc3RydWN0b3IodCA9IDAsIGUgPSAwLCBpID0gMCwgbiA9IDEpIHsKICAgIHRoaXMuaXNRdWF0ZXJuaW9uID0gITAsIHRoaXMuX3ggPSB0LCB0aGlzLl95ID0gZSwgdGhpcy5feiA9IGksIHRoaXMuX3cgPSBuOwogIH0KICAvKioKICAgKiBJbnRlcnBvbGF0ZXMgYmV0d2VlbiB0d28gcXVhdGVybmlvbnMgdmlhIFNMRVJQLiBUaGlzIGltcGxlbWVudGF0aW9uIGFzc3VtZXMgdGhlCiAgICogcXVhdGVybmlvbiBkYXRhIGFyZSBtYW5hZ2VkICBpbiBmbGF0IGFycmF5cy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gZHN0IC0gVGhlIGRlc3RpbmF0aW9uIGFycmF5LgogICAqIEBwYXJhbSB7bnVtYmVyfSBkc3RPZmZzZXQgLSBBbiBvZmZzZXQgaW50byB0aGUgZGVzdGluYXRpb24gYXJyYXkuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBzcmMwIC0gVGhlIHNvdXJjZSBhcnJheSBvZiB0aGUgZmlyc3QgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gc3JjT2Zmc2V0MCAtIEFuIG9mZnNldCBpbnRvIHRoZSBmaXJzdCBzb3VyY2UgYXJyYXkuCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBzcmMxIC0gIFRoZSBzb3VyY2UgYXJyYXkgb2YgdGhlIHNlY29uZCBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzcmNPZmZzZXQxIC0gQW4gb2Zmc2V0IGludG8gdGhlIHNlY29uZCBzb3VyY2UgYXJyYXkuCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IgaW4gdGhlIHJhbmdlIGBbMCwxXWAuCiAgICogQHNlZSB7QGxpbmsgUXVhdGVybmlvbiNzbGVycH0KICAgKi8KICBzdGF0aWMgc2xlcnBGbGF0KHQsIGUsIGksIG4sIHMsIHIsIG8pIHsKICAgIGxldCBsID0gaVtuICsgMF0sIGggPSBpW24gKyAxXSwgYyA9IGlbbiArIDJdLCB1ID0gaVtuICsgM107CiAgICBjb25zdCBkID0gc1tyICsgMF0sIHAgPSBzW3IgKyAxXSwgZiA9IHNbciArIDJdLCB5ID0gc1tyICsgM107CiAgICBpZiAobyA9PT0gMCkgewogICAgICB0W2UgKyAwXSA9IGwsIHRbZSArIDFdID0gaCwgdFtlICsgMl0gPSBjLCB0W2UgKyAzXSA9IHU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChvID09PSAxKSB7CiAgICAgIHRbZSArIDBdID0gZCwgdFtlICsgMV0gPSBwLCB0W2UgKyAyXSA9IGYsIHRbZSArIDNdID0geTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHUgIT09IHkgfHwgbCAhPT0gZCB8fCBoICE9PSBwIHx8IGMgIT09IGYpIHsKICAgICAgbGV0IGcgPSAxIC0gbzsKICAgICAgY29uc3QgbSA9IGwgKiBkICsgaCAqIHAgKyBjICogZiArIHUgKiB5LCB2ID0gbSA+PSAwID8gMSA6IC0xLCB4ID0gMSAtIG0gKiBtOwogICAgICBpZiAoeCA+IE51bWJlci5FUFNJTE9OKSB7CiAgICAgICAgY29uc3QgUyA9IE1hdGguc3FydCh4KSwgdyA9IE1hdGguYXRhbjIoUywgbSAqIHYpOwogICAgICAgIGcgPSBNYXRoLnNpbihnICogdykgLyBTLCBvID0gTWF0aC5zaW4obyAqIHcpIC8gUzsKICAgICAgfQogICAgICBjb25zdCBfID0gbyAqIHY7CiAgICAgIGlmIChsID0gbCAqIGcgKyBkICogXywgaCA9IGggKiBnICsgcCAqIF8sIGMgPSBjICogZyArIGYgKiBfLCB1ID0gdSAqIGcgKyB5ICogXywgZyA9PT0gMSAtIG8pIHsKICAgICAgICBjb25zdCBTID0gMSAvIE1hdGguc3FydChsICogbCArIGggKiBoICsgYyAqIGMgKyB1ICogdSk7CiAgICAgICAgbCAqPSBTLCBoICo9IFMsIGMgKj0gUywgdSAqPSBTOwogICAgICB9CiAgICB9CiAgICB0W2VdID0gbCwgdFtlICsgMV0gPSBoLCB0W2UgKyAyXSA9IGMsIHRbZSArIDNdID0gdTsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0d28gcXVhdGVybmlvbnMuIFRoaXMgaW1wbGVtZW50YXRpb24gYXNzdW1lcyB0aGUgcXVhdGVybmlvbiBkYXRhIGFyZSBtYW5hZ2VkCiAgICogaW4gZmxhdCBhcnJheXMuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGRzdCAtIFRoZSBkZXN0aW5hdGlvbiBhcnJheS4KICAgKiBAcGFyYW0ge251bWJlcn0gZHN0T2Zmc2V0IC0gQW4gb2Zmc2V0IGludG8gdGhlIGRlc3RpbmF0aW9uIGFycmF5LgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gc3JjMCAtIFRoZSBzb3VyY2UgYXJyYXkgb2YgdGhlIGZpcnN0IHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHNyY09mZnNldDAgLSBBbiBvZmZzZXQgaW50byB0aGUgZmlyc3Qgc291cmNlIGFycmF5LgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gc3JjMSAtICBUaGUgc291cmNlIGFycmF5IG9mIHRoZSBzZWNvbmQgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gc3JjT2Zmc2V0MSAtIEFuIG9mZnNldCBpbnRvIHRoZSBzZWNvbmQgc291cmNlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSBkZXN0aW5hdGlvbiBhcnJheS4KICAgKiBAc2VlIHtAbGluayBRdWF0ZXJuaW9uI211bHRpcGx5UXVhdGVybmlvbnN9LgogICAqLwogIHN0YXRpYyBtdWx0aXBseVF1YXRlcm5pb25zRmxhdCh0LCBlLCBpLCBuLCBzLCByKSB7CiAgICBjb25zdCBvID0gaVtuXSwgbCA9IGlbbiArIDFdLCBoID0gaVtuICsgMl0sIGMgPSBpW24gKyAzXSwgdSA9IHNbcl0sIGQgPSBzW3IgKyAxXSwgcCA9IHNbciArIDJdLCBmID0gc1tyICsgM107CiAgICByZXR1cm4gdFtlXSA9IG8gKiBmICsgYyAqIHUgKyBsICogcCAtIGggKiBkLCB0W2UgKyAxXSA9IGwgKiBmICsgYyAqIGQgKyBoICogdSAtIG8gKiBwLCB0W2UgKyAyXSA9IGggKiBmICsgYyAqIHAgKyBvICogZCAtIGwgKiB1LCB0W2UgKyAzXSA9IGMgKiBmIC0gbyAqIHUgLSBsICogZCAtIGggKiBwLCB0OwogIH0KICAvKioKICAgKiBUaGUgeCB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgeCgpIHsKICAgIHJldHVybiB0aGlzLl94OwogIH0KICBzZXQgeCh0KSB7CiAgICB0aGlzLl94ID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBUaGUgeSB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgeSgpIHsKICAgIHJldHVybiB0aGlzLl95OwogIH0KICBzZXQgeSh0KSB7CiAgICB0aGlzLl95ID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBUaGUgeiB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgeigpIHsKICAgIHJldHVybiB0aGlzLl96OwogIH0KICBzZXQgeih0KSB7CiAgICB0aGlzLl96ID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBUaGUgdyB2YWx1ZSBvZiB0aGlzIHF1YXRlcm5pb24uCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDEKICAgKi8KICBnZXQgdygpIHsKICAgIHJldHVybiB0aGlzLl93OwogIH0KICBzZXQgdyh0KSB7CiAgICB0aGlzLl93ID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBxdWF0ZXJuaW9uIGNvbXBvbmVudHMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IHZhbHVlIG9mIHRoaXMgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IHZhbHVlIG9mIHRoaXMgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB6IHZhbHVlIG9mIHRoaXMgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gdyAtIFRoZSB3IHZhbHVlIG9mIHRoaXMgcXVhdGVybmlvbi4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgc2V0KHQsIGUsIGksIG4pIHsKICAgIHJldHVybiB0aGlzLl94ID0gdCwgdGhpcy5feSA9IGUsIHRoaXMuX3ogPSBpLCB0aGlzLl93ID0gbiwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHF1YXRlcm5pb24gd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLl94LCB0aGlzLl95LCB0aGlzLl96LCB0aGlzLl93KTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHF1YXRlcm5pb24gdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcXVhdGVybmlvbiAtIFRoZSBxdWF0ZXJuaW9uIHRvIGNvcHkuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMuX3ggPSB0LngsIHRoaXMuX3kgPSB0LnksIHRoaXMuX3ogPSB0LnosIHRoaXMuX3cgPSB0LncsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHF1YXRlcm5pb24gZnJvbSB0aGUgcm90YXRpb24gc3BlY2lmaWVkIGJ5IHRoZSBnaXZlbgogICAqIEV1bGVyIGFuZ2xlcy4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGFuZ2xlcy4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1cGRhdGU9dHJ1ZV0gLSBXaGV0aGVyIHRoZSBpbnRlcm5hbCBgb25DaGFuZ2VgIGNhbGxiYWNrIHNob3VsZCBiZSBleGVjdXRlZCBvciBub3QuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHNldEZyb21FdWxlcih0LCBlID0gITApIHsKICAgIGNvbnN0IGkgPSB0Ll94LCBuID0gdC5feSwgcyA9IHQuX3osIHIgPSB0Ll9vcmRlciwgbyA9IE1hdGguY29zLCBsID0gTWF0aC5zaW4sIGggPSBvKGkgLyAyKSwgYyA9IG8obiAvIDIpLCB1ID0gbyhzIC8gMiksIGQgPSBsKGkgLyAyKSwgcCA9IGwobiAvIDIpLCBmID0gbChzIC8gMik7CiAgICBzd2l0Y2ggKHIpIHsKICAgICAgY2FzZSAiWFlaIjoKICAgICAgICB0aGlzLl94ID0gZCAqIGMgKiB1ICsgaCAqIHAgKiBmLCB0aGlzLl95ID0gaCAqIHAgKiB1IC0gZCAqIGMgKiBmLCB0aGlzLl96ID0gaCAqIGMgKiBmICsgZCAqIHAgKiB1LCB0aGlzLl93ID0gaCAqIGMgKiB1IC0gZCAqIHAgKiBmOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJZWFoiOgogICAgICAgIHRoaXMuX3ggPSBkICogYyAqIHUgKyBoICogcCAqIGYsIHRoaXMuX3kgPSBoICogcCAqIHUgLSBkICogYyAqIGYsIHRoaXMuX3ogPSBoICogYyAqIGYgLSBkICogcCAqIHUsIHRoaXMuX3cgPSBoICogYyAqIHUgKyBkICogcCAqIGY7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlpYWSI6CiAgICAgICAgdGhpcy5feCA9IGQgKiBjICogdSAtIGggKiBwICogZiwgdGhpcy5feSA9IGggKiBwICogdSArIGQgKiBjICogZiwgdGhpcy5feiA9IGggKiBjICogZiArIGQgKiBwICogdSwgdGhpcy5fdyA9IGggKiBjICogdSAtIGQgKiBwICogZjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWllYIjoKICAgICAgICB0aGlzLl94ID0gZCAqIGMgKiB1IC0gaCAqIHAgKiBmLCB0aGlzLl95ID0gaCAqIHAgKiB1ICsgZCAqIGMgKiBmLCB0aGlzLl96ID0gaCAqIGMgKiBmIC0gZCAqIHAgKiB1LCB0aGlzLl93ID0gaCAqIGMgKiB1ICsgZCAqIHAgKiBmOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJZWlgiOgogICAgICAgIHRoaXMuX3ggPSBkICogYyAqIHUgKyBoICogcCAqIGYsIHRoaXMuX3kgPSBoICogcCAqIHUgKyBkICogYyAqIGYsIHRoaXMuX3ogPSBoICogYyAqIGYgLSBkICogcCAqIHUsIHRoaXMuX3cgPSBoICogYyAqIHUgLSBkICogcCAqIGY7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlhaWSI6CiAgICAgICAgdGhpcy5feCA9IGQgKiBjICogdSAtIGggKiBwICogZiwgdGhpcy5feSA9IGggKiBwICogdSAtIGQgKiBjICogZiwgdGhpcy5feiA9IGggKiBjICogZiArIGQgKiBwICogdSwgdGhpcy5fdyA9IGggKiBjICogdSArIGQgKiBwICogZjsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBjb25zb2xlLndhcm4oIlRIUkVFLlF1YXRlcm5pb246IC5zZXRGcm9tRXVsZXIoKSBlbmNvdW50ZXJlZCBhbiB1bmtub3duIG9yZGVyOiAiICsgcik7CiAgICB9CiAgICByZXR1cm4gZSA9PT0gITAgJiYgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgcXVhdGVybmlvbiBmcm9tIHRoZSBnaXZlbiBheGlzIGFuZCBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSBub3JtYWxpemVkIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHNldEZyb21BeGlzQW5nbGUodCwgZSkgewogICAgY29uc3QgaSA9IGUgLyAyLCBuID0gTWF0aC5zaW4oaSk7CiAgICByZXR1cm4gdGhpcy5feCA9IHQueCAqIG4sIHRoaXMuX3kgPSB0LnkgKiBuLCB0aGlzLl96ID0gdC56ICogbiwgdGhpcy5fdyA9IE1hdGguY29zKGkpLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBxdWF0ZXJuaW9uIGZyb20gdGhlIGdpdmVuIHJvdGF0aW9uIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIEEgNHg0IG1hdHJpeCBvZiB3aGljaCB0aGUgdXBwZXIgM3gzIG9mIG1hdHJpeCBpcyBhIHB1cmUgcm90YXRpb24gbWF0cml4IChpLmUuIHVuc2NhbGVkKS4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgc2V0RnJvbVJvdGF0aW9uTWF0cml4KHQpIHsKICAgIGNvbnN0IGUgPSB0LmVsZW1lbnRzLCBpID0gZVswXSwgbiA9IGVbNF0sIHMgPSBlWzhdLCByID0gZVsxXSwgbyA9IGVbNV0sIGwgPSBlWzldLCBoID0gZVsyXSwgYyA9IGVbNl0sIHUgPSBlWzEwXSwgZCA9IGkgKyBvICsgdTsKICAgIGlmIChkID4gMCkgewogICAgICBjb25zdCBwID0gMC41IC8gTWF0aC5zcXJ0KGQgKyAxKTsKICAgICAgdGhpcy5fdyA9IDAuMjUgLyBwLCB0aGlzLl94ID0gKGMgLSBsKSAqIHAsIHRoaXMuX3kgPSAocyAtIGgpICogcCwgdGhpcy5feiA9IChyIC0gbikgKiBwOwogICAgfSBlbHNlIGlmIChpID4gbyAmJiBpID4gdSkgewogICAgICBjb25zdCBwID0gMiAqIE1hdGguc3FydCgxICsgaSAtIG8gLSB1KTsKICAgICAgdGhpcy5fdyA9IChjIC0gbCkgLyBwLCB0aGlzLl94ID0gMC4yNSAqIHAsIHRoaXMuX3kgPSAobiArIHIpIC8gcCwgdGhpcy5feiA9IChzICsgaCkgLyBwOwogICAgfSBlbHNlIGlmIChvID4gdSkgewogICAgICBjb25zdCBwID0gMiAqIE1hdGguc3FydCgxICsgbyAtIGkgLSB1KTsKICAgICAgdGhpcy5fdyA9IChzIC0gaCkgLyBwLCB0aGlzLl94ID0gKG4gKyByKSAvIHAsIHRoaXMuX3kgPSAwLjI1ICogcCwgdGhpcy5feiA9IChsICsgYykgLyBwOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcCA9IDIgKiBNYXRoLnNxcnQoMSArIHUgLSBpIC0gbyk7CiAgICAgIHRoaXMuX3cgPSAociAtIG4pIC8gcCwgdGhpcy5feCA9IChzICsgaCkgLyBwLCB0aGlzLl95ID0gKGwgKyBjKSAvIHAsIHRoaXMuX3ogPSAwLjI1ICogcDsKICAgIH0KICAgIHJldHVybiB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBxdWF0ZXJuaW9uIHRvIHRoZSByb3RhdGlvbiByZXF1aXJlZCB0byByb3RhdGUgdGhlIGRpcmVjdGlvbiB2ZWN0b3IKICAgKiBgdkZyb21gIHRvIHRoZSBkaXJlY3Rpb24gdmVjdG9yIGB2VG9gLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2RnJvbSAtIFRoZSBmaXJzdCAobm9ybWFsaXplZCkgZGlyZWN0aW9uIHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHZUbyAtIFRoZSBzZWNvbmQgKG5vcm1hbGl6ZWQpIGRpcmVjdGlvbiB2ZWN0b3IuCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIHNldEZyb21Vbml0VmVjdG9ycyh0LCBlKSB7CiAgICBsZXQgaSA9IHQuZG90KGUpICsgMTsKICAgIHJldHVybiBpIDwgMWUtOCA/IChpID0gMCwgTWF0aC5hYnModC54KSA+IE1hdGguYWJzKHQueikgPyAodGhpcy5feCA9IC10LnksIHRoaXMuX3kgPSB0LngsIHRoaXMuX3ogPSAwLCB0aGlzLl93ID0gaSkgOiAodGhpcy5feCA9IDAsIHRoaXMuX3kgPSAtdC56LCB0aGlzLl96ID0gdC55LCB0aGlzLl93ID0gaSkpIDogKHRoaXMuX3ggPSB0LnkgKiBlLnogLSB0LnogKiBlLnksIHRoaXMuX3kgPSB0LnogKiBlLnggLSB0LnggKiBlLnosIHRoaXMuX3ogPSB0LnggKiBlLnkgLSB0LnkgKiBlLngsIHRoaXMuX3cgPSBpKSwgdGhpcy5ub3JtYWxpemUoKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgYW5nbGUgYmV0d2VlbiB0aGlzIHF1YXRlcm5pb24gYW5kIHRoZSBnaXZlbiBvbmUgaW4gcmFkaWFucy4KICAgKgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcSAtIFRoZSBxdWF0ZXJuaW9uIHRvIGNvbXB1dGUgdGhlIGFuZ2xlIHdpdGguCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgKi8KICBhbmdsZVRvKHQpIHsKICAgIHJldHVybiAyICogTWF0aC5hY29zKE1hdGguYWJzKHllKHRoaXMuZG90KHQpLCAtMSwgMSkpKTsKICB9CiAgLyoqCiAgICogUm90YXRlcyB0aGlzIHF1YXRlcm5pb24gYnkgYSBnaXZlbiBhbmd1bGFyIHN0ZXAgdG8gdGhlIGdpdmVuIHF1YXRlcm5pb24uCiAgICogVGhlIG1ldGhvZCBlbnN1cmVzIHRoYXQgdGhlIGZpbmFsIHF1YXRlcm5pb24gd2lsbCBub3Qgb3ZlcnNob290IGBxYC4KICAgKgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcSAtIFRoZSB0YXJnZXQgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcCAtIFRoZSBhbmd1bGFyIHN0ZXAgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgcm90YXRlVG93YXJkcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5hbmdsZVRvKHQpOwogICAgaWYgKGkgPT09IDApIHJldHVybiB0aGlzOwogICAgY29uc3QgbiA9IE1hdGgubWluKDEsIGUgLyBpKTsKICAgIHJldHVybiB0aGlzLnNsZXJwKHQsIG4pLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgcXVhdGVybmlvbiB0byB0aGUgaWRlbnRpdHkgcXVhdGVybmlvbjsgdGhhdCBpcywgdG8gdGhlCiAgICogcXVhdGVybmlvbiB0aGF0IHJlcHJlc2VudHMgIm5vIHJvdGF0aW9uIi4KICAgKgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBpZGVudGl0eSgpIHsKICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwLCAxKTsKICB9CiAgLyoqCiAgICogSW52ZXJ0cyB0aGlzIHF1YXRlcm5pb24gdmlhIHtAbGluayBRdWF0ZXJuaW9uI2Nvbmp1Z2F0ZX0uIFRoZQogICAqIHF1YXRlcm5pb24gaXMgYXNzdW1lZCB0byBoYXZlIHVuaXQgbGVuZ3RoLgogICAqCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIGludmVydCgpIHsKICAgIHJldHVybiB0aGlzLmNvbmp1Z2F0ZSgpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSByb3RhdGlvbmFsIGNvbmp1Z2F0ZSBvZiB0aGlzIHF1YXRlcm5pb24uIFRoZSBjb25qdWdhdGUgb2YgYQogICAqIHF1YXRlcm5pb24gcmVwcmVzZW50cyB0aGUgc2FtZSByb3RhdGlvbiBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uIGFib3V0CiAgICogdGhlIHJvdGF0aW9uYWwgYXhpcy4KICAgKgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBjb25qdWdhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5feCAqPSAtMSwgdGhpcy5feSAqPSAtMSwgdGhpcy5feiAqPSAtMSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBkb3QgcHJvZHVjdCBvZiB0aGlzIHF1YXRlcm5pb24gYW5kIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHYgLSBUaGUgcXVhdGVybmlvbiB0byBjb21wdXRlIHRoZSBkb3QgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgZG90IHByb2R1Y3QuCiAgICovCiAgZG90KHQpIHsKICAgIHJldHVybiB0aGlzLl94ICogdC5feCArIHRoaXMuX3kgKiB0Ll95ICsgdGhpcy5feiAqIHQuX3ogKyB0aGlzLl93ICogdC5fdzsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIHNxdWFyZWQgRXVjbGlkZWFuIGxlbmd0aCAoc3RyYWlnaHQtbGluZSBsZW5ndGgpIG9mIHRoaXMgcXVhdGVybmlvbiwKICAgKiBjb25zaWRlcmVkIGFzIGEgNCBkaW1lbnNpb25hbCB2ZWN0b3IuIFRoaXMgY2FuIGJlIHVzZWZ1bCBpZiB5b3UgYXJlIGNvbXBhcmluZyB0aGUKICAgKiBsZW5ndGhzIG9mIHR3byBxdWF0ZXJuaW9ucywgYXMgdGhpcyBpcyBhIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IGNhbGN1bGF0aW9uIHRoYW4KICAgKiB7QGxpbmsgUXVhdGVybmlvbiNsZW5ndGh9LgogICAqCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgc3F1YXJlZCBFdWNsaWRlYW4gbGVuZ3RoLgogICAqLwogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMuX3ggKiB0aGlzLl94ICsgdGhpcy5feSAqIHRoaXMuX3kgKyB0aGlzLl96ICogdGhpcy5feiArIHRoaXMuX3cgKiB0aGlzLl93OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgRXVjbGlkZWFuIGxlbmd0aCAoc3RyYWlnaHQtbGluZSBsZW5ndGgpIG9mIHRoaXMgcXVhdGVybmlvbiwKICAgKiBjb25zaWRlcmVkIGFzIGEgNCBkaW1lbnNpb25hbCB2ZWN0b3IuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBFdWNsaWRlYW4gbGVuZ3RoLgogICAqLwogIGxlbmd0aCgpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5feCAqIHRoaXMuX3ggKyB0aGlzLl95ICogdGhpcy5feSArIHRoaXMuX3ogKiB0aGlzLl96ICsgdGhpcy5fdyAqIHRoaXMuX3cpOwogIH0KICAvKioKICAgKiBOb3JtYWxpemVzIHRoaXMgcXVhdGVybmlvbiAtIHRoYXQgaXMsIGNhbGN1bGF0ZWQgdGhlIHF1YXRlcm5pb24gdGhhdCBwZXJmb3JtcwogICAqIHRoZSBzYW1lIHJvdGF0aW9uIGFzIHRoaXMgb25lLCBidXQgaGFzIGEgbGVuZ3RoIGVxdWFsIHRvIGAxYC4KICAgKgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBub3JtYWxpemUoKSB7CiAgICBsZXQgdCA9IHRoaXMubGVuZ3RoKCk7CiAgICByZXR1cm4gdCA9PT0gMCA/ICh0aGlzLl94ID0gMCwgdGhpcy5feSA9IDAsIHRoaXMuX3ogPSAwLCB0aGlzLl93ID0gMSkgOiAodCA9IDEgLyB0LCB0aGlzLl94ID0gdGhpcy5feCAqIHQsIHRoaXMuX3kgPSB0aGlzLl95ICogdCwgdGhpcy5feiA9IHRoaXMuX3ogKiB0LCB0aGlzLl93ID0gdGhpcy5fdyAqIHQpLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhpcyBxdWF0ZXJuaW9uIGJ5IHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgcXVhdGVybmlvbi4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlRdWF0ZXJuaW9ucyh0aGlzLCB0KTsKICB9CiAgLyoqCiAgICogUHJlLW11bHRpcGxpZXMgdGhpcyBxdWF0ZXJuaW9uIGJ5IHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgcXVhdGVybmlvbi4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgcHJlbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlRdWF0ZXJuaW9ucyh0LCB0aGlzKTsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gcXVhdGVybmlvbnMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0IGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IGEgLSBUaGUgZmlyc3QgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IGIgLSBUaGUgc2Vjb25kIHF1YXRlcm5pb24uCiAgICogQHJldHVybiB7UXVhdGVybmlvbn0gQSByZWZlcmVuY2UgdG8gdGhpcyBxdWF0ZXJuaW9uLgogICAqLwogIG11bHRpcGx5UXVhdGVybmlvbnModCwgZSkgewogICAgY29uc3QgaSA9IHQuX3gsIG4gPSB0Ll95LCBzID0gdC5feiwgciA9IHQuX3csIG8gPSBlLl94LCBsID0gZS5feSwgaCA9IGUuX3osIGMgPSBlLl93OwogICAgcmV0dXJuIHRoaXMuX3ggPSBpICogYyArIHIgKiBvICsgbiAqIGggLSBzICogbCwgdGhpcy5feSA9IG4gKiBjICsgciAqIGwgKyBzICogbyAtIGkgKiBoLCB0aGlzLl96ID0gcyAqIGMgKyByICogaCArIGkgKiBsIC0gbiAqIG8sIHRoaXMuX3cgPSByICogYyAtIGkgKiBvIC0gbiAqIGwgLSBzICogaCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBQZXJmb3JtcyBhIHNwaGVyaWNhbCBsaW5lYXIgaW50ZXJwb2xhdGlvbiBiZXR3ZWVuIHF1YXRlcm5pb25zLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxYiAtIFRoZSB0YXJnZXQgcXVhdGVybmlvbi4KICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciBpbiB0aGUgY2xvc2VkIGludGVydmFsIGBbMCwgMV1gLgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBzbGVycCh0LCBlKSB7CiAgICBpZiAoZSA9PT0gMCkgcmV0dXJuIHRoaXM7CiAgICBpZiAoZSA9PT0gMSkgcmV0dXJuIHRoaXMuY29weSh0KTsKICAgIGNvbnN0IGkgPSB0aGlzLl94LCBuID0gdGhpcy5feSwgcyA9IHRoaXMuX3osIHIgPSB0aGlzLl93OwogICAgbGV0IG8gPSByICogdC5fdyArIGkgKiB0Ll94ICsgbiAqIHQuX3kgKyBzICogdC5fejsKICAgIGlmIChvIDwgMCA/ICh0aGlzLl93ID0gLXQuX3csIHRoaXMuX3ggPSAtdC5feCwgdGhpcy5feSA9IC10Ll95LCB0aGlzLl96ID0gLXQuX3osIG8gPSAtbykgOiB0aGlzLmNvcHkodCksIG8gPj0gMSkKICAgICAgcmV0dXJuIHRoaXMuX3cgPSByLCB0aGlzLl94ID0gaSwgdGhpcy5feSA9IG4sIHRoaXMuX3ogPSBzLCB0aGlzOwogICAgY29uc3QgbCA9IDEgLSBvICogbzsKICAgIGlmIChsIDw9IE51bWJlci5FUFNJTE9OKSB7CiAgICAgIGNvbnN0IHAgPSAxIC0gZTsKICAgICAgcmV0dXJuIHRoaXMuX3cgPSBwICogciArIGUgKiB0aGlzLl93LCB0aGlzLl94ID0gcCAqIGkgKyBlICogdGhpcy5feCwgdGhpcy5feSA9IHAgKiBuICsgZSAqIHRoaXMuX3ksIHRoaXMuX3ogPSBwICogcyArIGUgKiB0aGlzLl96LCB0aGlzLm5vcm1hbGl6ZSgpLCB0aGlzOwogICAgfQogICAgY29uc3QgaCA9IE1hdGguc3FydChsKSwgYyA9IE1hdGguYXRhbjIoaCwgbyksIHUgPSBNYXRoLnNpbigoMSAtIGUpICogYykgLyBoLCBkID0gTWF0aC5zaW4oZSAqIGMpIC8gaDsKICAgIHJldHVybiB0aGlzLl93ID0gciAqIHUgKyB0aGlzLl93ICogZCwgdGhpcy5feCA9IGkgKiB1ICsgdGhpcy5feCAqIGQsIHRoaXMuX3kgPSBuICogdSArIHRoaXMuX3kgKiBkLCB0aGlzLl96ID0gcyAqIHUgKyB0aGlzLl96ICogZCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBQZXJmb3JtcyBhIHNwaGVyaWNhbCBsaW5lYXIgaW50ZXJwb2xhdGlvbiBiZXR3ZWVuIHRoZSBnaXZlbiBxdWF0ZXJuaW9ucwogICAqIGFuZCBzdG9yZXMgdGhlIHJlc3VsdCBpbiB0aGlzIHF1YXRlcm5pb24uCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHFhIC0gVGhlIHNvdXJjZSBxdWF0ZXJuaW9uLgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcWIgLSBUaGUgdGFyZ2V0IHF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgLSBUaGUgaW50ZXJwb2xhdGlvbiBmYWN0b3IgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBBIHJlZmVyZW5jZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICovCiAgc2xlcnBRdWF0ZXJuaW9ucyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5jb3B5KHQpLnNsZXJwKGUsIGkpOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgcXVhdGVybmlvbiB0byBhIHVuaWZvcm1seSByYW5kb20sIG5vcm1hbGl6ZWQgcXVhdGVybmlvbi4KICAgKgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICByYW5kb20oKSB7CiAgICBjb25zdCB0ID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpLCBlID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpLCBpID0gTWF0aC5yYW5kb20oKSwgbiA9IE1hdGguc3FydCgxIC0gaSksIHMgPSBNYXRoLnNxcnQoaSk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIG4gKiBNYXRoLnNpbih0KSwKICAgICAgbiAqIE1hdGguY29zKHQpLAogICAgICBzICogTWF0aC5zaW4oZSksCiAgICAgIHMgKiBNYXRoLmNvcyhlKQogICAgKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyBxdWF0ZXJuaW9uIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcXVhdGVybmlvbiAtIFRoZSBxdWF0ZXJuaW9uIHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyBxdWF0ZXJuaW9uIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuX3ggPT09IHRoaXMuX3ggJiYgdC5feSA9PT0gdGhpcy5feSAmJiB0Ll96ID09PSB0aGlzLl96ICYmIHQuX3cgPT09IHRoaXMuX3c7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBxdWF0ZXJuaW9uJ3MgY29tcG9uZW50cyBmcm9tIHRoZSBnaXZlbiBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYXJyYXkgLSBBbiBhcnJheSBob2xkaW5nIHRoZSBxdWF0ZXJuaW9uIGNvbXBvbmVudCB2YWx1ZXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBUaGUgb2Zmc2V0IGludG8gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLl94ID0gdFtlXSwgdGhpcy5feSA9IHRbZSArIDFdLCB0aGlzLl96ID0gdFtlICsgMl0sIHRoaXMuX3cgPSB0W2UgKyAzXSwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBXcml0ZXMgdGhlIGNvbXBvbmVudHMgb2YgdGhpcyBxdWF0ZXJuaW9uIHRvIHRoZSBnaXZlbiBhcnJheS4gSWYgbm8gYXJyYXkgaXMgcHJvdmlkZWQsCiAgICogdGhlIG1ldGhvZCByZXR1cm5zIGEgbmV3IGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBbYXJyYXk9W11dIC0gVGhlIHRhcmdldCBhcnJheSBob2xkaW5nIHRoZSBxdWF0ZXJuaW9uIGNvbXBvbmVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBJbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gVGhlIHF1YXRlcm5pb24gY29tcG9uZW50cy4KICAgKi8KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIHJldHVybiB0W2VdID0gdGhpcy5feCwgdFtlICsgMV0gPSB0aGlzLl95LCB0W2UgKyAyXSA9IHRoaXMuX3osIHRbZSArIDNdID0gdGhpcy5fdywgdDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIHF1YXRlcm5pb24gZnJvbSB0aGUgZ2l2ZW4gYnVmZmVyIGF0dHJpYnV0ZS4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyQXR0cmlidXRlfSBhdHRyaWJ1dGUgLSBUaGUgYnVmZmVyIGF0dHJpYnV0ZSBob2xkaW5nIHF1YXRlcm5pb24gZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYXR0cmlidXRlLgogICAqIEByZXR1cm4ge1F1YXRlcm5pb259IEEgcmVmZXJlbmNlIHRvIHRoaXMgcXVhdGVybmlvbi4KICAgKi8KICBmcm9tQnVmZmVyQXR0cmlidXRlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLl94ID0gdC5nZXRYKGUpLCB0aGlzLl95ID0gdC5nZXRZKGUpLCB0aGlzLl96ID0gdC5nZXRaKGUpLCB0aGlzLl93ID0gdC5nZXRXKGUpLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFRoaXMgbWV0aG9kcyBkZWZpbmVzIHRoZSBzZXJpYWxpemF0aW9uIHJlc3VsdCBvZiB0aGlzIGNsYXNzLiBSZXR1cm5zIHRoZQogICAqIG51bWVyaWNhbCBlbGVtZW50cyBvZiB0aGlzIHF1YXRlcm5pb24gaW4gYW4gYXJyYXkgb2YgZm9ybWF0IGBbeCwgeSwgeiwgd11gLgogICAqCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gVGhlIHNlcmlhbGl6ZWQgcXVhdGVybmlvbi4KICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy50b0FycmF5KCk7CiAgfQogIF9vbkNoYW5nZSh0KSB7CiAgICByZXR1cm4gdGhpcy5fb25DaGFuZ2VDYWxsYmFjayA9IHQsIHRoaXM7CiAgfQogIF9vbkNoYW5nZUNhbGxiYWNrKCkgewogIH0KICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICB5aWVsZCB0aGlzLl94LCB5aWVsZCB0aGlzLl95LCB5aWVsZCB0aGlzLl96LCB5aWVsZCB0aGlzLl93OwogIH0KfQpjbGFzcyBGZSB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzRCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgeCB2YWx1ZSBvZiB0aGlzIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gW3k9MF0gLSBUaGUgeSB2YWx1ZSBvZiB0aGlzIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gW3o9MF0gLSBUaGUgeiB2YWx1ZSBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gMCwgZSA9IDAsIGkgPSAwKSB7CiAgICBGZS5wcm90b3R5cGUuaXNWZWN0b3IzID0gITAsIHRoaXMueCA9IHQsIHRoaXMueSA9IGUsIHRoaXMueiA9IGk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgb2YgdGhlIHggY29tcG9uZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIG9mIHRoZSB5IGNvbXBvbmVudC4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSB2YWx1ZSBvZiB0aGUgeiBjb21wb25lbnQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0KHQsIGUsIGkpIHsKICAgIHJldHVybiBpID09PSB2b2lkIDAgJiYgKGkgPSB0aGlzLnopLCB0aGlzLnggPSB0LCB0aGlzLnkgPSBlLCB0aGlzLnogPSBpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyB0byB0aGUgc2FtZSB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgdmFsdWUgdG8gc2V0IGZvciBhbGwgdmVjdG9yIGNvbXBvbmVudHMuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzLnkgPSB0LCB0aGlzLnogPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB4IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRYKHQpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB5IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRZKHQpIHsKICAgIHJldHVybiB0aGlzLnkgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IncyB6IGNvbXBvbmVudCB0byB0aGUgZ2l2ZW4gdmFsdWUKICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB6IC0gVGhlIHZhbHVlIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRaKHQpIHsKICAgIHJldHVybiB0aGlzLnogPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBbGxvd3MgdG8gc2V0IGEgdmVjdG9yIGNvbXBvbmVudCB3aXRoIGFuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGNvbXBvbmVudCBpbmRleC4gYDBgIGVxdWFscyB0byB4LCBgMWAgZXF1YWxzIHRvIHksIGAyYCBlcXVhbHMgdG8gei4KICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldENvbXBvbmVudCh0LCBlKSB7CiAgICBzd2l0Y2ggKHQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMueCA9IGU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSBlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy56ID0gZTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImluZGV4IGlzIG91dCBvZiByYW5nZTogIiArIHQpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSB2ZWN0b3IgY29tcG9uZW50IHdoaWNoIG1hdGNoZXMgdGhlIGdpdmVuIGluZGV4LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGNvbXBvbmVudCBpbmRleC4gYDBgIGVxdWFscyB0byB4LCBgMWAgZXF1YWxzIHRvIHksIGAyYCBlcXVhbHMgdG8gei4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IEEgdmVjdG9yIGNvbXBvbmVudCB2YWx1ZS4KICAgKi8KICBnZXRDb21wb25lbnQodCkgewogICAgc3dpdGNoICh0KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgICBjYXNlIDE6CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgICAgY2FzZSAyOgogICAgICAgIHJldHVybiB0aGlzLno7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyB0KTsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyBhIG5ldyB2ZWN0b3Igd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLngsIHRoaXMueSwgdGhpcy56KTsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB2YWx1ZXMgb2YgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb3B5LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNvcHkodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQueCwgdGhpcy55ID0gdC55LCB0aGlzLnogPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBhZGQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdC54LCB0aGlzLnkgKz0gdC55LCB0aGlzLnogKz0gdC56LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiBzY2FsYXIgdmFsdWUgdG8gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBhZGQuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYWRkU2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnggKz0gdCwgdGhpcy55ICs9IHQsIHRoaXMueiArPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3JzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdCBpbiB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBhIC0gVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGIgLSBUaGUgc2Vjb25kIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhZGRWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKyBlLngsIHRoaXMueSA9IHQueSArIGUueSwgdGhpcy56ID0gdC56ICsgZS56LCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBnaXZlbiB2ZWN0b3Igc2NhbGVkIGJ5IHRoZSBnaXZlbiBmYWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM3xWZWN0b3I0fSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBmYWN0b3IgdGhhdCBzY2FsZXMgYHZgLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGFkZFNjYWxlZFZlY3Rvcih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ICs9IHQueCAqIGUsIHRoaXMueSArPSB0LnkgKiBlLCB0aGlzLnogKz0gdC56ICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogU3VidHJhY3RzIHRoZSBnaXZlbiB2ZWN0b3IgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LngsIHRoaXMueSAtPSB0LnksIHRoaXMueiAtPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIGZyb20gYWxsIGNvbXBvbmVudHMgb2YgdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBzdWJ0cmFjdC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzdWJTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMueCAtPSB0LCB0aGlzLnkgLT0gdCwgdGhpcy56IC09IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gdmVjdG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBiIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc3ViVmVjdG9ycyh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54IC0gZS54LCB0aGlzLnkgPSB0LnkgLSBlLnksIHRoaXMueiA9IHQueiAtIGUueiwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gbXVsdGlwbHkuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMueCAqPSB0LngsIHRoaXMueSAqPSB0LnksIHRoaXMueiAqPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSB3aXRoIGFsbCBjb21wb25lbnRzIG9mIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGFyIC0gVGhlIHNjYWxhciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy54ICo9IHQsIHRoaXMueSAqPSB0LCB0aGlzLnogKj0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gdmVjdG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYSAtIFRoZSBmaXJzdCB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSBiIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbXVsdGlwbHlWZWN0b3JzKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LnggKiBlLngsIHRoaXMueSA9IHQueSAqIGUueSwgdGhpcy56ID0gdC56ICogZS56LCB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiBFdWxlciByb3RhdGlvbiB0byB0aGlzIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGFuZ2xlcy4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhcHBseUV1bGVyKHQpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihpMC5zZXRGcm9tRXVsZXIodCkpOwogIH0KICAvKioKICAgKiBBcHBsaWVzIGEgcm90YXRpb24gc3BlY2lmaWVkIGJ5IGFuIGF4aXMgYW5kIGFuIGFuZ2xlIHRvIHRoaXMgdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSBheGlzIC0gQSBub3JtYWxpemVkIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIHJvdGF0aW9uIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlBeGlzQW5nbGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlRdWF0ZXJuaW9uKGkwLnNldEZyb21BeGlzQW5nbGUodCwgZSkpOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoaXMgdmVjdG9yIHdpdGggdGhlIGdpdmVuIDN4MyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgM3gzIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhcHBseU1hdHJpeDModCkgewogICAgY29uc3QgZSA9IHRoaXMueCwgaSA9IHRoaXMueSwgbiA9IHRoaXMueiwgcyA9IHQuZWxlbWVudHM7CiAgICByZXR1cm4gdGhpcy54ID0gc1swXSAqIGUgKyBzWzNdICogaSArIHNbNl0gKiBuLCB0aGlzLnkgPSBzWzFdICogZSArIHNbNF0gKiBpICsgc1s3XSAqIG4sIHRoaXMueiA9IHNbMl0gKiBlICsgc1s1XSAqIGkgKyBzWzhdICogbiwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGlzIHZlY3RvciBieSB0aGUgZ2l2ZW4gbm9ybWFsIG1hdHJpeCBhbmQgbm9ybWFsaXplcwogICAqIHRoZSByZXN1bHQuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbm9ybWFsIG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBhcHBseU5vcm1hbE1hdHJpeCh0KSB7CiAgICByZXR1cm4gdGhpcy5hcHBseU1hdHJpeDModCkubm9ybWFsaXplKCk7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgdGhpcyB2ZWN0b3IgKHdpdGggYW4gaW1wbGljaXQgMSBpbiB0aGUgNHRoIGRpbWVuc2lvbikgYnkgbSwgYW5kCiAgICogZGl2aWRlcyBieSBwZXJzcGVjdGl2ZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSBtYXRyaXggdG8gYXBwbHkuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlNYXRyaXg0KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0aGlzLnosIHMgPSB0LmVsZW1lbnRzLCByID0gMSAvIChzWzNdICogZSArIHNbN10gKiBpICsgc1sxMV0gKiBuICsgc1sxNV0pOwogICAgcmV0dXJuIHRoaXMueCA9IChzWzBdICogZSArIHNbNF0gKiBpICsgc1s4XSAqIG4gKyBzWzEyXSkgKiByLCB0aGlzLnkgPSAoc1sxXSAqIGUgKyBzWzVdICogaSArIHNbOV0gKiBuICsgc1sxM10pICogciwgdGhpcy56ID0gKHNbMl0gKiBlICsgc1s2XSAqIGkgKyBzWzEwXSAqIG4gKyBzWzE0XSkgKiByLCB0aGlzOwogIH0KICAvKioKICAgKiBBcHBsaWVzIHRoZSBnaXZlbiBRdWF0ZXJuaW9uIHRvIHRoaXMgdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIFF1YXRlcm5pb24uCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgYXBwbHlRdWF0ZXJuaW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLngsIGkgPSB0aGlzLnksIG4gPSB0aGlzLnosIHMgPSB0LngsIHIgPSB0LnksIG8gPSB0LnosIGwgPSB0LncsIGggPSAyICogKHIgKiBuIC0gbyAqIGkpLCBjID0gMiAqIChvICogZSAtIHMgKiBuKSwgdSA9IDIgKiAocyAqIGkgLSByICogZSk7CiAgICByZXR1cm4gdGhpcy54ID0gZSArIGwgKiBoICsgciAqIHUgLSBvICogYywgdGhpcy55ID0gaSArIGwgKiBjICsgbyAqIGggLSBzICogdSwgdGhpcy56ID0gbiArIGwgKiB1ICsgcyAqIGMgLSByICogaCwgdGhpczsKICB9CiAgLyoqCiAgICogUHJvamVjdHMgdGhpcyB2ZWN0b3IgZnJvbSB3b3JsZCBzcGFjZSBpbnRvIHRoZSBjYW1lcmEncyBub3JtYWxpemVkCiAgICogZGV2aWNlIGNvb3JkaW5hdGUgKE5EQykgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBwcm9qZWN0KHQpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkSW52ZXJzZSkuYXBwbHlNYXRyaXg0KHQucHJvamVjdGlvbk1hdHJpeCk7CiAgfQogIC8qKgogICAqIFVucHJvamVjdHMgdGhpcyB2ZWN0b3IgZnJvbSB0aGUgY2FtZXJhJ3Mgbm9ybWFsaXplZCBkZXZpY2UgY29vcmRpbmF0ZSAoTkRDKQogICAqIHNwYWNlIGludG8gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICB1bnByb2plY3QodCkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlNYXRyaXg0KHQucHJvamVjdGlvbk1hdHJpeEludmVyc2UpLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkKTsKICB9CiAgLyoqCiAgICogVHJhbnNmb3JtcyB0aGUgZGlyZWN0aW9uIG9mIHRoaXMgdmVjdG9yIGJ5IGEgbWF0cml4ICh0aGUgdXBwZXIgbGVmdCAzIHggMwogICAqIHN1YnNldCBvZiB0aGUgZ2l2ZW4gNHg0IG1hdHJpeCBhbmQgdGhlbiBub3JtYWxpemVzIHRoZSByZXN1bHQuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHRyYW5zZm9ybURpcmVjdGlvbih0KSB7CiAgICBjb25zdCBlID0gdGhpcy54LCBpID0gdGhpcy55LCBuID0gdGhpcy56LCBzID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnggPSBzWzBdICogZSArIHNbNF0gKiBpICsgc1s4XSAqIG4sIHRoaXMueSA9IHNbMV0gKiBlICsgc1s1XSAqIGkgKyBzWzldICogbiwgdGhpcy56ID0gc1syXSAqIGUgKyBzWzZdICogaSArIHNbMTBdICogbiwgdGhpcy5ub3JtYWxpemUoKTsKICB9CiAgLyoqCiAgICogRGl2aWRlcyB0aGlzIGluc3RhbmNlIGJ5IHRoZSBnaXZlbiB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGUodCkgewogICAgcmV0dXJuIHRoaXMueCAvPSB0LngsIHRoaXMueSAvPSB0LnksIHRoaXMueiAvPSB0LnosIHRoaXM7CiAgfQogIC8qKgogICAqIERpdmlkZXMgdGhpcyB2ZWN0b3IgYnkgdGhlIGdpdmVuIHNjYWxhci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsYXIgLSBUaGUgc2NhbGFyIHRvIGRpdmlkZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBkaXZpZGVTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoMSAvIHQpOwogIH0KICAvKioKICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHkgb3IgeiB2YWx1ZSBpcyBncmVhdGVyIHRoYW4gdGhlIGdpdmVuIHZlY3RvcidzIHgsIHkgb3IgegogICAqIHZhbHVlLCByZXBsYWNlIHRoYXQgdmFsdWUgd2l0aCB0aGUgY29ycmVzcG9uZGluZyBtaW4gdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIG1pbih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5taW4odGhpcy54LCB0LngpLCB0aGlzLnkgPSBNYXRoLm1pbih0aGlzLnksIHQueSksIHRoaXMueiA9IE1hdGgubWluKHRoaXMueiwgdC56KSwgdGhpczsKICB9CiAgLyoqCiAgICogSWYgdGhpcyB2ZWN0b3IncyB4LCB5IG9yIHogdmFsdWUgaXMgbGVzcyB0aGFuIHRoZSBnaXZlbiB2ZWN0b3IncyB4LCB5IG9yIHoKICAgKiB2YWx1ZSwgcmVwbGFjZSB0aGF0IHZhbHVlIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgbWF4IHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBtYXgodCkgewogICAgcmV0dXJuIHRoaXMueCA9IE1hdGgubWF4KHRoaXMueCwgdC54KSwgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB0LnkpLCB0aGlzLnogPSBNYXRoLm1heCh0aGlzLnosIHQueiksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSBvciB6IHZhbHVlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZlY3RvcidzIHgsIHkgb3IgegogICAqIHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieSB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHkgb3IgeiB2YWx1ZSBpcyBsZXNzIHRoYW4gdGhlIG1pbiB2ZWN0b3IncyB4LCB5IG9yIHogdmFsdWUsCiAgICogaXQgaXMgcmVwbGFjZWQgYnkgdGhlIGNvcnJlc3BvbmRpbmcgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IG1pbiAtIFRoZSBtaW5pbXVtIHgsIHkgYW5kIHogdmFsdWVzLgogICAqIEBwYXJhbSB7VmVjdG9yM30gbWF4IC0gVGhlIG1heGltdW0geCwgeSBhbmQgeiB2YWx1ZXMgaW4gdGhlIGRlc2lyZWQgcmFuZ2UuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXAodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHllKHRoaXMueCwgdC54LCBlLngpLCB0aGlzLnkgPSB5ZSh0aGlzLnksIHQueSwgZS55KSwgdGhpcy56ID0geWUodGhpcy56LCB0LnosIGUueiksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgeCwgeSBvciB6IHZhbHVlcyBhcmUgZ3JlYXRlciB0aGFuIHRoZSBtYXggdmFsdWUsIHRoZXkgYXJlCiAgICogcmVwbGFjZWQgYnkgdGhlIG1heCB2YWx1ZS4KICAgKiBJZiB0aGlzIHZlY3RvcidzIHgsIHkgb3IgeiB2YWx1ZXMgYXJlIGxlc3MgdGhhbiB0aGUgbWluIHZhbHVlLCB0aGV5IGFyZQogICAqIHJlcGxhY2VkIGJ5IHRoZSBtaW4gdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbWluVmFsIC0gVGhlIG1pbmltdW0gdmFsdWUgdGhlIGNvbXBvbmVudHMgd2lsbCBiZSBjbGFtcGVkIHRvLgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhWYWwgLSBUaGUgbWF4aW11bSB2YWx1ZSB0aGUgY29tcG9uZW50cyB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgY2xhbXBTY2FsYXIodCwgZSkgewogICAgcmV0dXJuIHRoaXMueCA9IHllKHRoaXMueCwgdCwgZSksIHRoaXMueSA9IHllKHRoaXMueSwgdCwgZSksIHRoaXMueiA9IHllKHRoaXMueiwgdCwgZSksIHRoaXM7CiAgfQogIC8qKgogICAqIElmIHRoaXMgdmVjdG9yJ3MgbGVuZ3RoIGlzIGdyZWF0ZXIgdGhhbiB0aGUgbWF4IHZhbHVlLCBpdCBpcyByZXBsYWNlZCBieQogICAqIHRoZSBtYXggdmFsdWUuCiAgICogSWYgdGhpcyB2ZWN0b3IncyBsZW5ndGggaXMgbGVzcyB0aGFuIHRoZSBtaW4gdmFsdWUsIGl0IGlzIHJlcGxhY2VkIGJ5IHRoZQogICAqIG1pbiB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0aGUgdmVjdG9yIGxlbmd0aCB3aWxsIGJlIGNsYW1wZWQgdG8uCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRoZSB2ZWN0b3IgbGVuZ3RoIHdpbGwgYmUgY2xhbXBlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBjbGFtcExlbmd0aCh0LCBlKSB7CiAgICBjb25zdCBpID0gdGhpcy5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcihpIHx8IDEpLm11bHRpcGx5U2NhbGFyKHllKGksIHQsIGUpKTsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgZG93biB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgZmxvb3IoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpLCB0aGlzLnkgPSBNYXRoLmZsb29yKHRoaXMueSksIHRoaXMueiA9IE1hdGguZmxvb3IodGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdXAgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNlaWwoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCksIHRoaXMueSA9IE1hdGguY2VpbCh0aGlzLnkpLCB0aGlzLnogPSBNYXRoLmNlaWwodGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciB2YWx1ZQogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yb3VuZCh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnJvdW5kKHRoaXMueSksIHRoaXMueiA9IE1hdGgucm91bmQodGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogVGhlIGNvbXBvbmVudHMgb2YgdGhpcyB2ZWN0b3IgYXJlIHJvdW5kZWQgdG93YXJkcyB6ZXJvICh1cCBpZiBuZWdhdGl2ZSwKICAgKiBkb3duIGlmIHBvc2l0aXZlKSB0byBhbiBpbnRlZ2VyIHZhbHVlLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgcm91bmRUb1plcm8oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC50cnVuYyh0aGlzLngpLCB0aGlzLnkgPSBNYXRoLnRydW5jKHRoaXMueSksIHRoaXMueiA9IE1hdGgudHJ1bmModGhpcy56KSwgdGhpczsKICB9CiAgLyoqCiAgICogSW52ZXJ0cyB0aGlzIHZlY3RvciAtIGkuZS4gc2V0cyB4ID0gLXgsIHkgPSAteSBhbmQgeiA9IC16LgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbmVnYXRlKCkgewogICAgcmV0dXJuIHRoaXMueCA9IC10aGlzLngsIHRoaXMueSA9IC10aGlzLnksIHRoaXMueiA9IC10aGlzLnosIHRoaXM7CiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIGRvdCBwcm9kdWN0IG9mIHRoZSBnaXZlbiB2ZWN0b3Igd2l0aCB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBkb3QgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJlc3VsdCBvZiB0aGUgZG90IHByb2R1Y3QuCiAgICovCiAgZG90KHQpIHsKICAgIHJldHVybiB0aGlzLnggKiB0LnggKyB0aGlzLnkgKiB0LnkgKyB0aGlzLnogKiB0Lno7CiAgfQogIC8vIFRPRE8gbGVuZ3RoU3F1YXJlZD8KICAvKioKICAgKiBDb21wdXRlcyB0aGUgc3F1YXJlIG9mIHRoZSBFdWNsaWRlYW4gbGVuZ3RoIChzdHJhaWdodC1saW5lIGxlbmd0aCkgZnJvbQogICAqICgwLCAwLCAwKSB0byAoeCwgeSwgeikuIElmIHlvdSBhcmUgY29tcGFyaW5nIHRoZSBsZW5ndGhzIG9mIHZlY3RvcnMsIHlvdSBzaG91bGQKICAgKiBjb21wYXJlIHRoZSBsZW5ndGggc3F1YXJlZCBpbnN0ZWFkIGFzIGl0IGlzIHNsaWdodGx5IG1vcmUgZWZmaWNpZW50IHRvIGNhbGN1bGF0ZS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHNxdWFyZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56OwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgIEV1Y2xpZGVhbiBsZW5ndGggKHN0cmFpZ2h0LWxpbmUgbGVuZ3RoKSBmcm9tICgwLCAwLCAwKSB0byAoeCwgeSwgeikuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICovCiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnopOwogIH0KICAvKioKICAgKiBDb21wdXRlcyB0aGUgTWFuaGF0dGFuIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxlbmd0aCBvZiB0aGlzIHZlY3Rvci4KICAgKi8KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopOwogIH0KICAvKioKICAgKiBDb252ZXJ0cyB0aGlzIHZlY3RvciB0byBhIHVuaXQgdmVjdG9yIC0gdGhhdCBpcywgc2V0cyBpdCBlcXVhbCB0byBhIHZlY3RvcgogICAqIHdpdGggdGhlIHNhbWUgZGlyZWN0aW9uIGFzIHRoaXMgb25lLCBidXQgd2l0aCBhIHZlY3RvciBsZW5ndGggb2YgYDFgLgogICAqCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgbm9ybWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKHRoaXMubGVuZ3RoKCkgfHwgMSk7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyB2ZWN0b3IgdG8gYSB2ZWN0b3Igd2l0aCB0aGUgc2FtZSBkaXJlY3Rpb24gYXMgdGhpcyBvbmUsIGJ1dAogICAqIHdpdGggdGhlIHNwZWNpZmllZCBsZW5ndGguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIC0gVGhlIG5ldyBsZW5ndGggb2YgdGhpcyB2ZWN0b3IuCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0TGVuZ3RoKHQpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKHQpOwogIH0KICAvKioKICAgKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgYmV0d2VlbiB0aGUgZ2l2ZW4gdmVjdG9yIGFuZCB0aGlzIGluc3RhbmNlLCB3aGVyZQogICAqIGFscGhhIGlzIHRoZSBwZXJjZW50IGRpc3RhbmNlIGFsb25nIHRoZSBsaW5lIC0gYWxwaGEgPSAwIHdpbGwgYmUgdGhpcwogICAqIHZlY3RvciwgYW5kIGFscGhhID0gMSB3aWxsIGJlIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIGludGVycG9sYXRlIHRvd2FyZHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yLCB0eXBpY2FsbHkgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBsZXJwKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggKz0gKHQueCAtIHRoaXMueCkgKiBlLCB0aGlzLnkgKz0gKHQueSAtIHRoaXMueSkgKiBlLCB0aGlzLnogKz0gKHQueiAtIHRoaXMueikgKiBlLCB0aGlzOwogIH0KICAvKioKICAgKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgYmV0d2VlbiB0aGUgZ2l2ZW4gdmVjdG9ycywgd2hlcmUgYWxwaGEgaXMgdGhlIHBlcmNlbnQKICAgKiBkaXN0YW5jZSBhbG9uZyB0aGUgbGluZSAtIGFscGhhID0gMCB3aWxsIGJlIGZpcnN0IHZlY3RvciwgYW5kIGFscGhhID0gMSB3aWxsCiAgICogYmUgdGhlIHNlY29uZCBvbmUuIFRoZSByZXN1bHQgaXMgc3RvcmVkIGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYxIC0gVGhlIGZpcnN0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYyIC0gVGhlIHNlY29uZCB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yLCB0eXBpY2FsbHkgaW4gdGhlIGNsb3NlZCBpbnRlcnZhbCBgWzAsIDFdYC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBsZXJwVmVjdG9ycyh0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC54ICsgKGUueCAtIHQueCkgKiBpLCB0aGlzLnkgPSB0LnkgKyAoZS55IC0gdC55KSAqIGksIHRoaXMueiA9IHQueiArIChlLnogLSB0LnopICogaSwgdGhpczsKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgY3Jvc3MgcHJvZHVjdCBvZiB0aGUgZ2l2ZW4gdmVjdG9yIHdpdGggdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgY3Jvc3MgcHJvZHVjdCB3aXRoLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSByZXN1bHQgb2YgdGhlIGNyb3NzIHByb2R1Y3QuCiAgICovCiAgY3Jvc3ModCkgewogICAgcmV0dXJuIHRoaXMuY3Jvc3NWZWN0b3JzKHRoaXMsIHQpOwogIH0KICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBjcm9zcyBwcm9kdWN0IG9mIHRoZSBnaXZlbiB2ZWN0b3JzIGFuZCBzdG9yZXMgdGhlIHJlc3VsdAogICAqIGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGEgLSBUaGUgZmlyc3QgdmVjdG9yLgogICAqIEBwYXJhbSB7VmVjdG9yM30gYiAtIFRoZSBzZWNvbmQgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIGNyb3NzVmVjdG9ycyh0LCBlKSB7CiAgICBjb25zdCBpID0gdC54LCBuID0gdC55LCBzID0gdC56LCByID0gZS54LCBvID0gZS55LCBsID0gZS56OwogICAgcmV0dXJuIHRoaXMueCA9IG4gKiBsIC0gcyAqIG8sIHRoaXMueSA9IHMgKiByIC0gaSAqIGwsIHRoaXMueiA9IGkgKiBvIC0gbiAqIHIsIHRoaXM7CiAgfQogIC8qKgogICAqIFByb2plY3RzIHRoaXMgdmVjdG9yIG9udG8gdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gcHJvamVjdCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBwcm9qZWN0T25WZWN0b3IodCkgewogICAgY29uc3QgZSA9IHQubGVuZ3RoU3EoKTsKICAgIGlmIChlID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCk7CiAgICBjb25zdCBpID0gdC5kb3QodGhpcykgLyBlOwogICAgcmV0dXJuIHRoaXMuY29weSh0KS5tdWx0aXBseVNjYWxhcihpKTsKICB9CiAgLyoqCiAgICogUHJvamVjdHMgdGhpcyB2ZWN0b3Igb250byBhIHBsYW5lIGJ5IHN1YnRyYWN0aW5nIHRoaXMKICAgKiB2ZWN0b3IgcHJvamVjdGVkIG9udG8gdGhlIHBsYW5lJ3Mgbm9ybWFsIGZyb20gdGhpcyB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHBsYW5lTm9ybWFsIC0gVGhlIHBsYW5lIG5vcm1hbC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBwcm9qZWN0T25QbGFuZSh0KSB7CiAgICByZXR1cm4gTmQuY29weSh0aGlzKS5wcm9qZWN0T25WZWN0b3IodCksIHRoaXMuc3ViKE5kKTsKICB9CiAgLyoqCiAgICogUmVmbGVjdHMgdGhpcyB2ZWN0b3Igb2ZmIGEgcGxhbmUgb3J0aG9nb25hbCB0byB0aGUgZ2l2ZW4gbm9ybWFsIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gbm9ybWFsIC0gVGhlIChub3JtYWxpemVkKSBub3JtYWwgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJlZmxlY3QodCkgewogICAgcmV0dXJuIHRoaXMuc3ViKE5kLmNvcHkodCkubXVsdGlwbHlTY2FsYXIoMiAqIHRoaXMuZG90KHQpKSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGFuZ2xlIGJldHdlZW4gdGhlIGdpdmVuIHZlY3RvciBhbmQgdGhpcyBpbnN0YW5jZSBpbiByYWRpYW5zLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBhbmdsZSB3aXRoLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICovCiAgYW5nbGVUbyh0KSB7CiAgICBjb25zdCBlID0gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3EoKSAqIHQubGVuZ3RoU3EoKSk7CiAgICBpZiAoZSA9PT0gMCkgcmV0dXJuIE1hdGguUEkgLyAyOwogICAgY29uc3QgaSA9IHRoaXMuZG90KHQpIC8gZTsKICAgIHJldHVybiBNYXRoLmFjb3MoeWUoaSwgLTEsIDEpKTsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIGRpc3RhbmNlIGZyb20gdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB2IC0gVGhlIHZlY3RvciB0byBjb21wdXRlIHRoZSBkaXN0YW5jZSB0by4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZVRvKHQpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5kaXN0YW5jZVRvU3F1YXJlZCh0KSk7CiAgfQogIC8qKgogICAqIENvbXB1dGVzIHRoZSBzcXVhcmVkIGRpc3RhbmNlIGZyb20gdGhlIGdpdmVuIHZlY3RvciB0byB0aGlzIGluc3RhbmNlLgogICAqIElmIHlvdSBhcmUganVzdCBjb21wYXJpbmcgdGhlIGRpc3RhbmNlIHdpdGggYW5vdGhlciBkaXN0YW5jZSwgeW91IHNob3VsZCBjb21wYXJlCiAgICogdGhlIGRpc3RhbmNlIHNxdWFyZWQgaW5zdGVhZCBhcyBpdCBpcyBzbGlnaHRseSBtb3JlIGVmZmljaWVudCB0byBjYWxjdWxhdGUuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIGNvbXB1dGUgdGhlIHNxdWFyZWQgZGlzdGFuY2UgdG8uCiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgc3F1YXJlZCBkaXN0YW5jZS4KICAgKi8KICBkaXN0YW5jZVRvU3F1YXJlZCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy54IC0gdC54LCBpID0gdGhpcy55IC0gdC55LCBuID0gdGhpcy56IC0gdC56OwogICAgcmV0dXJuIGUgKiBlICsgaSAqIGkgKyBuICogbjsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIE1hbmhhdHRhbiBkaXN0YW5jZSBmcm9tIHRoZSBnaXZlbiB2ZWN0b3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gY29tcHV0ZSB0aGUgTWFuaGF0dGFuIGRpc3RhbmNlIHRvLgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIE1hbmhhdHRhbiBkaXN0YW5jZS4KICAgKi8KICBtYW5oYXR0YW5EaXN0YW5jZVRvKHQpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLnggLSB0LngpICsgTWF0aC5hYnModGhpcy55IC0gdC55KSArIE1hdGguYWJzKHRoaXMueiAtIHQueik7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIHNwaGVyaWNhbCBjb29yZGluYXRlcy4KICAgKgogICAqIEBwYXJhbSB7U3BoZXJpY2FsfSBzIC0gVGhlIHNwaGVyaWNhbCBjb29yZGluYXRlcy4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tU3BoZXJpY2FsKHQpIHsKICAgIHJldHVybiB0aGlzLnNldEZyb21TcGhlcmljYWxDb29yZHModC5yYWRpdXMsIHQucGhpLCB0LnRoZXRhKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gc3BoZXJpY2FsIGNvb3JkaW5hdGVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHBoaSAtIFRoZSBwaGkgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0gdGhldGEgLSBUaGUgdGhldGEgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tU3BoZXJpY2FsQ29vcmRzKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSBNYXRoLnNpbihlKSAqIHQ7CiAgICByZXR1cm4gdGhpcy54ID0gbiAqIE1hdGguc2luKGkpLCB0aGlzLnkgPSBNYXRoLmNvcyhlKSAqIHQsIHRoaXMueiA9IG4gKiBNYXRoLmNvcyhpKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gY3lsaW5kcmljYWwgY29vcmRpbmF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge0N5bGluZHJpY2FsfSBjIC0gVGhlIGN5bGluZHJpY2FsIGNvb3JkaW5hdGVzLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldEZyb21DeWxpbmRyaWNhbCh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tQ3lsaW5kcmljYWxDb29yZHModC5yYWRpdXMsIHQudGhldGEsIHQueSk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIGN5bGluZHJpY2FsIGNvb3JkaW5hdGVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSByYWRpdXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHRoZXRhIC0gVGhlIHRoZXRhIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSB2YWx1ZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tQ3lsaW5kcmljYWxDb29yZHModCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMueCA9IHQgKiBNYXRoLnNpbihlKSwgdGhpcy55ID0gaSwgdGhpcy56ID0gdCAqIE1hdGguY29zKGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyB0byB0aGUgcG9zaXRpb24gZWxlbWVudHMgb2YgdGhlCiAgICogZ2l2ZW4gdHJhbnNmb3JtYXRpb24gbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtIC0gVGhlIDR4NCBtYXRyaXguCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMueCA9IGVbMTJdLCB0aGlzLnkgPSBlWzEzXSwgdGhpcy56ID0gZVsxNF0sIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHZlY3RvciBjb21wb25lbnRzIHRvIHRoZSBzY2FsZSBlbGVtZW50cyBvZiB0aGUKICAgKiBnaXZlbiB0cmFuc2Zvcm1hdGlvbiBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tTWF0cml4U2NhbGUodCkgewogICAgY29uc3QgZSA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAwKS5sZW5ndGgoKSwgaSA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAxKS5sZW5ndGgoKSwgbiA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAyKS5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLnggPSBlLCB0aGlzLnkgPSBpLCB0aGlzLnogPSBuLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyBmcm9tIHRoZSBzcGVjaWZpZWQgbWF0cml4IGNvbHVtbi4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSA0eDQgbWF0cml4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBjb2x1bW4gaW5kZXguCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0RnJvbU1hdHJpeENvbHVtbih0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkodC5lbGVtZW50cywgZSAqIDQpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSB2ZWN0b3IgY29tcG9uZW50cyBmcm9tIHRoZSBzcGVjaWZpZWQgbWF0cml4IGNvbHVtbi4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSAzeDMgbWF0cml4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBjb2x1bW4gaW5kZXguCiAgICogQHJldHVybiB7VmVjdG9yM30gQSByZWZlcmVuY2UgdG8gdGhpcyB2ZWN0b3IuCiAgICovCiAgc2V0RnJvbU1hdHJpeDNDb2x1bW4odCwgZSkgewogICAgcmV0dXJuIHRoaXMuZnJvbUFycmF5KHQuZWxlbWVudHMsIGUgKiAzKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgZ2l2ZW4gRXVsZXIgYW5nbGVzLgogICAqCiAgICogQHBhcmFtIHtFdWxlcn0gZSAtIFRoZSBFdWxlciBhbmdsZXMgdG8gc2V0LgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHNldEZyb21FdWxlcih0KSB7CiAgICByZXR1cm4gdGhpcy54ID0gdC5feCwgdGhpcy55ID0gdC5feSwgdGhpcy56ID0gdC5feiwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgdmVjdG9yIGNvbXBvbmVudHMgZnJvbSB0aGUgUkdCIGNvbXBvbmVudHMgb2YgdGhlCiAgICogZ2l2ZW4gY29sb3IuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjIC0gVGhlIGNvbG9yIHRvIHNldC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBzZXRGcm9tQ29sb3IodCkgewogICAgcmV0dXJuIHRoaXMueCA9IHQuciwgdGhpcy55ID0gdC5nLCB0aGlzLnogPSB0LmIsIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgdmVjdG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIHZlY3RvciBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIHJldHVybiB0LnggPT09IHRoaXMueCAmJiB0LnkgPT09IHRoaXMueSAmJiB0LnogPT09IHRoaXMuejsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHZlY3RvcidzIHggdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgXWAsIHkgdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgKyAxIF1gCiAgICogYW5kIHogdmFsdWUgdG8gYmUgYGFycmF5WyBvZmZzZXQgKyAyIF1gLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIEFuIGFycmF5IGhvbGRpbmcgdGhlIHZlY3RvciBjb21wb25lbnQgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnggPSB0W2VdLCB0aGlzLnkgPSB0W2UgKyAxXSwgdGhpcy56ID0gdFtlICsgMl0sIHRoaXM7CiAgfQogIC8qKgogICAqIFdyaXRlcyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgdmVjdG9yIGNvbXBvbmVudHMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBJbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7QXJyYXk8bnVtYmVyPn0gVGhlIHZlY3RvciBjb21wb25lbnRzLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgcmV0dXJuIHRbZV0gPSB0aGlzLngsIHRbZSArIDFdID0gdGhpcy55LCB0W2UgKyAyXSA9IHRoaXMueiwgdDsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIHZlY3RvciBmcm9tIHRoZSBnaXZlbiBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJBdHRyaWJ1dGV9IGF0dHJpYnV0ZSAtIFRoZSBidWZmZXIgYXR0cmlidXRlIGhvbGRpbmcgdmVjdG9yIGRhdGEuCiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IGludG8gdGhlIGF0dHJpYnV0ZS4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICBmcm9tQnVmZmVyQXR0cmlidXRlKHQsIGUpIHsKICAgIHJldHVybiB0aGlzLnggPSB0LmdldFgoZSksIHRoaXMueSA9IHQuZ2V0WShlKSwgdGhpcy56ID0gdC5nZXRaKGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIGVhY2ggY29tcG9uZW50IG9mIHRoaXMgdmVjdG9yIHRvIGEgcHNldWRvLXJhbmRvbSB2YWx1ZSBiZXR3ZWVuIGAwYCBhbmQKICAgKiBgMWAsIGV4Y2x1ZGluZyBgMWAuCiAgICoKICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBBIHJlZmVyZW5jZSB0byB0aGlzIHZlY3Rvci4KICAgKi8KICByYW5kb20oKSB7CiAgICByZXR1cm4gdGhpcy54ID0gTWF0aC5yYW5kb20oKSwgdGhpcy55ID0gTWF0aC5yYW5kb20oKSwgdGhpcy56ID0gTWF0aC5yYW5kb20oKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGlzIHZlY3RvciB0byBhIHVuaWZvcm1seSByYW5kb20gcG9pbnQgb24gYSB1bml0IHNwaGVyZS4KICAgKgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgdmVjdG9yLgogICAqLwogIHJhbmRvbURpcmVjdGlvbigpIHsKICAgIGNvbnN0IHQgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDIsIGUgPSBNYXRoLnJhbmRvbSgpICogMiAtIDEsIGkgPSBNYXRoLnNxcnQoMSAtIGUgKiBlKTsKICAgIHJldHVybiB0aGlzLnggPSBpICogTWF0aC5jb3ModCksIHRoaXMueSA9IGUsIHRoaXMueiA9IGkgKiBNYXRoLnNpbih0KSwgdGhpczsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy54LCB5aWVsZCB0aGlzLnksIHlpZWxkIHRoaXMuejsKICB9Cn0KY29uc3QgTmQgPSAvKiBAX19QVVJFX18gKi8gbmV3IEZlKCksIGkwID0gLyogQF9fUFVSRV9fICovIG5ldyAkbygpOwpjbGFzcyBfciB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyAzeDMgbWF0cml4LiBUaGUgYXJndW1lbnRzIGFyZSBzdXBwb3NlZCB0byBiZQogICAqIGluIHJvdy1tYWpvciBvcmRlci4gSWYgbm8gYXJndW1lbnRzIGFyZSBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdG9yCiAgICogaW5pdGlhbGl6ZXMgdGhlIG1hdHJpeCBhcyBhbiBpZGVudGl0eSBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW24xMV0gLSAxLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTJdIC0gMS0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjEzXSAtIDEtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yMV0gLSAyLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjJdIC0gMi0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIzXSAtIDItMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMV0gLSAzLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzJdIC0gMy0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMzXSAtIDMtMyBtYXRyaXggZWxlbWVudC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKSB7CiAgICBfci5wcm90b3R5cGUuaXNNYXRyaXgzID0gITAsIHRoaXMuZWxlbWVudHMgPSBbCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgIF0sIHQgIT09IHZvaWQgMCAmJiB0aGlzLnNldCh0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZWxlbWVudHMgb2YgdGhlIG1hdHJpeC5UaGUgYXJndW1lbnRzIGFyZSBzdXBwb3NlZCB0byBiZQogICAqIGluIHJvdy1tYWpvciBvcmRlci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjExXSAtIDEtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xMl0gLSAxLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTNdIC0gMS0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIxXSAtIDItMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yMl0gLSAyLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjNdIC0gMi0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMxXSAtIDMtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMl0gLSAzLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzNdIC0gMy0zIG1hdHJpeCBlbGVtZW50LgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHNldCh0LCBlLCBpLCBuLCBzLCByLCBvLCBsLCBoKSB7CiAgICBjb25zdCBjID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiBjWzBdID0gdCwgY1sxXSA9IG4sIGNbMl0gPSBvLCBjWzNdID0gZSwgY1s0XSA9IHMsIGNbNV0gPSBsLCBjWzZdID0gaSwgY1s3XSA9IHIsIGNbOF0gPSBoLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IHRvIHRoZSAzeDMgaWRlbnRpdHkgbWF0cml4LgogICAqCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgaWRlbnRpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBtYXRyaXggdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gY29weS4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBjb3B5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50czsKICAgIHJldHVybiBlWzBdID0gaVswXSwgZVsxXSA9IGlbMV0sIGVbMl0gPSBpWzJdLCBlWzNdID0gaVszXSwgZVs0XSA9IGlbNF0sIGVbNV0gPSBpWzVdLCBlWzZdID0gaVs2XSwgZVs3XSA9IGlbN10sIGVbOF0gPSBpWzhdLCB0aGlzOwogIH0KICAvKioKICAgKiBFeHRyYWN0cyB0aGUgYmFzaXMgb2YgdGhpcyBtYXRyaXggaW50byB0aGUgdGhyZWUgYXhpcyB2ZWN0b3JzIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB4QXhpcyAtIFRoZSBiYXNpcydzIHggYXhpcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHlBeGlzIC0gVGhlIGJhc2lzJ3MgeSBheGlzLgogICAqIEBwYXJhbSB7VmVjdG9yM30gekF4aXMgLSBUaGUgYmFzaXMncyB6IGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgZXh0cmFjdEJhc2lzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0LnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDApLCBlLnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDEpLCBpLnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDIpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXQgdGhpcyBtYXRyaXggdG8gdGhlIHVwcGVyIDN4MyBtYXRyaXggb2YgdGhlIGdpdmVuIDR4NCBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzZXRGcm9tTWF0cml4NCh0KSB7CiAgICBjb25zdCBlID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgZVswXSwKICAgICAgZVs0XSwKICAgICAgZVs4XSwKICAgICAgZVsxXSwKICAgICAgZVs1XSwKICAgICAgZVs5XSwKICAgICAgZVsyXSwKICAgICAgZVs2XSwKICAgICAgZVsxMF0KICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFBvc3QtbXVsdGlwbGllcyB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gM3gzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gbXVsdGlwbHkgd2l0aC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHRoaXMsIHQpOwogIH0KICAvKioKICAgKiBQcmUtbXVsdGlwbGllcyB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gM3gzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSBtYXRyaXggdG8gbXVsdGlwbHkgd2l0aC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBwcmVtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHQsIHRoaXMpOwogIH0KICAvKioKICAgKiBNdWx0aXBsZXMgdGhlIGdpdmVuIDN4MyBtYXRyaWNlcyBhbmQgc3RvcmVzIHRoZSByZXN1bHQKICAgKiBpbiB0aGlzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gYSAtIFRoZSBmaXJzdCBtYXRyaXguCiAgICogQHBhcmFtIHtNYXRyaXgzfSBiIC0gVGhlIHNlY29uZCBtYXRyaXguCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbXVsdGlwbHlNYXRyaWNlcyh0LCBlKSB7CiAgICBjb25zdCBpID0gdC5lbGVtZW50cywgbiA9IGUuZWxlbWVudHMsIHMgPSB0aGlzLmVsZW1lbnRzLCByID0gaVswXSwgbyA9IGlbM10sIGwgPSBpWzZdLCBoID0gaVsxXSwgYyA9IGlbNF0sIHUgPSBpWzddLCBkID0gaVsyXSwgcCA9IGlbNV0sIGYgPSBpWzhdLCB5ID0gblswXSwgZyA9IG5bM10sIG0gPSBuWzZdLCB2ID0gblsxXSwgeCA9IG5bNF0sIF8gPSBuWzddLCBTID0gblsyXSwgdyA9IG5bNV0sIFQgPSBuWzhdOwogICAgcmV0dXJuIHNbMF0gPSByICogeSArIG8gKiB2ICsgbCAqIFMsIHNbM10gPSByICogZyArIG8gKiB4ICsgbCAqIHcsIHNbNl0gPSByICogbSArIG8gKiBfICsgbCAqIFQsIHNbMV0gPSBoICogeSArIGMgKiB2ICsgdSAqIFMsIHNbNF0gPSBoICogZyArIGMgKiB4ICsgdSAqIHcsIHNbN10gPSBoICogbSArIGMgKiBfICsgdSAqIFQsIHNbMl0gPSBkICogeSArIHAgKiB2ICsgZiAqIFMsIHNbNV0gPSBkICogZyArIHAgKiB4ICsgZiAqIHcsIHNbOF0gPSBkICogbSArIHAgKiBfICsgZiAqIFQsIHRoaXM7CiAgfQogIC8qKgogICAqIE11bHRpcGxpZXMgZXZlcnkgY29tcG9uZW50IG9mIHRoZSBtYXRyaXggYnkgdGhlIGdpdmVuIHNjYWxhci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhci4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiBlWzBdICo9IHQsIGVbM10gKj0gdCwgZVs2XSAqPSB0LCBlWzFdICo9IHQsIGVbNF0gKj0gdCwgZVs3XSAqPSB0LCBlWzJdICo9IHQsIGVbNV0gKj0gdCwgZVs4XSAqPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBhbmQgcmV0dXJucyB0aGUgZGV0ZXJtaW5hbnQgb2YgdGhpcyBtYXRyaXguCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZXRlcm1pbmFudC4KICAgKi8KICBkZXRlcm1pbmFudCgpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmVsZW1lbnRzLCBlID0gdFswXSwgaSA9IHRbMV0sIG4gPSB0WzJdLCBzID0gdFszXSwgciA9IHRbNF0sIG8gPSB0WzVdLCBsID0gdFs2XSwgaCA9IHRbN10sIGMgPSB0WzhdOwogICAgcmV0dXJuIGUgKiByICogYyAtIGUgKiBvICogaCAtIGkgKiBzICogYyArIGkgKiBvICogbCArIG4gKiBzICogaCAtIG4gKiByICogbDsKICB9CiAgLyoqCiAgICogSW52ZXJ0cyB0aGlzIG1hdHJpeCwgdXNpbmcgdGhlIFthbmFseXRpYyBtZXRob2Rde0BsaW5rIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0ludmVydGlibGVfbWF0cml4I0FuYWx5dGljX3NvbHV0aW9ufS4KICAgKiBZb3UgY2FuIG5vdCBpbnZlcnQgd2l0aCBhIGRldGVybWluYW50IG9mIHplcm8uIElmIHlvdSBhdHRlbXB0IHRoaXMsIHRoZSBtZXRob2QgcHJvZHVjZXMKICAgKiBhIHplcm8gbWF0cml4IGluc3RlYWQuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBpbnZlcnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0sIGkgPSB0WzFdLCBuID0gdFsyXSwgcyA9IHRbM10sIHIgPSB0WzRdLCBvID0gdFs1XSwgbCA9IHRbNl0sIGggPSB0WzddLCBjID0gdFs4XSwgdSA9IGMgKiByIC0gbyAqIGgsIGQgPSBvICogbCAtIGMgKiBzLCBwID0gaCAqIHMgLSByICogbCwgZiA9IGUgKiB1ICsgaSAqIGQgKyBuICogcDsKICAgIGlmIChmID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCk7CiAgICBjb25zdCB5ID0gMSAvIGY7CiAgICByZXR1cm4gdFswXSA9IHUgKiB5LCB0WzFdID0gKG4gKiBoIC0gYyAqIGkpICogeSwgdFsyXSA9IChvICogaSAtIG4gKiByKSAqIHksIHRbM10gPSBkICogeSwgdFs0XSA9IChjICogZSAtIG4gKiBsKSAqIHksIHRbNV0gPSAobiAqIHMgLSBvICogZSkgKiB5LCB0WzZdID0gcCAqIHksIHRbN10gPSAoaSAqIGwgLSBoICogZSkgKiB5LCB0WzhdID0gKHIgKiBlIC0gaSAqIHMpICogeSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNwb3NlcyB0aGlzIG1hdHJpeCBpbiBwbGFjZS4KICAgKgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHRyYW5zcG9zZSgpIHsKICAgIGxldCB0OwogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdCA9IGVbMV0sIGVbMV0gPSBlWzNdLCBlWzNdID0gdCwgdCA9IGVbMl0sIGVbMl0gPSBlWzZdLCBlWzZdID0gdCwgdCA9IGVbNV0sIGVbNV0gPSBlWzddLCBlWzddID0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogQ29tcHV0ZXMgdGhlIG5vcm1hbCBtYXRyaXggd2hpY2ggaXMgdGhlIGludmVyc2UgdHJhbnNwb3NlIG9mIHRoZSB1cHBlcgogICAqIGxlZnQgM3gzIHBvcnRpb24gb2YgdGhlIGdpdmVuIDR4NCBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG1hdHJpeDQgLSBUaGUgNHg0IG1hdHJpeC4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBnZXROb3JtYWxNYXRyaXgodCkgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbU1hdHJpeDQodCkuaW52ZXJ0KCkudHJhbnNwb3NlKCk7CiAgfQogIC8qKgogICAqIFRyYW5zcG9zZXMgdGhpcyBtYXRyaXggaW50byB0aGUgc3VwcGxpZWQgYXJyYXksIGFuZCByZXR1cm5zIGl0c2VsZiB1bmNoYW5nZWQuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IHIgLSBBbiBhcnJheSB0byBzdG9yZSB0aGUgdHJhbnNwb3NlZCBtYXRyaXggZWxlbWVudHMuCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgdHJhbnNwb3NlSW50b0FycmF5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIHRbMF0gPSBlWzBdLCB0WzFdID0gZVszXSwgdFsyXSA9IGVbNl0sIHRbM10gPSBlWzFdLCB0WzRdID0gZVs0XSwgdFs1XSA9IGVbN10sIHRbNl0gPSBlWzJdLCB0WzddID0gZVs1XSwgdFs4XSA9IGVbOF0sIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIFVWIHRyYW5zZm9ybSBtYXRyaXggZnJvbSBvZmZzZXQsIHJlcGVhdCwgcm90YXRpb24sIGFuZCBjZW50ZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gdHggLSBPZmZzZXQgeC4KICAgKiBAcGFyYW0ge251bWJlcn0gdHkgLSBPZmZzZXQgeS4KICAgKiBAcGFyYW0ge251bWJlcn0gc3ggLSBSZXBlYXQgeC4KICAgKiBAcGFyYW0ge251bWJlcn0gc3kgLSBSZXBlYXQgeS4KICAgKiBAcGFyYW0ge251bWJlcn0gcm90YXRpb24gLSBSb3RhdGlvbiwgaW4gcmFkaWFucy4gUG9zaXRpdmUgdmFsdWVzIHJvdGF0ZSBjb3VudGVyY2xvY2t3aXNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjeCAtIENlbnRlciB4IG9mIHJvdGF0aW9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBjeSAtIENlbnRlciB5IG9mIHJvdGF0aW9uCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgc2V0VXZUcmFuc2Zvcm0odCwgZSwgaSwgbiwgcywgciwgbykgewogICAgY29uc3QgbCA9IE1hdGguY29zKHMpLCBoID0gTWF0aC5zaW4ocyk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGkgKiBsLAogICAgICBpICogaCwKICAgICAgLWkgKiAobCAqIHIgKyBoICogbykgKyByICsgdCwKICAgICAgLW4gKiBoLAogICAgICBuICogbCwKICAgICAgLW4gKiAoLWggKiByICsgbCAqIG8pICsgbyArIGUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFNjYWxlcyB0aGlzIG1hdHJpeCB3aXRoIHRoZSBnaXZlbiBzY2FsYXIgdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHN4IC0gVGhlIGFtb3VudCB0byBzY2FsZSBpbiB0aGUgWCBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzeSAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzY2FsZSh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5wcmVtdWx0aXBseShPZC5tYWtlU2NhbGUodCwgZSkpLCB0aGlzOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoaXMgbWF0cml4IGJ5IHRoZSBnaXZlbiBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHJvdGF0ZSh0KSB7CiAgICByZXR1cm4gdGhpcy5wcmVtdWx0aXBseShPZC5tYWtlUm90YXRpb24oLXQpKSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlcyB0aGlzIG1hdHJpeCBieSB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0eCAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBYIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHR5IC0gVGhlIGFtb3VudCB0byB0cmFuc2xhdGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICB0cmFuc2xhdGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMucHJlbXVsdGlwbHkoT2QubWFrZVRyYW5zbGF0aW9uKHQsIGUpKSwgdGhpczsKICB9CiAgLy8gZm9yIDJEIFRyYW5zZm9ybXMKICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgMkQgdHJhbnNsYXRpb24gdHJhbnNmb3JtLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ8VmVjdG9yMn0geCAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBYIGF4aXMgb3IgYWx0ZXJuYXRpdmVseSBhIHRyYW5zbGF0aW9uIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBZIGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4M30gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZVRyYW5zbGF0aW9uKHQsIGUpIHsKICAgIHJldHVybiB0LmlzVmVjdG9yMiA/IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICB0LngsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIHQueSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSA6IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICB0LAogICAgICAwLAogICAgICAxLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgMkQgcm90YXRpb25hbCB0cmFuc2Zvcm1hdGlvbi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VSb3RhdGlvbih0KSB7CiAgICBjb25zdCBlID0gTWF0aC5jb3ModCksIGkgPSBNYXRoLnNpbih0KTsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgZSwKICAgICAgLWksCiAgICAgIDAsCiAgICAgIGksCiAgICAgIGUsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBtYXRyaXggYXMgYSAyRCBzY2FsZSB0cmFuc2Zvcm0uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFggYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlU2NhbGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICB0LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIG1hdHJpeCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG1hdHJpeCAtIFRoZSBtYXRyaXggdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIG1hdHJpeCBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICovCiAgZXF1YWxzKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50czsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgOTsgbisrKQogICAgICBpZiAoZVtuXSAhPT0gaVtuXSkgcmV0dXJuICExOwogICAgcmV0dXJuICEwOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBlbGVtZW50cyBvZiB0aGUgbWF0cml4IGZyb20gdGhlIGdpdmVuIGFycmF5LgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBhcnJheSAtIFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge01hdHJpeDN9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIGZyb21BcnJheSh0LCBlID0gMCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA5OyBpKyspCiAgICAgIHRoaXMuZWxlbWVudHNbaV0gPSB0W2kgKyBlXTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBXcml0ZXMgdGhlIGVsZW1lbnRzIG9mIHRoaXMgbWF0cml4IHRvIHRoZSBnaXZlbiBhcnJheS4gSWYgbm8gYXJyYXkgaXMgcHJvdmlkZWQsCiAgICogdGhlIG1ldGhvZCByZXR1cm5zIGEgbmV3IGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBbYXJyYXk9W11dIC0gVGhlIHRhcmdldCBhcnJheSBob2xkaW5nIHRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgY29uc3QgaSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdFtlXSA9IGlbMF0sIHRbZSArIDFdID0gaVsxXSwgdFtlICsgMl0gPSBpWzJdLCB0W2UgKyAzXSA9IGlbM10sIHRbZSArIDRdID0gaVs0XSwgdFtlICsgNV0gPSBpWzVdLCB0W2UgKyA2XSA9IGlbNl0sIHRbZSArIDddID0gaVs3XSwgdFtlICsgOF0gPSBpWzhdLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbWF0cml4IHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXgzfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5mcm9tQXJyYXkodGhpcy5lbGVtZW50cyk7CiAgfQp9CmNvbnN0IE9kID0gLyogQF9fUFVSRV9fICovIG5ldyBfcigpOwpmdW5jdGlvbiBuMChhKSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUygiaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIsIGEpOwp9CmNvbnN0IHMwID0ge307CmZ1bmN0aW9uIHIwKGEpIHsKICBhIGluIHMwIHx8IChzMFthXSA9ICEwLCBjb25zb2xlLndhcm4oYSkpOwp9CmNvbnN0IGEwID0gLyogQF9fUFVSRV9fICovIG5ldyBfcigpLnNldCgKICAwLjQxMjM5MDgsCiAgMC4zNTc1ODQzLAogIDAuMTgwNDgwOCwKICAwLjIxMjYzOSwKICAwLjcxNTE2ODcsCiAgMC4wNzIxOTIzLAogIDAuMDE5MzMwOCwKICAwLjExOTE5NDgsCiAgMC45NTA1MzIyCiksIG8wID0gLyogQF9fUFVSRV9fICovIG5ldyBfcigpLnNldCgKICAzLjI0MDk2OTksCiAgLTEuNTM3MzgzMiwKICAtMC40OTg2MTA4LAogIC0wLjk2OTI0MzYsCiAgMS44NzU5Njc1LAogIDAuMDQxNTU1MSwKICAwLjA1NTYzMDEsCiAgLTAuMjAzOTc3LAogIDEuMDU2OTcxNQopOwpmdW5jdGlvbiB5QygpIHsKICBjb25zdCBhID0gewogICAgZW5hYmxlZDogITAsCiAgICB3b3JraW5nQ29sb3JTcGFjZTogUWcsCiAgICAvKioKICAgICAqIEltcGxlbWVudGF0aW9ucyBvZiBzdXBwb3J0ZWQgY29sb3Igc3BhY2VzLgogICAgICoKICAgICAqIFJlcXVpcmVkOgogICAgICoJLSBwcmltYXJpZXM6IGNocm9tYXRpY2l0eSBjb29yZGluYXRlcyBbIHJ4IHJ5IGd4IGd5IGJ4IGJ5IF0KICAgICAqCS0gd2hpdGVQb2ludDogcmVmZXJlbmNlIHdoaXRlIFsgeCB5IF0KICAgICAqCS0gdHJhbnNmZXI6IHRyYW5zZmVyIGZ1bmN0aW9uIChwcmUtZGVmaW5lZCkKICAgICAqCS0gdG9YWVo6IE1hdHJpeDMgUkdCIHRvIFhZWiB0cmFuc2Zvcm0KICAgICAqCS0gZnJvbVhZWjogTWF0cml4MyBYWVogdG8gUkdCIHRyYW5zZm9ybQogICAgICoJLSBsdW1pbmFuY2VDb2VmZmljaWVudHM6IFJHQiBsdW1pbmFuY2UgY29lZmZpY2llbnRzCiAgICAgKgogICAgICogT3B0aW9uYWw6CiAgICAgKiAgLSBvdXRwdXRDb2xvclNwYWNlQ29uZmlnOiB7IGRyYXdpbmdCdWZmZXJDb2xvclNwYWNlOiBDb2xvclNwYWNlLCB0b25lTWFwcGluZ01vZGU6ICdleHRlbmRlZCcgfCAnc3RhbmRhcmQnIH0KICAgICAqICAtIHdvcmtpbmdDb2xvclNwYWNlQ29uZmlnOiB7IHVucGFja0NvbG9yU3BhY2U6IENvbG9yU3BhY2UgfQogICAgICoKICAgICAqIFJlZmVyZW5jZToKICAgICAqIC0gaHR0cHM6Ly93d3cucnVzc2VsbGNvdHRyZWxsLmNvbS9waG90by9tYXRyaXhDYWxjdWxhdG9yLmh0bQogICAgICovCiAgICBzcGFjZXM6IHt9LAogICAgY29udmVydDogZnVuY3Rpb24obiwgcywgcikgewogICAgICByZXR1cm4gdGhpcy5lbmFibGVkID09PSAhMSB8fCBzID09PSByIHx8ICFzIHx8ICFyIHx8ICh0aGlzLnNwYWNlc1tzXS50cmFuc2ZlciA9PT0gQmQgJiYgKG4uciA9IHRzKG4uciksIG4uZyA9IHRzKG4uZyksIG4uYiA9IHRzKG4uYikpLCB0aGlzLnNwYWNlc1tzXS5wcmltYXJpZXMgIT09IHRoaXMuc3BhY2VzW3JdLnByaW1hcmllcyAmJiAobi5hcHBseU1hdHJpeDModGhpcy5zcGFjZXNbc10udG9YWVopLCBuLmFwcGx5TWF0cml4Myh0aGlzLnNwYWNlc1tyXS5mcm9tWFlaKSksIHRoaXMuc3BhY2VzW3JdLnRyYW5zZmVyID09PSBCZCAmJiAobi5yID0gdWEobi5yKSwgbi5nID0gdWEobi5nKSwgbi5iID0gdWEobi5iKSkpLCBuOwogICAgfSwKICAgIHdvcmtpbmdUb0NvbG9yU3BhY2U6IGZ1bmN0aW9uKG4sIHMpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmVydChuLCB0aGlzLndvcmtpbmdDb2xvclNwYWNlLCBzKTsKICAgIH0sCiAgICBjb2xvclNwYWNlVG9Xb3JraW5nOiBmdW5jdGlvbihuLCBzKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZlcnQobiwgcywgdGhpcy53b3JraW5nQ29sb3JTcGFjZSk7CiAgICB9LAogICAgZ2V0UHJpbWFyaWVzOiBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiB0aGlzLnNwYWNlc1tuXS5wcmltYXJpZXM7CiAgICB9LAogICAgZ2V0VHJhbnNmZXI6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT09IFFfID8gdDAgOiB0aGlzLnNwYWNlc1tuXS50cmFuc2ZlcjsKICAgIH0sCiAgICBnZXRUb25lTWFwcGluZ01vZGU6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIHRoaXMuc3BhY2VzW25dLm91dHB1dENvbG9yU3BhY2VDb25maWcudG9uZU1hcHBpbmdNb2RlIHx8ICJzdGFuZGFyZCI7CiAgICB9LAogICAgZ2V0THVtaW5hbmNlQ29lZmZpY2llbnRzOiBmdW5jdGlvbihuLCBzID0gdGhpcy53b3JraW5nQ29sb3JTcGFjZSkgewogICAgICByZXR1cm4gbi5mcm9tQXJyYXkodGhpcy5zcGFjZXNbc10ubHVtaW5hbmNlQ29lZmZpY2llbnRzKTsKICAgIH0sCiAgICBkZWZpbmU6IGZ1bmN0aW9uKG4pIHsKICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnNwYWNlcywgbik7CiAgICB9LAogICAgLy8gSW50ZXJuYWwgQVBJcwogICAgX2dldE1hdHJpeDogZnVuY3Rpb24obiwgcywgcikgewogICAgICByZXR1cm4gbi5jb3B5KHRoaXMuc3BhY2VzW3NdLnRvWFlaKS5tdWx0aXBseSh0aGlzLnNwYWNlc1tyXS5mcm9tWFlaKTsKICAgIH0sCiAgICBfZ2V0RHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U6IGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIHRoaXMuc3BhY2VzW25dLm91dHB1dENvbG9yU3BhY2VDb25maWcuZHJhd2luZ0J1ZmZlckNvbG9yU3BhY2U7CiAgICB9LAogICAgX2dldFVucGFja0NvbG9yU3BhY2U6IGZ1bmN0aW9uKG4gPSB0aGlzLndvcmtpbmdDb2xvclNwYWNlKSB7CiAgICAgIHJldHVybiB0aGlzLnNwYWNlc1tuXS53b3JraW5nQ29sb3JTcGFjZUNvbmZpZy51bnBhY2tDb2xvclNwYWNlOwogICAgfSwKICAgIC8vIERlcHJlY2F0ZWQKICAgIGZyb21Xb3JraW5nQ29sb3JTcGFjZTogZnVuY3Rpb24obiwgcykgewogICAgICByZXR1cm4gcjAoIlRIUkVFLkNvbG9yTWFuYWdlbWVudDogLmZyb21Xb3JraW5nQ29sb3JTcGFjZSgpIGhhcyBiZWVuIHJlbmFtZWQgdG8gLndvcmtpbmdUb0NvbG9yU3BhY2UoKS4iKSwgYS53b3JraW5nVG9Db2xvclNwYWNlKG4sIHMpOwogICAgfSwKICAgIHRvV29ya2luZ0NvbG9yU3BhY2U6IGZ1bmN0aW9uKG4sIHMpIHsKICAgICAgcmV0dXJuIHIwKCJUSFJFRS5Db2xvck1hbmFnZW1lbnQ6IC50b1dvcmtpbmdDb2xvclNwYWNlKCkgaGFzIGJlZW4gcmVuYW1lZCB0byAuY29sb3JTcGFjZVRvV29ya2luZygpLiIpLCBhLmNvbG9yU3BhY2VUb1dvcmtpbmcobiwgcyk7CiAgICB9CiAgfSwgdCA9IFswLjY0LCAwLjMzLCAwLjMsIDAuNiwgMC4xNSwgMC4wNl0sIGUgPSBbMC4yMTI2LCAwLjcxNTIsIDAuMDcyMl0sIGkgPSBbMC4zMTI3LCAwLjMyOV07CiAgcmV0dXJuIGEuZGVmaW5lKHsKICAgIFtRZ106IHsKICAgICAgcHJpbWFyaWVzOiB0LAogICAgICB3aGl0ZVBvaW50OiBpLAogICAgICB0cmFuc2ZlcjogdDAsCiAgICAgIHRvWFlaOiBhMCwKICAgICAgZnJvbVhZWjogbzAsCiAgICAgIGx1bWluYW5jZUNvZWZmaWNpZW50czogZSwKICAgICAgd29ya2luZ0NvbG9yU3BhY2VDb25maWc6IHsgdW5wYWNrQ29sb3JTcGFjZTogb24gfSwKICAgICAgb3V0cHV0Q29sb3JTcGFjZUNvbmZpZzogeyBkcmF3aW5nQnVmZmVyQ29sb3JTcGFjZTogb24gfQogICAgfSwKICAgIFtvbl06IHsKICAgICAgcHJpbWFyaWVzOiB0LAogICAgICB3aGl0ZVBvaW50OiBpLAogICAgICB0cmFuc2ZlcjogQmQsCiAgICAgIHRvWFlaOiBhMCwKICAgICAgZnJvbVhZWjogbzAsCiAgICAgIGx1bWluYW5jZUNvZWZmaWNpZW50czogZSwKICAgICAgb3V0cHV0Q29sb3JTcGFjZUNvbmZpZzogeyBkcmF3aW5nQnVmZmVyQ29sb3JTcGFjZTogb24gfQogICAgfQogIH0pLCBhOwp9CmNvbnN0IHNuID0gLyogQF9fUFVSRV9fICovIHlDKCk7CmZ1bmN0aW9uIHRzKGEpIHsKICByZXR1cm4gYSA8IDAuMDQwNDUgPyBhICogMC4wNzczOTkzODA4IDogTWF0aC5wb3coYSAqIDAuOTQ3ODY3Mjk4NiArIDAuMDUyMTMyNzAxNCwgMi40KTsKfQpmdW5jdGlvbiB1YShhKSB7CiAgcmV0dXJuIGEgPCAzMTMwOGUtNyA/IGEgKiAxMi45MiA6IDEuMDU1ICogTWF0aC5wb3coYSwgMC40MTY2NikgLSAwLjA1NTsKfQpsZXQgS3I7CmNsYXNzIF9DIHsKICAvKioKICAgKiBSZXR1cm5zIGEgZGF0YSBVUkkgY29udGFpbmluZyBhIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBpbWFnZS4KICAgKgogICAqIEBwYXJhbSB7KEhUTUxJbWFnZUVsZW1lbnR8SFRNTENhbnZhc0VsZW1lbnQpfSBpbWFnZSAtIFRoZSBpbWFnZSBvYmplY3QuCiAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlPSdpbWFnZS9wbmcnXSAtIEluZGljYXRlcyB0aGUgaW1hZ2UgZm9ybWF0LgogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIGRhdGEgVVJJLgogICAqLwogIHN0YXRpYyBnZXREYXRhVVJMKHQsIGUgPSAiaW1hZ2UvcG5nIikgewogICAgaWYgKC9eZGF0YTovaS50ZXN0KHQuc3JjKSB8fCB0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgPiAidSIpCiAgICAgIHJldHVybiB0LnNyYzsKICAgIGxldCBpOwogICAgaWYgKHQgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCkKICAgICAgaSA9IHQ7CiAgICBlbHNlIHsKICAgICAgS3IgPT09IHZvaWQgMCAmJiAoS3IgPSBuMCgiY2FudmFzIikpLCBLci53aWR0aCA9IHQud2lkdGgsIEtyLmhlaWdodCA9IHQuaGVpZ2h0OwogICAgICBjb25zdCBuID0gS3IuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgdCBpbnN0YW5jZW9mIEltYWdlRGF0YSA/IG4ucHV0SW1hZ2VEYXRhKHQsIDAsIDApIDogbi5kcmF3SW1hZ2UodCwgMCwgMCwgdC53aWR0aCwgdC5oZWlnaHQpLCBpID0gS3I7CiAgICB9CiAgICByZXR1cm4gaS50b0RhdGFVUkwoZSk7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIHRoZSBnaXZlbiBzUkdCIGltYWdlIGRhdGEgdG8gbGluZWFyIGNvbG9yIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHsoSFRNTEltYWdlRWxlbWVudHxIVE1MQ2FudmFzRWxlbWVudHxJbWFnZUJpdG1hcHxPYmplY3QpfSBpbWFnZSAtIFRoZSBpbWFnZSBvYmplY3QuCiAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR8T2JqZWN0fSBUaGUgY29udmVydGVkIGltYWdlLgogICAqLwogIHN0YXRpYyBzUkdCVG9MaW5lYXIodCkgewogICAgaWYgKHR5cGVvZiBIVE1MSW1hZ2VFbGVtZW50IDwgInUiICYmIHQgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50IHx8IHR5cGVvZiBIVE1MQ2FudmFzRWxlbWVudCA8ICJ1IiAmJiB0IGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQgfHwgdHlwZW9mIEltYWdlQml0bWFwIDwgInUiICYmIHQgaW5zdGFuY2VvZiBJbWFnZUJpdG1hcCkgewogICAgICBjb25zdCBlID0gbjAoImNhbnZhcyIpOwogICAgICBlLndpZHRoID0gdC53aWR0aCwgZS5oZWlnaHQgPSB0LmhlaWdodDsKICAgICAgY29uc3QgaSA9IGUuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgaS5kcmF3SW1hZ2UodCwgMCwgMCwgdC53aWR0aCwgdC5oZWlnaHQpOwogICAgICBjb25zdCBuID0gaS5nZXRJbWFnZURhdGEoMCwgMCwgdC53aWR0aCwgdC5oZWlnaHQpLCBzID0gbi5kYXRhOwogICAgICBmb3IgKGxldCByID0gMDsgciA8IHMubGVuZ3RoOyByKyspCiAgICAgICAgc1tyXSA9IHRzKHNbcl0gLyAyNTUpICogMjU1OwogICAgICByZXR1cm4gaS5wdXRJbWFnZURhdGEobiwgMCwgMCksIGU7CiAgICB9IGVsc2UgaWYgKHQuZGF0YSkgewogICAgICBjb25zdCBlID0gdC5kYXRhLnNsaWNlKDApOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGUubGVuZ3RoOyBpKyspCiAgICAgICAgZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgfHwgZSBpbnN0YW5jZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ID8gZVtpXSA9IE1hdGguZmxvb3IodHMoZVtpXSAvIDI1NSkgKiAyNTUpIDogZVtpXSA9IHRzKGVbaV0pOwogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IGUsCiAgICAgICAgd2lkdGg6IHQud2lkdGgsCiAgICAgICAgaGVpZ2h0OiB0LmhlaWdodAogICAgICB9OwogICAgfSBlbHNlCiAgICAgIHJldHVybiBjb25zb2xlLndhcm4oIlRIUkVFLkltYWdlVXRpbHMuc1JHQlRvTGluZWFyKCk6IFVuc3VwcG9ydGVkIGltYWdlIHR5cGUuIE5vIGNvbG9yIHNwYWNlIGNvbnZlcnNpb24gYXBwbGllZC4iKSwgdDsKICB9Cn0KbGV0IHhDID0gMDsKY2xhc3MgdkMgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgdmlkZW8gdGV4dHVyZS4KICAgKgogICAqIEBwYXJhbSB7YW55fSBbZGF0YT1udWxsXSAtIFRoZSBkYXRhIGRlZmluaXRpb24gb2YgYSB0ZXh0dXJlLgogICAqLwogIGNvbnN0cnVjdG9yKHQgPSBudWxsKSB7CiAgICB0aGlzLmlzU291cmNlID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiB4QysrIH0pLCB0aGlzLnV1aWQgPSBNZigpLCB0aGlzLmRhdGEgPSB0LCB0aGlzLmRhdGFSZWFkeSA9ICEwLCB0aGlzLnZlcnNpb24gPSAwOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBkaW1lbnNpb25zIG9mIHRoZSBzb3VyY2UgaW50byB0aGUgZ2l2ZW4gdGFyZ2V0IHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7KFZlY3RvcjJ8VmVjdG9yMyl9IHRhcmdldCAtIFRoZSB0YXJnZXQgb2JqZWN0IHRoZSByZXN1bHQgaXMgd3JpdHRlbiBpbnRvLgogICAqIEByZXR1cm4geyhWZWN0b3IyfFZlY3RvcjMpfSBUaGUgZGltZW5zaW9ucyBvZiB0aGUgc291cmNlLgogICAqLwogIGdldFNpemUodCkgewogICAgY29uc3QgZSA9IHRoaXMuZGF0YTsKICAgIHJldHVybiB0eXBlb2YgSFRNTFZpZGVvRWxlbWVudCA8ICJ1IiAmJiBlIGluc3RhbmNlb2YgSFRNTFZpZGVvRWxlbWVudCA/IHQuc2V0KGUudmlkZW9XaWR0aCwgZS52aWRlb0hlaWdodCwgMCkgOiBlIGluc3RhbmNlb2YgVmlkZW9GcmFtZSA/IHQuc2V0KGUuZGlzcGxheUhlaWdodCwgZS5kaXNwbGF5V2lkdGgsIDApIDogZSAhPT0gbnVsbCA/IHQuc2V0KGUud2lkdGgsIGUuaGVpZ2h0LCBlLmRlcHRoIHx8IDApIDogdC5zZXQoMCwgMCwgMCksIHQ7CiAgfQogIC8qKgogICAqIFdoZW4gdGhlIHByb3BlcnR5IGlzIHNldCB0byBgdHJ1ZWAsIHRoZSBlbmdpbmUgYWxsb2NhdGVzIHRoZSBtZW1vcnkKICAgKiBmb3IgdGhlIHRleHR1cmUgKGlmIG5lY2Vzc2FyeSkgYW5kIHRyaWdnZXJzIHRoZSBhY3R1YWwgdGV4dHVyZSB1cGxvYWQKICAgKiB0byB0aGUgR1BVIG5leHQgdGltZSB0aGUgc291cmNlIGlzIHVzZWQuCiAgICoKICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKiBAZGVmYXVsdCBmYWxzZQogICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUKICAgKi8KICBzZXQgbmVlZHNVcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgdGhpcy52ZXJzaW9uKys7CiAgfQogIC8qKgogICAqIFNlcmlhbGl6ZXMgdGhlIHNvdXJjZSBpbnRvIEpTT04uCiAgICoKICAgKiBAcGFyYW0gez8oT2JqZWN0fHN0cmluZyl9IG1ldGEgLSBBbiBvcHRpb25hbCB2YWx1ZSBob2xkaW5nIG1ldGEgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHNlcmlhbGl6YXRpb24uCiAgICogQHJldHVybiB7T2JqZWN0fSBBIEpTT04gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgc2VyaWFsaXplZCBzb3VyY2UuCiAgICogQHNlZSB7QGxpbmsgT2JqZWN0TG9hZGVyI3BhcnNlfQogICAqLwogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gdCA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0ID09ICJzdHJpbmciOwogICAgaWYgKCFlICYmIHQuaW1hZ2VzW3RoaXMudXVpZF0gIT09IHZvaWQgMCkKICAgICAgcmV0dXJuIHQuaW1hZ2VzW3RoaXMudXVpZF07CiAgICBjb25zdCBpID0gewogICAgICB1dWlkOiB0aGlzLnV1aWQsCiAgICAgIHVybDogIiIKICAgIH0sIG4gPSB0aGlzLmRhdGE7CiAgICBpZiAobiAhPT0gbnVsbCkgewogICAgICBsZXQgczsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkobikpIHsKICAgICAgICBzID0gW107CiAgICAgICAgZm9yIChsZXQgciA9IDAsIG8gPSBuLmxlbmd0aDsgciA8IG87IHIrKykKICAgICAgICAgIG5bcl0uaXNEYXRhVGV4dHVyZSA/IHMucHVzaChrZChuW3JdLmltYWdlKSkgOiBzLnB1c2goa2QobltyXSkpOwogICAgICB9IGVsc2UKICAgICAgICBzID0ga2Qobik7CiAgICAgIGkudXJsID0gczsKICAgIH0KICAgIHJldHVybiBlIHx8ICh0LmltYWdlc1t0aGlzLnV1aWRdID0gaSksIGk7CiAgfQp9CmZ1bmN0aW9uIGtkKGEpIHsKICByZXR1cm4gdHlwZW9mIEhUTUxJbWFnZUVsZW1lbnQgPCAidSIgJiYgYSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQgfHwgdHlwZW9mIEhUTUxDYW52YXNFbGVtZW50IDwgInUiICYmIGEgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCB8fCB0eXBlb2YgSW1hZ2VCaXRtYXAgPCAidSIgJiYgYSBpbnN0YW5jZW9mIEltYWdlQml0bWFwID8gX0MuZ2V0RGF0YVVSTChhKSA6IGEuZGF0YSA/IHsKICAgIGRhdGE6IEFycmF5LmZyb20oYS5kYXRhKSwKICAgIHdpZHRoOiBhLndpZHRoLAogICAgaGVpZ2h0OiBhLmhlaWdodCwKICAgIHR5cGU6IGEuZGF0YS5jb25zdHJ1Y3Rvci5uYW1lCiAgfSA6IChjb25zb2xlLndhcm4oIlRIUkVFLlRleHR1cmU6IFVuYWJsZSB0byBzZXJpYWxpemUgVGV4dHVyZS4iKSwge30pOwp9CmxldCBiQyA9IDA7CmNvbnN0IFZkID0gLyogQF9fUFVSRV9fICovIG5ldyBGZSgpOwpjbGFzcyB1ciBleHRlbmRzIHR4IHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IHRleHR1cmUuCiAgICoKICAgKiBAcGFyYW0gez9PYmplY3R9IFtpbWFnZT1UZXh0dXJlLkRFRkFVTFRfSU1BR0VdIC0gVGhlIGltYWdlIGhvbGRpbmcgdGhlIHRleHR1cmUgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gW21hcHBpbmc9VGV4dHVyZS5ERUZBVUxUX01BUFBJTkddIC0gVGhlIHRleHR1cmUgbWFwcGluZy4KICAgKiBAcGFyYW0ge251bWJlcn0gW3dyYXBTPUNsYW1wVG9FZGdlV3JhcHBpbmddIC0gVGhlIHdyYXBTIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbd3JhcFQ9Q2xhbXBUb0VkZ2VXcmFwcGluZ10gLSBUaGUgd3JhcFQgdmFsdWUuCiAgICogQHBhcmFtIHtudW1iZXJ9IFttYWdGaWx0ZXI9TGluZWFyRmlsdGVyXSAtIFRoZSBtYWcgZmlsdGVyIHZhbHVlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWluRmlsdGVyPUxpbmVhck1pcG1hcExpbmVhckZpbHRlcl0gLSBUaGUgbWluIGZpbHRlciB2YWx1ZS4KICAgKiBAcGFyYW0ge251bWJlcn0gW2Zvcm1hdD1SR0JBRm9ybWF0XSAtIFRoZSB0ZXh0dXJlIGZvcm1hdC4KICAgKiBAcGFyYW0ge251bWJlcn0gW3R5cGU9VW5zaWduZWRCeXRlVHlwZV0gLSBUaGUgdGV4dHVyZSB0eXBlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbYW5pc290cm9weT1UZXh0dXJlLkRFRkFVTFRfQU5JU09UUk9QWV0gLSBUaGUgYW5pc290cm9weSB2YWx1ZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yU3BhY2U9Tm9Db2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKi8KICBjb25zdHJ1Y3Rvcih0ID0gdXIuREVGQVVMVF9JTUFHRSwgZSA9IHVyLkRFRkFVTFRfTUFQUElORywgaSA9IHBoLCBuID0gcGgsIHMgPSBkQywgciA9IHBDLCBvID0gbUMsIGwgPSBmQywgaCA9IHVyLkRFRkFVTFRfQU5JU09UUk9QWSwgYyA9IFFfKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzVGV4dHVyZSA9ICEwLCBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgImlkIiwgeyB2YWx1ZTogYkMrKyB9KSwgdGhpcy51dWlkID0gTWYoKSwgdGhpcy5uYW1lID0gIiIsIHRoaXMuc291cmNlID0gbmV3IHZDKHQpLCB0aGlzLm1pcG1hcHMgPSBbXSwgdGhpcy5tYXBwaW5nID0gZSwgdGhpcy5jaGFubmVsID0gMCwgdGhpcy53cmFwUyA9IGksIHRoaXMud3JhcFQgPSBuLCB0aGlzLm1hZ0ZpbHRlciA9IHMsIHRoaXMubWluRmlsdGVyID0gciwgdGhpcy5hbmlzb3Ryb3B5ID0gaCwgdGhpcy5mb3JtYXQgPSBvLCB0aGlzLmludGVybmFsRm9ybWF0ID0gbnVsbCwgdGhpcy50eXBlID0gbCwgdGhpcy5vZmZzZXQgPSBuZXcgX28oMCwgMCksIHRoaXMucmVwZWF0ID0gbmV3IF9vKDEsIDEpLCB0aGlzLmNlbnRlciA9IG5ldyBfbygwLCAwKSwgdGhpcy5yb3RhdGlvbiA9IDAsIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9ICEwLCB0aGlzLm1hdHJpeCA9IG5ldyBfcigpLCB0aGlzLmdlbmVyYXRlTWlwbWFwcyA9ICEwLCB0aGlzLnByZW11bHRpcGx5QWxwaGEgPSAhMSwgdGhpcy5mbGlwWSA9ICEwLCB0aGlzLnVucGFja0FsaWdubWVudCA9IDQsIHRoaXMuY29sb3JTcGFjZSA9IGMsIHRoaXMudXNlckRhdGEgPSB7fSwgdGhpcy51cGRhdGVSYW5nZXMgPSBbXSwgdGhpcy52ZXJzaW9uID0gMCwgdGhpcy5vblVwZGF0ZSA9IG51bGwsIHRoaXMucmVuZGVyVGFyZ2V0ID0gbnVsbCwgdGhpcy5pc1JlbmRlclRhcmdldFRleHR1cmUgPSAhMSwgdGhpcy5pc0FycmF5VGV4dHVyZSA9ICEhKHQgJiYgdC5kZXB0aCAmJiB0LmRlcHRoID4gMSksIHRoaXMucG1yZW1WZXJzaW9uID0gMDsKICB9CiAgLyoqCiAgICogVGhlIHdpZHRoIG9mIHRoZSB0ZXh0dXJlIGluIHBpeGVscy4KICAgKi8KICBnZXQgd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy5zb3VyY2UuZ2V0U2l6ZShWZCkueDsKICB9CiAgLyoqCiAgICogVGhlIGhlaWdodCBvZiB0aGUgdGV4dHVyZSBpbiBwaXhlbHMuCiAgICovCiAgZ2V0IGhlaWdodCgpIHsKICAgIHJldHVybiB0aGlzLnNvdXJjZS5nZXRTaXplKFZkKS55OwogIH0KICAvKioKICAgKiBUaGUgZGVwdGggb2YgdGhlIHRleHR1cmUgaW4gcGl4ZWxzLgogICAqLwogIGdldCBkZXB0aCgpIHsKICAgIHJldHVybiB0aGlzLnNvdXJjZS5nZXRTaXplKFZkKS56OwogIH0KICAvKioKICAgKiBUaGUgaW1hZ2Ugb2JqZWN0IGhvbGRpbmcgdGhlIHRleHR1cmUgZGF0YS4KICAgKgogICAqIEB0eXBlIHs/T2JqZWN0fQogICAqLwogIGdldCBpbWFnZSgpIHsKICAgIHJldHVybiB0aGlzLnNvdXJjZS5kYXRhOwogIH0KICBzZXQgaW1hZ2UodCA9IG51bGwpIHsKICAgIHRoaXMuc291cmNlLmRhdGEgPSB0OwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSB0ZXh0dXJlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCBmcm9tIHRoZSBmcm9tIHRoZSBwcm9wZXJ0aWVzIHtAbGluayBUZXh0dXJlI29mZnNldH0sCiAgICoge0BsaW5rIFRleHR1cmUjcmVwZWF0fSwge0BsaW5rIFRleHR1cmUjcm90YXRpb259LCBhbmQge0BsaW5rIFRleHR1cmUjY2VudGVyfS4KICAgKi8KICB1cGRhdGVNYXRyaXgoKSB7CiAgICB0aGlzLm1hdHJpeC5zZXRVdlRyYW5zZm9ybSh0aGlzLm9mZnNldC54LCB0aGlzLm9mZnNldC55LCB0aGlzLnJlcGVhdC54LCB0aGlzLnJlcGVhdC55LCB0aGlzLnJvdGF0aW9uLCB0aGlzLmNlbnRlci54LCB0aGlzLmNlbnRlci55KTsKICB9CiAgLyoqCiAgICogQWRkcyBhIHJhbmdlIG9mIGRhdGEgaW4gdGhlIGRhdGEgdGV4dHVyZSB0byBiZSB1cGRhdGVkIG9uIHRoZSBHUFUuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBQb3NpdGlvbiBhdCB3aGljaCB0byBzdGFydCB1cGRhdGUuCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvdW50IC0gVGhlIG51bWJlciBvZiBjb21wb25lbnRzIHRvIHVwZGF0ZS4KICAgKi8KICBhZGRVcGRhdGVSYW5nZSh0LCBlKSB7CiAgICB0aGlzLnVwZGF0ZVJhbmdlcy5wdXNoKHsgc3RhcnQ6IHQsIGNvdW50OiBlIH0pOwogIH0KICAvKioKICAgKiBDbGVhcnMgdGhlIHVwZGF0ZSByYW5nZXMuCiAgICovCiAgY2xlYXJVcGRhdGVSYW5nZXMoKSB7CiAgICB0aGlzLnVwZGF0ZVJhbmdlcy5sZW5ndGggPSAwOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHRleHR1cmUgd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge1RleHR1cmV9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiB0ZXh0dXJlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge1RleHR1cmV9IHNvdXJjZSAtIFRoZSB0ZXh0dXJlIHRvIGNvcHkuCiAgICogQHJldHVybiB7VGV4dHVyZX0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQpIHsKICAgIHJldHVybiB0aGlzLm5hbWUgPSB0Lm5hbWUsIHRoaXMuc291cmNlID0gdC5zb3VyY2UsIHRoaXMubWlwbWFwcyA9IHQubWlwbWFwcy5zbGljZSgwKSwgdGhpcy5tYXBwaW5nID0gdC5tYXBwaW5nLCB0aGlzLmNoYW5uZWwgPSB0LmNoYW5uZWwsIHRoaXMud3JhcFMgPSB0LndyYXBTLCB0aGlzLndyYXBUID0gdC53cmFwVCwgdGhpcy5tYWdGaWx0ZXIgPSB0Lm1hZ0ZpbHRlciwgdGhpcy5taW5GaWx0ZXIgPSB0Lm1pbkZpbHRlciwgdGhpcy5hbmlzb3Ryb3B5ID0gdC5hbmlzb3Ryb3B5LCB0aGlzLmZvcm1hdCA9IHQuZm9ybWF0LCB0aGlzLmludGVybmFsRm9ybWF0ID0gdC5pbnRlcm5hbEZvcm1hdCwgdGhpcy50eXBlID0gdC50eXBlLCB0aGlzLm9mZnNldC5jb3B5KHQub2Zmc2V0KSwgdGhpcy5yZXBlYXQuY29weSh0LnJlcGVhdCksIHRoaXMuY2VudGVyLmNvcHkodC5jZW50ZXIpLCB0aGlzLnJvdGF0aW9uID0gdC5yb3RhdGlvbiwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gdC5tYXRyaXhBdXRvVXBkYXRlLCB0aGlzLm1hdHJpeC5jb3B5KHQubWF0cml4KSwgdGhpcy5nZW5lcmF0ZU1pcG1hcHMgPSB0LmdlbmVyYXRlTWlwbWFwcywgdGhpcy5wcmVtdWx0aXBseUFscGhhID0gdC5wcmVtdWx0aXBseUFscGhhLCB0aGlzLmZsaXBZID0gdC5mbGlwWSwgdGhpcy51bnBhY2tBbGlnbm1lbnQgPSB0LnVucGFja0FsaWdubWVudCwgdGhpcy5jb2xvclNwYWNlID0gdC5jb2xvclNwYWNlLCB0aGlzLnJlbmRlclRhcmdldCA9IHQucmVuZGVyVGFyZ2V0LCB0aGlzLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9IHQuaXNSZW5kZXJUYXJnZXRUZXh0dXJlLCB0aGlzLmlzQXJyYXlUZXh0dXJlID0gdC5pc0FycmF5VGV4dHVyZSwgdGhpcy51c2VyRGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodC51c2VyRGF0YSkpLCB0aGlzLm5lZWRzVXBkYXRlID0gITAsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyB0ZXh0dXJlJ3MgcHJvcGVydGllcyBiYXNlZCBvbiBgdmFsdWVzYC4KICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzIC0gQSBjb250YWluZXIgd2l0aCB0ZXh0dXJlIHBhcmFtZXRlcnMuCiAgICovCiAgc2V0VmFsdWVzKHQpIHsKICAgIGZvciAoY29uc3QgZSBpbiB0KSB7CiAgICAgIGNvbnN0IGkgPSB0W2VdOwogICAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBUSFJFRS5UZXh0dXJlLnNldFZhbHVlcygpOiBwYXJhbWV0ZXIgJyR7ZX0nIGhhcyB2YWx1ZSBvZiB1bmRlZmluZWQuYCk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgbiA9IHRoaXNbZV07CiAgICAgIGlmIChuID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLndhcm4oYFRIUkVFLlRleHR1cmUuc2V0VmFsdWVzKCk6IHByb3BlcnR5ICcke2V9JyBkb2VzIG5vdCBleGlzdC5gKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBuICYmIGkgJiYgbi5pc1ZlY3RvcjIgJiYgaS5pc1ZlY3RvcjIgfHwgbiAmJiBpICYmIG4uaXNWZWN0b3IzICYmIGkuaXNWZWN0b3IzIHx8IG4gJiYgaSAmJiBuLmlzTWF0cml4MyAmJiBpLmlzTWF0cml4MyA/IG4uY29weShpKSA6IHRoaXNbZV0gPSBpOwogICAgfQogIH0KICAvKioKICAgKiBTZXJpYWxpemVzIHRoZSB0ZXh0dXJlIGludG8gSlNPTi4KICAgKgogICAqIEBwYXJhbSB7PyhPYmplY3R8c3RyaW5nKX0gbWV0YSAtIEFuIG9wdGlvbmFsIHZhbHVlIGhvbGRpbmcgbWV0YSBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VyaWFsaXphdGlvbi4KICAgKiBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIHRleHR1cmUuCiAgICogQHNlZSB7QGxpbmsgT2JqZWN0TG9hZGVyI3BhcnNlfQogICAqLwogIHRvSlNPTih0KSB7CiAgICBjb25zdCBlID0gdCA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0ID09ICJzdHJpbmciOwogICAgaWYgKCFlICYmIHQudGV4dHVyZXNbdGhpcy51dWlkXSAhPT0gdm9pZCAwKQogICAgICByZXR1cm4gdC50ZXh0dXJlc1t0aGlzLnV1aWRdOwogICAgY29uc3QgaSA9IHsKICAgICAgbWV0YWRhdGE6IHsKICAgICAgICB2ZXJzaW9uOiA0LjcsCiAgICAgICAgdHlwZTogIlRleHR1cmUiLAogICAgICAgIGdlbmVyYXRvcjogIlRleHR1cmUudG9KU09OIgogICAgICB9LAogICAgICB1dWlkOiB0aGlzLnV1aWQsCiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgaW1hZ2U6IHRoaXMuc291cmNlLnRvSlNPTih0KS51dWlkLAogICAgICBtYXBwaW5nOiB0aGlzLm1hcHBpbmcsCiAgICAgIGNoYW5uZWw6IHRoaXMuY2hhbm5lbCwKICAgICAgcmVwZWF0OiBbdGhpcy5yZXBlYXQueCwgdGhpcy5yZXBlYXQueV0sCiAgICAgIG9mZnNldDogW3RoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnldLAogICAgICBjZW50ZXI6IFt0aGlzLmNlbnRlci54LCB0aGlzLmNlbnRlci55XSwKICAgICAgcm90YXRpb246IHRoaXMucm90YXRpb24sCiAgICAgIHdyYXA6IFt0aGlzLndyYXBTLCB0aGlzLndyYXBUXSwKICAgICAgZm9ybWF0OiB0aGlzLmZvcm1hdCwKICAgICAgaW50ZXJuYWxGb3JtYXQ6IHRoaXMuaW50ZXJuYWxGb3JtYXQsCiAgICAgIHR5cGU6IHRoaXMudHlwZSwKICAgICAgY29sb3JTcGFjZTogdGhpcy5jb2xvclNwYWNlLAogICAgICBtaW5GaWx0ZXI6IHRoaXMubWluRmlsdGVyLAogICAgICBtYWdGaWx0ZXI6IHRoaXMubWFnRmlsdGVyLAogICAgICBhbmlzb3Ryb3B5OiB0aGlzLmFuaXNvdHJvcHksCiAgICAgIGZsaXBZOiB0aGlzLmZsaXBZLAogICAgICBnZW5lcmF0ZU1pcG1hcHM6IHRoaXMuZ2VuZXJhdGVNaXBtYXBzLAogICAgICBwcmVtdWx0aXBseUFscGhhOiB0aGlzLnByZW11bHRpcGx5QWxwaGEsCiAgICAgIHVucGFja0FsaWdubWVudDogdGhpcy51bnBhY2tBbGlnbm1lbnQKICAgIH07CiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy51c2VyRGF0YSkubGVuZ3RoID4gMCAmJiAoaS51c2VyRGF0YSA9IHRoaXMudXNlckRhdGEpLCBlIHx8ICh0LnRleHR1cmVzW3RoaXMudXVpZF0gPSBpKSwgaTsKICB9CiAgLyoqCiAgICogRnJlZXMgdGhlIEdQVS1yZWxhdGVkIHJlc291cmNlcyBhbGxvY2F0ZWQgYnkgdGhpcyBpbnN0YW5jZS4gQ2FsbCB0aGlzCiAgICogbWV0aG9kIHdoZW5ldmVyIHRoaXMgaW5zdGFuY2UgaXMgbm8gbG9uZ2VyIHVzZWQgaW4geW91ciBhcHAuCiAgICoKICAgKiBAZmlyZXMgVGV4dHVyZSNkaXNwb3NlCiAgICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuZGlzcGF0Y2hFdmVudCh7IHR5cGU6ICJkaXNwb3NlIiB9KTsKICB9CiAgLyoqCiAgICogVHJhbnNmb3JtcyB0aGUgZ2l2ZW4gdXYgdmVjdG9yIHdpdGggdGhlIHRleHR1cmVzIHV2IHRyYW5zZm9ybWF0aW9uIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yMn0gdXYgLSBUaGUgdXYgdmVjdG9yLgogICAqIEByZXR1cm4ge1ZlY3RvcjJ9IFRoZSB0cmFuc2Zvcm1lZCB1diB2ZWN0b3IuCiAgICovCiAgdHJhbnNmb3JtVXYodCkgewogICAgaWYgKHRoaXMubWFwcGluZyAhPT0gS18pIHJldHVybiB0OwogICAgaWYgKHQuYXBwbHlNYXRyaXgzKHRoaXMubWF0cml4KSwgdC54IDwgMCB8fCB0LnggPiAxKQogICAgICBzd2l0Y2ggKHRoaXMud3JhcFMpIHsKICAgICAgICBjYXNlIEpnOgogICAgICAgICAgdC54ID0gdC54IC0gTWF0aC5mbG9vcih0LngpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBwaDoKICAgICAgICAgIHQueCA9IHQueCA8IDAgPyAwIDogMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgS2c6CiAgICAgICAgICBNYXRoLmFicyhNYXRoLmZsb29yKHQueCkgJSAyKSA9PT0gMSA/IHQueCA9IE1hdGguY2VpbCh0LngpIC0gdC54IDogdC54ID0gdC54IC0gTWF0aC5mbG9vcih0LngpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIGlmICh0LnkgPCAwIHx8IHQueSA+IDEpCiAgICAgIHN3aXRjaCAodGhpcy53cmFwVCkgewogICAgICAgIGNhc2UgSmc6CiAgICAgICAgICB0LnkgPSB0LnkgLSBNYXRoLmZsb29yKHQueSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIHBoOgogICAgICAgICAgdC55ID0gdC55IDwgMCA/IDAgOiAxOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBLZzoKICAgICAgICAgIE1hdGguYWJzKE1hdGguZmxvb3IodC55KSAlIDIpID09PSAxID8gdC55ID0gTWF0aC5jZWlsKHQueSkgLSB0LnkgOiB0LnkgPSB0LnkgLSBNYXRoLmZsb29yKHQueSk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgcmV0dXJuIHRoaXMuZmxpcFkgJiYgKHQueSA9IDEgLSB0LnkpLCB0OwogIH0KICAvKioKICAgKiBTZXR0aW5nIHRoaXMgcHJvcGVydHkgdG8gYHRydWVgIGluZGljYXRlcyB0aGUgZW5naW5lIHRoZSB0ZXh0dXJlCiAgICogbXVzdCBiZSB1cGRhdGVkIGluIHRoZSBuZXh0IHJlbmRlci4gVGhpcyB0cmlnZ2VycyBhIHRleHR1cmUgdXBsb2FkCiAgICogdG8gdGhlIEdQVSBhbmQgZW5zdXJlcyBjb3JyZWN0IHRleHR1cmUgcGFyYW1ldGVyIGNvbmZpZ3VyYXRpb24uCiAgICoKICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKiBAZGVmYXVsdCBmYWxzZQogICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUKICAgKi8KICBzZXQgbmVlZHNVcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgKHRoaXMudmVyc2lvbisrLCB0aGlzLnNvdXJjZS5uZWVkc1VwZGF0ZSA9ICEwKTsKICB9CiAgLyoqCiAgICogU2V0dGluZyB0aGlzIHByb3BlcnR5IHRvIGB0cnVlYCBpbmRpY2F0ZXMgdGhlIGVuZ2luZSB0aGUgUE1SRU0KICAgKiBtdXN0IGJlIHJlZ2VuZXJhdGVkLgogICAqCiAgICogQHR5cGUge2Jvb2xlYW59CiAgICogQGRlZmF1bHQgZmFsc2UKICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlCiAgICovCiAgc2V0IG5lZWRzUE1SRU1VcGRhdGUodCkgewogICAgdCA9PT0gITAgJiYgdGhpcy5wbXJlbVZlcnNpb24rKzsKICB9Cn0KdXIuREVGQVVMVF9JTUFHRSA9IG51bGw7CnVyLkRFRkFVTFRfTUFQUElORyA9IEtfOwp1ci5ERUZBVUxUX0FOSVNPVFJPUFkgPSAxOwpjbGFzcyBlcyB7CiAgLyoqCiAgICogQ29uc3RydWN0cyBhIG5ldyA0eDQgbWF0cml4LiBUaGUgYXJndW1lbnRzIGFyZSBzdXBwb3NlZCB0byBiZQogICAqIGluIHJvdy1tYWpvciBvcmRlci4gSWYgbm8gYXJndW1lbnRzIGFyZSBwcm92aWRlZCwgdGhlIGNvbnN0cnVjdG9yCiAgICogaW5pdGlhbGl6ZXMgdGhlIG1hdHJpeCBhcyBhbiBpZGVudGl0eSBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW24xMV0gLSAxLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTJdIC0gMS0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjEzXSAtIDEtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xNF0gLSAxLTQgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjFdIC0gMi0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIyXSAtIDItMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yM10gLSAyLTMgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjRdIC0gMi00IG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMxXSAtIDMtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMl0gLSAzLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzNdIC0gMy0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjM0XSAtIDMtNCBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW240MV0gLSA0LTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuNDJdIC0gNC0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjQzXSAtIDQtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW240NF0gLSA0LTQgbWF0cml4IGVsZW1lbnQuCiAgICovCiAgY29uc3RydWN0b3IodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCwgYywgdSwgZCwgcCwgZiwgeSwgZykgewogICAgZXMucHJvdG90eXBlLmlzTWF0cml4NCA9ICEwLCB0aGlzLmVsZW1lbnRzID0gWwogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICBdLCB0ICE9PSB2b2lkIDAgJiYgdGhpcy5zZXQodCwgZSwgaSwgbiwgcywgciwgbywgbCwgaCwgYywgdSwgZCwgcCwgZiwgeSwgZyk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGVsZW1lbnRzIG9mIHRoZSBtYXRyaXguVGhlIGFyZ3VtZW50cyBhcmUgc3VwcG9zZWQgdG8gYmUKICAgKiBpbiByb3ctbWFqb3Igb3JkZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW24xMV0gLSAxLTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMTJdIC0gMS0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjEzXSAtIDEtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24xNF0gLSAxLTQgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjFdIC0gMi0xIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjIyXSAtIDItMiBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24yM10gLSAyLTMgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMjRdIC0gMi00IG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjMxXSAtIDMtMSBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW24zMl0gLSAzLTIgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuMzNdIC0gMy0zIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjM0XSAtIDMtNCBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW240MV0gLSA0LTEgbWF0cml4IGVsZW1lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtuNDJdIC0gNC0yIG1hdHJpeCBlbGVtZW50LgogICAqIEBwYXJhbSB7bnVtYmVyfSBbbjQzXSAtIDQtMyBtYXRyaXggZWxlbWVudC4KICAgKiBAcGFyYW0ge251bWJlcn0gW240NF0gLSA0LTQgbWF0cml4IGVsZW1lbnQuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgc2V0KHQsIGUsIGksIG4sIHMsIHIsIG8sIGwsIGgsIGMsIHUsIGQsIHAsIGYsIHksIGcpIHsKICAgIGNvbnN0IG0gPSB0aGlzLmVsZW1lbnRzOwogICAgcmV0dXJuIG1bMF0gPSB0LCBtWzRdID0gZSwgbVs4XSA9IGksIG1bMTJdID0gbiwgbVsxXSA9IHMsIG1bNV0gPSByLCBtWzldID0gbywgbVsxM10gPSBsLCBtWzJdID0gaCwgbVs2XSA9IGMsIG1bMTBdID0gdSwgbVsxNF0gPSBkLCBtWzNdID0gcCwgbVs3XSA9IGYsIG1bMTFdID0geSwgbVsxNV0gPSBnLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IHRvIHRoZSA0eDQgaWRlbnRpdHkgbWF0cml4LgogICAqCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgaWRlbnRpdHkoKSB7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBtYXRyaXggd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgY2xvbmUgb2YgdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgZXMoKS5mcm9tQXJyYXkodGhpcy5lbGVtZW50cyk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiBtYXRyaXggdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSBtYXRyaXggdG8gY29weS4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBjb3B5KHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50czsKICAgIHJldHVybiBlWzBdID0gaVswXSwgZVsxXSA9IGlbMV0sIGVbMl0gPSBpWzJdLCBlWzNdID0gaVszXSwgZVs0XSA9IGlbNF0sIGVbNV0gPSBpWzVdLCBlWzZdID0gaVs2XSwgZVs3XSA9IGlbN10sIGVbOF0gPSBpWzhdLCBlWzldID0gaVs5XSwgZVsxMF0gPSBpWzEwXSwgZVsxMV0gPSBpWzExXSwgZVsxMl0gPSBpWzEyXSwgZVsxM10gPSBpWzEzXSwgZVsxNF0gPSBpWzE0XSwgZVsxNV0gPSBpWzE1XSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSB0cmFuc2xhdGlvbiBjb21wb25lbnQgb2YgdGhlIGdpdmVuIG1hdHJpeAogICAqIGludG8gdGhpcyBtYXRyaXgncyB0cmFuc2xhdGlvbiBjb21wb25lbnQuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4IHRvIGNvcHkgdGhlIHRyYW5zbGF0aW9uIGNvbXBvbmVudC4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBjb3B5UG9zaXRpb24odCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHMsIGkgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIGVbMTJdID0gaVsxMl0sIGVbMTNdID0gaVsxM10sIGVbMTRdID0gaVsxNF0sIHRoaXM7CiAgfQogIC8qKgogICAqIFNldCB0aGUgdXBwZXIgM3gzIGVsZW1lbnRzIG9mIHRoaXMgbWF0cml4IHRvIHRoZSB2YWx1ZXMgb2YgZ2l2ZW4gM3gzIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4M30gbSAtIFRoZSAzeDMgbWF0cml4LgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHNldEZyb21NYXRyaXgzKHQpIHsKICAgIGNvbnN0IGUgPSB0LmVsZW1lbnRzOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBlWzBdLAogICAgICBlWzNdLAogICAgICBlWzZdLAogICAgICAwLAogICAgICBlWzFdLAogICAgICBlWzRdLAogICAgICBlWzddLAogICAgICAwLAogICAgICBlWzJdLAogICAgICBlWzVdLAogICAgICBlWzhdLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBFeHRyYWN0cyB0aGUgYmFzaXMgb2YgdGhpcyBtYXRyaXggaW50byB0aGUgdGhyZWUgYXhpcyB2ZWN0b3JzIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB4QXhpcyAtIFRoZSBiYXNpcydzIHggYXhpcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHlBeGlzIC0gVGhlIGJhc2lzJ3MgeSBheGlzLgogICAqIEBwYXJhbSB7VmVjdG9yM30gekF4aXMgLSBUaGUgYmFzaXMncyB6IGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgZXh0cmFjdEJhc2lzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0LnNldEZyb21NYXRyaXhDb2x1bW4odGhpcywgMCksIGUuc2V0RnJvbU1hdHJpeENvbHVtbih0aGlzLCAxKSwgaS5zZXRGcm9tTWF0cml4Q29sdW1uKHRoaXMsIDIpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiBiYXNpcyB2ZWN0b3JzIHRvIHRoaXMgbWF0cml4LgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB4QXhpcyAtIFRoZSBiYXNpcydzIHggYXhpcy4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHlBeGlzIC0gVGhlIGJhc2lzJ3MgeSBheGlzLgogICAqIEBwYXJhbSB7VmVjdG9yM30gekF4aXMgLSBUaGUgYmFzaXMncyB6IGF4aXMuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbWFrZUJhc2lzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnNldCgKICAgICAgdC54LAogICAgICBlLngsCiAgICAgIGkueCwKICAgICAgMCwKICAgICAgdC55LAogICAgICBlLnksCiAgICAgIGkueSwKICAgICAgMCwKICAgICAgdC56LAogICAgICBlLnosCiAgICAgIGkueiwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSwgdGhpczsKICB9CiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIHJvdGF0aW9uIGNvbXBvbmVudCBvZiB0aGUgZ2l2ZW4gbWF0cml4CiAgICogaW50byB0aGlzIG1hdHJpeCdzIHJvdGF0aW9uIGNvbXBvbmVudC4KICAgKgogICAqIE5vdGU6IFRoaXMgbWV0aG9kIGRvZXMgbm90IHN1cHBvcnQgcmVmbGVjdGlvbiBtYXRyaWNlcy4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbSAtIFRoZSBtYXRyaXguCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgZXh0cmFjdFJvdGF0aW9uKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC5lbGVtZW50cywgbiA9IDEgLyBRci5zZXRGcm9tTWF0cml4Q29sdW1uKHQsIDApLmxlbmd0aCgpLCBzID0gMSAvIFFyLnNldEZyb21NYXRyaXhDb2x1bW4odCwgMSkubGVuZ3RoKCksIHIgPSAxIC8gUXIuc2V0RnJvbU1hdHJpeENvbHVtbih0LCAyKS5sZW5ndGgoKTsKICAgIHJldHVybiBlWzBdID0gaVswXSAqIG4sIGVbMV0gPSBpWzFdICogbiwgZVsyXSA9IGlbMl0gKiBuLCBlWzNdID0gMCwgZVs0XSA9IGlbNF0gKiBzLCBlWzVdID0gaVs1XSAqIHMsIGVbNl0gPSBpWzZdICogcywgZVs3XSA9IDAsIGVbOF0gPSBpWzhdICogciwgZVs5XSA9IGlbOV0gKiByLCBlWzEwXSA9IGlbMTBdICogciwgZVsxMV0gPSAwLCBlWzEyXSA9IDAsIGVbMTNdID0gMCwgZVsxNF0gPSAwLCBlWzE1XSA9IDEsIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHJvdGF0aW9uIGNvbXBvbmVudCAodGhlIHVwcGVyIGxlZnQgM3gzIG1hdHJpeCkgb2YgdGhpcyBtYXRyaXggdG8KICAgKiB0aGUgcm90YXRpb24gc3BlY2lmaWVkIGJ5IHRoZSBnaXZlbiBFdWxlciBhbmdsZXMuIFRoZSByZXN0IG9mCiAgICogdGhlIG1hdHJpeCBpcyBzZXQgdG8gdGhlIGlkZW50aXR5LiBEZXBlbmRpbmcgb24gdGhlIHtAbGluayBFdWxlciNvcmRlcn0sCiAgICogdGhlcmUgYXJlIHNpeCBwb3NzaWJsZSBvdXRjb21lcy4gU2VlIFt0aGlzIHBhZ2Vde0BsaW5rIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0V1bGVyX2FuZ2xlcyNSb3RhdGlvbl9tYXRyaXh9CiAgICogZm9yIGEgY29tcGxldGUgbGlzdC4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGFuZ2xlcy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlUm90YXRpb25Gcm9tRXVsZXIodCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHMsIGkgPSB0LngsIG4gPSB0LnksIHMgPSB0LnosIHIgPSBNYXRoLmNvcyhpKSwgbyA9IE1hdGguc2luKGkpLCBsID0gTWF0aC5jb3MobiksIGggPSBNYXRoLnNpbihuKSwgYyA9IE1hdGguY29zKHMpLCB1ID0gTWF0aC5zaW4ocyk7CiAgICBpZiAodC5vcmRlciA9PT0gIlhZWiIpIHsKICAgICAgY29uc3QgZCA9IHIgKiBjLCBwID0gciAqIHUsIGYgPSBvICogYywgeSA9IG8gKiB1OwogICAgICBlWzBdID0gbCAqIGMsIGVbNF0gPSAtbCAqIHUsIGVbOF0gPSBoLCBlWzFdID0gcCArIGYgKiBoLCBlWzVdID0gZCAtIHkgKiBoLCBlWzldID0gLW8gKiBsLCBlWzJdID0geSAtIGQgKiBoLCBlWzZdID0gZiArIHAgKiBoLCBlWzEwXSA9IHIgKiBsOwogICAgfSBlbHNlIGlmICh0Lm9yZGVyID09PSAiWVhaIikgewogICAgICBjb25zdCBkID0gbCAqIGMsIHAgPSBsICogdSwgZiA9IGggKiBjLCB5ID0gaCAqIHU7CiAgICAgIGVbMF0gPSBkICsgeSAqIG8sIGVbNF0gPSBmICogbyAtIHAsIGVbOF0gPSByICogaCwgZVsxXSA9IHIgKiB1LCBlWzVdID0gciAqIGMsIGVbOV0gPSAtbywgZVsyXSA9IHAgKiBvIC0gZiwgZVs2XSA9IHkgKyBkICogbywgZVsxMF0gPSByICogbDsKICAgIH0gZWxzZSBpZiAodC5vcmRlciA9PT0gIlpYWSIpIHsKICAgICAgY29uc3QgZCA9IGwgKiBjLCBwID0gbCAqIHUsIGYgPSBoICogYywgeSA9IGggKiB1OwogICAgICBlWzBdID0gZCAtIHkgKiBvLCBlWzRdID0gLXIgKiB1LCBlWzhdID0gZiArIHAgKiBvLCBlWzFdID0gcCArIGYgKiBvLCBlWzVdID0gciAqIGMsIGVbOV0gPSB5IC0gZCAqIG8sIGVbMl0gPSAtciAqIGgsIGVbNl0gPSBvLCBlWzEwXSA9IHIgKiBsOwogICAgfSBlbHNlIGlmICh0Lm9yZGVyID09PSAiWllYIikgewogICAgICBjb25zdCBkID0gciAqIGMsIHAgPSByICogdSwgZiA9IG8gKiBjLCB5ID0gbyAqIHU7CiAgICAgIGVbMF0gPSBsICogYywgZVs0XSA9IGYgKiBoIC0gcCwgZVs4XSA9IGQgKiBoICsgeSwgZVsxXSA9IGwgKiB1LCBlWzVdID0geSAqIGggKyBkLCBlWzldID0gcCAqIGggLSBmLCBlWzJdID0gLWgsIGVbNl0gPSBvICogbCwgZVsxMF0gPSByICogbDsKICAgIH0gZWxzZSBpZiAodC5vcmRlciA9PT0gIllaWCIpIHsKICAgICAgY29uc3QgZCA9IHIgKiBsLCBwID0gciAqIGgsIGYgPSBvICogbCwgeSA9IG8gKiBoOwogICAgICBlWzBdID0gbCAqIGMsIGVbNF0gPSB5IC0gZCAqIHUsIGVbOF0gPSBmICogdSArIHAsIGVbMV0gPSB1LCBlWzVdID0gciAqIGMsIGVbOV0gPSAtbyAqIGMsIGVbMl0gPSAtaCAqIGMsIGVbNl0gPSBwICogdSArIGYsIGVbMTBdID0gZCAtIHkgKiB1OwogICAgfSBlbHNlIGlmICh0Lm9yZGVyID09PSAiWFpZIikgewogICAgICBjb25zdCBkID0gciAqIGwsIHAgPSByICogaCwgZiA9IG8gKiBsLCB5ID0gbyAqIGg7CiAgICAgIGVbMF0gPSBsICogYywgZVs0XSA9IC11LCBlWzhdID0gaCAqIGMsIGVbMV0gPSBkICogdSArIHksIGVbNV0gPSByICogYywgZVs5XSA9IHAgKiB1IC0gZiwgZVsyXSA9IGYgKiB1IC0gcCwgZVs2XSA9IG8gKiBjLCBlWzEwXSA9IHkgKiB1ICsgZDsKICAgIH0KICAgIHJldHVybiBlWzNdID0gMCwgZVs3XSA9IDAsIGVbMTFdID0gMCwgZVsxMl0gPSAwLCBlWzEzXSA9IDAsIGVbMTRdID0gMCwgZVsxNV0gPSAxLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSByb3RhdGlvbiBjb21wb25lbnQgb2YgdGhpcyBtYXRyaXggdG8gdGhlIHJvdGF0aW9uIHNwZWNpZmllZCBieQogICAqIHRoZSBnaXZlbiBRdWF0ZXJuaW9uIGFzIG91dGxpbmVkIFtoZXJlXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Sb3RhdGlvbl9tYXRyaXgjUXVhdGVybmlvbn0KICAgKiBUaGUgcmVzdCBvZiB0aGUgbWF0cml4IGlzIHNldCB0byB0aGUgaWRlbnRpdHkuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgUXVhdGVybmlvbi4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlUm90YXRpb25Gcm9tUXVhdGVybmlvbih0KSB7CiAgICByZXR1cm4gdGhpcy5jb21wb3NlKE1DLCB0LCBTQyk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHJvdGF0aW9uIGNvbXBvbmVudCBvZiB0aGUgdHJhbnNmb3JtYXRpb24gbWF0cml4LCBsb29raW5nIGZyb20gYGV5ZWAgdG93YXJkcwogICAqIGB0YXJnZXRgLCBhbmQgb3JpZW50ZWQgYnkgdGhlIHVwLWRpcmVjdGlvbi4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gZXllIC0gVGhlIGV5ZSB2ZWN0b3IuCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3Rvci4KICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHVwIC0gVGhlIHVwIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBsb29rQXQodCwgZSwgaSkgewogICAgY29uc3QgbiA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gVWkuc3ViVmVjdG9ycyh0LCBlKSwgVWkubGVuZ3RoU3EoKSA9PT0gMCAmJiAoVWkueiA9IDEpLCBVaS5ub3JtYWxpemUoKSwgeXMuY3Jvc3NWZWN0b3JzKGksIFVpKSwgeXMubGVuZ3RoU3EoKSA9PT0gMCAmJiAoTWF0aC5hYnMoaS56KSA9PT0gMSA/IFVpLnggKz0gMWUtNCA6IFVpLnogKz0gMWUtNCwgVWkubm9ybWFsaXplKCksIHlzLmNyb3NzVmVjdG9ycyhpLCBVaSkpLCB5cy5ub3JtYWxpemUoKSwgbWguY3Jvc3NWZWN0b3JzKFVpLCB5cyksIG5bMF0gPSB5cy54LCBuWzRdID0gbWgueCwgbls4XSA9IFVpLngsIG5bMV0gPSB5cy55LCBuWzVdID0gbWgueSwgbls5XSA9IFVpLnksIG5bMl0gPSB5cy56LCBuWzZdID0gbWgueiwgblsxMF0gPSBVaS56LCB0aGlzOwogIH0KICAvKioKICAgKiBQb3N0LW11bHRpcGxpZXMgdGhpcyBtYXRyaXggYnkgdGhlIGdpdmVuIDR4NCBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4IHRvIG11bHRpcGx5IHdpdGguCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlNYXRyaWNlcyh0aGlzLCB0KTsKICB9CiAgLyoqCiAgICogUHJlLW11bHRpcGxpZXMgdGhpcyBtYXRyaXggYnkgdGhlIGdpdmVuIDR4NCBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBUaGUgbWF0cml4IHRvIG11bHRpcGx5IHdpdGguCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgcHJlbXVsdGlwbHkodCkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlNYXRyaWNlcyh0LCB0aGlzKTsKICB9CiAgLyoqCiAgICogTXVsdGlwbGVzIHRoZSBnaXZlbiA0eDQgbWF0cmljZXMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0CiAgICogaW4gdGhpcyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IGEgLSBUaGUgZmlyc3QgbWF0cml4LgogICAqIEBwYXJhbSB7TWF0cml4NH0gYiAtIFRoZSBzZWNvbmQgbWF0cml4LgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG11bHRpcGx5TWF0cmljZXModCwgZSkgewogICAgY29uc3QgaSA9IHQuZWxlbWVudHMsIG4gPSBlLmVsZW1lbnRzLCBzID0gdGhpcy5lbGVtZW50cywgciA9IGlbMF0sIG8gPSBpWzRdLCBsID0gaVs4XSwgaCA9IGlbMTJdLCBjID0gaVsxXSwgdSA9IGlbNV0sIGQgPSBpWzldLCBwID0gaVsxM10sIGYgPSBpWzJdLCB5ID0gaVs2XSwgZyA9IGlbMTBdLCBtID0gaVsxNF0sIHYgPSBpWzNdLCB4ID0gaVs3XSwgXyA9IGlbMTFdLCBTID0gaVsxNV0sIHcgPSBuWzBdLCBUID0gbls0XSwgUiA9IG5bOF0sIGIgPSBuWzEyXSwgTSA9IG5bMV0sIEwgPSBuWzVdLCBVID0gbls5XSwgTyA9IG5bMTNdLCBWID0gblsyXSwgVyA9IG5bNl0sIEcgPSBuWzEwXSwgZXQgPSBuWzE0XSwgSCA9IG5bM10sIGF0ID0gbls3XSwgcHQgPSBuWzExXSwgTXQgPSBuWzE1XTsKICAgIHJldHVybiBzWzBdID0gciAqIHcgKyBvICogTSArIGwgKiBWICsgaCAqIEgsIHNbNF0gPSByICogVCArIG8gKiBMICsgbCAqIFcgKyBoICogYXQsIHNbOF0gPSByICogUiArIG8gKiBVICsgbCAqIEcgKyBoICogcHQsIHNbMTJdID0gciAqIGIgKyBvICogTyArIGwgKiBldCArIGggKiBNdCwgc1sxXSA9IGMgKiB3ICsgdSAqIE0gKyBkICogViArIHAgKiBILCBzWzVdID0gYyAqIFQgKyB1ICogTCArIGQgKiBXICsgcCAqIGF0LCBzWzldID0gYyAqIFIgKyB1ICogVSArIGQgKiBHICsgcCAqIHB0LCBzWzEzXSA9IGMgKiBiICsgdSAqIE8gKyBkICogZXQgKyBwICogTXQsIHNbMl0gPSBmICogdyArIHkgKiBNICsgZyAqIFYgKyBtICogSCwgc1s2XSA9IGYgKiBUICsgeSAqIEwgKyBnICogVyArIG0gKiBhdCwgc1sxMF0gPSBmICogUiArIHkgKiBVICsgZyAqIEcgKyBtICogcHQsIHNbMTRdID0gZiAqIGIgKyB5ICogTyArIGcgKiBldCArIG0gKiBNdCwgc1szXSA9IHYgKiB3ICsgeCAqIE0gKyBfICogViArIFMgKiBILCBzWzddID0gdiAqIFQgKyB4ICogTCArIF8gKiBXICsgUyAqIGF0LCBzWzExXSA9IHYgKiBSICsgeCAqIFUgKyBfICogRyArIFMgKiBwdCwgc1sxNV0gPSB2ICogYiArIHggKiBPICsgXyAqIGV0ICsgUyAqIE10LCB0aGlzOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIGV2ZXJ5IGNvbXBvbmVudCBvZiB0aGUgbWF0cml4IGJ5IHRoZSBnaXZlbiBzY2FsYXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFRoZSBzY2FsYXIuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgbXVsdGlwbHlTY2FsYXIodCkgewogICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gZVswXSAqPSB0LCBlWzRdICo9IHQsIGVbOF0gKj0gdCwgZVsxMl0gKj0gdCwgZVsxXSAqPSB0LCBlWzVdICo9IHQsIGVbOV0gKj0gdCwgZVsxM10gKj0gdCwgZVsyXSAqPSB0LCBlWzZdICo9IHQsIGVbMTBdICo9IHQsIGVbMTRdICo9IHQsIGVbM10gKj0gdCwgZVs3XSAqPSB0LCBlWzExXSAqPSB0LCBlWzE1XSAqPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBDb21wdXRlcyBhbmQgcmV0dXJucyB0aGUgZGV0ZXJtaW5hbnQgb2YgdGhpcyBtYXRyaXguCiAgICoKICAgKiBCYXNlZCBvbiB0aGUgbWV0aG9kIG91dGxpbmVkIFtoZXJlXXtAbGluayBodHRwOi8vd3d3LmV1Y2xpZGVhbnNwYWNlLmNvbS9tYXRocy9hbGdlYnJhL21hdHJpeC9mdW5jdGlvbnMvaW52ZXJzZS9mb3VyRC9pbmRleC5odG1sfS4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRldGVybWluYW50LgogICAqLwogIGRldGVybWluYW50KCkgewogICAgY29uc3QgdCA9IHRoaXMuZWxlbWVudHMsIGUgPSB0WzBdLCBpID0gdFs0XSwgbiA9IHRbOF0sIHMgPSB0WzEyXSwgciA9IHRbMV0sIG8gPSB0WzVdLCBsID0gdFs5XSwgaCA9IHRbMTNdLCBjID0gdFsyXSwgdSA9IHRbNl0sIGQgPSB0WzEwXSwgcCA9IHRbMTRdLCBmID0gdFszXSwgeSA9IHRbN10sIGcgPSB0WzExXSwgbSA9IHRbMTVdOwogICAgcmV0dXJuIGYgKiAoK3MgKiBsICogdSAtIG4gKiBoICogdSAtIHMgKiBvICogZCArIGkgKiBoICogZCArIG4gKiBvICogcCAtIGkgKiBsICogcCkgKyB5ICogKCtlICogbCAqIHAgLSBlICogaCAqIGQgKyBzICogciAqIGQgLSBuICogciAqIHAgKyBuICogaCAqIGMgLSBzICogbCAqIGMpICsgZyAqICgrZSAqIGggKiB1IC0gZSAqIG8gKiBwIC0gcyAqIHIgKiB1ICsgaSAqIHIgKiBwICsgcyAqIG8gKiBjIC0gaSAqIGggKiBjKSArIG0gKiAoLW4gKiBvICogYyAtIGUgKiBsICogdSArIGUgKiBvICogZCArIG4gKiByICogdSAtIGkgKiByICogZCArIGkgKiBsICogYyk7CiAgfQogIC8qKgogICAqIFRyYW5zcG9zZXMgdGhpcyBtYXRyaXggaW4gcGxhY2UuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICB0cmFuc3Bvc2UoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50czsKICAgIGxldCBlOwogICAgcmV0dXJuIGUgPSB0WzFdLCB0WzFdID0gdFs0XSwgdFs0XSA9IGUsIGUgPSB0WzJdLCB0WzJdID0gdFs4XSwgdFs4XSA9IGUsIGUgPSB0WzZdLCB0WzZdID0gdFs5XSwgdFs5XSA9IGUsIGUgPSB0WzNdLCB0WzNdID0gdFsxMl0sIHRbMTJdID0gZSwgZSA9IHRbN10sIHRbN10gPSB0WzEzXSwgdFsxM10gPSBlLCBlID0gdFsxMV0sIHRbMTFdID0gdFsxNF0sIHRbMTRdID0gZSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgcG9zaXRpb24gY29tcG9uZW50IGZvciB0aGlzIG1hdHJpeCBmcm9tIHRoZSBnaXZlbiB2ZWN0b3IsCiAgICogd2l0aG91dCBhZmZlY3RpbmcgdGhlIHJlc3Qgb2YgdGhlIG1hdHJpeC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfFZlY3RvcjN9IHggLSBUaGUgeCBjb21wb25lbnQgb2YgdGhlIHZlY3RvciBvciBhbHRlcm5hdGl2ZWx5IHRoZSB2ZWN0b3Igb2JqZWN0LgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29tcG9uZW50IG9mIHRoZSB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgeiBjb21wb25lbnQgb2YgdGhlIHZlY3Rvci4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBzZXRQb3NpdGlvbih0LCBlLCBpKSB7CiAgICBjb25zdCBuID0gdGhpcy5lbGVtZW50czsKICAgIHJldHVybiB0LmlzVmVjdG9yMyA/IChuWzEyXSA9IHQueCwgblsxM10gPSB0LnksIG5bMTRdID0gdC56KSA6IChuWzEyXSA9IHQsIG5bMTNdID0gZSwgblsxNF0gPSBpKSwgdGhpczsKICB9CiAgLyoqCiAgICogSW52ZXJ0cyB0aGlzIG1hdHJpeCwgdXNpbmcgdGhlIFthbmFseXRpYyBtZXRob2Rde0BsaW5rIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0ludmVydGlibGVfbWF0cml4I0FuYWx5dGljX3NvbHV0aW9ufS4KICAgKiBZb3UgY2FuIG5vdCBpbnZlcnQgd2l0aCBhIGRldGVybWluYW50IG9mIHplcm8uIElmIHlvdSBhdHRlbXB0IHRoaXMsIHRoZSBtZXRob2QgcHJvZHVjZXMKICAgKiBhIHplcm8gbWF0cml4IGluc3RlYWQuCiAgICoKICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBpbnZlcnQoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0sIGkgPSB0WzFdLCBuID0gdFsyXSwgcyA9IHRbM10sIHIgPSB0WzRdLCBvID0gdFs1XSwgbCA9IHRbNl0sIGggPSB0WzddLCBjID0gdFs4XSwgdSA9IHRbOV0sIGQgPSB0WzEwXSwgcCA9IHRbMTFdLCBmID0gdFsxMl0sIHkgPSB0WzEzXSwgZyA9IHRbMTRdLCBtID0gdFsxNV0sIHYgPSB1ICogZyAqIGggLSB5ICogZCAqIGggKyB5ICogbCAqIHAgLSBvICogZyAqIHAgLSB1ICogbCAqIG0gKyBvICogZCAqIG0sIHggPSBmICogZCAqIGggLSBjICogZyAqIGggLSBmICogbCAqIHAgKyByICogZyAqIHAgKyBjICogbCAqIG0gLSByICogZCAqIG0sIF8gPSBjICogeSAqIGggLSBmICogdSAqIGggKyBmICogbyAqIHAgLSByICogeSAqIHAgLSBjICogbyAqIG0gKyByICogdSAqIG0sIFMgPSBmICogdSAqIGwgLSBjICogeSAqIGwgLSBmICogbyAqIGQgKyByICogeSAqIGQgKyBjICogbyAqIGcgLSByICogdSAqIGcsIHcgPSBlICogdiArIGkgKiB4ICsgbiAqIF8gKyBzICogUzsKICAgIGlmICh3ID09PSAwKSByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCk7CiAgICBjb25zdCBUID0gMSAvIHc7CiAgICByZXR1cm4gdFswXSA9IHYgKiBULCB0WzFdID0gKHkgKiBkICogcyAtIHUgKiBnICogcyAtIHkgKiBuICogcCArIGkgKiBnICogcCArIHUgKiBuICogbSAtIGkgKiBkICogbSkgKiBULCB0WzJdID0gKG8gKiBnICogcyAtIHkgKiBsICogcyArIHkgKiBuICogaCAtIGkgKiBnICogaCAtIG8gKiBuICogbSArIGkgKiBsICogbSkgKiBULCB0WzNdID0gKHUgKiBsICogcyAtIG8gKiBkICogcyAtIHUgKiBuICogaCArIGkgKiBkICogaCArIG8gKiBuICogcCAtIGkgKiBsICogcCkgKiBULCB0WzRdID0geCAqIFQsIHRbNV0gPSAoYyAqIGcgKiBzIC0gZiAqIGQgKiBzICsgZiAqIG4gKiBwIC0gZSAqIGcgKiBwIC0gYyAqIG4gKiBtICsgZSAqIGQgKiBtKSAqIFQsIHRbNl0gPSAoZiAqIGwgKiBzIC0gciAqIGcgKiBzIC0gZiAqIG4gKiBoICsgZSAqIGcgKiBoICsgciAqIG4gKiBtIC0gZSAqIGwgKiBtKSAqIFQsIHRbN10gPSAociAqIGQgKiBzIC0gYyAqIGwgKiBzICsgYyAqIG4gKiBoIC0gZSAqIGQgKiBoIC0gciAqIG4gKiBwICsgZSAqIGwgKiBwKSAqIFQsIHRbOF0gPSBfICogVCwgdFs5XSA9IChmICogdSAqIHMgLSBjICogeSAqIHMgLSBmICogaSAqIHAgKyBlICogeSAqIHAgKyBjICogaSAqIG0gLSBlICogdSAqIG0pICogVCwgdFsxMF0gPSAociAqIHkgKiBzIC0gZiAqIG8gKiBzICsgZiAqIGkgKiBoIC0gZSAqIHkgKiBoIC0gciAqIGkgKiBtICsgZSAqIG8gKiBtKSAqIFQsIHRbMTFdID0gKGMgKiBvICogcyAtIHIgKiB1ICogcyAtIGMgKiBpICogaCArIGUgKiB1ICogaCArIHIgKiBpICogcCAtIGUgKiBvICogcCkgKiBULCB0WzEyXSA9IFMgKiBULCB0WzEzXSA9IChjICogeSAqIG4gLSBmICogdSAqIG4gKyBmICogaSAqIGQgLSBlICogeSAqIGQgLSBjICogaSAqIGcgKyBlICogdSAqIGcpICogVCwgdFsxNF0gPSAoZiAqIG8gKiBuIC0gciAqIHkgKiBuIC0gZiAqIGkgKiBsICsgZSAqIHkgKiBsICsgciAqIGkgKiBnIC0gZSAqIG8gKiBnKSAqIFQsIHRbMTVdID0gKHIgKiB1ICogbiAtIGMgKiBvICogbiArIGMgKiBpICogbCAtIGUgKiB1ICogbCAtIHIgKiBpICogZCArIGUgKiBvICogZCkgKiBULCB0aGlzOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoZSBjb2x1bW5zIG9mIHRoaXMgbWF0cml4IGJ5IHRoZSBnaXZlbiB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgc2NhbGUgdmVjdG9yLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIHNjYWxlKHQpIHsKICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzLCBpID0gdC54LCBuID0gdC55LCBzID0gdC56OwogICAgcmV0dXJuIGVbMF0gKj0gaSwgZVs0XSAqPSBuLCBlWzhdICo9IHMsIGVbMV0gKj0gaSwgZVs1XSAqPSBuLCBlWzldICo9IHMsIGVbMl0gKj0gaSwgZVs2XSAqPSBuLCBlWzEwXSAqPSBzLCBlWzNdICo9IGksIGVbN10gKj0gbiwgZVsxMV0gKj0gcywgdGhpczsKICB9CiAgLyoqCiAgICogR2V0cyB0aGUgbWF4aW11bSBzY2FsZSB2YWx1ZSBvZiB0aGUgdGhyZWUgYXhlcy4KICAgKgogICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG1heGltdW0gc2NhbGUuCiAgICovCiAgZ2V0TWF4U2NhbGVPbkF4aXMoKSB7CiAgICBjb25zdCB0ID0gdGhpcy5lbGVtZW50cywgZSA9IHRbMF0gKiB0WzBdICsgdFsxXSAqIHRbMV0gKyB0WzJdICogdFsyXSwgaSA9IHRbNF0gKiB0WzRdICsgdFs1XSAqIHRbNV0gKyB0WzZdICogdFs2XSwgbiA9IHRbOF0gKiB0WzhdICsgdFs5XSAqIHRbOV0gKyB0WzEwXSAqIHRbMTBdOwogICAgcmV0dXJuIE1hdGguc3FydChNYXRoLm1heChlLCBpLCBuKSk7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBtYXRyaXggYXMgYSB0cmFuc2xhdGlvbiB0cmFuc2Zvcm0gZnJvbSB0aGUgZ2l2ZW4gdmVjdG9yLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ8VmVjdG9yM30geCAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBYIGF4aXMgb3IgYWx0ZXJuYXRpdmVseSBhIHRyYW5zbGF0aW9uIHZlY3Rvci4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBhbW91bnQgdG8gdHJhbnNsYXRlIGluIHRoZSBZIGF4aXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IHogLSBUaGUgYW1vdW50IHRvIHRyYW5zbGF0ZSBpbiB0aGUgeiBheGlzLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VUcmFuc2xhdGlvbih0LCBlLCBpKSB7CiAgICByZXR1cm4gdC5pc1ZlY3RvcjMgPyB0aGlzLnNldCgKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgdC54LAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICB0LnksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIHQueiwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKSA6IHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICB0LAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICBpLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgcm90YXRpb25hbCB0cmFuc2Zvcm1hdGlvbiBhcm91bmQgdGhlIFggYXhpcyBieQogICAqIHRoZSBnaXZlbiBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VSb3RhdGlvblgodCkgewogICAgY29uc3QgZSA9IE1hdGguY29zKHQpLCBpID0gTWF0aC5zaW4odCk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIGUsCiAgICAgIC1pLAogICAgICAwLAogICAgICAwLAogICAgICBpLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgcm90YXRpb25hbCB0cmFuc2Zvcm1hdGlvbiBhcm91bmQgdGhlIFkgYXhpcyBieQogICAqIHRoZSBnaXZlbiBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VSb3RhdGlvblkodCkgewogICAgY29uc3QgZSA9IE1hdGguY29zKHQpLCBpID0gTWF0aC5zaW4odCk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGUsCiAgICAgIDAsCiAgICAgIGksCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIC1pLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgcm90YXRpb25hbCB0cmFuc2Zvcm1hdGlvbiBhcm91bmQgdGhlIFogYXhpcyBieQogICAqIHRoZSBnaXZlbiBhbmdsZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB0aGV0YSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VSb3RhdGlvbloodCkgewogICAgY29uc3QgZSA9IE1hdGguY29zKHQpLCBpID0gTWF0aC5zaW4odCk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGUsCiAgICAgIC1pLAogICAgICAwLAogICAgICAwLAogICAgICBpLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgcm90YXRpb25hbCB0cmFuc2Zvcm1hdGlvbiBhcm91bmQgdGhlIGdpdmVuIGF4aXMgYnkKICAgKiB0aGUgZ2l2ZW4gYW5nbGUuCiAgICoKICAgKiBUaGlzIGlzIGEgc29tZXdoYXQgY29udHJvdmVyc2lhbCBidXQgbWF0aGVtYXRpY2FsbHkgc291bmQgYWx0ZXJuYXRpdmUgdG8KICAgKiByb3RhdGluZyB2aWEgUXVhdGVybmlvbnMuIFNlZSB0aGUgZGlzY3Vzc2lvbiBbaGVyZV17QGxpbmsgaHR0cHM6Ly93d3cuZ2FtZWRldi5uZXQvYXJ0aWNsZXMvcHJvZ3JhbW1pbmcvbWF0aC1hbmQtcGh5c2ljcy9kby13ZS1yZWFsbHktbmVlZC1xdWF0ZXJuaW9ucy1yMTE5OX0uCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGF4aXMgLSBUaGUgbm9ybWFsaXplZCByb3RhdGlvbiBheGlzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSByb3RhdGlvbiBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogICAqLwogIG1ha2VSb3RhdGlvbkF4aXModCwgZSkgewogICAgY29uc3QgaSA9IE1hdGguY29zKGUpLCBuID0gTWF0aC5zaW4oZSksIHMgPSAxIC0gaSwgciA9IHQueCwgbyA9IHQueSwgbCA9IHQueiwgaCA9IHMgKiByLCBjID0gcyAqIG87CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIGggKiByICsgaSwKICAgICAgaCAqIG8gLSBuICogbCwKICAgICAgaCAqIGwgKyBuICogbywKICAgICAgMCwKICAgICAgaCAqIG8gKyBuICogbCwKICAgICAgYyAqIG8gKyBpLAogICAgICBjICogbCAtIG4gKiByLAogICAgICAwLAogICAgICBoICogbCAtIG4gKiBvLAogICAgICBjICogbCArIG4gKiByLAogICAgICBzICogbCAqIGwgKyBpLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgc2NhbGUgdHJhbnNmb3JtYXRpb24uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFggYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFkgYXhpcy4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSBhbW91bnQgdG8gc2NhbGUgaW4gdGhlIFogYXhpcy4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlU2NhbGUodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICB0LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICBlLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICBpLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IGFzIGEgc2hlYXIgdHJhbnNmb3JtYXRpb24uCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geHkgLSBUaGUgYW1vdW50IHRvIHNoZWFyIFggYnkgWS4KICAgKiBAcGFyYW0ge251bWJlcn0geHogLSBUaGUgYW1vdW50IHRvIHNoZWFyIFggYnkgWi4KICAgKiBAcGFyYW0ge251bWJlcn0geXggLSBUaGUgYW1vdW50IHRvIHNoZWFyIFkgYnkgWC4KICAgKiBAcGFyYW0ge251bWJlcn0geXogLSBUaGUgYW1vdW50IHRvIHNoZWFyIFkgYnkgWi4KICAgKiBAcGFyYW0ge251bWJlcn0genggLSBUaGUgYW1vdW50IHRvIHNoZWFyIFogYnkgWC4KICAgKiBAcGFyYW0ge251bWJlcn0genkgLSBUaGUgYW1vdW50IHRvIHNoZWFyIFogYnkgWS4KICAgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAgKi8KICBtYWtlU2hlYXIodCwgZSwgaSwgbiwgcywgcikgewogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICAxLAogICAgICBpLAogICAgICBzLAogICAgICAwLAogICAgICB0LAogICAgICAxLAogICAgICByLAogICAgICAwLAogICAgICBlLAogICAgICBuLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgbWF0cml4IHRvIHRoZSB0cmFuc2Zvcm1hdGlvbiBjb21wb3NlZCBvZiB0aGUgZ2l2ZW4gcG9zaXRpb24sCiAgICogcm90YXRpb24gKFF1YXRlcm5pb24pIGFuZCBzY2FsZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9zaXRpb24gLSBUaGUgcG9zaXRpb24gdmVjdG9yLgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcXVhdGVybmlvbiAtIFRoZSByb3RhdGlvbiBhcyBhIFF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtWZWN0b3IzfSBzY2FsZSAtIFRoZSBzY2FsZSB2ZWN0b3IuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgY29tcG9zZSh0LCBlLCBpKSB7CiAgICBjb25zdCBuID0gdGhpcy5lbGVtZW50cywgcyA9IGUuX3gsIHIgPSBlLl95LCBvID0gZS5feiwgbCA9IGUuX3csIGggPSBzICsgcywgYyA9IHIgKyByLCB1ID0gbyArIG8sIGQgPSBzICogaCwgcCA9IHMgKiBjLCBmID0gcyAqIHUsIHkgPSByICogYywgZyA9IHIgKiB1LCBtID0gbyAqIHUsIHYgPSBsICogaCwgeCA9IGwgKiBjLCBfID0gbCAqIHUsIFMgPSBpLngsIHcgPSBpLnksIFQgPSBpLno7CiAgICByZXR1cm4gblswXSA9ICgxIC0gKHkgKyBtKSkgKiBTLCBuWzFdID0gKHAgKyBfKSAqIFMsIG5bMl0gPSAoZiAtIHgpICogUywgblszXSA9IDAsIG5bNF0gPSAocCAtIF8pICogdywgbls1XSA9ICgxIC0gKGQgKyBtKSkgKiB3LCBuWzZdID0gKGcgKyB2KSAqIHcsIG5bN10gPSAwLCBuWzhdID0gKGYgKyB4KSAqIFQsIG5bOV0gPSAoZyAtIHYpICogVCwgblsxMF0gPSAoMSAtIChkICsgeSkpICogVCwgblsxMV0gPSAwLCBuWzEyXSA9IHQueCwgblsxM10gPSB0LnksIG5bMTRdID0gdC56LCBuWzE1XSA9IDEsIHRoaXM7CiAgfQogIC8qKgogICAqIERlY29tcG9zZXMgdGhpcyBtYXRyaXggaW50byBpdHMgcG9zaXRpb24sIHJvdGF0aW9uIGFuZCBzY2FsZSBjb21wb25lbnRzCiAgICogYW5kIHByb3ZpZGVzIHRoZSByZXN1bHQgaW4gdGhlIGdpdmVuIG9iamVjdHMuCiAgICoKICAgKiBOb3RlOiBOb3QgYWxsIG1hdHJpY2VzIGFyZSBkZWNvbXBvc2FibGUgaW4gdGhpcyB3YXkuIEZvciBleGFtcGxlLCBpZiBhbgogICAqIG9iamVjdCBoYXMgYSBub24tdW5pZm9ybWx5IHNjYWxlZCBwYXJlbnQsIHRoZW4gdGhlIG9iamVjdCdzIHdvcmxkIG1hdHJpeAogICAqIG1heSBub3QgYmUgZGVjb21wb3NhYmxlLCBhbmQgdGhpcyBtZXRob2QgbWF5IG5vdCBiZSBhcHByb3ByaWF0ZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gcG9zaXRpb24gLSBUaGUgcG9zaXRpb24gdmVjdG9yLgogICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcXVhdGVybmlvbiAtIFRoZSByb3RhdGlvbiBhcyBhIFF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtWZWN0b3IzfSBzY2FsZSAtIFRoZSBzY2FsZSB2ZWN0b3IuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgZGVjb21wb3NlKHQsIGUsIGkpIHsKICAgIGNvbnN0IG4gPSB0aGlzLmVsZW1lbnRzOwogICAgbGV0IHMgPSBRci5zZXQoblswXSwgblsxXSwgblsyXSkubGVuZ3RoKCk7CiAgICBjb25zdCByID0gUXIuc2V0KG5bNF0sIG5bNV0sIG5bNl0pLmxlbmd0aCgpLCBvID0gUXIuc2V0KG5bOF0sIG5bOV0sIG5bMTBdKS5sZW5ndGgoKTsKICAgIHRoaXMuZGV0ZXJtaW5hbnQoKSA8IDAgJiYgKHMgPSAtcyksIHQueCA9IG5bMTJdLCB0LnkgPSBuWzEzXSwgdC56ID0gblsxNF0sIHJuLmNvcHkodGhpcyk7CiAgICBjb25zdCBoID0gMSAvIHMsIGMgPSAxIC8gciwgdSA9IDEgLyBvOwogICAgcmV0dXJuIHJuLmVsZW1lbnRzWzBdICo9IGgsIHJuLmVsZW1lbnRzWzFdICo9IGgsIHJuLmVsZW1lbnRzWzJdICo9IGgsIHJuLmVsZW1lbnRzWzRdICo9IGMsIHJuLmVsZW1lbnRzWzVdICo9IGMsIHJuLmVsZW1lbnRzWzZdICo9IGMsIHJuLmVsZW1lbnRzWzhdICo9IHUsIHJuLmVsZW1lbnRzWzldICo9IHUsIHJuLmVsZW1lbnRzWzEwXSAqPSB1LCBlLnNldEZyb21Sb3RhdGlvbk1hdHJpeChybiksIGkueCA9IHMsIGkueSA9IHIsIGkueiA9IG8sIHRoaXM7CiAgfQogIC8qKgogIAkgKiBDcmVhdGVzIGEgcGVyc3BlY3RpdmUgcHJvamVjdGlvbiBtYXRyaXguIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5IGJ5CiAgCSAqIHtAbGluayBQZXJzcGVjdGl2ZUNhbWVyYSN1cGRhdGVQcm9qZWN0aW9uTWF0cml4fS4KICAKICAJICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgLSBMZWZ0IGJvdW5kYXJ5IG9mIHRoZSB2aWV3aW5nIGZydXN0dW0gYXQgdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSByaWdodCAtIFJpZ2h0IGJvdW5kYXJ5IG9mIHRoZSB2aWV3aW5nIGZydXN0dW0gYXQgdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgLSBUb3AgYm91bmRhcnkgb2YgdGhlIHZpZXdpbmcgZnJ1c3R1bSBhdCB0aGUgbmVhciBwbGFuZS4KICAJICogQHBhcmFtIHtudW1iZXJ9IGJvdHRvbSAtIEJvdHRvbSBib3VuZGFyeSBvZiB0aGUgdmlld2luZyBmcnVzdHVtIGF0IHRoZSBuZWFyIHBsYW5lLgogIAkgKiBAcGFyYW0ge251bWJlcn0gbmVhciAtIFRoZSBkaXN0YW5jZSBmcm9tIHRoZSBjYW1lcmEgdG8gdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSBmYXIgLSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgY2FtZXJhIHRvIHRoZSBmYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7KFdlYkdMQ29vcmRpbmF0ZVN5c3RlbXxXZWJHUFVDb29yZGluYXRlU3lzdGVtKX0gW2Nvb3JkaW5hdGVTeXN0ZW09V2ViR0xDb29yZGluYXRlU3lzdGVtXSAtIFRoZSBjb29yZGluYXRlIHN5c3RlbS4KICAJICogQHBhcmFtIHtib29sZWFufSBbcmV2ZXJzZWREZXB0aD1mYWxzZV0gLSBXaGV0aGVyIHRvIHVzZSBhIHJldmVyc2VkIGRlcHRoLgogIAkgKiBAcmV0dXJuIHtNYXRyaXg0fSBBIHJlZmVyZW5jZSB0byB0aGlzIG1hdHJpeC4KICAJICovCiAgbWFrZVBlcnNwZWN0aXZlKHQsIGUsIGksIG4sIHMsIHIsIG8gPSBmaCwgbCA9ICExKSB7CiAgICBjb25zdCBoID0gdGhpcy5lbGVtZW50cywgYyA9IDIgKiBzIC8gKGUgLSB0KSwgdSA9IDIgKiBzIC8gKGkgLSBuKSwgZCA9IChlICsgdCkgLyAoZSAtIHQpLCBwID0gKGkgKyBuKSAvIChpIC0gbik7CiAgICBsZXQgZiwgeTsKICAgIGlmIChsKQogICAgICBmID0gcyAvIChyIC0gcyksIHkgPSByICogcyAvIChyIC0gcyk7CiAgICBlbHNlIGlmIChvID09PSBmaCkKICAgICAgZiA9IC0ociArIHMpIC8gKHIgLSBzKSwgeSA9IC0yICogciAqIHMgLyAociAtIHMpOwogICAgZWxzZSBpZiAobyA9PT0gZTApCiAgICAgIGYgPSAtciAvIChyIC0gcyksIHkgPSAtciAqIHMgLyAociAtIHMpOwogICAgZWxzZQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRIUkVFLk1hdHJpeDQubWFrZVBlcnNwZWN0aXZlKCk6IEludmFsaWQgY29vcmRpbmF0ZSBzeXN0ZW06ICIgKyBvKTsKICAgIHJldHVybiBoWzBdID0gYywgaFs0XSA9IDAsIGhbOF0gPSBkLCBoWzEyXSA9IDAsIGhbMV0gPSAwLCBoWzVdID0gdSwgaFs5XSA9IHAsIGhbMTNdID0gMCwgaFsyXSA9IDAsIGhbNl0gPSAwLCBoWzEwXSA9IGYsIGhbMTRdID0geSwgaFszXSA9IDAsIGhbN10gPSAwLCBoWzExXSA9IC0xLCBoWzE1XSA9IDAsIHRoaXM7CiAgfQogIC8qKgogIAkgKiBDcmVhdGVzIGEgb3J0aG9ncmFwaGljIHByb2plY3Rpb24gbWF0cml4LiBUaGlzIGlzIHVzZWQgaW50ZXJuYWxseSBieQogIAkgKiB7QGxpbmsgT3J0aG9ncmFwaGljQ2FtZXJhI3VwZGF0ZVByb2plY3Rpb25NYXRyaXh9LgogIAogIAkgKiBAcGFyYW0ge251bWJlcn0gbGVmdCAtIExlZnQgYm91bmRhcnkgb2YgdGhlIHZpZXdpbmcgZnJ1c3R1bSBhdCB0aGUgbmVhciBwbGFuZS4KICAJICogQHBhcmFtIHtudW1iZXJ9IHJpZ2h0IC0gUmlnaHQgYm91bmRhcnkgb2YgdGhlIHZpZXdpbmcgZnJ1c3R1bSBhdCB0aGUgbmVhciBwbGFuZS4KICAJICogQHBhcmFtIHtudW1iZXJ9IHRvcCAtIFRvcCBib3VuZGFyeSBvZiB0aGUgdmlld2luZyBmcnVzdHVtIGF0IHRoZSBuZWFyIHBsYW5lLgogIAkgKiBAcGFyYW0ge251bWJlcn0gYm90dG9tIC0gQm90dG9tIGJvdW5kYXJ5IG9mIHRoZSB2aWV3aW5nIGZydXN0dW0gYXQgdGhlIG5lYXIgcGxhbmUuCiAgCSAqIEBwYXJhbSB7bnVtYmVyfSBuZWFyIC0gVGhlIGRpc3RhbmNlIGZyb20gdGhlIGNhbWVyYSB0byB0aGUgbmVhciBwbGFuZS4KICAJICogQHBhcmFtIHtudW1iZXJ9IGZhciAtIFRoZSBkaXN0YW5jZSBmcm9tIHRoZSBjYW1lcmEgdG8gdGhlIGZhciBwbGFuZS4KICAJICogQHBhcmFtIHsoV2ViR0xDb29yZGluYXRlU3lzdGVtfFdlYkdQVUNvb3JkaW5hdGVTeXN0ZW0pfSBbY29vcmRpbmF0ZVN5c3RlbT1XZWJHTENvb3JkaW5hdGVTeXN0ZW1dIC0gVGhlIGNvb3JkaW5hdGUgc3lzdGVtLgogIAkgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXZlcnNlZERlcHRoPWZhbHNlXSAtIFdoZXRoZXIgdG8gdXNlIGEgcmV2ZXJzZWQgZGVwdGguCiAgCSAqIEByZXR1cm4ge01hdHJpeDR9IEEgcmVmZXJlbmNlIHRvIHRoaXMgbWF0cml4LgogIAkgKi8KICBtYWtlT3J0aG9ncmFwaGljKHQsIGUsIGksIG4sIHMsIHIsIG8gPSBmaCwgbCA9ICExKSB7CiAgICBjb25zdCBoID0gdGhpcy5lbGVtZW50cywgYyA9IDIgLyAoZSAtIHQpLCB1ID0gMiAvIChpIC0gbiksIGQgPSAtKGUgKyB0KSAvIChlIC0gdCksIHAgPSAtKGkgKyBuKSAvIChpIC0gbik7CiAgICBsZXQgZiwgeTsKICAgIGlmIChsKQogICAgICBmID0gMSAvIChyIC0gcyksIHkgPSByIC8gKHIgLSBzKTsKICAgIGVsc2UgaWYgKG8gPT09IGZoKQogICAgICBmID0gLTIgLyAociAtIHMpLCB5ID0gLShyICsgcykgLyAociAtIHMpOwogICAgZWxzZSBpZiAobyA9PT0gZTApCiAgICAgIGYgPSAtMSAvIChyIC0gcyksIHkgPSAtcyAvIChyIC0gcyk7CiAgICBlbHNlCiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuTWF0cml4NC5tYWtlT3J0aG9ncmFwaGljKCk6IEludmFsaWQgY29vcmRpbmF0ZSBzeXN0ZW06ICIgKyBvKTsKICAgIHJldHVybiBoWzBdID0gYywgaFs0XSA9IDAsIGhbOF0gPSAwLCBoWzEyXSA9IGQsIGhbMV0gPSAwLCBoWzVdID0gdSwgaFs5XSA9IDAsIGhbMTNdID0gcCwgaFsyXSA9IDAsIGhbNl0gPSAwLCBoWzEwXSA9IGYsIGhbMTRdID0geSwgaFszXSA9IDAsIGhbN10gPSAwLCBoWzExXSA9IDAsIGhbMTVdID0gMSwgdGhpczsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyBtYXRyaXggaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqCiAgICogQHBhcmFtIHtNYXRyaXg0fSBtYXRyaXggLSBUaGUgbWF0cml4IHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhpcyBtYXRyaXggaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqLwogIGVxdWFscyh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50cywgaSA9IHQuZWxlbWVudHM7CiAgICBmb3IgKGxldCBuID0gMDsgbiA8IDE2OyBuKyspCiAgICAgIGlmIChlW25dICE9PSBpW25dKSByZXR1cm4gITE7CiAgICByZXR1cm4gITA7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGVsZW1lbnRzIG9mIHRoZSBtYXRyaXggZnJvbSB0aGUgZ2l2ZW4gYXJyYXkuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGFycmF5IC0gVGhlIG1hdHJpeCBlbGVtZW50cyBpbiBjb2x1bW4tbWFqb3Igb3JkZXIuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXQ9MF0gLSBJbmRleCBvZiB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgYXJyYXkuCiAgICogQHJldHVybiB7TWF0cml4NH0gQSByZWZlcmVuY2UgdG8gdGhpcyBtYXRyaXguCiAgICovCiAgZnJvbUFycmF5KHQsIGUgPSAwKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspCiAgICAgIHRoaXMuZWxlbWVudHNbaV0gPSB0W2kgKyBlXTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBXcml0ZXMgdGhlIGVsZW1lbnRzIG9mIHRoaXMgbWF0cml4IHRvIHRoZSBnaXZlbiBhcnJheS4gSWYgbm8gYXJyYXkgaXMgcHJvdmlkZWQsCiAgICogdGhlIG1ldGhvZCByZXR1cm5zIGEgbmV3IGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBbYXJyYXk9W11dIC0gVGhlIHRhcmdldCBhcnJheSBob2xkaW5nIHRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcj59IFRoZSBtYXRyaXggZWxlbWVudHMgaW4gY29sdW1uLW1ham9yIG9yZGVyLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgY29uc3QgaSA9IHRoaXMuZWxlbWVudHM7CiAgICByZXR1cm4gdFtlXSA9IGlbMF0sIHRbZSArIDFdID0gaVsxXSwgdFtlICsgMl0gPSBpWzJdLCB0W2UgKyAzXSA9IGlbM10sIHRbZSArIDRdID0gaVs0XSwgdFtlICsgNV0gPSBpWzVdLCB0W2UgKyA2XSA9IGlbNl0sIHRbZSArIDddID0gaVs3XSwgdFtlICsgOF0gPSBpWzhdLCB0W2UgKyA5XSA9IGlbOV0sIHRbZSArIDEwXSA9IGlbMTBdLCB0W2UgKyAxMV0gPSBpWzExXSwgdFtlICsgMTJdID0gaVsxMl0sIHRbZSArIDEzXSA9IGlbMTNdLCB0W2UgKyAxNF0gPSBpWzE0XSwgdFtlICsgMTVdID0gaVsxNV0sIHQ7CiAgfQp9CmNvbnN0IFFyID0gLyogQF9fUFVSRV9fICovIG5ldyBGZSgpLCBybiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgZXMoKSwgTUMgPSAvKiBAX19QVVJFX18gKi8gbmV3IEZlKDAsIDAsIDApLCBTQyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRmUoMSwgMSwgMSksIHlzID0gLyogQF9fUFVSRV9fICovIG5ldyBGZSgpLCBtaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRmUoKSwgVWkgPSAvKiBAX19QVVJFX18gKi8gbmV3IEZlKCksIGwwID0gLyogQF9fUFVSRV9fICovIG5ldyBlcygpLCBoMCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgJG8oKTsKY2xhc3MgZnUgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgZXVsZXIgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgYW5nbGUgb2YgdGhlIHggYXhpcyBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSBhbmdsZSBvZiB0aGUgeSBheGlzIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtudW1iZXJ9IFt6PTBdIC0gVGhlIGFuZ2xlIG9mIHRoZSB6IGF4aXMgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge3N0cmluZ30gW29yZGVyPUV1bGVyLkRFRkFVTFRfT1JERVJdIC0gQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBvcmRlciB0aGF0IHRoZSByb3RhdGlvbnMgYXJlIGFwcGxpZWQuCiAgICovCiAgY29uc3RydWN0b3IodCA9IDAsIGUgPSAwLCBpID0gMCwgbiA9IGZ1LkRFRkFVTFRfT1JERVIpIHsKICAgIHRoaXMuaXNFdWxlciA9ICEwLCB0aGlzLl94ID0gdCwgdGhpcy5feSA9IGUsIHRoaXMuX3ogPSBpLCB0aGlzLl9vcmRlciA9IG47CiAgfQogIC8qKgogICAqIFRoZSBhbmdsZSBvZiB0aGUgeCBheGlzIGluIHJhZGlhbnMuCiAgICoKICAgKiBAdHlwZSB7bnVtYmVyfQogICAqIEBkZWZhdWx0IDAKICAgKi8KICBnZXQgeCgpIHsKICAgIHJldHVybiB0aGlzLl94OwogIH0KICBzZXQgeCh0KSB7CiAgICB0aGlzLl94ID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBUaGUgYW5nbGUgb2YgdGhlIHkgYXhpcyBpbiByYWRpYW5zLgogICAqCiAgICogQHR5cGUge251bWJlcn0KICAgKiBAZGVmYXVsdCAwCiAgICovCiAgZ2V0IHkoKSB7CiAgICByZXR1cm4gdGhpcy5feTsKICB9CiAgc2V0IHkodCkgewogICAgdGhpcy5feSA9IHQsIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgLyoqCiAgICogVGhlIGFuZ2xlIG9mIHRoZSB6IGF4aXMgaW4gcmFkaWFucy4KICAgKgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICogQGRlZmF1bHQgMAogICAqLwogIGdldCB6KCkgewogICAgcmV0dXJuIHRoaXMuX3o7CiAgfQogIHNldCB6KHQpIHsKICAgIHRoaXMuX3ogPSB0LCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIC8qKgogICAqIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgb3JkZXIgdGhhdCB0aGUgcm90YXRpb25zIGFyZSBhcHBsaWVkLgogICAqCiAgICogQHR5cGUge3N0cmluZ30KICAgKiBAZGVmYXVsdCAnWFlaJwogICAqLwogIGdldCBvcmRlcigpIHsKICAgIHJldHVybiB0aGlzLl9vcmRlcjsKICB9CiAgc2V0IG9yZGVyKHQpIHsKICAgIHRoaXMuX29yZGVyID0gdCwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBFdWxlciBjb21wb25lbnRzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgYW5nbGUgb2YgdGhlIHggYXhpcyBpbiByYWRpYW5zLgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIGFuZ2xlIG9mIHRoZSB5IGF4aXMgaW4gcmFkaWFucy4KICAgKiBAcGFyYW0ge251bWJlcn0geiAtIFRoZSBhbmdsZSBvZiB0aGUgeiBheGlzIGluIHJhZGlhbnMuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtvcmRlcl0gLSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIG9yZGVyIHRoYXQgdGhlIHJvdGF0aW9ucyBhcmUgYXBwbGllZC4KICAgKiBAcmV0dXJuIHtFdWxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBFdWxlciBpbnN0YW5jZS4KICAgKi8KICBzZXQodCwgZSwgaSwgbiA9IHRoaXMuX29yZGVyKSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHQsIHRoaXMuX3kgPSBlLCB0aGlzLl96ID0gaSwgdGhpcy5fb3JkZXIgPSBuLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgRXVsZXIgaW5zdGFuY2Ugd2l0aCBjb3BpZWQgdmFsdWVzIGZyb20gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEByZXR1cm4ge0V1bGVyfSBBIGNsb25lIG9mIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5feCwgdGhpcy5feSwgdGhpcy5feiwgdGhpcy5fb3JkZXIpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gRXVsZXIgaW5zdGFuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGluc3RhbmNlIHRvIGNvcHkuCiAgICogQHJldHVybiB7RXVsZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgRXVsZXIgaW5zdGFuY2UuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHQuX3gsIHRoaXMuX3kgPSB0Ll95LCB0aGlzLl96ID0gdC5feiwgdGhpcy5fb3JkZXIgPSB0Ll9vcmRlciwgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBhbmdsZXMgb2YgdGhpcyBFdWxlciBpbnN0YW5jZSBmcm9tIGEgcHVyZSByb3RhdGlvbiBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBBIDR4NCBtYXRyaXggb2Ygd2hpY2ggdGhlIHVwcGVyIDN4MyBvZiBtYXRyaXggaXMgYSBwdXJlIHJvdGF0aW9uIG1hdHJpeCAoaS5lLiB1bnNjYWxlZCkuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtvcmRlcl0gLSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIG9yZGVyIHRoYXQgdGhlIHJvdGF0aW9ucyBhcmUgYXBwbGllZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1cGRhdGU9dHJ1ZV0gLSBXaGV0aGVyIHRoZSBpbnRlcm5hbCBgb25DaGFuZ2VgIGNhbGxiYWNrIHNob3VsZCBiZSBleGVjdXRlZCBvciBub3QuCiAgICogQHJldHVybiB7RXVsZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgRXVsZXIgaW5zdGFuY2UuCiAgICovCiAgc2V0RnJvbVJvdGF0aW9uTWF0cml4KHQsIGUgPSB0aGlzLl9vcmRlciwgaSA9ICEwKSB7CiAgICBjb25zdCBuID0gdC5lbGVtZW50cywgcyA9IG5bMF0sIHIgPSBuWzRdLCBvID0gbls4XSwgbCA9IG5bMV0sIGggPSBuWzVdLCBjID0gbls5XSwgdSA9IG5bMl0sIGQgPSBuWzZdLCBwID0gblsxMF07CiAgICBzd2l0Y2ggKGUpIHsKICAgICAgY2FzZSAiWFlaIjoKICAgICAgICB0aGlzLl95ID0gTWF0aC5hc2luKHllKG8sIC0xLCAxKSksIE1hdGguYWJzKG8pIDwgMC45OTk5OTk5ID8gKHRoaXMuX3ggPSBNYXRoLmF0YW4yKC1jLCBwKSwgdGhpcy5feiA9IE1hdGguYXRhbjIoLXIsIHMpKSA6ICh0aGlzLl94ID0gTWF0aC5hdGFuMihkLCBoKSwgdGhpcy5feiA9IDApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJZWFoiOgogICAgICAgIHRoaXMuX3ggPSBNYXRoLmFzaW4oLXllKGMsIC0xLCAxKSksIE1hdGguYWJzKGMpIDwgMC45OTk5OTk5ID8gKHRoaXMuX3kgPSBNYXRoLmF0YW4yKG8sIHApLCB0aGlzLl96ID0gTWF0aC5hdGFuMihsLCBoKSkgOiAodGhpcy5feSA9IE1hdGguYXRhbjIoLXUsIHMpLCB0aGlzLl96ID0gMCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlpYWSI6CiAgICAgICAgdGhpcy5feCA9IE1hdGguYXNpbih5ZShkLCAtMSwgMSkpLCBNYXRoLmFicyhkKSA8IDAuOTk5OTk5OSA/ICh0aGlzLl95ID0gTWF0aC5hdGFuMigtdSwgcCksIHRoaXMuX3ogPSBNYXRoLmF0YW4yKC1yLCBoKSkgOiAodGhpcy5feSA9IDAsIHRoaXMuX3ogPSBNYXRoLmF0YW4yKGwsIHMpKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWllYIjoKICAgICAgICB0aGlzLl95ID0gTWF0aC5hc2luKC15ZSh1LCAtMSwgMSkpLCBNYXRoLmFicyh1KSA8IDAuOTk5OTk5OSA/ICh0aGlzLl94ID0gTWF0aC5hdGFuMihkLCBwKSwgdGhpcy5feiA9IE1hdGguYXRhbjIobCwgcykpIDogKHRoaXMuX3ggPSAwLCB0aGlzLl96ID0gTWF0aC5hdGFuMigtciwgaCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJZWlgiOgogICAgICAgIHRoaXMuX3ogPSBNYXRoLmFzaW4oeWUobCwgLTEsIDEpKSwgTWF0aC5hYnMobCkgPCAwLjk5OTk5OTkgPyAodGhpcy5feCA9IE1hdGguYXRhbjIoLWMsIGgpLCB0aGlzLl95ID0gTWF0aC5hdGFuMigtdSwgcykpIDogKHRoaXMuX3ggPSAwLCB0aGlzLl95ID0gTWF0aC5hdGFuMihvLCBwKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlhaWSI6CiAgICAgICAgdGhpcy5feiA9IE1hdGguYXNpbigteWUociwgLTEsIDEpKSwgTWF0aC5hYnMocikgPCAwLjk5OTk5OTkgPyAodGhpcy5feCA9IE1hdGguYXRhbjIoZCwgaCksIHRoaXMuX3kgPSBNYXRoLmF0YW4yKG8sIHMpKSA6ICh0aGlzLl94ID0gTWF0aC5hdGFuMigtYywgcCksIHRoaXMuX3kgPSAwKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBjb25zb2xlLndhcm4oIlRIUkVFLkV1bGVyOiAuc2V0RnJvbVJvdGF0aW9uTWF0cml4KCkgZW5jb3VudGVyZWQgYW4gdW5rbm93biBvcmRlcjogIiArIGUpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX29yZGVyID0gZSwgaSA9PT0gITAgJiYgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBhbmdsZXMgb2YgdGhpcyBFdWxlciBpbnN0YW5jZSBmcm9tIGEgbm9ybWFsaXplZCBxdWF0ZXJuaW9uLgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gQSBub3JtYWxpemVkIFF1YXRlcm5pb24uCiAgICogQHBhcmFtIHtzdHJpbmd9IFtvcmRlcl0gLSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIG9yZGVyIHRoYXQgdGhlIHJvdGF0aW9ucyBhcmUgYXBwbGllZC4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1cGRhdGU9dHJ1ZV0gLSBXaGV0aGVyIHRoZSBpbnRlcm5hbCBgb25DaGFuZ2VgIGNhbGxiYWNrIHNob3VsZCBiZSBleGVjdXRlZCBvciBub3QuCiAgICogQHJldHVybiB7RXVsZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgRXVsZXIgaW5zdGFuY2UuCiAgICovCiAgc2V0RnJvbVF1YXRlcm5pb24odCwgZSwgaSkgewogICAgcmV0dXJuIGwwLm1ha2VSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKHQpLCB0aGlzLnNldEZyb21Sb3RhdGlvbk1hdHJpeChsMCwgZSwgaSk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGFuZ2xlcyBvZiB0aGlzIEV1bGVyIGluc3RhbmNlIGZyb20gdGhlIGdpdmVuIHZlY3Rvci4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gdiAtIFRoZSB2ZWN0b3IuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtvcmRlcl0gLSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIG9yZGVyIHRoYXQgdGhlIHJvdGF0aW9ucyBhcmUgYXBwbGllZC4KICAgKiBAcmV0dXJuIHtFdWxlcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBFdWxlciBpbnN0YW5jZS4KICAgKi8KICBzZXRGcm9tVmVjdG9yMyh0LCBlID0gdGhpcy5fb3JkZXIpIHsKICAgIHJldHVybiB0aGlzLnNldCh0LngsIHQueSwgdC56LCBlKTsKICB9CiAgLyoqCiAgICogUmVzZXRzIHRoZSBldWxlciBhbmdsZSB3aXRoIGEgbmV3IG9yZGVyIGJ5IGNyZWF0aW5nIGEgcXVhdGVybmlvbiBmcm9tIHRoaXMKICAgKiBldWxlciBhbmdsZSBhbmQgdGhlbiBzZXR0aW5nIHRoaXMgZXVsZXIgYW5nbGUgd2l0aCB0aGUgcXVhdGVybmlvbiBhbmQgdGhlCiAgICogbmV3IG9yZGVyLgogICAqCiAgICogV2FybmluZzogVGhpcyBkaXNjYXJkcyByZXZvbHV0aW9uIGluZm9ybWF0aW9uLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IFtuZXdPcmRlcl0gLSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIG5ldyBvcmRlciB0aGF0IHRoZSByb3RhdGlvbnMgYXJlIGFwcGxpZWQuCiAgICogQHJldHVybiB7RXVsZXJ9IEEgcmVmZXJlbmNlIHRvIHRoaXMgRXVsZXIgaW5zdGFuY2UuCiAgICovCiAgcmVvcmRlcih0KSB7CiAgICByZXR1cm4gaDAuc2V0RnJvbUV1bGVyKHRoaXMpLCB0aGlzLnNldEZyb21RdWF0ZXJuaW9uKGgwLCB0KTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhpcyBFdWxlciBpbnN0YW5jZSBpcyBlcXVhbCB3aXRoIHRoZSBnaXZlbiBvbmUuCiAgICoKICAgKiBAcGFyYW0ge0V1bGVyfSBldWxlciAtIFRoZSBFdWxlciBpbnN0YW5jZSB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoaXMgRXVsZXIgaW5zdGFuY2UgaXMgZXF1YWwgd2l0aCB0aGUgZ2l2ZW4gb25lLgogICAqLwogIGVxdWFscyh0KSB7CiAgICByZXR1cm4gdC5feCA9PT0gdGhpcy5feCAmJiB0Ll95ID09PSB0aGlzLl95ICYmIHQuX3ogPT09IHRoaXMuX3ogJiYgdC5fb3JkZXIgPT09IHRoaXMuX29yZGVyOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgRXVsZXIgaW5zdGFuY2UncyBjb21wb25lbnRzIHRvIHZhbHVlcyBmcm9tIHRoZSBnaXZlbiBhcnJheS4gVGhlIGZpcnN0IHRocmVlCiAgICogZW50cmllcyBvZiB0aGUgYXJyYXkgYXJlIGFzc2lnbiB0byB0aGUgeCx5IGFuZCB6IGNvbXBvbmVudHMuIEFuIG9wdGlvbmFsIGZvdXJ0aCBlbnRyeQogICAqIGRlZmluZXMgdGhlIEV1bGVyIG9yZGVyLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXIsbnVtYmVyLG51bWJlciw/c3RyaW5nPn0gYXJyYXkgLSBBbiBhcnJheSBob2xkaW5nIHRoZSBFdWxlciBjb21wb25lbnQgdmFsdWVzLgogICAqIEByZXR1cm4ge0V1bGVyfSBBIHJlZmVyZW5jZSB0byB0aGlzIEV1bGVyIGluc3RhbmNlLgogICAqLwogIGZyb21BcnJheSh0KSB7CiAgICByZXR1cm4gdGhpcy5feCA9IHRbMF0sIHRoaXMuX3kgPSB0WzFdLCB0aGlzLl96ID0gdFsyXSwgdFszXSAhPT0gdm9pZCAwICYmICh0aGlzLl9vcmRlciA9IHRbM10pLCB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCksIHRoaXM7CiAgfQogIC8qKgogICAqIFdyaXRlcyB0aGUgY29tcG9uZW50cyBvZiB0aGlzIEV1bGVyIGluc3RhbmNlIHRvIHRoZSBnaXZlbiBhcnJheS4gSWYgbm8gYXJyYXkgaXMgcHJvdmlkZWQsCiAgICogdGhlIG1ldGhvZCByZXR1cm5zIGEgbmV3IGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXIsbnVtYmVyLG51bWJlcixzdHJpbmc+fSBbYXJyYXk9W11dIC0gVGhlIHRhcmdldCBhcnJheSBob2xkaW5nIHRoZSBFdWxlciBjb21wb25lbnRzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gSW5kZXggb2YgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIGFycmF5LgogICAqIEByZXR1cm4ge0FycmF5PG51bWJlcixudW1iZXIsbnVtYmVyLHN0cmluZz59IFRoZSBFdWxlciBjb21wb25lbnRzLgogICAqLwogIHRvQXJyYXkodCA9IFtdLCBlID0gMCkgewogICAgcmV0dXJuIHRbZV0gPSB0aGlzLl94LCB0W2UgKyAxXSA9IHRoaXMuX3ksIHRbZSArIDJdID0gdGhpcy5feiwgdFtlICsgM10gPSB0aGlzLl9vcmRlciwgdDsKICB9CiAgX29uQ2hhbmdlKHQpIHsKICAgIHJldHVybiB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrID0gdCwgdGhpczsKICB9CiAgX29uQ2hhbmdlQ2FsbGJhY2soKSB7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMuX3gsIHlpZWxkIHRoaXMuX3ksIHlpZWxkIHRoaXMuX3osIHlpZWxkIHRoaXMuX29yZGVyOwogIH0KfQpmdS5ERUZBVUxUX09SREVSID0gIlhZWiI7CmNsYXNzIHdDIHsKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgbmV3IGxheWVycyBpbnN0YW5jZSwgd2l0aCBtZW1iZXJzaGlwCiAgICogaW5pdGlhbGx5IHNldCB0byBsYXllciBgMGAuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm1hc2sgPSAxOwogIH0KICAvKioKICAgKiBTZXRzIG1lbWJlcnNoaXAgdG8gdGhlIGdpdmVuIGxheWVyLCBhbmQgcmVtb3ZlIG1lbWJlcnNoaXAgYWxsIG90aGVyIGxheWVycy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byBzZXQuCiAgICovCiAgc2V0KHQpIHsKICAgIHRoaXMubWFzayA9ICgxIDw8IHQgfCAwKSA+Pj4gMDsKICB9CiAgLyoqCiAgICogQWRkcyBtZW1iZXJzaGlwIG9mIHRoZSBnaXZlbiBsYXllci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byBlbmFibGUuCiAgICovCiAgZW5hYmxlKHQpIHsKICAgIHRoaXMubWFzayB8PSAxIDw8IHQgfCAwOwogIH0KICAvKioKICAgKiBBZGRzIG1lbWJlcnNoaXAgdG8gYWxsIGxheWVycy4KICAgKi8KICBlbmFibGVBbGwoKSB7CiAgICB0aGlzLm1hc2sgPSAtMTsKICB9CiAgLyoqCiAgICogVG9nZ2xlcyB0aGUgbWVtYmVyc2hpcCBvZiB0aGUgZ2l2ZW4gbGF5ZXIuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbGF5ZXIgLSBUaGUgbGF5ZXIgdG8gdG9nZ2xlLgogICAqLwogIHRvZ2dsZSh0KSB7CiAgICB0aGlzLm1hc2sgXj0gMSA8PCB0IHwgMDsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyBtZW1iZXJzaGlwIG9mIHRoZSBnaXZlbiBsYXllci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byBlbmFibGUuCiAgICovCiAgZGlzYWJsZSh0KSB7CiAgICB0aGlzLm1hc2sgJj0gfigxIDw8IHQgfCAwKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyB0aGUgbWVtYmVyc2hpcCBmcm9tIGFsbCBsYXllcnMuCiAgICovCiAgZGlzYWJsZUFsbCgpIHsKICAgIHRoaXMubWFzayA9IDA7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgYW5kIHRoZSBnaXZlbiBsYXllcnMgb2JqZWN0IGhhdmUgYXQgbGVhc3Qgb25lCiAgICogbGF5ZXIgaW4gY29tbW9uLgogICAqCiAgICogQHBhcmFtIHtMYXllcnN9IGxheWVycyAtIFRoZSBsYXllcnMgdG8gdGVzdC4KICAgKiBAcmV0dXJuIHtib29sZWFuIH0gV2hldGhlciB0aGlzIGFuZCB0aGUgZ2l2ZW4gbGF5ZXJzIG9iamVjdCBoYXZlIGF0IGxlYXN0IG9uZSBsYXllciBpbiBjb21tb24gb3Igbm90LgogICAqLwogIHRlc3QodCkgewogICAgcmV0dXJuICh0aGlzLm1hc2sgJiB0Lm1hc2spICE9PSAwOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gbGF5ZXIgaXMgZW5hYmxlZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsYXllciAtIFRoZSBsYXllciB0byB0ZXN0LgogICAqIEByZXR1cm4ge2Jvb2xlYW4gfSBXaGV0aGVyIHRoZSBnaXZlbiBsYXllciBpcyBlbmFibGVkIG9yIG5vdC4KICAgKi8KICBpc0VuYWJsZWQodCkgewogICAgcmV0dXJuICh0aGlzLm1hc2sgJiAoMSA8PCB0IHwgMCkpICE9PSAwOwogIH0KfQpsZXQgQUMgPSAwOwpjb25zdCBjMCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRmUoKSwgdGEgPSAvKiBAX19QVVJFX18gKi8gbmV3ICRvKCksIFduID0gLyogQF9fUFVSRV9fICovIG5ldyBlcygpLCBnaCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRmUoKSwgaW8gPSAvKiBAX19QVVJFX18gKi8gbmV3IEZlKCksIEVDID0gLyogQF9fUFVSRV9fICovIG5ldyBGZSgpLCBUQyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgJG8oKSwgdTAgPSAvKiBAX19QVVJFX18gKi8gbmV3IEZlKDEsIDAsIDApLCBkMCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRmUoMCwgMSwgMCksIHAwID0gLyogQF9fUFVSRV9fICovIG5ldyBGZSgwLCAwLCAxKSwgZjAgPSB7IHR5cGU6ICJhZGRlZCIgfSwgQ0MgPSB7IHR5cGU6ICJyZW1vdmVkIiB9LCBlYSA9IHsgdHlwZTogImNoaWxkYWRkZWQiLCBjaGlsZDogbnVsbCB9LCBIZCA9IHsgdHlwZTogImNoaWxkcmVtb3ZlZCIsIGNoaWxkOiBudWxsIH07CmNsYXNzIEVzIGV4dGVuZHMgdHggewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgM0Qgb2JqZWN0LgogICAqLwogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc09iamVjdDNEID0gITAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAiaWQiLCB7IHZhbHVlOiBBQysrIH0pLCB0aGlzLnV1aWQgPSBNZigpLCB0aGlzLm5hbWUgPSAiIiwgdGhpcy50eXBlID0gIk9iamVjdDNEIiwgdGhpcy5wYXJlbnQgPSBudWxsLCB0aGlzLmNoaWxkcmVuID0gW10sIHRoaXMudXAgPSBFcy5ERUZBVUxUX1VQLmNsb25lKCk7CiAgICBjb25zdCB0ID0gbmV3IEZlKCksIGUgPSBuZXcgZnUoKSwgaSA9IG5ldyAkbygpLCBuID0gbmV3IEZlKDEsIDEsIDEpOwogICAgZnVuY3Rpb24gcygpIHsKICAgICAgaS5zZXRGcm9tRXVsZXIoZSwgITEpOwogICAgfQogICAgZnVuY3Rpb24gcigpIHsKICAgICAgZS5zZXRGcm9tUXVhdGVybmlvbihpLCB2b2lkIDAsICExKTsKICAgIH0KICAgIGUuX29uQ2hhbmdlKHMpLCBpLl9vbkNoYW5nZShyKSwgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGhpcywgewogICAgICAvKioKICAgICAgICogUmVwcmVzZW50cyB0aGUgb2JqZWN0J3MgbG9jYWwgcG9zaXRpb24uCiAgICAgICAqCiAgICAgICAqIEBuYW1lIE9iamVjdDNEI3Bvc2l0aW9uCiAgICAgICAqIEB0eXBlIHtWZWN0b3IzfQogICAgICAgKiBAZGVmYXVsdCAoMCwwLDApCiAgICAgICAqLwogICAgICBwb3NpdGlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IHQKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFJlcHJlc2VudHMgdGhlIG9iamVjdCdzIGxvY2FsIHJvdGF0aW9uIGFzIEV1bGVyIGFuZ2xlcywgaW4gcmFkaWFucy4KICAgICAgICoKICAgICAgICogQG5hbWUgT2JqZWN0M0Qjcm90YXRpb24KICAgICAgICogQHR5cGUge0V1bGVyfQogICAgICAgKiBAZGVmYXVsdCAoMCwwLDApCiAgICAgICAqLwogICAgICByb3RhdGlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IGUKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFJlcHJlc2VudHMgdGhlIG9iamVjdCdzIGxvY2FsIHJvdGF0aW9uIGFzIFF1YXRlcm5pb25zLgogICAgICAgKgogICAgICAgKiBAbmFtZSBPYmplY3QzRCNxdWF0ZXJuaW9uCiAgICAgICAqIEB0eXBlIHtRdWF0ZXJuaW9ufQogICAgICAgKi8KICAgICAgcXVhdGVybmlvbjogewogICAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgdmFsdWU6IGkKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFJlcHJlc2VudHMgdGhlIG9iamVjdCdzIGxvY2FsIHNjYWxlLgogICAgICAgKgogICAgICAgKiBAbmFtZSBPYmplY3QzRCNzY2FsZQogICAgICAgKiBAdHlwZSB7VmVjdG9yM30KICAgICAgICogQGRlZmF1bHQgKDEsMSwxKQogICAgICAgKi8KICAgICAgc2NhbGU6IHsKICAgICAgICBjb25maWd1cmFibGU6ICEwLAogICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgIHZhbHVlOiBuCiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBSZXByZXNlbnRzIHRoZSBvYmplY3QncyBtb2RlbC12aWV3IG1hdHJpeC4KICAgICAgICoKICAgICAgICogQG5hbWUgT2JqZWN0M0QjbW9kZWxWaWV3TWF0cml4CiAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgKi8KICAgICAgbW9kZWxWaWV3TWF0cml4OiB7CiAgICAgICAgdmFsdWU6IG5ldyBlcygpCiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBSZXByZXNlbnRzIHRoZSBvYmplY3QncyBub3JtYWwgbWF0cml4LgogICAgICAgKgogICAgICAgKiBAbmFtZSBPYmplY3QzRCNub3JtYWxNYXRyaXgKICAgICAgICogQHR5cGUge01hdHJpeDN9CiAgICAgICAqLwogICAgICBub3JtYWxNYXRyaXg6IHsKICAgICAgICB2YWx1ZTogbmV3IF9yKCkKICAgICAgfQogICAgfSksIHRoaXMubWF0cml4ID0gbmV3IGVzKCksIHRoaXMubWF0cml4V29ybGQgPSBuZXcgZXMoKSwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gRXMuREVGQVVMVF9NQVRSSVhfQVVUT19VUERBVEUsIHRoaXMubWF0cml4V29ybGRBdXRvVXBkYXRlID0gRXMuREVGQVVMVF9NQVRSSVhfV09STERfQVVUT19VUERBVEUsIHRoaXMubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9ICExLCB0aGlzLmxheWVycyA9IG5ldyB3QygpLCB0aGlzLnZpc2libGUgPSAhMCwgdGhpcy5jYXN0U2hhZG93ID0gITEsIHRoaXMucmVjZWl2ZVNoYWRvdyA9ICExLCB0aGlzLmZydXN0dW1DdWxsZWQgPSAhMCwgdGhpcy5yZW5kZXJPcmRlciA9IDAsIHRoaXMuYW5pbWF0aW9ucyA9IFtdLCB0aGlzLmN1c3RvbURlcHRoTWF0ZXJpYWwgPSB2b2lkIDAsIHRoaXMuY3VzdG9tRGlzdGFuY2VNYXRlcmlhbCA9IHZvaWQgMCwgdGhpcy51c2VyRGF0YSA9IHt9OwogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgM0Qgb2JqZWN0IGlzIHJlbmRlcmVkIHRvIGEgc2hhZG93IG1hcC4KICAgKgogICAqIEBwYXJhbSB7UmVuZGVyZXJ8V2ViR0xSZW5kZXJlcn0gcmVuZGVyZXIgLSBUaGUgcmVuZGVyZXIuCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdC4KICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYSB0aGF0IGlzIHVzZWQgdG8gcmVuZGVyIHRoZSBzY2VuZS4KICAgKiBAcGFyYW0ge0NhbWVyYX0gc2hhZG93Q2FtZXJhIC0gVGhlIHNoYWRvdyBjYW1lcmEuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbH0gZGVwdGhNYXRlcmlhbCAtIFRoZSBkZXB0aCBtYXRlcmlhbC4KICAgKiBAcGFyYW0ge09iamVjdH0gZ3JvdXAgLSBUaGUgZ2VvbWV0cnkgZ3JvdXAgZGF0YS4KICAgKi8KICBvbkJlZm9yZVNoYWRvdygpIHsKICB9CiAgLyoqCiAgICogQSBjYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIGltbWVkaWF0ZWx5IGFmdGVyIGEgM0Qgb2JqZWN0IGlzIHJlbmRlcmVkIHRvIGEgc2hhZG93IG1hcC4KICAgKgogICAqIEBwYXJhbSB7UmVuZGVyZXJ8V2ViR0xSZW5kZXJlcn0gcmVuZGVyZXIgLSBUaGUgcmVuZGVyZXIuCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdC4KICAgKiBAcGFyYW0ge0NhbWVyYX0gY2FtZXJhIC0gVGhlIGNhbWVyYSB0aGF0IGlzIHVzZWQgdG8gcmVuZGVyIHRoZSBzY2VuZS4KICAgKiBAcGFyYW0ge0NhbWVyYX0gc2hhZG93Q2FtZXJhIC0gVGhlIHNoYWRvdyBjYW1lcmEuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbH0gZGVwdGhNYXRlcmlhbCAtIFRoZSBkZXB0aCBtYXRlcmlhbC4KICAgKiBAcGFyYW0ge09iamVjdH0gZ3JvdXAgLSBUaGUgZ2VvbWV0cnkgZ3JvdXAgZGF0YS4KICAgKi8KICBvbkFmdGVyU2hhZG93KCkgewogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkgYmVmb3JlIGEgM0Qgb2JqZWN0IGlzIHJlbmRlcmVkLgogICAqCiAgICogQHBhcmFtIHtSZW5kZXJlcnxXZWJHTFJlbmRlcmVyfSByZW5kZXJlciAtIFRoZSByZW5kZXJlci4KICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgM0Qgb2JqZWN0LgogICAqIEBwYXJhbSB7Q2FtZXJhfSBjYW1lcmEgLSBUaGUgY2FtZXJhIHRoYXQgaXMgdXNlZCB0byByZW5kZXIgdGhlIHNjZW5lLgogICAqIEBwYXJhbSB7QnVmZmVyR2VvbWV0cnl9IGdlb21ldHJ5IC0gVGhlIDNEIG9iamVjdCdzIGdlb21ldHJ5LgogICAqIEBwYXJhbSB7TWF0ZXJpYWx9IG1hdGVyaWFsIC0gVGhlIDNEIG9iamVjdCdzIG1hdGVyaWFsLgogICAqIEBwYXJhbSB7T2JqZWN0fSBncm91cCAtIFRoZSBnZW9tZXRyeSBncm91cCBkYXRhLgogICAqLwogIG9uQmVmb3JlUmVuZGVyKCkgewogIH0KICAvKioKICAgKiBBIGNhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgYSAzRCBvYmplY3QgaXMgcmVuZGVyZWQuCiAgICoKICAgKiBAcGFyYW0ge1JlbmRlcmVyfFdlYkdMUmVuZGVyZXJ9IHJlbmRlcmVyIC0gVGhlIHJlbmRlcmVyLgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QuCiAgICogQHBhcmFtIHtDYW1lcmF9IGNhbWVyYSAtIFRoZSBjYW1lcmEgdGhhdCBpcyB1c2VkIHRvIHJlbmRlciB0aGUgc2NlbmUuCiAgICogQHBhcmFtIHtCdWZmZXJHZW9tZXRyeX0gZ2VvbWV0cnkgLSBUaGUgM0Qgb2JqZWN0J3MgZ2VvbWV0cnkuCiAgICogQHBhcmFtIHtNYXRlcmlhbH0gbWF0ZXJpYWwgLSBUaGUgM0Qgb2JqZWN0J3MgbWF0ZXJpYWwuCiAgICogQHBhcmFtIHtPYmplY3R9IGdyb3VwIC0gVGhlIGdlb21ldHJ5IGdyb3VwIGRhdGEuCiAgICovCiAgb25BZnRlclJlbmRlcigpIHsKICB9CiAgLyoqCiAgICogQXBwbGllcyB0aGUgZ2l2ZW4gdHJhbnNmb3JtYXRpb24gbWF0cml4IHRvIHRoZSBvYmplY3QgYW5kIHVwZGF0ZXMgdGhlIG9iamVjdCdzIHBvc2l0aW9uLAogICAqIHJvdGF0aW9uIGFuZCBzY2FsZS4KICAgKgogICAqIEBwYXJhbSB7TWF0cml4NH0gbWF0cml4IC0gVGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeC4KICAgKi8KICBhcHBseU1hdHJpeDQodCkgewogICAgdGhpcy5tYXRyaXhBdXRvVXBkYXRlICYmIHRoaXMudXBkYXRlTWF0cml4KCksIHRoaXMubWF0cml4LnByZW11bHRpcGx5KHQpLCB0aGlzLm1hdHJpeC5kZWNvbXBvc2UodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCB0aGlzLnNjYWxlKTsKICB9CiAgLyoqCiAgICogQXBwbGllcyBhIHJvdGF0aW9uIHJlcHJlc2VudGVkIGJ5IGdpdmVuIHRoZSBxdWF0ZXJuaW9uIHRvIHRoZSAzRCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHEgLSBUaGUgcXVhdGVybmlvbi4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhcHBseVF1YXRlcm5pb24odCkgewogICAgcmV0dXJuIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseSh0KSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gcm90YXRpb24gcmVwcmVzZW50ZWQgYXMgYW4gYXhpcy9hbmdsZSBjb3VwbGUgdG8gdGhlIDNEIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSAobm9ybWFsaXplZCkgYXhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICovCiAgc2V0Um90YXRpb25Gcm9tQXhpc0FuZ2xlKHQsIGUpIHsKICAgIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKHQsIGUpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBnaXZlbiByb3RhdGlvbiByZXByZXNlbnRlZCBhcyBFdWxlciBhbmdsZXMgdG8gdGhlIDNEIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7RXVsZXJ9IGV1bGVyIC0gVGhlIEV1bGVyIGFuZ2xlcy4KICAgKi8KICBzZXRSb3RhdGlvbkZyb21FdWxlcih0KSB7CiAgICB0aGlzLnF1YXRlcm5pb24uc2V0RnJvbUV1bGVyKHQsICEwKTsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgZ2l2ZW4gcm90YXRpb24gcmVwcmVzZW50ZWQgYXMgcm90YXRpb24gbWF0cml4IHRvIHRoZSAzRCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDR9IG0gLSBBbHRob3VnaCBhIDR4NCBtYXRyaXggaXMgZXhwZWN0ZWQsIHRoZSB1cHBlciAzeDMgcG9ydGlvbiBtdXN0IGJlCiAgICogYSBwdXJlIHJvdGF0aW9uIG1hdHJpeCAoaS5lLCB1bnNjYWxlZCkuCiAgICovCiAgc2V0Um90YXRpb25Gcm9tTWF0cml4KHQpIHsKICAgIHRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgodCk7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGdpdmVuIHJvdGF0aW9uIHJlcHJlc2VudGVkIGFzIGEgUXVhdGVybmlvbiB0byB0aGUgM0Qgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtRdWF0ZXJuaW9ufSBxIC0gVGhlIFF1YXRlcm5pb24KICAgKi8KICBzZXRSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKHQpIHsKICAgIHRoaXMucXVhdGVybmlvbi5jb3B5KHQpOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSAzRCBvYmplY3QgYWxvbmcgYW4gYXhpcyBpbiBsb2NhbCBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSAobm9ybWFsaXplZCkgYXhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlT25BeGlzKHQsIGUpIHsKICAgIHJldHVybiB0YS5zZXRGcm9tQXhpc0FuZ2xlKHQsIGUpLCB0aGlzLnF1YXRlcm5pb24ubXVsdGlwbHkodGEpLCB0aGlzOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSAzRCBvYmplY3QgYWxvbmcgYW4gYXhpcyBpbiB3b3JsZCBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7VmVjdG9yM30gYXhpcyAtIFRoZSAobm9ybWFsaXplZCkgYXhpcyB2ZWN0b3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlT25Xb3JsZEF4aXModCwgZSkgewogICAgcmV0dXJuIHRhLnNldEZyb21BeGlzQW5nbGUodCwgZSksIHRoaXMucXVhdGVybmlvbi5wcmVtdWx0aXBseSh0YSksIHRoaXM7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhlIDNEIG9iamVjdCBhcm91bmQgaXRzIFggYXhpcyBpbiBsb2NhbCBzcGFjZS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHJvdGF0ZVgodCkgewogICAgcmV0dXJuIHRoaXMucm90YXRlT25BeGlzKHUwLCB0KTsKICB9CiAgLyoqCiAgICogUm90YXRlcyB0aGUgM0Qgb2JqZWN0IGFyb3VuZCBpdHMgWSBheGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgcm90YXRlWSh0KSB7CiAgICByZXR1cm4gdGhpcy5yb3RhdGVPbkF4aXMoZDAsIHQpOwogIH0KICAvKioKICAgKiBSb3RhdGVzIHRoZSAzRCBvYmplY3QgYXJvdW5kIGl0cyBaIGF4aXMgaW4gbG9jYWwgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICByb3RhdGVaKHQpIHsKICAgIHJldHVybiB0aGlzLnJvdGF0ZU9uQXhpcyhwMCwgdCk7CiAgfQogIC8qKgogICAqIFRyYW5zbGF0ZSB0aGUgM0Qgb2JqZWN0IGJ5IGEgZGlzdGFuY2UgYWxvbmcgdGhlIGdpdmVuIGF4aXMgaW4gbG9jYWwgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IGF4aXMgLSBUaGUgKG5vcm1hbGl6ZWQpIGF4aXMgdmVjdG9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBkaXN0YW5jZSAtIFRoZSBkaXN0YW5jZSBpbiB3b3JsZCB1bml0cy4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICB0cmFuc2xhdGVPbkF4aXModCwgZSkgewogICAgcmV0dXJuIGMwLmNvcHkodCkuYXBwbHlRdWF0ZXJuaW9uKHRoaXMucXVhdGVybmlvbiksIHRoaXMucG9zaXRpb24uYWRkKGMwLm11bHRpcGx5U2NhbGFyKGUpKSwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlIHRoZSAzRCBvYmplY3QgYnkgYSBkaXN0YW5jZSBhbG9uZyBpdHMgWC1heGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGluIHdvcmxkIHVuaXRzLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zbGF0ZVgodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKHUwLCB0KTsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlIHRoZSAzRCBvYmplY3QgYnkgYSBkaXN0YW5jZSBhbG9uZyBpdHMgWS1heGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGluIHdvcmxkIHVuaXRzLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zbGF0ZVkodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKGQwLCB0KTsKICB9CiAgLyoqCiAgICogVHJhbnNsYXRlIHRoZSAzRCBvYmplY3QgYnkgYSBkaXN0YW5jZSBhbG9uZyBpdHMgWi1heGlzIGluIGxvY2FsIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGluIHdvcmxkIHVuaXRzLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHRyYW5zbGF0ZVoodCkgewogICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKHAwLCB0KTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIHZlY3RvciBmcm9tIHRoaXMgM0Qgb2JqZWN0J3MgbG9jYWwgc3BhY2UgdG8gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHZlY3RvciAtIFRoZSB2ZWN0b3IgdG8gY29udmVydC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY29udmVydGVkIHZlY3Rvci4KICAgKi8KICBsb2NhbFRvV29ybGQodCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdC5hcHBseU1hdHJpeDQodGhpcy5tYXRyaXhXb3JsZCk7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIHRoZSBnaXZlbiB2ZWN0b3IgZnJvbSB0aGlzIDNEIG9iamVjdCdzIHdvcmQgc3BhY2UgdG8gbG9jYWwgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHZlY3RvciAtIFRoZSB2ZWN0b3IgdG8gY29udmVydC4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgY29udmVydGVkIHZlY3Rvci4KICAgKi8KICB3b3JsZFRvTG9jYWwodCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgdC5hcHBseU1hdHJpeDQoV24uY29weSh0aGlzLm1hdHJpeFdvcmxkKS5pbnZlcnQoKSk7CiAgfQogIC8qKgogICAqIFJvdGF0ZXMgdGhlIG9iamVjdCB0byBmYWNlIGEgcG9pbnQgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCBzdXBwb3J0IG9iamVjdHMgaGF2aW5nIG5vbi11bmlmb3JtbHktc2NhbGVkIHBhcmVudChzKS4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfFZlY3RvcjN9IHggLSBUaGUgeCBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlLiBBbHRlcm5hdGl2ZWx5LCBhIHZlY3RvciByZXByZXNlbnRpbmcgYSBwb3NpdGlvbiBpbiB3b3JsZCBzcGFjZQogICAqIEBwYXJhbSB7bnVtYmVyfSBbeV0gLSBUaGUgeSBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbel0gLSBUaGUgeiBjb29yZGluYXRlIGluIHdvcmxkIHNwYWNlLgogICAqLwogIGxvb2tBdCh0LCBlLCBpKSB7CiAgICB0LmlzVmVjdG9yMyA/IGdoLmNvcHkodCkgOiBnaC5zZXQodCwgZSwgaSk7CiAgICBjb25zdCBuID0gdGhpcy5wYXJlbnQ7CiAgICB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIGlvLnNldEZyb21NYXRyaXhQb3NpdGlvbih0aGlzLm1hdHJpeFdvcmxkKSwgdGhpcy5pc0NhbWVyYSB8fCB0aGlzLmlzTGlnaHQgPyBXbi5sb29rQXQoaW8sIGdoLCB0aGlzLnVwKSA6IFduLmxvb2tBdChnaCwgaW8sIHRoaXMudXApLCB0aGlzLnF1YXRlcm5pb24uc2V0RnJvbVJvdGF0aW9uTWF0cml4KFduKSwgbiAmJiAoV24uZXh0cmFjdFJvdGF0aW9uKG4ubWF0cml4V29ybGQpLCB0YS5zZXRGcm9tUm90YXRpb25NYXRyaXgoV24pLCB0aGlzLnF1YXRlcm5pb24ucHJlbXVsdGlwbHkodGEuaW52ZXJ0KCkpKTsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gM0Qgb2JqZWN0IGFzIGEgY2hpbGQgdG8gdGhpcyAzRCBvYmplY3QuIEFuIGFyYml0cmFyeSBudW1iZXIgb2YKICAgKiBvYmplY3RzIG1heSBiZSBhZGRlZC4gQW55IGN1cnJlbnQgcGFyZW50IG9uIGFuIG9iamVjdCBwYXNzZWQgaW4gaGVyZSB3aWxsIGJlCiAgICogcmVtb3ZlZCwgc2luY2UgYW4gb2JqZWN0IGNhbiBoYXZlIGF0IG1vc3Qgb25lIHBhcmVudC4KICAgKgogICAqIEBmaXJlcyBPYmplY3QzRCNhZGRlZAogICAqIEBmaXJlcyBPYmplY3QzRCNjaGlsZGFkZGVkCiAgICogQHBhcmFtIHtPYmplY3QzRH0gb2JqZWN0IC0gVGhlIDNEIG9iamVjdCB0byBhZGQuCiAgICogQHJldHVybiB7T2JqZWN0M0R9IEEgcmVmZXJlbmNlIHRvIHRoaXMgaW5zdGFuY2UuCiAgICovCiAgYWRkKHQpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICBmb3IgKGxldCBlID0gMDsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykKICAgICAgICB0aGlzLmFkZChhcmd1bWVudHNbZV0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHJldHVybiB0ID09PSB0aGlzID8gKGNvbnNvbGUuZXJyb3IoIlRIUkVFLk9iamVjdDNELmFkZDogb2JqZWN0IGNhbid0IGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgaXRzZWxmLiIsIHQpLCB0aGlzKSA6ICh0ICYmIHQuaXNPYmplY3QzRCA/ICh0LnJlbW92ZUZyb21QYXJlbnQoKSwgdC5wYXJlbnQgPSB0aGlzLCB0aGlzLmNoaWxkcmVuLnB1c2godCksIHQuZGlzcGF0Y2hFdmVudChmMCksIGVhLmNoaWxkID0gdCwgdGhpcy5kaXNwYXRjaEV2ZW50KGVhKSwgZWEuY2hpbGQgPSBudWxsKSA6IGNvbnNvbGUuZXJyb3IoIlRIUkVFLk9iamVjdDNELmFkZDogb2JqZWN0IG5vdCBhbiBpbnN0YW5jZSBvZiBUSFJFRS5PYmplY3QzRC4iLCB0KSwgdGhpcyk7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgdGhlIGdpdmVuIDNEIG9iamVjdCBhcyBjaGlsZCBmcm9tIHRoaXMgM0Qgb2JqZWN0LgogICAqIEFuIGFyYml0cmFyeSBudW1iZXIgb2Ygb2JqZWN0cyBtYXkgYmUgcmVtb3ZlZC4KICAgKgogICAqIEBmaXJlcyBPYmplY3QzRCNyZW1vdmVkCiAgICogQGZpcmVzIE9iamVjdDNEI2NoaWxkcmVtb3ZlZAogICAqIEBwYXJhbSB7T2JqZWN0M0R9IG9iamVjdCAtIFRoZSAzRCBvYmplY3QgdG8gcmVtb3ZlLgogICAqIEByZXR1cm4ge09iamVjdDNEfSBBIHJlZmVyZW5jZSB0byB0aGlzIGluc3RhbmNlLgogICAqLwogIHJlbW92ZSh0KSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspCiAgICAgICAgdGhpcy5yZW1vdmUoYXJndW1lbnRzW2ldKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBlID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKHQpOwogICAgcmV0dXJuIGUgIT09IC0xICYmICh0LnBhcmVudCA9IG51bGwsIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGUsIDEpLCB0LmRpc3BhdGNoRXZlbnQoQ0MpLCBIZC5jaGlsZCA9IHQsIHRoaXMuZGlzcGF0Y2hFdmVudChIZCksIEhkLmNoaWxkID0gbnVsbCksIHRoaXM7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgdGhpcyAzRCBvYmplY3QgZnJvbSBpdHMgY3VycmVudCBwYXJlbnQuCiAgICoKICAgKiBAZmlyZXMgT2JqZWN0M0QjcmVtb3ZlZAogICAqIEBmaXJlcyBPYmplY3QzRCNjaGlsZHJlbW92ZWQKICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICByZW1vdmVGcm9tUGFyZW50KCkgewogICAgY29uc3QgdCA9IHRoaXMucGFyZW50OwogICAgcmV0dXJuIHQgIT09IG51bGwgJiYgdC5yZW1vdmUodGhpcyksIHRoaXM7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYWxsIGNoaWxkIG9iamVjdHMuCiAgICoKICAgKiBAZmlyZXMgT2JqZWN0M0QjcmVtb3ZlZAogICAqIEBmaXJlcyBPYmplY3QzRCNjaGlsZHJlbW92ZWQKICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjbGVhcigpIHsKICAgIHJldHVybiB0aGlzLnJlbW92ZSguLi50aGlzLmNoaWxkcmVuKTsKICB9CiAgLyoqCiAgICogQWRkcyB0aGUgZ2l2ZW4gM0Qgb2JqZWN0IGFzIGEgY2hpbGQgb2YgdGhpcyAzRCBvYmplY3QsIHdoaWxlIG1haW50YWluaW5nIHRoZSBvYmplY3QncyB3b3JsZAogICAqIHRyYW5zZm9ybS4gVGhpcyBtZXRob2QgZG9lcyBub3Qgc3VwcG9ydCBzY2VuZSBncmFwaHMgaGF2aW5nIG5vbi11bmlmb3JtbHktc2NhbGVkIG5vZGVzKHMpLgogICAqCiAgICogQGZpcmVzIE9iamVjdDNEI2FkZGVkCiAgICogQGZpcmVzIE9iamVjdDNEI2NoaWxkYWRkZWQKICAgKiBAcGFyYW0ge09iamVjdDNEfSBvYmplY3QgLSBUaGUgM0Qgb2JqZWN0IHRvIGF0dGFjaC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBhdHRhY2godCkgewogICAgcmV0dXJuIHRoaXMudXBkYXRlV29ybGRNYXRyaXgoITAsICExKSwgV24uY29weSh0aGlzLm1hdHJpeFdvcmxkKS5pbnZlcnQoKSwgdC5wYXJlbnQgIT09IG51bGwgJiYgKHQucGFyZW50LnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIFduLm11bHRpcGx5KHQucGFyZW50Lm1hdHJpeFdvcmxkKSksIHQuYXBwbHlNYXRyaXg0KFduKSwgdC5yZW1vdmVGcm9tUGFyZW50KCksIHQucGFyZW50ID0gdGhpcywgdGhpcy5jaGlsZHJlbi5wdXNoKHQpLCB0LnVwZGF0ZVdvcmxkTWF0cml4KCExLCAhMCksIHQuZGlzcGF0Y2hFdmVudChmMCksIGVhLmNoaWxkID0gdCwgdGhpcy5kaXNwYXRjaEV2ZW50KGVhKSwgZWEuY2hpbGQgPSBudWxsLCB0aGlzOwogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSAzRCBvYmplY3QgYW5kIGl0cyBjaGlsZHJlbiwgc3RhcnRpbmcgd2l0aCB0aGUgM0Qgb2JqZWN0CiAgICogaXRzZWxmLCBhbmQgcmV0dXJucyB0aGUgZmlyc3Qgd2l0aCBhIG1hdGNoaW5nIElELgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGlkIC0gVGhlIGlkLgogICAqIEByZXR1cm4ge09iamVjdDNEfHVuZGVmaW5lZH0gVGhlIGZvdW5kIDNEIG9iamVjdC4gUmV0dXJucyBgdW5kZWZpbmVkYCBpZiBubyAzRCBvYmplY3QgaGFzIGJlZW4gZm91bmQuCiAgICovCiAgZ2V0T2JqZWN0QnlJZCh0KSB7CiAgICByZXR1cm4gdGhpcy5nZXRPYmplY3RCeVByb3BlcnR5KCJpZCIsIHQpOwogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSAzRCBvYmplY3QgYW5kIGl0cyBjaGlsZHJlbiwgc3RhcnRpbmcgd2l0aCB0aGUgM0Qgb2JqZWN0CiAgICogaXRzZWxmLCBhbmQgcmV0dXJucyB0aGUgZmlyc3Qgd2l0aCBhIG1hdGNoaW5nIG5hbWUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lLgogICAqIEByZXR1cm4ge09iamVjdDNEfHVuZGVmaW5lZH0gVGhlIGZvdW5kIDNEIG9iamVjdC4gUmV0dXJucyBgdW5kZWZpbmVkYCBpZiBubyAzRCBvYmplY3QgaGFzIGJlZW4gZm91bmQuCiAgICovCiAgZ2V0T2JqZWN0QnlOYW1lKHQpIHsKICAgIHJldHVybiB0aGlzLmdldE9iamVjdEJ5UHJvcGVydHkoIm5hbWUiLCB0KTsKICB9CiAgLyoqCiAgICogU2VhcmNoZXMgdGhyb3VnaCB0aGUgM0Qgb2JqZWN0IGFuZCBpdHMgY2hpbGRyZW4sIHN0YXJ0aW5nIHdpdGggdGhlIDNEIG9iamVjdAogICAqIGl0c2VsZiwgYW5kIHJldHVybnMgdGhlIGZpcnN0IHdpdGggYSBtYXRjaGluZyBwcm9wZXJ0eSB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5LgogICAqIEBwYXJhbSB7YW55fSB2YWx1ZSAtIFRoZSB2YWx1ZS4KICAgKiBAcmV0dXJuIHtPYmplY3QzRHx1bmRlZmluZWR9IFRoZSBmb3VuZCAzRCBvYmplY3QuIFJldHVybnMgYHVuZGVmaW5lZGAgaWYgbm8gM0Qgb2JqZWN0IGhhcyBiZWVuIGZvdW5kLgogICAqLwogIGdldE9iamVjdEJ5UHJvcGVydHkodCwgZSkgewogICAgaWYgKHRoaXNbdF0gPT09IGUpIHJldHVybiB0aGlzOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBjb25zdCByID0gdGhpcy5jaGlsZHJlbltpXS5nZXRPYmplY3RCeVByb3BlcnR5KHQsIGUpOwogICAgICBpZiAociAhPT0gdm9pZCAwKQogICAgICAgIHJldHVybiByOwogICAgfQogIH0KICAvKioKICAgKiBTZWFyY2hlcyB0aHJvdWdoIHRoZSAzRCBvYmplY3QgYW5kIGl0cyBjaGlsZHJlbiwgc3RhcnRpbmcgd2l0aCB0aGUgM0Qgb2JqZWN0CiAgICogaXRzZWxmLCBhbmQgcmV0dXJucyBhbGwgM0Qgb2JqZWN0cyB3aXRoIGEgbWF0Y2hpbmcgcHJvcGVydHkgdmFsdWUuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eS4KICAgKiBAcGFyYW0ge2FueX0gdmFsdWUgLSBUaGUgdmFsdWUuCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3QzRD59IHJlc3VsdCAtIFRoZSBtZXRob2Qgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxPYmplY3QzRD59IFRoZSBmb3VuZCAzRCBvYmplY3RzLgogICAqLwogIGdldE9iamVjdHNCeVByb3BlcnR5KHQsIGUsIGkgPSBbXSkgewogICAgdGhpc1t0XSA9PT0gZSAmJiBpLnB1c2godGhpcyk7CiAgICBjb25zdCBuID0gdGhpcy5jaGlsZHJlbjsKICAgIGZvciAobGV0IHMgPSAwLCByID0gbi5sZW5ndGg7IHMgPCByOyBzKyspCiAgICAgIG5bc10uZ2V0T2JqZWN0c0J5UHJvcGVydHkodCwgZSwgaSk7CiAgICByZXR1cm4gaTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBhIHZlY3RvciByZXByZXNlbnRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSAzRCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgc3RvcmVkIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSAzRCBvYmplY3QncyBwb3NpdGlvbiBpbiB3b3JsZCBzcGFjZS4KICAgKi8KICBnZXRXb3JsZFBvc2l0aW9uKHQpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHQuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKHRoaXMubWF0cml4V29ybGQpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgUXVhdGVybmlvbiByZXByZXNlbnRpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSAzRCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1F1YXRlcm5pb259IHRhcmdldCAtIFRoZSB0YXJnZXQgUXVhdGVybmlvbiB0aGUgcmVzdWx0IGlzIHN0b3JlZCB0by4KICAgKiBAcmV0dXJuIHtRdWF0ZXJuaW9ufSBUaGUgM0Qgb2JqZWN0J3Mgcm90YXRpb24gaW4gd29ybGQgc3BhY2UuCiAgICovCiAgZ2V0V29ybGRRdWF0ZXJuaW9uKHQpIHsKICAgIHJldHVybiB0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCEwLCAhMSksIHRoaXMubWF0cml4V29ybGQuZGVjb21wb3NlKGlvLCB0LCBFQyksIHQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgYSB2ZWN0b3IgcmVwcmVzZW50aW5nIHRoZSBzY2FsZSBvZiB0aGUgM0Qgb2JqZWN0IGluIHdvcmxkIHNwYWNlLgogICAqCiAgICogQHBhcmFtIHtWZWN0b3IzfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IHZlY3RvciB0aGUgcmVzdWx0IGlzIHN0b3JlZCB0by4KICAgKiBAcmV0dXJuIHtWZWN0b3IzfSBUaGUgM0Qgb2JqZWN0J3Mgc2NhbGUgaW4gd29ybGQgc3BhY2UuCiAgICovCiAgZ2V0V29ybGRTY2FsZSh0KSB7CiAgICByZXR1cm4gdGhpcy51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0aGlzLm1hdHJpeFdvcmxkLmRlY29tcG9zZShpbywgVEMsIHQpLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgdmVjdG9yIHJlcHJlc2VudGluZyB0aGUgKCJsb29rIikgZGlyZWN0aW9uIG9mIHRoZSAzRCBvYmplY3QgaW4gd29ybGQgc3BhY2UuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHRhcmdldCAtIFRoZSB0YXJnZXQgdmVjdG9yIHRoZSByZXN1bHQgaXMgc3RvcmVkIHRvLgogICAqIEByZXR1cm4ge1ZlY3RvcjN9IFRoZSAzRCBvYmplY3QncyBkaXJlY3Rpb24gaW4gd29ybGQgc3BhY2UuCiAgICovCiAgZ2V0V29ybGREaXJlY3Rpb24odCkgewogICAgdGhpcy51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpOwogICAgY29uc3QgZSA9IHRoaXMubWF0cml4V29ybGQuZWxlbWVudHM7CiAgICByZXR1cm4gdC5zZXQoZVs4XSwgZVs5XSwgZVsxMF0pLm5vcm1hbGl6ZSgpOwogIH0KICAvKioKICAgKiBBYnN0cmFjdCBtZXRob2QgdG8gZ2V0IGludGVyc2VjdGlvbnMgYmV0d2VlbiBhIGNhc3RlZCByYXkgYW5kIHRoaXMKICAgKiAzRCBvYmplY3QuIFJlbmRlcmFibGUgM0Qgb2JqZWN0cyBzdWNoIGFzIHtAbGluayBNZXNofSwge0BsaW5rIExpbmV9IG9yIHtAbGluayBQb2ludHN9CiAgICogaW1wbGVtZW50IHRoaXMgbWV0aG9kIGluIG9yZGVyIHRvIHVzZSByYXljYXN0aW5nLgogICAqCiAgICogQGFic3RyYWN0CiAgICogQHBhcmFtIHtSYXljYXN0ZXJ9IHJheWNhc3RlciAtIFRoZSByYXljYXN0ZXIuCiAgICogQHBhcmFtIHtBcnJheTxPYmplY3Q+fSBpbnRlcnNlY3RzIC0gQW4gYXJyYXkgaG9sZGluZyB0aGUgcmVzdWx0IG9mIHRoZSBtZXRob2QuCiAgICovCiAgcmF5Y2FzdCgpIHsKICB9CiAgLyoqCiAgICogRXhlY3V0ZXMgdGhlIGNhbGxiYWNrIG9uIHRoaXMgM0Qgb2JqZWN0IGFuZCBhbGwgZGVzY2VuZGFudHMuCiAgICoKICAgKiBOb3RlOiBNb2RpZnlpbmcgdGhlIHNjZW5lIGdyYXBoIGluc2lkZSB0aGUgY2FsbGJhY2sgaXMgZGlzY291cmFnZWQuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBhbGxvd3MgdG8gcHJvY2VzcyB0aGUgY3VycmVudCAzRCBvYmplY3QuCiAgICovCiAgdHJhdmVyc2UodCkgewogICAgdCh0aGlzKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS50cmF2ZXJzZSh0KTsKICB9CiAgLyoqCiAgICogTGlrZSB7QGxpbmsgT2JqZWN0M0QjdHJhdmVyc2V9LCBidXQgdGhlIGNhbGxiYWNrIHdpbGwgb25seSBiZSBleGVjdXRlZCBmb3IgdmlzaWJsZSAzRCBvYmplY3RzLgogICAqIERlc2NlbmRhbnRzIG9mIGludmlzaWJsZSAzRCBvYmplY3RzIGFyZSBub3QgdHJhdmVyc2VkLgogICAqCiAgICogTm90ZTogTW9kaWZ5aW5nIHRoZSBzY2VuZSBncmFwaCBpbnNpZGUgdGhlIGNhbGxiYWNrIGlzIGRpc2NvdXJhZ2VkLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgYWxsb3dzIHRvIHByb2Nlc3MgdGhlIGN1cnJlbnQgM0Qgb2JqZWN0LgogICAqLwogIHRyYXZlcnNlVmlzaWJsZSh0KSB7CiAgICBpZiAodGhpcy52aXNpYmxlID09PSAhMSkgcmV0dXJuOwogICAgdCh0aGlzKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS50cmF2ZXJzZVZpc2libGUodCk7CiAgfQogIC8qKgogICAqIExpa2Uge0BsaW5rIE9iamVjdDNEI3RyYXZlcnNlfSwgYnV0IHRoZSBjYWxsYmFjayB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgZm9yIGFsbCBhbmNlc3RvcnMuCiAgICoKICAgKiBOb3RlOiBNb2RpZnlpbmcgdGhlIHNjZW5lIGdyYXBoIGluc2lkZSB0aGUgY2FsbGJhY2sgaXMgZGlzY291cmFnZWQuCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIEEgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBhbGxvd3MgdG8gcHJvY2VzcyB0aGUgY3VycmVudCAzRCBvYmplY3QuCiAgICovCiAgdHJhdmVyc2VBbmNlc3RvcnModCkgewogICAgY29uc3QgZSA9IHRoaXMucGFyZW50OwogICAgZSAhPT0gbnVsbCAmJiAodChlKSwgZS50cmF2ZXJzZUFuY2VzdG9ycyh0KSk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCBpbiBsb2NhbCBzcGFjZSBieSBjb21wdXRpbmcgaXQgZnJvbSB0aGUgY3VycmVudAogICAqIHBvc2l0aW9uLCByb3RhdGlvbiBhbmQgc2NhbGUgdmFsdWVzLgogICAqLwogIHVwZGF0ZU1hdHJpeCgpIHsKICAgIHRoaXMubWF0cml4LmNvbXBvc2UodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCB0aGlzLnNjYWxlKSwgdGhpcy5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gITA7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHRyYW5zZm9ybWF0aW9uIG1hdHJpeCBpbiB3b3JsZCBzcGFjZSBvZiB0aGlzIDNEIG9iamVjdHMgYW5kIGl0cyBkZXNjZW5kYW50cy4KICAgKgogICAqIFRvIGVuc3VyZSBjb3JyZWN0IHJlc3VsdHMsIHRoaXMgbWV0aG9kIGFsc28gcmVjb21wdXRlcyB0aGUgM0Qgb2JqZWN0J3MgdHJhbnNmb3JtYXRpb24gbWF0cml4IGluCiAgICogbG9jYWwgc3BhY2UuIFRoZSBjb21wdXRhdGlvbiBvZiB0aGUgbG9jYWwgYW5kIHdvcmxkIG1hdHJpeCBjYW4gYmUgY29udHJvbGxlZCB3aXRoIHRoZQogICAqIHtAbGluayBPYmplY3QzRCNtYXRyaXhBdXRvVXBkYXRlfSBhbmQge0BsaW5rIE9iamVjdDNEI21hdHJpeFdvcmxkQXV0b1VwZGF0ZX0gZmxhZ3Mgd2hpY2ggYXJlIGJvdGgKICAgKiBgdHJ1ZWAgYnkgZGVmYXVsdC4gIFNldCB0aGVzZSBmbGFncyB0byBgZmFsc2VgIGlmIHlvdSBuZWVkIG1vcmUgY29udHJvbCBvdmVyIHRoZSB1cGRhdGUgbWF0cml4IHByb2Nlc3MuCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmb3JjZT1mYWxzZV0gLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGEgcmVjb21wdXRhdGlvbiBvZiB3b3JsZCBtYXRyaWNlcyBpcyBmb3JjZWQgZXZlbgogICAqIHdoZW4ge0BsaW5rIE9iamVjdDNEI21hdHJpeFdvcmxkQXV0b1VwZGF0ZX0gaXMgc2V0IHRvIGBmYWxzZWAuCiAgICovCiAgdXBkYXRlTWF0cml4V29ybGQodCkgewogICAgdGhpcy5tYXRyaXhBdXRvVXBkYXRlICYmIHRoaXMudXBkYXRlTWF0cml4KCksICh0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgfHwgdCkgJiYgKHRoaXMubWF0cml4V29ybGRBdXRvVXBkYXRlID09PSAhMCAmJiAodGhpcy5wYXJlbnQgPT09IG51bGwgPyB0aGlzLm1hdHJpeFdvcmxkLmNvcHkodGhpcy5tYXRyaXgpIDogdGhpcy5tYXRyaXhXb3JsZC5tdWx0aXBseU1hdHJpY2VzKHRoaXMucGFyZW50Lm1hdHJpeFdvcmxkLCB0aGlzLm1hdHJpeCkpLCB0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSAhMSwgdCA9ICEwKTsKICAgIGNvbnN0IGUgPSB0aGlzLmNoaWxkcmVuOwogICAgZm9yIChsZXQgaSA9IDAsIG4gPSBlLmxlbmd0aDsgaSA8IG47IGkrKykKICAgICAgZVtpXS51cGRhdGVNYXRyaXhXb3JsZCh0KTsKICB9CiAgLyoqCiAgICogQW4gYWx0ZXJuYXRpdmUgdmVyc2lvbiBvZiB7QGxpbmsgT2JqZWN0M0QjdXBkYXRlTWF0cml4V29ybGR9IHdpdGggbW9yZSBjb250cm9sIG92ZXIgdGhlCiAgICogdXBkYXRlIG9mIGFuY2VzdG9yIGFuZCBkZXNjZW5kYW50IG5vZGVzLgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBbdXBkYXRlUGFyZW50cz1mYWxzZV0gV2hldGhlciBhbmNlc3RvciBub2RlcyBzaG91bGQgYmUgdXBkYXRlZCBvciBub3QuCiAgICogQHBhcmFtIHtib29sZWFufSBbdXBkYXRlQ2hpbGRyZW49ZmFsc2VdIFdoZXRoZXIgZGVzY2VuZGFudCBub2RlcyBzaG91bGQgYmUgdXBkYXRlZCBvciBub3QuCiAgICovCiAgdXBkYXRlV29ybGRNYXRyaXgodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMucGFyZW50OwogICAgaWYgKHQgPT09ICEwICYmIGkgIT09IG51bGwgJiYgaS51cGRhdGVXb3JsZE1hdHJpeCghMCwgITEpLCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgJiYgdGhpcy51cGRhdGVNYXRyaXgoKSwgdGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09ICEwICYmICh0aGlzLnBhcmVudCA9PT0gbnVsbCA/IHRoaXMubWF0cml4V29ybGQuY29weSh0aGlzLm1hdHJpeCkgOiB0aGlzLm1hdHJpeFdvcmxkLm11bHRpcGx5TWF0cmljZXModGhpcy5wYXJlbnQubWF0cml4V29ybGQsIHRoaXMubWF0cml4KSksIGUgPT09ICEwKSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLmNoaWxkcmVuOwogICAgICBmb3IgKGxldCBzID0gMCwgciA9IG4ubGVuZ3RoOyBzIDwgcjsgcysrKQogICAgICAgIG5bc10udXBkYXRlV29ybGRNYXRyaXgoITEsICEwKTsKICAgIH0KICB9CiAgLyoqCiAgICogU2VyaWFsaXplcyB0aGUgM0Qgb2JqZWN0IGludG8gSlNPTi4KICAgKgogICAqIEBwYXJhbSB7PyhPYmplY3R8c3RyaW5nKX0gbWV0YSAtIEFuIG9wdGlvbmFsIHZhbHVlIGhvbGRpbmcgbWV0YSBpbmZvcm1hdGlvbiBhYm91dCB0aGUgc2VyaWFsaXphdGlvbi4KICAgKiBAcmV0dXJuIHtPYmplY3R9IEEgSlNPTiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzZXJpYWxpemVkIDNEIG9iamVjdC4KICAgKiBAc2VlIHtAbGluayBPYmplY3RMb2FkZXIjcGFyc2V9CiAgICovCiAgdG9KU09OKHQpIHsKICAgIGNvbnN0IGUgPSB0ID09PSB2b2lkIDAgfHwgdHlwZW9mIHQgPT0gInN0cmluZyIsIGkgPSB7fTsKICAgIGUgJiYgKHQgPSB7CiAgICAgIGdlb21ldHJpZXM6IHt9LAogICAgICBtYXRlcmlhbHM6IHt9LAogICAgICB0ZXh0dXJlczoge30sCiAgICAgIGltYWdlczoge30sCiAgICAgIHNoYXBlczoge30sCiAgICAgIHNrZWxldG9uczoge30sCiAgICAgIGFuaW1hdGlvbnM6IHt9LAogICAgICBub2Rlczoge30KICAgIH0sIGkubWV0YWRhdGEgPSB7CiAgICAgIHZlcnNpb246IDQuNywKICAgICAgdHlwZTogIk9iamVjdCIsCiAgICAgIGdlbmVyYXRvcjogIk9iamVjdDNELnRvSlNPTiIKICAgIH0pOwogICAgY29uc3QgbiA9IHt9OwogICAgbi51dWlkID0gdGhpcy51dWlkLCBuLnR5cGUgPSB0aGlzLnR5cGUsIHRoaXMubmFtZSAhPT0gIiIgJiYgKG4ubmFtZSA9IHRoaXMubmFtZSksIHRoaXMuY2FzdFNoYWRvdyA9PT0gITAgJiYgKG4uY2FzdFNoYWRvdyA9ICEwKSwgdGhpcy5yZWNlaXZlU2hhZG93ID09PSAhMCAmJiAobi5yZWNlaXZlU2hhZG93ID0gITApLCB0aGlzLnZpc2libGUgPT09ICExICYmIChuLnZpc2libGUgPSAhMSksIHRoaXMuZnJ1c3R1bUN1bGxlZCA9PT0gITEgJiYgKG4uZnJ1c3R1bUN1bGxlZCA9ICExKSwgdGhpcy5yZW5kZXJPcmRlciAhPT0gMCAmJiAobi5yZW5kZXJPcmRlciA9IHRoaXMucmVuZGVyT3JkZXIpLCBPYmplY3Qua2V5cyh0aGlzLnVzZXJEYXRhKS5sZW5ndGggPiAwICYmIChuLnVzZXJEYXRhID0gdGhpcy51c2VyRGF0YSksIG4ubGF5ZXJzID0gdGhpcy5sYXllcnMubWFzaywgbi5tYXRyaXggPSB0aGlzLm1hdHJpeC50b0FycmF5KCksIG4udXAgPSB0aGlzLnVwLnRvQXJyYXkoKSwgdGhpcy5tYXRyaXhBdXRvVXBkYXRlID09PSAhMSAmJiAobi5tYXRyaXhBdXRvVXBkYXRlID0gITEpLCB0aGlzLmlzSW5zdGFuY2VkTWVzaCAmJiAobi50eXBlID0gIkluc3RhbmNlZE1lc2giLCBuLmNvdW50ID0gdGhpcy5jb3VudCwgbi5pbnN0YW5jZU1hdHJpeCA9IHRoaXMuaW5zdGFuY2VNYXRyaXgudG9KU09OKCksIHRoaXMuaW5zdGFuY2VDb2xvciAhPT0gbnVsbCAmJiAobi5pbnN0YW5jZUNvbG9yID0gdGhpcy5pbnN0YW5jZUNvbG9yLnRvSlNPTigpKSksIHRoaXMuaXNCYXRjaGVkTWVzaCAmJiAobi50eXBlID0gIkJhdGNoZWRNZXNoIiwgbi5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkID0gdGhpcy5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkLCBuLnNvcnRPYmplY3RzID0gdGhpcy5zb3J0T2JqZWN0cywgbi5kcmF3UmFuZ2VzID0gdGhpcy5fZHJhd1Jhbmdlcywgbi5yZXNlcnZlZFJhbmdlcyA9IHRoaXMuX3Jlc2VydmVkUmFuZ2VzLCBuLmdlb21ldHJ5SW5mbyA9IHRoaXMuX2dlb21ldHJ5SW5mby5tYXAoKG8pID0+ICh7CiAgICAgIC4uLm8sCiAgICAgIGJvdW5kaW5nQm94OiBvLmJvdW5kaW5nQm94ID8gby5ib3VuZGluZ0JveC50b0pTT04oKSA6IHZvaWQgMCwKICAgICAgYm91bmRpbmdTcGhlcmU6IG8uYm91bmRpbmdTcGhlcmUgPyBvLmJvdW5kaW5nU3BoZXJlLnRvSlNPTigpIDogdm9pZCAwCiAgICB9KSksIG4uaW5zdGFuY2VJbmZvID0gdGhpcy5faW5zdGFuY2VJbmZvLm1hcCgobykgPT4gKHsgLi4ubyB9KSksIG4uYXZhaWxhYmxlSW5zdGFuY2VJZHMgPSB0aGlzLl9hdmFpbGFibGVJbnN0YW5jZUlkcy5zbGljZSgpLCBuLmF2YWlsYWJsZUdlb21ldHJ5SWRzID0gdGhpcy5fYXZhaWxhYmxlR2VvbWV0cnlJZHMuc2xpY2UoKSwgbi5uZXh0SW5kZXhTdGFydCA9IHRoaXMuX25leHRJbmRleFN0YXJ0LCBuLm5leHRWZXJ0ZXhTdGFydCA9IHRoaXMuX25leHRWZXJ0ZXhTdGFydCwgbi5nZW9tZXRyeUNvdW50ID0gdGhpcy5fZ2VvbWV0cnlDb3VudCwgbi5tYXhJbnN0YW5jZUNvdW50ID0gdGhpcy5fbWF4SW5zdGFuY2VDb3VudCwgbi5tYXhWZXJ0ZXhDb3VudCA9IHRoaXMuX21heFZlcnRleENvdW50LCBuLm1heEluZGV4Q291bnQgPSB0aGlzLl9tYXhJbmRleENvdW50LCBuLmdlb21ldHJ5SW5pdGlhbGl6ZWQgPSB0aGlzLl9nZW9tZXRyeUluaXRpYWxpemVkLCBuLm1hdHJpY2VzVGV4dHVyZSA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZS50b0pTT04odCksIG4uaW5kaXJlY3RUZXh0dXJlID0gdGhpcy5faW5kaXJlY3RUZXh0dXJlLnRvSlNPTih0KSwgdGhpcy5fY29sb3JzVGV4dHVyZSAhPT0gbnVsbCAmJiAobi5jb2xvcnNUZXh0dXJlID0gdGhpcy5fY29sb3JzVGV4dHVyZS50b0pTT04odCkpLCB0aGlzLmJvdW5kaW5nU3BoZXJlICE9PSBudWxsICYmIChuLmJvdW5kaW5nU3BoZXJlID0gdGhpcy5ib3VuZGluZ1NwaGVyZS50b0pTT04oKSksIHRoaXMuYm91bmRpbmdCb3ggIT09IG51bGwgJiYgKG4uYm91bmRpbmdCb3ggPSB0aGlzLmJvdW5kaW5nQm94LnRvSlNPTigpKSk7CiAgICBmdW5jdGlvbiBzKG8sIGwpIHsKICAgICAgcmV0dXJuIG9bbC51dWlkXSA9PT0gdm9pZCAwICYmIChvW2wudXVpZF0gPSBsLnRvSlNPTih0KSksIGwudXVpZDsKICAgIH0KICAgIGlmICh0aGlzLmlzU2NlbmUpCiAgICAgIHRoaXMuYmFja2dyb3VuZCAmJiAodGhpcy5iYWNrZ3JvdW5kLmlzQ29sb3IgPyBuLmJhY2tncm91bmQgPSB0aGlzLmJhY2tncm91bmQudG9KU09OKCkgOiB0aGlzLmJhY2tncm91bmQuaXNUZXh0dXJlICYmIChuLmJhY2tncm91bmQgPSB0aGlzLmJhY2tncm91bmQudG9KU09OKHQpLnV1aWQpKSwgdGhpcy5lbnZpcm9ubWVudCAmJiB0aGlzLmVudmlyb25tZW50LmlzVGV4dHVyZSAmJiB0aGlzLmVudmlyb25tZW50LmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSAhPT0gITAgJiYgKG4uZW52aXJvbm1lbnQgPSB0aGlzLmVudmlyb25tZW50LnRvSlNPTih0KS51dWlkKTsKICAgIGVsc2UgaWYgKHRoaXMuaXNNZXNoIHx8IHRoaXMuaXNMaW5lIHx8IHRoaXMuaXNQb2ludHMpIHsKICAgICAgbi5nZW9tZXRyeSA9IHModC5nZW9tZXRyaWVzLCB0aGlzLmdlb21ldHJ5KTsKICAgICAgY29uc3QgbyA9IHRoaXMuZ2VvbWV0cnkucGFyYW1ldGVyczsKICAgICAgaWYgKG8gIT09IHZvaWQgMCAmJiBvLnNoYXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgY29uc3QgbCA9IG8uc2hhcGVzOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGwpKQogICAgICAgICAgZm9yIChsZXQgaCA9IDAsIGMgPSBsLmxlbmd0aDsgaCA8IGM7IGgrKykgewogICAgICAgICAgICBjb25zdCB1ID0gbFtoXTsKICAgICAgICAgICAgcyh0LnNoYXBlcywgdSk7CiAgICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgcyh0LnNoYXBlcywgbCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLmlzU2tpbm5lZE1lc2ggJiYgKG4uYmluZE1vZGUgPSB0aGlzLmJpbmRNb2RlLCBuLmJpbmRNYXRyaXggPSB0aGlzLmJpbmRNYXRyaXgudG9BcnJheSgpLCB0aGlzLnNrZWxldG9uICE9PSB2b2lkIDAgJiYgKHModC5za2VsZXRvbnMsIHRoaXMuc2tlbGV0b24pLCBuLnNrZWxldG9uID0gdGhpcy5za2VsZXRvbi51dWlkKSksIHRoaXMubWF0ZXJpYWwgIT09IHZvaWQgMCkKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5tYXRlcmlhbCkpIHsKICAgICAgICBjb25zdCBvID0gW107CiAgICAgICAgZm9yIChsZXQgbCA9IDAsIGggPSB0aGlzLm1hdGVyaWFsLmxlbmd0aDsgbCA8IGg7IGwrKykKICAgICAgICAgIG8ucHVzaChzKHQubWF0ZXJpYWxzLCB0aGlzLm1hdGVyaWFsW2xdKSk7CiAgICAgICAgbi5tYXRlcmlhbCA9IG87CiAgICAgIH0gZWxzZQogICAgICAgIG4ubWF0ZXJpYWwgPSBzKHQubWF0ZXJpYWxzLCB0aGlzLm1hdGVyaWFsKTsKICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgICAgbi5jaGlsZHJlbiA9IFtdOwogICAgICBmb3IgKGxldCBvID0gMDsgbyA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBvKyspCiAgICAgICAgbi5jaGlsZHJlbi5wdXNoKHRoaXMuY2hpbGRyZW5bb10udG9KU09OKHQpLm9iamVjdCk7CiAgICB9CiAgICBpZiAodGhpcy5hbmltYXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgbi5hbmltYXRpb25zID0gW107CiAgICAgIGZvciAobGV0IG8gPSAwOyBvIDwgdGhpcy5hbmltYXRpb25zLmxlbmd0aDsgbysrKSB7CiAgICAgICAgY29uc3QgbCA9IHRoaXMuYW5pbWF0aW9uc1tvXTsKICAgICAgICBuLmFuaW1hdGlvbnMucHVzaChzKHQuYW5pbWF0aW9ucywgbCkpOwogICAgICB9CiAgICB9CiAgICBpZiAoZSkgewogICAgICBjb25zdCBvID0gcih0Lmdlb21ldHJpZXMpLCBsID0gcih0Lm1hdGVyaWFscyksIGggPSByKHQudGV4dHVyZXMpLCBjID0gcih0LmltYWdlcyksIHUgPSByKHQuc2hhcGVzKSwgZCA9IHIodC5za2VsZXRvbnMpLCBwID0gcih0LmFuaW1hdGlvbnMpLCBmID0gcih0Lm5vZGVzKTsKICAgICAgby5sZW5ndGggPiAwICYmIChpLmdlb21ldHJpZXMgPSBvKSwgbC5sZW5ndGggPiAwICYmIChpLm1hdGVyaWFscyA9IGwpLCBoLmxlbmd0aCA+IDAgJiYgKGkudGV4dHVyZXMgPSBoKSwgYy5sZW5ndGggPiAwICYmIChpLmltYWdlcyA9IGMpLCB1Lmxlbmd0aCA+IDAgJiYgKGkuc2hhcGVzID0gdSksIGQubGVuZ3RoID4gMCAmJiAoaS5za2VsZXRvbnMgPSBkKSwgcC5sZW5ndGggPiAwICYmIChpLmFuaW1hdGlvbnMgPSBwKSwgZi5sZW5ndGggPiAwICYmIChpLm5vZGVzID0gZik7CiAgICB9CiAgICByZXR1cm4gaS5vYmplY3QgPSBuLCBpOwogICAgZnVuY3Rpb24gcihvKSB7CiAgICAgIGNvbnN0IGwgPSBbXTsKICAgICAgZm9yIChjb25zdCBoIGluIG8pIHsKICAgICAgICBjb25zdCBjID0gb1toXTsKICAgICAgICBkZWxldGUgYy5tZXRhZGF0YSwgbC5wdXNoKGMpOwogICAgICB9CiAgICAgIHJldHVybiBsOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IDNEIG9iamVjdCB3aXRoIGNvcGllZCB2YWx1ZXMgZnJvbSB0aGlzIGluc3RhbmNlLgogICAqCiAgICogQHBhcmFtIHtib29sZWFufSBbcmVjdXJzaXZlPXRydWVdIC0gV2hlbiBzZXQgdG8gYHRydWVgLCBkZXNjZW5kYW50cyBvZiB0aGUgM0Qgb2JqZWN0IGFyZSBhbHNvIGNsb25lZC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKHQpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcywgdCk7CiAgfQogIC8qKgogICAqIENvcGllcyB0aGUgdmFsdWVzIG9mIHRoZSBnaXZlbiAzRCBvYmplY3QgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0M0R9IHNvdXJjZSAtIFRoZSAzRCBvYmplY3QgdG8gY29weS4KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZWN1cnNpdmU9dHJ1ZV0gLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGRlc2NlbmRhbnRzIG9mIHRoZSAzRCBvYmplY3QgYXJlIGNsb25lZC4KICAgKiBAcmV0dXJuIHtPYmplY3QzRH0gQSByZWZlcmVuY2UgdG8gdGhpcyBpbnN0YW5jZS4KICAgKi8KICBjb3B5KHQsIGUgPSAhMCkgewogICAgaWYgKHRoaXMubmFtZSA9IHQubmFtZSwgdGhpcy51cC5jb3B5KHQudXApLCB0aGlzLnBvc2l0aW9uLmNvcHkodC5wb3NpdGlvbiksIHRoaXMucm90YXRpb24ub3JkZXIgPSB0LnJvdGF0aW9uLm9yZGVyLCB0aGlzLnF1YXRlcm5pb24uY29weSh0LnF1YXRlcm5pb24pLCB0aGlzLnNjYWxlLmNvcHkodC5zY2FsZSksIHRoaXMubWF0cml4LmNvcHkodC5tYXRyaXgpLCB0aGlzLm1hdHJpeFdvcmxkLmNvcHkodC5tYXRyaXhXb3JsZCksIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IHQubWF0cml4QXV0b1VwZGF0ZSwgdGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPSB0Lm1hdHJpeFdvcmxkQXV0b1VwZGF0ZSwgdGhpcy5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gdC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlLCB0aGlzLmxheWVycy5tYXNrID0gdC5sYXllcnMubWFzaywgdGhpcy52aXNpYmxlID0gdC52aXNpYmxlLCB0aGlzLmNhc3RTaGFkb3cgPSB0LmNhc3RTaGFkb3csIHRoaXMucmVjZWl2ZVNoYWRvdyA9IHQucmVjZWl2ZVNoYWRvdywgdGhpcy5mcnVzdHVtQ3VsbGVkID0gdC5mcnVzdHVtQ3VsbGVkLCB0aGlzLnJlbmRlck9yZGVyID0gdC5yZW5kZXJPcmRlciwgdGhpcy5hbmltYXRpb25zID0gdC5hbmltYXRpb25zLnNsaWNlKCksIHRoaXMudXNlckRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHQudXNlckRhdGEpKSwgZSA9PT0gITApCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdC5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IG4gPSB0LmNoaWxkcmVuW2ldOwogICAgICAgIHRoaXMuYWRkKG4uY2xvbmUoKSk7CiAgICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KfQpFcy5ERUZBVUxUX1VQID0gLyogQF9fUFVSRV9fICovIG5ldyBGZSgwLCAxLCAwKTsKRXMuREVGQVVMVF9NQVRSSVhfQVVUT19VUERBVEUgPSAhMDsKRXMuREVGQVVMVF9NQVRSSVhfV09STERfQVVUT19VUERBVEUgPSAhMDsKY29uc3QgZXggPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9LCBfcyA9IHsgaDogMCwgczogMCwgbDogMCB9LCB5aCA9IHsgaDogMCwgczogMCwgbDogMCB9OwpmdW5jdGlvbiBHZChhLCB0LCBlKSB7CiAgcmV0dXJuIGUgPCAwICYmIChlICs9IDEpLCBlID4gMSAmJiAoZSAtPSAxKSwgZSA8IDEgLyA2ID8gYSArICh0IC0gYSkgKiA2ICogZSA6IGUgPCAxIC8gMiA/IHQgOiBlIDwgMiAvIDMgPyBhICsgKHQgLSBhKSAqIDYgKiAoMiAvIDMgLSBlKSA6IGE7Cn0KY2xhc3MgQmkgewogIC8qKgogICAqIENvbnN0cnVjdHMgYSBuZXcgY29sb3IuCiAgICoKICAgKiBOb3RlIHRoYXQgc3RhbmRhcmQgbWV0aG9kIG9mIHNwZWNpZnlpbmcgY29sb3IgaW4gdGhyZWUuanMgaXMgd2l0aCBhIGhleGFkZWNpbWFsIHRyaXBsZXQsCiAgICogYW5kIHRoYXQgbWV0aG9kIGlzIHVzZWQgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGUgZG9jdW1lbnRhdGlvbi4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmd8Q29sb3IpfSBbcl0gLSBUaGUgcmVkIGNvbXBvbmVudCBvZiB0aGUgY29sb3IuIElmIGBnYCBhbmQgYGJgIGFyZQogICAqIG5vdCBwcm92aWRlZCwgaXQgY2FuIGJlIGhleGFkZWNpbWFsIHRyaXBsZXQsIGEgQ1NTLXN0eWxlIHN0cmluZyBvciBhbm90aGVyIGBDb2xvcmAgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtnXSAtIFRoZSBncmVlbiBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtiXSAtIFRoZSBibHVlIGNvbXBvbmVudC4KICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlLCBpKSB7CiAgICByZXR1cm4gdGhpcy5pc0NvbG9yID0gITAsIHRoaXMuciA9IDEsIHRoaXMuZyA9IDEsIHRoaXMuYiA9IDEsIHRoaXMuc2V0KHQsIGUsIGkpOwogIH0KICAvKioKICAgKiBTZXRzIHRoZSBjb2xvcnMncyBjb21wb25lbnRzIGZyb20gdGhlIGdpdmVuIHZhbHVlcy4KICAgKgogICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmd8Q29sb3IpfSBbcl0gLSBUaGUgcmVkIGNvbXBvbmVudCBvZiB0aGUgY29sb3IuIElmIGBnYCBhbmQgYGJgIGFyZQogICAqIG5vdCBwcm92aWRlZCwgaXQgY2FuIGJlIGhleGFkZWNpbWFsIHRyaXBsZXQsIGEgQ1NTLXN0eWxlIHN0cmluZyBvciBhbm90aGVyIGBDb2xvcmAgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtnXSAtIFRoZSBncmVlbiBjb21wb25lbnQuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtiXSAtIFRoZSBibHVlIGNvbXBvbmVudC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXQodCwgZSwgaSkgewogICAgaWYgKGUgPT09IHZvaWQgMCAmJiBpID09PSB2b2lkIDApIHsKICAgICAgY29uc3QgbiA9IHQ7CiAgICAgIG4gJiYgbi5pc0NvbG9yID8gdGhpcy5jb3B5KG4pIDogdHlwZW9mIG4gPT0gIm51bWJlciIgPyB0aGlzLnNldEhleChuKSA6IHR5cGVvZiBuID09ICJzdHJpbmciICYmIHRoaXMuc2V0U3R5bGUobik7CiAgICB9IGVsc2UKICAgICAgdGhpcy5zZXRSR0IodCwgZSwgaSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29sb3JzJ3MgY29tcG9uZW50cyB0byB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxhciAtIFRoZSBzY2FsYXIgdmFsdWUuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc2V0U2NhbGFyKHQpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0LCB0aGlzLmcgPSB0LCB0aGlzLmIgPSB0LCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBhIGhleGFkZWNpbWFsIHZhbHVlLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGhleCAtIFRoZSBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yU3BhY2U9U1JHQkNvbG9yU3BhY2VdIC0gVGhlIGNvbG9yIHNwYWNlLgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIHNldEhleCh0LCBlID0gb24pIHsKICAgIHJldHVybiB0ID0gTWF0aC5mbG9vcih0KSwgdGhpcy5yID0gKHQgPj4gMTYgJiAyNTUpIC8gMjU1LCB0aGlzLmcgPSAodCA+PiA4ICYgMjU1KSAvIDI1NSwgdGhpcy5iID0gKHQgJiAyNTUpIC8gMjU1LCBzbi5jb2xvclNwYWNlVG9Xb3JraW5nKHRoaXMsIGUpLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBSR0IgdmFsdWVzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHIgLSBSZWQgY2hhbm5lbCB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcGFyYW0ge251bWJlcn0gZyAtIEdyZWVuIGNoYW5uZWwgdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgLSBCbHVlIGNoYW5uZWwgdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPUNvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc2V0UkdCKHQsIGUsIGksIG4gPSBzbi53b3JraW5nQ29sb3JTcGFjZSkgewogICAgcmV0dXJuIHRoaXMuciA9IHQsIHRoaXMuZyA9IGUsIHRoaXMuYiA9IGksIHNuLmNvbG9yU3BhY2VUb1dvcmtpbmcodGhpcywgbiksIHRoaXM7CiAgfQogIC8qKgogICAqIFNldHMgdGhpcyBjb2xvciBmcm9tIFJHQiB2YWx1ZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gaCAtIEh1ZSB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcGFyYW0ge251bWJlcn0gcyAtIFNhdHVyYXRpb24gdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtudW1iZXJ9IGwgLSBMaWdodG5lc3MgdmFsdWUgYmV0d2VlbiBgMC4wYCBhbmQgYDEuMGAuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPUNvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc2V0SFNMKHQsIGUsIGksIG4gPSBzbi53b3JraW5nQ29sb3JTcGFjZSkgewogICAgaWYgKHQgPSBnQyh0LCAxKSwgZSA9IHllKGUsIDAsIDEpLCBpID0geWUoaSwgMCwgMSksIGUgPT09IDApCiAgICAgIHRoaXMuciA9IHRoaXMuZyA9IHRoaXMuYiA9IGk7CiAgICBlbHNlIHsKICAgICAgY29uc3QgcyA9IGkgPD0gMC41ID8gaSAqICgxICsgZSkgOiBpICsgZSAtIGkgKiBlLCByID0gMiAqIGkgLSBzOwogICAgICB0aGlzLnIgPSBHZChyLCBzLCB0ICsgMSAvIDMpLCB0aGlzLmcgPSBHZChyLCBzLCB0KSwgdGhpcy5iID0gR2QociwgcywgdCAtIDEgLyAzKTsKICAgIH0KICAgIHJldHVybiBzbi5jb2xvclNwYWNlVG9Xb3JraW5nKHRoaXMsIG4pLCB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBhIENTUy1zdHlsZSBzdHJpbmcuIEZvciBleGFtcGxlLCBgcmdiKDI1MCwgMCwwKWAsCiAgICogYHJnYigxMDAlLCAwJSwgMCUpYCwgYGhzbCgwLCAxMDAlLCA1MCUpYCwgYCNmZjAwMDBgLCBgI2YwMGAsIG9yIGByZWRgICggb3IKICAgKiBhbnkgW1gxMSBjb2xvciBuYW1lXXtAbGluayBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9YMTFfY29sb3JfbmFtZXMjQ29sb3JfbmFtZV9jaGFydH0gLQogICAqIGFsbCAxNDAgY29sb3IgbmFtZXMgYXJlIHN1cHBvcnRlZCkuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3R5bGUgLSBDb2xvciBhcyBhIENTUy1zdHlsZSBzdHJpbmcuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPVNSR0JDb2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXRTdHlsZSh0LCBlID0gb24pIHsKICAgIGZ1bmN0aW9uIGkocykgewogICAgICBzICE9PSB2b2lkIDAgJiYgcGFyc2VGbG9hdChzKSA8IDEgJiYgY29uc29sZS53YXJuKCJUSFJFRS5Db2xvcjogQWxwaGEgY29tcG9uZW50IG9mICIgKyB0ICsgIiB3aWxsIGJlIGlnbm9yZWQuIik7CiAgICB9CiAgICBsZXQgbjsKICAgIGlmIChuID0gL14oXHcrKVwoKFteXCldKilcKS8uZXhlYyh0KSkgewogICAgICBsZXQgczsKICAgICAgY29uc3QgciA9IG5bMV0sIG8gPSBuWzJdOwogICAgICBzd2l0Y2ggKHIpIHsKICAgICAgICBjYXNlICJyZ2IiOgogICAgICAgIGNhc2UgInJnYmEiOgogICAgICAgICAgaWYgKHMgPSAvXlxzKihcZCspXHMqLFxzKihcZCspXHMqLFxzKihcZCspXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKG8pKQogICAgICAgICAgICByZXR1cm4gaShzWzRdKSwgdGhpcy5zZXRSR0IoCiAgICAgICAgICAgICAgTWF0aC5taW4oMjU1LCBwYXJzZUludChzWzFdLCAxMCkpIC8gMjU1LAogICAgICAgICAgICAgIE1hdGgubWluKDI1NSwgcGFyc2VJbnQoc1syXSwgMTApKSAvIDI1NSwKICAgICAgICAgICAgICBNYXRoLm1pbigyNTUsIHBhcnNlSW50KHNbM10sIDEwKSkgLyAyNTUsCiAgICAgICAgICAgICAgZQogICAgICAgICAgICApOwogICAgICAgICAgaWYgKHMgPSAvXlxzKihcZCspXCVccyosXHMqKFxkKylcJVxzKixccyooXGQrKVwlXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKG8pKQogICAgICAgICAgICByZXR1cm4gaShzWzRdKSwgdGhpcy5zZXRSR0IoCiAgICAgICAgICAgICAgTWF0aC5taW4oMTAwLCBwYXJzZUludChzWzFdLCAxMCkpIC8gMTAwLAogICAgICAgICAgICAgIE1hdGgubWluKDEwMCwgcGFyc2VJbnQoc1syXSwgMTApKSAvIDEwMCwKICAgICAgICAgICAgICBNYXRoLm1pbigxMDAsIHBhcnNlSW50KHNbM10sIDEwKSkgLyAxMDAsCiAgICAgICAgICAgICAgZQogICAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiaHNsIjoKICAgICAgICBjYXNlICJoc2xhIjoKICAgICAgICAgIGlmIChzID0gL15ccyooXGQqXC4/XGQrKVxzKixccyooXGQqXC4/XGQrKVwlXHMqLFxzKihcZCpcLj9cZCspXCVccyooPzosXHMqKFxkKlwuP1xkKylccyopPyQvLmV4ZWMobykpCiAgICAgICAgICAgIHJldHVybiBpKHNbNF0pLCB0aGlzLnNldEhTTCgKICAgICAgICAgICAgICBwYXJzZUZsb2F0KHNbMV0pIC8gMzYwLAogICAgICAgICAgICAgIHBhcnNlRmxvYXQoc1syXSkgLyAxMDAsCiAgICAgICAgICAgICAgcGFyc2VGbG9hdChzWzNdKSAvIDEwMCwKICAgICAgICAgICAgICBlCiAgICAgICAgICAgICk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5Db2xvcjogVW5rbm93biBjb2xvciBtb2RlbCAiICsgdCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobiA9IC9eXCMoW0EtRmEtZlxkXSspJC8uZXhlYyh0KSkgewogICAgICBjb25zdCBzID0gblsxXSwgciA9IHMubGVuZ3RoOwogICAgICBpZiAociA9PT0gMykKICAgICAgICByZXR1cm4gdGhpcy5zZXRSR0IoCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgwKSwgMTYpIC8gMTUsCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgxKSwgMTYpIC8gMTUsCiAgICAgICAgICBwYXJzZUludChzLmNoYXJBdCgyKSwgMTYpIC8gMTUsCiAgICAgICAgICBlCiAgICAgICAgKTsKICAgICAgaWYgKHIgPT09IDYpCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0SGV4KHBhcnNlSW50KHMsIDE2KSwgZSk7CiAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuQ29sb3I6IEludmFsaWQgaGV4IGNvbG9yICIgKyB0KTsKICAgIH0gZWxzZSBpZiAodCAmJiB0Lmxlbmd0aCA+IDApCiAgICAgIHJldHVybiB0aGlzLnNldENvbG9yTmFtZSh0LCBlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IgZnJvbSBhIGNvbG9yIG5hbWUuIEZhc3RlciB0aGFuIHtAbGluayBDb2xvciNzZXRTdHlsZX0gaWYKICAgKiB5b3UgZG9uJ3QgbmVlZCB0aGUgb3RoZXIgQ1NTLXN0eWxlIGZvcm1hdHMuCiAgICoKICAgKiBGb3IgY29udmVuaWVuY2UsIHRoZSBsaXN0IG9mIG5hbWVzIGlzIGV4cG9zZWQgaW4gYENvbG9yLk5BTUVTYCBhcyBhIGhhc2guCiAgICogYGBganMKICAgKiBDb2xvci5OQU1FUy5hbGljZWJsdWUgLy8gcmV0dXJucyAweEYwRjhGRgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0eWxlIC0gVGhlIGNvbG9yIG5hbWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPVNSR0JDb2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXRDb2xvck5hbWUodCwgZSA9IG9uKSB7CiAgICBjb25zdCBpID0gZXhbdC50b0xvd2VyQ2FzZSgpXTsKICAgIHJldHVybiBpICE9PSB2b2lkIDAgPyB0aGlzLnNldEhleChpLCBlKSA6IGNvbnNvbGUud2FybigiVEhSRUUuQ29sb3I6IFVua25vd24gY29sb3IgIiArIHQpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IGNvbG9yIHdpdGggY29waWVkIHZhbHVlcyBmcm9tIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcmV0dXJuIHtDb2xvcn0gQSBjbG9uZSBvZiB0aGlzIGluc3RhbmNlLgogICAqLwogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuciwgdGhpcy5nLCB0aGlzLmIpOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gY29sb3IgdG8gdGhpcyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGNvcHkuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgY29weSh0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gdC5yLCB0aGlzLmcgPSB0LmcsIHRoaXMuYiA9IHQuYiwgdGhpczsKICB9CiAgLyoqCiAgICogQ29waWVzIHRoZSBnaXZlbiBjb2xvciBpbnRvIHRoaXMgY29sb3IsIGFuZCB0aGVuIGNvbnZlcnRzIHRoaXMgY29sb3IgZnJvbQogICAqIGBTUkdCQ29sb3JTcGFjZWAgdG8gYExpbmVhclNSR0JDb2xvclNwYWNlYC4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGNvcHkvY29udmVydC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBjb3B5U1JHQlRvTGluZWFyKHQpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0cyh0LnIpLCB0aGlzLmcgPSB0cyh0LmcpLCB0aGlzLmIgPSB0cyh0LmIpLCB0aGlzOwogIH0KICAvKioKICAgKiBDb3BpZXMgdGhlIGdpdmVuIGNvbG9yIGludG8gdGhpcyBjb2xvciwgYW5kIHRoZW4gY29udmVydHMgdGhpcyBjb2xvciBmcm9tCiAgICogYExpbmVhclNSR0JDb2xvclNwYWNlYCB0byBgU1JHQkNvbG9yU3BhY2VgLgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gY29weS9jb252ZXJ0LgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGNvcHlMaW5lYXJUb1NSR0IodCkgewogICAgcmV0dXJuIHRoaXMuciA9IHVhKHQuciksIHRoaXMuZyA9IHVhKHQuZyksIHRoaXMuYiA9IHVhKHQuYiksIHRoaXM7CiAgfQogIC8qKgogICAqIENvbnZlcnRzIHRoaXMgY29sb3IgZnJvbSBgU1JHQkNvbG9yU3BhY2VgIHRvIGBMaW5lYXJTUkdCQ29sb3JTcGFjZWAuCiAgICoKICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBjb252ZXJ0U1JHQlRvTGluZWFyKCkgewogICAgcmV0dXJuIHRoaXMuY29weVNSR0JUb0xpbmVhcih0aGlzKSwgdGhpczsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhpcyBjb2xvciBmcm9tIGBMaW5lYXJTUkdCQ29sb3JTcGFjZWAgdG8gYFNSR0JDb2xvclNwYWNlYC4KICAgKgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGNvbnZlcnRMaW5lYXJUb1NSR0IoKSB7CiAgICByZXR1cm4gdGhpcy5jb3B5TGluZWFyVG9TUkdCKHRoaXMpLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBoZXhhZGVjaW1hbCB2YWx1ZSBvZiB0aGlzIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPVNSR0JDb2xvclNwYWNlXSAtIFRoZSBjb2xvciBzcGFjZS4KICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgKi8KICBnZXRIZXgodCA9IG9uKSB7CiAgICByZXR1cm4gc24ud29ya2luZ1RvQ29sb3JTcGFjZShuaS5jb3B5KHRoaXMpLCB0KSwgTWF0aC5yb3VuZCh5ZShuaS5yICogMjU1LCAwLCAyNTUpKSAqIDY1NTM2ICsgTWF0aC5yb3VuZCh5ZShuaS5nICogMjU1LCAwLCAyNTUpKSAqIDI1NiArIE1hdGgucm91bmQoeWUobmkuYiAqIDI1NSwgMCwgMjU1KSk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGhleGFkZWNpbWFsIHZhbHVlIG9mIHRoaXMgY29sb3IgYXMgYSBzdHJpbmcgKGZvciBleGFtcGxlLCAnRkZGRkZGJykuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yU3BhY2U9U1JHQkNvbG9yU3BhY2VdIC0gVGhlIGNvbG9yIHNwYWNlLgogICAqIEByZXR1cm4ge3N0cmluZ30gVGhlIGhleGFkZWNpbWFsIHZhbHVlIGFzIGEgc3RyaW5nLgogICAqLwogIGdldEhleFN0cmluZyh0ID0gb24pIHsKICAgIHJldHVybiAoIjAwMDAwMCIgKyB0aGlzLmdldEhleCh0KS50b1N0cmluZygxNikpLnNsaWNlKC02KTsKICB9CiAgLyoqCiAgICogQ29udmVydHMgdGhlIGNvbG9ycyBSR0IgdmFsdWVzIGludG8gdGhlIEhTTCBmb3JtYXQgYW5kIHN0b3JlcyB0aGVtIGludG8gdGhlCiAgICogZ2l2ZW4gdGFyZ2V0IG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7e2g6bnVtYmVyLHM6bnVtYmVyLGw6bnVtYmVyfX0gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgdGhhdCBpcyB1c2VkIHRvIHN0b3JlIHRoZSBtZXRob2QncyByZXN1bHQuCiAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvclNwYWNlPUNvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7e2g6bnVtYmVyLHM6bnVtYmVyLGw6bnVtYmVyfX0gVGhlIEhTTCByZXByZXNlbnRhdGlvbiBvZiB0aGlzIGNvbG9yLgogICAqLwogIGdldEhTTCh0LCBlID0gc24ud29ya2luZ0NvbG9yU3BhY2UpIHsKICAgIHNuLndvcmtpbmdUb0NvbG9yU3BhY2UobmkuY29weSh0aGlzKSwgZSk7CiAgICBjb25zdCBpID0gbmkuciwgbiA9IG5pLmcsIHMgPSBuaS5iLCByID0gTWF0aC5tYXgoaSwgbiwgcyksIG8gPSBNYXRoLm1pbihpLCBuLCBzKTsKICAgIGxldCBsLCBoOwogICAgY29uc3QgYyA9IChvICsgcikgLyAyOwogICAgaWYgKG8gPT09IHIpCiAgICAgIGwgPSAwLCBoID0gMDsKICAgIGVsc2UgewogICAgICBjb25zdCB1ID0gciAtIG87CiAgICAgIHN3aXRjaCAoaCA9IGMgPD0gMC41ID8gdSAvIChyICsgbykgOiB1IC8gKDIgLSByIC0gbyksIHIpIHsKICAgICAgICBjYXNlIGk6CiAgICAgICAgICBsID0gKG4gLSBzKSAvIHUgKyAobiA8IHMgPyA2IDogMCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIG46CiAgICAgICAgICBsID0gKHMgLSBpKSAvIHUgKyAyOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBzOgogICAgICAgICAgbCA9IChpIC0gbikgLyB1ICsgNDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGwgLz0gNjsKICAgIH0KICAgIHJldHVybiB0LmggPSBsLCB0LnMgPSBoLCB0LmwgPSBjLCB0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBSR0IgdmFsdWVzIG9mIHRoaXMgY29sb3IgYW5kIHN0b3JlcyB0aGVtIGludG8gdGhlIGdpdmVuIHRhcmdldCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSB0YXJnZXQgLSBUaGUgdGFyZ2V0IGNvbG9yIHRoYXQgaXMgdXNlZCB0byBzdG9yZSB0aGUgbWV0aG9kJ3MgcmVzdWx0LgogICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JTcGFjZT1Db2xvck1hbmFnZW1lbnQud29ya2luZ0NvbG9yU3BhY2VdIC0gVGhlIGNvbG9yIHNwYWNlLgogICAqIEByZXR1cm4ge0NvbG9yfSBUaGUgUkdCIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgY29sb3IuCiAgICovCiAgZ2V0UkdCKHQsIGUgPSBzbi53b3JraW5nQ29sb3JTcGFjZSkgewogICAgcmV0dXJuIHNuLndvcmtpbmdUb0NvbG9yU3BhY2UobmkuY29weSh0aGlzKSwgZSksIHQuciA9IG5pLnIsIHQuZyA9IG5pLmcsIHQuYiA9IG5pLmIsIHQ7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoaXMgY29sb3IgYXMgYSBDU1Mgc3R5bGUgc3RyaW5nLiBFeGFtcGxlOiBgcmdiKDI1NSwwLDApYC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JTcGFjZT1TUkdCQ29sb3JTcGFjZV0gLSBUaGUgY29sb3Igc3BhY2UuCiAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgQ1NTIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgY29sb3IuCiAgICovCiAgZ2V0U3R5bGUodCA9IG9uKSB7CiAgICBzbi53b3JraW5nVG9Db2xvclNwYWNlKG5pLmNvcHkodGhpcyksIHQpOwogICAgY29uc3QgZSA9IG5pLnIsIGkgPSBuaS5nLCBuID0gbmkuYjsKICAgIHJldHVybiB0ICE9PSBvbiA/IGBjb2xvcigke3R9ICR7ZS50b0ZpeGVkKDMpfSAke2kudG9GaXhlZCgzKX0gJHtuLnRvRml4ZWQoMyl9KWAgOiBgcmdiKCR7TWF0aC5yb3VuZChlICogMjU1KX0sJHtNYXRoLnJvdW5kKGkgKiAyNTUpfSwke01hdGgucm91bmQobiAqIDI1NSl9KWA7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIEhTTCB2YWx1ZXMgdG8gdGhpcyBjb2xvcidzIHZhbHVlcy4KICAgKiBJbnRlcm5hbGx5LCB0aGlzIGNvbnZlcnRzIHRoZSBjb2xvcidzIFJHQiB2YWx1ZXMgdG8gSFNMLCBhZGRzIEhTTAogICAqIGFuZCB0aGVuIGNvbnZlcnRzIHRoZSBjb2xvciBiYWNrIHRvIFJHQi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBoIC0gSHVlIHZhbHVlIGJldHdlZW4gYDAuMGAgYW5kIGAxLjBgLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gU2F0dXJhdGlvbiB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcGFyYW0ge251bWJlcn0gbCAtIExpZ2h0bmVzcyB2YWx1ZSBiZXR3ZWVuIGAwLjBgIGFuZCBgMS4wYC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBvZmZzZXRIU0wodCwgZSwgaSkgewogICAgcmV0dXJuIHRoaXMuZ2V0SFNMKF9zKSwgdGhpcy5zZXRIU0woX3MuaCArIHQsIF9zLnMgKyBlLCBfcy5sICsgaSk7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIFJHQiB2YWx1ZXMgb2YgdGhlIGdpdmVuIGNvbG9yIHRvIHRoZSBSR0IgdmFsdWVzIG9mIHRoaXMgY29sb3IuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvciAtIFRoZSBjb2xvciB0byBhZGQuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgYWRkKHQpIHsKICAgIHJldHVybiB0aGlzLnIgKz0gdC5yLCB0aGlzLmcgKz0gdC5nLCB0aGlzLmIgKz0gdC5iLCB0aGlzOwogIH0KICAvKioKICAgKiBBZGRzIHRoZSBSR0IgdmFsdWVzIG9mIHRoZSBnaXZlbiBjb2xvcnMgYW5kIHN0b3JlcyB0aGUgcmVzdWx0IGluIHRoaXMgaW5zdGFuY2UuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvcjEgLSBUaGUgZmlyc3QgY29sb3IuCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IyIC0gVGhlIHNlY29uZCBjb2xvci4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBhZGRDb2xvcnModCwgZSkgewogICAgcmV0dXJuIHRoaXMuciA9IHQuciArIGUuciwgdGhpcy5nID0gdC5nICsgZS5nLCB0aGlzLmIgPSB0LmIgKyBlLmIsIHRoaXM7CiAgfQogIC8qKgogICAqIEFkZHMgdGhlIGdpdmVuIHNjYWxhciB2YWx1ZSB0byB0aGUgUkdCIHZhbHVlcyBvZiB0aGlzIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHMgLSBUaGUgc2NhbGFyIHRvIGFkZC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBhZGRTY2FsYXIodCkgewogICAgcmV0dXJuIHRoaXMuciArPSB0LCB0aGlzLmcgKz0gdCwgdGhpcy5iICs9IHQsIHRoaXM7CiAgfQogIC8qKgogICAqIFN1YnRyYWN0cyB0aGUgUkdCIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gY29sb3IgZnJvbSB0aGUgUkdCIHZhbHVlcyBvZiB0aGlzIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gc3VidHJhY3QuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgc3ViKHQpIHsKICAgIHJldHVybiB0aGlzLnIgPSBNYXRoLm1heCgwLCB0aGlzLnIgLSB0LnIpLCB0aGlzLmcgPSBNYXRoLm1heCgwLCB0aGlzLmcgLSB0LmcpLCB0aGlzLmIgPSBNYXRoLm1heCgwLCB0aGlzLmIgLSB0LmIpLCB0aGlzOwogIH0KICAvKioKICAgKiBNdWx0aXBsaWVzIHRoZSBSR0IgdmFsdWVzIG9mIHRoZSBnaXZlbiBjb2xvciB3aXRoIHRoZSBSR0IgdmFsdWVzIG9mIHRoaXMgY29sb3IuCiAgICoKICAgKiBAcGFyYW0ge0NvbG9yfSBjb2xvciAtIFRoZSBjb2xvciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBtdWx0aXBseSh0KSB7CiAgICByZXR1cm4gdGhpcy5yICo9IHQuciwgdGhpcy5nICo9IHQuZywgdGhpcy5iICo9IHQuYiwgdGhpczsKICB9CiAgLyoqCiAgICogTXVsdGlwbGllcyB0aGUgZ2l2ZW4gc2NhbGFyIHZhbHVlIHdpdGggdGhlIFJHQiB2YWx1ZXMgb2YgdGhpcyBjb2xvci4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBzIC0gVGhlIHNjYWxhciB0byBtdWx0aXBseS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBtdWx0aXBseVNjYWxhcih0KSB7CiAgICByZXR1cm4gdGhpcy5yICo9IHQsIHRoaXMuZyAqPSB0LCB0aGlzLmIgKj0gdCwgdGhpczsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIHRoaXMgY29sb3IncyBSR0IgdmFsdWVzIHRvd2FyZCB0aGUgUkdCIHZhbHVlcyBvZiB0aGUKICAgKiBnaXZlbiBjb2xvci4gVGhlIGFscGhhIGFyZ3VtZW50IGNhbiBiZSB0aG91Z2h0IG9mIGFzIHRoZSByYXRpbyBiZXR3ZWVuCiAgICogdGhlIHR3byBjb2xvcnMsIHdoZXJlIGAwLjBgIGlzIHRoaXMgY29sb3IgYW5kIGAxLjBgIGlzIHRoZSBmaXJzdCBhcmd1bWVudC4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGNvbnZlcmdlIG9uLgogICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBpbnRlcnBvbGF0aW9uIGZhY3RvciBpbiB0aGUgY2xvc2VkIGludGVydmFsIGBbMCwxXWAuCiAgICogQHJldHVybiB7Q29sb3J9IEEgcmVmZXJlbmNlIHRvIHRoaXMgY29sb3IuCiAgICovCiAgbGVycCh0LCBlKSB7CiAgICByZXR1cm4gdGhpcy5yICs9ICh0LnIgLSB0aGlzLnIpICogZSwgdGhpcy5nICs9ICh0LmcgLSB0aGlzLmcpICogZSwgdGhpcy5iICs9ICh0LmIgLSB0aGlzLmIpICogZSwgdGhpczsKICB9CiAgLyoqCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIGJldHdlZW4gdGhlIGdpdmVuIGNvbG9ycyBhbmQgc3RvcmVzIHRoZSByZXN1bHQgaW4gdGhpcyBpbnN0YW5jZS4KICAgKiBUaGUgYWxwaGEgYXJndW1lbnQgY2FuIGJlIHRob3VnaHQgb2YgYXMgdGhlIHJhdGlvIGJldHdlZW4gdGhlIHR3byBjb2xvcnMsIHdoZXJlIGAwLjBgCiAgICogaXMgdGhlIGZpcnN0IGFuZCBgMS4wYCBpcyB0aGUgc2Vjb25kIGNvbG9yLgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IxIC0gVGhlIGZpcnN0IGNvbG9yLgogICAqIEBwYXJhbSB7Q29sb3J9IGNvbG9yMiAtIFRoZSBzZWNvbmQgY29sb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yIGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLDFdYC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBsZXJwQ29sb3JzKHQsIGUsIGkpIHsKICAgIHJldHVybiB0aGlzLnIgPSB0LnIgKyAoZS5yIC0gdC5yKSAqIGksIHRoaXMuZyA9IHQuZyArIChlLmcgLSB0LmcpICogaSwgdGhpcy5iID0gdC5iICsgKGUuYiAtIHQuYikgKiBpLCB0aGlzOwogIH0KICAvKioKICAgKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgdGhpcyBjb2xvcidzIEhTTCB2YWx1ZXMgdG93YXJkIHRoZSBIU0wgdmFsdWVzIG9mIHRoZQogICAqIGdpdmVuIGNvbG9yLiBJdCBkaWZmZXJzIGZyb20ge0BsaW5rIENvbG9yI2xlcnB9IGJ5IG5vdCBpbnRlcnBvbGF0aW5nIHN0cmFpZ2h0CiAgICogZnJvbSBvbmUgY29sb3IgdG8gdGhlIG90aGVyLCBidXQgaW5zdGVhZCBnb2luZyB0aHJvdWdoIGFsbCB0aGUgaHVlcyBpbiBiZXR3ZWVuCiAgICogdGhvc2UgdHdvIGNvbG9ycy4gVGhlIGFscGhhIGFyZ3VtZW50IGNhbiBiZSB0aG91Z2h0IG9mIGFzIHRoZSByYXRpbyBiZXR3ZWVuCiAgICogdGhlIHR3byBjb2xvcnMsIHdoZXJlIDAuMCBpcyB0aGlzIGNvbG9yIGFuZCAxLjAgaXMgdGhlIGZpcnN0IGFyZ3VtZW50LgogICAqCiAgICogQHBhcmFtIHtDb2xvcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gY29udmVyZ2Ugb24uCiAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGludGVycG9sYXRpb24gZmFjdG9yIGluIHRoZSBjbG9zZWQgaW50ZXJ2YWwgYFswLDFdYC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBsZXJwSFNMKHQsIGUpIHsKICAgIHRoaXMuZ2V0SFNMKF9zKSwgdC5nZXRIU0woeWgpOwogICAgY29uc3QgaSA9IHpkKF9zLmgsIHloLmgsIGUpLCBuID0gemQoX3MucywgeWgucywgZSksIHMgPSB6ZChfcy5sLCB5aC5sLCBlKTsKICAgIHJldHVybiB0aGlzLnNldEhTTChpLCBuLCBzKSwgdGhpczsKICB9CiAgLyoqCiAgICogU2V0cyB0aGUgY29sb3IncyBSR0IgY29tcG9uZW50cyBmcm9tIHRoZSBnaXZlbiAzRCB2ZWN0b3IuCiAgICoKICAgKiBAcGFyYW0ge1ZlY3RvcjN9IHYgLSBUaGUgdmVjdG9yIHRvIHNldC4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBzZXRGcm9tVmVjdG9yMyh0KSB7CiAgICByZXR1cm4gdGhpcy5yID0gdC54LCB0aGlzLmcgPSB0LnksIHRoaXMuYiA9IHQueiwgdGhpczsKICB9CiAgLyoqCiAgICogVHJhbnNmb3JtcyB0aGlzIGNvbG9yIHdpdGggdGhlIGdpdmVuIDN4MyBtYXRyaXguCiAgICoKICAgKiBAcGFyYW0ge01hdHJpeDN9IG0gLSBUaGUgbWF0cml4LgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGFwcGx5TWF0cml4Myh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5yLCBpID0gdGhpcy5nLCBuID0gdGhpcy5iLCBzID0gdC5lbGVtZW50czsKICAgIHJldHVybiB0aGlzLnIgPSBzWzBdICogZSArIHNbM10gKiBpICsgc1s2XSAqIG4sIHRoaXMuZyA9IHNbMV0gKiBlICsgc1s0XSAqIGkgKyBzWzddICogbiwgdGhpcy5iID0gc1syXSAqIGUgKyBzWzVdICogaSArIHNbOF0gKiBuLCB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGlzIGNvbG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKgogICAqIEBwYXJhbSB7Q29sb3J9IGMgLSBUaGUgY29sb3IgdG8gdGVzdCBmb3IgZXF1YWxpdHkuCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGlzIGJvdW5kaW5nIGNvbG9yIGlzIGVxdWFsIHdpdGggdGhlIGdpdmVuIG9uZS4KICAgKi8KICBlcXVhbHModCkgewogICAgcmV0dXJuIHQuciA9PT0gdGhpcy5yICYmIHQuZyA9PT0gdGhpcy5nICYmIHQuYiA9PT0gdGhpcy5iOwogIH0KICAvKioKICAgKiBTZXRzIHRoaXMgY29sb3IncyBSR0IgY29tcG9uZW50cyBmcm9tIHRoZSBnaXZlbiBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYXJyYXkgLSBBbiBhcnJheSBob2xkaW5nIHRoZSBSR0IgdmFsdWVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbb2Zmc2V0PTBdIC0gVGhlIG9mZnNldCBpbnRvIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtDb2xvcn0gQSByZWZlcmVuY2UgdG8gdGhpcyBjb2xvci4KICAgKi8KICBmcm9tQXJyYXkodCwgZSA9IDApIHsKICAgIHJldHVybiB0aGlzLnIgPSB0W2VdLCB0aGlzLmcgPSB0W2UgKyAxXSwgdGhpcy5iID0gdFtlICsgMl0sIHRoaXM7CiAgfQogIC8qKgogICAqIFdyaXRlcyB0aGUgUkdCIGNvbXBvbmVudHMgb2YgdGhpcyBjb2xvciB0byB0aGUgZ2l2ZW4gYXJyYXkuIElmIG5vIGFycmF5IGlzIHByb3ZpZGVkLAogICAqIHRoZSBtZXRob2QgcmV0dXJucyBhIG5ldyBpbnN0YW5jZS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gW2FycmF5PVtdXSAtIFRoZSB0YXJnZXQgYXJyYXkgaG9sZGluZyB0aGUgY29sb3IgY29tcG9uZW50cy4KICAgKiBAcGFyYW0ge251bWJlcn0gW29mZnNldD0wXSAtIEluZGV4IG9mIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSBhcnJheS4KICAgKiBAcmV0dXJuIHtBcnJheTxudW1iZXI+fSBUaGUgY29sb3IgY29tcG9uZW50cy4KICAgKi8KICB0b0FycmF5KHQgPSBbXSwgZSA9IDApIHsKICAgIHJldHVybiB0W2VdID0gdGhpcy5yLCB0W2UgKyAxXSA9IHRoaXMuZywgdFtlICsgMl0gPSB0aGlzLmIsIHQ7CiAgfQogIC8qKgogICAqIFNldHMgdGhlIGNvbXBvbmVudHMgb2YgdGhpcyBjb2xvciBmcm9tIHRoZSBnaXZlbiBidWZmZXIgYXR0cmlidXRlLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJBdHRyaWJ1dGV9IGF0dHJpYnV0ZSAtIFRoZSBidWZmZXIgYXR0cmlidXRlIGhvbGRpbmcgY29sb3IgZGF0YS4KICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW50byB0aGUgYXR0cmlidXRlLgogICAqIEByZXR1cm4ge0NvbG9yfSBBIHJlZmVyZW5jZSB0byB0aGlzIGNvbG9yLgogICAqLwogIGZyb21CdWZmZXJBdHRyaWJ1dGUodCwgZSkgewogICAgcmV0dXJuIHRoaXMuciA9IHQuZ2V0WChlKSwgdGhpcy5nID0gdC5nZXRZKGUpLCB0aGlzLmIgPSB0LmdldFooZSksIHRoaXM7CiAgfQogIC8qKgogICAqIFRoaXMgbWV0aG9kcyBkZWZpbmVzIHRoZSBzZXJpYWxpemF0aW9uIHJlc3VsdCBvZiB0aGlzIGNsYXNzLiBSZXR1cm5zIHRoZSBjb2xvcgogICAqIGFzIGEgaGV4YWRlY2ltYWwgdmFsdWUuCiAgICoKICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBoZXhhZGVjaW1hbCB2YWx1ZS4KICAgKi8KICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy5nZXRIZXgoKTsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy5yLCB5aWVsZCB0aGlzLmcsIHlpZWxkIHRoaXMuYjsKICB9Cn0KY29uc3QgbmkgPSAvKiBAX19QVVJFX18gKi8gbmV3IEJpKCk7CkJpLk5BTUVTID0gZXg7CmNsYXNzIFJDIGV4dGVuZHMgRXMgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKSwgdGhpcy5pc0dyb3VwID0gITAsIHRoaXMudHlwZSA9ICJHcm91cCI7CiAgfQp9CnR5cGVvZiBfX1RIUkVFX0RFVlRPT0xTX18gPCAidSIgJiYgX19USFJFRV9ERVZUT09MU19fLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCJyZWdpc3RlciIsIHsgZGV0YWlsOiB7CiAgcmV2aXNpb246IEpfCn0gfSkpOwp0eXBlb2Ygd2luZG93IDwgInUiICYmICh3aW5kb3cuX19USFJFRV9fID8gY29uc29sZS53YXJuKCJXQVJOSU5HOiBNdWx0aXBsZSBpbnN0YW5jZXMgb2YgVGhyZWUuanMgYmVpbmcgaW1wb3J0ZWQuIikgOiB3aW5kb3cuX19USFJFRV9fID0gSl8pOwpmdW5jdGlvbiBpeChhKSB7CiAgdmFyIHQ7CiAgaWYgKGEpIHsKICAgIGEuZGlzcG9zZSgpOwogICAgZm9yIChjb25zdCBlIG9mIE9iamVjdC52YWx1ZXMoYS5hdHRyaWJ1dGVzKSkKICAgICAgKHQgPSBlID09IG51bGwgPyB2b2lkIDAgOiBlLmRpc3Bvc2UpID09IG51bGwgfHwgdC5jYWxsKGUpOwogIH0KfQpmdW5jdGlvbiBQQyhhKSB7CiAgYS5nZW9tZXRyeSAmJiBpeChhLmdlb21ldHJ5KSwgYS5tYXRlcmlhbCAmJiAoQXJyYXkuaXNBcnJheShhLm1hdGVyaWFsKSA/IGEubWF0ZXJpYWwuZm9yRWFjaCgodCkgPT4gdC5kaXNwb3NlKCkpIDogYS5tYXRlcmlhbC5kaXNwb3NlKCkpOwp9CmZ1bmN0aW9uIEVjKGEpIHsKICBhICYmIChBcnJheS5pc0FycmF5KGEuY2hpbGRyZW4pICYmIGEuY2hpbGRyZW4uZm9yRWFjaChFYyksIGEuZGlzcG9zZSA/IGEuZGlzcG9zZSgpIDogQXJyYXkuaXNBcnJheShhKSA/IGEuZm9yRWFjaChFYykgOiAoYS5pc01lc2ggfHwgYS5pc0xpbmUpICYmIFBDKGEpKTsKfQpjbGFzcyBJQyBleHRlbmRzIFJDIHsKICAvKioKICAgKgogICAqIEBwYXJhbSB7Kn0gb3BhY2l0eQogICAqIEBwYXJhbSB7Kn0gYWxwaGEKICAgKiBAcGFyYW0geyp9IGVkZ2VfY29sb3IKICAgKiBAcGFyYW0ge29iamVjdH0gc2hhcGVJbmZvIEEgZGljdGlvbmFyeSBvZiBzaGFwZSBpbmZvcm1hdGlvbiB3aXRoIGEgInRvcG8iIGZpZWxkIGFuZCAiZ2VvbXR5cGUiIGZpZWxkLgogICAqIEBwYXJhbSB7Kn0gcmVuZGVyYmFjawogICAqLwogIGNvbnN0cnVjdG9yKHQsIGUsIGksIG4sIHMsIHIpIHsKICAgIHN1cGVyKCksIHRoaXMub3BhY2l0eSA9IHQsIHRoaXMuYWxwaGEgPSBlID8/IDEsIHRoaXMuZWRnZV9jb2xvciA9IGksIHRoaXMuc2hhcGVJbmZvID0gbiwgdGhpcy5zdWJ0eXBlID0gcywgdGhpcy5yZW5kZXJiYWNrID0gciwgdGhpcy50eXBlcyA9IHsgZnJvbnQ6IG51bGwsIGJhY2s6IG51bGwsIGVkZ2VzOiBudWxsLCB2ZXJ0aWNlczogbnVsbCB9LCB0aGlzLmlzU2VsZWN0ZWQgPSAhMSwgdGhpcy5vcmlnaW5hbENvbG9yID0gbnVsbCwgdGhpcy5vcmlnaW5hbEJhY2tDb2xvciA9IG51bGwsIHRoaXMub3JpZ2luYWxXaWR0aCA9IG51bGwsIHRoaXMudmVydGV4Rm9jdXNTaXplID0gOCwgdGhpcy5lZGdlRm9jdXNXaWR0aCA9IDU7CiAgfQogIGRpc3Bvc2UoKSB7CiAgICB0aGlzLnNoYXBlR2VvbWV0cnkgJiYgKGl4KHRoaXMuc2hhcGVHZW9tZXRyeSksIHRoaXMuc2hhcGVHZW9tZXRyeSA9IG51bGwpLCBFYyhPYmplY3QudmFsdWVzKHRoaXMudHlwZXMpKSwgdGhpcy5jaGlsZHJlbiAmJiAoRWModGhpcy5jaGlsZHJlbiksIHRoaXMuY2xlYXIoKSk7CiAgfQogIGFkZFR5cGUodCwgZSkgewogICAgdGhpcy5hZGQodCksIHRoaXMudHlwZXNbZV0gPSB0LCB0aGlzLnR5cGVzLnZlcnRpY2VzID8gKHRoaXMub3JpZ2luYWxDb2xvciA9IHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwuY29sb3IuY2xvbmUoKSwgdGhpcy5vcmlnaW5hbFdpZHRoID0gdGhpcy50eXBlcy52ZXJ0aWNlcy5tYXRlcmlhbC5zaXplKSA6IHRoaXMudHlwZXMuZWRnZXMgJiYgIXRoaXMudHlwZXMuZnJvbnQgPyAodGhpcy5vcmlnaW5hbENvbG9yID0gdGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC5jb2xvci5jbG9uZSgpLCB0aGlzLm9yaWdpbmFsV2lkdGggPSB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLmxpbmV3aWR0aCkgOiB0aGlzLnR5cGVzLmZyb250ID8gdGhpcy5vcmlnaW5hbENvbG9yID0gdGhpcy50eXBlcy5mcm9udC5tYXRlcmlhbC5jb2xvci5jbG9uZSgpIDogdGhpcy50eXBlcy5iYWNrICYmICh0aGlzLm9yaWdpbmFsQmFja0NvbG9yID0gdGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLmNvbG9yLmNsb25lKCkpOwogIH0KICB3aWRlbih0KSB7CiAgICB0aGlzLnR5cGVzLnZlcnRpY2VzID8gdGhpcy50eXBlcy52ZXJ0aWNlcy5tYXRlcmlhbC5zaXplID0gdCA/IHRoaXMudmVydGV4Rm9jdXNTaXplIDogdGhpcy5pc1NlbGVjdGVkID8gdGhpcy52ZXJ0ZXhGb2N1c1NpemUgLSAyIDogdGhpcy5vcmlnaW5hbFdpZHRoIDogdGhpcy50eXBlcy5lZGdlcyAmJiAodGhpcy50eXBlcy5lZGdlcy5tYXRlcmlhbC5saW5ld2lkdGggPSB0ID8gdGhpcy5lZGdlRm9jdXNXaWR0aCA6IHRoaXMuaXNTZWxlY3RlZCA/IHRoaXMuZWRnZUZvY3VzV2lkdGggLSAyIDogdGhpcy5vcmlnaW5hbFdpZHRoKTsKICB9CiAgdG9nZ2xlU2VsZWN0aW9uKCkgewogICAgY29uc3QgdCA9ICF0aGlzLmlzU2VsZWN0ZWQ7CiAgICB0aGlzLmlzU2VsZWN0ZWQgPSB0LCB0aGlzLmhpZ2hsaWdodCh0KSwgdGhpcy53aWRlbighMSk7CiAgfQogIHVuaGlnaGxpZ2h0KHQpIHsKICAgICghdCB8fCAhdGhpcy5pc1NlbGVjdGVkKSAmJiAodGhpcy5pc1NlbGVjdGVkID0gITEsIHRoaXMuaGlnaGxpZ2h0KCExKSksIHRoaXMud2lkZW4oITEpOwogIH0KICBoaWdobGlnaHQodCkgewogICAgdmFyIGUgPSBudWxsLCBpID0gbnVsbCwgbiA9IG51bGw7CiAgICB0aGlzLnR5cGVzLmZyb250ID8gKGUgPSB0aGlzLnR5cGVzLmZyb250LCBpID0gdGhpcy5pc1NlbGVjdGVkID8gbmV3IEJpKDU0ODA2NzUpIDogbmV3IEJpKDkwMjYwMTkpLCBuID0gdGhpcy5vcmlnaW5hbENvbG9yKSA6IHRoaXMudHlwZXMudmVydGljZXMgPyAoZSA9IHRoaXMudHlwZXMudmVydGljZXMsIGkgPSB0aGlzLmlzU2VsZWN0ZWQgPyBuZXcgQmkoNTQ4MDY3NSkgOiBuZXcgQmkoOTAyNjAxOSksIG4gPSB0aGlzLm9yaWdpbmFsQ29sb3IpIDogdGhpcy50eXBlcy5lZGdlcyAmJiAoZSA9IHRoaXMudHlwZXMuZWRnZXMsIGkgPSB0aGlzLmlzU2VsZWN0ZWQgPyBuZXcgQmkoNTQ4MDY3NSkgOiBuZXcgQmkoOTAyNjAxOSksIG4gPSB0aGlzLm9yaWdpbmFsQ29sb3IpLCBlICE9IG51bGwgJiYgKHRoaXMud2lkZW4odCksIGUubWF0ZXJpYWwuY29sb3IgPSB0ID8gaSA6IG4sIGUubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCksIHRoaXMudHlwZXMuYmFjayAmJiAoZSA9IHRoaXMudHlwZXMuYmFjaywgaSA9IHRoaXMuaXNTZWxlY3RlZCA/IG5ldyBCaSg1NDgwNjc1KSA6IG5ldyBCaSg5MDI2MDE5KSwgbiA9IHRoaXMub3JpZ2luYWxCYWNrQ29sb3IpLCBlICE9IG51bGwgJiYgKGUubWF0ZXJpYWwuY29sb3IgPSB0ID8gaSA6IG4sIGUubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIGNsZWFySGlnaGxpZ2h0cygpIHsKICAgIHRoaXMuaGlnaGxpZ2h0KCExKSwgdGhpcy5pc1NlbGVjdGVkID0gITEsIHRoaXMud2lkZW4oITEpOwogIH0KICBtZXRyaWNzKCkgewogICAgaWYgKHRoaXMudHlwZXMuZnJvbnQpCiAgICAgIHJldHVybiB7IG5hbWU6ICJmYWNlIiwgdmFsdWU6IDAgfTsKICAgIGlmICh0aGlzLnR5cGVzLnZlcnRpY2VzKQogICAgICByZXR1cm4geyBuYW1lOiAidmVydGV4IiwgdmFsdWU6IDAgfTsKICAgIGlmICh0aGlzLnR5cGVzLmVkZ2VzKQogICAgICByZXR1cm4geyBuYW1lOiAiZWRnZSIsIHZhbHVlOiAwIH07CiAgfQogIHNldE1ldGFsbmVzcyh0KSB7CiAgICBmb3IgKHZhciBlIG9mIHRoaXMuY2hpbGRyZW4pCiAgICAgIGUubmFtZS5zdGFydHNXaXRoKCJjbGlwcGluZyIpIHx8IChlLm1hdGVyaWFsLm1ldGFsbmVzcyA9IHQsIGUubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIHNldFJvdWdobmVzcyh0KSB7CiAgICBmb3IgKHZhciBlIG9mIHRoaXMuY2hpbGRyZW4pCiAgICAgIGUubmFtZS5zdGFydHNXaXRoKCJjbGlwcGluZyIpIHx8IChlLm1hdGVyaWFsLnJvdWdobmVzcyA9IHQsIGUubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIHNldFRyYW5zcGFyZW50KHQpIHsKICAgIHRoaXMudHlwZXMuYmFjayAmJiAodGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLm9wYWNpdHkgPSB0ID8gdGhpcy5vcGFjaXR5ICogdGhpcy5hbHBoYSA6IHRoaXMuYWxwaGEsIHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwub3BhY2l0eSA9IHQgPyB0aGlzLm9wYWNpdHkgKiB0aGlzLmFscGhhIDogdGhpcy5hbHBoYSk7CiAgICBmb3IgKHZhciBlIG9mIHRoaXMuY2hpbGRyZW4pCiAgICAgIGUubmFtZS5zdGFydHNXaXRoKCJjbGlwcGluZyIpIHx8IChlLm1hdGVyaWFsLmRlcHRoV3JpdGUgPSB0aGlzLmFscGhhIDwgMSA/ICExIDogIXQsIGUubWF0ZXJpYWwuZGVwdGhUZXN0ID0gITAsIGUubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIHNldEJsYWNrRWRnZXModCkgewogICAgaWYgKHRoaXMudHlwZXMuZWRnZXMpIHsKICAgICAgY29uc3QgZSA9IHQgPyAwIDogdGhpcy5lZGdlX2NvbG9yOwogICAgICB0aGlzLm9yaWdpbmFsQ29sb3IgPSBuZXcgQmkoZSksIHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwuY29sb3IgPSBuZXcgQmkoZSksIHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMDsKICAgIH0KICB9CiAgc2V0RWRnZUNvbG9yKHQpIHsKICAgIHRoaXMudHlwZXMuZWRnZXMgJiYgKHRoaXMuZWRnZV9jb2xvciA9IHQsIHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwuY29sb3IgPSBuZXcgQmkodCksIHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIHNldE9wYWNpdHkodCkgewogICAgKHRoaXMudHlwZXMuZnJvbnQgfHwgdGhpcy50eXBlcy5iYWNrKSAmJiAodGhpcy5vcGFjaXR5ID0gdCwgdGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLm9wYWNpdHkgPSB0aGlzLm9wYWNpdHksIHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwub3BhY2l0eSA9IHRoaXMub3BhY2l0eSwgdGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gITAsIHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSAhMCk7CiAgfQogIHNldFNoYXBlVmlzaWJsZSh0KSB7CiAgICB0aGlzLnR5cGVzLmZyb250ICYmICh0aGlzLnR5cGVzLmZyb250Lm1hdGVyaWFsLnZpc2libGUgPSB0KTsKICAgIGZvciAodmFyIGUgb2YgWyJjbGlwcGluZy0wIiwgImNsaXBwaW5nLTEiLCAiY2xpcHBpbmctMiJdKQogICAgICB0aGlzLnR5cGVzW2VdICYmICh0aGlzLnR5cGVzW2VdLmNoaWxkcmVuWzBdLm1hdGVyaWFsLnZpc2libGUgPSB0LCB0aGlzLnR5cGVzW2VdLmNoaWxkcmVuWzFdLm1hdGVyaWFsLnZpc2libGUgPSB0KTsKICAgIHRoaXMudHlwZXMuYmFjayAmJiB0aGlzLnJlbmRlcmJhY2sgJiYgKHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC52aXNpYmxlID0gdCk7CiAgfQogIHNldEVkZ2VzVmlzaWJsZSh0KSB7CiAgICB0aGlzLnR5cGVzLmVkZ2VzICYmICh0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLnZpc2libGUgPSB0KSwgdGhpcy50eXBlcy52ZXJ0aWNlcyAmJiAodGhpcy50eXBlcy52ZXJ0aWNlcy5tYXRlcmlhbC52aXNpYmxlID0gdCk7CiAgfQogIHNldEJhY2tWaXNpYmxlKHQpIHsKICAgIHRoaXMudHlwZXMuYmFjayAmJiB0aGlzLnR5cGVzLmZyb250Lm1hdGVyaWFsLnZpc2libGUgJiYgKHRoaXMudHlwZXMuYmFjay5tYXRlcmlhbC52aXNpYmxlID0gdGhpcy5yZW5kZXJiYWNrIHx8IHQpOwogIH0KICBnZXRWaXNpYmlsaXR5KCkgewogICAgcmV0dXJuIHRoaXMudHlwZXMuZnJvbnQgPyB0aGlzLnR5cGVzLmVkZ2VzID8gdGhpcy50eXBlcy5mcm9udC5tYXRlcmlhbC52aXNpYmxlIHx8IHRoaXMudHlwZXMuZWRnZXMubWF0ZXJpYWwudmlzaWJsZSA6IHRoaXMudHlwZXMuZnJvbnQubWF0ZXJpYWwudmlzaWJsZSA6IHRoaXMudHlwZXMuZWRnZXMgPyB0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLnZpc2libGUgOiB0aGlzLnR5cGVzLnZlcnRpY2VzID8gdGhpcy50eXBlcy52ZXJ0aWNlcy5tYXRlcmlhbC52aXNpYmxlIDogITE7CiAgfQogIHNldENsaXBJbnRlcnNlY3Rpb24odCkgewogICAgZm9yICh2YXIgZSBvZiB0aGlzLmNoaWxkcmVuKQogICAgICBlLm5hbWUuc3RhcnRzV2l0aCgiY2xpcHBpbmciKSB8fCAoZS5tYXRlcmlhbC5jbGlwSW50ZXJzZWN0aW9uID0gdCwgZS5tYXRlcmlhbC5jbGlwSW50ZXJzZWN0aW9uID0gdCwgZS5tYXRlcmlhbC5jbGlwSW50ZXJzZWN0aW9uID0gdCk7CiAgfQogIHNldENsaXBQbGFuZXModCkgewogICAgdGhpcy50eXBlcy5iYWNrICYmICh0aGlzLnR5cGVzLmJhY2subWF0ZXJpYWwuY2xpcHBpbmdQbGFuZXMgPSB0KSwgdGhpcy50eXBlcy5mcm9udCAmJiAodGhpcy50eXBlcy5mcm9udC5tYXRlcmlhbC5jbGlwcGluZ1BsYW5lcyA9IHQpLCB0aGlzLnR5cGVzLmVkZ2VzICYmICh0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzID0gdCksIHRoaXMudHlwZXMudmVydGljZXMgJiYgKHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwuY2xpcHBpbmdQbGFuZXMgPSB0KSwgdGhpcy51cGRhdGVNYXRlcmlhbHMoITApOwogIH0KICBzZXRQb2x5Z29uT2Zmc2V0KHQpIHsKICAgIHRoaXMudHlwZXMuYmFjayAmJiAodGhpcy50eXBlcy5iYWNrLm1hdGVyaWFsLnBvbHlnb25PZmZzZXRVbml0cyA9IHQpOwogIH0KICBzZXRaU2NhbGUodCkgewogICAgZnVuY3Rpb24gZShpLCBuLCBzLCByID0gITApIHsKICAgICAgZm9yICh2YXIgbyBvZiBpLmNoaWxkcmVuKQogICAgICAgIG8uaXNNZXNoIHx8IG8uaXNMaW5lID8gKG8uc2NhbGUueiA9IHQsIHIgJiYgKG8ucGFyZW50LnBvc2l0aW9uLnogPSBuICogdCkpIDogby5pc0dyb3VwICYmIGUobywgbiwgcywgIW8ubmFtZS5zdGFydHNXaXRoKCJjbGlwcGluZyIpKTsKICAgIH0KICAgICh0aGlzLnR5cGVzLmZyb250IHx8IHRoaXMudHlwZXMuYmFjayB8fCB0aGlzLnR5cGVzLmVkZ2VzKSAmJiBlKHRoaXMsIHRoaXMubWluWiwgdGhpcy5oZWlnaHQpOwogIH0KICB1cGRhdGVNYXRlcmlhbHModCkgewogICAgdGhpcy50eXBlcy5iYWNrICYmICh0aGlzLnR5cGVzLmJhY2subWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0KSwgdGhpcy50eXBlcy5mcm9udCAmJiAodGhpcy50eXBlcy5mcm9udC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHQpLCB0aGlzLnR5cGVzLmVkZ2VzICYmICh0aGlzLnR5cGVzLmVkZ2VzLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdCksIHRoaXMudHlwZXMudmVydGljZXMgJiYgKHRoaXMudHlwZXMudmVydGljZXMubWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0KTsKICB9Cn0KY29uc3QgbTAgPSBuZXcgVXMoKSwgX2ggPSBuZXcgdHQoKTsKY2xhc3MgbnggZXh0ZW5kcyBjQyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpLCB0aGlzLmlzTGluZVNlZ21lbnRzR2VvbWV0cnkgPSAhMCwgdGhpcy50eXBlID0gIkxpbmVTZWdtZW50c0dlb21ldHJ5IjsKICAgIGNvbnN0IHQgPSBbLTEsIDIsIDAsIDEsIDIsIDAsIC0xLCAxLCAwLCAxLCAxLCAwLCAtMSwgMCwgMCwgMSwgMCwgMCwgLTEsIC0xLCAwLCAxLCAtMSwgMF0sIGUgPSBbLTEsIDIsIDEsIDIsIC0xLCAxLCAxLCAxLCAtMSwgLTEsIDEsIC0xLCAtMSwgLTIsIDEsIC0yXSwgaSA9IFswLCAyLCAxLCAyLCAzLCAxLCAyLCA0LCAzLCA0LCA1LCAzLCA0LCA2LCA1LCA2LCA3LCA1XTsKICAgIHRoaXMuc2V0SW5kZXgoaSksIHRoaXMuc2V0QXR0cmlidXRlKCJwb3NpdGlvbiIsIG5ldyB3Yyh0LCAzKSksIHRoaXMuc2V0QXR0cmlidXRlKCJ1diIsIG5ldyB3YyhlLCAyKSk7CiAgfQogIGFwcGx5TWF0cml4NCh0KSB7CiAgICBjb25zdCBlID0gdGhpcy5hdHRyaWJ1dGVzLmluc3RhbmNlU3RhcnQsIGkgPSB0aGlzLmF0dHJpYnV0ZXMuaW5zdGFuY2VFbmQ7CiAgICByZXR1cm4gZSAhPT0gdm9pZCAwICYmIChlLmFwcGx5TWF0cml4NCh0KSwgaS5hcHBseU1hdHJpeDQodCksIGUubmVlZHNVcGRhdGUgPSAhMCksIHRoaXMuYm91bmRpbmdCb3ggIT09IG51bGwgJiYgdGhpcy5jb21wdXRlQm91bmRpbmdCb3goKSwgdGhpcy5ib3VuZGluZ1NwaGVyZSAhPT0gbnVsbCAmJiB0aGlzLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCB0aGlzOwogIH0KICBzZXRQb3NpdGlvbnModCkgewogICAgbGV0IGU7CiAgICB0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5ID8gZSA9IHQgOiBBcnJheS5pc0FycmF5KHQpICYmIChlID0gbmV3IEZsb2F0MzJBcnJheSh0KSk7CiAgICBjb25zdCBpID0gbmV3IGJwKGUsIDYsIDEpOwogICAgcmV0dXJuIHRoaXMuc2V0QXR0cmlidXRlKCJpbnN0YW5jZVN0YXJ0IiwgbmV3IFNzKGksIDMsIDApKSwgdGhpcy5zZXRBdHRyaWJ1dGUoImluc3RhbmNlRW5kIiwgbmV3IFNzKGksIDMsIDMpKSwgdGhpcy5pbnN0YW5jZUNvdW50ID0gdGhpcy5hdHRyaWJ1dGVzLmluc3RhbmNlU3RhcnQuY291bnQsIHRoaXMuY29tcHV0ZUJvdW5kaW5nQm94KCksIHRoaXMuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCksIHRoaXM7CiAgfQogIHNldENvbG9ycyh0KSB7CiAgICBsZXQgZTsKICAgIHQgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgPyBlID0gdCA6IEFycmF5LmlzQXJyYXkodCkgJiYgKGUgPSBuZXcgRmxvYXQzMkFycmF5KHQpKTsKICAgIGNvbnN0IGkgPSBuZXcgYnAoZSwgNiwgMSk7CiAgICByZXR1cm4gdGhpcy5zZXRBdHRyaWJ1dGUoImluc3RhbmNlQ29sb3JTdGFydCIsIG5ldyBTcyhpLCAzLCAwKSksIHRoaXMuc2V0QXR0cmlidXRlKCJpbnN0YW5jZUNvbG9yRW5kIiwgbmV3IFNzKGksIDMsIDMpKSwgdGhpczsKICB9CiAgZnJvbVdpcmVmcmFtZUdlb21ldHJ5KHQpIHsKICAgIHJldHVybiB0aGlzLnNldFBvc2l0aW9ucyh0LmF0dHJpYnV0ZXMucG9zaXRpb24uYXJyYXkpLCB0aGlzOwogIH0KICBmcm9tRWRnZXNHZW9tZXRyeSh0KSB7CiAgICByZXR1cm4gdGhpcy5zZXRQb3NpdGlvbnModC5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5KSwgdGhpczsKICB9CiAgZnJvbU1lc2godCkgewogICAgcmV0dXJuIHRoaXMuZnJvbVdpcmVmcmFtZUdlb21ldHJ5KG5ldyBsQyh0Lmdlb21ldHJ5KSksIHRoaXM7CiAgfQogIGZyb21MaW5lU2VnbWVudHModCkgewogICAgY29uc3QgZSA9IHQuZ2VvbWV0cnk7CiAgICByZXR1cm4gdGhpcy5zZXRQb3NpdGlvbnMoZS5hdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5KSwgdGhpczsKICB9CiAgY29tcHV0ZUJvdW5kaW5nQm94KCkgewogICAgdGhpcy5ib3VuZGluZ0JveCA9PT0gbnVsbCAmJiAodGhpcy5ib3VuZGluZ0JveCA9IG5ldyBVcygpKTsKICAgIGNvbnN0IHQgPSB0aGlzLmF0dHJpYnV0ZXMuaW5zdGFuY2VTdGFydCwgZSA9IHRoaXMuYXR0cmlidXRlcy5pbnN0YW5jZUVuZDsKICAgIHQgIT09IHZvaWQgMCAmJiBlICE9PSB2b2lkIDAgJiYgKHRoaXMuYm91bmRpbmdCb3guc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZSh0KSwgbTAuc2V0RnJvbUJ1ZmZlckF0dHJpYnV0ZShlKSwgdGhpcy5ib3VuZGluZ0JveC51bmlvbihtMCkpOwogIH0KICBjb21wdXRlQm91bmRpbmdTcGhlcmUoKSB7CiAgICB0aGlzLmJvdW5kaW5nU3BoZXJlID09PSBudWxsICYmICh0aGlzLmJvdW5kaW5nU3BoZXJlID0gbmV3IHV1KCkpLCB0aGlzLmJvdW5kaW5nQm94ID09PSBudWxsICYmIHRoaXMuY29tcHV0ZUJvdW5kaW5nQm94KCk7CiAgICBjb25zdCB0ID0gdGhpcy5hdHRyaWJ1dGVzLmluc3RhbmNlU3RhcnQsIGUgPSB0aGlzLmF0dHJpYnV0ZXMuaW5zdGFuY2VFbmQ7CiAgICBpZiAodCAhPT0gdm9pZCAwICYmIGUgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBpID0gdGhpcy5ib3VuZGluZ1NwaGVyZS5jZW50ZXI7CiAgICAgIHRoaXMuYm91bmRpbmdCb3guZ2V0Q2VudGVyKGkpOwogICAgICBsZXQgbiA9IDA7CiAgICAgIGZvciAobGV0IHMgPSAwLCByID0gdC5jb3VudDsgcyA8IHI7IHMrKykKICAgICAgICBfaC5mcm9tQnVmZmVyQXR0cmlidXRlKHQsIHMpLCBuID0gTWF0aC5tYXgobiwgaS5kaXN0YW5jZVRvU3F1YXJlZChfaCkpLCBfaC5mcm9tQnVmZmVyQXR0cmlidXRlKGUsIHMpLCBuID0gTWF0aC5tYXgobiwgaS5kaXN0YW5jZVRvU3F1YXJlZChfaCkpOwogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlLnJhZGl1cyA9IE1hdGguc3FydChuKSwgaXNOYU4odGhpcy5ib3VuZGluZ1NwaGVyZS5yYWRpdXMpICYmIGNvbnNvbGUuZXJyb3IoIlRIUkVFLkxpbmVTZWdtZW50c0dlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOiBDb21wdXRlZCByYWRpdXMgaXMgTmFOLiBUaGUgaW5zdGFuY2VkIHBvc2l0aW9uIGRhdGEgaXMgbGlrZWx5IHRvIGhhdmUgTmFOIHZhbHVlcy4iLCB0aGlzKTsKICAgIH0KICB9CiAgdG9KU09OKCkgewogIH0KICBhcHBseU1hdHJpeCh0KSB7CiAgICByZXR1cm4gY29uc29sZS53YXJuKCJUSFJFRS5MaW5lU2VnbWVudHNHZW9tZXRyeTogYXBwbHlNYXRyaXgoKSBoYXMgYmVlbiByZW5hbWVkIHRvIGFwcGx5TWF0cml4NCgpLiIpLCB0aGlzLmFwcGx5TWF0cml4NCh0KTsKICB9Cn0Kc2kubGluZSA9IHsKICB3b3JsZFVuaXRzOiB7IHZhbHVlOiAxIH0sCiAgbGluZXdpZHRoOiB7IHZhbHVlOiAxIH0sCiAgcmVzb2x1dGlvbjogeyB2YWx1ZTogbmV3IF9pKDEsIDEpIH0sCiAgZGFzaE9mZnNldDogeyB2YWx1ZTogMCB9LAogIGRhc2hTY2FsZTogeyB2YWx1ZTogMSB9LAogIGRhc2hTaXplOiB7IHZhbHVlOiAxIH0sCiAgZ2FwU2l6ZTogeyB2YWx1ZTogMSB9CiAgLy8gdG9kbyBGSVggLSBtYXliZSBjaGFuZ2UgdG8gdG90YWxTaXplCn07CmNhLmxpbmUgPSB7CiAgdW5pZm9ybXM6IGpfLm1lcmdlKFsKICAgIHNpLmNvbW1vbiwKICAgIHNpLmZvZywKICAgIHNpLmxpbmUKICBdKSwKICB2ZXJ0ZXhTaGFkZXI6ICgKICAgIC8qIGdsc2wgKi8KICAgIGAKCQkjaW5jbHVkZSA8Y29tbW9uPgoJCSNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD4KCQkjaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PgoJCSNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD4KCQkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4PgoKCQl1bmlmb3JtIGZsb2F0IGxpbmV3aWR0aDsKCQl1bmlmb3JtIHZlYzIgcmVzb2x1dGlvbjsKCgkJYXR0cmlidXRlIHZlYzMgaW5zdGFuY2VTdGFydDsKCQlhdHRyaWJ1dGUgdmVjMyBpbnN0YW5jZUVuZDsKCgkJYXR0cmlidXRlIHZlYzMgaW5zdGFuY2VDb2xvclN0YXJ0OwoJCWF0dHJpYnV0ZSB2ZWMzIGluc3RhbmNlQ29sb3JFbmQ7CgoJCSNpZmRlZiBXT1JMRF9VTklUUwoKCQkJdmFyeWluZyB2ZWM0IHdvcmxkUG9zOwoJCQl2YXJ5aW5nIHZlYzMgd29ybGRTdGFydDsKCQkJdmFyeWluZyB2ZWMzIHdvcmxkRW5kOwoKCQkJI2lmZGVmIFVTRV9EQVNICgoJCQkJdmFyeWluZyB2ZWMyIHZVdjsKCgkJCSNlbmRpZgoKCQkjZWxzZQoKCQkJdmFyeWluZyB2ZWMyIHZVdjsKCgkJI2VuZGlmCgoJCSNpZmRlZiBVU0VfREFTSAoKCQkJdW5pZm9ybSBmbG9hdCBkYXNoU2NhbGU7CgkJCWF0dHJpYnV0ZSBmbG9hdCBpbnN0YW5jZURpc3RhbmNlU3RhcnQ7CgkJCWF0dHJpYnV0ZSBmbG9hdCBpbnN0YW5jZURpc3RhbmNlRW5kOwoJCQl2YXJ5aW5nIGZsb2F0IHZMaW5lRGlzdGFuY2U7CgoJCSNlbmRpZgoKCQl2b2lkIHRyaW1TZWdtZW50KCBjb25zdCBpbiB2ZWM0IHN0YXJ0LCBpbm91dCB2ZWM0IGVuZCApIHsKCgkJCS8vIHRyaW0gZW5kIHNlZ21lbnQgc28gaXQgdGVybWluYXRlcyBiZXR3ZWVuIHRoZSBjYW1lcmEgcGxhbmUgYW5kIHRoZSBuZWFyIHBsYW5lCgoJCQkvLyBjb25zZXJ2YXRpdmUgZXN0aW1hdGUgb2YgdGhlIG5lYXIgcGxhbmUKCQkJZmxvYXQgYSA9IHByb2plY3Rpb25NYXRyaXhbIDIgXVsgMiBdOyAvLyAzbmQgZW50cnkgaW4gM3RoIGNvbHVtbgoJCQlmbG9hdCBiID0gcHJvamVjdGlvbk1hdHJpeFsgMyBdWyAyIF07IC8vIDNuZCBlbnRyeSBpbiA0dGggY29sdW1uCgkJCWZsb2F0IG5lYXJFc3RpbWF0ZSA9IC0gMC41ICogYiAvIGE7CgoJCQlmbG9hdCBhbHBoYSA9ICggbmVhckVzdGltYXRlIC0gc3RhcnQueiApIC8gKCBlbmQueiAtIHN0YXJ0LnogKTsKCgkJCWVuZC54eXogPSBtaXgoIHN0YXJ0Lnh5eiwgZW5kLnh5eiwgYWxwaGEgKTsKCgkJfQoKCQl2b2lkIG1haW4oKSB7CgoJCQkjaWZkZWYgVVNFX0NPTE9SCgoJCQkJdkNvbG9yLnh5eiA9ICggcG9zaXRpb24ueSA8IDAuNSApID8gaW5zdGFuY2VDb2xvclN0YXJ0IDogaW5zdGFuY2VDb2xvckVuZDsKCgkJCSNlbmRpZgoKCQkJI2lmZGVmIFVTRV9EQVNICgoJCQkJdkxpbmVEaXN0YW5jZSA9ICggcG9zaXRpb24ueSA8IDAuNSApID8gZGFzaFNjYWxlICogaW5zdGFuY2VEaXN0YW5jZVN0YXJ0IDogZGFzaFNjYWxlICogaW5zdGFuY2VEaXN0YW5jZUVuZDsKCQkJCXZVdiA9IHV2OwoKCQkJI2VuZGlmCgoJCQlmbG9hdCBhc3BlY3QgPSByZXNvbHV0aW9uLnggLyByZXNvbHV0aW9uLnk7CgoJCQkvLyBjYW1lcmEgc3BhY2UKCQkJdmVjNCBzdGFydCA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQoIGluc3RhbmNlU3RhcnQsIDEuMCApOwoJCQl2ZWM0IGVuZCA9IG1vZGVsVmlld01hdHJpeCAqIHZlYzQoIGluc3RhbmNlRW5kLCAxLjAgKTsKCgkJCSNpZmRlZiBXT1JMRF9VTklUUwoKCQkJCXdvcmxkU3RhcnQgPSBzdGFydC54eXo7CgkJCQl3b3JsZEVuZCA9IGVuZC54eXo7CgoJCQkjZWxzZQoKCQkJCXZVdiA9IHV2OwoKCQkJI2VuZGlmCgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIHBlcnNwZWN0aXZlIHByb2plY3Rpb24sIGFuZCBzZWdtZW50cyB0aGF0IHRlcm1pbmF0ZSBlaXRoZXIgaW4sIG9yIGJlaGluZCwgdGhlIGNhbWVyYSBwbGFuZQoJCQkvLyBjbGVhcmx5IHRoZSBncHUgZmlybXdhcmUgaGFzIGEgd2F5IG9mIGFkZHJlc3NpbmcgdGhpcyBpc3N1ZSB3aGVuIHByb2plY3RpbmcgaW50byBuZGMgc3BhY2UKCQkJLy8gYnV0IHdlIG5lZWQgdG8gcGVyZm9ybSBuZGMtc3BhY2UgY2FsY3VsYXRpb25zIGluIHRoZSBzaGFkZXIsIHNvIHdlIG11c3QgYWRkcmVzcyB0aGlzIGlzc3VlIGRpcmVjdGx5CgkJCS8vIHBlcmhhcHMgdGhlcmUgaXMgYSBtb3JlIGVsZWdhbnQgc29sdXRpb24gLS0gV2VzdExhbmdsZXkKCgkJCWJvb2wgcGVyc3BlY3RpdmUgPSAoIHByb2plY3Rpb25NYXRyaXhbIDIgXVsgMyBdID09IC0gMS4wICk7IC8vIDR0aCBlbnRyeSBpbiB0aGUgM3JkIGNvbHVtbgoKCQkJaWYgKCBwZXJzcGVjdGl2ZSApIHsKCgkJCQlpZiAoIHN0YXJ0LnogPCAwLjAgJiYgZW5kLnogPj0gMC4wICkgewoKCQkJCQl0cmltU2VnbWVudCggc3RhcnQsIGVuZCApOwoKCQkJCX0gZWxzZSBpZiAoIGVuZC56IDwgMC4wICYmIHN0YXJ0LnogPj0gMC4wICkgewoKCQkJCQl0cmltU2VnbWVudCggZW5kLCBzdGFydCApOwoKCQkJCX0KCgkJCX0KCgkJCS8vIGNsaXAgc3BhY2UKCQkJdmVjNCBjbGlwU3RhcnQgPSBwcm9qZWN0aW9uTWF0cml4ICogc3RhcnQ7CgkJCXZlYzQgY2xpcEVuZCA9IHByb2plY3Rpb25NYXRyaXggKiBlbmQ7CgoJCQkvLyBuZGMgc3BhY2UKCQkJdmVjMyBuZGNTdGFydCA9IGNsaXBTdGFydC54eXogLyBjbGlwU3RhcnQudzsKCQkJdmVjMyBuZGNFbmQgPSBjbGlwRW5kLnh5eiAvIGNsaXBFbmQudzsKCgkJCS8vIGRpcmVjdGlvbgoJCQl2ZWMyIGRpciA9IG5kY0VuZC54eSAtIG5kY1N0YXJ0Lnh5OwoKCQkJLy8gYWNjb3VudCBmb3IgY2xpcC1zcGFjZSBhc3BlY3QgcmF0aW8KCQkJZGlyLnggKj0gYXNwZWN0OwoJCQlkaXIgPSBub3JtYWxpemUoIGRpciApOwoKCQkJI2lmZGVmIFdPUkxEX1VOSVRTCgoJCQkJdmVjMyB3b3JsZERpciA9IG5vcm1hbGl6ZSggZW5kLnh5eiAtIHN0YXJ0Lnh5eiApOwoJCQkJdmVjMyB0bXBGd2QgPSBub3JtYWxpemUoIG1peCggc3RhcnQueHl6LCBlbmQueHl6LCAwLjUgKSApOwoJCQkJdmVjMyB3b3JsZFVwID0gbm9ybWFsaXplKCBjcm9zcyggd29ybGREaXIsIHRtcEZ3ZCApICk7CgkJCQl2ZWMzIHdvcmxkRndkID0gY3Jvc3MoIHdvcmxkRGlyLCB3b3JsZFVwICk7CgkJCQl3b3JsZFBvcyA9IHBvc2l0aW9uLnkgPCAwLjUgPyBzdGFydDogZW5kOwoKCQkJCS8vIGhlaWdodCBvZmZzZXQKCQkJCWZsb2F0IGh3ID0gbGluZXdpZHRoICogMC41OwoJCQkJd29ybGRQb3MueHl6ICs9IHBvc2l0aW9uLnggPCAwLjAgPyBodyAqIHdvcmxkVXAgOiAtIGh3ICogd29ybGRVcDsKCgkJCQkvLyBkb24ndCBleHRlbmQgdGhlIGxpbmUgaWYgd2UncmUgcmVuZGVyaW5nIGRhc2hlcyBiZWNhdXNlIHdlCgkJCQkvLyB3b24ndCBiZSByZW5kZXJpbmcgdGhlIGVuZGNhcHMKCQkJCSNpZm5kZWYgVVNFX0RBU0gKCgkJCQkJLy8gY2FwIGV4dGVuc2lvbgoJCQkJCXdvcmxkUG9zLnh5eiArPSBwb3NpdGlvbi55IDwgMC41ID8gLSBodyAqIHdvcmxkRGlyIDogaHcgKiB3b3JsZERpcjsKCgkJCQkJLy8gYWRkIHdpZHRoIHRvIHRoZSBib3gKCQkJCQl3b3JsZFBvcy54eXogKz0gd29ybGRGd2QgKiBodzsKCgkJCQkJLy8gZW5kY2FwcwoJCQkJCWlmICggcG9zaXRpb24ueSA+IDEuMCB8fCBwb3NpdGlvbi55IDwgMC4wICkgewoKCQkJCQkJd29ybGRQb3MueHl6IC09IHdvcmxkRndkICogMi4wICogaHc7CgoJCQkJCX0KCgkJCQkjZW5kaWYKCgkJCQkvLyBwcm9qZWN0IHRoZSB3b3JsZHBvcwoJCQkJdmVjNCBjbGlwID0gcHJvamVjdGlvbk1hdHJpeCAqIHdvcmxkUG9zOwoKCQkJCS8vIHNoaWZ0IHRoZSBkZXB0aCBvZiB0aGUgcHJvamVjdGVkIHBvaW50cyBzbyB0aGUgbGluZQoJCQkJLy8gc2VnbWVudHMgb3ZlcmxhcCBuZWF0bHkKCQkJCXZlYzMgY2xpcFBvc2UgPSAoIHBvc2l0aW9uLnkgPCAwLjUgKSA/IG5kY1N0YXJ0IDogbmRjRW5kOwoJCQkJY2xpcC56ID0gY2xpcFBvc2UueiAqIGNsaXAudzsKCgkJCSNlbHNlCgoJCQkJdmVjMiBvZmZzZXQgPSB2ZWMyKCBkaXIueSwgLSBkaXIueCApOwoJCQkJLy8gdW5kbyBhc3BlY3QgcmF0aW8gYWRqdXN0bWVudAoJCQkJZGlyLnggLz0gYXNwZWN0OwoJCQkJb2Zmc2V0LnggLz0gYXNwZWN0OwoKCQkJCS8vIHNpZ24gZmxpcAoJCQkJaWYgKCBwb3NpdGlvbi54IDwgMC4wICkgb2Zmc2V0ICo9IC0gMS4wOwoKCQkJCS8vIGVuZGNhcHMKCQkJCWlmICggcG9zaXRpb24ueSA8IDAuMCApIHsKCgkJCQkJb2Zmc2V0ICs9IC0gZGlyOwoKCQkJCX0gZWxzZSBpZiAoIHBvc2l0aW9uLnkgPiAxLjAgKSB7CgoJCQkJCW9mZnNldCArPSBkaXI7CgoJCQkJfQoKCQkJCS8vIGFkanVzdCBmb3IgbGluZXdpZHRoCgkJCQlvZmZzZXQgKj0gbGluZXdpZHRoOwoKCQkJCS8vIGFkanVzdCBmb3IgY2xpcC1zcGFjZSB0byBzY3JlZW4tc3BhY2UgY29udmVyc2lvbiAvLyBtYXliZSByZXNvbHV0aW9uIHNob3VsZCBiZSBiYXNlZCBvbiB2aWV3cG9ydCAuLi4KCQkJCW9mZnNldCAvPSByZXNvbHV0aW9uLnk7CgoJCQkJLy8gc2VsZWN0IGVuZAoJCQkJdmVjNCBjbGlwID0gKCBwb3NpdGlvbi55IDwgMC41ICkgPyBjbGlwU3RhcnQgOiBjbGlwRW5kOwoKCQkJCS8vIGJhY2sgdG8gY2xpcCBzcGFjZQoJCQkJb2Zmc2V0ICo9IGNsaXAudzsKCgkJCQljbGlwLnh5ICs9IG9mZnNldDsKCgkJCSNlbmRpZgoKCQkJZ2xfUG9zaXRpb24gPSBjbGlwOwoKCQkJdmVjNCBtdlBvc2l0aW9uID0gKCBwb3NpdGlvbi55IDwgMC41ICkgPyBzdGFydCA6IGVuZDsgLy8gdGhpcyBpcyBhbiBhcHByb3hpbWF0aW9uCgoJCQkjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PgoJCQkjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD4KCQkJI2luY2x1ZGUgPGZvZ192ZXJ0ZXg+CgoJCX0KCQlgCiAgKSwKICBmcmFnbWVudFNoYWRlcjogKAogICAgLyogZ2xzbCAqLwogICAgYAoJCXVuaWZvcm0gdmVjMyBkaWZmdXNlOwoJCXVuaWZvcm0gZmxvYXQgb3BhY2l0eTsKCQl1bmlmb3JtIGZsb2F0IGxpbmV3aWR0aDsKCgkJI2lmZGVmIFVTRV9EQVNICgoJCQl1bmlmb3JtIGZsb2F0IGRhc2hPZmZzZXQ7CgkJCXVuaWZvcm0gZmxvYXQgZGFzaFNpemU7CgkJCXVuaWZvcm0gZmxvYXQgZ2FwU2l6ZTsKCgkJI2VuZGlmCgoJCXZhcnlpbmcgZmxvYXQgdkxpbmVEaXN0YW5jZTsKCgkJI2lmZGVmIFdPUkxEX1VOSVRTCgoJCQl2YXJ5aW5nIHZlYzQgd29ybGRQb3M7CgkJCXZhcnlpbmcgdmVjMyB3b3JsZFN0YXJ0OwoJCQl2YXJ5aW5nIHZlYzMgd29ybGRFbmQ7CgoJCQkjaWZkZWYgVVNFX0RBU0gKCgkJCQl2YXJ5aW5nIHZlYzIgdlV2OwoKCQkJI2VuZGlmCgoJCSNlbHNlCgoJCQl2YXJ5aW5nIHZlYzIgdlV2OwoKCQkjZW5kaWYKCgkJI2luY2x1ZGUgPGNvbW1vbj4KCQkjaW5jbHVkZSA8Y29sb3JfcGFyc19mcmFnbWVudD4KCQkjaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+CgkJI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+CgkJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50PgoKCQl2ZWMyIGNsb3Nlc3RMaW5lVG9MaW5lKHZlYzMgcDEsIHZlYzMgcDIsIHZlYzMgcDMsIHZlYzMgcDQpIHsKCgkJCWZsb2F0IG11YTsKCQkJZmxvYXQgbXViOwoKCQkJdmVjMyBwMTMgPSBwMSAtIHAzOwoJCQl2ZWMzIHA0MyA9IHA0IC0gcDM7CgoJCQl2ZWMzIHAyMSA9IHAyIC0gcDE7CgoJCQlmbG9hdCBkMTM0MyA9IGRvdCggcDEzLCBwNDMgKTsKCQkJZmxvYXQgZDQzMjEgPSBkb3QoIHA0MywgcDIxICk7CgkJCWZsb2F0IGQxMzIxID0gZG90KCBwMTMsIHAyMSApOwoJCQlmbG9hdCBkNDM0MyA9IGRvdCggcDQzLCBwNDMgKTsKCQkJZmxvYXQgZDIxMjEgPSBkb3QoIHAyMSwgcDIxICk7CgoJCQlmbG9hdCBkZW5vbSA9IGQyMTIxICogZDQzNDMgLSBkNDMyMSAqIGQ0MzIxOwoKCQkJZmxvYXQgbnVtZXIgPSBkMTM0MyAqIGQ0MzIxIC0gZDEzMjEgKiBkNDM0MzsKCgkJCW11YSA9IG51bWVyIC8gZGVub207CgkJCW11YSA9IGNsYW1wKCBtdWEsIDAuMCwgMS4wICk7CgkJCW11YiA9ICggZDEzNDMgKyBkNDMyMSAqICggbXVhICkgKSAvIGQ0MzQzOwoJCQltdWIgPSBjbGFtcCggbXViLCAwLjAsIDEuMCApOwoKCQkJcmV0dXJuIHZlYzIoIG11YSwgbXViICk7CgoJCX0KCgkJdm9pZCBtYWluKCkgewoKCQkJI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD4KCgkJCSNpZmRlZiBVU0VfREFTSAoKCQkJCWlmICggdlV2LnkgPCAtIDEuMCB8fCB2VXYueSA+IDEuMCApIGRpc2NhcmQ7IC8vIGRpc2NhcmQgZW5kY2FwcwoKCQkJCWlmICggbW9kKCB2TGluZURpc3RhbmNlICsgZGFzaE9mZnNldCwgZGFzaFNpemUgKyBnYXBTaXplICkgPiBkYXNoU2l6ZSApIGRpc2NhcmQ7IC8vIHRvZG8gLSBGSVgKCgkJCSNlbmRpZgoKCQkJZmxvYXQgYWxwaGEgPSBvcGFjaXR5OwoKCQkJI2lmZGVmIFdPUkxEX1VOSVRTCgoJCQkJLy8gRmluZCB0aGUgY2xvc2VzdCBwb2ludHMgb24gdGhlIHZpZXcgcmF5IGFuZCB0aGUgbGluZSBzZWdtZW50CgkJCQl2ZWMzIHJheUVuZCA9IG5vcm1hbGl6ZSggd29ybGRQb3MueHl6ICkgKiAxZTU7CgkJCQl2ZWMzIGxpbmVEaXIgPSB3b3JsZEVuZCAtIHdvcmxkU3RhcnQ7CgkJCQl2ZWMyIHBhcmFtcyA9IGNsb3Nlc3RMaW5lVG9MaW5lKCB3b3JsZFN0YXJ0LCB3b3JsZEVuZCwgdmVjMyggMC4wLCAwLjAsIDAuMCApLCByYXlFbmQgKTsKCgkJCQl2ZWMzIHAxID0gd29ybGRTdGFydCArIGxpbmVEaXIgKiBwYXJhbXMueDsKCQkJCXZlYzMgcDIgPSByYXlFbmQgKiBwYXJhbXMueTsKCQkJCXZlYzMgZGVsdGEgPSBwMSAtIHAyOwoJCQkJZmxvYXQgbGVuID0gbGVuZ3RoKCBkZWx0YSApOwoJCQkJZmxvYXQgbm9ybSA9IGxlbiAvIGxpbmV3aWR0aDsKCgkJCQkjaWZuZGVmIFVTRV9EQVNICgoJCQkJCSNpZmRlZiBVU0VfQUxQSEFfVE9fQ09WRVJBR0UKCgkJCQkJCWZsb2F0IGRub3JtID0gZndpZHRoKCBub3JtICk7CgkJCQkJCWFscGhhID0gMS4wIC0gc21vb3Roc3RlcCggMC41IC0gZG5vcm0sIDAuNSArIGRub3JtLCBub3JtICk7CgoJCQkJCSNlbHNlCgoJCQkJCQlpZiAoIG5vcm0gPiAwLjUgKSB7CgoJCQkJCQkJZGlzY2FyZDsKCgkJCQkJCX0KCgkJCQkJI2VuZGlmCgoJCQkJI2VuZGlmCgoJCQkjZWxzZQoKCQkJCSNpZmRlZiBVU0VfQUxQSEFfVE9fQ09WRVJBR0UKCgkJCQkJLy8gYXJ0aWZhY3RzIGFwcGVhciBvbiBzb21lIGhhcmR3YXJlIGlmIGEgZGVyaXZhdGl2ZSBpcyB0YWtlbiB3aXRoaW4gYSBjb25kaXRpb25hbAoJCQkJCWZsb2F0IGEgPSB2VXYueDsKCQkJCQlmbG9hdCBiID0gKCB2VXYueSA+IDAuMCApID8gdlV2LnkgLSAxLjAgOiB2VXYueSArIDEuMDsKCQkJCQlmbG9hdCBsZW4yID0gYSAqIGEgKyBiICogYjsKCQkJCQlmbG9hdCBkbGVuID0gZndpZHRoKCBsZW4yICk7CgoJCQkJCWlmICggYWJzKCB2VXYueSApID4gMS4wICkgewoKCQkJCQkJYWxwaGEgPSAxLjAgLSBzbW9vdGhzdGVwKCAxLjAgLSBkbGVuLCAxLjAgKyBkbGVuLCBsZW4yICk7CgoJCQkJCX0KCgkJCQkjZWxzZQoKCQkJCQlpZiAoIGFicyggdlV2LnkgKSA+IDEuMCApIHsKCgkJCQkJCWZsb2F0IGEgPSB2VXYueDsKCQkJCQkJZmxvYXQgYiA9ICggdlV2LnkgPiAwLjAgKSA/IHZVdi55IC0gMS4wIDogdlV2LnkgKyAxLjA7CgkJCQkJCWZsb2F0IGxlbjIgPSBhICogYSArIGIgKiBiOwoKCQkJCQkJaWYgKCBsZW4yID4gMS4wICkgZGlzY2FyZDsKCgkJCQkJfQoKCQkJCSNlbmRpZgoKCQkJI2VuZGlmCgoJCQl2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIGFscGhhICk7CgoJCQkjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+CgkJCSNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD4KCgkJCWdsX0ZyYWdDb2xvciA9IHZlYzQoIGRpZmZ1c2VDb2xvci5yZ2IsIGFscGhhICk7CgoJCQkjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+CgkJCSNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PgoJCQkjaW5jbHVkZSA8Zm9nX2ZyYWdtZW50PgoJCQkjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD4KCgkJfQoJCWAKICApCn07CmNsYXNzIHN4IGV4dGVuZHMgbkMgewogIHN0YXRpYyBnZXQgdHlwZSgpIHsKICAgIHJldHVybiAiTGluZU1hdGVyaWFsIjsKICB9CiAgY29uc3RydWN0b3IodCkgewogICAgc3VwZXIoewogICAgICB1bmlmb3Jtczogal8uY2xvbmUoY2EubGluZS51bmlmb3JtcyksCiAgICAgIHZlcnRleFNoYWRlcjogY2EubGluZS52ZXJ0ZXhTaGFkZXIsCiAgICAgIGZyYWdtZW50U2hhZGVyOiBjYS5saW5lLmZyYWdtZW50U2hhZGVyLAogICAgICBjbGlwcGluZzogITAKICAgICAgLy8gcmVxdWlyZWQgZm9yIGNsaXBwaW5nIHN1cHBvcnQKICAgIH0pLCB0aGlzLmlzTGluZU1hdGVyaWFsID0gITAsIHRoaXMuc2V0VmFsdWVzKHQpOwogIH0KICBnZXQgY29sb3IoKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5kaWZmdXNlLnZhbHVlOwogIH0KICBzZXQgY29sb3IodCkgewogICAgdGhpcy51bmlmb3Jtcy5kaWZmdXNlLnZhbHVlID0gdDsKICB9CiAgZ2V0IHdvcmxkVW5pdHMoKSB7CiAgICByZXR1cm4gIldPUkxEX1VOSVRTIiBpbiB0aGlzLmRlZmluZXM7CiAgfQogIHNldCB3b3JsZFVuaXRzKHQpIHsKICAgIHQgPT09ICEwID8gdGhpcy5kZWZpbmVzLldPUkxEX1VOSVRTID0gIiIgOiBkZWxldGUgdGhpcy5kZWZpbmVzLldPUkxEX1VOSVRTOwogIH0KICBnZXQgbGluZXdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMudW5pZm9ybXMubGluZXdpZHRoLnZhbHVlOwogIH0KICBzZXQgbGluZXdpZHRoKHQpIHsKICAgIHRoaXMudW5pZm9ybXMubGluZXdpZHRoICYmICh0aGlzLnVuaWZvcm1zLmxpbmV3aWR0aC52YWx1ZSA9IHQpOwogIH0KICBnZXQgZGFzaGVkKCkgewogICAgcmV0dXJuICJVU0VfREFTSCIgaW4gdGhpcy5kZWZpbmVzOwogIH0KICBzZXQgZGFzaGVkKHQpIHsKICAgIHQgPT09ICEwICE9PSB0aGlzLmRhc2hlZCAmJiAodGhpcy5uZWVkc1VwZGF0ZSA9ICEwKSwgdCA9PT0gITAgPyB0aGlzLmRlZmluZXMuVVNFX0RBU0ggPSAiIiA6IGRlbGV0ZSB0aGlzLmRlZmluZXMuVVNFX0RBU0g7CiAgfQogIGdldCBkYXNoU2NhbGUoKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5kYXNoU2NhbGUudmFsdWU7CiAgfQogIHNldCBkYXNoU2NhbGUodCkgewogICAgdGhpcy51bmlmb3Jtcy5kYXNoU2NhbGUudmFsdWUgPSB0OwogIH0KICBnZXQgZGFzaFNpemUoKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5kYXNoU2l6ZS52YWx1ZTsKICB9CiAgc2V0IGRhc2hTaXplKHQpIHsKICAgIHRoaXMudW5pZm9ybXMuZGFzaFNpemUudmFsdWUgPSB0OwogIH0KICBnZXQgZGFzaE9mZnNldCgpIHsKICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmRhc2hPZmZzZXQudmFsdWU7CiAgfQogIHNldCBkYXNoT2Zmc2V0KHQpIHsKICAgIHRoaXMudW5pZm9ybXMuZGFzaE9mZnNldC52YWx1ZSA9IHQ7CiAgfQogIGdldCBnYXBTaXplKCkgewogICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuZ2FwU2l6ZS52YWx1ZTsKICB9CiAgc2V0IGdhcFNpemUodCkgewogICAgdGhpcy51bmlmb3Jtcy5nYXBTaXplLnZhbHVlID0gdDsKICB9CiAgZ2V0IG9wYWNpdHkoKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5vcGFjaXR5LnZhbHVlOwogIH0KICBzZXQgb3BhY2l0eSh0KSB7CiAgICB0aGlzLnVuaWZvcm1zICYmICh0aGlzLnVuaWZvcm1zLm9wYWNpdHkudmFsdWUgPSB0KTsKICB9CiAgZ2V0IHJlc29sdXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlOwogIH0KICBzZXQgcmVzb2x1dGlvbih0KSB7CiAgICB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUuY29weSh0KTsKICB9CiAgZ2V0IGFscGhhVG9Db3ZlcmFnZSgpIHsKICAgIHJldHVybiAiVVNFX0FMUEhBX1RPX0NPVkVSQUdFIiBpbiB0aGlzLmRlZmluZXM7CiAgfQogIHNldCBhbHBoYVRvQ292ZXJhZ2UodCkgewogICAgdGhpcy5kZWZpbmVzICYmICh0ID09PSAhMCAhPT0gdGhpcy5hbHBoYVRvQ292ZXJhZ2UgJiYgKHRoaXMubmVlZHNVcGRhdGUgPSAhMCksIHQgPT09ICEwID8gdGhpcy5kZWZpbmVzLlVTRV9BTFBIQV9UT19DT1ZFUkFHRSA9ICIiIDogZGVsZXRlIHRoaXMuZGVmaW5lcy5VU0VfQUxQSEFfVE9fQ09WRVJBR0UpOwogIH0KfQpjb25zdCBXZCA9IG5ldyBQbigpLCBnMCA9IG5ldyB0dCgpLCB5MCA9IG5ldyB0dCgpLCBxZSA9IG5ldyBQbigpLCAkZSA9IG5ldyBQbigpLCBibiA9IG5ldyBQbigpLCBxZCA9IG5ldyB0dCgpLCAkZCA9IG5ldyBRbigpLCBZZSA9IG5ldyB1QygpLCBfMCA9IG5ldyB0dCgpLCB4aCA9IG5ldyBVcygpLCB2aCA9IG5ldyB1dSgpLCBNbiA9IG5ldyBQbigpOwpsZXQgQW4sIGRyOwpmdW5jdGlvbiB4MChhLCB0LCBlKSB7CiAgcmV0dXJuIE1uLnNldCgwLCAwLCAtdCwgMSkuYXBwbHlNYXRyaXg0KGEucHJvamVjdGlvbk1hdHJpeCksIE1uLm11bHRpcGx5U2NhbGFyKDEgLyBNbi53KSwgTW4ueCA9IGRyIC8gZS53aWR0aCwgTW4ueSA9IGRyIC8gZS5oZWlnaHQsIE1uLmFwcGx5TWF0cml4NChhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlKSwgTW4ubXVsdGlwbHlTY2FsYXIoMSAvIE1uLncpLCBNYXRoLmFicyhNYXRoLm1heChNbi54LCBNbi55KSk7Cn0KZnVuY3Rpb24gTEMoYSwgdCkgewogIGNvbnN0IGUgPSBhLm1hdHJpeFdvcmxkLCBpID0gYS5nZW9tZXRyeSwgbiA9IGkuYXR0cmlidXRlcy5pbnN0YW5jZVN0YXJ0LCBzID0gaS5hdHRyaWJ1dGVzLmluc3RhbmNlRW5kLCByID0gTWF0aC5taW4oaS5pbnN0YW5jZUNvdW50LCBuLmNvdW50KTsKICBmb3IgKGxldCBvID0gMCwgbCA9IHI7IG8gPCBsOyBvKyspIHsKICAgIFllLnN0YXJ0LmZyb21CdWZmZXJBdHRyaWJ1dGUobiwgbyksIFllLmVuZC5mcm9tQnVmZmVyQXR0cmlidXRlKHMsIG8pLCBZZS5hcHBseU1hdHJpeDQoZSk7CiAgICBjb25zdCBoID0gbmV3IHR0KCksIGMgPSBuZXcgdHQoKTsKICAgIEFuLmRpc3RhbmNlU3FUb1NlZ21lbnQoWWUuc3RhcnQsIFllLmVuZCwgYywgaCksIGMuZGlzdGFuY2VUbyhoKSA8IGRyICogMC41ICYmIHQucHVzaCh7CiAgICAgIHBvaW50OiBjLAogICAgICBwb2ludE9uTGluZTogaCwKICAgICAgZGlzdGFuY2U6IEFuLm9yaWdpbi5kaXN0YW5jZVRvKGMpLAogICAgICBvYmplY3Q6IGEsCiAgICAgIGZhY2U6IG51bGwsCiAgICAgIGZhY2VJbmRleDogbywKICAgICAgdXY6IG51bGwsCiAgICAgIHV2MTogbnVsbAogICAgfSk7CiAgfQp9CmZ1bmN0aW9uIERDKGEsIHQsIGUpIHsKICBjb25zdCBpID0gdC5wcm9qZWN0aW9uTWF0cml4LCBzID0gYS5tYXRlcmlhbC5yZXNvbHV0aW9uLCByID0gYS5tYXRyaXhXb3JsZCwgbyA9IGEuZ2VvbWV0cnksIGwgPSBvLmF0dHJpYnV0ZXMuaW5zdGFuY2VTdGFydCwgaCA9IG8uYXR0cmlidXRlcy5pbnN0YW5jZUVuZCwgYyA9IE1hdGgubWluKG8uaW5zdGFuY2VDb3VudCwgbC5jb3VudCksIHUgPSAtdC5uZWFyOwogIEFuLmF0KDEsIGJuKSwgYm4udyA9IDEsIGJuLmFwcGx5TWF0cml4NCh0Lm1hdHJpeFdvcmxkSW52ZXJzZSksIGJuLmFwcGx5TWF0cml4NChpKSwgYm4ubXVsdGlwbHlTY2FsYXIoMSAvIGJuLncpLCBibi54ICo9IHMueCAvIDIsIGJuLnkgKj0gcy55IC8gMiwgYm4ueiA9IDAsIHFkLmNvcHkoYm4pLCAkZC5tdWx0aXBseU1hdHJpY2VzKHQubWF0cml4V29ybGRJbnZlcnNlLCByKTsKICBmb3IgKGxldCBkID0gMCwgcCA9IGM7IGQgPCBwOyBkKyspIHsKICAgIGlmIChxZS5mcm9tQnVmZmVyQXR0cmlidXRlKGwsIGQpLCAkZS5mcm9tQnVmZmVyQXR0cmlidXRlKGgsIGQpLCBxZS53ID0gMSwgJGUudyA9IDEsIHFlLmFwcGx5TWF0cml4NCgkZCksICRlLmFwcGx5TWF0cml4NCgkZCksIHFlLnogPiB1ICYmICRlLnogPiB1KQogICAgICBjb250aW51ZTsKICAgIGlmIChxZS56ID4gdSkgewogICAgICBjb25zdCB4ID0gcWUueiAtICRlLnosIF8gPSAocWUueiAtIHUpIC8geDsKICAgICAgcWUubGVycCgkZSwgXyk7CiAgICB9IGVsc2UgaWYgKCRlLnogPiB1KSB7CiAgICAgIGNvbnN0IHggPSAkZS56IC0gcWUueiwgXyA9ICgkZS56IC0gdSkgLyB4OwogICAgICAkZS5sZXJwKHFlLCBfKTsKICAgIH0KICAgIHFlLmFwcGx5TWF0cml4NChpKSwgJGUuYXBwbHlNYXRyaXg0KGkpLCBxZS5tdWx0aXBseVNjYWxhcigxIC8gcWUudyksICRlLm11bHRpcGx5U2NhbGFyKDEgLyAkZS53KSwgcWUueCAqPSBzLnggLyAyLCBxZS55ICo9IHMueSAvIDIsICRlLnggKj0gcy54IC8gMiwgJGUueSAqPSBzLnkgLyAyLCBZZS5zdGFydC5jb3B5KHFlKSwgWWUuc3RhcnQueiA9IDAsIFllLmVuZC5jb3B5KCRlKSwgWWUuZW5kLnogPSAwOwogICAgY29uc3QgeSA9IFllLmNsb3Nlc3RQb2ludFRvUG9pbnRQYXJhbWV0ZXIocWQsICEwKTsKICAgIFllLmF0KHksIF8wKTsKICAgIGNvbnN0IGcgPSBGVC5sZXJwKHFlLnosICRlLnosIHkpLCBtID0gZyA+PSAtMSAmJiBnIDw9IDEsIHYgPSBxZC5kaXN0YW5jZVRvKF8wKSA8IGRyICogMC41OwogICAgaWYgKG0gJiYgdikgewogICAgICBZZS5zdGFydC5mcm9tQnVmZmVyQXR0cmlidXRlKGwsIGQpLCBZZS5lbmQuZnJvbUJ1ZmZlckF0dHJpYnV0ZShoLCBkKSwgWWUuc3RhcnQuYXBwbHlNYXRyaXg0KHIpLCBZZS5lbmQuYXBwbHlNYXRyaXg0KHIpOwogICAgICBjb25zdCB4ID0gbmV3IHR0KCksIF8gPSBuZXcgdHQoKTsKICAgICAgQW4uZGlzdGFuY2VTcVRvU2VnbWVudChZZS5zdGFydCwgWWUuZW5kLCBfLCB4KSwgZS5wdXNoKHsKICAgICAgICBwb2ludDogXywKICAgICAgICBwb2ludE9uTGluZTogeCwKICAgICAgICBkaXN0YW5jZTogQW4ub3JpZ2luLmRpc3RhbmNlVG8oXyksCiAgICAgICAgb2JqZWN0OiBhLAogICAgICAgIGZhY2U6IG51bGwsCiAgICAgICAgZmFjZUluZGV4OiBkLAogICAgICAgIHV2OiBudWxsLAogICAgICAgIHV2MTogbnVsbAogICAgICB9KTsKICAgIH0KICB9Cn0KY2xhc3MgRkMgZXh0ZW5kcyBBYyB7CiAgY29uc3RydWN0b3IodCA9IG5ldyBueCgpLCBlID0gbmV3IHN4KHsgY29sb3I6IE1hdGgucmFuZG9tKCkgKiAxNjc3NzIxNSB9KSkgewogICAgc3VwZXIodCwgZSksIHRoaXMuaXNMaW5lU2VnbWVudHMyID0gITAsIHRoaXMudHlwZSA9ICJMaW5lU2VnbWVudHMyIjsKICB9CiAgLy8gZm9yIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5LCBidXQgY291bGQgYmUgYSBtZXRob2Qgb2YgTGluZVNlZ21lbnRzR2VvbWV0cnkuLi4KICBjb21wdXRlTGluZURpc3RhbmNlcygpIHsKICAgIGNvbnN0IHQgPSB0aGlzLmdlb21ldHJ5LCBlID0gdC5hdHRyaWJ1dGVzLmluc3RhbmNlU3RhcnQsIGkgPSB0LmF0dHJpYnV0ZXMuaW5zdGFuY2VFbmQsIG4gPSBuZXcgRmxvYXQzMkFycmF5KDIgKiBlLmNvdW50KTsKICAgIGZvciAobGV0IHIgPSAwLCBvID0gMCwgbCA9IGUuY291bnQ7IHIgPCBsOyByKyssIG8gKz0gMikKICAgICAgZzAuZnJvbUJ1ZmZlckF0dHJpYnV0ZShlLCByKSwgeTAuZnJvbUJ1ZmZlckF0dHJpYnV0ZShpLCByKSwgbltvXSA9IG8gPT09IDAgPyAwIDogbltvIC0gMV0sIG5bbyArIDFdID0gbltvXSArIGcwLmRpc3RhbmNlVG8oeTApOwogICAgY29uc3QgcyA9IG5ldyBicChuLCAyLCAxKTsKICAgIHJldHVybiB0LnNldEF0dHJpYnV0ZSgiaW5zdGFuY2VEaXN0YW5jZVN0YXJ0IiwgbmV3IFNzKHMsIDEsIDApKSwgdC5zZXRBdHRyaWJ1dGUoImluc3RhbmNlRGlzdGFuY2VFbmQiLCBuZXcgU3MocywgMSwgMSkpLCB0aGlzOwogIH0KICByYXljYXN0KHQsIGUpIHsKICAgIGNvbnN0IGkgPSB0aGlzLm1hdGVyaWFsLndvcmxkVW5pdHMsIG4gPSB0LmNhbWVyYTsKICAgIG4gPT09IG51bGwgJiYgIWkgJiYgY29uc29sZS5lcnJvcignTGluZVNlZ21lbnRzMjogIlJheWNhc3Rlci5jYW1lcmEiIG5lZWRzIHRvIGJlIHNldCBpbiBvcmRlciB0byByYXljYXN0IGFnYWluc3QgTGluZVNlZ21lbnRzMiB3aGlsZSB3b3JsZFVuaXRzIGlzIHNldCB0byBmYWxzZS4nKTsKICAgIGNvbnN0IHMgPSB0LnBhcmFtcy5MaW5lMiAhPT0gdm9pZCAwICYmIHQucGFyYW1zLkxpbmUyLnRocmVzaG9sZCB8fCAwOwogICAgQW4gPSB0LnJheTsKICAgIGNvbnN0IHIgPSB0aGlzLm1hdHJpeFdvcmxkLCBvID0gdGhpcy5nZW9tZXRyeSwgbCA9IHRoaXMubWF0ZXJpYWw7CiAgICBkciA9IGwubGluZXdpZHRoICsgcywgby5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCAmJiBvLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCB2aC5jb3B5KG8uYm91bmRpbmdTcGhlcmUpLmFwcGx5TWF0cml4NChyKTsKICAgIGxldCBoOwogICAgaWYgKGkpCiAgICAgIGggPSBkciAqIDAuNTsKICAgIGVsc2UgewogICAgICBjb25zdCB1ID0gTWF0aC5tYXgobi5uZWFyLCB2aC5kaXN0YW5jZVRvUG9pbnQoQW4ub3JpZ2luKSk7CiAgICAgIGggPSB4MChuLCB1LCBsLnJlc29sdXRpb24pOwogICAgfQogICAgaWYgKHZoLnJhZGl1cyArPSBoLCBBbi5pbnRlcnNlY3RzU3BoZXJlKHZoKSA9PT0gITEpCiAgICAgIHJldHVybjsKICAgIG8uYm91bmRpbmdCb3ggPT09IG51bGwgJiYgby5jb21wdXRlQm91bmRpbmdCb3goKSwgeGguY29weShvLmJvdW5kaW5nQm94KS5hcHBseU1hdHJpeDQocik7CiAgICBsZXQgYzsKICAgIGlmIChpKQogICAgICBjID0gZHIgKiAwLjU7CiAgICBlbHNlIHsKICAgICAgY29uc3QgdSA9IE1hdGgubWF4KG4ubmVhciwgeGguZGlzdGFuY2VUb1BvaW50KEFuLm9yaWdpbikpOwogICAgICBjID0geDAobiwgdSwgbC5yZXNvbHV0aW9uKTsKICAgIH0KICAgIHhoLmV4cGFuZEJ5U2NhbGFyKGMpLCBBbi5pbnRlcnNlY3RzQm94KHhoKSAhPT0gITEgJiYgKGkgPyBMQyh0aGlzLCBlKSA6IERDKHRoaXMsIG4sIGUpKTsKICB9CiAgb25CZWZvcmVSZW5kZXIodCkgewogICAgY29uc3QgZSA9IHRoaXMubWF0ZXJpYWwudW5pZm9ybXM7CiAgICBlICYmIGUucmVzb2x1dGlvbiAmJiAodC5nZXRWaWV3cG9ydChXZCksIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS5zZXQoV2QueiwgV2QudykpOwogIH0KfQpjb25zdCBpYSA9IDIwMCwgdjAgPSAxMiwgYjAgPSA0MDAsIFNmID0gODAwLCBVQyA9IDEwMCwgQkMgPSAiI2U4YjAyNCIsIHJ4ID0gMzM1NTQ0MywgYXggPSB7CiAgYW1iaWVudEludGVuc2l0eTogMSwKICBkaXJlY3RJbnRlbnNpdHk6IDEuMSwKICBtZXRhbG5lc3M6IDAuMywKICByb3VnaG5lc3M6IDAuNjUsCiAgZWRnZUNvbG9yOiByeCwKICBkZWZhdWx0T3BhY2l0eTogMC41LAogIG5vcm1hbExlbjogMAp9LCBvbyA9IHsKICBFWFBBTkRfQUxMOiAwLAogIC8vIFNob3cgYWxsIG5vZGVzIGV4cGFuZGVkCiAgUk9PVF9PTkxZOiAxLAogIC8vIENvbGxhcHNlIHRvIHJvb3QgbGV2ZWwgb25seQogIENPTExBUFNFX0FMTDogMiwKICAvLyBBbGwgbm9kZXMgY29sbGFwc2VkCiAgRklSU1RfTEVWRUw6IDMKICAvLyBFeHBhbmQgZmlyc3QgbGV2ZWwgb25seQp9LCBNMCA9IHsKICB1cDogIloiLAogIGF4ZXM6ICEwLAogIGF4ZXMwOiAhMCwKICBncmlkOiBbITAsICExLCAhMV0sCiAgb3J0aG86ICEwLAogIHRyYW5zcGFyZW50OiAhMSwKICBibGFja0VkZ2VzOiAhMCwKICBjb2xsYXBzZTogb28uUk9PVF9PTkxZCn0sIHpDID0gWzEsIDFdLCBOQyA9IDEsIE9DID0gewogIHRoZW1lOiAiYnJvd3NlciIsCiAgcGlubmluZzogITEKfSwgb3ggPSA2MDA7CmZ1bmN0aW9uIGtDKGEsIHQsIGUpIHsKICBjb25zdCBpID0gYSBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSA/IGEgOiBuZXcgRmxvYXQzMkFycmF5KGEpLCBuID0gbmV3IG54KCk7CiAgbi5zZXRQb3NpdGlvbnMoaSk7CiAgY29uc3QgcyA9IHQuZWRnZUNvbG9yID8/IHJ4LCByID0gbmV3IHN4KHsKICAgIGNvbG9yOiBuZXcgQWkocyksCiAgICBsaW5ld2lkdGg6IDEsCiAgICB0cmFuc3BhcmVudDogITAsCiAgICBkZXB0aFdyaXRlOiAhdC50cmFuc3BhcmVudCwKICAgIGRlcHRoVGVzdDogIXQudHJhbnNwYXJlbnQsCiAgICBjbGlwSW50ZXJzZWN0aW9uOiAhMQogIH0pOwogIHIudmlzaWJsZSA9IGVbMV0gPT09IDEsIHIucmVzb2x1dGlvbi5zZXQodC53aWR0aCB8fCBTZiwgdC5oZWlnaHQgfHwgb3gpOwogIGNvbnN0IG8gPSBuZXcgRkMobiwgcik7CiAgcmV0dXJuIG8ucmVuZGVyT3JkZXIgPSA5OTksIG87Cn0KZnVuY3Rpb24gVkMoYSwgdCA9IHt9KSB7CiAgdmFyIFQ7CiAgY29uc3QgZSA9IHsgLi4uYXgsIHdpZHRoOiBTZiwgaGVpZ2h0OiBveCwgLi4udCB9LCB7IGlkOiBpLCBuYW1lOiBuLCBzaGFwZTogcywgY29sb3I6IHIsIGFscGhhOiBvLCBzdGF0ZTogbCB9ID0gYSwgaCA9IG5ldyBBaShyIHx8IEJDKSwgYyA9IG8gPz8gTkMsIHUgPSBsIHx8IHpDLCBkID0gITAsIHAgPSBuZXcgSUMoCiAgICBlLmRlZmF1bHRPcGFjaXR5LAogICAgLy8gb3BhY2l0eQogICAgYywKICAgIC8vIGFscGhhCiAgICBlLmVkZ2VDb2xvciwKICAgIC8vIGVkZ2VfY29sb3IKICAgIHsgdG9wbzogImZhY2UiIH0sCiAgICAvLyBzaGFwZUluZm8gKGdlb210eXBlKQogICAgInNvbGlkIiwKICAgIC8vIHN1YnR5cGUgLSBDUklUSUNBTCBmb3IgY2xpcHBpbmcgY2hlY2sKICAgIGQKICAgIC8vIHJlbmRlcmJhY2sKICApOwogIHAubmFtZSA9IGkucmVwbGFjZUFsbCgiLyIsICJ8Iik7CiAgY29uc3QgZiA9IHMudmVydGljZXMgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkgPyBzLnZlcnRpY2VzIDogbmV3IEZsb2F0MzJBcnJheShzLnZlcnRpY2VzKSwgeSA9IHMubm9ybWFscyBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSA/IHMubm9ybWFscyA6IG5ldyBGbG9hdDMyQXJyYXkocy5ub3JtYWxzKSwgZyA9IHMudHJpYW5nbGVzIGluc3RhbmNlb2YgVWludDMyQXJyYXkgPyBzLnRyaWFuZ2xlcyA6IG5ldyBVaW50MzJBcnJheShzLnRyaWFuZ2xlcyksIG0gPSBuZXcgRmEoKTsKICBtLnNldEF0dHJpYnV0ZSgicG9zaXRpb24iLCBuZXcgcWkoZiwgMykpLCBtLnNldEF0dHJpYnV0ZSgibm9ybWFsIiwgbmV3IHFpKHksIDMpKSwgbS5zZXRJbmRleChuZXcgcWkoZywgMSkpLCBtLmNvbXB1dGVCb3VuZGluZ0JveCgpLCBtLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpLCBwLnNoYXBlR2VvbWV0cnkgPSBtOwogIGNvbnN0IHYgPSBlLnRyYW5zcGFyZW50IHx8IGMgPCAxLCB4ID0gbmV3IGhDKHsKICAgIGNvbG9yOiBoLAogICAgbWV0YWxuZXNzOiBlLm1ldGFsbmVzcywKICAgIHJvdWdobmVzczogZS5yb3VnaG5lc3MsCiAgICBwb2x5Z29uT2Zmc2V0OiAhMCwKICAgIHBvbHlnb25PZmZzZXRGYWN0b3I6IDEsCiAgICBwb2x5Z29uT2Zmc2V0VW5pdHM6IDEsCiAgICB0cmFuc3BhcmVudDogITAsCiAgICBvcGFjaXR5OiB2ID8gZS5kZWZhdWx0T3BhY2l0eSAqIGMgOiBjLAogICAgZGVwdGhXcml0ZTogIXYsCiAgICBkZXB0aFRlc3Q6ICEwLAogICAgY2xpcEludGVyc2VjdGlvbjogITEsCiAgICBzaWRlOiBCbywKICAgIHZpc2libGU6IHVbMF0gPT09IDEsCiAgICBuYW1lOiAiZnJvbnRNYXRlcmlhbCIKICB9KSwgXyA9IG5ldyBwdSh7CiAgICBjb2xvcjogaCwKICAgIHNpZGU6IGdmLAogICAgcG9seWdvbk9mZnNldDogITAsCiAgICBwb2x5Z29uT2Zmc2V0RmFjdG9yOiAxLAogICAgcG9seWdvbk9mZnNldFVuaXRzOiAxLAogICAgdHJhbnNwYXJlbnQ6ICEwLAogICAgb3BhY2l0eTogdiA/IGUuZGVmYXVsdE9wYWNpdHkgKiBjIDogYywKICAgIGRlcHRoV3JpdGU6ICF2LAogICAgZGVwdGhUZXN0OiAhMCwKICAgIGNsaXBJbnRlcnNlY3Rpb246ICExLAogICAgdmlzaWJsZTogdVswXSA9PT0gMSAmJiBkLAogICAgbmFtZTogImJhY2tNYXRlcmlhbCIKICB9KSwgUyA9IG5ldyBBYyhtLCBfKTsKICBTLm5hbWUgPSBuIHx8IGk7CiAgY29uc3QgdyA9IG5ldyBBYyhtLCB4KTsKICBpZiAody5uYW1lID0gbiB8fCBpLCBjIDwgMSAmJiAoUy5yZW5kZXJPcmRlciA9IDk5OSwgdy5yZW5kZXJPcmRlciA9IDk5OSksIHAuYWRkVHlwZShTLCAiYmFjayIpLCBwLmFkZFR5cGUodywgImZyb250IiksICgoVCA9IHMuZWRnZXMpID09IG51bGwgPyB2b2lkIDAgOiBULmxlbmd0aCkgPiAwKSB7CiAgICBjb25zdCBSID0ga0Mocy5lZGdlcywgZSwgdSk7CiAgICBSLm5hbWUgPSBuIHx8IGksIHAuYWRkVHlwZShSLCAiZWRnZXMiKTsKICB9CiAgcmV0dXJuIHA7Cn0KZnVuY3Rpb24gSEMoYSwgdCkgewogIHJldHVybiB0ID8gewogICAgLi4uYSwKICAgIHdpZHRoOiB0LmNhZFdpZHRoIHx8IGEud2lkdGgsCiAgICBoZWlnaHQ6IHQuaGVpZ2h0IHx8IGEuaGVpZ2h0CiAgfSA6IGE7Cn0KY29uc3QgR0MgPSBuZXcgcHUoewogIGRlcHRoV3JpdGU6ICExLAogIGRlcHRoVGVzdDogITEsCiAgY29sb3JXcml0ZTogITEsCiAgc2lkZTogZ2YsCiAgc3RlbmNpbFdyaXRlOiAhMCwKICBzdGVuY2lsRnVuYzogU2MsCiAgc3RlbmNpbEZhaWw6IG1kLAogIHN0ZW5jaWxaRmFpbDogbWQsCiAgc3RlbmNpbFpQYXNzOiBtZAp9KSwgV0MgPSBuZXcgcHUoewogIGRlcHRoV3JpdGU6ICExLAogIGRlcHRoVGVzdDogITEsCiAgY29sb3JXcml0ZTogITEsCiAgc2lkZTogQm8sCiAgc3RlbmNpbFdyaXRlOiAhMCwKICBzdGVuY2lsRnVuYzogU2MsCiAgc3RlbmNpbEZhaWw6IGdkLAogIHN0ZW5jaWxaRmFpbDogZ2QsCiAgc3RlbmNpbFpQYXNzOiBnZAp9KTsKZnVuY3Rpb24gUzAoYSwgdCwgZSwgaSkgewogIGNvbnN0IG4gPSB0LmNsb25lKCk7CiAgbi5jbGlwcGluZ1BsYW5lcyA9IFtpXTsKICBjb25zdCBzID0gbmV3IEFjKGUsIG4pOwogIHJldHVybiBzLm5hbWUgPSBhLCBzOwp9CmNsYXNzIHFDIHsKICAvKioKICAgKiBAcGFyYW0ge09iamVjdH0gdmlld2VyIC0gTGl2ZVZpZXdlciBpbnN0YW5jZQogICAqLwogIGNvbnN0cnVjdG9yKHQpIHsKICAgIHRoaXMuX3ZpZXdlciA9IHQ7CiAgfQogIC8qKgogICAqIENoZWNrIGlmIGNsaXBwaW5nIGlzIGF2YWlsYWJsZSAodmlld2VyIGhhcyBiZWVuIHJlbmRlcmVkKQogICAqIEByZXR1cm5zIHtib29sZWFufQogICAqLwogIGdldCBpc1JlYWR5KCkgewogICAgdmFyIHQsIGU7CiAgICByZXR1cm4gISEoKGUgPSAodCA9IHRoaXMuX3ZpZXdlcikgPT0gbnVsbCA/IHZvaWQgMCA6IHQuY2xpcHBpbmcpICE9IG51bGwgJiYgZS5jbGlwUGxhbmVzKTsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBjbGlwcGluZyBwbGFuZXMgZnJvbSB0aGUgdmlld2VyCiAgICogQHJldHVybnMge0FycmF5PFRIUkVFLlBsYW5lPnxudWxsfQogICAqLwogIGdldCBjbGlwUGxhbmVzKCkgewogICAgdmFyIHQsIGU7CiAgICByZXR1cm4gKChlID0gKHQgPSB0aGlzLl92aWV3ZXIpID09IG51bGwgPyB2b2lkIDAgOiB0LmNsaXBwaW5nKSA9PSBudWxsID8gdm9pZCAwIDogZS5jbGlwUGxhbmVzKSB8fCBudWxsOwogIH0KICAvKioKICAgKiBTZXR1cCBjbGlwcGluZyBzdGVuY2lscyBmb3IgYSBuZXdseSBhZGRlZCBPYmplY3RHcm91cC4KICAgKiBNdXN0IGJlIGNhbGxlZCBBRlRFUiB2aWV3ZXIuY2xpcHBpbmcgZXhpc3RzIChhZnRlciBmaXJzdCByZW5kZXIpLgogICAqIAogICAqIFRoaXMgcmVwbGljYXRlcyB3aGF0IHRoZSBDbGlwcGluZyBjb25zdHJ1Y3RvciBkb2VzIGZvciBlYWNoIE9iamVjdEdyb3VwOgogICAqIDEuIENyZWF0ZXMgZnJvbnQvYmFjayBzdGVuY2lsIG1lc2hlcyBmb3IgZWFjaCBjbGlwcGluZyBwbGFuZSAoWCwgWSwgWikKICAgKiAyLiBBZGRzIHRoZW0gdG8gdGhlIGdyb3VwIHZpYSBhZGRUeXBlKCkgc28gc2V0U2hhcGVWaXNpYmxlKCkgY29udHJvbHMgdGhlbQogICAqIDMuIFNldHMgY2xpcCBwbGFuZXMgb24gdGhlIGdyb3VwJ3MgbWF0ZXJpYWxzCiAgICogCiAgICogQHBhcmFtIHtPYmplY3RHcm91cH0gZ3JvdXAgLSBPYmplY3RHcm91cCBpbnN0YW5jZSB0byBzZXR1cCBjbGlwcGluZyBmb3IKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSB0cnVlIGlmIGNsaXBwaW5nIHdhcyBzZXQgdXAsIGZhbHNlIGlmIG5vdCBwb3NzaWJsZQogICAqLwogIHNldHVwQ2xpcHBpbmcodCkgewogICAgdmFyIG47CiAgICBpZiAoIXRoaXMuaXNSZWFkeSB8fCAhKHQgIT0gbnVsbCAmJiB0LnNoYXBlR2VvbWV0cnkpIHx8IHQuc3VidHlwZSAhPT0gInNvbGlkIiB8fCAobiA9IHQudHlwZXMpICE9IG51bGwgJiYgblsiY2xpcHBpbmctMCJdKQogICAgICByZXR1cm4gITE7CiAgICBjb25zdCBlID0gdGhpcy5jbGlwUGxhbmVzLCBpID0gdC5zaGFwZUdlb21ldHJ5OwogICAgZm9yIChsZXQgcyA9IDA7IHMgPCAzOyBzKyspIHsKICAgICAgY29uc3QgciA9IGVbc10sIG8gPSBuZXcgYUMoKTsKICAgICAgby5uYW1lID0gYGNsaXBwaW5nLSR7c31gOwogICAgICBjb25zdCBsID0gUzAoCiAgICAgICAgYGZyb250U3RlbmNpbC0ke3N9YCwKICAgICAgICBXQywKICAgICAgICBpLAogICAgICAgIHIKICAgICAgKTsKICAgICAgby5hZGQobCk7CiAgICAgIGNvbnN0IGggPSBTMCgKICAgICAgICBgYmFja1N0ZW5jaWwtJHtzfWAsCiAgICAgICAgR0MsCiAgICAgICAgaSwKICAgICAgICByCiAgICAgICk7CiAgICAgIG8uYWRkKGgpLCB0LmFkZFR5cGUobywgYGNsaXBwaW5nLSR7c31gKTsKICAgIH0KICAgIHJldHVybiB0LnNldENsaXBQbGFuZXMoZSksICEwOwogIH0KICAvKioKICAgKiBSZW1vdmUgY2xpcHBpbmcgZnJvbSBhIGdyb3VwIChmb3IgY2xlYW51cCkKICAgKiBAcGFyYW0ge09iamVjdEdyb3VwfSBncm91cCAtIE9iamVjdEdyb3VwIGluc3RhbmNlCiAgICovCiAgcmVtb3ZlQ2xpcHBpbmcodCkgewogICAgaWYgKHQgIT0gbnVsbCAmJiB0LnR5cGVzKSB7CiAgICAgIGZvciAobGV0IGUgPSAwOyBlIDwgMzsgZSsrKSB7CiAgICAgICAgY29uc3QgaSA9IGBjbGlwcGluZy0ke2V9YCwgbiA9IHQudHlwZXNbaV07CiAgICAgICAgaWYgKG4pIHsKICAgICAgICAgIGZvciAoY29uc3QgcyBvZiBuLmNoaWxkcmVuKQogICAgICAgICAgICBzLm1hdGVyaWFsICYmIHMubWF0ZXJpYWwuZGlzcG9zZSgpOwogICAgICAgICAgdC5yZW1vdmUobiksIGRlbGV0ZSB0LnR5cGVzW2ldOwogICAgICAgIH0KICAgICAgfQogICAgICB0eXBlb2YgdC5zZXRDbGlwUGxhbmVzID09ICJmdW5jdGlvbiIgJiYgdC5zZXRDbGlwUGxhbmVzKG51bGwpOwogICAgfQogIH0KICAvKioKICAgKiBTZXR1cCBjbGlwcGluZyBmb3IgYWxsIGdyb3VwcyB0aGF0IGRvbid0IGhhdmUgaXQgeWV0LgogICAqIFVzZWZ1bCBhZnRlciBiYXRjaCBhZGRpbmcgcGFydHMuCiAgICogQHBhcmFtIHtPYmplY3R9IGdyb3VwcyAtIE1hcCBvZiBwYXRoIC0+IE9iamVjdEdyb3VwCiAgICogQHJldHVybnMge251bWJlcn0gLSBOdW1iZXIgb2YgZ3JvdXBzIHRoYXQgZ290IGNsaXBwaW5nIHNldHVwCiAgICovCiAgc2V0dXBDbGlwcGluZ0ZvckFsbCh0KSB7CiAgICBpZiAoIXQgfHwgIXRoaXMuaXNSZWFkeSkgcmV0dXJuIDA7CiAgICBsZXQgZSA9IDA7CiAgICBmb3IgKGNvbnN0IGkgb2YgT2JqZWN0LnZhbHVlcyh0KSkKICAgICAgdGhpcy5zZXR1cENsaXBwaW5nKGkpICYmIGUrKzsKICAgIHJldHVybiBlOwogIH0KfQpjbGFzcyBYZCB7CiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gUGFydCBJRCAocGF0aCBsaWtlICIvR3JvdXAvUGFydE5hbWUiKQogICAqIEBwYXJhbSB7T2JqZWN0R3JvdXB9IGdyb3VwIC0gT2JqZWN0R3JvdXAgaW5zdGFuY2UKICAgKi8KICBjb25zdHJ1Y3Rvcih0LCBlKSB7CiAgICB0aGlzLmlkID0gdCwgdGhpcy5fZ3JvdXAgPSBlLCB0aGlzLl9kaXNwb3NlZCA9ICExOwogIH0KICAvKiogQ2hlY2sgaWYgdGhpcyBoYW5kbGUgaXMgc3RpbGwgdmFsaWQgKi8KICBnZXQgaXNWYWxpZCgpIHsKICAgIHJldHVybiAhdGhpcy5fZGlzcG9zZWQgJiYgdGhpcy5fZ3JvdXAgJiYgdGhpcy5fZ3JvdXAucGFyZW50OwogIH0KICAvKiogR2V0IHRoZSBPYmplY3RHcm91cCBmb3IgdGhpcyBwYXJ0ICovCiAgZ2V0IGdyb3VwKCkgewogICAgcmV0dXJuIHRoaXMuX2dyb3VwOwogIH0KICAvKiogR2V0IHRoZSBnZW9tZXRyeSAqLwogIGdldCBnZW9tZXRyeSgpIHsKICAgIHZhciB0OwogICAgcmV0dXJuICh0ID0gdGhpcy5fZ3JvdXApID09IG51bGwgPyB2b2lkIDAgOiB0LnNoYXBlR2VvbWV0cnk7CiAgfQogIC8qKiBTZXQgcGFydCBwb3NpdGlvbiAqLwogIHNldFBvc2l0aW9uKHQsIGUsIGkpIHsKICAgIHRoaXMuaXNWYWxpZCAmJiB0aGlzLl9ncm91cC5wb3NpdGlvbi5zZXQodCwgZSwgaSk7CiAgfQogIC8qKiBTZXQgcGFydCByb3RhdGlvbiBhcyBxdWF0ZXJuaW9uICovCiAgc2V0UXVhdGVybmlvbih0LCBlLCBpLCBuKSB7CiAgICB0aGlzLmlzVmFsaWQgJiYgdGhpcy5fZ3JvdXAucXVhdGVybmlvbi5zZXQodCwgZSwgaSwgbik7CiAgfQogIC8qKiBTZXQgcG9zaXRpb24gYW5kIHF1YXRlcm5pb24gZnJvbSBsb2MgYXJyYXkgW1t4LHksel0sIFtxeCxxeSxxeixxd11dICovCiAgc2V0VHJhbnNmb3JtKHQpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkIHx8ICF0KSByZXR1cm47CiAgICBjb25zdCBbZSwgaV0gPSB0OwogICAgZSAmJiB0aGlzLnNldFBvc2l0aW9uKGVbMF0sIGVbMV0sIGVbMl0pLCBpICYmIHRoaXMuc2V0UXVhdGVybmlvbihpWzBdLCBpWzFdLCBpWzJdLCBpWzNdKTsKICB9CiAgLyoqIFVwZGF0ZSBnZW9tZXRyeSBidWZmZXJzICovCiAgdXBkYXRlR2VvbWV0cnkodCwgZSwgaSkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQpIHJldHVybjsKICAgIGNvbnN0IG4gPSB0aGlzLl9ncm91cC5zaGFwZUdlb21ldHJ5OwogICAgaWYgKCFuKSByZXR1cm47CiAgICBjb25zdCBzID0gdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSA/IHQgOiBuZXcgRmxvYXQzMkFycmF5KHQpLCByID0gZSBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSA/IGUgOiBuZXcgRmxvYXQzMkFycmF5KGUpLCBvID0gaSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5ID8gaSA6IG5ldyBVaW50MzJBcnJheShpKTsKICAgIHRoaXMuX3VwZGF0ZUJ1ZmZlckF0dHJpYnV0ZShuLCAicG9zaXRpb24iLCBzLCAzKSwgdGhpcy5fdXBkYXRlQnVmZmVyQXR0cmlidXRlKG4sICJub3JtYWwiLCByLCAzKSwgdGhpcy5fdXBkYXRlSW5kZXgobiwgbyksIG4uY29tcHV0ZUJvdW5kaW5nQm94KCksIG4uY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CiAgfQogIC8qKiBVcGRhdGUgZWRnZSBnZW9tZXRyeSAqLwogIHVwZGF0ZUVkZ2VzKHQpIHsKICAgIHZhciBuLCBzOwogICAgaWYgKCF0aGlzLmlzVmFsaWQpIHJldHVybjsKICAgIGNvbnN0IGUgPSAobiA9IHRoaXMuX2dyb3VwLnR5cGVzKSA9PSBudWxsID8gdm9pZCAwIDogbi5lZGdlczsKICAgIGlmICghKChzID0gZSA9PSBudWxsID8gdm9pZCAwIDogZS5nZW9tZXRyeSkgIT0gbnVsbCAmJiBzLnNldFBvc2l0aW9ucykpIHJldHVybjsKICAgIGNvbnN0IGkgPSB0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5ID8gdCA6IG5ldyBGbG9hdDMyQXJyYXkodCk7CiAgICBlLmdlb21ldHJ5LnNldFBvc2l0aW9ucyhpKTsKICB9CiAgLyoqIERpc3Bvc2Ugb2YgdGhpcyBwYXJ0J3MgcmVzb3VyY2VzICovCiAgZGlzcG9zZSgpIHsKICAgIHRoaXMuX2Rpc3Bvc2VkIHx8ICh0aGlzLl9ncm91cCAmJiAodGhpcy5fZ3JvdXAucGFyZW50ICYmIHRoaXMuX2dyb3VwLnBhcmVudC5yZW1vdmUodGhpcy5fZ3JvdXApLCB0eXBlb2YgdGhpcy5fZ3JvdXAuZGlzcG9zZSA9PSAiZnVuY3Rpb24iICYmIHRoaXMuX2dyb3VwLmRpc3Bvc2UoKSksIHRoaXMuX2Rpc3Bvc2VkID0gITApOwogIH0KICAvKiogQHByaXZhdGUgVXBkYXRlIGEgYnVmZmVyIGF0dHJpYnV0ZSwgcmV1c2luZyBpZiBzaXplIG1hdGNoZXMgKi8KICBfdXBkYXRlQnVmZmVyQXR0cmlidXRlKHQsIGUsIGksIG4pIHsKICAgIGNvbnN0IHMgPSB0LmF0dHJpYnV0ZXNbZV07CiAgICBzICYmIHMuYXJyYXkubGVuZ3RoID09PSBpLmxlbmd0aCA/IChzLmFycmF5LnNldChpKSwgcy5uZWVkc1VwZGF0ZSA9ICEwKSA6IHQuc2V0QXR0cmlidXRlKGUsIG5ldyBxaShpLCBuKSk7CiAgfQogIC8qKiBAcHJpdmF0ZSBVcGRhdGUgZ2VvbWV0cnkgaW5kZXggKi8KICBfdXBkYXRlSW5kZXgodCwgZSkgewogICAgY29uc3QgaSA9IHQuaW5kZXg7CiAgICBpICYmIGkuYXJyYXkubGVuZ3RoID09PSBlLmxlbmd0aCA/IChpLmFycmF5LnNldChlKSwgaS5uZWVkc1VwZGF0ZSA9ICEwKSA6IHQuc2V0SW5kZXgobmV3IHFpKGUsIDEpKTsKICB9Cn0KY2xhc3MgJEMgewogIC8qKgogICAqIEBwYXJhbSB7T2JqZWN0fSB2aWV3ZXIgLSBMaXZlVmlld2VyIGluc3RhbmNlCiAgICovCiAgY29uc3RydWN0b3IodCkgewogICAgdGhpcy5fdmlld2VyID0gdCwgdGhpcy5fcGFydHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCB0aGlzLl9yZW5kZXJPcHRpb25zID0gbnVsbCwgdGhpcy5fY2xpcHBpbmdFeHQgPSBuZXcgcUModCk7CiAgfQogIC8qKiBHZXQgdGhlIENsaXBwaW5nRXh0ZW5zaW9uICovCiAgZ2V0IGNsaXBwaW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2NsaXBwaW5nRXh0OwogIH0KICAvKiogU2V0IHJlbmRlciBvcHRpb25zIGZvciBuZXcgcGFydHMgKi8KICBzZXRSZW5kZXJPcHRpb25zKHQpIHsKICAgIHRoaXMuX3JlbmRlck9wdGlvbnMgPSB0OwogIH0KICAvKiogR2V0IHJlbmRlciBvcHRpb25zIHdpdGggZGlzcGxheSBkaW1lbnNpb25zICovCiAgX2dldE9wdGlvbnMoKSB7CiAgICB2YXIgdDsKICAgIHJldHVybiBIQygKICAgICAgdGhpcy5fcmVuZGVyT3B0aW9ucyB8fCB7fSwKICAgICAgKHQgPSB0aGlzLl92aWV3ZXIpID09IG51bGwgPyB2b2lkIDAgOiB0LmRpc3BsYXkKICAgICk7CiAgfQogIC8qKiBHZXQgYSBwYXJ0IGJ5IElEICovCiAgZ2V0KHQpIHsKICAgIHJldHVybiB0aGlzLl9wYXJ0cy5nZXQodCkgfHwgbnVsbDsKICB9CiAgLyoqIENoZWNrIGlmIGEgcGFydCBleGlzdHMgKi8KICBoYXModCkgewogICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhhcyh0KTsKICB9CiAgLyoqIEdldCBhbGwgcGFydCBJRHMgKi8KICBpZHMoKSB7CiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLl9wYXJ0cy5rZXlzKCkpOwogIH0KICAvKiogR2V0IGFsbCBwYXJ0cyAqLwogIGFsbCgpIHsKICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuX3BhcnRzLnZhbHVlcygpKTsKICB9CiAgLyoqIAogICAqIEJ1aWxkIHBhcnQgbWFwIGZyb20gdmlld2VyJ3MgY3VycmVudCBzdGF0ZSAoYWZ0ZXIgaW5pdGlhbCByZW5kZXIpLgogICAqIE1hcHMgdGhyZWUtY2FkLXZpZXdlcidzIE9iamVjdEdyb3VwcyB0byBQYXJ0SGFuZGxlcy4KICAgKi8KICBidWlsZEZyb21WaWV3ZXIoKSB7CiAgICB2YXIgZSwgaTsKICAgIHRoaXMuX3BhcnRzLmNsZWFyKCk7CiAgICBjb25zdCB0ID0gKGkgPSAoZSA9IHRoaXMuX3ZpZXdlcikgPT0gbnVsbCA/IHZvaWQgMCA6IGUubmVzdGVkR3JvdXApID09IG51bGwgPyB2b2lkIDAgOiBpLmdyb3VwczsKICAgIGlmICh0KQogICAgICBmb3IgKGNvbnN0IFtuLCBzXSBvZiBPYmplY3QuZW50cmllcyh0KSkgewogICAgICAgIGlmICghbikgY29udGludWU7CiAgICAgICAgY29uc3QgciA9IG5ldyBYZChuLCBzKTsKICAgICAgICB0aGlzLl9wYXJ0cy5zZXQobiwgcik7CiAgICAgIH0KICB9CiAgLyoqCiAgICogQWRkIGEgbmV3IHBhcnQgdG8gdGhlIHNjZW5lIHVzaW5nIGEgcmVhbCBPYmplY3RHcm91cC4KICAgKiBAcGFyYW0ge09iamVjdH0gcGFydERhdGEgLSBQYXJ0IGRhdGEgd2l0aCBzaGFwZSwgY29sb3IsIGV0Yy4KICAgKiBAcmV0dXJucyB7UGFydEhhbmRsZXxudWxsfQogICAqLwogIGFkZCh0KSB7CiAgICB2YXIgciwgbywgbDsKICAgIGNvbnN0IHsgaWQ6IGUsIGxvYzogaSB9ID0gdDsKICAgIGlmICghKChyID0gdC5zaGFwZSkgIT0gbnVsbCAmJiByLnZlcnRpY2VzKSB8fCAhKChsID0gKG8gPSB0aGlzLl92aWV3ZXIpID09IG51bGwgPyB2b2lkIDAgOiBvLm5lc3RlZEdyb3VwKSAhPSBudWxsICYmIGwucm9vdEdyb3VwKSkKICAgICAgcmV0dXJuIG51bGw7CiAgICBjb25zdCBuID0gVkModCwgdGhpcy5fZ2V0T3B0aW9ucygpKTsKICAgIHRoaXMuX3ZpZXdlci5uZXN0ZWRHcm91cC5yb290R3JvdXAuYWRkKG4pLCB0aGlzLl92aWV3ZXIubmVzdGVkR3JvdXAuZ3JvdXBzW2VdID0gbiwgdGhpcy5fY2xpcHBpbmdFeHQuc2V0dXBDbGlwcGluZyhuKTsKICAgIGNvbnN0IHMgPSBuZXcgWGQoZSwgbik7CiAgICByZXR1cm4gdGhpcy5fcGFydHMuc2V0KGUsIHMpLCBpICYmIHMuc2V0VHJhbnNmb3JtKGkpLCBzOwogIH0KICAvKioKICAgKiBSZW1vdmUgYSBwYXJ0IGZyb20gdGhlIHNjZW5lLgogICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFBhcnQgSUQgdG8gcmVtb3ZlCiAgICovCiAgcmVtb3ZlKHQpIHsKICAgIHZhciBpLCBuLCBzOwogICAgY29uc3QgZSA9IHRoaXMuX3BhcnRzLmdldCh0KTsKICAgIGUgJiYgKHRoaXMuX2NsaXBwaW5nRXh0LnJlbW92ZUNsaXBwaW5nKGUuZ3JvdXApLCBlLmRpc3Bvc2UoKSwgdGhpcy5fcGFydHMuZGVsZXRlKHQpKSwgKHMgPSAobiA9IChpID0gdGhpcy5fdmlld2VyKSA9PSBudWxsID8gdm9pZCAwIDogaS5uZXN0ZWRHcm91cCkgPT0gbnVsbCA/IHZvaWQgMCA6IG4uZ3JvdXBzKSAhPSBudWxsICYmIHNbdF0gJiYgZGVsZXRlIHRoaXMuX3ZpZXdlci5uZXN0ZWRHcm91cC5ncm91cHNbdF07CiAgfQogIC8qKgogICAqIFVwZGF0ZSBhbiBleGlzdGluZyBwYXJ0J3MgZ2VvbWV0cnkgYW5kIHRyYW5zZm9ybS4KICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgLSBQYXJ0IElECiAgICogQHBhcmFtIHtPYmplY3R9IHBhcnREYXRhIC0gTmV3IHBhcnQgZGF0YQogICAqLwogIHVwZGF0ZSh0LCBlKSB7CiAgICB2YXIgciwgbywgbDsKICAgIGxldCBpID0gdGhpcy5fcGFydHMuZ2V0KHQpOwogICAgaWYgKCFpKSB7CiAgICAgIGNvbnN0IGggPSAobCA9IChvID0gKHIgPSB0aGlzLl92aWV3ZXIpID09IG51bGwgPyB2b2lkIDAgOiByLm5lc3RlZEdyb3VwKSA9PSBudWxsID8gdm9pZCAwIDogby5ncm91cHMpID09IG51bGwgPyB2b2lkIDAgOiBsW3RdOwogICAgICBoICYmIChpID0gbmV3IFhkKHQsIGgpLCB0aGlzLl9wYXJ0cy5zZXQodCwgaSkpOwogICAgfQogICAgaWYgKCFpIHx8ICFpLmlzVmFsaWQpIHJldHVybjsKICAgIGNvbnN0IHsgc2hhcGU6IG4sIGxvYzogcyB9ID0gZTsKICAgIG4gIT0gbnVsbCAmJiBuLnZlcnRpY2VzICYmIChpLnVwZGF0ZUdlb21ldHJ5KG4udmVydGljZXMsIG4ubm9ybWFscywgbi50cmlhbmdsZXMpLCBuLmVkZ2VzICYmIGkudXBkYXRlRWRnZXMobi5lZGdlcykpLCBzICYmIGkuc2V0VHJhbnNmb3JtKHMpOwogIH0KICAvKioKICAgKiBTeW5jIHBhcnRzIHdpdGggbmV3IGRhdGEgLSBpbnRlbGxpZ2VudGx5IGFkZCwgcmVtb3ZlLCB1cGRhdGUuCiAgICogQHBhcmFtIHtBcnJheX0gcGFydHNEYXRhIC0gQXJyYXkgb2YgcGFydCBkYXRhIG9iamVjdHMKICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIHsgYWRkZWQsIHVwZGF0ZWQsIHJlbW92ZWQgfSBjb3VudHMKICAgKi8KICBzeW5jKHQpIHsKICAgIGNvbnN0IGUgPSBuZXcgU2V0KHQubWFwKChyKSA9PiByLmlkKSksIGkgPSBuZXcgU2V0KHRoaXMuX3BhcnRzLmtleXMoKSksIG4gPSB0aGlzLl9nZXRWaWV3ZXJQYXJ0SWRzKCk7CiAgICBmb3IgKGNvbnN0IHIgb2YgbikKICAgICAgaS5hZGQocik7CiAgICBjb25zdCBzID0geyBhZGRlZDogMCwgdXBkYXRlZDogMCwgcmVtb3ZlZDogMCB9OwogICAgZm9yIChjb25zdCByIG9mIGkpCiAgICAgIGUuaGFzKHIpIHx8ICh0aGlzLnJlbW92ZShyKSwgcy5yZW1vdmVkKyspOwogICAgZm9yIChjb25zdCByIG9mIHQpCiAgICAgIGkuaGFzKHIuaWQpID8gKHRoaXMudXBkYXRlKHIuaWQsIHIpLCBzLnVwZGF0ZWQrKykgOiAodGhpcy5hZGQociksIHMuYWRkZWQrKyk7CiAgICByZXR1cm4gczsKICB9CiAgLyoqIEBwcml2YXRlIEdldCBhbGwgcGFydCBJRHMgKHBhdGhzKSBmcm9tIHZpZXdlcidzIGdyb3VwcyAqLwogIF9nZXRWaWV3ZXJQYXJ0SWRzKCkgewogICAgdmFyIGksIG47CiAgICBjb25zdCB0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwgZSA9IChuID0gKGkgPSB0aGlzLl92aWV3ZXIpID09IG51bGwgPyB2b2lkIDAgOiBpLm5lc3RlZEdyb3VwKSA9PSBudWxsID8gdm9pZCAwIDogbi5ncm91cHM7CiAgICBpZiAoIWUpIHJldHVybiB0OwogICAgZm9yIChjb25zdCBzIG9mIE9iamVjdC5rZXlzKGUpKQogICAgICBzICYmIHQuYWRkKHMpOwogICAgcmV0dXJuIHQ7CiAgfQogIC8qKiBDbGVhciBhbGwgcGFydHMgKi8KICBjbGVhcigpIHsKICAgIGZvciAoY29uc3QgdCBvZiB0aGlzLl9wYXJ0cy52YWx1ZXMoKSkKICAgICAgdGhpcy5fY2xpcHBpbmdFeHQucmVtb3ZlQ2xpcHBpbmcodC5ncm91cCksIHQuZGlzcG9zZSgpOwogICAgdGhpcy5fcGFydHMuY2xlYXIoKTsKICB9Cn0KY2xhc3MgWEMgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5fc3RhdGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICB9CiAgLyoqCiAgICogR2V0IHN0YXRlIGZvciBhIHBhdGgsIHJldHVybnMgZGVmYXVsdCBbMSwgMV0gaWYgbm90IGZvdW5kCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBQYXJ0IHBhdGggKGUuZy4sICIvR3JvdXAvUGFydE5hbWUiKQogICAqIEByZXR1cm5zIHtbbnVtYmVyLCBudW1iZXJdfSAtIFtzaGFwZVZpc2libGUsIGVkZ2VzVmlzaWJsZV0KICAgKi8KICBnZXQodCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlcy5nZXQodCkgfHwgWzEsIDFdOwogIH0KICAvKioKICAgKiBTZXQgc3RhdGUgZm9yIGEgcGF0aAogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gUGFydCBwYXRoCiAgICogQHBhcmFtIHtbbnVtYmVyLCBudW1iZXJdfSBzdGF0ZSAtIFtzaGFwZVZpc2libGUsIGVkZ2VzVmlzaWJsZV0KICAgKi8KICBzZXQodCwgZSkgewogICAgdGhpcy5fc3RhdGVzLnNldCh0LCBlKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlIHN0YXRlIGZvciBhIHBhdGgKICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIFBhcnQgcGF0aAogICAqLwogIHJlbW92ZSh0KSB7CiAgICB0aGlzLl9zdGF0ZXMuZGVsZXRlKHQpOwogIH0KICAvKioKICAgKiBDaGVjayBpZiBhIHBhdGggaGFzIHNhdmVkIHN0YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBQYXJ0IHBhdGgKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgKi8KICBoYXModCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlcy5oYXModCk7CiAgfQogIC8qKgogICAqIEdldCBhbGwgc3RhdGVzIGFzIGFuIG9iamVjdAogICAqIEByZXR1cm5zIHtPYmplY3QuPHN0cmluZywgW251bWJlciwgbnVtYmVyXT59CiAgICovCiAgYWxsKCkgewogICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl9zdGF0ZXMpOwogIH0KICAvKioKICAgKiBHZXQgbnVtYmVyIG9mIHNhdmVkIHN0YXRlcwogICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICovCiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5fc3RhdGVzLnNpemU7CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCBzdGF0ZXMKICAgKi8KICBjbGVhcigpIHsKICAgIHRoaXMuX3N0YXRlcy5jbGVhcigpOwogIH0KICAvKioKICAgKiBTYXZlIGN1cnJlbnQgc3RhdGVzIGZyb20gdHJlZSB2aWV3IGJlZm9yZSByZWJ1aWxkLgogICAqIEBwYXJhbSB7T2JqZWN0fSB0cmVldmlldyAtIFRyZWVWaWV3IGluc3RhbmNlIHdpdGggZ2V0U3RhdGVzKCkgbWV0aG9kCiAgICovCiAgc2F2ZUZyb21UcmVlKHQpIHsKICAgIGlmICh0ICE9IG51bGwgJiYgdC5nZXRTdGF0ZXMpCiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZSA9IHQuZ2V0U3RhdGVzKCk7CiAgICAgICAgZm9yIChjb25zdCBbaSwgbl0gb2YgT2JqZWN0LmVudHJpZXMoZSkpCiAgICAgICAgICBpICYmIEFycmF5LmlzQXJyYXkobikgJiYgdGhpcy5fc3RhdGVzLnNldChpLCBuKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybigiW1N0YXRlTWFuYWdlcl0gQ291bGQgbm90IHNhdmUgc3RhdGVzIGZyb20gdHJlZToiLCBlLm1lc3NhZ2UpOwogICAgICB9CiAgfQogIC8qKgogICAqIEFwcGx5IHNhdmVkIHN0YXRlcyB0byBPYmplY3RHcm91cHMuCiAgICogQ2FsbGVkIGFmdGVyIHRyZWUgcmVidWlsZCB0byByZXN0b3JlIHZpc2liaWxpdHkuCiAgICogQHBhcmFtIHtPYmplY3R9IGdyb3VwcyAtIE1hcCBvZiBwYXRoIC0+IE9iamVjdEdyb3VwCiAgICovCiAgYXBwbHlUb0dyb3Vwcyh0KSB7CiAgICBpZiAodCkKICAgICAgZm9yIChjb25zdCBbZSwgaV0gb2YgdGhpcy5fc3RhdGVzKSB7CiAgICAgICAgY29uc3QgbiA9IHRbZV07CiAgICAgICAgbiAmJiAodHlwZW9mIG4uc2V0U2hhcGVWaXNpYmxlID09ICJmdW5jdGlvbiIgJiYgbi5zZXRTaGFwZVZpc2libGUoaVswXSA9PT0gMSksIHR5cGVvZiBuLnNldEVkZ2VzVmlzaWJsZSA9PSAiZnVuY3Rpb24iICYmIG4uc2V0RWRnZXNWaXNpYmxlKGlbMV0gPT09IDEpKTsKICAgICAgfQogIH0KICAvKioKICAgKiBBcHBseSBzdGF0ZSB0byBhIHNpbmdsZSBncm91cAogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIC0gUGFydCBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IGdyb3VwIC0gT2JqZWN0R3JvdXAgaW5zdGFuY2UKICAgKi8KICBhcHBseVRvR3JvdXAodCwgZSkgewogICAgY29uc3QgaSA9IHRoaXMuZ2V0KHQpOwogICAgdHlwZW9mIGUuc2V0U2hhcGVWaXNpYmxlID09ICJmdW5jdGlvbiIgJiYgZS5zZXRTaGFwZVZpc2libGUoaVswXSA9PT0gMSksIHR5cGVvZiBlLnNldEVkZ2VzVmlzaWJsZSA9PSAiZnVuY3Rpb24iICYmIGUuc2V0RWRnZXNWaXNpYmxlKGlbMV0gPT09IDEpOwogIH0KICAvKioKICAgKiBSZW1vdmUgc3RhdGVzIGZvciBwYXRocyBub3QgaW4gdGhlIGN1cnJlbnQgc2V0LgogICAqIENhbGxlZCBhZnRlciBzeW5jIHRvIGNsZWFuIHVwIHJlbW92ZWQgcGFydHMuCiAgICogQHBhcmFtIHtTZXQ8c3RyaW5nPn0gY3VycmVudFBhdGhzIC0gU2V0IG9mIGN1cnJlbnQgcGFydCBwYXRocwogICAqLwogIGNsZWFudXBSZW1vdmVkKHQpIHsKICAgIGZvciAoY29uc3QgZSBvZiB0aGlzLl9zdGF0ZXMua2V5cygpKQogICAgICB0LmhhcyhlKSB8fCB0aGlzLl9zdGF0ZXMuZGVsZXRlKGUpOwogIH0KICAvKioKICAgKiBJbml0aWFsaXplIHN0YXRlcyBmcm9tIHBhcnRzIGRhdGEgKGZvciBuZXcgcGFydHMpLgogICAqIE9ubHkgc2V0cyBzdGF0ZSBpZiBub3QgYWxyZWFkeSBzYXZlZC4KICAgKiBAcGFyYW0ge0FycmF5fSBwYXJ0c0RhdGEgLSBBcnJheSBvZiBwYXJ0IGRhdGEgb2JqZWN0cwogICAqLwogIGluaXRGcm9tUGFydHModCkgewogICAgZm9yIChjb25zdCBlIG9mIHQpCiAgICAgIGlmIChlLmlkICYmICF0aGlzLl9zdGF0ZXMuaGFzKGUuaWQpKSB7CiAgICAgICAgY29uc3QgaSA9IGUuc3RhdGUgfHwgWzEsIDFdOwogICAgICAgIHRoaXMuX3N0YXRlcy5zZXQoZS5pZCwgaSk7CiAgICAgIH0KICB9Cn0KY2xhc3MgWUMgZXh0ZW5kcyBjVCB7CiAgY29uc3RydWN0b3IoZSwgaSwgbikgewogICAgc3VwZXIoZSwgaSwgbik7CiAgICAvKioKICAgICAqIEZpeGVkIGdldE5vZGVDb2xvciB0aGF0IHVzZXMgZHVjayB0eXBpbmcgaW5zdGVhZCBvZiBpbnN0YW5jZW9mIE9iamVjdEdyb3VwLgogICAgICogVGhlIG9yaWdpbmFsIHJlbGllcyBvbiBpbnN0YW5jZW9mIHdoaWNoIGZhaWxzIGZvciBvdXIgZHluYW1pY2FsbHkgY3JlYXRlZCBncm91cHMuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAtIE5vZGUgcGF0aCB3aXRob3V0IGxlYWRpbmcgc2xhc2gKICAgICAqIEByZXR1cm5zIHtzdHJpbmd8bnVsbH0gLSBIZXggY29sb3Igc3RyaW5nIG9yIG51bGwKICAgICAqLwogICAgayh0aGlzLCAiX2dldE5vZGVDb2xvckZpeGVkIiwgKGUpID0+IHsKICAgICAgdmFyIHIsIG8sIGwsIGgsIGM7CiAgICAgIGNvbnN0IGkgPSAobyA9IChyID0gdGhpcy5uZXN0ZWRHcm91cCkgPT0gbnVsbCA/IHZvaWQgMCA6IHIuZ3JvdXBzKSA9PSBudWxsID8gdm9pZCAwIDogb1siLyIgKyBlXTsKICAgICAgaWYgKCFpIHx8ICFpLmNoaWxkcmVuIHx8IGkuY2hpbGRyZW4ubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDsKICAgICAgbGV0IG4gPSBudWxsOwogICAgICBjb25zdCBzID0gaS5jaGlsZHJlblswXTsKICAgICAgcmV0dXJuIChsID0gcyA9PSBudWxsID8gdm9pZCAwIDogcy5tYXRlcmlhbCkgIT0gbnVsbCAmJiBsLmNvbG9yICYmIChzLnR5cGUgIT09ICJNZXNoIiB8fCBzLm1hdGVyaWFsLm5hbWUgPT09ICJmcm9udE1hdGVyaWFsIiA/IG4gPSBzLm1hdGVyaWFsLmNvbG9yIDogKGMgPSAoaCA9IGkuY2hpbGRyZW5bMV0pID09IG51bGwgPyB2b2lkIDAgOiBoLm1hdGVyaWFsKSAhPSBudWxsICYmIGMuY29sb3IgJiYgKG4gPSBpLmNoaWxkcmVuWzFdLm1hdGVyaWFsLmNvbG9yKSksIG4gPyAiIyIgKyBuLmdldEhleFN0cmluZygpIDogbnVsbDsKICAgIH0pOwogICAgLyoqCiAgICAgKiBGaXhlZCBzZXRPYmplY3QgdGhhdCB1c2VzIGR1Y2sgdHlwaW5nIGluc3RlYWQgb2YgaW5zdGFuY2VvZiBPYmplY3RHcm91cC4KICAgICAqIFRoZSBvcmlnaW5hbCByZWxpZXMgb24gaW5zdGFuY2VvZiB3aGljaCBmYWlscyBmb3Igb3VyIGR5bmFtaWNhbGx5IGNyZWF0ZWQgZ3JvdXBzLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBOb2RlIHBhdGggKHdpdGggbGVhZGluZyBzbGFzaCkKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGF0ZSAtIDAgb3IgMSBmb3IgdmlzaWJpbGl0eQogICAgICogQHBhcmFtIHtudW1iZXJ9IGljb25OdW1iZXIgLSAwIGZvciBzaGFwZSwgMSBmb3IgZWRnZXMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbm90aWZ5IC0gV2hldGhlciB0byBub3RpZnkgc3RhdGUgY2hhbmdlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHVwZGF0ZSAtIFdoZXRoZXIgdG8gdHJpZ2dlciByZW5kZXIgdXBkYXRlCiAgICAgKi8KICAgIGsodGhpcywgIl9zZXRPYmplY3RGaXhlZCIsIChlLCBpLCBuLCBzID0gITAsIHIgPSAhMCkgPT4gewogICAgICB2YXIgbCwgaDsKICAgICAgY29uc3QgbyA9IChoID0gKGwgPSB0aGlzLm5lc3RlZEdyb3VwKSA9PSBudWxsID8gdm9pZCAwIDogbC5ncm91cHMpID09IG51bGwgPyB2b2lkIDAgOiBoW2VdOwogICAgICBvICYmICh0eXBlb2Ygby5zZXRTaGFwZVZpc2libGUgIT0gImZ1bmN0aW9uIiB8fCB0eXBlb2Ygby5zZXRFZGdlc1Zpc2libGUgIT0gImZ1bmN0aW9uIiB8fCAobiA9PT0gMCA/IG8uc2V0U2hhcGVWaXNpYmxlKGkgPT09IDEpIDogby5zZXRFZGdlc1Zpc2libGUoaSA9PT0gMSksIHIgJiYgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpKSk7CiAgICB9KTsKICAgIHRoaXMuX3BhcnRzID0gbmV3ICRDKHRoaXMpLCB0aGlzLl9zdGF0ZU1hbmFnZXIgPSBuZXcgWEMoKSwgdGhpcy5fcmVuZGVyT3B0aW9ucyA9IG51bGwsIHRoaXMuX3ZpZXdlck9wdGlvbnMgPSBudWxsLCB0aGlzLl9sYXN0UGFydHNEYXRhID0gbnVsbCwgdGhpcy5nZXROb2RlQ29sb3IgPSB0aGlzLl9nZXROb2RlQ29sb3JGaXhlZCwgdGhpcy5zZXRPYmplY3QgPSB0aGlzLl9zZXRPYmplY3RGaXhlZDsKICB9CiAgLyoqCiAgICogR2V0IHRoZSBQYXJ0TWFuYWdlciBmb3IgZGlyZWN0IHBhcnQgbWFuaXB1bGF0aW9uLgogICAqIEByZXR1cm5zIHtQYXJ0TWFuYWdlcn0KICAgKi8KICBnZXQgcGFydHMoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFydHM7CiAgfQogIC8qKgogICAqIEdldCB0aGUgU3RhdGVNYW5hZ2VyIGZvciB2aXNpYmlsaXR5IHN0YXRlIG1hbmFnZW1lbnQuCiAgICogQHJldHVybnMge1N0YXRlTWFuYWdlcn0KICAgKi8KICBnZXQgc3RhdGVNYW5hZ2VyKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRlTWFuYWdlcjsKICB9CiAgLyoqCiAgICogT3ZlcnJpZGUgcmVuZGVyIHRvIGluaXRpYWxpemUgUGFydE1hbmFnZXIgYWZ0ZXIgc2NlbmUgaXMgYnVpbHQuCiAgICovCiAgcmVuZGVyKGUsIGksIG4pIHsKICAgIHRoaXMuX3JlbmRlck9wdGlvbnMgPSBpLCB0aGlzLl92aWV3ZXJPcHRpb25zID0gbiwgdGhpcy5fcGFydHMuc2V0UmVuZGVyT3B0aW9ucyhpKSwgdGhpcy5fbGFzdFBhcnRzRGF0YSA9IChlID09IG51bGwgPyB2b2lkIDAgOiBlLnBhcnRzKSB8fCBbXTsKICAgIGNvbnN0IHMgPSBzdXBlci5yZW5kZXIoZSwgaSwgbik7CiAgICByZXR1cm4gdGhpcy5fcGFydHMuYnVpbGRGcm9tVmlld2VyKCksIHRoaXMuX3N0YXRlTWFuYWdlci5pbml0RnJvbVBhcnRzKHRoaXMuX2xhc3RQYXJ0c0RhdGEpLCBzOwogIH0KICAvKioKICAgKiBTeW5jIHBhcnRzIHdpdGggbmV3IGRhdGEgLSBpbnRlbGxpZ2VudGx5IGFkZCwgcmVtb3ZlLCBvciB1cGRhdGUuCiAgICogUHJlc2VydmVzIGNhbWVyYSBwb3NpdGlvbiBhbmQgdmlzaWJpbGl0eSBzdGF0ZXMuCiAgICogCiAgICogQHBhcmFtIHtPYmplY3R9IHNoYXBlc0RhdGEgLSBTaGFwZSBkYXRhIHdpdGggcGFydHMgYXJyYXkKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFN5bmMgb3B0aW9ucwogICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy51cGRhdGVUcmVlIC0gV2hldGhlciB0byB1cGRhdGUgdGhlIHRyZWUgdmlldyAoZGVmYXVsdDogdHJ1ZSkKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiBzeW5jIHN1Y2NlZWRlZAogICAqLwogIHN5bmNQYXJ0cyhlLCBpID0ge30pIHsKICAgIHZhciBvOwogICAgY29uc3QgeyB1cGRhdGVUcmVlOiBuID0gITAgfSA9IGk7CiAgICBpZiAoIXRoaXMucmVhZHkgfHwgISgobyA9IHRoaXMubmVzdGVkR3JvdXApICE9IG51bGwgJiYgby5ncm91cHMpIHx8ICEoZSAhPSBudWxsICYmIGUucGFydHMpKQogICAgICByZXR1cm4gITE7CiAgICB0aGlzLl9zdGF0ZU1hbmFnZXIuc2F2ZUZyb21UcmVlKHRoaXMudHJlZXZpZXcpOwogICAgY29uc3QgcyA9IHRoaXMuX3BhcnRzLnN5bmMoZS5wYXJ0cyksIHIgPSBuZXcgU2V0KGUucGFydHMubWFwKChsKSA9PiBsLmlkKSk7CiAgICByZXR1cm4gdGhpcy5fc3RhdGVNYW5hZ2VyLmNsZWFudXBSZW1vdmVkKHIpLCB0aGlzLl9zdGF0ZU1hbmFnZXIuaW5pdEZyb21QYXJ0cyhlLnBhcnRzKSwgbiAmJiAocy5hZGRlZCA+IDAgfHwgcy5yZW1vdmVkID4gMCkgJiYgdGhpcy5fcmVidWlsZFRyZWVWaWV3KGUucGFydHMpLCB0aGlzLl9zdGF0ZU1hbmFnZXIuYXBwbHlUb0dyb3Vwcyh0aGlzLm5lc3RlZEdyb3VwLmdyb3VwcyksIHRoaXMuX2xhc3RQYXJ0c0RhdGEgPSBlLnBhcnRzLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlciksICEwOwogIH0KICAvKioKICAgKiBSZWJ1aWxkIHRoZSB0cmVlIHZpZXcgdG8gcmVmbGVjdCBjdXJyZW50IHBhcnRzLgogICAqIFVzZXMgU3RhdGVNYW5hZ2VyIGZvciB2aXNpYmlsaXR5IHN0YXRlIHByZXNlcnZhdGlvbi4KICAgKiBAcHJpdmF0ZQogICAqLwogIF9yZWJ1aWxkVHJlZVZpZXcoZSkgewogICAgaWYgKCF0aGlzLnRyZWV2aWV3IHx8ICF0aGlzLmRpc3BsYXkpCiAgICAgIHJldHVybjsKICAgIGNvbnN0IGkgPSB0aGlzLl9idWlsZFRyZWVGcm9tUGFydHMoZSk7CiAgICB0aGlzLnRyZWUgPSBpLCB0aGlzLmV4cGFuZGVkVHJlZSA9IGksIHRoaXMuY29tcGFjdFRyZWUgPSBpLCB0aGlzLnRyZWV2aWV3LmRpc3Bvc2UgJiYgdGhpcy50cmVldmlldy5kaXNwb3NlKCksIHRoaXMuZGlzcGxheS5jbGVhckNhZFRyZWUoKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IG4gPSB0aGlzLnRyZWV2aWV3LmNvbnN0cnVjdG9yOwogICAgICB0aGlzLnRyZWV2aWV3ID0gbmV3IG4oCiAgICAgICAgdGhpcy50cmVlLAogICAgICAgIHRoaXMuZGlzcGxheS5jYWRUcmVlU2Nyb2xsQ29udGFpbmVyLAogICAgICAgIHRoaXMuc2V0T2JqZWN0LAogICAgICAgIHRoaXMuaGFuZGxlUGljaywKICAgICAgICB0aGlzLnVwZGF0ZSwKICAgICAgICB0aGlzLm5vdGlmeVN0YXRlcywKICAgICAgICB0aGlzLmdldE5vZGVDb2xvciwKICAgICAgICB0aGlzLnRoZW1lLAogICAgICAgIHRoaXMubmV3VHJlZUJlaGF2aW9yLAogICAgICAgICExCiAgICAgICAgLy8gZGVidWcKICAgICAgKTsKICAgICAgY29uc3QgcyA9IHRoaXMudHJlZXZpZXcuY3JlYXRlKCk7CiAgICAgIHN3aXRjaCAodGhpcy5kaXNwbGF5LmFkZENhZFRyZWUocyksIHRoaXMudHJlZXZpZXcucmVuZGVyKCksIHRoaXMuY29sbGFwc2UpIHsKICAgICAgICBjYXNlIG9vLkVYUEFORF9BTEw6CiAgICAgICAgICB0aGlzLnRyZWV2aWV3LmV4cGFuZEFsbCgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBvby5ST09UX09OTFk6CiAgICAgICAgICB0aGlzLnRyZWV2aWV3Lm9wZW5MZXZlbCgtMSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIG9vLkNPTExBUFNFX0FMTDoKICAgICAgICAgIHRoaXMudHJlZXZpZXcuY29sbGFwc2VBbGwoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2Ugb28uRklSU1RfTEVWRUw6CiAgICAgICAgICB0aGlzLnRyZWV2aWV3Lm9wZW5MZXZlbCgxKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9IGNhdGNoIChuKSB7CiAgICAgIGNvbnNvbGUud2FybigiW0xpdmVWaWV3ZXJdIENvdWxkIG5vdCByZWJ1aWxkIHRyZWUgdmlldzoiLCBuLm1lc3NhZ2UpOwogICAgfQogIH0KICAvKioKICAgKiBCdWlsZCBhIHRyZWUgc3RydWN0dXJlIGZyb20gcGFydHMgZGF0YS4KICAgKiBUcmVlIHN0cnVjdHVyZSBtdXN0IG1hdGNoIHBhcnQgSURzIHNvIHBhdGhzIGFsaWduLgogICAqIFBhcnQgSUQgIi9Hcm91cC9NeUJveCIgLT4gdHJlZSB7IEdyb3VwOiB7IE15Qm94OiBbMSwxXSB9IH0KICAgKiBAcGFyYW0ge0FycmF5fSBwYXJ0c0RhdGEgLSBQYXJ0cyBkYXRhCiAgICogQHByaXZhdGUKICAgKi8KICBfYnVpbGRUcmVlRnJvbVBhcnRzKGUpIHsKICAgIGNvbnN0IGkgPSB7fTsKICAgIGZvciAoY29uc3QgbiBvZiBlKSB7CiAgICAgIGNvbnN0IHMgPSBuLmlkIHx8ICIiLCByID0gcy5zcGxpdCgiLyIpLmZpbHRlcigoYykgPT4gYyk7CiAgICAgIGlmIChyLmxlbmd0aCA9PT0gMCkgY29udGludWU7CiAgICAgIGNvbnN0IG8gPSB0aGlzLl9zdGF0ZU1hbmFnZXIuZ2V0KHMpOwogICAgICBsZXQgbCA9IGk7CiAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgci5sZW5ndGggLSAxOyBjKyspIHsKICAgICAgICBjb25zdCB1ID0gcltjXTsKICAgICAgICBsW3VdIHx8IChsW3VdID0ge30pLCBsID0gbFt1XTsKICAgICAgfQogICAgICBjb25zdCBoID0gcltyLmxlbmd0aCAtIDFdOwogICAgICBsW2hdID0gbzsKICAgIH0KICAgIHJldHVybiBpOwogIH0KICAvKioKICAgKiBHZXQgYSBwYXJ0IGhhbmRsZSBieSBJRCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbi4KICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgLSBQYXJ0IElECiAgICogQHJldHVybnMge1BhcnRIYW5kbGV8bnVsbH0KICAgKi8KICBnZXRQYXJ0KGUpIHsKICAgIHJldHVybiB0aGlzLl9wYXJ0cy5nZXQoZSk7CiAgfQogIC8qKgogICAqIFVwZGF0ZSBhIHNpbmdsZSBwYXJ0J3MgZ2VvbWV0cnkgYW5kIHRyYW5zZm9ybS4KICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgLSBQYXJ0IElECiAgICogQHBhcmFtIHtPYmplY3R9IHBhcnREYXRhIC0gUGFydCBkYXRhIHdpdGggc2hhcGUgYW5kL29yIGxvYwogICAqLwogIHVwZGF0ZVBhcnQoZSwgaSkgewogICAgdGhpcy5fcGFydHMudXBkYXRlKGUsIGkpLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlcik7CiAgfQogIC8qKgogICAqIEFkZCBhIG5ldyBwYXJ0IHRvIHRoZSBzY2VuZS4KICAgKiBAcGFyYW0ge09iamVjdH0gcGFydERhdGEgLSBQYXJ0IGRhdGEKICAgKiBAcmV0dXJucyB7UGFydEhhbmRsZXxudWxsfQogICAqLwogIGFkZFBhcnQoZSkgewogICAgY29uc3QgaSA9IHRoaXMuX3BhcnRzLmFkZChlKTsKICAgIHJldHVybiBpICYmICh0aGlzLl9zdGF0ZU1hbmFnZXIuaW5pdEZyb21QYXJ0cyhbZV0pLCB0aGlzLnVwZGF0ZSh0aGlzLnVwZGF0ZU1hcmtlcikpLCBpOwogIH0KICAvKioKICAgKiBSZW1vdmUgYSBwYXJ0IGZyb20gdGhlIHNjZW5lLgogICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFBhcnQgSUQKICAgKi8KICByZW1vdmVQYXJ0KGUpIHsKICAgIHRoaXMuX3BhcnRzLnJlbW92ZShlKSwgdGhpcy5fc3RhdGVNYW5hZ2VyLnJlbW92ZShlKSwgdGhpcy51cGRhdGUodGhpcy51cGRhdGVNYXJrZXIpOwogIH0KfQpmdW5jdGlvbiBaQyh7IG1vZGVsOiBhLCBlbDogdCB9KSB7CiAgY29uc3QgZSA9IGEuZ2V0KCJ3aWR0aCIpIHx8ICIxMDAlIiwgaSA9IGEuZ2V0KCJoZWlnaHQiKSB8fCA2MDAsIG4gPSB0eXBlb2YgZSA9PSAibnVtYmVyIiA/IGAke2V9cHhgIDogZSwgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIHMuY2xhc3NOYW1lID0gIm1hcmltby1jYWQtY29udGFpbmVyIiwgcy5zdHlsZS53aWR0aCA9IG4sIHMuc3R5bGUuaGVpZ2h0ID0gaSArICJweCIsIHQuYXBwZW5kQ2hpbGQocyk7CiAgbGV0IHIgPSBudWxsLCBvID0gbnVsbCwgbCA9IG51bGwsIGggPSAhMTsKICBmdW5jdGlvbiBjKCkgewogICAgaWYgKGgpIHJldHVybjsKICAgIGNvbnN0IGYgPSBzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoLCB5ID0gZiA+IDAgPyBNYXRoLmZsb29yKGYpIDogU2YsIGcgPSBNYXRoLm1heCh5IC0gaWEgLSB2MCwgYjApLCBtID0gewogICAgICAuLi5PQywKICAgICAgY2FkV2lkdGg6IGcsCiAgICAgIGhlaWdodDogaSwKICAgICAgdHJlZVdpZHRoOiBpYQogICAgfTsKICAgIHIgPSBuZXcgVkUocywgbSksIG8gPSBuZXcgWUMociwgTTAsICh2KSA9PiB7CiAgICAgIHYudHlwZSA9PT0gInNlbGVjdCIgJiYgKGEuc2V0KCJzZWxlY3RlZCIsIHYuZGF0YSksIGEuc2F2ZV9jaGFuZ2VzKCkpOwogICAgfSksIGggPSAhMCwgYS5zZW5kKHsgdHlwZTogInJlYWR5IiB9KSwgdSgpLCByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICBpZiAoby5yZWFkeSkKICAgICAgICB0cnkgewogICAgICAgICAgby5yZXNpemVDYWRWaWV3KGcsIGlhLCBpLCAhMSk7CiAgICAgICAgfSBjYXRjaCAodikgewogICAgICAgICAgY29uc29sZS53YXJuKCJbbWFyaW1vLWNhZF0gSW5pdGlhbCByZXNpemUgZmFpbGVkOiIsIHYubWVzc2FnZSk7CiAgICAgICAgfQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIHUoKSB7CiAgICBpZiAoIW8pIHJldHVybjsKICAgIGNvbnN0IGYgPSBhLmdldCgic2hhcGVzX2RhdGEiKTsKICAgIGlmICghKCFmIHx8ICFmLnBhcnRzIHx8IGYucGFydHMubGVuZ3RoID09PSAwKSAmJiAhKG8ucmVhZHkgJiYgby5zeW5jUGFydHMgJiYgby5zeW5jUGFydHMoZikpKSB7CiAgICAgIGlmIChvLm5lc3RlZEdyb3VwKQogICAgICAgIHRyeSB7CiAgICAgICAgICBvLmNsZWFyKCk7CiAgICAgICAgfSBjYXRjaCAoeSkgewogICAgICAgICAgY29uc29sZS53YXJuKCJbbWFyaW1vLWNhZF0gRmFpbGVkIHRvIGNsZWFyIHZpZXdlcjoiLCB5Lm1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgby5yZW5kZXIoZiwgYXgsIE0wKTsKICAgIH0KICB9CiAgYS5vbigiY2hhbmdlOnNoYXBlc19kYXRhIiwgdSk7CiAgZnVuY3Rpb24gZChmKSB7CiAgICBpZiAoIXIgfHwgIW8gfHwgIW8ucmVhZHkpIHJldHVybjsKICAgIGNvbnN0IHkgPSBNYXRoLm1heChNYXRoLmZsb29yKGYpIC0gaWEgLSB2MCwgYjApOwogICAgdHJ5IHsKICAgICAgci5zZXRTaXplcyh7CiAgICAgICAgY2FkV2lkdGg6IHksCiAgICAgICAgaGVpZ2h0OiBpLAogICAgICAgIHRyZWVXaWR0aDogaWEKICAgICAgfSksIG8ucmVzaXplQ2FkVmlldyh5LCBpYSwgaSwgITEpOwogICAgfSBjYXRjaCAoZykgewogICAgICBjb25zb2xlLndhcm4oIlttYXJpbW8tY2FkXSBSZXNpemUgZmFpbGVkOiIsIGcubWVzc2FnZSk7CiAgICB9CiAgfQogIGNvbnN0IHAgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoKGYpID0+IHsKICAgIGNvbnN0IHkgPSBmWzBdLmNvbnRlbnRSZWN0LndpZHRoOwogICAgeSA+IDAgJiYgKGggPyAobCAmJiBjbGVhclRpbWVvdXQobCksIGwgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgZCh5KTsKICAgIH0sIFVDKSkgOiBjKCkpOwogIH0pOwogIHJldHVybiBwLm9ic2VydmUocyksIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICBoIHx8IGMoKTsKICB9KSwgKCkgPT4gewogICAgaWYgKHAuZGlzY29ubmVjdCgpLCBsICYmIGNsZWFyVGltZW91dChsKSwgbykKICAgICAgdHJ5IHsKICAgICAgICBvLmRpc3Bvc2UoKTsKICAgICAgfSBjYXRjaCAoZikgewogICAgICAgIGNvbnNvbGUud2FybigiW21hcmltby1jYWRdIERpc3Bvc2UgZmFpbGVkOiIsIGYubWVzc2FnZSk7CiAgICAgIH0KICAgIHMuaW5uZXJIVE1MID0gIiI7CiAgfTsKfQpjb25zdCBrMiA9IHsgcmVuZGVyOiBaQyB9OwpleHBvcnQgewogIGsyIGFzIGRlZmF1bHQsCiAgWkMgYXMgcmVuZGVyCn07Cg==&quot;' data-js-hash='&quot;96db34ac7879f1fd210b4f0c27d77315&quot;'></marimo-anywidget></marimo-ui-element></div>"
          }
        }
      ],
      "console": []
    }
  ]
}